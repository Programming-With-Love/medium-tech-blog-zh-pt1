<html>
<head>
<title>Upgrading Pinterest operational metrics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">升级Pinterest运营指标</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/upgrading-pinterest-operational-metrics-8718d058079a?source=collection_archive---------5-----------------------#2019-08-15">https://medium.com/pinterest-engineering/upgrading-pinterest-operational-metrics-8718d058079a?source=collection_archive---------5-----------------------#2019-08-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="60cc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Jonathan Fung |软件工程师实习生，能见度<br/> Colin Probasco |软件工程师，能见度</p><p id="d858" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最近，Pinterest达到了一个重要的里程碑:<a class="ae jc" href="https://newsroom.pinterest.com/en/300million" rel="noopener ugc nofollow" target="_blank">全球3亿</a>月活跃用户。为了通过我们庞大的内容语料库可靠地服务于这一用户群，Pinterest的工程团队维护着数千项紧密协作的服务。每个服务都会发出对健康监控和警报系统至关重要的指标。可见性团队负责维护支持指标收集、报告、处理和显示的系统。</p><h1 id="3cec" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">为什么要升级？</h1><p id="3a62" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">到目前为止，Pinterest一直使用Twitter的<a class="ae jc" href="https://github.com/twitter/ostrich" rel="noopener ugc nofollow" target="_blank">鸵鸟</a>库从Java服务中收集指标。由于鸵鸟最近的贬值，它已经成为我们技术债务的来源，迫使我们使用旧版本的<a class="ae jc" href="https://twitter.github.io/finagle/" rel="noopener ugc nofollow" target="_blank">欺骗</a>。最重要的是，它阻碍了我们实现准确的服务级别指标聚合，因为鸵鸟只公开直方图分布的摘要。考虑以下由三台机器组成的机群的示例。每台主机报告其响应时间延迟的第90个百分位数(粉红色-16、6和8)。不可能从三个采样数据点中恢复出真正的90%分布(12)。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kg"><img src="../Images/2b626d8fc6558e3c8ae740fade192895.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UElYofOLgwN1SBBf"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">Three distributions from three hosts, each reporting one p90</figcaption></figure><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kw"><img src="../Images/0e90b9ad945b49537fcc6f8119268a07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bXnbFi_fGrNC3R7s5qvBvA.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">The true p90 across all three hosts cannot be recovered from the sampled p90s</figcaption></figure><p id="16fe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这提出了多个问题:</p><ul class=""><li id="447c" class="kx ky hh ig b ih ii il im ip kz it la ix lb jb lc ld le lf bi translated">运营指标按节点标记，因此要存储的指标数量随着Pinterest的指标用例线性增长。这导致指标存储需求逐年大幅增长。</li><li id="770d" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated">我们目前平均分布中的百分位数来估计真实的百分位数。这并不一定能准确代表真实的百分比指标，关键警报可能取决于这些服务生成的指标。不正确的百分比度量可能导致假阳性，甚至更糟，假阴性。</li></ul><p id="d7c0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对此的解决方案有两个:</p><ol class=""><li id="42bc" class="kx ky hh ig b ih ii il im ip kz it la ix lb jb ll ld le lf bi translated">我们必须摒弃当前收集指标的方式，创建一个内部指标收集器和报告器，以便我们能够控制内部实现。直方图指标将得到T-Digest的支持:一种紧凑、可串行化、精确的直方图数据结构，最重要的是，它是可合并的。</li><li id="c448" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb ll ld le lf bi translated">必须创建与语言无关的指标聚合管道，以提供服务级别的聚合支持。如果需要按节点度量，还必须有一个选择加入选项，以便在短时间内保留节点级别的度量。</li></ol><p id="13ff" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这两个项目将对Pinterest的度量系统进行更多的控制。由于消除了不必要的按节点度量，度量存储需求将大幅降低，并且由于在查询中提取的数据更少，查询性能将得到提高。最后，Pinterest将提供准确的服务水平百分比指标。</p><h1 id="e80a" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">Pinterest统计收集器</h1><p id="b523" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">为了反对鸵鸟，我们构建了Pinterest StatsCollector，这是一个Java度量收集器和报告库。StatsCollector需要能够以线程安全的方式收集三种类型的指标(计数器、计量器和直方图),并每分钟将它们推过聚合管道，以将它们持久存储在时序数据库(TSDB)中。在开发过程中，我们针对CPU性能和API与传统系统的兼容性进行了优化，以简化迁移步骤。</p><p id="433d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">概括地说，该库由以下部分组成:</p><ol class=""><li id="c407" class="kx ky hh ig b ih ii il im ip kz it la ix lb jb ll ld le lf bi translated"><strong class="ig hi"> StatsCollector: </strong>创建计数器、计量器和直方图的界面。</li><li id="1d1a" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb ll ld le lf bi translated"><strong class="ig hi"> Stats: </strong>围绕单个StatsCollector的瘦静态单例类包装器。每个JVM一个。用户调用此对象。</li><li id="5385" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb ll ld le lf bi translated"><strong class="ig hi">度量:</strong>计数器、直方图和量表的线程安全实现</li><li id="b056" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb ll ld le lf bi translated"><strong class="ig hi"> LogPusher: </strong>我们使用基于推送的模型来衡量指标。这个类将指标从StatsCollector推送到<em class="lm"> metrics-agent </em>，这是一个运行在每台Pinterest机器上的sidecar，负责对指标进行后处理，并将它们转发到适当的目的地。</li><li id="fc54" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb ll ld le lf bi translated"><strong class="ig hi"> ThreadLocalStats: </strong>一个方便的接口，用于线程本地的批量度量。提供性能优势。</li></ol><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es ln"><img src="../Images/e90ba1d52777cb4202846355e679cbd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/0*f9wO532kA5YIqjaQ"/></div><figcaption class="ks kt et er es ku kv bd b be z dx">Metrics flow diagram</figcaption></figure><h2 id="0848" class="lo je hh bd jf lp lq lr jj ls lt lu jn ip lv lw jr it lx ly jv ix lz ma jz mb bi translated">API决策</h2><p id="acb0" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">在设计StatsCollector和Stats接口时，我们广泛地分析了我们的Java代码库，以找到现有的度量代码模式。发现了一些关键的用例以及性能瓶颈，我们设计了我们的库来缓解这些问题。这里，我们详细介绍一些应用程序级和用户级的优化。</p><h2 id="cb1a" class="lo je hh bd jf lp lq lr jj ls lt lu jn ip lv lw jr it lx ly jv ix lz ma jz mb bi translated">优化1:缓存同步哈希表查找</h2><p id="20ab" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">首先，我们修改了向StatsCollector报告指标的流程。举例来说，考虑递增计数器。前面的方法涉及直接在Stats singleton上调用<em class="lm"> incr </em>。因此，在每次incr调用期间，只有一次同步的hashmap查找来访问度量名称到计数器的映射，这在执行高每秒查询数(QPS)函数时会导致性能问题。因为对于每个JVM，从度量名称到计数器只有一个映射，所以所有同步的查找都是在一个hashmap上执行的，并且因为锁定需要从用户模式到内核模式的昂贵的进程级切换，所以会发生锁抖动。</p><p id="664c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了优化，我们转向了一种新的API，它可以有效地“缓存”同步查找。用户现在维护一个对Stats singleton分配的计数器对象的引用，所有度量操作都在该对象上执行。</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="mc md l"/></div></figure><h2 id="b6f2" class="lo je hh bd jf lp lq lr jj ls lt lu jn ip lv lw jr it lx ly jv ix lz ma jz mb bi translated">优化2:线程本地统计</h2><p id="4cf7" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">然而，当谈到指标的动态命名时，我们的第一个优化失败了。考虑一个用例，其中用户必须在批处理操作中增加动态命名的计数器，例如处理许多事件的循环。前面提到的方法不会带来性能上的好处，因为每次函数调用都需要同步的hashmap查找。</p><p id="37bf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了使这种情况具有性能，我们可以从hashmap查找和度量增量中删除所有同步。我们构建了线程本地Stats，这是StatsCollector及其内部指标的线程本地版本，它不具有任何锁定行为。线程本地统计数据实际上充当了一个存储桶，以批处理方式存储指标，直到用户将线程本地统计数据刷新回StatsCollector。因为线程本地统计是线程本地的，所以在任何度量操作期间都没有同步，优化了从用户模式切换到内核模式所需的资源。</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="mc md l"/></div></figure><h2 id="4bd5" class="lo je hh bd jf lp lq lr jj ls lt lu jn ip lv lw jr it lx ly jv ix lz ma jz mb bi translated">优化3:仪表API设计</h2><p id="f1d2" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">与用于测量事件发生率的计数器相反，计量器可以被认为是监控某个值的功能。仪表的经典示例是监视列表大小的函数。在一个量规被初始化之后，当LogPusher推送度量时，它的值将被轮询并每分钟报告一次。</p><p id="9d4b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">初始化Gauge的传统方法是内嵌一个Java类型的匿名类<em class="lm"> Supplier </em>，或者Scala <em class="lm"> Function0 </em>。这些可以被认为是输出一个双精度值的无参数lambdas。这对于用户来说是麻烦的，并且不是高性能的，增加了被监控程序的内存占用。对被监视对象的引用必须在匿名内联类中维护，这可以防止JVM将该对象标记为适合垃圾收集，因为只有当对该对象的所有引用都丢失时，该对象才会被垃圾收集。这不是我们想要的行为，因为监控系统不应该影响客户端的性能。</p><figure class="kh ki kj kk fd kl"><div class="bz dy l di"><div class="mc md l"/></div></figure><p id="67f5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了优化，我们从<a class="ae jc" href="http://micrometer.io/" rel="noopener ugc nofollow" target="_blank">千分尺</a>库中借鉴了灵感，并将Java <a class="ae jc" href="https://docs.oracle.com/javase/8/docs/api/java/lang/ref/WeakReference.html" rel="noopener ugc nofollow" target="_blank"> WeakReference </a>对象引入到我们的量规中。对对象的弱引用不能防止垃圾回收。维护仪表所监控对象的强引用是库用户的责任。当用户完成监视并删除强引用时，JVM垃圾收集器就被允许收集该对象。通过这一改进，我们监控系统中的仪表对用户完全透明，并且不会占用额外的内存。</p><h1 id="14b0" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">按服务汇总指标(MABS)</h1><p id="6d99" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">随着指标流经我们内部的Pinterest StatsCollector，我们现在可以对如何处理指标进行更多的控制。这允许我们开发语言无关的MABS管道，为服务提供一种聚合度量的方式。完成的管道将允许服务中的所有节点通过MABS报告它们的指标，这将汇总按节点的指标并为每个指标生成一个数据点。我们还允许用户选择按节点存储指标。</p><p id="471b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从高层次来看，MABS由以下人员组成:</p><ol class=""><li id="1ec8" class="kx ky hh ig b ih ii il im ip kz it la ix lb jb ll ld le lf bi translated"><strong class="ig hi">Metrics-Agent:</strong>Pinterest sidecar必须接受新的命令语句，并在转发到适当的Kafka主题之前执行必要的处理。</li><li id="1fcc" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb ll ld le lf bi translated"><strong class="ig hi"> Kafka主题:</strong> Kafka被用作MABS组件之间的流缓冲区。</li><li id="52c5" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb ll ld le lf bi translated"><strong class="ig hi"> Spark聚合器:</strong>一个持续运行的任务，用于聚合度量。</li><li id="2744" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb ll ld le lf bi translated"><strong class="ig hi">入口:</strong>将数据推送到存储系统的服务。</li><li id="851e" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb ll ld le lf bi translated"><strong class="ig hi">时间序列数据库:</strong>Pinterest的存储&amp;缓存团队维护着<a class="ae jc" rel="noopener" href="/pinterest-engineering/goku-building-a-scalable-and-high-performant-time-series-database-system-a8ff5758a181">悟空</a>，我们的内部TSDB。Goku支持多个存储层，非常适合我们的短期<em class="lm"> by_node </em>指标。</li></ol><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es me"><img src="../Images/e1343525e1609bc36e8ea107483159b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*R0nfoiTkA6timcHn"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">Before and After MABS pipeline</figcaption></figure><h1 id="ac46" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">使用</h1><p id="3506" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">服务通过TCP连接向本地度量代理发送明文MABS命令来与度量代理通信。计数器和仪表分别以整数和双精度形式通过网络发送。直方图作为支持T-Digest的Base64编码序列化发送。可选的<em class="lm"> by_node=True </em>命令标记将标记主机级指标，以便短期保留。</p><p id="2cd2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">输入后，Metrics-Agent执行适当的后处理，并将度量转发给适当的Kafka主题。Kafka主题将指标缓冲到一个Spark聚合作业中，Spark聚合作业的输出被发送到一个Ingestor，后者将数据点写入悟空TSDB。</p><h1 id="ca5f" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">影响</h1><p id="a10b" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">Pinterest StatsCollector和MABS为我们的指标管道带来了巨大的好处。通过将服务迁移到MABS管道，我们能够垂直汇总整个服务的指标。这大大减少了需要存储在TSDBs中的数据量。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mf"><img src="../Images/9f8f5ed523c84deb805b0ee5904c7978.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g8PHbPXGSB-2NixE"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">Only the true p95 is stored, rather than one p95 for every fleet machine.</figcaption></figure><p id="4971" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过将MABS部署到内部Pinterest指标中，我们能够移除指标中多余的主机标签。由此带来的指标维度的减少在指标存储 <em class="lm">方面产生了高达<strong class="ig hi"> 99%的节省。</strong></em></p><p id="76f2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">除了存储容量和运营成本的降低，MABS最终让Pinterest获得了精确的直方图指标。百分比指标对于监控服务的健康非常重要。有了准确的指标，可以减少误报和漏报。下图是通过MABS改进的延迟测量的真实示例。红线是报告直方图指标的传统方式，由max函数汇总，而蓝线是通过MABS报告的真实指标。MABS指标不那么参差不齐，提供了更准确的真实情况，最重要的是，不会错误地触发警报。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mf"><img src="../Images/75779182e61a2cdf4bcd85fe2b695911.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0dnMnfaSQPUS8oBB"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">MABS pipeline does not have false spikes</figcaption></figure><h1 id="a355" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="713e" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">度量在任何软件公司中都扮演着重要的角色。如果没有一种可靠的方法来报告和显示指标，软件工程师将会盲目——想象一下驾驶一架没有任何速度、航向或高度仪表的飞机！MABS是使我们的指标体系更具可扩展性、稳健性和准确性的下一步。我们的基础设施目前支持一种产品，该产品每月激励超过3亿Pinners过上他们热爱的生活。随着Pinterest迈向下一个3亿Pinners，Visibility团队将不断努力构建和改进基础设施，为Pinners提供无缝、鼓舞人心的浏览体验。</p><p id="631a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Pinterest实习一个夏天是一次不可思议的经历。在短短的三个月里，学习、责任和乐趣都变得异常丰富。实习生有机会参与真实的、有影响力的项目(比如MABS！)提供了无限的发展机会和接触多种技术的宝贵机会。如果你是读这个的大学生，肯定考虑申请。如有任何问题，请随时联系<a class="ae jc" href="https://jonfung.me" rel="noopener ugc nofollow" target="_blank"> me </a>！</p><p id="03f0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">致谢</strong></p><p id="883d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lm"> Colin Probasco，感谢他在项目期间的指导和支持。感谢可视性团队的Brian Overstreet、Naoman Abbas、朱未、Peter Kim、Humsheen Geo和Dai Ngyuen。感谢James Fish、存储&amp;缓存团队和日志团队在设计评审期间提供的意见。感谢林义杰帮助开发工具。</em></p></div></div>    
</body>
</html>