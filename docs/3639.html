<html>
<head>
<title>CICD Automation using Unity CLI for publishing Android App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Unity CLI发布Android应用程序的CICD自动化</h1>
<blockquote>原文：<a href="https://medium.com/globant/cicd-automation-using-unity-cli-for-publishing-android-app-752f3e85ec10?source=collection_archive---------0-----------------------#2021-03-10">https://medium.com/globant/cicd-automation-using-unity-cli-for-publishing-android-app-752f3e85ec10?source=collection_archive---------0-----------------------#2021-03-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="bf35" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Unity是一个广泛使用的游戏开发引擎，被许多人用来为各种平台开发游戏。</p><p id="0a8d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本文包含以下几个部分:</p><ul class=""><li id="6be0" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">介绍</li><li id="36e6" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">先决条件</li><li id="0da3" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">步骤1:使用命令行在本地服务器上构建和测试</li><li id="9b69" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">步骤2:使用CI/CD工具构建、测试和发布</li><li id="967b" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">结论</li><li id="1995" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">参考</li></ul><h1 id="6c18" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">介绍</h1><p id="20d8" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">在本文中，我们将看到如何通过命令行使用unity命令来自动构建和测试我们的android项目，并将其发布到应用中心。虽然在本文中，我们将在步骤中使用Jenkins pipeline的屏幕截图作为参考，但您可以选择使用您选择的任何其他CI/CD工具，因为所有工具的方法都是相同的。</p><p id="2158" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们将要使用的命令由Unity Technologies提供，可以使用<a class="ae kt" href="https://docs.unity3d.com/Manual/CommandLineArguments.html" rel="noopener ugc nofollow" target="_blank"> Unity命令行文档</a>访问。</p><p id="ebb2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">文章分为两个主要部分。在第一部分中，我们将使用命令行实用程序在本地构建apk，在第二部分中，我们将了解如何使用DevOps工具来构建、测试和部署同一个项目。</p><h1 id="999b" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">先决条件</h1><ul class=""><li id="c5ef" class="jc jd hh ig b ih ko il kp ip ku it kv ix kw jb jh ji jj jk bi translated">安装在具有有效许可证的本地计算机上的Unity Hub。Unity hub可以从其官方网站<a class="ae kt" href="https://unity3d.com/get-unity/download" rel="noopener ugc nofollow" target="_blank">下载</a>。</li><li id="ab5c" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">Unity版本应该与在所需目标支持下安装的项目版本相同。示例—如果构建apk文件，应该安装和配置Android SDK和NDK。</li><li id="5580" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">应用中心帐户。没有的话可以<a class="ae kt" href="https://appcenter.ms/signup?utm_source=Azure%20Marketing&amp;utm_medium=Azure" rel="noopener ugc nofollow" target="_blank">免费造</a>一个。</li></ul><h1 id="0926" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">步骤1:使用命令行在本地服务器上构建和测试</h1><ul class=""><li id="e353" class="jc jd hh ig b ih ko il kp ip ku it kv ix kw jb jh ji jj jk bi translated">创建一个执行方法文件:<br/>为了通过命令行构建一个项目，需要一个执行方法。首先调用这个execute方法，它将一个接一个地构建execute方法中列出的场景。<br/>下面是一个包含在您的项目中的示例执行方法，它定义了三个场景、输出文件的位置和平台目标(本例中为Android):</li></ul><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="de17" class="lg jr hh lc b fi lh li l lj lk">using UnityEditor;<br/>class AndroidBuilder<br/>{<br/> static void ProductionBuild()<br/> {<br/>  BuildPlayerOptions buildPlayerOptions = new BuildPlayerOptions();<br/>  buildPlayerOptions.scenes = new[] { "Assets/Scenes/Scene1.unity", "Assets/Scenes/Scene2.unity", "Assets/Scenes/Scene3.unity" };<br/>  buildPlayerOptions.locationPathName = "/builds/OutputApkName.apk";<br/>  buildPlayerOptions.target = BuildTarget.Android;<br/>  buildPlayerOptions.options = BuildOptions.None;<br/>  BuildPipeline.BuildPlayer(buildPlayerOptions);<br/> }<br/>}</span></pre><ul class=""><li id="e0f3" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">接下来，您需要在repo中提交该文件。您可以创建以下目录结构，将文件保存为项目中的AndroidBuilder.cs:</li></ul><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="9da5" class="lg jr hh lc b fi lh li l lj lk">Assets/Editor/Builder/AndroidBuilder.cs</span></pre><ul class=""><li id="3359" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">打开命令提示符，将目录更改为包含您的项目版本的Unity.exe的文件夹:</li></ul><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="df11" class="lg jr hh lc b fi lh li l lj lk">cd C:\Program Files\Unity\Hub\Editor\&lt;EditorVersion&gt;\Editor</span></pre><ul class=""><li id="de72" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">使用以下参数运行build命令:</li></ul><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="5cd2" class="lg jr hh lc b fi lh li l lj lk">Unity.exe -batchmode -quit -projectPath “&lt;path to your project&gt;” -buildTarget Android -executeMethod AndroidBuilder.ProductionBuild -logfile “&lt;path to your project&gt;/logfileName.log”</span></pre><ul class=""><li id="99ad" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">快速浏览一下这些参数:<br/> -batchmode:在后台执行Unity。<br/> -quit:命令执行完毕后退出Unity。<br/> -projectPath:项目的路径。<br/>-build Target:Android/web GL/iOS等目标平台。<br/> -logfile:在提到的目录中创建一个构建日志文件。</li><li id="8532" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">使用以下命令运行单元测试:</li></ul><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="08a4" class="lg jr hh lc b fi lh li l lj lk">Unity.exe -batchmode -quit -runTests -testPlatform editmode -projectPath “&lt;path to your project&gt;” -testResults “&lt;Output folder for test file&gt;\TestResults.xml”</span></pre><p id="af04" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">-runTests和-testPlatform是两个特定于运行单元测试的参数。测试可以在“播放模式”或“编辑模式”下运行。</p><h1 id="8d14" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">步骤2:使用CI/CD工具构建、测试和发布</h1><p id="cc2c" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">既然我们已经了解了如何通过命令来构建Unity项目，我们就可以利用DevOps工具来持续构建代码，并将其分发给测试人员，然后最终分发给生产环境，而不必每次都手动构建。</p><p id="92fd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们看看配置发布应用程序的端到端系统所需的步骤。我们在这里使用了Jenkins pipeline的截图，但是对于其他工具来说方法也是一样的。</p><p id="9a69" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下图显示了将apk文件发布到Visual Center的步骤流程。开发人员将在git存储库中提交他们的代码。构建管道将连接到git存储库，并将构建和测试代码，并将apk作为构建工件输出。发布管道将获取构建工件，并将其发布到相应环境的分发组。</p><figure class="kx ky kz la fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es ll"><img src="../Images/e61be006da65e234958d9fc8f8ab47e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*I-7CJH4EJWI-GTJV"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx">Build and Release Flow</figcaption></figure><h2 id="768d" class="lg jr hh bd js lx ly lz jw ma mb mc ka ip md me ke it mf mg ki ix mh mi km mj bi translated">构建步骤:</h2><ul class=""><li id="9258" class="jc jd hh ig b ih ko il kp ip ku it kv ix kw jb jh ji jj jk bi translated"><strong class="ig hi">创建新的构建管道</strong>。我选择了詹金斯的自由式项目。</li></ul><figure class="kx ky kz la fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es mk"><img src="../Images/1bb9df636337f21ae99790f7451b0d7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ssUZ-SdsdizOKxIQ"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx">Creating New Item in Jenkins</figcaption></figure><ul class=""><li id="a267" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><strong class="ig hi">将你的代码库链接到管道</strong>。如果您的代码在本地机器上，您必须首先将它推送到一个代码存储库，比如Git，并使用repo链接连接到管道。</li></ul><figure class="kx ky kz la fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es ml"><img src="../Images/4636fc6eda7f80cefd6293887ec2e8da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MDy9gs0VHesQUvXL"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx">Link Repository in pipeline</figcaption></figure><ul class=""><li id="d9d4" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><strong class="ig hi">为构建触发器</strong>配置管道。<br/>您可以根据需要从可用选项中设置构建触发器。如果您希望启用持续集成，请选择“GitHub hook trigger for git SCM polling”。</li></ul><figure class="kx ky kz la fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es mm"><img src="../Images/b18da9b58203aab1548a825ca25eb771.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MpAgsp8TcJT28xUt"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx">Set up build triggers in your pipeline</figcaption></figure><ul class=""><li id="a291" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><strong class="ig hi">添加运行命令行脚本的任务/步骤，输入构建命令</strong>。请注意，在下面的截图中，我使用了“%WORKSPACE%”，这是工作目录的预定义变量。您必须为正在使用的工具更改和使用预定义的工作空间变量。</li></ul><figure class="kx ky kz la fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es mn"><img src="../Images/b701394c9a4a88ad90d9c13435000dc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hK_g1dn0HKmVuDMG"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx">Command Line task for running build</figcaption></figure><ul class=""><li id="5da9" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><strong class="ig hi">添加另一个命令行任务/步骤来运行测试命令</strong>。</li></ul><figure class="kx ky kz la fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es mo"><img src="../Images/60e56438d8646a2155af73d44a021f49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*j1lwofos_qBmsMLs"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx">Command Line task for running test in editmode</figcaption></figure><ul class=""><li id="9904" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><strong class="ig hi">添加一个发布构建工件的任务</strong>。在要发布的路径中传递生成输出目录的路径。在Jenkins中，您可以添加一个构建后操作来归档工件。</li></ul><figure class="kx ky kz la fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es mp"><img src="../Images/b206cf5d2d310b884c393b8940cba362.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*804J7Bdv9AtKgMP1"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx">creates an apk file in the Builds folder as Build artifact</figcaption></figure><h2 id="0e28" class="lg jr hh bd js lx ly lz jw ma mb mc ka ip md me ke it mf mg ki ix mh mi km mj bi translated">发布步骤:</h2><ul class=""><li id="57fe" class="jc jd hh ig b ih ko il kp ip ku it kv ix kw jb jh ji jj jk bi translated"><strong class="ig hi">创建一个新的发布管道，并将构建工件链接到发布管道</strong>。<br/>发布管道应该能够获取构建输出文件。在这里，我使用Azure DevOps来创建我的CD管道。我已经使用Azure DevOps上的服务连接将我的<a class="ae kt" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/release/integrate-jenkins-pipelines-cicd?view=azure-devops&amp;tabs=classic#link-jenkins-with-azure-pipelines%20https://docs.microsoft.com/en-" rel="noopener ugc nofollow" target="_blank"> Jenkins服务器链接到Azure DevOps，并使用链接的我的Jenkins构建管道输出作为Azure DevOps发布管道中的工件。</a></li></ul><figure class="kx ky kz la fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es mq"><img src="../Images/f581918880b59190528f193a7df6e5f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vyPzkt4E0yN8lZ41"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx">Jenkins service connection on Azure DevOps</figcaption></figure><ul class=""><li id="fa69" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><strong class="ig hi">安装VS应用中心所需的插件/任务</strong>。<br/>在发布到App Center之前，您必须首先安装VS App Center所需的任务/插件，并在您的App Center应用程序和您的部署工具之间创建一个连接(在本例中为Azure DevOps pipeline)。为此，您将需要服务器URL和API应用程序令牌。可以使用此处提供的<a class="ae kt" href="https://docs.microsoft.com/en-us/appcenter/api-docs/" rel="noopener ugc nofollow" target="_blank">步骤创建API令牌。</a></li><li id="8ccb" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated"><strong class="ig hi">为Dev创建一个新的stage并添加一个Visual Studio App Center任务</strong>。<br/>填写您的应用程序的详细信息，例如所有者姓名/用户名、版本、发布说明和分发组详细信息</li></ul><figure class="kx ky kz la fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es mr"><img src="../Images/6f779e88abf1f5dee8e2077c5104cf80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2MDEBBU-zQzf--tv"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx">Add artifacts and new stage from the Pipeline section</figcaption></figure><figure class="kx ky kz la fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es ms"><img src="../Images/15cc099d378123bd4aac0cc178a3da71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_HahWtM_AVsXVJdQ"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx">Add a task for distributing on App Center</figcaption></figure><ul class=""><li id="0972" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">您可以为测试、试运行和生产环境创建类似的发布阶段。<br/>对于生产，您必须增加一个额外的步骤来签署和调整apk。有现成的Android签名任务，您可以在发布应用程序之前使用这些任务对其进行签名。您可以将您的应用中心配置为<a class="ae kt" href="https://docs.microsoft.com/en-us/appcenter/distribution/stores/googleplay#create-a-google-play-connection-in-app-center" rel="noopener ugc nofollow" target="_blank">连接到Play Store </a>并从您的管道发布到商店。</li></ul><figure class="kx ky kz la fd lm er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es mt"><img src="../Images/f1bcbe83824c53edb19c9c7b90180b93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pojUPSqUIurlx0To"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx">Release pipeline with separate stage for each environment</figcaption></figure><p id="3407" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此外，您可以根据您对构建和发布管道的要求设置CI/CD、拉式请求、预定触发器，以实现持续集成、交付和部署。这将确保您的更改得到更频繁的测试和部署。</p><h1 id="fe8f" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">结论</h1><p id="61c2" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">我们看到了如何通过为我们的Unity项目建立一个构建和发布管道，我们可以不断地发布新版本到一个发布列表，如App Center，而没有一次又一次手动构建和发布的麻烦。您可以使用不同的CI和CD工具，就像我们在这里所做的那样，或者只使用一个工具。Jenkins作为一个构建工具完美地完成了工作，Azure DevOps提供了一个优秀的多阶段发布功能，具有发布前部署批准，这使得它可以轻松地部署到多个环境。</p><h1 id="0245" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">参考</h1><ul class=""><li id="1951" class="jc jd hh ig b ih ko il kp ip ku it kv ix kw jb jh ji jj jk bi translated"><a class="ae kt" href="https://support.unity.com/hc/en-us/articles/115000368846-How-do-I-support-different-configurations-to-build-specific-players-by-command-line-or-auto-build-system-" rel="noopener ugc nofollow" target="_blank">我如何通过命令行或自动构建支持不同的配置来构建特定的播放器… </a></li></ul><p id="b7bb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">值得一读:</p><ul class=""><li id="c452" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><a class="ae kt" href="https://bitbar.com/blog/7-process-steps-with-mobile-devops-tools/" rel="noopener ugc nofollow" target="_blank">使用移动DevOps工具的7个流程步骤——Bitbar</a></li></ul></div></div>    
</body>
</html>