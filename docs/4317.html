<html>
<head>
<title>Enforcing Team Rules with Lint: Tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Lint执行团队规则:测试</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/enforcing-team-rules-with-lint-tests-7e538a294445?source=collection_archive---------4-----------------------#2020-11-20">https://medium.com/google-developer-experts/enforcing-team-rules-with-lint-tests-7e538a294445?source=collection_archive---------4-----------------------#2020-11-20</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/9b1488af6650d93358a83c893954b768.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MFGggOfz7RfRVzpv"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo by <a class="ae it" href="https://unsplash.com/@henry_be?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Henry Be</a> on <a class="ae it" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="8291" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">几个月前，我的团队达成了一项协议，当在代码中的任何地方留下一个TODO时，我们需要始终提供几样东西:</p><ul class=""><li id="1afc" class="js jt hh iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">应该处理待办事项的人</li><li id="3f01" class="js jt hh iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">离开待办事项的日期</li><li id="fe61" class="js jt hh iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">关于需要做什么的评论或解释</li></ul><p id="66df" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我创建了一个<a class="ae it" href="https://zarah.dev/2020/03/06/live-templates.html" rel="noopener ugc nofollow" target="_blank">实时模板</a>来支持遵守这条规则，但是为什么不更进一步，将这条规则集成到我们的日常工作流程中呢？</p><p id="7b54" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们之前已经看到:</p><p id="df5f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">对我们的自定义Lint规则进行测试非常重要。我们不希望Lint错误地标记错误。这会导致挫败感，用户可能会关闭我们的规则。</p><h1 id="ecd7" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">提供文件💁</h1><p id="ff67" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">Lint检查在文件上运行，所以对于我们的每个测试用例，我们需要提供模拟文件。</p><p id="b7ee" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Lint提供了一个API，允许我们内联创建这些模拟文件。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="3250" class="ls kh hh lo b fi lt lu l lv lw">TestFiles.java(<br/>    """<br/>        package test.pkg;<br/>        public class TestClass1 {<br/>            // In a comment, mentioning "lint" has no effect<br/>         }<br/>    """<br/>)</span><span id="e726" class="ls kh hh lo b fi lx lu l lv lw">TestFiles.kotlin(<br/>     """<br/>        package test.pkg<br/>        class TestClass {<br/>            // In a comment, mentioning "lint" has no effect<br/>        }<br/>    """</span></pre><p id="8e72" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我使用<a class="ae it" href="https://kotlinlang.org/docs/reference/basic-types.html#string-literals" rel="noopener ugc nofollow" target="_blank">原始字符串</a>，这样我就不用担心转义特殊字符。</p><p id="8ad2" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">它也给了我们非常好的语法高亮！</p><figure class="lj lk ll lm fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ly"><img src="../Images/c0848ee044d07a28ea1455c7f8ebcd90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5yPT3CEiICW-5tur.png"/></div></div></figure><p id="0676" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">此外，如果你从提示中选择“编辑Kotlin片段”，Android Studio将打开一个文件编辑器。您在此编辑器中所做的任何更改都会立即反映在您的<code class="du lz ma mb lo b">TestFile</code>中。相当酷！</p><figure class="lj lk ll lm fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mc"><img src="../Images/54ec2f5be31bd44a67c0eace90fa2fa9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pt7wsUnK2KQEr7gs.png"/></div></div></figure><h1 id="ebd9" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">我们去做测试吧🔬</h1><p id="83a3" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">我们测试用例的入口是<a class="ae it" href="https://cs.android.com/android-studio/platform/tools/base/+/mirror-goog-studio-master-dev:lint/libs/lint-tests/src/main/java/com/android/tools/lint/checks/infrastructure/TestLintTask.java" rel="noopener ugc nofollow" target="_blank">testlintask</a>。我们需要为其提供以下内容:</p><ul class=""><li id="23d8" class="js jt hh iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">我们要检查的文件</li><li id="c2d3" class="js jt hh iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">我们正在测试的问题</li><li id="83b3" class="js jt hh iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">预期结果</li></ul><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="6d6b" class="ls kh hh lo b fi lt lu l lv lw">@Test<br/>fun testKotlinFileNormalComment() {<br/>    TestLintTask.lint()<br/>        .files(<br/>            TestFiles.kotlin(<br/>                """<br/>                    package test.pkg<br/>                        <br/>                    class TestClass {<br/>                        // In a comment, mentioning "lint" has no effect<br/>                    }<br/>                """<br/>            )<br/>        )<br/>        .issues(TodoDetector.ISSUE)<br/>        .run()<br/>        .expect("No warnings.")<br/>}</span></pre><p id="bb91" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">注意，我们可以选择使用<code class="du lz ma mb lo b">expect("No warnings.")</code>或<code class="du lz ma mb lo b">expectClean()</code>。</p><p id="8a07" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">对于我们预计会发生错误的测试用例，我们需要输入Lint输出的文本(即类似于您在运行<code class="du lz ma mb lo b">.gradlew :app:lintDebug</code>时在控制台中看到的内容)。最棘手的是字符串必须与<em class="md">完全匹配</em>，包括曲线的位置。</p><p id="1657" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最简单的方法是向<code class="du lz ma mb lo b">expect()</code>传递一个空字符串，让测试失败。然后，您可以将错误信息复制粘贴到您的测试中。</p><figure class="lj lk ll lm fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es me"><img src="../Images/a2da304dc4174e2a7672df3137dfa700.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NoVtqE0iQt57imFu.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Retrieving the message for an error scenario</figcaption></figure><p id="e7ff" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我为检测器编写了一些测试，包括Java和Kotlin文件、不正确的日期格式和“TODO”大小写。你可以在这里找到所有的<a class="ae it" href="https://github.com/zmdominguez/sdk_sandbox/blob/main/checks/src/test/java/dev/zarah/lint/checks/TodoDetectorTest.kt" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="c459" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">将这一切结合在一起🤝</h1><p id="1aae" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">既然我们已经编写了测试，现在终于是时候将Lint规则集成到我们的应用程序中了！</p><p id="36d1" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">首先，我们需要创建我们的<code class="du lz ma mb lo b"><a class="ae it" href="https://cs.android.com/android-studio/platform/tools/base/+/mirror-goog-studio-master-dev:lint/libs/lint-api/src/main/java/com/android/tools/lint/client/api/IssueRegistry.kt" rel="noopener ugc nofollow" target="_blank">IssueRegistry</a></code>,让Lint知道我们的自定义规则。我们还需要提供一个API值；对于自定义规则，我们可以使用Lint API定义的常量。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="c6b5" class="ls kh hh lo b fi lt lu l lv lw">@Suppress("UnstableApiUsage")<br/>class IssueRegistry : IssueRegistry() {<br/>    override val issues: List&lt;Issue&gt; = listOf(<br/>        TodoDetector.ISSUE<br/>    )<br/><br/>    override val api = CURRENT_API<br/>}</span></pre><p id="6719" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">然后，我们通过在一个<code class="du lz ma mb lo b">META-INF/services/</code>文件夹下创建一个具有完全限定名称的文件来注册我们的<code class="du lz ma mb lo b">IssueRegistry</code>:🙌</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="321e" class="ls kh hh lo b fi lt lu l lv lw">src/main/resources/META-INF/services/dev.zarah.lint.checks.IssueRegistry</span></pre><p id="3dea" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">大多数帖子提到添加这个注册表就足够了，我可能做错了什么，但是我发现对于我的项目，我仍然必须通过将它添加到我的<code class="du lz ma mb lo b">build.gradle.kts</code>文件来将我的<code class="du lz ma mb lo b">IssueRegistry</code>包含在清单中:</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="d2f1" class="ls kh hh lo b fi lt lu l lv lw">tasks {<br/>  jar {<br/>    manifest {<br/>      attributes(<br/>          "Lint-Registry-v2" to "dev.zarah.lint.checks.IssueRegistry"<br/>      )<br/>    }<br/>  }<br/>}</span></pre><p id="d689" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们已经设置好了一切，现在是时候使用我们的自定义lint规则了！在您希望应用规则的模块中，在<code class="du lz ma mb lo b">dependencies</code>闭包中添加一个<code class="du lz ma mb lo b">lintChecks</code>条目，构建您的项目，一切都应该准备好了！🏃‍♀</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="7a45" class="ls kh hh lo b fi lt lu l lv lw">dependencies {<br/>    lintChecks project(':checks')<br/>}</span></pre><h1 id="1674" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">看到它的实际应用📽️</h1><p id="8239" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">终于！我们已经到了旅程的终点！这是我们的探测器:</p><figure class="lj lk ll lm fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mf"><img src="../Images/f66c5befe05f66b69ab97b14935c2900.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LYwefC3Szkha8Dgp.gif"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Custom lint rule with quickfix</figcaption></figure><p id="00b4" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这个Lint系列的源代码是Github 上的<a class="ae it" href="https://github.com/zmdominguez/sdk_sandbox/tree/main/checks" rel="noopener ugc nofollow" target="_blank">(</a><a class="ae it" href="https://github.com/zmdominguez/sdk_sandbox/pull/25" rel="noopener ugc nofollow" target="_blank">diff</a>)。🙇‍♀</p><p id="853d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我在做这个任务的时候学到了很多东西。</p><p id="593a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">正如我在Twitter上提到的，几乎没有任何公开的文档。我看过的演讲对我来说太深奥了(例如，我需要在点击之前理解PSI和UAST是什么，大多数演讲甚至都没有定义它们)。</p><p id="c721" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">有很多尝试和错误，所以。很多。猜测。这非常令人沮丧。感谢麦克·伊文斯耐心地指导我一小时又一小时地进行结对编程。如果他不帮忙，我都不知道从何说起。当然，我可以从样本中复制粘贴，但是我想知道为什么事情是这样做的——这就是我学习的方式。</p><p id="6431" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我可能在写这些帖子的时候做了错误的假设🤷‍♀:但同样，没有文件，所以这是我能做的最好的。😅</p><p id="8c62" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">无论如何，我想说的是，我通常只看到其他人工作的最终成果，有时我不禁感到嫉妒——为什么他们觉得这超级容易，而我却在这里哭，因为我什么都不懂？我需要提醒自己，沮丧是可以的，慢慢学习是可以的，寻求帮助是可以的。</p><h1 id="86f0" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">进一步阅读(和/或观看)📖</h1><p id="a96a" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">如果您想了解更多，这里有一些关于Lint和自定义Lint规则的资源:</p><p id="ae49" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">- <a class="ae it" href="https://youtu.be/jCmJWOkjbM0" rel="noopener ugc nofollow" target="_blank">按风格编码:采用自定义Lint规则的静态分析，Android Dev Summit 2019 </a>(艾伦·维韦雷特、拉胡尔·拉维库马尔)<br/> - <a class="ae it" href="https://youtu.be/p8yX5-lPS6o" rel="noopener ugc nofollow" target="_blank">采用Android Lint的Kotlin静态分析</a> (Tor Norbye) <br/> - <a class="ae it" href="https://cs.android.com/android-studio/platform/tools/base/+/mirror-goog-studio-master-dev:lint/libs/lint-api/src/main/java/com/android/tools/lint/detector/api/" rel="noopener ugc nofollow" target="_blank"> Lint API源代码</a> <br/> - <a class="ae it" href="https://cs.android.com/androidx/platform/frameworks/support/+/androidx-master-dev:docs/LINT.md" rel="noopener ugc nofollow" target="_blank"> AndroidX文档</a> <br/> - <a class="ae it" href="https://github.com/alexjlockwood/android-lint-checks-demo" rel="noopener ugc nofollow" target="_blank"> Android Lint检查演示</a>(亚历克斯·洛克伍德)<br/> - <a class="ae it" href="https://groups.google.com/g/lint-dev" rel="noopener ugc nofollow" target="_blank"> lint-dev谷歌组【T11</a></p></div><div class="ab cl mg mh go mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ha hb hc hd he"><p id="2ba8" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="md">原载于2020年11月20日</em><a class="ae it" href="https://zarah.dev/2020/11/20/todo-test.html" rel="noopener ugc nofollow" target="_blank"><em class="md">https://zarah . dev</em></a><em class="md">。</em></p></div></div>    
</body>
</html>