<html>
<head>
<title>JankStats Goes Alpha</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JankStats变成Alpha</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/jankstats-goes-alpha-8aff942255d5?source=collection_archive---------3-----------------------#2022-02-09">https://medium.com/androiddevelopers/jankstats-goes-alpha-8aff942255d5?source=collection_archive---------3-----------------------#2022-02-09</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/15b695e85caf4167b235e0b09798b88c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2MwXp6fzSjDvD5VT52csag.png"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">Illustration by Virginia Poltrack</figcaption></figure><div class=""/><div class=""><h2 id="d774" class="pw-subtitle-paragraph it hv hw bd b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk dx translated">一个在现实世界中追捕jank的图书馆</h2></div><blockquote class="jl"><p id="3156" class="jm jn hw bd jo jp jq jr js jt ju jv dx translated">邱建(名词):糟糕的应用程序性能会导致丢帧、不连续的用户界面动作和糟糕的用户体验。请参阅“不满意的用户”</p></blockquote><p id="ea03" class="pw-post-body-paragraph jw jx hw jy b jz ka ix kb kc kd ja ke kf kg kh ki kj kk kl km kn ko kp kq jv ha bi translated">调试性能问题是…困难的。通常，不清楚从哪里开始，使用什么工具，用户有什么问题，或者这些问题如何在现实世界的设备上表现出来。</p><p id="ba29" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">Android团队在过去几年中提供了更多工具来调试问题的不同部分，从分析<a class="ae kw" rel="noopener" href="/androiddevelopers/app-startup-part-1-34f57b65cacd">启动性能</a>到测试<a class="ae kw" href="https://developer.android.com/studio/profile/benchmark" rel="noopener ugc nofollow" target="_blank">特定代码路径</a>到测试和优化特定<a class="ae kw" href="https://developer.android.com/studio/profile/macrobenchmark-intro" rel="noopener ugc nofollow" target="_blank">用例</a>到<a class="ae kw" href="https://developer.android.com/studio/profile/android-profiler" rel="noopener ugc nofollow" target="_blank">IDE</a>中的可视化分析器。所有这些都是为了开发时测试，以帮助您调试和修复您在本地看到的问题。</p><p id="22a2" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">与此同时，Google Play的<a class="ae kw" href="https://support.google.com/googleplay/android-developer/answer/9844486?visit_id=637793617854677762-3147968388&amp;rd=1" rel="noopener ugc nofollow" target="_blank"> Android Vitals </a>和<a class="ae kw" href="https://firebase.google.com/products/performance" rel="noopener ugc nofollow" target="_blank"> Firebase </a>都提供了仪表盘，开发者可以在那里看到他们的应用在用户设备上的表现。</p><p id="207a" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">但是，仍然很难知道如何找到您的应用程序在真实情况下可能存在的问题，尤其是发生在用户设备上的问题，而不仅仅是您在舒适的椅子上使用的方便的开发机器上看到的情况。性能仪表板会有所帮助，但它们不一定能提供您需要的详细程度，让您知道当您的用户遇到问题时发生了什么。</p><p id="f90b" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">进入<strong class="jy hx"> JankStats </strong>:第一个专门构建的AndroidX库，用于检测和报告用户设备上应用程序的性能问题。</p><p id="2c1f" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">JankStats是一个相对较小的API，主要有三个目标:捕获每帧的性能信息，在用户(不仅仅是开发)设备上运行您的应用程序，以及在应用程序出现性能问题时支持检测和报告应用程序中发生的情况。</p><h1 id="61dc" class="kx ky hw bd kz la lb lc ld le lf lg lh jc li jd lj jf lk jg ll ji lm jj ln lo bi translated">每帧性能</h1><p id="08ba" class="pw-post-body-paragraph jw jx hw jy b jz lp ix kb kc lq ja ke kf lr kh ki kj ls kl km kn lt kp kq jv ha bi translated">Android平台已经提供了获取帧性能数据的方法。例如，您可以从API 24开始使用FrameMetrics，我们已经在最近的版本中添加了它，以提供更多的信息。如果您运行的是早期版本，有多种方法可以获得不太准确但仍然有用的计时信息。</p><p id="e397" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">因此，如果您想让您自己的帧持续时间逻辑在所有版本中工作，您需要在API版本中实现这些不同的机制。或者您可以使用单个的JankStats API，它可以为您完成这项工作…此外还提供了更多的特性(继续阅读！).</p><p id="0bca" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">JankStats通过提供单个API来报告每帧持续时间，并在内部委托给适当的机制(API 24+上的<code class="du lu lv lw lx b"><a class="ae kw" href="https://developer.android.com/reference/android/view/FrameMetrics" rel="noopener ugc nofollow" target="_blank">FrameMetrics</a></code>等)，从而简化了这一过程。您不必担心这些数据是从哪里来的，您只需让JankStats告诉您事情花了多长时间，您就可以得到带有这些信息的回调。</p><p id="583b" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">创建和监听JankStats数据本质上非常简单:创建数据，然后坐下来(好吧，代码坐下来)监听。以下是来自JankStats示例的这些步骤的示例，<a class="ae kw" href="https://github.com/android/performance-samples/blob/main/JankStatsSample/app/src/main/java/com/example/jankstats/JankLoggingActivity.kt" rel="noopener ugc nofollow" target="_blank"> JankLoggingActivity </a>:</p><pre class="ly lz ma mb fd mc lx md me aw mf bi"><span id="8820" class="mg ky hw lx b fi mh mi l mj mk">val jankFrameListener = JankStats.OnFrameListener { frameData -&gt;<br/>  // real app would do something more interesting than log this...<br/>  Log.v("JankStatsSample", frameData.toString())<br/>}</span><span id="9d3b" class="mg ky hw lx b fi ml mi l mj mk">jankStats = JankStats.createAndTrack(<br/>    window,<br/>    Dispatchers.Default.asExecutor(),<br/>    jankFrameListener,<br/>)</span></pre><p id="0060" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">那个<code class="du lu lv lw lx b">Log.v()</code>调用是…不是你应该在你的应用中做的，它只是为了举例。相反，您可能应该聚合/存储/上传数据以供以后分析，而不是仅仅将数据放到日志中。无论如何，下面是它在API 30模拟器上运行时产生的结果的示例(为了清楚起见，删除了一些logcat噪声并添加了空白行):</p><pre class="ly lz ma mb fd mc lx md me aw mf bi"><span id="7f97" class="mg ky hw lx b fi mh mi l mj mk">JankStats.OnFrameListener: FrameData(frameStartNanos=827233150542009, frameDurationUiNanos=27779985, frameDurationCpuNanos=31296985, isJank=false, states=[Activity: JankLoggingActivity])</span><span id="7b5c" class="mg ky hw lx b fi ml mi l mj mk">JankStats.OnFrameListener: FrameData(frameStartNanos=827314067288736, frameDurationUiNanos=89903592, frameDurationCpuNanos=94582592, isJank=true, states=[RecyclerView: Dragging, Activity: JankLoggingActivity])</span><span id="dc63" class="mg ky hw lx b fi ml mi l mj mk">JankStats.OnFrameListener: FrameData(frameStartNanos=827314167288732, frameDurationUiNanos=88641926, frameDurationCpuNanos=91526926, isJank=true, states=[RecyclerView: Settling, RecyclerView: Dragging, Activity: JankLoggingActivity])</span><span id="01e4" class="mg ky hw lx b fi ml mi l mj mk">JankStats.OnFrameListener: FrameData(frameStartNanos=827314183945923, frameDurationUiNanos=4731405, frameDurationCpuNanos=8283405, isJank=false, states=[RecyclerView: Settling, Activity: JankLoggingActivity])</span></pre><p id="1199" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">你可以在记录的<code class="du lu lv lw lx b">frameData</code>中看到一些有趣的片段:</p><ul class=""><li id="5e8e" class="mm mn hw jy b jz kr kc ks kf mo kj mp kn mq jv mr ms mt mu bi translated">有一些带<code class="du lu lv lw lx b">isJank=true</code>的框架。该日志取自示例应用程序<code class="du lu lv lw lx b">JankLoggingActivity</code>的运行，它位于下面链接的<a class="ae kw" href="https://github.com/android/performance-samples/tree/main/JankStatsSample" rel="noopener ugc nofollow" target="_blank">示例</a>中。那个应用强制一些长帧(谢谢，<code class="du lu lv lw lx b">Thread.sleep()</code>！)，这导致由JankStats进行这种jank确定。</li><li id="c7b3" class="mm mn hw jy b jz mv kc mw kf mx kj my kn mz jv mr ms mt mu bi translated">帧持续时间信息具有UI和CPU数据。在API 24之前(引入<code class="du lu lv lw lx b">FrameMetrics</code>时)，只有UI持续时间。</li><li id="b6f3" class="mm mn hw jy b jz mv kc mw kf mx kj my kn mz jv mr ms mt mu bi translated">日志是从我开始抛出RecyclerView的时候开始的。当recycle view开始移动(“拖动”)和滚动(“稳定”)时，我们可以看到关于UI状态的信息。下面更多关于提供这种UI状态的内容。</li></ul><h1 id="6709" class="kx ky hw bd kz la lb lc ld le lf lg lh jc li jd lj jf lk jg ll ji lm jj ln lo bi translated">真实世界数据</h1><p id="137c" class="pw-post-body-paragraph jw jx hw jy b jz lp ix kb kc lq ja ke kf lr kh ki kj ls kl km kn lt kp kq jv ha bi translated">与最近的基准测试库不同，JankStats的创建是为了提供来自用户设备的结果。在你的开发机器上调试问题是很棒的，但是对于那些你的应用被真实世界中的真实的人在非常不同的设备上，在非常不同的约束下使用的情况，这没有帮助。</p><p id="59f3" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">JankStats提供了一个API来检测您的应用程序，以提供您需要的性能数据和一个报告机制，以便您可以获得这些数据来进行离线上传和分析。</p><h1 id="4779" class="kx ky hw bd kz la lb lc ld le lf lg lh jc li jd lj jf lk jg ll ji lm jj ln lo bi translated">精神状态</h1><p id="b46e" class="pw-post-body-paragraph jw jx hw jy b jz lp ix kb kc lq ja ke kf lr kh ki kj ls kl km kn lt kp kq jv ha bi translated">最后(听好了:这是这个库真正的新事物)，JankStats提供了一种方法来了解当性能问题发生时，应用程序中实际发生了什么。我们经常听到的抱怨是，现有的工具、仪表板和方法没有为您提供足够的<em class="na">上下文</em>来处理您的用户可能会看到的性能问题。</p><p id="c01f" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">例如，FrameMetrics API(在API 24中引入，在JankStats中内部使用)可以告诉您绘制帧需要多长时间，您可以从中获得jank信息。但是它不能告诉你当时你的应用程序里发生了什么。当您尝试检测您的代码并将其与FrameMetrics或其他性能度量工具集成时，这个问题就留给您自己去解决了。但是每个人都有足够的事情要做，而不必在内部构建这种基础设施，所以jank通常不被测量，性能问题继续存在。</p><p id="347a" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">同样，Android Vitals仪表板可以告诉你你的应用程序有性能问题，但它不能告诉你当这些问题发生时你的应用程序正在做什么。所以很难知道如何处理这些信息。</p><p id="afdf" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">JankStats引入了<code class="du lu lv lw lx b">PerformanceMetricsState</code> API，这是一组简单的方法，允许您通过成对的<code class="du lu lv lw lx b">String</code>随时告诉系统您的应用程序中正在发生什么。例如，您可能希望记录某个特定的<code class="du lu lv lw lx b">Activity</code>或<code class="du lu lv lw lx b">Fragment</code>何时处于活动状态，或者某个<code class="du lu lv lw lx b">RecyclerView</code>何时正在滚动。</p><p id="82cb" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">例如，以下是来自JankStats示例的代码，显示了如何检测RecyclerView以向JankStats提供此信息:</p><pre class="ly lz ma mb fd mc lx md me aw mf bi"><span id="0aac" class="mg ky hw lx b fi mh mi l mj mk">val scrollListener = object : RecyclerView.OnScrollListener() {<br/>  override fun onScrollStateChanged(recyclerView: RecyclerView,<br/>                                    newState: Int)<br/>  {<br/>    val metricsState = metricsStateHolder?.state ?: return <br/>      when (newState) {<br/>        RecyclerView.SCROLL_STATE_DRAGGING -&gt; {<br/>          metricsState.addState("RecyclerView", "Dragging")<br/>        }<br/>        RecyclerView.SCROLL_STATE_SETTLING -&gt; {<br/>          metricsState.addState("RecyclerView", "Settling")<br/>        }<br/>        else -&gt; {<br/>          metricsState.removeState("RecyclerView")<br/>        }<br/>     }<br/>  }<br/>}</span></pre><p id="a46b" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">这个状态可以从应用程序中的任何地方注入(甚至可以从另一个库中注入)，当JankStats报告结果时，它会被选中。这样，当您从JankStats获得报告时，您不仅会发现每一帧花费了多长时间，还会发现用户在该帧中做了什么，这可能是一个影响因素。</p><h1 id="048d" class="kx ky hw bd kz la lb lc ld le lf lg lh jc li jd lj jf lk jg ll ji lm jj ln lo bi translated">资源</h1><p id="8911" class="pw-post-body-paragraph jw jx hw jy b jz lp ix kb kc lq ja ke kf lr kh ki kj ls kl km kn lt kp kq jv ha bi translated">这里有一些资源供您了解更多关于JankStats的信息:</p><p id="bdd3" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated"><strong class="jy hx"> AndroidX项目</strong> : JankStats在AndroidX 的<a class="ae kw" href="https://developer.android.com/jetpack/androidx/releases/metrics#1.0.0-alpha01" rel="noopener ugc nofollow" target="_blank"> androidx.metrics库中。</a></p><p id="efcf" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated"><strong class="jy hx">文档</strong>:我们的开发者网站有一个新的<a class="ae kw" href="https://developer.android.com/studio/profile/jankstats" rel="noopener ugc nofollow" target="_blank">开发者指南</a>，描述了如何使用JankStats。</p><p id="1bb4" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated"><strong class="jy hx">示例代码</strong>:这个<a class="ae kw" href="https://github.com/android/performance-samples/tree/main/JankStatsSample" rel="noopener ugc nofollow" target="_blank">项目</a>有一些示例，展示了如何实例化和监听JankStats对象，以及如何用重要的UI状态信息来检测您的应用程序:</p><div class="hg hh ez fb hi nb"><a href="https://github.com/android/performance-samples/tree/main/JankStatsSample" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab dw"><div class="nd ab ne cl cj nf"><h2 class="bd hx fi z dy ng ea eb nh ed ef hv bi translated">主android上的performance-samples/jankstats sample/performance-samples</h2><div class="ni l"><h3 class="bd b fi z dy ng ea eb nh ed ef dx translated">这个示例项目展示了如何使用JankStats库。它包括多个简单的示例活动…</h3></div><div class="nj l"><p class="bd b fp z dy ng ea eb nh ed ef dx translated">github.com</p></div></div><div class="nk l"><div class="nl l nm nn no nk np ho nb"/></div></div></a></div><p id="94f6" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated"><strong class="jy hx">bug，bug，bug</strong>:如果你对库有任何问题，或者有API请求，请<a class="ae kw" href="https://issuetracker.google.com/issues/new?component=1109743&amp;template=1621342" rel="noopener ugc nofollow" target="_blank">提交bug </a>。</p><h1 id="17a5" class="kx ky hw bd kz la lb lc ld le lf lg lh jc li jd lj jf lk jg ll ji lm jj ln lo bi translated">Alpha -&gt; 1.0</h1><p id="2529" class="pw-post-body-paragraph jw jx hw jy b jz lp ix kb kc lq ja ke kf lr kh ki kj ls kl km kn lt kp kq jv ha bi translated">JankStats刚刚推出了它的第一个alpha版本，这意味着“我们认为这是对1.0版本有意义的API和功能，但请试用并让我们知道。”</p><p id="97b4" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">未来我们还想对JankStats做一些其他的事情，包括添加某种聚合机制，甚至与现有的上传服务同步。但是我们想把第一个版本和基本的管道系统一起推出来，看看你如何使用它，以及你还想看到什么。我们希望它在目前的基本状态下是有用的；仅仅是能够方便地检测和记录UI状态信息就应该比没有这种能力要好。</p><p id="09a9" class="pw-post-body-paragraph jw jx hw jy b jz kr ix kb kc ks ja ke kf kt kh ki kj ku kl km kn kv kp kq jv ha bi translated">所以<a class="ae kw" href="https://developer.android.com/jetpack/androidx/releases/metrics#1.0.0-alpha01" rel="noopener ugc nofollow" target="_blank">得到</a>它，玩玩它，<a class="ae kw" href="https://issuetracker.google.com/issues/new?component=1109743&amp;template=1621342" rel="noopener ugc nofollow" target="_blank">让我们知道你是否有任何问题</a>。而且最重要的是；找到并修复那些性能问题！你的用户在等你——不要让他们等太久！</p></div></div>    
</body>
</html>