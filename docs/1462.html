<html>
<head>
<title>Using a Pre-Trained TensorFlow Model on Android — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Android上使用预先训练好的TensorFlow模型—第2部分</h1>
<blockquote>原文：<a href="https://medium.com/capital-one-tech/using-a-pre-trained-tensorflow-model-on-android-part-2-153ebdd4c465?source=collection_archive---------1-----------------------#2017-08-26">https://medium.com/capital-one-tech/using-a-pre-trained-tensorflow-model-on-android-part-2-153ebdd4c465?source=collection_archive---------1-----------------------#2017-08-26</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/83167334c5934ca5fe9a7807c6c6ea7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xEeStdLoylMMhihqUAMAdQ.png"/></div></div></figure><p id="fa62" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在第1部分的<a class="ae jn" rel="noopener" href="/@daj/using-a-pre-trained-tensorflow-model-on-android-e747831a3d6">中，我向您介绍了<code class="du jo jp jq jr b">TensorFlowInferenceInterface</code>和<code class="du jo jp jq jr b">org.tensorflow:tensorflow-android</code>依赖关系。它们一起提供了一种将预训练TensorFlow模型嵌入您的Android应用程序的简单方法。</a></p><p id="3397" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在本帖中，我们将通过查看这个简单的GitHub项目示例来挖掘更多细节:</p><div class="js jt ez fb ju jv"><a href="https://github.com/daj/AndroidTensorFlowMNISTExample" rel="noopener  ugc nofollow" target="_blank"><div class="jw ab dw"><div class="jx ab jy cl cj jz"><h2 class="bd hi fi z dy ka ea eb kb ed ef hg bi translated">daj/androidtensorflowmnitestexample</h2><div class="kc l"><h3 class="bd b fi z dy ka ea eb kb ed ef dx translated">Android TensorFlow mnistexample-Android tensor flow机器学习MNIST示例(使用tensor flow为……</h3></div><div class="kd l"><p class="bd b fp z dy ka ea eb kb ed ef dx translated">github.com</p></div></div><div class="ke l"><div class="kf l kg kh ki ke kj in jv"/></div></div></a></div><h2 id="64c4" class="kk kl hh bd km kn ko kp kq kr ks kt ku ja kv kw kx je ky kz la ji lb lc ld le bi translated">从属关系中有什么？</h2><p id="ce0e" class="pw-post-body-paragraph ip iq hh ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">让我们看看<code class="du jo jp jq jr b">org.tensorflow:tensorflow-android</code>依赖给我们的项目带来了什么。Android Studio中的项目视图让我们可以浏览到<code class="du jo jp jq jr b">app/build/intermediates/exploded-aar</code>文件夹，看看下载了什么。</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lk"><img src="../Images/4601a3a2dbd3dfdfb7f943cf504a7d56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mMfMXW_as-iiatCo3DC5mg.png"/></div></div></figure><p id="e9dd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们可以看到，对于四种架构的每一种，我们都有一个本地二进制文件:<code class="du jo jp jq jr b">arm64-v8a</code>、<code class="du jo jp jq jr b">armeabi-v7a</code>、<code class="du jo jp jq jr b">x86</code>和<code class="du jo jp jq jr b">x86_64</code>。还有一个包含<code class="du jo jp jq jr b">TensorFlowInferenceInterface</code>和其他支持类的<code class="du jo jp jq jr b">classes.jar </code>。</p><h2 id="c92d" class="kk kl hh bd km kn ko kp kq kr ks kt ku ja kv kw kx je ky kz la ji lb lc ld le bi translated">项目结构</h2><p id="6a32" class="pw-post-body-paragraph ip iq hh ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">我们的张量流图(。pb)和标签(。txt)都在<code class="du jo jp jq jr b">app/src/main/assets</code>里。</p><p id="96eb" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">TensorFlowImageClassifier</code>与<code class="du jo jp jq jr b">TensorFlowInferenceInterface</code>接口。</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div class="er es lp"><img src="../Images/f015788cb52fd31d82ee1c673734f824.png" data-original-src="https://miro.medium.com/v2/resize:fit:718/format:webp/1*g-RfWddwQiPH4GUosv6ecw.png"/></div></figure><h2 id="55ba" class="kk kl hh bd km kn ko kp kq kr ks kt ku ja kv kw kx je ky kz la ji lb lc ld le bi translated">代码—初始化</h2><p id="4ac3" class="pw-post-body-paragraph ip iq hh ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">初始化<code class="du jo jp jq jr b">TensorFlowInferenceInterface</code>。</p><pre class="ll lm ln lo fd lq jr lr ls aw lt bi"><span id="ec94" class="kk kl hh jr b fi lu lv l lw lx">c.inferenceInterface = new TensorFlowInferenceInterface(assetManager, modelFilename);</span></pre><h2 id="024a" class="kk kl hh bd km kn ko kp kq kr ks kt ku ja kv kw kx je ky kz la ji lb lc ld le bi translated">代码-模型定义</h2><p id="243e" class="pw-post-body-paragraph ip iq hh ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">我们需要定义一些与张量流模型接口所需的名称和大小。</p><p id="3cef" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">下面显示的大多数值来自<a class="ae jn" href="https://github.com/daj/AndroidTensorFlowMNISTExample/blob/master/app/src/main/java/com/mindorks/tensorflowexample/MainActivity.java#L54" rel="noopener ugc nofollow" target="_blank">主活动</a>。</p><pre class="ll lm ln lo fd lq jr lr ls aw lt bi"><span id="b246" class="kk kl hh jr b fi lu lv l lw lx">private static final String <em class="ly">MODEL_FILE </em>= <br/>        "file:///android_asset/mnist_model_graph.pb";<br/>private static final String <em class="ly">LABEL_FILE </em>=<br/>        "file:///android_asset/graph_label_strings.txt";</span></pre><p id="21b4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这些模型和标签文件的名称与我们之前在<code class="du jo jp jq jr b">assets</code>文件夹中看到的文件相匹配。</p><pre class="ll lm ln lo fd lq jr lr ls aw lt bi"><span id="026a" class="kk kl hh jr b fi lu lv l lw lx">private static final String <em class="ly">INPUT_NAME </em>= "input";<br/>private static final String <em class="ly">OUTPUT_NAME </em>= "output";</span></pre><p id="f657" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">模型的输入和输出的名称来自我们的<a class="ae jn" href="https://github.com/daj/AndroidTensorFlowMNISTExample/blob/master/mnist.py#L144" rel="noopener ugc nofollow" target="_blank"> mnist.py </a>训练脚本。该脚本包含许多从头开始训练模型所需的复杂命令，但这些行显示了输入和输出张量的定义位置:</p><pre class="ll lm ln lo fd lq jr lr ls aw lt bi"><span id="efbd" class="kk kl hh jr b fi lu lv l lw lx">x_2 = tf.placeholder(“float”, shape=[None, 784], name=”<strong class="jr hi">input</strong>”)</span><span id="10b7" class="kk kl hh jr b fi lz lv l lw lx">&lt;snip&gt;</span><span id="cde9" class="kk kl hh jr b fi lz lv l lw lx">OUTPUT = tf.nn.softmax(tf.matmul(FC1, W_OUT) + B_OUT, name="<strong class="jr hi">output</strong>")</span></pre><p id="f45c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="ly">另一种确定输入和输出节点名称的方法是</em> <a class="ae jn" rel="noopener" href="/@daj/how-to-inspect-a-pre-trained-tensorflow-model-5fd2ee79ced0"> <em class="ly">将TensorFlow模型导入TensorBoard </em> </a> <em class="ly">并在那里检查。</em></p><p id="087b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们需要指定的最后一件事是输入大小。</p><pre class="ll lm ln lo fd lq jr lr ls aw lt bi"><span id="a099" class="kk kl hh jr b fi lu lv l lw lx">private static final int <em class="ly">INPUT_SIZE </em>= 28;</span></pre><p id="4c4a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在MNIST的例子中，我们的训练数据都是28×28像素的字符图像；为了简单起见，我们的示例项目让用户在28x28“像素”的画布上绘制他们的角色(通过将28 传递到<a class="ae jn" href="https://github.com/daj/AndroidTensorFlowMNISTExample/blob/master/app/src/main/java/com/mindorks/tensorflowexample/view/DrawModel.java" rel="noopener ugc nofollow" target="_blank"> DrawModel </a>类构造函数中来实现<a class="ae jn" href="https://github.com/daj/AndroidTensorFlowMNISTExample/blob/master/app/src/main/java/com/mindorks/tensorflowexample/MainActivity.java#L39" rel="noopener ugc nofollow" target="_blank">)。</a></p><p id="b330" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为什么我们真的需要定义这个？根据代码注释:</p><blockquote class="ma mb mc"><p id="b8fc" class="ip iq ly ir b is it iu iv iw ix iy iz md jb jc jd me jf jg jh mf jj jk jl jm ha bi translated">理想情况下，inputSize可以从输入操作的形状中检索。遗憾的是，graphdef中通常使用的输入占位符节点并不指定形状，因此它必须作为参数传入。</p></blockquote><p id="a13a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">幸运的是，outputSize直接从张量流模型获得:</p><pre class="ll lm ln lo fd lq jr lr ls aw lt bi"><span id="af72" class="kk kl hh jr b fi lu lv l lw lx">int numClasses =<br/>        (int) c.inferenceInterface.graph().operation(outputName).output(0).shape().size(1);</span></pre><h2 id="e7df" class="kk kl hh bd km kn ko kp kq kr ks kt ku ja kv kw kx je ky kz la ji lb lc ld le bi translated">代码—通过<code class="du jo jp jq jr b">TensorFlowInferenceInterface</code>运行分类器</h2><p id="bfca" class="pw-post-body-paragraph ip iq hh ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">现在，我们需要将用户绘制的28x28像素图片传递到我们预先训练好的分类器中。</p><p id="0180" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">下面是来自<a class="ae jn" href="https://github.com/daj/AndroidTensorFlowMNISTExample/blob/master/app/src/main/java/com/mindorks/tensorflowexample/TensorFlowImageClassifier.java#L121" rel="noopener ugc nofollow" target="_blank">tensorflowimagecordinator</a>的recognizeImage方法的一些(简化的)亮点:</p><pre class="ll lm ln lo fd lq jr lr ls aw lt bi"><span id="d9a2" class="kk kl hh jr b fi lu lv l lw lx">@Override<br/>public List&lt;Recognition&gt; recognizeImage(final float[] pixels) {<br/>    // Copy the input data into TensorFlow.<br/>    inferenceInterface.<strong class="jr hi">feed</strong>(inputName, pixels, new long[]{inputSize * inputSize});<br/><br/>    // Run the inference call.<br/>    inferenceInterface.<strong class="jr hi">run</strong>(outputNames);<br/><br/>    // Copy the output Tensor back into the output array.<br/>    inferenceInterface.<strong class="jr hi">fetch</strong>(outputName, outputs);<br/><br/>    // Find the best classifications.<br/>    for (int i = 0; i &lt; outputs.length; ++i) {<br/>        &lt;snip&gt; <br/>    }</span><span id="92c6" class="kk kl hh jr b fi lz lv l lw lx">    return recognitions;<br/>}</span></pre><p id="05ed" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们在像素数据中<code class="du jo jp jq jr b">feed</code>，<code class="du jo jp jq jr b">run</code>分类器，然后<code class="du jo jp jq jr b">fetch</code>输出。</p><p id="620a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然后对这些输出进行排序，以获得具有最高置信度(高于指定阈值)的输出，并显示给用户:</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div class="er es mg"><img src="../Images/8abfb0a8f6528bec4ab6c0c47647eb8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:450/format:webp/1*zoB2JpP97KsbkrAEt3oFDw.png"/></div></figure><p id="4f52" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">你可以在<a class="ae jn" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/android/README.md" rel="noopener ugc nofollow" target="_blank">tensor flow Android contrib</a>中阅读更多关于<a class="ae jn" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/android/java/org/tensorflow/contrib/android/TensorFlowInferenceInterface.java" rel="noopener ugc nofollow" target="_blank">TensorFlowInferenceInterface.java</a>的信息。</p><h2 id="7f23" class="kk kl hh bd km kn ko kp kq kr ks kt ku ja kv kw kx je ky kz la ji lb lc ld le bi translated"><code class="du jo jp jq jr b">Warning — the TensorFlowInferenceInterface </code> API变更！</h2><p id="4caf" class="pw-post-body-paragraph ip iq hh ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">TensorFlow仍在积极开发中，TensorFlow的r1.1和r1.2版本之间的<code class="du jo jp jq jr b">TensorFlowInferenceInterface</code>发生了变化。</p><p id="dea8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">通过查看位于r1.1 (使用<code class="du jo jp jq jr b">fillNodeFloat</code>)和r1.2 (使用<code class="du jo jp jq jr b">feed</code>)的TensorFlowImageClassifier <a class="ae jn" href="https://github.com/tensorflow/tensorflow/blob/r1.1/tensorflow/examples/android/src/org/tensorflow/demo/TensorFlowImageClassifier.java#L153" rel="noopener ugc nofollow" target="_blank">可以看到这一点。</a></p><p id="5260" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您正在查看旧的示例，这可能会让您感到困惑。</p><p id="fc8d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="ly">声明:这些观点仅代表作者个人观点。除非本帖中另有说明，否则Capital One不属于所提及的任何公司，也不被其认可。使用或展示的所有商标和其他知识产权都是其各自所有者的所有权。本文为2017首都一。</em></p><p id="3208" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="ly">如需了解更多关于Capital One的API、开源、社区活动和开发者文化的信息，请访问我们的一站式开发者门户网站DevExchange:</em><a class="ae jn" href="https://developer.capitalone.com/" rel="noopener ugc nofollow" target="_blank"><em class="ly">https://developer.capitalone.com/</em></a></p></div></div>    
</body>
</html>