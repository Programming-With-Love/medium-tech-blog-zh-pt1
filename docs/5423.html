<html>
<head>
<title>Using Packer to build Windows based images for Oracle Cloud Infrastructure Classic</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Packer为Oracle云基础架构Classic构建基于Windows的映像</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/using-packer-to-build-windows-based-images-for-oracle-cloud-infrastructure-classic-e38545376dfc?source=collection_archive---------0-----------------------#2018-03-28">https://medium.com/oracledevs/using-packer-to-build-windows-based-images-for-oracle-cloud-infrastructure-classic-e38545376dfc?source=collection_archive---------0-----------------------#2018-03-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="41d6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Packer在2月份推出了对在Oracle Cloud infra structure Classic上构建映像的支持。</p><ul class=""><li id="3e1c" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><a class="ae jl" href="https://blogs.oracle.com/developers/announcing-packer-builder-for-oracle-cloud-infrastructure-classic" rel="noopener ugc nofollow" target="_blank">宣布面向Oracle云基础设施的Packer Builder Classic</a></li></ul><p id="4b7e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">自最初发布以来，packer <code class="du jm jn jo jp b">oracle-classic</code> builder已经添加了对启用配置Windows映像的<code class="du jm jn jo jp b">WinRM</code>支持。在这篇文章中，我们将看看如何创建一个WinRM支持的打包配置</p><p id="4746" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下已经用<code class="du jm jn jo jp b"><a class="ae jl" href="https://www.packer.io/downloads.html" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">packer v1.2.2</strong></a></code>测试过了。这里是主<code class="du jm jn jo jp b">packer.json</code>配置文件</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="3fcf" class="jy jz hh jp b fi ka kb l kc kd">{<br/>  "variables": {<br/>    "username": "user@example.com",<br/>    "password": "Pa55_Word",<br/>    "domain": "example",<br/>    "endpoint": "https://api-z61.compute.us6.oraclecloud.com/"<br/>  },<br/>  "builders": [<br/>    {<br/>      "type": "oracle-classic",<br/>      "username": "{{user `username`}}",<br/>      "password": "{{user `password`}}",<br/>      "identity_domain": "{{user `domain`}}",<br/>      "api_endpoint": "{{user `endpoint`}}",<br/>      "shape": "oc3",<br/><strong class="jp hi">      "source_image_list": "/Compute-{{user `domain`}}/{{user `username`}}/Microsoft_Windows_Server_2012_R2-18.1.2-20180110-070846",<br/></strong>      "dest_image_list": "Packer_Windows_Demo",<br/>      "image_name": "Packer_Windows_Demo_{{timestamp}}",<br/>      "image_description": "My Packer Built Windows Image",<br/><strong class="jp hi">      "attributes_file": "./windows_attributes.json",<br/>      "communicator": "winrm",<br/>      "winrm_username": "Administrator",<br/>      "winrm_password": "Pa55_Word"<br/></strong>    }<br/>  ],<br/>  "provisioners": [<br/>    {<br/>      "type": "powershell",<br/>      "inline": "Write-Output(\"HELLO WORLD\")"<br/>    }<br/>  ]<br/>}</span></pre><p id="3b90" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du jm jn jo jp b">communicator</code>、<code class="du jm jn jo jp b">winrm_username</code>和<code class="du jm jn jo jp b">winrm_password</code>设置packer builder通过WinRM提供实例。其他需要配置的Windows实例特定属性是源图像列表和<code class="du jm jn jo jp b">opc-init</code>配置的属性文件</p><h2 id="f34e" class="jy jz hh bd ke kf kg kh ki kj kk kl km ip kn ko kp it kq kr ks ix kt ku kv kw bi translated">源图像列表</h2><p id="81b1" class="pw-post-body-paragraph ie if hh ig b ih kx ij ik il ky in io ip kz ir is it la iv iw ix lb iz ja jb ha bi translated"><code class="du jm jn jo jp b"><strong class="ig hi">source_image_list</strong></code>必须是创建新映像的源映像的全限定引用。Oracle云基础架构经典版的基本Windows服务器映像由Oracle在<a class="ae jl" href="https://cloud.oralce.com/marketplace" rel="noopener ugc nofollow" target="_blank"> Oracle云市场</a>上提供。</p><p id="57d1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">允许访问您域中的Windows映像:</p><ol class=""><li id="22c7" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb lc ji jj jk bi translated">在Compute Classic控制台中选择“<strong class="ig hi">创建实例</strong>”，然后选择“<strong class="ig hi">显示所有图像</strong>”选项</li><li id="50c3" class="jc jd hh ig b ih ld il le ip lf it lg ix lh jb lc ji jj jk bi translated">从“<strong class="ig hi"> Marketplace </strong>”部分选择所需的Windows Server版本。</li><li id="8b39" class="jc jd hh ig b ih ld il le ip lf it lg ix lh jb lc ji jj jk bi translated">一旦镜像安装被确认，你可以<strong class="ig hi">取消</strong>这个“创建实例”流程</li></ol><figure class="jq jr js jt fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es li"><img src="../Images/46fa2e9f4580f0ec0d28c5c37c6444ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xHU-d2EjtJXDzkMYxWKAwg.png"/></div></div></figure><p id="1350" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要找到窗口服务器映像的完全限定名，您可以使用<code class="du jm jn jo jp b"><a class="ae jl" href="http://www.oracle.com/technetwork/topics/cloud/downloads/opc-cli-3096036.html" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">opc-cli</strong></a></code>实用程序查询可用的映像列表，例如</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="989a" class="jy jz hh jp b fi ka kb l kc kd">$ <strong class="jp hi">opc compute image-lists list /Compute-example/</strong><br/>/Compute-example/user@example.com/Microsoft_Windows_Server_2012_R2-18.1.2-20180110-070846</span></pre><h2 id="21ab" class="jy jz hh bd ke kf kg kh ki kj kk kl km ip kn ko kp it kq kr ks ix kt ku kv kw bi translated">属性文件</h2><p id="6eb9" class="pw-post-body-paragraph ie if hh ig b ih kx ij ik il ky in io ip kz ir is it la iv iw ix lb iz ja jb ha bi translated">打包器配置中的<code class="du jm jn jo jp b"><strong class="ig hi">attributes_file</strong></code>属性引用本地json文件，该文件包含在启动时提供给基本实例的<code class="du jm jn jo jp b">opc-init</code>实例供应属性。该文件至少必须包含配置有<strong class="ig hi">的<code class="du jm jn jo jp b">administrator_password</code>，该<strong class="ig hi">与为封隔器配置中的<code class="du jm jn jo jp b">winrm_password</code> <strong class="ig hi"> </strong>设置的</strong>密码相同。</strong></p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="a30e" class="jy jz hh jp b fi ka kb l kc kd">{<br/>    "<strong class="jp hi">userdata</strong>": {<br/>        "<strong class="jp hi">administrator_password</strong>": "Pa55_Word",<br/>        "<strong class="jp hi">winrm</strong>": {}<br/>    }<br/>}</span></pre><p id="9933" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">可以配置附加的<code class="du jm jn jo jp b">userdata</code>属性来设置可信主机、创建用户和运行预引导脚本。有关更多详细信息，请参见<a class="ae jl" href="https://docs.oracle.com/en/cloud/iaas/compute-iaas-cloud/stcsg/automating-instance-initialization-using-opc-init.html#GUID-C63680F1-1D97-4984-AB02-285B17278CC5" rel="noopener ugc nofollow" target="_blank">使用opc-init </a>文档中的<a class="ae jl" href="https://docs.oracle.com/en/cloud/iaas/compute-iaas-cloud/stcsg/automating-instance-initialization-using-opc-init.html#GUID-E3A674C1-855B-4AD4-BB3E-A4A8F24189E3" rel="noopener ugc nofollow" target="_blank">Windows实例上使用的用户数据属性</a>部分。</p><h2 id="52c2" class="jy jz hh bd ke kf kg kh ki kj kk kl km ip kn ko kp it kq kr ks ix kt ku kv kw bi translated">WinRM设置程序</h2><p id="c775" class="pw-post-body-paragraph ie if hh ig b ih kx ij ik il ky in io ip kz ir is it la iv iw ix lb iz ja jb ha bi translated">启用WinRM后，打包程序可以使用<code class="du jm jn jo jp b"><a class="ae jl" href="https://www.packer.io/docs/provisioners/powershell.html" rel="noopener ugc nofollow" target="_blank">powershell</a></code>和<code class="du jm jn jo jp b"><a class="ae jl" href="https://www.packer.io/docs/provisioners/windows-shell.html" rel="noopener ugc nofollow" target="_blank">windows-shell</a></code>供应程序供应新实例。在这个例子中，我们只是输出一个“Hello World”消息来演示provisoner正在工作</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="995d" class="jy jz hh jp b fi ka kb l kc kd">  "provisioners": [<br/>    {<br/>      "type": "<strong class="jp hi">powershell</strong>",<br/>      "inline": "<strong class="jp hi">Write-Output(\"HELLO WORLD\")</strong>"<br/>    }<br/>  ]</span></pre><h1 id="be5d" class="lq jz hh bd ke lr ls lt ki lu lv lw km lx ly lz kp ma mb mc ks md me mf kv mg bi translated">运行打包程序构建</h1><p id="1bab" class="pw-post-body-paragraph ie if hh ig b ih kx ij ik il ky in io ip kz ir is it la iv iw ix lb iz ja jb ha bi translated">现在我们已经完成了打包程序的配置，让我们运行构建来创建新的映像</p><pre class="jq jr js jt fd ju jp jv jw aw jx bi"><span id="c692" class="jy jz hh jp b fi ka kb l kc kd">$ <strong class="jp hi">packer build packer.json</strong></span><span id="a0cd" class="jy jz hh jp b fi mh kb l kc kd"><strong class="jp hi">oracle-classic output will be in this color.</strong></span><span id="cf91" class="jy jz hh jp b fi mh kb l kc kd"><strong class="jp hi">==&gt; oracle-classic: Creating temporary ssh key for instance...<br/></strong>oracle-classic: Creating temporary IP reservation: ipres_Packer_Windows_Demo_1522198317_5abae72e-34f3-26b4-73dd-c445c3d92088<br/><strong class="jp hi">==&gt; oracle-classic: Not using SSH communicator; skip generating SSH keys...<br/>==&gt; oracle-classic: Configuring security lists and rules to enable WINRM access...<br/>==&gt; oracle-classic: Creating Instance...<br/></strong>oracle-classic: Created instance: 47a97edc-df17-41cd-a660-46420c402131.<br/><strong class="jp hi">==&gt; oracle-classic: Waiting for WinRM to become available...<br/></strong>oracle-classic: WinRM connected.<br/>oracle-classic: #&lt; CLIXML<br/>oracle-classic: &lt;Objs Version="1.1.0.1" &gt;&lt;Obj S="progress" RefId="0"&gt;&lt;TN RefId="0"&gt;&lt;T&gt;System.Management.Automation.PSCustomObject&lt;/T&gt;&lt;T&gt;System.Object&lt;/T&gt;&lt;/TN&gt;&lt;MS&gt;&lt;I64 N="SourceId"&gt;1&lt;/I64&gt;&lt;PR N="Record"&gt;&lt;AV&gt;Preparing modules for first use.&lt;/AV&gt;&lt;AI&gt;0&lt;/AI&gt;&lt;Nil /&gt;&lt;PI&gt;-1&lt;/PI&gt;&lt;PC&gt;-1&lt;/PC&gt;&lt;T&gt;Completed&lt;/T&gt;&lt;SR&gt;-1&lt;/SR&gt;&lt;SD&gt; &lt;/SD&gt;&lt;/PR&gt;&lt;/MS&gt;&lt;/Obj&gt;&lt;Obj S="progress" RefId="1"&gt;&lt;TNRef RefId="0" /&gt;&lt;MS&gt;&lt;I64 N="SourceId"&gt;2&lt;/I64&gt;&lt;PR N="Record"&gt;&lt;AV&gt;Preparing modules for first use.&lt;/AV&gt;&lt;AI&gt;0&lt;/AI&gt;&lt;Nil /&gt;&lt;PI&gt;-1&lt;/PI&gt;&lt;PC&gt;-1&lt;/PC&gt;&lt;T&gt;Completed&lt;/T&gt;&lt;SR&gt;-1&lt;/SR&gt;&lt;SD&gt; &lt;/SD&gt;&lt;/PR&gt;&lt;/MS&gt;&lt;/Obj&gt;&lt;/Objs&gt;<br/><strong class="jp hi">==&gt; oracle-classic: Connected to WinRM!<br/>==&gt; oracle-classic: Provisioning with Powershell...<br/>==&gt; oracle-classic: Provisioning with powershell script: /var/folders/b1/6p_97r4531b4zrtr7p3zs1f40000gn/T/packer-powershell-provisioner540599988<br/></strong>oracle-classic: HELLO WORLD<br/><strong class="jp hi">==&gt; oracle-classic: Creating Snapshot...<br/></strong>oracle-classic: Created snapshot: 47a97edc-df17-41cd-a660-46420c402131/276e9428-d77f-4852-9685-8f6673c4d4e4.<br/><strong class="jp hi">==&gt; oracle-classic: Adding image to image list...<br/>==&gt; oracle-classic: 404: {"message": "ImageList does not exist"}<br/>==&gt; oracle-classic: Destination image list Packer_Windows_Demo does not exist; Creating it...<br/></strong>oracle-classic: Image list https://api-z61.compute.us6.oraclecloud.com/imagelist/Compute-ptstest/stephen.cross%40oracle.com/Packer_Windows_Demo created!<br/>oracle-classic: created image list entry<br/><strong class="jp hi">==&gt; oracle-classic: Deleting Snapshot...<br/>==&gt; oracle-classic: Terminating source instance...<br/>==&gt; oracle-classic: Terminated instance.<br/>==&gt; oracle-classic: Deleting temporary rules and lists...<br/>==&gt; oracle-classic: Cleaning up IP reservations...<br/>Build 'oracle-classic' finished.</strong></span><span id="c371" class="jy jz hh jp b fi mh kb l kc kd">==&gt; Builds finished. The artifacts of successful builds are:<br/>--&gt; oracle-classic: An image list entry was created:<br/>Name: Packer_Windows_Demo_1522198317<br/>File: image/47a97edc-df17-41cd-a660-46420c402131-276e9428-d77f-4852-9685-8f6673c4d4e4-snapshot.tar.gz<br/>Version: 1</span></pre><p id="fa44" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">新创建的映像现在可用于启动新实例。</p><figure class="jq jr js jt fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es li"><img src="../Images/70a9788940b192e3f01ec36ce7eae816.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vc20zUvQ__NuLi7OjFbaWA.png"/></div></div></figure></div></div>    
</body>
</html>