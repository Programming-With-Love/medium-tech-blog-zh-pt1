<html>
<head>
<title>Field Level Encryption in Azure CosmosDb Documents</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure CosmosDb文档中的字段级加密</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/field-level-encryption-in-azure-cosmosdb-documents-c701f605754e?source=collection_archive---------4-----------------------#2020-08-29">https://medium.com/walmartglobaltech/field-level-encryption-in-azure-cosmosdb-documents-c701f605754e?source=collection_archive---------4-----------------------#2020-08-29</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="1124" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在当今世界，客户的数据安全和隐私至关重要。当您开始采用云时，这变得尤为重要。</p><p id="a8e1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通常，您还必须遵守特定产品领域的法规遵从性。例如，如果你进入<strong class="ig hi">电子商务</strong>的领域并处理用户的信用卡信息，你必须符合<strong class="ig hi"> PCI DSS </strong>。如果你进入了<strong class="ig hi">医疗保健</strong>领域，你可能必须遵守<strong class="ig hi"> HIPAA </strong>标准，这取决于你处理的医疗保健数据的种类</p><p id="5cbc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过防火墙设置限制您的云PaaS(平台即服务)组件，可能是可以应用的最基本的安全措施。但是，这并不能完全保护您的数据免受其他内部团队的攻击，例如云管理员、数据库管理员等。</p><p id="1763" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">加密助您一臂之力</strong> —有了加密，数据的完全控制权现在归特定的企业所有者和技术团队所有，而不会将解密的数据泄露给未经授权和授权的各方。</p><h1 id="5a95" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated"><strong class="ak">用例</strong></h1><p id="efab" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">作为云迁移的一部分，我们需要在Cosmos中存储JSON文档，文档中的一些字段非常敏感。</p><p id="6fba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们桌子上的加密选项如下。</p><ol class=""><li id="e609" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb kk kl km kn bi translated"><strong class="ig hi">将整个文档存储为加密的blob </strong></li></ol><ul class=""><li id="6bb4" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb ko kl km kn bi translated">优点:这更容易实现</li><li id="299c" class="kf kg hh ig b ih kq il kr ip ks it kt ix ku jb ko kl km kn bi translated"><em class="kp">缺点</em>:对字段没有可搜索性(将数据库简化为键值存储)，加密和解密的成本更高，基本可调试性丧失，即现在即使是对文档的基本检查也需要解密</li></ul><p id="ebe2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2.<strong class="ig hi">仅加密高度敏感的字段</strong></p><ul class=""><li id="3827" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb ko kl km kn bi translated"><em class="kp">优点</em>:允许在索引字段上搜索，更低的加密和解密成本，支持基本的可调试性。</li><li id="ba2c" class="kf kg hh ig b ih kq il kr ip ks it kt ix ku jb ko kl km kn bi translated"><em class="kp">缺点</em>:实现起来相对复杂，仍然需要解决对加密字段的搜索。</li></ul><p id="a25a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于上述“选项2”的优势，我们选择继续进行。此外，加密有两种标准形式</p><ul class=""><li id="8ed8" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb ko kl km kn bi translated"><strong class="ig hi"> <em class="kp">随机化</em> </strong>:使用随机CEK(内容加密密钥)，所以同样的文本会有不同的加密输出。这被认为是更安全的，但是您失去了在字段上搜索的能力</li><li id="c6dd" class="kf kg hh ig b ih kq il kr ip ks it kt ix ku jb ko kl km kn bi translated"><strong class="ig hi"> <em class="kp">确定性</em> </strong> —使用标准CEK，这样相同的文本将有相同的加密输出。</li></ul><p id="326c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如上所述，我们对这些字段中的一些有搜索需求，所以我们不得不用确定性加密来解决。</p><h1 id="a5ac" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">挑战</h1><p id="a918" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">由于CosmosDb不提供任何可以加密特定字段的现成功能，所以我们必须想出自己的解决方案。</p><p id="4f3c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们还必须以无缝的方式解决这个问题，以便所有加密和解密的复杂性都被查询/DAO层吸收，并且客户端不需要特别地参与相同的细节，例如，加密文本并传递到Cosmos查询</p><p id="7f37" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">根据我们的信息安全要求，如果使用确定性模式，我们还必须经常轮换加密密钥。</p><h1 id="0fcf" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">加密基础</h1><p id="2db8" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">在我们深入研究如何解决它的细节之前，下面是加密方法的一些基础知识。</p><ul class=""><li id="9d25" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb ko kl km kn bi translated">加密由一个名为<em class="kp"> CEK(内容加密密钥)</em>的标准密钥完成</li><li id="c4ad" class="kf kg hh ig b ih kq il kr ip ks it kt ix ku jb ko kl km kn bi translated">在系统的生命周期中,<em class="kp"> CEK </em>不会改变，因为如果我们需要改变<em class="kp"> CEK </em>的话，重新加密所有历史数据会有很大的开销。</li><li id="abf7" class="kf kg hh ig b ih kq il kr ip ks it kt ix ku jb ko kl km kn bi translated">为了确保您的<em class="kp"> CEK </em>的健全性/安全性，它以加密的方式存储在您的配置系统中，通过另一个名为<em class="kp"> CMK(内容主密钥)</em>的密钥进行加密。</li><li id="75c3" class="kf kg hh ig b ih kq il kr ip ks it kt ix ku jb ko kl km kn bi translated"><em class="kp"> CMK </em>可以旋转，在任何时间点都应该有至少两个版本的加密<em class="kp"> CEKs </em>(一个用旧的CMK加密，另一个用新的CMK加密)，您的应用程序(在这种情况下是DAO层)可以理解，以支持CMK的无缝旋转。</li><li id="b556" class="kf kg hh ig b ih kq il kr ip ks it kt ix ku jb ko kl km kn bi translated">CMK主要由HSM支持/提供。</li></ul><p id="3cbb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="kp">总结流程:</em> </strong></p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/78d04ebcd76310597f47728993573c92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fzYex7RTkOWjR64_"/></div></div></figure><blockquote class="lh li lj"><p id="95dc" class="ie if kp ig b ih ii ij ik il im in io lk iq ir is ll iu iv iw lm iy iz ja jb ha bi translated">应用程序发出参数化查询。库(Cosmos客户端库)拥有加密列的元数据。</p><p id="bf1b" class="ie if kp ig b ih ii ij ik il im in io lk iq ir is ll iu iv iw lm iy iz ja jb ha bi translated"><strong class="ig hi"> 1。</strong>库从列元数据中获取加密算法，此后加密CEK和CMK的位置</p><p id="06e3" class="ie if kp ig b ih ii ij ik il im in io lk iq ir is ll iu iv iw lm iy iz ja jb ha bi translated"><strong class="ig hi"> 2。然后，库联系密钥库并检索CMK来解密CEK。缓存解密的CEK以减少往返次数(如果允许)</strong></p><p id="98d0" class="ie if kp ig b ih ii ij ik il im in io lk iq ir is ll iu iv iw lm iy iz ja jb ha bi translated"><strong class="ig hi"> 3。然后，库使用解密的CEK加密查询中的参数，并将查询发送到服务器。</strong></p><p id="568c" class="ie if kp ig b ih ii ij ik il im in io lk iq ir is ll iu iv iw lm iy iz ja jb ha bi translated"><strong class="ig hi"> 4。</strong>如果读取查询，结果中返回的加密列由库使用相同的CEK解密。</p></blockquote><h1 id="6668" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">解决办法</h1><p id="1127" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">通常Spring数据仓库在抽象Crud方法方面做得非常好，我们使用spring-data-cosmosdb进行我们的cosmosdb交互。其中一种方法是在spring数据层之上添加加密功能作为包装。</p><ol class=""><li id="edb7" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb kk kl km kn bi translated"><strong class="ig hi"> <em class="kp">定义加密元数据</em> </strong></li></ol><p id="e917" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们提出了一种可以在包含加密元数据的实体对象的字段上定义的注释。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="ln lo l"/></div></figure></div><div class="ab cl lp lq go lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ha hb hc hd he"><ul class=""><li id="29d5" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb ko kl km kn bi translated"><em class="kp">encryption type</em>&amp;<em class="kp">encryption algorithm</em>—不言自明，它们表示加密的类型和用于加密的算法。</li><li id="86af" class="kf kg hh ig b ih kq il kr ip ks it kt ix ku jb ko kl km kn bi translated"><em class="kp"> ceKid </em> —这是配置系统中<em class="kp"> CEK </em>的密钥标识符，即表示存储加密CEK的密钥。由于不同的字段可能具有不同的CEK，元数据指示用于该字段的特定密钥标识符。</li><li id="9af9" class="kf kg hh ig b ih kq il kr ip ks it kt ix ku jb ko kl km kn bi translated">可缓存—这是一个字段，指示您是否可以缓存未加密的密钥或在每次需要使用它时解密它(这是一个您需要采取的安全措施，因为内存转储可能会暴露您的CEK)</li></ul><p id="3f1f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2.<strong class="ig hi"> <em class="kp">储酒桶</em> </strong></p><p id="fec4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们选择使用单独的Cosmos集合来存储加密的CEKs。然而，cek还需要存储主密钥的元数据。所以我们为CEK和CMK设计了以下POJO对象。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="ln lo l"/></div></figure><ul class=""><li id="02d1" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb ko kl km kn bi translated"><em class="kp">关键路径值</em>—HSM层中的CMK密钥标识符。</li><li id="7215" class="kf kg hh ig b ih kq il kr ip ks it kt ix ku jb ko kl km kn bi translated"><em class="kp">providerName</em>—providerName是HSM访问层的一个实现。因为它在不同的团队/组织之间会有所不同，所以我们选择保持它的抽象，实现下面的接口。</li></ul><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="c494" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">KeyStoreProvider的特定于客户端的实现可以在应用程序启动时向KeyStoreManager注册，以便它们可供crypto实用工具类使用。</p><p id="0b0f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">3.<strong class="ig hi"> <em class="kp">扩展DocumentDbPersistentProperty存储CryptoMetadata </em> </strong></p><p id="e798" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">spring-data-cosmosdb中的DocumentDbPersistentProperty类存储字段元数据，例如，它是id还是partitionKey字段。我们对其进行了扩展，以存储来自步骤1中定义的注释的加密元数据。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="5722" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="kp"> 4。扩展MappingDocumentDbConverter</em></strong></p><p id="a693" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">MappingDocumentDbConverter是EntityConverter类，它负责将POJO转换为Cosmos文档对象，反之亦然。因此，加密(写)和解密(读)字段的功能是通过扩展转换器来实现的。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="ln lo l"/></div></figure><h1 id="1843" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated"><strong class="ak">结论</strong></h1><p id="45b6" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">加密带来了一些我们都应该意识到的缺点。</p><ol class=""><li id="be25" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb kk kl km kn bi translated"><em class="kp">将所有查询转换为绑定查询</em> —之前我们曾提供预构建的字符串作为查询，因为所有的Cosmos查询都被转换为POST请求，与JDBC的查询缓存不同，绑定参数并没有给我们带来多少优势。这种方法没有帮助我们识别字段元数据，即，如果它是一个加密的字段，数据应该加密并在查询参数中传递给服务器。</li><li id="9727" class="kf kg hh ig b ih kq il kr ip ks it kt ix ku jb kk kl km kn bi translated"><em class="kp">加密列中不支持基于范围的查询</em> —显然，加密列破坏了文本/数字的顺序/排序语义。因此这些列不支持基于范围的查询。</li></ol><p id="2c0c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">字段级加密确保了在保护云上的客户数据和简化基本调试之间的良好平衡。</p><h1 id="bf51" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">承认</h1><p id="48a0" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">合著者<a class="lw lx ge" href="https://medium.com/u/bb9e68824db8?source=post_page-----c701f605754e--------------------------------" rel="noopener" target="_blank">拉凯什·潘迪特</a></p><p id="f80c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">来自<a class="lw lx ge" href="https://medium.com/u/206b04e5090e?source=post_page-----c701f605754e--------------------------------" rel="noopener" target="_blank"> Srinivas Devarakonda </a>和<a class="lw lx ge" href="https://medium.com/u/2cf58d95bc2e?source=post_page-----c701f605754e--------------------------------" rel="noopener" target="_blank"> Krishna Kanth Annamraju </a>的重要意见</p></div></div>    
</body>
</html>