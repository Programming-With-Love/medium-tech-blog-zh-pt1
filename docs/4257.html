<html>
<head>
<title>Cutting down over 95% of your BigQuery costs using File Loads</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用文件加载降低95%以上的大查询成本</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/trimming-down-over-95-of-your-bigquery-costs-using-file-loads-d08dd3d8b2fd?source=collection_archive---------2-----------------------#2019-08-30">https://medium.com/google-developer-experts/trimming-down-over-95-of-your-bigquery-costs-using-file-loads-d08dd3d8b2fd?source=collection_archive---------2-----------------------#2019-08-30</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/af87c659bace17eef9e34b5cfd7fb0f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*afZUCqsL-nk4Nshxdbps4w.png"/></div></div></figure><p id="80e9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">TL；dr </strong>:使用相对较低频率的文件加载，而不是使用云数据流的流插入</p><p id="9abc" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这个故事是我写的那个故事的前传<a class="ae jn" rel="noopener" href="/@harshithdwivedi/how-disabling-external-ips-helped-us-cut-down-over-80-of-our-cloud-dataflow-costs-259d25aebe74">在这里</a>(是的，我是星战迷，续集在前传之前🤷‍♂️)</p><div class="jo jp ez fb jq jr"><a rel="noopener follow" target="_blank" href="/@harshithdwivedi/how-disabling-external-ips-helped-us-cut-down-over-80-of-our-cloud-dataflow-costs-259d25aebe74"><div class="js ab dw"><div class="jt ab ju cl cj jv"><h2 class="bd hi fi z dy jw ea eb jx ed ef hg bi translated">禁用外部IPs如何帮助我们削减超过80%的云数据流成本</h2><div class="jy l"><h3 class="bd b fi z dy jw ea eb jx ed ef dx translated">被“通过运营商对等网络的网络出口”的疯狂成本所困扰？请继续阅读，因为这篇文章正是你正在寻找的…</h3></div><div class="jz l"><p class="bd b fp z dy jw ea eb jx ed ef dx translated">medium.com</p></div></div><div class="ka l"><div class="kb l kc kd ke ka kf in jr"/></div></div></a></div><p id="9801" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你读了上面的博客文章，你就会知道我们正试图建立一个实时数据聚合管道，为此，我们在GCP家族中使用了以下产品:</p><ol class=""><li id="6fe1" class="kg kh hh ir b is it iw ix ja ki je kj ji kk jm kl km kn ko bi translated"><strong class="ir hi">应用引擎</strong>:接收来自用户网页和应用的请求。</li><li id="867b" class="kg kh hh ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated"><strong class="ir hi"> PubSub </strong>:一个可伸缩且可靠的消息队列，接受传入App Engine的消息。</li><li id="6066" class="kg kh hh ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated"><strong class="ir hi">数据流</strong>:数据处理管道，读取来自发布订阅的消息，并根据我们的需要对其进行转换。</li><li id="f5eb" class="kg kh hh ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated"><strong class="ir hi">big query</strong>:data flow摄取的所有数据都保存在其中的数据仓库。</li></ol><p id="07fd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这里的挑战显然是保持系统的吞吐量和可靠性尽可能高，同时保持延迟和成本最低。</p><p id="fd43" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">就目前情况而言，我们每天处理超过3亿个事件，这些事件通过Google Cloud数据流一到达就存储到BigQuery中，以确保事件一发出就可供我们的客户使用(保证有<strong class="ir hi"> &lt; 4秒</strong>的延迟)。</p><p id="0b3b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">有趣的是，我们的一些客户并不完全想要接近实时的数据；对他们来说，稍微晚一点(比如说几分钟)就能得到的数据也是一样好的，只要他们能为此支付更少的费用。</p><p id="aeb4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在流插入，虽然对我们提供的实时性至关重要；有一个相关的成本，提供一个延迟的数据意味着我们可以通过批量插入BigQuery来节省一些成本！</p><p id="3c5a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们回去看了一下BigQuery提供的定价计划，令我们惊讶的是，从外部来源加载数据到BigQuery是免费的！</p><p id="3331" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这意味着，如果我们可以将传入的事件存储到Google云存储桶中，然后让BigQuery加载这些保存的事件，<a class="ae jn" href="https://cloud.google.com/bigquery/pricing#free" rel="noopener ugc nofollow" target="_blank">这是免费的</a>！</p><figure class="kv kw kx ky fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ku"><img src="../Images/46ae05e828493ca2e15e5c508653e02d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G2fGepCC8KSDQ-0zyFpNYg.png"/></div></div></figure><p id="f28f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们不得不承担的唯一代价是在Google Cloud Storag bucket中存储和下载事件；如果您在同一个区域输入和输出数据，这也是<a class="ae jn" href="https://cloud.google.com/storage/pricing#network-pricing" rel="noopener ugc nofollow" target="_blank">免费的(我们是！).</a></p><figure class="kv kw kx ky fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kz"><img src="../Images/0a220d2d6cae0e32d404c98acf210874.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TjxW5nNMx09LZX0aAEeU7g.png"/></div></div></figure><p id="41a0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">弄清楚要做什么之后，剩下的唯一事情就是修改我们的数据流管道，将数据保存并加载到BigQuery中，而不是像现在这样流式传输。</p><p id="bccc" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">多亏了Apache Beam提供的简单API，这变成了一个不到5分钟的任务。</p><figure class="kv kw kx ky fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es la"><img src="../Images/851e7ffca061e6e352430335194948d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PW_FeYqGzQOCRk44axrc1w.png"/></div></div><figcaption class="lb lc et er es ld le bd b be z dx">Less than 3 lines of code, and you’re done!</figcaption></figure><p id="399f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在你可能想知道为什么我们不把频率降低到一个更小的数字(比如3秒)来模拟流插入的实时特性。</p><p id="1332" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当然，这将是一个很好的选择，但有一些限制，阻止我们这样做。</p><ol class=""><li id="5f1a" class="kg kh hh ir b is it iw ix ja ki je kj ji kk jm kl km kn ko bi translated"><strong class="ir hi"> BigQuery API限制<br/> </strong>在撰写本文时，每天可以在BigQuery上执行的加载作业数量被限制在1000个，大约每90秒一次。<br/>请注意，这是一个硬限制，不能增加</li><li id="879d" class="kg kh hh ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated"><strong class="ir hi">数据流增加的内存需求<br/> </strong>数据流将所有传入的消息保存在其内存中，一旦达到触发频率，它会将它们上传到Google云存储，因此我们部署的新管道最终需要2个核心CPU和13.5GB内存，而我们的旧设置是1个核心CPU和3.75GB内存。虽然这并没有阻止我们实施接近实时的加载作业，但它会增加您的计费成本。</li></ol><p id="e2da" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们最终将触发频率设置为90秒，这足以让我们的客户(他们对延迟的延迟很满意)满意，并帮助我们减少了不必要的定价。</p><p id="8c4a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这里有一个快速截图，展示了我们实施文件加载前后的成本。</p><figure class="kv kw kx ky fd ii er es paragraph-image"><div class="er es lf"><img src="../Images/43bc1b70019f41c4b35642eabb060f9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/1*d-brRN5tYRyKGKXFfv2JLA.png"/></div><figcaption class="lb lc et er es ld le bd b be z dx">August 23rd afternoon was when we implemented File Loads</figcaption></figure><p id="a35c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">但这不全是钟声和低语；正如你在这篇博客中看到的<a class="ae jn" rel="noopener" href="/@harshithdwivedi/how-disabling-external-ips-helped-us-cut-down-over-80-of-our-cloud-dataflow-costs-259d25aebe74">，我们遇到了另一个问题(经过几周的搜索和研究，我们设法解决了这个问题)。</a></p><p id="fe50" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你在一家高速发展的公司工作，并且希望你的数据一创建出来就可以使用；看看<a class="ae jn" href="https://roobits.com/" rel="noopener ugc nofollow" target="_blank">https://roobits.com/</a>吧，我们可能就是你要找的人！</p><p id="495c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="lg">感谢阅读！如果你喜欢这个故事，请点击</em><strong class="ir hi"><em class="lg"/></strong>👏<strong class="ir hi"> <em class="lg">按钮</em> </strong> <em class="lg"> </em> <strong class="ir hi"> <em class="lg">并分享</em> </strong> <em class="lg">帮助别人找到它！欢迎留言评论</em>💬<em class="lg">下图。</em></p><p id="190f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="lg">有反馈？下面我们来连线推特上的</em><a class="ae jn" href="https://twitter.com/harshithdwivedi" rel="noopener ugc nofollow" target="_blank"><em class="lg"/></a><em class="lg">。</em></p></div></div>    
</body>
</html>