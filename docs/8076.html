<html>
<head>
<title>Getting started with Apache Spark + GPU + RAPIDS (part-I)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Spark + GPU + RAPIDS入门(第一部分)</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/getting-started-with-apache-spark-gpu-rapids-part-i-938664771092?source=collection_archive---------0-----------------------#2021-11-10">https://medium.com/walmartglobaltech/getting-started-with-apache-spark-gpu-rapids-part-i-938664771092?source=collection_archive---------0-----------------------#2021-11-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/667105c47cfe9b622c53bba83da9231f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y0lj6ex1ZmqX6juiPZkSyg.png"/></div></div></figure><p id="461f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">先决条件:</strong>本文假设读者了解Spark 3.0的架构和设置，并且已经使用过Spark 2.0。</p><p id="a1b3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Spark 3.0版本增加了一个新特性，使用RAPIDS库在GPU上运行Spark工作负载。该功能将帮助数据科学家/数据工程师使用单一工具创建从ETL(提取转换负载)/ELT(提取负载转换)到模型训练的单一管道。这个特性的主要优点是Spark可以在CPU和GPU之间无缝切换处理。下一段中的概念验证(PoC)细节旨在帮助您启动Apache Spark + GPU + RAPIDS之旅，在我的案例中，我在基于GCP (Google云平台)的Spark 3.0 Dataproc集群上执行了PoC，该集群运行Dataproc 2.0.7、CUDA 10.2、RAPIDS 0.18和Spark RAPIDS 0.4.1。相同的PoC可以在任何其他云平台上试用。关于本文的一个标注——它完全基于Spark 3.0的数据工程观点。</p></div><div class="ab cl jn jo go jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ha hb hc hd he"><p id="c39b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">第一步是启用RAPIDS库。在将<strong class="ir hi"> spark.rapids.sql.enabled </strong>设置为<strong class="ir hi"> true </strong>之后，我们将指示spark利用底层GPU进行处理，只要有在GPU上运行特定指令的选项。GPU不支持的指令将自动退回到CPU进行处理。将<strong class="ir hi"> spark.rapids.sql.enabled </strong>设置为false将只在CPU上运行您的指令。<br/>在本文的后面，我将举例说明如何检查哪个部分在GPU上执行，哪个部分在CPU上执行。</p><p id="96bc" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">既然我们已经知道了如何在GPU上启用Spark，那么让我们来看看一些可以用来优化处理的重要配置参数。</p><p id="f6ec" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">spark . task . resource . gpu . amount</strong>:设置每个任务的GPU资源量</p><p id="2fe5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">spark . rapids . SQL . concurrentgputasks</strong>:设置并发GPU任务的数量</p><p id="3da0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">spark . executor . resource . gpu . amount</strong>:设置每个执行器的GPU数量</p><p id="cfa9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">理想情况下，CPU上的并行度应该等于GPU上的并行度，这样才不会浪费资源-</p><blockquote class="ju jv jw"><p id="f1a4" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated"><strong class="ir hi"> GPU并行度</strong>= spark . executor . resource . GPU . amount/spark . task . resource . GPU . amount</p><p id="e763" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated"><strong class="ir hi"> CPU并行度</strong>= spark . executor . cores/spark . task . CPU</p></blockquote><p id="f02f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">让我们用一个例子来理解这一点，</p><p id="e1cd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">假设，我们有4个核心CPU连接到一个GPU。有三种可能的情况，让我们从第一种情况开始，使用带有运行时配置的spark-shell运行每一种情况，同样可以使用配置文件设置来实现:</p><p id="78c3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi"> GPU并行度= CPU并行度</strong></p><blockquote class="ju jv jw"><p id="27b1" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">火花壳</p><p id="e6c6" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">— — conf spark.executor.cores=4</p><p id="4fee" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">——conf spark . task . resource . GPU . amount = . 25</p><p id="6d5e" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">——conf spark . task . CPU = 1</p><p id="fe63" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">——conf spark . executor . instances = 4</p><p id="8170" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">——conf spark . executor . resource . GPU . amount = 1</p></blockquote><p id="c478" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这是理想情况，Spark启动时没有任何警告消息，因为4/1 = 1/.25</p><p id="7161" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi"> GPU并行&lt; CPU并行</strong></p><blockquote class="ju jv jw"><p id="6f9d" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">火花壳</p><p id="bc2e" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">— — conf spark.executor.cores=4</p><p id="9292" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">——conf spark . task . resource . GPU . amount = . 5</p><p id="25ad" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">——conf spark . task . CPU = 1</p><p id="ef3a" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">——conf spark . executor . instances = 4</p><p id="6304" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">——conf spark . executor . resource . GPU . amount = 1</p></blockquote><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kb"><img src="../Images/1bff27fadaf4c6cb6358702463bbd6e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HT_UP0VQU3v4UeEmoUVayQ.png"/></div></div></figure><p id="270e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">1 / .5 ( <strong class="ir hi"> GPU并行</strong> ) &lt; 4 / 1 ( <strong class="ir hi"> CPU并行</strong>)</p><blockquote class="ju jv jw"><p id="f402" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">火花壳</p><p id="c422" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">— — conf spark.executor.cores=4</p><p id="6a4f" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">——conf spark . task . resource . GPU . amount = . 25</p><p id="8d89" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">——conf spark . task . CPU = 2</p><p id="f7f3" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">——conf spark . executor . instances = 4</p><p id="74a1" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">——conf spark . executor . resource . GPU . amount = 1</p></blockquote><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kg"><img src="../Images/03cd33566970bbf7f6b5f52d5d3c55d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*guyvXYKjukA3tNoDVeMxDA.png"/></div></div></figure><blockquote class="ju jv jw"><p id="5a70" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">1 / .25 ( <strong class="ir hi"> GPU并行</strong> ) &gt; 4 / 2 ( <strong class="ir hi"> CPU并行</strong>)</p></blockquote><p id="84f3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">请注意，将<strong class="ir hi">spark . rapids . SQL . concurrentgputasks</strong>设置为更高的值会导致内存不足错误或性能下降，通常该值应该在2到4之间。</p></div><div class="ab cl jn jo go jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ha hb hc hd he"><p id="4e55" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在我们已经了解了在Spark上运行应用程序所需的基本配置，让我们看看如何检查SQL的哪一部分阻塞了要在GPU上执行的指令。</p><p id="a390" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">spark . rapids . SQL . explain</strong>将输入作为ALL/NONE/NOT_ON_GPU之一</p><p id="6d69" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">设置spark . rapids . SQL . explain = NOT _ ON _ GPU将导致打印所有这些不能在GPU上执行的指令。</p><p id="466f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">到目前为止，GPU还不支持各种操作/数据类型，其中一个例子是支持十进制数据类型，在撰写本文时，CPU上的Spark支持128位精度，而GPU上的Spark支持高达64位精度(高达十进制(18，x))。因此，即使您的操作是在Decimal(9，2)和Decimal(12，6)的属性之间执行的，Spark inserts <strong class="ir hi">也会提升Precision </strong>将值转换为compute而不会溢出。因为结果可能是十进制的(19，8)，并且因为它在GPU上不受支持，所以计算将在CPU上执行。</p><p id="303e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">让我们举一个例子，sales_yrly表包含年销售额，属性sales_amt定义为decimal(12，2)</p><blockquote class="ju jv jw"><p id="003b" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">Scala &gt; spark . conf . set(" spark . rapids . SQL . explain "，" NOT _ ON _ GPU ")；</p><p id="507c" class="ip iq jx ir b is it iu iv iw ix iy iz jy jb jc jd jz jf jg jh ka jj jk jl jm ha bi translated">Scala &gt; spark . SQL(" explain select sum(sales _ AMT)from sales _ yrly ")</p></blockquote><p id="2435" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您可以在下面的截图中看到，当我们启用“NOT_ON_GPU”时，无法在GPU上运行的操作已在解释计划中突出显示</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kh"><img src="../Images/64e415f2dc262ce1b74a628bbba5aad8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ENDxpRdQSq3Md2gczuWaEQ.png"/></div></div></figure></div><div class="ab cl jn jo go jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ha hb hc hd he"><p id="cbbb" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在开始Spark on RAPIDS之旅之前，预先检查哪些运营商受支持，哪些不受支持将是有益的。所有这些操作在官方文档页面上都有很好的描述。</p><p id="1610" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这标志着本文第一部分的结束，在下一篇文章中，我们将更深入地研究Dag，以了解Spark 3.0中的操作是如何执行的。</p><h1 id="300e" class="ki kj hh bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">参考资料:</h1><p id="8b54" class="pw-post-body-paragraph ip iq hh ir b is lg iu iv iw lh iy iz ja li jc jd je lj jg jh ji lk jk jl jm ha bi translated"><a class="ae ll" href="https://nvidia.github.io/spark-rapids/" rel="noopener ugc nofollow" target="_blank"><em class="jx">https://nvidia.github.io/spark-rapids/</em></a></p></div></div>    
</body>
</html>