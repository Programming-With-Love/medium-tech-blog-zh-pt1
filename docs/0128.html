<html>
<head>
<title>Supporting Dynamic Type at Airbnb</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Airbnb支持动态类型</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/supporting-dynamic-type-at-airbnb-b47c68b0c998?source=collection_archive---------1-----------------------#2019-07-24">https://medium.com/airbnb-engineering/supporting-dynamic-type-at-airbnb-b47c68b0c998?source=collection_archive---------1-----------------------#2019-07-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="d486" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">概述我们在将动态类型引入Airbnb时学到的流程、技巧和陷阱。供您在应用程序中支持动态类型时参考！</h2></div><p id="4fad" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">由<a class="ae js" href="https://twitter.com/sond813" rel="noopener ugc nofollow" target="_blank">诺亚马丁</a> &amp; <a class="ae js" href="https://twitter.com/hugoahlberg" rel="noopener ugc nofollow" target="_blank">雨果阿尔贝里</a></p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/8faa35f41ec822ec52afb63405f3f28a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nJNU8jmjTx7ZnfgHP5XYLA.jpeg"/></div></div></figure><h1 id="5830" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">背景</h1><p id="2475" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">自iOS 7以来，动态字体允许用户为手机选择喜欢的字体大小。在Airbnb，我们试图建立一个我们整个社区都可以使用的应用程序——因为动态类型是一个关键的辅助功能，我们知道支持它会让更多人能够有效地使用我们的应用程序，其中一些人可能是第一次使用。为了验证这一功能的重要性，我们检查了数据，发现多达30%的人在使用我们的应用程序时使用了非默认的首选字体大小。这种用法并不倾向于特定的大小，而是平均分布在比默认值更大和更小的大小上。</p><blockquote class="lc"><p id="53e5" class="ld le hh bd lf lg lh li lj lk ll jr dx translated">30%使用该应用程序的人喜欢的字体大小不是默认的。</p></blockquote><p id="8470" class="pw-post-body-paragraph iw ix hh iy b iz lm ii jb jc ln il je jf lo jh ji jj lp jl jm jn lq jp jq jr ha bi translated">事实证明，支持这种偏好创建了用户会注意到的跨操作系统的一致体验。在Airbnb应用程序的单个功能上尝试动态类型，导致参与度显著增加，有助于提高我们的底线指标。如果你花时间在你的应用程序中支持动态类型，用户肯定会感谢你的！</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lr"><img src="../Images/5ef7826d84ef5c4c87409344edf3b0cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QCU6TBGiD3_i5fBni0-i9w@2x.png"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">Font size selection in iOS</figcaption></figure><h1 id="86e9" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">为什么重要？</h1><p id="173d" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">除了度量标准之外，对动态类型的支持将您的UI组件保持在更高的质量水平。布局需要足够健壮，以处理各种各样的偏好，类似于由本地化和设备屏幕大小造成的变化。由于我们的大部分开发时间都花在了单个设备和语言上，所以只能在特定配置中重现的错误往往会被忽略。幸运的是，在动态类型测试过程中，许多这样的问题都被发现了。如果你已经通过<a class="ae js" href="https://developer.apple.com/documentation/uikit/uitraitcollection" rel="noopener ugc nofollow" target="_blank"> UITraitCollection </a>和不同长度字符串的翻译支持不同的屏幕尺寸，那么很有可能你已经完成了支持动态类型的大部分工作。</p><h1 id="c982" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">设计</h1><p id="442c" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">当使用大字体时，我们遇到的大多数错误都与文本不适合其容器有关。为了解决这些问题，我们提出了一些设计建议。首先，宽度和高度变得灵活，允许文本扩展到多行。在许多情况下，这应该已经完成，因为一些语言可能比我们在设计模拟中包含的英语单词长得多。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lw"><img src="../Images/4eba74fb5d6d2b9ca93adc992f245980.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-8Rjt5M6uUVqngzcAaXEXA.png"/></div></div></figure><p id="c9df" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">第二，我们必须确保字体缩放正确的数量。这是通过给每个文本分配一个相应的<a class="ae js" href="https://developer.apple.com/documentation/uikit/uifont/textstyle" rel="noopener ugc nofollow" target="_blank"> UIFont来实现的。文本样式</a>。使用较大的TextStyle表明你的字体已经很大了，所以它不需要增加太多的大小。</p><p id="61f3" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">第三，我们必须修复一些改变尺寸的标签，即使它们不应该有资格缩放。我们的建议是，屏幕上可滚动区域的所有部分都应该缩放，其他部分应该保持静态。然而，任何启用了大型动态类型的人仍然需要一种方法来查看较小容器(如标签栏)中的文本。如果使用所有标准UIKit元素，这将由大型内容查看器处理:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lr"><img src="../Images/1b4c9a7c7504aa7c658286e545c1a616.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cuqbr7usHOisg3KVI-QnyA@2x.png"/></div></div></figure><p id="9b7d" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们向苹果公司提交了一份错误报告，要求一个新的API来从自定义视图中显示这些弹出窗口。这项功能已经包含在iOS 13测试版中，所以你很快就可以在Airbnb应用程序中看到它。</p><h1 id="699e" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">工程</h1><p id="aa16" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">iOS主要为系统字体提供自动动态类型API，但Airbnb应用程序使用自定义字体，<a class="ae js" href="https://airbnb.design/cereal/" rel="noopener ugc nofollow" target="_blank">谷物</a>。为了支持动态类型，我们依靠<a class="ae js" href="https://developer.apple.com/documentation/uikit/uifontmetrics" rel="noopener ugc nofollow" target="_blank"> UIFontMetrics </a>。这个类处理字体大小、行高和跟踪的缩放。</p><p id="3ec6" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这些属性中的每一个都以两种形式存在:</p><ol class=""><li id="63df" class="lx ly hh iy b iz ja jc jd jf lz jj ma jn mb jr mc md me mf bi translated">以默认字体大小显示给用户的未缩放单位，是我们在创建字体属性时设置的值。</li><li id="4eb5" class="lx ly hh iy b iz mg jc mh jf mi jj mj jn mk jr mc md me mf bi translated">符合<code class="du ml mm mn mo b"><a class="ae js" href="https://developer.apple.com/documentation/uikit/uitraitcollection/1771746-preferredcontentsizecategory" rel="noopener ugc nofollow" target="_blank">preferredContentSizeCategory</a></code>的缩放单位是我们在运行时读取的。</li></ol><p id="2fbb" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在内部，特性将请求一个使用以未缩放单位表示的属性的字体，并将接收一个包含各种函数的对象，这些函数用于显示总是以缩放单位返回值的文本。这确保了任何计算(如文本的边界框)都将使用缩放单位。我们看到的一些最常见的错误是由于在布局计算中使用未缩放单位而不是缩放单位造成的。</p><p id="341a" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">有两种方法可以使用UIFontMetrics将未缩放单位转换为缩放单位。</p><p id="6966" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><a class="ae js" href="https://developer.apple.com/documentation/uikit/uifontmetrics/2877389-scaledfont" rel="noopener ugc nofollow" target="_blank">方法#1: </a></p><pre class="ju jv jw jx fd mp mo mq mr aw ms bi"><span id="0679" class="mt kg hh mo b fi mu mv l mw mx">func scaledFont(for font: UIFont, compatibleWith traitCollection: UITraitCollection?) -&gt; UIFont</span></pre><p id="1477" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><a class="ae js" href="https://developer.apple.com/documentation/uikit/uifontmetrics/2877388-scaledvalue" rel="noopener ugc nofollow" target="_blank">方法#2: </a></p><pre class="ju jv jw jx fd mp mo mq mr aw ms bi"><span id="946b" class="mt kg hh mo b fi mu mv l mw mx">func scaledValue(for value: CGFloat, compatibleWith traitCollection: UITraitCollection?) -&gt; CGFloat</span></pre><p id="39e5" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这些方法有细微的差别。考虑以下示例，每个示例都使用不同的UIFontMetrics方法:</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="my mz l"/></div></figure><p id="31d3" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">根据您运行的设备，我们观察到如下结果:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es na"><img src="../Images/454955abd2940c5697a2289a38f2e4c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*40O3zWZiRMBd1UKQFvkrmQ.png"/></div></div></figure><p id="ef09" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">结果并不完全一致，但是因为我们用NSParagraphStyle定制了行高，所以我们需要使用CGFloat scale函数。直接缩放未缩放磅值的UIFont，以获得调整后的UIFont。以下是缩放非属性字符串的完整示例:</p><figure class="ju jv jw jx fd jy"><div class="bz dy l di"><div class="my mz l"/></div></figure><p id="b9b0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">完全支持动态类型的最后一步是鼓励跨所有特性的验证，包括开发中的特性。我们知道开发人员的时间是有限的，所以我们尽可能地自动支持动态类型。<a class="ae js" href="https://happo.io" rel="noopener ugc nofollow" target="_blank"> Happo </a>，我们用于UI回归检测的工具，已经对现有组件进行了快照。我们添加了一个额外的步骤来渲染accessibilityExtraExtraExtraLarge大小。</p><p id="fbe8" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">没有可用的API来以编程方式改变模拟器的动态类型设置，所以避免使用<code class="du ml mm mn mo b">UIApplication.shared.preferredContentSize</code>。更易测试的方法是查询UIView的trait集合。在Happo测试的UIWindow中，traitCollection被配置为包含一个定制的内容大小。最终结果是这样的快照:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es nb"><img src="../Images/6997d5bd353e22a31027b33120644c31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qeD8HOm8klEsGh9DmNgyAg.png"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">Default (large) preferred content size</figcaption></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es nb"><img src="../Images/d1c06c5639c263f017fd974404e17d23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uHrtVZCAYdmru8TK5to1bw.png"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">AccessibilityExtraExtraExtraLarge preferredContentSize</figcaption></figure><p id="b214" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">由于iOS应用程序的每次代码更改都会生成快照，开发人员可以轻松了解新功能是否支持动态类型，并轻松检测回归。</p><p id="ad82" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">感谢<a class="ae js" href="https://www.linkedin.com/in/amiekweon/" rel="noopener ugc nofollow" target="_blank">李正吉·奎恩</a>、<a class="ae js" href="https://www.linkedin.com/in/dylanharris/" rel="noopener ugc nofollow" target="_blank">迪伦·哈里斯</a>、<a class="ae js" href="https://twitter.com/brynbodayle" rel="noopener ugc nofollow" target="_blank">布林·博达伊尔</a>、<a class="nc nd ge" href="https://medium.com/u/c93af7c0720f?source=post_page-----b47c68b0c998--------------------------------" rel="noopener" target="_blank">泰勒·亨德里克</a>和<a class="ae js" href="https://www.linkedin.com/in/kierajmumick/" rel="noopener ugc nofollow" target="_blank">基拉杰·穆米克</a>对这个项目的支持！</p></div><div class="ab cl ne nf go ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ha hb hc hd he"><p id="d792" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">要亲自体验这些功能，请在<a class="ae js" href="https://itunes.apple.com/us/app/airbnb/id401626263" rel="noopener ugc nofollow" target="_blank">应用商店</a>下载Airbnb应用。如果你对这样的项目和iOS开发充满热情，我们鼓励你申请我们开放的<a class="ae js" href="https://careers.airbnb.com/?gh_src=1cb1ce351" rel="noopener ugc nofollow" target="_blank">职位</a>！</p></div></div>    
</body>
</html>