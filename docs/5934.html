<html>
<head>
<title>Using Cluster API to upgrade a Kubernetes cluster in OCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用集群API升级OCI的Kubernetes集群</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/using-cluster-api-to-upgrade-a-kubernetes-cluster-in-oci-d9846e63b08a?source=collection_archive---------0-----------------------#2022-06-27">https://medium.com/oracledevs/using-cluster-api-to-upgrade-a-kubernetes-cluster-in-oci-d9846e63b08a?source=collection_archive---------0-----------------------#2022-06-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/2755fb9ccfa0d8a6edf853ebf7a28337.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DQ8rwmJy7wtyOZl8m-toSA.jpeg"/></div></div></figure><p id="fc30" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这次有点不寻常的帖子。我代表我的同事和队友Joe发这个帖子。显然，他更喜欢我来处理剪辑。我不知道为什么，但他是一个伟大的队友，有着邪恶的幽默感，我从他身上学到了很多，所以我很乐意帮忙。我们开始吧:</p><p id="bc86" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在这篇文章中，我将介绍<a class="ae jn" href="https://cluster-api.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank">集群API </a>的一个非常棒的特性:对Kubernetes集群进行滚动升级的能力。集群API使其成为一个简单且可重复的过程。我会完全诚实:我曾经手动升级过一个Kubernetes集群，而且<a class="ae jn" href="https://asterixonline.info/vitalstatistix/" rel="noopener ugc nofollow" target="_blank">天没有塌下来</a>。但是我是一个懒惰的黑客，所以当我可以自动操作并具有可重复性的安全性时，为什么还要手动操作呢？</p><h2 id="9e98" class="jo jp hh bd jq jr js jt ju jv jw jx jy ja jz ka kb je kc kd ke ji kf kg kh ki bi translated">什么是集群API？</h2><p id="cab3" class="pw-post-body-paragraph ip iq hh ir b is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji kn jk jl jm ha bi translated">如果您不熟悉集群API，它是Kubernetes的一个子项目，主要提供声明性API和工具来简化多个Kubernetes集群的供应、升级和操作。打个比方，把集群API想象成Java接口，它使用Kubernetes风格的接口来定义Kubernetes集群所需的基础设施。</p><p id="3e0a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">坚持我们的Java类比，为了使用所说的接口，你需要在一个类中实现它。Cluster API使用一个基础设施模型来扩展对多个基础设施提供者的支持。几乎每个基础设施提供商<em class="ko">都实现了</em>(我希望你明白这里的双关语！)一。基础设施提供者的实现是将API集群化，就像类对于Java一样。Oracle的在这里<a class="ae jn" href="https://github.com/oracle/cluster-api-provider-oci" rel="noopener ugc nofollow" target="_blank">实现</a>，它可以用于在Oracle云中构建集群。有关如何从OCI提供商开始的简要介绍，请查看<a class="ae jn" href="https://blogs.oracle.com/cloud-infrastructure/post/create-and-manage-kubernetes-clusters-on-oracle-cloud-infrastructure-with-cluster-api" rel="noopener ugc nofollow" target="_blank"> Paul Jenkins的帖子</a>或阅读<a class="ae jn" href="https://oracle.github.io/cluster-api-provider-oci/gs/overview.html" rel="noopener ugc nofollow" target="_blank">文档</a>。您还应该检查集群API的<a class="ae jn" href="https://cluster-api.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank"> awesome book </a>，使用<a class="ae jn" href="https://rust-lang.github.io/mdBook/" rel="noopener ugc nofollow" target="_blank"> mdbook </a>从Markdown生成。</p><h2 id="6966" class="jo jp hh bd jq jr js jt ju jv jw jx jy ja jz ka kb je kc kd ke ji kf kg kh ki bi translated">使用集群API升级集群</h2><p id="9e5b" class="pw-post-body-paragraph ip iq hh ir b is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji kn jk jl jm ha bi translated">集群API的主要目标之一是</p><blockquote class="kp kq kr"><p id="eb8f" class="ip iq ko ir b is it iu iv iw ix iy iz ks jb jc jd kt jf jg jh ku jj jk jl jm ha bi translated">使用声明性API管理符合Kubernetes的集群的生命周期(创建、扩展、升级、销毁)。</p></blockquote><p id="2179" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">自动化升级过程是一大成就。我不想必须封锁/清空节点来手动进行滚动更新。工具应该为我做这件事。</p><p id="a796" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我假设您已经启动并运行了一个管理和工作负载集群。如果没有，请按照<a class="ae jn" href="https://oracle.github.io/cluster-api-provider-oci/gs/gs.html" rel="noopener ugc nofollow" target="_blank">入门指南</a>创建工作负载集群。下面是我如何创建工作负载集群的:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="1b60" class="jo jp hh la b fi le lf l lg lh">OCI_IMAGE_ID=&lt;your image ocid&gt; \  <br/>OCI_COMPARTMENT_ID=&lt;your compartment ocid&gt; \  <br/>NODE_MACHINE_COUNT=3 \  <br/>OCI_REGION=us-phoenix-1 \  <br/>OCI_SHAPE=VM.Standard.E4.Flex \  <br/>OCI_NODE_MACHINE_TYPE_OCPUS=2 \  <br/>OCI_CONTROL_PLANE_MACHINE_TYPE_OCPUS=3 \  <br/>OCI_SHAPE_MEMORY_IN_GBS= \  <br/>OCI_SSH_KEY=&lt;your private key&gt; \  <br/>clusterctl generate cluster oci-cluster-phx --kubernetes-version v1.22.9 \  <br/>--target-namespace default \  <br/>--control-plane-machine-count=3 \  <br/>--from https://github.com/oracle/cluster-api-provider-oci/releases/download/v0.3.0/cluster-template.yaml | kubectl apply -f -</span></pre><p id="cb28" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">既然我们已经启动并运行了一个工作负载集群，那么是时候升级了。升级过程的高级步骤如下:</p><ol class=""><li id="7284" class="li lj hh ir b is it iw ix ja lk je ll ji lm jm ln lo lp lq bi translated">创建新版本的Kubernetes图像</li><li id="4163" class="li lj hh ir b is lr iw ls ja lt je lu ji lv jm ln lo lp lq bi translated">升级控制平面</li><li id="2736" class="li lj hh ir b is lr iw ls ja lt je lu ji lv jm ln lo lp lq bi translated">升级工人机器</li></ol><p id="608a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在开始之前，让我们检查一下正在运行的工作负载集群的版本。为了访问我们的工作负载集群，我们需要从我们的管理集群中导出Kubernetes配置:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="14d4" class="jo jp hh la b fi le lf l lg lh">clusterctl get kubeconfig oci-cluster-phx -n default &gt; oci-cluster-phx.kubeconfig</span></pre><p id="ce24" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一旦我们有了<code class="du lw lx ly la b">kubeconfig</code>文件，我们就可以检查工作负载集群的版本:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="ddce" class="jo jp hh la b fi le lf l lg lh">kubectl --kubeconfig=oci-cluster-phx.kubeconfig version</span><span id="16d2" class="jo jp hh la b fi lz lf l lg lh">Client Version: version.Info{Major:"1", Minor:"23", GitVersion:"v1.23.4", GitCommit:"e6c093d87ea4cbb530a7b2ae91e54c0842d8308a", GitTreeState:"clean", BuildDate:"2022-02-16T12:38:05Z", GoVersion:"go1.17.7", Compiler:"gc", Platform:"darwin/amd64"}<br/>Server Version: version.Info{Major:"1", Minor:"22", GitVersion:"v1.22.9", GitCommit:"6df4433e288edc9c40c2e344eb336f63fad45cd2", GitTreeState:"clean", BuildDate:"2022-04-13T19:52:02Z", GoVersion:"go1.16.15", Compiler:"gc", Platform:"linux/amd64"}</span></pre><p id="a998" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">注意服务器版本是<code class="du lw lx ly la b">v1.22.9</code>。让我们加速吧。</p><h2 id="4ee2" class="jo jp hh bd jq jr js jt ju jv jw jx jy ja jz ka kb je kc kd ke ji kf kg kh ki bi translated">创建新的Kubernetes形象</h2><p id="0a91" class="pw-post-body-paragraph ip iq hh ir b is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji kn jk jl jm ha bi translated">为了升级我们的worker节点，我们需要使用<a class="ae jn" href="https://image-builder.sigs.k8s.io/capi/providers/oci.html" rel="noopener ugc nofollow" target="_blank"> Kubernetes映像构建器</a>来构建映像。按照<a class="ae jn" href="https://image-builder.sigs.k8s.io/capi/providers/oci.html#building-images" rel="noopener ugc nofollow" target="_blank">构建图像</a>一节中更详细的步骤完成先决步骤。</p><p id="3504" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然后，我们需要将<code class="du lw lx ly la b">kubernetes</code>信息设置为比当前集群版本更新的版本。现在，正在使用的集群是<code class="du lw lx ly la b">1.22.9</code>，我们想要升级到<code class="du lw lx ly la b">1.23.6</code>(当前发布版本可以在这里找到<a class="ae jn" href="https://kubernetes.io/releases/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/releases/</a>)。我们将编辑<code class="du lw lx ly la b">images/capi/packer/config/kubernetes.json</code>并更改以下内容:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="f766" class="jo jp hh la b fi le lf l lg lh">"kubernetes_deb_version": "1.23.6-00",<br/>"kubernetes_rpm_version": "1.23.6-0",<br/>"kubernetes_semver": "v1.23.6",<br/>"kubernetes_series": "v1.23"</span></pre><p id="af33" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在配置更新后，我们将使用Ubuntu 20.04构建来创建带有packer的新映像:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="aaa7" class="jo jp hh la b fi le lf l lg lh">$ cd &lt;root_of_image_builder_repo&gt;/images/capi<br/>$ PACKER_VAR_FILES=json/oci_phx.json make build-oci-ubuntu-2004</span></pre><p id="94ae" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这将在OCI启动一个实例来构建映像。一旦完成，你应该得到图像的OCID输出。您也可以通过访问<code class="du lw lx ly la b">https://console.us-phoenix-1.oraclecloud.com/compute/images</code>来检查构建的图像。你会想要保存这个OCID，因为我们以后会用到它。下面是一个成功输出的截断示例:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="33c7" class="jo jp hh la b fi le lf l lg lh">==&gt; oracle-oci: Creating temporary ssh key for instance...<br/>==&gt; oracle-oci: Creating instance...<br/>==&gt; oracle-oci: Created instance (&lt;your instance OCID will be here&gt;).<br/>==&gt; oracle-oci: Waiting for instance to enter 'RUNNING' state...<br/>==&gt; oracle-oci: Instance 'RUNNING'.<br/>...<br/>...<br/>...<br/>==&gt; oracle-oci: Creating image from instance...<br/>==&gt; oracle-oci: Image created.<br/>==&gt; oracle-oci: Terminating instance (&lt;your instance OCID will be here)...<br/>==&gt; oracle-oci: Terminated instance.<br/>Build 'oracle-oci' finished after 15 minutes 29 seconds.</span><span id="2d82" class="jo jp hh la b fi lz lf l lg lh">==&gt; Wait completed after 15 minutes 29 seconds</span><span id="387d" class="jo jp hh la b fi lz lf l lg lh">==&gt; Builds finished. The artifacts of successful builds are:<br/>--&gt; oracle-oci: An image was created: 'cluster-api-ubuntu-2004-1.23-v1.23.6-1653421889' (OCID: &lt;you image OCID will be here&gt;) in region 'us-phoenix-1'</span></pre><h2 id="eb7b" class="jo jp hh bd jq jr js jt ju jv jw jx jy ja jz ka kb je kc kd ke ji kf kg kh ki bi translated">升级控制平面</h2><p id="e2d0" class="pw-post-body-paragraph ip iq hh ir b is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji kn jk jl jm ha bi translated">现在我们已经有了新版本Kubernetes的计算映像，我们可以升级控制平面了。</p><p id="07bf" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">首先，让我们为控制平面复制一个机器模板:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="caf3" class="jo jp hh la b fi le lf l lg lh">$ kubectl get ocimachinetemplate oci-cluster-phx-control-plane -o yaml &gt; control-plane-machine-template.yaml</span></pre><p id="b706" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们需要修改以下内容:</p><ul class=""><li id="b0fd" class="li lj hh ir b is it iw ix ja lk je ll ji lm jm ma lo lp lq bi translated"><code class="du lw lx ly la b">spec.template.spec.imageId</code> -使用之前创建的自定义图像OCID</li><li id="e4f8" class="li lj hh ir b is lr iw ls ja lt je lu ji lv jm ma lo lp lq bi translated"><code class="du lw lx ly la b">metadata.name</code>——有了新名字。例子:<code class="du lw lx ly la b">oci-cluster-phx-control-plane-v1-23-6</code></li><li id="6447" class="li lj hh ir b is lr iw ls ja lt je lu ji lv jm ma lo lp lq bi translated">在尝试将元数据发送到API服务器之前，清除所有无关的元数据，包括<code class="du lw lx ly la b">resourceVersion</code>字段</li></ul><p id="e76d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">修改字段后，我们可以将它们应用到集群:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="f92e" class="jo jp hh la b fi le lf l lg lh">$ kubectl apply -f control-plane-machine-template.yaml</span><span id="5ea4" class="jo jp hh la b fi lz lf l lg lh">ocimachinetemplate.infrastructure.cluster.x-k8s.io/oci-cluster-phx-control-plane configured</span></pre><p id="0fca" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">请注意，这只会创建新的机器模板。下一步将触发实际的更新。</p><p id="6365" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们现在想告诉<code class="du lw lx ly la b">KubeadmControlPlane</code>资源关于新的机器模板并升级版本号。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="6d28" class="jo jp hh la b fi le lf l lg lh">$ kubectl get KubeadmControlPlane -o yaml &gt; kubeadm-control-plan-update.yaml</span></pre><p id="0897" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们需要为<code class="du lw lx ly la b">oci-cluster-phx-control-plane</code>修改以下内容:</p><ul class=""><li id="5b57" class="li lj hh ir b is it iw ix ja lk je ll ji lm jm ma lo lp lq bi translated"><code class="du lw lx ly la b">spec.machineTemplate.infrastructureRef.name</code> -在此使用新创建的机器模板名称。示例<code class="du lw lx ly la b">oci-cluster-phx-control-plane-v1-23-6</code></li><li id="b4f1" class="li lj hh ir b is lr iw ls ja lt je lu ji lv jm ma lo lp lq bi translated"><code class="du lw lx ly la b">spec.version</code> -应该是<code class="du lw lx ly la b">v1.22.9</code>你会想换成<code class="du lw lx ly la b">v1.23.6</code></li></ul><p id="1c39" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">升级控制平面:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="1a6b" class="jo jp hh la b fi le lf l lg lh">$ kubectl apply -f kubeadm-control-plan-update.yaml</span></pre><p id="9d7e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在<code class="du lw lx ly la b">capi-kubeadm-control-plane-controller-manager</code>中，您应该会看到类似如下的日志:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="f239" class="jo jp hh la b fi le lf l lg lh">$ kubectl -n capi-kubeadm-control-plane-system logs capi-kubeadm-control-plane-controller-manager-75cc644b4b-pkghd</span><span id="154c" class="jo jp hh la b fi lz lf l lg lh">...<br/>...<br/>controller/kubeadmcontrolplane "msg"="Rolling out Control Plane machines" "cluster"="oci-cluster-phx" "name"="oci-cluster-phx-control-plane" "namespace"="default" "reconciler group"="controlplane.cluster.x-k8s.io" "reconciler kind"="KubeadmControlPlane" "needRollout"=["oci-cluster-phx-control-plane-74bkb","oci-cluster-phx-control-plane-8h5zw","oci-cluster-phx-control-plane-pcbjq"]<br/>...<br/>..</span></pre><p id="e201" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们可以通过<code class="du lw lx ly la b">clusterctl</code>查看集群升级的进度:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="b811" class="jo jp hh la b fi le lf l lg lh">$ clusterctl describe cluster oci-cluster-phx                                                                                                                   <br/>NAME                                                                READY  SEVERITY  REASON                   SINCE  MESSAGE<br/>Cluster/oci-cluster-phx                                             False  Warning   RollingUpdateInProgress  98s    Rolling 3 replicas with outdated spec (1 replicas up to date)<br/>├─ClusterInfrastructure - OCICluster/oci-cluster-phx                True                                      4h50m<br/>├─ControlPlane - KubeadmControlPlane/oci-cluster-phx-control-plane  False  Warning   RollingUpdateInProgress  98s    Rolling 3 replicas with outdated spec (1 replicas up to date)<br/>│ └─4 Machines...                                                   True                                      9m17s  See oci-cluster-phx-control-plane-ptg4m, oci-cluster-phx-control-plane-sg67j, ...<br/>└─Workers<br/>  └─MachineDeployment/oci-cluster-phx-md-0                          True                                      10m<br/>    └─3 Machines...                                                 True                                      4h44m  See oci-cluster-phx-md-0-8667c8d69-47nh9, oci-cluster-phx-md-0-8667c8d69-5r4zc, ...</span></pre><p id="89ce" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们还可以看到，随着新实例的创建，滚动更新开始发生:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="c0ba" class="jo jp hh la b fi le lf l lg lh">$ kubectl --kubeconfig=oci-cluster-phx.kubeconfig get nodes -A</span><span id="fdae" class="jo jp hh la b fi lz lf l lg lh">NAME                                  STATUS     ROLES                  AGE     VERSION<br/>oci-cluster-phx-control-plane-464zs   Ready      control-plane,master   4h40m   v1.22.5<br/>oci-cluster-phx-control-plane-7vdxp   NotReady   control-plane,master   27s     v1.23.6<br/>oci-cluster-phx-control-plane-dhxml   Ready      control-plane,master   4h48m   v1.22.5<br/>oci-cluster-phx-control-plane-dmk8j   Ready      control-plane,master   4h44m   v1.22.5<br/>oci-cluster-phx-md-0-cnrbf            Ready      &lt;none&gt;                 4h44m   v1.22.5<br/>oci-cluster-phx-md-0-hc6fj            Ready      &lt;none&gt;                 4h45m   v1.22.5<br/>oci-cluster-phx-md-0-nc2g9            Ready      &lt;none&gt;                 4h44m   v1.22.5</span></pre><p id="9cdd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在控制平面实例被终止之前，它将按预期被封锁和排空:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="7f0d" class="jo jp hh la b fi le lf l lg lh">oci-cluster-phx-control-plane-dmk8j   NotReady,SchedulingDisabled   control-plane,master   4h52m   v1.22.5</span></pre><p id="7657" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这个过程大约需要15分钟。所有控制平面节点升级后，您应该会看到使用<code class="du lw lx ly la b">kubectl version</code>的新版本:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="2a37" class="jo jp hh la b fi le lf l lg lh">kubectl --kubeconfig=oci-cluster-phx.kubeconfig version</span><span id="bdc6" class="jo jp hh la b fi lz lf l lg lh">Client Version: version.Info{Major:"1", Minor:"23", GitVersion:"v1.23.4", GitCommit:"e6c093d87ea4cbb530a7b2ae91e54c0842d8308a", GitTreeState:"clean", BuildDate:"2022-02-16T12:38:05Z", GoVersion:"go1.17.7", Compiler:"gc", Platform:"darwin/amd64"}</span><span id="18b1" class="jo jp hh la b fi lz lf l lg lh">Server Version: version.Info{Major:"1", Minor:"23", GitVersion:"<strong class="la hi">v1.23.6</strong>", GitCommit:"ad3338546da947756e8a88aa6822e9c11e7eac22", GitTreeState:"clean", BuildDate:"2022-04-14T08:43:11Z", GoVersion:"go1.17.9", Compiler:"gc", Platform:"linux/amd64"}</span></pre><p id="1ca8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们的集群现在已经升级，我们可以继续升级工作节点。</p><h2 id="7a1e" class="jo jp hh bd jq jr js jt ju jv jw jx jy ja jz ka kb je kc kd ke ji kf kg kh ki bi translated">升级工作节点</h2><p id="05fe" class="pw-post-body-paragraph ip iq hh ir b is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji kn jk jl jm ha bi translated">升级控制平面节点后，我们现在可以升级工作节点<a class="ae jn" href="https://cluster-api.sigs.k8s.io/tasks/updating-machine-templates.html" rel="noopener ugc nofollow" target="_blank">https://cluster-API . sigs . k8s . io/tasks/updating-machine-templates . html</a></p><p id="9751" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">首先，我们需要为worker节点复制机器模板:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="16d0" class="jo jp hh la b fi le lf l lg lh">$ kubectl get ocimachinetemplate oci-cluster-phx-md-0 -o yaml &gt; worker-machine-template.yaml</span></pre><p id="69a8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们首先修改以下内容:</p><ul class=""><li id="8ec2" class="li lj hh ir b is it iw ix ja lk je ll ji lm jm ma lo lp lq bi translated"><code class="du lw lx ly la b">spec.template.spec.imageId</code> -使用之前创建的自定义图像OCID</li><li id="e997" class="li lj hh ir b is lr iw ls ja lt je lu ji lv jm ma lo lp lq bi translated"><code class="du lw lx ly la b">metadata.name</code>——有了新名字。示例:<code class="du lw lx ly la b">oci-cluster-phx-md-0-v1-23-6</code></li></ul><p id="bf7d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一旦修改了字段，我们需要将它们应用到集群中。和以前一样，这只会创建新的机器模板。下一步将开始实际的更新。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="3ef1" class="jo jp hh la b fi le lf l lg lh">$ kubectl apply -f worker-machine-template.yaml</span><span id="f47d" class="jo jp hh la b fi lz lf l lg lh">ocimachinetemplate.infrastructure.cluster.x-k8s.io/oci-cluster-phx-md-0-v1-23-6 created</span></pre><p id="9c77" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">让我们用刚刚创建的新资源修改worker节点的<code class="du lw lx ly la b">MachineDeployment</code>。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="ad2a" class="jo jp hh la b fi le lf l lg lh">$ kubectl get MachineDeployment -o yaml &gt; worker-machine-deployment.yaml</span></pre><p id="9239" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们需要为<code class="du lw lx ly la b">oci-cluster-phx-md-0</code>修改以下内容:</p><ul class=""><li id="fe75" class="li lj hh ir b is it iw ix ja lk je ll ji lm jm ma lo lp lq bi translated"><code class="du lw lx ly la b">spec.template.spec.infrastructureRef.name</code> -在此使用新创建的机器模板名称。示例<code class="du lw lx ly la b">oci-cluster-phx-md-0-v1-23-6</code></li><li id="77c2" class="li lj hh ir b is lr iw ls ja lt je lu ji lv jm ma lo lp lq bi translated"><code class="du lw lx ly la b">spec.template.spec</code> -应该是<code class="du lw lx ly la b">v1.22.9</code>你会想换成<code class="du lw lx ly la b">v1.23.6</code></li><li id="baed" class="li lj hh ir b is lr iw ls ja lt je lu ji lv jm ma lo lp lq bi translated">在试图发送给API服务器之前，清除任何无关的元数据，包括<code class="du lw lx ly la b">resourceVersion</code>字段</li></ul><p id="4b59" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">升级工作节点:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="3b46" class="jo jp hh la b fi le lf l lg lh">$ kubectl apply -f worker-machine-deployment.yaml</span></pre><p id="4ab3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">同样，我们可以通过<code class="du lw lx ly la b">clusterctl</code>命令来观察集群的进度。然而，与控制平面不同，机器部署处理工作机的更新，因此<code class="du lw lx ly la b">clusterctl describe cluster</code>将只显示正在更新的机器部署。如果希望在创建新实例时观察滚动更新的发生，可以执行以下操作:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="9b02" class="jo jp hh la b fi le lf l lg lh">$ kubectl --kubeconfig=oci-cluster-phx.kubeconfig get nodes -A</span><span id="2423" class="jo jp hh la b fi lz lf l lg lh">...</span><span id="b09b" class="jo jp hh la b fi lz lf l lg lh">oci-cluster-phx-md-0-z59t8                   Ready,SchedulingDisabled   &lt;none&gt;                 55m    v1.22.5</span><span id="5a5a" class="jo jp hh la b fi lz lf l lg lh">oci-cluster-phx-md-0-z59t8                   NotReady,SchedulingDisabled   &lt;none&gt;                 56m     v1.22.5</span></pre><p id="f426" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您在工作机器上有pod，您将看到它们被迁移到新机器上:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="9706" class="jo jp hh la b fi le lf l lg lh">$ kubectl --kubeconfig=oci-cluster-phx.kubeconfig get pods</span><span id="5e45" class="jo jp hh la b fi lz lf l lg lh">NAME                          READY   STATUS       AGE     NODE<br/>echoserver-55587b4c46-2q5hz   1/1     Terminating  89m    oci-cluster-phx-md-0-z59t8<br/>echoserver-55587b4c46-4x72p   1/1     Running      5m24s  oci-cluster-phx-md-0-v1-23-6-bqs8l<br/>echoserver-55587b4c46-tmj4b   1/1     Running      29s    oci-cluster-phx-md-0-v1-23-6-btjzs<br/>echoserver-55587b4c46-vz7gm   1/1     Running      89m    oci-cluster-phx-md-0-z79bd</span></pre><p id="48ff" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在我们的示例中，大约10或15分钟后，工人应该得到更新。显然，节点越多，滚动更新的时间就越长。您可以检查所有节点的版本以确认:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="c243" class="jo jp hh la b fi le lf l lg lh">$ kubectl --kubeconfig=oci-cluster-phx.kubeconfig get nodes -A</span><span id="d047" class="jo jp hh la b fi lz lf l lg lh">NAME                                          STATUS                     ROLES                  AGE     VERSION<br/>oci-cluster-phx-control-plane-v1-23-6-926gx   Ready                      control-plane,master   18m     v1.23.6<br/>oci-cluster-phx-control-plane-v1-23-6-vfp5g   Ready                      control-plane,master   24m     v1.23.6<br/>oci-cluster-phx-control-plane-v1-23-6-vprqc   Ready                      control-plane,master   30m     v1.23.6<br/>oci-cluster-phx-md-0-v1-23-6-bqs8l            Ready                      &lt;none&gt;                 9m58s   v1.23.6<br/>oci-cluster-phx-md-0-v1-23-6-btjzs            Ready                      &lt;none&gt;                 5m37s   v1.23.6<br/>oci-cluster-phx-md-0-v1-23-6-z79bd            Ready                      &lt;none&gt;                 71s     v1.23.6</span></pre><h2 id="9ef1" class="jo jp hh bd jq jr js jt ju jv jw jx jy ja jz ka kb je kc kd ke ji kf kg kh ki bi translated">机器部署策略</h2><p id="df74" class="pw-post-body-paragraph ip iq hh ir b is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji kn jk jl jm ha bi translated">集群API提供了两种机器部署策略<code class="du lw lx ly la b">RollingUpdate</code>和<code class="du lw lx ly la b">OnDelete</code>。</p><p id="8768" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们上面的例子使用了<code class="du lw lx ly la b">RollingUpdate</code>策略，您可以用它来修改<code class="du lw lx ly la b">maxSurge</code>和<code class="du lw lx ly la b">maxUnavailable</code>。<code class="du lw lx ly la b">maxSurge</code>和<code class="du lw lx ly la b">maxUnavailable</code>都可以是一个绝对数字(如5)或所需机器的百分比(如10%)。</p><p id="4793" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">另一个机器部署策略选项是<code class="du lw lx ly la b">OnDelete</code>。这要求用户完全删除旧机器来驱动更新。当机器被完全删除后，一个新的会出现。</p><p id="926c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了更好地理解带有集群API的机器部署是如何工作的，请查看关于机器部署的文档。</p><h1 id="22f9" class="mb jp hh bd jq mc md me ju mf mg mh jy mi mj mk kb ml mm mn ke mo mp mq kh mr bi translated">结论</h1><p id="50b1" class="pw-post-body-paragraph ip iq hh ir b is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji kn jk jl jm ha bi translated">我们创建了一个新映像，并将滚动升级推送到我们集群的控制平面和工作节点。我们通过对我们的配置进行一些修改实现了这一点。无论集群大小如何，升级过程都是相同的。</p><p id="e4d9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果这不是集群API的卖点，我不知道还有什么。</p><p id="d2b4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">随着许多新特性的出现，集群API项目正在快速发展。OCI集群API提供商团队正在努力为您带来所有最新最棒的产品，如<code class="du lw lx ly la b"><a class="ae jn" href="https://cluster-api.sigs.k8s.io/tasks/experimental-features/cluster-class/index.html" rel="noopener ugc nofollow" target="_blank">ClusterClass</a></code>、<code class="du lw lx ly la b"><a class="ae jn" href="https://cluster-api.sigs.k8s.io/tasks/experimental-features/machine-pools.html" rel="noopener ugc nofollow" target="_blank">MachinePools</a></code>和<code class="du lw lx ly la b"><a class="ae jn" href="https://cluster-api.sigs.k8s.io/tasks/experimental-features/cluster-class/operate-cluster.html" rel="noopener ugc nofollow" target="_blank">ManagedClusters</a></code>。</p><p id="96d8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">关于<a class="ae jn" href="https://github.com/oracle/cluster-api-provider-oci" rel="noopener ugc nofollow" target="_blank">集群-api-provider-oci </a>的更新，请关注GitHub repo。我们很高兴能为Kubernetes和CNCF社区做出贡献，希望你能加入我们。</p><p id="fa67" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您也可以<a class="ae jn" href="https://bit.ly/devrel_slack" rel="noopener ugc nofollow" target="_blank">加入我们的公共休闲</a>讨论！</p><h2 id="4dfa" class="jo jp hh bd jq jr js jt ju jv jw jx jy ja jz ka kb je kc kd ke ji kf kg kh ki bi translated">相关资源</h2><p id="45db" class="pw-post-body-paragraph ip iq hh ir b is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji kn jk jl jm ha bi translated">集群API:<a class="ae jn" href="https://cluster-api.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank">https://cluster-api.sigs.k8s.io/</a></p><p id="edfb" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">https://oracle.github.io/cluster-api-provider-oci/ OCI集群API<a class="ae jn" href="https://oracle.github.io/cluster-api-provider-oci/" rel="noopener ugc nofollow" target="_blank"/></p><p id="3fd8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">GitHub上的卡波奇:<a class="ae jn" href="https://github.com/oracle/cluster-api-provider-oci" rel="noopener ugc nofollow" target="_blank">https://github.com/oracle/cluster-api-provider-oci</a></p><p id="4ee5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">松弛的卡波奇:<a class="ae jn" href="https://kubernetes.slack.com/archives/C039CDHABFF" rel="noopener ugc nofollow" target="_blank">https://kubernetes.slack.com/archives/C039CDHABFF</a></p><p id="57a3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="ko">照片由</em> <a class="ae jn" href="https://unsplash.com/@melpoole?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> <em class="ko">梅尔普尔</em> </a> <em class="ko">上</em><a class="ae jn" href="https://unsplash.com/s/photos/cluster?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"><em class="ko">Unsplash</em></a></p></div></div>    
</body>
</html>