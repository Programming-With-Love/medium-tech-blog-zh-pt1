<html>
<head>
<title>Working with OCI Tag Defaults In Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Terraform中使用OCI标签默认值</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/working-with-oci-tag-defaults-in-terraform-d07608564eaf?source=collection_archive---------0-----------------------#2022-12-15">https://medium.com/oracledevs/working-with-oci-tag-defaults-in-terraform-d07608564eaf?source=collection_archive---------0-----------------------#2022-12-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/30dcac9adcfda375ffc1a5895bbb9b03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3WHRZc0OioSifpxuDlM37Q.jpeg"/></div></div></figure><p id="86e6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">对资源进行标记对于您的OCI部署来说是一件非常方便的事情。<a class="ae jn" href="https://docs.oracle.com/en-us/iaas/Content/Tagging/Tasks/managingtagdefaults.htm" rel="noopener ugc nofollow" target="_blank">标签默认值</a>提供了一种自动化资源标签的方法，但是在使用Terraform时要小心。</p><p id="3de6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一般来说，标记有助于从成本管理到定位部署的相关资源的所有事情。有许多方法可以手动和编程地将标签应用到OCI中的资源，但是使用自动<a class="ae jn" href="https://docs.oracle.com/en-us/iaas/Content/Tagging/Tasks/managingtagdefaults.htm" rel="noopener ugc nofollow" target="_blank">标签默认值</a>和区间是应用符合层次结构的标签策略的好方法，而不需要实际显式地添加标签；在给定隔离专区中创建的任何资源都将自动应用该隔离专区和任何父隔离专区的任何标记默认值(<strong class="ir hi"> <em class="jo">注</em> </strong>:对于没有定义默认值的标记默认值，您仍然必须显式提供标记和值)。您可能已经在使用这个特性而没有意识到它——Oracle提供了<code class="du jp jq jr js b"><a class="ae jn" href="https://docs.oracle.com/en-us/iaas/Content/Tagging/Concepts/understandingautomaticdefaulttags.htm" rel="noopener ugc nofollow" target="_blank">Oracle-Tags</a></code>标记名称空间，该名称空间提供了<code class="du jp jq jr js b">CreatedBy</code>和<code class="du jp jq jr js b">CreatedOn</code>标记，这些标记被配置为根隔离专区中的默认标记，并且可能应用于您已经创建的所有资源。</p><p id="ba6f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当手动创建资源时，利用标签默认值特别有效，并且可以很容易地适应作为代码场景的基础设施；即仅提供非默认的标签和标签值。然而，如果您的Terraform项目的寿命超过一次应用，那么Terraform就会出现问题。问题是Terraform维护一个状态文件，其中包含它创建的资源的详细信息，这包括资源参数，包括标记。对于最初的Terraform资源创建，一切都很好——创建了资源并应用了标签默认值。Terraform知道它创建了哪些资源，以及创建这些资源时的参数是什么，但是当Terraform <code class="du jp jq jr js b">plan</code>随后运行时，Terraform将默认标签识别为它没有提供的参数，因此很可能想要删除它们。在这种情况下，如果运行<code class="du jp jq jr js b">apply</code>，标签将被删除。这不是一个很好的结果，如果你是默认的成本跟踪标签！</p><h1 id="ba45" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">用代码修复它</h1><h2 id="1e58" class="kr ju hh bd jv ks kt ku jz kv kw kx kd ja ky kz kh je la lb kl ji lc ld kp le bi translated">资源特定方法</h2><p id="c053" class="pw-post-body-paragraph ip iq hh ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">一个显而易见的解决方案是，在使用Terraform时不要依赖标签默认值，而是显式定义所有必需的标签。</p><p id="cae3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">以编程方式设置所有必需的标签更容易被接受，并且可以被编入编码和测试周期中，以确保它们被创建。问题是，这对于通常使用<a class="ae jn" href="https://docs.oracle.com/en-us/iaas/Content/Tagging/Tasks/usingtagvariables.htm#Using_Tag_Variables" rel="noopener ugc nofollow" target="_blank">标签变量</a>来设置的<code class="du jp jq jr js b">Oracle-Tags</code>标签来说效果不好；该变量不等于最终应用的值，因此Terraform对后续运行不满意，将使用标签变量重新应用标签，这肯定会改变<code class="du jp jq jr js b">CreatedOn</code>并可能改变<code class="du jp jq jr js b">CreatedBy</code>。更好的方法是让OCI自动设置<code class="du jp jq jr js b">Oracle-Tags</code>，然后在地形中忽略它们。下面的示例代码创建了一个虚拟云网络，但也表明Terraform不应该担心<code class="du jp jq jr js b">CreatedBy</code>和<code class="du jp jq jr js b">CreatedOn</code>标签。有了这个位，任何后续的Terraform运行都不会改变这些标签。这可以根据需要扩展到包括其他自动默认的标签:</p><pre class="lk ll lm ln fd lo js lp bn lq lr bi"><span id="3e08" class="ls ju hh js b be lt lu l lv lw">resource "oci_core_vcn" "vcn" {<br/>  display_name   = var.vcn_name<br/>  compartment_id = var.compartment_id<br/>  cidr_blocks    = var.vcn_cidr_blocks<br/>  dns_label      = var.dns_label<br/>  is_ipv6enabled = false<br/>  defined_tags   = var.defined_tags<br/><br/>  lifecycle {<br/>    ignore_changes = [<br/>      defined_tags["Oracle-Tags.CreatedBy"],<br/>      defined_tags["Oracle-Tags.CreatedOn"],<br/>      defined_tags["My-Tags.AwesomeTag"]<br/>    ]<br/>  }<br/>}</span></pre><p id="9ec9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">注意，这种方法并不意味着任何可能应用了标签默认值的资源都需要有一个<code class="du jp jq jr js b">lifecycle</code>块来屏蔽所应用的标签默认值。</p><h2 id="1e80" class="kr ju hh bd jv ks kt ku jz kv kw kx kd ja ky kz kh je la lb kl ji lc ld kp le bi translated">提供商方法</h2><p id="1a06" class="pw-post-body-paragraph ip iq hh ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">另一种可能更好的方法是利用OCI平台提供商的一个特性，即<code class="du jp jq jr js b">ignore_defined_tags</code>参数。这将适用于由提供者实例管理的任何资源。您的提供者配置可能如下所示:</p><pre class="lk ll lm ln fd lo js lp bn lq lr bi"><span id="836f" class="ls ju hh js b be lt lu l lv lw">provider "oci" {<br/>  tenancy_ocid        = var.tenancy_ocid<br/>  region              = var.region<br/>  user_ocid           = var.user_ocid<br/>  fingerprint         = var.fingerprint<br/>  private_key         = var.private_key<br/><br/>  ignore_defined_tags = [<br/>    "Oracle-Tags.CreatedBy",<br/>    "Oracle-Tags.CreatedOn",<br/>    "My-Tags.AwesomeTag"<br/>  ]<br/>}</span></pre><p id="b143" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这些方法中的任何一种，甚至两者的组合，都可以扩展到您的环境中定义的其他标签默认值。</p><p id="f7f4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">显然，标签有巨大的潜力，所以在使用Terraform这样的工具时，了解一些潜在的陷阱是很重要的。想了解更多？请访问我们的开发人员Slack<a class="ae jn" href="https://bit.ly/odevrel_slack" rel="noopener ugc nofollow" target="_blank">与使用相同工具的人聊天！</a></p></div></div>    
</body>
</html>