<html>
<head>
<title>DataStore and synchronous work</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据存储和同步工作</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/datastore-and-synchronous-work-576f3869ec4c?source=collection_archive---------7-----------------------#2022-02-10">https://medium.com/androiddevelopers/datastore-and-synchronous-work-576f3869ec4c?source=collection_archive---------7-----------------------#2022-02-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/2299991abb14db357c1c152c75cb62f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8lWMtxkqO0QNOmu8L6R5Pg.png"/></div></div></figure><div class=""/><p id="ff59" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在我们的<a class="ae jn" rel="noopener" href="/androiddevelopers/introduction-to-jetpack-datastore-3dc8d74139e7"> <strong class="ir ht"> Jetpack数据存储系列</strong> </a>的以下帖子中，我们将涵盖几个额外的概念，以了解数据存储如何与其他API交互，以便您可以在<strong class="ir ht">生产环境</strong>中使用它。在这篇文章中，我们将重点关注与数据存储库的<strong class="ir ht">同步工作。我们将参考<a class="ae jn" href="https://developer.android.com/codelabs/android-preferences-datastore#0" rel="noopener ugc nofollow" target="_blank"> <strong class="ir ht">首选项</strong> </a> <strong class="ir ht"> codelab </strong>，获取代码示例。</strong></p><h1 id="be6b" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">做同步工作</h1><p id="11f9" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">在整个系列中，我们提到了DataStore的<strong class="ir ht">完全异步API </strong>，来自其内部使用的<strong class="ir ht"> Kotlin协程和流</strong>。为了防止在UI线程上执行较重的I/O操作时发生潜在的ANRs和UI jank，数据存储<strong class="ir ht">不提供随时可用的同步支持</strong>。DataStore将其数据集保存在一个文件中，除非另有说明，否则它会在<code class="du kr ks kt ku b"><strong class="ir ht">Dispatchers.IO</strong></code> <strong class="ir ht">、</strong>上执行所有数据操作，从而保持UI线程的畅通。这种API结构是DataStore相对于其前身<code class="du kr ks kt ku b">SharedPreferences</code>的主要优势之一，也是您在大多数情况下使用DataStore的方式。</p><p id="5648" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然而，如果您发现您的代码需要您与数据存储同步工作，无论是因为对另一个运行在主线程上的API的依赖，还是因为您当前的设置需要您为您的UI设置检索一些持久化的值，您都可以使用<code class="du kr ks kt ku b"><a class="ae jn" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/run-blocking.html" rel="noopener ugc nofollow" target="_blank"><strong class="ir ht">runBlocking()</strong></a></code>协程构建器来同步读取数据存储<strong class="ir ht"/>。这将<strong class="ir ht">阻塞调用线程</strong>，直到数据存储返回:</p><figure class="kv kw kx ky fd hj"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="6a84" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您发现自己处于需要使用这种方法的情况，请花些时间弄清楚是否绝对有必要<strong class="ir ht">阻塞主线程</strong>。考虑如何使用提供的<strong class="ir ht">数据存储异步替代方案</strong>或重构当前代码以避免<code class="du kr ks kt ku b">runBlocking()</code>，例如通过异步预加载数据:</p><figure class="kv kw kx ky fd hj"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="f4b4" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果这是不可能的，确保你用错误处理、<a class="ae jn" href="https://kotlinlang.org/docs/cancellation-and-timeouts.html" rel="noopener ugc nofollow" target="_blank">取消和超时</a>或者一些漂亮的视觉效果来覆盖所有潜在的UI jank场景，让用户体验尽可能的流畅。</p><h1 id="5a05" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">待续</h1><p id="871a" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">我们已经介绍了如何对数据存储执行<strong class="ir ht">同步工作。</strong>虽然这不是推荐的数据存储方法，但是如果您当前的设置确实需要您对它进行同步调用，您可以结合使用<code class="du kr ks kt ku b">.runBlocking()</code>和<code class="du kr ks kt ku b">.first()</code>操作符。</p><p id="ad33" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">加入我们系列的下一篇文章，我们将探讨如何进行<strong class="ir ht">数据存储到数据存储的迁移</strong>。</p><p id="4588" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您可以在这里找到我们的Jetpack DataStore系列的所有帖子:<br/><a class="ae jn" rel="noopener" href="/androiddevelopers/introduction-to-jetpack-datastore-3dc8d74139e7">Jetpack DataStore简介</a> <br/> <a class="ae jn" rel="noopener" href="/androiddevelopers/all-about-preferences-datastore-cc7995679334">所有关于首选项DataStore </a> <br/> <a class="ae jn" rel="noopener" href="/androiddevelopers/all-about-proto-datastore-1b1af6cd2879">所有关于Proto DataStore</a><br/><a class="ae jn" rel="noopener" href="/androiddevelopers/datastore-and-dependency-injection-ea32b95704e3">DataStore和依赖注入</a> <br/> <a class="ae jn" rel="noopener" href="/androiddevelopers/datastore-and-kotlin-serialization-8b25bf0be66c"> DataStore和Kotlin序列化</a> <br/> <a class="ae jn" rel="noopener" href="/androiddevelopers/datastore-and-synchronous-work-576f3869ec4c"> DataStore和同步工作</a> <br/> <a class="ae jn" rel="noopener" href="/androiddevelopers/datastore-and-data-migration-fdca806eb1aa"> DataStore和数据迁移</a> <br/> <a class="ae jn" rel="noopener" href="/androiddevelopers/datastore-and-testing-edf7ae8df3d8"> DataStore和测试</a></p></div></div>    
</body>
</html>