<html>
<head>
<title>Custom Downscaler For Trino Cluster on Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Cloud上Trino集群的自定义缩减器</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/custom-downscaler-for-trino-cluster-on-google-cloud-243f64112b86?source=collection_archive---------0-----------------------#2021-04-19">https://medium.com/walmartglobaltech/custom-downscaler-for-trino-cluster-on-google-cloud-243f64112b86?source=collection_archive---------0-----------------------#2021-04-19</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/d95605d3a77957a48765fd7b08234a1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hbs3J8_QF25KNNzPgQ4_iA.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Source: <a class="ae it" href="https://github.com/trinodb/trino.io/blob/master/assets/trino-og.png" rel="noopener ugc nofollow" target="_blank">Trino</a>, <a class="ae it" href="https://cloud.google.com/press/" rel="noopener ugc nofollow" target="_blank">Google Cloud</a></figcaption></figure><h1 id="3805" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">概观</h1><p id="aa63" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">我们在2018年用Trino开始了我们的旅程，当时只有少数用户，主要目标是只提供特别查询。与Hive相比，我们能够获得60倍的性能提升。这也是Trino在沃尔玛被越来越多的人采用的原因。不同的团队为了不同的用例转而使用Trino，他们都很高兴。</p><p id="fe19" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">到今天为止，在几个BI工具上开发的数千个仪表盘都由Trino提供支持，并且<strong class="ju hi">超过2K的活跃用户每月运行超过一百万个查询，在这个平台上每天处理数Pb的数据</strong>。</p><p id="5e49" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">我们的Trino集群位于GCP上，过去运行在Autoscale模式下，该模式根据集群负载的增加或减少，自动从托管实例组中添加或删除虚拟机(VM)实例。当对资源的需求较低时，它还帮助我们降低了成本。使用GCP的自动缩放器唯一令人担忧的缺点是，在自动缩放器终止的主机上运行的任务会失败。</p><p id="687f" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">尽管我们的大多数SQL查询都在5-10秒内完成，但也有一些长时间运行的查询会运行超过45分钟。由于GCP虚拟机被GCP自动缩放器终止，这些长时间运行的查询受到了很大的影响。因此经常会出现查询失败。</p><p id="242b" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">我们希望为我们的平台用户提供更加可靠和愉快的体验，</p><ul class=""><li id="eb1c" class="kv kw hh ju b jv kq jz kr kd kx kh ky kl kz kp la lb lc ld bi translated"><strong class="ju hi">集群缩减期间零查询失败</strong></li><li id="1af1" class="kv kw hh ju b jv le jz lf kd lg kh lh kl li kp la lb lc ld bi translated"><strong class="ju hi">对查询性能影响最小</strong></li></ul><p id="b32d" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">同时，我们希望<strong class="ju hi">确保Trino集群得到充分利用。</strong></p><h1 id="bc34" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">Trino星团的自动缩放问题</h1><p id="2dea" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">Trino集群向上扩展没有任何问题，但是<strong class="ju hi">当集群向下扩展时运行查询失败肯定会有问题</strong>。</p><p id="2e2d" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">即使Trino worker 在缩减期间<a class="ae it" href="https://trino.io/docs/current/admin/graceful-shutdown.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ju hi">正常关闭</strong> </a> <strong class="ju hi">，如果查询在关闭前启动并且运行时间超过90秒的宽限期，查询也可能失败。长期运行的查询也不例外。</strong></p><p id="9afb" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">比方说，一个用户提交一个SQL查询，它运行了45分钟，但失败了，原因仅仅是集群规模缩小了！留给用户的唯一选择是重试运行查询，并再等待45分钟，希望这次查询能够成功运行。</p><p id="1460" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">这给整个用户体验增加了一个坏味道，并且在任何组织中肯定会产生很多噪音。</p><p id="7c6e" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">简而言之，下面是我们想要解决的两个主要问题:</p><ul class=""><li id="ccf1" class="kv kw hh ju b jv kq jz kr kd kx kh ky kl kz kp la lb lc ld bi translated">GCP自动缩放器随机终止工作节点导致频繁查询失败</li><li id="a3cb" class="kv kw hh ju b jv le jz lf kd lg kh lh kl li kp la lb lc ld bi translated">当一个查询运行超过45分钟而失败时，会浪费集群资源，因为其中一个节点被GCP自动缩放器取走</li></ul><p id="512a" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">为了避免所有这些问题，我们决定自己管理集群缩减，让GCP只负责扩展集群。</p><h1 id="6432" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">定制下分频器的诞生</h1><figure class="lk ll lm ln fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lj"><img src="../Images/9e26ba605d453b7148040cec18cbd2d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AzuqrKn3J5Arptttq0jn2g.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Different strategies that we adopted to resolve the cluster down-scale issue</figcaption></figure><p id="ebd2" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">当我们第一次看到这个问题时，我们决定从自动扩展集群切换到静态集群。我们曾经根据集群负载在一天中的特定时间调整集群界限两次。但是，这只是一个临时的方法，显然不是非常有效和具有成本效益的方法。我们的用户很高兴，因为他们不再看到<strong class="ju hi"> PAGE_TRANSPORT_ERROR </strong>、<strong class="ju hi"> REMOTE_HOST_GONE </strong>和<strong class="ju hi"> TOO_MANY_REQUESTS_FAILED </strong>错误。集群处于更加可靠的状态。</p><p id="d18f" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">下一步，我们切换到在<strong class="ju hi">仅自动纵向扩展</strong>模式下运行集群，在这种模式下，GCP只负责纵向扩展集群。我们过去每天都会强制调整集群的大小，以确保在非高峰时段不会浪费集群资源。</p><p id="5319" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">即便如此，这也不是最佳解决方案，因为我们的集群曾经在集群上出现突然负载时快速扩展，但仅在非高峰时段缩减一次，这意味着<strong class="ju hi">集群曾经以上限运行至少10-12小时，即使负载已经减少</strong>。</p><p id="6caa" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">这是我们决定写一个自定义的向下缩放器的时候。我们允许GCP仅根据CPU利用率纵向扩展实例。缩小规模由我们负责。我们通过适度缩减Trino工人的规模解决了这个问题。</p><h1 id="2b2c" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">自定义下分频器如何工作？</h1><p id="e45d" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">自定义向下缩放器查看各种指标，如整体CPU利用率、内存利用率、运行查询计数和排队查询计数，以决定是否可以触发向下缩放操作。</p><p id="30da" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">一旦定制的向下缩放器发现缩小集群的机会，它就向Trino工作器发送关闭信号。</p><p id="99a1" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">Trino工人然后进入一个特殊的状态</p><ol class=""><li id="1480" class="kv kw hh ju b jv kq jz kr kd kx kh ky kl kz kp lo lb lc ld bi translated">停止服务新的请求，</li><li id="c590" class="kv kw hh ju b jv le jz lf kd lg kh lh kl li kp lo lb lc ld bi translated">继续处理为其安排的当前查询任务，</li><li id="335c" class="kv kw hh ju b jv le jz lf kd lg kh lh kl li kp lo lb lc ld bi translated">完成该工作后关闭。</li></ol><p id="e392" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">定制下定标器持续轮询Trino工作线程上正在运行的任务。一旦计数下降到零，自定义向下缩放器将虚拟机标记为终止。</p><h1 id="c2d2" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">这不是故事的结尾</h1><p id="126f" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">除了24/7运行的定制下分频器，我们还采用了<strong class="ju hi">预定下分频器</strong>的方法。在非高峰时段，我们的Trino集群负载会显著下降。</p><p id="6069" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">比方说，在高峰业务时段，集群满负荷运行，负载下降，向下缩放器将花费几个小时将集群向下缩放到更小/合适的大小。不是仅仅依靠定制的向下调整器来缩减集群，而是运行一个预定的向下调整器，通过调整GCP实例组的大小来强制调整Trino集群的大小。</p><p id="3a4d" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">我们确保在执行resize操作时，集群上没有或只有少量查询在运行，因此不会产生巨大的影响。</p><h1 id="a233" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">有什么帮助？</h1><p id="3cc4" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">嗯，我们设法<strong class="ju hi">将每月在Trino基础设施上的支出减少了近50% </strong>，而没有影响用户体验。集群几乎一直都得到很好的利用。</p><figure class="lk ll lm ln fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lp"><img src="../Images/a66882aa5938cca82835aad4017dfdf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r0m-uLQw07KEqo_2Ke8AHw.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Source: <a class="ae it" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">GCP</a> Trino Cluster CPU Utilization (<strong class="bd iw">Before Custom Downscaler</strong>)</figcaption></figure><figure class="lk ll lm ln fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lq"><img src="../Images/7f3c38dd9dd858287dd6cc946344a7aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GGT-jNqq6pMzwqUxgmtVRQ.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Source: <a class="ae it" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank">GCP</a> Trino Cluster CPU Utilization (<strong class="bd iw">After Custom Downscaler</strong>)</figcaption></figure><p id="4e6d" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">上面的屏幕抓图描述了引入自定义向下缩放器前后的群集利用率。很明显，在引入向下缩放器之前，群集利用率非常不一致，有时甚至不到30%。在定制的下分频器出现后，性能有了很大的提高，几乎一直保持在80%左右。</p><p id="3e80" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">当集群缩减时，我们没有看到更多的查询失败。</p><p id="e348" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated"><strong class="ju hi">生意快乐，我们快乐！</strong></p></div></div>    
</body>
</html>