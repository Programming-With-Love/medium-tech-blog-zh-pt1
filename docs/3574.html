<html>
<head>
<title>Kotlin Multiplatform Mobile(KMM) : Code sharing between Android and iOS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kotlin多平台移动(KMM):Android和iOS之间的代码共享</h1>
<blockquote>原文：<a href="https://medium.com/globant/kotlin-multiplatform-mobile-kmm-code-sharing-between-android-and-ios-9a9af66e2655?source=collection_archive---------0-----------------------#2020-12-11">https://medium.com/globant/kotlin-multiplatform-mobile-kmm-code-sharing-between-android-and-ios-9a9af66e2655?source=collection_archive---------0-----------------------#2020-12-11</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/53ee6afaba95453fbc0cffc5aaf319ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B-QWZzBRNUW_t2CIr9Ka8g.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">With KMM Android and iOS can be BFF</figcaption></figure><p id="be16" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这个博客将帮助你了解Kotlin多平台移动设备(又名KMM)在Android和iOS之间共享代码的潜力。我为我们的项目评估了KMM，现在在这里与你们分享我们的经验。</p><h1 id="85af" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">动机</strong></h1><ul class=""><li id="8f72" class="kp kq hh iv b iw kr ja ks je kt ji ku jm kv jq kw kx ky kz bi translated">第一个动机因素是你想开发Android和iOS应用程序？但是不想把工作做两遍！</li><li id="8e90" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">你简直爱干(不重复自己)校长！却不知道如何开始。</li><li id="9cac" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">或者你在iOS方面的专业知识较少。</li><li id="92dd" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">作为一名优秀的软件工程师，您也希望快速交付高质量的特性。</li><li id="68d9" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">但是由于某种原因不喜欢现有的跨平台技术。</li></ul><p id="1568" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">如果以上几点足够激励你，让我们来了解一下KMM到底是什么。</p><h1 id="14c1" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">什么是KMM？</h1><ul class=""><li id="2769" class="kp kq hh iv b iw kr ja ks je kt ji ku jm kv jq kw kx ky kz bi translated">允许您一次编写代码，并在Android和iOS等多个平台上使用。</li><li id="6dc5" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">它减少了测试工作。</li><li id="c0f5" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">维护问题较少，因为修改简单快捷。</li><li id="bb5e" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">它使用Kotlin，这是一种静态类型的语言，具有本地编程语言的优势。</li><li id="ceae" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">对于Android工程师来说，没有什么真正的变化，对于iOS项目，我们只是导入一个框架，就像任何基于Swift的框架一样。</li><li id="4cf8" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">如果你计划得当，iOS的开发时间可以减少30-40 %,他们只需要为它编写UI层。</li></ul></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><h1 id="1c74" class="jr js hh bd jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk lq km kn ko bi translated">KMM与现代应用架构</h1><p id="6d28" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">现代需要现代应用，现代应用需要现代架构。Android和iOS生态系统都处于一个阶段，它们不太适合刻板的架构模式。他们要求更多。我们有缓存、维护视图状态、了解生命周期变化等概念，下图解释了应用程序的哪一层可以共享。你会有一些想法，在哪里你可以利用KMM的概念。</p><figure class="lu lv lw lx fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/eb5c54697d9502906f0d461bb9c6d6cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EIcuDPeZAk6j9HaFaWDUdQ.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">What can be shared in the modern architecture</figcaption></figure><p id="f6cb" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">从上图中你可以很容易地理解，在数据层上，负责网络调用和数据库查询的类可以100%共享。KMM在<a class="ae ly" href="https://ktor.io/" rel="noopener ugc nofollow" target="_blank"> Ktor </a>的帮助下为你提供这种力量。Ktor是一个框架，使您能够进行异步网络调用。还有另一个框架叫做<a class="ae ly" href="https://www.kotlinresources.com/library/sqldelight/" rel="noopener ugc nofollow" target="_blank"> SQLDelight </a>，来自square.io，它与KMM兼容，允许你编写代码来进行一些SQLite数据库操作。</p><h1 id="0cc0" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">KMM是如何运作的？</h1><p id="2e73" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">所以你一定在想这整个事情是怎么运作的。让我用图表来帮助你理解这一点。</p><figure class="lu lv lw lx fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/12cd14d7e6307a1a0ca3ca44aefe0c77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8oCM2DzarLdysWttivqJ5g.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">How KMM works? Icons by <a class="ae ly" href="https://www.flaticon.com/authors/freepik" rel="noopener ugc nofollow" target="_blank">Freepik</a></figcaption></figure><p id="fd08" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在上面的可视化表示中，你可以看到我是如何将idea分为三个主要层的，即共享代码、iOS原生代码和Android原生代码。</p><p id="7790" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">共享代码将具有围绕网络调用和其他核心实用类型功能的业务逻辑的通用实现。</p><p id="f076" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">KMM足够灵活，它允许开发者在需要的时候使用Android和iOS的特定API实现。它使用预期/实际机制来实现这一点。在本文中，我们将很快了解expect/actual。</p><p id="7854" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">一旦构建了共享模块，共享模块的最终结果是。iOS和的框架文件。Android的jar文件。所以从逻辑上讲，你的Android和iOS项目甚至不知道共享模块是用Kotlin编写的，对他们来说，这只是另一种依赖。</p><h1 id="538d" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">KMM:循序渐进指南</h1><p id="ad6b" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">在这一点上，你应该对KMM在概念上如何适用于Android和iOS有了足够的理解。现在是以一步一步的方式实际实现整个概念的时候了。</p></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><h2 id="7e9d" class="lz js hh bd jt ma mb mc jx md me mf kb je mg mh kf ji mi mj kj jm mk ml kn mm bi translated">1.您需要的工具</h2><p id="705d" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">要开发任何KMM项目，你需要以下四种工具。</p><p id="17af" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi"> Android Studio : </strong>你需要AS 4.0及以上版本来编写你的共享代码和Android应用。</p><p id="6076" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi"> Xcode : </strong> XCode 11.3.1及更高版本允许您编写iOS应用程序，它也是编译和构建您的iOS应用程序所必需的</p><p id="c6c6" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi"> KMM插件:</strong> KMM插件允许你使用向导创建KMM项目，并附带定制的升级任务来构建iOS应用程序。</p><p id="cf8d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">由于整个iOS生态系统都在macOS上运行，你需要macOS来编写和测试iOS应用程序。</p></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><h2 id="a4e2" class="lz js hh bd jt ma mb mc jx md me mf kb je mg mh kf ji mi mj kj jm mk ml kn mm bi translated">2.设置KMM项目</h2><p id="55e6" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">从AndroidStudio的<code class="du mn mo mp mq b">Preference -&gt;Plugins-&gt; Marketplace</code>部分安装KMM插件。KMM插件需要Kotlin 1.3及以上版本。</p><p id="3cff" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">一旦插件安装完毕，重启AndroidStudio，创建一个新的Android应用程序，并在项目模板中选择KMM应用程序。请看下图。</p><figure class="lu lv lw lx fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mr"><img src="../Images/112cc0487eeef46a081c49c5268ef25d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O29oDq4sz2-PhgMHL-kKNQ.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Select KMM application in project template</figcaption></figure><p id="fc4c" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">一旦您选择了应用程序，您需要提供更多的细节，如应用程序名称和名称为您的Android，iOS和共享模块。一旦你提供了这些细节，你将有你的项目创建。我将我的项目命名为KMMNovelCovid，并在项目创建后获得了以下目录结构。</p><figure class="lu lv lw lx fd ii er es paragraph-image"><div class="er es ms"><img src="../Images/a1d950094e16ad798a604701c50900f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*ajHtQMwJwXOuPQdVwxUrDw.png"/></div><figcaption class="ip iq et er es ir is bd b be z dx">KMM Directory structure</figcaption></figure><p id="898a" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">现在一切都准备好了，可以开始编码了！</p></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><h2 id="a5ac" class="lz js hh bd jt ma mb mc jx md me mf kb je mg mh kf ji mi mj kj jm mk ml kn mm bi translated">3.问题陈述/用例</h2><p id="47b1" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">我们采用了足够好的问题陈述来测试所有典型的Android和iOS项目范例和复杂性。</p><p id="dce7" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">我们想要建造</p><ul class=""><li id="4684" class="kp kq hh iv b iw ix ja jb je mt ji mu jm mv jq kw kx ky kz bi translated">一个简单的应用程序，显示covid 19受影响国家的列表。</li><li id="65ff" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">将从远程服务器获取数据。</li><li id="9d2b" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">提取的数据将显示在用户的设备上。</li><li id="4553" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">应用程序将使用本地组件开发。</li><li id="bb10" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">需要编写测试用例。</li></ul><p id="fbfc" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">下图将帮助你想象我们正在开发的东西。</p><figure class="lu lv lw lx fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/fa5b974164f66419f79fe94ee08bcebc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kr0Rz4QbV3MeKV7O-12ekw.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Visualize application UI</figcaption></figure></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><h2 id="6416" class="lz js hh bd jt ma mb mc jx md me mf kb je mg mh kf ji mi mj kj jm mk ml kn mm bi translated">4.我们在分享什么？</h2><p id="33a6" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">基于以上几点，下面是我们将如何开发我们的共享模块的图表。</p><figure class="lu lv lw lx fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mw"><img src="../Images/44074c3e2ab23045964beb2df945dc49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Os5emVHOuOKryQrJccEcrg.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Shared module diagram</figcaption></figure><p id="ea6b" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">让我们花一些时间来理解这个图。</p><p id="3d46" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在最底层，我保留了<code class="du mn mo mp mq b">Ktor</code>。我们的HTTP客户端。幕后Ktor分别针对Android和iOS应用使用HttpURLConnection和NSURLSession。它可以配置所有东西，如重试和超时机制，为安全起见添加证书和公共pin。最重要的是，它支持一些基于JSON的ORM库，例如<code class="du mn mo mp mq b">Moshi</code>、<code class="du mn mo mp mq b">Jackson</code>和<code class="du mn mo mp mq b">Gson</code>。Kotlin团队也提出了他们自己的序列化库，即<code class="du mn mo mp mq b">Kotlinx Serialisation</code>。我们的项目使用Kotlinx序列化。最重要的是，Ktor还支持Kotlin协程。是不是很神奇？</p><p id="d2f6" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">现在网络层直接用在一个名为<code class="du mn mo mp mq b">NovelCovidAPIClient.kt</code>的类中。这个类单独负责使用核心ktor类连接到远程服务器，解析json响应并将其发送回消费者类。</p><p id="3699" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><code class="du mn mo mp mq b">NovelCovidAPIClient.kt</code>可以直接访问像<code class="du mn mo mp mq b">CountryItem.kt </code>和<code class="du mn mo mp mq b">CountryInfo.kt</code>这样的实体/数据类。这些类以类属性的形式保存JSON数据。</p><p id="daa7" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">还要注意上图中的独立块。该类允许您获取每个平台的操作系统信息。我将向您展示<code class="du mn mo mp mq b">expect/actual</code>机制是如何工作的，您可以在共享模块中有一个代码，但对于您的Android和iOS应用程序却有不同的实现。</p></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><h2 id="71c2" class="lz js hh bd jt ma mb mc jx md me mf kb je mg mh kf ji mi mj kj jm mk ml kn mm bi translated">5.配置:共享模块</h2><p id="78a9" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">内部:共享模块您需要打开<code class="du mn mo mp mq b">build.gradle.kts</code>文件并添加一些依赖项，如下面的代码片段所示。</p><figure class="lu lv lw lx fd ii"><div class="bz dy l di"><div class="mx my l"/></div></figure><p id="405b" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">查看如何创建各种源集，即<code class="du mn mo mp mq b">commonMain</code>、<code class="du mn mo mp mq b">androidMain</code>和<code class="du mn mo mp mq b">iOSMain</code>。在每个源集中，我们都添加了所需的依赖项。这些依赖关系最终将用于编写网络层。</p><p id="85ec" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">还要注意属性，即<code class="du mn mo mp mq b">packForXcode</code>。这个性质是在做一个创造现象的任务。iOS项目的框架文件。</p></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><h2 id="9cb8" class="lz js hh bd jt ma mb mc jx md me mf kb je mg mh kf ji mi mj kj jm mk ml kn mm bi translated">6.编写共享网络客户端</h2><p id="df4c" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">现在我们需要创建进行网络调用的共享类。我们称之为<code class="du mn mo mp mq b">NovelCovidApiClient</code>。检查代码片段，看看我们是如何用Kotlin编写这个类的。</p><figure class="lu lv lw lx fd ii"><div class="bz dy l di"><div class="mx my l"/></div></figure><p id="af90" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在上面的代码片段中，你还可以看到我们如何配置<code class="du mn mo mp mq b">kotlinx.serialization</code> lib来将JSON解析成<code class="du mn mo mp mq b">CountryItem</code>和<code class="du mn mo mp mq b">CountryInfo</code>数据类。</p><p id="76e7" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">现在，您可以在类的存储库类型中使用它，也可以直接使用该类。将这个类作为repository类的一部分是一个好主意，因为它将对Ktor的依赖从主应用程序中分离出来。</p></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><h2 id="bdeb" class="lz js hh bd jt ma mb mc jx md me mf kb je mg mh kf ji mi mj kj jm mk ml kn mm bi translated">7.在Android中使用共享网络类</h2><p id="1f7f" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">要在Android中使用这个类，你通常可以使用<code class="du mn mo mp mq b">Presenter</code>或<code class="du mn mo mp mq b">ViewModel</code>。KMM的美妙之处在于，它不会在平台上强加任何东西。您的<code class="du mn mo mp mq b">ViewModel</code>类通常如下所示。</p><figure class="lu lv lw lx fd ii"><div class="bz dy l di"><div class="mx my l"/></div></figure><p id="e382" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这很简单。我不是一开始就说过吗？这就是为什么对于Android工程师来说，它不会改变任何事情。</p><p id="c7ee" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">现在这个视图模型类可以在<code class="du mn mo mp mq b">Fragment</code>或<code class="du mn mo mp mq b">Activity</code>级别使用。当您在任何视图层上使用视图模型实例时，KMM不在范围内。UI层完全不知道KMM的存在</p></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><h2 id="8acf" class="lz js hh bd jt ma mb mc jx md me mf kb je mg mh kf ji mi mj kj jm mk ml kn mm bi translated">8.在iOS中使用共享网络类</h2><p id="f7f7" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">现在的你，可能不是iOS工程师。但是为了让您对如何在iOS中使用KMM有一个完整的了解，让我来介绍一下如何使用这个共享的网络类。就像Android一样，你可以直接使用这个类，也可以用某个类来包装它。检查以下要点，它会给你更多的信息，我如何在iOS中使用这个类。</p><figure class="lu lv lw lx fd ii"><div class="bz dy l di"><div class="mx my l"/></div></figure><p id="c584" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">就是这样！任务完成。</p><p id="d444" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">现在，让我们花些时间来了解一下，一切是如何走到一起的。</p><p id="1995" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">有两个因素使得这一切成为可能。KMM插件和一个定制的<code class="du mn mo mp mq b">gradle</code>任务。参考步骤5中<code class="du mn mo mp mq b">:shared:build.gradle.kts </code>文件中的<code class="du mn mo mp mq b">packForXcode</code>属性。KMM插件在Xcode的构建阶段配置这个任务。所以每次你运行Xcode构建并触发iOS构建时，<code class="du mn mo mp mq b">packForXcode</code>就会运行并为你创建一个<code class="du mn mo mp mq b">.framework </code>文件。KMM插件也链接并嵌入这个<code class="du mn mo mp mq b">.framework</code>文件到你的Xcode设置中。这是免费的，不需要任何努力，因为所有这些都是由KMM插件自动完成的。</p><p id="9d26" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">当<code class="du mn mo mp mq b">packForXcode</code>任务运行时，它实际上将所有Kotlin代码转换成Swift和ObjectiveC头文件。</p><h1 id="23d1" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">针对每个平台的不同实现</h1><p id="410d" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">假设我们想要获得操作系统的名称和版本。但是我们希望将这些代码保存在共享模块中。你怎么能做到这一点。KMM允许您使用expect关键字定义期望。无论你用expect关键字定义什么，实际的实现都将由Android和iOS项目提供。</p><h2 id="8693" class="lz js hh bd jt ma mb mc jx md me mf kb je mg mh kf ji mi mj kj jm mk ml kn mm bi translated">预期</h2><p id="d6df" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">这是一种给KMM编译器的指令，期望它稍后实现，并且它不会在<code class="du mn mo mp mq b">commonMain</code>源集中。稍后<code class="du mn mo mp mq b">androidMain</code>和<code class="du mn mo mp mq b">iOSMain</code>源集将提供它的实际实现。</p><h2 id="93f1" class="lz js hh bd jt ma mb mc jx md me mf kb je mg mh kf ji mi mj kj jm mk ml kn mm bi translated">实际的</h2><p id="a40c" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated"><code class="du mn mo mp mq b">androidMain</code>和<code class="du mn mo mp mq b">iOSMain</code>都使用这个关键字提供了实现。原则上，这看起来就像使用expect关键字声明抽象，然后使用实际的关键字实现。</p><p id="85c3" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在下面的代码片段中，您可以看到expect/actual在运行。</p><figure class="lu lv lw lx fd ii"><div class="bz dy l di"><div class="mx my l"/></div></figure><p id="ffa2" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Android Android和iOS都可以调用这个函数，就像从共享模块调用任何其他函数一样。</p><h1 id="cb71" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">测试</h1><p id="7481" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">测试是评估KMM的能力和潜力的非常重要的参数。现在每个工程师都知道单元测试的重要性，并且非常重视它。当我试着写一个测试用例时，它对我来说非常自然，没有任何虚假。我也使用了流行的Mockito框架。我使用这个模仿库来模仿核心http客户端。看到下图，知道我是如何围绕share networking客户端编写单元测试的。</p><figure class="lu lv lw lx fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/d83c11a9127fcc11a55fdd590e5b7dd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4553kgTYM80fb46bs66tWA.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Unit testing Shared API client</figcaption></figure><h1 id="7c73" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">如果我的项目不是绿地项目怎么办？</h1><p id="8f53" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">在新项目中设置和使用KMM非常简单。但是让我们现实一点。你不能指望在整个科特林社区，你总是会开始新的项目。如果你有现有的项目，仍然想使用KMM。以下是JetBrains的Kotlin团队在2020年举行的Kotlin 1.4活动中分享的一些指南。</p><figure class="lu lv lw lx fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/3e63bbf439773583acb1900b76d79bc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xtSiFQwQ7VVd03DpKa0-Zw.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Use KMM in existing project. Reference from <a class="ae ly" href="https://youtu.be/PW-jkOLucjM?t=466" rel="noopener ugc nofollow" target="_blank">Kotlin 1.4 event</a></figcaption></figure><h1 id="c28b" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">KMM准备好生产了吗？</h1><p id="4f3b" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">在了解了这个令人兴奋的框架和方法之后，我相信您已经迫不及待地开始着手这项工作了。但是等一下，不要着急。因为您可能想知道我们所了解的一切实际上是稳定的，并且可以用于生产。下表将帮助您了解稳定性。</p><figure class="lu lv lw lx fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/b98de934a07534fb7a5fa286372e157a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*StNQbGXokgW-p5KmczwJnQ.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">KMM Stability guide</figcaption></figure><ul class=""><li id="aeef" class="kp kq hh iv b iw ix ja jb je mt ji mu jm mv jq kw kx ky kz bi translated">该图在2020年12月5日仍然有效。查看最新的<a class="ae ly" href="https://kotlinlang.org/docs/reference/evolution/components-stability.html" rel="noopener ugc nofollow" target="_blank">https://kotlinlang . org/docs/reference/evolution/components-stability . html</a></li><li id="b1eb" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">科特林生态系统的组成部分有实验性的、阿尔法的、贝塔的和稳定的。</li><li id="b660" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">KMM处于阿尔法状态。这意味着Kotlin团队完全致力于改进和发展这项技术，不会突然放弃它。</li></ul><h1 id="a29e" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">参考</h1><p id="2d82" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">我从下面的链接中找到了很多有用的信息，我相信你也会发现这些链接很有用。</p><ul class=""><li id="a21b" class="kp kq hh iv b iw ix ja jb je mt ji mu jm mv jq kw kx ky kz bi translated"><a class="ae ly" href="https://play.kotlinlang.org/hands-on/Networking%20and%20Data%20Storage%20with%20Kotlin%20Multiplatfrom%20Mobile/01_Introduction" rel="noopener ugc nofollow" target="_blank">动手教程</a></li><li id="aa2c" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated"><a class="ae ly" href="https://kotlinlang.org/docs/mobile/integrate-in-existing-app.html#decide-what-to-share" rel="noopener ugc nofollow" target="_blank">与现有应用集成</a></li><li id="eeb2" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated"><a class="ae ly" href="https://kotlinlang.org/docs/mobile/kmm-evolution.html" rel="noopener ugc nofollow" target="_blank"> KMM稳定</a></li><li id="07a0" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated"><a class="ae ly" href="https://kotlinlang.org/docs/mobile/introduce-your-team-to-kmm.html#prepare-for-questions" rel="noopener ugc nofollow" target="_blank">关于KMM的常见问题</a></li><li id="cdae" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated"><a class="ae ly" href="https://kotlinlang.slack.com/?redir=%2Farchives%2FC3PQML5NU" rel="noopener ugc nofollow" target="_blank">科特林懈对KMM的支持</a></li></ul><h1 id="3dc2" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">演示视频</h1><p id="223a" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lr jg jh ji ls jk jl jm lt jo jp jq ha bi translated">本月早些时候，我和我的同事Rohit Jankar也就此发表了演讲。请检查视频</p><figure class="lu lv lw lx fd ii"><div class="bz dy l di"><div class="mz my l"/></div></figure><p id="952c" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">关于KMM，我要说的就是这些。祝你代码共享愉快。😄</p></div></div>    
</body>
</html>