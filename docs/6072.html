<html>
<head>
<title>Open-sourcing Pinterest MySQL management tools</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开源Pinterest MySQL管理工具</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/open-sourcing-pinterest-mysql-management-tools-7a9f90cffc9?source=collection_archive---------1-----------------------#2015-10-28">https://medium.com/pinterest-engineering/open-sourcing-pinterest-mysql-management-tools-7a9f90cffc9?source=collection_archive---------1-----------------------#2015-10-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="bc01" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Robert Wultsch | Pinterest工程师</p><p id="3c92" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">过去，我们分享过<a class="ae jc" href="https://engineering.pinterest.com/blog/learn-stop-using-shiny-new-things-and-love-mysql" rel="noopener ugc nofollow" target="_blank">你为什么应该喜欢MySQL </a>以及它如何通过切分帮助<a class="ae jc" href="https://engineering.pinterest.com/blog/sharding-pinterest-how-we-scaled-our-mysql-fleet" rel="noopener ugc nofollow" target="_blank"> Pinterest扩大规模。在今天的</a><a class="ae jc" href="https://events.rainfocus.com/oow15/catalog/oracle.jsp?search=[CON3654]&amp;search.event=openworldEvent&amp;search.day=20151028" rel="noopener ugc nofollow" target="_blank">甲骨文开放世界</a>大会上，我们宣布开源我们维护MySQL基础设施的绝大部分自动化。在本帖中，我们将详细介绍我们的MySQL环境，用于管理它的工具，以及如何实现它们来自动化您的MySQL基础架构。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/c24965affe82267f52c7fbd2eadcbf4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/format:webp/0*AQnJ-IM4Zg1tEdLN.png"/></div></figure><h2 id="d7cd" class="jl jm hh bd jn jo jp jq jr js jt ju jv ip jw jx jy it jz ka kb ix kc kd ke kf bi translated">Pinterest上的MySQL基础知识</h2><p id="18f7" class="pw-post-body-paragraph ie if hh ig b ih kg ij ik il kh in io ip ki ir is it kj iv iw ix kk iz ja jb ha bi translated">历史上，我们使用MySQL存储一些最重要的数据，包括pin、电路板、图像元数据和Pinners的证书。</p><p id="7f81" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最近，我们增加了以下使用案例:</p><ul class=""><li id="164c" class="kl km hh ig b ih ii il im ip kn it ko ix kp jb kq kr ks kt bi translated"><a class="ae jc" href="https://engineering.pinterest.com/blog/pinlater-asynchronous-job-execution-system" rel="noopener ugc nofollow" target="_blank"> PinLater </a>:部分由于<a class="ae jc" href="https://engineering.pinterest.com/blog/mysql-performance-optimization-50-more-work-60-less-latency-variance" rel="noopener ugc nofollow" target="_blank">内核优化</a>，MySQL已经取代Redis，成为我们的异步作业执行引擎唯一支持的后端。</li><li id="7fbc" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb kq kr ks kt bi translated"><a class="ae jc" href="https://www.youtube.com/watch?v=yI0vHfgK6oI" rel="noopener ugc nofollow" target="_blank"> Zen </a> : MySQL已经加入HBase，作为我们图形存储引擎的支持后端。</li></ul><p id="50ea" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于Pinterest上的所有MySQL用例，从管理角度来看，环境是相同的:</p><ul class=""><li id="e3b0" class="kl km hh ig b ih ii il im ip kn it ko ix kp jb kq kr ks kt bi translated">一个主服务器带一个或两个从服务器:历史上，MySQL用于一个副本集中的多个可写实例。这种拓扑容易出错，已经简化为一个主设备和一个或多个从设备。</li><li id="0be3" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb kq kr ks kt bi translated"><a class="ae jc" href="https://engineering.pinterest.com/blog/serving-configuration-data-scale-high-availability" rel="noopener ugc nofollow" target="_blank"> Zookeeper提供服务发现</a>:管理工具和MySQL应用之间的契约是Zookeeper。除了少数例外，ZooKeeper为客户提供数据库主机名、用户名和密码。</li></ul><h2 id="25c1" class="jl jm hh bd jn jo jp jq jr js jt ju jv ip jw jx jy it jz ka kb ix kc kd ke kf bi translated">云中MySQL实例的生命周期</h2><p id="bbc5" class="pw-post-body-paragraph ie if hh ig b ih kg ij ik il kh in io ip ki ir is it kj iv iw ix kk iz ja jb ha bi translated">Pinterest上的MySQL服务器启动、存活和死亡都只伴随着最罕见的配置变化。升级内核、MySQL版本和任何其他需要重启数据库的更改都不会就地完成。相反，这些操作总是根据需要通过服务器更换和故障切换/从属升级来执行。这种选择消除了管理中间状态的需要，极大地简化了我们的自动化。我们称这种心态为“运营佛教”，意思是我们不会依赖我们的服务器，因为它们可能明天就不在了。</p><p id="9708" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们最重要的脚本之一是<em class="kz">launch _ replacement _ db _ host . py</em>。在最简单的情况下，<em class="kz">launch _ replacement _ db _ host . py</em>唯一需要的参数是失败的从服务器的主机名。检查现有实例，计算新服务器所需的所有参数，然后启动新服务器。对于其他更改，如MySQL升级、硬件升级/降级和数据中心迁移，有可选参数。</p><p id="4919" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在新服务器启动并从我们的供应系统接收到初始基本配置后，cron作业将注意到数据目录为空，并运行<em class="kz">MySQL _ restore _ xtra backup . py</em>。基于来自我们的服务发现(ZooKeeper)的信息，这个脚本将尝试找到一个数据库备份，恢复它，设置复制，并将新的MySQL实例添加到目录中。与<em class="kz">launch _ replacement _ db _ host . py</em>一样，<em class="kz">MySQL _ restore _ xtra backup . py</em>接受许多非标准用途的可选参数。</p><p id="21dd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果MySQL主服务器需要更换，则必须运行<em class="kz"> mysql_failover.py </em>脚本来将主要从服务器升级为主服务器。该脚本处理活着的或死去的初始主机，然后修改MySQL复制拓扑并更新服务发现。</p><p id="0f13" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当一个服务器从ZooKeeper中移除后，它将被一个退役队列系统所控制。该系统有几个导致服务器最终终止的步骤:</p><ul class=""><li id="6f0d" class="kl km hh ig b ih ii il im ip kn it ko ix kp jb kq kr ks kt bi translated">ZooKeeper中不存在的服务器被认为没有被使用，并且将重置几个状态计数器。</li><li id="49bb" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb kq kr ks kt bi translated">一天后，将检查服务器，查看是否有任何活动导致状态计数器增加。如果计数器已经递增，则退出过程中止。如果计数器没有增加，MySQL实例将被发送一个关闭命令。</li><li id="eee7" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb kq kr ks kt bi translated">又过了一天，如果服务器的数据库没有重新启动，服务器将被终止。</li></ul><h2 id="e58a" class="jl jm hh bd jn jo jp jq jr js jt ju jv ip jw jx jy it jz ka kb ix kc kd ke kf bi translated">其他公用事业</h2><p id="9f05" class="pw-post-body-paragraph ie if hh ig b ih kg ij ik il kh in io ip ki ir is it kj iv iw ix kk iz ja jb ha bi translated">我们已经构建了各种各样的其他实用程序，并且也是开源的:</p><ul class=""><li id="f14c" class="kl km hh ig b ih ii il im ip kn it ko ix kp jb kq kr ks kt bi translated"><em class="kz">MySQL _ replica _ mappings . py</em>:这个脚本以一种易于用于shell脚本的格式，为管理员提供了生产中的内容的快速视图(我们将“生产中”定义为“ZooKeeper中”)。</li><li id="a266" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb kq kr ks kt bi translated">mysql_backup_xtrabackup.py :这是我们mysql的主要备份系统。这些备份被<em class="kz"> mysql_restore_xtrabackup </em>用来构建新的mysql实例。</li><li id="34a5" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb kq kr ks kt bi translated"><em class="kz"> archive_mysql_binlogs.py </em>:我们备份mysql复制日志，以便在副本集中的所有服务器都丢失的情况下执行时间点恢复。</li><li id="a326" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb kq kr ks kt bi translated">这个脚本管理我们的数据库用户。这是我们最古老的自动化技术之一，也是我们最受限制的技术之一。它暂时满足了我们的需求，但迟早需要大幅扩展。</li><li id="8ccf" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb kq kr ks kt bi translated"><em class="kz"> mysql_cnf_builder.py </em>:该脚本基于全局默认值构建mysql配置文件，然后覆盖工作负载类型、硬件和MySQL版本。包括几个示例配置文件。</li><li id="47d4" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb kq kr ks kt bi translated"><em class="kz"> mysql_checksum.py </em>和<em class="kz">get _ recent _ checksum . py</em>:每天，我们对一部分碎片运行pt-checksum，以确定主设备和从设备是否不同步，如果是，同步程度如何。(大多数时候，我们的复制漂移是零或者非常接近零。)mysql_checksum.py脚本运行校验和并存储结果。<em class="kz">get _ recent _ checksums . py</em>脚本将检索所有最近的校验和结果，并以用户友好的方式显示数据。</li><li id="fbd4" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb kq kr ks kt bi translated">还有一堆！</li></ul><h2 id="8748" class="jl jm hh bd jn jo jp jq jr js jt ju jv ip jw jx jy it jz ka kb ix kc kd ke kf bi translated">不是万灵药</h2><p id="1639" class="pw-post-body-paragraph ie if hh ig b ih kg ij ik il kh in io ip ki ir is it kj iv iw ix kk iz ja jb ha bi translated">这些工具紧密集成到我们的服务发现机制中，并且可能需要对从服务发现中读取和写入的代码进行适度的修改。与我们已经开源的其他技术不同，这些实用程序有一些遗留限制，例如缺少对两个以上从设备的支持。我们希望这些工具对希望为MySQL基础设施创建自动化的其他人有用。</p><h2 id="0148" class="jl jm hh bd jn jo jp jq jr js jt ju jv ip jw jx jy it jz ka kb ix kc kd ke kf bi translated">人类效率</h2><p id="430d" class="pw-post-body-paragraph ie if hh ig b ih kg ij ik il kh in io ip ki ir is it kj iv iw ix kk iz ja jb ha bi translated">由于我们工具的有效性，我们能够用不到两名专门的工程师来维护具有数百TB数据的MySQL环境。</p><h2 id="5df0" class="jl jm hh bd jn jo jp jq jr js jt ju jv ip jw jx jy it jz ka kb ix kc kd ke kf bi translated">代码</h2><p id="0f92" class="pw-post-body-paragraph ie if hh ig b ih kg ij ik il kh in io ip ki ir is it kj iv iw ix kk iz ja jb ha bi translated">我们的公共代码库现已上线，可以在位于<a class="ae jc" href="https://github.com/pinterest/mysql_utils" rel="noopener ugc nofollow" target="_blank">https://github.com/pinterest/mysql_utils</a>的<a class="ae jc" href="https://github.com/pinterest" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到我们的其他开源项目</p><p id="b694" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">鸣谢:Ernie Souhrada也为MySQL管理工具做出了贡献。</p></div></div>    
</body>
</html>