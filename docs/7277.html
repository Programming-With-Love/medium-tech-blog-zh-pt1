<html>
<head>
<title>OAuth with PHP, Part One: getting access tokens.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用PHP实现OAuth，第一部分:获取访问令牌。</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/oauth-with-php-part-one-getting-access-tokens-5a18b0b70099?source=collection_archive---------1-----------------------#2017-11-30">https://medium.com/square-corner-blog/oauth-with-php-part-one-getting-access-tokens-5a18b0b70099?source=collection_archive---------1-----------------------#2017-11-30</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="c27b" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">实现OAuth可能是集成中最难的部分，但如果你要向其他商家开放你的应用，这是必须的。如果你正在使用PHP，这里有一些帮助。</h2></div><blockquote class="iw"><p id="ab74" class="ix iy hh bd iz ja jb jc jd je jf jg dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae jh" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><p id="dcd1" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc jg ha bi translated">OAuth是安全控制开发者应用程序和Square商家账户之间访问的重要部分。如果您正在构建供多个Square帐户使用的应用程序，您将需要实现它。</p><p id="fcfb" class="pw-post-body-paragraph ji jj hh jk b jl kd ii jn jo ke il jq jr kf jt ju jv kg jx jy jz kh kb kc jg ha bi translated">除了这篇文章，你应该在构建你的集成时看看<a class="ae jh" href="https://docs.connect.squareup.com/api/oauth" rel="noopener ugc nofollow" target="_blank"> Square的OAuth文档</a>——它将永远是真理的源泉，并且会随着任何事情的变化而不断更新。还有第2部分关于<a class="ae jh" rel="noopener" href="/square-corner-blog/oauth-with-php-part-two-refreshing-revoking-tokens-9ae065537c41">如何刷新和撤销OAuth令牌</a>。</p><h2 id="bf8e" class="ki kj hh bd kk kl km kn ko kp kq kr ks jr kt ku kv jv kw kx ky jz kz la lb lc bi translated"><strong class="ak">基础知识</strong></h2><figure class="le lf lg lh fd li er es paragraph-image"><div class="er es ld"><img src="../Images/dfea527f2ac4b2680736a0b8b4f6cb9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*-NvIPaE-Z2YO3epu3cPaDA.png"/></div></figure><p id="f033" class="pw-post-body-paragraph ji jj hh jk b jl kd ii jn jo ke il jq jr kf jt ju jv kg jx jy jz kh kb kc jg ha bi translated">其核心是，OAuth要求你将用户重定向到Square网站上包含你的<code class="du ll lm ln lo b">application id</code>的特殊URL。然后，商家决定是否允许您的应用程序访问，以及您的应用程序将拥有哪些权限。然后，您的应用程序获得一个授权码，它将使用这个授权码与一个经过身份验证的请求交换一个访问令牌。</p><p id="c35a" class="pw-post-body-paragraph ji jj hh jk b jl kd ii jn jo ke il jq jr kf jt ju jv kg jx jy jz kh kb kc jg ha bi translated">让我们看看这在代码中是什么样子的:</p><h2 id="8014" class="ki kj hh bd kk kl km kn ko kp kq kr ks jr kt ku kv jv kw kx ky jz kz la lb lc bi translated"><strong class="ak">步骤0:设置</strong></h2><p id="229f" class="pw-post-body-paragraph ji jj hh jk b jl lp ii jn jo lq il jq jr lr jt ju jv ls jx jy jz lt kb kc jg ha bi translated">因为这是一个例子，我们将使用<a class="ae jh" href="http://php.net/manual/en/features.commandline.webserver.php" rel="noopener ugc nofollow" target="_blank"> PHP内置的web服务器</a>来托管文件，并使用PHP内置的URL请求功能<code class="du ll lm ln lo b">file_get_contents</code>向Square的服务器发出请求。您还需要在<a class="ae jh" href="https://connect.squareup.com/apps" rel="noopener ugc nofollow" target="_blank"> Square开发门户</a>中创建一个应用程序，如果您还没有这样做的话，以获得下一步需要的<code class="du ll lm ln lo b">application_id</code>。您还需要在应用程序的OAuth部分下添加以下内容作为您的回调URL:<code class="du ll lm ln lo b">http://localhost:8080/callback.php</code>。</p><p id="8a61" class="pw-post-body-paragraph ji jj hh jk b jl kd ii jn jo ke il jq jr kf jt ju jv kg jx jy jz kh kb kc jg ha bi translated">您可以从在您的文件系统上创建一个新文件夹和一个我们将把代码放入其中的<code class="du ll lm ln lo b">index.php</code>开始，并启动开发web服务器。</p><pre class="le lf lg lh fd lu lo lv lw aw lx bi"><span id="9c24" class="ki kj hh lo b fi ly lz l ma mb">mkdir oauth-test<br/>cd oauth-test<br/>touch index.php<br/>php -S localhost:8080 </span></pre><h2 id="58e1" class="ki kj hh bd kk kl km kn ko kp kq kr ks jr kt ku kv jv kw kx ky jz kz la lb lc bi translated">第一步:请求许可</h2><p id="30e6" class="pw-post-body-paragraph ji jj hh jk b jl lp ii jn jo lq il jq jr lr jt ju jv ls jx jy jz lt kb kc jg ha bi translated">流程中的第一步涉及到一个终端，该终端希望将您的应用程序连接到他们的Square帐户，通常是通过单击一个按钮。你可以添加一个到<code class="du ll lm ln lo b">index.php</code>的链接，在末尾加上你的<code class="du ll lm ln lo b">application_id</code>。</p><pre class="le lf lg lh fd lu lo lv lw aw lx bi"><span id="dcb8" class="ki kj hh lo b fi ly lz l ma mb">&lt;a href="<a class="ae jh" href="https://connect.squareup.com/oauth2/authorize?client_id=sq0idp-gbQhcOCpmb2X4W1588Ky7A" rel="noopener ugc nofollow" target="_blank">https://connect.squareup.com/oauth2/authorize?client_id=A</a>PPLICATION ID"&gt;Authorize App&lt;/a&gt;</span></pre><p id="9e0c" class="pw-post-body-paragraph ji jj hh jk b jl kd ii jn jo ke il jq jr kf jt ju jv kg jx jy jz kh kb kc jg ha bi translated">现在，如果您转到<a class="ae jh" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> localhost:8080 </a>，您应该会看到类似这样的内容:</p><figure class="le lf lg lh fd li er es paragraph-image"><div class="er es mc"><img src="../Images/ad3314a2ce03a066cc2dfbcfa831516b.png" data-original-src="https://miro.medium.com/v2/resize:fit:592/format:webp/1*xevg7fT7_ARlprr0ejFodA.png"/></div></figure><p id="2cee" class="pw-post-body-paragraph ji jj hh jk b jl kd ii jn jo ke il jq jr kf jt ju jv kg jx jy jz kh kb kc jg ha bi translated">如果您点击该链接，系统会提示您接受该应用程序(如果您已经接受了该应用程序，或者您自己创建了该应用程序，那么您将看不到该屏幕，直到您在Square dashboard中删除了该应用程序的权限)，然后您会被重定向到您在开发人员门户中为该应用程序设置的回调URL(<code class="du ll lm ln lo b">localhost:8080/callback.php</code>)。现在让我们填写那个<code class="du ll lm ln lo b">callback.php</code>:</p><pre class="le lf lg lh fd lu lo lv lw aw lx bi"><span id="fba3" class="ki kj hh lo b fi ly lz l ma mb">touch callback.php<br/>open callback.php</span></pre><h2 id="5a6b" class="ki kj hh bd kk kl km kn ko kp kq kr ks jr kt ku kv jv kw kx ky jz kz la lb lc bi translated">步骤2:将您的授权码换成访问令牌</h2><p id="da64" class="pw-post-body-paragraph ji jj hh jk b jl lp ii jn jo lq il jq jr lr jt ju jv ls jx jy jz lt kb kc jg ha bi translated">如果商家接受了您的应用程序的许可，那么您将获得一个授权码，作为get参数发送到您的回调URL。在您的生产代码中，您应该检查最终用户是否拒绝了您的应用程序(在这种情况下，您将得到一个没有授权代码的不同响应)，如<a class="ae jh" href="https://docs.connect.squareup.com/api/oauth#oauthflowrequestpermission" rel="noopener ugc nofollow" target="_blank"> OAuth文档</a>中所述，但是您可以在本演示中跳过这一步。</p><p id="9c06" class="pw-post-body-paragraph ji jj hh jk b jl kd ii jn jo ke il jq jr kf jt ju jv kg jx jy jz kh kb kc jg ha bi translated">首先，<code class="du ll lm ln lo b">callback.php</code>需要您在应用程序门户中设置的一些值，然后它会将这些值捆绑到一个json主体中用于POST请求，并将它们发送到Square的令牌端点，在屏幕上打印结果。</p><pre class="le lf lg lh fd lu lo lv lw aw lx bi"><span id="37d5" class="ki kj hh lo b fi ly lz l ma mb">$client_id = '';<br/>$client_secret = '';<br/>$redirect_uri= "http://localhost:8080/callback.php";<br/>$authorization_code = $_GET['code'];<br/>$url = '<a class="ae jh" href="https://connect.squareup.com/oauth2/token'" rel="noopener ugc nofollow" target="_blank">https://connect.squareup.com/oauth2/token'</a>;</span><span id="4be1" class="ki kj hh lo b fi md lz l ma mb">$data = array(<br/>    'client_id' =&gt; $client_id,<br/>    'client_secret' =&gt; $client_secret,<br/>    'redirect_uri' =&gt; $redirect_uri,<br/>     'code' =&gt; $authorization_code<br/> );</span><span id="9d60" class="ki kj hh lo b fi md lz l ma mb">$options = array(<br/>    'http' =&gt; array(<br/>        'header'  =&gt; "Content-type: application/json\r\n",<br/>        'method'  =&gt; 'POST',<br/>        'content' =&gt; json_encode($data)<br/>    )<br/>);<br/>$context  = stream_context_create($options);<br/>$result = file_get_contents($url, false, $context);</span><span id="4b00" class="ki kj hh lo b fi md lz l ma mb">var_dump($result);</span></pre><p id="d0f5" class="pw-post-body-paragraph ji jj hh jk b jl kd ii jn jo ke il jq jr kf jt ju jv kg jx jy jz kh kb kc jg ha bi translated">如果一切顺利，那么您应该从API获得json主体，并将您的访问令牌打印到屏幕上。</p><figure class="le lf lg lh fd li er es paragraph-image"><div class="er es me"><img src="../Images/b4ce9ee370d6128b322664053af969fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/1*KwvcPchpAAAcFX34iOidHg.gif"/></div><figcaption class="mf mg et er es mh mi bd b be z dx">mapsNote that the OAuth screen was skipped since this was an app I had previously authorized.</figcaption></figure><p id="27c8" class="pw-post-body-paragraph ji jj hh jk b jl kd ii jn jo ke il jq jr kf jt ju jv kg jx jy jz kh kb kc jg ha bi translated">最后，完整的示例如下所示:</p><p id="a477" class="pw-post-body-paragraph ji jj hh jk b jl kd ii jn jo ke il jq jr kf jt ju jv kg jx jy jz kh kb kc jg ha bi translated"><code class="du ll lm ln lo b">index.php</code></p><figure class="le lf lg lh fd li"><div class="bz dy l di"><div class="mj mk l"/></div></figure><p id="0428" class="pw-post-body-paragraph ji jj hh jk b jl kd ii jn jo ke il jq jr kf jt ju jv kg jx jy jz kh kb kc jg ha bi translated"><code class="du ll lm ln lo b">callback.php</code></p><figure class="le lf lg lh fd li"><div class="bz dy l di"><div class="mj mk l"/></div></figure><p id="08fc" class="pw-post-body-paragraph ji jj hh jk b jl kd ii jn jo ke il jq jr kf jt ju jv kg jx jy jz kh kb kc jg ha bi translated">请记住，您需要为您的<code class="du ll lm ln lo b">client_id</code>、<code class="du ll lm ln lo b">client_secret</code>填写选项，当然还需要在应用程序的开发者门户中设置<code class="du ll lm ln lo b">redirect_url</code> ( <code class="du ll lm ln lo b">localhost:8080/callback.php</code>)。</p><p id="b6b3" class="pw-post-body-paragraph ji jj hh jk b jl kd ii jn jo ke il jq jr kf jt ju jv kg jx jy jz kh kb kc jg ha bi translated">我希望这对那些正在与OAuth作斗争的人有所帮助！在第二部分中，我们将了解如何刷新和撤销访问令牌。如果你有任何问题或评论，请告诉我，当你在这里的时候:<a class="ae jh" href="https://www.workwithsquare.com/developer-newsletter.html?channel=Online%20Social&amp;sqmethod=Blog" rel="noopener ugc nofollow" target="_blank">注册</a>我们的每月开发者通讯，来Square dev <a class="ae jh" href="https://squ.re/slack" rel="noopener ugc nofollow" target="_blank"> Slack频道</a>打招呼，当然，在Twitter上关注我们，在<a class="ae jh" href="https://twitter.com/squaredev" rel="noopener ugc nofollow" target="_blank"> @SquareDev </a>。</p></div></div>    
</body>
</html>