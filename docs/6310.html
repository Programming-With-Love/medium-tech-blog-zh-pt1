<html>
<head>
<title>Fighting Spam using Clustering and Automated Rule Creation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用聚类和自动规则创建来对抗垃圾邮件</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/fighting-spam-using-clustering-and-automated-rule-creation-1c01d8c11a05?source=collection_archive---------3-----------------------#2021-08-03">https://medium.com/pinterest-engineering/fighting-spam-using-clustering-and-automated-rule-creation-1c01d8c11a05?source=collection_archive---------3-----------------------#2021-08-03</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="954a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Cathy Yang |软件工程师，信任与安全</p><p id="75c0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们在Pinterest最优先考虑的事情之一是保证Pinners的安全，这包括保护他们免受垃圾邮件的侵害。信任与安全小组的目标不仅仅是捕捉垃圾邮件，而是尽可能快地将其删除，以最小化Pinner的影响。</p><p id="3e6a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">垃圾邮件发送者的目标是赚钱，而实现这一目标的最佳方式是大规模发送垃圾邮件。这是一个数字游戏:一百万封垃圾邮件比一封垃圾邮件有效得多。为了快速删除垃圾邮件，我们查看垃圾邮件攻击的常见趋势，以识别可疑行为。</p><p id="2764" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了达到有效的规模，垃圾邮件发送者必须自动化他们的行动，并且这些“攻击”中的每一个都可以被认为是一个集群。攻击群集中的每个事件可能具有一些共同特征，但是不同的群将具有不同的共同特征集。</p><p id="4287" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">例如，在创建大量pin的攻击中，垃圾邮件发送者可能会将所有pin指向同一个域。虽然攻击之间的域可能会发生变化，但垃圾邮件制造者仍然试图将流量定向到同一个垃圾邮件站点。</p><p id="4cf2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的垃圾邮件缓解策略之一是我们的规则引擎<a class="ae jc" rel="noopener" href="/pinterest-engineering/fighting-spam-with-guardian-a-real-time-analytics-and-rules-engine-938e7e61fa27"> Guardian </a>，它有助于识别垃圾邮件攻击中的常见特征。</p><h1 id="aed3" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">动机</h1><p id="4155" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">以前，当垃圾邮件攻击发生时:</p><ul class=""><li id="ba62" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">我们的系统统计板上会发出警报，随叫随到的分析师会进行调查</li><li id="898b" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">分析师将确定该攻击的共同趋势</li><li id="0692" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">分析师将创建一个“补丁规则”(一个特定的临时规则来处理攻击)，然后追溯应用它来捕捉旧的和未来的垃圾邮件发送者</li></ul><p id="0f46" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个过程存在很多问题，原因有很多:对于分析师来说，这是一个非常手动的过程，在垃圾邮件攻击和我们的响应之间存在延迟，这对Pinners来说是一个潜在的负面影响。</p><p id="0d43" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是，如果我们可以自动检测垃圾邮件发送者的批量操作，找到每个集群中的共享共同特征，创建这些修补程序规则，并捕获这些类型的垃圾邮件攻击，会怎么样呢？</p><h1 id="d05d" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">补丁规则</h1><p id="7b86" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">修补程序规则旨在是短期的，并且高度针对攻击。以下是旨在停用垃圾邮件用户的修补程序规则示例:</p><ol class=""><li id="5660" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb ku km kn ko bi translated">是新帐户</li><li id="06ef" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb ku km kn ko bi translated">正在用Android设备创建pin</li><li id="a78c" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb ku km kn ko bi translated">以文本“查看我们的网站”开始Pin描述</li></ol><p id="0b65" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该规则在捕捉垃圾邮件攻击方面非常有效，并且不太可能影响任何好用户。在SQL的定制变体GSQL中，规则如下:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es kv"><img src="../Images/d937289734cf6f917281e16d10c24eee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*ewvhDyTdqdxg8egwgO93wQ.png"/></div></figure><p id="45d6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Guardian使得创建类似SQL的规则变得非常容易。仅仅通过使用<em class="ld"> where </em>子句，我们就可以在这些条件下停用用户。为了自动创建这样的规则，我们只需要关注用户停用的<em class="ld"> where </em>子句或条件。</p><p id="d5a5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如上所述，大多数简单攻击都有一些共同的特征，即使它们使用不同的帐户。因此，我们的目标是从一组用户中提取共同的特征。</p><h1 id="6a63" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">异常检测和聚类</h1><p id="f9b8" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">检测垃圾邮件攻击中突发活动的策略之一是时序异常检测。异常检测有利于检测尖峰活动(如图1所示)，这些活动极有可能是垃圾邮件活动。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es le"><img src="../Images/97ae0a570f15c7e3ea77864312fee3f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/0*fZfyDG-67jvFzMT0"/></div><figcaption class="lf lg et er es lh li bd b be z dx">Figure 1: Spiky activities</figcaption></figure><p id="c4fc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Pinterest，我们有一个内部实时异常检测系统。我们将为模型提供一个时间序列的事件，模型可以从中学习。如果模型的期望值与实际值相差某个阈值，就有异常。</p><p id="2bdc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，如果我们对具有所有特征的所有事件的时间序列进行异常检测，正常的用户活动将会有太多的噪声，并且突发可能被异常检测算法忽略。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es lj"><img src="../Images/b5d60a08174a65366e4c8c73e221fe5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LylVZm8abNGiww95"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">Figure 2: A lot of noise on all user activities</figcaption></figure><p id="dafa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">相反，我们对具有特定特征的特定事件类型发出警报。例如，为了对Pin创建事件发出警报，我们可能会对IP地址、Pin详细信息、地理位置或其他一些特征进行异常检测。这里的目标是缩小我们想要聚集的事件的范围，而不会从正常的用户活动中引入太多的干扰。</p><p id="f853" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以按城市划分的Pin创建时间序列为例:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es lo"><img src="../Images/02f7baef8cbfb54911eedc866ce4a838.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*v3eGmwbRegsvkIE4"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">Figure 3: Abnomal Pin creation events from a small town that usually doesn’t have any Pin creation activities vs. normal Pin creation events from San Francisco</figcaption></figure><p id="b68a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">黄线:每小时的模型预期计数</p><p id="3206" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">蓝线:每小时实际Pin创建事件数</p><p id="d63d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">左侧的图表显示，在突然达到峰值之前，Pin创建事件的数量在相当长的时间内几乎为0。由于与移动平均值相比，计数激增如此之多，我们的异常检测算法告诉我们，该镇在此期间的Pin创建事件非常可疑。这就把我们的关注点缩小到了那段时间的事件上。然后，我们收集了相关数据，并将其存储在S3，以进行进一步的聚类。</p><h2 id="b270" class="lp je hh bd jf lq lr ls jj lt lu lv jn ip lw lx jr it ly lz jv ix ma mb jz mc bi translated">使聚集</h2><p id="7fe4" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">分析我们存储在S3的数据的目标是找到共享某个模式的用户，因为他们很可能来自一个垃圾邮件活动。这个想法是:</p><ul class=""><li id="eca1" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">按一个感兴趣的特性分组:如果按域分组，我们会有group<em class="ld">google.com</em>，group<em class="ld">instagram.com</em>，group <em class="ld"> something.gr </em>等。</li><li id="a33b" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">对于每个组，我们查看所有其他兴趣特征的值分布</li><li id="529b" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">如果存在具有主导值的特征(例如组中95%的IP是1.1.1.1)，我们知道存在集群</li></ul><p id="6acf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们看到许多垃圾邮件发送者试图通过创建多个链接到他们自己的域的pin来将Pinners引导到他们的网站。在以下示例中，让我们考虑将Pin的域作为我们感兴趣的特征:</p><ol class=""><li id="d97a" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb ku km kn ko bi translated">异常检测告诉我们，从今天13:00开始，A城出现了异常</li><li id="9c3a" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb ku km kn ko bi translated">我们查询得到那个时间段的所有数据，然后按域分组(ab 123 . blogspot . com；bc456.blogspot.com；something.grgoogle.com；Instagram.com；其他域)</li><li id="b48a" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb ku km kn ko bi translated">对于每个域，我们计算其他几个特征的数据分布，如IP、帐龄和Pin细节。然后我们将知道每个值在该特性下出现的频率。</li></ol><p id="8c4a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于域名<em class="ld">ab123.blogspot.com</em>:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es md"><img src="../Images/569c8217d3a0bc392816859548038156.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/format:webp/1*DPi3Wo1clHNVi30Ox9cOkQ.png"/></div></figure><p id="bb69" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将上面的结果与已知的可信域进行比较，比如Google.com的<em class="ld"/>:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es me"><img src="../Images/c1b71a8f3dc9b77a95ebd5f0638853e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*X9x1WqCIVykpfZUQeP4WnQ.png"/></div></figure><p id="fdcf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">4.【Google.com】是一个值得信赖的域名；所有感兴趣的特征都具有良好的随机分布。然而，域名<em class="ld">ab123.blogspot.com</em>有三个主要特征:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es mf"><img src="../Images/ff6f2c965a74006477e365988928350a.png" data-original-src="https://miro.medium.com/v2/resize:fit:776/format:webp/1*FZyRNbE2qMe2P4gObV9NYg.png"/></div></figure><p id="700d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">5.现在，我们可以使用我们的查询语言GSQL创建一个包含所有条件的规则，在Guardian中编写规则:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es mg"><img src="../Images/0ba79e7f1059ed264eb6e068a4904905.png" data-original-src="https://miro.medium.com/v2/resize:fit:874/format:webp/1*EgcZPk53rGEyKE0nFwzYyQ.png"/></div></figure><p id="62d6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">6.一些其他标准也可能有助于减少误报，例如仅当超过10个用户满足标准时才创建规则，或者仅当他们创建了超过100个pin时才创建规则。我们也可以使group by条件成为一个正则表达式模式，<em class="ld"> </em>如<em class="ld">'^[a-za-z]+[0–9]+[.]blogspot[。]com$' </em>，而不是一个确切的域。</p><h1 id="5f82" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">评估结果</h1><h2 id="f64d" class="lp je hh bd jf lq lr ls jj lt lu lv jn ip lw lx jr it ly lz jv ix ma mb jz mc bi translated">代理审查</h2><p id="ce41" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">对于普通用户来说，在一定的时间跨度内很少出现类似的模式，但是如果集群规模不是很大，用户仍然有可能是好的。为了减少任何误报的影响，我们将我们聚集的<em class="ld">抽样用户</em>发送到我们的内部内容审查工具<a class="ae jc" rel="noopener" href="/pinterest-engineering/introducing-pinqueue3-0-pinterests-next-gen-content-moderation-platform-fcfa972bf39c"> PinQueue </a>，以便代理可以在我们打开规则之前评估规则的准确性，并允许它自动对用户采取行动。</p><h2 id="dda7" class="lp je hh bd jf lq lr ls jj lt lu lv jn ip lw lx jr it ly lz jv ix ma mb jz mc bi translated"><strong class="ak">在Guardian中创建规则</strong></h2><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es mh"><img src="../Images/314e5947c089dcafb4e1209d0bab7242.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5bnG0U9OvT2oj7XJ"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">Figure 4: Auto-created rule</figcaption></figure><p id="e676" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦我们确信规则的准确性符合我们的标准，我们就将它添加到Guardian中。</p><h2 id="cc45" class="lp je hh bd jf lq lr ls jj lt lu lv jn ip lw lx jr it ly lz jv ix ma mb jz mc bi translated"><strong class="ak">一定时间后存档</strong></h2><p id="86aa" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">由于这些规则旨在临时缓解特定的垃圾邮件攻击，所以我们在一定时间后存档补丁规则，通常是在我们看到攻击已经平息之后。这不仅是一个很好的内务管理问题，而且还限制了任何假阳性的暴露。将来，可能会有一个符合所有这些条件的好用户，如果我们不存档，他会被补丁规则意外停用。</p><h2 id="6b13" class="lp je hh bd jf lq lr ls jj lt lu lv jn ip lw lx jr it ly lz jv ix ma mb jz mc bi translated">垃圾邮件制造者会变异，但我们可以自动创建新的补丁规则！</h2><p id="5f5c" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">当垃圾邮件发送者发现使用这个IP不再有效时，他们肯定会通过购买其他IP或其他域来再次尝试。但是只要有一些模式，我们就可以自动创建新的补丁规则。</p><h1 id="3f46" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">摘要</h1><p id="bd43" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">通过异常检测、聚类和自动规则创建，我们现在可以快速做出反应，检测大多数简单的垃圾邮件攻击，然后对它们采取措施。下面，图4显示了该过程的概况:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es lo"><img src="../Images/ae94a8310ded5afb85a63e58c74ea96d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Tn-B3giXNBQ5Z7QF"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">Figure 5: Automated rule creation with anomaly detection diagram</figcaption></figure><h1 id="f716" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">承认</h1><p id="d601" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">这篇博文是在哈里·沙曼斯基和凯特·弗莱明的大力帮助下完成的。感谢谷开发了异常检测系统。此外，还要感谢Preston Guillory、、、刘、Alok Singhal、Dennis Horte、Carmen Dekmezian、Weiqi An、以及我们的Trust &amp; Safety团队的其他成员提供的帮助和建议！</p><p id="2708" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ld">要在Pinterest了解更多工程知识，请查看我们的</em> <a class="ae jc" href="https://medium.com/pinterest-engineering" rel="noopener"> <em class="ld">工程博客</em> </a> <em class="ld">，并访问我们的</em><a class="ae jc" href="https://labs.pinterest.com/?utm_source=medium&amp;utm_medium=blog-article&amp;utm_campaign=yang-august-3-2021" rel="noopener ugc nofollow" target="_blank"><em class="ld">Pinterest Labs</em></a><em class="ld">网站。要查看和申请空缺职位，请访问我们的</em> <a class="ae jc" href="https://www.pinterestcareers.com/?utm_source=medium&amp;utm_medium=blog-article&amp;utm_campaign=yang-august-3-2021" rel="noopener ugc nofollow" target="_blank"> <em class="ld">职业</em> </a> <em class="ld">页面。</em></p></div></div>    
</body>
</html>