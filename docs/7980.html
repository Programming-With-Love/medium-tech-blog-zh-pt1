<html>
<head>
<title>Nimar Loader</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Nimar装载机</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/nimar-loader-4f61c090c49e?source=collection_archive---------3-----------------------#2021-03-01">https://medium.com/walmartglobaltech/nimar-loader-4f61c090c49e?source=collection_archive---------3-----------------------#2021-03-01</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/1d638176829cd404f839d24fcdc56989.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Eei113D20bG5G1wgO5k2BQ.png"/></div></div></figure><div class=""/><pre class="ip iq ir is fd it iu iv iw aw ix bi"><span id="5237" class="iy iz hs iu b fi ja jb l jc jd">By Joshua Platt &amp; Jason Reaves</span></pre></div><div class="ab cl je jf go jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="ha hb hc hd he"><figure class="ip iq ir is fd hj er es paragraph-image"><div class="er es jl"><img src="../Images/b3cf8162b4cf91cbd0203100698f3c61.png" data-original-src="https://miro.medium.com/v2/resize:fit:76/format:webp/1*JriuMoKJ-1dBE4TU8LaRsw.png"/></div></figure></div><div class="ab cl je jf go jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="ha hb hc hd he"><p id="ef67" class="pw-post-body-paragraph jm jn hs jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi kk translated">在过去的一年里，多家安全供应商认为，BazarLoader &amp; BazarBackdoor是Trickbot背后有组织的网络犯罪集团所为。最初出现在2020年4月左右，该恶意软件利用以前用于分发Trickbot的基础设施在电子邮件活动中传播。[<a class="ae kt" href="https://twitter.com/pancak3lullz/status/1252303608747565057" rel="noopener ugc nofollow" target="_blank">1</a>bazar loader一词是由于依赖和使用区块链域名系统以及用于与控制器通信的相关bazar域而产生的。从那时起，Baza或Bazarloader这两个术语就被交替使用来指代这一特定的恶意软件家族。</p><p id="c8c9" class="pw-post-body-paragraph jm jn hs jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">在Baza最初出现后，出现了多个将各种代码归属于恶意软件家族的报告。[ <a class="ae kt" href="https://blog.fox-it.com/2020/06/02/in-depth-analysis-of-the-new-team9-malware-family/" rel="noopener ugc nofollow" target="_blank"> 2 </a> ] [ <a class="ae kt" href="https://www.cybereason.com/blog/a-bazar-of-tricks-following-team9s-development-cycles" rel="noopener ugc nofollow" target="_blank"> 3 </a>越来越明显的是，开发正在进行，多个项目正在建设中。这种公众追随的不利一面是普遍接受基于以前TTPS的活动。将TTP(例如将powershell stagers加载到red team实用程序中)与类似的活动结构和C2流量模式相结合，会很快导致恶意软件家族和参与者的错误归属。</p><p id="463f" class="pw-post-body-paragraph jm jn hs jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">2月3日，我们检测到了以前属于Baza的活动，但恶意软件利用了不同的请求标头。其他几个人也注意到了奇怪之处。进一步的分析指出了一些完全不同的新东西。Nimar loader与baza家族的代码库不同。</p><p id="6a95" class="pw-post-body-paragraph jm jn hs jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">NimarLoader或Nimrod最近被误认为BazarLoader，是用Nim编码的。恶意软件被混淆，但不包含在大规模活动中看到的典型硬化。由于这是新开发的东西，隐藏样本是不必要的，但奇怪的是，它没有使分析变得不那么困难。从字符串中，可以清楚地看到对该功能的暗示。</p><pre class="ip iq ir is fd it iu iv iw aw ix bi"><span id="2021" class="iy iz hs iu b fi ja jb l jc jd">verb in @["GET", "POST"]<br/><a class="ae kt" href="http://twitter.com/https" rel="noopener ugc nofollow" target="_blank">@https</a><br/><a class="ae kt" href="http://twitter.com/fKHMP" rel="noopener ugc nofollow" target="_blank">@fKHMP</a>]<br/><a class="ae kt" href="http://twitter.com/SPMVDSD" rel="noopener ugc nofollow" target="_blank">@SPMVDSD</a><br/>job_type<br/>job_args<br/>job_results<br/><a class="ae kt" href="http://twitter.com/heartbeat" rel="noopener ugc nofollow" target="_blank">@heartbeat</a> set<br/><a class="ae kt" href="http://twitter.com/HEARTBEAT" rel="noopener ugc nofollow" target="_blank">@HEARTBEAT</a> set Failed<br/><a class="ae kt" href="http://twitter.com/HEARTBEAT" rel="noopener ugc nofollow" target="_blank">@HEARTBEAT</a> set<br/><a class="ae kt" href="http://twitter.com/Shellcode" rel="noopener ugc nofollow" target="_blank">@Shellcode</a> Done<br/><a class="ae kt" href="http://twitter.com/heartbeat" rel="noopener ugc nofollow" target="_blank">@heartbeat</a><br/><a class="ae kt" href="http://twitter.com/shellcode" rel="noopener ugc nofollow" target="_blank">@shellcode</a><br/><a class="ae kt" href="http://twitter.com/handshake" rel="noopener ugc nofollow" target="_blank">@handshake</a><br/><a class="ae kt" href="http://twitter.com/No" rel="noopener ugc nofollow" target="_blank">@No</a> update data recieved<br/>agentId<br/>pathAdj<br/>pathNoun<br/>seqNum<br/>seqTotal<br/>jobIdHeader<br/>userAgent<br/>serverPubKeyEncoded<br/>jitterParamStr<br/>sessionKey<br/>sessionDie</span></pre><p id="8792" class="pw-post-body-paragraph jm jn hs jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">命令表允许握手、心跳、外壳代码、powershell或cmd，如在执行期间看到的字符串所示。</p><figure class="ip iq ir is fd hj er es paragraph-image"><div class="er es ku"><img src="../Images/71698316fcfd9740db8b1759f75c90e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:724/format:webp/1*gqStG8tqVV1F-xfCNVP2_Q.png"/></div><figcaption class="kv kw et er es kx ky bd b be z dx">Image1: handshake</figcaption></figure><figure class="ip iq ir is fd hj er es paragraph-image"><div class="er es kz"><img src="../Images/44d94f7a583665110f3017c6a15c465a.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*63lxWiNHWPKlSqgZbF8kIQ.png"/></div><figcaption class="kv kw et er es kx ky bd b be z dx">Image2: heartbeat</figcaption></figure><figure class="ip iq ir is fd hj er es paragraph-image"><div class="er es la"><img src="../Images/252f193b1f486bd582d60dd40dd50e60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/format:webp/1*PPO4mIl-ZuzIBQMN1NUOJg.png"/></div><figcaption class="kv kw et er es kx ky bd b be z dx">Image3. powershell or cmd</figcaption></figure><figure class="ip iq ir is fd hj er es paragraph-image"><div class="er es lb"><img src="../Images/60b9ef75ead2756a50897d7f4fcae369.png" data-original-src="https://miro.medium.com/v2/resize:fit:634/format:webp/1*lrECK7ns0t3tVeBweIIRsg.png"/></div><figcaption class="kv kw et er es kx ky bd b be z dx">Image4: shellcode</figcaption></figure><figure class="ip iq ir is fd hj er es paragraph-image"><div class="er es lc"><img src="../Images/31f3b17d9e012c0f5d7d4006ad0bc14a.png" data-original-src="https://miro.medium.com/v2/resize:fit:614/format:webp/1*NNs5to_6ap5Q1QtoIaJgkg.png"/></div><figcaption class="kv kw et er es kx ky bd b be z dx">Image5: unknown command</figcaption></figure><p id="6540" class="pw-post-body-paragraph jm jn hs jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">虽然一些字符串是可见的，但是存在一个字符串编码和解码例程。</p><figure class="ip iq ir is fd hj er es paragraph-image"><div class="er es ld"><img src="../Images/078fb43511afe5d2b23e1930f297ae14.png" data-original-src="https://miro.medium.com/v2/resize:fit:498/format:webp/1*E2a-tNSQz2Xj9IcH8CgkKw.png"/></div><figcaption class="kv kw et er es kx ky bd b be z dx">Image6: Decoding routine</figcaption></figure><p id="3d1b" class="pw-post-body-paragraph jm jn hs jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">解码循环将编码字符串的每个字节与密钥的每个字节进行XOR运算，然后将密钥递增1，由于XOR运算的工作方式，这与用单个XOR字节对每个字节进行XOR编码并在滚动单字节XOR循环中通过迭代器递增密钥是相同的。</p><figure class="ip iq ir is fd hj er es paragraph-image"><div class="er es le"><img src="../Images/a38dcc90e8ae056ae315fe8f2805ee85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*PNsKM_PHuHBC1dqHgsHTYg.png"/></div><figcaption class="kv kw et er es kx ky bd b be z dx">Image7: Decoding Loop</figcaption></figure><p id="6582" class="pw-post-body-paragraph jm jn hs jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">运行该例程后，以下字符串被解密:</p><figure class="ip iq ir is fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es lf"><img src="../Images/d8302b3848e6e64f9fcf63b90d085709.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h87j9_lAseP_t8aAlHafjA.png"/></div></div></figure><p id="1c4f" class="pw-post-body-paragraph jm jn hs jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">如前所述，该示例的功能有点像加载器，能够处理外壳代码并通过cmd或powershell执行任务或作业。与大多数Baza战役相似，执行的任务以钴击舞台的形式出现。使用这种“无文件”机制的好处是不需要接触磁盘。</p><p id="3559" class="pw-post-body-paragraph jm jn hs jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">执行时，stager对<code class="du lg lh li iu b">topservicebin[.]com</code>进行调出。在活动期间，域解析为包含以下SSL证书的ip <code class="du lg lh li iu b">45.141.87 .41</code>。</p><figure class="ip iq ir is fd hj er es paragraph-image"><div class="er es lj"><img src="../Images/76300f26cd20c429e9c54223966a3c36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/format:webp/1*MOC5686xbh4qEK79McWB-A.png"/></div><figcaption class="kv kw et er es kx ky bd b be z dx">Image8: SSL Cert</figcaption></figure><p id="847d" class="pw-post-body-paragraph jm jn hs jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">以下是所有具有匹配或相似证书的Cobalt Strike服务器，共享同一个主机提供商。</p><figure class="ip iq ir is fd hj er es paragraph-image"><div class="er es lk"><img src="../Images/b4bcd0b5dd10ca2df4a40fdf86729d02.png" data-original-src="https://miro.medium.com/v2/resize:fit:644/format:webp/1*657HK4vczt49c0HwJq7Duw.png"/></div></figure><p id="3522" class="pw-post-body-paragraph jm jn hs jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">几乎相同的基础设施不仅与BazarLoader的部署密切相关，还与Mandiant去年10月部署RYUK的部署密切相关。[ <a class="ae kt" href="https://www.fireeye.com/blog/threat-research/2020/10/kegtap-and-singlemalt-with-a-ransomware-chaser.html" rel="noopener ugc nofollow" target="_blank"> 6 </a></p><p id="52dd" class="pw-post-body-paragraph jm jn hs jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">Nimar Loader似乎部分基于现有的代码，或者这个想法可能源自其他地方。TrickBot背后的行为者在过去为了他们自己的邪恶目的(MiniLZO、BloodHound、CobaltStrike、PowerSploit、Obfuscator-LLVM、adv Obfuscator……)而整合了网络安全或开源社区开发的免费实用程序和软件。虽然nim语言在攻击性场景中并不陌生，但它与Trickbot的传统工具有很大的不同。[ <a class="ae kt" href="https://github.com/byt3bl33d3r/OffensiveNim" rel="noopener ugc nofollow" target="_blank"> 7 </a></p><h1 id="cf18" class="ll iz hs bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">参考资料:</h1><ol class=""><li id="8bac" class="mi mj hs jo b jp mk jt ml jx mm kb mn kf mo kj mp mq mr ms bi translated"><a class="ae kt" href="https://twitter.com/pancak3lullz/status/1252303608747565057" rel="noopener ugc nofollow" target="_blank">https://twitter.com/pancak3lullz/status/1252303608747565057</a></li><li id="f1fe" class="mi mj hs jo b jp mt jt mu jx mv kb mw kf mx kj mp mq mr ms bi translated"><a class="ae kt" href="https://blog.fox-it.com/2020/06/02/in-depth-analysis-of-the-new-team9-malware-family/" rel="noopener ugc nofollow" target="_blank">https://blog . fox-it . com/2020/06/02/depth-analysis-of-the-new-team 9-malware-family/</a></li><li id="3ba4" class="mi mj hs jo b jp mt jt mu jx mv kb mw kf mx kj mp mq mr ms bi translated"><a class="ae kt" href="https://www.cybereason.com/blog/a-bazar-of-tricks-following-team9s-development-cycles" rel="noopener ugc nofollow" target="_blank">https://www . cyber eason . com/blog/a-bazar-of-tricks-following-team 9s-development-cycles</a></li><li id="3696" class="mi mj hs jo b jp mt jt mu jx mv kb mw kf mx kj mp mq mr ms bi translated"><a class="ae kt" href="https://twitter.com/James_inthe_box/status/1357009652857196546" rel="noopener ugc nofollow" target="_blank">https://Twitter . com/James _ in _ box/status/1357009652857196546</a></li><li id="41a4" class="mi mj hs jo b jp mt jt mu jx mv kb mw kf mx kj mp mq mr ms bi translated"><a class="ae kt" href="https://twitter.com/Casperinous/status/1357013722955399170" rel="noopener ugc nofollow" target="_blank">https://twitter.com/Casperinous/status/1357013722955399170</a></li><li id="2572" class="mi mj hs jo b jp mt jt mu jx mv kb mw kf mx kj mp mq mr ms bi translated"><a class="ae kt" href="https://www.fireeye.com/blog/threat-research/2020/10/kegtap-and-singlemalt-with-a-ransomware-chaser.html" rel="noopener ugc nofollow" target="_blank">https://www . fire eye . com/blog/threat-research/2020/10/keg tap-and-single malt-with-a-ransomware-chaser . html</a></li><li id="66f5" class="mi mj hs jo b jp mt jt mu jx mv kb mw kf mx kj mp mq mr ms bi translated">【https://github.com/byt3bl33d3r/OffensiveNim T4】</li></ol></div></div>    
</body>
</html>