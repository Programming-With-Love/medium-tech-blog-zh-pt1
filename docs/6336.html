<html>
<head>
<title>Debugging Deadlock in PininfoService Ubuntu18 Upgrade: Part 1 of 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">调试PininfoService Ubuntu18升级中的死锁:第1部分，共2部分</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/debugging-deadlock-in-pininfoservice-ubuntu18-upgrade-part-1-of-2-116bce917ea2?source=collection_archive---------4-----------------------#2022-01-21">https://medium.com/pinterest-engineering/debugging-deadlock-in-pininfoservice-ubuntu18-upgrade-part-1-of-2-116bce917ea2?source=collection_archive---------4-----------------------#2022-01-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="7d36" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作者:李康南|关键价值系统软件工程师</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/335edc7e835a1dc623b766db12088b31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1pbcqmnwHcus9s1v"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Unblock deadlock for PininfoService</figcaption></figure><p id="fbc1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是由两部分组成的博客系列的第一部分。第二部分<a class="ae js" rel="noopener" href="/pinterest-engineering/debugging-deadlock-in-pininfoservice-ubuntu18-upgrade-part-2-of-2-f49b654bff37">此处</a>。</p><p id="3fbb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">阅读本系列的两个部分将让您深入了解我们在Pinterest Engineering Key Value Systems团队(从之前的服务系统衍生而来的团队)中使用的一些调试技术。在<a class="ae js" rel="noopener" href="/pinterest-engineering/open-sourcing-terrapin-a-serving-system-for-batch-generated-data-7aa2f38c4472"> Terrapin </a>、Rocksplicator ( <a class="ae js" rel="noopener" href="/pinterest-engineering/open-sourcing-rocksplicator-a-real-time-rocksdb-data-replicator-558cd3847a9d"> 1 </a>和<a class="ae js" rel="noopener" href="/pinterest-engineering/automated-cluster-management-and-recovery-for-rocksplicator-f1f8fd35c833"> 2 </a>)、<a class="ae js" rel="noopener" href="/pinterest-engineering/building-a-dynamic-and-responsive-pinterest-7d410e99f0a9"> Aperture </a>和<a class="ae js" href="https://www.youtube.com/watch?v=MtFEVEs_2Vo&amp;ab_channel=MetaDevelopers" rel="noopener ugc nofollow" target="_blank"> Realpin </a>的博客和演示中可以看到该团队拥有的相关项目。</p><p id="fe96" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这个系列中，我们将内容划分如下:</p><p id="b737" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第一部分</p><ul class=""><li id="c50a" class="jt ju hh ig b ih ii il im ip jv it jw ix jx jb jy jz ka kb bi translated">如何设置<strong class="ig hi">测试/金丝雀环境</strong></li><li id="6a50" class="jt ju hh ig b ih kc il kd ip ke it kf ix kg jb jy jz ka kb bi translated">如何用<strong class="ig hi">控制变量</strong>设计测试</li><li id="7fa4" class="jt ju hh ig b ih kc il kd ip ke it kf ix kg jb jy jz ka kb bi translated">如何设计针对<strong class="ig hi">根/叶的测试(即路由/持久层)分离</strong></li></ul><p id="3f91" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第二部分</p><ul class=""><li id="e8e9" class="jt ju hh ig b ih ii il im ip jv it jw ix jx jb jy jz ka kb bi translated">如何生成<strong class="ig hi">堆转储</strong></li><li id="1069" class="jt ju hh ig b ih kc il kd ip ke it kf ix kg jb jy jz ka kb bi translated">如何使用<strong class="ig hi"> GDB </strong>调试正在运行的进程</li></ul><p id="27b4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest是一个月活跃用户超过4亿的平台，这意味着工程师有机会大规模解决大数据问题。PininfoService (PIS)是Pinterest众多后端服务之一。</p><p id="42e0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">PininfoService是一个<em class="kh">无根</em>只读<em class="kh"> </em>缓存服务，为每个集群每秒1000万个批处理请求提供服务，以支持Pinterest Homefeed、相关pin和其他服务。它从各种源数据服务(即上游)获取客户定义的信号，并以定制的生存时间(TTL)保存数据。</p><p id="7f11" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注:</strong>在本文中，我们用<strong class="ig hi"> <em class="kh">根、叶、无根</em> </strong>来对系统架构进行分类。<strong class="ig hi">根，</strong>也叫<em class="kh">路由层，</em>负责路由请求和聚合响应。<strong class="ig hi">叶子</strong> <em class="kh">(即持久层)</em>负责序列化/反序列化thrift struct数据，并写入、获取本地缓存存储。<strong class="ig hi">无根</strong>——在<strong class="ig hi">无根</strong>架构中，每个节点同时充当根和叶的角色。每个节点充当根角色，接收作为根请求的客户端请求，并基于数据分布图(即碎片图)；同时，每个节点还接收和处理作为叶请求从根节点路由的请求，以与高速缓存交互并检索源数据。</p><h1 id="7c1c" class="ki kj hh bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">背景</h1><p id="f627" class="pw-post-body-paragraph ie if hh ig b ih lg ij ik il lh in io ip li ir is it lj iv iw ix lk iz ja jb ha bi translated">随着Ubuntu14在2019年达到其生命周期的终点，我们的任务是为PIS将操作系统从Ubuntu14 (U14)升级到UbuntU18 (U18)。让这变得困难的是，我们的许多系统都是有状态的，这意味着简单的集群轮换不是一个可行的选择。因此，我们认为就地升级对我们的可用性影响最小。</p><p id="7aab" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了确保无缝升级，我们将升级过程分为三个步骤:</p><ol class=""><li id="35fa" class="jt ju hh ig b ih ii il im ip jv it jw ix jx jb ll jz ka kb bi translated">更改服务代码，使其与U18兼容；</li><li id="7d97" class="jt ju hh ig b ih kc il kd ip ke it kf ix kg jb ll jz ka kb bi translated">使用暗流量部署U18服务构建，以确保可比较的结果；和</li><li id="d39e" class="jt ju hh ig b ih kc il kd ip ke it kf ix kg jb ll jz ka kb bi translated">将U14实例就地升级到U18。</li></ol><p id="267b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们已经成功地采用了这个三步流程来就地升级超过10，000个有状态服务实例。</p><p id="bdc3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于我们还没有支持完整克隆(例如<a class="ae js" href="https://blog.markvincze.com/shadow-mirroring-with-envoy/" rel="noopener ugc nofollow" target="_blank">特使影子镜像</a>)的架构来测试生产集群的数据和流量，我们设计了两个子步骤(测试+金丝雀环境)来验证U18版本:</p><p id="10cd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">测试环境:</strong>一个具有期望的构建和运行时配置的测试集群。生产环境中的一些主机被放入一个单独的池中，以“一劳永逸”的方式将可控百分比的流量转发到测试集群。</p><p id="aeee" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">金丝雀环境:一些主机被放入“金丝雀”环境中。这个canary环境继续为相同数量的生产流量提供服务，同时使我们能够部署不同的构建和运行时配置。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lm"><img src="../Images/b37e5692994323e87888f13c41943c6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gkzPD5hp4zpaWlUW"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx"><strong class="bd kk"><em class="ln">Scheme 1.</em></strong> Test/Canary environment setup.</figcaption></figure><h1 id="00cf" class="ki kj hh bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">观察和假设</h1><h2 id="a3b3" class="lo kj hh bd kk lp lq lr ko ls lt lu ks ip lv lw kw it lx ly la ix lz ma le mb bi translated">从生产集群到测试集群的暗流量。</h2><p id="2a1e" class="pw-post-body-paragraph ie if hh ig b ih lg ij ik il lh in io ip li ir is it lj iv iw ix lk iz ja jb ha bi translated">在使用测试设置(<strong class="ig hi"> <em class="kh">方案1) </em> </strong>进行测试期间，我们从测试集群中观察到以下两个问题:</p><ol class=""><li id="f896" class="jt ju hh ig b ih ii il im ip jv it jw ix jx jb ll jz ka kb bi translated">QPS下降到0</li><li id="3cd1" class="jt ju hh ig b ih kc il kd ip ke it kf ix kg jb ll jz ka kb bi translated">内存使用不一致。根据配置，PIS U14生产主机通常使用160–200 GB内存。在测试集群上，一些主机停滞在&lt;50GB while some increased to ~500GB causing OOM.</li></ol><p id="2193" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">First we needed to determine: <strong class="ig hi">这是两个独立的问题，还是由一个底层问题引起的？</strong> <em class="kh"> </em>收集测试主机的<em class="kh"> QPS跌落</em>和<em class="kh">内存使用</em>的时间线和统计数据，还不能确定这两个问题是否由一个底层问题引起。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mc"><img src="../Images/f9f33e642a8269a024d206201b874c0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Sj5qTnPmL4EOwqtalRexUg.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx"><strong class="bd kk"><em class="ln">Graph 1.</em></strong> Stats of two U18 hosts with test environment setup in <em class="ln">Scheme1</em>.</figcaption></figure><h2 id="ddfb" class="lo kj hh bd kk lp lq lr ko ls lt lu ks ip lv lw kw it lx ly la ix lz ma le mb bi translated">假设</h2><p id="c43e" class="pw-post-body-paragraph ie if hh ig b ih lg ij ik il lh in io ip li ir is it lj iv iw ix lk iz ja jb ha bi translated">考虑到上述问题，我们调查了以下问题以帮助探究这些问题:</p><ul class=""><li id="f51c" class="jt ju hh ig b ih ii il im ip jv it jw ix jx jb jy jz ka kb bi translated"><strong class="ig hi">U18语法变化是否存在代码bug？</strong> <em class="kh">这是通过反复检查代码变化排除的，一个U18升级代码变化的例子，参考</em><a class="ae js" href="https://github.com/pinterest/rocksplicator/pull/336" rel="noopener ugc nofollow" target="_blank"><em class="kh">rocksplicator/pull request 336</em></a><em class="kh">。</em></li><li id="ad42" class="jt ju hh ig b ih kc il kd ip ke it kf ix kg jb jy jz ka kb bi translated"><strong class="ig hi">运行时配置需要重新调优吗？</strong> <em class="kh">缓存服务需要根据所提供的硬件进行调整，以最大限度地适应生产流量，这种情况并不少见。</em></li><li id="188c" class="jt ju hh ig b ih kc il kd ip ke it kf ix kg jb jy jz ka kb bi translated"><strong class="ig hi">根还是叶，是哪一层的问题？</strong></li><li id="0836" class="jt ju hh ig b ih kc il kd ip ke it kf ix kg jb jy jz ka kb bi translated"><strong class="ig hi">内存泄露？</strong> <em class="kh">考虑到内存使用有时会增加到500GB，导致U18主机上出现OOM，可能会引入一些内存泄漏，或者U14中的一些现有内存错误直到U18才会触发。(参见本系列</em><strong class="ig hi"><em class="kh">part 2</em></strong><em class="kh">)</em></li></ul><h1 id="c3cc" class="ki kj hh bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">实验和分析</h1><p id="2cd3" class="pw-post-body-paragraph ie if hh ig b ih lg ij ik il lh in io ip li ir is it lj iv iw ix lk iz ja jb ha bi translated">我们的下一步是设计实验来测试和验证上述假设。在排除了一个代码错误之后，我们通过重新调整运行时参数和分离根/叶层来获得提示，集中精力缩小有问题的部分。</p><p id="d9ac" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在进行实验时，我们尝试用<a class="ae js" href="https://en.wikipedia.org/wiki/Control_variable" rel="noopener ugc nofollow" target="_blank"> <em class="kh">控制变量</em> </a> <strong class="ig hi">。</strong>如果假设是因素A导致了问题，我们设计测试来保持非因素A不变，只改变因素A。然后，该测试可以表明因素A是正相关/负相关还是根本不相关。</p><h2 id="d643" class="lo kj hh bd kk lp lq lr ko ls lt lu ks ip lv lw kw it lx ly la ix lz ma le mb bi translated">重新调整运行时配置</h2><p id="0d00" class="pw-post-body-paragraph ie if hh ig b ih lg ij ik il lh in io ip li ir is it lj iv iw ix lk iz ja jb ha bi translated">基于我们对服务的理解，我们用<strong class="ig hi"> <em class="kh">方案1 </em> </strong>中的测试环境设置在八个测试中调优了六个运行时参数:通过调整运行时配置，每个测试运行都在三台主机上执行。使用旧的U14配置(即<strong class="ig hi"> <em class="kh">方案2 </em> </strong>中的<em class="kh">Test0–0</em>为对照组:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es md"><img src="../Images/7b75251b790bb1f0a0b46e511bf04824.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Yes5syCYeKW3ECfV"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx"><strong class="bd kk"><em class="ln">Scheme 2.</em></strong> Tuning runtime parameters for U18 test environment.</figcaption></figure><p id="c9ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在<em class="kh">Test0–1</em>到<em class="kh">Test0–6</em>中，一次调整一个运行时配置，所有测试都获得了更好的结果，这表明(正如<strong class="ig hi">暗示1 </strong>线程池和这两个问题之间存在某种关联。最终，我们用<em class="kh">Test0–7</em>完成了调优，与<em class="kh">Test0–0</em>相比，它提供了迄今为止最好的性能，QPS下降的频率更低，内存使用量稳定在200GB。然而，问题并没有完全解决，因此我们决定继续进行其他测试，将<em class="kh">Test0–7</em>配置作为优化的运行时配置。</p><h2 id="e29c" class="lo kj hh bd kk lp lq lr ko ls lt lu ks ip lv lw kw it lx ly la ix lz ma le mb bi translated">根/叶隔离</h2><p id="539b" class="pw-post-body-paragraph ie if hh ig b ih lg ij ik il lh in io ip li ir is it lj iv iw ix lk iz ja jb ha bi translated">PIS是无根的，这意味着每个节点既是根又是叶。为了缩小问题的来源，我们对仅根节点或仅叶节点执行了测试。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es me"><img src="../Images/7a2a2149ac378145b8bc8f6612c27b99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fXL_vB8N20JTH4na"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx"><strong class="bd kk"><em class="ln">Scheme 3.</em></strong> Root / leaf isolation test.</figcaption></figure><p id="2223" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在上述<em class="kh">Test1–1</em>&amp;<em class="kh">Test1–2</em>中，实验组为“仅根”或“仅叶”主机，而对照组为相同测试环境中剩余的2台U18无根主机。测试结果显示，仅叶主机上仍然存在问题，而仅根主机不再遇到问题，因此我们缩小了范围，认为叶逻辑更有可能是导致进程崩溃和内存使用不一致的原因。<strong class="ig hi">因此，将使用设置为<em class="kh">Test1–2</em>进行以下测试(1个仅叶+ 2个无根主机)。</strong></p><p id="b710" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注:</strong>在<em class="kh">试验1–2</em>期间，这两个问题不确定地发生在实验组(即只有叶子)或对照组(即无根)上。因此，执行了几次运行以收集稳定的测试结果。</p><p id="9774" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在第1部分中，我们已经回答了在<strong class="ig hi"> <em class="kh">假设</em> </strong>部分提出的前三个问题。接下来，我们将重点讨论一些工具辅助的内存调试，这将在本系列的第2部分中进行总结。</p><h1 id="c4a0" class="ki kj hh bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">第1部分概述</h1><p id="0e0e" class="pw-post-body-paragraph ie if hh ig b ih lg ij ik il lh in io ip li ir is it lj iv iw ix lk iz ja jb ha bi translated">在本文中，我们分享了如何设置测试和canary环境来调试服务U18升级期间遇到的问题。我们采用<strong class="ig hi">控制变量</strong>来设置测试(<em class="kh">Test0–0</em>到<em class="kh">Test0–7</em>)以重新调整运行时配置，这给了我们一些提示，线程池可能与观察到的问题有关:<em class="kh"> QPS降至0 </em>和<em class="kh">内存使用不一致—增加或保持低水平</em>。然后，<em class="kh">Test1–1</em>和<em class="kh">Test1–2</em>被设计成缩小问题来自叶层而不是根层的范围。</p><p id="ffce" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在第2部分中，我们将讨论如何使用工具来探测问题，排除内存泄漏，并最终根据本文中描述的“线程池提示(<strong class="ig hi"> hint1 </strong>)”来确定问题的根本原因。</p><h1 id="43b0" class="ki kj hh bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">确认</h1><p id="c6f0" class="pw-post-body-paragraph ie if hh ig b ih lg ij ik il lh in io ip li ir is it lj iv iw ix lk iz ja jb ha bi translated">Key Value Systems的U14到U18迁移是工程师Kangnan Li、Rakesh Kalidindi、Carlos Castellanos、Madeline Nguyen和Harold Cabalic几个月来的巨大努力，总共完成了7个服务的12K多个有状态实例的升级。特别感谢刘波、Alberto Ordonez Pereira、Saurabh Joshi、Prem Kumar和Rakesh Kalidindi在调试过程中提供的丰富信息和帮助。感谢Key Value团队经理Jessica Chan、技术主管Rajath Prasad对这项工作的支持。</p><p id="387b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kh">要在Pinterest了解更多工程知识，请查看我们的</em> <a class="ae js" href="https://medium.com/pinterest-engineering" rel="noopener"> <em class="kh">工程博客</em> </a> <em class="kh">，并访问我们的</em><a class="ae js" href="https://www.pinterestlabs.com/?utm_source=medium&amp;utm_medium=blog-article-link&amp;utm_campaign=kangnan-li-january-21-2022&amp;utm_content=part-1" rel="noopener ugc nofollow" target="_blank"><em class="kh">Pinterest Labs</em></a><em class="kh">网站。要查看和申请空缺职位，请访问我们的</em> <a class="ae js" href="https://www.pinterestcareers.com/?utm_source=medium&amp;utm_medium=blog-article-link&amp;utm_campaign=kangnan-li-january-21-2022&amp;utm_content=part-1" rel="noopener ugc nofollow" target="_blank"> <em class="kh">招聘</em> </a> <em class="kh">页面</em></p></div></div>    
</body>
</html>