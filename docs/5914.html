<html>
<head>
<title>How to Read a Remote IP Address Behind Ingress and Load Balancer in OKE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在OKE中读取入口和负载平衡器后面的远程IP地址</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/how-to-read-a-remote-ip-address-behind-ingress-and-load-balancer-in-oke-ea71dedcbbec?source=collection_archive---------0-----------------------#2022-05-24">https://medium.com/oracledevs/how-to-read-a-remote-ip-address-behind-ingress-and-load-balancer-in-oke-ea71dedcbbec?source=collection_archive---------0-----------------------#2022-05-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/738260b04a8f05fb4721081c903d212a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rNwymdr9gzD7846UkboPsg.jpeg"/></div></div></figure><h1 id="49b2" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">介绍</h1><p id="a862" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated"><a class="ae kl" href="https://www.oracle.com/cloud/cloud-native/container-engine-kubernetes/" rel="noopener ugc nofollow" target="_blank">适用于Kubernetes </a>的Oracle容器引擎，也称为OKE，是功能强大的Kubernetes托管服务，是Oracle云基础设施中云原生堆栈的尖端。它与核心云组件紧密集成，如负载平衡器和网络。每一个现代的云原生部署都意味着您的容器化应用程序在Kubernetes中执行，通过入口控制器和其上的负载平衡器向外界公开。更重要的是，ingress将使用<a class="ae kl" href="https://cert-manager.io/" rel="noopener ugc nofollow" target="_blank">证书管理器</a>来管理每个域和路径的证书。OKE集成了OCI负载均衡器，你可以轻松安装多个ingress控制器，比如<a class="ae kl" href="https://kubernetes.github.io/ingress-nginx/" rel="noopener ugc nofollow" target="_blank"> Ingress Nginx控制器</a>。</p><p id="0c37" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">在高级场景中，您可能想从容器或入口控制器中知道远程客户端IP地址。这对于蓝/绿部署可能是必要的，在蓝/绿部署中，您将允许特定的源IP地址预览一些canary功能。典型的入口Nginx控制器安装与云无关，并采用默认的OCI负载平衡器设置。OCI负载平衡器是一种灵活的基于代理的负载平衡器，运行在OSI模型的第4层和第7层。默认设置意味着负载平衡器监听器不通过<code class="du kr ks kt ku b">x-real-ip</code>或<code class="du kr ks kt ku b">x-forwarded-for</code>头传播远程IP地址，因为监听器最初使用TCP。TCP层没有报头，对吗？然后，您可以使用<a class="ae kl" href="http://cloud.oracle.com" rel="noopener ugc nofollow" target="_blank"> OCI控制台</a>(或将<a class="ae kl" href="https://github.com/oracle/oci-cloud-controller-manager/blob/master/docs/load-balancer-annotations.md" rel="noopener ugc nofollow" target="_blank">自定义注释</a>添加到入口控制器清单中)并将负载平衡器监听器更改为使用HTTP或HTTPS。这将解决问题，并在标头中暴露远程IP地址，但可能会导致另一个问题——在负载平衡器级别强制SSL终止。如果你想用<code class="du kr ks kt ku b">cert-manager</code>，这不是最愉快的选择。</p><p id="54c7" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">一种解决方案是在入口控制器之前实现OCI网络负载平衡器。OCI网络负载平衡器是一种替代解决方案，它是一种运行在OSI模型第4层的非代理负载平衡器。这意味着它不会做SSL终止，但它能够转发客户端源地址，如果配置这样做。</p><h1 id="af1e" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">安装入口Nginx控制器，OCI网络负载平衡器在前面</h1><h2 id="19b3" class="kv iq hh bd ir kw kx ky iv kz la lb iz jy lc ld jd kc le lf jh kg lg lh jl li bi">1</h2><p id="87ed" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">遵循Oracle官方指南设置Nginx控制器:<a class="ae kl" href="https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengsettingupingresscontroller.htm" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/en-us/iaas/Content/ContEng/Tasks/contengsettingupingresscontroller . htm</a></p><h2 id="c492" class="kv iq hh bd ir kw kx ky iv kz la lb iz jy lc ld jd kc le lf jh kg lg lh jl li bi">2</h2><p id="e07c" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">当您到达<a class="ae kl" href="https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengsettingupingresscontroller.htm#settingupcontroller__creatingserviceaccount" rel="noopener ugc nofollow" target="_blank">部署<em class="lj">ingress-nginx-controller</em></a>的步骤时，就在应用<code class="du kr ks kt ku b">kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.3/deploy/static/provider/cloud/deploy.yaml</code>之前，停止并下载<a class="ae kl" href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.3/deploy/static/provider/cloud/deploy.yaml" rel="noopener ugc nofollow" target="_blank">部署清单</a>。通过添加注释来修改它，以供应OCI网络负载平衡器，而不是默认的那个(在下面的代码片段中标记为粗体)。</p><pre class="lk ll lm ln fd lo ku lp lq aw lr bi"><span id="9fd1" class="kv iq hh ku b fi ls lt l lu lv">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  labels:<br/>    helm.sh/chart: ingress-nginx-3.23.0<br/>    app.kubernetes.io/name: ingress-nginx<br/>    app.kubernetes.io/instance: ingress-nginx<br/>    app.kubernetes.io/version: 0.44.0<br/>    app.kubernetes.io/managed-by: Helm<br/>    app.kubernetes.io/component: controller<br/>  name: ingress-nginx-controller-nlb<br/>  namespace: ingress-nginx<br/>  annotations:<br/>    <strong class="ku hi">oci.oraclecloud.com/load-balancer-type: "nlb"</strong><br/>spec:<br/>  type: LoadBalancer<br/>  <strong class="ku hi">externalTrafficPolicy: Local</strong><br/>  ports:<br/>    - name: http<br/>      port: 80<br/>      protocol: TCP<br/>      targetPort: http<br/>    - name: https<br/>      port: 443<br/>      protocol: TCP<br/>      targetPort: https<br/>  selector:<br/>    app.kubernetes.io/name: ingress-nginx<br/>    app.kubernetes.io/instance: ingress-nginx<br/>    app.kubernetes.io/component: controller</span></pre><p id="a67d" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">自定义注释<code class="du kr ks kt ku b">oci.oraclecloud.com/load-balancer-type: “nlb”</code>和规范属性<code class="du kr ks kt ku b">externalTrafficPolicy: Local</code> <strong class="jp hi"> </strong>将启用Nginx控制器内部的远程IP地址直通，一直到容器。</p><h2 id="67ec" class="kv iq hh bd ir kw kx ky iv kz la lb iz jy lc ld jd kc le lf jh kg lg lh jl li bi">3</h2><p id="a199" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">使用<code class="du kr ks kt ku b">kubectl apply -f downloaded_manifest.yaml</code>执行下载并更新的清单，并从第一步开始完成指南。</p><h2 id="f031" class="kv iq hh bd ir kw kx ky iv kz la lb iz jy lc ld jd kc le lf jh kg lg lh jl li bi">4</h2><p id="5931" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">因为规范属性<code class="du kr ks kt ku b">externalTrafficPolicy: Local</code>将远程IP地址作为工作节点的源地址，所以要确保相应地更新工作节点子网安全列表。您很可能需要添加安全列表入口规则，以允许源0.0.0.0/0(远程客户端IP)到达工作节点端口(30000–32767)。你可以在<a class="ae kl" href="https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengcreatingloadbalancer.htm#contengcreatingnetworkloadbalancer_topic_Preserving_client_IP" rel="noopener ugc nofollow" target="_blank">官方文件</a>中找到更多信息。</p><h2 id="a6e8" class="kv iq hh bd ir kw kx ky iv kz la lb iz jy lc ld jd kc le lf jh kg lg lh jl li bi">5</h2><p id="1cf7" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">调用您的应用程序，检查您是否可以从容器中读取<code class="du kr ks kt ku b">x-real-ip</code>或<code class="du kr ks kt ku b">x-forwarded-for</code>头。在我的例子中，它非常有效，将远程客户端的IP地址写在头中。</p><pre class="lk ll lm ln fd lo ku lp lq aw lr bi"><span id="93ec" class="kv iq hh ku b fi ls lt l lu lv">{"host":"remoteip-nlb.micro.ivandelic.com","x-real-ip":"74.34.156.180","x-forwarded-for":"74.34.156.180","x-forwarded-host":"remoteip-nlb.micro.ivandelic.com","x-forwarded-port":"443","x-forwarded-proto":"https"...}</span></pre><h1 id="9ea7" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">如果你在Cloudflare Proxy后面怎么办？</h1><p id="bf55" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">由于我们使用的是在第4层运行的OCI网络负载平衡器，因此Cloudflare设置的所有报头都会转发到入口Nginx控制器。这意味着每个HTTP请求中都存在<code class="du kr ks kt ku b">CF-Connecting-IP</code>头。默认情况下，Nginx使用头<code class="du kr ks kt ku b">X-Forwarded-For</code>的内容来获取关于客户端IP地址的信息。这对我们的场景很不方便，因为<code class="du kr ks kt ku b">X-Forwarded-For</code>拥有Cloudflare代理的IP地址。这种行为的原因是OCI网络负载平衡器不识别Cloudflare代理的存在，并将代理IP地址设置为远程IP地址。显而易见的解决方法是配置Nginx使用<code class="du kr ks kt ku b">CF-Connecting-IP</code>报头来获取真正的远程IP地址，而不是<code class="du kr ks kt ku b">X-Forwarded-For</code>。</p><p id="7cfb" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">要使其工作，通过在ConfigMap中添加自定义配置来修改下载的入口Nginx清单，如下例所示。</p><pre class="lk ll lm ln fd lo ku lp lq aw lr bi"><span id="28fb" class="kv iq hh ku b fi ls lt l lu lv">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  labels:<br/>    helm.sh/chart: ingress-nginx-3.23.0<br/>    app.kubernetes.io/name: ingress-nginx<br/>    app.kubernetes.io/instance: ingress-nginx<br/>    app.kubernetes.io/version: 0.44.0<br/>    app.kubernetes.io/managed-by: Helm<br/>    app.kubernetes.io/component: controller<br/>  name: ingress-nginx-controller<br/>  namespace: ingress-nginx<br/>data:<br/>  proxy-real-ip-cidr: "173.245.48.0/20,103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,141.101.64.0/18,108.162.192.0/18,190.93.240.0/20,188.114.96.0/20,197.234.240.0/22,198.41.128.0/17,162.158.0.0/15,104.16.0.0/13,104.24.0.0/14,172.64.0.0/13,131.0.72.0/22,2400:cb00::/32,2606:4700::/32,2803:f800::/32,2405:b500::/32,2405:8100::/32,2a06:98c0::/29,2c0f:f248::/32"<br/>  use-forwarded-headers: "true"<br/>  forwarded-for-header: "CF-Connecting-IP"</span></pre><p id="a2e7" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">注意:如果您还没有这样做，您可以<a class="ae kl" href="https://signup.cloud.oracle.com/?language=en" rel="noopener ugc nofollow" target="_blank">立即注册Oracle云免费层帐户</a>。如果你对如何开始学习OCI感兴趣，注册是第一步，没有必要跟着这篇文章走。</p><p id="748d" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">如果你对Oracle开发人员在他们的自然环境中发生的事情感到好奇，请加入我们的公共休闲频道！</p></div></div>    
</body>
</html>