<html>
<head>
<title>Secure RDP to EC2 Private Instance Using AWS SSM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS SSM保护RDP到EC2私有实例</h1>
<blockquote>原文：<a href="https://medium.com/globant/secure-rdp-to-ec2-private-instance-using-aws-ssm-d0a1cadd9d6?source=collection_archive---------0-----------------------#2022-01-06">https://medium.com/globant/secure-rdp-to-ec2-private-instance-using-aws-ssm-d0a1cadd9d6?source=collection_archive---------0-----------------------#2022-01-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="88a0" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">介绍</h1><p id="85a6" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">传统上，我们需要一个堡垒主机来连接EC2私有实例，以实现安全连接或减少攻击面，AWS建议使用一个<a class="ae ka" href="https://docs.aws.amazon.com/quickstart/latest/linux-bastion/welcome.html" rel="noopener ugc nofollow" target="_blank">堡垒主机</a>，也称为跳转主机。Bastion是一个特殊用途的EC2实例，被设计为来自Internet的主要接入点，并充当其他EC2实例的代理。为了连接到您的EC2实例，您首先将远程桌面协议(RDP)连接到bastion主机，并从那里连接到目标EC2实例。</p><p id="ead7" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">为了消除堡垒主机的负担，AWS提供了<a class="ae ka" href="https://aws.amazon.com/systems-manager/" rel="noopener ugc nofollow" target="_blank"> AWS系统管理器</a> (SSM)，允许您安全地连接到您的EC2实例，而不需要运行和操作您自己的堡垒主机，也不需要在您的EC2实例上运行SSH。</p><p id="6f59" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">在本文中，我将介绍如何使用AWS SSM和隧道RDP，使用会话管理器的端口转发功能来访问远程Windows实例。</p><p id="1794" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">本文包括以下部分:</p><p id="224d" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">1-先决条件<br/> 2- AWS系统经理(SSM) <br/> 3-创建Windows OS用户<br/> 4- RDP到EC2实例<br/> 5-摘要<br/> 6-参考</p><h1 id="26cc" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">1-先决条件</h1><ul class=""><li id="c5b8" class="kg kh hh je b jf jg jj jk jn ki jr kj jv kk jz kl km kn ko bi translated">具有互联网连接性(通过NAT网关)的EC2实例，或者位于为SSM 配置了<a class="ae ka" href="https://aws.amazon.com/premiumsupport/knowledge-center/ec2-systems-manager-vpc-endpoints/" rel="noopener ugc nofollow" target="_blank"> VPC端点的子网中。</a></li><li id="c23b" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">分配给实例的IAM实例配置文件，该实例附加了<strong class="je hi">amazonsmsmanagedinstancecore</strong>托管策略(或类似权限)。</li><li id="9162" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">在实例上安装并运行SSM代理。</li><li id="6e90" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">在本地计算机上安装和配置AWS CLI。</li><li id="97c0" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">安装在本地机器上的AWS CLI 的<a class="ae ka" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html" rel="noopener ugc nofollow" target="_blank">会话管理器插件的最新版本。</a></li></ul><h1 id="31d9" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">2- AWS系统经理(SSM)</h1><p id="ff9a" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">AWS Systems Manager会话管理器是一个新的交互式shell和CLI，有助于提供安全、受访问控制和受审核的Windows和Linux EC2实例管理。会话管理器消除了打开入站端口、管理SSH密钥或使用堡垒主机的需要。</p><p id="10dd" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">AWS SSM使用实例上的Systems Manager代理(SSM代理)来启动实例和主机之间的连接。SSM代理预安装在Windows Server 2016/2019 ami上。本文将向您展示如何安全地使用SSM代理和Systems Manager API，通过隧道使用端口转发连接到您的私有Windows EC2实例，而无需运行bastion hosts/jump box，也无需向该实例打开任何入站端口。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/e15cc29a4d03ea473f1b841dae089887.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*U4f5WgMyOzeSXCKY"/></div></div></figure><h2 id="6818" class="lg if hh bd ig lh li lj ik lk ll lm io jn ln lo is jr lp lq iw jv lr ls ja lt bi translated"><strong class="ak"> SSM港转运</strong></h2><p id="cd92" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">您可以使用会话管理器的端口转发功能建立远程桌面协议(RDP)隧道，以访问远程Windows实例，而无需在远程实例上打开入站端口3389(默认RDP端口)。</p><p id="6ab1" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">通过端口转发，您可以将远程实例上的端口转发到本地机器上的端口。这允许用户将传统的远程桌面协议(RDP)端口(3389/tcp)转发到他们本地机器上的可用端口(例如，55678/tcp)。然后，用户可以使用任何RDP客户端连接到本地机器上的转发端口，以访问AWS中的实例。这可以使用下面的SSM命令来实现:</p><pre class="kv kw kx ky fd lu lv lw lx aw ly bi"><span id="136d" class="lg if hh lv b fi lz ma l mb mc">aws ssm start-session --target &lt;instance-id&gt; --document-name     AWS-StartPortForwardingSession --parameters “localPortNumber=55678,portNumber=3389”</span></pre><h1 id="2a90" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak"> 3-创建一个Windows操作系统用户</strong></h1><p id="2b75" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">如果您的EC2实例加入了一个<a class="ae ka" href="https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms_ad_join_instance.html" rel="noopener ugc nofollow" target="_blank">活动目录域</a>，您可以跳过创建windows本地用户的这一步，这将是您的活动目录凭证。按照以下步骤在windows实例中创建新的远程桌面用户:</p><p id="589f" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">A.在AWS系统管理器导航菜单中的节点管理下，浏览到会话管理器控制台，并在Windows实例上启动会话。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es md"><img src="../Images/d46e1057476c7ea42aef052c1e40b066.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0xy-96s0UoQr5-lN"/></div></div></figure><p id="29fa" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">B.键入以下命令创建新用户:</p><ul class=""><li id="d991" class="kg kh hh je b jf kb jj kc jn me jr mf jv mg jz kl km kn ko bi translated">以安全字符串的形式输入密码。输入下面的命令，该命令将提示您输入密码，然后键入一个强密码并输入:</li></ul><pre class="kv kw kx ky fd lu lv lw lx aw ly bi"><span id="64a8" class="lg if hh lv b fi lz ma l mb mc">$Password = Read-Host -AsSecureString</span></pre><ul class=""><li id="7352" class="kg kh hh je b jf kb jj kc jn me jr mf jv mg jz kl km kn ko bi translated">创建本地用户:</li></ul><pre class="kv kw kx ky fd lu lv lw lx aw ly bi"><span id="fa07" class="lg if hh lv b fi lz ma l mb mc">New-LocalUser "User01" -Password $Password</span></pre><ul class=""><li id="264d" class="kg kh hh je b jf kb jj kc jn me jr mf jv mg jz kl km kn ko bi translated">将用户添加到远程桌面用户组:</li></ul><pre class="kv kw kx ky fd lu lv lw lx aw ly bi"><span id="0add" class="lg if hh lv b fi lz ma l mb mc">Add-LocalGroupMember -Group “Remote Desktop Users” -Member “User01”</span></pre><ul class=""><li id="17b7" class="kg kh hh je b jf kb jj kc jn me jr mf jv mg jz kl km kn ko bi translated">单击终止以终止会话，或输入exit并选择关闭。</li></ul><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mh"><img src="../Images/0d4fd0e24cfa8aa97fd74a0496f77417.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ydUMs8wvvEaFYKr7"/></div></div></figure><h1 id="e54f" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak"> 4- RDP到EC2实例</strong></h1><p id="d127" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">按照以下步骤在RDP和EC2实例之间建立安全连接:</p><p id="c0fe" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">A.浏览到EC2控制台，记下Windows实例的实例id。</p><p id="9ce6" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">B.在您的本地机器上打开一个终端，键入下面的命令来启动一个到Windows实例的会话。</p><pre class="kv kw kx ky fd lu lv lw lx aw ly bi"><span id="5a5e" class="lg if hh lv b fi lz ma l mb mc">aws ssm start-session --target &lt;instance-id&gt; --document-name     AWS-StartPortForwardingSession --parameters “localPortNumber=55678,portNumber=3389”</span></pre><p id="b53a" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">C.您应该会看到一条消息，表明端口55678已经为该会话打开。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es mi"><img src="../Images/7a9af021b7a1462e3f01a49e96e02bd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/0*YH-Bz_8NSj8PqPGi"/></div></figure><p id="3b8f" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">D.打开Microsoft远程桌面客户端，并使用以下信息添加新的远程桌面。</p><ul class=""><li id="dfa3" class="kg kh hh je b jf kb jj kc jn me jr mf jv mg jz kl km kn ko bi translated">PC名称:本地主机:55678。</li><li id="5874" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">用户帐户:提供在前面步骤中创建的用户名和密码。</li></ul><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es mj"><img src="../Images/e89bcd0d38b93f402212a43bd3f7ef49.png" data-original-src="https://miro.medium.com/v2/resize:fit:798/format:webp/1*imAj1YLMmT9TVyOhA6xaig.png"/></div></figure><p id="8271" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">E.现在，您应该已经连接，能够通过RDP在远程实例上工作了。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mk"><img src="../Images/0b3a85e10c9f27b09502011bffd0e82f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OHFHq9FIuNSFL2u9"/></div></div></figure><p id="f776" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">一旦完成了EC2实例上的工作，就可以安全地从RDP会话断开连接。然后，您可以进入终端窗口，按Ctrl+C取消会话管理器命令。这将关闭到EC2实例的连接，并从本地机器上的实例中删除任何转发的端口。</p><h1 id="55e0" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">5-摘要</h1><p id="9dca" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在这篇文章中，我们看到了如何使用AWS会话管理器访问私有EC2实例，而不需要向实例的安全组添加入站规则，管理SSH密钥并使用另一个实例作为堡垒主机。我们还学习了如何使用会话管理器来使用端口转发。</p><h1 id="93cb" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">6-参考文献</h1><div class="ml mm ez fb mn mo"><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/what-is-systems-manager.html" rel="noopener  ugc nofollow" target="_blank"><div class="mp ab dw"><div class="mq ab mr cl cj ms"><h2 class="bd hi fi z dy mt ea eb mu ed ef hg bi translated">什么是AWS系统管理器？</h2><div class="mv l"><h3 class="bd b fi z dy mt ea eb mu ed ef dx translated">AWS系统管理器(以前称为SSM)是一种AWS服务，您可以使用它来查看和控制您的基础架构…</h3></div><div class="mw l"><p class="bd b fp z dy mt ea eb mu ed ef dx translated">docs.aws.amazon.co</p></div></div><div class="mx l"><div class="my l mz na nb mx nc le mo"/></div></div></a></div><p id="8309" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated"><a class="ae ka" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/what-is-systems-manager.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/systems-manager/latest/user guide/what-is-systems-manager . html</a></p><p id="3f30" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated"><a class="ae ka" href="https://aws.amazon.com/premiumsupport/knowledge-center/ec2-systems-manager-vpc-endpoints/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/premium support/knowledge-center/ec2-systems-manager-VPC-endpoints/</a></p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es nd"><img src="../Images/a1f75c97581dc50c4d8588f9c9ca6bc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:590/format:webp/0*SGEmsvd24iSP4fdM.png"/></div></figure><p id="a4be" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">在https://www.globant.com/studio/cloud-ops<a class="ae ka" href="https://www.globant.com/studio/cloud-ops" rel="noopener ugc nofollow" target="_blank">拜访我们</a></p></div></div>    
</body>
</html>