<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://medium.com/oracledevs/gain-on-the-roundabout-but-lose-on-the-swings-d9d49ac725f5?source=collection_archive---------1-----------------------#2019-03-10">https://medium.com/oracledevs/gain-on-the-roundabout-but-lose-on-the-swings-d9d49ac725f5?source=collection_archive---------1-----------------------#2019-03-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><h2 id="e967" class="hf hg hh bd hi hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id bi translated">在回旋中获得，但在摇摆中失去</h2><p id="08f3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io hr ip iq ir hv is it iu hz iv iw ix iy ha bi translated">每个人都喜欢脚踏实地——但是阻碍其他交通只会让其他人慢下来。</p><p id="1669" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">向现有表中进行简单大容量装载的示例如下:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="6e0a" class="hf hg hh jk b fi jo jp l jq jr">INSERT INTO &amp;tbl_1<br/>SELECT * FROM &amp;tbl_2;</span></pre><p id="5c0b" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">业务用户使用应用程序时，可能会发生简单的批量加载。datapump导入也可以通过网络链接或转储文件集完成基本相同的任务。</p><p id="94e9" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">对于大容量加载，数据泵导入也可以使用以下访问方法:</p><ul class=""><li id="8e24" class="js jt hh ig b ih ja il jb hr ju hv jv hz jw iy jx jy jz ka bi translated">常规负载。</li><li id="cf6b" class="js jt hh ig b ih kb il kc hr kd hv ke hz kf iy jx jy jz ka bi translated">直接路径负载。</li></ul><p id="3c0a" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">datapump导入可以在应用程序使用时加载数据。</p><p id="48c5" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">问题是，与传统加载相比，直接路径加载会对应用程序的性能产生影响吗？</p><h2 id="39c8" class="hf hg hh bd hi hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id bi translated">传统加载期间对应用程序的影响</h2><p id="16c5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io hr ip iq ir hv is it iu hz iv iw ix iy ha bi translated">数据泵导入的默认访问方法是使用直接路径。datapump导入也不会尝试加载已经存在的表。</p><p id="3d84" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">因此，要对现有的表执行传统的装载，datapump import语句将需要以下子句:</p><ul class=""><li id="697d" class="js jt hh ig b ih ja il jb hr ju hv jv hz jw iy jx jy jz ka bi translated">表_存在_操作=追加</li><li id="3b58" class="js jt hh ig b ih kb il kc hr kd hv ke hz kf iy jx jy jz ka bi translated">访问方法=常规</li></ul><p id="bbbb" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">因此，要对现有模式执行传统的装载，完整的datapump import语句应该是:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="5299" class="hf hg hh jk b fi jo jp l jq jr">&gt; impdp system table_exists_action=append access_method=conventional parfile=d:\importdp.par</span></pre><p id="e6eb" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">数据泵导入的日志文件头如下:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="f48c" class="hf hg hh jk b fi jo jp l jq jr">Import: Release 12.2.0.1.0 — Production on Sun Nov 4 20:42:15 2018</span><span id="ce4a" class="hf hg hh jk b fi kg jp l jq jr">Copyright © 1982, 2018, Oracle and/or its affiliates. All rights reserved.<br/>Password:</span><span id="9f39" class="hf hg hh jk b fi kg jp l jq jr">Connected to: Oracle Database 12c Enterprise Edition Release 12.2.0.1.0–64bit Production<br/>Database Directory Object has defaulted to: “DATA_PUMP_DIR”.<br/>Master table “SYSTEM”.”IMPDP” successfully loaded/unloaded<br/>Starting “SYSTEM”.”IMPDP”: system/******** table_exists_action=append access_method=conventional parfile=d:\importdp.par<br/>Processing object type SCHEMA_EXPORT/USER<br/>..</span></pre><p id="2a40" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">现在使用ctrl+c从命令行模式切换到交互模式，然后退出交互模式:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="065f" class="hf hg hh jk b fi jo jp l jq jr">Import&gt; exit_client</span></pre><p id="2ce9" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">尽管退出了datapump客户端，datapump导入将继续运行，并使用DBA_DATAPUMP_JOBS字典视图显示:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="cba9" class="hf hg hh jk b fi jo jp l jq jr">-— show the current datapump jobs<br/>col owner_name format a10<br/>col job_name format a10<br/>col operation format a10<br/>col job_mode format a10<br/>col state format a10<br/>SELECT * FROM DBA_DATAPUMP_JOBS;</span><span id="4fcd" class="hf hg hh jk b fi kg jp l jq jr">OWNER_NAME JOB_NAME OPERATION JOB_MODE STATE     DEGREE<br/>—————————— ———————— ———————-- -------- --------- ------<br/>SYSTEM     IMPDP    IMPORT    FULL     EXECUTING      1</span><span id="cdd9" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt;</span></pre><p id="a6ca" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">通过SQLPLUS客户机查询一段时间内的事务统计数据，很容易证明datapump导入访问方法是传统的:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="61eb" class="hf hg hh jk b fi jo jp l jq jr">col name format a40<br/>SELECT name, status, noundo, used_ublk, log_io, phy_io<br/>FROM v$transaction;</span><span id="0dcd" class="hf hg hh jk b fi kg jp l jq jr">NAME                            STATUS NOU USED_UBLK  LOG_IO PHY_IO<br/>———————————————————————-------- ------ --- --------- ------- ------<br/>                                ACTIVE NO       1492  239773    128</span><span id="f205" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt; /</span><span id="aad6" class="hf hg hh jk b fi kg jp l jq jr">NAME                            STATUS NOU USED_UBLK  LOG_IO PHY_IO<br/>———————————————————————-------- ------ --- --------- ------- ------<br/>                                ACTIVE NO       5532  883356    193</span><span id="3239" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt; /</span><span id="0f51" class="hf hg hh jk b fi kg jp l jq jr">NAME                            STATUS NOU USED_UBLK  LOG_IO PHY_IO<br/>———————————————————————-------- ------ --- --------- ------- ------<br/>                                ACTIVE NO       7890 1257154    217</span><span id="6d05" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt;</span></pre><p id="f335" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">因此，事务统计数据显示，正在使用的撤销块迅速增加，这种行为与传统的访问方法是一致的。</p><p id="7afc" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">由会话生成的重做记录的数量也将提示直接路径或传统的访问方法:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="1879" class="hf hg hh jk b fi jo jp l jq jr">col name format a30<br/>SELECT sid, name, TRUNC(value/1024/1024,1) "MB"<br/>FROM v$sesstat ss<br/>INNER JOIN v$statname sn<br/>ON (ss.statistic# = sn.statistic#)<br/>WHERE name IN ('redo size for direct writes', —- direct path only<br/>               'redo size') —- conventional plus direct path<br/>  AND sid IN (SELECT sid<br/>              FROM v$session <br/>              WHERE program='impdp.exe' or module like 'Data Pump%')<br/>ORDER BY sid, name;</span><span id="3f10" class="hf hg hh jk b fi kg jp l jq jr">SID NAME                             MB<br/>——— ——————————------------------ ------<br/> 16 redo size                        .3<br/> 16 redo size for direct writes      .1<br/>139 redo size                     403.4<br/>139 redo size for direct writes      .5<br/>271 redo size                        .8<br/>271 redo size for direct writes       0</span><span id="3d50" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt; /</span><span id="10d4" class="hf hg hh jk b fi kg jp l jq jr">SID NAME                             MB<br/>——— ——————————------------------ ------<br/> 16 redo size                        .3<br/> 16 redo size for direct writes      .1<br/>139 redo size                      2015<br/>139 redo size for direct writes      .5<br/>271 redo size                        .8<br/>271 redo size for direct writes       0</span><span id="bd58" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt; /</span><span id="2b65" class="hf hg hh jk b fi kg jp l jq jr">SID NAME                             MB<br/>——— ——————————------------------ ------<br/>16 redo size                         .3<br/>16 redo size for direct writes       .1<br/>139 redo size                    4024.7<br/>139 redo size for direct writes      .5<br/>271 redo size                        .8<br/>271 redo size for direct writes       0</span><span id="7c87" class="hf hg hh jk b fi kg jp l jq jr">SQL &gt;</span></pre><p id="5a09" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">会话统计数据显示,“直接写入的重做大小”无关紧要，而“重做大小”指标却在稳步增长。</p><p id="73b8" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">这种现象表明传统的重做记录正在被创建。</p><p id="65d0" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">为了模拟业务用户使用的应用程序，需要在加载datapump导入时创建额外的会话。</p><p id="a4c4" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">因此，通过SQLPLUS创建了三个会话，并在每个会话中执行insert、update和delete语句。</p><p id="83f4" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">使用SET TRANSACTION NAME语句，事务将被命名为:</p><ul class=""><li id="0287" class="js jt hh ig b ih ja il jb hr ju hv jv hz jw iy jx jy jz ka bi translated">小型常规散装货物</li><li id="6340" class="js jt hh ig b ih kb il kc hr kd hv ke hz kf iy jx jy jz ka bi translated">更新</li><li id="dce5" class="js jt hh ig b ih kb il kc hr kd hv ke hz kf iy jx jy jz ka bi translated">删除</li></ul><p id="8059" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">这三个事务的命名将使识别它们变得更容易，因为来自datapump导入的常规装载将不会被命名。</p><p id="d908" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">查询四个会话的事务统计数据(包括来自数据泵导入的负载)将给出一些性能指标:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="bf89" class="hf hg hh jk b fi jo jp l jq jr">col name format a40<br/>SELECT name, status, noundo, used_ublk, log_io, phy_io<br/>FROM v$transaction;</span><span id="9845" class="hf hg hh jk b fi kg jp l jq jr">NAME                            STATUS NOU USED_UBLK  LOG_IO PHY_IO<br/>———————————————————————-------- ------ --- --------- ------- ------small conventional bulk load    ACTIVE NO         53   25901    407<br/>delete                          ACTIVE NO       2813  603415  13420<br/>update                          ACTIVE NO        533  142307  65112<br/>                                ACTIVE NO      17309 2811209    159</span><span id="22e4" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt; /</span><span id="a786" class="hf hg hh jk b fi kg jp l jq jr">NAME                            STATUS NOU USED_UBLK  LOG_IO PHY_IO<br/>———————————————————————-------- ------ --- --------- ------- ------<br/>small conventional bulk load    ACTIVE NO        241  103226    583<br/>delete                          ACTIVE NO       3132  708728  26231<br/>update                          ACTIVE NO        977  250572  97026<br/>                                ACTIVE NO      20429 3300952    214</span><span id="6860" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt; /</span><span id="8e30" class="hf hg hh jk b fi kg jp l jq jr">NAME                            STATUS NOU USED_UBLK  LOG_IO PHY_IO<br/>———————————————————————-------- ------ --- --------- ------- ------<br/>small conventional bulk load    ACTIVE NO        484  206412    746<br/>delete                          ACTIVE NO       5206 1186624  26845<br/>update                          ACTIVE NO       1078  284712 131124<br/>                                ACTIVE NO      34612 5602518    304</span><span id="d0ec" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt;</span></pre><p id="6aaa" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">所有事务统计数据都在增加，这表明一个会话中没有事务阻塞其他会话中的其他事务。</p><p id="0a81" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">监视阻塞事务(或会话)的一种更图形化的方式是在SQL Developer客户端的“实例查看器”菜单中:</p><figure class="jf jg jh ji fd ki er es paragraph-image"><div class="er es kh"><img src="../Images/d1de747999a12ff0273866defadb969c.png" data-original-src="https://miro.medium.com/v2/resize:fit:656/format:webp/1*Y_lK8uf6oV2JND-6AF9rRg.jpeg"/></div></figure><p id="34d8" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">SQL Developer客户端显示有几个活动会话，并且没有会话被阻塞。</p><p id="2c93" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">等待会话和阻塞会话也可以通过从SQLPLUS客户端查询字典视图来确定:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="4c28" class="hf hg hh jk b fi jo jp l jq jr">-— determine if a session is waiting due to a block<br/>col lock_type format a15<br/>col lock_id1 format 999999<br/>col lock_id2 format 999999<br/>select * from dba_waiters;</span><span id="ffca" class="hf hg hh jk b fi kg jp l jq jr">no rows selected</span><span id="e1ad" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt;</span></pre><p id="4671" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">因此没有等待锁的会话。</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="18d6" class="hf hg hh jk b fi jo jp l jq jr">-— determine if a session is blocking<br/>col mode_held format a10<br/>col mode_requested format a10<br/>col lock_id1 format a10<br/>col lock_id2 format a10<br/>col blocking_others format a15<br/>col lock_type format a15<br/>select *<br/>from dba_lock<br/>where blocking_others='Blocking'<br/>order by session_id;</span><span id="ba3e" class="hf hg hh jk b fi kg jp l jq jr">no rows selected</span><span id="3394" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt;</span></pre><p id="1a92" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">没有会话阻塞任何其他会话，如果没有会话在等待锁，这就是我们所期望的。</p><p id="59e8" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">在不阻塞其他会话的情况下，使用传统访问方法的数据泵导入影响应用程序性能的可能性较低。</p><h2 id="89c1" class="hf hg hh bd hi hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id bi translated">直接路径加载期间对应用程序的影响</h2><p id="47a8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io hr ip iq ir hv is it iu hz iv iw ix iy ha bi translated">为了确定影响应用程序的直接路径负载的可能影响，将重复datapump导入。</p><p id="73a4" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">这一次将忽略“access _ method = conventional”子句，因此将使用直接路径。</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="02f9" class="hf hg hh jk b fi jo jp l jq jr">&gt; impdp system table_exists_action=append parfile=d:\importdp.par</span></pre><p id="d16b" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">数据泵导入的日志文件头如下:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="14f3" class="hf hg hh jk b fi jo jp l jq jr">Import: Release 12.2.0.1.0 — Production on Sun Nov 4 22:51:17 2018</span><span id="ec8d" class="hf hg hh jk b fi kg jp l jq jr">Copyright © 1982, 2018, Oracle and/or its affiliates. All rights reserved.<br/>Password:</span><span id="795a" class="hf hg hh jk b fi kg jp l jq jr">Connected to: Oracle Database 12c Enterprise Edition Release 12.2.0.1.0–64bit Production<br/>Database Directory Object has defaulted to: “DATA_PUMP_DIR”.<br/>Master table “SYSTEM”.”IMPDP” successfully loaded/unloaded<br/>Starting “SYSTEM”.”IMPDP”: system/******** table_exists_action=append parfile=d:\importdp.par<br/>Processing object type SCHEMA_EXPORT/USER<br/>..</span></pre><p id="9b79" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">现在使用ctrl+c从命令行模式切换到交互模式，然后退出交互模式:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="d33f" class="hf hg hh jk b fi jo jp l jq jr">Import&gt; exit_client</span></pre><p id="049d" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">数据泵导入将继续运行，并使用DBA_DATAPUMP_JOBS显示:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="bb77" class="hf hg hh jk b fi jo jp l jq jr">-— show the current datapump jobs<br/>col owner_name format a10<br/>col job_name format a10<br/>col operation format a10<br/>col job_mode format a10<br/>col state format a10<br/>SELECT * FROM DBA_DATAPUMP_JOBS;</span><span id="d84b" class="hf hg hh jk b fi kg jp l jq jr">OWNER_NAME JOB_NAME OPERATION JOB_MODE STATE     DEGREE<br/>—————————— ———————— ———————-- -------- --------- ------<br/>SYSTEM     IMPDP    IMPORT    FULL     EXECUTING      1</span><span id="0626" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt;</span></pre><p id="0b3f" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">查询事务统计还将确定使用的是直接路径还是传统访问方法:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="2968" class="hf hg hh jk b fi jo jp l jq jr">col name format a40<br/>SELECT name, status, noundo, used_ublk, log_io, phy_io<br/>FROM v$transaction;</span><span id="c974" class="hf hg hh jk b fi kg jp l jq jr">NAME                            STATUS NOU USED_UBLK  LOG_IO PHY_IO<br/>———————————————————————-------- ------ --- --------- ------- ------<br/>                                ACTIVE NO          1   12406  12478</span><span id="cb3d" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt; /</span><span id="6b71" class="hf hg hh jk b fi kg jp l jq jr">NAME                            STATUS NOU USED_UBLK  LOG_IO PHY_IO<br/>———————————————————————-------- ------ --- --------- ------- ------ <br/>                                ACTIVE NO          1   15442  18108</span><span id="3acd" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt; /</span><span id="ce23" class="hf hg hh jk b fi kg jp l jq jr">NAME                            STATUS NOU USED_UBLK  LOG_IO PHY_IO<br/>———————————————————————-------- ------ --- --------- ------- ------<br/>                                ACTIVE NO          1   22537  26684</span><span id="95ca" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt;</span></pre><p id="6cc0" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">使用的撤销块很少，这表明访问方法使用的是直接路径。</p><p id="75a2" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">会话统计信息还应指示访问方法是传统的还是直接路径:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="8127" class="hf hg hh jk b fi jo jp l jq jr">col name format a30<br/>SELECT sid, name, TRUNC(value/1024/1024,1) "MB"<br/>FROM v$sesstat ss<br/>INNER JOIN v$statname sn<br/>ON (ss.statistic# = sn.statistic#)<br/>WHERE name IN ('redo size for direct writes', -— direct path only<br/>               'redo size') — conventional plus direct path<br/>and sid IN (SELECT sid<br/>            FROM v$session<br/>            WHERE program='impdp.exe' or module like 'Data Pump%')<br/>ORDER BY sid, name;</span><span id="3c94" class="hf hg hh jk b fi kg jp l jq jr">SID NAME                             MB<br/>——— ——————————------------------ ------<br/> 16 redo size                        .3<br/> 16 redo size for direct writes      .1<br/>142 redo size                     211.4<br/>142 redo size for direct writes   209.8<br/>379 redo size                        .8<br/>379 redo size for direct writes       0</span><span id="ca47" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt; /</span><span id="edb4" class="hf hg hh jk b fi kg jp l jq jr">SID NAME                             MB<br/>——— ——————————------------------ ------<br/> 16 redo size                        .3<br/> 16 redo size for direct writes      .1<br/>142 redo size                     949.1<br/>142 redo size for direct writes   947.3<br/>379 redo size                        .8<br/>379 redo size for direct writes       0</span><span id="c3ff" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt; /</span><span id="57ec" class="hf hg hh jk b fi kg jp l jq jr">SID NAME                             MB<br/>——— ——————————------------------ ------<br/> 16 redo size                        .3<br/> 16 redo size for direct writes      .1<br/>142 redo size                    1668.1<br/>142 redo size for direct writes  1666.2<br/>379 redo size                        .8<br/>379 redo size for direct writes       0</span><span id="90b2" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt;</span></pre><p id="b837" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">会话统计数据显示,“直接写入的重做大小”正在显著增加，因此访问方法是直接路径。</p><p id="6f83" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">同样，为了模拟业务用户使用的应用程序，在加载datapump导入时需要创建额外的会话。</p><p id="ce77" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">当直接路径加载正在进行时，在SQLPLUS客户机中创建三个会话，并在每个会话中执行insert、update和delete语句。</p><p id="bbb5" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">总共有四个会话(包括数据泵导入)，相应的事务统计如下所示:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="fc06" class="hf hg hh jk b fi jo jp l jq jr">col name format a40<br/>SELECT name, status, noundo, used_ublk, log_io, phy_io<br/>FROM v$transaction;</span><span id="abca" class="hf hg hh jk b fi kg jp l jq jr">NAME                            STATUS NOU USED_UBLK  LOG_IO PHY_IO<br/>———————————————————————-------- ------ --- --------- ------- ------<br/>                                ACTIVE NO          1   12406  12478</span><span id="93c7" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt; /</span><span id="32b0" class="hf hg hh jk b fi kg jp l jq jr">NAME                            STATUS NOU USED_UBLK  LOG_IO PHY_IO<br/>———————————————————————-------- ------ --- --------- ------- ------<br/>                                ACTIVE NO          1   60309  82231</span><span id="a05c" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt; /</span><span id="7cf9" class="hf hg hh jk b fi kg jp l jq jr">NAME                            STATUS NOU USED_UBLK  LOG_IO PHY_IO<br/>———————————————————————-------- ------ --- --------- ------- ------<br/>                                ACTIVE NO          4  127661 164033</span><span id="1822" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt;</span></pre><p id="e533" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">现在有一个问题。</p><p id="44ef" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">以前使用传统访问方法时，有四个事务同时进行。</p><p id="8cf9" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">然而，尽管执行了四条语句，现在只有一个事务！</p><p id="1070" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">SQL开发人员可以用图形方式显示会话的状态。</p><figure class="jf jg jh ji fd ki er es paragraph-image"><div class="er es kl"><img src="../Images/57ace7c8b0c784af20117f8a20590ac4.png" data-original-src="https://miro.medium.com/v2/resize:fit:654/format:webp/1*yyaW8qwN7dtlMHYzQcqGKg.jpeg"/></div></figure><p id="1a68" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">SQL Developer显示有几个活动会话，但有三个会话被阻塞。</p><p id="62bf" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">DBA_WAITERS字典视图还会指出哪些会话正在等待:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="1a01" class="hf hg hh jk b fi jo jp l jq jr">-— determine if a session is waiting due to a block<br/>col lock_type format a15<br/>col lock_id1 format 999999<br/>col lock_id2 format 999999<br/>select * from dba_waiters;</span><span id="7f87" class="hf hg hh jk b fi kg jp l jq jr">WAITING_SESSION HOLDING_SESSION LOCK_TYPE MODE_HELD MODE_REQUE<br/>——————————————— ——————————————- --------- --------- ----------<br/>            141             278 DML       Exclusive Row-X (SX)<br/>            146             278 DML       Exclusive Row-X (SX)<br/>            271             278 DML       Exclusive Row-X (SX)</span><span id="61e4" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt;</span></pre><p id="04dd" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">以前，对于传统访问方法，没有会话被阻止，但现在有三个会话受到影响。</p><p id="eb2b" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">阻塞会话也很容易从DBA_LOCK字典视图中确定。</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="d84c" class="hf hg hh jk b fi jo jp l jq jr">-— determine if a session is blocking<br/>col mode_held format a10<br/>col mode_requested format a10<br/>col lock_id1 format a10<br/>col lock_id2 format a10<br/>col blocking_others format a15<br/>col lock_type format a15<br/>select *<br/>from dba_lock<br/>where blocking_others='Blocking'<br/>order by session_id;</span><span id="0d9f" class="hf hg hh jk b fi kg jp l jq jr">SESSION_ID LOCK_TYPE MODE_HELD MODE_REQUE BLOCKING_OTHERS<br/>—————————— ————————— ————————- ---------- ---------------<br/>       142 DML       Exclusive None       Blocking</span><span id="fab5" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt;</span></pre><p id="6b55" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">会话142是直接路径负载，所以现在数据泵导入对应用程序有不利影响。</p><p id="2321" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">Oracle还提供了一个脚本UTLLOCKT，以树形格式显示拦截器和等待者:</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="a418" class="hf hg hh jk b fi jo jp l jq jr">-— show all the blocking and requested locks<br/>@?\RDBMS\ADMIN\utllockt</span><span id="425e" class="hf hg hh jk b fi kg jp l jq jr">WAITING_SESSION LOCK_TYPE MODE_REQUE MODE_HELD LOCK_ID1 LOCK_ID2<br/>——————————————— ————————- ---------- --------- -------- --------<br/>142             None<br/>   141          DML       Row-X (SX) Exclusive 87471    0<br/>   146          DML       Row-X (SX) Exclusive 87471    0<br/>   271          DML       Row-X (SX) Exclusive 87471    0</span><span id="5f42" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt;</span></pre><p id="244c" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">既然我们知道有三个会话被直接路径负载阻塞，那么下一个问题是，影响是什么？</p><p id="3cd2" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">通过查询事务入队统计信息，可以确定直接路径负载导致的阻塞持续时间。</p><pre class="jf jg jh ji fd jj jk jl jm aw jn bi"><span id="2eab" class="hf hg hh jk b fi jo jp l jq jr">column DECODE(lmode,0,'none',1,'null',2,'rowS',3,'rowX',4,'share',5,'S/RowX',6,'excl',lmode) form A7 heading lock<br/>column DECODE(request,0,'none',1,'null',2,'rowS',3,'rowX',4,'share',5,'S/RowX',6,'excl',request) form A7 heading request<br/>select<br/>  sid, type,<br/>  DECODE(lmode,0,'none', 1,'null', 2,'rowS', 3,'rowX', 4,'share', 5,'S/RowX', 6,'excl',lmode),<br/>  DECODE(request,0,'none', 1,'null', 2,'rowS', 3,'rowX', 4,'share', 5,'S/RowX', 6,'excl',request),<br/>  ctime "time(sec)"<br/>from V$TRANSACTION_ENQUEUE a;</span><span id="318e" class="hf hg hh jk b fi kg jp l jq jr">sid TY lock request time(sec)<br/>——— —— ———— —------ ---------<br/>142 TX excl none            7</span><span id="c8f3" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt; /</span><span id="b328" class="hf hg hh jk b fi kg jp l jq jr">sid TY lock request time(sec)<br/>——— —— ———— —------ ---------<br/>142 TX excl none          103</span><span id="66bf" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt; /</span><span id="550e" class="hf hg hh jk b fi kg jp l jq jr">sid TY lock request time(sec)<br/>——— —— ———— —------ ---------<br/>142 TX excl none          172</span><span id="8823" class="hf hg hh jk b fi kg jp l jq jr">SQL&gt;</span></pre><p id="2c6b" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">直接路径负载越大，阻塞锁被持有的时间就越长。在这种情况下，阻塞锁的持续时间会增加。</p><p id="f2e8" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">实际上，这意味着应用程序的功能将被阻塞，业务用户将不得不等待。</p><p id="45dc" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">只有当该表的直接路径加载完成时，阻塞锁才会被释放，应用程序才会恢复正常的性能预期。</p><h2 id="d18b" class="hf hg hh bd hi hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id bi translated">请参见</h2><p id="9028" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io hr ip iq ir hv is it iu hz iv iw ix iy ha bi translated">数据并发性和一致性</p><p id="0b35" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated"><a class="ae km" href="https://docs.oracle.com/en/database/oracle/oracle-database/12.2/cncpt/data-concurrency-and-consistency.html#GUID-E8CBA9C5-58E3-460F-A82A-850E0152E95C" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/en/database/Oracle/Oracle-database/12.2/cncpt/data-concurrency-and-consistency . html # GUID-E8 CBA 9 c 5-58e 3-460 f-A82A-850 e 0152 e 95 c</a></p><p id="64f2" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated">使用数据泵导入加载</p><p id="3736" class="pw-post-body-paragraph ie if hh ig b ih ja ij ik il jb in io hr jc iq ir hv jd it iu hz je iw ix iy ha bi translated"><a class="ae km" href="https://docs.oracle.com/en/database/oracle/oracle-database/12.2/sutil/datapump-import-utility.html#GUID-D11E340E-14C6-43B8-AB09-6335F0C1F71B" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/en/database/Oracle/Oracle-database/12.2/sutil/data pump-import-utility . html # GUID-d11e 340 e-14 C6-43 b8-AB09-6335 f 0 C1 f 71 b</a></p><h2 id="31e1" class="hf hg hh bd hi hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id bi translated">关于作者</h2><p id="df79" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io hr ip iq ir hv is it iu hz iv iw ix iy ha bi translated"><em class="iz"> Paul Guerin是一名专注于Oracle数据库性能的国际顾问。Paul在东南亚的全球交付中心工作，但他的客户来自澳大利亚、欧洲、亚洲和北美。此外，他还出席了一些世界领先的甲骨文会议，包括甲骨文2013年世界开放大会。他的工作还入选了2015年IOUG最佳实践技巧手册，以及甲骨文技术网络(OTN)。他是一名DBA OCP，并将继续参与Oracle ACE计划。</em></p></div></div>    
</body>
</html>