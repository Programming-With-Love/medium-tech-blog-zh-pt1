# Airbnb 支付平台的异常检测

> 原文：<https://medium.com/airbnb-engineering/anomaly-detection-for-airbnb-s-payment-platform-e3b0ec513199?source=collection_archive---------0----------------------->

由[卢](https://www.linkedin.com/in/jingxiao-lu-07925019)

![](img/974e511c400f3aa9f384b55a1ed913cf.png)

Airbnb 的主人和客人遍布全球，Airbnb 希望提供一种无摩擦的支付体验，让我们的客人可以通过熟悉的支付方式用当地货币支付，而我们的主人可以通过方便的方式用他们喜欢的货币收款。例如，在巴西，货币是巴西雷亚尔，人们熟悉 Boleto 作为一种支付方式。这些与我们在美国使用的完全不同，想象一下这个问题蔓延到 Airbnb 服务的 190 个国家。

为了实现这一目标，我们的[支付团队](http://nerds.airbnb.com/payments-airbnb/)构建了一个安全易用的世界级支付平台。该团队的职责包括支持客人支付和主人支付，新的支付体验，如[礼品卡](https://www.airbnb.com/gift)，以及协助财务对账等。

因为 Airbnb 在 190 个国家运营，我们支持大量的货币和处理器。大多数时候，我们的系统正常运行，但我们确实会遇到一些问题，比如某个货币无法处理或者某个支付网关无法访问。为了尽快捕捉这些中断，数据科学团队构建了一个异常检测系统，可以在问题出现时实时识别问题。这有助于产品团队快速发现问题和机会，同时腾出数据科学家的时间来进行 A/B 测试(新的支付方式、新产品发布)、统计分析(价格对预订、预测的影响)以及构建机器学习模型来个性化用户体验。

为了让您了解我们为检测支付数据集中的异常值而构建的异常检测工具，在这篇博客中，我将使用几组不同的模拟数据来演示模型是如何工作的。我将假装在 2020 年夏天经营一家电子商务商店，出售三种黑客物品:显示器、键盘和鼠标。我还有两个供应商:利马和朴树。

# 动机

异常检测系统的主要目标是在我们的时间序列数据集中发现异常值。有时候，一个高层次的展望就足够了，但大多数时候我们需要切割数据来解读潜在的趋势。让我们考虑下面的例子，我们正在监视监视器的导入。

![](img/2d31775d55c90dc685b555843f721929.png)

这些显示器的总体数字看起来很正常。然后，我们看一下由我们的两个不同供应商进口的显示器:Lima 和 Hackberry。

![](img/68b5a166b470b893996fd6c2a2248463.png)

在这里我们可以看到，我们的显示器主要供应商 Lima 在 2020 年 8 月 18 日连续三天没有交付预期数量的产品。在此期间，我们自动求助于我们的二级供应商 Hackberry。如果我们只看高层次的数据，我们不会发现这个问题，但是更深层次的观察为我们提供了针对正确问题的信息。

# 模型

**简单回归模型**

一个直观的模型是运行一个简单的[普通最小二乘](http://www.wikiwand.com/en/Ordinary_least_squares)回归，用虚拟变量表示星期几。该模型采用以下形式:

![](img/e2e49fb4322558fd51cc06763f2c1af5.png)

其中 y 是我们要跟踪的数量，t 是时间变量， *I_day_i* 是指示变量，表示今天是否是一周的第*天*天，e 是误差项。这个模型非常简单，它通常在识别趋势方面做得很好。然而，有几个缺点:

*   增长预测值是线性的。如果我们经历指数增长，它不擅长建模趋势。
*   有一个强有力的假设，即时间序列只显示每周的季节性。它不能处理具有其他季节性模式的产品。
*   太多的虚拟变量需要更大的系数样本量，以达到理想的显著性水平。

即使我们可以观察我们想要跟踪的指标的模式，并手动更改模型的形式(即，当观察到强烈的月度或年度季节性时，我们可以添加额外的虚拟变量)，该过程也是不可扩展的。一种自动识别季节性的方法有助于我们避免自己的偏见，并使我们能够在支付以外的数据集中使用这种技术。

**快速傅立叶变换模型**

在构建具有趋势和季节性的时间序列模型时，通常的做法是构建采用以下形式的模型:

![](img/d95fb204f889a440fd17b56e23e460d2.png)

其中 Y 是度量单位；s 代表季节性；t 代表趋势；e 是误差项。例如，在我们的简单回归模型中，S 由指标函数的总和表示，T 由 at+b 表示。

在这一节中，我们将开发新的方法来检测趋势和季节性，结合我们从上一节中获得的知识。我们将使用键盘和鼠标这两个虚拟产品的销售来演示这个模型是如何工作的。下图描述了这两种产品的销售价值:

![](img/953748f3385f16effc853e6a3724d0eb.png)

如上所示，键盘是 2016 年 9 月推出的主要产品，鼠标是 2017 年 8 月推出的。我们将对季节性和趋势进行建模，并试图发现误差项与平均值相差太远的异常情况。

# 季节性

为了检测季节性，我们将使用[快速傅立叶变换](https://en.wikipedia.org/wiki/Fast_Fourier_transform) (FFT)。在简单的线性回归模型中，我们假设了每周的季节性。正如我们在上面看到的，Mouses 中没有强的周模式，所以盲目假设这样的模式会因为不必要的虚拟变量而伤害模型。一般来说，如果我们有大量的历史数据，FFT 是检测季节性的好工具。它非常擅长探测季节模式。将 FFT 应用于两个时间序列后，我们得到下图:

![](img/d29d65eba9198d89176f13894ddc81e9.png)

其中，季节日是变换余弦波的周期。在 FFT 中，我们通常只选择具有峰值振幅的周期来代表季节性，而将所有其他周期视为噪声。在这种情况下，对于键盘，我们在 7 和 3.5 处看到两个较大的峰值，在 45 和 60 处看到另外两个较小的峰值。对于小鼠，我们在第 7 天看到一个显著峰值，在第 35、60 和 80 天看到一些较小的峰值。从 FFT 生成的键盘和鼠标的季节性如下图所示:

![](img/14e768830231247c8b40f14479353f3e.png)

正如我们所看到的，键盘的季节性幅度随着时间的推移而增长，并且它包含一个主要的每周季节性，而鼠标的幅度在每周趋势和 40 天内都显示出显著的季节性。

# 趋势

这里我们将使用滚动中位数作为时间序列的趋势。这里的假设是，在很短的时间内，增长不是很显著。例如，对于某一天，我们将使用之前 7 天的滚动中位数作为该天的趋势水平。使用中间值而不是平均值的优点是在异常值的情况下具有更好的稳定性。例如，如果我们有一两天突然增加了 10 倍，如果我们看中位数，这不会影响趋势。但是，如果用均值的话会影响我们的走势。在本次演示中，我们使用 14 天中值作为趋势，如下图所示:

![](img/881ac505ff5a8247c9354e0660e52ab1.png)

# 错误

在得到季节性和趋势后，我们将评估误差项。我们将使用误差项来确定时间序列数据集中是否存在异常。当我们将趋势和季节性结合在一起，并从原始销售数据中减去它时，我们得到误差项。我们在下图中绘制了误差项:

![](img/d28668943ae6adce715da8aabe4c303b.png)

如我们所见，误差项中有一些尖峰，代表时间序列数据中的异常。根据我们可以容忍多少假阳性，我们可以选择允许多少个偏离 0 的标准偏差。这里我们将使用 4 个标准差来获得合理的警报数量。

![](img/2972f2b533222d218d75b53338e37066.png)

正如我们在上面看到的，警报系统很好地识别了误差项中的大多数尖峰，这与数据中的一些异常相对应。请注意，我们检测到的一些异常对人眼来说根本不是异常，但由于季节性模式，它们实际上是真实的异常。

总的来说，根据我们的内部测试，该模型在识别异常方面表现良好，同时对数据做了最少的假设。

# 结论

希望这篇博文能提供一些关于如何构建一个模型来检测异常的见解。大多数异常检测模型涉及季节性和趋势建模。建模的一个关键要素是尽可能少做假设。这将使模型足够通用，以适应更多的情况。然而，如果一些假设大大简化了你的建模过程，不要回避采用这些假设。

![](img/3913f6470a7657e02386189e67b4eb30.png)

## 在 [airbnb.io](http://airbnb.io) 查看我们所有的开源项目，并在 Twitter 上关注我们:[@ Airbnb eng](https://twitter.com/AirbnbEng)+[@ Airbnb data](https://twitter.com/AirbnbData)

*原载于 2015 年 8 月 18 日*[*nerds.airbnb.com*](http://nerds.airbnb.com/anomaly-detection/)*。*