<html>
<head>
<title>myfile: Using Active Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我的文件:使用活动存储</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/myfile-using-active-storage-23b37f3f8085?source=collection_archive---------4-----------------------#2022-02-23">https://medium.com/oracledevs/myfile-using-active-storage-23b37f3f8085?source=collection_archive---------4-----------------------#2022-02-23</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/5c8303612667e569d7cc0950b4518b5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*noUAQW8VaeGjx0mHwDTK8A.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo by <a class="ae it" href="https://www.pexels.com/@cleyder-duque-1585619?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"><strong class="bd iu">Cleyder Duque</strong></a> from <a class="ae it" href="https://www.pexels.com/photo/photo-of-warehouse-3821385/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"><strong class="bd iu">Pexels</strong></a></figcaption></figure><h1 id="411b" class="iv iw hh bd iu ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">介绍</h1><p id="d435" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">本文基于我们在第一篇文章的<a class="ae it" rel="noopener" href="/oracledevs/introducing-myfile-a-base-rails-app-on-oci-a91149812cbc">中构建的简单的<em class="kq"> myfile </em>示例应用程序。我们将切换到使用活动存储来处理文件上传/下载，将所有文件存储在OCI对象存储中。</a></p><h1 id="8628" class="iv iw hh bd iu ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">背景</h1><p id="a78d" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">这是关于在OCI中使用一些流行的红宝石的系列文章的一部分。如果你没有跟上，请参见<a class="ae it" rel="noopener" href="/oracledevs/introducing-myfile-a-base-rails-app-on-oci-a91149812cbc">的第一篇文章</a>，它提供了我们将在本教程中使用的基础应用。</p><p id="71ad" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">我们将与<a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/Object/Concepts/objectstorageoverview.htm" rel="noopener ugc nofollow" target="_blank"> OCI对象存储</a>合作，所以如果你还没有OCI账户，你应该<a class="ae it" href="https://www.oracle.com/cloud/free/#always-free?source=:ex:tb:::::WWMK220126P00003&amp;SC=:ex:tb:::::WWMK220126P00003&amp;pcode=WWMK220126P00003" rel="noopener ugc nofollow" target="_blank">现在就注册</a>一个！有任何问题、评论或想与其他志同道合的技术极客聊天吗？请随意评论这篇文章(如下)以及加入<a class="ae it" href="https://join.slack.com/t/oracledevrel/shared_invite/zt-uffjmwh3-ksmv2ii9YxSkc6IpbokL1g" rel="noopener ugc nofollow" target="_blank"> Slack </a>的乐趣。</p><h1 id="1297" class="iv iw hh bd iu ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">事实真相</h1><p id="1415" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">实际上，我们不会引入任何新的功能(至少在前端)。相反，我们存储文件的方式将会改变。我们将把它们持久化到OCI对象存储中，并使用Rails活动存储创建一个处理“附件”的全功能接口。</p><h1 id="9b3e" class="iv iw hh bd iu ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">它不是什么</h1><p id="d365" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">提醒一下大家，这不是为了“今天就去生产吧！”情况，而是展示如何在Rails应用程序中集成(使用)OCI对象存储。这个特定的实现使用活动存储来处理附件的管理。安全性最佳实践并未得到强调，它更像是一个“展示和讲述”的例子。</p><h1 id="5eeb" class="iv iw hh bd iu ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">入门指南</h1><p id="d191" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">从我们在本系列的第一篇文章<a class="ae it" rel="noopener" href="/oracledevs/introducing-myfile-a-base-rails-app-on-oci-a91149812cbc">中构建的myfile示例Rails应用程序的“干净”副本开始。您可以将myfile应用程序复制并粘贴到另一个目录(如<em class="kq"> myfile_active_storage </em>)或创建一个分支。无论哪种方式，我们将从我们离开的地方开始，所以拿起一杯茶，让我们开始吧！</a></p><h1 id="feac" class="iv iw hh bd iu ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">创建OCI对象存储桶</h1><p id="0938" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">首先，我们需要创建一个桶。我选择用Terraform来做这件事。下面是一个示例Terraform代码片段(提供者等。未示出-仅是与桶相关的几个相关摘录):</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="7f4a" class="lf iw hh lb b fi lg lh l li lj">data "oci_objectstorage_namespace" "this" {<br/>  compartment_id = var.tenancy_ocid<br/>}</span><span id="287b" class="lf iw hh lb b fi lk lh l li lj">resource "oci_objectstorage_bucket" "test_bucket" {<br/>  compartment_id = var.compartment_ocid<br/>  name = "myfile-development"<br/>  namespace = data.oci_objectstorage_namespace.this.namespace<br/>  access_type = "NoPublicAccess"<br/>  storage_tier = "Standard"<br/>  <br/>  lifecycle {<br/>    ignore_changes = [defined_tags["Oracle-Tags.CreatedBy"], defined_tags["Oracle-Tags.CreatedOn"]]<br/>  }<br/>}</span></pre><p id="1d64" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">上面的代码片段在一个特定的区间中创建了一个名为<em class="kq"> myfile-development </em>的bucket。该存储桶是私有的(公共访问是<em class="kq">而不是</em>授予的)，并且使用<em class="kq">标准</em>存储层。虽然其中一些可能是默认设置，但我喜欢明确地把它拼写出来，让人们痛苦地明白正在做什么。不熟悉OCI Terraform提供者和oci_objectstorage_bucket资源的人仍然可以从上面的内容中推断出一些基础知识。</p><p id="805d" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">如果您愿意，您可以使用OCI控制台来创建这个桶。如果您不熟悉如何操作，请参见<a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/Object/Tasks/managingbuckets.htm#ariaid-title18" rel="noopener ugc nofollow" target="_blank"> OCI文档</a>中的<a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/Object/Tasks/managingbuckets.htm#ariaid-title18" rel="noopener ugc nofollow" target="_blank">说明</a>。</p><p id="9d69" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">在我们完全完成之前，还有一个为<a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/Object/Tasks/s3compatibleapi.htm" rel="noopener ugc nofollow" target="_blank"> OCI S3兼容性API </a>设置凭证的问题。遵循在<a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/Object/Tasks/s3compatibleapi.htm" rel="noopener ugc nofollow" target="_blank"> OCI S3兼容性API </a>文档中标题为<em class="kq">设置对Oracle云基础设施的访问</em>一节中设置客户密钥的说明。请将这些凭证存放在安全的地方，因为您很快就会用到它们！</p><h1 id="4211" class="iv iw hh bd iu ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">镜像数据</h1><p id="5214" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">活动存储提供了将数据从一个位置镜像到另一个位置的能力。这可能如何使用？最简单的方法之一是从一个OCI地区复制到另一个地区。使用<a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/Object/Tasks/usingreplication.htm" rel="noopener ugc nofollow" target="_blank"> OCI对象存储复制</a>功能，该功能在OCI本地也可用。</p><p id="69cf" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">哪个最好？这取决于你。主动存储方法的一个危险信号是它不是原子的。活动存储镜像服务文档非常清楚镜像不是一个“有保证的”动作。我倾向于使用OCI本地的功能，这将提供不依赖于我的应用程序代码的稳定性能。在我看来，这保证了更高层次的保证，它会被正确地完成。</p><p id="3e94" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">不过，我们有些超前了——我们甚至还没有在项目中设置活动存储。就这么办吧！</p><h1 id="c3fa" class="iv iw hh bd iu ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">添加活动存储</h1><p id="15a9" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">活动存储使用几个需要创建的表(<a class="ae it" href="https://guides.rubyonrails.org/active_storage_overview.html" rel="noopener ugc nofollow" target="_blank">活动存储文档</a>告诉你更多关于这些的信息)。这是通过以下命令完成的:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="c87d" class="lf iw hh lb b fi lg lh l li lj">$ rails active_storage:install</span></pre><p id="7c92" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">这将创建负责创建三个表的迁移。使用以下内容运行迁移:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="c856" class="lf iw hh lb b fi lg lh l li lj">$ rake db:migrate</span></pre><p id="a81e" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">现在，我们已经有了在应用程序中使用活动存储的基本基础架构。我们需要告诉活动存储哪些存储位置是可用的:用类似下面的内容配置<em class="kq"> config/storage.yml </em>:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="dea7" class="lf iw hh lb b fi lg lh l li lj"># config/storage.yml</span><span id="d9dc" class="lf iw hh lb b fi lk lh l li lj">oci:<br/>  service: S3<br/>  access_key_id: &lt;%= ENV['OCI_KEY'] %&gt;<br/>  secret_access_key: &lt;%= ENV['OCI_SECRET'] %&gt;<br/>  bucket: myfile-&lt;%= Rails.env %&gt;<br/>  region: &lt;%= ENV['OCI_REGION'] %&gt;<br/>  endpoint: &lt;OCI S3 Compatibility API URL &gt;<br/>  force_path_style: true</span></pre><p id="1707" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">我将避免无休止地争论哪个更好(更安全):配置文件(当然是锁定的，不提交给回购)或环境变量。在这个例子中，我们将使用环境变量。不要担心这里使用的环境名称！你可以随意修改……你会知道怎么做的。</p><p id="457d" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">端点参数应该设置为正确的URL。参考<a class="ae it" href="https://docs.oracle.com/en-us/iaas/api/#/en/s3objectstorage/20160918/" rel="noopener ugc nofollow" target="_blank">文档</a>查看不同的<a class="ae it" href="https://docs.oracle.com/en-us/iaas/api/#/en/s3objectstorage/20160918/" rel="noopener ugc nofollow" target="_blank"> OCI S3兼容API端点</a>列表。您还需要获得您的OCI对象存储名称空间来完成API。上面的Terraform获取名称空间，但也可以通过OCI控制台、OCI CLI或其他方法获取。参见<a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/Object/Tasks/understandingnamespaces.htm" rel="noopener ugc nofollow" target="_blank"> OCI对象存储命名空间文档</a>了解更多关于如何使用OCI命名空间的信息。</p><p id="d1a8" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">这里有一个更好的端点解决方案(同样，这将放在<em class="kq"> config/storage.yml </em>)中:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="9c51" class="lf iw hh lb b fi lg lh l li lj"># config/storage.ym</span><span id="d007" class="lf iw hh lb b fi lk lh l li lj">oci:<br/>  service: S3<br/>  access_key_id: &lt;%= ENV['OCI_KEY'] %&gt;<br/>  secret_access_key: &lt;%= ENV['OCI_SECRET'] %&gt;<br/>  bucket: myfile-&lt;%= Rails.env %&gt;<br/>  region: &lt;%= ENV['OCI_REGION'] %&gt;<br/>  endpoint: https://&lt;%= ENV['OCI_NAMESPACE'] %&gt;.compat.objectstorage.&lt;%= ENV['OCI_REGION'] %&gt;.oraclecloud.com<br/>  force_path_style: true</span></pre><p id="8253" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">通过简单地提供两个以上的环境变量(或者这些可以是配置文件设置)，我们找到了一种方法，使我们可以轻松地在解决方案中使用不同的OCI地区，而不必更改端点URL。</p><p id="5e66" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">注意:<em class="kq"> force_path_style </em>参数必须设置为true，否则会出现如下错误:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="fc09" class="lf iw hh lb b fi lg lh l li lj">Aws::S3::Errors::MalformedXML (The XML you provided was not well-formed or did not validate against our published schema.):</span></pre><p id="e611" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">编辑<em class="kq">config/environments/development . Rb</em>并确保出现如下所示的行:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="f13b" class="lf iw hh lb b fi lg lh l li lj"># config/environments/development.rb</span><span id="4edf" class="lf iw hh lb b fi lk lh l li lj"># use OCI Object Storage for file storage<br/>config.active_storage.service = :oci</span></pre><p id="6a08" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">请注意，config.active_storage.service设置可能已经有一行了(我的设置为use :local)。</p><p id="af05" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">在我们开始之前，请注意我们如何将<em class="kq"> S3 </em>服务用于<em class="kq"> oci </em>存储服务？我们需要安装<em class="kq"> aws-sdk-s3 </em> gem来工作。现在让我们通过将以下内容添加到<em class="kq"> Gemfile </em>中来实现这一点:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="9c55" class="lf iw hh lb b fi lg lh l li lj"># Gemfile</span><span id="4518" class="lf iw hh lb b fi lk lh l li lj">gem "aws-sdk-s3", require: false</span></pre><p id="0584" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">(这是直接从<a class="ae it" href="https://guides.rubyonrails.org/active_storage_overview.html" rel="noopener ugc nofollow" target="_blank">活动存储文档</a>中复制的)</p><p id="84a1" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">让我们运行Bundler以确保所有的gem都准备好供我们使用:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="f3dd" class="lf iw hh lb b fi lg lh l li lj">$ bundle</span></pre><p id="0b1a" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">有了基本的“基础设施”(表、存储位置定义等。)现在，我们已经准备好迁移我们的应用程序，以使用活动存储(而不是我们自己的自制解决方案)。</p><h1 id="8183" class="iv iw hh bd iu ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">修订模型结构</h1><p id="ddd0" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">如果您看一下Active Storage为我们创建的迁移(使用<em class="kq">rails Active _ Storage:install</em>命令)，您会注意到<em class="kq"> active_storage_blobs </em>表中有几个字段与我们自己的<em class="kq"> things </em>表中的字段重复:<em class="kq"> filename </em>和<em class="kq"> content_type </em>。<em class="kq">active _ storage _ attachments</em>表具有<em class="kq"> blob </em>列，它存储实际的二进制文件数据。原来我们不再需要在<em class="kq"> things </em>表中为这些数据点拥有自己的列！让我们生成一个新的<a class="ae it" href="https://guides.rubyonrails.org/active_record_migrations.html" rel="noopener ugc nofollow" target="_blank">迁移</a>来去掉几个不需要的列:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="aaea" class="lf iw hh lb b fi lg lh l li lj">$ rails g migration RemoveThingsColumns</span></pre><p id="4ed8" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">您将在<em class="kq"> db/migrate </em>中找到该文件(它还会告诉您<em class="kq"> create </em>行中的路径)。继续修改您的代码，如下所示:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="2e58" class="lf iw hh lb b fi lg lh l li lj">class RemoveThingsColumns &lt; ActiveRecord::Migration[7.0]<br/>  def change<br/>    remove_column :things, :file_name, :string<br/>    remove_column :things, :content_type, :string<br/>    remove_column :things, :file_data, :binary<br/>    add_column :things, :document, :attachment<br/>  end<br/>end</span></pre><p id="0ca8" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">我们将从<em class="kq">事物</em>表中删除三列(<em class="kq">文件名</em>、<em class="kq">内容类型</em>和<em class="kq">文件数据</em>)，并添加一个新列(<em class="kq">附件</em>)，这将是我们与活动存储品质的链接！这意味着我们将有一个<em class="kq">事物</em>记录，它可以通过活动存储(即<em class="kq">:附件</em>类型)附加(和管理)一个<em class="kq">文档</em>。多棒啊。！我喜欢这个。通过运行以下命令来应用迁移:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="299d" class="lf iw hh lb b fi lg lh l li lj">$ rake db:migrate</span></pre><p id="ea39" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">现在，我们准备在应用程序中更新模型/控制器。首先，更新模型以建立一个<em class="kq">事物</em>和一个单独的<em class="kq">文档</em>之间的关系。修改<em class="kq"> app/models/thing.rb </em>如下所示:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="4a12" class="lf iw hh lb b fi lg lh l li lj"># app/models/thing.rb</span><span id="47c4" class="lf iw hh lb b fi lk lh l li lj">class Thing &lt; ApplicationRecord<br/>  has_one_attached :document<br/>end</span></pre><p id="3549" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">现在我们来编辑<em class="kq">app/controllers/things _ controller . Rb</em>。滚动到底部，在private下，从以下位置更新<em class="kq"> thing_params </em>方法:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="3d95" class="lf iw hh lb b fi lg lh l li lj"># app/controllers/things_controller.rb</span><span id="8e1b" class="lf iw hh lb b fi lk lh l li lj">    def thing_params<br/>      ret = params.require(:thing).permit(:description)<br/>      ret.merge( { file_data: params[:thing][:file_data].read, file_name: params[:thing][:file_data].original_filename, content_type: params[:thing][:file_data].content_type } )<br/>    end</span></pre><p id="d3a5" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">对此:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="585a" class="lf iw hh lb b fi lg lh l li lj"># app/controllers/things_controller.rb</span><span id="0592" class="lf iw hh lb b fi lk lh l li lj">    def thing_params<br/>      params.require(:thing).permit(:description, :document)<br/>    end</span></pre><p id="5cc0" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">在同一个控制器中，更改以下内容:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="355f" class="lf iw hh lb b fi lg lh l li lj"># app/controllers/things_controller.rb</span><span id="3a46" class="lf iw hh lb b fi lk lh l li lj">class ThingsController &lt; ApplicationController<br/>  before_action :set_thing, only: %i[ show edit update destroy download ]</span></pre><p id="f268" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">对此:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="1544" class="lf iw hh lb b fi lg lh l li lj"># app/controllers/things_controller.rb</span><span id="f9fe" class="lf iw hh lb b fi lk lh l li lj">class ThingsController &lt; ApplicationController<br/>  before_action :set_thing, only: %i[ show edit update destroy ]</span></pre><p id="7afc" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">并完全删除下载方法(不再需要它，因为活动存储已经为我们解决了这个问题！):</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="5f47" class="lf iw hh lb b fi lg lh l li lj"># app/controllers/things_controller.rb</span><span id="fbed" class="lf iw hh lb b fi lk lh l li lj">  def download<br/>    # credit to <a class="ae it" href="https://piotrmurach.com/articles/streaming-large-zip-files-in-rails/" rel="noopener ugc nofollow" target="_blank">https://piotrmurach.com/articles/streaming-large-zip-files-in-rails/</a> for the header to set<br/>    response.set_header('Content-Disposition', "attachment; filename=\"#{<a class="ae it" href="http://twitter.com/thing" rel="noopener ugc nofollow" target="_blank">@thing</a>.file_name}\"")<br/>    response.content_type = <a class="ae it" href="http://twitter.com/thing" rel="noopener ugc nofollow" target="_blank">@thing</a>.content_type<br/>    response.write(<a class="ae it" href="http://twitter.com/thing" rel="noopener ugc nofollow" target="_blank">@thing</a>.file_data)<br/>  end</span></pre><p id="6c50" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">删除<em class="kq">下载</em>的路径，编辑<em class="kq"> /config/routes.rb </em>，修改如下:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="e7c3" class="lf iw hh lb b fi lg lh l li lj"># config/routes.rb</span><span id="39e4" class="lf iw hh lb b fi lk lh l li lj">Rails.application.routes.draw do<br/>  resources :things do<br/>    get 'download', on: :member<br/>  end<br/>  # Define your application routes per the DSL in <a class="ae it" href="https://guides.rubyonrails.org/routing.html" rel="noopener ugc nofollow" target="_blank">https://guides.rubyonrails.org/routing.html</a></span><span id="b85c" class="lf iw hh lb b fi lk lh l li lj"># Defines the root path route ("/")<br/>  root "things#index"<br/>end</span></pre><p id="826b" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">对此:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="aae1" class="lf iw hh lb b fi lg lh l li lj"># config/routes.rb</span><span id="d18c" class="lf iw hh lb b fi lk lh l li lj">Rails.application.routes.draw do<br/>  resources :things<br/>  # Define your application routes per the DSL in <a class="ae it" href="https://guides.rubyonrails.org/routing.html" rel="noopener ugc nofollow" target="_blank">https://guides.rubyonrails.org/routing.html</a></span><span id="fab6" class="lf iw hh lb b fi lk lh l li lj"># Defines the root path route ("/")<br/>  root "things#index"<br/>end</span></pre><p id="352d" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">编辑(或创建，如果缺少的话)<em class="kq">config/initializers/active _ storage . Rb</em>，确保以下行存在:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="50ac" class="lf iw hh lb b fi lg lh l li lj"># config/initializers/active_storage.rb</span><span id="d726" class="lf iw hh lb b fi lk lh l li lj">Rails.application.config.active_storage.resolve_model_to_route = :rails_storage_proxy</span></pre><p id="e9a5" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">让我们继续更新不同的视图。修改<em class="kq">app/views/things/_ form . html . erb</em>，更改如下:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="57d8" class="lf iw hh lb b fi lg lh l li lj"># app/views/things/_form.html.erb</span><span id="8716" class="lf iw hh lb b fi lk lh l li lj">  &lt;div&gt;<br/>    &lt;%= form.label :file_data, style: "display: block" %&gt;<br/>    &lt;%= form.file_field :file_data %&gt;<br/>  &lt;/div&gt;</span></pre><p id="f369" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">对此:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="a43d" class="lf iw hh lb b fi lg lh l li lj"># app/views/things/_form.html.erb</span><span id="9481" class="lf iw hh lb b fi lk lh l li lj">  &lt;div&gt;<br/>    &lt;%= form.label "Document", style: "display: block" %&gt;<br/>    &lt;%= form.file_field :document %&gt;<br/>  &lt;/div&gt;</span></pre><p id="6e4d" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">继续并更改<em class="kq">app/views/things/_ thing . html . erb</em>如下:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="e5e3" class="lf iw hh lb b fi lg lh l li lj"># app/views/things/_thing.html.erb</span><span id="715f" class="lf iw hh lb b fi lk lh l li lj">&lt;div id="&lt;%= dom_id thing %&gt;"&gt;<br/>  &lt;p&gt;<br/>    &lt;strong&gt;File name:&lt;/strong&gt;<br/>    &lt;%= link_to thing.file_name, download_thing_path(thing) %&gt;<br/>  &lt;/p&gt;</span><span id="b0a6" class="lf iw hh lb b fi lk lh l li lj">&lt;p&gt;<br/>    &lt;strong&gt;Content type:&lt;/strong&gt;<br/>    &lt;%= thing.content_type %&gt;<br/>  &lt;/p&gt;</span><span id="0ecb" class="lf iw hh lb b fi lk lh l li lj">&lt;p&gt;<br/>    &lt;strong&gt;File data length (bytes):&lt;/strong&gt;<br/>    &lt;%= thing.file_data.length %&gt;<br/>  &lt;/p&gt;</span><span id="9fa2" class="lf iw hh lb b fi lk lh l li lj">&lt;p&gt;<br/>    &lt;strong&gt;Description:&lt;/strong&gt;<br/>    &lt;%= thing.description %&gt;<br/>  &lt;/p&gt;</span><span id="d674" class="lf iw hh lb b fi lk lh l li lj">&lt;/div&gt;</span></pre><p id="2f73" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">对此:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="dc0b" class="lf iw hh lb b fi lg lh l li lj"># app/views/things/_thing.html.erb</span><span id="d08c" class="lf iw hh lb b fi lk lh l li lj">&lt;div id="&lt;%= dom_id thing %&gt;"&gt;<br/>  &lt;% if thing.document.attached? %&gt;<br/>  &lt;p&gt;<br/>    &lt;strong&gt;File name:&lt;/strong&gt;<br/>    &lt;%= link_to thing.document.filename, rails_storage_proxy_path(thing.document) %&gt;<br/>  &lt;/p&gt;</span><span id="d187" class="lf iw hh lb b fi lk lh l li lj">&lt;p&gt;<br/>    &lt;strong&gt;Content type:&lt;/strong&gt;<br/>    &lt;%= thing.document.content_type %&gt;<br/>  &lt;/p&gt;</span><span id="ae0d" class="lf iw hh lb b fi lk lh l li lj">&lt;p&gt;<br/>    &lt;strong&gt;File data length (bytes):&lt;/strong&gt;<br/>    &lt;%= thing.document.byte_size %&gt;<br/>  &lt;/p&gt;<br/>  &lt;% else %&gt;<br/>  &lt;p&gt;No document is attached to this &lt;i&gt;thing&lt;/i&gt;.&lt;/p&gt;<br/>  &lt;% end %&gt;<br/>  <br/>  &lt;p&gt;<br/>    &lt;strong&gt;Description:&lt;/strong&gt;<br/>    &lt;%= thing.description %&gt;<br/>  &lt;/p&gt;</span><span id="608a" class="lf iw hh lb b fi lk lh l li lj">&lt;/div&gt;</span></pre><p id="ff49" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">记住，这不是关于<em class="kq">好的</em> Ruby/Rails代码，而是关于如何获得使用OCI对象存储的积极支持。为此，我走了一些捷径，最终在视图中嵌入了一些逻辑(糟糕，糟糕，糟糕)。由此产生的ERB模板相当混乱。我们真的应该使用类似于<a class="ae it" href="https://github.com/mustache/mustache" rel="noopener ugc nofollow" target="_blank">小胡子</a>的东西将模板和逻辑分开。我明白了。你明白了。同样，我们让事情变得非常简单:我不想给画面添加这种额外的“混乱”,而是将注意力放在手头的任务上:让活动存储使用OCI对象存储。</p><p id="dfea" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">我们现在已经准备好完成这件事了！用如下代码启动它(这适用于许多* nix shells):</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="fb31" class="lf iw hh lb b fi lg lh l li lj">$ export OCI_KEY=&lt;YOUR OCI KEY HERE&gt;<br/>$ export OCI_SECRET=&lt;YOUR OCI SECRET HERE&gt;<br/>$ export OCI_NAMESPACE=&lt;YOUR OCI NAMESPACE HERE&gt;<br/>$ export OCI_REGION=&lt;YOUR OCI REGION HERE&gt;</span></pre><p id="d77a" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">OCI地区需要成为它的地区标识符。查看<a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/General/Concepts/regions.htm" rel="noopener ugc nofollow" target="_blank"> OCI文档</a>中的地区和标识符列表，了解更多信息。然后你运行它:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="a8eb" class="lf iw hh lb b fi lg lh l li lj">$ rails s</span></pre><p id="7d84" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">出于某种原因，我在这一点上出现了一个错误。如果您遇到同样的问题“link_tree参数必须是一个目录”，我进入app/assets/config/manifest.js并删除了它所抱怨的令人不快的行。在我的例子中，下面一行是问题所在(我已经删除了):</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="7964" class="lf iw hh lb b fi lg lh l li lj">//= link_tree ../../../vendor/javascript .js</span></pre><p id="e9fa" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">从那时起，事情进展顺利。</p><h1 id="4c8c" class="iv iw hh bd iu ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">我们拥有的</h1><p id="5d24" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">活动存储为在我们的应用程序中处理文件提供了一个非常好的接口。在<em class="kq">文档</em>附件中有几种不同的方法。在轨道控制台中跟随自己(运行<em class="kq">轨道c </em>):</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="8130" class="lf iw hh lb b fi lg lh l li lj">t = Thing.last<br/># this will tell us whether or not a file is attached<br/>t.document.attached?<br/># here's how to get the file size<br/>t.document.byte_size<br/># self-explanatory<br/>t.document.filename.to_s<br/># again, no explanation needed here<br/>t.document.content_type</span></pre><p id="74eb" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">这只是可用属性中的一小部分。查看此处的<a class="ae it" href="https://api.rubyonrails.org/classes/ActiveStorage.html" rel="noopener ugc nofollow" target="_blank">和此处的</a>和<a class="ae it" href="https://www.rubydoc.info/gems/activestorage" rel="noopener ugc nofollow" target="_blank">以了解有关活动存储提供的一些优秀方法和属性的更多信息。</a></p><h1 id="8a3f" class="iv iw hh bd iu ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">清理</h1><p id="d9b1" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">这很有趣，对吧？！现在是时候收拾我们留下的烂摊子了。如果您试图删除<em class="kq">my file-development</em>bucket(或者您选择的任何名称)，您可能会遇到一个错误。这是因为要删除一个存储桶，它必须是空的。您可以遍历所有不同的对象并手动删除它们，但这真的很痛苦。在此过程中，我们不只是删除对象存储中的对象，而是继续保持本地数据库的整洁，完成后删除每件事的记录(和对象)。开始了…打开rails控制台(<em class="kq"> rails c </em>)，然后发出下面的命令(不要忘记确保首先设置好您的环境变量！):</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="c3df" class="lf iw hh lb b fi lg lh l li lj">Thing.all.each do |t|<br/>  t.document.purge<br/>  t.destroy<br/>end</span></pre><p id="1ba5" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">有人可能认为简单地调用<em class="kq"> Thing.destroy_all </em>就可以了，但我发现这有问题。上面几行彻底销毁了对象(一个接一个地“清除”)并销毁了本地SQLite3数据库中的记录(销毁了实际的“thing”资源)。</p><p id="2474" class="pw-post-body-paragraph js jt hh ju b jv kr jx jy jz ks kb kc kd kt kf kg kh ku kj kk kl kv kn ko kp ha bi translated">在这一点上，继续删除我们一直使用的OCI对象存储桶(<em class="kq"> myfile-development </em>)是安全的，因为它现在应该是空的。</p><h1 id="69de" class="iv iw hh bd iu ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">资源</h1><p id="0edd" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">这里有一些很棒的参考资料和资源，你可能会觉得有用(我找到了！):</p><ul class=""><li id="c150" class="ll lm hh ju b jv kr jz ks kd ln kh lo kl lp kp lq lr ls lt bi translated"><a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/Object/Tasks/s3compatibleapi.htm" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/en-us/iaas/Content/Object/Tasks/S3 compatibleapi . htm</a></li><li id="2719" class="ll lm hh ju b jv lu jz lv kd lw kh lx kl ly kp lq lr ls lt bi translated"><a class="ae it" href="https://docs.oracle.com/en-us/iaas/api/%23/en/s3objectstorage/20160918/" rel="noopener ugc nofollow" target="_blank">https://docs . Oracle . com/en-us/iaas/API/#/en/S3 objectstorage/2016 09 18/</a></li><li id="f5fa" class="ll lm hh ju b jv lu jz lv kd lw kh lx kl ly kp lq lr ls lt bi translated"><a class="ae it" href="https://registry.terraform.io/providers/hashicorp/oci/latest/docs/resources/objectstorage_bucket" rel="noopener ugc nofollow" target="_blank">https://registry . terra form . io/providers/hashi corp/OCI/latest/docs/resources/object storage _ bucket</a></li><li id="ad2e" class="ll lm hh ju b jv lu jz lv kd lw kh lx kl ly kp lq lr ls lt bi translated"><a class="ae it" href="https://www.oracle.com/cloud/storage/object-storage/faq/" rel="noopener ugc nofollow" target="_blank">https://www.oracle.com/cloud/storage/object-storage/faq/</a></li><li id="a172" class="ll lm hh ju b jv lu jz lv kd lw kh lx kl ly kp lq lr ls lt bi translated"><a class="ae it" href="https://guides.rubyonrails.org/active_record_migrations.html" rel="noopener ugc nofollow" target="_blank">https://guides . ruby on rails . org/active _ record _ migrations . html</a></li><li id="41a3" class="ll lm hh ju b jv lu jz lv kd lw kh lx kl ly kp lq lr ls lt bi translated"><a class="ae it" href="https://guides.rubyonrails.org/active_storage_overview.html" rel="noopener ugc nofollow" target="_blank">https://guides.rubyonrails.org/active_storage_overview.html</a></li><li id="c3d2" class="ll lm hh ju b jv lu jz lv kd lw kh lx kl ly kp lq lr ls lt bi translated"><a class="ae it" href="https://www.rubyguides.com/2019/01/ruby-environment-variables/" rel="noopener ugc nofollow" target="_blank">https://www . ruby guides . com/2019/01/ruby-environment-variables/</a></li><li id="88c8" class="ll lm hh ju b jv lu jz lv kd lw kh lx kl ly kp lq lr ls lt bi translated"><a class="ae it" href="https://www.rubydoc.info/gems/activestorage" rel="noopener ugc nofollow" target="_blank">https://www.rubydoc.info/gems/activestorage</a></li><li id="b71e" class="ll lm hh ju b jv lu jz lv kd lw kh lx kl ly kp lq lr ls lt bi translated"><a class="ae it" href="https://api.rubyonrails.org/classes/ActiveStorage.html" rel="noopener ugc nofollow" target="_blank">https://api.rubyonrails.org/classes/ActiveStorage.html</a></li></ul><h1 id="0e0d" class="iv iw hh bd iu ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">包装它</h1><p id="afcf" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">这是一次有趣的小旅程。主动存储正在蓬勃发展。碰巧的是，它与OCI对象存储<em class="kq">配合得非常好</em>！并不是说我有任何疑问，但是做一个快速演示，向您展示这种集成是多么容易，这很棒。希望你已经发现这至少有点有趣，如果没有帮助，参考。这对我来说是一个很好的练习，允许我记录一些特定的集成点。</p><h1 id="0f6b" class="iv iw hh bd iu ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">下一步是什么</h1><p id="4220" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">如果您已经在使用特定的gem(而不是活动存储)来处理文件附件，该怎么办？看看myfile如何与其他一些文件处理工具(而不是活动存储)一起工作不是很好吗？并不是说活动存储有什么问题…我认为它实际上真的很酷。但是，如果您已经有了一个最喜欢的处理附件的工具，并且希望继续使用(和OCI对象存储一起)，该怎么办呢？这是一个有趣的想法…请继续关注一些即将到来的迭代。直到下一次，保持位流。</p></div></div>    
</body>
</html>