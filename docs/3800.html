<html>
<head>
<title>Introduction to Google Cloud Armor - Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌云装甲介绍-第1部分</h1>
<blockquote>原文：<a href="https://medium.com/globant/introduction-to-google-cloud-armor-part-1-ddd76c7b9085?source=collection_archive---------2-----------------------#2021-12-23">https://medium.com/globant/introduction-to-google-cloud-armor-part-1-ddd76c7b9085?source=collection_archive---------2-----------------------#2021-12-23</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="a9a3" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">WAF和DDoS保护的政策和规则</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/d69164739469cc6d5bc77f7187ce7ca1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dQpfMo2xPEWZNQAK"/></div></div></figure><blockquote class="ji jj jk"><p id="cb6c" class="jl jm jn jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">这篇文章分为两部分。在第一篇文章中，你将了解Google Cloud Armor，它是什么，以及它如何使用策略和规则来保护你的应用程序。在第二场中，你将看到如何在GKE应用it目标和使用它。我们还将探究它生成的日志。</p></blockquote><p id="2857" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">为了更好地了解它的功能，请查看谷歌的<a class="ae ki" href="https://cloud.google.com/armor" rel="noopener ugc nofollow" target="_blank">官方概述</a>。同样，当你开始使用它并且对实现细节感到好奇时，请阅读<a class="ae ki" href="https://cloud.google.com/armor/docs/security-policy-overview" rel="noopener ugc nofollow" target="_blank">文档</a>，因为它提供了关于这个工具提供的所有功能的细节。</p><p id="7dcf" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">我的目标是让这个指南介于这两者之间，提供足够的细节来开始使用云甲，但不要让你厌烦那些不必要的信息。</p><h1 id="8f44" class="km kn hh bd ko kp kq kr ks kt ku kv kw in kx io ky iq kz ir la it lb iu lc ld bi translated">介绍</h1><p id="b9c0" class="pw-post-body-paragraph jl jm hh jo b jp le ii jr js lf il ju kj lg jx jy kk lh kb kc kl li kf kg kh ha bi translated">Cloud Armor是GCP的DDoS保护解决方案，这意味着它可以提供自动L3和L4 DDoS保护，而且能够提供第7层保护。前者是每一个主要的云提供商和web托管平台都具备的一种通用能力。但后者包括一些非常创新的功能，如速率限制、bot管理和自适应保护。</p><p id="c874" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">云甲也是一个Web应用防火墙，这意味着它可以识别和阻止常见的攻击类型(想想<a class="ae ki" href="https://owasp.org/www-project-top-ten/" rel="noopener ugc nofollow" target="_blank"> OWASP top 10 </a>)。它包含<a class="ae ki" href="https://cloud.google.com/armor/docs/rule-tuning" rel="noopener ugc nofollow" target="_blank">预配置的规则</a>，可以微调为子规则。因此，如果您愿意，您可以保护您的应用程序免受所有SQL注入攻击、常见的XSS入侵和一些会话固定攻击。</p><p id="4a56" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">您将创建适用于负载平衡器的策略。每个策略可以包含多个规则，您可以在其中指定要阻止的实际内容。<br/>您可以在这里<a class="ae ki" href="https://cloud.google.com/armor/pricing" rel="noopener ugc nofollow" target="_blank">查看最新的价格方案</a>关于政策、规则等影响因素。</p><h1 id="bac9" class="km kn hh bd ko kp kq kr ks kt ku kv kw in kx io ky iq kz ir la it lb iu lc ld bi translated">设置云甲</h1><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lj"><img src="../Images/2b59e747b1df94c60d1703c521c8a8be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OsdlmqiqbHfnFoFlPKYlsA.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx">Cloud Armor dashboard</figcaption></figure><p id="4e88" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">创建策略有多种方式:GCP仪表盘、gcloud甚至是Terraform。我们现在将集中讨论前两个。</p><p id="a5bc" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">首先打开GCP，在搜索栏中输入<em class="jn">云甲</em>。如果您以前从未使用过它，您将必须激活API(这不需要任何成本)。<br/>完成后，就该创建您的第一份保单了。</p><h2 id="685d" class="lo kn hh bd ko lp lq lr ks ls lt lu kw kj lv lw ky kk lx ly la kl lz ma lc mb bi translated">创建策略</h2><p id="40ad" class="pw-post-body-paragraph jl jm hh jo b jp le ii jr js lf il ju kj lg jx jy kk lh kb kc kl li kf kg kh ha bi translated">按下顶部的<em class="jn">创建策略</em>按钮，您将进入一个新屏幕:</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mc"><img src="../Images/4757899e5f776604dc998f6dcbb55673.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WHmp_5hT9S0VGfYRRdR8bA.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx">Create new policy from the UI</figcaption></figure><p id="b1b9" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">这里选择一个适合的名字(这是最难的部分)，因为你以后不能改变它。对于策略类型，您可以保留<em class="jn">后端安全策略</em>，因为它有更多的保护功能。<br/>默认规则指定默认情况下允许或阻止所有请求。这是很好的品味和具体情况。对于公共应用程序，我只想阻止几个IP或国家，我通常让<em class="jn">默认允许</em>。对于私人应用，我一般选择<em class="jn">拒绝。</em></p><p id="5970" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">您也可以选择<em class="jn">拒绝</em>动作的响应代码。同样，这是具体情况，但如果你想让用户知道该动作被禁止，你可以使用<strong class="jo hi"> 403 </strong>。如果你想给人留下他们寻找的资源并不存在的印象，你可以选择<strong class="jo hi"> 404 </strong>。还有502，我不用。</p><p id="93cd" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">这些是必填字段，您可以按下<em class="jn">创建策略</em>按钮，它就准备好了。但是您可以选择在这个屏幕中创建规则，也可以将其附加到负载平衡器。</p><p id="d40b" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">自适应保护是一项高级功能，但您仍可以将其作为预览打开。它会学习访问您站点的请求模式，并根据异常流量发出警报/建议补救措施。</p><p id="4af7" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">也可以使用<em class="jn"> gcloud </em>命令行实用程序创建策略:</p><pre class="ix iy iz ja fd md me mf mg aw mh bi"><span id="f352" class="lo kn hh me b fi mi mj l mk ml">gcloud compute security-policies create my-security-policy \<br/>--description "My awesome policy"</span></pre><h1 id="cca9" class="km kn hh bd ko kp kq kr ks kt ku kv kw in kx io ky iq kz ir la it lb iu lc ld bi translated">创建规则</h1><p id="83f5" class="pw-post-body-paragraph jl jm hh jo b jp le ii jr js lf il ju kj lg jx jy kk lh kb kc kl li kf kg kh ha bi translated">规则还有一个<em class="jn">允许</em>或<em class="jn">拒绝</em>动作，类似于策略基础规则，在基本场景中，如果基础规则是<em class="jn">允许</em>，那么其他规则将是<em class="jn">拒绝</em>，反之亦然。但是还有更复杂的情况，我们将在后面讨论一些细节。</p><p id="ce1e" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">现在，您可以单击add rule在该策略中创建您的第一个规则。基本模式很简单，你可以允许或阻止IP范围。因此，如果我想只允许我的IP地址，我会将基本规则设置为deny，并创建一个规则来允许我的IP地址(您可以通过调用<code class="du mm mn mo me b">curl ifconfig.me</code>来获得)。</p><p id="1b0c" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">如果<em class="jn">仅预览</em>被启用，则规则操作将仅被记录，而不会被实际执行。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mp"><img src="../Images/3baf446b59b431a0640f94cda32e88cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K2mu-4mHhEXbvfc-Scy2uQ.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx">Creating a new rule (overview on the right side)</figcaption></figure><p id="ff71" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">在高级模式下，您可以通过使用逻辑运算符、基于标题值的过滤或引用预配置的规则(WAF)来创建更复杂的规则。在<a class="ae ki" href="https://cloud.google.com/armor/docs/rules-language-reference" rel="noopener ugc nofollow" target="_blank">文档</a>中有很多例子。<br/>您还可以使用逻辑运算符，通过在一个规则中包含多个条件来降低一些成本。</p><p id="5b05" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">比方说，如果我们想要阻止来自中国和俄罗斯的所有请求(无意冒犯)以及用户代理包含<code class="du mm mn mo me b">curl</code>的请求，我们将创建如下内容:</p><pre class="ix iy iz ja fd md me mf mg aw mh bi"><span id="0f4d" class="lo kn hh me b fi mi mj l mk ml">'[CN, RU]'.contains(origin.region_code) || <!-- -->request.headers['user-agent'].contains('curl')</span></pre><h2 id="228d" class="lo kn hh bd ko lp lq lr ks ls lt lu kw kj lv lw ky kk lx ly la kl lz ma lc mb bi translated">WAF规则</h2><p id="9a98" class="pw-post-body-paragraph jl jm hh jo b jp le ii jr js lf il ju kj lg jx jy kk lh kb kc kl li kf kg kh ha bi translated">检查<a class="ae ki" href="https://cloud.google.com/armor/docs/rule-tuning" rel="noopener ugc nofollow" target="_blank">该页面</a>以查看关于可以过滤掉的漏洞类型的所有可能性。</p><p id="9761" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">为了阻止所有的SQL注入和跨站脚本攻击，我们将设置这个规则:<code class="du mm mn mo me b">evaluatePreconfiguredExpr('xss-stable') || evaluatePreconfiguredExpr('sqli-stable')</code>。</p><p id="9e19" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">我不建议在生产环境中马上这样做。这是其中一种情况，您可以打开<em class="jn">预览模式，</em>这样所有被这些规则阻止的请求都会被记录下来。之后，进行一些广泛的测试，如果您发现一些请求被阻止了，而这些请求通常是不应该被阻止的，那么您可以进行一些例外处理。</p><p id="f04a" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">假设你注意到<code class="du mm mn mo me b">owasp-crs-v030001-id942460-sqli</code>在测试中出现了很多次。如果您在这里查看表格<a class="ae ki" href="https://cloud.google.com/armor/docs/rule-tuning#sql_injection_sqli" rel="noopener ugc nofollow" target="_blank">，您会注意到这是一个3级灵敏度规则，表示更高的假阳性几率。所以我们想排除它。在这种情况下，我们可以这样使用规则:</a></p><pre class="ix iy iz ja fd md me mf mg aw mh bi"><span id="ff75" class="lo kn hh me b fi mi mj l mk ml">evaluatePreconfiguredExpr('sqli-stable', ['owasp-crs-v030001-id942460-sqli'])<!-- --> </span></pre><p id="fb49" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">函数的第二部分可以包含一个由逗号分隔的一个或多个元素组成的数组，在这里您可以指定您希望从一般规则中排除的所有签名。</p><p id="b2d5" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">在本系列的第二部分，我将向您展示一个脚本，它可以用来过滤日志中出现的唯一签名。</p><h2 id="0d97" class="lo kn hh bd ko lp lq lr ks ls lt lu kw kj lv lw ky kk lx ly la kl lz ma lc mb bi translated">Log4j</h2><p id="d1e0" class="pw-post-body-paragraph jl jm hh jo b jp le ii jr js lf il ju kj lg jx jy kk lh kb kc kl li kf kg kh ha bi translated">2021年12月，非常常用的<em class="jn"> log4j </em> Java库中出现了一个重大漏洞。它是如此关键(<em class="jn">CVSS</em>10分)并且容易被利用，以至于云装甲团队引入了一种新的表达方式来防止它。您可以通过添加以下规则来实现这一点:</p><pre class="ix iy iz ja fd md me mf mg aw mh bi"><span id="c196" class="lo kn hh me b fi mi mj l mk ml">evaluatePreconfiguredExpr('cve-canary')</span></pre><p id="cb9e" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">在他们的博客文章中找到更多关于这条规则和漏洞的信息。</p><h2 id="31c0" class="lo kn hh bd ko lp lq lr ks ls lt lu kw kj lv lw ky kk lx ly la kl lz ma lc mb bi translated">限速</h2><p id="05b0" class="pw-post-body-paragraph jl jm hh jo b jp le ii jr js lf il ju kj lg jx jy kk lh kb kc kl li kf kg kh ha bi translated">这是一个非常有用的L7保护功能，在撰写本文时仍在预览中(但工作得相当好)。目前这些规则只能从命令行创建，但是将来可能会得到UI支持。</p><p id="a2cb" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">这里有一个例子:</p><pre class="ix iy iz ja fd md me mf mg aw mh bi"><span id="3bf1" class="lo kn hh me b fi mi mj l mk ml">gcloud beta compute security-policies rules create 700 \<br/>--security-policy my-security-policy  \<br/>--src-ip-ranges="100.0.0.0/24"     \<br/>--action=throttle                \<br/>--rate-limit-threshold-count=100 \<br/>--rate-limit-threshold-interval-sec=60 \<br/>--conform-action=allow           \<br/>--exceed-action=deny-404         \<br/>--enforce-on-key=IP</span></pre><p id="dcb4" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">您通过规则的优先级(在上面的例子中是700)和它所应用的安全策略(<em class="jn"> my-security-policy </em>)来识别规则。</p><p id="14d8" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">动作可以是<em class="jn">油门</em>或<em class="jn">限速禁止</em>。该规则将计算来自每个特定IP地址(由<code class="du mm mn mo me b">enforce-on-key</code>定义)的请求数量，如果这些请求在最后的<code class="du mm mn mo me b">rate-limit-threshold-interval-sec</code> (60)秒内超过了由<code class="du mm mn mo me b">rate-limit-threshold-count</code> (100)指定的限制，那么下面的请求将被拒绝，并显示404状态代码(<code class="du mm mn mo me b">exceed-action</code>)。<br/>在<strong class="jo hi">节流</strong>的情况下，当请求数量再次低于时间间隔内允许的限制时，用户可以继续发出新的请求并得到响应。然而，使用<strong class="jo hi">基于费率的禁令</strong>、<strong class="jo hi">、</strong>您可以阻止他们在设定的时间内(例如10分钟)发出新的请求。</p><p id="0280" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">如果我们希望在预览中阻止来自美国的所有请求，如果它们在过去10分钟内超过100个请求，我们可以创建此规则:</p><pre class="ix iy iz ja fd md me mf mg aw mh bi"><span id="e8a9" class="lo kn hh me b fi mi mj l mk ml">gcloud beta compute security-policies rules create 825 \<br/>--security-policy <!-- -->my-security-policy <!-- -->\<br/>--expression "origin.region_code == 'US'" \<br/>--action=rate-based-ban \<br/>--ban-duration-sec=300 \<br/>--ban-threshold-count=100 \<br/>--ban-threshold-interval-sec=600 \<br/>--conform-action=allow \<br/>--exceed-action=deny-403 \<br/>--enforce-on-key=IP \<br/>--description "Ban US requests" \<br/>--preview</span></pre><p id="a782" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">禁令可以与限制结合起来创建复杂的规则。</p><p id="4d1e" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">要查看可以指定的所有可用选项，请在此处查看文档<a class="ae ki" href="https://cloud.google.com/sdk/gcloud/reference/beta/compute/security-policies/rules/create?hl=fr-CA" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="66cd" class="lo kn hh bd ko lp lq lr ks ls lt lu kw kj lv lw ky kk lx ly la kl lz ma lc mb bi translated">其他功能</h2><p id="41ac" class="pw-post-body-paragraph jl jm hh jo b jp le ii jr js lf il ju kj lg jx jy kk lh kb kc kl li kf kg kh ha bi translated">你可以使用<a class="ae ki" href="https://cloud.google.com/armor/docs/bot-management" rel="noopener ugc nofollow" target="_blank">机器人管理</a>向非人类访客提供reCAPTCHA挑战来阻止他们。如果你怀疑你的网站可能是网络抓取的对象，这是很有用的，常见的例子包括电子商务、新闻网站、工作论坛等。</p><p id="9c3e" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated"><a class="ae ki" href="https://cloud.google.com/armor/docs/adaptive-protection-overview" rel="noopener ugc nofollow" target="_blank">自适应保护</a>使用机器学习来检测流量中的异常。如果没有托管保护plus，您只会在发生异常情况时收到警报，而没有攻击签名或现成的规则可供快速部署。</p><p id="4c79" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">您可以使用<a class="ae ki" href="https://cloud.google.com/armor/docs/armor-named-ip#ip-list-providers" rel="noopener ugc nofollow" target="_blank">命名的IP列表</a>轻松允许来自几个CDN提供商的所有流量:<code class="du mm mn mo me b">evaluatePreconfiguredExpr(‘sourceiplist-cloudflare’)</code></p></div><div class="ab cl mq mr go ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ha hb hc hd he"><p id="a410" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">在第一篇文章中，我们熟悉了云装甲，介绍了策略和规则，并探索了现有的不同类型的规则和用例。</p><p id="a09d" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">在下一部分的<a class="ae ki" rel="noopener" href="/globant/introduction-to-google-cloud-armor-part-2-c3ff50739aa9">中，我们将从UI和Kubernetes配置中将这些规则应用于目标负载平衡器。之后，我们将探索日志记录，并使用脚本来过滤日志。</a></p></div></div>    
</body>
</html>