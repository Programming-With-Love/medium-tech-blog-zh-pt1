<html>
<head>
<title>How to: Using Jenkins to build container image and push to OCIR</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何:使用Jenkins构建容器映像并推送到OCIR</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/how-to-using-jenkins-to-build-container-image-and-push-to-ocir-c475f46b2a8d?source=collection_archive---------0-----------------------#2021-11-16">https://medium.com/oracledevs/how-to-using-jenkins-to-build-container-image-and-push-to-ocir-c475f46b2a8d?source=collection_archive---------0-----------------------#2021-11-16</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="c556" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我真正喜欢OCI的一点是它的开放性:对开发者的开放性，允许他们使用和接受完全不同的软件和解决方案，即使他们看起来对OCI自己的服务有竞争力。</p><p id="cafc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一个典型的例子是:极具竞争力的持续集成前景。OCI有了新的<a class="ae jd" href="https://docs.oracle.com/en-us/iaas/Content/devops/using/home.htm" rel="noopener ugc nofollow" target="_blank"> DevOps服务</a>。见鬼，我以前甚至写过关于使用<a class="ae jd" href="https://lmukadam.medium.com/running-continuous-integration-on-oke-with-tekton-353684c15730" rel="noopener"> Tekton </a>的文章。</p><p id="4e20" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是在本教程中，我们将看到如何使用Oracle Linux在OCI上部署<a class="ae jd" href="https://jenkins.io/" rel="noopener ugc nofollow" target="_blank"> Jenkins </a>来构建容器并推送到OCIR (OCI注册中心)。</p><p id="4ab3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下是我们将努力实现的概念性目标:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/4bf55c72072d9ecae0cfe35f80699a22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mos_Kx-TJ77kAmlt22IayA.png"/></div></div></figure><ol class=""><li id="ccc6" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb jv jw jx jy bi translated">开发人员将代码推送到git repo(在本例中是GitHub)</li><li id="e960" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">Jenkins检测到一个推动，并开始新的构建</li><li id="01db" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">在成功构建之后，Jenkins将新的容器映像推送到OCIR</li></ol><h2 id="f350" class="ke kf hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">安装Jenkins</h2><p id="b338" class="pw-post-body-paragraph ie if hh ig b ih kz ij ik il la in io ip lb ir is it lc iv iw ix ld iz ja jb ha bi translated">我们将从在私有子网中的计算实例上安装Jenkins开始。创建没有安全列表的专用子网，并创建分别具有以下出口和入口规则的NSG:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es le"><img src="../Images/1632aa0bac20bab795e46b204fe2dc53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fxd2lHqRPlQuBfUWAwMZeQ.png"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">NSG for Jenkins instance</figcaption></figure><p id="b859" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，通过选择Oracle Linux 8创建您的实例。确保您选择了正确的子网和NSG。记下私有IP地址，您可以使用堡垒主机通过ssh访问它:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="3a2f" class="ke kf hh lk b fi lo lp l lq lr">ssh -i ~/.ssh/id_rsa -J opc@11.22.33.44 opc@10.0.3.14</span></pre><p id="dd42" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，配置防火墙d:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="4d33" class="ke kf hh lk b fi lo lp l lq lr">sudo firewall-cmd --permanent --add-service=jenkins<br/>sudo firewall-cmd --reload</span></pre><p id="65e4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，您也可以使用terraform和cloud init来自动完成这项工作。在这种情况下，您需要运行“防火墙-脱机-cmd”并且不使用“永久”选项:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="af16" class="ke kf hh lk b fi lo lp l lq lr"># Configuring firewalld using cloud-init<br/>firewall-offline-cmd --add-service=jenkins</span></pre><p id="e7e7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，安装JDK</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="7412" class="ke kf hh lk b fi lo lp l lq lr">sudo dnf install -y java-11-openjdk.x86_64</span></pre><p id="1963" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">检查Java是否在您的路径中:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="2f19" class="ke kf hh lk b fi lo lp l lq lr">$ java -version</span><span id="87d5" class="ke kf hh lk b fi ls lp l lq lr">openjdk version "11.0.13" 2021-10-19 LTS<br/>OpenJDK Runtime Environment 18.9 (build 11.0.13+8-LTS)<br/>OpenJDK 64-Bit Server VM 18.9 (build 11.0.13+8-LTS, mixed mode, sharing)</span></pre><p id="fc5e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">安装Jenkins和git:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="05e9" class="ke kf hh lk b fi lo lp l lq lr">sudo wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins.io/redhat/jenkins.repo</span><span id="aa20" class="ke kf hh lk b fi ls lp l lq lr">sudo dnf config-manager --enable jenkins --enable ol8_developer_EPEL</span><span id="8b74" class="ke kf hh lk b fi ls lp l lq lr">sudo rpm --import http://pkg.jenkins.io/redhat/jenkins.io.key</span><span id="a995" class="ke kf hh lk b fi ls lp l lq lr">sudo dnf install -y jenkins git</span><span id="bb0e" class="ke kf hh lk b fi ls lp l lq lr">sudo systemctl enable jenkins &amp; sudo systemctl start jenkins</span></pre><h2 id="0719" class="ke kf hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">安装容器-工具</h2><p id="6b97" class="pw-post-body-paragraph ie if hh ig b ih kz ij ik il la in io ip lb ir is it lc iv iw ix ld iz ja jb ha bi translated">由于我们将构建容器，我们还需要安装必要的工具和守护进程。在Oracle Linux 7上，我们会安装docker-engine，但我们不再为OL 8构建docker-engine。相反，我们建议您使用install podman和相关实用程序:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="837b" class="ke kf hh lk b fi lo lp l lq lr">sudo dnf module install -y container-tools:ol8</span></pre><p id="3759" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这也将安装<a class="ae jd" href="https://buildah.io/" rel="noopener ugc nofollow" target="_blank"> buildah </a>和<a class="ae jd" href="https://github.com/containers/skopeo" rel="noopener ugc nofollow" target="_blank"> skopeo </a>。容器工具(podman，buildah，skopeo)对于Docker就像<a class="ae jd" href="https://www.imdb.com/title/tt0120611/" rel="noopener ugc nofollow" target="_blank">刀锋</a>对于吸血鬼一样:<a class="ae jd" href="https://www.youtube.com/watch?v=xdUlvsdgWQU&amp;t=26s" rel="noopener ugc nofollow" target="_blank">它的所有优点，没有它的缺点</a>。在这些优势中，重用和持续使用现有或新docker文件的能力最为突出。这为开发人员省去许多重写构建脚本的麻烦。</p><p id="eff2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">那些弱点呢？虽然Docker需要root访问权限来用Docker守护进程构建Docker映像，但buildah和podman都不需要。这意味着不再有突破容器进入底层主机的风险。</p><p id="f63d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">也就是说，旧的(或者坏的，或者两者都有)习惯很难改变，我仍然习惯使用Docker命令，可能还有其他命令:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="1553" class="ke kf hh lk b fi lo lp l lq lr">docker search<br/>docker build<br/>docker push<br/>....</span></pre><p id="c086" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此，虽然有<a class="ae jd" href="https://docs.podman.io/en/latest/Commands.html" rel="noopener ugc nofollow" target="_blank"> podman的等效</a>命令，我认为许多CI工具仍然希望能够运行docker命令。这就是波德曼-多克一揽子计划的救援之处。podman-docker软件包为podman提供了docker别名，省去了你不得不修改脚本或重新连接你的小脑的麻烦。让我们安装它:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="6007" class="ke kf hh lk b fi lo lp l lq lr">sudo dnf install -y podman-docker</span></pre><p id="dea5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，我们可以测试它:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="06eb" class="ke kf hh lk b fi lo lp l lq lr">docker</span><span id="aaa0" class="ke kf hh lk b fi ls lp l lq lr">Emulate Docker CLI using podman. Create /etc/containers/nodocker to quiet msg.<br/>Error: missing command 'podman COMMAND'<br/>Try 'podman --help' for more information.</span></pre><p id="db24" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">同样，如果我们搜索一幅图像:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="cef8" class="ke kf hh lk b fi lo lp l lq lr">docker search ubuntu</span><span id="b22c" class="ke kf hh lk b fi ls lp l lq lr">Emulate Docker CLI using podman. Create /etc/containers/nodocker to quiet msg.<br/>INDEX       NAME                                                               DESCRIPTION                                      STARS       OFFICIAL    AUTOMATED<br/>docker.io   docker.io/library/ubuntu                                           Ubuntu is a Debian-based Linux operating sys...  13130       [OK]<br/>...<br/>...</span></pre><h2 id="371f" class="ke kf hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">配置Jenkins</h2><p id="8762" class="pw-post-body-paragraph ie if hh ig b ih kz ij ik il la in io ip lb ir is it lc iv iw ix ld iz ja jb ha bi translated">我们现在必须配置詹金斯，安装插件等。启动与Jenkins的新终端会话以建立隧道:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="7551" class="ke kf hh lk b fi lo lp l lq lr">ssh -L 8080:localhost:8080 -i ~/.ssh/id_rsa -J opc@11.22.33.44 opc@10.0.3.14</span></pre><p id="81e7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用您的浏览器，访问位于<a class="ae jd" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>的Jenkins。您将被要求提供初始管理员密码:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lt"><img src="../Images/2c952dcf2baa9b71f2da5eb9a9602f17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bya1u-xfULVS34SSY01fTQ.png"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">Provide the initialAdminPassword</figcaption></figure><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="8e8b" class="ke kf hh lk b fi lo lp l lq lr">sudo cat /var/lib/jenkins/secrets/initialAdminPassword</span></pre><p id="182a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">复制并粘贴密码，然后单击“继续”按钮。接下来会要求您安装建议的插件:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lu"><img src="../Images/bfa4a6abf3f1116aac5b3789b6363f04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QHbw5iDMhPlEmsdb--Wdgw.png"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">Install suggested plugins</figcaption></figure><p id="b185" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">继续安装建议的插件:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lv"><img src="../Images/385c5bfd5dece84fa595ceab3795fbec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rYFB3KHUvmHsQ72pfyxhLQ.png"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">Installing the suggested plugins</figcaption></figure><p id="b3ea" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">选择“跳过并以管理员身份继续”，然后在实例配置页面上保存并完成。</p><p id="87e1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，我们需要安装几个Jenkins插件:</p><ul class=""><li id="aa2c" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb lw jw jx jy bi translated">点击“管理Jenkins”&gt;“管理插件”&gt;可用</li><li id="8496" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">使用搜索栏搜索“Docker”、“Docker Pipeline”、“GitHub Authentication”和“Blue Ocean Aggregator”插件</li><li id="0ca4" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">找到插件后选择它们</li><li id="3af4" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">单击“安装而不重新启动”</li></ul><p id="19d1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于jenkins将作为“Jenkins”用户运行，我们需要确保podman可以在<a class="ae jd" href="https://www.mankier.com/1/podman#Rootless_mode" rel="noopener ugc nofollow" target="_blank">无根模式</a>下运行:</p><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="4746" class="ke kf hh lk b fi lo lp l lq lr">sudo echo jenkins:10000:65536 &gt;&gt; /etc/subuid<br/>sudo echo jenkins:10000:65536 &gt;&gt; /etc/subgid</span></pre><h2 id="ab23" class="ke kf hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">配置OCIR凭据</h2><p id="125f" class="pw-post-body-paragraph ie if hh ig b ih kz ij ik il la in io ip lb ir is it lc iv iw ix ld iz ja jb ha bi translated">首先，我们需要在OCI做两件事:</p><ol class=""><li id="7acd" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb jv jw jx jy bi translated">创建用于登录的身份验证令牌</li><li id="9760" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">获取租用名称空间</li></ol><p id="47a2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们这样做:</p><ul class=""><li id="e38d" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb lw jw jx jy bi translated">登录OCI控制台，点击“个人资料”图标&gt;“用户设置”</li><li id="5cf1" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">点击“授权令牌”</li><li id="6cf7" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">点击“生成令牌”</li><li id="96df" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">点击“复制”并把它保存在某个安全的地方，就像一个密码管理器</li><li id="4729" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">再次单击“个人资料”图标&gt;“租赁”</li><li id="ea74" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">找到“对象存储命名空间”并记下它的值。这是</li></ul><p id="cc1c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">根据<a class="ae jd" rel="noopener" href="/@gustavo.guss/jenkins-building-docker-image-and-sending-to-registry-64b84ea45ee9">这篇文章</a>，我们现在可以为OCIR创建凭证:</p><ul class=""><li id="65d0" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb lw jw jx jy bi translated">点击“管理Jenkins”&gt;“管理凭证”</li><li id="3e91" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">点击“Jenkins”&gt;“全局凭证”&gt;“添加凭证”</li><li id="31a5" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">为种类选择“带密码的用户名”</li><li id="adc5" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">选择“全球…”对于范围</li><li id="acb5" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">如果您使用的是OCI本地用户，用户名将是<tenancy-namespace> / <username/></tenancy-namespace></li><li id="8d28" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">如果您使用的是IDCS用户，用户名将是<tenancy-namespace>/oracleidentitycloudservice/<username/></tenancy-namespace></li><li id="ab45" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">密码是您在创建身份验证令牌时获得的值</li><li id="03b8" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">输入“OCIR”作为ID</li></ul><p id="e3ef" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意，在上面，出于写作的目的，我使用了我自己的凭证。但是，我建议您:</p><ul class=""><li id="1b9d" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb lw jw jx jy bi translated">创建一个专门的Jenkins用户</li><li id="1d35" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">将Jenkins用户添加到组中</li><li id="b982" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">创建一个策略，给该组<a class="ae jd" href="https://docs.oracle.com/en-us/iaas/Content/Registry/Concepts/registrypolicyrepoaccess.htm#Policies_to_Control_Repository_Access" rel="noopener ugc nofollow" target="_blank">必要的和有限的特权</a>，这将允许它把图像推送到OCIR。</li></ul><h2 id="b71d" class="ke kf hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">在OCIR创建存储库</h2><p id="1940" class="pw-post-body-paragraph ie if hh ig b ih kz ij ik il la in io ip lb ir is it lc iv iw ix ld iz ja jb ha bi translated">接下来，我们需要在OCIR创建一个存储库。首先，让我们澄清一个常见的混淆:存储库是租户的名称空间和repo路径中的标记之间存在的一切。</p><p id="a865" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">假设我们对Acme Corp .有以下两个回购:</p><ul class=""><li id="8041" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb lw jw jx jy bi translated">租赁_名称空间/网站:1.0</li><li id="423d" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">tenance _ namespace/acme/blog:1.0</li></ul><p id="8b66" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第一个存储库是“网站”，而第二个存储库是“acme/blog”。换句话说，存储库包括图像的名称。其次，每个地区都有自己的URI。通常是在ocir.io前面加上<a class="ae jd" href="https://en.wikipedia.org/wiki/IATA_airport_code" rel="noopener ugc nofollow" target="_blank">地区的IATA代码</a>，例如伦敦是lon.ocir.io，悉尼是syd.ocir.io，圣何塞是sjc.ocir.io等等。</p><p id="b660" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们为acmewebsite创建一个。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lx"><img src="../Images/ecee7a4b15f2e16ef91c60d6886b47f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*66yvPeVWogplpYLqY8S-hg.png"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">Creating a repository</figcaption></figure><h2 id="74d6" class="ke kf hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">在詹金斯建立管道</h2><p id="6c92" class="pw-post-body-paragraph ie if hh ig b ih kz ij ik il la in io ip lb ir is it lc iv iw ix ld iz ja jb ha bi translated">我们要做的最后一件事是在Jenkins创建一个管道。我们希望将Jenkins指向GitHub repo，并执行一系列步骤，这些步骤将导致构建容器映像并将其推送到我们之前创建的存储库中。再说一次，我或多或少地关注了这个博客(帽尖)，并根据我们的需要对它进行了调整:</p><ul class=""><li id="3a82" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb lw jw jx jy bi translated">点击“新项目”</li><li id="1eae" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">输入名称，例如“acmewebsite”</li><li id="a981" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">检查GitHub项目并输入网址:<a class="ae jd" href="https://github.com/hyder/acmewebsite" rel="noopener ugc nofollow" target="_blank">https://github.com/hyder/acmewebsite</a></li><li id="5cca" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb lw jw jx jy bi translated">对于管道，选择管道脚本并输入以下内容:</li></ul><pre class="jf jg jh ji fd lj lk ll lm aw ln bi"><span id="14d0" class="ke kf hh lk b fi lo lp l lq lr">pipeline {<br/>    environment {<br/>        registry = "<strong class="lk hi">region_code</strong>.ocir.io/<strong class="lk hi">namespace</strong>/acmewebsite"<br/>        registryCredential = 'ocir'<br/>        dockerImage = ''<br/>    }<br/>    agent any<br/>    stages {<br/>        stage('SCM Checkout') {<br/>            steps {<br/>                git branch: 'master', url: '<a class="ae jd" href="https://github.com/lmukadam/acmewebsite.git'" rel="noopener ugc nofollow" target="_blank"><strong class="lk hi">https://github.com/hyder/acmewebsite.git</strong>'</a><br/>            }<br/>        }<br/>        stage('Building image') {<br/>            steps{<br/>                script {<br/>                    dockerImage = docker.build(registry + ":${BUILD_NUMBER}")<br/>                }<br/>            }<br/>        }<br/>        stage('Push to OCIR') {<br/>            steps {<br/>                script {<br/>                    docker.withRegistry( '<a class="ae jd" href="https://sin.ocir.io'" rel="noopener ugc nofollow" target="_blank">https://</a><strong class="lk hi">region_code</strong><a class="ae jd" href="https://sin.ocir.io'" rel="noopener ugc nofollow" target="_blank">.ocir.io'</a>, registryCredential ) {<br/>                    dockerImage.push()<br/>                    }<br/>                }<br/>            }<br/>        }<br/>        stage('Cleanup') {<br/>            steps{<br/>                sh "docker rmi $registry:$BUILD_NUMBER"<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="8fe1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">用适当的值替换上面的粗体字。请注意，我们在这里没有配置完整的管道；我们只想让Jenkins构建一个容器映像，并将其推送到OCIR。</p><p id="302a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">保存并点击立即构建。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ly"><img src="../Images/e4c6c02dad49f2dedc158f4a1d6f9395.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_o7iEZZsqkWekMPXNXsb9A.png"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">Building the image</figcaption></figure><p id="5a62" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你也可以打开蓝色海洋视图:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es le"><img src="../Images/4242a86353c5442e53b6abd125b03d2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oe_Ji6wxXKKRUuqWku3wdg.png"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">Blue Ocean view of Jenkins pipeline</figcaption></figure><p id="e377" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">导航回OCI控制台&gt;开发人员服务&gt;容器注册表。您现在应该能够看到OCIR的容器图像:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lz"><img src="../Images/7de3a7c83292adb5c30eac1b0709ad45.png" data-original-src="https://miro.medium.com/v2/resize:fit:630/format:webp/1*_XIExsi7hukreEH4fn0sow.png"/></div><figcaption class="lf lg et er es lh li bd b be z dx">Container image in OCIR</figcaption></figure><h2 id="492a" class="ke kf hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">结论</h2><p id="c585" class="pw-post-body-paragraph ie if hh ig b ih kz ij ik il la in io ip lb ir is it lc iv iw ix ld iz ja jb ha bi translated">在上面的例子中，我们使用了一个内嵌管道脚本。您还可以将管道存储在Jenkinsfile中，然后可以在GitHub repo中检查它。但是，您必须确保敏感变量(如租用名称空间和凭据)不会随代码一起签入。</p><p id="523d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们让Jenkins构建一个容器映像并将其推送到OCIR的练习到此结束。</p></div></div>    
</body>
</html>