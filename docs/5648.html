<html>
<head>
<title>Java Development with Autonomous Transaction Processing Dedicated (ATP-D)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">专用自主事务处理的Java开发(ATP-D)</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/java-development-with-autonomous-transaction-processing-dedicated-atp-d-f0355a2f9abd?source=collection_archive---------0-----------------------#2019-09-02">https://medium.com/oracledevs/java-development-with-autonomous-transaction-processing-dedicated-atp-d-f0355a2f9abd?source=collection_archive---------0-----------------------#2019-09-02</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="2d42" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Oracle Autonomous Transaction Processing Dedicated(<a class="ae jc" href="https://blogs.oracle.com/oracle-database/autonomous-database-dedicated-exadata-cloud-infrastructure" rel="noopener ugc nofollow" target="_blank">ATP-D</a>)是一种数据库云服务，支持在Oracle公共云中的专用数据库云服务器基础设施上实施私有数据库云服务。这篇博客文章的目标是帮助Java开发人员或架构师使用ATP-D构建和部署快速、可伸缩和可靠的Java应用程序，使用普通Java、Java Servlets或Java微服务，以及WebLogic、Helidon、WebSphere、Liberty、Tomcat、wildly(JBoss)、Spring等等。</p><p id="fc5d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我将向您介绍:(I)到ATP-D的先决条件和Java连接性；(ii)使用ATP-D的Java应用程序零停机时间；(iii)最后，使用ATP-D的Java应用程序的性能和可伸缩性。</p><p id="b763" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">虽然这个博客使用Linux命令行和脚本，但是即将到来的对<a class="ae jc" href="https://github.com/oracle/oci-toolkit-eclipse/releases" rel="noopener ugc nofollow" target="_blank">Oracle Cloud infra structure toolkit for Eclipse</a>的扩展将使体验对Java开发人员更加友好。</p><h1 id="ade7" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">先决条件和与ATP-D的Java连接</h1><p id="4a50" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">在Java中使用ATP-D需要以下步骤:</p><ul class=""><li id="4def" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">在<a class="ae jc" href="https://cloud.oracle.com/sign-in" rel="noopener ugc nofollow" target="_blank"> Oracle云基础设施</a>上提供ATP-D云服务实例，并填充您的数据库；看视频<a class="ae jc" href="https://cloud.oracle.com/en_US/atp/videos" rel="noopener ugc nofollow" target="_blank">这里</a>。</li><li id="9fcf" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">从云服务控制台获取客户端凭据；您将被要求提供保护钱包和信任商店的密码；在此处查看详情<a class="ae jc" href="https://www.oracle.com/technetwork/database/application-development/jdbc/documentation/atp-5073445.html" rel="noopener ugc nofollow" target="_blank">(特别是先决条件下的步骤#2)。</a></li><li id="e5c8" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">客户端凭证包的一部分,<em class="ku"> ojdbc.properties </em>属性文件已经预先配置好，可以使用Oracle Wallet简化与ATP-D的连接。</li></ul><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="5b93" class="le je hh la b fi lf lg l lh li">oracle.net.wallet_location=(SOURCE=(METHOD=FILE)(METHOD_DATA=(DIRECTORY=${TNS_ADMIN})))</span></pre><p id="26ea" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于使用JKS的连接，您需要如下编辑<em class="ku"> ojdbc.properties </em>文件</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="2893" class="le je hh la b fi lf lg l lh li">javax.net.ssl.trustStore=${TNS_ADMIN}/truststore.jks<br/>javax.net.ssl.trustStorePassword=....</span></pre><ul class=""><li id="51ae" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">ATP-D提供了五种支持TCP和TCP协议的预配置服务(推荐使用TCP)。</li></ul><figure class="kv kw kx ky fd lk er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lj"><img src="../Images/10de89693adaa083b2c7b32af59fe42a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TBglpDQfDykCj6VJqKhMeg.png"/></div></div><figcaption class="lr ls et er es lt lu bd b be z dx">Pre-configured ATP-D Services (must used the _tls equivalent)</figcaption></figure><ul class=""><li id="b647" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">从上面的列表中选择您的数据库服务名。这些类似于JNDI名字，并且隐藏/虚拟化数据库服务的细节；这些细节在<em class="ku"> tnsnames.ora </em>文件中(如下所示)，是客户端凭证的一部分。</li></ul><figure class="kv kw kx ky fd lk er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lv"><img src="../Images/c47048414d33b0562c9086e2512434df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eOsXt_Y1H94YqrmevKa17g.png"/></div></div></figure><ul class=""><li id="941a" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">虚拟化允许服务透明地从一个实例移动到另一个实例。您的ATP-D服务的名称由您选择的服务名组成(例如，<em class="ku"> tpurgent </em>),以您的数据库名为前缀，在我的例子中是“java”，后缀是“tls”。比如:<em class="ku"> java_tpurgent_tls </em>支持TCP，而<em class="ku"> java_tpurgent </em>虽然是有效的ATP-D实例名，但是只支持TCP，不推荐使用。</li><li id="6fa8" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">您的责任是编辑该文件并更改一些默认值(例如，<em class="ku"> RETRY_COUNT、RETRY_DELAY、CONNECT_TIMEOUT </em>)以满足您的特定需求。</li><li id="6357" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">直接在JDBC连接字符串中设置ATP-D服务名，或者将其导出并从环境变量中检索(我的偏好)。</li></ul><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="0e2c" class="le je hh la b fi lf lg l lh li">export url=jdbc:oracle:thin:@<strong class="la hi">java_tpurgent_tls</strong></span></pre><ul class=""><li id="9f7c" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">出于安全原因，您不能从本地运行的Java应用程序(例如，从您的笔记本电脑)直接连接到ATP-D；您需要在同一个虚拟云网络(也称为VCN)中配置一个计算实例，并从该计算实例中通过Java代码、客户端凭据和网络配置文件执行CI/CD工作。你需要一对(私人的，公共的)密钥来访问计算机；详见<a class="ae jc" href="https://docs.cloud.oracle.com/iaas/Content/Functions/Tasks/functionssetupapikey.htm" rel="noopener ugc nofollow" target="_blank">文档</a>。</li></ul><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="05ac" class="le je hh la b fi lf lg l lh li">ssh -i ~/ocikey opc@xxx.yyy.zzz.ttt</span></pre><ul class=""><li id="0b7e" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">获取最新的JDK8 (JDK8u163+)、JDK9、JDK10或JDK11</li><li id="7696" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">从<a class="ae jc" rel="noopener" href="/@kuassimensah/oracle-jdbc-drivers-on-maven-central-64fcf724d8b?source=your_stories_page---------------------------"> Maven Central </a>或者<a class="ae jc" href="https://blogs.oracle.com/dev2dev/get-oracle-jdbc-drivers-and-ucp-from-oracle-maven-repository-without-ides" rel="noopener ugc nofollow" target="_blank"> Oracle Maven repository </a>或者<a class="ae jc" href="https://www.oracle.com/technetwork/database/application-development/jdbc/downloads/jdbc-ucp-183-5013470.html" rel="noopener ugc nofollow" target="_blank"> JDBC下载页面</a> : <em class="ku"> ojdbc8.jar或者ojdbc10.jar </em>(取决于你的JDK)，<em class="ku"> ucp.jar，oraclepki.jar，osdt_core.jar，osdt_cert.jar，ons.jar，simplefan.jar</em><em class="ku">xdb . jar+xmlparserv 2 . jar</em>如果打算使用XML数据类型；以及<em class="ku"> orai18n.jar </em>如果需要处理民族语言。</li><li id="782d" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">将TNS_ADMIN环境变量设置到您提取客户机凭证的位置，可以在JDBC URL(DB 18c的新特性)中，或者作为环境变量，或者使用<em class="ku">Oracle . net . TNS _ ADMIN</em>Java系统属性；设置TNS_ADMIN这是驱动程序定位网络配置文件<em class="ku"> tnsnames.ora、</em>以及新的<em class="ku"> ojdbc.properties </em>文件等所必需的。</li></ul><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="1b35" class="le je hh la b fi lf lg l lh li">export TNS_ADMIN=/home/opc/credentials</span></pre><p id="0e7e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面是从Java代码中获取连接的代码片段；此片段使用的是通用连接池(UCP)数据源，而不是JDBC数据源。</p><figure class="kv kw kx ky fd lk"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="c54d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">JDBC数据源的等价物应该是(在<em class="ku">类路径</em>中不需要<em class="ku"> ucp.jar </em></p><figure class="kv kw kx ky fd lk er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es ly"><img src="../Images/fa5f5054355dc92af9444d332482e1c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zbzzfh8m1E7XjbJ_tT_XWg.png"/></div></div></figure><p id="2361" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">收集</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="8c62" class="le je hh la b fi lf lg l lh li">javac -classpath ./lib/ojdbc10.jar:./lib/ucp.jar:./lib/ons.jar UCP.java</span></pre><p id="3365" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用Oracle Wallet <br/>运行——Oracle . ons . Wallet file和<em class="ku">Oracle . ons . Wallet password</em>的设置作为JDK系统属性对所有数据源/连接都是全局的；可以替换为新的每个连接的属性<em class="ku">Oracle . JDBC . ons . wallet file</em>和<em class="ku">Oracle . JDBC . ons . wallet password</em><br/>——在<em class="ku">类路径</em>中使用<em class="ku"> oraclepki.jar、osdt_core.jar和osdt_cert.jar、</em>，以便使用oraclepki提供程序，而不是不支持所有PKCS12功能的SunJSSE提供程序。</p><figure class="kv kw kx ky fd lk er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lz"><img src="../Images/bf33b1e11bc9c9045bcf638d1eb70230.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jpn_Wn75FvC0MKlJVye4bQ.png"/></div></div></figure><p id="2a72" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用JKS运行<br/>注意<em class="ku"> trustStore.jks </em>文件的位置以及<em class="ku">trust store password</em>，这是您在下载客户端凭证时输入的密码(如上)。本例中的<em class="ku"> oraclepki.jar </em>由Oracle通知系统(ONS)使用(见后面)。</p><figure class="kv kw kx ky fd lk er es paragraph-image"><div class="er es ma"><img src="../Images/7a139495ebf0c889f276b28ec41cd756.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*JycFA_unOIm5kZyUEIW-ow.png"/></div></figure><h1 id="6422" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">使用ATP-D实现Java应用的零停机</h1><p id="4a04" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">面对计划内和/或计划外的数据库实例停机，如何实现Java应用程序的连续可用性？有了ATP-D，基础设施可以透明地处理大部分机制，以确保零停机时间。然而，作为Java开发人员/架构师，您只需负责很少的步骤。这是强调ATP-D服务、iow数据库和ATP-D实例(运行服务的RDBMS基础设施)之间差异的最佳位置。<br/>以下代码片段将打印运行ATP-D服务的实例名称。</p><figure class="kv kw kx ky fd lk er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mb"><img src="../Images/4766b0f7d924dde7a35dc575e0c15115.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cE1bx4pVH6tEeJ8rH6T4dw.png"/></div></div><figcaption class="lr ls et er es lt lu bd b be z dx"><strong class="bd jf">Where is my service running?</strong></figcaption></figure><h2 id="d942" class="le je hh bd jf mc md me jj mf mg mh jn ip mi mj jr it mk ml jv ix mm mn jz mo bi translated">ATP-D中的高可用性机制</h2><p id="cdbb" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">以下机制显然有助于零停机:快速应用程序通知事件、应用程序连续性和透明的应用程序连续性。</p><p id="f717" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ku">快速应用通知(FAN)事件</em> <br/>传统上，在数据库操作或尝试连接它的过程中，Java应用会在超时到期时收到一个异常；不幸的是，超时不是立即的和不可预测的。另一方面，快速应用程序通知(FAN)提供即时通知。风扇事件由以下数据库事件触发:</p><figure class="kv kw kx ky fd lk er es paragraph-image"><div class="er es mp"><img src="../Images/0e898f2ec8f70c542b0643f489640adf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*hdr_029panKKgknPq7AiRw.png"/></div><figcaption class="lr ls et er es lt lu bd b be z dx">Fast Application Notification (FAN) Events</figcaption></figure><p id="9915" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用ATP-D，Oracle通知系统(ONS)会自动启用并传送/交付FAN事件。作为Java开发人员/架构师，您的职责是:(I)在Java连接池(UCP)的<em class="ku">类路径</em>中为FAN订阅设置<em class="ku">ons . jar</em>；或者(ii)相反，如果不使用UCP，则由JDBC驱动程序为fan订阅在<em class="ku">类路径</em>中设置<em class="ku"> simplefan.jar </em>。<br/>在ATP-D环境中，通知系统(ONS)本身使用Oracle Wallet进行通信；您的职责是:<br/> (i)在您的Java代码中以系统属性(<em class="ku">-do racle . ons . wallet file =…-do racle . ons . wallet password =…</em>)或以JDBC连接/数据源属性(<em class="ku">Oracle . JDBC . ons . wallet file</em>，<em class="ku">Oracle . JDBC . ons . wallet password</em>)的形式指定钱包文件和钱包密码的位置；<br/> (ii)将<em class="ku"> oraclepki.jar </em>添加到<em class="ku"> classpath </em>中，无论您是使用JKS还是Oracle Wallet进行Java连接(这是ons所必需的)。</p><p id="1a82" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ku">应用连续性(AC) </em></p><p id="5bba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">应用程序连续性(AC)是RDBMS版本12.1中引入的一项成熟技术，它跨越了RDBMS及其客户端(驱动程序、连接池)。启用时，AC包括在驱动程序内存中记录应用程序工作单元(通常是事务)期间进行的所有数据库调用，并在隐藏异常后，在一个实例、主机或网络出现故障时，针对同一数据库的另一个实例重放这些调用。在重放时，如果结果是相同的(即，结果集校验和)，则AC是成功的，并且控制被交还给应用程序以继续，就像什么也没有发生一样；否则，异常将被重新转换，并在Java代码中可见。<br/>ATP-D基础设施可确保数据库服务的持续可用性，但是，如上所述，Java开发人员只需采取几个步骤，就能在计划内或计划外停机期间透明、持续地访问服务。<br/> AC建立在事务保护之上，它保证在<em class="ku"> COMMIT </em>或<em class="ku"> ROLLBACK </em>语句失败时——如果正在进行的事务的状态检查返回“不确定”,<em class="ku"> COMMIT或ROLLBACK </em>将永远不会完成，因此重放记录的调用是安全的。<br/> <br/>对于ATP-D，所有预配置服务默认启用AC。作为Java开发人员，您的职责是通过如下设置连接工厂来使用Oracle JDBC驱动程序的重放数据源</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="7a46" class="le je hh la b fi lf lg l lh li">pds.setConnectionFactoryClassName(“oracle.jdbc.replay.OracleDataSourceImpl”);</span></pre><p id="ac20" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">启用交流时，还需要考虑其他因素:</p><ul class=""><li id="0186" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">不使用Oracle UCP或Weblogic活动网格链接时，使用<em class="ku"> conn.beginRequest() </em>和<em class="ku"> conn.endRequest() </em>调用显式划分工作单元(也称为数据库请求)</li><li id="43d0" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">Java应用程序可能具有非事务性数据库状态，例如NLS设置、优化器首选项、事件设置、PL/SQL全局变量、临时表、高级队列、lob和结果缓存。简单的状态被恢复，但是许多其他的和复杂的状态，比如临时表或sys_context，将不会被AC恢复；作为Java开发人员，您有责任了解您的应用程序并实现“<a class="ae jc" href="https://docs.oracle.com/en/database/oracle/oracle-database/19/jjucp/application-continuity-using-ucp.html#GUID-83526888-0AA4-4112-B962-4057D64F192B" rel="noopener ugc nofollow" target="_blank"> UCP连接标记回调</a>”，以便在重放期间恢复AC未覆盖的状态。</li><li id="140c" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">如果您通常在检查池中的连接时设置初始自定义状态，AC基础结构将不会在重放期间重置这些状态；为此，实现<a class="ae jc" href="https://docs.oracle.com/en/database/oracle/oracle-database/19/jjdbc/application-continuity.html#GUID-715A5BE7-93F3-43CE-89E6-EA350AF6363D" rel="noopener ugc nofollow" target="_blank"> JDBC连接初始化回调</a>是您的责任。</li><li id="f55c" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">数据库可变函数，如<em class="ku"> SYSDATE，SYSTIMESTAMP，SYS_GUID </em>和<em class="ku"> sequence。NEXTVAL </em>返回与其原始调用不同的值，这使得重放无效。通过向数据库用户授予<em class="ku"> KEEP </em>特权，可以防止这些可变函数在重放期间返回不同的值。</li><li id="b253" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">从数据库内部调用外部系统的应用程序，如FTP callout(文件传输)、发送电子邮件等，会在重放过程中产生副作用。您可以通过在<em class="ku">Oracle . JDBC . replay . replayable connection</em>接口上使用<em class="ku"> disableReplay </em>调用来显式禁用重放，如下所示:</li></ul><figure class="kv kw kx ky fd lk er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mq"><img src="../Images/3270cecd416cd996389285c2cbe04cb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pe3ltsxMedMZ_R_J2f1qJQ.png"/></div></div></figure><ul class=""><li id="7425" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">AC基础设施支持作为具体类实现的传统Oracle JDBC类型，但是不支持少数类型，如<em class="ku"> oracle.sql.OPAQUE和oracle.sql.ANYDATA </em>(即，重放将不起作用)。</li></ul><p id="d769" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ku">透明应用连续性(TAC) </em></p><p id="d330" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Oracle数据库版本18c及相应的驱动程序和池中引入的透明应用程序连续性(TAC)是对应用程序连续性(AC)的增强。有了TAC，留给开发人员的大部分AC设置都得到透明的处理。<br/> (i) TAC具有能够恢复大多数会话状态的状态跟踪机制(<em class="ku">_ *，CLIENT_INFO，MODULE，ACTION，CLIENT_ID，ECONTEXT_* </em>)，对于复杂的会话状态，如临时表或sys_context，您需要恢复到AC并实现“JDBC连接初始化回调”或“UCP连接标记回调”。<br/> (ii)您不需要实现回调来恢复初始会话状态；可变的数据库函数被“保留”(即，在重放期间返回相同的值)。<br/> (iii)不使用Oracle pools (UCP、Weblogic Active GridLink)时，不需要明确划分工作单元(也称为数据库请求)，这些都是隐式标识的。<br/> (iv)不需要显式禁用副作用。(v)你不需要使用连接池，只需要普通的JDBC；但是，您仍然需要使用重放数据源。</p><p id="2145" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">TAC默认启用<em class="ku"> TPURGENT </em>和<em class="ku"> TP </em>服务(例如java_tpurgent_tls)。</p><p id="1adb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在让我们看看这些机制如何在计划内或计划外停机期间为您的Java应用程序提供零停机时间。</p><h2 id="20b4" class="le je hh bd jf mc md me jj mf mg mh jn ip mi mj jr it mk ml jv ix mm mn jz mo bi translated">维持计划内数据库停机</h2><p id="90da" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">目标是对Java应用程序隐藏运行ATP-D服务的实例的计划停机时间。<br/>在触发预定的计划维护操作(由车队管理员发起，有时应用户请求)时，连接池和驱动程序会发出并接收风扇“计划停机”事件。<br/>最简单也是最推荐的方法是将UCP与普通Java，或者Weblogic或者第三方Java容器一起使用；它停止分发到该ATP-D实例的连接，然后将后续请求重新路由到另一个主机或数据库容器，其中相同/相同的数据库服务已经被基础架构重新打开，这对您的Java应用程序是透明的。<br/>默认的drain_timeout大约为5分钟，使用<em class="ku"> TP和TPURGENT </em>服务(使用<em class="ku">高、中和低</em>服务最多1小时)允许在维护的目标实例上完成运行中的数据库操作。不能完成的长时间运行的操作或飞行中的工作单元，将在超时后被终止，并由AC/TAC重放。<br/>如果您没有使用UCP，而只是使用普通JDBC，ATP-D会标记连接/会话以进行排水；当调用下面描述的“<em class="ku">安全排出API</em>之一时，JDBC驱动程序关闭使用中的连接，以便允许这些连接被安全移除。</p><figure class="kv kw kx ky fd lk"><div class="bz dy l di"><div class="lw lx l"/></div><figcaption class="lr ls et er es lt lu bd b be z dx">Safe Draining APIs</figcaption></figure><p id="a0ad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Java容器和框架包括Tomcat、Weblogic、WebSphere、Liberty、Wildfly/JBoss、SpringBoot、Helidon可能有特定的连接验证选项，例如:<em class="ku"> PreTest Connection、TestConnectionOnReserve、TestOnBorrow </em>、check-valid-connection-sql —要在它们的数据源配置中指定。</p><p id="297f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">理由如下:调用这些API中的一个——这是Java开发人员的职责——向驱动程序表明Java应用程序已经准备好在调用结果为<em class="ku">假</em>的情况下做一些事情(即，完成工作单元、关闭连接对象等)；因此，终止连接是安全。</p><p id="7767" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在数据库从一个实例到另一个实例的透明转换过程中(平均来说与清空超时时间相同)，新的连接请求可能不会立即成功，您有责任在<em class="ku"> tnsnames.ora </em>文件中调整ATP-D服务条目的<em class="ku"> RETRY_COUNT、RETRY_DELAY和CONNECT_TIMEOUT </em>，正如在“<em class="ku">先决条件和到ATP-D的Java连接性</em>中已经讨论过的。</p><h2 id="74cc" class="le je hh bd jf mc md me jj mf mg mh jn ip mi mj jr it mk ml jv ix mm mn jz mo bi translated">持续计划外的数据库中断</h2><p id="3286" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">目标是对Java应用程序隐藏ATP-D实例的意外中断。<br/>当您的ATP-D实例出现故障时，会发出一个FAN“Down”事件，表明基础架构和一个相同的数据库已在另一个主机或容器数据库上预配。<br/> TAC或AC介入(即取得控制权)以:</p><ul class=""><li id="0a87" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">对应用程序隐藏SQL异常(假设这是一个可恢复的异常；详见<a class="ae jc" href="https://docs.oracle.com/en/database/oracle/oracle-database/19/jjdbc/jdbc-developers-guide.pdf" rel="noopener ugc nofollow" target="_blank"> JDBC文件</a>。</li><li id="a151" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">通过删除连接到失败实例的孤立连接来清理池。</li><li id="9bdd" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">创建到新实例(相同数据库)的临时连接；然后恢复由TAC/AC或用户回叫保留的会话状态。它还对可变函数的值进行了重新造型(使用AC显式地保持特权，或者使用TAC透明地保持特权)。</li><li id="c7a0" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">在后台调用事务保护(TG ),检查正在进行的工作是否已经提交(或回滚)。如果TG返回“不确定”,那么它会重放正在进行的工作单元的记录。</li><li id="7198" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">在重放时，如果结果与原始调用相同(即，结果集的校验和)，则TAC/AC成功，并且控制被交还给应用以继续；否则，异常将被重新转换，并在用户Java代码中可见。</li></ul><h2 id="5135" class="le je hh bd jf mc md me jj mf mg mh jn ip mi mj jr it mk ml jv ix mm mn jz mo bi translated">关于零停机时间的更多信息</h2><p id="9b3b" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">TAC/AC适用于大多数Java应用程序，但是可能会出现TAC/AC无法成功重放的情况。我们建议运行ORAchk实用程序，请参考<a class="ae jc" href="https://support.oracle.com/CSP/main/article?cmd=show&amp;type=NOT&amp;id=1268927.2" rel="noopener ugc nofollow" target="_blank">我的Oracle支持说明1268927.2 </a>。<br/>除了这篇博文，还有更多值得商榷的地方；请参见《Oracle数据库应用的<a class="ae jc" href="https://www.oracle.com/technetwork/database/options/clustering/applicationcontinuity/adb-continuousavailability-5169724.pdf" rel="noopener ugc nofollow" target="_blank"> MAA》白皮书，以及《Oracle JDBC文档》中的【Java应用连续性</a>章节了解更多详细信息。</p><h1 id="6581" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">使用ATP-D的Java应用程序的性能和可伸缩性</h1><p id="cbf8" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">使用ATP-D为您的Web应用程序获得最佳性能和可伸缩性包括:加速数据库连接、加速SQL语句处理、优化网络流量、就地处理和扩展Java工作负载。<br/>我在之前的<a class="ae jc" rel="noopener" href="/oracledevs/revisiting-java-applications-performance-scalability-with-rdbms-68d9f85466ca">博文</a>中详细讨论了这些以及相关的JDBC、UCP或OJVM特性。</p><p id="41ab" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">感谢阅读。</p></div></div>    
</body>
</html>