<html>
<head>
<title>Building a Serverless REST API in Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Go中构建无服务器REST API</h1>
<blockquote>原文：<a href="https://medium.com/capital-one-tech/building-a-serverless-rest-api-in-go-3ffcb549ef2?source=collection_archive---------2-----------------------#2017-01-12">https://medium.com/capital-one-tech/building-a-serverless-rest-api-in-go-3ffcb549ef2?source=collection_archive---------2-----------------------#2017-01-12</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/e13a6879d9351769e0f30d1046650d3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uSNgjOsmfDWPr1Ei17JrKg.jpeg"/></div></div></figure><p id="ad8a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">无服务器，或FaaS(功能即服务)，正在成为软件架构世界的一个重要趋势。在AWS re:Invent 2016 大会上，有超过40场会议计划讨论无服务器架构，而一年前还不到10场。正如<a class="ae jn" href="http://martinfowler.com/articles/serverless.html#benefits" rel="noopener ugc nofollow" target="_blank"> Mike Roberts </a>总结的那样，人们迅速采用无服务器架构的明显原因包括:</p><ul class=""><li id="101b" class="jo jp hh ir b is it iw ix ja jq je jr ji js jm jt ju jv jw bi translated">降低开发和运营成本</li><li id="7889" class="jo jp hh ir b is jx iw jy ja jz je ka ji kb jm jt ju jv jw bi translated">能够适应各种流量模式的自动扩展</li><li id="f8dc" class="jo jp hh ir b is jx iw jy ja jz je ka ji kb jm jt ju jv jw bi translated">更轻松的运营管理</li></ul><p id="17b0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">那么什么是无服务器架构呢？根据<a class="ae jn" href="https://www.thoughtworks.com/radar/techniques/serverless-architecture" rel="noopener ugc nofollow" target="_blank"> ThoughtWorks </a>、<em class="kc">的说法，“无服务器架构用短暂的计算能力取代了长期运行的虚拟机，这种计算能力根据请求而存在，并在使用后立即消失。”基于这个定义，REST APIs非常适合使用无服务器架构，因为任何正在运行的代码都需要是无状态的，而且执行速度非常快。</em></p><p id="50e2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在这篇文章中，我们将描述如何在Go (Golang)中开发一个无服务器的REST API。更具体地说，我们将展示如何在Go中开发REST API，将其部署为<a class="ae jn" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>函数，并最终通过<a class="ae jn" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank"> Amazon API Gateway </a>发布。</p><p id="8b98" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因为AWS Lambda本身不支持Go，我们将使用一个名为<a class="ae jn" href="http://apex.run/" rel="noopener ugc nofollow" target="_blank"> Apex </a>的框架来支持我们对语言的选择<em class="kc">(你可以使用自己选择的框架，甚至在这个实例中不使用框架)</em>。Apex通过为Amazon的服务器架构构建Go二进制文件(GOOS=linux GOARCH=amd64)并在Node.js Lambda函数的子进程中运行它来实现这一点。Apex还提供了各种与工作流相关的工具，用于构建、部署和测试Lambda函数、回滚部署、查看指标、跟踪日志等。我们将展示Apex如何简化大多数与Lambda相关的工作，并让我们专注于开发Go代码。</p><p id="03a0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="kc">提示:虽然Apex支持使用Go开发Lambda函数，但它也支持那些本地语言，包括Node.js、Python和Java。当使用本地语言开发Lambda函数时，你可能会考虑的另一个流行框架是</em> <a class="ae jn" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank"> <em class="kc">无服务器框架</em> </a> <em class="kc">。</em></p><h2 id="7638" class="kd ke hh bd kf kg kh ki kj kk kl km kn ja ko kp kq je kr ks kt ji ku kv kw kx bi translated">入门指南</h2><p id="76b7" class="pw-post-body-paragraph ip iq hh ir b is ky iu iv iw kz iy iz ja la jc jd je lb jg jh ji lc jk jl jm ha bi translated">首先，安装apex工具和相应的Go包，如下所示:</p><figure class="le lf lg lh fd ii er es paragraph-image"><div class="er es ld"><img src="../Images/9079e00dbb05be0142664dabc0acae20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/0*FJfuP8qiBdir0d-P."/></div></figure><p id="7c54" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然后按照<a class="ae jn" href="http://apex.run/#aws-credentials" rel="noopener ugc nofollow" target="_blank"> Apex文档</a>中的说明，设置使用Apex部署Lambda函数所需的AWS凭证。</p><h2 id="1dbc" class="kd ke hh bd kf kg kh ki kj kk kl km kn ja ko kp kq je kr ks kt ji ku kv kw kx bi translated">创建Lambda函数</h2><p id="6773" class="pw-post-body-paragraph ip iq hh ir b is ky iu iv iw kz iy iz ja la jc jd je lb jg jh ji lc jk jl jm ha bi translated"><em class="kc">提示:对于那些没有耐心的人，你可以查看我的golang-serverless-restapi开源项目的完整源代码。</em></p><p id="8cba" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">创建Go项目文件夹。根据Apex的要求，在项目文件夹下创建如下所示的文件夹结构。您也可以使用命令apex init来完成这项初始化工作。</p><figure class="le lf lg lh fd ii er es paragraph-image"><div class="er es li"><img src="../Images/b0fda0cd783c8c62220d18a76abb4639.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/0*8clmxpvHu0VcjYjU."/></div></figure><p id="ac65" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Apex项目可能有一个或多个Lambda函数，每个函数都被组织为functions文件夹的子文件夹。对于我们的演示项目，我们只需要一个名为API的Lambda函数。该函数通过名为project.json的项目级配置文件和名为function.json的特定于函数的配置文件进行配置。在这些文件中，我们指定参数，如内存限制、超时，Apex在将Lambda函数部署到AWS时会使用这些参数。</p><p id="4b15" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">project.json文件应该包含以下内容:</p><figure class="le lf lg lh fd ii er es paragraph-image"><div class="er es lj"><img src="../Images/1655d736d2b3c4ecacf1a8169556bbdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/0*Yvwox3VitsKE9jbz."/></div></figure><p id="4107" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">function.json文件可能包含:</p><figure class="le lf lg lh fd ii er es paragraph-image"><div class="er es lk"><img src="../Images/e0cee7b7528b4f9f27527210d4a802f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/0*p4PqR_Q4rBuibV4A."/></div></figure><p id="0ca4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">上面的配置文件读到项目命名为rest，名为apis的Lambda函数要保留128MB内存，运行时耗时不超过10秒。</p><p id="d0be" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">的。apexignore文件包含如下单行，通知Apex不应将任何Go源文件包含在部署分发中:</p><figure class="le lf lg lh fd ii er es paragraph-image"><div class="er es ll"><img src="../Images/f908287a5e7d4d57b7a34efaea4eda19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/0*k408pEYqG7DoOm8w."/></div></figure><p id="14df" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最后，main.go文件是go源文件，包含我们的REST API实现和与Apex框架的连接。</p><figure class="le lf lg lh fd ii er es paragraph-image"><div class="er es lm"><img src="../Images/f4c9e98bb8f41f24dccce074b672d2ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1318/0*lEWgv32UFHp1dsAf."/></div></figure><p id="b70e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在上面的代码中，我们首先创建了一个HTTP处理程序，它实现了<a class="ae jn" href="https://golang.org/pkg/net/http/#Handler" rel="noopener ugc nofollow" target="_blank"> http。Handler </a>接口，就像我们在开发REST API时通常做的那样。这个处理程序负责接受各种HTTP请求并相应地处理它们。虽然在这个例子中我们使用标准的http。ServerMux handler，如果您使用第三方HTTP路由框架，如Echo或Gin，您应该仍然可以使用，因为它们都应该提供一个处理程序。</p><p id="570d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们称之为顶点。HandleFunc注册一个每次调用Lambda时都会调用的函数。该函数有两个参数:</p><ul class=""><li id="01f5" class="jo jp hh ir b is it iw ix ja jq je jr ji js jm jt ju jv jw bi translated">第一个参数事件是一个JSON格式的字节数组，表示调用Lambda函数时使用的输入参数</li><li id="987b" class="jo jp hh ir b is jx iw jy ja jz je ka ji kb jm jt ju jv jw bi translated">第二个参数ctx包含函数调用的上下文信息(例如请求ID、函数名)。</li></ul><p id="2e08" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">该函数返回的数据将由Apex以JSON格式整理，并设置为Lambda的输出。可能会返回指示Lambda调用失败的错误。</p><p id="a4c7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在apex注册的函数内。HandleFunc，我们首先将Lambda事件解析成标准的<a class="ae jn" href="https://golang.org/pkg/net/http/#Request" rel="noopener ugc nofollow" target="_blank"> http。请求</a>。然后，我们调用HTTP处理程序的ServeHTTP方法来处理请求。<em class="kc">注意，我们使用了一个</em> <a class="ae jn" href="https://golang.org/pkg/net/http/httptest/#ResponseRecorder" rel="noopener ugc nofollow" target="_blank"> <em class="kc"> httptest。ResponseRecorder </em> </a> <em class="kc">记录处理程序的响应。</em>最后我们将响应转换成Lambda所期望的格式。</p><p id="a0f1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当Lambda函数与Amazon API Gateway挂钩时(稍后描述)，其输入和输出的格式可以描述为以下结构:</p><figure class="le lf lg lh fd ii er es paragraph-image"><div class="er es lk"><img src="../Images/8ece2b95e2d20a5786403bfb47d0eebd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/0*XxoCTHBn7smcV5CA."/></div></figure><p id="84fa" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">所以在前面描述的main函数中，ParseRequest函数应该将LambdaInput转换成http。请求，而FormatResponse转换httptest。ResponseRecorder到LambdaOutput，并format error从错误构建LambdaOutput。</p><p id="0009" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您已经有了一个想要转换成无服务器的REST API，这是您应该做的主要调整工作。</p><p id="2119" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">由于数据转换工作非常简单，我们在这里不会展示实现。如果你想了解更多，请在我的<a class="ae jn" href="https://github.com/qiangxue/golang-serverless-restapi" rel="noopener ugc nofollow" target="_blank">golang-server less-restapi</a>开源项目中找到完整的源代码。</p><h2 id="02fe" class="kd ke hh bd kf kg kh ki kj kk kl km kn ja ko kp kq je kr ks kt ji ku kv kw kx bi translated">部署Lambda函数</h2><p id="2995" class="pw-post-body-paragraph ip iq hh ir b is ky iu iv iw kz iy iz ja la jc jd je lb jg jh ji lc jk jl jm ha bi translated">在Apex的帮助下，部署Lambda函数就像运行一个命令一样简单，如下所示:</p><figure class="le lf lg lh fd ii er es paragraph-image"><div class="er es ln"><img src="../Images/68924e04b3e3ffe7044647fc738f0fdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/0*hbLggvnJwAhtSzE-."/></div></figure><p id="e6b3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">上面的命令将在functions文件夹下构建每个Lambda函数，并将它们部署到AWS区域us-east-1。我们可以多次运行同一个命令。如果Apex检测到二进制文件的任何更改，它将创建新版本，并将其命名为最新版本。</p><p id="f45d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们可以使用Apex或通过AWS控制台测试部署的Lambda。例如:</p><figure class="le lf lg lh fd ii er es paragraph-image"><div class="er es lo"><img src="../Images/75fa003a6a18fb6dc092e040c873a9e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/0*R5IQHAbwYKhoD4pQ."/></div></figure><h2 id="f54a" class="kd ke hh bd kf kg kh ki kj kk kl km kn ja ko kp kq je kr ks kt ji ku kv kw kx bi translated">配置Amazon API网关</h2><p id="0106" class="pw-post-body-paragraph ip iq hh ir b is ky iu iv iw kz iy iz ja la jc jd je lb jg jh ji lc jk jl jm ha bi translated">尽管我们已经在AWS上部署了Lambda功能，但它目前还不能被互联网用户访问。我们需要使用Amazon API Gateway将来自互联网用户的HTTP请求委托给Lambda函数。为了实现这个目标，我们将利用Amazon API Gateway的代理特性。</p><p id="43d5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">采取以下步骤来配置Amazon API Gateway:</p><ol class=""><li id="da4f" class="jo jp hh ir b is it iw ix ja jq je jr ji js jm lp ju jv jw bi translated">登录AWS控制台并切换到API网关页面。在该页面上，选择“Create new API”并输入API名称“hello”(或者您喜欢的任何其他名称)。</li><li id="7c08" class="jo jp hh ir b is jx iw jy ja jz je ka ji kb jm lp ju jv jw bi translated">在“hello”API的“Resources”选项卡中，单击“Actions”下拉按钮并选择“Create Resource”。在“新建子资源”页面中，选择“配置为代理资源”，然后单击“创建资源”按钮。见下面截图作为参考。</li></ol><figure class="le lf lg lh fd ii er es paragraph-image"><div class="er es lq"><img src="../Images/5f131b40420d7848074f9c0b80b152e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:886/0*0BY1Z71RQD3-9W1Z."/></div></figure><ol class=""><li id="f99c" class="jo jp hh ir b is it iw ix ja jq je jr ji js jm lp ju jv jw bi translated">在“/{proxy+} — ANY — Setup”页面中，选择“Lambda Region”作为us-east-1(或您用来部署Lambda函数的实际AWS区域)，并输入“Lambda函数”名称作为rest_apis。单击“保存”按钮完成代理资源设置。见下面截图作为参考。</li></ol><figure class="le lf lg lh fd ii er es paragraph-image"><div class="er es lq"><img src="../Images/12eb4f8dc07f2e72e7ec52d0d3b933f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:886/0*ytGmsdItPZjsX9Xd."/></div></figure><ol class=""><li id="16a7" class="jo jp hh ir b is it iw ix ja jq je jr ji js jm lp ju jv jw bi translated">单击“操作”下拉按钮，然后选择“部署API”。在弹出窗口中，在“部署阶段”下拉列表中选择[新阶段]，并在“阶段名称”输入字段中输入prod。单击“部署”按钮完成部署。</li><li id="4f95" class="jo jp hh ir b is jx iw jy ja jz je ka ji kb jm lp ju jv jw bi translated">此时，您应该被重定向到一个页面，该页面显示了关于“hello”API的部署信息。你应该在页面上看到一个类似于<a class="ae jn" href="https://xxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod." rel="noopener ugc nofollow" target="_blank">https://xxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod.</a>的“调用URL ”,这是一个根URL，每个人都可以用它来访问我们的REST API。</li></ol><p id="d12a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您更喜欢使用AWS CLI，也可以运行以下命令来实现上述步骤:</p><figure class="le lf lg lh fd ii er es paragraph-image"><div class="er es lr"><img src="../Images/463c9a7d20775f67eb665bf231f9926e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/0*6hBOPK2-Z8LEr-hr."/></div></figure><figure class="le lf lg lh fd ii er es paragraph-image"><div class="er es ls"><img src="../Images/31606085ef6578e165691bcf2650dcd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/0*MiTieE4oiuhnjifb."/></div></figure><h2 id="d37d" class="kd ke hh bd kf kg kh ki kj kk kl km kn ja ko kp kq je kr ks kt ji ku kv kw kx bi translated">尝试一下</h2><p id="4087" class="pw-post-body-paragraph ip iq hh ir b is ky iu iv iw kz iy iz ja la jc jd je lb jg jh ji lc jk jl jm ha bi translated">运行以下命令来验证REST API是否可访问并按预期工作:</p><figure class="le lf lg lh fd ii er es paragraph-image"><div class="er es lt"><img src="../Images/31edf190a702ced2bb0df542c39e2aeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/0*r-hm5l1Wmuaf9pkn."/></div></figure><p id="7e0d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在AWS控制台中，找到名为rest_apis的Lambda函数，并检查其监控结果，以验证Lambda确实被调用了。</p><p id="ca5a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最后，记住我们的REST API的默认根URL不是用户友好的。Amazon API Gateway允许我们设置一个自定义域名(例如api.example.com ),这样URL看起来更简单、更直观。有关如何实现这一目标的更多信息，请参阅AWS文档。</p><h2 id="6197" class="kd ke hh bd kf kg kh ki kj kk kl km kn ja ko kp kq je kr ks kt ji ku kv kw kx bi translated">最终注释</h2><p id="9ea4" class="pw-post-body-paragraph ip iq hh ir b is ky iu iv iw kz iy iz ja la jc jd je lb jg jh ji lc jk jl jm ha bi translated">在上面，我们已经展示了如何从头开始开发一个无服务器REST API。然而，同样的过程也可以用来将现有的REST API转换成无服务器的。要做到这一点，唯一需要的改变是修改NewHTTPHandler函数，以使用现有的HTTP路由代码。</p><p id="9764" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">亚马逊API网关的代理功能非常容易使用。然而，使用它也意味着我们不能利用网关提供的许多其他高级功能；包括认证、错误处理、速率限制等。对于现有的REST API来说，这可能不是问题，因为这些特性很可能已经在API层实现了。如果您正在开发一个REST API，您可能想要考虑网关的更高级的用法。但是，要注意的是，网关的配置不是一项简单的任务，尤其是当API处于频繁变化的活跃开发阶段时。</p><p id="9e33" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="kc">最初发表于</em><a class="ae jn" href="https://developer.capitalone.com/blog-post/building-a-serverless-rest-api-in-go/" rel="noopener ugc nofollow" target="_blank">T5【developer.capitalone.com】</a><em class="kc">。</em></p></div><div class="ab cl lu lv go lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ha hb hc hd he"><p id="3926" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要了解更多关于Capital One的API、开源、社区活动和开发人员文化的信息，请访问我们的一站式开发人员门户网站DevExchange。<a class="ae jn" href="https://developer.capitalone.com/" rel="noopener ugc nofollow" target="_blank"><em class="kc"/></a></p></div></div>    
</body>
</html>