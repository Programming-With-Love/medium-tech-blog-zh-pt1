<html>
<head>
<title>Caviar iOS: Migrating from AdvancedCollectionView to PJFDataSource</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Caviar iOS:从AdvancedCollectionView迁移到PJFDataSource</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/caviar-ios-migrating-from-advancedcollectionview-to-pjfdatasource-81f8c2e4fcdf?source=collection_archive---------1-----------------------#2016-06-13">https://medium.com/square-corner-blog/caviar-ios-migrating-from-advancedcollectionview-to-pjfdatasource-81f8c2e4fcdf?source=collection_archive---------1-----------------------#2016-06-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="d6e5" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">幕后看看PJFDataSource在我们的Caviar iOS应用程序中的演变。</h2></div><p id="8424" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="js">由</em> <a class="jt ju ge" href="https://medium.com/u/8ce6b756010b?source=post_page-----81f8c2e4fcdf--------------------------------" rel="noopener" target="_blank">撰写<em class="js">迈克尔索尔</em> </a> <em class="js">。</em></p><blockquote class="jv"><p id="d1dd" class="jw jx hh bd jy jz ka kb kc kd ke jr dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae kf" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><p id="2fdf" class="pw-post-body-paragraph iw ix hh iy b iz kg ii jb jc kh il je jf ki jh ji jj kj jl jm jn kk jp jq jr ha bi translated">2014年12月，我们发布了我们的iOS应用程序的第一个版本，用于我们的高品质餐厅外卖服务<a class="ae kf" href="https://www.trycaviar.com/" rel="noopener ugc nofollow" target="_blank"> Caviar </a>。该应用的视图控制器架构在很大程度上基于苹果2014年WWDC演讲中提出的框架:<a class="ae kf" href="https://developer.apple.com/videos/play/wwdc2014/232/" rel="noopener ugc nofollow" target="_blank">带有集合视图的高级用户界面</a>和附带的样本代码。对于我们的应用程序来说，这是一个很好的起点，但我们最终对它感到失望，原因我将在下面详述。</p><p id="2837" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在考虑了多种方法后，我们决定构建一个小型库，重新实现我们最重视的AdvancedCollectionView的功能，同时省去我们不需要的任何复杂性。为了推动我们构建一个与Caviar应用程序联系不太紧密的通用库，我们从一开始就将它构建为一个外部库。我们已经成功地使用了6个多月，并决定将它作为PJFDataSource向公众开放源代码。</p><p id="9191" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在本帖中，我们将看看PJFDataSource的创建过程:作为我们早期应用程序架构中AdvancedCollectionView示例代码的替代。如果你想一头扎进去，请前往我们的<a class="ae kf" href="https://github.com/square/PJFDataSource" rel="noopener ugc nofollow" target="_blank"> GitHub页面</a>。</p><h1 id="a6db" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">一个好的起点</h1><p id="613f" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">Caviar的iOS应用架构基于苹果的AdvancedCollectionView样本代码是一个很好的起点，尽管我们最终会遇到一些问题。它提供了一种在整个应用程序中加载数据和显示内容的一致方法，并推动我们走向许多最佳实践。</p><p id="957e" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最重要的是，AdvancedCollectionView帮助我们避免了创建<a class="ae kf" href="https://www.youtube.com/watch?v=dgOdsh1Bq10" rel="noopener ugc nofollow" target="_blank">大规模视图控制器</a>，这是一个常见的iOS应用程序架构陷阱(为此<a class="ae kf" href="https://www.objc.io/issues/1-view-controllers/lighter-view-controllers/" rel="noopener ugc nofollow" target="_blank">那里</a> <a class="ae kf" href="https://www.objc.io/issues/13-architecture/mvvm/" rel="noopener ugc nofollow" target="_blank">是</a> <a class="ae kf" href="https://corner.squareup.com/2015/12/ziggurat-ios-app-architecture.html" rel="noopener ugc nofollow" target="_blank">许多</a> <a class="ae kf" rel="noopener" href="/ios-os-x-development/ios-architecture-patterns-ecba4c38de52#.vl27g5oi3">好的</a> <a class="ae kf" href="http://khanlou.com/2014/09/8-patterns-to-help-you-destroy-massive-view-controller/" rel="noopener ugc nofollow" target="_blank">解决方案</a>)。它主要是通过要求每一部分内容都有一个数据源对象，与视图控制器本身分开。这些数据源对象是您的内容视图的模型。在这个实现中，这些对象还负责加载它们的内容——这是另一项职责，可能会以不太规范的方式在视图控制器中结束。</p><p id="7617" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这些数据源甚至可以像构建块一样组合成一个“聚合数据源”，鼓励创建更小的组件数据源。这允许在应用程序的不同部分重复使用相同组件的代码。例如，您添加到购物车中的食品列表和历史收据上的食品列表可以共享这些组件数据源中的一个，因为它们只是在不同的上下文中表示相同的内容。</p><p id="fc3e" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">AdvancedCollectionView还提供了显示加载、无内容和错误状态的一致方法。它通过将数据源对象与显示内容的UICollectionView紧密耦合来实现，并在适当的时候添加补充的占位符视图。虽然起初并不明显，但这成为了我们最喜欢的AdvancedCollectionView的“特性”之一，并在PJFDataSource的形成中发挥了很大的作用。</p><h1 id="c4f5" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">问题…和解决方案</h1><p id="c869" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">随着我们走过Caviar for iOS的最初版本，并开始进入一个定期的功能构建和错误修复发布周期，我们开始认识到大量使用AdvancedCollectionView的一些缺点。这些都是相互关联的，但是我将围绕灵活性、稳定性和社区这三个主题来讨论它们。</p><h1 id="505f" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">灵活性</h1><p id="5a93" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">正如您可能已经从名称中猜到的那样，AdvancedCollectionView需要使用UICollectionView。你可能听说过这句谚语“如果你只有一把锤子，那么所有的东西看起来都像钉子”。对我们来说，UICollectionView就是我们的锤子，尽管它并不总是最适合这项工作的工具。这种缺乏灵活性在几个方面打击了我们。</p><p id="ad52" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">一个简单、具体的例子来自主屏幕，这里Caviar列出了所有你可以订购的餐馆。在我们更大的市场中，可能有数百家餐厅，每个餐厅都有一个高度可变的单元格，具体取决于相关的元数据。传统上，集合视图和表格视图需要确定每个单元格的大小，以便计算它自己的内容大小。对于大量内容，这可能会很慢，并对用户体验产生负面影响。对于UITableViews，苹果公司增加了table view:estimatedheightforrowatdinexpath:，这是针对这个问题的一个优雅的解决方案。当时在我们的集合视图布局中没有类似的东西，我们被迫实现我们自己的快速视图调整和缓存——这是我们希望避免的复杂性。</p><p id="cd3b" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">更一般地说，在Caviar应用程序中几乎处处使用UICollectionViews简直是矫枉过正。几乎所有的屏幕都可以使用UITableView更简单地实现。有些甚至可以用基于UIStackView的布局来实现(为了与iOS 8兼容，用<a class="ae kf" href="https://github.com/oarrabi/OAStackView" rel="noopener ugc nofollow" target="_blank"> OAStackView </a>)，甚至可以用基于UIView的手动布局来实现。</p><p id="c82e" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这种体验是我们决定PJFDataSource应该是视图不可知的，让应用程序提供自己的内容视图的主要原因。PJFDataSource没有与集合视图紧密耦合，而是提供了一个“内容包装器视图”，它将显示您提供的内容视图，或者用于处理加载、无内容和错误状态的各种占位符之一。</p><p id="b8f7" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在今天的Caviar应用程序中，我们尝试使用最适合的工具。主屏幕现在是一个UITableView视图，利用自动单元格大小和使用估计的高度来提高速度。菜单视图使用了UICollectionVIew，在这里我们以<a class="ae kf" href="https://github.com/chiahsien/CHTCollectionViewWaterfallLayout" rel="noopener ugc nofollow" target="_blank">瀑布布局</a>展示了令人垂涎的餐馆所有食物的照片。Account视图的内容有限，它使用的是ui stack view——这是我目前最喜欢的工具之一。</p><h1 id="9e29" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">稳定性</h1><p id="8a9e" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">一旦Caviar应用程序公开发布，使用它的用户数量比我们内部测试组的用户数量多了几个数量级，我们发现一些神秘的“一次性”崩溃根本不是“一次性”的。相反，它们是我们数据源堆栈中某处崩溃错误的早期警告信号。</p><p id="a63c" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">一旦我们意识到这一点，我们就深入挖掘，找到并解决潜在的问题。根据Crashlytics的测量，我们设定的目标是<strong class="iy hi"> 99.9% </strong> <a class="ae kf" href="https://docs.fabric.io/ios/answers/answers-metrics.html#crash-free-users" rel="noopener ugc nofollow" target="_blank">无崩溃用户</a>。我们增加了<a class="ae kf" href="https://docs.fabric.io/ios/crashlytics/enhanced-reports.html#custom-logs" rel="noopener ugc nofollow" target="_blank"> Crashlytics日志</a>来支持野外撞车后更好的法医调查。我们编写自动化测试来对有问题的领域进行压力测试。我们学到了很多关于UICollectionView的常见<a class="ae kf" href="http://stackoverflow.com/questions/13904049/assertion-failure-in-uicollectionviewdata-indexpathforitematglobalindex" rel="noopener ugc nofollow" target="_blank">bug</a>和/或<a class="ae kf" href="http://stackoverflow.com/questions/12611292/uicollectionview-assertion-failure?lq=1" rel="noopener ugc nofollow" target="_blank">误用</a>的知识。我们修复了几个问题，降低了我们的崩溃率。但是我们不能解决所有的问题，我们也不能把事故率降到我们的目标。</p><p id="75bb" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这些神秘的不速之客是我们最终决定放弃AdvancedCollectionView并创建PJFDataSource的主要驱动力。我们将达到崩溃率目标作为迁移的首要目标。我们逐步进行工程设计和推广，优先考虑受这些崩溃影响最大的应用程序。</p><p id="6d26" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我们来看看2015年下半年的一些真实数据:</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div class="er es li"><img src="../Images/f9569755dc8a4c92299c50b9f162aabe.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/0*1m27b27Gho6t45qK.png"/></div></figure><p id="50d6" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如您所见，我们开始时的无崩溃用户率约为97.5%。这意味着使用我们的应用程序的客户在任何一天都有大约2.5%的机会看到崩溃。<em class="js">哎哟。</em></p><p id="fb64" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在最初的几个月里，我们做了一些渐进的改进(和回归)。在我们9月中旬的更新中，我们发布了第一个部分推出的PJFDataSource版本。我们马上看到了巨大的改进，然后随着我们更新应用程序的更多部分以及我们的客户升级到最新版本，我们会继续改进。在今年的最后6周，我们终于实现了99.9%的无事故目标，并一直保持到今天。</p><p id="1aea" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我强烈建议为你的崩盘率设定一个积极的目标，并迅速修正任何导致你跌破的回归。这确保了在你的崩溃报告中有很强的信噪比，使得回归很容易被发现和修复。它还可以帮助您更快地注意到崩溃，而最近更改的代码仍然记忆犹新。</p><h1 id="a49f" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">社区</h1><p id="9bcf" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">回顾过去，AdvancedCollectionView的一个我们最初低估的问题是缺乏社区对它的支持。在GitHub上没有一个规范的主页可以让你和作者或者其他用户互动。没有人计划修复臭虫。当新版本的iOS或Xcode发布时，没有人进行兼容性修复。当我们撞到墙上时，没有任何专家可以依靠。</p><p id="46ee" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">所有这些从一开始就很清楚，并且是从WWDC获得一个6000线样本项目并在此基础上发展所固有的——我们只是低估了长期成本。这一经历让我更欣赏iOS生态系统中存在的许多充满活力的社区。</p><h1 id="19f5" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">递增量</h1><p id="000b" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">值得重申的是，这种变化是如何渐进的，因为我认为这是一个很好的例子，说明了如何在一个运输应用程序中考虑和执行主要的架构变化:</p><p id="b4c4" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi"> 1。识别问题</strong></p><ul class=""><li id="13df" class="lq lr hh iy b iz ja jc jd jf ls jj lt jn lu jr lv lw lx ly bi translated">对我们来说，两个主要问题是不速之客和在任何地方使用UICollectionViews的不灵活性/复杂性。</li><li id="28a0" class="lq lr hh iy b iz lz jc ma jf mb jj mc jn md jr lv lw lx ly bi translated">还有人担心AdvancedCollectionView的长期所有权，但我们可以咬紧牙关，自己真正“拥有”它，从而解决这个问题。</li><li id="e670" class="lq lr hh iy b iz lz jc ma jf mb jj mc jn md jr lv lw lx ly bi translated">我们还确定了我们真正喜欢的作品，并希望结转到任何潜在的替代品中。</li></ul><p id="f0d8" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi"> 2 .寻找更小的改动来解决</strong></p><ul class=""><li id="f5fa" class="lq lr hh iy b iz ja jc jd jf ls jj lt jn lu jr lv lw lx ly bi translated">我们花了相当长的时间试图找到一两个解决重大事故的良方。只有在发现了多个问题、进行了修复并且只看到了增量改进之后，我们才决定这可能值得进行更大的体系结构更改。</li></ul><p id="e0e1" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi"> 3 .拿出计划和目标</strong></p><ul class=""><li id="1754" class="lq lr hh iy b iz ja jc jd jf ls jj lt jn lu jr lv lw lx ly bi translated">很早的时候，我们就确立了99.9%无崩溃用户的目标。</li><li id="ba90" class="lq lr hh iy b iz lz jc ma jf mb jj mc jn md jr lv lw lx ly bi translated">更宽松地说，我们也知道我们希望在选择内容视图时有更大的灵活性，尤其是随着iOS的发展和新工具的添加(例如UIStackView)。</li></ul><p id="f8ba" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi"> 4 .增量设计和推广</strong></p><ul class=""><li id="6c7a" class="lq lr hh iy b iz ja jc jd jf ls jj lt jn lu jr lv lw lx ly bi translated">我们<em class="js">本可以</em>在一段时间内专注于此，重写应用程序中的所有视图控制器，并在一次大爆炸中发货。也许它会奏效，但更有可能的是，我们错过了一些东西，并在此过程中导致了一些重大倒退。</li><li id="c72c" class="lq lr hh iy b iz lz jc ma jf mb jj mc jn md jr lv lw lx ly bi translated">相反，我们在逐个屏幕的基础上有条不紊地向PJFDataSource迁移(按预期影响排序)。我们定期向客户发货，发现小问题，并不断改进。因为这是一个“慢烧”类型的项目，我们能够继续在新特性上取得进展，同时修复其他领域的小错误。</li></ul><p id="d7ae" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi"> 5。评估</strong></p><ul class=""><li id="72ca" class="lq lr hh iy b iz ja jc jd jf ls jj lt jn lu jr lv lw lx ly bi translated">增加稳定性，增加灵活性，降低复杂性。成功！</li></ul><h1 id="4dde" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">结论</h1><p id="9be1" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">希望这篇关于PJFDataSource的创建和发展的背景故事在您下次评估潜在的依赖或考虑重大重构时会对您有所帮助。</p><p id="ef98" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果它看起来像是你自己可能想要使用的东西，请前往我们的<a class="ae kf" href="https://github.com/square/PJFDataSource" rel="noopener ugc nofollow" target="_blank"> GitHub页面</a>。</p></div><div class="ab cl me mf go mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ha hb hc hd he"><p id="9595" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="js"> Square的iOS工程团队邀请你参加我们的闪电对话之夜，并在WWDC期间与你的iOS工程师同事一起享用食物和饮料。6月14日星期二，欢迎加入我们的SF包厢——下午5:30开门。RSVP </em> <a class="ae kf" href="https://squareioseng.splashthat.com/" rel="noopener ugc nofollow" target="_blank"> <em class="js">此处</em> </a> <em class="js">保留您的位置！</em></p></div><div class="ab cl me mf go mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ha hb hc hd he"><div class="lj lk ll lm fd ml"><a rel="noopener follow" target="_blank" href="/@mthole"><div class="mm ab dw"><div class="mn ab mo cl cj mp"><h2 class="bd hi fi z dy mq ea eb mr ed ef hg bi translated">迈克尔·索尔-简介</h2><div class="ms l"><h3 class="bd b fi z dy mq ea eb mr ed ef dx translated">工程经理@广场。前.我喜欢建造重要的产品。</h3></div><div class="mt l"><p class="bd b fp z dy mq ea eb mr ed ef dx translated">medium.com</p></div></div><div class="mu l"><div class="mv l mw mx my mu mz lo ml"/></div></div></a></div></div></div>    
</body>
</html>