<html>
<head>
<title>How to Create an Execution Plan for Oracle Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何为Oracle数据库创建执行计划</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/how-to-create-an-execution-plan-oracle-all-things-sql-blog-b3aa9dc7144c?source=collection_archive---------0-----------------------#2016-03-22">https://medium.com/oracledevs/how-to-create-an-execution-plan-oracle-all-things-sql-blog-b3aa9dc7144c?source=collection_archive---------0-----------------------#2016-03-22</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="ed4f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当你试图让SQL运行得更快时，有一样东西是至关重要的:执行计划。在本帖中，我们将探讨创建这些的四种方法:</p><ul class=""><li id="b038" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><a class="ae jl" href="https://blogs.oracle.com/sql/how-to-create-an-execution-plan#autotrace" rel="noopener ugc nofollow" target="_blank">自动跟踪</a></li><li id="4277" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated"><a class="ae jl" href="https://blogs.oracle.com/sql/how-to-create-an-execution-plan#sqlmonitor" rel="noopener ugc nofollow" target="_blank"> SQL监视器</a></li><li id="e2f2" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated"><a class="ae jl" href="https://blogs.oracle.com/sql/how-to-create-an-execution-plan#tkprof" rel="noopener ugc nofollow" target="_blank"> TKPROF </a></li><li id="7194" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated"><a class="ae jl" href="https://blogs.oracle.com/sql/how-to-create-an-execution-plan#dbmsxplan" rel="noopener ugc nofollow" target="_blank"> DBMS_XPlan </a></li></ul><p id="f45c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但在我们开始之前，让我们先回答这个问题:</p><h1 id="fff0" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">什么是执行计划？</h1><p id="7037" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">SQL语句的计划是一组指令。这告诉数据库如何访问数据并将其连接在一起。</p><p id="710c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">计划有两种类型:</p><p id="9bbc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这些听起来差不多。但它们是不同的。要理解为什么要考虑这个例子。</p><p id="3bbf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你在做一次汽车旅行。你事先计划好了。这是你期望走的路线。</p><p id="e8d0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是就在你准备离开的时候，你听到新闻说在你选择的路线上发生了一起事故。这样会让它慢很多。所以你走了一条不同的路。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es ku"><img src="../Images/e53c895899a431a66df72b25ebc72828.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*fqKFb57e3z7nUNWI.png"/></div></figure><p id="a990" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里有两条路线。你期望拿走的和你实际拿走的。</p><p id="b562" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">到达目的地后，你想知道自己是否能更快地完成旅程。要弄清楚这一点，你需要看看你去了哪里。不是你计划去的地方。</p><p id="d3fa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一个解释计划<em class="lc">预测了</em>Oracle将如何处理您的查询。</p><p id="f75e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">执行计划描述了<em class="lc">实际采取的步骤</em>。</p><p id="5bae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">就像上面的驾驶示例一样，Oracle可能会使用不同于其预测的路线。正如<a class="ae jl" href="http://tkyte.blogspot.co.uk/2007/04/when-explanation-doesn-sound-quite.html" rel="noopener ugc nofollow" target="_blank"> Tom Kyte所讨论的</a>，这种情况的发生有几个原因。因此，要诊断您的查询，您需要知道Oracle做了什么。不是它猜测它可能做的事！</p><h1 id="d19a" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">边注</h1><p id="cdb8" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">“解释计划”听起来很像“执行计划”。这可能会导致混乱。很多时候，当我要求人们提供一个执行计划时，他们提供的是一种解释。</p><p id="433f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我想如果我们给这些非常不同的名字会更好。例如，将执行计划称为“描述的路径”或类似的东西。这将有助于提醒人们这些是不同的东西(尽管它们看起来很相似)，并减少混淆的机会。</p><p id="7aeb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">提示:如果有人问你要“计划”，他们通常是在寻找一种执行方式。即实际发生了什么。</p><p id="2df2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">那么清楚了这一点，你如何着手收集它们呢？</p><h1 id="09e4" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">电气液压靠模仿型铣床</h1><p id="9428" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">首先，autotrace。这是一个免费的工具。您可以在SQL*Plus中使用“set autotrace”命令启用它。</p><p id="df24" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">启用此选项后，Oracle会在每次查询后显示其输出。下面是该计划及其性能统计数据:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es ku"><img src="../Images/9661dae6e5bab6355c6309386e2d5f41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*MsQXlOEVnI9nQPja.png"/></div></figure><p id="8a8f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您的查询返回数百或数千行，您必须等待Oracle显示所有行。这可能是一种痛苦。</p><p id="125c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">幸运的是，您可以使用trace[only]选项隐藏结果。您也可以选择只显示计划或统计数据。例如，要隐藏查询输出并仅显示统计信息，请使用:</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="c8fa" class="li js hh le b fi lj lk l ll lm">set autotrace trace stat</span></pre><p id="88f3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要包括输出和计划，请输入</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="64e9" class="li js hh le b fi lj lk l ll lm">set autotrace on exp</span></pre><p id="9ffa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">完成后，您可以通过以下方式将其关闭:</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="ef15" class="li js hh le b fi lj lk l ll lm">set autotrace off</span></pre><p id="01f5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">虽然使用SQL*Plus比什么都不用要好，但它有几个限制:</p><ul class=""><li id="01a6" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">它没有显示统计数据(输出行数、缓冲区获取数等。)对于计划中的每一步</li><li id="ee3c" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">它使用解释计划，所以您看到的可能不是Oracle所做的！</li></ul><p id="db98" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此，虽然它对空中快速手指很有用，但还有更好的版本可用。</p><p id="0d7d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">比如:</p><h1 id="159c" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">SQL Developer中的Autotrace</h1><p id="8182" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">这比SQL*Plus版本更上一层楼。它显示了计划中每一步的统计数据。因此，对于每个操作，您可以看到以下指标:</p><ul class=""><li id="8be6" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">使用了多少缓冲区</li><li id="d197" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">跑了多长时间</li><li id="19b3" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">它进行了多少次磁盘读写</li></ul><p id="34e6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这使得找出消耗最多资源的点变得容易得多。</p><p id="013a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要了解如何配置和运行它，请观看此视频:</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="c846" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">除了一步一步的分解，<a class="ae jl" href="http://www.oracle.com/sqldeveloper" rel="noopener ugc nofollow" target="_blank"> SQL Developer </a>中的autotrace比SQL*Plus更有优势。其中包括:</p><ul class=""><li id="1328" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">您可以展开和折叠部分计划。这使得更容易看到发生了什么</li><li id="67dd" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">您可以比较执行计划。当你试图找出两个大计划之间的差异时，这是一个绝妙的工具。</li></ul><p id="13e5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是SQL*Plus版本的一大进步。所以从现在开始，当我提到autotrace时，我指的是SQL Developer版本。</p><p id="2d90" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一句简短的警告。默认情况下，SQL Developer只根据“<a class="ae jl" href="http://www.thatjeffsmith.com/archive/2014/09/30-sql-developer-tips-in-30-days-day-7-the-array-fetch-size-preference/" rel="noopener ugc nofollow" target="_blank"> SQL数组提取大小</a>”参数提取行数。对于返回大量行的查询，这可能会错过大量工作。确保将其设置为“<a class="ae jl" href="http://www.thatjeffsmith.com/archive/2013/07/explain-plan-and-autotrace-enhancements-in-oracle-sql-developer-4/" rel="noopener ugc nofollow" target="_blank">获取所有行</a>”。</p><p id="1bec" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在优化查询时，您通常希望保存计划以供以后参考或与其他人共享。为此，右键单击该计划，您将获得一个“导出HTML”选项:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="er es lp"><img src="../Images/a8cc1a8cf3c3a8ab8b460ea2f14c72b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/0*hiPJAuMLsUGXbYSe.png"/></div></div></figure><p id="0dda" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">保存这个以获得HTML格式的计划。</p><p id="853b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这听起来很棒。</p><p id="fbc3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是autotrace有一个很大的缺点:您必须等待查询完成！</p><p id="0a29" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您的SQL需要几分钟或几小时才能完成，等待是一件痛苦的事情。如果能实时看到查询进度，那就太棒了。</p><p id="f289" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这就引出了下一个方法:</p><h1 id="701c" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">SQL监视器</h1><p id="cf8c" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">SQL监控器提升autotrace。它提供了类似的操作级统计信息。但是有额外的好处。您可以实时查看执行计划的进度！</p><p id="0ac5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有麻烦的满桌扫描吗？你可以看着甲骨文公司努力工作。您不必等待查询完成，而是可以立即看到计划。这使得识别瓶颈变得容易。</p><p id="c044" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">更好的是，与需要手动运行的autotrace不同，Oracle会自动为您捕获计划。</p><p id="9960" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">那么，你如何看待这些计划？</p><p id="dccf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在SQL Developer中，可以通过工具-&gt;监控SQL…</p><p id="927b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">或者，您可以在企业管理器的“性能”选项卡中查看它们:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es lu"><img src="../Images/7ce17111ea37d949daff29482bfb1e2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/format:webp/0*z9qhFwcb38MxhsWx.png"/></div></figure><p id="69ec" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">单击您的语句的SQL ID会显示完整的详细信息:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es ku"><img src="../Images/e2f11bf3a25a8610a44280a3e6a71e57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*bk1EZKozriHFHdKo.png"/></div></figure><p id="0526" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">与SQL Developer一样，您可以展开和折叠计划的各个部分。关于阅读这些报告的更多细节，请看这篇关于<a class="ae jl" href="https://blogs.oracle.com/datawarehousing/entry/monitoring_parallel_execution_using_real" rel="noopener ugc nofollow" target="_blank">监控并行执行</a>的文章。</p><p id="7ef6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于喜欢文本的人，可以使用SQL输出计划。为此，请使用以下查询:</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="9f57" class="li js hh le b fi lj lk l ll lm">select dbms_sqltune.report_sql_monitor( <br/>  sql_id =&gt; '4htx5uyx0gxxx', type =&gt; 'TEXT', report_level =&gt; 'ALL' <br/>       ) as report <br/>from dual;</span></pre><p id="eb66" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您需要用查询的ID替换SQL ID参数。您可以通过以下语句找到这一点:</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="a03c" class="li js hh le b fi lj lk l ll lm">select sql_id, sql_text <br/>from   v$sql <br/>where  sql_text like '%some text from your query%' <br/>and    sql_text not like '%not this%';</span></pre><p id="931e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果有许多匹配项，请检查SQL文本，看哪一个是您的语句。</p><p id="87bd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意SQL_text被限制为1000个字符。所以对于非常大的语句，您可能还需要包含SQL_fulltext列！</p><p id="7c50" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果它如此伟大，为什么这不是我最喜欢的方法？</p><p id="f0a8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">嗯，有几个警告:</p><ul class=""><li id="09cf" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">默认情况下，并非所有查询都会出现。Oracle只捕获持续时间超过五秒或并行运行的线程。</li><li id="28fe" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">您需要有诊断和优化包许可证才能使用它</li></ul><p id="b7ad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第一个限制很容易绕过。一种方法是添加monitor提示:</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="2aee" class="li js hh le b fi lj lk l ll lm">select /*+ monitor */… from …</span></pre><p id="c20b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要获得许可，您需要与当地销售代表联系；)</p><p id="e072" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">假设您获得了许可，SQL Monitor是对那些长达一小时的查询进行早期故障排除的绝佳方式。通常，您可以在几分钟内发现计划中哪些部分造成的损害最大。这使得早期诊断成为可能。您可以计划新的方法，而不必等待语句结束！</p><p id="464b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这两种方法都很棒。但是他们一次只处理一条语句。如果想分析一个事务中几段SQL的性能怎么办？</p><p id="6fae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">输入:</p><h1 id="f86c" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">TKPROF</h1><p id="6ce8" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">TKPROF是一个命令行实用程序，它分析跟踪文件并将它们转换成可读形式。它为您提供文件中所有SQL的执行统计信息。这就引出了一个问题:</p><h1 id="39db" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">如何生成跟踪文件？</h1><p id="f91a" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">有几种方法。最简单的方法是打开SQL跟踪。执行此操作的命令是:</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="c0cc" class="li js hh le b fi lj lk l ll lm">alter session set sql_trace = true;</span></pre><p id="ea9b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Oracle将在跟踪文件中捕获此后执行的所有语句。要停止这种情况，请使用以下命令断开连接或关闭跟踪:</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="74d6" class="li js hh le b fi lj lk l ll lm">alter session set sql_trace = false;</span></pre><p id="6c91" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这种方法很简单，但是有局限性。例如，它只跟踪您的会话。</p><p id="4e71" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">更强大的方法是调用<a class="ae jl" href="http://docs.oracle.com/database/121/ARPLS/d_monitor.htm#ARPLS67178" rel="noopener ugc nofollow" target="_blank">DBMS _ monitor . session _ trace _ enable</a>。这有五个参数:</p><ul class=""><li id="675e" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">会话id</li><li id="7b1a" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">序列号</li><li id="24a3" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">等待</li><li id="aa79" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">约束</li><li id="f3e6" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">计划_统计</li></ul><p id="c5df" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">传入相关的session_id和serial_num来跟踪另一个会话。如果您将这些保留为空，Oracle将跟踪您当前会话。将等待和绑定设置为true会在文件中包含这些信息。</p><p id="c441" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要停止跟踪，调用<a class="ae jl" href="http://docs.oracle.com/database/121/ARPLS/d_monitor.htm#ARPLS67176" rel="noopener ugc nofollow" target="_blank">DBMS _ monitor . session _ trace _ disable</a>。与启用过程一样，传递相关的session_id和serial_num。如果跟踪当前会话，则保留空白。</p><p id="5a43" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此，要为当前会话生成跟踪文件，包括等待和绑定细节，请执行以下操作:</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="d253" class="li js hh le b fi lj lk l ll lm">exec DBMS_monitor.session_trace_enable ( null, null, true, true ); <br/>***your code here*** <br/>exec DBMS_monitor.session_trace_disable;</span></pre><p id="c898" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">DBMS_monitor还包括跟踪所有语句的过程:</p><p id="9333" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，跟踪会增加开销。所以避免对整个数据库启用它。完成后记得关闭它！</p><p id="cdc8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦你跟踪了你的代码，你需要得到这个文件，这样你就可以分析它。</p><h1 id="6ea8" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">如何获取跟踪文件</h1><p id="27ea" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">“但是我在哪里可以找到跟踪文件呢？”我听到你问了。</p><p id="be53" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">它位于数据库服务器上。这意味着你需要访问它(或者从需要的人那里得到帮助！).你还需要知道它在哪里，叫什么！</p><p id="3b70" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">康纳在这段视频中解释了如何找到他们:</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="ln lo l"/></div></figure><p id="ce30" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">获取文件可能很麻烦，尤其是如果你无法访问服务器的话。你可以通过<a class="ae jl" href="https://oracle-base.com/articles/misc/sql-trace-10046-trcsess-and-tkprof#query_contents_of_trace_files" rel="noopener ugc nofollow" target="_blank">配置一个文件阅读器</a>来解决这个问题，使你能够查询它们的内容(从而保存到你的本地机器)。</p><p id="e489" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有了跟踪文件，就可以用TKPROF解析它。其基本语法是:</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="cd8a" class="li js hh le b fi lj lk l ll lm">tkprof &lt;trace_file_name&gt; &lt;output_file_name&gt;</span></pre><p id="ced7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">例如:</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="4d1a" class="li js hh le b fi lj lk l ll lm">tkprof ORCL_ora_27883.trc trace.log</span></pre><p id="1aa3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这会将ORCL_ora_27883.trc的内容解析到trace.log中。</p><p id="ec34" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">快速注意:TKPROF还包括一个解释选项。这将显示你的解释，而不是执行计划。小心使用这个。</p><p id="9c02" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">与autotrace和SQL Monitor相比，这是一个很大的工作量。</p><p id="76bf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所以你可能会想:这额外的麻烦值得吗？</p><p id="4bb7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">TKPROF比这些有一些优势:</p><ul class=""><li id="02a2" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">它包括在开始和停止跟踪之间运行的所有SQL语句。这包括递归SQL，即触发器、函数等内部的语句。</li><li id="4b5f" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">它将执行时间分解为解析、执行和获取时间</li></ul><p id="f07c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您有一个包含几个语句的慢速事务，第一个好处非常大。您可以在输出文件中将它们从最慢到最快排序。这有助于你发现哪一个花费的时间最长。为此，请使用排序选项:</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="a30b" class="li js hh le b fi lj lk l ll lm">tkprof &lt;trace_file_name&gt; &lt;output_file_name&gt; sort=prsela,exeela,fchela</span></pre><p id="27cf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这对于发现多次执行的快速查询特别有用。这可能是因为您正在进行逐行处理。或者你有一个SQL语句，它有很多调用PL/SQL，而PL/SQL本身调用SQL(这是你应该<a class="ae jl" href="https://blogs.oracle.com/sql/the-problem-with-sql-calling-plsql-calling-sql" rel="noopener ugc nofollow" target="_blank">避免</a>的)。或者触发你没有意识到的逻辑。但是，正如Jonathan Lewis在评论中指出的，要知道一个SQL语句可能对每个执行都有不同的计划。TKPROF只会报告其中一个。</p><p id="c9f2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">解析、执行和获取的分解有助于您发现与计划本身无关的问题。例如，在过载的系统中，解析时间可能会更长。如果语句运行时的很大一部分是解析，那么您应该开始寻找计划本身以外的问题。</p><p id="0eba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所以TKPROF使您能够看到在前两个工具中看不到的信息。有时候额外的麻烦是值得的！</p><h1 id="fe6c" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">DBMS_XPlan</h1><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es lv"><img src="../Images/6695bf35a2cabddbabf508e65df90672.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/0*ONC9jGeJqTy-cuXA.png"/></div></figure><p id="c3b1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们要看的最后一个方法使用了包<a class="ae jl" href="http://docs.oracle.com/database/121/ARPLS/d_xplan.htm" rel="noopener ugc nofollow" target="_blank"> DBMS_XPlan </a>。这包括几个显示功能。这些是流水线式的，所以可以像普通表一样使用table()操作符查询它们。</p><p id="8b3a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用这些，您可以获得计划中每一步的性能统计数据:实际的行数、花费的时间等。</p><p id="fcf6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要查看这些信息，您需要提高Oracle的统计级别。您可以通过以下方式做到这一点:</p><ul class=""><li id="a068" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">在会话(或数据库)中将statistics_level设置为all！)使用:</li></ul><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="5d7e" class="li js hh le b fi lj lk l ll lm">alter session set statistics_level = all;</span></pre><ul class=""><li id="bc81" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">向查询中添加/*+ gather_plan_statistics */提示</li></ul><p id="62e8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦你完成了其中的一项，并运行语句直到完成，你就可以得到你的计划了！</p><p id="85b7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在执行完SQL后，立即调用display_cursor来获取计划(注意确保您已经<a class="ae jl" href="https://connormcdonald.wordpress.com/2016/01/29/common-gather_plan_statistic-confusion/" rel="noopener ugc nofollow" target="_blank">将serveroutput设置为off </a>):</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="ee8f" class="li js hh le b fi lj lk l ll lm">select * from table(dbms_xplan.display_cursor);</span></pre><p id="b32d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这将获取会话中最后一条语句的计划。这很好，但错过了许多有趣的细节。若要包含这些内容，请使用format参数。这使您能够包括或排除部分计划。我最喜欢的一些选项是:</p><ul class=""><li id="8f8c" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">all stats—IOSTATS MEMSTATS的简写。这包括诸如使用了多少行和每个步骤的一致性等细节。</li><li id="78cd" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">LAST —仅显示上次执行的统计信息。否则，这将默认为您提供每次执行的信息。</li><li id="9aa7" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">分区—包括Pstart和Pstop列。这会告诉您Oracle访问了哪些分区。只有在查询分区表时才需要！</li><li id="92c9" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">PARALLEL——同样，只与PARALLEL语句相关！</li><li id="32d1" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">注释-包括注释部分。这提供了额外的信息，例如Oracle是否使用了动态统计、自适应计划等特性。</li></ul><p id="6ed4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您想排除部分计划，只需在格式前加上减号'-'。</p><p id="60bd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你也可以用这个来获取之前语句的计划。您只需要找到SQL ID并将其传入:</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="b041" class="li js hh le b fi lj lk l ll lm">select * <br/>from   table(<br/>  dbms_xplan.display_cursor('sql_id', null, 'ALLSTATS LAST')<br/>);</span></pre><p id="5328" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该计划必须仍在游标缓存中才能使用。前往<a class="ae jl" href="https://livesql.oracle.com/apex/livesql/file/content_FAQU2DYYI7N1RYDB5CR2Y98DD.html" rel="noopener ugc nofollow" target="_blank"> LiveSQL查看如何做到这一点的示例</a>。如果您使用的是<a class="ae jl" href="https://docs.oracle.com/cd/E11882_01/server.112/e41573/autostat.htm#PFGRF02601" rel="noopener ugc nofollow" target="_blank">自动工作负载库</a>，您可以使用display_AWR获得旧的计划:</p><pre class="kv kw kx ky fd ld le lf lg aw lh bi"><span id="089f" class="li js hh le b fi lj lk l ll lm">select * <br/>from   table(<br/>  dbms_xplan.display_awr('sql_id', null, null, 'ALLSTATS LAST')<br/>);</span></pre><p id="a4f0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这一切都很好。但是输出是静态文本。您不能像在SQL Developer中那样展开和折叠计划。这可能会使大型计划难以理解。</p><p id="c523" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">那么，为什么您会选择这个而不是SQL Developer呢？</p><p id="7972" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一个显而易见的答案是，因为这是脚本化过程的一部分。这些需要纯SQL！</p><p id="3b33" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">另一个是如果你想把这个计划贴在某个地方(*咳* <a class="ae jl" href="https://asktom.oracle.com/" rel="noopener ugc nofollow" target="_blank">问汤姆</a>*咳*)以获得他人的帮助。简单的文本格式非常适合分享。</p><h1 id="1b48" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">摘要</h1><p id="d772" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">我们已经了解了创建执行计划的四种方法。</p><p id="bd73" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这些都各有利弊。最后，你用哪一种很大程度上取决于个人品味。</p><p id="bb9a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于短期运行的查询，扩展、折叠和比较执行计划的能力使SQL Developer中的autotrace成为我的赢家。对于较长的查询——在许可的情况下——我会选择SQL monitor。</p><p id="9ccb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是根据我最近的Twitter投票，DBMS_XPlan是我的追随者中最受欢迎的:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es lw"><img src="../Images/a547f3067af800835b3023eb9887edd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1050/format:webp/0*148b-f1JeocmJGKz.png"/></div></figure><p id="b99e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">还有许多其他方法可以生成Oracle执行计划。特别是<a class="ae jl" href="https://carlos-sierra.net/2012/04/03/what-is-sqltxplain/" rel="noopener ugc nofollow" target="_blank"> SQLTXPLAIN </a>。这是一个强大的工具，还包括许多支持细节，比如当前的表统计数据。如果需要他人的帮助，这是非常有用的(例如支持！).这确保他们拥有诊断问题所需的所有信息。</p><p id="a0b8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最重要的是确保你得到<em class="lc">执行</em>计划，<strong class="ig hi">而不是</strong> <em class="lc">解释</em>计划。如果输出缺少细节，比如实际的行数和花费的时间，那么很可能是类型错误。至少，您错过了帮助您调优SQL的重要信息。</p><p id="07d9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你呢？你最喜欢哪个？你还使用过我没有提到的其他工具吗？我听说其他供应商也有创建执行计划工具的工具；)这些有什么显著的好处吗？</p><p id="87f8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请在评论中告诉我们！</p></div><div class="ab cl lx ly go lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ha hb hc hd he"><p id="38f0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lc">原载于2016年3月22日</em><a class="ae jl" href="https://blogs.oracle.com/sql/how-to-create-an-execution-plan" rel="noopener ugc nofollow" target="_blank"><em class="lc">【blogs.oracle.com】</em></a><em class="lc">。</em></p></div></div>    
</body>
</html>