<html>
<head>
<title>Install Apache Airflow on a Google Cloud Platform Virtual Machine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在谷歌云平台虚拟机上安装Apache Airflow</h1>
<blockquote>原文：<a href="https://medium.com/compendium/install-apache-airflow-on-a-google-cloud-platform-virtual-machine-f9a5b01b6c33?source=collection_archive---------1-----------------------#2019-04-24">https://medium.com/compendium/install-apache-airflow-on-a-google-cloud-platform-virtual-machine-f9a5b01b6c33?source=collection_archive---------1-----------------------#2019-04-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/88ed3a6e51db7119e2c4ef203ea8f36d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PxafgMVye18LlDGWNfW59w.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Three Wind Turbines — Photo: Vera Kratochvil (<a class="ae it" href="http://creativecommons.org/publicdomain/zero/1.0/" rel="noopener ugc nofollow" target="_blank">CC0 Public Domain</a>)</figcaption></figure><p id="e7a3" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">从头开始安装Airflow是Google提供的托管版本Cloud Composer的替代方案。这是我的安装说明。</p><p id="92be" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">一个新的更新版本可以在这里找到:<a class="ae it" rel="noopener" href="/grensesnittet/airflow-on-gcp-may-2020-cdcdfe594019">GCP的气流(2020年5月)</a></p><h1 id="d305" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">模块</h1><p id="2b49" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">Ubuntu 18.04 LTS —已经启动并运行，未涵盖<br/> Python 3.6 —默认为Ubuntu 18.04 LTS<br/>Apache air flow 1 . 10 . 1<br/>PostgreSQL 9.6—托管云SQL版本<br/> Nginx 1.14.0 —用作前端和TLS终止<br/>让我们加密HTTPS证书<br/> Systemd服务—自动启动</p><h1 id="da7f" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">安装气流</h1><p id="5852" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">下面的命令安装所需的包，在<code class="du kv kw kx ky b">/srv</code>下创建一个Python虚拟环境，创建一个服务器将作为其运行的airflow用户，并设置所有者和权限。</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><h1 id="f5ae" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">安装数据库</h1><p id="321e" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">使用没有公共IP地址的托管云SQL数据库。降低成本，选择所有最低资源(1个CPU、3.75 GB RAM、10 GB HDD)。</p><p id="25e8" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们希望以以下内容结束:</p><ul class=""><li id="575b" class="lf lg hh iw b ix iy jb jc jf lh jj li jn lj jr lk ll lm ln bi translated">实例ID为:airflow-db的数据库实例(服务器)</li><li id="549d" class="lf lg hh iw b ix lo jb lp jf lq jj lr jn ls jr lk ll lm ln bi translated">数据库名称:气流</li><li id="7d06" class="lf lg hh iw b ix lo jb lp jf lq jj lr jn ls jr lk ll lm ln bi translated">数据库用户名:airflow-user</li><li id="3c3b" class="lf lg hh iw b ix lo jb lp jf lq jj lr jn ls jr lk ll lm ln bi translated">气流用户的数据库密码:<db-password/></li><li id="9502" class="lf lg hh iw b ix lo jb lp jf lq jj lr jn ls jr lk ll lm ln bi translated">数据库IP地址:<db-server-ip/></li></ul><p id="e147" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">从Google控制台，转到存储| SQL |选择“创建新实例”，然后“选择PostgreSQL”。选择“专用IP”并关联到您的虚拟机可以访问的现有网络。</p><figure class="kz la lb lc fd ii er es paragraph-image"><div class="er es lt"><img src="../Images/27098b33530c9663dee4a467948c2792.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*A0JnvX1R1fOmOV24jhMQvQ.png"/></div><figcaption class="ip iq et er es ir is bd b be z dx">Database installation. Note the password and select an associated network that your VM can access.</figcaption></figure><p id="2230" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">完成数据库向导后，您应该创建一个新数据库“airflow”和一个新用户“airflow-user”。</p><figure class="kz la lb lc fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lu"><img src="../Images/e8290611bf8b58d1608636bf2cd6d85d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uI_6g63um511j0SFzRTAPw.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Create the new “airflow” database in your airflow-db instance.</figcaption></figure><figure class="kz la lb lc fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lu"><img src="../Images/2dcbc5e1c06dbff47107051f0362237b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aZxJeZA0gFnF3JMFWSMFLg.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Create a new user account “airflow-user” and take note of the password.</figcaption></figure><p id="db85" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您需要从实例详细信息概述窗格中找到“专用IP地址”。</p><p id="d03a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">此时，您应该能够连接新的数据库了。</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="0611" class="lz jt hh ky b fi ma mb l mc md">$ psql -h <strong class="ky hi">&lt;db-server-ip&gt;</strong> -U airflow-user -d airflow<br/>Password for user airflow-user:<br/>psql (10.6 (Ubuntu 10.6–0ubuntu0.18.04.1), server 9.6.10)<br/>SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES128-GCM-SHA256, bits: 128, compression: off)<br/>Type “help” for help.</span><span id="ab41" class="lz jt hh ky b fi me mb l mc md">airflow=&gt;</span><span id="708f" class="lz jt hh ky b fi me mb l mc md">airflow=&gt; grant usage on schema public to “airflow-user”;</span></pre><h2 id="d7f8" class="lz jt hh bd ju mf mg mh jy mi mj mk kc jf ml mm kg jj mn mo kk jn mp mq ko mr bi translated">初始化数据库和配置文件</h2><p id="7239" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">运行<code class="du kv kw kx ky b">airflow initdb</code>将创建配置文件和元数据数据库。因为我们使用PostgreSQL数据库，所以我们必须在配置文件中修改数据库连接字符串，然后重新运行<code class="du kv kw kx ky b">airflow initdb</code>命令。</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="d902" class="lz jt hh ky b fi ma mb l mc md">sudo su airflow<br/>cd /srv/airflow<br/>source bin/activate<br/>export AIRFLOW_HOME=/srv/airflow<br/>export AIRFLOW__WEBSERVER__RBAC=true</span><span id="4c7f" class="lz jt hh ky b fi me mb l mc md">airflow initdb</span></pre><p id="2c55" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">查看<code class="du kv kw kx ky b">/srv/airflow/airflow.cfg</code>文件并更改连接字符串和模拟用户:</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="8fb6" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">查看文件<code class="du kv kw kx ky b">/srv/airflow/webserver_config.py</code>,确保设置了以下内容:</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="05a8" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">编辑配置文件后，初始化PostgreSQL数据库(激活虚拟环境):</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="c85a" class="lz jt hh ky b fi ma mb l mc md">airflow initdb</span></pre><p id="f2f6" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">添加新的气流管理员用户(激活的虚拟环境):</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="4792" class="lz jt hh ky b fi ma mb l mc md">airflow create_user -r Admin -u jon -e jon@exampl.com -f Jon -l Snow</span></pre><p id="90d5" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，您可以启动airflow web服务器:</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="eb93" class="lz jt hh ky b fi ma mb l mc md">airflow webserver -p 8080</span></pre><p id="54d0" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">和调度程序:</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="a790" class="lz jt hh ky b fi ma mb l mc md">airflow scheduler</span></pre></div><div class="ab cl ms mt go mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ha hb hc hd he"><h1 id="d22a" class="js jt hh bd ju jv mz jx jy jz na kb kc kd nb kf kg kh nc kj kk kl nd kn ko kp bi translated">Nginx和让我们加密证书</h1><p id="ef08" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">要使用Nginx作为具有HTTPS终端的web前端，让我们加密您的Airflow服务器需要拥有的证书:</p><ul class=""><li id="c94f" class="lf lg hh iw b ix iy jb jc jf lh jj li jn lj jr lk ll lm ln bi translated">公共IP地址</li><li id="4b03" class="lf lg hh iw b ix lo jb lp jf lq jj lr jn ls jr lk ll lm ln bi translated">指向公共IP地址的服务器域名(airflow.example.com)的DNS条目</li><li id="c2fe" class="lf lg hh iw b ix lo jb lp jf lq jj lr jn ls jr lk ll lm ln bi translated">允许流量从任何地方进入端口80和443的防火墙</li></ul><p id="734d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果以上都是真的，那么您可以安装以下存储库和软件包:</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="2d8a" class="lz jt hh ky b fi ma mb l mc md">sudo su</span><span id="c640" class="lz jt hh ky b fi me mb l mc md"># Nginx as TLS terminator and reverse proxy for Airflow<br/><em class="ne">apt </em>install nginx</span><span id="584c" class="lz jt hh ky b fi me mb l mc md"># Needed added repositories and packages for certbot<br/><em class="ne">apt </em>update<br/><em class="ne">apt </em>install software-properties-common -y<br/><em class="ne">add-apt-repository </em>ppa:certbot/certbot -y<br/><em class="ne">apt update<br/>apt upgrade<br/>apt </em>install python-certbot-nginx -y</span></pre><p id="1f89" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在新计算机上运行一次以创建新的dhparam.pem文件:</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="d3a3" class="lz jt hh ky b fi ma mb l mc md">sudo su<br/>cd /etc/ssl/private<br/>openssl dhparam -out dhparam.pem 4096<br/>chmod o-rwx dhparam.pem</span></pre><p id="e88b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">编辑<code class="du kv kw kx ky b">/etc/nginx/nginx.conf</code>并在http部分的SSL设置中添加/编辑以下内容:</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="1a28" class="lz jt hh ky b fi ma mb l mc md">ssl_session_timeout 10m;<br/>ssl_session_cache shared:SSL:10m;<br/>ssl_protocols TLSv1.2;<br/>ssl_ciphers ‘EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH’;<br/>ssl_dhparam /etc/ssl/private/dhparam.pem;<br/>ssl_prefer_server_ciphers on;</span></pre><p id="505c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为你的气流站点<br/> <code class="du kv kw kx ky b">sudo nano /etc/nginx/sites-available/airflow.example.com</code>创建一个新的Nginx配置文件，如下所示:</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="1973" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">此配置取决于Airflow web服务器侦听127.0.0.1:8080。通过重新加载nginx应用您的配置更改:</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="6d58" class="lz jt hh ky b fi ma mb l mc md">sudo service nginx reload</span></pre><p id="1083" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">然后在交互模式下运行<code class="du kv kw kx ky b">certbot</code>:</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="3ed7" class="lz jt hh ky b fi ma mb l mc md">sudo certbot --nginx</span></pre><p id="6068" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Certbot成功运行后，您应该得到两个服务器部分，一个用于HTTP，一个用于HTTPS。您需要添加位置部分:</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="3013" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果成功，检查nginx配置并重新加载nginx。</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="3756" class="lz jt hh ky b fi ma mb l mc md">sudo nginx -t<br/>sudo service nginx reload</span></pre><p id="01b4" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">你现在应该可以用HTTPS访问你的网站了。点击这里查看你的考试成绩:<a class="ae it" href="https://www.ssllabs.com/ssltest/analyze.html?d=bigdata.bbl.no&amp;hideResults=on&amp;latest" rel="noopener ugc nofollow" target="_blank">https://www.ssllabs.com/ssltest/analyze.html?d = air flow . example . com&amp;hide results = on&amp;最新</a></p><h1 id="3ba6" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">系统d服务</h1><p id="2a9f" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">使用systemd设置Airflow web服务器和调度程序，以允许在服务器启动时自动启动。</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="6acc" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">将上述文件复制到<code class="du kv kw kx ky b">/lib/systemd/system</code>:</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="c18c" class="lz jt hh ky b fi ma mb l mc md">sudo cp airflow-webserver.service /lib/systemd/system/<br/>sudo systemctl daemon-reload<br/>sudo systemctl enable airflow-webserver.service<br/>sudo systemctl start airflow-webserver.service<br/>sudo systemctl status airflow-webserver.service</span></pre><p id="caf5" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">同<code class="du kv kw kx ky b">airflow-scheduler.service</code>到:</p><figure class="kz la lb lc fd ii"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="2805" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">然后，您应该能够使用<code class="du kv kw kx ky b">systemctl</code>命令启动和停止服务:</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="d00c" class="lz jt hh ky b fi ma mb l mc md">sudo systemctl stop airflow-webserver<br/>sudo systemctl stop airflow-scheduler<br/>sudo systemctl stop nginx</span></pre><p id="df9d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我使用环境来设置调度程序使用的路径。我只使用BashOperator和DummyOperator，并使用以下命令设置我的Python作业:</p><pre class="kz la lb lc fd lv ky lw lx aw ly bi"><span id="c4f7" class="lz jt hh ky b fi ma mb l mc md">task = BashOperator(<br/>    task_id='my_task',<br/>    bash_command=f’/srv/&lt;virtualenv&gt;/bin/python3 src/transfer.py’,<br/>    ...<br/>)</span></pre><h1 id="4e5a" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">混杂的</h1><p id="1833" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">请给我反馈。这是一个复杂的装置，有许多活动部件。</p><h2 id="0ecc" class="lz jt hh bd ju mf mg mh jy mi mj mk kc jf ml mm kg jj mn mo kk jn mp mq ko mr bi translated">注意事项/问题</h2><p id="567d" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">必须创建目录/home/airflow，即使我使用了安装目录/srv/airflow，一些服务总是想检查/home/airflow目录。我从来没有找到一种方法，使气流不检查该目录。</p><p id="de1b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您应该添加防火墙规则，只允许来自您自己的已知站点的流量。</p></div></div>    
</body>
</html>