<html>
<head>
<title>How I automatically deployed Typescript to Elastic Beanstalk to speed up server-side development</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何将Typescript自动部署到弹性豆茎，以加快服务器端开发</h1>
<blockquote>原文：<a href="https://medium.com/quick-code/how-i-automatically-deployed-typescript-to-elastic-beanstalk-to-speed-up-server-development-22b89870e159?source=collection_archive---------0-----------------------#2019-12-17">https://medium.com/quick-code/how-i-automatically-deployed-typescript-to-elastic-beanstalk-to-speed-up-server-development-22b89870e159?source=collection_archive---------0-----------------------#2019-12-17</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="79b1" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">通过将Typescript代码自动部署到EB，加快您的开发过程！</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/c5573ad2c7bad98e556863ef427ff4b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*jZXqbGLfJtKixd4TRMA1Gg.gif"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">A demo of <strong class="bd jm">Booktogether</strong>, an online publishing platform that I created the back-end for.</figcaption></figure><p id="cd7c" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">在我最近的团队项目<a class="ae kj" href="https://booktogether.org/" rel="noopener ugc nofollow" target="_blank">book together</a>——一个用韩语进行图书管理和评论的在线出版平台——中，我负责使用Typescript和Express进行服务器端开发，以及使用AWS弹性豆茎进行部署。</p><p id="15b1" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">正如我很快发现的，手动部署到EB是一个乏味的过程。我一直在将Typescript代码编译成Javascript，将所有文件压缩成一个. zip文件，并将压缩文件上传到AWS。</p><p id="7320" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">这时我想，“有没有什么方法可以加快部署速度，让我可以专注于编写工作代码？”在网上做了一些挖掘后，我发现了亚伦·怀特的这个<a class="ae kj" href="https://www.youtube.com/watch?v=VO3tGUFQRKw" rel="noopener ugc nofollow" target="_blank">穿越</a>帮助我建立了一个AWS代码管道，将我的代码直接从Github发送到EB。</p><h2 id="abff" class="kk kl hh bd jm km kn ko kp kq kr ks kt jw ku kv kw ka kx ky kz ke la lb lc ld bi translated">旁注:常见错误</h2><p id="3405" class="pw-post-body-paragraph jn jo hh jp b jq le ii js jt lf il jv jw lg jy jz ka lh kc kd ke li kg kh ki ha bi translated">虽然我在本文中不会深入讨论代码管道的配置细节，但我想说明我在设置这个自动部署系统时遇到的一个问题。当我最初将服务器端代码(以及一个<a class="ae kj" href="https://docs.aws.amazon.com/codebuild/latest/userguide/sample-elastic-beanstalk.html#sample-elastic-beanstalk-codepipeline" rel="noopener ugc nofollow" target="_blank">构建规范文件</a>)从Github推送到AWS时，EB控制台出现了以下错误:</p><blockquote class="lj lk ll"><p id="4f5d" class="jn jo lm jp b jq jr ii js jt ju il jv ln jx jy jz lo kb kc kd lp kf kg kh ki ha bi translated">[实例:i-12345]命令在实例上失败。返回代码:1输出:(截断)…/opt/elasticbeanthal/container files/EB node . py "，第180行，npm_install raise e子过程。CalledProcessError(截断)</p></blockquote><p id="5a24" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">正如我后来意识到的，发生这个错误是因为当代码被部署到EC2实例时EB运行的<code class="du lq lr ls lt b">npm install</code>命令。具体来说，一些软件包的安装会触发<code class="du lq lr ls lt b">node-gyp</code>过程，该过程由默认的EC2用户运行。</p><p id="5bc3" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">默认用户没有权限访问<code class="du lq lr ls lt b">npm install</code>创建的node_modules目录中的一些包，这就是为什么需要在项目根目录下创建一个名为<code class="du lq lr ls lt b">.npmrc</code>的文件并添加以下内容:</p><pre class="ix iy iz ja fd lu lt lv lw aw lx bi"><span id="b21a" class="kk kl hh lt b fi ly lz l ma mb"># Forces node-gyp process to be run as root user, not ec2 default<br/>unsafe-perm=true</span></pre><h2 id="6000" class="kk kl hh bd jm km kn ko kp kq kr ks kt jw ku kv kw ka kx ky kz ke la lb lc ld bi translated">将Typescript代码自动部署到EB</h2><p id="a4d4" class="pw-post-body-paragraph jn jo hh jp b jq le ii js jt lf il jv jw lg jy jz ka lh kc kd ke li kg kh ki ha bi translated">现在回到问题的核心。当代码被部署到弹性豆茎中的Node.js环境时，会自动调用<code class="du lq lr ls lt b">node app</code>来初始化服务器。然而，因为Node.js是一个Javascript运行时环境，我为我的服务器编写的Typescript代码默认情况下不会运行。我需要首先编译我的Typescript代码。</p><p id="af3f" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">为了在不需要手动将代码上传为. zip文件的情况下完成这项工作，我有两个选择。第一个是在我的本地机器上使用类似于<code class="du lq lr ls lt b">npm run build</code>的命令编译Typescript代码，然后将Javascript和Typescript上传到我的Github存储库。然而，这种选择有两个主要缺点:</p><ol class=""><li id="7b70" class="mc md hh jp b jq jr jt ju jw me ka mf ke mg ki mh mi mj mk bi translated">一个额外的步骤(执行<code class="du lq lr ls lt b">npm run build</code>)将被添加到部署流程中</li><li id="6b65" class="mc md hh jp b jq ml jt mm jw mn ka mo ke mp ki mh mi mj mk bi translated">我将不得不应对这两方面的变化。js和。Github中的ts文件</li></ol><p id="7bd0" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">考虑到这些问题，我求助于另一个选择——特别是使用<code class="du lq lr ls lt b">.ebextensions</code>目录。该目录中的文件用于弹性Beanstalk环境的高级定制配置。<code class="du lq lr ls lt b">.ebextensions</code>文件以YAML或JSON格式编写，文件扩展名为. config。</p><p id="d2a8" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">我在这个例子中使用的配置文件以这样一种方式配置EB，即在运行<code class="du lq lr ls lt b">npm install</code>之后，实例将所有的类型脚本代码编译成Javascript。引用下面的<a class="ae kj" rel="noopener" href="/@lhviet88/deploy-a-typescript-expressjs-into-elasticbeanstalk-nodejs-server-8381e00e7e52">文章</a>关于使用。ebextensions，我在<code class="du lq lr ls lt b">.ebextensions</code>目录中创建了一个名为<code class="du lq lr ls lt b">source_compile.config</code>的文件，并包含了以下脚本:</p><pre class="ix iy iz ja fd lu lt lv lw aw lx bi"><span id="eb3a" class="kk kl hh lt b fi ly lz l ma mb"># source_compile.config<br/>container_commands:<br/>  compile:<br/>    command: "./node_modules/.bin/tsc -p tsconfig.json"<br/>    env:<br/>      PATH: /opt/elasticbeanstalk/node-install/node-v10.15.3-linuxT-x64/bin/</span></pre><p id="89d5" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">给定配置文件<code class="du lq lr ls lt b">tsconfig.json</code>，命令<code class="du lq lr ls lt b">tsc -p tsconfig.json</code>告诉EB将Typescript项目编译成Javascript。如果在<code class="du lq lr ls lt b">tsconfig.json</code>中没有指定<code class="du lq lr ls lt b">outdir</code>键，编译后的。js文件将位于与相应的。ts文件。</p><p id="6394" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">此外，我需要确保在<code class="du lq lr ls lt b">PATH</code>键中指定的节点版本与我的EB环境使用的节点版本兼容。如果需要，应该更改上面的<code class="du lq lr ls lt b">source_compile.config</code>脚本的<code class="du lq lr ls lt b">PATH</code>键中使用的节点版本(当前写为v10.15.3)和操作系统名称。</p><p id="c840" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">完成所有这些步骤后，我再次将更改合并到我的主Github分支中——瞧！服务器启动并运行。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mq"><img src="../Images/788ade7f6694c1c5106c47286bff2520.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3jCi63xDMRfJOupPLLxY1Q.png"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Health shown as “Ok” after deploying a project with configuration files (buildspec.yml, .npmrc, .ebextensions)</figcaption></figure><p id="3bad" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">因此，通过利用自动部署管道和<code class="du lq lr ls lt b">.ebextensions</code>，我让部署自行处理，并且能够更专注于用Typescript编写服务器端代码。对于广泛使用的产品或应用程序，明智的做法是建立一个独立的开发服务器，连接到这个管道和额外的CI/CD工具进行严格的测试。</p></div></div>    
</body>
</html>