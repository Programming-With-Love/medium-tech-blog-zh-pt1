<html>
<head>
<title>Building My Github Action to Deliver Doggoes to PRs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建我的Github操作以向PRs交付Doggoes</h1>
<blockquote>原文：<a href="https://medium.easyread.co/building-my-github-action-to-deliver-doggoes-to-prs-d9cd5d4a42d0?source=collection_archive---------7-----------------------#2020-03-08">https://medium.easyread.co/building-my-github-action-to-deliver-doggoes-to-prs-d9cd5d4a42d0?source=collection_archive---------7-----------------------#2020-03-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="0f67" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">因为谁不想好男生一推就出现呢？</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi kc"><img src="../Images/5141e47a6cdb522cbd0ecf1f4808d21e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*Mj4QtH-swcMFRMkB.png"/></div></figure><p id="ec30" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">期待已久的GitHub Action功能终于推出测试版，并准备在每个存储库中推出。GitHub甚至在整个三月组织了<a class="ae lg" href="https://githubhackathon.com/" rel="noopener ugc nofollow" target="_blank">黑客马拉松</a>，鼓励人们创造更多令人敬畏和有用的行为。在浏览提交的内容时，我发现<a class="ae lg" href="https://github.com/ruairidhwm/action-cats" rel="noopener ugc nofollow" target="_blank">是一个很酷的GitHub动作</a>,可以在拉取请求上发布cat gifs。大声说出他的酷想法👏👏👏。</p><p id="8b16" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">只有采取行动把狗狗们交给我们的公关，这才是对狗狗们的公平。那一刻我清楚地知道我的下一个Github行动计划会是什么。该去工作了。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi kc"><img src="../Images/0800a470edc3ffd8e47da05aa60e6bd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*82BIm07p2L2cgXWo"/></div></figure></div><div class="ab cl lh li hr lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ig ih ii ij ik"><h1 id="6527" class="lo lp in bd lq lr ls lt lu lv lw lx ly jt lz ju ma jw mb jx mc jz md ka me mf bi translated">创建GitHub动作的要点</h1><p id="0c4d" class="pw-post-body-paragraph kk kl in km b kn mg jo kp kq mh jr ks kt mi kv kw kx mj kz la lb mk ld le lf ig bi translated"><a class="ae lg" href="https://help.github.com/en/actions/getting-started-with-github-actions/about-github-actions" rel="noopener ugc nofollow" target="_blank"> GitHub动作</a>基本上是(与❤️一起)预制的工作单元，用于GitHub工作流(想想<a class="ae lg" href="https://travis-ci.org/" rel="noopener ugc nofollow" target="_blank"> Travis </a>的构建)。Github动作可以用<a class="ae lg" href="https://help.github.com/en/actions/building-actions/creating-a-docker-container-action" rel="noopener ugc nofollow" target="_blank"> Docker容器</a>或<a class="ae lg" href="https://help.github.com/en/actions/building-actions/creating-a-javascript-action" rel="noopener ugc nofollow" target="_blank"> JS/TS脚本</a>构建。用JS/TS创建GitHub动作的一个优点是可以从<a class="ae lg" href="https://github.com/actions/toolkit" rel="noopener ugc nofollow" target="_blank"> GitHub工具包</a>中获得现成的模块。有了这样的集成支持，连接GitHub服务就容易多了(拜托🙄谁想要编写<code class="fe ml mm mn mo b"><strong class="km io">curl</strong></code>命令来进行API调用)。用<a class="ae lg" href="https://github.com/actions/typescript-action" rel="noopener ugc nofollow" target="_blank"> TypeScript动作模板</a>就很明显了。有了这个决定，让我们开始写动作狗。</p><h2 id="0741" class="mp lp in bd lq mq mr dn lu ms mt dp ly kt mu mv ma kx mw mx mc lb my mz me na bi translated">主运行文件</h2><p id="78f1" class="pw-post-body-paragraph kk kl in km b kn mg jo kp kq mh jr ks kt mi kv kw kx mj kz la lb mk ld le lf ig bi translated">在JS/TS GitHub动作中，工作负载将从一个主入口点启动(考虑运行<code class="fe ml mm mn mo b"><strong class="km io">node src/index.js</strong></code>来启动web应用程序的一个节点进程，等等)。对于行动狗，这是我的主程序的基本设置</p><pre class="kd ke kf kg gt nb mo nc nd aw ne bi"><span id="5ea9" class="mp lp in mo b gy nf ng l nh ni">import * as core from "@actions/core";<br/>import * as github from "@actions/github";<br/>import { generate } from "./doggo/generator";</span><span id="de22" class="mp lp in mo b gy nj ng l nh ni">(async function run(): Promise&lt;void&gt; {<br/>  try {<br/>    const ctx = github.context;<br/>    if (!ctx.payload.pull_request) {<br/>      throw new Error("Not in the context of a PR!");<br/>    }</span><span id="c0b3" class="mp lp in mo b gy nj ng l nh ni">    const ghCli = new github.GitHub(core.getInput("github-token"));<br/>    const doggo = generate();<br/>    ghCli.issues.createComment({<br/>      ...ctx.repo,<br/>      issue_number: ctx.payload.pull_request.number,<br/>      body: `![Doggo](${doggo})`<br/>    });<br/>  } catch (e) {<br/>    core.setFailed(e.message);<br/>  }<br/>})();</span></pre><p id="0c6a" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">在一个可以触发GitHub工作流的事件期间，我们被提供了一个可以通过<code class="fe ml mm mn mo b"><strong class="km io">@actions/github</strong></code>模块访问的上下文对象。使用它，我能够检查我的有效载荷是否来自于一个<code class="fe ml mm mn mo b"><strong class="km io">pull_request</strong></code>，否则拒绝。接下来，我需要发布一个带有doggo gif内容的相应pull请求的注释。假设我的doggo生成器(我将在下一节中解释)工作正常，我可以检索doggo gif的URL，在pull请求上创建注释非常简单，因为我只需要从我们的上下文对象和PR的编号中传递回购信息。此外，万一我们在这些操作中得到任何错误，调用<code class="fe ml mm mn mo b"><strong class="km io">core.setFailed(e.message)</strong></code>将会用错误消息将构建标记为失败。</p><h2 id="e024" class="mp lp in bd lq mq mr dn lu ms mt dp ly kt mu mv ma kx mw mx mc lb my mz me na bi translated">该死的发电机</h2><p id="44c5" class="pw-post-body-paragraph kk kl in km b kn mg jo kp kq mh jr ks kt mi kv kw kx mj kz la lb mk ld le lf ig bi translated">经过大量研究，我打算使用一个公共API来获得随机的doggo gifs，但我找不到一个公共的API(如<a class="ae lg" href="https://dog.ceo/" rel="noopener ugc nofollow" target="_blank"> dog.ceo </a>)并且也提供gif(如<a class="ae lg" href="https://giphy.com/" rel="noopener ugc nofollow" target="_blank"> GIPHY </a>)。因为我没有办法安全地存储GIPHY API密匙，以便在action-dogs中使用，所以我回到了静态JSON数组的好方法。</p><p id="c6e0" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">想知道我是如何获得充满doggo awesomeness的数组(来自❤️ <a class="ae lg" href="https://giphy.com/" rel="noopener ugc nofollow" target="_blank">吉菲</a> ❤️)而没有在这个过程中生成任何API密匙吗？我实际上去了GIPHY网站，搜索doggoes，向下滚动，直到在打开我的控制台之前呈现了大量的“giffy-boys”</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/ad5bd1127f5597f867c0763cd0723a7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/0*0c-CpL2TSE8cgIul"/></div></figure><p id="90dc" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">有了这几行JS</p><pre class="kd ke kf kg gt nb mo nc nd aw ne bi"><span id="6e5b" class="mp lp in mo b gy nf ng l nh ni">const dogsData = [];<br/>document<br/>  .querySelectorAll("a._2SwDiFPqIlZmUDkxHNOeqU")<br/>  .forEach(e =&gt; dogsData.push(e.href));<br/>var dataStr =<br/>  "data:text/json;charset=utf-8," +<br/>  encodeURIComponent(JSON.stringify(dogsData));<br/>var dlAnchorElem = document.createElement("a");<br/>dlAnchorElem.setAttribute("href", dataStr);<br/>dlAnchorElem.setAttribute("download", "dogs.json");<br/>dlAnchorElem.click();</span></pre><p id="acb8" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">它基本上从搜索结果页面上的所有“复制链接”元素中获取“href”值，将它们流式传输到一个JSON数组，并填充到一个文件中供我“下载”，“生成”只是从数组中随机选取一个URL。</p><pre class="kd ke kf kg gt nb mo nc nd aw ne bi"><span id="5138" class="mp lp in mo b gy nf ng l nh ni">import dogs from "./dogs.json";</span><span id="29ab" class="mp lp in mo b gy nj ng l nh ni">export function generate(): string {<br/>  return dogs[Math.floor(Math.random() * dogs.length)];<br/>}</span></pre><h2 id="c9e1" class="mp lp in bd lq mq mr dn lu ms mt dp ly kt mu mv ma kx mw mx mc lb my mz me na bi translated">测试</h2><p id="1ad1" class="pw-post-body-paragraph kk kl in km b kn mg jo kp kq mh jr ks kt mi kv kw kx mj kz la lb mk ld le lf ig bi translated">我用jest为我的doggo生成器写了一个单元测试(但实际上主要是作为有趣描述的一个途径)。</p><pre class="kd ke kf kg gt nb mo nc nd aw ne bi"><span id="566e" class="mp lp in mo b gy nf ng l nh ni">import { generate } from "../../src/doggo/generator";</span><span id="170b" class="mp lp in mo b gy nj ng l nh ni">describe("doggo generator", () =&gt; {<br/>  test("to return a good boy", () =&gt; {<br/>    Math.random = jest.fn().mockReturnValue(0);<br/>    const good = "https://media3.giphy.com/media/mCRJDo24UvJMA/giphy.gif";<br/>    const boy = generate();<br/>    expect(boy).toBe(good);<br/>  });<br/>});</span></pre><p id="14e3" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">但是真正的测试是使用<code class="fe ml mm mn mo b"><strong class="km io">action-dogs</strong></code>本身的工作流(是的，您可以在它自己的repo上使用GitHub动作🤯).</p><pre class="kd ke kf kg gt nb mo nc nd aw ne bi"><span id="6e1a" class="mp lp in mo b gy nf ng l nh ni">name: "doggo"</span><span id="2551" class="mp lp in mo b gy nj ng l nh ni">on: pull_request</span><span id="fefc" class="mp lp in mo b gy nj ng l nh ni">jobs:<br/>  build:<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>      - uses: actions/checkout@v2<br/>      - uses: stanleynguyen/action-dogs@master<br/>        with:<br/>          github-token: ${{ secrets.GITHUB_TOKEN }}</span></pre><p id="43d7" class="pw-post-body-paragraph kk kl in km b kn ko jo kp kq kr jr ks kt ku kv kw kx ky kz la lb lc ld le lf ig bi translated">现在我可以看到<code class="fe ml mm mn mo b"><strong class="km io">action-dogs</strong></code>和<a class="ae lg" href="https://github.com/stanleynguyen/action-dogs/pull/1" rel="noopener ugc nofollow" target="_blank">一个公关样本</a>一起工作。加油🙌🙌🙌！！现在我可以安全地在GitHub Marketplace上发布它了。</p></div><div class="ab cl lh li hr lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ig ih ii ij ik"><h1 id="39db" class="lo lp in bd lq lr ls lt lu lv lw lx ly jt lz ju ma jw mb jx mc jz md ka me mf bi translated">Outtro</h1><p id="36fc" class="pw-post-body-paragraph kk kl in km b kn mg jo kp kq mh jr ks kt mi kv kw kx mj kz la lb mk ld le lf ig bi translated">这就是我为了娱乐和学习而创作<code class="fe ml mm mn mo b"><strong class="km io">action-dogs</strong> </code>的故事。你可以在<a class="ae lg" href="https://github.com/stanleynguyen/action-dogs" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到源代码(因为它还能在哪里🤷‍♂️)和<a class="ae lg" href="https://github.com/marketplace/actions/action-dogs" rel="noopener ugc nofollow" target="_blank">市场</a>上的<code class="fe ml mm mn mo b"><strong class="km io">action-dogs</strong></code>。</p></div><div class="ab cl lh li hr lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ig ih ii ij ik"><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nl nm l"/></div></figure></div></div>    
</body>
</html>