<html>
<head>
<title>Digital Goods Transaction of Actions on Google (Consume Products)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌上的数字商品交易行为(消费产品)</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/digital-goods-transaction-of-actions-on-google-consume-products-e40e534512e1?source=collection_archive---------4-----------------------#2018-12-16">https://medium.com/google-developer-experts/digital-goods-transaction-of-actions-on-google-consume-products-e40e534512e1?source=collection_archive---------4-----------------------#2018-12-16</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="e45c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作为最后一个故事，我在这个故事中描述了如何实现一个功能来消费数字商品。</p><div class="jc jd ez fb je jf"><a href="https://developers.google.com/actions/transactions/digital/dev-guide-digital" rel="noopener  ugc nofollow" target="_blank"><div class="jg ab dw"><div class="jh ab ji cl cj jj"><h2 class="bd hi fi z dy jk ea eb jl ed ef hg bi translated">构建数字交易| Google上的行动| Google开发者</h2><div class="jm l"><h3 class="bd b fi z dy jk ea eb jl ed ef dx translated">要向数字采购API发送请求，您需要下载一个与您的……</h3></div><div class="jn l"><p class="bd b fp z dy jk ea eb jl ed ef dx translated">developers.google.com</p></div></div><div class="jo l"><div class="jp l jq jr js jo jt ju jf"/></div></div></a></div><h1 id="5562" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">消耗品？非消耗品？</h1><p id="3df3" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">您的操作可以支持两种产品类型:被管理产品和订购产品。特别是，被管理产品还有两种类型:</p><ul class=""><li id="5666" class="ky kz hh ig b ih ii il im ip la it lb ix lc jb ld le lf lg bi translated"><strong class="ig hi">消耗性产品</strong>:可以多次购买，比如一定数量的游戏内货币。购买商品后，发送消费请求以使商品再次可供购买。</li><li id="ff2c" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb ld le lf lg bi translated"><strong class="ig hi">非消耗性产品</strong>:每个用户只能购买一次，比如无广告体验的付费升级，或者有附加内容的游戏资料片。</li></ul><p id="f5d8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Google Play主机上两者没有区别。相反，你的行动需要处理这种差异。</p><h1 id="a740" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">检查用户已经购买的产品</h1><p id="6c89" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">当用户购买了您的产品后访问您的操作时，Actions on Google会将购买的产品信息包含到对您的操作的每个请求中。您可以通过以下助手功能检索产品信息:</p><pre class="lm ln lo lp fd lq lr ls lt aw lu bi"><span id="52e1" class="lv jw hh lr b fi lw lx l ly lz">const findEntitlement = (conv, skuType, id) =&gt; {<br/>    const entitlementGroups = conv.user.entitlements;<br/>    const entitlementGroup = entitlementGroups.find(x =&gt; {<br/>        return x.packageName === packageName;<br/>    });<br/>    if (entitlementGroup) {<br/>        return entitlementGroup.entitlements.find(x =&gt; {<br/>            return x.skuType === skuType.substring(9)<br/>                &amp;&amp; x.sku === id;<br/>        });<br/>    }<br/>    return undefined;<br/>};</span></pre><p id="5aa3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Google Webhook的行为协议中，用户已经购买的产品被称为“授权”。你可以通过<code class="du ma mb mc lr b">conv.user.entitlements</code>得到它们。结果的类是一个<code class="du ma mb mc lr b"><a class="ae md" href="https://actions-on-google.github.io/actions-on-google-nodejs/interfaces/actionssdk_api_v2.googleactionsv2packageentitlement.html" rel="noopener ugc nofollow" target="_blank">GoogleActionsV2PackageEntitlement</a></code>的数组。也就是说，您可以根据Android应用程序的包名检索多个权限。</p><p id="14df" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">每个<code class="du ma mb mc lr b">GoogleActionsV2PackageEntitlement</code>都有一个或多个<code class="du ma mb mc lr b">GoogleActionsV2Entitlement</code>，你可以通过<code class="du ma mb mc lr b">elements</code>属性访问它们。这个类有SKU的ID和类型。这意味着通过的授权代表用户已经购买的产品。您的行动可以知道包括包名称，SKU ID和SKU类型的集合列表。</p><h1 id="3fe3" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">购买_状态_已拥有</h1><p id="5879" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">当用户试图购买已经购买的产品时(这意味着您的操作响应具有产品的SKU ID和类型的<code class="du ma mb mc lr b">CompletePurchase</code>对象)，Google上的操作返回<code class="du ma mb mc lr b">PURCHASE_STATUS_ALREADY_OWNED</code>状态作为结果。也就是说，购买请求失败。</p><p id="9857" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">非消耗品是指只能购买一次的产品。因此，对于非消耗性产品，这种行为是合适的。换句话说，基本上所有带有<code class="du ma mb mc lr b">CompletePurchase</code>的请求都被视为非消耗性采购。</p><h1 id="a357" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">重新购买被管理产品</h1><p id="816d" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">对于易耗品，有必要采用其他方式重新采购(又名。消费)被管理产品。Google上的Actions提供了一个API来消费产品。API是操作API的一部分。</p><figure class="lm ln lo lp fd mf er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es me"><img src="../Images/d76e765e5eb7495029ed1a3edd073977.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EUmP0OJ3raYlukY9tCBa2A.png"/></div></div></figure><p id="5dcd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您应该已经拥有一个服务帐户，可以使用Actions API从Google Play检索产品信息。您可以使用同一个服务帐户来消费产品。</p><p id="6983" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">消费产品的代码如下:</p><pre class="lm ln lo lp fd lq lr ls lt aw lu bi"><span id="7516" class="lv jw hh lr b fi lw lx l ly lz">const consume = (tokens, conv, entitlement) =&gt; {<br/>    return new Promise((resolve, reject) =&gt; {<br/>        const convId = conv.request.conversation.conversationId;<br/>        const purchaseToken = entitlement.inAppDetails.inAppPurchaseData.purchaseToken;<br/>        const url = `<a class="ae md" href="https://actions.googleapis.com/v3/conversations/${convId}/entitlement:consume`" rel="noopener ugc nofollow" target="_blank">https://actions.googleapis.com/v3/conversations/${convId}/entitlement:consume`</a>;<br/>        request.post(url, {<br/>            auth: {<br/>                bearer: tokens.access_token<br/>            },<br/>            json: true,<br/>            body: {<br/>                purchaseToken<br/>            }<br/>        }, (err, httpResponse, body) =&gt; {<br/>            if (err) {<br/>                reject(err);<br/>            } else {<br/>                const statusCode = httpResponse.statusCode;<br/>                const statusMessage = httpResponse.statusMessage;<br/>                console.log(`${statusCode}: ${statusMessage}`);<br/>                resolve();<br/>            }<br/>        });<br/>    });<br/>};</span></pre><p id="ebc9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">每项权利都有一个购买令牌，在购买后即可使用。可以通过权限对象的<code class="du ma mb mc lr b">inAppDetails.inAppPurchaseData.purchaseToken</code>获得令牌。您需要在端点的请求体中指定购买令牌来消费产品。</p><h1 id="29cb" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">支持耗材和非耗材</h1><p id="adde" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">因此，您可以像下面这样更新您的<code class="du ma mb mc lr b">actions_intent_OPTION</code>意图句柄函数:</p><pre class="lm ln lo lp fd lq lr ls lt aw lu bi"><span id="278d" class="lv jw hh lr b fi lw lx l ly lz">const consumableProducts = ["coins"];</span><span id="bf12" class="lv jw hh lr b fi ml lx l ly lz">app.intent("actions.intent.OPTION", (conv, params, option) =&gt; {<br/>    if (option === "cancel") {<br/>        conv.ask("Canceled");<br/>        return;<br/>    }<br/>    const [skuType, id] = option.split(",");<br/>    const entitlement = findEntitlement(conv, skuType, id);<br/>    if (entitlement &amp;&amp; consumableProducts.includes(id)) {<br/>        return new Promise((resolve, reject) =&gt; {<br/>            createJwtClient().authorize((err, tokens) =&gt; {<br/>                if (err) {<br/>                    reject(`Auth error: ${err}`);<br/>                    return;<br/>                }<br/>                consume(tokens, conv, entitlement).then(() =&gt; {<br/>                    conv.close(`You purchased ${id} successfully.`);<br/>                    resolve();<br/>                }).catch(err =&gt; {<br/>                    reject(`API request error: ${err}`);<br/>                });<br/>            });<br/>        });<br/>    } else {<br/>        conv.ask(new CompletePurchase({<br/>            skuId: {<br/>                skuType: skuType,<br/>                id: id,<br/>                packageName: packageName<br/>            }<br/>        }));<br/>    }<br/>});</span></pre><h1 id="000e" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">结论</h1><p id="4f33" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">为了解释如何使用数字商品交易，有必要写9个故事…我认为数字商品交易的规范是如此糟糕。太多的步骤。太复杂了。而且，太难了。此外，官方文件没有提供足够的信息。我猜想大多数开发者不能通过阅读官方文件来实现你的数字商品交易行为。</p><p id="6c1f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我希望你能通过阅读我写的故事，用数字商品交易来实施你的行动，并从中获利。</p></div></div>    
</body>
</html>