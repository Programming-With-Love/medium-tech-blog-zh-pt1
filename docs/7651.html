<html>
<head>
<title>Tech Transformation: Real-time Messaging at Walmart</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">技术转型:沃尔玛的实时信息传递</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/tech-transformation-real-time-messaging-at-walmart-8787f5ab19e8?source=collection_archive---------1-----------------------#2016-11-01">https://medium.com/walmartglobaltech/tech-transformation-real-time-messaging-at-walmart-8787f5ab19e8?source=collection_archive---------1-----------------------#2016-11-01</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/379d85e54bc74f53cfabab22ae7ae6f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*onR_rNgrZMH-zi6Ga-DdhQ.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo Credit: <a class="ae it" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank">Apache Kafka</a></figcaption></figure><p id="6d62" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><a class="ae it" href="http://www.zdnet.com/article/ten-companies-where-soa-made-a-difference-in-2006/" rel="noopener ugc nofollow" target="_blank">据报道，许多顶级组织</a>受益于<a class="ae it" href="https://en.wikipedia.org/wiki/Service-oriented_architecture" rel="noopener ugc nofollow" target="_blank">面向服务的架构</a>(SOA)<a class="ae it" href="http://www.walmartlabs.com/2015/02/why-we-chose-openstack-for-walmart-global-ecommerce/" rel="noopener ugc nofollow" target="_blank">沃尔玛也基于SOA和弹性云</a>重建了其电子商务网站(walmart.com)。SOA的一个重要子集是<strong class="iw hi">消息驱动的</strong>架构，它作为异步通信的通道来分离捆绑的组件。结果是一个更加可扩展和高效的体系结构，其中每个组件或服务都可以通过消息传递平台与其他组件或服务进行通信来独立制作和扩展。</p><p id="75c5" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">传统的消息队列曾经是消息驱动架构的解决方案，但是当涉及到处理大规模的时候，它已经变得有一种内在的缺陷。</p><figure class="jt ju jv jw fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es js"><img src="../Images/9a1ed01b8888ee282893d0b97ed61b8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ufIT74GNCRgB1XwR.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo Credit: <a class="ae it" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank">Apache Kafka</a></figcaption></figure><p id="f02b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当我们审视当今的高吞吐量消息传递解决方案领域时，<a class="ae it" href="http://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Kafka </a>已被证明是最佳选择，因为它是一个高度可伸缩、持久和分布式的消息传递系统，单个Kafka消息代理每秒可以处理来自数千个客户端的数百兆字节的读取和写入。Kafka已经被许多硅谷科技公司高度采用，如Twitter、网飞、LinkedIn、优步、Airbnb、Pinterest，以及硅谷以外的大型IT公司，如Cerner和高盛。<a class="ae it" href="https://cwiki.apache.org/confluence/display/KAFKA/Powered+By" rel="noopener ugc nofollow" target="_blank">这里</a>显示了著名的Kafka用户列表。</p><p id="972b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><a class="ae it" href="http://www.walmartlabs.com/" rel="noopener ugc nofollow" target="_blank">沃尔玛<a class="ae it" href="https://www.walmart.com/" rel="noopener ugc nofollow" target="_blank">沃尔玛</a>的技术部门沃尔玛实验室</a>，从两年前开始就在许多不同的用例中使用Kafka。在这篇博客中，我们将介绍早期的Kafka用例，Kafka部署模型的转变，以及从这一转变中吸取的教训。</p><h1 id="efb5" class="jx jy hh bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">早期</h1><p id="780e" class="pw-post-body-paragraph iu iv hh iw b ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn kz jp jq jr ha bi translated">经过数月的调查，甚至考虑编写我们自己的信息系统，Kafka于2014年初被沃尔玛采用。主要的用例是我们的跟踪像素feed，为此我们使用了一个定制的Apache Flume fork<a class="ae it" href="https://flume.apache.org/" rel="noopener ugc nofollow" target="_blank">和一个简单的共享TCP流服务相结合，该服务是为下游的实时应用程序设计的。</a></p><p id="b8bc" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">另一个用例是我们的应用程序日志收集服务，它也使用了<a class="ae it" href="https://flume.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Flume </a>。在这两种情况下，我们对性能、灵活性、缓冲能力和弹性都不满意。</p><p id="caed" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当时，Kafka几乎没有交付保证的意识，Kafka的大部分使用只是因为它的高吞吐量和低延迟对他们来说已经足够好了，即使在极少数情况下可能会有少量的消息丢失。</p><h1 id="3422" class="jx jy hh bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">裸机上的共享卡夫卡</h1><p id="9206" class="pw-post-body-paragraph iu iv hh iw b ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn kz jp jq jr ha bi translated">我们从部署在裸机服务器上的几个独立Kafka集群开始，并迅速扩展到遍布各州的7个地理数据中心。</p><p id="7733" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在七个数据中心中，有五个是只包含本地消息的“本地”Kafka集群。有两个“聚合”集群，每个集群位于不同的DC中，用于冗余。我们使用<a class="ae it" href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=27846330" rel="noopener ugc nofollow" target="_blank"> Kafka MirrorMaker </a>从本地聚合消息到聚合集群。</p><figure class="jt ju jv jw fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es la"><img src="../Images/07ea2431fe6dd1e91499ba49a4e3dffb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZjtyGjub0BZEjOo6hDUIDw.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Shared Kafka Deployment on Bare-metal with Redundancy</figcaption></figure><p id="ae83" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">一些应用程序只关心单个Kafka集群中发生的事情，因此它们只从本地集群中进行消费。许多其他应用程序需要全面了解所有数据中心的情况，因此它们从聚合集群中进行消耗。</p><p id="0cce" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">所有Kafka集群都由一组运营人员维护，希望使用Kafka服务的应用程序团队(也称为租户)可以独立创建他们的主题，插入他们的生产者和消费者，然后开始通过Kafka集群发送他们的消息，因此这种模式被称为“共享”Kafka。</p><p id="1d54" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在运行Kafka的第一年，集中管理和共享的Kafka模式对Kafka租户和运营团队都非常有效，因为:</p><ol class=""><li id="d235" class="lb lc hh iw b ix iy jb jc jf ld jj le jn lf jr lg lh li lj bi translated"><em class="lk"> Kafka租户不必担心硬件容量和Kafka日常运营，他们可以专注于自己的应用程序开发。</em></li><li id="7784" class="lb lc hh iw b ix ll jb lm jf ln jj lo jn lp jr lg lh li lj bi translated">Kafka租户的数量并不多，而且每个租户发送的消息量都是受控的，因此租户仍然可以享受足够好的吞吐量，即使与他人共享硬件容量。</li><li id="b96e" class="lb lc hh iw b ix ll jb lm jf ln jj lo jn lp jr lg lh li lj bi translated"><em class="lk">租户对Kafka的期望不过是一个高吞吐量的消息传递系统。在极少数情况下，Kafka经历了短暂或极少量的消息丢失，大多数应用程序可以容忍由于非关键业务用例或在自己的流程中处理糟糕的情况。</em></li></ol><p id="e18b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">然而不久之后，随着越来越多的租户迁移他们的应用程序并依赖Kafka，共享Kafka模式开始遇到越来越多的阻碍:</p><ol class=""><li id="c25c" class="lb lc hh iw b ix iy jb jc jf ld jj le jn lf jr lg lh li lj bi translated"><em class="lk">争夺容量:如果一个租户对一个共享的Kafka集群产生流量高峰，其余的Kafka租户将立即受到影响。</em></li><li id="0553" class="lb lc hh iw b ix ll jb lm jf ln jj lo jn lp jr lg lh li lj bi translated">缺乏认证:任何租户都可以向其他租户的Kafka主题发送消息，甚至更糟，错误地更改或删除它。</li><li id="31a7" class="lb lc hh iw b ix ll jb lm jf ln jj lo jn lp jr lg lh li lj bi translated"><em class="lk">“漏洞百出”的客户端:租户在Kafka客户端实现中的软件漏洞可能会耗尽Kafka资源，并阻止其他团队连接到Kafka。</em></li><li id="7727" class="lb lc hh iw b ix ll jb lm jf ln jj lo jn lp jr lg lh li lj bi translated"><em class="lk">没有“一刀切”:Kafka租户开始设定不同的期望，从配置、集群可用性到消息交付的可靠性，因为Kafka本身随着时间的推移已经成为一个成熟的生产就绪项目。</em></li></ol><p id="484d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">不可避免的是，随着越来越多的租户开始使用共享Kafka模式并计划将其用于关键业务，该模式变得效率低下。从那时起，我们开始寻找更高效的Kafka部署和运营模式，OneOps进入了我们的视野。</p><h1 id="bbc4" class="jx jy hh bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">由云和OneOps支持的自助式Kafka</h1><p id="1d01" class="pw-post-body-paragraph iu iv hh iw b ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn kz jp jq jr ha bi translated"><a class="ae it" href="http://www.oneops.com/" rel="noopener ugc nofollow" target="_blank"> OneOps </a>是一个由WalmartLabs 开源的<a class="ae it" href="https://techcrunch.com/2016/01/26/walmart-launches-oneops-an-open-source-cloud-and-application-lifecycle-management-platform/" rel="noopener ugc nofollow" target="_blank">多云和应用生命周期管理平台。在上游，OneOps可以协调应用模式/包，以便在整个生命周期中进行配置、操作和管理。在下游，OneOps可以将任何应用模式部署到主要的公共云和私有云提供商，如</a><a class="ae it" href="https://www.openstack.org/" rel="noopener ugc nofollow" target="_blank"> OpenStack </a>。</p><p id="59c4" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><a class="ae it" href="https://www.openstack.org/summit/vancouver-2015/summit-videos/presentation/walmart-and-039s-cloud-journey" rel="noopener ugc nofollow" target="_blank">沃尔玛一直采用OpenStack </a>作为其电子商务业务的计算骨干，而<a class="ae it" href="http://www.zdnet.com/article/walmarts-oneops-open-source-cloud-management-platform-could-become-part-of-openstack/" rel="noopener ugc nofollow" target="_blank">连接OpenStack和应用的桥梁是<strong class="iw hi"> OneOps </strong> </a>。受OneOps产品的启发和激励，我们开始将Kafka从共享裸机部署过渡到面向云的<strong class="iw hi">分散自助式</strong>部署。</p><p id="ba22" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">OneOps培养了真正的DevOps文化，其中一部分意味着通过OneOps提升服务的团队应该对其整个生命周期事件负责，例如添加容量、微调配置、升级/修补以及在需要时反弹服务。这种新的OneOps(自助服务)模型允许Kafka用户通过OneOps定制和部署自己的Kafka集群，方法是使用生产驱动的Kafka“OneOps pack”。自助服务模式的商业价值可以概括为:</p><p id="5f8c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">它更加面向业务:每个团队部署并拥有自己的基础设施和服务，以满足业务目标和期望，而不是共享的集群和服务。</p><p id="6942" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">通过使用Kafka pack，它不仅可以自动部署和配置Kafka集群，还可以为Kafka提供GUI。GUI托管操作功能和性能监控，提供涵盖大多数Kafka日常操作任务和全面的Kafka级和服务器级性能指标的“一站式”体验。此外，Kafka pack可以在出现问题时通过OneOps提醒用户，例如Kafka进程停止、分区复制不足、leader丢失、磁盘空间不足、CPU利用率非常高。</p><p id="1488" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">通过采用自助式Kafka模型，应用程序团队现在可以完全控制操作、容量和配置调整，从而保证专用资源的性能。监控和警报大大增强了Kafka支持的消息服务的可见性和生产就绪性。</p><h1 id="d4ca" class="jx jy hh bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">从过渡中吸取的经验教训</h1><p id="7c86" class="pw-post-body-paragraph iu iv hh iw b ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn kz jp jq jr ha bi translated">自助式模型有助于应用程序团队快速、轻松地拥有和操作Kafka集群。与此同时，它也给Kafka集群所有者和Kafka pack开发者带来了新的挑战:</p><p id="d561" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">卡夫卡集群主人</strong>:学习适应新的自助模式和DevOps文化。当从第一天开始拥有Kafka集群时，他们负责操作和监控它，特别是学习如何快速处理常见故障并在影响最小的情况下恢复。</p><p id="eed2" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi"> Kafka模式/包开发者</strong>:提供健壮的、高度可用的、可伸缩的Kafka部署策略。例如，Kafka pack利用了OneOps的“自动驾驶”功能，它可以自动修复坏节点，在自动修复失败时自动替换它，并在负载达到预定义的阈值时自动扩展Kafka集群。</p><p id="4b46" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">运行自助式Kafka集群的成功取决于所有者和开发者之间的密切沟通和协作。开发人员不仅负责开发和支持该包，而且还是Kafka的内部专家，所有者可以咨询任何Kafka技术问题，包括最佳实践、部署策略、配置调整甚至Kafka生态系统的构建。</p><p id="bbea" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">反过来，开发人员也从所有者的日常操作中获得有价值的反馈，并在下一次迭代中对其进行概括以改进Kafka pack。这将形成一个积极的循环，令人满意地积累最佳实践，并将它们反馈给现有的和新的所有者。</p><h1 id="7606" class="jx jy hh bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">摘要</h1><p id="7a7b" class="pw-post-body-paragraph iu iv hh iw b ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn kz jp jq jr ha bi translated">这并不是我们Kafka故事的结尾:更多的技术细节可以在部署策略、内部Kafka分叉、监控管道和跨数据中心的高可用性上分享。</p><p id="8e58" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">请继续关注关于卡夫卡的深度解读！</p><p id="7a3a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">推特:<a class="ae it" href="https://twitter.com/NingZhang6" rel="noopener ugc nofollow" target="_blank"> @ningZhang6 </a></p></div></div>    
</body>
</html>