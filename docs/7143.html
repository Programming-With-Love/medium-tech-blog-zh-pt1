<html>
<head>
<title>Shared App Functionality via JavaScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过JavaScript共享应用功能</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/shared-app-functionality-via-javascript-bbba4f0cb3ea?source=collection_archive---------0-----------------------#2016-01-19">https://medium.com/square-corner-blog/shared-app-functionality-via-javascript-bbba4f0cb3ea?source=collection_archive---------0-----------------------#2016-01-19</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="b7c7" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">我们如何创建一种灵活的方式来离线查看Square现金支付。</h2></div><p id="3088" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="js">由</em> <a class="jt ju ge" href="https://medium.com/u/bdc2de5d06c0?source=post_page-----bbba4f0cb3ea--------------------------------" rel="noopener" target="_blank"> <em class="js">阿兰·鲍林</em> </a> <em class="js">撰写。</em></p><blockquote class="jv"><p id="384f" class="jw jx hh bd jy jz ka kb kc kd ke jr dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae kf" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><p id="44a5" class="pw-post-body-paragraph iw ix hh iy b iz kg ii jb jc kh il je jf ki jh ji jj kj jl jm jn kk jp jq jr ha bi translated">在构建<a class="ae kf" href="https://cash.me/" rel="noopener ugc nofollow" target="_blank"> Square Cash app </a>的2.9版本时，我们遇到了一个有趣的挑战。该应用程序正在从我们的服务器获取支付对象，需要显示给用户。这基本上包括为每笔付款选择一个模板并格式化数据。为简单起见，假设数据包括日期、金额和收件人姓名，并且需要生成一个可显示的字符串，如:“您在下午3:00向Erin Hills发送了20美元。”</p><p id="c3ca" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们首先考虑将逻辑和模板烘焙到应用程序中，但这将导致一个不灵活的系统，我们需要启动新版本的应用程序来适应变化。旧版本将无法正确显示支付，并且逻辑需要在每个支持的平台(iOS和Android)上重复。我们的工程速度将会大大降低。</p><p id="3c12" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">很长一段时间，我们通过让服务器返回完整呈现的数据而不是原始数据来解决这个问题。这实现了灵活性，但代价是一些大的缺点。最重要的问题是应用程序需要一个网络连接，并且需要不断地请求显示支付的视图(因为显示的数据是时间敏感的)。这导致了过度的数据使用，滞后可能会导致过时。当我们致力于开发离线支付功能时，我们知道这种方法不再可行。</p><h1 id="f04a" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">解决办法</h1><p id="7420" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">我们找到的解决方案是在应用中使用JavaScript引擎，从原始对象中产生呈现的字符串。这非常有效。在JavaScript引擎中运行的JavaScript库实际上包含一系列模板和一个翻译函数，该函数使用原始对象，然后应用适当的模板，最后输出呈现的数据。</p><p id="055c" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">下面是一个从服务器获取的原始对象的简化示例，该对象从应用程序传递到JavaScript库:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="7914" class="lr km hh ln b fi ls lt l lu lv">{<br/>  amount_cents: 2000,<br/>  recipient_name: “Erin Hills”<br/>  date : “2016-01-19T15:00:00Z”<br/>}</span></pre><p id="6db6" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">JavaScript库生成以下对象，并将其传递回应用程序:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="84e9" class="lr km hh ln b fi ls lt l lu lv">{<br/>  description: “You sent $20 to Erin Hills at 3:00 pm”<br/>}</span></pre><p id="1f56" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">显示的数据对当前日期和时区敏感。如果用户一天后在没有网络连接的情况下打开应用程序，相同的JavaScript可能会产生:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="f8ec" class="lr km hh ln b fi ls lt l lu lv">{<br/>  description: “You sent $20 to Erin Hills yesterday”<br/>}</span></pre><p id="a557" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">更新字符串或添加对新支付类型的支持可以通过更改JavaScript来完成。这里有一个简单的例子，说明我们何时增加了对非营利组织捐款的支持。原始数据:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="f97d" class="lr km hh ln b fi ls lt l lu lv">{<br/>  amount_cents: 2000,<br/>  recipient_name: “Wikipedia”<br/>  date: “2016-01-19T15:00:00Z”,<br/>  type: “NON-PROFIT”<br/>}</span></pre><p id="dac9" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">JavaScript会将其转换成:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="c532" class="lr km hh ln b fi ls lt l lu lv">{<br/>  description: “You donated $20 to Wikipedia yesterday. No goods or services were provided in exchange for this contribution.”<br/>}</span></pre><h1 id="616a" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">履行</h1><p id="585f" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">iOS 7通过其<a class="ae kf" href="https://developer.apple.com/library/mac/documentation/Carbon/Reference/WebKit_JavaScriptCore_Ref/" rel="noopener ugc nofollow" target="_blank"> JavaScriptCore </a>框架引入了对无浏览器JavaScript引擎的支持。这就形成了一个简单的开箱即用的解决方案，只需很少的时间就可以启动并运行。</p><p id="968b" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在Android中，标准API中没有内置框架。因此，我们构建了一个<a class="ae kf" href="https://github.com/square/duktape-android" rel="noopener ugc nofollow" target="_blank">开源</a> Java绑定到<a class="ae kf" href="http://duktape.org/" rel="noopener ugc nofollow" target="_blank"> Duktape </a>，一个可嵌入的JavaScript引擎。我们内置了对时区的支持，将JavaScript堆栈跟踪转换为Java堆栈跟踪(当JavaScript抛出时)，以及其他功能。</p><p id="33bf" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">应用程序调用的JavaScript函数(实际上是本机代码和JavaScript之间的接口)需要使用原语对象。实际上，我们的库向应用程序公开的函数都有一个或多个输入字符串参数，并且都返回一个字符串。JavaScript库负责将输入解析成JSON对象。这些应用程序负责将字符串化JSON的输出序列化为本机对象。</p><p id="cc55" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">服务器将JavaScript库作为单个文件托管，应用程序定期检查更新版本。这个机制的实现使用ETags来重新下载JavaScript文件。</p><p id="8c7b" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们发现有用的一个实现细节是将原始对象作为不透明字符串而不是强类型对象传递给应用程序。这使得服务器可以完全控制原始对象和使用它的JavaScript。新字段可以添加到原始对象，而应用程序不会知道或受到影响。</p><h1 id="8c38" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">额外好处</h1><p id="6e23" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">JavaScript的一个好处是它不局限于本地应用。同样的库也可以在web中使用。这可能是这种方法最好的方面之一:逻辑位于一个位置(服务器)，而不是跨iOS、Android和web复制。这有助于确保一致的体验，减少所需的测试数量，并提高我们的工程速度。</p><h1 id="787b" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">结论</h1><p id="f2bb" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">共享JavaScript库的使用使得Square现金支付可以离线查看，同时允许演示文稿独立于新的应用程序版本进行更新。我们很高兴将这种方法扩展到应用程序的其他领域。感谢Michael Druker、Dan Federman、Matt Precious、Alec Strong、Shawn Welch、Jesse Wilson和Shawn Zurbrigg为此做出的贡献。</p></div><div class="ab cl lw lx go ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ha hb hc hd he"><div class="li lj lk ll fd md"><a rel="noopener follow" target="_blank" href="/@alanpaulin"><div class="me ab dw"><div class="mf ab mg cl cj mh"><h2 class="bd hi fi z dy mi ea eb mj ed ef hg bi translated">艾伦·波林-简介</h2><div class="mk l"><h3 class="bd b fi z dy mi ea eb mj ed ef dx translated">关注Alan Paulin - Profile在Medium上的最新活动，查看他们的故事和推荐。</h3></div><div class="ml l"><p class="bd b fp z dy mi ea eb mj ed ef dx translated">medium.com</p></div></div><div class="mm l"><div class="mn l mo mp mq mm mr ms md"/></div></div></a></div></div></div>    
</body>
</html>