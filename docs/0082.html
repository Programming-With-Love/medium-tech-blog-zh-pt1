<html>
<head>
<title>Building Services at Airbnb, Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Airbnb的建筑服务，第1部分</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/building-services-at-airbnb-part-1-c4c1d8fa811b?source=collection_archive---------1-----------------------#2017-12-12">https://medium.com/airbnb-engineering/building-services-at-airbnb-part-1-c4c1d8fa811b?source=collection_archive---------1-----------------------#2017-12-12</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="1736" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated"><strong class="ak">本文是关于扩展服务开发的系列文章中的第一篇，着眼于核心结构，即支撑Airbnb新的面向服务架构的服务IDL。</strong></h2></div><p id="fd99" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="js">由、</em> <a class="ae jt" href="https://www.linkedin.com/in/frank-lin-7712154/" rel="noopener ugc nofollow" target="_blank"> <em class="js">费林零</em> </a> <em class="js">和</em> <a class="ae jt" href="https://www.linkedin.com/in/junjie-guan-5192b85a/" rel="noopener ugc nofollow" target="_blank"> <em class="js">接君卦</em> </a> <em class="js"> n </em></p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ju"><img src="../Images/eff0faa8e85b9f21a9520124b4b10e0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ab7m_B9mwLz30DGp8W9UWA.jpeg"/></div></div><figcaption class="kg kh et er es ki kj bd b be z dx">Alexis, one of our hosts, shows some of her guests how to shuck oysters in <a class="ae jt" href="https://www.airbnb.com/experiences/168498" rel="noopener ugc nofollow" target="_blank">East Boston</a></figcaption></figure><p id="3117" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Airbnb正在加速将其基础设施向SOA(面向服务的架构)迁移，但在构建新产品和新功能的同时，从单一的Rails服务向SOA迁移并非没有挑战。</p><p id="5dbf" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在本帖中，我们分享了我们为扩展服务开发而设计和构建的东西——使用相同的工程师工时来构建更多更健壮、更高效、更易于维护的后端服务。这是关于这个话题的一系列文章中的第一篇；在本帖中，我们将呈现该方法和整体架构的鸟瞰图，后续的帖子将深入到具体的组件。</p><h1 id="42e3" class="kk kl hh bd km kn ko kp kq kr ks kt ku in kv io kw iq kx ir ky it kz iu la lb bi translated">我们以前拥有的</h1><p id="ef8e" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf le jh ji jj lf jl jm jn lg jp jq jr ha bi translated">在Airbnb，后端服务大多是使用<a class="ae jt" href="http://www.dropwizard.io" rel="noopener ugc nofollow" target="_blank"> Dropwizard </a> web服务框架用Java编写的，许多Airbnb专用的定制Dropwizard过滤器和模块标准化了服务器端的最佳实践。此外，<em class="js"> make-me-a-service </em>工具帮助工程师引导一个随时可以部署的Dropwizard应用程序框架，在此基础上，工程师添加RESTful和JSON-over-HTTP服务资源端点。</p><p id="c6ac" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">然而，上述组合仍有许多不足之处；服务开发人员提出的主要缺点包括:</p><ol class=""><li id="89d1" class="lh li hh iy b iz ja jc jd jf lj jj lk jn ll jr lm ln lo lp bi translated">它缺乏明确定义和强类型的服务接口和数据模式。如果不检查源代码，通常很难知道服务做什么以及如何发送请求和接收响应。此外，过去在进行违反合同的变更时，缺乏服务/客户合同验证曾导致生产事故。</li><li id="ad1d" class="lh li hh iy b iz lq jc lr jf ls jj lt jn lu jr lm ln lo lp bi translated">RESTful服务框架不提供服务RPCs开发人员必须花费大量的时间为他们的服务编写Ruby和Java客户端。好的RPC代码不仅仅是HTTP客户端包装器；它应包括标准基础架构要求和平台最佳实践的可靠实施，例如，传递请求上下文、测量请求和性能指标、传播服务异常和原因、启用相互TLS以及对服务端点进行监控和警报。所有这些都需要数小时甚至数天的额外工程工作。</li><li id="96f3" class="lh li hh iy b iz lq jc lr jf ls jj lt jn lu jr lm ln lo lp bi translated">与用于高性能服务间通信的紧凑的、模式化的二进制格式相比，JSON请求/响应数据有效负载很大且效率很低(例如字符串字段名)，特别是对于第95和第99百分位的有效负载。</li></ol><h1 id="0f95" class="kk kl hh bd km kn ko kp kq kr ks kt ku in kv io kw iq kx ir ky it kz iu la lb bi translated">用于扩展服务开发的结构</h1><h2 id="d55d" class="lv kl hh bd km lw lx ly kq lz ma mb ku jf mc md kw jj me mf ky jn mg mh la mi bi translated">现成的解决方案</h2><p id="2699" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf le jh ji jj lf jl jm jn lg jp jq jr ha bi translated">服务的API包括服务接口和请求/响应数据模式。在REST服务领域，Swagger之类的工具可用于自动化一些样板任务，如记录REST API和提供基本的客户端代码生成。然而，与成熟的服务RPC框架(如Apache Thrift和Google gRPC)相比，大多数REST工具缺乏丰富的功能(如强类型支持、请求/响应验证、有效的有效负载编码和传输协议),这些功能可以加速健壮和高性能服务的开发。</p><p id="56c0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Thrift和gRPC是两种流行的RPC系统，被业界广泛采用。然而，将Airbnb的HTTP服务栈替换为任何一个都意味着基础设施的大规模大修，这将需要大量的工程资源，并对生产力造成重大干扰。</p><h2 id="fc66" class="lv kl hh bd km lw lx ly kq lz ma mb ku jf mc md kw jj me mf ky jn mg mh la mi bi translated">我们的方法</h2><p id="b7c1" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf le jh ji jj lf jl jm jn lg jp jq jr ha bi translated">在权衡了不同技术方法的利弊之后，我们决定采用一种不会中断当前Java服务开发过程的方法，同时为将来逐步改进和发展服务架构提供了可能性。我们的方法是保留Dropwizard服务框架，在框架中添加定制的Thrift service IDL(接口定义语言)，将传输协议从<em class="js"> JSON-over-Http </em>切换到<em class="js"> Thrift-over-Http </em>，并构建工具来生成不同语言的RPC客户端。</p><p id="8e50" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们将在下面更详细地解释这种方法如何在最小化中断的同时扩大开发规模。</p><h2 id="280f" class="lv kl hh bd km lw lx ly kq lz ma mb ku jf mc md kw jj me mf ky jn mg mh la mi bi translated">以节俭为服务</h2><p id="2603" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf le jh ji jj lf jl jm jn lg jp jq jr ha bi translated">我们使用Thrift IDL来定义服务的API——它的接口和请求/响应数据模式。在基于服务IDL的Java服务开发流程中，开发者在<em class="js">中定义服务API。thrift </em>文件，通过Airbnb服务平台从这些文件中生成服务端代码和RPC客户端，这是帮助实施基础设施最佳实践的标准工具。这简化了服务开发，并允许工程师专注于编写服务业务逻辑，而不是管道和监控工作(例如，服务间传输、度量、警报和向后兼容的API管理)。</p><h2 id="ad5d" class="lv kl hh bd km lw lx ly kq lz ma mb ku jf mc md kw jj me mf ky jn mg mh la mi bi translated">启用HTTP上的节约</h2><p id="2a23" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf le jh ji jj lf jl jm jn lg jp jq jr ha bi translated">服务开发人员熟悉Dropwizard服务框架，并为其构建了许多公共库。Dropwizard是<em class="js"> JSON-over-Http </em>(使用<em class="js"> </em> Jersey和Jackson库)，但是我们想把Thrift service IDL带到服务开发中。由于不中断当前的服务框架和服务间通信协议很重要，我们扩展了Dropwizard的Thrift有效负载类型支持，使服务间通信协议从<em class="js"> JSON-over-Http </em>无缝过渡到<em class="js"> Thrift-over-Http </em>。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es mj"><img src="../Images/c36a70192b6dbd4991f4ff791eb79f08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X6EKE2Gy7hqsfyvKn_2HHg.png"/></div></div></figure><h2 id="8e37" class="lv kl hh bd km lw lx ly kq lz ma mb ku jf mc md kw jj me mf ky jn mg mh la mi bi translated">强类型API</h2><p id="79e0" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf le jh ji jj lf jl jm jn lg jp jq jr ha bi translated">使用Thrift作为服务IDL本质上为服务API提供了清晰的定义和文档；而且，数据模式中的每个字段都有明确定义的类型，这些类型在生成的Java和Ruby数据类中被严格执行。通过内置的模式实施和精心设计的服务器端和客户端生成的代码，管理API向后兼容性变得更加简单和容易。</p><p id="7a8f" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们还扩展了普通Apache Thrift IDL之外的类型，增加了日期<em class="js">和日期<em class="js">日期</em>。类型扩展背后的基本原理是基于过去的经验——如果服务开发人员被限制在太少的类型集合中，他们最终会通过现有的类型(例如，作为字符串的日期)来改变他们想要的类型，绕过自动的类型检查和验证，并违背拥有强类型模式的目的。</em></p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es mk"><img src="../Images/e0a8de84ee9081688d09c2220e39ac10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pwz6grs4eF5UQDHeRVtm4Q.png"/></div></div></figure><h1 id="ffea" class="kk kl hh bd km kn ko kp kq kr ks kt ku in kv io kw iq kx ir ky it kz iu la lb bi translated">Apache Thrift之外的服务IDL和扩展</h1><p id="341e" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf le jh ji jj lf jl jm jn lg jp jq jr ha bi translated">编写服务比简单地实现服务器端业务逻辑需要更多的工作。用不同的语言实现服务RPC客户端、设置和执行服务间通信、添加用于监控的服务端和客户端指标，以及采用标准的服务平台实践，这些都是繁琐的工作，容易出错，并且会导致巨大的工程成本。在service IDL出现之前，创建和管理服务的成本导致工程师和管理层在时间压力下回避SOA。</p><p id="8594" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们希望使用service IDL进行的服务开发简单、经济高效，并在附加好处方面提供一个step函数。为此，香草阿帕奇节俭是不够的。我们对现有的Thrift IDL编译器进行了广泛的定制，以生成具有许多附加特性的服务样板代码和RPC客户端。我们相信这是加速Airbnb技术栈向SOA迁移的关键。</p><p id="f7db" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">下图显示了一个示例Java服务，名为Banana，使用服务IDL、Ruby服务和另一个Java服务，使用生成的服务客户端进行RPC调用。红色的组件是基于Banana的服务IDL自动生成/检测的。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ml"><img src="../Images/bf78717502e228ccc76a58a64b289cff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7hq4o9KSPl4hALFlbrteZA.png"/></div></div></figure><h2 id="64c1" class="lv kl hh bd km lw lx ly kq lz ma mb ku jf mc md kw jj me mf ky jn mg mh la mi bi translated">服务IDL依赖和编译器集成</h2><p id="b0e5" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf le jh ji jj lf jl jm jn lg jp jq jr ha bi translated">服务开发人员除了编写他们的服务IDL之外，还可以通过指向其他服务IDL文件来声明服务依赖。服务的IDL文件和它所依赖的服务的IDL文件都无缝地集成到现有的构建过程和构建工具中。服务开发人员做他们以前一直在做的事情，他们需要的所有IDL相关代码都是自动生成的，并显示在他们的IDE中，无需额外的步骤。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es mm"><img src="../Images/d20bc8e3e756f28287ea7f2260e0d626.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gomuURep3dFjhe16RAN6XA.png"/></div></div></figure><h2 id="5b26" class="lv kl hh bd km lw lx ly kq lz ma mb ku jf mc md kw jj me mf ky jn mg mh la mi bi translated">服务框架样板代码</h2><p id="2a4f" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf le jh ji jj lf jl jm jn lg jp jq jr ha bi translated">我们用Dropwizard资源生成扩展了Apache Thrift代码生成器。生成的服务资源类和方法带有必要的Jersey和Jackson注释，以支持HTTP有效负载中的JSON和Thrift媒体类型——服务可以接收和返回JSON和Thrift请求/响应数据。节俭二进制传输是为了性能，而JSON是为了与旧服务兼容，并便于测试和调试。</p><p id="cc01" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">由于生成了业务逻辑和Dropwizard之间的粘合代码，服务开发人员可以编写与底层web服务器框架无关的代码；因此，如果我们升级Dropwizard或放弃Dropwizard，迁移会更容易。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es mn"><img src="../Images/14971dfed0776f0d3fed90d92030a3c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RBkmsdLQxZyWEyFv88E7SA.png"/></div></div></figure><h2 id="1949" class="lv kl hh bd km lw lx ly kq lz ma mb ku jf mc md kw jj me mf ky jn mg mh la mi bi translated">RPC客户端</h2><p id="a4ed" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf le jh ji jj lf jl jm jn lg jp jq jr ha bi translated">在服务IDL之前，工程师必须为与他们的服务对话的其他应用程序实现客户机。用一种以上的语言编写客户机不仅耗时，而且很快就会过时，失去对等性(例如，在Ruby和Java客户机之间)。有了service IDL，现成的Java和Ruby API客户端就完全生成了。这些生成的客户机不是普通Apache Thrift附带的Ruby或Java的Thrift客户机。它们是RPC客户端，提供了许多普通Apache Thrift中没有的功能(例如，mTLS、重试、验证、请求上下文)。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es mo"><img src="../Images/32e893cc56a477611163705ab28cf333.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3d_mo1X4uFf0ZB7Z-e5CIg.png"/></div></div></figure><h2 id="b681" class="lv kl hh bd km lw lx ly kq lz ma mb ku jf mc md kw jj me mf ky jn mg mh la mi bi translated">服务平台标准实践</h2><p id="40fb" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf le jh ji jj lf jl jm jn lg jp jq jr ha bi translated">随着工程师构建更多的服务，所有服务都采用一致的最佳实践是非常重要的。例如，服务请求有关联的上下文信息，请求上下文应该在服务RPC调用链上传播。如果不同的服务以不同的方式传播这个上下文(或者根本不传播)，或者如果这个上下文是以不同的方式定义和获取的，那么这将很难管理。如果每个服务发出不同的度量标准并有不同类型的警报，那么SRE监控和调试SOA问题也会很头疼。在服务器端和客户端发出标准的请求和响应指标，不仅可以更好地监控服务拥有团队的内部和外部，还可以用来创建自动化的服务仪表板和警报。服务客户端也应该采用标准的RPC超时、重试和断路器逻辑；我们生成的RPC客户端使得服务开发人员不必自己实现这些RPC弹性特性。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es mp"><img src="../Images/6fc9989da90da17ea9371116562c2c36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5HbX74iyw5J9kK7bOYw87g.png"/></div></div></figure><h1 id="8868" class="kk kl hh bd km kn ko kp kq kr ks kt ku in kv io kw iq kx ir ky it kz iu la lb bi translated">结果</h1><p id="610f" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf le jh ji jj lf jl jm jn lg jp jq jr ha bi translated">将Thrift service IDL添加到我们的Java服务框架中是迈向可靠、高性能和开发者友好的服务平台的重要的第一步。它是一个核心结构，随着Airbnb将其基础设施转向SOA，可以在此基础上构建更多开发规模的功能。</p><p id="ac1c" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">新的服务IDL驱动的Java服务开发过程自发布以来已经被产品团队广泛接受。它大大提高了开发速度；使用service IDL构建的几个新的Java服务，从服务开始到获得生产流量，只花了三周时间——我们估计在之前的开发过程中，每个Java服务节省了2-3周的工程时间。我们计划将服务IDL支持扩展到Ruby服务。</p><p id="e82a" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在这篇文章中，我们展示了在最小化中断的同时扩展服务开发的方法，并介绍了作为该方法核心的服务IDL。我们忽略了服务IDL的各种组件的许多设计和实现细节；在本系列的后续文章中，我们将对它们进行更深入的讨论。敬请期待！</p></div><div class="ab cl mq mr go ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ha hb hc hd he"><p id="4656" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果你喜欢阅读这篇文章，并认为这是一个有趣的挑战，生产平台团队一直在寻找有才华的工程师<a class="ae jt" href="https://www.airbnb.com/careers/departments/engineering" rel="noopener ugc nofollow" target="_blank">加入团队</a>。</p></div><div class="ab cl mq mr go ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ha hb hc hd he"><p id="c7b7" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="js">非常感谢Victor Peng、Xing An、Mike Parker、Liao、Mousom Dhar Gupta、Weibo He、Rahul Agrawal、Charlie Zhou、Lynn Lu、、Zhong、Luca Luo、、Jessica Tai的贡献、支持和反馈。</em></p></div></div>    
</body>
</html>