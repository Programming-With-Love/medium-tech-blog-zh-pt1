<html>
<head>
<title>MS Office File Formats — Advanced Malicious Document (Maldoc) Techniques</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MS Office文件格式—高级恶意文档(Maldoc)技术</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/ms-office-file-formats-advanced-malicious-document-maldoc-techniques-b5f948950fdf?source=collection_archive---------2-----------------------#2018-10-05">https://medium.com/walmartglobaltech/ms-office-file-formats-advanced-malicious-document-maldoc-techniques-b5f948950fdf?source=collection_archive---------2-----------------------#2018-10-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="72b0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作者:Kirk say re(<a class="ae jc" href="https://twitter.com/bigmacjpg" rel="noopener ugc nofollow" target="_blank">@ biggmacjpg</a>)、Harold Ogden(<a class="ae jc" href="https://twitter.com/haroldogden" rel="noopener ugc nofollow" target="_blank">@ haroldogden</a>)和Carrie Roberts(<a class="ae jc" href="https://twitter.com/OrOneEqualsOne" rel="noopener ugc nofollow" target="_blank">@ oronequalsone</a>)</p><p id="139d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">欢迎阅读关于高级恶意文档(Maldoc)技术的一系列博客文章中的第一篇。本文将讨论MS Office使用的基本文件格式及其一些含义。这里提供的基础信息将为后续帖子奠定基础。对于其他一些激动人心的内容，一定要阅读后续的<strong class="ig hi"> <em class="jd">躲躲闪闪的VBA </em> </strong>和<strong class="ig hi"> <em class="jd"> VBA跺脚</em> </strong>文章。</p><p id="00a7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">MS Office文档的文件格式会影响防病毒解决方案处理该文件的方式。旧的Office 97–2003文件格式使用OLE ( <a class="ae jc" href="https://msdn.microsoft.com/en-us/library/19z074ky.aspx" rel="noopener ugc nofollow" target="_blank">对象链接和嵌入</a>)文件格式。这是一种复杂的二进制格式，不容易手动操作。另一方面，较新版本的Office保存为描述文档的较小单个文件的压缩存档(也称zip文件)。大多数文件都是人类可读的XML文件，但在某些情况下，如启用了宏的文档，存档也可以是OLE文件。特别感兴趣的是名为vbaProject.bin的OLE文件中启用宏的文档。该文件包含要执行的宏代码的详细信息。</p><p id="e49f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Office 97-2003 Word文档的文件扩展名始终为<strong class="ig hi">。文档</strong>，而较新的Office版本使用了一个<strong class="ig hi">。docx </strong>为标准文件，<strong class="ig hi">。docm </strong>用于包含宏的文件。如果没有<strong class="ig hi">，MS Office应用程序将拒绝保存包含宏的文档。docm </strong>扩展为新的zip存档文件格式。为了避免这种情况，您可以简单地在从Office保存后用另一个工具重命名该文件，或者您可以选择旧的Office 97-2003文件格式。</p><p id="319a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">手动重命名一个<strong class="ig hi">。docm </strong>到<strong class="ig hi">。doc，</strong>例如使用文件资源管理器，不会改变文件的“幻数”。幻数是文件开头的一系列字节，用于标识文件类型。在<strong class="ig hi">的情况下。docm </strong>，幻数为504b0304表示是zip存档。将这样的文件重命名为<strong class="ig hi">。doc </strong>不改变幻数，文件在MS Office中继续正常运行。旧的MS Office文件格式为<strong class="ig hi">。doc </strong>文件以d0cf11e的幻数开头(“doc文件”的可爱十六进制表示)。文件扩展名和幻数不匹配是不常见的，这可能表明作者有恶意。</p><p id="a8a1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如前所述，<strong class="ig hi">。docm </strong>文件格式是许多其他文件的压缩存档。特别感兴趣的是解压缩MS word文档时在“Word”目录中找到的vbaProject.bin文件，如下所示。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/69c90e68554de1847623c00b6e43415d.png" data-original-src="https://miro.medium.com/v2/resize:fit:934/format:webp/1*7gSY365nuddqoub0zyOCeA.png"/></div></figure><p id="9740" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">vbaProject.bin文件包含有关要执行的宏代码的信息。这是MS Word默认情况下保存文件的位置和文件名，但可以手动更改以破坏反病毒检测或反向工程。Philippe Lagadec的<a class="ae jc" href="http://www.decalage.info/files/JCV07_Lagadec_OpenDocument_OpenXML_v4_decalage.pdf" rel="noopener ugc nofollow" target="_blank"> OpenDocument和Open XML Security </a>论文描述了这种规避技术以及其他技术。重命名vbaProject.bin所需的步骤如下(来自Philippe的文档)。</p><p id="1a8d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">1.将“vbaProject.bin”重命名为“no_macros_here.txt”</p><p id="7f00" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2.更新“word/_rels/document.xml.rels”中的关系</p><p id="8e32" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">3.在“[内容类型]中。xml”，将“bin”替换为“txt”</p><p id="1c3d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作为反病毒规避的演示，向Virus Total上传了一个标准的攻击宏。一次上传未被修改，第二次上传将vbaProject.bin文件重命名为ver.txt。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es jm"><img src="../Images/e5bbf9accf59c5032d1d7528d50a3e68.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*J4wri6_ih-J02gBQuKsG3g.png"/></div></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es jn"><img src="../Images/75ccf6df5c39050ea3285438a861224c.png" data-original-src="https://miro.medium.com/v2/resize:fit:608/format:webp/1*pQ5H4Nfx75nsW8R99hINNA.png"/></div></figure><p id="d576" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">VT哈希:f77e 0716 c 2994607 e 2e 2 de 7 ea 41d 04687 c 9 b 2533883753560 ea 4 f 4d 1d 29 ba 41 bbd和29 a7 cbdb 40398 f 63377 e 8 ad 99d 5 ecce D5 3 b 8 f 087 ef 2c 0 c 019835 BD 3 BC 1 f 7 b 2</p><p id="4f4b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">病毒检测率降低了6%，但文档的行为没有改变。除了重命名的文件之外，包含良性或误导性的虚拟vbaProject.bin文件也可能会分散分析师对真正恶意负载的注意力。</p><p id="1d8d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">存档中另一个有趣的文件是vbaData.xml文件，它包含宏名。作为维护者，您可以利用这一点来禁用被配置为在文档打开时自动运行的宏。关于如何做到这一点的详细信息，请参见博客上的<strong class="ig hi"> <em class="jd"> VBA跺脚</em> </strong>。</p></div></div>    
</body>
</html>