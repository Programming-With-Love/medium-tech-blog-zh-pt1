<html>
<head>
<title>Unit Test (Redis) in Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Golang的单元测试(Redis)</h1>
<blockquote>原文：<a href="https://medium.easyread.co/unit-test-redis-in-golang-c22b5589ea37?source=collection_archive---------0-----------------------#2020-06-16">https://medium.easyread.co/unit-test-redis-in-golang-c22b5589ea37?source=collection_archive---------0-----------------------#2020-06-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="892d" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">如何用Golang模拟我们的Redis代码进行单元测试</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/67e5fa73da905bb35f6ee42f9e721ab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MYWxpVvsE8TKLSnyVRhCQA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk"><a class="ae ks" href="https://www.vecteezy.com/free-vector/research" rel="noopener ugc nofollow" target="_blank">Research Vectors by Vecteezy</a></figcaption></figure><p id="9459" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">大家好！和我一起，一次又一次地，分享一些关于软件工程领域技术相关的经验、想法或观点。在这一部分中，我想分享如何在Golang中模拟我们的Redis代码以进行单元测试。</p><p id="b37a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">老实说，我对如何为Redis制作有点困惑。因为没有像DATA-DOG的go-sqlmock这样受欢迎的库。直到我发现了这篇很棒的文章，《Go   中的<a class="ae ks" href="https://medium.com/@elliotchance/mocking-redis-in-unit-tests-in-go-28aff285b98" rel="noopener"><em class="lp">嘲讽单元测试中的雷迪斯》。</em></a></p><p id="a0cf" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">不错，很有帮助！但是，我应该修改我现有的代码，以便在测试和实际实现中都能很好地工作。所以，我们开始做一个简单的例子测试吧！我们将需要3个库来运行测试。</p><ul class=""><li id="e999" class="lq lr in kv b kw kx kz la lc ls lg lt lk lu lo lv lw lx ly bi translated"><strong class="kv io">对于假冒的Redis服务器:</strong><a class="ae ks" href="https://github.com/alicebob/miniredis" rel="noopener ugc nofollow" target="_blank">https://github.com/alicebob/miniredis</a></li><li id="0d9c" class="lq lr in kv b kw lz kz ma lc mb lg mc lk md lo lv lw lx ly bi translated"><strong class="kv io">与Redis互动:</strong>s<a class="ae ks" href="https://github.com/elliotchance/redismock" rel="noopener ugc nofollow" target="_blank">https://github.com/elliotchance/redismock</a></li><li id="2553" class="lq lr in kv b kw lz kz ma lc mb lg mc lk md lo lv lw lx ly bi translated"><strong class="kv io">对于Redis客户端:</strong><a class="ae ks" href="https://github.com/go-redis/redis" rel="noopener ugc nofollow" target="_blank">https://github.com/go-redis/redis</a></li></ul><p id="3ac3" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">首先，像这样创建项目结构:</p><pre class="kd ke kf kg gt me mf mg mh aw mi bi"><span id="729b" class="mj mk in mf b gy ml mm l mn mo"><em class="lp">+ your_gopath/<br/>|<br/>+--+ src/github.com/moemoe89<br/>|  |<br/>|  +--+ go-unit-test-redis/<br/>|     |<br/>|     +--+ main.go<br/>|        + repository/<br/>|        |<br/>|        +--+ repository.go<br/>|           + repository_test.go<br/>|<br/>+--+ bin/<br/>|  |<br/>|  +-- ... executable file<br/>|<br/>+--+ pkg/<br/>   |<br/>   +-- ... all dependency_library required</em></span></pre><p id="f41e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">之后，我们需要在<code class="fe mp mq mr mf b"><strong class="kv io">repository</strong></code>目录下创建两个文件:<code class="fe mp mq mr mf b"><strong class="kv io">repository.go</strong></code>和<code class="fe mp mq mr mf b"><strong class="kv io">repository_test.go</strong></code>。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="ade9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">首先，<code class="fe mp mq mr mf b"><strong class="kv io">repository.go</strong></code>文件将有<code class="fe mp mq mr mf b"><strong class="kv io">Repository</strong></code>接口的实现，该接口有两个简单的函数用于设置和获取数据。如果您已经熟悉了干净架构的概念和依赖注入，那么代码对您来说就很容易了。如果你不熟悉的话，我给你推荐这篇<a class="ae ks" href="https://hackernoon.com/golang-clean-archithecture-efd6d7c43047" rel="noopener ugc nofollow" target="_blank"> <strong class="kv io"> <em class="lp">在Golang </em> </strong> </a> <strong class="kv io"> </strong>上尝试干净的架构由<a class="mu mv ep" href="https://medium.com/u/ef42567fbbae?source=post_page-----c22b5589ea37--------------------------------" rel="noopener" target="_blank"> Iman Tumorang </a>。这是一篇伟大的文章，也存在于印度尼西亚语中，<a class="ae ks" href="https://medium.com/golangid/mencoba-golang-clean-architecture-c2462f355f41" rel="noopener"> <strong class="kv io"> Mencoba干净的建筑pada Golang </strong> </a>。感谢伊曼的分享。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="104a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">最后，测试文件<code class="fe mp mq mr mf b"><strong class="kv io">repository_test.go</strong></code>将使用模拟数据测试存储库代码。为了更好地理解，我将对这一部分进行更多的解释。</p><p id="ff0b" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这个测试的主要代码，我们需要从miniredis使用run函数运行假Redis服务器。</p><pre class="kd ke kf kg gt me mf mg mh aw mi bi"><span id="890c" class="mj mk in mf b gy ml mm l mn mo">mr, err := miniredis.Run()<br/><strong class="mf io">if </strong>err != nil {<br/>   log.Fatalf(<strong class="mf io">"an error '%s' was not expected when opening a stub database connection"</strong>, err)<br/>}</span></pre><p id="de85" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">然后，使用来自miniredis address的地址从go-redis库中创建客户机连接。</p><pre class="kd ke kf kg gt me mf mg mh aw mi bi"><span id="4304" class="mj mk in mf b gy ml mm l mn mo">client = redis.NewClient(&amp;redis.Options{<br/>   Addr: mr.Addr(),<br/>})</span></pre><p id="a1a1" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">接下来，我们可以使用来自<strong class="kv io"> elliotchance </strong>的<strong class="kv io"> redismock库</strong>创建模拟函数。在下面的代码中，它是来自我们的Set和Get函数的模拟数据的例子。</p><pre class="kd ke kf kg gt me mf mg mh aw mi bi"><span id="bb07" class="mj mk in mf b gy ml mm l mn mo">mock := redismock.NewNiceMock(client)<br/>mock.On(<strong class="mf io">"Set"</strong>, key, val, exp).Return(redis.NewStatusResult(<strong class="mf io">""</strong>, nil))</span><span id="0ed0" class="mj mk in mf b gy mw mm l mn mo">mock := redismock.NewNiceMock(client)<br/>mock.On(<strong class="mf io">"Get"</strong>, key).Return(redis.NewStringResult(val, nil))</span></pre><p id="b501" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果你已经在使用DATA-DOG的go-sqlmock，是不是也差不多？</p><p id="79ca" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">好吧！是时候进行测试了。使用<code class="fe mp mq mr mf b"><strong class="kv io">go test ./...</strong></code>执行测试用例。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mx"><img src="../Images/6ee8107ea89dc4cde24a53a7d97fc643.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qUBjCCHVCbkaLh-bJSQYuw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Unit Test Result</figcaption></figure><p id="10ac" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">还有…酷，我们通过测试了！！起作用了！！</p><p id="31e5" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果您想查看这个测试的完整示例项目，您可以访问我在GitHub上的这个项目的存储库，<a class="ae ks" href="https://github.com/moemoe89/go-unit-test-redis" rel="noopener ugc nofollow" target="_blank"><strong class="kv io">moe moe 89/go-unit-test-redis</strong></a>。</p><div class="my mz gp gr na nb"><a href="https://github.com/moemoe89/go-unit-test-redis" rel="noopener  ugc nofollow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd io gy z fp ng fr fs nh fu fw im bi translated">moemoe89/go-unit-test-redis</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">📈Golang中Redis的模拟单元测试，用于我的中等故事材料- moemoe89/go-unit-test-redis</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">github.com</p></div></div><div class="nk l"><div class="nl l nm nn no nk np km nb"/></div></div></a></div><p id="f621" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">希望你喜欢它，我很高兴如果这篇文章对你有用！测试愉快！</p><p id="3f45" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">谢谢大家！</p></div><div class="ab cl nq nr hr ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="ig ih ii ij ik"><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nx mt l"/></div></figure></div></div>    
</body>
</html>