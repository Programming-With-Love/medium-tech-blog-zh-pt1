<html>
<head>
<title>Deteksi Slow Function di Golang dengan Profiling</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Deteksi Slow Function di Golang dengan Profiling</h1>
<blockquote>原文：<a href="https://medium.easyread.co/deteksi-slow-function-di-golang-dengan-profiling-2f6e5e51c1c?source=collection_archive---------3-----------------------#2018-04-19">https://medium.easyread.co/deteksi-slow-function-di-golang-dengan-profiling-2f6e5e51c1c?source=collection_archive---------3-----------------------#2018-04-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="7ef7" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">Langkah sederhana untuk mendeteksi slow function di golang menggunakan pprof</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/a5000227f604bfc09c503ae76efc0565.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XK29wZ4XgEh5iySqg8dQOw.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Slow Illustration by <a class="ae ks" href="https://unsplash.com/photos/qMWgy4LpaIs?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Alex Blăjan</a> on <a class="ae ks" href="https://unsplash.com/search/photos/slow?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="a1d9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Baru-baru ini, kami di <a class="ae ks" href="https://kurio.co.id" rel="noopener ugc nofollow" target="_blank"> Kurio </a> melakukan sedikit eksperimen sederhana, yakni melakukan <em class="lp"> tune-up </em> fungsi-fungsi pada API yang kami miliki.</p><p id="baee" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Berangkat dari permasalahan yang kami alami ketika membangun sebuah fitur di Kurio. Saat kami melakukan proses <em class="lp"> deploying </em> untuk fitur tersebut <em class="lp"> , </em> penggunaan CPU server kami tiba-tiba naik. Tentu saja hal tersebut sangat mengganggu, sehingga diperlukan penanganan serius. <em class="lp"> What really happen there </em> ?</p><p id="2f87" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="lp"> Nah </em> , untuk mengetahui apa yang sebenernya terjadi, langkah-langkah yang kami lakukan adalah:</p><ul class=""><li id="85ea" class="lq lr in kv b kw kx kz la lc ls lg lt lk lu lo lv lw lx ly bi translated">Mendeteksi <em class="lp"> slow function, </em> yakni mencari fungsi-fungsi yang menggunakan <em class="lp"> resource </em> paling banyak,</li><li id="ba4e" class="lq lr in kv b kw lz kz ma lc mb lg mc lk md lo lv lw lx ly bi translated"><em class="lp"> Improve function </em> , yakni melakukan pembaharuan pada fungsi tersebut dengan opsi yang optimal, dan</li><li id="648a" class="lq lr in kv b kw lz kz ma lc mb lg mc lk md lo lv lw lx ly bi translated">Penambahan <em class="lp"> cache </em> jika di perlukan.</li></ul><h1 id="3ce0" class="me mf in bd mg mh mi mj mk ml mm mn mo jt mp ju mq jw mr jx ms jz mt ka mu mv bi translated">Profiling Golang</h1><p id="f372" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">Untuk tahap pertama, yang kami lakukan adalah mendeteksi fungsi yang berat dan menggunakan <em class="lp"> resource </em> paling banyak. Hal ini ternyata sangat mudah untuk dilakukan di Golang.</p><p id="cddd" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Berkat package <code class="fe nb nc nd ne b">pprof</code> pada Golang, kita dapat dengan mudah mendeteksi fungsi apa saja yang memakan banyak <em class="lp"> resource </em> . Cara pemakaiannya juga cukup mudah. Kita hanya perlu <em class="lp"> mengimport </em> <em class="lp"> package </em> <code class="fe nb nc nd ne b">pprof</code> pada aplikasi yang ingin kita <em class="lp"> profiling </em> .</p><p id="52ea" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Pada <code class="fe nb nc nd ne b">pprof</code> Golang terdapat beberapa cara melakukan profiling:</p><p id="f7a1" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io"> Runtime Profiling </strong> <br/> <em class="lp"> Runtime profiling </em> digunakan untuk aplikasi <em class="lp"> binary </em> yang tidak ada proses http service. <em class="lp"> Runtime profiling </em> sangat cocok digunakan untuk program-program yang bersifat <em class="lp"> standalone </em> seperti <em class="lp"> library </em> . <br/> Menggunakan package: <code class="fe nb nc nd ne b">runtime/pprof</code></p><p id="84e1" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io"> HTTP Profiling </strong> <br/> <em class="lp"> HTTP profiling </em> digunakan untuk <em class="lp"> profiling </em> API atau http server yang kita miliki. Perlakuannya mirip dengan <em class="lp"> runtime </em> <em class="lp"> profiling </em> , namun karena diharuskan <em class="lp"> live </em> , <em class="lp"> HTTP profiling </em> harus dilakukan saat <em class="lp"> load test </em> . <br/> Menggunakan package: <code class="fe nb nc nd ne b">net/http/pprof</code></p><p id="32e4" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="lp"> Nah </em> , digolang sendiri dengan tools <code class="fe nb nc nd ne b">pprof</code> , terdapat beberapa jenis <em class="lp"> profiling </em> <br/> - <em class="lp"> CPU Profiling </em> (akan di bahas di tulisan ini), <br/> - <em class="lp"> Heap Memory Profiling </em> , <br/> - <em class="lp"> Block Profiling </em> , dan <br/> - <em class="lp"> Goroutine Profiling </em></p><p id="a654" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Ke empat topik tersebut cukup banyak untuk di bahas dalam satu tulisan. Makadari itu untuk tulisan kali ini saya hanya akan membahas mengenai <em class="lp"> CPU Profiling </em> .</p><h1 id="3bcf" class="me mf in bd mg mh mi mj mk ml mm mn mo jt mp ju mq jw mr jx ms jz mt ka mu mv bi translated"><em class="nf"> CPU Profiling </em></h1><p id="e449" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">Jika kita ingin mengetahui fungsi apa aja yang memakan CPU paling banyak atau fungsi mana yang paling lama proses eksekusinya, maka kita dapat melakukan CPU <em class="lp"> profiling </em> pada fungsi kita.</p><p id="4ea8" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Untuk contoh sederhana, kita bisa mulai dengan sebuah fungsi kecil. Dimana fungsi tersebut akan mengembalikan sebuah <em class="lp"> array </em> besar yang kemudian akan di proses oleh fungsi lain.</p><pre class="kd ke kf kg gt ng ne nh ni aw nj bi"><span id="53a8" class="nk mf in ne b gy nl nm l nn no">func bigArray() *[]int {<br/>  s := make([]int, 10000000)<br/>  return &amp;s<br/>}</span><span id="86c2" class="nk mf in ne b gy np nm l nn no">func ProcessBigArray() {<br/>  for i := 0; i &lt; 10000; i++ {<br/>    arr := bigArray()<br/>    if arr == nil {<br/>      fmt.Println("Array is Nil")<br/>    }<br/>  }<br/>}</span></pre><p id="38bb" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Nah, untuk mulai <em class="lp"> memprofiling </em> fungsi ini, hal pertama tentu saja kita perlu <em class="lp"> mengimport </em> package <code class="fe nb nc nd ne b">runtime/pprof</code> seperti yang sudah jelaskan di atas.</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="2884" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Penjelasan:</p><pre class="kd ke kf kg gt ng ne nh ni aw nj bi"><span id="fc6c" class="nk mf in ne b gy nl nm l nn no">cpuProf, err := os.Create(cpuProfile) <br/>if err != nil {<br/>  log.Fatal(err) <br/>} <br/>defer cpuProf.Close() <br/>_runtime.StartCPUProfile(cpuProf) <br/>defer _runtime.StopCPUProfile()</span></pre><p id="7d7a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="lp"> Code </em> diatas digunakan untuk <em class="lp"> mentrack </em> CPU <em class="lp"> usage </em> kita saat mengeksekusi fungsi di bawahnya. Dan akan berhenti pada saat fungsi <code class="fe nb nc nd ne b">main</code> telah selesai dieksekusi.</p><h2 id="7ad1" class="nk mf in bd mg ns nt dn mk nu nv dp mo lc nw nx mq lg ny nz ms lk oa ob mu oc bi translated">Run Profiling</h2><p id="f3fc" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">Setelah <em class="lp"> code </em> tersebut kita selesaikan, maka kita akan melakukan <em class="lp"> profiling </em> CPU pada fungsi tersebut.</p><pre class="kd ke kf kg gt ng ne nh ni aw nj bi"><span id="dd21" class="nk mf in ne b gy nl nm l nn no"># Build the go project<br/>$ go build -o app_name</span><span id="7195" class="nk mf in ne b gy np nm l nn no"># run the project<br/>$ ./app_name</span><span id="959b" class="nk mf in ne b gy np nm l nn no"># Wait until done</span></pre><p id="9d84" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Setelah selesai, pada folder tersebut akan anda temukan file baru yang bernama <code class="fe nb nc nd ne b">cpu.prof</code> . Selanjutnya anda tinggal melihat <em class="lp"> profiling </em> pada aplikasi anda.</p><pre class="kd ke kf kg gt ng ne nh ni aw nj bi"><span id="81c0" class="nk mf in ne b gy nl nm l nn no"># Run the pprof<br/>$ go tool pprof app_name cpu.prof</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi od"><img src="../Images/8fdec894059d66a504799f5bd6790c01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/1*_MclWmcTDJ2RJWOw1MOrZA.gif"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">demo 1: go tool pprof</figcaption></figure><h2 id="1287" class="nk mf in bd mg ns nt dn mk nu nv dp mo lc nw nx mq lg ny nz ms lk oa ob mu oc bi translated">List Top CPU Usage</h2><p id="c6c8" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">Nah untuk melihat <em class="lp"> list process </em> yang memakai CPU, lakukan langkah berikut</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi od"><img src="../Images/81dc7bcb1b40e3e47a61aaf193d07ebd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/1*Z6zUO01PAP655MR2JaBvgw.gif"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">demo 2: go tool pprof</figcaption></figure><ul class=""><li id="45b8" class="lq lr in kv b kw kx kz la lc ls lg lt lk lu lo lv lw lx ly bi translated"><em class="lp"> Command </em> : <code class="fe nb nc nd ne b">top</code> .</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/8445e49f2747089a4ca665a8c1316267.png" data-original-src="https://miro.medium.com/v2/resize:fit:1054/format:webp/1*ASQy522Ww11JVtir7MJeFg.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">pprof top</figcaption></figure><ul class=""><li id="d0a6" class="lq lr in kv b kw kx kz la lc ls lg lt lk lu lo lv lw lx ly bi translated"><em class="lp"> Command </em> : <code class="fe nb nc nd ne b">top N </code> atau <code class="fe nb nc nd ne b">topN</code> Contoh: <code class="fe nb nc nd ne b">top 20</code> , atau <code class="fe nb nc nd ne b">top20</code> .</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi of"><img src="../Images/4dcb828c4cdaf2af31f8d023297aac5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*BOM_eURizkU0Hhf3HIUpZw.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">pprof top 20</figcaption></figure><p id="4599" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="lp"> Command </em> ini akan menampilkan sebanyak 20 fungsi atau <em class="lp"> package </em> yang memakai CPU paling banyak.</p><ul class=""><li id="017a" class="lq lr in kv b kw kx kz la lc ls lg lt lk lu lo lv lw lx ly bi translated"><em class="lp"> Command </em> <code class="fe nb nc nd ne b">top -param</code> ,untuk mengurutkan berdasarkan <code class="fe nb nc nd ne b">param</code> . Contoh: <code class="fe nb nc nd ne b">top -cum</code> , <code class="fe nb nc nd ne b">top -sum</code> , <code class="fe nb nc nd ne b">top -flat</code> .</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi og"><img src="../Images/9827c8317f501a7ad2c27ab05ff638ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/format:webp/1*t06erSez6FqiyJHUKhI8kg.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">sort by cum</figcaption></figure><p id="c960" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">** <strong class="kv io"> flat </strong> , adalah satuan waktu yang dibutuhkan oleh satu fungsi untuk mengeksekusi secara langsung, tanpa fungsi lain yang termasuk di dalam. <br/> ** <strong class="kv io"> cum </strong> , adalah satuan waktu keseluruhan fungsi secara kumulatif.</p><p id="9ac2" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Untuk lebih jelas tentang <code class="fe nb nc nd ne b">cum</code> dan <code class="fe nb nc nd ne b">flat</code> dapat kita buat ke dalam contoh.</p><pre class="kd ke kf kg gt ng ne nh ni aw nj bi"><span id="c783" class="nk mf in ne b gy nl nm l nn no">//need 4s to execute<br/>func iman() {<br/>}</span><span id="6862" class="nk mf in ne b gy np nm l nn no">// need 2s to execute<br/>func tampan(){<br/>}</span><span id="19fa" class="nk mf in ne b gy np nm l nn no">// need 7s to execute in total<br/>func hakiki(){<br/> iman() <br/> tampan()<br/> // Other code <br/> // execute  for 1s<br/>}</span><span id="c9bc" class="nk mf in ne b gy np nm l nn no">// neeed 1s to execute<br/>func fakta() {<br/>}</span><span id="6a71" class="nk mf in ne b gy np nm l nn no">func main() {<br/> fakta() // executed for <strong class="ne io">1s</strong><br/> // Some of random<br/> // Unknown function<br/> // Executed for <strong class="ne io">2s</strong><br/> hakiki() // executed for <strong class="ne io">7s</strong> <br/>}</span></pre><p id="af31" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="lp"> Nah </em> , dari contoh kodingan di atas, jika kita lihat dari fungsi <code class="fe nb nc nd ne b">main</code> maka dapat dijabarkan sebagai berikut: <br/> - <strong class="kv io"> cum </strong> dari fungsi <code class="fe nb nc nd ne b">main</code> adalah 10 detik. <br/> Karena secara kumulatif, fungsi main dieksekusi selama 10 seconds. <code class="fe nb nc nd ne b">1s</code> untuk memanggil <code class="fe nb nc nd ne b">fakta()</code> . <code class="fe nb nc nd ne b">2s</code> untuk kodingan <em class="lp"> logic </em> <code class="fe nb nc nd ne b">main</code> sendiri. Dan <code class="fe nb nc nd ne b">7s</code> untuk memanggil <code class="fe nb nc nd ne b">hakiki()</code> . <br/> - <strong class="kv io"> flat </strong> dari fungsi <code class="fe nb nc nd ne b">main</code> adalah 2 detik. <br/> Karena tanpa fungsi <code class="fe nb nc nd ne b">fakta()</code> dan <code class="fe nb nc nd ne b">hakiki()</code> , fungsi <code class="fe nb nc nd ne b">main</code> membutuhkan waktu <code class="fe nb nc nd ne b">2s</code> untuk kodingannya sendiri.</p><h2 id="c730" class="nk mf in bd mg ns nt dn mk nu nv dp mo lc nw nx mq lg ny nz ms lk oa ob mu oc bi translated">Export Graphical</h2><p id="4bc1" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">Selain melihat melalui <em class="lp"> command </em> <code class="fe nb nc nd ne b">top</code> , kita juga bisa melihat melalui gambar <em class="lp"> graphical </em> . Yaitu dengan mengetik <em class="lp"> command </em> <code class="fe nb nc nd ne b">web</code></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi oh"><img src="../Images/405a1ab384862426075807639aadb544.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*4qVZy-b5XvcLJ35hrojUzQ.gif"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">demo 3: pprof</figcaption></figure><pre class="kd ke kf kg gt ng ne nh ni aw nj bi"><span id="21a8" class="nk mf in ne b gy nl nm l nn no">(pprof) web </span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/aa3996d689dcac22b80d4173fda7aa87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*9yeqv0hLoqWnq7VM784tEw.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">pprof web</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi oj"><img src="../Images/41fa38f3dddde1ccc269350604ac92a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eLChc7XDdkjlPENsMgbahA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">pprof web results</figcaption></figure><p id="b919" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="lp"> Command </em> <code class="fe nb nc nd ne b">web</code> akan <em class="lp"> mengexport </em> hasilnya ke dalam file <code class="fe nb nc nd ne b">svg</code> dan bisa di buka dengan <em class="lp"> browser </em> . Atau kita juga bisa menggunakan terminal <em class="lp"> command </em> :</p><pre class="kd ke kf kg gt ng ne nh ni aw nj bi"><span id="d3f9" class="nk mf in ne b gy nl nm l nn no">$ go tool pprof -png app_name cpu.prof &gt; cpu.png</span></pre><p id="7ee5" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Command diatas akan menyimpan hasil pprof dalam bentuk gambar png.</p><h2 id="367c" class="nk mf in bd mg ns nt dn mk nu nv dp mo lc nw nx mq lg ny nz ms lk oa ob mu oc bi translated">Seek To Source Code</h2><p id="0c84" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">Dengan <code class="fe nb nc nd ne b">pprof</code> kita juga bisa langsung melihat ke source code, <em class="lp"> line </em> berapa yang meenggunakan resource waktu paling banyak. Langkahnya tetap sama.</p><pre class="kd ke kf kg gt ng ne nh ni aw nj bi"><span id="f4f4" class="nk mf in ne b gy nl nm l nn no"># Run the pprof<br/>$ go tool pprof app_name cpu.prof</span></pre><p id="03f6" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">dan kemudian gunakan <em class="lp"> command </em> <code class="fe nb nc nd ne b">list functionName</code> . Secara langsung <em class="lp"> command </em> <code class="fe nb nc nd ne b">list</code> akan melihat ke dalam <em class="lp"> source code </em> kita, dan jika menggunakan <code class="fe nb nc nd ne b">functionName</code> akan melakukan filter pada seluruh <em class="lp"> function </em> yang sesuai dengan yang dimasukkan.</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ok"><img src="../Images/c90ba46c99aaa82af69e10eae597eb8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fa2mof5nX0GLBTv_sYm8-g.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">pprof : list function name</figcaption></figure><p id="57ee" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Jika di lihat pada gambar di atas, kita dapat melihat, <em class="lp"> function </em> <code class="fe nb nc nd ne b">ProcessBigArray()</code> membutuhkan waktu <code class="fe nb nc nd ne b">10.26s</code> untuk di eksekusi. <br/> Atau jika kita filter lagi kedalam function <code class="fe nb nc nd ne b">ProcessBigArray()</code></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ol"><img src="../Images/9a559b3c82a944cae738c31f9c0bcc99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pw-DkqEmOEeUsBu6HV7nPA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">pprof : list ProcessBigArray</figcaption></figure><p id="8c26" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Maka semakin kelihatan apa yang memakan waktu terlalu banyak. Yakni code:</p><pre class="kd ke kf kg gt ng ne nh ni aw nj bi"><span id="a8a3" class="nk mf in ne b gy nl nm l nn no">s:=make([]int,1000000) // membutuhkan waktu 10.26s</span></pre><p id="4070" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Hal ini terjadi karena kita menginialisasi <em class="lp"> array </em> yang sangat besar dengan <em class="lp"> array </em> <code class="fe nb nc nd ne b">[]int</code> dan panjang <code class="fe nb nc nd ne b">1000000</code> . Maka dari hasil ini kita bisa simpulkan, untuk inialisasi <em class="lp"> array </em> saja dengan <code class="fe nb nc nd ne b">size</code> -nya yang besar, memakan waktu cukup banyak. Sehingga, kita bisa mengantisipasinya dengan menggunakan <em class="lp"> array </em> <em class="lp"> size </em> secukupnya saja.</p><h1 id="3d83" class="me mf in bd mg mh mi mj mk ml mm mn mo jt mp ju mq jw mr jx ms jz mt ka mu mv bi translated">Implementasi dengan HTTP Golang API</h1><p id="a0a3" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">Penjelasan di atas adalah tentang bagaimana kita melakukan <em class="lp"> profiling </em> pada aplikasi <em class="lp"> standalone </em> , yakni dengan cara <em class="lp"> Runtime profiling </em> .</p><p id="1eab" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Namun cara tersebut kurang cocok dilakukan pada aplikasi HTTP API server. Sehingga perlu dilakukan pendekatan yang berbeda. Untuk keseluruhan <em class="lp"> command </em> , pada <code class="fe nb nc nd ne b">pprof</code> masi mirip, yang berbeda hanya cara <em class="lp"> mereproducenya </em> pada HTTP API Server.</p><p id="e167" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Sebagai contoh, misalnya kita memiliki sebuah API sebagai berikut:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nq nr l"/></div></figure><h2 id="ca2b" class="nk mf in bd mg ns nt dn mk nu nv dp mo lc nw nx mq lg ny nz ms lk oa ob mu oc bi translated">Add Endpoint Debugging Profiling</h2><p id="feeb" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">Langkah pertama adalah dengan menambah <em class="lp"> endpoint </em> <em class="lp"> profiling </em> pada aplikasi kita. Jika melihat <em class="lp"> code </em> diatas, kita akan menemukan code seperti berikut.</p><pre class="kd ke kf kg gt ng ne nh ni aw nj bi"><span id="4b26" class="nk mf in ne b gy nl nm l nn no">handler.HandleFunc("/debug/pprof/", pprof.Index)<br/>handler.HandleFunc("/debug/pprof/cmdline", pprof.Cmdline)<br/>handler.HandleFunc("/debug/pprof/profile", pprof.Profile)<br/>handler.HandleFunc("/debug/pprof/symbol", pprof.Symbol)<br/>handler.HandleFunc("/debug/pprof/trace", pprof.Trace)</span></pre><p id="cc73" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Dengan menambahkan <em class="lp"> endpoint </em> ini pada aplikasi kita, maka kita sudah bisa melakukan profiling pada aplikasi kita menggunakan <code class="fe nb nc nd ne b">pprof</code> .</p><h2 id="d3c1" class="nk mf in bd mg ns nt dn mk nu nv dp mo lc nw nx mq lg ny nz ms lk oa ob mu oc bi translated">Make A Huge Request</h2><p id="9189" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">Untuk melakukan <em class="lp"> profiling </em> , tentu saja API kita harus dalam keadaan <em class="lp"> live </em> dan sedang menangani <em class="lp"> request </em> . Untuk membuat ini, kita bisa menggunakan <em class="lp"> tools </em> untuk <em class="lp"> load testing </em> , yang akan memberikan <em class="lp"> load </em> <em class="lp"> request </em> banyak pada API kita. <br/> Untuk <em class="lp"> project </em> kecil yang saya buat, saya menggunakan <code class="fe nb nc nd ne b">github.com/rakyll/hey</code> , sebagai <em class="lp"> tools </em> untuk load test.</p><pre class="kd ke kf kg gt ng ne nh ni aw nj bi"><span id="d459" class="nk mf in ne b gy nl nm l nn no"># make a huge load request<br/>$ hey -n 500 -c 50 <a class="ae ks" href="http://localhost:9090/hi" rel="noopener ugc nofollow" target="_blank">http://localhost:9090/hi</a></span></pre><h2 id="bcec" class="nk mf in bd mg ns nt dn mk nu nv dp mo lc nw nx mq lg ny nz ms lk oa ob mu oc bi translated">Running The Profiling</h2><p id="fa33" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">Sembari <em class="lp"> load </em> <em class="lp"> test </em> berjalan, kita lakukan <em class="lp"> profiling </em> pada API kita</p><pre class="kd ke kf kg gt ng ne nh ni aw nj bi"><span id="ac6e" class="nk mf in ne b gy nl nm l nn no"># start profiling <br/>$ go tool pprof app http://localhost:9090/debug/pprof/profile</span></pre><p id="44d7" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Untuk <em class="lp"> profiling </em> nya akan memakan waktu sekitar 30 detik, sampai <code class="fe nb nc nd ne b">pprof</code> selesai me- <em class="lp"> record </em> data yang dibutuhkan.</p><h2 id="0a75" class="nk mf in bd mg ns nt dn mk nu nv dp mo lc nw nx mq lg ny nz ms lk oa ob mu oc bi translated">Detect Slow Function</h2><p id="34c6" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">Setelah selesai, <code class="fe nb nc nd ne b">pprof</code> akan muncul. Selanjutnya kita mendeteksi fungsi yang lamban dan memakai <em class="lp"> resource </em> yang banyak. <em class="lp"> Commandnya </em> sama seperti sebelumnya, yaitu: <br/> <code class="fe nb nc nd ne b">topN</code> , <code class="fe nb nc nd ne b">top -cum</code> , <code class="fe nb nc nd ne b">list functionName</code> serta <code class="fe nb nc nd ne b">web</code> ,jika ingin mengaksesnya secara visual.</p></div><div class="ab cl om on hr oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="ig ih ii ij ik"><h1 id="368d" class="me mf in bd mg mh ot mj mk ml ou mn mo jt ov ju mq jw ow jx ms jz ox ka mu mv bi translated">What Next?</h1><p id="6f5a" class="pw-post-body-paragraph kt ku in kv b kw mw jo ky kz mx jr lb lc my le lf lg mz li lj lk na lm ln lo ig bi translated">Demikian cara singkat penggunaan <code class="fe nb nc nd ne b">pprof</code> di golang untuk membantu rekan <code class="fe nb nc nd ne b">Gopher</code> melakukan <em class="lp"> profiling </em> pada aplikasi yang dimiliki. Kepada rekan pembaca, jika ingin mengeksplorasi lebih lanjut, berikut kami sertakan referensi untuk profiling golang.</p><h2 id="a373" class="nk mf in bd mg ns nt dn mk nu nv dp mo lc nw nx mq lg ny nz ms lk oa ob mu oc bi translated">References:</h2><ul class=""><li id="5823" class="lq lr in kv b kw mw kz mx lc oy lg oz lk pa lo lv lw lx ly bi translated"><a class="ae ks" href="https://blog.golang.org/profiling-go-programs" rel="noopener ugc nofollow" target="_blank"> https://blog.golang.org/profiling-go-programs </a></li><li id="22e9" class="lq lr in kv b kw lz kz ma lc mb lg mc lk md lo lv lw lx ly bi translated"><a class="ae ks" href="https://artem.krylysov.com/blog/2017/03/13/profiling-and-optimizing-go-web-applications/" rel="noopener ugc nofollow" target="_blank"> https://artem.krylysov.com/blog/2017/03/13/profiling-and-optimizing-go-web-applications/ </a></li><li id="f48f" class="lq lr in kv b kw lz kz ma lc mb lg mc lk md lo lv lw lx ly bi translated"><a class="ae ks" href="https://research.google.com/pubs/pub37122.html" rel="noopener ugc nofollow" target="_blank"> https://research.google.com/pubs/pub37122.html </a></li></ul><p id="29af" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">And btw, <a class="ae ks" href="https://medium.com/easyread" rel="noopener"> Easyread </a> is <a class="ae ks" href="https://medium.com/easyread/about-easyread-74b20960e180" rel="noopener"> calling for submission </a> 😆. HAPPY READING 😃</p></div><div class="ab cl om on hr oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="ig ih ii ij ik"><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="pb nr l"/></div></figure></div></div>    
</body>
</html>