<html>
<head>
<title>Untrusted Touch Events in Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android中的不可信触摸事件</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/untrusted-touch-events-2c0e0b9c374c?source=collection_archive---------4-----------------------#2021-05-26">https://medium.com/androiddevelopers/untrusted-touch-events-2c0e0b9c374c?source=collection_archive---------4-----------------------#2021-05-26</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/f2b85b57500740ded41689b0dc889f2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lvwe7v_bcNsNXI_7ltFkJA.jpeg"/></div></div></figure><div class=""/><p id="5cc4" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在Android 12中，我们正在进行更改，以增强应用程序和平台的安全性，为我们的用户提供更安全的体验。在这篇文章之后，看看我们其他的关于安全和隐私的<a class="ae jn" href="https://medium.com/androiddevelopers/tagged/android-privacy" rel="noopener">博客文章</a>。</p><p id="89d8" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">触摸输入是Android中与应用程序交互的主要方式。Android 12包括额外的措施，以确保触摸事件正确地传递到预期的应用程序，以确保直观和安全的UX。具体来说，Android 12防止触摸事件被传递到应用程序，如果这些触摸通过不同应用程序的窗口。这种行为变化适用于Android 12上运行的所有应用程序，无论“targetSdkVersion”如何。这有助于确保用户可以看到他们正在交互的内容。请继续阅读，了解替代方案，看看您的应用程序是否会受到影响，以及如何测试它。</p><h1 id="403a" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">尽可能使用特殊用途的API</h1><p id="cff3" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">在检查您的用例是否受到影响之前，最好评估一下您的应用程序是否可以利用Android中的以下API之一。这些易于使用的API使您不必担心这些限制，因为它们部分由系统控制，因此是可信的。请考虑以下情况:</p><ul class=""><li id="5537" class="kr ks hs ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated"><a class="ae jn" href="https://developer.android.com/guide/topics/ui/bubbles" rel="noopener ugc nofollow" target="_blank">气泡</a>:气泡漂浮在其他应用程序内容的顶部，跟随用户到任何地方，并且可以扩展以显示应用程序的功能和信息。</li><li id="5de7" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated"><a class="ae jn" href="https://developer.android.com/guide/topics/ui/picture-in-picture" rel="noopener ugc nofollow" target="_blank">画中画</a> (PIP):当用户在应用程序之间导航或浏览主屏幕上的内容时，PIP允许应用程序在一个小窗口中显示内容，该窗口被钉在屏幕的一角。用户可以拖动画中画窗口，并可以点击它来扩大或关闭。</li><li id="04c1" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated"><a class="ae jn" href="https://developer.android.com/guide/topics/ui/notifiers/notifications" rel="noopener ugc nofollow" target="_blank">通知</a>:通知是向用户提供提醒、来自其他人的消息或来自你的应用程序的其他及时信息的标准方式，同时最大限度地减少对设备使用的干扰。用户可以轻按通知来打开您的应用程序，或者直接从通知中采取操作。</li><li id="9ae2" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated"><a class="ae jn" href="https://developer.android.com/reference/com/google/android/material/snackbar/Snackbar" rel="noopener ugc nofollow" target="_blank"> Snackbars </a>和<a class="ae jn" href="https://developer.android.com/guide/topics/ui/notifiers/toasts" rel="noopener ugc nofollow" target="_blank">祝酒词</a>:如果你需要在你的应用程序中短时间显示一条消息，看看<a class="ae jn" href="https://developer.android.com/reference/com/google/android/material/snackbar/Snackbar" rel="noopener ugc nofollow" target="_blank"> Snackbars </a>。如果你需要在你的应用程序处于后台时显示这条消息，看看<a class="ae jn" href="https://developer.android.com/guide/topics/ui/notifiers/toasts" rel="noopener ugc nofollow" target="_blank">祝酒词</a>是否适合你的用例。</li></ul><p id="1d4a" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您的用例符合这些API之一，那么强烈建议您使用它们。它们不仅更容易使用，更安全，而且用户已经熟悉了其中的大部分。</p><h1 id="b019" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">这对我有影响吗？</h1><p id="fc6a" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">如果你的应用程序不能利用上面的API之一，并让触摸事件通过它的窗口，那么在Android 12上，它们可能不会像预期的那样通过底层。</p><p id="c511" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">示例包括但不限于以下内容:</p><ul class=""><li id="a7e6" class="kr ks hs ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">使用<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#FLAG_NOT_TOUCHABLE" rel="noopener ugc nofollow" target="_blank">FLAG_NOT_TOUCHABLE</a></code>的<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams?hl=zh-TW#TYPE_APPLICATION_OVERLAY" rel="noopener ugc nofollow" target="_blank">TYPE_APPLICATION_OVERLAY</a></code>类型的窗口。</li><li id="a92e" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">使用<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#FLAG_NOT_TOUCHABLE" rel="noopener ugc nofollow" target="_blank">FLAG_NOT_TOUCHABLE</a></code>的活动窗口。</li></ul><p id="feac" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您正在使用<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#FLAG_NOT_TOUCHABLE" rel="noopener ugc nofollow" target="_blank">FLAG_NOT_TOUCHABLE</a></code>，您很可能会受到影响，除非您的用例属于以下豁免之一:</p><ul class=""><li id="4011" class="kr ks hs ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated"><strong class="ir ht">应用程序内的互动</strong>。覆盖图仅出现在您的应用程序上方。</li><li id="c9bd" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated"><strong class="ir ht">可信windows </strong>。这些窗口包括(但不限于)<a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams?hl=zh-TW#TYPE_ACCESSIBILITY_OVERLAY" rel="noopener ugc nofollow" target="_blank">辅助窗口</a>、<a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams?hl=zh-TW#TYPE_INPUT_METHOD" rel="noopener ugc nofollow" target="_blank">输入法编辑器(IME)窗口</a>和<a class="ae jn" href="https://developer.android.com/reference/android/service/voice/VoiceInteractionSession" rel="noopener ugc nofollow" target="_blank">助手窗口</a>。</li><li id="b331" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated"><strong class="ir ht">隐形窗户</strong>。窗口的根视图是<a class="ae jn" href="https://developer.android.com/reference/android/view/View#GONE" rel="noopener ugc nofollow" target="_blank">消失</a>或<a class="ae jn" href="https://developer.android.com/reference/android/view/View#INVISIBLE" rel="noopener ugc nofollow" target="_blank">不可见</a>。</li><li id="4a47" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated"><strong class="ir ht">完全透明的窗户</strong>。窗口的<a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#alpha" rel="noopener ugc nofollow" target="_blank"> alpha </a>属性为0.0。</li><li id="5923" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated"><strong class="ir ht">足够半透明的TYPE_APPLICATION_OVERLAY窗口</strong>。窗口的类型为<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#TYPE_APPLICATION_OVERLAY" rel="noopener ugc nofollow" target="_blank">TYPE_APPLICATION_OVERLAY</a></code>，其<a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#alpha" rel="noopener ugc nofollow" target="_blank"> alpha </a>属性等于或小于<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/hardware/input/InputManager#getMaximumObscuringOpacityForTouch()" rel="noopener ugc nofollow" target="_blank">InputManager.getMaximumObscuringOpacityForTouch()</a></code>。从开发人员预览版3开始，该值目前为0.8，但在最终发布之前可能会有所变化。在这种类型的多个重叠窗口的情况下，使用它们的<a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#combined-obscuring-opacity" rel="noopener ugc nofollow" target="_blank">组合不透明度</a>。</li></ul><p id="c84b" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您的用例不在上面的列表中，触摸将被阻止。如果这对你的用例有效，考虑移除<code class="du lf lg lh li b">FLAG_NOT_TOUCHABLE</code>来移除让触摸通过的意图。如果你需要让触摸通过，你必须调整你的代码来适应上面的一个豁免。下一节将介绍必须改变的常见模式的示例:</p><h1 id="776e" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">具有透明背景且没有用户界面的窗口</h1><p id="5362" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">在透明背景的窗口中显示一些UI的应用程序可以在某些时候在视图级别隐藏它们的UI，同时添加<code class="du lf lg lh li b">FLAG_NOT_TOUCHABLE</code>以便用户可以与后面的内容进行交互。</p><figure class="lk ll lm ln fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es lj"><img src="../Images/1432439a8dd49aa4e861e697828d1191.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zP4af7xIdj1sCIEj"/></div></div></figure><p id="e186" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如上图所示，如果应用程序只是隐藏了用户界面，要么通过删除子视图，要么改变它们的可见性，并添加了<code class="du lf lg lh li b">FLAG_NOT_TOUCHABLE</code>以便用户可以与后面的内容进行交互，这将不再适用于Android 12(注意与之前提到的豁免的不同——这里我们改变的是内部视图，而不是窗口)，因为对后面其他应用程序的触摸将被阻止。在这种情况下，很容易解决这个问题；您可以:</p><ul class=""><li id="55e8" class="kr ks hs ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">使用<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/ViewManager#removeView(android.view.View)" rel="noopener ugc nofollow" target="_blank">WindowManager.removeView()</a></code>移除窗口，传递根视图。</li><li id="e644" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">用根视图上的<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/View#GONE" rel="noopener ugc nofollow" target="_blank">View.GONE</a></code>或<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/View#INVISIBLE" rel="noopener ugc nofollow" target="_blank">View.INVISIBLE</a></code>调用<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/View#setVisibility(int)" rel="noopener ugc nofollow" target="_blank">View.setVisibility()</a></code>使窗口不可见。</li><li id="6922" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">通过<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#alpha" rel="noopener ugc nofollow" target="_blank">LayoutParams.alpha</a></code>设置窗口的不透明度为0.0。</li></ul><p id="e5d1" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">每当您需要再次显示该UI时，您只需反转上面的操作。</p><h1 id="5d2b" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">不必要的大窗户</h1><p id="ed04" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">应用程序可能希望显示一些小的UI，同时仍然允许用户与窗口后面的内容进行交互。以前，一个应用程序可以通过简单地使用全屏窗口并用<code class="du lf lg lh li b">FLAG_NOT_TOUCHABLE</code>标记它来实现，如图1所示:</p><figure class="lk ll lm ln fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es lo"><img src="../Images/9045ec2f7baad0f6a6b3f250c981e56a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*I5mQJtAAXU0QfAEV"/></div></div></figure><p id="0d43" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">请注意，在以前的操作系统版本中，通过实际UI元素的触摸在这种情况下会传递到后面的窗口。在这种情况下，第一个建议是查看一下<a class="ae jn" href="https://developer.android.com/guide/topics/ui/notifiers/toasts" rel="noopener ugc nofollow" target="_blank"> Toast </a> API，看看它是否符合您的目的。如果没有，这里的解决方案也很简单，如右图所示:您只需将窗口边界缩小到实际的UI并使用<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#FLAG_NOT_TOUCH_MODAL" rel="noopener ugc nofollow" target="_blank">FLAG_NOT_TOUCH_MODAL</a></code>，此时您可能还想删除<code class="du lf lg lh li b">FLAG_NOT_TOUCHABLE</code>。</p><p id="2aa4" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在你UI外的触摸会直接到后面的窗口，不会被遮挡。</p><h1 id="2cbe" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">半透明的窗户</h1><p id="3aca" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">如果你使用的是一个<code class="du lf lg lh li b">TYPE_APPLICATION_OVERLAY</code>窗口，并且在显示内容时绝对需要让触摸通过它，你必须降低不透明度，这样用户才能合理地看到他们在窗口后面触摸的东西。</p><figure class="lk ll lm ln fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es lp"><img src="../Images/0bbc0c032bdffcacb8bb924c70a675ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XWgucUoq2FOWduj8"/></div></div></figure><p id="d4d3" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">你必须在<strong class="ir ht">窗口级别降低不透明度，</strong>仅仅改变视图的不透明度是不起作用的。您可以使用<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#alpha" rel="noopener ugc nofollow" target="_blank">LayoutParams.alpha</a></code>将不透明度降低到低于或等于<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/hardware/input/InputManager#getMaximumObscuringOpacityForTouch()" rel="noopener ugc nofollow" target="_blank">InputManager.getMaximumObscuringOpacityForTouch()</a></code>的值，如右图所示。该值目前为0.8，但在Android 12最终发布之前可能会有所变化。</p><p id="d2d6" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在，假设你的应用程序没有多个相互重叠的窗口，触摸将通过后面的窗口。关于重叠窗口的更多细节，请看 <code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#FLAG_NOT_TOUCHABLE" rel="noopener ugc nofollow" target="_blank">FLAG_NOT_TOUCHABLE</a></code>的<a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#FLAG_NOT_TOUCHABLE" rel="noopener ugc nofollow" target="_blank">文档。</a></p><h1 id="baba" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">无障碍服务</h1><p id="5852" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">作为一个连接的辅助功能服务，可以创建类型为<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager.LayoutParams#TYPE_ACCESSIBILITY_OVERLAY" rel="noopener ugc nofollow" target="_blank">TYPE_ACCESSIBILITY_OVERLAY</a></code>的窗口，这些窗口是可信的，因此不受前面描述的限制。为了创建这样的窗口，只需使用您的<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/accessibilityservice/AccessibilityService" rel="noopener ugc nofollow" target="_blank">AccessibilityService</a></code>的上下文通过<code class="du lf lg lh li b"><a class="ae jn" href="http://getsystemservice" rel="noopener ugc nofollow" target="_blank">getSystemService()</a></code>获得一个<code class="du lf lg lh li b"><a class="ae jn" href="https://developer.android.com/reference/android/view/WindowManager" rel="noopener ugc nofollow" target="_blank">WindowManager</a></code>来创建所述窗口。</p><h1 id="c9c6" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">如何测试你的应用是否受到影响</h1><p id="c97b" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">如果触摸动作被系统阻止，您将在<a class="ae jn" href="https://developer.android.com/studio/command-line/logcat?hl=zh-TW" rel="noopener ugc nofollow" target="_blank">日志目录</a>中看到以下消息:由于被PACKAGE_NAME遮挡，触摸不可信。</p><h1 id="1014" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">后续步骤</h1><p id="b0af" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">如果您想了解更多关于<a class="ae jn" href="https://developer.android.com/about/versions/12/behavior-changes-all?hl=zh-TW#untrusted-touch-events" rel="noopener ugc nofollow" target="_blank">不可信触摸事件</a>及其<a class="ae jn" href="https://developer.android.com/about/versions/12/behavior-changes-all?hl=zh-TW#untrusted-touch-events-exceptions" rel="noopener ugc nofollow" target="_blank">异常</a>的信息，请查阅文档。</p><p id="469f" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">编码快乐！</p></div></div>    
</body>
</html>