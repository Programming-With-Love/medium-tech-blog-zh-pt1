<html>
<head>
<title>TerramEarth — Vista técnica a los casos de estudio de la certificación Profesional Cloud Architect</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TerramEarth — 云架构师专业认证案例研究的技术概述</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/terramearth-vista-t%C3%A9cnica-a-los-casos-de-estudio-de-la-certificaci%C3%B3n-profesional-cloud-architect-218aae2e1999?source=collection_archive---------0-----------------------#2019-03-23">https://medium.com/google-developer-experts/terramearth-vista-t%C3%A9cnica-a-los-casos-de-estudio-de-la-certificaci%C3%B3n-profesional-cloud-architect-218aae2e1999?source=collection_archive---------0-----------------------#2019-03-23</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="ddcb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本文的目的不是为了阻止您自己研究案例研究,而是帮助您了解分析大型项目时需要考虑的多个方面,并逐步了解每个解决方案组件背后的技术含义。按照您的免费 GCP 帐户中的步骤操作将帮助您为认证做好准备。</p><p id="8d55" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 在 Github 中查找代码 </strong><a class="ae jc" href="https://github.com/develasquez/casos-de-estudio/tree/master/TerramEarth" rel="noopener ugc nofollow" target="_blank">https://github.com/develasquez/studio-case/tree/master/TerramEarth </a></p><h1 id="c8b2" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">案例研究</h1><p id="487f" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">你需要做的第一件事是分析<a class="ae jc" href="https://cloud.google.com/certification/guides/cloud-architect/casestudy-terramearth-rev2/" rel="noopener ugc nofollow" target="_blank">TerramEarth</a>的案例研究。这是最近为2018年11月进行的考试更新而修订的。</p><p id="e4ad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">总而言之,TerramEarth 拥有一大批每天产生 TB 数据的农业/矿业车辆,其中 20% 的车辆可以通过无线方式发送这些指标,其余车辆在车辆进入维修阶段时发送。</p><p id="5dde" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该公司的架构分为两个流,即批处理和流式处理,类似于下图。请记住,这是一个试验性的解决方案,因为有许多方法可以实现它,我邀请您测试它并找到一个更好的解决方案,它将对Cert有很大的帮助。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kg"><img src="../Images/3b6980160a0d29f1e007256473e10d0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P8uf_cwa2Q9ROAeRb66nEQ.png"/></div></div></figure><p id="9b67" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Hora 将为您提供解决方案的每个主要组件的列表和一个实验室(Codelabs 或 Qvolutionab),以便您更深入地了解。</p><ul class=""><li id="03cf" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated">云存储(T7)</li><li id="db77" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><a class="ae jc" href="https://codelabs.developers.google.com/codelabs/cloud-starting-cloudfunctions/index.html?index=..%2F..index" rel="noopener ugc nofollow" target="_blank">Functions</a>(这也将是有用的,但对于TerramEarth来说太贵了)</li><li id="fb7b" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">数据流批处理(Dataflow Batch)</li><li id="b48f" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">(T12) BigQuery (T13)</li><li id="993e" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><a class="ae jc" href="https://www.qwiklabs.com/focuses/1005?catalog_rank=%7B%22rank%22%3A5%2C%22num_filters%22%3A0%2C%22has_search%22%3Atrue%7D&amp;parent=catalog&amp;search_id=2128990" rel="noopener ugc nofollow" target="_blank">数据工作室(T1)</a></li><li id="b1cb" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">(T2) BigQuery ML (T3)</li><li id="8877" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><a class="ae jc" href="https://codelabs.developers.google.com/codelabs/iot-data-pipeline/index.html?index=..%2F..index" rel="noopener ugc nofollow" target="_blank">IoT Core 1 (T5)</a></li><li id="44bd" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><a class="ae jc" href="https://codelabs.developers.google.com/codelabs/cloud-iot-core-overview/index.html?index=..%2F..index" rel="noopener ugc nofollow" target="_blank">IoT Core 2 (T7)</a></li><li id="55a0" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><a class="ae jc" href="https://codelabs.developers.google.com/codelabs/cloud-spring-cloud-gcp-pubsub-integration/index.html?index=..%2F..index" rel="noopener ugc nofollow" target="_blank">Pub/Sub(T9)</a></li><li id="a7e7" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">数据流流(Dataflow Streaming,T11)</li></ul><p id="2295" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">不要作弊,停止阅读并结束XD实验室。</p><h1 id="4374" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">从纸到云</h1><p id="afa0" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">如果你已经让这些实验室进入这个领域,我们将分析将TerramEarth带到云端所需的每一个步骤。</p><p id="705c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先,在GCP中为您的项目命名,以使其更容易:</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="9bca" class="ll je hh lh b fi lm ln l lo lp">TU_PROYECTO=xxxxxxxx</span></pre><h1 id="bedb" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">(1)预转移</h1><p id="9692" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">对于脱离网络的车辆,预计每天将产生大量数据,这就是为什么在将数据上传到云之前需要压缩数据的原因。</p><p id="dd7c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于他们,我们将使用基于<a class="ae jc" href="http://www.snon.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi"> snon </strong> </a>模式的示例数据,您可以查看文件<a class="ae jc" href="https://github.com/develasquez/casos-de-estudio/blob/master/TerramEarth/example.data.json" rel="noopener ugc nofollow" target="_blank"> example.data.json </a>作为示例。</p><p id="b673" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要模拟车辆生成的数据,您可以运行 generateRandomMetrics.js 脚本,该脚本将生成一个名为 data.json 的文件,其中包含 90,000 条记录,每条记录大约 120 个字段,总计大约 312 MB。</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="4857" class="ll je hh lh b fi lm ln l lo lp"><em class="lq">#debes tener node.js instalado</em><br/>node generateRandomMetrics.js &gt; data.json</span></pre><p id="fb94" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请记住,此阶段的重点是压缩数据以减少传输时间,为此我们将使用gzip,它将生成一个名为<em class="lq"> data.json.gz </em>的文件,该文件将重约61.3MB,比原始大小减少80%以上。您可以预期在更大的数据量相同,对于TerramEarth的实际案例。</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="43d2" class="ll je hh lh b fi lm ln l lo lp">gzip data.json</span></pre><p id="ab6e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">好吧,我们已经准备好上传到云端,玩游戏了!！。</p><h1 id="e221" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">(2)转移</h1><h2 id="0fa3" class="ll je hh bd jf lr ls lt jj lu lv lw jn ip lx ly jr it lz ma jv ix mb mc jz md bi translated">Batch 传输</h2><p id="0608" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">现在我们上传了这些数据,但传输方法不是游戏,这对于考试来说非常重要。请注意,对于TE(TerramEarth),每天将累积约891 TB,我们必须做出重要决定,我们将使用什么传输机制?让我们来看看Google是怎么做的。</p><ul class=""><li id="e308" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><a class="ae jc" href="https://cloud.google.com/transfer-appliance/" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">Transfer Appliance </strong></a><strong class="ig hi"/> 这种传输方法是谷歌向您发送一个大约100或480TB的XD随身碟,这不是开玩笑,它是一个可折叠的设备,您可以在其中上传数据并将其安全地发送到Google Cloud。这节省了大量的加载时间,从原籍国到谷歌的服务和运输成本的复合。</li></ul><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es me"><img src="../Images/8e58d0ef47a5f05cb1b93971a6823d2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*uGFx4BP-9rhhiX23"/></div></figure><p id="e421" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于TE而言,此解决方案不适用,因为此系统适用于一次性负载,但TE几乎每天都需要上传。</p><ul class=""><li id="53ff" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><a class="ae jc" href="https://cloud.google.com/storage-transfer/docs/overview" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">存储传输服务</strong></a>此传输方法允许您将数据从在线系统导入,这些系统可以是<a class="ae jc" href="https://aws.amazon.com/es/s3/" rel="noopener ugc nofollow" target="_blank">Amazon S3</a>、Google Cloud Storage、HTTP 或 HTTPS 源到您的项目中的 Google Cloud Storage。</li></ul><p id="56e5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于我们的解决方案,此机制也无济于事,因为数据位于 TE 的物理服务器上,因此通过 HTTP/S 公开数据仅仅是为了使用此机制进行传输是不理想的。</p><ul class=""><li id="655c" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><a class="ae jc" href="https://cloud.google.com/storage/docs/gsutil" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">gsutil </strong></a>这个功能强大且通用的工具是用 Python 开发的,让你可以完全控制 Google Cloud Storage 的操作。</li></ul><p id="c2dc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您需要考虑的是您的网络连接速度、数据量以及您上传网络所需的时间。为此,TE 必须使用 <a class="ae jc" href="https://cloud.google.com/hybrid-connectivity/" rel="noopener ugc nofollow" target="_blank"> Cloud Interconnect </a> 服务并选择连接类型。</p><p id="afd7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">看看<a class="ae jc" href="https://cloud.google.com/interconnect/docs/how-to/choose-type" rel="noopener ugc nofollow" target="_blank">互连</a>的两种模式</p><ul class=""><li id="a721" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated">专用互连(Dedicated Interconnect)</li><li id="4ed0" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">合作伙伴 Interconnect</li></ul><p id="92d0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">假设 TE 使用 <strong class="ig hi"> Dedicated interconnect </strong>,速度介于 10 Gbps 和 80 Gbps(最大允许)之间。现在让我们考虑以下因素,TE每天生成981 TB的数据,如果这些是用gzip压缩的,理论上会减少80%,根据连接类型,总共有196.2 TB压缩,最多可能需要60小时至6小时(80 Gbps)</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mf"><img src="../Images/140b76122de08f8a79cc2e3cb501bd17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*I51yw5bjMkVzbY6W"/></div></div></figure><p id="b5be" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是,仅仅拥有良好的速度是不够的,还有<a class="ae jc" rel="noopener" href="/google-cloud/google-cloud-storage-large-object-upload-speeds-7339751eaa24">优化传输</a>的策略,在这种情况下,最有用的策略是调用<a class="ae jc" href="https://cloud.google.com/storage/docs/gsutil/commands/cp" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">parallel_composite_upload_threshold</strong></a>,这将把你的文件切成小块,利用并行发送,大大减少了上传时间。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mg"><img src="../Images/103e2c5faf99bf31a2ae318833ac5809.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yMyBz3W-KJDcMoqpNzKsvg.png"/></div></div></figure><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mh"><img src="../Images/12674f99527767075f62e66b991be586.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NYUB_u5UxIJRFcFYj_JTwA.png"/></div></div></figure><p id="03d3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了进行测试,我们在项目中创建一个存储桶,记住名称必须是唯一的,用一些神奇的独特的东西替换XXXX。</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="6979" class="ll je hh lh b fi lm ln l lo lp">BUCKET_NAME=terramearth-batch-XXXX<br/>gsutil mb gs://$BUCKET_NAME</span></pre><p id="034c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在,您需要以MB为单位给parallel_composite_upload_threshold赋值,在我们的示例中,我们将尝试使用15MB。</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="af49" class="ll je hh lh b fi lm ln l lo lp">gsutil -o GSUtil:parallel_composite_upload_threshold=15M cp ./data.json gs://$BUCKET_NAME</span></pre><p id="aaa2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这将创建多个线程,这将使我们的文件并行上传到15MB的小切口,真的很漂亮吗?XD的。</p><p id="2952" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在让我们来看看这个过程对于连接到互联网的车辆来说会是什么样子。</p><h2 id="ffd4" class="ll je hh bd jf lr ls lt jj lu lv lw jn ip lx ly jr it lz ma jv ix mb mc jz md bi translated">传输 Streaming</h2><p id="92f6" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">在TE车队中,有20%的车辆可以接入网络,从而避免了数据积累和大规模流程的需要。相反,它允许这些数据流式处理,每次在车辆上生成传感器样本时,它们都会实时发送到云端。</p><p id="6c86" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为此,我们必须理解物联网(T9)的概念,该概念旨在标准化设备/车辆/家用电器通过网络进行通信和管理的方式。</p><p id="ffae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">其中最常用的协议是<a class="ae jc" href="http://www.steves-internet-guide.com/mqtt-protocol-messages-overview/" rel="noopener ugc nofollow" target="_blank">MQTT</a>和HTTP,并且允许我们在Google Cloud中使用它们的组件是<a class="ae jc" href="https://cloud.google.com/iot-core/" rel="noopener ugc nofollow" target="_blank">Cloud IoT Core</a>。</p><p id="8fd8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">它在TE的情况下是双向的,因为它允许从车辆收集数据,并将新配置发送给车辆。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es mi"><img src="../Images/b661e66bac1da079636bfe4701faa1ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*ijjddx0XWyMxk0rP"/></div></figure><p id="31ec" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如您所见,这些二进制数据通过在<a class="ae jc" href="https://cloud.google.com/pubsub/" rel="noopener ugc nofollow" target="_blank">Pub/Sub</a>中使用一个<a class="ae jc" href="https://cloud.google.com/pubsub/docs/publisher#pubsub-publish-message-nodejs" rel="noopener ugc nofollow" target="_blank">主题</a>来传输,我们将在瞬间创建这些数据。</p><p id="c962" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要在 Google Cloud 中创建 IoT 核心记录并对其进行测试,您可以使用此存储库的 IoT 文件夹中的示例。</p><p id="a8b9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于安全性在云中至关重要,因此想要与 Cloud IoT 核心进行通信的设备必须使用 JWT 令牌,这些令牌必须包含针对 IoT 核心配置中存储的公钥进行验证的私钥。</p><p id="bd3a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要创建你的自签名证书,你可以运行以下命令,在这里我给你一些<a class="ae jc" href="https://cloud.google.com/iot/docs/how-tos/credentials/keys" rel="noopener ugc nofollow" target="_blank">文档</a></p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="1cd8" class="ll je hh lh b fi lm ln l lo lp">#si es que estas en otro directorio<br/>cd IoT/resources; </span><span id="99a7" class="ll je hh lh b fi mj ln l lo lp">openssl req -x509 -nodes -newkey rsa:2048 -keyout rsa_private.pem -days 1000000 -out rsa_cert.pem -subj "/CN=unused"</span></pre><p id="0a80" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先要注意的是,对于 Cloud IoT Core,只有三个区域可用:us-central1、europe-west1 和 asia-east1。</p><p id="4961" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请记住,在这种情况下,您必须在 IoT Core 注册之前创建  主题。这些主题将负责接收设备生成的每个消息作为事件。</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="c98d" class="ll je hh lh b fi lm ln l lo lp">gcloud pubsub topics create te-tractor-topic;<br/>gcloud pubsub topics create te-tractor-state-topic;</span></pre><p id="ba0a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Cloud IoT Core 允许您创建日志以集中具有共同目标或操作的多个设备,在这种情况下,我们将为拖拉机创建日志。</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="47be" class="ll je hh lh b fi lm ln l lo lp">gcloud iot registries create te-tractor \<br/>    --project=${TU_PROYECTO} \<br/>    --region=us-central1 \<br/>    --event-notification-config=topic=te-tractor-topic \<br/>    --state-pubsub-topic=te-tractor-state-topic</span></pre><p id="fe15" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们必须创建设备,即特定的拖拉机。</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="7bbf" class="ll je hh lh b fi lm ln l lo lp">gcloud iot devices create te-tractor-device \<br/>  --project=${TU_PROYECTO} \<br/>  --region=us-central1 \<br/>  --registry=te-tractor \<br/>  --public-key path=rsa_cert.pem,type=rs256</span></pre><p id="ea3e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了模拟拖拉机生成的数据,我在Github的IoT Core NodeJs中修改了示例代码<a class="ae jc" href="https://github.com/GoogleCloudPlatform/nodejs-docs-samples/tree/master/iot/mqtt_example" rel="noopener ugc nofollow" target="_blank">示例代码</a>,它将所有120个字段的模板放在JSON中,并通过MQTT将它们发送到IoT Core,最终将它们注入我们在Pub/Sub中创建的主题中。</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="1130" class="ll je hh lh b fi lm ln l lo lp">#vuelve al directorio TerramEarth/IoT<br/>cd ..; <br/>#instalamos las dependencias</span><span id="61c5" class="ll je hh lh b fi mj ln l lo lp">npm install<br/> <br/># Emulamos en envío de 10 mensajes desde el tractor, puedes cambiar la cantidad pero creo que con 10 se entiende el concepto.</span><span id="136d" class="ll je hh lh b fi mj ln l lo lp">node cloudiot_mqtt_example_nodejs.js mqttDeviceDemo    \<br/>  --projectId=${TU_PROYECTO} \<br/>  --cloudRegion=us-central1 \<br/>  --registryId=te-tractor  \<br/>  --deviceId=te-tractor-device  \<br/>  --privateKeyFile=resources/rsa_private.pem \<br/>  --numMessages=10 \<br/>  --algorithm=RS256</span></pre><p id="6d86" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">即使你看不到XD,我建议你这样做,使用从PubSub到Cloud Storage的模板在<a class="ae jc" href="https://cloud.google.com/dataflow/docs/guides/templates/provided-templates#cloudpubsubtogcstext" rel="noopener ugc nofollow" target="_blank">DataFlow中创建一个流,这将创建一个流式处理,该流式处理将提交的事件并将其保存在存储桶中的文件中。由于这不是我们期望的最终性能,所以不要记录这个过程,但它工作得很好,我鼓励你自己尝试一下,特别是考虑到目前我们对即将到来的消息视而不见。</a></p><p id="78c4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">非常好,我们已经设法从我们的拖拉机中提取数据,无论是连接还是断开连接,但对于TE来说,这并不便宜,实际上对于该数据量来说,它非常昂贵。</p><p id="3144" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在,我们将看看流处理的成本,然后我们将看到如何降低批处理成本。</p><h2 id="fb6d" class="ll je hh bd jf lr ls lt jj lu lv lw jn ip lx ly jr it lz ma jv ix mb mc jz md bi translated">谈谈银</h2><p id="4e84" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">首先要注意的是,如果您将 <a class="ae jc" href="https://cloud.google.com/iot/pricing" rel="noopener ugc nofollow" target="_blank"> Cloud IoT Core 与 Cloud Pub/Sub </a> 搭配使用,则还需要单独支付 Cloud Pub/Sub 资源使用费。</p><p id="3cc1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">考虑到TE每天生成9TB的数据,我们可以理解,如果我们将它们添加到Google Cloud的<a class="ae jc" href="https://cloud.google.com/products/calculator/#" rel="noopener ugc nofollow" target="_blank">定价计算器(T3),则每月将生成279TB,而不是添加将通过Pub / Sub传输的数据量,这也是279TB,总计153,841.30美元,Wooow,超过15万美元,仅流式处理,在下图中您可以看到每个组件的详细信息。</a></p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mk"><img src="../Images/7b79b3a612f9398adde57e31e1c9928b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2oreTVRhxYF8coj0.png"/></div></div></figure><p id="8395" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我看来,它非常昂贵,它让我认为也许这些数据是解压缩的,但是MQTT的巨大优势之一是它是二进制的,它压缩了接近85%的有效载荷,这降低了传输的总量,搜索信息我发现了一个<a class="ae jc" href="https://help.devicewise.com/display/ARG/MQTT+data+usage" rel="noopener ugc nofollow" target="_blank">分析MQTT</a>及其消耗,并且估计每1小时发送100个属性,每台设备每月大约1.4MB。如果我们将其乘以400万台设备(占总机队的20%),它会产生5.6TB,如果我们记住这是100个字段,我们会添加20%通过云物联网核心的MQTT每月产生6.72TB,并到达可能已经解压缩的Pub/Sub。让我们做另一个计算。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es ml"><img src="../Images/92fd7f866c554d8bbb3b0a8bfc16e92f.png" data-original-src="https://miro.medium.com/v2/resize:fit:878/format:webp/0*bFE3JdGiqiUmDT-p.png"/></div></figure><p id="9dce" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这对我来说更有意义,因为否则IoT Core对任何公司来说都是不可行的。因此,我们估计通过 MQTT 发送的数据会减少。我留下两个屏幕,帮助我发现了这一点。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mm"><img src="../Images/bcaf1a24548cf2e3ef184339ed3dc7a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*P92oSCNigL1KbZi5.png"/></div></div></figure><p id="3d73" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">和这个伟大的分析在<a class="ae jc" href="https://help.devicewise.com/display/ARG/MQTT+data+usage" rel="noopener ugc nofollow" target="_blank">Device Wise</a></p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mn"><img src="../Images/c5f969cb849a03be967ead1c24c11eeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YazR2tIy2xB-LeI0.png"/></div></div></figure><p id="afc2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在,让我们看看我们如何优化批处理过程的成本,该过程比流处理大 4 倍。</p><h1 id="c81c" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">3)档案存储</h1><p id="d75d" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">每当我们需要在云中存储某些内容时,我们必须正确选择要使用的存储类型,可以是各种类型的数据库,NFS,甚至是云存储等全局存储系统。</p><p id="1657" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我留下 <a class="ae jc" href="https://cloud.google.com/storage-options/" rel="noopener ugc nofollow" target="_blank"> 链接到官方文档 </a> 和一个优秀的流程图,这将帮助您确定您的解决方案需要哪种类型的存储,学习它以获得认证将非常有用。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mo"><img src="../Images/db3473b1c2ed2349613f1eb0b077059e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TRw8tBXweHU91lMOcSFDNg.png"/></div></div></figure><p id="cc5d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于 TE,我们显然会使用 Cloud Storage,但正如您所知道的那样,本产品中有 <a class="ae jc" href="https://cloud.google.com/storage/docs/storage-classes" rel="noopener ugc nofollow" target="_blank"> 4 种 </a> 存储类别和一系列最佳实践,可以帮助我们节省一些 <a class="ae jc" href="https://cloud.google.com/storage/pricing" rel="noopener ugc nofollow" target="_blank"> 钱包 </a> XD。</p><p id="1802" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下是您在使用 Cloud Storage 时应该考虑的 <a class="ae jc" href="https://cloud.google.com/storage/docs/best-practices" rel="noopener ugc nofollow" target="_blank"> 最佳实践 </a> 链接。</p><p id="f5cc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">每个班级的价格和特点如下</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mp"><img src="../Images/b0ad48c41027a39ce38f95193638418a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mJIvrjQtJtMbnn58NgHl9A.png"/></div></div></figure><p id="af91" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您担心这些SLA,请记住,Google的存储旨在实现99.999999999%(11.9秒)的年度持久性,这是通过跨多个可用区域跨多个设备冗余存储对象来实现的。</p><h2 id="480a" class="ll je hh bd jf lr ls lt jj lu lv lw jn ip lx ly jr it lz ma jv ix mb mc jz md bi translated">关于Storage TerramEarth</h2><p id="da54" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">在我看来,这种情况下最好的策略是<strong class="ig hi">区域存储</strong>,每月每GB存储的费用为0.020美元,以及允许删除文件的<a class="ae jc" href="https://cloud.google.com/storage/docs/managing-lifecycles" rel="noopener ugc nofollow" target="_blank">生命周期策略</a>。让我们分开...</p><ul class=""><li id="36a6" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><strong class="ig hi"> 类型 </strong></li></ul><p id="611c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们需要做的第一件事是将存储类型从多区域更改为区域,这里的docu<a class="ae jc" href="https://cloud.google.com/storage/docs/changing-storage-classes" rel="noopener ugc nofollow" target="_blank">。</a></p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="ab94" class="ll je hh lh b fi lm ln l lo lp">gsutil rewrite -s regional -r gs://$BUCKET_NAME/**</span></pre><p id="51b8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">根据文档应该是这样的,我错了:</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="7181" class="ll je hh lh b fi lm ln l lo lp">BadRequestException: 400 The combination of locationConstraint and storageClass you provided is not supported for your project</span></pre><p id="485d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此,在这一点上,最好的解决方案是直接从零创建区域。</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="5f97" class="ll je hh lh b fi lm ln l lo lp"># Para eliminar el bucket</span><span id="a89f" class="ll je hh lh b fi mj ln l lo lp">gsutil rm -r gs://$BUCKET_NAME</span><span id="f090" class="ll je hh lh b fi mj ln l lo lp"># Para crearlo regional en </span><span id="8113" class="ll je hh lh b fi mj ln l lo lp">gsutil mb -c regional -l us-central1 gs://$BUCKET_NAME/</span><span id="b82d" class="ll je hh lh b fi mj ln l lo lp"># Subimos nuevamente el Archivo</span><span id="e0a3" class="ll je hh lh b fi mj ln l lo lp">gsutil -o GSUtil:parallel_composite_upload_threshold=15M cp ./data.json gs://$BUCKET_NAME</span></pre><p id="8944" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们已经在一个地区拥有存储桶,与IoT Core us-central1相同,剩下的就是创建一个策略来删除文件。</p><ul class=""><li id="748c" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><strong class="ig hi">政治(T17)</strong></li></ul><p id="d97c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我认为最好将其保留2天,以防Batch流程在第一时间不起作用。为此,我们需要创建一个JSON文件,其中包含以下内容,我认为这只是解释。和往常一样,我在这里给你<a class="ae jc" href="https://cloud.google.com/storage/docs/managing-lifecycles" rel="noopener ugc nofollow" target="_blank">文档</a></p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="36e3" class="ll je hh lh b fi lm ln l lo lp">{<br/>	"lifecycle": {<br/>	  "rule": [<br/>	  {<br/>	    "action": {"type": "Delete"},<br/>	    "condition": {<br/>	      "age": 2,<br/>	      "isLive": true<br/>	    }<br/>	  }<br/>	]<br/>	}<br/>}</span></pre><p id="2f9d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要应用策略,我们需要使用以下命令:</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="d8ef" class="ll je hh lh b fi lm ln l lo lp">gsutil lifecycle set lifecycle.json gs://$BUCKET_NAME</span></pre><p id="0cc8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这将使我们能够控制一些成本,因为存档将持续最多2天。同样,这也使我们在成本方面有点棘手,所以让我们看看云存储中有多少数据。</p><ul class=""><li id="6186" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><strong class="ig hi">成本(T21)</strong></li></ul><p id="aba0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请记住,TE 每天总共生成 196.2TB 片剂,如果这些片剂保留两天,您通常会获得两倍的数据存储量。</p><p id="4b6c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果我们计算这些数据的成本,每月在区域存储中永久存储 392.4TB 可为我们提供:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mq"><img src="../Images/5cdc84edd7f18c0faa28d89f21d1d5ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ndD9HSA8jfHclURa.png"/></div></div></figure><p id="d6ba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">无论如何,如果我们没有应用压缩,类别更改和自动删除策略,那么8000美元的少量XD可能会更昂贵。</p><h1 id="3a21" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">4)数据存储</h1><p id="7a5d" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">在从 Pub/Sub 和 Cloud Storage 移动数据之前,我们需要考虑最终存储数据以供分析,在 GCP 中的所有存储机制中,最适合满足 TE 要求的是 BigQuery。,你应该问自己什么问题来确定这一点。</p><p id="7b97" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">给你几个小把戏:</p><ol class=""><li id="125e" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb mr ky kz la bi translated"><strong class="ig hi">查看我之前在文件存储部分放置的流程图。(T1 )</strong></li><li id="e1f7" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb mr ky kz la bi translated"><strong class="ig hi"> 数据关系</strong>:<br/> a) 是关系型,Cloud Sql,BigQuery,Spanner。<br/>b) 如果是非关系,则为 Datastore、BigTable、Firestore。</li><li id="17bf" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb mr ky kz la bi translated"><strong class="ig hi">考虑数据量</strong>:<br/>a)如果大于10TB,请丢弃Cloud SQL。(B) Petabytes ?使用 BigQuery, Spanner, BigTable</li><li id="c1a4" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb mr ky kz la bi translated"><strong class="ig hi"> 使用或消耗</strong>:<br/>a) 如果你需要分析,丢弃 Datastore,它是不可取的,它没有 SUM、AVG 等聚合函数,在 Where 中没有 OR,也没有 IN(&lt; - 这是 cert 问题),你应该一个一个地问他们。(T13 B) 用于分析?这就是BigQuery。(C)实时?使用 Firestore。<br/> d) TimeSeries ?使用BitTable</li><li id="bcc7" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb mr ky kz la bi translated"><strong class="ig hi"> 连接到哪个</strong>:<br/>a) 您必须连接到 Data Studio,那么考虑一下 Cloud Sql 或 BigQuery<br/>b) 移动应用程序?饰 Firestore</li><li id="efe0" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb mr ky kz la bi translated"><strong class="ig hi">复制</strong>:<br/>a)一个区域?所有<br/>b)多区?Cloud SQL <br/> c) 多区域?出色的Spanner非常高的一致性,但它是昂贵的,BigQuery(欧盟,美国),在Roadmap Cloud SQL中,目前还没有,如果它是No SQL,Firestore和Datastore。</li></ol><p id="e98e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此,如果TE的数据量如此之大,则必须从美国两岸进行访问,其主要目标是分析。所以我认为另一种选择是Big Query。</p><p id="dcc8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">大查询</strong>:这是一个功能强大的数据库,非常类似于<a class="ae jc" href="https://hive.apache.org/" rel="noopener ugc nofollow" target="_blank">Apache Hive</a>,它允许您在几秒钟内查询数PB的数据。你可以说太多关于这个数据库,但它不是目的。我邀请您查看其在认证方面的特点和局限性。但是你需要知道的是谷歌对这个引擎的所有热爱,并试图使其成为市场基准,这对我们来说非常合适。BigQuery 使我们的工作变得非常简单,并与 GCP 平台的其他部分无缝集成。</p><h2 id="85f9" class="ll je hh bd jf lr ls lt jj lu lv lw jn ip lx ly jr it lz ma jv ix mb mc jz md bi translated">手在歌剧</h2><p id="c211" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">BigQuery 的一个伟大之处在于,它允许您基于一个文件自动创建我们的数据库架构,该文件可以是 CSV、JSON、Avro 等。它甚至会这样做,如果这是药丸。太棒了XD</p><p id="3e28" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要根据我们在 Google Cloud Storage 中留下的 JSON 文件自动创建 <a class="ae jc" href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-json#loading_json_data_with_schema_auto-detection" rel="noopener ugc nofollow" target="_blank"> 架构,只需运行以下命令即可。</a></p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="8608" class="ll je hh lh b fi lm ln l lo lp">#Creamos el dataset</span><span id="0e06" class="ll je hh lh b fi mj ln l lo lp">bq --location=US mk --dataset --description "Dataset principal de TerramEarth" ${TU_PROYECTO}:terramearth</span><span id="3f21" class="ll je hh lh b fi mj ln l lo lp">#Creamos la tabla a partir del archivo</span><span id="db41" class="ll je hh lh b fi mj ln l lo lp">bq --location=US load --autodetect --source_format=NEWLINE_DELIMITED_JSON terramearth.tractordata gs://$BUCKET_NAME/data.json.gz</span></pre><p id="5431" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这样做的优点是,你不应该复杂的手工创建的方案,特别是当它是如此复杂,因为它是我们想要为您存储。</p><p id="92c3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你需要记住的一件事是,数据必须是JSON,但以换行符分隔,也就是说,它不是一个由逗号分隔的内部有很多对象的数组,而是一个每行都有一个有效的JSON对象的文件。</p><p id="f589" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要成为一名优秀的云架构师,您需要考虑很多因素,特别是BigQuery,如果您考虑存储的数据量,并且要消耗的数据量可能会让TE付出沉重的代价。因此,让我们来看看有助于我们优化这些成本的一些因素。我在这里留下一个漂亮的<a class="ae jc" rel="noopener" href="/google-cloud/bigquery-optimized-cluster-your-tables-65e2f684594b">文章!！！</a>和<a class="ae jc" href="https://cloud.google.com/bigquery/docs/best-practices-performance-compute" rel="noopener ugc nofollow" target="_blank">官方良好做法在这里</a>。</p><ul class=""><li id="e91a" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated">尽量不要使用查询转换数据。</li><li id="ef73" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">例如,在聚合函数中使用近似值,而不是 COUNT(DISTINCT),则使用 APPROX_COUNT_DISTINCT()。</li><li id="8bba" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">在排序之前应用过滤器,以便在较少的日期上进行排序。</li><li id="d0e2" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">整理你的表格。</li><li id="38bf" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">尝试查找与聚类、日期或大型组相关的字段。</li><li id="1fec" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">强制在require_partition_filter=true查询中指定集群值。</li><li id="6bee" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">在queys中,它尊重集群的顺序。</li><li id="0673" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">规范化表并正确使用 JOINS。</li><li id="e837" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">使用基于聚集字段的 GROUP BYs。</li><li id="3ed9" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">配额,您可以在项目级别、数据集级别、用户级别或组级别(甚至在查询级别)设置千字节限制。</li></ul><p id="bc77" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果我们对价格粗心,我们可能会发生金融灾难,它已经过去了XD-什么看看如果我们在一个月的31天内每天考虑900TB,插入,存储和查询,只需1个月(27.9 Petabytes)就会产生多少......它提供超过200万美元,使其不可行。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es ms"><img src="../Images/1821190f7348d58e918ee0f8a8261f25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YUioFXeCT0mYcxNB.png"/></div></div></figure><p id="b8dc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了防止这种疯狂发生,遵循良好的做法。</p><h2 id="d734" class="ll je hh bd jf lr ls lt jj lu lv lw jn ip lx ly jr it lz ma jv ix mb mc jz md bi translated">解决问题的办法 The Solution of the Problem</h2><p id="48ce" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我最近包含在 BigQuery 中的一个很棒的东西是 <a class="ae jc" href="https://cloud.google.com/bigquery/pricing#flat_rate_pricing" rel="noopener ugc nofollow" target="_blank"> 计划费率 </a>,你肯定会喜欢这种方法。您可以从具有2000个插槽的Flat Rate 40到具有5000个插槽的Flat Rate 100(每月10万美元)。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mt"><img src="../Images/8f6be69774e8f14d608518184d2d801f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r0RCSpQJxqhED6xq.png"/></div></div></figure><p id="625c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您需要支付的唯一额外费用是存储空间,在这种情况下,对于<strong class="ig hi">27 PB</strong>来说,存储空间相当于600,000美元。这让我们思考,我们不应该存储所有数据,而应该只存储用于优化备件购买的数据。</p><p id="ba4c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在认证方面,我还建议您考虑在自己的项目中以及在其他项目中使用 BigQuery 所需的权限(</p><p id="f6c5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Bueno ya tenemos nuestra Tabla en la Base de Datos y solo nos queda mover los datos desde Pub/Sub y Cloud Storage a BigQuery.</p><h1 id="d625" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">5) Procesamiento</h1><p id="8bc3" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">Venimos excelente con nuestra implementación profesional de TerramEarth, y no será menos en el procesamiento de datos, para ello haremos uso de Dataflow, tanto para el proceso Batch como para el basado en eventos con Pub/Sub</p><p id="6167" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">La mejor ventaja que nos da Cloud Dataflow es que tiene plantillas que abordan los escenarios más comunes de movimiento y transformación de datos.</p><p id="4e13" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Para conocerlos mejor entra a la <a class="ae jc" href="https://cloud.google.com/dataflow/docs/guides/templates/provided-templates" rel="noopener ugc nofollow" target="_blank"> 官方模板文档</a> )。在这种情况下最适合我们的是:</p><ul class=""><li id="790f" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><a class="ae jc" href="https://cloud.google.com/dataflow/docs/guides/templates/provided-templates#cloud-storage-text-to-bigquery-stream" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">Cloud Storage to BigQuery — 流式传输</strong></a>:这是 Dataflow 中的一个作业,它从 Cloud Storage 中的源读取文件,获取一个 JSON 格式的文件,甚至可以使用<a class="ae jc" href="https://cloud.google.com/bigquery/user-defined-functions" rel="noopener ugc nofollow" target="_blank">UDF</a>压缩并转换该文件,将其插入 BigQuery 表中。这个模板的巨大优势是流式传输或更好地理解它,它仍然是运行和基于老板识别何时将文件添加到存储桶并立即处理它。</li></ul><p id="9532" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">考虑到<a class="ae jc" href="https://cloud.google.com/bigquery/user-defined-functions" rel="noopener ugc nofollow" target="_blank"> UDF文档</a>,为了实现此流程,必须首先在数据库中生成目标模式,BigQuery再次使这项工作变得非常容易。要获取此方案,只需运行:</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="f292" class="ll je hh lh b fi lm ln l lo lp">bq show --format=prettyjson ${TU_PROYECTO}:terramearth.tractordata | jq '.schema.fields'</span></pre><p id="ca97" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们获取此命令提供的内容,并将其保存到一个名为 schema.json 的文件中,然后将其上传到存储中。</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="e653" class="ll je hh lh b fi lm ln l lo lp">cd DataFlow;</span><span id="1529" class="ll je hh lh b fi mj ln l lo lp">gsutil mb gs://${BUCKET_NAME}-dataflow</span><span id="67f8" class="ll je hh lh b fi mj ln l lo lp">gsutil cp schema.json gs://${BUCKET_NAME}-dataflow</span></pre><p id="3a38" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">和一个UDF转换功能,在这种情况下不久。但是,如果你想减少你在BQ中输入的数据,这是正确的地方...</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="73ff" class="ll je hh lh b fi lm ln l lo lp">gsutil cp transform.js gs://${BUCKET_NAME}-dataflow/</span></pre><p id="7111" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦你有上面的文件,我们将运行Dataflow作业,并让它运行等待新的文件。</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="4312" class="ll je hh lh b fi lm ln l lo lp">JOB_NAME_GCS=gcs_text_to_bigquery-`date +"%Y%m%d-%H%M%S%z"`</span><span id="28df" class="ll je hh lh b fi mj ln l lo lp">gcloud dataflow jobs run ${JOB_NAME_GCS} \<br/>    --gcs-location gs://dataflow-templates/latest/Stream_GCS_Text_to_BigQuery \<br/>    --parameters \<br/>javascriptTextTransformFunctionName=transform,\<br/>JSONPath=gs://${BUCKET_NAME}-dataflow/schema.json,\<br/>javascriptTextTransformGcsPath=gs://${BUCKET_NAME}-dataflow/transform.js,\<br/>inputFilePattern=gs://${BUCKET_NAME}/*.json.gz,\<br/>outputTable=${TU_PROYECTO}:terramearth.tractordata,\<br/>bigQueryLoadingTemporaryDirectory=gs://${BUCKET_NAME}-dataflow/temp</span></pre><p id="d433" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Dataflow中可以看到</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mu"><img src="../Images/6df5067980834d6956e0c98f75b09a4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DGWVRQ_TdqQV9CsA.png"/></div></div></figure><p id="4ac5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了能够测试它是否有效,我们需要上传一个带有新数据的文件,在这种情况下,它将是相同的,但具有不同的名称,因为流需要的是符合JSON schema和名称为*.json.gz的文件。</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="3a93" class="ll je hh lh b fi lm ln l lo lp">gsutil cp ./data.json.gz gs://$BUCKET_NAME/data_2.json.gz</span></pre><p id="5855" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果我们进入 BigQuery 并拿出一个计数,我们应该看到最初的 90,000 条记录,当这个过程结束时,我们应该有两倍的记录。</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="5964" class="ll je hh lh b fi lm ln l lo lp">bq query --nouse_legacy_sql 'select count(1) from `${TU_PROYECTO}.terramearth.tractordata`';</span></pre><ul class=""><li id="c277" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><a class="ae jc" href="https://cloud.google.com/dataflow/docs/guides/templates/provided-templates#cloud-pubsub-to-bigquery" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi"> Cloud Pub/Sub to BigQuery — 流式传输</strong></a> 这是一个更简单的工作,您将阅读您在其中编写Cloud IoT Core的Pub/Sub主题并将其插入到BigQuery表中,当您听到Pub/Sub主题时,此过程处于活动状态,等待数据流式传输。</li></ul><p id="60ad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了能够实施它,它非常简单。执行以下命令:</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="67bc" class="ll je hh lh b fi lm ln l lo lp">JOB_NAME_PUB_SUB=pubsub-to-bigquery-`date +"%Y%m%d-%H%M%S%z"`<br/></span><span id="29ec" class="ll je hh lh b fi mj ln l lo lp">gcloud dataflow jobs run ${JOB_NAME_PUB_SUB} \<br/>    --gcs-location gs://dataflow-templates/latest/PubSub_to_BigQuery \<br/>    --parameters \<br/>inputTopic=projects/${TU_PROYECTO}/topics/te-tractor-topic,\<br/>outputTableSpec=${TU_PROYECTO}:terramearth.tractordata</span></pre><p id="d3a2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是在Dataflow中看到的:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mv"><img src="../Images/3643b106a3575774f30d2ebad9c7c898.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*V-XA_5U83Wvegxex.png"/></div></div></figure><p id="7b66" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们如何证明它是有效的?？？简单,只需运行我们在开始时使用的将事件发送到IoT Core的过程。(给它几分钟的流动举起工人)</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="bcb8" class="ll je hh lh b fi lm ln l lo lp">#vuelve al directorio TerramEarth/IoT<br/>cd ../IoT; </span><span id="9705" class="ll je hh lh b fi mj ln l lo lp"># Emulamos en envío de 10 mensajes desde el tractor, puedes cambiar la cantidad pero creo que con 10 se entiende el concepto.</span><span id="a236" class="ll je hh lh b fi mj ln l lo lp">node cloudiot_mqtt_example_nodejs.js mqttDeviceDemo    \<br/>  --projectId=${TU_PROYECTO} \<br/>  --cloudRegion=us-central1 \<br/>  --registryId=te-tractor  \<br/>  --deviceId=te-tractor-device  \<br/>  --privateKeyFile=resources/rsa_private.pem \<br/>  --numMessages=10 \<br/>  --algorithm=RS256</span></pre><p id="14c8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们可以在Big Query中看到结果,记录数量应该增加10。</p><pre class="kh ki kj kk fd lg lh li lj aw lk bi"><span id="dbc1" class="ll je hh lh b fi lm ln l lo lp">bq query --nouse_legacy_sql 'select count(1) from `${TU_PROYECTO}.terramearth.tractordata`';</span></pre><p id="909b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您已经看到了将Dataflow与模板一起使用是多么容易,但如果您想开始使用Dataflow,我建议您遵循本<a class="ae jc" href="https://cloud.google.com/dataflow/docs/quickstarts/quickstart-java-maven" rel="noopener ugc nofollow" target="_blank">指南</a> 。</p><p id="e64f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">到目前为止,我们已经在 BigQuery 中提供了数据,但我们需要使用 Data Studio 对其进行可视化,并使用 BigQuery ML 进行分析,以预测备件需求。</p><p id="aaf4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我希望这个茶指南有用,我们下一篇文章见。</p><h1 id="a72c" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">在接下来的交付中,我们将看到以下几点。</h1><h1 id="6ac9" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">(6)可视化</h1><h1 id="e14c" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">(7)预测</h1><p id="96b2" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">一个拥抱。</p></div></div>    
</body>
</html>