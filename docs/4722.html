<html>
<head>
<title>Shotgun: Building the OSS Moneysafe Library from Scratch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">猎枪:从零开始建立OSS货币安全图书馆</h1>
<blockquote>原文：<a href="https://medium.com/javascript-scene/shotgun-building-the-oss-moneysafe-library-from-scratch-c9117ffe5f9b?source=collection_archive---------3-----------------------#2017-08-15">https://medium.com/javascript-scene/shotgun-building-the-oss-moneysafe-library-from-scratch-c9117ffe5f9b?source=collection_archive---------3-----------------------#2017-08-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/991d0b9dbb03bab579fb88c41f2f5453.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lo8cD5m7VqUXPlKF3lgfNQ.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo: <a class="ae it" href="https://www.flickr.com/photos/luxurydesigner/" rel="noopener ugc nofollow" target="_blank">Brandon Bailey</a> — Midnight Cowboy (CC-BY-2.0)</figcaption></figure><blockquote class="iu iv iw"><p id="6638" class="ix iy iz ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv ha bi translated">当我构建真正的软件(和开源库)时，猎枪视频系列让你与我并肩作战。</p></blockquote><p id="e125" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">观看我使用单元测试作为指南，从零开始构建OSS库。Moneysafe旨在简化JavaScript中的货币操作。它使用函数式编程思想来构建易于学习和使用的直观API。</p><p id="fc5d" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">在GitHub 上查看<a class="ae it" href="https://github.com/ericelliott/moneysafe" rel="noopener ugc nofollow" target="_blank">货币安全图书馆。</a></p><p id="c84e" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">为<a class="ae it" href="http://ericelliottjs.com/" rel="noopener ugc nofollow" target="_blank">EricElliottJS.com</a>的成员推出了一部新的7集散弹枪迷你剧。会员可以登录并立即观看剧集。</p><p id="2ed3" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">点击这里查看第一集:</p><figure class="jz ka kb kc fd ii"><div class="bz dy l di"><div class="kd ke l"/></div></figure><h1 id="a8e8" class="kf kg hh bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">什么是货币安全？</h1><p id="cd9b" class="pw-post-body-paragraph ix iy hh ja b jb ld jd je jf le jh ji jw lf jl jm jx lg jp jq jy lh jt ju jv ha bi translated">Moneysafe是一个开源的JavaScript库，旨在让用JavaScript进行资金安全的计算变得非常简单。</p><p id="527e" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">用JavaScript编写处理金钱的软件有点麻烦。资金安全的计算比想象的要困难。</p><p id="ba9c" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">为什么？因为JavaScript数字是IEEE 754 64位浮点。结果是我们不能安全地添加货币，因为小数会被浮点舍入误差串起来。</p><pre class="jz ka kb kc fd li lj lk ll aw lm bi"><span id="4512" class="ln kg hh lj b fi lo lp l lq lr">.2 + .1 === .3; // false</span></pre><p id="5796" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">然而，如果你以美分为单位进行同样的计算，然后四舍五入到最接近的美分，这个问题就不存在了。Moneysafe将您的美元值转换成美分，然后将它们暴露给普通的JavaScript数学运算符，因此您可以像平常一样使用<code class="du ls lt lu lj b">+</code>、<code class="du ls lt lu lj b">-</code>、<code class="du ls lt lu lj b">*</code>、<code class="du ls lt lu lj b">/</code>。</p><h2 id="582a" class="ln kg hh bd kh lv lw lx kl ly lz ma kp jw mb mc kt jx md me kx jy mf mg lb mh bi translated">用安全的钱</h2><p id="de5f" class="pw-post-body-paragraph ix iy hh ja b jb ld jd je jf le jh ji jw lf jl jm jx lg jp jq jy lh jt ju jv ha bi translated">从npm安装:</p><pre class="jz ka kb kc fd li lj lk ll aw lm bi"><span id="0ada" class="ln kg hh lj b fi lo lp l lq lr">npm install --save moneysafe</span></pre><p id="f50c" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">然后导入并使用:</p><pre class="jz ka kb kc fd li lj lk ll aw lm bi"><span id="3820" class="ln kg hh lj b fi lo lp l lq lr">import { $ } from 'moneysafe';</span><span id="e2e2" class="ln kg hh lj b fi mi lp l lq lr">$(.1) + $(.2) === $(.3).cents;</span></pre><p id="3e33" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">甚至更好。对于购物车等常见计算，有一个方便的分类帐表单:</p><pre class="jz ka kb kc fd li lj lk ll aw lm bi"><span id="d728" class="ln kg hh lj b fi lo lp l lq lr">import { $ } from 'moneysafe';<br/>import { $$, subtractPercent, addPercent } from 'moneysafe/ledger';</span><span id="6f08" class="ln kg hh lj b fi mi lp l lq lr">$$(<br/>  $(40),<br/>  $(60),<br/>  // subtract discount<br/>  subtractPercent(20),<br/>  // add tax<br/>  addPercent(10)<br/>).$; // 88</span></pre><h1 id="e2c0" class="kf kg hh bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">Moneysafe是如何运作的？</h1><p id="4fd3" class="pw-post-body-paragraph ix iy hh ja b jb ld jd je jf le jh ji jw lf jl jm jx lg jp jq jy lh jt ju jv ha bi translated">它的工作原理是以美分而不是美元来存储和处理金额，这减少了将金额表示为十进制美元时的浮点舍入误差。当然，在大量的乘法和除法运算中，您仍然会遇到舍入误差，但是当换算到美分时，误差就不那么常见和显著了。</p><p id="9761" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">关于金钱的最佳实践是以完全浮点精度用美分进行计算，然后在准备使用最终值时四舍五入到最接近的美分。</p><p id="8bc7" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">那些<code class="du ls lt lu lj b">$()</code>符号<em class="iz">不是jQuery。</em>这是一个货币工厂，它将您的计算从美元值扩展到美分，并添加了一些方便的工具，如自动舍入到最近美分的<code class="du ls lt lu lj b">money.$</code>和<code class="du ls lt lu lj b">money.cents</code>getter，以及允许您使用普通JavaScript数学运算符的<code class="du ls lt lu lj b">money.valueOf()</code>方法。</p><h1 id="2ba7" class="kf kg hh bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">货币安全准确性注释</h1><p id="0aeb" class="pw-post-body-paragraph ix iy hh ja b jb ld jd je jf le jh ji jw lf jl jm jx lg jp jq jy lh jt ju jv ha bi translated">关于准确的货币计算有很多误解。以下是Moneysafe使用原生JavaScript <code class="du ls lt lu lj b">Number</code>类型的原因:</p><h2 id="b1b8" class="ln kg hh bd kh lv lw lx kl ly lz ma kp jw mb mc kt jx md me kx jy mf mg lb mh bi translated">小数类型不能修复舍入误差</h2><p id="1eb7" class="pw-post-body-paragraph ix iy hh ja b jb ld jd je jf le jh ji jw lf jl jm jx lg jp jq jy lh jt ju jv ha bi translated">有些人认为“只使用小数类型”是货币计算中浮点舍入误差的好解决方案，但这种观点是错误的。</p><p id="8aa8" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated"><strong class="ja hi">所有的小数类型都有舍入误差</strong>，无论基数还是精度，因为有些分数没有无限位数是无法准确表示为小数的。一些必须以2为基数舍入的分数以10为基数是有限的。这导致了混乱，但是<em class="iz">并没有使基数10更精确。</em></p><p id="4326" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">例如，<code class="du ls lt lu lj b">5/6</code>总是取整，不考虑基数。<code class="du ls lt lu lj b">1/3</code>始终以10为基数四舍五入。同样，如果您的decimal类型被设置为2小数精度(对于美分)，那么如果不进行舍入，您就不能准确地表示<code class="du ls lt lu lj b">1/1000</code>——这是那些认为他们可以“只使用decimal类型”来进行精确货币计算的人的常见错误。</p><p id="3215" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">当你从基数为2的浮点数转换到基数为10的十进制数时，你所要做的就是改变<em class="iz">哪些分数</em>会产生舍入误差。</p><p id="5bdc" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">一些十进制类型在每次计算时会自动舍入到最接近的美分，但是<strong class="ja hi">这会使精确度更差，而不是更好，</strong>在小得多的十进制精度下引入累积舍入误差。</p><p id="2b29" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated"><strong class="ja hi"> Moneysafe使用完整的IEEE 754浮点十进制精度来计算分的小数部分。</strong></p><p id="41eb" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">在Moneysafe中，IEEE 754给了我们十进制精度的大概<strong class="ja hi"> 16位小数。</strong></p><p id="209b" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">与大多数十进制库不同，每次计算都会保留整个可用精度范围，而不是四舍五入。我们不会因为每次计算的舍入而使舍入误差变大。我们只在用户说是时候取整的时候取整，所以取整误差尽可能小。</p><p id="55a9" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">我们通过鼓励使用<code class="du ls lt lu lj b">.$</code> getter来实现自动舍入，当您需要得到以美元为单位的值时，或者当您需要以美分为单位的值时，使用<code class="du ls lt lu lj b">.cents</code>，舍入到最接近的美分。</p><h2 id="7122" class="ln kg hh bd kh lv lw lx kl ly lz ma kp jw mb mc kt jx md me kx jy mf mg lb mh bi translated">Moneysafe对所有整分数值都有完美的表示准确性。</h2><p id="25f3" class="pw-post-body-paragraph ix iy hh ja b jb ld jd je jf le jh ji jw lf jl jm jx lg jp jq jy lh jt ju jv ha bi translated">整分精度还扩展到所有的<code class="du ls lt lu lj b">+</code> &amp; <code class="du ls lt lu lj b">—</code>计算。无舍入意味着无舍入误差。</p><h2 id="a84d" class="ln kg hh bd kh lv lw lx kl ly lz ma kp jw mb mc kt jx md me kx jy mf mg lb mh bi translated">函数式编程的货币组合</h2><p id="0471" class="pw-post-body-paragraph ix iy hh ja b jb ld jd je jf le jh ji jw lf jl jm jx lg jp jq jy lh jt ju jv ha bi translated">Moneysafe使用可组合函数作为数据类型。要了解其工作原理，请查看<a class="ae it" rel="noopener" href="/javascript-scene/composing-software-an-introduction-27b72500d6ea">“组合软件”系列</a>(了解<a class="ae it" rel="noopener" href="/javascript-scene/master-the-javascript-interview-what-is-function-composition-20dfb109a1a0">函数组合</a>、<a class="ae it" rel="noopener" href="/javascript-scene/higher-order-functions-composing-software-5365cf2cbe99">高阶函数</a>、<a class="ae it" rel="noopener" href="/javascript-scene/reduce-composing-software-fe22f0c39a1d">归约</a>)，尤其是<a class="ae it" rel="noopener" href="/javascript-scene/composable-datatypes-with-functions-aec72db3b093">“带函数的可组合数据类型”</a>帖子。</p><h1 id="b84c" class="kf kg hh bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">后续步骤</h1><p id="e44a" class="pw-post-body-paragraph ix iy hh ja b jb ld jd je jf le jh ji jw lf jl jm jx lg jp jq jy lh jt ju jv ha bi translated">想了解更多关于TDD和JavaScript函数式编程的知识吗？</p><p id="6a7e" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated"><a class="ae it" href="http://ericelliottjs.com/product/lifetime-access-pass/" rel="noopener ugc nofollow" target="_blank">跟Eric Elliott学JavaScript】。如果你不是会员，你就错过了！</a></p><figure class="jz ka kb kc fd ii er es paragraph-image"><a href="https://ericelliottjs.com/product/lifetime-access-pass/"><div class="er es mj"><img src="../Images/ebd7dfc9ae8d8938e30bdbdbe428fd4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3njisYUeHOdyLCGZ8czt_w.jpeg"/></div></a></figure></div><div class="ab cl mk ml go mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ha hb hc hd he"><p id="5e7e" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated"><strong class="ja hi"> <em class="iz">埃里克·艾略特</em> </strong> <em class="iz">是</em> <a class="ae it" href="http://pjabook.com" rel="noopener ugc nofollow" target="_blank"> <em class="iz">【编程JavaScript应用】</em> </a> <em class="iz"> (O'Reilly)的作者，也是</em><a class="ae it" href="https://devanywhere.io" rel="noopener ugc nofollow" target="_blank"><em class="iz">devanywhere . io</em></a><em class="iz">的联合创始人。他为Adobe Systems的</em><strong class="ja hi"><em class="iz"/></strong><em class="iz"/><strong class="ja hi"><em class="iz">尊巴健身</em></strong><em class="iz"/><strong class="ja hi"><em class="iz">华尔街日报</em></strong><em class="iz"/><strong class="ja hi"><em class="iz">ESPN</em></strong><em class="iz"/><em class="iz">BBC</em><em class="iz">等顶级录音师贡献了软件经验</em></p><p id="98ef" class="pw-post-body-paragraph ix iy hh ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv ha bi translated">他和世界上最美丽的女人一起在任何他想去的地方工作。</p></div></div>    
</body>
</html>