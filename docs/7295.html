<html>
<head>
<title>Understanding Composition Browser Events</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解合成浏览器事件</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/understanding-composition-browser-events-f402a8ed5643?source=collection_archive---------4-----------------------#2018-03-01">https://medium.com/square-corner-blog/understanding-composition-browser-events-f402a8ed5643?source=collection_archive---------4-----------------------#2018-03-01</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="b34a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">什么是IME，我为什么要关心？</p><blockquote class="jd"><p id="d94c" class="je jf hh bd jg jh ji jj jk jl jm jb dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们在https://developer.squareup.com/blog<a class="ae jn" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">的新家</a></p></blockquote><p id="3027" class="pw-post-body-paragraph ie if hh ig b ih jo ij ik il jp in io ip jq ir is it jr iv iw ix js iz ja jb ha bi translated">我们的Square卖家需要对他们的整个业务有一个统一的视图，这就是Dashboard的用武之地。Dashboard是一个大型前端Ember应用程序，使卖家能够通过分析、报告和各种服务有效地运营他们的业务。我们不断为Dashboard添加新功能，以帮助我们的卖家利用Square平台做更多事情。</p><p id="6d12" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最近，我的团队一直在开发一个特殊的功能，用于在Dashboard中搜索各种产品。当用户在搜索框中键入内容时，一个简短的搜索建议列表会显示在输入内容的下方，如果他们按下enter键，一个新的标签会打开，显示所有结果。看起来很简单，对吧？</p><p id="8505" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">不幸的是，当我开始用英语之外的语言测试这个搜索框时，我注意到了一些非常不可取的行为:当我仔细地构思我的搜索查询时，突然一个新标签会不知从哪里打开！我决定进行调查，最终我了解到了一些关于浏览器和其他语言的文本组成的非常有趣的细节。但是首先，让我们回顾一下什么是IME。</p></div><div class="ab cl jt ju go jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="ha hb hc hd he"><p id="a7e0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi">An input method editor, or IME, is an operating system-level program that converts characters from one language or character set to another language or character set. For example, let’s say that I wanted to type the character 桜 (Japanese for “cherry blossom”). I don’t have that character on my keyboard, but if I enable an IME on my OS, I can set my input source as Japanese and type the Romanization of the phrase: “sakura”. Let’s see what happens!</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div class="er es ka"><img src="../Images/8848bc7c08c167e2e45fe7e4f7b9a556.png" data-original-src="https://miro.medium.com/v2/resize:fit:308/1*YZJMiQ2Tki69QBdpDAJmlA.gif"/></div></figure><p id="9d58" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当我开始键入时，文本下方会出现一条下划线，表示IME处于活动状态。当我的操作系统试图智能地决定什么是最好的表示时，英文字符会自动转换成各种日文字符集。(像日语这样的许多语言有数百个同音词，因此对于一个发音，可能有许多可行的转换。)在这个过程中的任何时候，我都可以按键盘上的空格键或上/下箭头键来打开一个对话框，让我选择哪一组字符与我想表达的意思相匹配。</p><p id="eae4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi">From this point, hitting enter will lightly confirm my selection, letting me use the left and right arrow keys to move to another section of my sentence to convert next. For my simple example, I don’t have any other sections to convert, so I can hit enter a second time to commit my decision. Now, the character 桜 is placed in the input, and the IME disappears. 桜 acts just like any typical text, so it can be deleted, copied/pasted, and so forth. Character conversion via an IME is one of the primary ways that users from various countries are able to type in their native languages with ease.</p></div><div class="ab cl jt ju go jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="ha hb hc hd he"><p id="aa09" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">好的，太好了！现在我们知道IME是如何工作的了。那么是什么问题呢？</p><p id="8e65" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，为了与IME交互，需要进行大量的键盘输入——我们可以使用箭头键、空格键、回车键等等。起初，我天真地认为，由于IME是一个操作系统程序，任何输入或编辑都将存在于浏览器之外，因此浏览器将不会注意到我正在使用IME的事实。但事实并非如此！IME中的每一次按键都会被操作系统<strong class="ig hi">和浏览器</strong>响应！因此，当用户按下回车键来确认他们的IME选择时，我们的代码会立即处理一个keydown事件，打开一个新的选项卡，即使用户可能还没有完成他们的搜索查询。不好！如果代码处于这种状态，我们会让许多Square卖家用他们的母语使用我们的搜索框变得非常麻烦。</p><p id="6913" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc">(重要提示:这个bug不仅限于回车键！如果您有一个监听任何与IME控制方式一致的事件的输入，那么您的代码中可能会有类似的bug。)</em></p><p id="a26f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">那么如何才能修复呢？我花了 <a class="ae jn" href="https://www.stum.de/2016/06/24/handling-ime-events-in-javascript/" rel="noopener ugc nofollow" target="_blank">研究</a>的<a class="ae jn" href="https://developer.mozilla.org/en-US/docs/Web/Events/compositionstart" rel="noopener ugc nofollow" target="_blank">位</a> <a class="ae jn" href="https://readable-email.org/list/webkit-dev/topic/handling-ime-composition-events" rel="noopener ugc nofollow" target="_blank">，但我最终了解到了两个我以前从未遇到过的浏览器事件:<code class="du ki kj kk kl b">compositionStart </code>和<code class="du ki kj kk kl b">compositionEnd</code>。当用户开始用IME输入时，现代浏览器触发<code class="du ki kj kk kl b">compositionStart</code>事件，当文本最终被确认时，<code class="du ki kj kk kl b">compositionEnd</code>将被触发(有一个例外—见下文)。这正是我们所需要的！现在，我们可以在应用程序中设置一些状态，关于用户当前是否正在通过IME编写一些文本，如果是，我们将不使用任何自己的键盘事件逻辑。代码如下所示:</a></p><figure class="kb kc kd ke fd kf"><div class="bz dy l di"><div class="km kn l"/></div></figure></div><div class="ab cl jt ju go jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="ha hb hc hd he"><p id="3c03" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">万岁！这在我们在Square支持的浏览器中运行良好，只有一个例外。当用户想要完成他们的合成时出现问题；在这种状态下，<code class="du ki kj kk kl b">isComposing</code>是真实的。首先，我们来看看快乐案例中的事件链。</p><ul class=""><li id="fbb0" class="ko kp hh ig b ih ii il im ip kq it kr ix ks jb kt ku kv kw bi translated">用户按回车键结束合成。</li><li id="d24a" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated">浏览器启动<code class="du ki kj kk kl b">keyDown</code>，在<code class="du ki kj kk kl b">keyDown()</code>中运行我们的代码。<code class="du ki kj kk kl b">isComposing</code>是真的，所以我们提前退出。</li><li id="b69c" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated">浏览器启动<code class="du ki kj kk kl b">compositionEnd</code>，在<code class="du ki kj kk kl b">handleCompositionEnd()</code>中运行我们的代码。<code class="du ki kj kk kl b">isComposing</code>被设置为假。</li><li id="94c5" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated">用户再次点击enter。</li><li id="ea3c" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated">浏览器再次触发<code class="du ki kj kk kl b">keyDown</code>，但是由于<code class="du ki kj kk kl b">isComposing</code>现在为假，我们运行我们的自定义代码。</li></ul><p id="fe0c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是用户应该期望的；只有在完成撰写之后，后续的enter presses才应该在新的标签中打开他们的搜索查询。然而，在我的测试中，Safari似乎以相反的顺序触发了<code class="du ki kj kk kl b">keyDown</code>和<code class="du ki kj kk kl b">compositionEnd</code>事件。逻辑路径如下:</p><ul class=""><li id="4b04" class="ko kp hh ig b ih ii il im ip kq it kr ix ks jb kt ku kv kw bi translated">用户按回车键结束合成。</li><li id="21de" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated">Safari启动<code class="du ki kj kk kl b">compositionEnd</code>，在<code class="du ki kj kk kl b">handleCompositionEnd()</code>中运行我们的代码。<code class="du ki kj kk kl b">isComposing</code>被设置为假。</li><li id="45da" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated">Safari启动<code class="du ki kj kk kl b">keyDown</code>，在<code class="du ki kj kk kl b">keyDown()</code>中运行我们的代码。<code class="du ki kj kk kl b">isComposing</code>是假的，所以我们运行我们的自定义代码。</li></ul><p id="46b1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">换句话说，在新标签页中打开查询时，完成合成的回车键会被重复计算一次，这是一种糟糕的体验。为了解决这个问题，我将<code class="du ki kj kk kl b">handleCompositionEnd()</code>中的行包装在一个Ember队列中，这样它将总是在<code class="du ki kj kk kl b">keyDown</code>事件之后运行:</p><figure class="kb kc kd ke fd kf"><div class="bz dy l di"><div class="km kn l"/></div></figure></div><div class="ab cl jt ju go jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="ha hb hc hd he"><p id="29c9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最终，我们的输入成功地处理了来自多个来源的文本输入！这是一个非常酷的bug，我花了很长时间才找到它，但是一旦我理解了它，就有了一个非常好的解决方案。一些个人心得:</p><ul class=""><li id="a986" class="ko kp hh ig b ih ii il im ip kq it kr ix ks jb kt ku kv kw bi translated"><strong class="ig hi">考虑与你大相径庭的用户很关键。</strong>这适用于国际化(不同的输入源、翻译时的内容移动大小、从右向左的语言)和可访问性(盲人用户的屏幕阅读器、仅键盘访问)。如果你只测试你使用软件的方式，你可能会错过你的用户群的重要部分！</li><li id="23a8" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated">如果你最终写了一堆非常复杂的逻辑，感觉很粗糙，最好后退一步，重新评估你的选择。当我开始做这个的时候，我不知道合成事件，并且尝试了一些非常荒谬的事情来检测用户是否正在通过IME打字。这种痛苦迫使我做更多的研究，最终我找到了一个干净的解决方案。</li><li id="fafb" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated">MDN文档中有一些隐藏的宝石。😉此外，<a class="ae jn" href="https://caniuse.com/#feat=ime" rel="noopener ugc nofollow" target="_blank">这个网站</a>对于找出跨浏览器的奇怪之处是无价的。</li></ul><p id="1003" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">感谢阅读！如果你对此感兴趣，看看Square 这里的一些<a class="ae jn" href="https://squareup.com/careers/jobs?role=Engineering" rel="noopener ugc nofollow" target="_blank">职位空缺——我们一直在寻找有才华的工程师加入我们的团队！</a></p></div></div>    
</body>
</html>