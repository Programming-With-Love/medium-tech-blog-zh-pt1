<html>
<head>
<title>Send simple email in Azure DevOps using PowerShell (without any smtp server)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用PowerShell在Azure DevOps中发送简单的电子邮件(无需任何smtp服务器)</h1>
<blockquote>原文：<a href="https://medium.com/globant/send-simple-email-in-azure-devops-using-powershell-without-any-smtp-server-bd669a24e544?source=collection_archive---------0-----------------------#2020-11-06">https://medium.com/globant/send-simple-email-in-azure-devops-using-powershell-without-any-smtp-server-bd669a24e544?source=collection_archive---------0-----------------------#2020-11-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="4872" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">简介:</h1><p id="4a9b" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">本文是Azure Devops自动化系列的第一篇文章，其中没有任何特定的任务，我们可以使用脚本(主要是Powershell)实现许多自动化。这篇文章是关于在azure pipeline PowerShell任务中发送简单的电子邮件，而不需要任何smtp服务器或市场任务。这解决了很多不允许项目使用外部SMTP服务器的安全问题。所有的邮件都将由azuredevops@microsoft.com Azure devo PS发送。</p><h1 id="35be" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">背景</h1><p id="866a" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">我们会遇到这样的情况，我们需要发送简单的电子邮件来通知Azure DevOps团队成员快速的自定义细节。我们可以使用它来发送基于一些脚本或任务或工作的结果的详细信息。例如，如果我们使用自动化来检查哪些SPN将在未来10天内到期。到目前为止，我们必须使用sendgrid或任何第三方邮件服务，在那里我们必须设置smtp服务器细节来发送甚至是简单的邮件。</p><h1 id="75ad" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">解决方案:</h1><p id="ce6d" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">我们可以使用这个简单的发送邮件代码，它使用Azure Devops未发布的<strong class="je hi"> SendMail </strong> RestApi向指定的人发送电子邮件，而无需设置任何smtp服务器或第三方工具。所有电子邮件将被视为来自azuredevops@microsoft.com&gt;T5<strong class="je hi">蔚蓝海岸&lt;的邮件</strong></p><p id="7f7e" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">我们只能向Azure DevOps项目中的团队成员发送电子邮件。发送邮件的Azure Rest API只使用tfsid来发送邮件，因此我们需要获得与收件人的电子邮件相对应的所有tfsid。</p><p id="ca64" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">先决条件:</strong></p><p id="6735" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">由于Rest Api调用是在任务中进行的，所以我们必须在代理作业设置中为<strong class="je hi">启用一个复选框，以允许脚本访问OAuth令牌</strong>，如下图所示。</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kf"><img src="../Images/71c5fc30982b635d63952180715f5cac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ESgLS84zuOkUxp42"/></div></div></figure><h1 id="5248" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">该脚本实现了以下目标:</h1><p id="02d8" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated"><strong class="je hi">第一步:</strong>使用Rest api调用，我们获得devops项目中所有团队的信息，然后从每个团队获得项目中所有成员的详细信息。</p><p id="7a7a" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">第二步:</strong>现在，我们从成员信息中获取他们的电子邮件id和相关的TFSIDs。从主信息中，我们过滤与预期接收者的电子邮件相关联的TFSids列表。</p><p id="3da3" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">第三步:</strong>用给定的主题和自定义的邮件正文形成邮件请求对象后发送邮件。</p><p id="ea1d" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">所有三个步骤的实现细节都在下面的代码中。</p><h1 id="05c1" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">详细的代码片段</h1><p id="65a1" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi">################# ##################</p><pre class="kg kh ki kj fd kr ks kt ku aw kv bi"><span id="0ec8" class="kw if hh ks b fi kx ky l kz la">## Only following 5 variables are required to send mail</span><span id="e947" class="kw if hh ks b fi lb ky l kz la">$myorg = “my-ado-org”</span><span id="c5b7" class="kw if hh ks b fi lb ky l kz la">$myproj = “my-ado-project”</span><span id="4f15" class="kw if hh ks b fi lb ky l kz la">$sendmailto = “devops.user1@xyz.com,devops.user2@xyz.com” ## comma separated email ids of receivers</span><span id="b0f5" class="kw if hh ks b fi lb ky l kz la">$mysubject = “my custom subject of the mail” ## Subject of the email</span><span id="13c1" class="kw if hh ks b fi lb ky l kz la">$mailbody = “my custom mail body details” ## mail body</span><span id="6ec8" class="kw if hh ks b fi lb ky l kz la">#########################</span><span id="79a2" class="kw if hh ks b fi lb ky l kz la">## Get tfsids of users whom to send mail</span><span id="4043" class="kw if hh ks b fi lb ky l kz la">$mailusers = “$sendmailto”</span><span id="840d" class="kw if hh ks b fi lb ky l kz la">$mymailusers = $mailusers -split “,”</span><span id="42a2" class="kw if hh ks b fi lb ky l kz la">$pat = “Bearer $env:System_AccessToken”</span><span id="5abd" class="kw if hh ks b fi lb ky l kz la">$myurl =”https://dev.azure.com/${myorg}/_apis/projects/${myproj}/teams?api-version=5.1"</span><span id="7456" class="kw if hh ks b fi lb ky l kz la">$data = Invoke-RestMethod -Uri “$myurl” -Headers @{Authorization = $pat}</span><span id="3a29" class="kw if hh ks b fi lb ky l kz la">$myteams = $data.value.id</span><span id="70a1" class="kw if hh ks b fi lb ky l kz la">##Get list of members in all teams</span><span id="bfed" class="kw if hh ks b fi lb ky l kz la">$myusersarray = @()</span><span id="cbec" class="kw if hh ks b fi lb ky l kz la">foreach($myteam in $myteams) {</span><span id="3ad4" class="kw if hh ks b fi lb ky l kz la">$usrurl = “https://dev.azure.com/${myorg}/_apis/projects/${myproj}/teams/"+$myteam+"/members?api-version=5.1"</span><span id="ecc1" class="kw if hh ks b fi lb ky l kz la">$userdata = Invoke-RestMethod -Uri “$usrurl” -Headers @{Authorization = $pat}</span><span id="b06c" class="kw if hh ks b fi lb ky l kz la">$myusers = $userdata.value</span><span id="7811" class="kw if hh ks b fi lb ky l kz la">foreach($myuser in $myusers) {</span><span id="d84a" class="kw if hh ks b fi lb ky l kz la">$myuserid = $myuser.identity.id</span><span id="66fa" class="kw if hh ks b fi lb ky l kz la">$myusermail = $myuser.identity.uniqueName</span><span id="14b6" class="kw if hh ks b fi lb ky l kz la">$myuserrecord = “$myuserid”+”:”+”$myusermail”</span><span id="7611" class="kw if hh ks b fi lb ky l kz la">$myusersarray += $myuserrecord</span><span id="3eb1" class="kw if hh ks b fi lb ky l kz la">}</span><span id="865c" class="kw if hh ks b fi lb ky l kz la">}</span><span id="b53c" class="kw if hh ks b fi lb ky l kz la">## filter unique users</span><span id="43af" class="kw if hh ks b fi lb ky l kz la">$myfinalusersaray = $myusersarray | sort -Unique</span><span id="b5ad" class="kw if hh ks b fi lb ky l kz la">## create final hash of emails and tfsids</span><span id="2137" class="kw if hh ks b fi lb ky l kz la">$myusershash = @{}</span><span id="fa0a" class="kw if hh ks b fi lb ky l kz la">for ($i = 0; $i -lt $myfinalusersaray.count; $i++)</span><span id="3386" class="kw if hh ks b fi lb ky l kz la">{</span><span id="13b6" class="kw if hh ks b fi lb ky l kz la">$myusershash[$myfinalusersaray[$i].split(“:”)[1]] = $myfinalusersaray[$i].split(“:”)[0]</span><span id="210c" class="kw if hh ks b fi lb ky l kz la">}</span><span id="047c" class="kw if hh ks b fi lb ky l kz la">##</span><span id="45c0" class="kw if hh ks b fi lb ky l kz la">## create list of tfsid of mailers</span><span id="be6d" class="kw if hh ks b fi lb ky l kz la">foreach($mymail in $mymailusers) {</span><span id="69bd" class="kw if hh ks b fi lb ky l kz la">$myto = $myto +’”’+$myusershash[$mymail]+’”,’</span><span id="7ef9" class="kw if hh ks b fi lb ky l kz la">}</span><span id="7f95" class="kw if hh ks b fi lb ky l kz la">##send mail</span><span id="6877" class="kw if hh ks b fi lb ky l kz la">$uri = “https://${myorg}.vsrm.visualstudio.com/${myproj}/_apis/Release/sendmail/$(RELEASE.RELEASEID)?api-version=3.2-preview.1"</span><span id="a9c4" class="kw if hh ks b fi lb ky l kz la">$requestBody =</span><span id="6dc7" class="kw if hh ks b fi lb ky l kz la">@”</span><span id="3271" class="kw if hh ks b fi lb ky l kz la">{</span><span id="3eff" class="kw if hh ks b fi lb ky l kz la">“senderType”:1,</span><span id="5536" class="kw if hh ks b fi lb ky l kz la">“to”:{“tfsIds”:[$myto]},</span><span id="d23f" class="kw if hh ks b fi lb ky l kz la">“body”:”${mailbody}”,</span><span id="e108" class="kw if hh ks b fi lb ky l kz la">“subject”:”${mysubject}”</span><span id="cde9" class="kw if hh ks b fi lb ky l kz la">}</span><span id="4a99" class="kw if hh ks b fi lb ky l kz la">“@</span><span id="f0ed" class="kw if hh ks b fi lb ky l kz la">Try {</span><span id="8765" class="kw if hh ks b fi lb ky l kz la">Invoke-RestMethod -Uri $uri -Body $requestBody -Method POST -Headers @{Authorization = $pat} -ContentType “application/json”</span><span id="4435" class="kw if hh ks b fi lb ky l kz la">}</span><span id="02e2" class="kw if hh ks b fi lb ky l kz la">Catch {</span><span id="11dd" class="kw if hh ks b fi lb ky l kz la">$_.Exception</span><span id="6a8f" class="kw if hh ks b fi lb ky l kz la">}</span></pre><h1 id="e5b9" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">怎么跑</h1><p id="01c0" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在常规任务之后创建PowerShell任务(例如sendmail)。在这个PowerShell任务中使用上面的代码。根据您的项目和邮件列表，更新上面代码片段中提到的前五个变量。当管道运行时，它将执行并向<strong class="je hi"> sendmailto </strong>变量中提到的所有电子邮件id发送邮件。下面给出了屏幕截图。</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es lc"><img src="../Images/b7dbffe82a29c2f7804da745df9217c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kTAVRAvIh9-e3r0f"/></div></div></figure><h1 id="dee6" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">局限性:</h1><p id="30d1" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">虽然我们可以使用上面的脚本方法发送简单的电子邮件，但它仅限于发送简单的电子邮件，因为我们无法格式化我们的邮件，它们就像简单的文本邮件一样。第二，我们只能向azure devops项目的成员发送邮件，因为sendmail功能将电子邮件id与项目的tfsid进行映射，外部人员没有相应的tfsid，因此邮件不会发送给他们。我们使用未发布的sendmail rest api，因此它总是存在将来被淘汰或废弃的风险。</p><h1 id="884f" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">结论:</h1><p id="ad42" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">当我们想要激活快速电子邮件通知时，当组织邮箱不允许接受来自未授权邮箱的邮件，并且不允许在DevOps项目中使用第三方smtp服务器时，这个简单的电子邮件脚本会产生奇迹。</p></div></div>    
</body>
</html>