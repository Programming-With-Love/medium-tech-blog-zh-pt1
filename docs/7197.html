<html>
<head>
<title>Moshi, another JSON Processor</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Moshi，另一个JSON处理器</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/moshi-another-json-processor-624f8741f703?source=collection_archive---------0-----------------------#2017-03-27">https://medium.com/square-corner-blog/moshi-another-json-processor-624f8741f703?source=collection_archive---------0-----------------------#2017-03-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><blockquote class="ie"><p id="8348" class="if ig hh bd ih ii ij ik il im in io dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae ip" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><p id="86f8" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm io ha bi translated">程序员很少会两次处理同一个问题。要么第一个足够好，你就完成了，要么第一个不够好，你愚蠢地再次尝试。环境和傲慢给了我两次尝试的机会。</p><h1 id="f6fe" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">Guice，一个依赖注入器</h1><p id="ec44" class="pw-post-body-paragraph iq ir hh is b it kl iv iw ix km iz ja jb kn jd je jf ko jh ji jj kp jl jm io ha bi translated">当我2012年开始在Square工作时，Android团队正在使用<a class="ae ip" href="https://github.com/google/guice" rel="noopener ugc nofollow" target="_blank"> Google Guice </a>进行依赖注入。我为Guice做了贡献，所以在新工作中使用熟悉的代码感觉很好。但是有一个问题:Guice对于移动设备来说太慢了。即使是最新的姜饼设备也不够快。</p><h1 id="a8e4" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">Dagger，另一个依赖注入器</h1><p id="8059" class="pw-post-body-paragraph iq ir hh is b it kl iv iw ix km iz ja jb kn jd je jf ko jh ji jj kp jl jm io ha bi translated">我建议通过从基于反射的Guice切换到我们创建的新的基于codegen的依赖注入器来解决这个问题。我开始了将成为<a class="ae ip" href="https://github.com/google/dagger" rel="noopener ugc nofollow" target="_blank">匕首</a>的原型。第二次构建东西要容易得多！我知道哪些功能是重要的，哪些可以省略。Dagger 1.0借用了Guice的核心特性，让它们变得更加简单快捷。</p><p id="1544" class="pw-post-body-paragraph iq ir hh is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm io ha bi translated">谷歌后来接管了Dagger的开发。他们扩展了它的API，提高了它的性能。</p><h1 id="0476" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">JSON处理器Gson</h1><p id="4c2d" class="pw-post-body-paragraph iq ir hh is b it kl iv iw ix km iz ja jb kn jd je jf ko jh ji jj kp jl jm io ha bi translated">我还参与了Google Gson T8，Square用它来进行JSON编码和数据绑定。和Guice一样，使用我曾经工作过并引以为豪的东西也不错。Gson快速、安全且易于上手。它有一个灵活的数据绑定模型，可以扩展到复杂的用例。</p><p id="3a76" class="pw-post-body-paragraph iq ir hh is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm io ha bi translated">但是我用Gson越多，一些老错误就越让我恼火。例如，Gson的默认日期格式被破坏:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="87b7" class="le jo hh la b fi lf lg l lh li">Date epoch = new Date(0);<br/>String epochJson = new Gson().toJson(epoch);<br/>// "Dec 31, 1969 7:00:00 PM"</span></pre><p id="e49b" class="pw-post-body-paragraph iq ir hh is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm io ha bi translated">编码的日期没有时区，因此当编码器和解码器不共享时区时，数据会损坏。这个bug令人沮丧的部分是，修复它也很危险:我们不知道什么应用程序期待当前的格式，我们也不知道如果我们改变它，什么会被破坏。(Gson将<em class="lj">默认读取</em> <a class="ae ip" href="https://www.ietf.org/rfc/rfc3339.txt" rel="noopener ugc nofollow" target="_blank"> RFC 3339 </a>类似<code class="du lk ll lm la b">1970–01–01T00:00:00Z</code>的日期)。</p><p id="17e1" class="pw-post-body-paragraph iq ir hh is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm io ha bi translated">另一个问题是图书馆如何应对不良输入。当你使用<code class="du lk ll lm la b">Gson.fromJson()</code>将一个字符串转换成JSON时，它总是宽松的。它认为<code class="du lk ll lm la b">{a=TRUE}</code>等同于<code class="du lk ll lm la b">{"a":true}</code>。对于无效输入，如空字符串和null，它通常也会返回。这隐藏了错误，但修复它可能会破坏现有的应用程序。</p><h1 id="e544" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">介绍Moshi</h1><p id="b248" class="pw-post-body-paragraph iq ir hh is b it kl iv iw ix km iz ja jb kn jd je jf ko jh ji jj kp jl jm io ha bi translated">18个月前<a class="ae ip" href="https://github.com/jakewharton/" rel="noopener ugc nofollow" target="_blank">杰克</a>、<a class="ae ip" href="https://github.com/dragonsinth" rel="noopener ugc nofollow" target="_blank">斯科特</a>和我创建了<a class="ae ip" href="https://github.com/square/moshi" rel="noopener ugc nofollow" target="_blank">魔石</a>，试图借用Gson的一些核心理念，让它们变得更简单、更快捷。我们想要一个小巧、高效、默认安全的库。</p><p id="2bc9" class="pw-post-body-paragraph iq ir hh is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm io ha bi translated">Moshi试图在编码时防止错误，并可以在解码时检测错误。例如，如果您将一个<code class="du lk ll lm la b">java.util.UUID</code>字段添加到您的一个模型对象中，Moshi将会报错，除非您为该类型显式注册一个适配器。这样，您就不会无意中将JDK实现的细节泄露到您的JSON数据中。</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="aea2" class="le jo hh la b fi lf lg l lh li">IllegalArgumentException: Platform class java.util.UUID requires explicit JsonAdapter to be registered<br/>  at com.squareup.moshi.ClassJsonAdapter$1.create()<br/>  at com.squareup.moshi.Moshi.adapter()</span></pre><p id="bb71" class="pw-post-body-paragraph iq ir hh is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm io ha bi translated">类似地，Moshi有一个严格的模式，在未使用的字段上失败。对于集成测试来说，这是一个很好的选择！</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="f8e5" class="le jo hh la b fi lf lg l lh li">JsonDataException: Cannot skip unexpected STRING at $.fullNane<br/>  at com.squareup.moshi.JsonUtf8Reader.skipValue()<br/>  at com.squareup.moshi.ClassJsonAdapter.fromJson()<br/>  at com.squareup.moshi.JsonAdapter.fromJson()</span></pre><p id="77f7" class="pw-post-body-paragraph iq ir hh is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm io ha bi translated">我们一直在悄悄地完善Moshi的功能集，提高它的性能。在最近的1.4版本中，我们增加了对JSON值的支持，可以将对象转换成字节流或内存模型。</p><p id="a012" class="pw-post-body-paragraph iq ir hh is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm io ha bi translated">如果你正在构建一个新的应用并且需要JSON，请考虑<a class="ae ip" href="https://github.com/square/moshi" rel="noopener ugc nofollow" target="_blank"> Moshi </a>。准备好了。</p></div></div>    
</body>
</html>