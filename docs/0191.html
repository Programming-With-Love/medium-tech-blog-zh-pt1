<html>
<head>
<title>Meet Ottr: A Serverless Public Key Infrastructure Framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">认识Ottr:一个无服务器的公钥基础设施框架</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/meet-ottr-a-serverless-public-key-infrastructure-framework-f6580010ae0c?source=collection_archive---------1-----------------------#2021-10-26">https://medium.com/airbnb-engineering/meet-ottr-a-serverless-public-key-infrastructure-framework-f6580010ae0c?source=collection_archive---------1-----------------------#2021-10-26</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="057d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Ottr是一个无服务器的公钥基础设施框架，它无需使用代理就能处理端到端的证书轮换。该博客的目的是通过示例参考架构、逻辑和网络流程概述Ottr，并强调该解决方案的优势。有关安装说明，请跳到本文的开源部分。</p><p id="cbcf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae jd" href="https://www.linkedin.com/in/kenneyan/" rel="noopener ugc nofollow" target="_blank">杨纲凯</a></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/3960dcb51f34d141f98a761ce6217586.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6C4m508jFNo-FtFNIK1acw.png"/></div></div></figure><h1 id="966a" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">介绍</h1><p id="d93c" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">管理公钥基础设施(PKI)的证书对于任何组织来说都是一个难以大规模解决的问题。虽然有许多基于<a class="ae jd" href="https://letsencrypt.org/how-it-works/" rel="noopener ugc nofollow" target="_blank">代理的解决方案</a>来自动执行Linux和Windows发行版的证书轮换，但代理网络基础设施证书的过程通常涉及工程团队的手动干预或使用注册协议，如证书管理协议(CMP)、简单证书注册协议(SCEP)或安全传输注册(EST)，这些都存在安全问题。</p><p id="b633" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们在Airbnb建立了Ottr，使其成为AWS上可扩展和可配置的无服务器框架，几乎没有运营开销，也不依赖于注册协议。Ottr可以扩展为处理任何能够从远程会话(例如API、SSH、SSM代理)管理自己的X.509证书的主机(例如网络基础设施、Linux、Windows)的端到端证书轮换。</p><h2 id="804d" class="kt jr hh bd js ku kv kw jw kx ky kz ka ip la lb ke it lc ld ki ix le lf km lg bi translated">背景</h2><p id="6f89" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">PKI管理数字证书的颁发，以保护敏感数据，提供唯一的数字身份，并确保安全的端到端通信。证书颁发机构(CA)负责代理这些X.509证书，并拥有审查接收者和颁发过程的策略、实践和程序。用于生成数字证书的CA可以来自您的组织管理的私有CA，也可以来自公共CA，例如由<a class="ae jd" href="https://www.abetterinternet.org/" rel="noopener ugc nofollow" target="_blank">互联网安全研究小组(ISRG) </a>管理的<a class="ae jd" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> Let's Encrypt </a>。</p><p id="db71" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Airbnb，工程师负责确保计算节点以及防火墙、负载平衡器和其他网络设备的端到端加密到位。下图说明了重新颁发证书的典型过程。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lh"><img src="../Images/22ca41a64ce2eabda0135c4d60ad634f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_wSqMv2Z_AWmThkHg0a5uQ.png"/></div></div></figure><p id="f312" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正如您所看到的，这是一个需要大量手动操作的流程，需要一个批准步骤，这会给多个团队带来运营开销。详细情况如下:</p><ol class=""><li id="e620" class="li lj hh ig b ih ii il im ip lk it ll ix lm jb ln lo lp lq bi translated"><strong class="ig hi">生成私钥和证书签名请求(CSR):</strong>CSR是一个加密签名的请求，包含有关组织详细信息以及证书有效的通用名称(CN)和主题备用名称(San)的信息。CSR通常使用OpenSSL生成，其中私钥在目标设备上创建(并且永远不会离开主机),相关的公钥嵌入在CSR中。</li><li id="e6df" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb ln lo lp lq bi translated"><strong class="ig hi">向证书颁发机构(CA)发送CSR:</strong>为了让CA签署CSR，必须验证域。这可以通过许多不同的方式来完成(例如，HTTP-01、DNS-01挑战)。该CA可以是您的组织控制其信任链的私有CA，也可以是公共CA，如Let's Encrypt，它的<a class="ae jd" href="https://letsencrypt.org/certificates/" rel="noopener ugc nofollow" target="_blank">信任链</a>在您的控制之外。</li><li id="76d3" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb ln lo lp lq bi translated"><strong class="ig hi">批准CSR: </strong>由于证书申请流程的敏感性，通常需要安全团队的<strong class="ig hi"> </strong>批准，以允许CA为提交的CSR生成证书。</li><li id="221f" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb ln lo lp lq bi translated"><strong class="ig hi">下载证书:</strong>批准后，证书、中间证书、根证书或完整链将可从您的CA获得，并可以base64格式下载(例如，pem，。cer，. p7b)。</li><li id="400f" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb ln lo lp lq bi translated"><strong class="ig hi">上传证书:</strong>根据平台的不同，完整的证书链将以支持的格式上传到目标设备(例如。pem)并在适用的情况下重新启动。</li></ol><h1 id="36ea" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">为什么是Ottr？</h1><p id="3b38" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">当我们最初设计Ottr的时候，Airbnb需要一个框架来管理X.509证书，供那些无法运行代理来管理其X.509证书的主机使用；我们需要一个可定制、可扩展的解决方案，同时仍然强调安全性。下图说明了如何使用Ottr重新颁发证书。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lw"><img src="../Images/f95f66836dd19a206dcd8b0e0d566015.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*21rKmxuIKBD3bSF0BUN1-g.png"/></div></div></figure><p id="6173" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这种新框架有许多优点:</p><ul class=""><li id="7f3b" class="li lj hh ig b ih ii il im ip lk it ll ix lm jb lx lo lp lq bi translated"><strong class="ig hi">无服务器:</strong>无需管理底层基础设施，这意味着我们无需修补或加固新服务器。</li><li id="cf1d" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi">有限的依赖关系:</strong>唯一主要的依赖关系是ACME客户端(acme.sh)，它得到了很好的维护。</li><li id="1b46" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi">可定制:</strong> Ottr在设计上是模块化的，这意味着当基础设施中引入额外的平台时，它为开发人员提供了构建定制集成的能力。开发人员可以在Let's Encrypt之外使用证书颁发机构，只要它们支持ACME协议。</li><li id="ff71" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi">可扩展:</strong>每天执行数千个证书轮换的能力(基于CA设置的速率限制)。</li><li id="90de" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi">安全性:</strong>基础设施安全性是默认的；构建Ottr的Terraform模块具有强化的配置，并遵循最小特权原则。</li><li id="436f" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi">自动化:</strong> Ottr处理端到端证书轮换生命周期，无需任何人工干预。</li><li id="b307" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi">可移植性:</strong> Ottr通过Terraform构建了100多个资源，这些资源可以通过模块轻松配置，并且可以跨任何AWS环境部署。</li><li id="a55a" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi">成本:</strong> Ottr可以与运行ACME的私有或公共CA(例如，让我们加密)一起使用，不需要额外的成本。</li><li id="e615" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi">错误处理:</strong>通过Slack提供运行时任何潜在错误的即时反馈。</li><li id="9569" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi">开源:</strong>任何人都可以做出贡献，随着框架的成熟，可以引入新的平台支持。</li></ul><h1 id="97c4" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">进入引擎盖下</h1><p id="c164" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated"><em class="jc">在本节中，我们将深入探讨构成Ottr的不同组件，并解释它们如何连接在一起，以便从最终用户那里抽象出PKI的复杂性。</em></p><h2 id="229d" class="kt jr hh bd js ku kv kw jw kx ky kz ka ip la lb ke it lc ld ki ix le lf km lg bi translated">高级图表</h2><p id="769b" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated"><em class="jc"> Ottr架构</em></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ly"><img src="../Images/b944c915603a09406a963c95911446e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yUXlXD6mzsLGmMEgAGeIhQ.png"/></div></div></figure><p id="5688" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们来看看Ottr的架构，以及每个组件如何与整体流程相关联地工作:</p><ul class=""><li id="0cd2" class="li lj hh ig b ih ii il im ip lk it ll ix lm jb lx lo lp lq bi translated"><strong class="ig hi"> CloudWatch事件:<em class="jc"> </em> </strong>以可配置的时间间隔(例如，每天一次)触发Lambda路由器的自动入口点。</li><li id="0c0e" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi"> Ottr API: </strong>可用于执行一次性证书轮换的替代入口点。</li><li id="6856" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi"> Lambda同步器:</strong>聚集来自数据中心和/或AWS的主机元数据，用于通过Ottr API更新DynamoDB数据库。</li><li id="eb6e" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi"> Lambda路由器:</strong>扫描DynamoDB数据库，确定哪些主机有资格进行证书轮换，并将数据转发给Step函数。</li><li id="aaed" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi">步骤功能:</strong>并行处理来自路由器Lambda或API的一批设备数据，并为作为证书轮换目标的每个主机执行ECS容器。</li><li id="635a" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi"> ECS容器:</strong>根据从Step函数中检索的ECS任务定义元数据元素，从弹性容器注册表(ECR)中提取特定于平台的映像。</li><li id="0402" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated"><strong class="ig hi"> Lambda处理程序:</strong>在发生容器运行时错误的情况下，有一个与Slack的外部集成，它将提供设备详细信息和指向CloudWatch日志中条目的链接。</li></ul><p id="9ad2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">容器运行时:</strong></p><ul class=""><li id="74a7" class="li lj hh ig b ih ii il im ip lk it ll ix lm jb lx lo lp lq bi translated">建立与设备的连接，以在设备上生成公钥/私钥对和CSR将CSR拖到容器文件系统上。</li><li id="318f" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated">ACME客户端将组织的ACME凭证绑定到容器上，并将CSR发送到CA(例如，让我们加密)以开始证书签名流程。</li><li id="42bb" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated">ACME客户端将来自CSR的每个公用名(CN)和主题备用名(SAN)的DNS TXT记录写入Route53中的DNS子委派区域。</li><li id="874d" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated">CA通过DNS-01质询验证域所有权；经过验证后，会生成一个证书，ACME客户端会将完整的证书链写入容器文件系统。</li><li id="d995" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated">根据平台逻辑，证书将应用于设备，并执行大量验证检查。</li><li id="ec2a" class="li lj hh ig b ih lr il ls ip lt it lu ix lv jb lx lo lp lq bi translated">成功后，DynamoDB数据库中的设备的新证书到期日期会更新。</li></ul><h2 id="fb1b" class="kt jr hh bd js ku kv kw jw kx ky kz ka ip la lb ke it lc ld ki ix le lf km lg bi translated">数据库ˌ资料库</h2><p id="ab3c" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">该API不仅是Ottr的备选入口点，也是管理DynamoDB数据库中资产的首选端点。数据库中的元素提供设备详细信息，用于确定证书何时到期，以及用于将主机映射到运行时逻辑的平台特定ECS任务定义的元数据。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lz"><img src="../Images/3cd329e32f2c9e1db24fe2cf4161f883.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n-dEsmMrkZBTg6YrK4JwQA.png"/></div></div></figure><p id="66e2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc">数据库资产输出示例</em></p><pre class="jf jg jh ji fd ma mb mc md aw me bi"><span id="fc63" class="kt jr hh mb b fi mf mg l mh mi">{<br/>   "system_name": "test.example.com",<br/>   "common_name": "test.example.com",<br/>   "certificate_authority": "lets_encrypt",<br/>   "certificate_expiration": "2021-01-01T00:00:00",<br/>   "certificate_validation": "True",<br/>   "data_center": "DC1",<br/>   "device_model": "PA-XXXX",<br/>   "host_platform": "panos",<br/>   "ip_address": "10.0.0.1",<br/>   "origin": "API",<br/>   "os_version": "9.x.x",<br/>   "subject_alternative_name": [<br/>   "subdomain.example.com"<br/>   ]<br/>}</span></pre><h2 id="578a" class="kt jr hh bd js ku kv kw jw kx ky kz ka ip la lb ke it lc ld ki ix le lf km lg bi translated">任务路由</h2><p id="f739" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">在路由过程中，首先扫描数据库，以建立证书在30天内到期的设备列表。根据主机在DNS子委派区域内是否有有效的Route53记录，该列表的范围会进一步缩小。如果这两种情况都成立，则逻辑会根据设置的路由配置将每个主机映射到相应的ECS任务定义。</p><p id="aad6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">按照下面的路由配置示例，如果有一个型号为PA-XXXX的PAN-OS设备运行9.x.x，并且证书颁发机构设置为Let's Encrypt，则会返回一个<em class="jc">otter-panos-9x-lets-Encrypt</em>的ECS任务。通过使用这种路由逻辑，最终用户可以在一个平台上执行不同类型的设备轮换逻辑。</p><p id="70ea" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc">路由配置示例</em></p><pre class="jf jg jh ji fd ma mb mc md aw me bi"><span id="562b" class="kt jr hh mb b fi mf mg l mh mi">{<br/> "note": {<br/>   "description": "Routes to trigger certificate renewal or generation based on Platform, OS Version, and Certificate Authority."<br/> },<br/> "platform": {<br/>   "panos": {<br/>     "os": {<br/>       "9.x.x": {<br/>         "certificate_authority": {<br/>           "lets_encrypt": "otter-panos-9x-lets-encrypt" # ECS Task Definition<br/>         },<br/>         "model": [<br/>           "PA-XXXX",<br/>           "PA-YYYY",<br/>         ]<br/>       },<br/>   ...</span></pre><p id="92c1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc"> </em>路由器根据路由配置建立主机和任务定义之间的映射后，有效负载被发送到Step函数并作为映射进行处理，该映射用于为每个元素运行一组步骤。Step函数启动ECS Fargate容器，该容器提取ECS任务定义中定义的ECR映像。该过程与子网内可用的弹性网络接口(ENI)的最大并发数并行执行。如果需要运行的容器多于Eni的可用数量，Step函数会将作业排队，直到前面的执行完成并且网络接口可用。</p><p id="8bb1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">查看下面的步骤函数输入，它显示<em class="jc">test.example.com</em>的ECS任务定义为<em class="jc">otter-panos-9x-lets-encrypt</em>，而<em class="jc">test.airbnb.com</em>的ECS任务定义为<em class="jc">otter-Linux-AWS-SSM-lets-encrypt。</em>虽然平台和域都不同，但Ottr可以彼此独立地并行执行这两种循环，因为每个主机都有一个专用的容器。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mj"><img src="../Images/f5d3a7cb710c8749a46c113f075639e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HXAuO66-776Hr6h6fr0o7g.png"/></div></div></figure><h2 id="83f3" class="kt jr hh bd js ku kv kw jw kx ky kz ka ip la lb ke it lc ld ki ix le lf km lg bi translated">DNS子委派</h2><p id="1834" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">该服务的核心安全设计决策之一是限制对Route53 (DNS)的访问。Ottr使用DNS-01质询执行域验证，这意味着ACME客户端需要将DNS TXT记录写入_acme-challenge。[FQDN]为了让证书颁发机构验证域的所有权。出于安全考虑，我们不想提供允许跨组织的主要托管区域写入权限的访问。虽然Ottr可能只需要将TXT记录写入_ acme-challenge . test . example . com的能力，但在撰写本文时，AWS不提供仅指定对TXT记录的写入权限所必需的粒度，这意味着Ottr将被授予将任何记录类型(包括A、CNAME、PTR和MX记录)写入您组织的域的权限。</p><p id="2caf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了限制访问，我们向ACME客户端引入了DNS子授权。当Ottr的基础设施建立后，将会有一个新的Route53托管区域，它是根据配置创建的，例如<em class="jc">example-acme.com</em>。当ACME客户端向认证机构(CA)发送证书签名请求(CSR)时，CA随后将在挑战别名字段中查找TXT记录，该字段将是<em class="jc">example-acme.com</em>。</p><p id="f040" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这意味着，在域验证过程开始之前，需要配置DNS以在您的主机<em class="jc">test.example.com</em>之间建立CNAME映射，从而将记录转发到<em class="jc">example-acme.com</em>。</p><p id="e769" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc"> Terraform DNS模块</em></p><pre class="jf jg jh ji fd ma mb mc md aw me bi"><span id="4747" class="kt jr hh mb b fi mf mg l mh mi">module "dns_example" {<br/> source = "./modules/dns"</span><span id="a855" class="kt jr hh mb b fi mk mg l mh mi">certificate_common_name = "test.example.com"<br/> subject_alternative_names = ["subdomain.example.com",  "dev.example.com"]<br/>}</span></pre><p id="f1f5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc"> DNS CNAME记录映射</em></p><pre class="jf jg jh ji fd ma mb mc md aw me bi"><span id="9869" class="kt jr hh mb b fi mf mg l mh mi">_acme-challenge.test.example.com <br/>  =&gt;   _acme-challenge.test.example-acme.com<br/><br/>_acme-challenge.subdomain.example.com <br/>  =&gt;   _acme-challenge.test.example-acme.com</span><span id="58b9" class="kt jr hh mb b fi mk mg l mh mi">_acme-challenge.dev.example.com <br/>  =&gt;   _acme-challenge.test.example-acme.com</span></pre><p id="e723" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过添加这个映射，所有的TXT记录都在<em class="jc">example-acme.com</em>内被写入和读取。因此，Ottr内的权限可以限制为只读域，如<em class="jc">example.com</em>，而写权限将授予子授权区域<em class="jc">example-acme.com</em>。</p><h2 id="c3d7" class="kt jr hh bd js ku kv kw jw kx ky kz ka ip la lb ke it lc ld ki ix le lf km lg bi translated">外部集成</h2><p id="7a64" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">默认情况下，Ottr包含一个用于错误处理的Slack外部集成。每个ECS任务完成后，新的证书到期时间会添加到数据库中，等待成功运行。如果容器运行时出现错误，就会在Slack中生成一个通知，为运营团队提供即时反馈和一个链接，直接指向失败任务的CloudWatch日志。虽然Slack是默认的集成，但是如果您的组织喜欢使用其他平台或分类方法进行错误处理，也可以编写自定义逻辑。</p><h2 id="907f" class="kt jr hh bd js ku kv kw jw kx ky kz ka ip la lb ke it lc ld ki ix le lf km lg bi translated">网络体系结构</h2><p id="0838" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated"><em class="jc"> Ottr网络数据流</em></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ml"><img src="../Images/fe679e4408eaa8fac042dfae3424e5f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XMgiF7zl2A_2UWm5Z65Hsw.png"/></div></div></figure><p id="66a1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们看看AWS基础设施之外的路由的网络连接。在Step函数确定要在其上执行证书轮换的有效主机后，它将为每个设备并行执行一个容器。这些容器的启动取决于在使用Terraform构建基础架构时预定义的两个子网之一中的ENI可用性。在连接到设备并检索CSR之后，ACME客户端将CSR发送给证书颁发机构。默认情况下，这是让我们加密，但Ottr能够与任何支持ACME协议的CA集成。</p><p id="6f55" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在签名过程中，ACME客户端需要到证书颁发机构和Cloudflare DNS端点的路由。因为让我们加密是默认的CA，所以需要通过443 (SSL)访问生产端点<a class="ae jd" href="https://acme-v02.api.letsencrypt.org" rel="noopener ugc nofollow" target="_blank"><em class="jc">【acme-v02.api.letsencrypt.org】</em></a>以及中转端点<a class="ae jd" href="https://acme-staging-v02.api.letsencrypt.org" rel="noopener ugc nofollow" target="_blank"><em class="jc"/></a>。cloud flare DNS<a class="ae jd" href="https://cloudflare-dns.com" rel="noopener ugc nofollow" target="_blank"><em class="jc">cloudflare-dns.com</em></a>也用于使用HTTPS域名系统(DoH)轮询域名系统状态，以确定ACME客户端何时发布了用于域名验证的域名系统文本记录。通过使用DoH，DNS解析器通过TLS运行查询，这提高了安全性，因为DNS查询是加密的，而不是通过UDP上的DNS运行。与使用sleep在查询DNS以验证域之前等待一段时间相比，ACME客户端轮询DNS也提高了性能。</p><h1 id="2795" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">结果和投资回报</h1><p id="e5f5" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">通过在Airbnb内部部署Ottr，我们的组织实现了几个好处。我们已经看到了投资回报，因为节省了时间，也减少了工程团队的运营开销。自从年初引入Ottr以来，已经在没有任何人工干预的情况下执行了数千次证书轮换。这缓解了多个团队的一个棘手问题，包括负责监控过期证书票证并对其进行分类的运营团队、负责手动证书轮换流程的工程团队以及请求批准中涉及的安全团队。</p><p id="f78c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">另一个重要的回归与安全状况的改善有关。通过让Ottr充当CA和主机之间的代理，工程师将不再需要更改DNS记录来验证域所有权。这导致许多团队的AWS IAM权限减少，从而提高了最小特权。此外，Ottr提供了一个可重复的框架，在这个框架中，私钥在其生命周期内永远不会离开主机，而不是让工程师在本地生成一个私钥并将其上传到主机。</p><p id="ca6d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最重要的是，证书轮替比证书更新运行得更频繁，这意味着每次执行都要换出私钥；这会导致证书寿命缩短，在私钥泄露的情况下，会缩短数据被解密的时间。</p><h1 id="c0fa" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">结论</h1><p id="c052" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">尽管公钥基础设施在大规模解决时可能是一个复杂的问题，但Ottr的构建是为了抽象出与证书供应相关的许多挑战，同时还在运营和安全性方面提供了额外的好处。</p><p id="57bd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过开源Ottr，我们希望创建一个社区来共享、协作和扩展框架，以帮助满足其他组织的需求。如果你有兴趣帮助保护人员和数据，Airbnb Security正在招聘。查看我们的<a class="ae jd" href="https://www.airbnb.com/careers/departments/engineering" rel="noopener ugc nofollow" target="_blank">空缺职位</a>并立即申请！</p><h1 id="c06b" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">开放源码</h1><p id="521b" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated"><strong class="ig hi">设置<br/> </strong> Ottr现在在<a class="ae jd" href="https://github.com/airbnb/ottr" rel="noopener ugc nofollow" target="_blank"> Github </a>上开源。您可以转到设置资源页面开始构建基础架构，并通过支持的平台链接了解有关我们当前实施的更多信息。</p><p id="030b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">投稿<br/> </strong>如有任何建议，请随时联系或提交拉动请求。如果您目前正在利用Ottr并在目前不支持的平台上运行rotations，请查看<a class="ae jd" href="https://github.com/airbnb/ottr/tree/master/docs/CONTRIBUTE.md" rel="noopener ugc nofollow" target="_blank">投稿页面</a>并考虑帮助将您的实现添加到该平台！</p><p id="fc1f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">功劳和贡献:<br/> </strong>本·帕拉迪斯(Airbnb的安全工程师)<br/>亚伦·冯·亨根(高级安全项目经理)<br/>约翰·博罗梅奥(Airbnb的高级网络工程师)<br/>瑞安·迪尔斯(Airbnb的安全工程师)<br/>肖恩·科克伦(Airbnb的高级系统工程师)<br/>杰夫·南尼(Airbnb的网络架构师)<br/>马克·弗尔切克(Airbnb的安全工程师)<br/>齐山·哈迪姆(Airbnb的前经理)<br/>蒂娜</p><p id="bbb5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">支持acme.sh的开发社区</p><p id="b9ea" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc">所有产品名称、标识和品牌均为其各自所有者的财产。本网站中使用的所有公司、产品和服务名称仅用于识别目的。使用这些名称、标志和品牌并不意味着认可。</em></p><h1 id="e405" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">附录</h1><p id="e2f5" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">所有商标都是其注册所有者的财产；Airbnb声称对此不承担任何责任，也不享有任何所有权。</p></div></div>    
</body>
</html>