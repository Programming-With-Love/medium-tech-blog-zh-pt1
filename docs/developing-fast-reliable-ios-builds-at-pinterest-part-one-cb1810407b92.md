# 在 Pinterest 开发快速可靠的 iOS 版本

> 原文：<https://medium.com/pinterest-engineering/developing-fast-reliable-ios-builds-at-pinterest-part-one-cb1810407b92?source=collection_archive---------0----------------------->

作者 Rahul Malik | iOS 平台技术负责人

在 Pinterest，我们专注于帮助人们发现鼓舞人心的想法，从尝试晚餐食谱、购买家居和时尚产品，到旅行地点。打造最好的移动产品是其中的关键部分，80%的 Pinners 通过移动应用访问 Pinterest。特别是在 iOS 团队，我们一直在努力尽可能高效、快速地改善这种体验，给我们的团队最好的开发和测试环境是其中的关键一步。

我们最近研究了简化这一过程的方法，并着手提高我们在本地和持续集成环境中构建 iOS 的速度和可靠性。此外，我们开始将我们的应用程序模块化到独立的框架中，并且需要一个系统来支持这种迁移。我们回顾了多种工具，包括 Xcode、Cocoapods、Buck 和 Bazel。我们希望为未来引入一个更稳定的基础，这对我们快速迭代和向 Pinners 发布新功能的能力至关重要。

![](img/a708fd4bb63ebc457fff756b1b84b14c.png)

在比较了 Xcode、Cocoapods、Buck 和 Bazel 之后，我们发现 Bazel 最适合我们的目标，即构建一个基础，以大幅提高性能，消除构建环境中的可变性，并逐步采用。因此，我们现在使用 Bazel 发布我们所有的 iOS 版本，这已经取得了成功，包括:

**地方发展**

*   更快的构建:将干净的构建时间从 4m 38s 减少到 3m 38s，提高了 21%。
*   本地磁盘缓存允许即时重建您以前构建的任何东西(其他分支、提交等)。
*   CI 和本地环境之间的环境是相同的，因此构建问题很容易重现。
*   增强的自动化:像代码生成这样的任务被包含在构建图中。

**持续集成**

*   每个构建都是增量构建:由于 Bazel 是可重复的，我们已经一年多没有在 CI 上执行过一次干净的构建了。
*   构建一次，随处重用:引入远程构建缓存后，构建时间减少到不到一分钟，低至 30 秒，因为我们不需要在任何机器上重新构建任何已构建的东西
*   缩短登陆时间代码:将建造时间从 10 米 24 秒缩短到 7 米 34 秒，提高了 27%。
*   缩短了对测试版测试人员进行修改的时间:测试版构建时间从 14 米 32 秒减少到 7 米 52 秒，提高了 45%。
*   更快的测试执行:如果修改的代码不影响测试，测试运行是即时的。
*   更高的构建成功率:使用 Bazel 运行构建任务时，构建成功率从大约 80%提高到 97%-100%。

# 迈向快速可靠构建的未来

构建速度一直是开发人员的瓶颈，因为我们使用的是编译语言(Objective-C/C++)。但是构建速度很难量化。它包括不同环境中的构建，如持续集成或本地开发。我们还处理各种工作流场景，比如干净构建、增量构建、分支切换、重新构建、恢复变更等等。您不能改进您没有度量的东西，因此改进构建速度需要跟踪各种场景，以允许我们查明回归并集中我们的性能努力。

我们可以通过减少工作量或提高工作效率来加快构建速度。这可能涉及使用不同的工具、改进并行化，或者更新项目的架构以减少源文件的需求。围绕维护模块化架构和清理不被引用或与已完成的实验相关的死代码的强大实践将有助于维护/提高构建速度。我们使用各种内部工具和脚本来识别死代码。对于实验，我们利用添加 clang 注释的自动化来反对与实验相关的方法和常数，这允许编译器警告开发人员实验已经结束，应该删除代码。开发人员通过定期运行工具来识别未引用的代码，这些工具检查我们构建的头文件包含图，并寻找递归地没有引用的文件。

我们的构建过程需要既快速又可靠。如果构建是可重复的，那么它们就是可靠的。可重现的构建不仅对于重现 bug 很重要，对于确保我们发布的应用程序版本与我们开发和测试的版本完全一致也很重要。只有构建环境(输入和输出)一致，我们才能实现这一目标。

环境的变化会极大地影响最终产品并引入可变性。一致的环境保证了应用程序的行为是相同的，不管它是在开发人员的机器上构建的还是通过持续集成构建的，并且它消除了花费时间去弄清楚为什么一个构建在一个环境中成功而在另一个环境中失败。

虽然想法和探索都集中在 iOS 上，但快速和可重复构建的目标是我们所有人的共同目标，这将允许我们扩展客户端工程。

# 挑战

专注于改进我们的构建过程的决定根植于它对开发人员生产力的影响。随着我们团队和产品的成长，我们投资开发人员使用一致和快速构建系统的能力是至关重要的。

*   规模:当我们扩展客户端工程时，花费在支持开发人员、维护或减少构建时间以及提高可靠性上的时间也会随之扩展。支持开发人员的工程师数量不一定与开发人员的数量成比例，Xcode 不包含在性能下降时分析构建的工具。
*   模块化架构:我们已经开始从我们的应用程序重构组成我们平台的核心框架，以改善我们的整体架构、文档和质量。这增加了复杂性，因为它要求构建系统能够管理需要以特定顺序配置和编译的构建目标的依赖图。虽然在 Xcode 中并非不可能，但由于缺乏表达性的配置 API，随着时间的推移，这种图形的配置和维护将非常困难。
*   构建不稳定:在我们的代码库之外，有许多用不同语言编写的工具(Ruby、Python、Bash 等)。)需要特定的版本和工具链，这些版本和工具链必须相同才能创建一致的版本。这些变化会导致难以可靠重现的错误。对于开发人员来说，构建在本地通过，但在持续集成上失败是很常见的，反之亦然。只有某些机器具备创建发布候选的必要条件。本地状态可能会损坏，这需要执行干净的构建。那浪费时间。
*   任务自动化和代码生成:我们依靠代码生成来创建不可变的模型(通过 Plank)和日志基础设施(通过 Thrift)。虽然 Xcode 支持运行脚本阶段，但它不能将代码生成或一般任务自动化等动态工作流引入到构建过程中，而是需要手动集成生成的源代码，这增加了开发人员和入职教育的工作量。这还需要将生成的工件添加到版本控制中，这增加了我们的存储库大小和 git 克隆性能。
*   共享资源:外部存储库的集成路径并不清晰，并且在历史上导致了周期性地从其他存储库中复制资源。我们已经探索了像 git 子树或 git 子模块这样的选项，但是这需要增加对员工教育的投资和对开发人员工作流程的改变。这造成了混乱，也浪费了时间。Xcode 不支持声明外部构建依赖，所以我们必须依赖外部工具来提供这种集成。

# 解决方法

我们希望解决方案能够让我们通过工具和自动化来克服这些挑战，而不是增加开发人员教育和流程的负担，并且浪费更少的时间。我们主要针对以下方面进行优化:

*   快速迭代:我们的解决方案应该提供随着时间的推移极大地提高和维护构建速度和开发速度的功能，很可能通过更好的并行性和高级工具特性来实现。
*   沙盒开发:一个一致的环境，允许我们进行可靠的构建，并最小化可变性和对开发人员生产力的影响。
*   类似 Monorepo 的开发:所有的源代码仍然应该保留在一个存储库中。这最大限度地减少了跨应用程序进行更改所需的工作量和上下文切换。
*   概要分析、监控、分析:我们需要工具来洞察我们的构建系统以识别问题。我们的解决方案需要允许我们可视化整个构建过程中执行的操作以及它们各自的持续时间。假设我们有这个，我们将能够频繁地跟踪详细的变化。
*   增量编译:一旦我们构建了一次客户端，我们应该能够安全地通过所有的工作流进行增量编译。这应该包括切换分支、恢复更改或工作流的其他部分。干净构建是迄今为止最昂贵的构建，通常在本地状态损坏或开发人员试图诊断未知的构建问题时执行。

# 未来可扩展

随着我们的应用程序变得越来越复杂，我们的需求也在不断发展，我们必须确保我们的构建系统有足够的可扩展性，以允许变化的发展。但是它不能太具体，以免妨碍我们构建过程中的进一步动态自动化。这可能包括能够自动化任务以集成第三方静态分析、[定制工具链](/@Pinterest_Engineering/ios-linting-at-pinterest-3108d8764390)和[我们在 Pinterest 开发的内部工具](https://pinterest.github.io/plank/)。

改变一个构建系统是一个重大的改变，我们不能支持一个不可能增量引入的方法。一个全有或全无的解决方案可能需要暂停开发或维护一个长期的分支，并在开发人员环境和 CI 系统之间自动执行有风险的迁移。