<html>
<head>
<title>Oracle Load Balancer Classic configuration with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform的Oracle负载平衡器经典配置</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/oracle-load-balancer-classic-configuration-with-terraform-acc7dcf1a49a?source=collection_archive---------0-----------------------#2018-07-18">https://medium.com/oracledevs/oracle-load-balancer-classic-configuration-with-terraform-acc7dcf1a49a?source=collection_archive---------0-----------------------#2018-07-18</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="a454" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本文介绍了如何使用负载平衡器资源，通过Terraform提供和配置一个<strong class="ig hi">Oracle Cloud infra structure Load Balancer Classic</strong>实例</p><p id="4a53" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将负载平衡器经典资源与<code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/opc/" rel="noopener ugc nofollow" target="_blank">opc</a></code> Terraform提供程序一起使用时，必须在提供程序配置中设置<code class="du jc jd je jf b">lbaas_endpoint</code>属性。</p><pre class="jh ji jj jk fd jl jf jm jn aw jo bi"><span id="dbca" class="jp jq hh jf b fi jr js l jt ju">provider "opc" {<br/>  version         = "~&gt; 1.2"<br/>  user            = "${var.user}"<br/>  password        = "${var.password}"<br/>  identity_domain = "${var.compute_service_id}"<br/>  endpoint        = "${var.compute_endpoint}"<br/>  <strong class="jf hi">lbaas_endpoint  = "</strong><a class="ae jg" href="https://lbaas-148cba7050494081b95151c522617ba9.balancer.oraclecloud.com" rel="noopener ugc nofollow" target="_blank"><strong class="jf hi">https://lbaas-1111111.balancer.oraclecloud.com</strong></a><strong class="jf hi">"</strong><br/>}</span></pre><p id="1974" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先，我们创建主<strong class="ig hi">负载平衡器</strong>实例资源。服务器池、侦听器和策略资源将被创建为与此实例关联的子资源。</p><pre class="jh ji jj jk fd jl jf jm jn aw jo bi"><span id="2bc9" class="jp jq hh jf b fi jr js l jt ju">resource "<strong class="jf hi">opc_lbaas_load_balancer</strong>" "lb1" {<br/>  name        = "examplelb1"<br/>  region      = "uscom-central-1"<br/>  description = "My Example Load Balancer"<br/>  scheme      = "INTERNET_FACING"</span><span id="71c8" class="jp jq hh jf b fi jv js l jt ju">  permitted_methods = ["GET", "HEAD", "POST"]<br/>  ip_network        = "/Compute-${var.domain}/${var.user}/ipnet1"<br/>}</span></pre><p id="039f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了定义负载平衡器将流量导向的服务器集，我们创建了一个<strong class="ig hi">服务器池</strong>，有时也称为源服务器池。每台服务器都由目标IP地址或主机名和端口的组合来定义。为了这个例子的简洁，我们假设在一个现有的IP网络上已经有了几个实例，并且在端口<code class="du jc jd je jf b">8080</code>上运行了一个web服务。</p><pre class="jh ji jj jk fd jl jf jm jn aw jo bi"><span id="0b79" class="jp jq hh jf b fi jr js l jt ju">resource "<strong class="jf hi">opc_lbaas_server_pool</strong>" "serverpool1" {<br/>  load_balancer = "${opc_lbaas_load_balancer.lb1.id}"<br/>  name          = "serverpool1"</span><span id="9deb" class="jp jq hh jf b fi jv js l jt ju">  servers  = ["192.168.1.2:8080", "192.168.1.3:8080"]<br/>  vnic_set = "/Compute-${var.domain}/${var.user}/vnicset1"<br/>}</span></pre><p id="c9b3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">监听器</strong>资源定义了负载平衡器将把什么样的传入流量定向到特定的服务器池。可以为单个负载平衡器实例定义多个服务器池和侦听器。现在，我们假设所有的流量都是HTTP，包括负载平衡器和负载平衡器与服务器池之间的流量。我们稍后将研究如何保护与HTTPS的通信。在本例中，负载平衡器管理站点<code class="du jc jd je jf b">http://mywebapp.example.com</code>的入站请求，并将它们定向到我们上面定义的服务器池。</p><pre class="jh ji jj jk fd jl jf jm jn aw jo bi"><span id="035b" class="jp jq hh jf b fi jr js l jt ju">resource "<strong class="jf hi">opc_lbaas_listener</strong>" "listener1" {<br/>  load_balancer = "${opc_lbaas_load_balancer.lb1.id}"<br/>  name          = "http-listener"</span><span id="428f" class="jp jq hh jf b fi jv js l jt ju">  balancer_protocol = "HTTP"<br/>  port              = 80<br/>  virtual_hosts     = ["mywebapp.example.com"]</span><span id="34f0" class="jp jq hh jf b fi jv js l jt ju">  server_protocol = "HTTP"<br/>  server_pool     = "${opc_lbaas_server_pool.serverpool1.uri}"</span><span id="0004" class="jp jq hh jf b fi jv js l jt ju">  policies = [<br/>    "${opc_lbaas_policy.load_balancing_mechanism_policy.uri}",<br/>  ]<br/>}</span></pre><p id="3995" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">策略用于定义侦听器如何处理传入流量。在监听器定义中，我们引用了一个<strong class="ig hi">负载平衡机制策略</strong>来设置负载平衡器如何在服务器池中的可用服务器之间分配流量。还可以定义附加策略类型来控制会话关联性</p><pre class="jh ji jj jk fd jl jf jm jn aw jo bi"><span id="abc3" class="jp jq hh jf b fi jr js l jt ju">resource "<strong class="jf hi">opc_lbaas_policy</strong>" "load_balancing_mechanism_policy" {<br/>  load_balancer = "${opc_lbaas_load_balancer.lb1.id}"<br/>  name          = "roundrobin"</span><span id="e433" class="jp jq hh jf b fi jv js l jt ju">  load_balancing_mechanism_policy {<br/>    load_balancing_mechanism = "round_robin"<br/>  }<br/>}</span></pre><p id="f725" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">至此，我们的第一个基本负载平衡器配置就完成了。差不多吧。最后一步是配置DNS CNAME记录，将源域名(例如<code class="du jc jd je jf b">mywebapp.example.com</code>)指向负载平衡器实例的规范主机名。具体步骤取决于您的DNS提供商。要获得<code class="du jc jd je jf b">canonical_host_name</code>，添加以下输出。</p><pre class="jh ji jj jk fd jl jf jm jn aw jo bi"><span id="c37a" class="jp jq hh jf b fi jr js l jt ju">output "canonical_host_name" {<br/>  value = "${opc_lbaas_load_balancer.lb1.canonical_host_name}"<br/>}</span></pre><p id="0392" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="jw">有用提示</em> </strong> <em class="jw">:如果您只是创建用于测试的负载平衡器，并且您没有访问DNS名称的权限，那么您可以重定向，一个解决方法是将监听器配置中的</em> <code class="du jc jd je jf b"><em class="jw">virtual host</em></code> <em class="jw">设置为负载平衡器的规范主机名，然后您可以将规范主机名直接用于入站服务URL，例如</em></p><pre class="jh ji jj jk fd jl jf jm jn aw jo bi"><span id="6c3f" class="jp jq hh jf b fi jr js l jt ju">resource "<strong class="jf hi">opc_lbaas_listener</strong>" "listener1" { <br/>  ...<br/><strong class="jf hi">  virtual_hosts     = [<br/>    "${opc_lbaas_load_balancer.lb1.canonical_host_name}"<br/>  ]<br/></strong>  ...<br/>}</span></pre><h1 id="e595" class="jx jq hh bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">为HTTPS配置负载平衡器</h1><p id="57d3" class="pw-post-body-paragraph ie if hh ig b ih ku ij ik il kv in io ip kw ir is it kx iv iw ix ky iz ja jb ha bi translated">为HTTPS流量配置负载平衡器有两个独立的方面，第一个方面是启用对负载平衡器的入站HTTPS请求，通常称为SSL或TLS终止或卸载。第二种是对负载平衡器和原始服务器池中的服务器之间的流量使用HTTPS。</p><h2 id="9fe3" class="jp jq hh bd jy kz la lb kc lc ld le kg ip lf lg kk it lh li ko ix lj lk ks ll bi translated">HTTPS SSL/TLS终止</h2><p id="c711" class="pw-post-body-paragraph ie if hh ig b ih ku ij ik il kv in io ip kw ir is it kx iv iw ix ky iz ja jb ha bi translated">要配置负载平衡器侦听器以接受客户端和负载平衡器之间加密流量的入站HTTPS请求，请创建一个<strong class="ig hi">服务器证书</strong>，为CA证书链提供PEM编码的证书和私钥，以及PEM编码的级联证书集。</p><pre class="jh ji jj jk fd jl jf jm jn aw jo bi"><span id="783f" class="jp jq hh jf b fi jr js l jt ju">resource "<strong class="jf hi">opc_lbaas_certificate</strong>" "cert1" {<br/>  name = "server-cert"<br/>  type = "<strong class="jf hi">SERVER</strong>"<br/>  private_key = "${var.private_key_pem}"<br/>  certificate_body = "${var.cert_pem}"<br/>  certificate_chain = "${var.ca_cert_pem}"<br/>}</span></pre><p id="9c7c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在更新现有的，或者为HTTPS创建一个新的监听器</p><pre class="jh ji jj jk fd jl jf jm jn aw jo bi"><span id="c92c" class="jp jq hh jf b fi jr js l jt ju">resource "<strong class="jf hi">opc_lbaas_listener</strong>" "listener2" {<br/>  load_balancer = "${opc_lbaas_load_balancer.lb1.id}"<br/>  name          = "https-listener"</span><span id="08f5" class="jp jq hh jf b fi jv js l jt ju"><strong class="jf hi">  balancer_protocol = "HTTPS"<br/>  port              = 443<br/></strong>  <strong class="jf hi">certificates      = ["${opc_lbaas_certificate.cert1.uri}"]</strong><br/>  virtual_hosts     = ["mywebapp.example.com"]</span><span id="e645" class="jp jq hh jf b fi jv js l jt ju">  server_protocol = "HTTP"<br/>  server_pool     = "${opc_lbaas_server_pool.serverpool1.uri}"</span><span id="a07a" class="jp jq hh jf b fi jv js l jt ju">  policies = [<br/>    "${opc_lbaas_policy.load_balancing_mechanism_policy.uri}",<br/>  ]<br/>}</span></pre><p id="3928" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，服务器池协议仍然是HTTP，在此配置中，流量仅在客户端和负载平衡器之间加密。</p><h2 id="bd1d" class="jp jq hh bd jy kz la lb kc lc ld le kg ip lf lg kk it lh li ko ix lj lk ks ll bi translated">HTTP到HTTPS重定向</h2><p id="4455" class="pw-post-body-paragraph ie if hh ig b ih ku ij ik il kv in io ip kw ir is it kx iv iw ix ky iz ja jb ha bi translated">许多web应用程序需要的一个常见模式是确保任何通过HTTP的初始传入请求都被重定向到HTTPS，以实现安全的站点通信。要做到这一点，我们可以用一个新的重定向策略来更新上面创建的原始HTTP侦听器</p><pre class="jh ji jj jk fd jl jf jm jn aw jo bi"><span id="8677" class="jp jq hh jf b fi jr js l jt ju">resource "<strong class="jf hi">opc_lbaas_policy</strong>" "<strong class="jf hi">redirect_policy</strong>" {<br/>  load_balancer = "${opc_lbaas_load_balancer.lb1.id}"<br/>  name          = "example_redirect_policy"</span><span id="1d08" class="jp jq hh jf b fi jv js l jt ju"><strong class="jf hi">  redirect_policy {<br/>    redirect_uri = "</strong><a class="ae jg" href="https://${var.dns_name" rel="noopener ugc nofollow" target="_blank"><strong class="jf hi">https://${var.dns_name</strong></a><strong class="jf hi">}"<br/>    response_code = 301<br/>  }<br/></strong>}</span><span id="d967" class="jp jq hh jf b fi jv js l jt ju">resource "<strong class="jf hi">opc_lbaas_listener</strong>" "<strong class="jf hi">listener1</strong>" {<br/>  load_balancer = "${opc_lbaas_load_balancer.lb1.id}"<br/>  name          = "http-listener"</span><span id="330f" class="jp jq hh jf b fi jv js l jt ju">  balancer_protocol = "HTTP"<br/>  port              = 80<br/>  virtual_hosts     = ["mywebapp.example.com"]</span><span id="4cba" class="jp jq hh jf b fi jv js l jt ju">  server_protocol = "HTTP"<br/>  server_pool     = "${opc_lbaas_server_pool.serverpool1.uri}"</span><span id="e79c" class="jp jq hh jf b fi jv js l jt ju"><strong class="jf hi">  policies = [<br/>    "${opc_lbaas_policy.redirect_policy.uri}",<br/>  ]<br/></strong>}</span></pre><h2 id="1016" class="jp jq hh bd jy kz la lb kc lc ld le kg ip lf lg kk it lh li ko ix lj lk ks ll bi translated">负载平衡器和服务器池之间的HTTPS</h2><p id="b8ff" class="pw-post-body-paragraph ie if hh ig b ih ku ij ik il kv in io ip kw ir is it kx iv iw ix ky iz ja jb ha bi translated">如果通过公共互联网访问服务器池，则应使用负载平衡器和服务器池之间的HTTPS，当通过专用IP网络访问Oracle云基础架构中的服务器时，该技术也可用于提高安全性。</p><p id="35a9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此配置假设后端服务器已经配置为通过HTTPS提供内容服务。</p><p id="a718" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要配置负载平衡器以安全地与后端服务器通信，请创建一个<strong class="ig hi">可信证书</strong>，为后端服务器提供PEM编码的证书和CA授权证书链。</p><pre class="jh ji jj jk fd jl jf jm jn aw jo bi"><span id="22ca" class="jp jq hh jf b fi jr js l jt ju">resource "<strong class="jf hi">opc_lbaas_certificate</strong>" "cert2" {<br/>  name = "trusted-cert"<br/>  type = "<strong class="jf hi">TRUSTED</strong>"<strong class="jf hi"><br/></strong>  certificate_body = "${var.cert_pem}"<br/>  certificate_chain = "${var.ca_cert_pem}"<br/>}</span></pre><p id="d603" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来创建一个引用可信证书的<strong class="ig hi">可信证书策略</strong></p><pre class="jh ji jj jk fd jl jf jm jn aw jo bi"><span id="fe51" class="jp jq hh jf b fi jr js l jt ju">resource "<strong class="jf hi">opc_lbaas_policy</strong>" "trusted_certificate_policy" {<br/>  load_balancer = "${opc_lbaas_load_balancer.lb1.id}"<br/>  name          = "example_trusted_certificate_policy"</span><span id="12c7" class="jp jq hh jf b fi jv js l jt ju">  trusted_certificate_policy {<br/>    trusted_certificate = "${opc_lbaas_certificate.cert2.uri}"<br/>  }<br/>}</span></pre><p id="51cb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，将侦听器服务器池配置更新为HTTPS，添加可信证书策略</p><pre class="jh ji jj jk fd jl jf jm jn aw jo bi"><span id="9f1a" class="jp jq hh jf b fi jr js l jt ju">resource "<strong class="jf hi">opc_lbaas_listener</strong>" "listener2" {<br/>  load_balancer = "${opc_lbaas_load_balancer.lb1.id}"<br/>  name          = "https-listener"</span><span id="71fa" class="jp jq hh jf b fi jv js l jt ju">  balancer_protocol = "HTTPS"<br/>  port              = 443<br/>  certificates      = ["${opc_lbaas_certificate.cert1.uri}"]<strong class="jf hi"><br/></strong>  virtual_hosts     = ["mywebapp.example.com"]</span><span id="59a4" class="jp jq hh jf b fi jv js l jt ju"><strong class="jf hi">  server_protocol = "HTTPS"<br/></strong>  server_pool     = "${opc_lbaas_server_pool.serverpool1.uri}"</span><span id="116d" class="jp jq hh jf b fi jv js l jt ju">  policies = [<br/>    "${opc_lbaas_policy.load_balancing_mechanism_policy.uri}",<br/><strong class="jf hi">    "${opc_lbaas_policy.trusted_certificate_policy.uri}<br/></strong>  ]<br/>}</span></pre><h1 id="0b94" class="jx jq hh bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">更多信息</h1><ul class=""><li id="f095" class="lm ln hh ig b ih ku il kv ip lo it lp ix lq jb lr ls lt lu bi translated"><a class="ae jg" href="https://github.com/oracle/terraform-examples/tree/master/examples/opc/loadbalancer-classic" rel="noopener ugc nofollow" target="_blank">负载平衡器Classic的地形配置示例</a></li><li id="4e90" class="lm ln hh ig b ih lv il lw ip lx it ly ix lz jb lr ls lt lu bi translated"><a class="ae jg" href="https://docs.oracle.com/en/cloud/iaas/load-balancer-cloud/index.html" rel="noopener ugc nofollow" target="_blank">Oracle云基础设施负载平衡经典入门</a></li><li id="45d0" class="lm ln hh ig b ih lv il lw ip lx it ly ix lz jb lr ls lt lu bi translated"><a class="ae jg" href="https://www.terraform.io/docs/providers/opc/#" rel="noopener ugc nofollow" target="_blank">甲骨文云基础设施经典平台提供商</a></li></ul></div></div>    
</body>
</html>