<html>
<head>
<title>Trimming down the cost of running Google Cloud Dataflow at scale</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">大规模削减运行谷歌云数据流的成本</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/trimming-down-the-cost-of-running-google-cloud-dataflow-at-scale-1c796f72c002?source=collection_archive---------1-----------------------#2019-11-25">https://medium.com/google-developer-experts/trimming-down-the-cost-of-running-google-cloud-dataflow-at-scale-1c796f72c002?source=collection_archive---------1-----------------------#2019-11-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/d050d9ebb91716a77d065fd089f43747.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MsC6bEru6txzQBk84TK9ww.png"/></div></div></figure><p id="03ce" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Google Cloud Dataflow是Google Cloud Platform提供的产品之一，可以帮助您接收和转换来自流或批量数据源的数据。</p><p id="34e7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在<a class="ae jn" href="https://roobits.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ir hi"> Roobits </strong> </a>，我们广泛使用数据流管道来摄取事件，并将它们转换为客户所需的数据。</p><p id="59f4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Dataflow也是无服务器的，并根据输入负载自动扩展，这是对它已经提供的灵活性的额外奖励。</p><p id="9c59" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">数据流本质上要求您编写对来自源(可能是PubSub、Apache Kafka，甚至是一个文件)的传入事件执行的逻辑。)然后在Google的服务器上部署这个逻辑。</p><p id="16db" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">数据流允许你用Java、Kotlin或Python来编写这个逻辑。</p><p id="d381" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">数据流管道的一个非常简单的例子是获取输入段落并对其中的单词进行计数，如下所示:</p><figure class="jo jp jq jr fd ii"><div class="bz dy l di"><div class="js jt l"/></div></figure><p id="028b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">虽然这里的代码可能看起来很复杂，但是您可以去Apache Beam 的<a class="ae jn" href="https://beam.apache.org/documentation/" rel="noopener ugc nofollow" target="_blank">文档页面了解更多关于这里发生的事情。</a></p><p id="5f55" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要在您的Google Cloud项目上部署此代码，您可以按如下方式进行:</p><pre class="jo jp jq jr fd ju jv jw jx aw jy bi"><span id="32b1" class="jz ka hh jv b fi kb kc l kd ke"><strong class="jv hi">java -jar wordcount.jar \<br/>  --runner=DataflowRunner \<br/>  --project=&lt;YOUR_GCP_PROJECT_ID&gt;</strong></span></pre><p id="aa34" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">虽然这看起来不错，但当您计划扩展这一渠道时，在定价方面存在一些问题。</p><p id="293d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们一个一个来看。</p><h1 id="52c2" class="kf ka hh bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">减小磁盘大小</h1><p id="ce8a" class="pw-post-body-paragraph ip iq hh ir b is lc iu iv iw ld iy iz ja le jc jd je lf jg jh ji lg jk jl jm ha bi translated">默认情况下，数据流管道的磁盘大小对于批处理管道设置为250GB，对于流式管道设置为400GB。</p><p id="4ed6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您在内存中处理传入的事件，这很可能是一种资源浪费，因此，我建议将该参数减少到30GB或更少(最小推荐值是30GB，但是在以9–10GB的PD运行管道时，我们没有遇到任何问题)</p><p id="1d55" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在部署管道时，可以通过如下方式指定磁盘大小来实现这一点:</p><pre class="jo jp jq jr fd ju jv jw jx aw jy bi"><span id="d4c3" class="jz ka hh jv b fi kb kc l kd ke"><strong class="jv hi">--diskSizeGb=30</strong></span></pre><p id="a043" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在来看一下<a class="ae jn" href="https://cloud.google.com/products/calculator" rel="noopener ugc nofollow" target="_blank">谷歌云定价计算器</a>，降低这个值可以为我们每个员工每月节省<strong class="ir hi">大约20美元</strong>。</p><figure class="jo jp jq jr fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lh"><img src="../Images/4dc38d0df3f839a987dda172c72fa713.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cnarwj3OjN_OgZMpmdrOaA.png"/></div></div></figure></div><div class="ab cl li lj go lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ha hb hc hd he"><h1 id="c782" class="kf ka hh bd kg kh lp kj kk kl lq kn ko kp lr kr ks kt ls kv kw kx lt kz la lb bi translated">微批处理您的流管道</h1><p id="49f9" class="pw-post-body-paragraph ip iq hh ir b is lc iu iv iw ld iy iz ja le jc jd je lf jg jh ji lg jk jl jm ha bi translated">微批处理流管道帮助我们减少了数据流管道写入BigQuery的次数，从而降低了BigQuery写入的成本。</p><p id="fb90" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您可以看看下面的文章，了解更多关于如何做到这一点的见解:</p><div class="lu lv ez fb lw lx"><a rel="noopener follow" target="_blank" href="/google-developer-experts/micro-batching-a-streaming-input-source-using-google-cloud-dataflow-ccd30d2aabf2"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hi fi z dy mc ea eb md ed ef hg bi translated">使用Google Cloud数据流对流式输入源进行微批处理</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">通常，在构建数据处理管道时，您的数据可以是有界的(具有定义的大小)或无界的(具有……</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">medium.com</p></div></div><div class="mg l"><div class="mh l mi mj mk mg ml in lx"/></div></div></a></div></div><div class="ab cl li lj go lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ha hb hc hd he"><h1 id="c953" class="kf ka hh bd kg kh lp kj kk kl lq kn ko kp lr kr ks kt ls kv kw kx lt kz la lb bi translated">指定自定义机器类型</h1><p id="75d2" class="pw-post-body-paragraph ip iq hh ir b is lc iu iv iw ld iy iz ja le jc jd je lf jg jh ji lg jk jl jm ha bi translated">默认情况下，Dataflow支持用于管道的n1机器类型，尽管这些机器涵盖了各种用例，但是，您可能经常想要使用自己的定制机器，该机器具有强大的CPU或大容量RAM。</p><figure class="jo jp jq jr fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mm"><img src="../Images/d00b41a6f34cad10fdfc3decc73361bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cHKPAkgfLCUCuTm6Gf3KKA.png"/></div></div><figcaption class="mn mo et er es mp mq bd b be z dx">The prebuilt machines supported by dataflow</figcaption></figure><p id="f984" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为此，您可以在部署管道时添加以下参数:</p><pre class="jo jp jq jr fd ju jv jw jx aw jy bi"><span id="f751" class="jz ka hh jv b fi kb kc l kd ke"><strong class="jv hi">--workerMachineType=custom-8-7424</strong></span></pre><p id="080c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">上面的值对应于8个内核和7424 MB的内存，您可以根据自己的意愿进行调整，而不是局限于使用预设。</p></div><div class="ab cl li lj go lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ha hb hc hd he"><h1 id="b3ac" class="kf ka hh bd kg kh lp kj kk kl lq kn ko kp lr kr ks kt ls kv kw kx lt kz la lb bi translated">启用数据流引擎</h1><p id="d926" class="pw-post-body-paragraph ip iq hh ir b is lc iu iv iw ld iy iz ja le jc jd je lf jg jh ji lg jk jl jm ha bi translated">串流引擎是数据流家族的新成员，与传统管道相比具有多项优势，其中包括:</p><ol class=""><li id="4b63" class="mr ms hh ir b is it iw ix ja mt je mu ji mv jm mw mx my mz bi translated">减少工作虚拟机上消耗的CPU、内存和持久磁盘存储资源</li><li id="5eb0" class="mr ms hh ir b is na iw nb ja nc je nd ji ne jm mw mx my mz bi translated">更灵敏的<a class="ae jn" href="https://cloud.google.com/dataflow/service/dataflow-service-desc#autoscaling" rel="noopener ugc nofollow" target="_blank"> <strong class="ir hi">自动缩放</strong> </a>以响应传入数据量的变化</li><li id="d159" class="mr ms hh ir b is na iw nb ja nc je nd ji ne jm mw mx my mz bi translated">提高了可支持性，因为您不需要重新部署管道来应用服务更新</li></ol><p id="6d67" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">截至目前，流媒体引擎仅在这里的<a class="ae jn" href="https://cloud.google.com/dataflow/docs/guides/deploying-a-pipeline#streaming-engine" rel="noopener ugc nofollow" target="_blank">列表中提到的地区</a>可用，但随着服务的成熟，将会增加更多地区。</p><p id="b65c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要启用流引擎，只需将以下标志传递给管道执行即可！</p><pre class="jo jp jq jr fd ju jv jw jx aw jy bi"><span id="e41d" class="jz ka hh jv b fi kb kc l kd ke"><strong class="jv hi">--enableStreamingEngine</strong></span></pre></div><div class="ab cl li lj go lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ha hb hc hd he"><h1 id="4ece" class="kf ka hh bd kg kh lp kj kk kl lq kn ko kp lr kr ks kt ls kv kw kx lt kz la lb bi translated">禁用公共IP</h1><p id="d758" class="pw-post-body-paragraph ip iq hh ir b is lc iu iv iw ld iy iz ja le jc jd je lf jg jh ji lg jk jl jm ha bi translated">默认情况下，数据流服务为您的管道分配公共和私有IP地址。</p><p id="066b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在，如果您不希望您的数据对公众可用，禁用公共IPs是一个好主意，因为这不仅使您的管道更加安全，还可能帮助您节省一些网络成本。</p><p id="72e9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">向管道执行添加以下标志会禁用公共IP:</p><pre class="jo jp jq jr fd ju jv jw jx aw jy bi"><span id="957a" class="jz ka hh jv b fi kb kc l kd ke"><strong class="jv hi">--usePublicIps=false</strong></span></pre></div><div class="ab cl li lj go lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ha hb hc hd he"><h1 id="78c1" class="kf ka hh bd kg kh lp kj kk kl lq kn ko kp lr kr ks kt ls kv kw kx lt kz la lb bi translated">将您的GCP服务保持在同一地区</h1><p id="03dd" class="pw-post-body-paragraph ip iq hh ir b is lc iu iv iw ld iy iz ja le jc jd je lf jg jh ji lg jk jl jm ha bi translated">虽然对一些人来说这可能是显而易见的，但我看到很多人(包括我自己)为在GCP服务之间传输的数据支付额外的费用，只是因为他们不在同一个地区。</p><p id="1cf1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">例如，我们最终在一周内支付了大约<strong class="ir hi"> 500美元</strong>我们的一个项目，因为数据流管道和源代码应用引擎在不同的地方(美国和欧洲)</p><p id="19cb" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">不仅仅是AppEngine和Dataflow，很多GCP的服务都可以自由进出同一个地区！</p><p id="c00f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要在部署数据流管道时设置区域，可以添加以下执行参数:</p><pre class="jo jp jq jr fd ju jv jw jx aw jy bi"><span id="866d" class="jz ka hh jv b fi kb kc l kd ke"><strong class="jv hi">--region=europe-west1</strong></span></pre><p id="054d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">以下列出了云数据流支持的地区:</p><div class="lu lv ez fb lw lx"><a href="https://cloud.google.com/dataflow/docs/concepts/regional-endpoints" rel="noopener  ugc nofollow" target="_blank"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hi fi z dy mc ea eb md ed ef hg bi translated">区域端点|云数据流|谷歌云</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">云数据流区域端点存储和处理关于云数据流作业的元数据，并部署和控制…</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">cloud.google.com</p></div></div></div></a></div></div><div class="ab cl li lj go lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ha hb hc hd he"><p id="266b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">就是这样！<br/>结合使用上述技巧，我们能够从数据流上节省大量开支。</p><p id="f38e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">可以访问我的Medium profile，阅读更多围绕数据流和谷歌云的博客；从我上周写的这篇开始！</p><div class="lu lv ez fb lw lx"><a rel="noopener follow" target="_blank" href="/google-developer-experts/pitfalls-of-using-cron-jobs-with-google-app-engine-bf005f8bf7e6"><div class="ly ab dw"><div class="lz ab ma cl cj mb"><h2 class="bd hi fi z dy mc ea eb md ed ef hg bi translated">克服谷歌应用引擎Cron的缺陷</h2><div class="me l"><h3 class="bd b fi z dy mc ea eb md ed ef dx translated">当预建服务无法满足需求时！</h3></div><div class="mf l"><p class="bd b fp z dy mc ea eb md ed ef dx translated">medium.com</p></div></div><div class="mg l"><div class="mh l mi mj mk mg ml in lx"/></div></div></a></div><p id="228d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="nf">感谢阅读！如果你喜欢这个故事，请</em> <strong class="ir hi"> <em class="nf">点击</em> </strong>👏<strong class="ir hi"> <em class="nf">按钮</em> </strong> <em class="nf"> </em> <strong class="ir hi"> <em class="nf">分享</em> </strong> <em class="nf">帮助别人找到！欢迎留言</em>💬<em class="nf">下图。</em></p><p id="ba6a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="nf">有反馈吗？下面我们就来连线推特上的</em><a class="ae jn" href="https://twitter.com/harshithdwivedi" rel="noopener ugc nofollow" target="_blank"><em class="nf"/></a><em class="nf">。</em></p></div></div>    
</body>
</html>