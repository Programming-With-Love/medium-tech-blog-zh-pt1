<html>
<head>
<title>Monitoring multiple OKE clusters with Prometheus, Thanos and Grafana — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用普罗米修斯、灭霸和格拉夫纳监测多个OKE星团——第二部分</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/monitoring-multiple-oke-clusters-with-prometheus-thanos-and-grafana-part-2-77d2f0303ea0?source=collection_archive---------0-----------------------#2021-12-02">https://medium.com/oracledevs/monitoring-multiple-oke-clusters-with-prometheus-thanos-and-grafana-part-2-77d2f0303ea0?source=collection_archive---------0-----------------------#2021-12-02</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="2a41" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在<a class="ae jc" rel="noopener" href="/oracledevs/monitoring-multiple-oke-clusters-with-prometheus-thanos-and-grafana-part-1-df11df7013f1">第1部分</a>中，我们了解了我们希望使用<a class="ae jc" href="https://thanos.io/" rel="noopener ugc nofollow" target="_blank">灭霸</a>的一些原因，这是一种为Prometheus提供长期存储能力的高可用性解决方案。我们还在我们的<strong class="ig hi">管理</strong> <a class="ae jc" href="https://verrazzano.io/" rel="noopener ugc nofollow" target="_blank"> Verrazzano </a>集群中部署了灭霸的所有组件。但是，我们只获得了1个集群的指标。在本文中，我们将研究如何监控多个集群。</p><p id="19a2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">回想一下:</p><ul class=""><li id="2182" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated"><a class="ae jc" rel="noopener" href="/oracledevs/deploying-a-multi-cluster-verrazzano-using-oke-part-1-d6327d45ba03">我们已经部署了4个OKE集群，分别位于新加坡、悉尼、孟买和东京OCI地区</a></li><li id="bd8f" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><a class="ae jc" href="https://verrazzano.io/docs/concepts/verrazzanomulticluster/" rel="noopener ugc nofollow" target="_blank">在多集群设置中，Verrazzano有管理和被管理集群的概念</a>。<strong class="ig hi">管理</strong>集群类似于Kubernetes中的控制平面或WebLogic中的管理服务器，而受管集群类似于Kubernetes中的工作节点或WebLogic中的受管服务器</li><li id="1cae" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><a class="ae jc" rel="noopener" href="/oracledevs/deploying-a-multi-cluster-verrazzano-using-oke-part-2-93d2438f7eef">我们将新加坡集群设为管理集群，将其他地区设为被管理集群</a></li><li id="b846" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">我们还在新加坡集群中安装了灭霸。</li></ul><p id="e292" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">实际上，这使得新加坡集群成为我们的指挥中心:</p><figure class="jr js jt ju fd jv"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="75f4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们现在也想监视其他集群。为此，我们将在每个地区安装带灭霸边车的普罗米修斯。</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jy"><img src="../Images/01b1589117c28e9c13d0f8d1794d3c3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zUbio6i2EFJ2yHQB2V2tcA.png"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx">Multi-cluster, multi-region Thanos deployment</figcaption></figure><p id="a0f3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先，在每个区域创建一个名为<strong class="ig hi"> thanos </strong>的bucket。</p><p id="84e5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在操作员主机上，制作thanos-sin-storage.yaml的3个副本，并按区域对它们进行相应的重命名，例如thanos-syd-storage.yaml、thanos-mum-storage.yaml、thanos-tok-storage.yaml。编辑每个文件并更改它们各自的对象存储结束点和区域。对象存储端点具有以下格式:</p><pre class="jr js jt ju fd kj kk kl km aw kn bi"><span id="2f4a" class="ko kp hh kk b fi kq kr l ks kt">&lt;object_storage_namespace&gt;.compat.objectstorage.region.oraclecloud.com</span></pre><p id="23c6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">回想一下，我们还安装了<a class="ae jc" href="https://github.com/ahmetb/kubectx" rel="noopener ugc nofollow" target="_blank"> kubectx </a>，为了我们的多集群目的，我们将1个集群等同于1个上下文。对于每个受管理的集群，重复以下操作:</p><pre class="jr js jt ju fd kj kk kl km aw kn bi"><span id="4645" class="ko kp hh kk b fi kq kr l ks kt">## # change name of context everytime<br/>kubectx sydney</span><span id="df38" class="ko kp hh kk b fi ku kr l ks kt">kubectl create ns monitoring</span><span id="ad65" class="ko kp hh kk b fi ku kr l ks kt">## change file name everytime<br/>kubectl -n monitoring create secret generic thanos-objstore-config --from-file=thanos-syd-storage.yaml=thanos-syd-storage.yaml</span></pre><h2 id="721c" class="ko kp hh bd kv kw kx ky kz la lb lc ld ip le lf lg it lh li lj ix lk ll lm ln bi translated">用边车部署普罗米修斯</h2><p id="81cf" class="pw-post-body-paragraph ie if hh ig b ih lo ij ik il lp in io ip lq ir is it lr iv iw ix ls iz ja jb ha bi translated">接下来，我们将在每个地区部署带边车的普罗米修斯。和前面一样，为每个集群创建一个prometheusvalues.yaml文件的副本，例如prometheusvalues-sydney.yaml等。编辑每个文件并更改以下内容:</p><pre class="jr js jt ju fd kj kk kl km aw kn bi"><span id="75aa" class="ko kp hh kk b fi kq kr l ks kt"><em class="lt">prometheus.thanos.objectStorageConfig.secretKey</em>: <strong class="kk hi">thanos-sin-storage.yaml</strong><br/><em class="lt">prometheus.thanos.service.type</em>: ClusterIP<br/><em class="lt">prometheus.thanos.service.annotations</em>: {}<br/><em class="lt">prometheus.externalLabels</em>:<br/>  cluster: "<strong class="kk hi">syd</strong>"</span></pre><p id="24a0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你现在可以在每个地区部署普罗米修斯。记住每次都要更改上下文和文件:</p><pre class="jr js jt ju fd kj kk kl km aw kn bi"><span id="a0e3" class="ko kp hh kk b fi kq kr l ks kt">kubectx sydney</span><span id="0e5c" class="ko kp hh kk b fi ku kr l ks kt">helm install prometheus bitnami/kube-prometheus \<br/>--namespace monitoring \<br/>-f prometheusvalues-sydney.yaml</span></pre><p id="2a21" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">验证普罗米修斯吊舱在每个区域是否正常运行:</p><pre class="jr js jt ju fd kj kk kl km aw kn bi"><span id="90cb" class="ko kp hh kk b fi kq kr l ks kt">kubectl -n monitoring get pods</span></pre><p id="64fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，在所有“<strong class="ig hi">”管理的“</strong>”地区部署灭霸。首先，复制我们在第1部分中创建的thanosvalues.yaml <a class="ae jc" rel="noopener" href="/oracledevs/monitoring-multiple-oke-clusters-with-prometheus-thanos-and-grafana-part-1-df11df7013f1">，然后确保更新以下参数:</a></p><pre class="jr js jt ju fd kj kk kl km aw kn bi"><span id="b9c3" class="ko kp hh kk b fi kq kr l ks kt">objstoreConfig<br/>  ## update the endpoint, and region</span><span id="4b6d" class="ko kp hh kk b fi ku kr l ks kt">query.service.type: LoadBalancer<br/>query.service.annotations:<br/>  oci.oraclecloud.com/oci-network-security-groups: "<strong class="kk hi">nsg_id</strong>"<br/>  service.beta.kubernetes.io/oci-load-balancer-shape: "flexible"<br/>  service.beta.kubernetes.io/oci-load-balancer-shape-flex-min: "50"<br/>  service.beta.kubernetes.io/oci-load-balancer-shape-flex-max: "100"<br/>  service.beta.kubernetes.io/oci-load-balancer-subnet1: "<strong class="kk hi">subnet_id</strong>"<br/>  service.beta.kubernetes.io/oci-load-balancer-internal: "true"   service.beta.kubernetes.io/oci-load-balancer-security-list-management-mode: "All"</span></pre><p id="b4df" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您可以从OCI控制台获取nsg_id和子网_id值。确保您了解每个地区的价值观。<strong class="ig hi"> </strong>在各地区部署灭霸:</p><pre class="jr js jt ju fd kj kk kl km aw kn bi"><span id="aa04" class="ko kp hh kk b fi kq kr l ks kt">kubectx sydney</span><span id="6ca8" class="ko kp hh kk b fi ku kr l ks kt">helm install thanos bitnami/thanos \<br/>--namespace monitoring \<br/>-f thanos-syd.yaml</span></pre><p id="0a89" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">验证每个地区的所有灭霸吊舱运行正常:</p><pre class="jr js jt ju fd kj kk kl km aw kn bi"><span id="2dd7" class="ko kp hh kk b fi kq kr l ks kt">kubectl -n monitoring get pods</span></pre><h2 id="52f8" class="ko kp hh bd kv kw kx ky kz la lb lc ld ip le lf lg it lh li lj ix lk ll lm ln bi translated">更新管理区域中的普罗米修斯和灭霸</h2><p id="76e0" class="pw-post-body-paragraph ie if hh ig b ih lo ij ik il lp in io ip lq ir is it lr iv iw ix ls iz ja jb ha bi translated">有了上述架构，我们不再需要将<strong class="ig hi">管理</strong>区域中的侧车作为负载平衡器服务公开。相反，将query.service.type设置为<strong class="ig hi"> ClusterIP </strong>并注释/删除注释。我们也可以更新商店列表(请注意，我现在只有两个托管区域，因为我在测试其他东西时弄乱了东京集群):</p><pre class="jr js jt ju fd kj kk kl km aw kn bi"><span id="6d14" class="ko kp hh kk b fi kq kr l ks kt">stores:<br/>- 10.1.2.5:10901<br/>- 10.2.2.28:10901</span></pre><p id="91ab" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将上下文更改为管理并运行helm update:</p><pre class="jr js jt ju fd kj kk kl km aw kn bi"><span id="ec63" class="ko kp hh kk b fi kq kr l ks kt">kubectx admin</span><span id="594d" class="ko kp hh kk b fi ku kr l ks kt">helm upgrade thanos bitnami/thanos -f thanosvalues.yaml</span></pre><p id="c86f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您访问灭霸查询，您现在可以看到2个查询，1个商店和没有侧车:</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lu"><img src="../Images/281f802f10cd47a91a1cab183ca75b88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r6a6P1LmBgHAHKOljvnOrQ.png"/></div></div></figure><p id="521c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们使用灭霸来查找每个集群分配的和仍在使用的内存量。我们运行一个查询，然后使用我们在每个集群中设置的外部标签:</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lv"><img src="../Images/cd55b7e3ac11fafd1c6ca9514b523606.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fWUWmYSfFjqsusGLE9ngcg.png"/></div></div></figure><p id="6e33" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们看看格拉夫纳。这一次，我们将使用群集详细信息仪表板(id: 10856)。像以前一样导入它，使用灭霸数据源并访问仪表板。它将显示为空。</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lw"><img src="../Images/64e3d03277f8bffb9cbd1337bb8e9f64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zGiw-BH5BQpDKnaitO0zNQ.png"/></div></div></figure><p id="122f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">原因是仪表板显示了过去30分钟的指标，而数据尚未存储到对象存储中。更改时间范围，您可能需要等待至少2小时，直到第一个数据写入OCI对象存储:</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lx"><img src="../Images/4ae0540417ec30d62a03686f5afd6518.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Ei2JL1MdIq-JArkIRCReg.png"/></div></div></figure><h2 id="6902" class="ko kp hh bd kv kw kx ky kz la lb lc ld ip le lf lg it lh li lj ix lk ll lm ln bi translated">向Grafana仪表板添加区域过滤器</h2><p id="b723" class="pw-post-body-paragraph ie if hh ig b ih lo ij ik il lp in io ip lq ir is it lr iv iw ix ls iz ja jb ha bi translated">我们现在还希望能够检查一个特定的集群:</p><ol class=""><li id="27fb" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ly jj jk jl bi translated">单击仪表板设置，然后单击左侧菜单上的<strong class="ig hi">变量</strong>。</li><li id="ba48" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ly jj jk jl bi translated">点击<strong class="ig hi">新建</strong>新建一个变量</li><li id="28b2" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ly jj jk jl bi translated">命名为<strong class="ig hi">集群</strong></li><li id="e34d" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ly jj jk jl bi translated">将类型设置为<strong class="ig hi">特定过滤器</strong></li><li id="ee0b" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ly jj jk jl bi translated">并点击<strong class="ig hi">更新</strong>，之后是保存<strong class="ig hi">仪表盘</strong></li></ol><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lz"><img src="../Images/4f4e88153d9261a8c8e9a23f2e992017.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AYzxHHknndxAAW28fvv5tg.png"/></div></div></figure><p id="0421" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您现在将在仪表板的顶部看到一个过滤器:</p><figure class="jr js jt ju fd jv er es paragraph-image"><div class="er es ma"><img src="../Images/fe3197fc8e1a8134e6b5c0eb708aeefa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/format:webp/1*mFI-pn7aAlC_T129PSAqrA.png"/></div></figure><p id="4187" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">点击<strong class="ig hi"> + </strong>图标，选择<strong class="ig hi">集群</strong>，然后选择您要检查的集群:</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es mb"><img src="../Images/f693dea65ab1c7cdfcb871a0f49cd382.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lMG-8Sj6Zn3wpID3vKxYvg.png"/></div></div></figure><p id="d3c0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里的值将是您在每个集群的externalLabel参数中设置的值。选择1个集群后，您应该会看到各个面板中的值发生变化:</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es mc"><img src="../Images/92cda988caf423d16ba90bb5b60371bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mo_lUs7ZTTjJI3CTdzOrSQ.png"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx">Updated Grafana values after selecting a cluster</figcaption></figure><h2 id="5649" class="ko kp hh bd kv kw kx ky kz la lb lc ld ip le lf lg it lh li lj ix lk ll lm ln bi translated">摘要</h2><p id="e18d" class="pw-post-body-paragraph ie if hh ig b ih lo ij ik il lp in io ip lq ir is it lr iv iw ix ls iz ja jb ha bi translated">现在，我们可以跨多个区域、虚拟社区甚至同时监控OCI各种资源的性能。这次演习还帮助我更好地了解了灭霸，我开始意识到这只是将灭霸部署为Prometheus的长期高可用性解决方案时的众多变化之一。每种变化都有其优点和缺点，可能会有法规影响(如果您需要遵守这些法规),需要在基础设施、架构和财务方面进行权衡。在以后的文章中，我们希望能看到这些。</p><p id="5075" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我要感谢我的同事肖恩·利维和韦努戈帕尔·纳伊克，感谢他们深思熟虑的建议和想法。</p><p id="bb54" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">相关文献:</p><ul class=""><li id="79d2" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated"><a class="ae jc" href="https://artifacthub.io/packages/helm/bitnami/thanos/8.1.2" rel="noopener ugc nofollow" target="_blank">https://artifacthub.io/packages/helm/bitnami/thanos/8.1.2</a></li><li id="2c79" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><a class="ae jc" href="https://www.infracloud.io/blogs/thanos-ha-scalable-prometheus/" rel="noopener ugc nofollow" target="_blank">https://www . infra cloud . io/blogs/thanos-ha-scalable-Prometheus/</a></li><li id="de95" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">【https://particule.io/en/blog/thanos-monitoring/ T4】</li><li id="a63e" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><a class="ae jc" href="https://betterprogramming.pub/set-up-thanos-with-multi-tenancy-to-power-up-your-prometheus-70123e6ea555" rel="noopener ugc nofollow" target="_blank">https://better programming . pub/set-up-thanos-with-multi-tenancy-to-power-up-your-Prometheus-70123 e6ea 555</a></li></ul></div></div>    
</body>
</html>