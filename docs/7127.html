<html>
<head>
<title>iOS Build Infrastructure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">iOS构建基础设施</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/ios-build-infrastructure-8f69f2d7adec?source=collection_archive---------0-----------------------#2015-07-28">https://medium.com/square-corner-blog/ios-build-infrastructure-8f69f2d7adec?source=collection_archive---------0-----------------------#2015-07-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="f809" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">我们如何配置我们的Mac minis来运行构建</h2></div><p id="82ca" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="js">由</em> <a class="jt ju ge" href="https://medium.com/u/22c9903aa9f1?source=post_page-----8f69f2d7adec--------------------------------" rel="noopener" target="_blank">撰写<em class="js">迈克尔</em> </a> <em class="js">。</em></p><blockquote class="jv"><p id="a6a4" class="jw jx hh bd jy jz ka kb kc kd ke jr dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae kf" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><p id="9cd5" class="pw-post-body-paragraph iw ix hh iy b iz kg ii jb jc kh il je jf ki jh ji jj kj jl jm jn kk jp jq jr ha bi translated">Square有几十个iOS工程师在做<a class="ae kf" href="https://squareup.com/register" rel="noopener ugc nofollow" target="_blank"> Square寄存器</a>。此外，Square向App Store发布了多个iOS应用，并在内部分发了几个iOS应用。为了支持我们的应用程序员的工作，我们投资了一个持续集成和测试集群。</p><p id="a9ff" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们最近更换了该集群的后端，以便它可以扩展到超过8台机器。作为这一承诺的直接结果，在过去的一年中，我们增加了构建的<a class="ae kf" href="https://corner.squareup.com/2015/06/build-stability.html" rel="noopener ugc nofollow" target="_blank">可靠性</a>,并且对于每个工程师对注册库的贡献，我们能够运行的测试数量几乎翻了两番。这对我们的特性团队的速度产生了显著的影响，并在我们发布代码之前通知了我们许多重大的倒退。</p><p id="0c97" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当谈到持续集成时，iOS应用程序有点像特殊的雪花。这篇文章是关于我们为支持iOS团队所做的后端基础设施选择。</p><h1 id="9ba6" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">詹金斯</h1><p id="bda0" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">我们使用<a class="ae kf" href="http://jenkins-ci.org/" rel="noopener ugc nofollow" target="_blank"> Jenkins </a>，以及一个自定义插件<a class="ae kf" href="https://www.atlassian.com/software/stash" rel="noopener ugc nofollow" target="_blank"> Stash </a>，形成我们CI系统的主干。这个插件类似于Palantir的Stashbot当各种各样的git推送发生时，它充当Jenkins的通知器。我们构建集群中的构建奴隶使用<a class="ae kf" href="https://wiki.jenkins-ci.org/display/JENKINS/Swarm+Plugin" rel="noopener ugc nofollow" target="_blank"> swarm </a>插件连接到Jenkins master。所有构建都在从属机器上运行。主Jenkins实例负责在内部为Jenkins web接口提供服务，并将工件和日志移入和移出构建奴隶。</p><h1 id="b45e" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">五金器具</h1><p id="6de2" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">iOS应用程序必须建立在OSX之上。由于虚拟化构建基础架构的诸多优势，我们曾短暂考虑过使用它；然而在实践中，我们发现它对我们来说缺乏性能。构建通常需要对小文件进行多次读写。这给调度程序和文件系统驱动程序带来了相当大的压力。对于虚拟化系统，有两个调度程序和两个磁盘驱动程序。在Linux上，这些系统可以很好地协同工作，但是我们发现在OSX上并非如此。</p><p id="bad3" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">经过一些测试后，我们决定采用以下裸机配置，目前每个构建奴隶的价格约为1200美元:</p><ul class=""><li id="f688" class="li lj hh iy b iz ja jc jd jf lk jj ll jn lm jr ln lo lp lq bi translated">2.6Ghz双核英特尔酷睿i5</li><li id="8242" class="li lj hh iy b iz lr jc ls jf lt jj lu jn lv jr ln lo lp lq bi translated">16GB内存</li><li id="1dab" class="li lj hh iy b iz lr jc ls jf lt jj lu jn lv jr ln lo lp lq bi translated">256GB PCIe存储</li></ul><p id="bda7" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们还购买了<a class="ae kf" href="http://www.amazon.com/gp/product/B00FLZXGJ6/ref=as_li_qf_sp_asin_il_tl" rel="noopener ugc nofollow" target="_blank">假的hdmi显示器</a>，这样使用iOS模拟器的测试将使用显卡，而不是软件渲染。这种优化为我们的测试提供了10%的加速。</p><p id="8fa0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们希望仍然有可能从苹果商店购买2012年的四核配置。目前，只有双核配置必须作为新配置购买。我们的工作负载是高度可并行化的，希望在迷你外形中拥有更多计算单元。</p><h1 id="4c76" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">结构管理</h1><p id="2553" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">为了从机器中获得可靠且可重复的构建结果，我们希望确保它们的配置是相同的。我们使用<a class="ae kf" href="http://www.deploystudio.com/Home.html" rel="noopener ugc nofollow" target="_blank"> DeployStudio </a>通过网络镜像新的Mac minis，然后用<a class="ae kf" href="http://www.ansible.com/home" rel="noopener ugc nofollow" target="_blank"> Ansible </a>做最后的设置。Ansible允许我们拥有一个机器配置的检入记录，以及在任何给定时间我们有哪些机器在使用。当我们测试新的配置或者试图理解发生在构建奴隶上的问题时，这是非常宝贵的。</p><p id="4e51" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">对ansible repo的更改也要经过代码审查和测试。即使对于复杂的剧本，我们也坚持将它们写成等幂的片段，这样我们可以针对整个集群快速运行整个剧本，而不会导致任何更改。</p><h1 id="bfff" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">软件</h1><p id="16db" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">我们发现10.10.4 Yosemite是OSX Xcode 6及其模拟器最稳定的版本。在撰写本文时，我们正在我们的集群上使用Xcode 6.1.1，并且正在逐步升级Xcode 6 . 3 . 2——同时测试可靠性。</p><p id="a41d" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">除了安装Xcode、OSX和Xcode命令行工具之外，还有许多系统设置调整，使Xcode和iOS模拟器在命令行上比开箱即用更可靠。我们希望能够从OSX和Xcode获得可靠的行为，这些配置调整已经帮助我们做到了这一点。</p><h1 id="1a35" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">登录和图形用户界面</h1><p id="0ec5" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">我们已经配置了所有的构建奴隶来自动登录构建用户。这为我们提供了运行iOS模拟器的GUI上下文，意味着我们可以将Jenkins代理作为用户启动代理来启动。这允许Jenkins启动的任何进程访问该gui上下文。远程运行iOS模拟器的许多问题都源于缺乏通常的OSX登录中的API设施。</p><p id="bb15" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们通过在Jenkins从代理上运行<a class="ae kf" href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man8/caffeinate.8.html" rel="noopener ugc nofollow" target="_blank">咖啡因</a>来增强这一功能，这样mini就永远不会休眠。OSX上有很多睡眠设置，每个版本都会添加新的设置。我们发现使用咖啡因来设置power assert是防止构建奴隶进入睡眠状态的最可靠的方法。</p><p id="2fba" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">构建用户被自动记录意味着构建用户的密码<a class="ae kf" href="http://apple.stackexchange.com/a/50680" rel="noopener ugc nofollow" target="_blank">在文件系统上很容易被发现</a>。对于创建发布二进制文件的构建奴隶，我们禁用带密码的SSH访问，并完全关闭VNC。公司中受信任的小组可以访问代码签名机来部署我们的代码签名证书，但是不允许其他远程访问。构建用户对从机本身有sudo访问权，我们打开<a class="ae kf" href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man8/DevToolsSecurity.8.html" rel="noopener ugc nofollow" target="_blank"> DevToolsSecurity </a>，这样Xcode就可以正常工作了。</p><h1 id="8a54" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">OS X无障碍通道</h1><p id="32be" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">Xcodebuild使用OSX的可访问性访问挂钩来控制iOS模拟器。在Mavericks (10.9)中，OSX访问这些钩子的方式已经获得了应用程序级的粒度。以前，它是一个系统级参数，允许所有进程相互访问。如果访问未被授权，可能会导致令人抓狂的问题，xcodebuild在从Terminal.app运行时会完美运行，但在从Jenkins或SSH启动时会莫名其妙地失败。</p><p id="8798" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Mavericks (10.9)和Yosemite (10.10)通过访问进程的父进程来决定一个进程是否可以访问可访问性钩子。通过将<a class="ae kf" href="https://en.wikipedia.org/wiki/Launchd" rel="noopener ugc nofollow" target="_blank"> launchd </a>放入允许的进程列表中，通过SSH或Jenkins启动的进程可以访问整个系统的可访问性挂钩。为此，您可以根据本<a class="ae kf" href="https://gist.github.com/mtauraso/b4839ee262ab6f612805" rel="noopener ugc nofollow" target="_blank">要点</a>修改TCC数据库。需要重新启动才能使更改生效。</p><h1 id="a13a" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">连接到詹金斯</h1><p id="12f9" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">如前所述，我们使用<a class="ae kf" href="https://wiki.jenkins-ci.org/display/JENKINS/Swarm+Plugin" rel="noopener ugc nofollow" target="_blank"> Jenkins Swarm插件</a>来配置我们的从机。这与正常的Jenkins用法相反，因为每个从节点都连接到主节点，而不是从Jenkins配置进行管理。这使我们在添加或删除从节点，或者更改它们的IP或DNS名称时，不必维护主节点上的配置。</p><p id="8bbf" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">swarm插件中需要注意的主要问题是Jenkins remoting组件中的不匹配。这通常发生在Jenkins升级期间，需要向奴隶推送一个新的虫罐。因为未能连接到Jenkins的从机不会出现在列表中，所以建议从外部监控机器以确保它们保持连接。</p><h1 id="3b3a" class="kl km hh bd kn ko kp kq kr ks kt ku kv in kw io kx iq ky ir kz it la iu lb lc bi translated">当前工作</h1><p id="c4f0" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">我们为集群保持了高标准的<a class="ae kf" href="https://corner.squareup.com/2015/06/build-stability.html" rel="noopener ugc nofollow" target="_blank">构建稳定性</a>，目前我们运营着24台Mac minis。维护集群的某些方面还不太顺利。</p><p id="5d90" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Xcode升级还是有点工作量的。很难预测新版本的稳定性。在大多数情况下，点版本号越高，Xcode就越可靠。我们经常发现自己归档雷达，并为新升级的行为寻找解决办法。当Xcode 6.1是新版本时，我们决定在给定的机器上只有单一的Xcode配置(因为测试版与旧版本的Xcode互操作时有一些错误)。这种支持已经变得更好了，我们正在改变我们的配置，以允许在一个构建奴隶上有多个版本的Xcode。随着时间的推移，在单个主机上支持多个iOS模拟设备也变得越来越容易，我们也在努力使我们的安装不透气。</p><p id="3cb7" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们希望这些信息对为iOS构建持续集成系统的人有用。随着它的不断变化，我们将根据我们当前的配置实践更新这个角落。我们还对您使用苹果软件构建平台的经历感兴趣。在这个设置过程中，Stackoverflow问题和博客帖子是我们最好的老师，我们非常感谢花时间来教育我们的每一个人。此外，如果你对构建和发布工具感兴趣，并对苹果平台充满热情，给我们写封短信，<a class="ae kf" href="http://hire.jobvite.com/CompanyJobs/Careers.aspx?c=q8Z9VfwV&amp;page=Jobs" rel="noopener ugc nofollow" target="_blank">我们正在招聘</a>。</p></div><div class="ab cl lw lx go ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ha hb hc hd he"><div class="md me mf mg fd mh"><a rel="noopener follow" target="_blank" href="/@mtauraso"><div class="mi ab dw"><div class="mj ab mk cl cj ml"><h2 class="bd hi fi z dy mm ea eb mn ed ef hg bi translated">迈克尔·陶拉索-简介</h2><div class="mo l"><h3 class="bd b fi z dy mm ea eb mn ed ef dx translated">请关注迈克尔·陶拉索的最新活动-在媒体上发布个人资料。96人正在关注迈克尔·陶拉索的个人资料…</h3></div><div class="mp l"><p class="bd b fp z dy mm ea eb mn ed ef dx translated">medium.com</p></div></div><div class="mq l"><div class="mr l ms mt mu mq mv mw mh"/></div></div></a></div></div></div>    
</body>
</html>