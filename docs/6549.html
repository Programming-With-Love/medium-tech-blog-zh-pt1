<html>
<head>
<title>CI/CD with Angular 6 &amp; Firebase &amp; Bitbucket Pipelines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CI/CD，带角度6 &amp; Firebase &amp; Bitbucket管道</h1>
<blockquote>原文：<a href="https://medium.com/quick-code/ci-cd-with-angular-6-firebase-bitbucket-pipelines-a72a5445ef6f?source=collection_archive---------0-----------------------#2018-12-13">https://medium.com/quick-code/ci-cd-with-angular-6-firebase-bitbucket-pipelines-a72a5445ef6f?source=collection_archive---------0-----------------------#2018-12-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="352a" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">使用位桶管道自动构建、测试和部署</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/08642e5b5fc4b1093a56d1fcd327c094.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U0JJp4elWZwoXSHMh-0SEA.png"/></div></div></figure><h1 id="b96a" class="ji jj hh bd jk jl jm jn jo jp jq jr js in jt io ju iq jv ir jw it jx iu jy jz bi translated">投资CI/CD的动机</h1><p id="cb80" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">现代开发实践大大减少了工作的批量大小，例如，加快上市时间或更早获得客户反馈。一年一次或两次的经典发布节奏不再适用，无法跟上越来越多行业的市场步伐。相反，在极端情况下，亚马逊会每隔<a class="ae kw" href="https://news.ycombinator.com/item?id=2971521" rel="noopener ugc nofollow" target="_blank"> 11.6秒发布一次(截至2011年)。手动构建版本，执行手动测试，通过票证系统将代码移交给运营部门，然后运营部门尝试手动部署，这些方式显然不再有效。</a></p><blockquote class="kx ky kz"><p id="e2fb" class="ka kb la kc b kd lb ii kf kg lc il ki ld le kl km lf lg kp kq lh li kt ku kv ha bi translated"><strong class="kc hi">持续集成(CI) </strong>是一种开发实践，它要求开发人员频繁地将他们的代码集成到一个共享的存储库中，通常一天几次。每次签入都通过构建代码和执行测试来验证，以便尽早发现问题。【对比:<a class="ae kw" href="https://www.thoughtworks.com/de/continuous-integration" rel="noopener ugc nofollow" target="_blank">思想作品</a></p><p id="4963" class="ka kb la kc b kd lb ii kf kg lc il ki ld le kl km lf lg kp kq lh li kt ku kv ha bi translated"><strong class="kc hi">连续部署(CD) </strong>是在CI阶段通过所有自动化测试后，自动将代码部署到生产环境中的策略。[比较:<a class="ae kw" href="https://searchitoperations.techtarget.com/definition/continuous-deployment" rel="noopener ugc nofollow" target="_blank"> Techtarget </a> ]</p></blockquote><p id="f990" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated"><a class="ae kw" href="https://puppet.com/blog/2017-state-devops-report-here" rel="noopener ugc nofollow" target="_blank"> 2017年开发运营状况报告</a>解释了为什么与传统方法相比，CI/CD更有利于应用:</p><ul class=""><li id="af20" class="lj lk hh kc b kd lb kg lc kj ll kn lm kr ln kv lo lp lq lr bi translated">质量:变更失败率降低5倍</li><li id="ffed" class="lj lk hh kc b kd ls kg lt kj lu kn lv kr lw kv lo lp lq lr bi translated">交付:从提交到部署的交付时间缩短了440倍</li><li id="fc9f" class="lj lk hh kc b kd ls kg lt kj lu kn lv kr lw kv lo lp lq lr bi translated">交付:代码部署频率提高46倍</li><li id="d6d1" class="lj lk hh kc b kd ls kg lt kj lu kn lv kr lw kv lo lp lq lr bi translated">快乐的团队:花在新特性和代码上的时间增加了44%</li></ul><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lx"><img src="../Images/e002431da748723c5e47a184767d7cc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZLr-3WSIg8Evok8116dOTA.png"/></div></div><figcaption class="ly lz et er es ma mb bd b be z dx">Excerpt of 2017 State of DevOps Report <a class="ae kw" href="https://puppet.com/system/files/2017-06/puppet-2017-State-of-DevOps-Report_0.pdf" rel="noopener ugc nofollow" target="_blank">Infograph</a></figcaption></figure><p id="dc80" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">构建、测试和部署的自动化是可以自动化的最典型的步骤。在本文中，我们将在每次提交到主分支时，自动构建、测试和部署一个Angular 6应用程序到Firebase hosting。为了使这个过程自动化，我们使用位桶流水线。</p><p id="202e" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">在之前的文章中，我已经演示了使用Bitbucket管道的CI/CD，用于1) <a class="ae kw" rel="noopener" href="/quick-code/ci-cd-of-cakephp-with-bitbucket-pipelines-shared-hosting-server-via-ftp-9815f4e59dc1"> CakePHP通过FTP到共享主机服务器</a>和2) <a class="ae kw" rel="noopener" href="/quick-code/ci-cd-of-cakephp-with-bitbucket-pipelines-heroku-81005ae70ff8"> CakePHP到Heroku </a>。</p><h1 id="ddcf" class="ji jj hh bd jk jl jm jn jo jp jq jr js in jt io ju iq jv ir jw it jx iu jy jz bi translated">概述</h1><ol class=""><li id="9cb8" class="lj lk hh kc b kd ke kg kh kj mc kn md kr me kv mf lp lq lr bi translated">创建位存储库</li><li id="4530" class="lj lk hh kc b kd ls kg lt kj lu kn lv kr lw kv mf lp lq lr bi translated">创建Angular 6演示应用程序</li><li id="1de6" class="lj lk hh kc b kd ls kg lt kj lu kn lv kr lw kv mf lp lq lr bi translated">创建Firebase项目</li><li id="2c14" class="lj lk hh kc b kd ls kg lt kj lu kn lv kr lw kv mf lp lq lr bi translated">配置位桶管道</li></ol><h1 id="ef17" class="ji jj hh bd jk jl jm jn jo jp jq jr js in jt io ju iq jv ir jw it jx iu jy jz bi translated">先决条件</h1><ul class=""><li id="a2db" class="lj lk hh kc b kd ke kg kh kj mc kn md kr me kv lo lp lq lr bi translated"><a class="ae kw" href="https://bitbucket.org" rel="noopener ugc nofollow" target="_blank"> Bitbucket </a>和<a class="ae kw" href="https://firebase.google.com/" rel="noopener ugc nofollow" target="_blank"> Firebase </a>账号</li><li id="64b3" class="lj lk hh kc b kd ls kg lt kj lu kn lv kr lw kv lo lp lq lr bi translated">安装在本地开发机器上的<a class="ae kw" href="https://git-scm.com/" rel="noopener ugc nofollow" target="_blank"> Git </a>和<a class="ae kw" href="https://nodejs.org" rel="noopener ugc nofollow" target="_blank"> Node.js </a> 10.x</li></ul><h1 id="881f" class="ji jj hh bd jk jl jm jn jo jp jq jr js in jt io ju iq jv ir jw it jx iu jy jz bi translated">(1)创建比特桶储存库</h1><p id="7573" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">首先，我们创建一个新的<a class="ae kw" href="https://bitbucket.org/" rel="noopener ugc nofollow" target="_blank">位存储库</a>。你可以在这里找到我的演示库:<a class="ae kw" href="https://bitbucket.org/kainiklas/angular-firebase-ci-demo" rel="noopener ugc nofollow" target="_blank">https://bitbucket.org/kainiklas/angular-firebase-ci-demo</a></p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mg"><img src="../Images/c01eb0dfb7869851cff0c91edff84199.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xS-cU9n4acKcn7Or4yGOCQ.png"/></div></div><figcaption class="ly lz et er es ma mb bd b be z dx">Create new Bitbucket repository</figcaption></figure><h1 id="d401" class="ji jj hh bd jk jl jm jn jo jp jq jr js in jt io ju iq jv ir jw it jx iu jy jz bi translated">(2)初始化角度应用</h1><p id="c9a6" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">在这个演示中，我们用<a class="ae kw" href="https://angular.io/guide/quickstart" rel="noopener ugc nofollow" target="_blank"> Angular CLI </a>创建我们的Angular应用程序。如果您尚未安装CLI，请使用以下命令进行安装:</p><pre class="ix iy iz ja fd mh mi mj mk aw ml bi"><span id="ee94" class="mm jj hh mi b fi mn mo l mp mq">npm install -g @angular/cli</span></pre><p id="f844" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">如果您已经安装了旧版本的angular CLI，请使用以下命令升级到最新版本，如这里的<a class="ae kw" href="https://www.npmjs.com/package/@angular/cli" rel="noopener ugc nofollow" target="_blank">所述</a>:</p><pre class="ix iy iz ja fd mh mi mj mk aw ml bi"><span id="12a6" class="mm jj hh mi b fi mn mo l mp mq">npm uninstall -g @angular/cli<br/>npm cache verify<em class="la"><br/></em>npm install -g @angular/cli@latest</span></pre><p id="e7f0" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">然后，我们可以创建我们的角骨架应用程序:</p><pre class="ix iy iz ja fd mh mi mj mk aw ml bi"><span id="6f21" class="mm jj hh mi b fi mn mo l mp mq">ng new angular-firebase-ci-demo</span></pre><p id="efa9" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">如果您对刚刚创建的内容感兴趣，请从内置服务器开始:</p><pre class="ix iy iz ja fd mh mi mj mk aw ml bi"><span id="252b" class="mm jj hh mi b fi mn mo l mp mq">cd angular-firebase-ci-demo <br/>ng serve -o</span></pre><p id="60c7" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">该命令应该会自动启动您的浏览器并导航到<a class="ae kw" href="http://localhost:4200/" rel="noopener ugc nofollow" target="_blank"> http://localhost:4200/ </a>。</p><h2 id="0a9b" class="mm jj hh bd jk mr ms mt jo mu mv mw js kj mx my ju kn mz na jw kr nb nc jy nd bi translated">使用木偶师配置测试</h2><p id="079d" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">默认的测试行为是启动Chrome并执行测试。在我们的CI环境中，我们没有安装Chrome，我们也不想启动基于安贵的应用程序。因此，我们使用了包含chrome的木偶剧包，然后我们可以在无头模式下启动，这意味着没有GUI。</p><p id="9c48" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">首先，我们包含了对木偶师的开发依赖性:</p><pre class="ix iy iz ja fd mh mi mj mk aw ml bi"><span id="9a4f" class="mm jj hh mi b fi mn mo l mp mq">npm install --save-dev puppeteer</span></pre><p id="5150" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">然后我们配置我们的<code class="du ne nf ng mi b">karma.conf.js</code>用ChromeHeadless代替Chrome。此外，我们需要使用<code class="du ne nf ng mi b">— no-sandbox</code>选项，让它在我们的CI环境中工作。此外，我们只想让测试用例运行一次，我们可以用标志<code class="du ne nf ng mi b">singleRun</code>进行配置。</p><pre class="ix iy iz ja fd mh mi mj mk aw ml bi"><span id="46ba" class="mm jj hh mi b fi mn mo l mp mq"># ./angular-firebase-ci-demo/<strong class="mi hi">src/karma.conf.js</strong></span><span id="441a" class="mm jj hh mi b fi nh mo l mp mq"><strong class="mi hi">const puppeteer = require('puppeteer');<br/>process.env.CHROME_BIN = puppeteer.executablePath();</strong></span><span id="5985" class="mm jj hh mi b fi nh mo l mp mq">module.exports = function (config) {<br/>  config.set({<br/>    (...)<br/>    <strong class="mi hi">browsers: [<br/>      'ChromeHeadlessNoSandbox'<br/>    ],<br/>    customLaunchers: {<br/>      ChromeHeadlessNoSandbox: {<br/>        base: 'ChromeHeadless',<br/>        flags: ['--no-sandbox']<br/>      }<br/>    },<br/>    singleRun: true<br/>  </strong>});<br/>};</span></pre><h2 id="458d" class="mm jj hh bd jk mr ms mt jo mu mv mw js kj mx my ju kn mz na jw kr nb nc jy nd bi translated">提交到位桶</h2><p id="acd7" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">现在我们可以在Bitbucket中与远程存储库共享我们的本地代码。您可以在Bitbucket存储库概述中找到git URL。对我来说，这些命令看起来像这样:</p><pre class="ix iy iz ja fd mh mi mj mk aw ml bi"><span id="5558" class="mm jj hh mi b fi mn mo l mp mq"># switch to project folder in ./angular-firebase-ci-demo</span><span id="20a4" class="mm jj hh mi b fi nh mo l mp mq">git remote add origin <a class="ae kw" href="https://kainiklas@bitbucket.org/kainiklas/angular-firebase-ci-demo.git" rel="noopener ugc nofollow" target="_blank">https://kainiklas@bitbucket.org/kainiklas/angular-firebase-ci-demo.git</a></span><span id="f7bb" class="mm jj hh mi b fi nh mo l mp mq">git push origin master</span></pre><p id="233f" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">代码现在应该在我们的Bitbucket存储库中可见了。</p><h1 id="7623" class="ji jj hh bd jk jl jm jn jo jp jq jr js in jt io ju iq jv ir jw it jx iu jy jz bi translated">(3)创建Firebase应用程序</h1><p id="f3a3" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">在https://console.firebase.google.com/的<a class="ae kw" href="https://console.firebase.google.com/" rel="noopener ugc nofollow" target="_blank">上创建一个新项目。</a></p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es ni"><img src="../Images/b9b55322bf150c870e570f2ebc2f3cee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*eXp6uegaaXkKZfDe9lM1hw.png"/></div><figcaption class="ly lz et er es ma mb bd b be z dx">New Firebase Project</figcaption></figure><h2 id="f69f" class="mm jj hh bd jk mr ms mt jo mu mv mw js kj mx my ju kn mz na jw kr nb nc jy nd bi translated">安装Firebase工具</h2><p id="ee12" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">因为我们想要部署到firebase，所以我们需要<a class="ae kw" href="https://www.npmjs.com/package/firebase-tools" rel="noopener ugc nofollow" target="_blank"> firebase工具</a>。让我们将它们添加到我们的开发依赖项中，并在我们的机器上全局安装它们:</p><pre class="ix iy iz ja fd mh mi mj mk aw ml bi"><span id="bd72" class="mm jj hh mi b fi mn mo l mp mq">npm install --save-dev firebase-tools<br/>npm install -g firebase-tools</span></pre><h2 id="d6ca" class="mm jj hh bd jk mr ms mt jo mu mv mw js kj mx my ju kn mz na jw kr nb nc jy nd bi translated">添加构建和部署命令</h2><p id="a197" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">在我们的<code class="du ne nf ng mi b">package.json</code>中，我们添加了以下两个用于生产构建和部署的命令。我们将在稍后的管道中使用它们。</p><pre class="ix iy iz ja fd mh mi mj mk aw ml bi"><span id="97e9" class="mm jj hh mi b fi mn mo l mp mq">"scripts": {<br/>  <!-- -->"build-prod": "ng build --prod",<br/>  "deploy": "firebase deploy --token $FIREBASE_TOKEN --non-interactive"<br/>},</span></pre><h2 id="c457" class="mm jj hh bd jk mr ms mt jo mu mv mw js kj mx my ju kn mz na jw kr nb nc jy nd bi translated">添加Firebase的配置</h2><p id="a7d8" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">常规Firebase项目配置:</p><pre class="ix iy iz ja fd mh mi mj mk aw ml bi"><span id="c37e" class="mm jj hh mi b fi mn mo l mp mq"># ./angular-firebase-ci-demo/<strong class="mi hi">.firebaserc</strong></span><span id="720f" class="mm jj hh mi b fi nh mo l mp mq">{<br/>  "projects": {<br/>    "default": "angular-firebase-ci-demo"<br/>  }<br/>}</span></pre><p id="0b09" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">Firebase托管配置。让我们只部署在生产构建期间创建的dist文件夹中的内容。</p><pre class="ix iy iz ja fd mh mi mj mk aw ml bi"><span id="da1b" class="mm jj hh mi b fi mn mo l mp mq"># ./angular-firebase-ci-demo/<strong class="mi hi">firebase.json</strong></span><span id="faa1" class="mm jj hh mi b fi nh mo l mp mq">{<br/>  "hosting": {<br/>    "public": "dist/angular-firebase-ci-demo",<br/>    "rewrites": [<br/>      {<br/>        "source": "**",<br/>        "destination": "/index.html"<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><h2 id="08f2" class="mm jj hh bd jk mr ms mt jo mu mv mw js kj mx my ju kn mz na jw kr nb nc jy nd bi translated">提交Firebase配置</h2><p id="ce07" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">我们现在需要将所有变更推送到我们的主分支。</p><pre class="ix iy iz ja fd mh mi mj mk aw ml bi"><span id="6ef5" class="mm jj hh mi b fi mn mo l mp mq">git add -A<br/>git commit -m "firebase config"<br/>git commit git push origin master</span></pre><h1 id="7aec" class="ji jj hh bd jk jl jm jn jo jp jq jr js in jt io ju iq jv ir jw it jx iu jy jz bi translated">(4)设置位桶流水线</h1><h2 id="3673" class="mm jj hh bd jk mr ms mt jo mu mv mw js kj mx my ju kn mz na jw kr nb nc jy nd bi translated">配置管道</h2><p id="b589" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">我们在<a class="ae kw" href="https://bitbucket.org" rel="noopener ugc nofollow" target="_blank">位桶</a>上导航到我们的存储库，并在左侧导航菜单中导航到<strong class="kc hi">管道</strong>。我们第一次点击它时，可能需要一些时间，直到我们看到一些东西(大约5-10秒)。我们向下滚动页面并选择JavaScript。用以下内容替换自动生成的<code class="du ne nf ng mi b">bitbucket-pipelines.yml</code>文件的内容，并提交文件:</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="nj nk l"/></div></figure><p id="574a" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated"><em class="la">注意:</em>我们会得到一些错误，因为我们还没有配置环境变量。</p><h2 id="fbdb" class="mm jj hh bd jk mr ms mt jo mu mv mw js kj mx my ju kn mz na jw kr nb nc jy nd bi translated">已配置管道的说明</h2><p id="5060" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">通过<code class="du ne nf ng mi b">image: node:10</code>,我们告诉管道哪个docker容器应该用于构建。对于角度6，我们需要节点10.x。</p><p id="031a" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">使用<code class="du ne nf ng mi b">branches: master:</code>我们定义，一旦我们将代码签入主分支，管道就应该运行。</p><p id="a2d5" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">使用<code class="du ne nf ng mi b">caches: -node</code>,我们缓存所有在依赖项安装期间下载的节点模块。这将加快后续运行的速度。</p><p id="d8d2" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">为了跟踪部署，我们使用命令<code class="du ne nf ng mi b">deployment: production</code>，该命令告诉Bitbucket将该管道视为生产部署。点击此处了解关于<a class="ae kw" href="https://confluence.atlassian.com/bitbucket/bitbucket-deployments-940695276.html" rel="noopener ugc nofollow" target="_blank">位存储桶部署</a>的更多信息。</p><p id="fb1d" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">最后一部分是<code class="du ne nf ng mi b">script:</code>部分的脚本。</p><ol class=""><li id="d153" class="lj lk hh kc b kd lb kg lc kj ll kn lm kr ln kv mf lp lq lr bi translated">安装<code class="du ne nf ng mi b">package.json</code>中描述的所有所需模块</li><li id="8283" class="lj lk hh kc b kd ls kg lt kj lu kn lv kr lw kv mf lp lq lr bi translated">按照<a class="ae kw" href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/troubleshooting.md" rel="noopener ugc nofollow" target="_blank">木偶师的故障排除文档</a>中所述，安装所需的库以在docker映像上运行chrome</li><li id="99bc" class="lj lk hh kc b kd ls kg lt kj lu kn lv kr lw kv mf lp lq lr bi translated">执行测试用例</li><li id="f155" class="lj lk hh kc b kd ls kg lt kj lu kn lv kr lw kv mf lp lq lr bi translated">构建生产就绪工件</li><li id="ba29" class="lj lk hh kc b kd ls kg lt kj lu kn lv kr lw kv mf lp lq lr bi translated">将工件部署到Firebase</li></ol><p id="07da" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">如果任何命令失败，整个管道都会失败。这意味着，失败的测试将阻止部署到服务器上(这很好，因为我们不想中断生产)。</p><h2 id="830f" class="mm jj hh bd jk mr ms mt jo mu mv mw js kj mx my ju kn mz na jw kr nb nc jy nd bi translated">在Bitbucket中设置环境变量</h2><p id="0453" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">在我们的管道脚本中，我们定义了环境变量<code class="du ne nf ng mi b">FIREBASE_TOKEN</code>,该变量用于针对Firebase对我们进行身份验证。我们通过在命令行上键入以下命令来获取令牌:</p><pre class="ix iy iz ja fd mh mi mj mk aw ml bi"><span id="3225" class="mm jj hh mi b fi mn mo l mp mq">firebase login:ci</span></pre><p id="4f6a" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">我们在<strong class="kc hi">设置&gt;管道&gt;存储库变量</strong>中放入out管道的令牌。</p><p id="4ec0" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated"><strong class="kc hi">重要提示:</strong>切勿在git中存储密码或其他机密信息。相反，利用例如安全存储的环境变量作为密码。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nl"><img src="../Images/1fe85fba55aa53555c02db2d5a9788a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IXMdXIpEv4CagvsaYg0P9Q.png"/></div></div></figure><p id="b511" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">现在提交master或重新运行管道，您将看到一个到Firebase的部署。</p><h2 id="afa6" class="mm jj hh bd jk mr ms mt jo mu mv mw js kj mx my ju kn mz na jw kr nb nc jy nd bi translated">替代Docker图像</h2><p id="a86b" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">该管道目前正被一个为chrome安装所需库的声明“毒害”。如果没有这些库，chrome将无法运行，并出现以下错误:</p><pre class="ix iy iz ja fd mh mi mj mk aw ml bi"><span id="dbb6" class="mm jj hh mi b fi mn mo l mp mq">Cannot start ChromeHeadless /opt/atlassian/pipelines/agent/build/node_modules/puppeteer/.local-chromium/linux-609904/chrome-linux/chrome: error while loading shared libraries: libX11-xcb.so.1: cannot open shared object file: No such file or directory</span></pre><p id="3c43" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">更干净的方法是使用包含这些库的自定义docker容器。这样维护起来更友好，并且加快了流水线的速度。在<a class="ae kw" href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/troubleshooting.md" rel="noopener ugc nofollow" target="_blank">木偶师的故障排除文档</a>中描述了这种情况。</p><h1 id="a2c4" class="ji jj hh bd jk jl jm jn jo jp jq jr js in jt io ju iq jv ir jw it jx iu jy jz bi translated">最后的想法</h1><p id="bedd" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">此外，我们可以定义在代码被合并到一个特定的分支之后，我们所部署的测试或测试环境。</p><h1 id="7201" class="ji jj hh bd jk jl jm jn jo jp jq jr js in jt io ju iq jv ir jw it jx iu jy jz bi translated">想多读点？</h1><p id="a798" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">订阅我的<a class="ae kw" href="https://mailchi.mp/7f46c21dfc63/better-software-architect" rel="noopener ugc nofollow" target="_blank"> <strong class="kc hi">现代软件架构</strong> </a>时事通讯。增长您的技能，成为更好的软件架构师。</p><p id="dbfa" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated">支持我的工作，看看我的书“<a class="ae kw" href="http://bit.ly/betterSoftwareArchitect" rel="noopener ugc nofollow" target="_blank">成为一个更好的软件架构师——实践经验中的行动和见解</a>”。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><a href="http://bit.ly/betterSoftwareArchitect"><div class="er es nm"><img src="../Images/7e76c94cfed58c19d8ba1ac7cf2ced66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A5DjoyQ07_MNk6W1FUrZNw.png"/></div></a><figcaption class="ly lz et er es ma mb bd b be z dx"><a class="ae kw" href="http://bit.ly/betterSoftwareArchitect" rel="noopener ugc nofollow" target="_blank">Become a Better Software Architect — Actions and insights from practical experience</a></figcaption></figure></div><div class="ab cl nn no go np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ha hb hc hd he"><p id="b7f1" class="pw-post-body-paragraph ka kb hh kc b kd lb ii kf kg lc il ki kj le kl km kn lg kp kq kr li kt ku kv ha bi translated"><em class="la">原载于2018年12月14日</em><a class="ae kw" href="https://kai-niklas.de/160/ci-cd-with-angular-6-firebase-bitbucket-pipelines/" rel="noopener ugc nofollow" target="_blank"><em class="la">kai-niklas . de</em></a><em class="la">。</em></p></div></div>    
</body>
</html>