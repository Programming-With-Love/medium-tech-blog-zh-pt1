<html>
<head>
<title>How Pinterest runs Kafka at scale</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pinterest如何规模化经营卡夫卡</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/how-pinterest-runs-kafka-at-scale-ff9c6f735be?source=collection_archive---------0-----------------------#2018-11-27">https://medium.com/pinterest-engineering/how-pinterest-runs-kafka-at-scale-ff9c6f735be?source=collection_archive---------0-----------------------#2018-11-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="216d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">杨宇| Pinterest工程师，数据工程</p><p id="0be3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest在云中运行最大的Kafka部署之一。我们广泛使用<a class="ae jc" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Kafka </a>作为消息总线来传输数据和支持实时流媒体服务，最终帮助全球超过2.5亿Pinners发现和做他们喜欢的事情。</p><p id="cd64" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正如在<a class="ae jc" rel="noopener" href="/@Pinterest_Engineering/scalable-and-reliable-data-ingestion-at-pinterest-b921c2ee8754">早先的帖子</a>中提到的，我们使用Kafka将数据传输到我们的数据仓库，包括像印象、点击、特写和重复这样的关键事件。我们还使用Kafka来传输我们内部服务的可见性指标。如果与指标相关的Kafka集群有任何故障，我们就无法准确地监控我们的服务或生成发出问题信号的警报。在实时流媒体方面，Kafka用于支持许多流媒体应用程序，如新鲜内容索引和推荐、垃圾邮件检测和过滤、实时广告商预算计算等。</p><p id="28e3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们已经在2018年<a class="ae jc" href="https://kafka-summit.org/kafka-summit-san-francisco-2018/schedule/" rel="noopener ugc nofollow" target="_blank"> Kafka峰会</a>上分享了关于<a class="ae jc" href="https://www.confluent.io/kafka-summit-sf18/pinterests-story-of-streaming-hundreds-of-terabytes" rel="noopener ugc nofollow" target="_blank">使用Kafka </a>增量db摄取和<a class="ae jc" href="https://www.confluent.io/kafka-summit-sf18/building-pinterest-real-time-ads-platform-using-kafka-streams" rel="noopener ugc nofollow" target="_blank">使用kafka streams </a>构建实时广告平台的经验。亚马逊网络服务上运行着&gt; 2，000个代理，每天传输&gt;8000亿条消息和&gt;1.2 Pb，在高峰时段每秒处理&gt; 1，500万条消息，我们经常被问到我们的Kafka设置以及如何在云中可靠地运行Kafka。我们借此机会分享我们的经验。</p><p id="2516" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> Pinterest卡夫卡设置</strong></p><p id="df40" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">图1显示了Pinterest Kafka服务的设置。目前我们在AWS的三个地区有Kafka。大多数卡夫卡经纪人都在美国东部1区。我们在美国东部-2和欧盟西部-1的足迹较小。我们使用MirrorMaker在这三个区域之间传输数据。在每个区域，我们将代理分布在多个集群中，以实现主题级隔离。因此，一个集群故障只会影响有限数量的主题。我们将每个集群的最大规模限制为200个代理。</p><p id="169b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们目前使用d2.2xlarge作为默认的代理实例。d 2.2x大型实例类型适用于大多数Pinterest工作负载。我们还有一些小型集群使用d 2.8 x大型实例进行高扇出读取。在选择使用本地存储的d2实例之前，我们尝试对Kafka工作负载使用弹性块存储st1(吞吐量优化硬盘)。我们发现使用本地存储的d2实例的性能优于EBS st1存储。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/56e8f3fc993329b3050b90f75bb9eed3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*seMzSI-ZmVyWpk1YGMBloQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx"><em class="jt">Figure 1. Pinterest Kafka setup</em></figcaption></figure><p id="2609" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们将<em class="ju">default . replication . factor</em>设置为3，以防止一个集群中出现最多两个代理故障。截至2018年11月，AWS <a class="ae jc" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/placement-groups.html#placement-groups-spread" rel="noopener ugc nofollow" target="_blank">分布放置组</a>将每组每个可用性区域的运行实例限制为7个。由于这一限制，我们无法利用分布放置组来保证将副本分配给同一可用性分区中的不同物理主机。相反，我们将每个Kafka集群中的代理分布在三个可用性区域中，并确保每个主题分区的副本分布在可用性区域中，以承受每个集群最多两个代理故障。</p><p id="a7fa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">卡夫卡集群自愈</strong></p><p id="970f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">随着数以千计的代理在云中运行，我们几乎每天都有代理失败。处理代理故障需要手工操作。这大大增加了团队的运营开销。2017年，我们构建并开源了<a class="ae jc" href="https://github.com/pinterest/doctorkafka" rel="noopener ugc nofollow" target="_blank"> DoctorKafka </a>，这是一项Kafka运营自动化服务，用于在运营自动化的代理故障期间执行分区重新分配。</p><p id="5d2c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">事实证明，仅仅重新分配分区是不够的。2018年1月，我们遇到了由于硬件降级而仅通过分区重新分配无法修复的代理故障。当底层物理机降级时，代理会陷入意外的糟糕状态。尽管DoctorKafka可以将故障代理上的主题分区分配给其他代理，但依赖服务的生产者和消费者仍可能试图与故障或降级的代理对话，从而导致依赖服务出现问题。快速替换失败的经纪人对于保证Kafka服务质量非常重要。</p><p id="c402" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Q1 2018中，我们改进了DoctorKafka的代理替换功能，允许它使用用户提供的脚本自动替换失败的代理，这帮助我们保护Kafka集群免受不可预见的问题。在短时间内更换过多的代理会导致数据丢失，因为我们的集群只存储三个数据副本。为了解决这个问题，我们在DoctorKafka中构建了一个速率限制特性，允许它在一段时间内只为一个集群替换一个代理。</p><p id="96f7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">还值得注意的是，<a class="ae jc" href="https://docs.aws.amazon.com/cli/latest/reference/ec2/assign-private-ip-addresses.html" rel="noopener ugc nofollow" target="_blank"> AWS ec2 api </a>允许用户替换实例，同时保持主机名和IP地址不变，这使我们能够最大限度地减少代理替换对依赖服务的影响。从那以后，我们已经能够将与Kafka相关的警报减少95%,并在最少人工干预的情况下保持&gt; 2000个经纪人在云中运行。在DoctorKafka中，我们的代理替换配置见<a class="ae jc" href="https://github.com/pinterest/doctorkafka/blob/master/drkafka/config/doctorkafka.properties#L51" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="970a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">与Kafka开源社区合作</strong></p><p id="c550" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Kafka开源社区一直在积极开发新功能和修复已知问题。我们建立了一个内部构建，在发布分支中不断地引入最新的Kafka变更，并以每月一次的节奏将它们推向生产。</p><p id="ab08" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们自己也改进了Kafka，并将这些变化反馈给了社区。最近，Pinterest的工程师对卡夫卡做出了以下贡献:</p><ul class=""><li id="2920" class="jv jw hh ig b ih ii il im ip jx it jy ix jz jb ka kb kc kd bi translated"><a class="ae jc" href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-91+Provide+Intuitive+User+Timeouts+in+The+Producer" rel="noopener ugc nofollow" target="_blank"> KIP-91 </a>向Kafka producer添加delivery.timeout.ms</li><li id="b7af" class="jv jw hh ig b ih ke il kf ip kg it kh ix ki jb ka kb kc kd bi translated"><a class="ae jc" href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-245%3A+Use+Properties+instead+of+StreamsConfig+in+KafkaStreams+constructor" rel="noopener ugc nofollow" target="_blank"> KIP-245 </a>在KafkaStreams构造函数中使用属性而不是StreamsConfig</li><li id="a675" class="jv jw hh ig b ih ke il kf ip kg it kh ix ki jb ka kb kc kd bi translated"><a class="ae jc" href="https://issues.apache.org/jira/browse/KAFKA-6896" rel="noopener ugc nofollow" target="_blank">KAFKA-6896</a>KAFKA流中的出口生产者和消费者指标</li><li id="f02b" class="jv jw hh ig b ih ke il kf ip kg it kh ix ki jb ka kb kc kd bi translated"><a class="ae jc" href="https://issues.apache.org/jira/browse/KAFKA-7023" rel="noopener ugc nofollow" target="_blank"> KAFKA-7023 </a>自定义RocksDBConfigSettters后调用Move prepareForBulkLoad()</li><li id="ee43" class="jv jw hh ig b ih ke il kf ip kg it kh ix ki jb ka kb kc kd bi translated"><a class="ae jc" href="https://issues.apache.org/jira/browse/KAFKA-7103" rel="noopener ugc nofollow" target="_blank"> KAFKA-7103 </a>在初始化期间对RocksDBSegmentedBytesStore使用批量装载</li></ul><p id="60cf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们还提出了几个正在讨论中的Kafka改进方案:</p><ul class=""><li id="1d4d" class="jv jw hh ig b ih ii il im ip jx it jy ix jz jb ka kb kc kd bi translated"><a class="ae jc" href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-276+Add+StreamsConfig+prefix+for+different+consumers" rel="noopener ugc nofollow" target="_blank"> KIP-276 </a>为不同的消费者添加配置前缀</li><li id="e903" class="jv jw hh ig b ih ke il kf ip kg it kh ix ki jb ka kb kc kd bi translated"><a class="ae jc" href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-300%3A+Add+Windowed+KTable+API+in+StreamsBuilder" rel="noopener ugc nofollow" target="_blank"> KIP-300 </a>添加窗口式KTable API</li><li id="93f5" class="jv jw hh ig b ih ke il kf ip kg it kh ix ki jb ka kb kc kd bi translated"><a class="ae jc" href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-345%3A+Introduce+static+membership+protocol+to+reduce+consumer+rebalances" rel="noopener ugc nofollow" target="_blank"> KIP-345 </a>通过静态会员资格减少消费者再平衡</li></ul><p id="2764" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">下一步</strong></p><p id="c2eb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">尽管我们已经对Pinterest的Kafka服务进行了改进，但要将服务提升到一个新的水平，还有许多有趣的问题需要解决。例如，我们将在Pinterest探索Kubernetes作为卡夫卡的抽象层。</p><p id="c88c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们目前正在研究为Kafka集群使用两个可用性区域来降低区域间数据传输成本，因为两个可用性区域同时出现故障的可能性很低。AWS最新一代实例类型经过EBS优化，拥有专用的EBS带宽和比前几代更好的网络性能。因此，我们将评估这些利用EBS实现更快Kafka broker恢复的最新实例类型。</p><p id="21a3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest engineering有许多有趣的问题需要解决，从构建可扩展、可靠和高效的基础设施到应用尖端的机器学习技术来帮助Pinners发现和做他们喜欢的事情。查看<a class="ae jc" href="https://careers.pinterest.com/careers" rel="noopener ugc nofollow" target="_blank">我们开放的工程职位并加入我们</a>！</p><p id="cff2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"><em class="ju"/></strong><em class="ju">:非常感谢Henry Cai、Shawn Nguyen、yiyi Yin、裴礼泉、陈柏扬、、Robert Claire、Jayme Cox、和Ambud Sharma，他们改进了Pinterest的Kafka服务。</em></p><p id="bbd1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">附录:</strong></p><p id="8302" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">1.<strong class="ig hi"> </strong>我们对d 2.2x大型实例使用的Kafka broker设置。这里我们只列出与Kafka默认值不同的设置。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kj"><img src="../Images/4c506a74c8eeb819e45d5dab47797f08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3r59rXOWBs6pM88ZpMYT2w.png"/></div></div></figure><p id="77d8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2.以下是Pinterest Kafka java参数。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kk"><img src="../Images/b7b806a2af14f0f94786b51f07d29dfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G06mzGlUpUoJg_SEXYM2iw.png"/></div></div></figure><p id="7688" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们在Pinterest上为Kafka启用了TLS访问。从Kafka 2.0.0开始，每一个具有ssl连接的KafkaChannel需要花费~122K内存，Kafka可能会因为频繁的重新连接而积累大量未关闭的Kafka channel(详见<a class="ae jc" href="https://issues.apache.org/jira/browse/KAFKA-7304" rel="noopener ugc nofollow" target="_blank"> KAFKA-7304 </a>)。我们使用8GB的堆大小来最小化Kafka遇到长暂停GC的风险。在启用TLS之前，我们对Kafka进程使用了4GB的堆大小。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kl"><img src="../Images/732042308b65878444e59857375c252d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*11SgBX8XLRywJtXE"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx"><em class="jt">Figure 2. The size of a KafkaChannel object with an SSL connection.</em></figcaption></figure></div></div>    
</body>
</html>