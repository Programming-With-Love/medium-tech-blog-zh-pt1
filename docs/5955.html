<html>
<head>
<title>Emulating ARM architecture in OCI Cloud Shell</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在OCI云壳中模拟ARM架构</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/emulating-arm-architecture-in-oci-cloud-shell-d5774d2b95cb?source=collection_archive---------7-----------------------#2022-08-15">https://medium.com/oracledevs/emulating-arm-architecture-in-oci-cloud-shell-d5774d2b95cb?source=collection_archive---------7-----------------------#2022-08-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/e92a6d9f482841526cc9297763a4bd91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lL9WuyncGuvGFmDln4UtVg.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo by Quang Nguyen Vinh: <a class="ae it" href="https://www.pexels.com/photo/shell-on-sea-beach-6872201/" rel="noopener ugc nofollow" target="_blank">https://www.pexels.com/photo/shell-on-sea-beach-6872201/</a></figcaption></figure><h1 id="3ab4" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">OCI云壳是什么？</h1><p id="5172" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated"><a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/API/Concepts/cloudshellintro.htm" rel="noopener ugc nofollow" target="_blank"> OCI云壳</a>这么好用，这么强大，很容易想当然！在您的OCI控制台中，通过单击云壳图标(位于屏幕的右上角)可以看到它:</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div class="er es kq"><img src="../Images/516ecadb8c298818f094b7648d4738b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:256/format:webp/1*BDYtMnDZny8sWgLxAwVIjg.png"/></div><figcaption class="ip iq et er es ir is bd b be z dx">Opening OCI Cloud Shell (upper-right of OCI Console)</figcaption></figure><p id="1608" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">OCI云Shell预装了管理OCI环境并与之交互所需的大量工具和实用程序，包括:</p><ul class=""><li id="6188" class="la lb hh ju b jv kv jz kw kd lc kh ld kl le kp lf lg lh li bi translated">OCI CLI</li><li id="776d" class="la lb hh ju b jv lj jz lk kd ll kh lm kl ln kp lf lg lh li bi translated">码头工人</li><li id="b037" class="la lb hh ju b jv lj jz lk kd ll kh lm kl ln kp lf lg lh li bi translated">库贝特尔</li><li id="6282" class="la lb hh ju b jv lj jz lk kd ll kh lm kl ln kp lf lg lh li bi translated">饭桶</li><li id="72a5" class="la lb hh ju b jv lj jz lk kd ll kh lm kl ln kp lf lg lh li bi translated">将（行星）地球化（以适合人类居住）</li><li id="7bef" class="la lb hh ju b jv lj jz lk kd ll kh lm kl ln kp lf lg lh li bi translated">大蟒</li><li id="d99f" class="la lb hh ju b jv lj jz lk kd ll kh lm kl ln kp lf lg lh li bi translated">…更多！</li></ul><p id="5bb4" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">参见<a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/API/Concepts/cloudshellintro.htm" rel="noopener ugc nofollow" target="_blank"> OCI云外壳文档</a>了解更多关于这个伟大资源的内容。</p><h1 id="5e84" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">多架构测试的挑战</h1><p id="0015" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">在OCI云外壳中模拟不同的CPU架构，即ARM架构，可能是可取的(纠正，必要的)。默认情况下，OCI云壳提供了一个x86_64计算环境，您可以使用该环境与您的OCI帐户和其他资源进行交互。通过运行<em class="lo"> uname -p </em>确认这一点:</p><pre class="kr ks kt ku fd lp lq lr ls aw lt bi"><span id="4c5e" class="lu iv hh lq b fi lv lw l lx ly">cloudshell:~ (us-sanjose-1)$ uname -p<br/>x86_64<br/>cloudshell:~ (us-sanjose-1)$</span></pre><p id="44eb" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">有时候可能需要模拟arm架构，比如当您需要通过Cloud Shell构建多架构容器映像(或者专门针对ARM的容器映像)时。因为云壳与OCI紧密结合，所以它是创建一次性容器图像并上传到OCI容器注册中心的绝佳地点。因为它是x86_64架构，所以需要仿真来模拟和构建arm容器映像(或执行其他基于ARM的计算活动)。</p><blockquote class="lz ma mb"><p id="ee11" class="js jt lo ju b jv kv jx jy jz kw kb kc mc kx kf kg md ky kj kk me kz kn ko kp ha bi translated">注意:我并不提倡使用云Shell来构建生产容器映像之类的东西。这对于实验来说更有用。生产工作负载应该使用<a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/devops/using/home.htm" rel="noopener ugc nofollow" target="_blank"> OCI DevOps </a>实现自动化！再次回到我们的一次性实验用例，让我们看看如何在OCI云壳中模拟ARM</p></blockquote><p id="e0f2" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">举个简单的例子，让我们看一个在云壳中会失败的基本Dockerfile。遵循您的云Shell实例:</p><pre class="kr ks kt ku fd lp lq lr ls aw lt bi"><span id="af6f" class="lu iv hh lq b fi lv lw l lx ly">cloudshell:~ (us-sanjose-1)$ mkdir multi_arch_test<br/>cloudshell:~ (us-sanjose-1)$ cd multi_arch_test<br/>cloudshell:multi_arch_test (us-sanjose-1)$ nano Dockerfile</span></pre><p id="23db" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">将以下内容粘贴到文件中:</p><pre class="kr ks kt ku fd lp lq lr ls aw lt bi"><span id="9fb6" class="lu iv hh lq b fi lv lw l lx ly">FROM container-registry.oracle.com/os/oraclelinux:8-slim<br/>RUN microdnf update<br/>CMD echo "Hello world!"</span></pre><p id="28c8" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">键入CTRL+x，键入y，然后按enter键(将文件保存为<em class="lo"> Dockerfile </em>)。</p><p id="680e" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">现在继续尝试构建容器:</p><pre class="kr ks kt ku fd lp lq lr ls aw lt bi"><span id="c6a6" class="lu iv hh lq b fi lv lw l lx ly">docker build --pull --platform arm64 -f Dockerfile -t test:v1.0.0 .</span></pre><p id="a4ce" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">你会注意到它失败了。您应该会看到如下所示的内容:</p><pre class="kr ks kt ku fd lp lq lr ls aw lt bi"><span id="3194" class="lu iv hh lq b fi lv lw l lx ly">cloudshell:multi_arch_test (us-sanjose-1)$ docker build --pull --platform arm64 -f Dockerfile -t test:v1.0.0 .<br/>Sending build context to Docker daemon  2.048kB<br/>Step 1/3 : FROM container-registry.oracle.com/os/oraclelinux:8-slim<br/>Trying to pull repository container-registry.oracle.com/os/oraclelinux ... <br/>8-slim: Pulling from container-registry.oracle.com/os/oraclelinux<br/>Digest: sha256:abc123...<br/>Status: Image is up to date for container-registry.oracle.com/os/oraclelinux:8-slim<br/> ---&gt; fe659acbc8d5<br/>Step 2/3 : RUN microdnf update<br/> ---&gt; Running in 9ec24c4a4bbc<br/>exec /bin/sh: exec format error<br/>The command '/bin/sh -c microdnf update' returned a non-zero code: 1<br/>cloudshell:multi_arch_test (us-sanjose-1)$</span></pre><p id="80ed" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">这里发生的事情是，我们试图在x86_64(又名amd64)平台上运行aarch64(又名arm64)映像(以及相关的二进制文件)。这是行不通的(不管怎么说，开箱即用)。</p><h1 id="3c2a" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">救援竞赛！</h1><p id="ed8f" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">我们的云Shell会话位于x86_64(又名amd64)环境中，但是我们需要构建/部署aarch64(又名arm64)架构。谢天谢地，我们有办法解决上面遇到的问题。像<a class="ae it" href="https://github.com/multiarch/qemu-user-static" rel="noopener ugc nofollow" target="_blank"> qemu-user-static </a>和<a class="ae it" href="https://github.com/dbhi/qus" rel="noopener ugc nofollow" target="_blank"> qus </a>这样的解决方案让我们可以模拟不同的硬件架构。让我们使用qemu-user-static，在OCI云Shell中运行以下代码:</p><pre class="kr ks kt ku fd lp lq lr ls aw lt bi"><span id="15d4" class="lu iv hh lq b fi lv lw l lx ly">docker run --rm --privileged multiarch/qemu-user-static --reset -p yes</span></pre><p id="5d1e" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">现在再次尝试构建示例容器:</p><pre class="kr ks kt ku fd lp lq lr ls aw lt bi"><span id="8fa6" class="lu iv hh lq b fi lv lw l lx ly">cloudshell:multi_arch_test (us-sanjose-1)$ docker build --pull --platform arm64 -f Dockerfile -t test:v1.0.0 .<br/>Sending build context to Docker daemon  2.048kB<br/>Step 1/3 : FROM container-registry.oracle.com/os/oraclelinux:8-slim<br/>Trying to pull repository container-registry.oracle.com/os/oraclelinux ... <br/>8-slim: Pulling from container-registry.oracle.com/os/oraclelinux<br/>Digest: sha256:abc098932...<br/>Status: Image is up to date for container-registry.oracle.com/os/oraclelinux:8-slim<br/> ---&gt; fe659acbc8d5<br/>Step 2/3 : RUN microdnf update<br/> ---&gt; Running in zyx345<br/>Downloading metadata...<br/>Downloading metadata...<br/>Package                                                  Repository           Size<br/>Upgrading:                                                                        <br/> oraclelinux-release-8:8.6-1.0.6.el8.aarch64             ol8_baseos_latest 84.1 kB<br/>   replacing oraclelinux-release-8:8.6-1.0.5.el8.aarch64                          <br/>Transaction Summary:<br/> Installing:        0 packages<br/> Reinstalling:      0 packages<br/> Upgrading:         1 packages<br/> Obsoleting:        0 packages<br/> Removing:          0 packages<br/> Downgrading:       0 packages<br/>Downloading packages...<br/>Running transaction test...<br/>Updating: oraclelinux-release;8:8.6-1.0.6.el8;aarch64;ol8_baseos_latest<br/>Cleanup: oraclelinux-release;8:8.6-1.0.5.el8;aarch64;installed<br/>Complete.<br/>Removing intermediate container abc123...<br/> ---&gt; bbc9c6bdfb14<br/>Step 3/3 : CMD echo "Hello world!"<br/> ---&gt; Running in xyz789...<br/>Removing intermediate container abc456...<br/> ---&gt; 1dea891c90b9<br/>Successfully built abc789...<br/>Successfully tagged test:v1.0.0<br/>cloudshell:multi_arch_test (us-sanjose-1)$</span></pre><p id="df1b" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">有用！我要警告你，上面的容器构建很慢……这就是它在模拟其他平台时的样子(经常会有性能上的影响),但是它<em class="lo">确实</em>工作。</p><p id="8aa2" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">现在继续运行容器(为什么不呢？):</p><pre class="kr ks kt ku fd lp lq lr ls aw lt bi"><span id="ec23" class="lu iv hh lq b fi lv lw l lx ly">docker run -it --rm test:v1.0.0</span></pre><p id="8fb2" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">您应该会看到如下所示的内容:</p><pre class="kr ks kt ku fd lp lq lr ls aw lt bi"><span id="ae78" class="lu iv hh lq b fi lv lw l lx ly">cloudshell:multi_arch_test (us-sanjose-1)$ docker run -it --rm test:v1.0.0<br/>Hello world!<br/>cloudshell:multi_arch_test (us-sanjose-1)$</span></pre><p id="1dbe" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">如果您发现想要一个干净的OCI云Shell会话，而不启用仿真，只需点击<em class="lo">查看</em>(屏幕的左上角)，然后<em class="lo">重启</em>:</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div class="er es mf"><img src="../Images/e48f14b818f07759f4093c891e8ecad4.png" data-original-src="https://miro.medium.com/v2/resize:fit:322/format:webp/1*6usN-NbY7Fq3YkHlaKodig.png"/></div><figcaption class="ip iq et er es ir is bd b be z dx">Restarting OCI Cloud Shell</figcaption></figure><p id="f673" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">请记住，云Shell会话是短暂的，在两次使用/会话之间，只有您的主目录会被保留。这意味着当您启动一个新的云Shell会话时，您需要再次启用模拟。没什么大不了的，只是要记住一些东西。</p><h1 id="548b" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">包装它</h1><p id="859e" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">OCI云壳是超级强大的，预装了许多工具，使工作与OCI超级容易。能够在Cloud Shell中模拟ARM开辟了许多可能性，可以使生活变得更加轻松，特别是在使用和支持多架构(x86_64和aarch64实例)环境时。</p></div><div class="ab cl mg mh go mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ha hb hc hd he"><p id="7f6b" class="pw-post-body-paragraph js jt hh ju b jv kv jx jy jz kw kb kc kd kx kf kg kh ky kj kk kl kz kn ko kp ha bi translated">大家来说说吧！点击，加入我们的<a class="ae it" href="https://bit.ly/devrel_slack" rel="noopener ugc nofollow" target="_blank">开发者公共松弛频道。</a></p></div></div>    
</body>
</html>