<html>
<head>
<title>How we enabled product and pricing-availability feeds as APIs for external partners</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们如何将产品和定价可用性提要作为API提供给外部合作伙伴</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/how-we-enabled-product-and-pricing-availability-feeds-as-apis-for-external-partners-a24448f976ca?source=collection_archive---------3-----------------------#2020-09-02">https://medium.com/walmartglobaltech/how-we-enabled-product-and-pricing-availability-feeds-as-apis-for-external-partners-a24448f976ca?source=collection_archive---------3-----------------------#2020-09-02</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/3d015f6e5b20f9461b329777926238f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U9w8lnYrdZdc7rVkrlmiUg.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo credit: <a class="ae it" href="https://pixabay.com/illustrations/ecommerce-online-sales-sales-1706105/" rel="noopener ugc nofollow" target="_blank">ReaxionLab</a></figcaption></figure><p id="6d86" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">作为美国最大的杂货商，沃尔玛希望顾客能够在当地商店数字化购物，甚至在选择路边取货或送货之前就计划好行程。</p><p id="1b24" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们来自子公司和OpenAPI工程团队。我们的团队致力于支持第三方整合，以推动沃尔玛的流量和转化率。我们的一个使用案例需要一个智能、高效的基础设施来处理数千家商店产品的可变性，从而有助于在未来与许多第三方整合，这些第三方可以帮助沃尔玛客户更好地将他们的生活与沃尔玛零售商整合在一起。</p><p id="2849" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在这篇文章中，我将概述我们如何将产品和价格可用性信息作为外部合作伙伴的可下载提要。有了这些API，沃尔玛的潜在客户可以在第三方出版商的应用程序/网站上为他们的本地商店发现产品，并可以直接将他们选择的商品添加到沃尔玛购物车。沃尔玛处理履行事宜，无论是路边取货还是送货。</p><h1 id="f6d0" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">概观</h1><p id="99bf" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">作为feeds APIs的一部分，我们提供了所有活动商店的产品元数据、产品定价和可用性信息的每日快照。除了快照，我们还每15分钟提供一次增量。合作伙伴的典型使用模式是使用快照来引导产品元数据和产品定价-可用性信息，然后每隔15分钟应用增量。</p><p id="01c4" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">基于Feeds的集成非常适合批量数据交换。对于单个产品的积分查询，我们提供实时定价-可用性API，可用于获取单个产品的最新数据。</p><p id="031e" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">所有的API都可以通过类别路径过滤，类别路径的列表通过我们的分类API公开。</p><h1 id="71ca" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">关键设计考虑因素</h1><p id="acab" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">以下是关键的设计考虑因素:</p><ul class=""><li id="2de9" class="kv kw hh iw b ix iy jb jc jf kx jj ky jn kz jr la lb lc ld bi translated"><em class="le">解决一些现有API中出现的带宽问题，这些API提供从本地集群下载提要。</em></li><li id="543f" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated"><em class="le">确保我们向外部合作伙伴公开的API的安全性。</em></li><li id="fb1e" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated"><em class="le">确保我们公开的数据具有适当的质量，因为任何数据差异都可能导致不正确的状态，从而导致客户的购物车出错。</em></li><li id="c2f3" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated"><em class="le">使feeds APIs成为多租户。需要多租户来确保只有给定合作伙伴可用的库存才包含在各自的feed或API中。可以把它看作是对库存信息的类别或项目级访问控制。</em></li><li id="2e8f" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated"><em class="le">对管道进行监控和报警，以确保管道运行没有任何问题。</em></li><li id="33ca" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated"><em class="le">让提要可以按类别查询。</em></li><li id="052a" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated"><em class="le">让合作伙伴的入职流程更加轻松。</em></li></ul><h1 id="d465" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">快照馈送API体系结构</h1><p id="60ca" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">快照馈送提供给定一天的产品目录元数据和产品定价-可用性信息的快照。以下是相同的高级架构:</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lk"><img src="../Images/f51ef2b01cda31ff19794279385ae263.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gJ6-Jyz1F3iSL3s8gMDfCQ.png"/></div></div></figure><p id="f27d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">产品目录和定价可用性数据是从许多管理库存信息的上游系统中收集的。几个气流火花作业收集上游数据，并在配置单元表中转换成一致的规范化表示。</p><p id="7e78" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">该系统的早期版本(具有部分功能)驻留在内部托管的Hadoop部署中。有趣的是，随着系统利用GCP和优化Spark作业，我们观察到了显著的性能改善——我们观察到，由于在GCP运行的管道和优化的Spark作业，处理时间减少了75%。</p><p id="3c1d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Google云存储被用作向外部合作伙伴公开的提要的存储层。数据存储在分层结构中，并按categoryId(给定产品所属类别的标识符)进行分区。基于类别的分区允许我们利用GCP存储访问控制来实施按合作伙伴的库存筛选—只有为给定合作伙伴启用的类别位置才会向该合作伙伴公开。</p><p id="ca49" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当合作伙伴对提要进行API调用时，会根据合作伙伴的配置为提要数据生成一个可下载的google云存储签名url，并在响应中返回。合作伙伴可以从google云存储签名的url下载提要数据。这解决了我们在从本地集群下载提要时遇到的带宽问题。通过在API网关启用必要的身份验证和授权机制，以及通过为数据馈送提供google云存储签名的url(该URL在预配置的时间后过期),可以保证馈送API的安全性。</p><p id="222a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">以下是google云存储签名url的参考文档。</p><div class="lp lq ez fb lr ls"><a href="https://cloud.google.com/storage/docs/access-control/signed-urls" rel="noopener  ugc nofollow" target="_blank"><div class="lt ab dw"><div class="lu ab lv cl cj lw"><h2 class="bd hi fi z dy lx ea eb ly ed ef hg bi translated">已签名的网址|云存储|谷歌云</h2><div class="lz l"><h3 class="bd b fi z dy lx ea eb ly ed ef dx translated">本页概述了已签名的URL，您可以使用这些URL向中的任何人授予有时间限制的资源访问权限…</h3></div><div class="ma l"><p class="bd b fp z dy lx ea eb ly ed ef dx translated">cloud.google.com</p></div></div><div class="mb l"><div class="mc l md me mf mb mg in ls"/></div></div></a></div><p id="b137" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果任何Dag中存在任何故障，在气流中运行的监控和警报管道将发送松弛/电子邮件警报。</p><h2 id="5a01" class="mh jt hh bd ju mi mj mk jy ml mm mn kc jf mo mp kg jj mq mr kk jn ms mt ko mu bi translated">作为快照数据质量检查的一部分，我们执行以下操作:</h2><ul class=""><li id="261b" class="kv kw hh iw b ix kq jb kr jf mv jj mw jn mx jr la lb lc ld bi translated"><em class="le">如果百分比差异超过预先配置的阈值，则生成的数据中的任何异常都会发出警报。</em></li><li id="ea25" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated"><em class="le">我们还确保馈送文件具有正确的格式、模式，以及是否存在所有必需的值，作为数据质量检查的一部分。随着时间的推移，我们将观察趋势，希望在这一数据质量检查管道的基础上建立更多的功能。</em></li></ul><h1 id="1467" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">Delta feed API架构</h1><p id="db66" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">增量提要API提供了产品定价-可用性信息的增量。可下载的feed文件每小时转储一次，转储每15分钟更新一次。高级架构如下所示:</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es my"><img src="../Images/cf9b81a2cce1af5a4a104583a2605dd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hDMJMlDPR6T9NI12uWyM3g.png"/></div></div></figure><p id="7d29" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">三角洲输送管道完全在GCP境内运行。我们听取一系列Kafka的上游话题，以确定产品的定价-可用性。dataproc集群中运行的Spark结构化流作业用于监听kafka主题，并将转换后的数据存储在BigQuery的基表中。具有增量管道的AirFlow DAG每15分钟运行一次，增量是通过对BigQuery中的基本表和快照表运行sql查询获得的，并存储回BigQuery中的增量表。</p><p id="1da5" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">从BigQuery查询增量，每15分钟更新一次每个合作伙伴的可下载提要。增量也存储在基于categoryId的分层结构中，并且可以针对每个categoryId进行查询。</p><p id="0e93" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当合作伙伴查询增量时，会提供一个可下载的google云存储url，类似于snapshot feed架构中描述的内容。合作伙伴还可以从特定的日期/小时获取每日/每小时的增量。</p><p id="f3c7" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">监控和警报可确保流作业和气流中的增量管道持续运行，并且增量生成没有任何延迟。对于任何故障/延迟，都会提供松弛/电子邮件提醒。监控流式作业的调度程序会在作业停止时自动重新启动流式作业。</p><h2 id="e518" class="mh jt hh bd ju mi mj mk jy ml mm mn kc jf mo mp kg jj mq mr kk jn ms mt ko mu bi translated">作为增量数据质量检查的一部分，我们执行以下操作:</h2><ul class=""><li id="6b01" class="kv kw hh iw b ix kq jb kr jf mv jj mw jn mx jr la lb lc ld bi translated"><em class="le">每15分钟运行一次的数据质量检查将我们生成的增量与实时价格-可用性API进行比较，并提醒任何发现的差异。这有助于我们主动排除任何数据差异，并在需要时应用修复。</em></li><li id="5a0a" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated"><em class="le">我们每天从BigQuery生成一次deltas表的快照，并将其与上游表进行比较，并警告任何发现的差异。这样做的目的是对差异进行故障排除，并在需要时将不匹配应用回BigQuery增量表。</em></li><li id="3431" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated"><em class="le">我们还确保deltas feed文件具有正确的格式、模式，以及是否存在所有必需的值，作为数据质量检查的一部分。随着时间的推移，我们将观察趋势，希望在这一数据质量检查管道的基础上建立更多的功能。</em></li></ul><h1 id="fef3" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">结论</h1><ul class=""><li id="b052" class="kv kw hh iw b ix kq jb kr jf mv jj mw jn mx jr la lb lc ld bi translated">进料管道的一个非常重要的部分是确保所提供的进料数据尽可能准确。通过与各种上游团队讨论，制定适当的设计帮助我们实现了这一目标。</li><li id="40f6" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated">一个可重复使用的管道监控和警报框架帮助我们确保管道运行没有任何问题。</li><li id="9333" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated">数据质量检查层帮助我们识别我们作为馈送的一部分生成的数据中的任何差异，并采取必要的措施。</li><li id="81c0" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated">利用GCP运行我们的数据管道和优化的Spark作业也有助于加快我们的最终快照生成，整个过程在2小时内完成。</li><li id="4ef4" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated">利用GCP提供可下载的提要(带有google云存储签名的URL)帮助我们解决了从内部基础设施下载提要时遇到的一些带宽问题。</li><li id="65f7" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated">为了确保向外部合作伙伴公开的API的安全性，我们考虑了一些重要因素，包括在API gateway和google云存储签名的URL上为API启用必要的身份验证和授权机制，用于在预配置时间后过期的数据馈送。</li><li id="6fd0" class="kv kw hh iw b ix lf jb lg jf lh jj li jn lj jr la lb lc ld bi translated">通过使用基于API的方法来提供提要，新合作伙伴的加入变得更加容易。</li></ul></div></div>    
</body>
</html>