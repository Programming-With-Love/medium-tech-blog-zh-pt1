<html>
<head>
<title>Open-sourcing Pinrepo, the Pinterest artifact repository</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开源Pinrepo，Pinterest工件库</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/open-sourcing-pinrepo-the-pinterest-artifact-repository-6ebfe5917bcb?source=collection_archive---------2-----------------------#2015-08-06">https://medium.com/pinterest-engineering/open-sourcing-pinrepo-the-pinterest-artifact-repository-6ebfe5917bcb?source=collection_archive---------2-----------------------#2015-08-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="4c34" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">宋宝刚| Pinterest工程主管，云工程</p><p id="24ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Pinterest，我们虔诚地实践持续集成。我们在主线中构建每一个代码提交，这反过来每天产生大量构建工件。我们不仅需要可靠地存储这些工件，还需要以一致的性能高效地服务它们，以扩展工程团队并确保开发人员的生产力。今天，随着<a class="ae jc" href="https://github.com/pinterest/pinrepo" rel="noopener ugc nofollow" target="_blank"> Pinrepo </a>的发布，我们正在开源我们的工作，这是一个高度可扩展的解决方案，用于存储和服务构建工件(由构建过程产生的二进制文件和元数据)，如debian包、maven jars和pypi包。</p><p id="65da" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinrepo功能:</p><ul class=""><li id="69c3" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">简单:在AWS S3中发布和存储构建工件，并使用Nginx反向代理服务</li><li id="dfcf" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">可扩展:轻松添加其他格式支持，如RPM</li><li id="e20a" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">可靠:高可用性nginx集群和AWS S3服务</li><li id="19de" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">可扩展:nginx层可以水平扩展，因为AWS S3后端是高度可扩展的</li><li id="0f94" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">开发操作系统友好型:已投入生产运行8个月，几乎无需维护</li></ul><h2 id="30b6" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">克服扩展挑战</h2><p id="b67d" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">Pinrepo帮助我们解决的最大挑战是可扩展性，并允许我们随着时间的推移高效地处理大量数据。例如，当一天50次构建一个主要的36M(1.8G/天，162G/ 3个月)Python包时，伸缩就成了一个问题。我们以前使用过不同的解决方案，但是随着对象数量的增加，它们的性能通常会下降。</p><p id="a51c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">除了扩展，还有服务可用性和数据持久性问题。我们以前使用的解决方案基于单个主机和磁盘，速度慢且经常崩溃。虽然有备份过程，但它们经常在没有通知的情况下中断。维护这些服务是一场噩梦。我们需要基于持久、高可伸缩对象存储的可靠服务。</p><p id="cc3b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们考虑过直接使用亚马逊S3，但是我们发现我们不能使用它来存储和提供构建工件，因为如果存储桶没有被配置为公共可访问的，存储库客户端就不能与S3对话。这些类型的AWS S3请求需要首先“签名”,包括根据请求的某些元素计算和附加HMAC的流程。</p><p id="5734" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个问题可以通过简单地在AWS S3前添加一个nginx服务器集群来解决。理论上，我们可以“修复”所有的存储库客户端，以便它们可以直接与S3对话，但是这需要大量的工作，并且很难维护和扩展到其他工件格式。另一方面，nginx层不仅可以签署请求并将其转发给AWS，还可以为工件提供本地缓存，从而显著提高性能。nginx层是无状态的，可以很容易地横向扩展，所以它也解决了可用性问题。此外，不需要额外的备份过程。</p><p id="e887" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的答案是:Pinrepo，我们内部的工件库。</p><h2 id="326e" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">介绍Pinrepo</h2><p id="b8ce" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">我们在负载平衡器后面创建了一个nginx服务器集群，将所有请求代理到后端AWS S3服务，并使用nginx模块<a class="ae jc" href="http://wiki.nginx.org/NginxHttpSetMiscModule" rel="noopener ugc nofollow" target="_blank"> ngx_set_misc </a>来创建AWS服务请求签名。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es kr"><img src="../Images/50b2d68eb613af9e053d687af9cd311c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/0*Gz45ggoDS4y3JpBS.png"/></div></figure><h2 id="92a6" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">将文物直接发布到S3</h2><p id="6bf4" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">在亚马逊S3上传和维护工件元数据和布局的方式有很多，包括使用<a class="ae jc" href="https://github.com/krobertson/deb-s3" rel="noopener ugc nofollow" target="_blank"> deb-s3 </a>上传和维护debian包，使用maven插件<a class="ae jc" href="https://github.com/jcaddel/maven-s3-wagon" rel="noopener ugc nofollow" target="_blank"> maven-s3-wagon </a>进行maven包。我们找不到任何现有的工具来上传Python包到S3，所以我们编写了自己的<a class="ae jc" href="https://github.pinadmin.com/internal-tools/pinrepo/blob/master/pypi/pypi-release.py" rel="noopener ugc nofollow" target="_blank"> pypi-release </a>来上传和维护pypi包。</p><h2 id="4330" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">简单更好</h2><p id="1c54" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">通过将构建工件直接发布和存储到亚马逊S3，并在前端使用nginx集群，我们简化了技术堆栈，同时实现了可伸缩性和持久性。我们已经在生产环境中运行Pinrepo八个多月了，性能稳定，几乎无需维护。</p><h2 id="f025" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">未来的改进</h2><p id="9c1e" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">带有搜索支持的简单UI可能是一个需要添加的特性，尽管可以使用各种S3工具来找出存储库中可用的内容。添加额外功能时要小心，不要让它们成为关键路径的一部分，以免危及现有简单解决方案的可靠性和可伸缩性。暂存存储库和包升级也很好，但如果您有暂存部署和生产前测试环境，则不是必需的。Pinrepo还可以被扩展以轻松支持更多的包格式，比如RPM。</p><p id="8af5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Github 上查看<a class="ae jc" href="https://github.com/pinterest/pinrepo" rel="noopener ugc nofollow" target="_blank"> Pinrepo，让我们知道你的想法！</a></p><p id="de38" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="kz">宋宝刚</em> </strong> <em class="kz">是Pinterest云工程团队内部开发工具团队的工程主管。</em></p><p id="38b8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kz">鸣谢:感谢Raj Patel，他帮助评估了各种现有的解决方案并使流程正式化；Jayme Cox负责审查设计并就实施细节提出建议；以及Pinterest云工程团队的所有成员，他们推动了网站的可靠性、速度和安全性，并为云基础设施和开发人员构建了技术构件。</em></p><p id="ec32" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kz">获取Pinterest工程新闻和更新，关注我们的工程</em><a class="ae jc" href="https://www.pinterest.com/malorie/pinterest-engineering-news/" rel="noopener ugc nofollow" target="_blank"><em class="kz">Pinterest</em></a><em class="kz">，</em> <a class="ae jc" href="https://www.facebook.com/pinterestengineering" rel="noopener ugc nofollow" target="_blank"> <em class="kz">脸书</em> </a> <em class="kz">和</em> <a class="ae jc" href="https://twitter.com/PinterestEng" rel="noopener ugc nofollow" target="_blank"> <em class="kz">推特</em> </a> <em class="kz">。有兴趣加入团队吗？访问我们的</em> <a class="ae jc" href="https://about.pinterest.com/en/careers/engineering-product" rel="noopener ugc nofollow" target="_blank"> <em class="kz">招聘网站</em> </a> <em class="kz">。</em></p></div></div>    
</body>
</html>