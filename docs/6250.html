<html>
<head>
<title>Using PID controllers to diversify content types on home feed</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用PID控制器来多样化家庭馈送上的内容类型</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/using-pid-controllers-to-diversify-content-types-on-home-feed-1c7195c89218?source=collection_archive---------0-----------------------#2020-07-10">https://medium.com/pinterest-engineering/using-pid-controllers-to-diversify-content-types-on-home-feed-1c7195c89218?source=collection_archive---------0-----------------------#2020-07-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="d3d2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Yaron Greif |软件工程师，Homefeed排名</p><p id="19e7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">每天都有数百万Pinners访问home feed，在Pinterest上寻找灵感。作为home feed排名团队的一员，我的工作不仅是找出向Pinners展示哪些相关的pin，还要确保这些pin将有助于维护整个Pinterest生态系统的健康。例如，相对于仅仅为了相关性而排名，我们可能会显示更多新创建的大头针，以确保我们的语料库不会变得陈旧，或者显示更多视频大头针，以展示创作者的可行想法。</p><p id="508f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">传统的点击预测模型旨在最大化用户参与度，但它们无助于实现其他业务目标。为了解决这些其他目标，home feed排名团队引入了<strong class="ig hi">可控分发</strong>，这是一个灵活的实时系统，在传统排名层之后应用，通过提高和降低内容类型的排名分数来控制相关性、新鲜度和创作者目标等领域之间的权衡。</p><h1 id="f72d" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated"><strong class="ak">背景</strong></h1><p id="e92b" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">在可控分发之前，我们通过代码库中的大量特例解决方案来解决那些业务约束。两个最常见的解决方案是简单地在大约每个<em class="kf"> n个</em>槽中插入我们想要的更多内容，或者在feed上向上移动内容，直到返回的内容的最小百分比是特定类型。</p><p id="5831" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">出于实践和理论的原因，这些类型的解决方案是痛苦的。</p><p id="cad2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在实践中，这些手动调整的增强很快变得难以控制，并相互干扰。更糟糕的是，随着时间的推移，他们经常停止工作——尤其是当排名模型更新时。我们经常不得不推迟非常有前途的新排名模型，因为它们打破了业务限制。</p><p id="e0a8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">理论上，基于每个请求控制内容是不可取的，因为它阻止了个性化。如果我们向每个用户展示相同数量的视频引脚，我们就无法向真正喜欢看视频的人展示更多视频，反之亦然。</p><h1 id="de85" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated"><strong class="ak">我们的解决方案</strong></h1><p id="3d8e" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">可控分发用一个系统取代了那些硬编码的常量，在这个系统中，企业所有者可以为按内容类型划分的展示百分比指定一个全局目标。例如，如果4%的源被设置为视频，则可控分发可以自动确定如何实现该分发，同时仍然尊重Pinner内容偏好。重要的是，可控分布实时地不断调整系统，因此它不会变得陈旧。</p><p id="aeca" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">可控分发通过一个系统来实现这一点，该系统会跟踪过去视频占馈送内容的百分比，然后根据与目标视频的接近程度来提升或降低内容。这种提升是通过将排名系统的分数增加一个标量来实现的，我们称之为“归一化常数”</p><p id="f23e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了激励归一化常数，我们可以将Pinterest排名设置公式化为受可控分布所施加的约束的优化问题。归一化常数就是优化问题的拉格朗日量。</p><p id="6d28" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于每个用户<em class="kf"> i </em>槽<em class="kf"> j </em>对，系统选择pin Xij以最大化排名分数。可控分布增加了一个约束，即每个引脚类型<em class="kf"> t </em>都应构成进给的Pt百分比</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es kg"><img src="../Images/da7ff51d911e91f71301aeeff062ce62.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*Bm-m9Vt1XL5UqjglTb_xyw.png"/></div></figure><p id="81a4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">优化问题就变成了:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es ko"><img src="../Images/ed35297b8bd03e3a127d235dd6ded71b.png" data-original-src="https://miro.medium.com/v2/resize:fit:828/format:webp/1*xEtV4ArEfPWEMhycP7siLw.png"/></div></figure><p id="768b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">拉格朗日形式是:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es kp"><img src="../Images/dafd302db19ab03cd5e74d1aabbbe8f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1072/format:webp/1*ZPkD0FWXTwIOSmYbDtwoWA.png"/></div></figure><p id="5ab4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">拉格朗日λ是我们的归一化常数。从经济角度来看，λ是选择t型销的影子价格或可接受的机会成本。我们愿意放弃预期约定的λ，以显示类型<em class="kf"> t. </em>的销</p><p id="4fda" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">上述优化问题在实践中是无法解决的，因为我们事先不知道将被排序的那组图钉。相反，在没有可控分布的情况下，通过贪婪地选择具有最高排名分数的引脚来近似解决方案。由于类型<em class="kf"> t </em>的λ独立于用户和插槽，因此可以更新上述判定规则，以选择具有最高组合排序分数和归一化常数的管脚。</p><p id="b44f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">类型<em class="kf"> t </em>的λ通过实时观察误差<em class="kf"> g(t) </em>并相应调整λ来估算。</p><p id="dab5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">例如，在下面的实验中，我们希望某种类型的引脚的实际百分比为15.5%。一开始很高，20%。当系统看到内容被过度分发时，它减少常数，最终百分比收敛到大约15.5%。</p><div class="kh ki kj kk fd ab cb"><figure class="kq kl kr ks kt ku kv paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><img src="../Images/110cbb1ca1007e25c01959a381218e24.png" data-original-src="https://miro.medium.com/v2/resize:fit:994/0*V4TtdxTSf2WeQ1aD"/></div></figure><figure class="kq kl la ks kt ku kv paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><img src="../Images/0a8c906f7f52a8510d7f8f50741c1efc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/0*jmiLOtgWTrdHohMs"/></div></figure></div><p id="7502" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们使用PID控制器来寻找归一化常数。PID控制器用于控制恒温器和巡航控制等日常系统。它们具有令人满意的特性，即它们不需要问题空间的模型就能工作。你的恒温器不需要知道你的窗户是否开着来维持你房子里的温度。同样，排名分数的分布也可能突然改变。因此，很难明确地对规范化常数和内容类型分布之间的关系进行建模。</p><p id="a895" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">相反，PID控制器仅使用目标分布和实际分布之间的最近历史或误差来更新归一化常数。这些误差在实践中很容易存储。使用的算法是:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es lb"><img src="../Images/48e56aca851dc423acc1bffa1c755157.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YTedHjUFccKKDh3-YvBCtw.png"/></div></div></figure><p id="63e6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">直观地说，<em class="kf"> i </em>项是上式中最重要的一项。如果我们显示多少内容有误差，我们就按比例增加我们的归一化常数。I越大，我们的更新就越大。但是如果我的T21太大，我们就过头了。因此，我们需要<em class="kf"> p </em>和<em class="kf"> d </em>项根据误差项减少的速度来抑制我们的更新。</p><p id="6d30" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">PID控制器给我们带来的最大问题是，提升非常大的内容类型比提升小的内容类型需要不同的<em class="kf"> p、i </em>和<em class="kf"> d </em>项。但是根据内容类型调整<em class="kf"> p，i </em>和<em class="kf"> d </em>项是很难维持的。相反，我们发现，如果我们修改PID控制以在日志空间上工作，则相同的PID控制器适用于所有内容类型。</p><p id="4a4d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用在线解决方案的一个很大的优势是，它可以很容易地扩展到处理没有过去数据的AB测试体验。相比之下，离线解决方案(例如使用前几周的数据来近似λ)必须等待数据生成。</p><p id="2a5b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">实施</strong></p><p id="4b97" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过让<a class="ae lc" rel="noopener" href="/pinterest-engineering/building-a-dynamic-and-responsive-pinterest-7d410e99f0a9">计数器服务</a>订阅前端印象的Kafka流，然后将集合存储在RocksDB中，可以跟踪错误术语。然后，PID控制器从计数器服务中读取错误项的历史，并在Zookeeper中发布结果归一化常数，以供选择算法使用。PID控制器被实现为每小时一次的Jenkins作业。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es ld"><img src="../Images/620aa2d87b00c2c39cedb8e759498a27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WOTsqrrK7zc3JQeF"/></div></div></figure><p id="6832" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">进展如何</strong></p><p id="5a7c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在许多方面，该解决方案比预期的更容易实现。创建一个可行的PID控制器花费的时间比计划的要少。而且该算法很容易扩展到控制多种内容类型，这在设计审查期间是一个大问题。</p><p id="0914" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，我们经常发现我们无法控制特定范围之外的内容。例如，我们可以将视频百分比定在4%到12%之间，但无法获得低于或高于该范围的视频。调试这些类型的问题是痛苦和乏味的，通常是由系统问题或遗留的硬编码常量引起的。</p><p id="0ce4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">影响</strong></p><p id="3e19" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">可控分配被用于生产，并且已经被证明是非常有用的。它实现了最初的用例，即当模型被更新以实现业务约束时，允许模型被部署而没有代价高昂的延迟。我们还使用可控制的分布来反对遗留系统，例如“定期插入”，简化了代码并节省了大量工程时间。</p><p id="d1f9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们还发现了超出最初预期的可控分发的新用例。例如，我们已经使用可控分发来测试不同内容类型的不同负载对系统的影响。下面我们使用可控分布来调整不同AB组的视频负载。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es ld"><img src="../Images/be9f70315e402d21a334f1079fb5a3b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XsJt-3SQAgtB_k5u"/></div></div></figure><p id="1890" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">下一步是什么</strong></p><p id="de63" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">传统上，Pinterest和类似的网站将大部分建模工作都花在了检索和事件预测上。可控分布只是一个例子，说明了对排名分数进行建模和修改，以向Pinners和creators提供最佳结果是多么重要。</p><p id="cafd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest将在这个排名后的阶段继续投入，我们称之为blending，向用户传递更好的励志内容。</p><p id="a5e9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kf">鸣谢:我们要特别感谢朱瑞民、李康南、张楠、Cosmin Negruseri和Ludek Cigler对本项目的帮助</em></p></div></div>    
</body>
</html>