# 将管道引入 Airbnb 的部署流程

> 原文：<https://medium.com/airbnb-engineering/introducing-deploy-pipelines-to-airbnb-fc804ac2a157?source=collection_archive---------2----------------------->

## 通过开发一种加强我们的部署过程的方法，加入抵御“坏代码”的最后一道防线，以及关于理论和实践在现实世界软件开发中如何不同的经验教训。

![](img/c4b0b8a537e6a8c3c2fc1469fe1f5c8d.png)

The deployment pipeline is used for services that power these unique [Experiences on Airbnb.com](https://www.airbnb.com/s/experiences).

在 Airbnb，停机时间不仅仅是一种不便——它通常会对我们的用户产生重大的现实影响。为了不断提醒这一极其重要的事实，我们制作了一张醒目的海报，张贴了许多个月前的一条推文。粗略地转述一下，上面写着:

> @AirbnbHelp 救命！我被锁在外面，由于 Airbnb 关闭，我无法联系我的主机。

当然，一个网站可能会因为各种原因而关闭。也许是一个古怪的测试出了问题，让我们推出了糟糕的代码。也许是某个盒子意外失效了。[可能是大规模漏洞修复影响了内核性能](https://meltdownattack.com/)。幸运的是，Airbnb 的每个团队都发挥了自己的作用，确保这种情况不会发生，使停机时间**变得极其罕见**。在 DeployInfra 上，我们关注软件开发生命周期中的 deploy box 基本上，一旦代码被编写并准备好使用，我们就负责将它放到适当的服务器上(这涵盖了*很多*领土！).Airbnb 的许多应用程序/服务几乎都使用我们自己开发的部署服务 Deployboard，这在许多方面使我们成为抵御“坏代码”的最后一道防线(在我们之后，代码是——根据定义——活的！).

随着这种强大的力量而来的是更大的责任。虽然几乎所有 Airbnb 工程师都会定期与 Deployboard 互动，但这些互动通常都很短暂，更多的是达到目的的一种手段。因此，我们不能依赖熟悉作为拐杖；**我们需要确保部署流程经过精心设计，并将潜在的误用降至最低**。特别是，我们对界面的易用性和直观性要求极高。少了一点，错误就会泛滥。

## 不必要的灵活部署程序

当然，我们并不完美，对于我们——作为系统的开发者——来说，看似直观的东西对于不经常使用的用户来说往往不够直观。特别是，灵活性对有经验的人来说是一种福气，但也常常是上吊的绳索。今年夏天，我们注意到 Deployboard 的一个相当重要的部分就是这种情况，这间接导致了相当多的事件。

首先，一点必要的背景。Airbnb 有大约 1000 种不同的服务，随着我们向 SOA 发展，这个数字只会继续增长。每个服务都有自己的一组“环境”——完成特定角色的机器集群——和一个指定代码变更部署顺序的部署过程。例如，一个典型的代码变更可能首先被部署到一个“登台”环境，然后到一个“金丝雀”环境，最后到生产环境。

目前为止，一切正常。但是在 Airbnb，我们为给予我们的工程师很大的自由和灵活性而自豪，这意味着任何工程师都可以用最少的努力部署到任何环境(回想一下，我们希望事情尽可能地简单！).然而，在这一特定背景下，这种自由引发了两个问题:

1.  **没有什么可以阻止工程师以错误的顺序部署**，例如，在部署到 staging 或 canary 之前直接部署到生产。事实上这并不罕见；在我的项目之前，大约 10%的代码变更直接进入生产。请注意，这些大部分都是测试或注释性的修改，所以这个数字并不像第一次出现时那么高，但是仍然令人担忧。
2.  如果一名工程师想要为他们不经常使用的服务做出贡献(这在 Airbnb 非常常见！)，**他们不容易发现服务的部署过程是什么**——这方面的文档很少是最新的。

![](img/2d354a5a52161da6dd34ae32b9b508b2.png)

Just a few of the 24 (!) environments for one of our many services. Try to guess the correct order!

当然，这些问题相互影响。当面对上面的显示时，一个新接触该服务的工程师可能会决定他们的更改最终应该在生产中结束，因此“最简单”的解决方案是在那里部署它。

正如我前面提到的，几乎所有 Airbnb 的工程师都会定期与 Deployboard 进行交互，虽然这些交互很短，但几乎所有的交互都在某个时候涉及到这个显示(毕竟，这个显示是代码实际部署的方式！).因此，解决这个问题成了当务之急。因此，虽然我们评估了几个外部解决方案，并可能在未来几年内转向一个，但在短期内，我们选择在 Deployboard 内部实现一个自主开发的管道系统。

这项工作需要非常仔细地完成。随着 Airbnb 在过去五年的发展，Deployboard 也一直在发展，现在每天处理数千个部署。可以说，Deployboard 是 Airbnb 运营中不可或缺的一部分，因此对其进行实质性的改变——尤其是在其关键部分——需要相当稳健的手。因此，开始了一个多团队协作来开发一个解决方案提案，这是一个一丝不苟、极其谨慎、非常注重细节的过程；在我实习的前几周，我感觉自己更像一个项目经理，而不是工程师。

最后，在多次原型迭代和数百条文档注释之后，最终目标成型了:

![](img/2a76a8cc45b80d98bcef136106dc94c5.png)

The same 24 targets, but a) arranged correctly and b) separated into “mandatory”/”optional” targets

## 开发管道

我们现在知道了 A 点和 B 点的样子，所以剩下的“所有”就是把这些点连接起来！和往常一样，不成文的第 0 步是首先将工作分成几个相对不同的步骤:

1.  **为服务所有者可以用来定义其部署程序(即管道)的配置文件制定规范。**

由于我们将[配置视为代码](https://confluence.atlassian.com/bamboo/what-is-configuration-as-code-894743909.html)，这使得开发和以后更新管道配置就像部署它一样简单！

因为部署本身是由管道处理的，所以这种方法确实带来了一个重要的微妙之处:有可能管道被调用来更新它自己的配置。原则上，这根本不是问题，但这意味着如果管道以某种方式获得了损坏的配置，它不能通过直接方法修复。因此，这一步需要高度防御性的编程来避免这种情况，以及开发工具来“拯救”管道，以防有东西从裂缝中溜走。

**2。将管道配置保存在数据库中。**

这引发了许多数据库设计问题。我们需要什么桌子？他们是如何互动的？我们如何表示目标之间的依赖关系？前两者相对简单；我们可以有一个管道表，引用一个管道阶段表，等等。然而，最后一个在[链接表](https://en.wikipedia.org/wiki/Many-to-many_(data_model))中需要稍微多一点的努力。一个简单的例子:

![](img/d2ed28b37818866b1537ed31945b4ab1.png)

这里，演员和电影通过一个单独的表以多对多的关系映射，该表的行包含演员 ID 和电影 ID。同样，我们可以将目标映射到目标。本质上，这是一种数据库友好的表示一种[邻接表](https://en.wikipedia.org/wiki/Adjacency_list)的方式。

3.**给前端一个访问该数据的方法**。

幸运的是这个很简单。我们可以简单地将管道公开为服务的 [Rails 呈现器](https://richonrails.com/articles/rails-presenters)的一部分；换句话说，我们产生了一个 [JSON](https://en.wikipedia.org/wiki/JSON) 等价物，它是我们想要保留的关于管道的信息。因为该信息当然包括管道中涉及的阶段和依赖关系，这递归地需要管道、阶段、链接等的呈现者。

4.**在 UI 显示中正确分离和排列目标**。

忽略围绕阶段相等的一些边缘情况细节，这归结为正确排序一个 [DAG](https://en.wikipedia.org/wiki/Directed_acyclic_graph) ，这当然最容易通过[拓扑排序](https://en.wikipedia.org/wiki/Topological_sorting)(一个典型的 [DFS](https://en.wikipedia.org/wiki/Depth-first_search) 应用)来完成。本质上，这是一种对我们的阶段进行排序的方式，以便后面的阶段只依赖于前面的阶段，这给了我们一个有保证的顺序，我们可以在不遇到依赖性问题的情况下处理它们。这个算法的一个好处是隐含的[周期检测](https://en.wikipedia.org/wiki/Cycle_detection)，这意味着它可以作为配置验证的一部分被重用(当然，我们应该拒绝包含周期的配置)。

5.**禁用不应部署到**的目标(即它具有尚未部署到的依赖项)。

这听起来可能是最简单的，因为我们已经有了一个用于部署的 DB 表，但结果却是最难的改变。事实证明，我们有*如此多的部署*,以至于以简单的方式检索与变更相关的部署非常慢。即使在添加了适当的[索引](https://en.wikipedia.org/wiki/Database_index)之后，这个问题仍然存在，这非常令人惊讶。

最后，解决方案稍微复杂了一点，需要公开一个新的 [API 端点](https://en.wikipedia.org/wiki/Application_programming_interface)(本质上允许按需访问信息，而不是预加载，以可接受的速度分发数据库访问模式)，这被证明是塞翁失马焉知非福，因为其他一些项目也需要这个基本功能。

6.**最后实现 UI** 。

这里没有太多要说的——这是相当标准的前端工作，涉及 [CSS 修补](https://en.wikipedia.org/wiki/Cascading_Style_Sheets)和一些[反应组件](https://reactjs.org/docs/react-component.html)。然而，一个有趣的注意事项是前面提到的对直观设计的关注——有一次，我们花了几天时间讨论使用哪个图标:蓝色圆圈还是金色星星！虽然这听起来可能没有必要，但实际上却是至关重要的——这个图标本质上是代表“下一步做什么”，这可能是 UI 应该传达的最重要的信息。

(如果你好奇的话:为了与 UI 的其余部分保持一致，我们最终选择了蓝色圆圈)

当然，完成技术工作并不是项目的结束——如果没有人使用它，开发解决方案就没有任何价值！因此，我实习的最后几周致力于向 Airbnb 的各个团队推广这个项目，需要一系列的演示、演示和许多许多的电子邮件。最终，许多关键服务——包括 Deployboard 本身！—最终采用了部署管道，极大地改善了开发人员的体验。

## 最后的话

总的来说，我在 Airbnb 的实习是一次难以置信的学习经历，无论是技术上还是其他方面。从组织闪电演讲到演示再到写这篇博客，除了坐在自己的小角落里编写代码之外，这里还有很多事情要做，就我的经验而言，这对于实习来说是相当不寻常的。这不是巧合——这里的文化独特地欢迎和鼓励交流(考虑到[在招聘中强调核心价值观](https://www.airbnb.com/careers)，这并不奇怪)。我绝对期待以后能回来！

Airbnb 不断寻求优秀的人加入我们的团队！如果你有兴趣在 Airbnb 实习/工作，请查看我们在[https://www.airbnb.com/careers/departments/engineering](https://www.airbnb.com/careers/departments/engineering)发布的招聘信息并提交申请！