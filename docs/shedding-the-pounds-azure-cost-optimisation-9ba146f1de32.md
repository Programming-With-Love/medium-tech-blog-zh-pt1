# 减肥:Azure 成本优化

> 原文：<https://medium.com/version-1/shedding-the-pounds-azure-cost-optimisation-9ba146f1de32?source=collection_archive---------1----------------------->

![](img/0ab375af5b7573e153a4b586154e5150.png)

Photo by [Paxson Woelber](https://unsplash.com/@paxsonwoelber?utm_source=medium&utm_medium=referral) on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)

作为微软 Azure 版本 1 的顾问，我每天都会被问到的问题主要是关于 Azure 中的技术场景，我该如何实现它？这将提供什么功能？为什么这不像预期的那样工作？

更常见的是，问题现在开始变得更加集中在成本消耗和优化上，例如，为什么这要花费我很多钱？有没有类似功能的更便宜的替代品？如果我们这样做，会如何影响我这个月或下一年的账单？

组织越来越意识到通过迁移到基于云的基础架构可以节省潜在成本，云成本开始成为 IT 预算的一大部分。对于那些已经开始云计算之旅的人来说，成本节约可能是他们首先开始迁移的主要驱动力。

但是，迁移到云并期望看到持续的成本节约，而不对应用程序和基础架构进行持续评估以进行优化，可能会导致昂贵的账单。我在版本 1 中的部分角色是帮助建议一些机会，这些机会可以帮助组织从 Azure 账单中“减肥”。

这里是我在各种项目中应用的 12 个优化和最佳实践，其中一些可能是显而易见的，一些不那么明显，一些可能只需最少的努力，一些优化可能需要详细的规划来实现。所有这些想法的结合(而不仅限于此)将有助于降低成本，并有助于发展一种持续优化的文化。

1.**关闭未使用的资源**

你可能认为这是一个简单的问题，但我曾多次遇到为测试而创建的虚拟机(VM ),在用户回来完成测试之前，它们已经运行了几天，甚至几周。

在 Azure 中，每分钟的正常运行时间都会被计费，这种情况可能会导致账单攀升，因此如果您没有使用它，并且它不是需要运行的工作负载，请关闭它以停止计量运行。

更好的是，通过使用计划的启动和关闭操作手册来自动完成这项任务。在工作日的下午 6 点到上午 8 点之间关闭虚拟机，在周末的下午 6 点到周一上午 8 点完全关闭虚拟机，计算价格将降低 60%，而不是让虚拟机全天候运行。

![](img/f2bba9ecd250ba1633ea4cd153169be6.png)

Startup and Shutdown Runbook Example

2.**移除未使用的资源**

在内部部署环境中，您可以关闭资源，而不会产生任何额外成本，除非您需要可以保留这些资源的容量。你可能不希望在 Azure 中这样做，如果你关闭一个虚拟机，计量停止，收费也停止，但是，你仍然需要为连接到该虚拟机的存储付费。因此，如果您保留该机器以备不时之需，但希望优化成本，请删除这些资源，并在需要时重新调配它们。

当考虑清理和删除资源时，您还应该考虑您的 IT 资产中可以退役的应用程序，有时退役会被推到优先级列表的底部。如果定期执行，审核基础架构并删除不再需要的资源可以节省大量成本。

**3。** **大小合适的虚拟机**

虚拟机拥有的资源越多，成本就越高。定期评估虚拟机使用情况并考虑应用程序供应商推荐的虚拟机大小，有助于确保您只为正在使用的资源付费。

在版本 1 中，我们在发现和评估阶段充分利用了原生工具，如果一个组织希望迁移到 Azure 或持续监控 Azure Advisor 以实现性能和成本优化，请查看 Azure 迁移评估。

**4。** **湛蓝色斑点实例**

一个相对较新的功能是 Azure Spot Instances，这是一个 Spot 实例，与现收现付实例相比，它以高达 90%的折扣率利用 Azure 中未使用的容量。然而，如果 Azure 需要容量，这些实例可以在任何时候被关闭和驱逐，因此只适合低优先级的测试和开发服务器。

![](img/cb83519b92bb5f88150bb730718a8f64.png)

Spot instance configuration in the Azure Portal

**5。** **企业开发/测试定价**

如果您有企业协议，您可以使用企业开发/测试服务订阅。在这些订阅中部署的虚拟机可以运行 Windows 和 SQL Server，而无需支付 Microsoft 软件的费用，所提供的价格与 Linux 机器相同，可以节省大约 50%的总体计算成本。

如果您没有企业协议，Visual Studio 订阅者可以注册购买开发和测试服务。

**6。** **选择正确的存储选项**

Azure 高级存储(SSD)是目前 Azure 中广泛提供的性能最好的磁盘，但是，与标准(SSD 或 HDD)存储相比，这种性能的价格很高。

对于磁盘性能至关重要的生产工作负载和应用程序，建议使用高级存储，但开发和测试工作负载最初应利用 Azure 中的标准存储。为了降低成本，如果需要，磁盘可以随时升级到高级存储。

我最近进行的一项评估显示，一个组织在 Azure 上的支出有 65%是存储，其中 78%是分配了高级存储的虚拟机磁盘。仅在需要时使用优质存储对于未来的成本优化至关重要。

7 .**。** **蔚蓝混合福利**

Azure Hybrid Benefit (AHB)允许您利用已购买的带有有效软件保障的许可证，以应用于 Azure 虚拟机。这导致 Azure VM 基础价格的应用没有任何额外的许可成本，与现收现付的计算价格相比，通常节省约 40%。

无论是在 SQL Server 标准许可证还是 SQL Server 企业许可证上投资，Azure Hybrid 的优势也已经扩展到了 SQL 工作负载上。下表显示了每个核心 SQL Server 许可证可获得多少个 vCore/vCPU 许可证:

![](img/0db652f4e2072f3e5d73384eeea5dd14.png)

Qualified licenses to Azure vCores table

**8。** **保留实例**

保留实例(RI)承诺在 Azure 中使用虚拟机 1 年或 3 年，以换取该虚拟机成本的折扣，请务必注意，您只是使用 Azure RI“保留”虚拟机的计算部分。你也可以保留一些托管的磁盘存储，但这是在一个单独的 Azure RI 下。

微软还扩展了他们的保留产品，包括 MySQL 的 Azure Database、SQL Database、SQL Datawarehouse、PostgreSQL、MariaDB 和 Cosmos DB。

Azure RI 可以按月支付或预付，没有合同锁定。如果需要，Azure RI 可以迁移到另一个虚拟机或完全取消，但是，如果取消，将收取 12%的取消费用。根据我的经验，RI 最适合生产应用程序，因为组织知道这些应用程序是长期存在的，不会很快被升级或替换。

利用 Azure RI 可以在 3 年内将计算成本降低高达 72%,如果与 Azure Hybrid 捆绑在一起，这一优势可以增加高达 80%。

**9。** **预算**

预算对于帮助规划支出和推动优化至关重要，有了预算，你可以计算出你在特定时期消费或订阅的 Azure 服务。他们可以帮助您告知其他人他们的支出情况，以便主动管理成本，并监控支出的进展情况。

当超过您创建的预算阈值时，可以向相关的利益相关者触发通知，但请注意，您的任何资源都不会受到影响，您的 Azure 消费也不会停止。如果你经常超出你的阈值，那么预算可以帮助你追踪超额成本的来源。

**10。** **使用备份和 Azure 站点恢复**

这可能有点争议，但不是所有的东西都需要备份或有一个灾难恢复计划，如果一个组织经历了站点中断。是的，作为最佳实践，应该为所有生产机器设置 Azure Backup 和 Azure Site Recovery，但请记住，这些都是收费服务。在很少使用或很容易重新创建的非生产工作负载上设置这些服务将会花费资金，这些资金可以节省下来并用于其他地方。

![](img/398203f325d1a2f3b98a4cb5f524bf16.png)

**11。** **利用 PaaS 服务**

平台即服务(PaaS)产品并不总是解决问题的答案，PaaS 解决方案是否适合您的工作负载还取决于许多因素，但如果适合，那么与基础架构即服务(IaaS)或其内部部署的同类产品相比，成本节约将是巨大的。

这方面的两个例子是 Azure SQL 和 Azure Files，这两种服务都有可能带走解决方案中最昂贵的元素，虚拟机及其许可证。在这种模式下，您只需为您所使用的资源付费，例如 Azure SQL 数据库资源或 Azure 存储，而不是在需要资源时让虚拟机全天候运行。

**12。** **利用临时存储的 SKUs】**

临时磁盘位于托管 Azure 虚拟机的虚拟机管理程序上，由于维护、虚拟机大小调整和重新部署到不同主机等活动，该磁盘上的数据可能会随时丢失。因此，临时磁盘不应用于存储永久数据。

在与我的同事克里斯·马歇尔(感谢克里斯！)我们一起将大约 450 台虚拟机迁移到 Azure，我们注意到每台虚拟机都有一个专用于页面文件的磁盘。通过移除这些磁盘并使用大多数虚拟机 SKU 上为页面文件提供的临时磁盘，我们将从资产中移除 450 个 P3 磁盘，相当于每月节省约 1000 英镑。

临时磁盘的另一个潜在用途是用于 SQL Server 上的 TempDB。对于 D 和 G 系列虚拟机上的 SQL Server，临时磁盘基于 SSD，如果切换到临时磁盘，大量使用 TempDB 的应用程序可以受益于更高的吞吐量和更低的延迟。

**关于作者**

*Steven Munsey 是微软 Azure 的顾问，目前在版本 1 的英国数字数据&云实践部门工作。关注版本 1 和 Steven，了解更多关于 Microsoft Azure 的博客。*