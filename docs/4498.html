<html>
<head>
<title>File Based Dynamic Configuration of Routes in Envoy Proxy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">特使代理中基于文件的路由动态配置</h1>
<blockquote>原文：<a href="https://medium.com/compendium/file-based-dynamic-configuration-of-routes-in-envoy-proxy-6234dae968d2?source=collection_archive---------1-----------------------#2019-03-12">https://medium.com/compendium/file-based-dynamic-configuration-of-routes-in-envoy-proxy-6234dae968d2?source=collection_archive---------1-----------------------#2019-03-12</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/f49d3760b37fa81ef06899eb097dbae8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p9qGkbrBiGNPv4Y9yexi5w.jpeg"/></div></div></figure><p id="c13e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">随着开发人员越来越多地参与边缘代理的配置，如<a class="ae jn" href="https://www.envoyproxy.io/" rel="noopener ugc nofollow" target="_blank">特使</a>，这些设备提供支持现代开发人员工作流程的开发人员体验变得非常重要。凭借动态服务发现功能，Envoy使这一切成为可能。除了静态引导配置之外，代理的所有方面都可以<a class="ae jn" href="https://www.envoyproxy.io/docs/envoy/v1.9.0/intro/arch_overview/dynamic_configuration" rel="noopener ugc nofollow" target="_blank">动态配置</a>。这意味着无需冷启动或热重启即可更新特使代理的配置。在许多情况下，这是处理频繁配置更改的首选和最简单的方法。</p><p id="9392" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">配置可以由配置服务器提供，也可以由文件提供。这种服务器有一些开源和商业实现。如果需要，项目可以基于可用的库、实现和示例(<a class="ae jn" href="https://github.com/envoyproxy" rel="noopener ugc nofollow" target="_blank">envoy proxy</a>/<a class="ae jn" href="https://github.com/envoyproxy/go-control-plane" rel="noopener ugc nofollow" target="_blank">go-control-plane</a>，<a class="ae jn" href="https://github.com/envoyproxy" rel="noopener ugc nofollow" target="_blank">envoy proxy</a>/<a class="ae jn" href="https://github.com/envoyproxy/java-control-plane" rel="noopener ugc nofollow" target="_blank">Java-control-plane</a>)实现自己的功能。如果需求不需要基于服务器的解决方案，简单的基于文件的方法可能就足够了。将创建一个具有新配置的文件，在文件系统移动操作中，当前文件将被新配置覆盖。使用<code class="du jo jp jq jr b">inotify</code>来监控文件的变化，Envoy将加载新的配置，如果有效的话就应用它。如果无效，先前的状态将保持活动状态，并且相应的消息将被写入日志。</p><p id="6fbb" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">发现服务的整个家族被指定为xDS。这篇文章展示了如何使用文件作为配置源而不是服务器来实现路由发现服务(RDS)。</p><p id="7754" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这篇文章附带的代码可以在<a class="ae jn" href="https://github.com/mgfeller/xds-envoy" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。它基于<a class="ae jn" href="https://github.com/envoyproxy/envoy" rel="noopener ugc nofollow" target="_blank">特使代理库</a>的前端代理示例代码，记录在<br/> <a class="ae jn" href="https://www.envoyproxy.io/docs/envoy/v1.9.0/start/sandboxes/front_proxy.html" rel="noopener ugc nofollow" target="_blank">特使文档</a>中。</p><p id="5a7a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在特使配置文件中，找到您想要用动态配置替换的字段<code class="du jo jp jq jr b">route_config</code>和<code class="du jo jp jq jr b">envoy.http_connection_manager</code>过滤器:</p><pre class="js jt ju jv fd jw jr jx jy aw jz bi"><span id="5a88" class="ka kb hh jr b fi kc kd l ke kf">- name: envoy.http_connection_manager<br/>  config:<br/>    codec_type: auto<br/>    stat_prefix: ingress_http<br/>    route_config:<br/>      name: local_route<br/>      virtual_hosts:<br/>      - name: backend<br/>        domains:<br/>        - "*"<br/>        routes:<br/>        - match:<br/>            prefix: "/service/1"<br/>          route:<br/>            cluster: service1<br/>        - match:<br/>            prefix: "/service/2"<br/>          route:<br/>            cluster: service2<br/>    http_filters:<br/>    - name: envoy.router<br/>      config: {}</span></pre><p id="acaa" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">将该字段替换为一个名为<code class="du jo jp jq jr b"><a class="ae jn" href="https://www.envoyproxy.io/docs/envoy/v1.9.0/api-v2/config/filter/network/http_connection_manager/v2/http_connection_manager.proto#envoy-api-msg-config-filter-network-http-connection-manager-v2-rds" rel="noopener ugc nofollow" target="_blank">rds</a></code>的字段，该字段指向包含相应配置的文件:</p><pre class="js jt ju jv fd jw jr jx jy aw jz bi"><span id="9efa" class="ka kb hh jr b fi kc kd l ke kf">- name: envoy.http_connection_manager<br/>  config:<br/>    codec_type: auto<br/>    stat_prefix: ingress_http<br/>    rds:<br/>      route_config_name: local_route<br/>      config_source:<br/>        path: /etc/rds/rds.yaml<br/>    http_filters:<br/>    - name: envoy.router<br/>      config: {}</span></pre><p id="af9c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">文件<code class="du jo jp jq jr b">rds.yaml</code>的内容是</p><pre class="js jt ju jv fd jw jr jx jy aw jz bi"><span id="e1fc" class="ka kb hh jr b fi kc kd l ke kf">version_info: "0"<br/>resources:<br/>- "<a class="ae jn" href="http://twitter.com/type" rel="noopener ugc nofollow" target="_blank">@type</a>": type.googleapis.com/envoy.api.v2.RouteConfiguration<br/>  name: local_route<br/>  virtual_hosts:<br/>  - name: backend<br/>    domains:<br/>    - "*"<br/>    routes:<br/>    - match:<br/>        prefix: "/service/1"<br/>      route:<br/>        cluster: service1<br/>    - match:<br/>        prefix: "/service/2"<br/>      route:<br/>        cluster: service2</span></pre><p id="7035" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在，如果需要更改配置，可以创建一个具有新配置的文件，比如说<code class="du jo jp jq jr b">rds-new.yaml</code>，然后在现有文件上移动:</p><pre class="js jt ju jv fd jw jr jx jy aw jz bi"><span id="51eb" class="ka kb hh jr b fi kc kd l ke kf">mv rds-new.yaml rds.yaml</span></pre><p id="5033" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Envoy将获取更改，验证并激活新配置。</p><p id="595a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">进一步阅读和资源:</strong></p><ul class=""><li id="5419" class="kg kh hh ir b is it iw ix ja ki je kj ji kk jm kl km kn ko bi translated"><a class="ae jn" href="https://www.envoyproxy.io/docs/envoy/v1.9.0/intro/arch_overview/dynamic_configuration" rel="noopener ugc nofollow" target="_blank">特使代理:动态配置</a></li><li id="5ccb" class="kg kh hh ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated"><a class="ae jn" href="https://blog.envoyproxy.io/the-universal-data-plane-api-d15cec7a" rel="noopener ugc nofollow" target="_blank">特使代理:通用数据平面API </a></li><li id="36c7" class="kg kh hh ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated"><a class="ae jn" href="https://github.com/envoyproxy/data-plane-api/blob/master/XDS_PROTOCOL.md" rel="noopener ugc nofollow" target="_blank">特使代理:xDS REST和gRPC协议</a></li><li id="7802" class="kg kh hh ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated"><a class="ae jn" href="https://www.katacoda.com/envoyproxy/scenarios/file-based-dynamic-routing-configuration" rel="noopener ugc nofollow" target="_blank"> Katacoda: envoyproxy —基于文件的动态路由配置(EDS) </a></li><li id="c8f6" class="kg kh hh ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated"><a class="ae jn" href="https://thenewstack.io/envoy-and-the-programmable-edge-edge-proxies-and-the-developer-experience/" rel="noopener ugc nofollow" target="_blank"> Envoy和可编程边缘:边缘代理和开发者体验</a></li></ul></div><div class="ab cl ku kv go kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ha hb hc hd he"><p id="a71b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="lb">原载于</em><a class="ae jn" rel="noopener" href="/p/5ec5998f7902/"><em class="lb">medium.com</em></a><em class="lb">。</em></p></div></div>    
</body>
</html>