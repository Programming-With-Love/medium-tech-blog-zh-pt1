# EC2 元数据—邪恶还是天才

> 原文：<https://medium.com/version-1/ec2-metadata-evil-or-genius-1abf73525d80?source=collection_archive---------3----------------------->

BBC Radio 4 的经常听众可能熟悉“邪恶天才”系列，其中罗素·凯恩(Russell Kane)在一组专家和名人嘉宾的协助下，权衡标志性人物，以确定他们是真正的邪恶还是真正的天才。

![](img/535b82210a014465681d206acdba1c9e.png)

Evil Genius, courtesy of the BBC

我很想拿起这个想法，用它运行一段时间，但是将它应用到与您的普通 it 人员更接近的地方 AWS EC2 实例中可用的元数据。

在深入研究 EC2 元数据的技术细节之前，让我们先看看什么是元数据。前缀“meta-”来源于希腊语，意思是“之后”或“超越”，在“元数学”和“形而上学”等术语中变得突出，表示潜在基础学科的研究领域。令人印象深刻的是，Meta- 已经延伸到英语的许多部分，表示“关于”其他事物的任何事物，给我们带来了 meta- *规则*(关于规则应用的规则)，meta *编程*(程序依赖其他程序)，但没有 Metaxa，这是一种不太像样的希腊白兰地。那么，元数据是关于数据的数据；例如，一本书的作者和出版日期，书的内容是数据本身，还是说*本身*是数据*的复数？你好，吹毛求疵的伙伴们。*

这些*开胃菜*已经够多了，让我们进入正题——EC2 元数据，它是什么，我们可以用它来做什么，最重要的是，它是邪恶的还是天才的？

## 这是什么？

这是关于您的 EC2 实例的数据(当然，我们从上面冗长的解释中猜到的，对吗？)，可在每个实例内部访问，并由实例元数据服务(IMDS)提供。您可以从实例中“浏览”到[http://169 . 254 . 169 . 254/latest/metadata/](http://169.254.169.254/latest/metadata/)来访问元数据。这将返回一个类别列表，您可以深入查看，以揭示关于您的实例的各种有趣的东西，这些东西不能从操作系统本身中立即获得。记住这一点，让我们继续看…

## 我们能用它做什么？

想知道您的实例的公共 IP 地址而不在控制台上查找它吗？

> curl[http://169 . 254 . 169 . 254/latest/metadata/public-IP v4](http://169.254.169.254/latest/metadata/public-ipv4)会告诉你你想知道的。

我使用了什么 AMI 来启动这个实例？

> curl[http://169 . 254 . 169 . 254/latest/metadata/ami-id](http://169.254.169.254/latest/metadata/ami-id)是你的朋友。

我真的在巴林启动了我的实例吗？！

> curl[http://169 . 254 . 169 . 254/latest/metadata/placement/avail ability-zone](http://169.254.169.254/latest/metadata/placement/availability-zone)让你放心。

我听到你说“这似乎是一大堆信息”。“安全吗？”。答案是肯定的，也是否定的，从这篇文章的语气来看，这可能是意料之中的。

## 邪恶还是天才？

人们可能会认为，只能在私有的本地地址上访问的 URL 是安全的，但是，如果我们设想一个场景，其中实例正在运行一个向外界呈现的服务，事情就变得不那么清晰了。输入… *服务器端请求伪造*，简称 SSRF。SSRF 是一种强制应用程序调用非其设计的系统或服务的方法，通常会产生不良后果。它通常与执行导入或导出操作的 web 应用程序结合使用，例如发送 PDF 格式的可打印报告或上传图像。如果应用程序没有对这种传输的类型和端点进行足够的检查，那么它们就可能被利用来检索正常情况下不应该可见的信息。

2019 年年中，对 Capital One 进行了这样的利用，导致 1 亿现有客户和潜在持卡人的个人信息泄露。攻击者有一个真实的 Capital One 在线帐户，他注意到上传和预览自定义图像以打印到您的新信用卡的过程使用了 AWS S3 桶，其 URL 被指定为上传图像 URL 的子组件。通过创建一个新的指向应用程序实例的元数据源的“子 URL ”,她能够虹吸出实例的 IAM 角色访问密钥，然后使用这些访问和扫描大量 S3 桶，下载数百万人的个人信息。Kontra 将这次入侵建模为一次指导性练习: [Capital One SSRF | Kontra](https://application.security/free-application-security-training/server-side-request-forgery-in-capital-one) ，让你站在负责的黑客的立场上，更好地了解漏洞是如何被发现和利用的。

就其本身而言，实例元数据看起来相当安全，而且非常有用。将一个构建草率的应用程序加入其中，一个没有彻底检查其输入和输出的应用程序，突然元数据就滑入了一个黑暗的地方。

根据您希望事情有多安全，会有许多选项出现。

在最极端的情况下，可以简单地禁用实例元数据服务。

如果您仍然需要元数据，可以使用一种更新、更安全的版本，巧妙地称为 IMDSv2。使用它可以阻止对较旧的、不太安全的版本的访问，并使用有时间限制的、基于令牌的访问方法。本质上，您可以在固定的时间段(1 秒到 6 小时)内“解锁”实例元数据会话，做您需要做的事情，当令牌过期时，IMDS 访问将停止工作。详见[配置实例元数据服务—亚马逊弹性计算云](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html#configuring-instance-metadata-options)

或者坚持使用旧的 IMDSv1，使用没有安全缺陷的应用程序。简单。

**关于作者**

*阿历克斯·科利尔目前是版本 1 的* DevOps 云工程师*。*

![](img/f88ee0c8aaf15df76f3c0f5afc239fe3.png)