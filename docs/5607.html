<html>
<head>
<title>Oracle automatic upgrade ala Docker way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Oracle自动升级ala Docker方式</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/oracle-automatic-upgrade-ala-docker-way-4af9e43d602d?source=collection_archive---------4-----------------------#2019-05-04">https://medium.com/oracledevs/oracle-automatic-upgrade-ala-docker-way-4af9e43d602d?source=collection_archive---------4-----------------------#2019-05-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="0c0d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有一篇来自<a class="ae jc" href="https://mikedietrichde.com/" rel="noopener ugc nofollow" target="_blank">迈克·迪特里希</a>的<a class="ae jc" href="https://mikedietrichde.com/2019/04/29/the-new-autoupgrade-utility-in-oracle-19c/?fbclid=IwAR1j9t-1ytdIfiks63_xlfauBvX0QX-MxH5pxounx9IorRRwbb2b634ToGo" rel="noopener ugc nofollow" target="_blank">帖子</a>和<a class="ae jc" href="https://mikedietrichde.com/slides/#OOW18" rel="noopener ugc nofollow" target="_blank">幻灯片</a>，讲述如何使用<a class="ae jc" href="https://support.oracle.com/epmos/faces/DocumentDisplay?id=2485457.1" rel="noopener ugc nofollow" target="_blank">自动升级工具</a>为您的Oracle RDBMS进行自动升级。</p><p id="d887" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是如果你的RDBMS运行在Docker或者Docker Swarm上会怎么样呢？嗯很容易。让我看看:</p><p id="0c0a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">假设我们有一个Swarm或Docker组合堆栈，如下所示:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="681e" class="jm jn hh ji b fi jo jp l jq jr">version: '3.6'<br/>services:<br/>  db:<br/>    image: oracle/database:12.2.0.1-ee<br/>    hostname: ols<br/>    volumes:<br/>      - /home/data/db/12cR2.test:/opt/oracle/oradata <br/>      - /run/shm:/dev/shm<br/>    ports:<br/>      - 1521:1521<br/>    environment:<br/>      - ORACLE_SID=TEST<br/>      - ORACLE_PDB=PDB1</span></pre><p id="1c58" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正在工作的<strong class="ig hi"> <em class="js"> 12cR2 </em> </strong> RDBMS数据库要迁移到19.3，首先由于自动升级要求我们需要一个在归档日志模式下工作的RDBMS，请将其更改为执行:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="0613" class="jm jn hh ji b fi jo jp l jq jr">SQL&gt; alter system set <strong class="ji hi"><em class="js">db_recovery_file_dest_size=30g</em></strong> scope=both;</span><span id="8c38" class="jm jn hh ji b fi jt jp l jq jr">System altered.</span><span id="4c3f" class="jm jn hh ji b fi jt jp l jq jr">SQL&gt; shutdown immediate;<br/>Database closed.<br/>Database dismounted.<br/>ORACLE instance shut down.<br/>SQL&gt; startup mount;<br/>ORACLE instance started.</span><span id="67e9" class="jm jn hh ji b fi jt jp l jq jr">Total System Global Area 1610612736 bytes<br/>Fixed Size      8793304 bytes<br/>Variable Size    520094504 bytes<br/>Database Buffers  1073741824 bytes<br/>Redo Buffers      7983104 bytes<br/>Database mounted.<br/>SQL&gt; <strong class="ji hi"><em class="js">alter database archivelog</em></strong>;</span><span id="979f" class="jm jn hh ji b fi jt jp l jq jr">Database altered.</span><span id="5f83" class="jm jn hh ji b fi jt jp l jq jr">SQL&gt; <strong class="ji hi"><em class="js">alter database open</em></strong>;</span><span id="33f8" class="jm jn hh ji b fi jt jp l jq jr">Database altered.</span></pre><p id="8cf5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要升级到19c，我们将采用两步迁移选项，首先运行分析-修复，最后升级，如图所示</p><figure class="jd je jf jg fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es ju"><img src="../Images/ede18c391ba9de60afcd2657ebb8b2a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fgFgEkBEuyut6iya9XHLlA.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx">auto-upgrade steps</figcaption></figure><p id="af7d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为此，我们将使用一个<a class="ae jc" href="https://gist.githubusercontent.com/marcelo-ochoa/1c0299bc3151b70695f1eb548e879575/raw/d5019a7ea3b994c89cef71807421688fe90285b5/migrate.sh" rel="noopener ugc nofollow" target="_blank"> migrate.sh </a> bash脚本</p><figure class="jd je jf jg fd jv"><div class="bz dy l di"><div class="kg kh l"/></div><figcaption class="kc kd et er es ke kf bd b be z dx">migrate.sh bash script</figcaption></figure><p id="d3c5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该脚本旨在使用RDBMS映像提供的启动功能运行，这些映像是使用Oracle官方构建<a class="ae jc" href="https://github.com/oracle/docker-images/tree/master/OracleDatabase/SingleInstance" rel="noopener ugc nofollow" target="_blank">脚本</a>创建的。</p><p id="35c4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了执行上述脚本，我们将更改Docker堆栈定义，添加新的挂载文件:</p><blockquote class="ki kj kk"><p id="ee7a" class="ie if js ig b ih ii ij ik il im in io kl iq ir is km iu iv iw kn iy iz ja jb ha bi translated">.....<br/>卷:<br/>-/home/data/db/12cr 2 . test:/opt/Oracle/oradata<br/>-/home/Oracle/auto upgrade . jar:/opt/Oracle/scripts/startup/auto upgrade . jar<br/>-/home/Oracle/migrate . conf:/opt/Oracle/scripts/startup/migrate . conf<br/>-/home/Oracle/migrate . sh:/opt/Oracle/scripts/startup/migrate . sh<br/>-/run/shm:/dev/shm</p></blockquote><p id="bc15" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"><em class="js">auto upgrade . jar</em></strong>从我的Oracle support <a class="ae jc" href="https://support.oracle.com/epmos/main/downloadattachmentprocessor?parent=DOCUMENT&amp;sourceId=2485457.1&amp;attachid=2485457.1:AUTOUPGRADE&amp;clickstream=yes" rel="noopener ugc nofollow" target="_blank">链接</a>下载。将上述挂载选项添加到<strong class="ig hi"><em class="js">docker-compose-migrate . yml</em></strong>文件中，需要关机-启动，让我们试试:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="e9bb" class="jm jn hh ji b fi jo jp l jq jr">oracle@localhost:~/sample-stacks$ docker service scale migrate_db=0<br/>oracle@localhost:~/sample-stacks$ docker stack deploy -c docker-compose-migrate.yml migrate</span></pre><p id="6150" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="js"> migrate.conf </em> </strong>文件只有定义源版本和目标版本的选项，在我们的例子中是:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="8e17" class="jm jn hh ji b fi jo jp l jq jr">global.autoupg_log_dir=/tmp/jobmgr<br/>upg1.dbname=TEST<br/>upg1.source_home=/opt/oracle/product/12.2.0.1/dbhome_1<br/>upg1.target_home=/opt/oracle/product/19c/dbhome_1<br/>upg1.sid=TEST<br/>upg1.start_time=now<br/>upg1.pdbs=*<br/>upg1.log_dir=/tmp<br/>upg1.upgrade_node=localhost<br/>upg1.run_utlrp=yes<br/>upg1.timezone_upg=yes<br/>upg1.target_version=19.3</span></pre><p id="e91d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当修改了堆栈的数据库启动时，它将记录以下输出:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="0381" class="jm jn hh ji b fi jo jp l jq jr">migrate_db.1.3pfwfxwkgo66@localhost    | /opt/oracle/runUserScripts.sh: running /opt/oracle/scripts/startup/migrate.sh<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Executing /opt/oracle/scripts/startup<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Autoupgrade tool launched with default options<br/>migrate_db.1.3pfwfxwkgo66@localhost    | +--------------------------------+<br/>migrate_db.1.3pfwfxwkgo66@localhost    | | Starting AutoUpgrade execution |<br/>migrate_db.1.3pfwfxwkgo66@localhost    | +--------------------------------+<br/>migrate_db.1.3pfwfxwkgo66@localhost    | 1 databases will be analyzed<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Job 100 completed<br/>migrate_db.1.3pfwfxwkgo66@localhost    | ------------------- Final Summary --------------------<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Number of databases            [ 1 ]<br/>migrate_db.1.3pfwfxwkgo66@localhost    | <br/>migrate_db.1.3pfwfxwkgo66@localhost    | Jobs finished successfully     [1]<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Jobs failed                    [0]<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Jobs pending                   [0]<br/>migrate_db.1.3pfwfxwkgo66@localhost    | ------------- JOBS FINISHED SUCCESSFULLY -------------<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Job 100 FOR TEST<br/>migrate_db.1.3pfwfxwkgo66@localhost    | <br/>migrate_db.1.3pfwfxwkgo66@localhost    | Autoupgrade tool launched with default options<br/>migrate_db.1.3pfwfxwkgo66@localhost    | +--------------------------------+<br/>migrate_db.1.3pfwfxwkgo66@localhost    | | Starting AutoUpgrade execution |<br/>migrate_db.1.3pfwfxwkgo66@localhost    | +--------------------------------+<br/>migrate_db.1.3pfwfxwkgo66@localhost    | 1 databases will be processed<br/>migrate_db.1.3pfwfxwkgo66@localhost    | <br/>migrate_db.1.3pfwfxwkgo66@localhost    | -------------------------------------------------<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Errors in database [TEST]<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Stage     [PRECHECKS]<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Operation [STOPPED]<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Status    [ERROR]<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Info    [<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Error: <br/>migrate_db.1.3pfwfxwkgo66@localhost    | [Unexpected Exception Error]<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Cause: <br/>migrate_db.1.3pfwfxwkgo66@localhost    | For further details, see the log file located at /tmp/TEST/101/autoupgrade_20190504_user.log]<br/>migrate_db.1.3pfwfxwkgo66@localhost    | <br/>migrate_db.1.3pfwfxwkgo66@localhost    | -------------------------------------------------<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Logs: [/tmp/TEST/101/autoupgrade_20190504_user.log]<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Job 101 completed<br/>migrate_db.1.3pfwfxwkgo66@localhost    | ------------------- Final Summary --------------------<br/>migrate_db.1.3pfwfxwkgo66@localhost    | Number of databases            [ 1 ]</span></pre><p id="410d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我的测试中，失败的作业(101)表明没有足够的快速恢复区，但是有了上面定义的30Gb，迁移过程将正常结束。</p><p id="ac03" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，数据库已检查完毕，并准备好迁移到19.3版本，让我们用新的docker映像版本更改我们的docker-compose文件，并使用升级工具启动，更改如下所示:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="6923" class="jm jn hh ji b fi jo jp l jq jr">version: '3.6'<br/>services:<br/>  db:<br/>    image: <strong class="ji hi"><em class="js">oracle/database:19.3.0-ee</em></strong><br/>    <strong class="ji hi"><em class="js">command</em></strong>: /opt/oracle/scripts/startup/migrate.sh <strong class="ji hi"><em class="js">upgrade</em></strong><br/>    hostname: ols<br/>    volumes:<br/>...</span></pre><p id="8313" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，我们将Oracle Docker映像更改为19.3，并使用命令upgrade将默认启动脚本替换为migrate.sh，再次需要关机启动:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="98b4" class="jm jn hh ji b fi jo jp l jq jr">oracle@localhost:~/sample-stacks$ docker service scale migrate_db=0<br/>oracle@localhost:~/sample-stacks$ docker stack deploy -c docker-compose-migrate.yml migrate</span></pre><p id="d152" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">RDBMS启动时将按原样显示升级过程:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="8340" class="jm jn hh ji b fi jo jp l jq jr">migrate_db.1.tdkei09htk99@localhost    | SQL*Plus: Release 19.0.0.0.0 - Production on Sat May 4 13:56:16 2019<br/>migrate_db.1.tdkei09htk99@localhost    | Version 19.3.0.0.0<br/>....<br/>migrate_db.1.tdkei09htk99@localhost    | Autoupgrade tool launched with default options<br/>migrate_db.1.tdkei09htk99@localhost    | +--------------------------------+<br/>migrate_db.1.tdkei09htk99@localhost    | | Starting AutoUpgrade execution |<br/>migrate_db.1.tdkei09htk99@localhost    | +--------------------------------+<br/>migrate_db.1.tdkei09htk99@localhost    | 1 databases will be processed<br/>....<br/>migrate_db.1.tdkei09htk99@localhost    | Job 100 completed<br/>migrate_db.1.tdkei09htk99@localhost    | ------------------- Final Summary --------------------<br/>migrate_db.1.tdkei09htk99@localhost    | Number of databases            [ 1 ]<br/>migrate_db.1.tdkei09htk99@localhost    | <br/>migrate_db.1.tdkei09htk99@localhost    | Jobs finished successfully     [1]<br/>migrate_db.1.tdkei09htk99@localhost    | Jobs failed                    [0]<br/>migrate_db.1.tdkei09htk99@localhost    | Jobs pending                   [0]<br/>migrate_db.1.tdkei09htk99@localhost    | ------------- JOBS FINISHED SUCCESSFULLY -------------<br/>migrate_db.1.tdkei09htk99@localhost    | Job 100 FOR TEST<br/>migrate_db.1.tdkei09htk99@localhost    | <br/>migrate_db.1.tdkei09htk99@localhost    | Remember to update /etc/oratab file with new ORACLE_HOME!!!...</span></pre><p id="89c4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后一条消息告诉我们，驻留在持久性存储中的/etc/oratab文件需要用新的Oracle主目录进行更新，现在是19c二进制版本:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="b774" class="jm jn hh ji b fi jo jp l jq jr">root@localhost:/home/data/db/12cR2.test# cat dbconfig/TEST/oratab <br/>#<br/>TEST:<strong class="ji hi"><em class="js">/opt/oracle/product/19c/dbhome_1</em></strong>:N</span></pre><p id="e76c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以上更改确保了<strong class="ig hi"> <em class="js"> checkStatus.sh </em> </strong>脚本在下次启动时将正常工作，最后通过删除docker compose命令选项和升级文件将我的数据库升级到19c:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="77d5" class="jm jn hh ji b fi jo jp l jq jr">version: '3.6'<br/>services:<br/>  db:<br/>    image: <strong class="ji hi"><em class="js">oracle/database:19.3.0-ee</em></strong><br/>    hostname: ols<br/>    volumes:<br/>      - /home/data/db/12cR2.test:/opt/oracle/oradata <br/>      - /run/shm:/dev/shm<br/>    ports:<br/>      - 1521:1521<br/>    environment:<br/>      - ORACLE_SID=TEST<br/>      - ORACLE_PDB=PDB1</span></pre><p id="40d8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">根据上述docker-compose.yml定义，需要一个最终关机启动数据库:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="962f" class="jm jn hh ji b fi jo jp l jq jr">oracle@localhost:~/sample-stacks$ docker service scale migrate_db=0<br/>oracle@localhost:~/sample-stacks$ docker stack deploy -c docker-compose-migrate.yml migrate</span></pre><p id="50ef" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">日志输出将显示我们的19.3数据库已准备就绪:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="d225" class="jm jn hh ji b fi jo jp l jq jr">migrate_db.1.r9yhv9labpah@localhost    | Version <strong class="ji hi"><em class="js">19.3.0.0.0</em></strong><br/>migrate_db.1.r9yhv9labpah@localhost    | The Oracle base remains unchanged with value /opt/oracle<br/>migrate_db.1.r9yhv9labpah@localhost    | #########################<br/>migrate_db.1.r9yhv9labpah@localhost    | DATABASE IS READY TO USE!<br/>migrate_db.1.r9yhv9labpah@localhost    | #########################<br/>....<br/>migrate_db.1.r9yhv9labpah@localhost    | ===========================================================<br/>migrate_db.1.r9yhv9labpah@localhost    | Dumping current patch information<br/>migrate_db.1.r9yhv9labpah@localhost    | ===========================================================<br/>migrate_db.1.r9yhv9labpah@localhost    | <strong class="ji hi"><em class="js">Patch Id: 29517242</em></strong><br/>migrate_db.1.r9yhv9labpah@localhost    | Patch Description: Database Release Update : 19.3.0.0.190416 (29517242)<br/>migrate_db.1.r9yhv9labpah@localhost    | Patch Apply Time: 2019-04-18T07:21:17Z<br/>....<br/>migrate_db.1.r9yhv9labpah@localhost    | <strong class="ji hi"><em class="js">Patch Id: 29585399</em></strong><br/>migrate_db.1.r9yhv9labpah@localhost    | Patch Description: OCW RELEASE UPDATE 19.3.0.0.0 (29585399)<br/>migrate_db.1.r9yhv9labpah@localhost    | Patch Apply Time: 2019-04-18T07:21:33Z</span></pre><p id="a82b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">升级您的RDBMs是一件愉快的事情。</p></div></div>    
</body>
</html>