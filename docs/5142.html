<html>
<head>
<title>Multiple aggregations on one list? That can be optimized. — Mendix and Me</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个列表中有多个聚合？可以优化的。——门迪克斯和我</h1>
<blockquote>原文：<a href="https://medium.com/mendix/multiple-aggregations-on-one-list-that-can-be-optimized-mendix-and-me-ad4de30e08a9?source=collection_archive---------1-----------------------#2021-09-24">https://medium.com/mendix/multiple-aggregations-on-one-list-that-can-be-optimized-mendix-and-me-ad4de30e08a9?source=collection_archive---------1-----------------------#2021-09-24</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/087737f2b4be114581449ee01ad4e49e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JqxjzJEk4DPnTkcTdRU1rQ.png"/></div></div></figure><div class=""/><p id="c727" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">这篇文章是关于数据库查询的优化。更准确地说，是关于一种特殊类型的查询的优化，即聚合。</p><h1 id="6878" class="jz ka if bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">Mendix中的聚合</h1><p id="ffb2" class="pw-post-body-paragraph jc jd if bd b je kx jg jh ji ky jk jl jm kz jo jp jq la js jt ju lb jw jx jy hn dt translated">聚合是对数据库条目列表中某一列的值的计算。典型的聚合是求和、求平均值、寻找最大或最小的元素…</p><p id="0943" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">我们将查看聚合，我们实际上只对结果感兴趣，但不需要实际值或数据库条目。特别是，它还涉及到当您需要在同一个对象列表上进行多个聚合时，如何优化调用。</p><p id="3dcd" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">在Mendix中有一个“聚合列表”动作，我们可以用它在列表上执行这样的聚合。让我们考虑下面的数据模型。</p><figure class="ld le lf lg fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff lc"><img src="../Images/874586a219d6dd200d3bf37c0c475379.png" data-original-src="https://miro.medium.com/v2/resize:fit:682/format:webp/0*2NhExTRQm06KgyfW.png"/></div></div></figure><p id="b45e" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">我想要实现的目标是计算每个属性的所有记录的总和。</p><figure class="ld le lf lg fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff lh"><img src="../Images/9095925fed5d19ba898085953e9245c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HUEzJLQIRIGPAbc7QchY_w.png"/></div></div><figcaption class="li lj fg fe ff lk ll bd b be z ek"><a class="ae lm" href="https://www.mendix.com/pricing/" rel="noopener ugc nofollow" target="_blank">https://www.mendix.com/pricing/</a></figcaption></figure><h1 id="6da9" class="jz ka if bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">明显的解决方案</h1><p id="cb0c" class="pw-post-body-paragraph jc jd if bd b je kx jg jh ji ky jk jl jm kz jo jp jq la js jt ju lb jw jx jy hn dt translated">下面是解决这个问题的一个非常简单(并且有效)的方法。</p><figure class="ld le lf lg fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff ln"><img src="../Images/17a16590681a61c750ee94f5f2f2f728.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xMP5aksxN7cXLMvK.png"/></div></div></figure><p id="7fac" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">在这个微流中，首先执行检索。在结果列表中，聚合现在是一个接一个地进行的。结果存储在result对象中。这工作完美无缺，结果是理想的。但是执行速度很差。在我的示例数据库中，执行这个微流大约需要2500毫秒。</p><p id="074f" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">这种解决方案的问题是列表首先从数据库加载到运行时。在那里它被聚集。但是，任何直接使用过数据库的人都知道，数据库本身可以执行聚合。数据库在这方面非常擅长。因此，我们希望有一种方法让数据库来完成这项工作。</p><h1 id="c4ae" class="jz ka if bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">最佳实践</h1><p id="a8a1" class="pw-post-body-paragraph jc jd if bd b je kx jg jh ji ky jk jl jm kz jo jp jq la js jt ju lb jw jx jy hn dt translated">上述解决方案的问题是，Mendix仅在以下情况下优化聚合:首先，检索和聚合直接在一起；其次，不对列表执行任何其他操作(即使它“仅”是其他聚合)。因此，即使乍看起来更费力，更好的选择是对每个聚合进行专门的检索。相应的微流看起来像这样。</p><figure class="ld le lf lg fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff ln"><img src="../Images/0d646d0f81523acdd58f077f9a4b0735.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xHx4QZPQs5BGKOj1.png"/></div></div></figure><p id="4126" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">在这个微流中，相同的列表被一遍又一遍地检索，然后立即执行聚合。由于这些列表都没有被进一步使用，Mendix优化了调用并直接在数据库上执行聚合。这些列表不会加载到运行时中。在那里只能找到聚合的结果。</p><p id="4992" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">在我的示例数据库中，这个微流的执行时间大约为240毫秒。因此，它比显而易见的解决方案快10倍。</p><p id="7b14" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">但是为什么要进行4次数据库调用来得到一个结果呢？在数据库中，你可以在一次调用中处理所有的事情？没错。整个事情的最终优化正是利用了这一点。</p><h1 id="ae78" class="jz ka if bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">OQL的速度更快</h1><p id="2c83" class="pw-post-body-paragraph jc jd if bd b je kx jg jh ji ky jk jl jm kz jo jp jq la js jt ju lb jw jx jy hn dt translated">我们不得不承认，这个解决方案是用Mendix板工具做不到的。我们需要来自门迪克斯市场的<a class="ae lm" href="https://marketplace.mendix.com/link/component/66876" rel="noopener ugc nofollow" target="_blank"> OQL模块</a>。在这个模块的帮助下，我们可以在数据库上执行OQL查询。这允许我们将所有的聚合放在一个数据库交互中。相应的微流如下所示。</p><figure class="ld le lf lg fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff lo"><img src="../Images/8048b07a2e9e0cecdf92f6acaa2ba408.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*S2Gkh6DIyogfyoM6.png"/></div></div></figure><p id="c412" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">是的，它实际上只有一个动作。其中执行了以下语句。</p><pre class="ld le lf lg fq lp lq lr ls aw lt dt"><span id="d938" class="lu ka if lq b fv lv lw l lx ly">SELECT<br/>  SUM(Entity.FirstDecimal) AS SumDecimal,<br/>  SUM(Entity.AnotherDecimal) AS SumAnotherDecimal,<br/>  SUM(Entity.ThirdDecimal) AS SumThirdDecimal,<br/>  SUM(Entity.LastDecimal) AS SumLastDecimal<br/>FROM<br/>  MyFirstModule.Entity AS Entity</span></pre><p id="2561" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">执行OQL语句动作在数据库上执行代码，并直接为我们创建一个结果对象。这里唯一需要注意的是，选择的别名必须与结果实体的属性名相匹配。</p><p id="4119" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">在我的示例数据库中，这个微流大约在90毫秒内执行。因此，在最佳实践和OQL变体之间，这又是一个相当大的性能跳跃。</p><h1 id="76c4" class="jz ka if bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw dt translated">结论</h1><p id="eaa1" class="pw-post-body-paragraph jc jd if bd b je kx jg jh ji ky jk jl jm kz jo jp jq la js jt ju lb jw jx jy hn dt translated">对于聚合，您至少应该始终使用Mendix最佳实践，并专门为一个聚合检索一个列表。只有这样，平台才会优化执行，让数据库来做工作。在某些情况下，尤其是对于许多记录或复杂的数据结构，使用OQL进一步优化会很有用。该图令人印象深刻地显示了执行速度的差异。</p><figure class="ld le lf lg fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff ln"><img src="../Images/468ca2808508a1011801aa03fdab2183.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MjS0uOSjK_a7aK2g.png"/></div></div></figure><p id="d468" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">在这里，显而易见的解决方案的性能会有多差。当只比较这两者时，最佳实践和OQL解决方案之间的差异就变得更加明显了。</p><figure class="ld le lf lg fq hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff lz"><img src="../Images/24823d3a8a393376719a9ea43ccfa79e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jezZcVFun6LvnNQ9.png"/></div></div></figure><p id="2aba" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">您还应该记住，所示的示例是一个非常简单的查询。数据库不需要执行任何复杂的连接。如果这些是必要的(在真实的例子中，它们几乎总是必要的),差异可能会显著得多。</p><p id="188a" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">一如既往，我希望你在尝试这个过程中获得很多乐趣。我也总是很高兴你的反馈-让我知道你的想法！</p><h2 id="8e08" class="lu ka if bd kb ma mb mc kf md me mf kj jm mg mh kn jq mi mj kr ju mk ml kv mm dt translated">阅读更多</h2><div class="ht hu fm fo hv mn"><a href="https://docs.mendix.com/refguide/aggregate-list" rel="noopener  ugc nofollow" target="_blank"><div class="mo ab ej"><div class="mp ab mq cl cj mr"><h2 class="bd ig fv z el ms eo ep mt er et ie dt translated">汇总列表- Studio Pro 9指南| Mendix文档</h2><div class="mu l"><h3 class="bd b fv z el ms eo ep mt er et ek translated">这种活性可用于微流和纳流。汇总清单活动可用于计算…</h3></div><div class="mv l"><p class="bd b gc z el ms eo ep mt er et ek translated">docs.mendix.com</p></div></div></div></a></div><div class="ht hu fm fo hv mn"><a href="https://docs.mendix.com/refguide/oql" rel="noopener  ugc nofollow" target="_blank"><div class="mo ab ej"><div class="mp ab mq cl cj mr"><h2 class="bd ig fv z el ms eo ep mt er et ie dt translated">OQL - Studio Pro 9指南| Mendix文档</h2><div class="mu l"><h3 class="bd b fv z el ms eo ep mt er et ek translated">Mendix对象查询语言(OQL)是一种关系查询语言，就像SQL一样。OQL的主要优势是…</h3></div><div class="mv l"><p class="bd b gc z el ms eo ep mt er et ek translated">docs.mendix.com</p></div></div></div></a></div><div class="ht hu fm fo hv mn"><a href="https://docs.mendix.com/howto/logic-business-rules/optimizing-microflow-aggregates" rel="noopener  ugc nofollow" target="_blank"><div class="mo ab ej"><div class="mp ab mq cl cj mr"><h2 class="bd ig fv z el ms eo ep mt er et ie dt translated">优化微流聚合- Studio Pro 9操作指南| Mendix文档</h2><div class="mu l"><h3 class="bd b fv z el ms eo ep mt er et ek translated">在某些应用中，有必要评估微流中的大型数据集(例如，用于报告目的)。如果全部…</h3></div><div class="mv l"><p class="bd b gc z el ms eo ep mt er et ek translated">docs.mendix.com</p></div></div></div></a></div></div><div class="ab cl mw mx hb my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="hn ho hp hq hr"><p id="9795" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated"><em class="nd">原文于2021年9月24日</em> <a class="ae lm" href="https://mendixandme.de/index.php/2021/09/24/mehrere-aggregationen-auf-einer-liste-das-laesst-sich-optimieren/" rel="noopener ugc nofollow" target="_blank"> <em class="nd">以德语发表https://mendixamme . de</em></a><em class="nd">。</em></p></div><div class="ab cl mw mx hb my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="hn ho hp hq hr"><p id="ad7b" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated"><em class="nd">来自发布者- </em></p><p id="627b" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">如果你喜欢这篇文章，你可以在我们的 <a class="ae lm" href="https://medium.com/mendix" rel="noopener"> <em class="nd">中页</em> </a> <em class="nd">找到更多喜欢的。对于精彩的视频和直播会话，您可以前往</em><a class="ae lm" href="https://www.mendix.com/live/" rel="noopener ugc nofollow" target="_blank"><em class="nd">MxLive</em></a><em class="nd">或我们的社区</em><a class="ae lm" href="https://www.youtube.com/c/MendixCommunity/community" rel="noopener ugc nofollow" target="_blank"><em class="nd">Youtube PAG</em></a><em class="nd">e .</em></p><p id="7d12" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated"><em class="nd">希望入门的创客，可以注册一个</em> <a class="ae lm" href="https://signup.mendix.com/link/signup/?source=direct" rel="noopener ugc nofollow" target="_blank"> <em class="nd">免费账号</em> </a> <em class="nd">，通过我们的</em> <a class="ae lm" href="https://academy.mendix.com/link/home" rel="noopener ugc nofollow" target="_blank"> <em class="nd">学苑</em> </a> <em class="nd">即时获取学习。</em></p><p id="42a8" class="pw-post-body-paragraph jc jd if bd b je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy hn dt translated">有兴趣更多地参与我们的社区吗？你可以加入我们的 <a class="ae lm" href="https://join.slack.com/t/mendixcommunity/shared_invite/zt-hwhwkcxu-~59ywyjqHlUHXmrw5heqpQ" rel="noopener ugc nofollow" target="_blank"> <em class="nd"> Slack社区频道</em> </a> <em class="nd">或者想更多参与的人，看看加入我们的</em><a class="ae lm" href="https://developers.mendix.com/meetups/#meetupsNearYou" rel="noopener ugc nofollow" target="_blank"><em class="nd">Meet ups</em></a><em class="nd">。</em></p></div></div>    
</body>
</html>