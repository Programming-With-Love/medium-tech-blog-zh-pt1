<html>
<head>
<title>Building a video player app in Android (Part 3 / 5)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Android中构建视频播放器应用程序(第3 / 5部分)</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/building-a-video-player-app-in-android-part-3-5-19543ea9d416?source=collection_archive---------5-----------------------#2018-03-09">https://medium.com/androiddevelopers/building-a-video-player-app-in-android-part-3-5-19543ea9d416?source=collection_archive---------5-----------------------#2018-03-09</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="1c97" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">使用ExoPlayer、播放列表、媒体会话、音频聚焦、画中画</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/2eed2a5c9bda533975efea4a4131b83e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UJISwRlkYE8nJzVJdudikw.png"/></div></div></figure><p id="8229" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">本系列文章的目标是让您开始使用ExoPlayer构建一个简单但功能丰富的视频播放器应用程序(支持播放列表、媒体会话、音频焦点和画中画)。</p><p id="3d2d" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这是5部分系列的第3部分，包括:</p><ul class=""><li id="db2f" class="ke kf hh jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/@nazmul/building-a-video-player-app-in-android-part-1-5-d95770ef762d"> ExoPlayer简介</a></li><li id="cfa1" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/@nazmul/building-a-video-player-app-in-android-part-2-5-e5a5392879fa"> ExoPlayer播放列表、用户界面定制和事件</a></li><li id="ef2e" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated">ExoPlayer的MediaSession连接器扩展(<strong class="jk hi">本文</strong>)</li><li id="c2a6" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/@nazmul/building-a-video-player-app-in-android-part-4-5-c69f12b49143">支持音频聚焦</a></li><li id="f7ef" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/@nazmul/building-a-video-player-app-in-android-part-5-5-725c1ec2557a">支持PIP </a></li></ul><p id="365c" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">本系列的前一篇文章介绍了通过连接<code class="du kt ku kv kw b">MediaSource</code>创建播放列表所需的步骤，以及定制ExoPlayer播放控制UI的细节。本文将详细介绍如何使用MediaSession连接器扩展来无缝使用应用程序中的MediaSession功能。</p><h1 id="7c37" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">媒体会话概述</h1><p id="dc42" class="pw-post-body-paragraph ji jj hh jk b jl lp ii jn jo lq il jq jr lr jt ju jv ls jx jy jz lt kb kc kd ha bi translated">MediaSession允许播放器(运行您的媒体应用程序)中的信息暴露给Android操作系统的其他部分。</p><ul class=""><li id="6c20" class="ke kf hh jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated">诸如播放器当前是否暂停、正在播放或者加载了什么媒体之类的事情都通过MediaSession广播到操作系统的其他部分、其他应用或系统组件。这就是如何将当前正在播放的内容及其播放状态发送给<a class="ae kn" rel="noopener" href="/google-developers/migrating-mediastyle-notifications-to-support-android-o-29c7edeca9b7"> MediaStyle通知</a>或感兴趣的蓝牙设备。甚至是谷歌助手。</li><li id="e6e0" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated">其他应用程序和操作系统也可以通过绑定到MediaSession的<code class="du kt ku kv kw b"><a class="ae kn" href="https://developer.android.com/reference/android/media/session/MediaController.TransportControls.html" rel="noopener ugc nofollow" target="_blank">MediaController.TransportControls</a></code>操作播放器(在您的应用程序中运行)。这使得蓝牙耳机、谷歌助手甚至其他应用程序上的媒体按钮能够播放、暂停或跳过媒体应用程序中的歌曲。</li></ul><p id="60ea" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">总之，MediaSession有两个用途:发布关于应用程序中正在播放的当前媒体的元数据，以及允许其他组件(操作系统和其他应用程序)控制播放(在应用程序中)。蓝牙设备、Android Auto和Wear甚至谷歌助手都使用元数据。除了操作系统之外，回放控制还可以作为元数据使用(这样有线耳机的按钮按键就可以转换成应用程序可以使用的命令)。</p><p id="d3fc" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">关于MediaSession的更多细节，这里有一些资源。</p><ul class=""><li id="4de5" class="ke kf hh jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/google-developers/understanding-mediasession-part-1-3-e4d2725f18e4">了解MediaSession媒体篇</a></li><li id="8e51" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" href="https://developer.android.com/guide/topics/media-apps/working-with-a-media-session.html" rel="noopener ugc nofollow" target="_blank">与d.android.com媒体会议合作</a></li><li id="7708" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" href="https://github.com/googlesamples/android-MediaBrowserService" rel="noopener ugc nofollow" target="_blank">使用MediaSession的Android示例代码</a></li></ul><h1 id="7e01" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">使用MediaSession连接器扩展</h1><p id="4e58" class="pw-post-body-paragraph ji jj hh jk b jl lp ii jn jo lq il jq jr lr jt ju jv ls jx jy jz lt kb kc kd ha bi translated">确保将<a class="ae kn" href="https://github.com/google/ExoPlayer/tree/release-v2/extensions/mediasession" rel="noopener ugc nofollow" target="_blank">梯度依赖</a>添加到您的<code class="du kt ku kv kw b">build.gradle</code>文件中。</p><pre class="ix iy iz ja fd lu kw lv lw aw lx bi"><span id="1886" class="ly ky hh kw b fi lz ma l mb mc">ext { ver = “2.7.0” }<br/>dependencies {<br/>  implementation <br/>    “com.google.android.exoplayer:extension-mediasession:$ver”<br/>}</span></pre><p id="e178" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">然后，您可以创建会话并将其附加到播放器(在您的<code class="du kt ku kv kw b">VideoActivity</code>中)，如下所示。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="a5bd" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi">关于Java varargs和Kotlin的注意事项</strong> — ExoPlayer和MediaSession连接器扩展是用Java编写的，<code class="du kt ku kv kw b"><a class="ae kn" href="https://goo.gl/M7pwmg" rel="noopener ugc nofollow" target="_blank">setPlayer()</a></code>方法接受varargs作为第三个参数。当从Kotlin调用这个方法时，如果没有传递第三个参数，那么在使用Java时，一切都会如您所料。然而，如果您将null作为第三个参数传递，那么这将抛出一个<code class="du kt ku kv kw b">NullPointerException</code>。如果您有一个想要传递的参数列表，那么您必须使用<a class="ae kn" href="https://goo.gl/y13f9G" rel="noopener ugc nofollow" target="_blank">扩展操作符* </a>来将一个参数列表传递给Java varargs参数。这里有一个例子。</p><pre class="ix iy iz ja fd lu kw lv lw aw lx bi"><span id="6318" class="ly ky hh kw b fi lz ma l mb mc">val uriList = mutableListOf&lt;MediaSource&gt;()<br/>val mediaSource = ConcatenatingMediaSource(*uriList.toTypedArray())</span></pre><p id="ac8f" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这样做将启用基本的一组<a class="ae kn" href="https://developer.android.com/reference/android/media/session/PlaybackState.html#constants" rel="noopener ugc nofollow" target="_blank">回放动作</a> ( <code class="du kt ku kv kw b">ACTION_PLAY_PAUSE</code>、<code class="du kt ku kv kw b">ACTION_PLAY</code>、<code class="du kt ku kv kw b">ACTION_PAUSE</code>、<code class="du kt ku kv kw b">ACTION_SEEK_TO</code>、<code class="du kt ku kv kw b">ACTION_FAST_FORWARD</code>、<code class="du kt ku kv kw b">ACTION_REWIND</code>、<code class="du kt ku kv kw b">ACTION_STOP</code>)。这意味着连接器将能够处理通过MediaSession从媒体按钮生成的这些操作，例如蓝牙耳机中允许暂停、播放、快进和快退的按钮。</p><p id="653e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">然而，如果你想提供对播放列表的控制，那么你也必须告诉连接器通过添加一个<code class="du kt ku kv kw b"><a class="ae kn" href="http://google.github.io/ExoPlayer/doc/reference/index.html?com/google/android/exoplayer2/ext/mediasession/MediaSessionConnector.QueueNavigator.html" rel="noopener ugc nofollow" target="_blank">QueueNavigator</a></code>来处理<code class="du kt ku kv kw b">ACTION_SKIP_*</code>命令。这是一个可能的例子。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="4c3b" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">使用这个例子，你也可以改变创建你的ExoPlayer和它的播放列表的代码，这样播放列表就可以从这个相同的'<code class="du kt ku kv kw b">MediaCatalog</code>'列表对象中加载。加载播放列表的代码可能如下所示。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="b4e5" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">您还可以告诉连接器，除了上述操作之外，您还想处理其他MediaSession操作。您可以在这篇<a class="ae kn" rel="noopener" href="/google-exoplayer/the-mediasession-extension-for-exoplayer-82b9619deb2d">中型文章</a>中找到关于以下各项的更多信息。</p><ul class=""><li id="e0cc" class="ke kf hh jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated"><code class="du kt ku kv kw b">MediaSessionConnector.PlaybackPreparer</code> —这允许你处理像<code class="du kt ku kv kw b">ACTION_PREPARE_FROM_SEARCH</code>和<code class="du kt ku kv kw b">ACTION_PREPARE_FROM_URI</code>这样的动作，如果你想与Android Auto或Google Assistant集成，这是必需的。有关允许Google Assistant通过MediaSession控制您的媒体应用程序的更多信息，请参考这篇关于<a class="ae kn" href="https://developer.android.com/guide/topics/media-apps/interacting-with-assistant.html" rel="noopener ugc nofollow" target="_blank">developers.android.com</a>的文章。</li><li id="e9b4" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><code class="du kt ku kv kw b">MediaSessionConnector.PlaybackController</code> —这允许您处理基本的回放控制器动作，例如<code class="du kt ku kv kw b">ACTION_PLAY_PAUSE</code>和<code class="du kt ku kv kw b">ACTION_SEEK_TO</code>。这是可选的，如果你不用这个来拦截这样的呼叫，就用一个<code class="du kt ku kv kw b"><a class="ae kn" href="https://google.github.io/ExoPlayer/doc/reference/index.html?com/google/android/exoplayer2/ext/mediasession/DefaultPlaybackController.html" rel="noopener ugc nofollow" target="_blank">DefaultPlaybackController</a></code>。</li><li id="6884" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><code class="du kt ku kv kw b">MediaSessionConnector.QueueEditor</code> —这允许你处理<code class="du kt ku kv kw b">ACTION_SET_RATING</code>和其他<code class="du kt ku kv kw b">MediaSessionCompat.FLAG_HANDLES_QUEUE_COMMAND</code>命令。<code class="du kt ku kv kw b">TimelineQueueEditor</code>是与<code class="du kt ku kv kw b">DynamicConcatenatingMediaSource</code>一起工作的实现。</li><li id="4f9c" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><code class="du kt ku kv kw b">MediaSessionConnector.CustomActionProvider</code> —处理您希望在应用程序中提供的任何自定义操作，例如提供一种方法来控制应用程序中的<a class="ae kn" href="https://google.github.io/ExoPlayer/doc/reference/com/google/android/exoplayer2/ext/mediasession/RepeatModeActionProvider.html" rel="noopener ugc nofollow" target="_blank">重复模式</a>。</li></ul><h1 id="9808" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">GitHub上的源代码</h1><p id="33e2" class="pw-post-body-paragraph ji jj hh jk b jl lp ii jn jo lq il jq jr lr jt ju jv ls jx jy jz lt kb kc kd ha bi translated">通过遵循这5篇文章，你应该能够创建一个视频播放器应用程序，类似于我们已经创建的这个示例(你也可以从Android Studio获得)。</p><div class="mf mg ez fb mh mi"><a href="https://github.com/googlesamples/android-VideoPlayer" rel="noopener  ugc nofollow" target="_blank"><div class="mj ab dw"><div class="mk ab ml cl cj mm"><h2 class="bd hi fi z dy mn ea eb mo ed ef hg bi translated">谷歌样品/安卓视频播放器</h2><div class="mp l"><h3 class="bd b fi z dy mn ea eb mo ed ef dx translated">在GitHub上创建一个帐户，为android视频播放器的开发做出贡献。</h3></div><div class="mq l"><p class="bd b fp z dy mn ea eb mo ed ef dx translated">github.com</p></div></div><div class="mr l"><div class="ms l mt mu mv mr mw jg mi"/></div></div></a></div><h1 id="7139" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">进一步学习的资源</h1><p id="d56c" class="pw-post-body-paragraph ji jj hh jk b jl lp ii jn jo lq il jq jr lr jt ju jv ls jx jy jz lt kb kc kd ha bi translated"><strong class="jk hi"> ExoPlayer </strong></p><ul class=""><li id="7671" class="ke kf hh jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated"><a class="ae kn" href="https://codelabs.developers.google.com/codelabs/exoplayer-intro/#0" rel="noopener ugc nofollow" target="_blank"> IO17 ExoPlayer codelab </a></li><li id="4498" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" href="https://www.youtube.com/watch?v=6VjF638VObA" rel="noopener ugc nofollow" target="_blank"> IO14 ExoPlayer介绍视频</a></li><li id="5905" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" href="https://www.youtube.com/watch?v=jAZn-J1I8Eg" rel="noopener ugc nofollow" target="_blank"> IO17 ExoPlayer会话视频</a></li><li id="fdb2" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/google-exoplayer/exoplayer-2-x-why-what-and-when-74fd9cb139">为什么是ExoPlayer？</a></li><li id="e16a" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/google-exoplayer/exoplayer-2-6-1-whats-new-a9e54bffffc5">exo player v 2 . 6 . 1的最新变化</a></li></ul><p id="9c14" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi">媒体会话，音频焦点</strong></p><ul class=""><li id="0871" class="ke kf hh jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/google-exoplayer/the-mediasession-extension-for-exoplayer-82b9619deb2d">exo player的MediaSession扩展</a></li><li id="af13" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/google-developers/understanding-mediasession-part-1-3-e4d2725f18e4">什么是MediaSession </a></li><li id="f69c" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/google-developers/audio-focus-1-6b32689e4380">什么是音频焦点</a></li></ul><p id="8671" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi">破折号，HLS </strong></p><ul class=""><li id="ebe0" class="ke kf hh jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated"><a class="ae kn" href="https://goo.gl/r9fXXf" rel="noopener ugc nofollow" target="_blank">破折号，HLS </a></li><li id="8321" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" href="https://goo.gl/SNvMgQ" rel="noopener ugc nofollow" target="_blank"> Dash优于HLS等</a></li></ul><p id="2650" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi">画中画</strong></p><ul class=""><li id="7098" class="ke kf hh jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/google-developers/making-magic-moments-with-picture-in-picture-e02964bf75ae">奥利奥中的画中画模式</a></li></ul></div></div>    
</body>
</html>