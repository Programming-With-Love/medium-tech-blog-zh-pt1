<html>
<head>
<title>How to enable observability into your Crunchy Data PostgreSQL clusters via Datadog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何通过Datadog实现对您的海量数据PostgreSQL集群的观察</h1>
<blockquote>原文：<a href="https://medium.com/globant/how-to-enable-observability-into-your-crunchy-data-postgresql-clusters-via-datadog-60e0fa7a23a5?source=collection_archive---------0-----------------------#2022-08-31">https://medium.com/globant/how-to-enable-observability-into-your-crunchy-data-postgresql-clusters-via-datadog-60e0fa7a23a5?source=collection_archive---------0-----------------------#2022-08-31</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/7e597439118fd7ffda803d58345abaf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*epeOTe3VjtlD_sKVO2fQSA.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Crunchy Data integration with Datadog</figcaption></figure><p id="7344" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在本文中，我们将学习如何通过Datadog来观察您的数据Postgres集群。</p><p id="4365" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">那么，我们开始吧。</p><h1 id="ee2e" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">本文涵盖的内容:</strong></h1><ol class=""><li id="4e9d" class="kp kq hh iv b iw kr ja ks je kt ji ku jm kv jq kw kx ky kz bi translated">概观</li><li id="612f" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">需要能够观察到复杂的数据Postgres集群</li><li id="1833" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">可用选项</li><li id="1338" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">提议的解决方案</li><li id="deba" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">先决条件</li><li id="0be7" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">实施步骤</li><li id="710c" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">结论</li><li id="ed46" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">参考</li></ol><h1 id="e73c" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">概述:</strong></h1><p id="f12e" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lf jg jh ji lg jk jl jm lh jo jp jq ha bi translated"><strong class="iv hi"> PostgreSQL </strong></p><p id="ea2d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">PostgreSQL是一个强大的开源对象关系数据库系统，它使用并扩展了SQL语言，并结合了许多功能，可以安全地存储和扩展最复杂的数据工作负载。</p><p id="3ce4" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">PostgreSQL附带了许多功能,旨在帮助开发人员构建应用程序，管理人员保护数据完整性和构建容错环境，并帮助您管理数据，无论数据集大小。</p><p id="30cb" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">除了免费和开源之外，PostgreSQL还具有高度的可扩展性。你可以定义自己的数据类型，构建自定义函数，甚至用不同的编程语言编写代码，而不需要重新编译你的数据库。</p><p id="88fb" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">脆脆的数据</strong></p><p id="4b48" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这些易碎的数据有助于Kubernetes支持的商业分布式工具集部署企业级PostgreSQL数据库。</p><p id="e935" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Crunchy Data创建、扩展和管理生产就绪的Kubernetes Postgres数据库。您可以使用强大的控件轻松定制pod配置以满足您的需求。使用Postgres操作符，只需几个命令，就可以在几秒钟内配置一个启动并运行的新数据库，准备接收数据。</p><p id="3aaa" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">它对开发人员友好，高度可用，并提供灾难恢复功能。</p><p id="2986" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">它支持零停机软件升级，这意味着可以使用滚动更新无缝部署安全补丁、次要和主要升级，从而最大限度地减少对应用程序和服务的中断。</p><p id="0aa0" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">数据狗</strong></p><p id="af17" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Datadog是一种针对云规模应用的可观测性服务，通过一个位于SaaS的数据分析平台提供对服务器、数据库、工具和服务的监控。</p><p id="eb27" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Datadog本质上是一个云应用的监控和安全平台。它汇集了端到端的跟踪、指标和日志，使应用程序、基础设施和第三方服务完全可见。这些功能可以帮助企业保护他们的系统，避免停机，并确保客户获得最佳的用户体验。Datadog是一个授权工具。</p><h1 id="8e68" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">用例:</strong></h1><p id="7aee" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lf jg jh ji lg jk jl jm lh jo jp jq ha bi translated">虽然在PostgreSQL集群出现问题时，拥有高度可用且容错的系统有助于解决问题，但监控有助于在问题发生之前就预测到问题。此外，监控可以帮助您诊断和解决可能不会导致停机但会导致性能下降的其他问题。</p><p id="3dd8" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">当PostgreSQL存储应用程序的关键任务数据时，人们总是想知道数据库的性能如何。</p><p id="e426" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">我们可以参考一些特定于PostgreSQL的关键数据指标，这些指标可以帮助我们了解PostgreSQL数据库集群的状态和健康状况，如下所述。</p><ul class=""><li id="83d2" class="kp kq hh iv b iw ix ja jb je lj ji lk jm ll jq lm kx ky kz bi translated">集群中每个pod和节点的<strong class="iv hi"> CPU </strong>和<strong class="iv hi">内存</strong>使用情况。</li><li id="eda5" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><strong class="iv hi">备份状态</strong>:上次对集群进行备份的时间。绿色很好。橙色表示备份已超过一天，可能需要调查。</li><li id="9240" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><strong class="iv hi">活动连接</strong>:有多少客户端连接到数据库。连接的客户端太多可能会影响性能，当值接近100%时，可能会导致客户端无法连接。</li><li id="bb81" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><strong class="iv hi">事务空闲</strong>:有多少客户端的连接状态为“事务空闲”。处于这种状态的客户端太多会导致性能问题，在某些情况下还会导致维护问题。</li><li id="65b3" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><strong class="iv hi"> Idle </strong>:有多少台客户端已连接但处于“空闲”状态。</li><li id="76f2" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><strong class="iv hi">连接</strong>:事务连接中活动、空闲和空闲的聚合视图。</li><li id="66fa" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><strong class="iv hi">数据库大小</strong>:PostgreSQL集群中的数据库有多大。通常与另一个用于分析的指标结合使用，有助于跟踪总体磁盘使用情况，以及是否需要围绕PVC大小采取任何分类步骤。</li><li id="7876" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><strong class="iv hi">行活动</strong>:选择、插入、更新、删除的行数。这有助于您确定工作负载中读取和写入的百分比，并有助于使用其他指标做出数据库调优决策。</li><li id="341b" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><strong class="iv hi">复制状态</strong>:提供关于主PostgreSQL实例和副本PostgreSQL实例之间复制延迟(以字节和时间为单位)的指导信息。这可以指示在发生故障转移时会丢失多少数据。</li><li id="0b58" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><strong class="iv hi">冲突/死锁</strong>:当PostgreSQL无法完成操作时会出现这些情况，这会导致事务丢失。目标是让这些数字为0。如果出现这些情况，请检查您的数据访问和写入模式。</li><li id="129c" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><strong class="iv hi">缓存命中率</strong>:衡量有多少“工作数据”，例如正在被访问和操作的数据，驻留在内存中。这用于了解PostgreSQL需要利用多少磁盘。</li><li id="9ca1" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><strong class="iv hi">提交&amp;回滚</strong>:提交和回滚了多少事务。</li><li id="c32e" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><strong class="iv hi">锁</strong>:给定系统中存在的锁的数量。</li></ul><h1 id="5c08" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">解决方案:</strong></h1><p id="626e" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lf jg jh ji lg jk jl jm lh jo jp jq ha bi translated">建议的解决方案包括利用Datadog的能力来监控我们的复杂数据PostgreSQL集群工作负载。</p><figure class="lo lp lq lr fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ln"><img src="../Images/a8caeeef01cbeeecf57088dda4ed701d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XxursjtF9yPVhZZv"/></div></div></figure><p id="2fbc" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">如上图所示，我们将使用部署在Crunchy Data PostgreSQL cluster pods旁边的Datadog代理，作为边柜容器。这些Datadog代理被部署为一个DaemonSet，因此在Kubernetes集群中的每个节点上都可以使用Datadog代理来捕获复杂的数据指标。每个节点上运行的Datadog代理将从Crunchy Data pods中提取所有需要的指标，并将它们推送到Datadog服务器。一旦在Datadog服务器中可用，我们就可以以可视化的方式在仪表板中查看这些指标，并在其上创建警报。</p><h1 id="0e90" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">先决条件:</strong></h1><ol class=""><li id="1b38" class="kp kq hh iv b iw kr ja ks je kt ji ku jm kv jq kw kx ky kz bi translated">一个使用AKS部署Crunchy Data PostgreSQL集群的活动Azure订阅。</li><li id="8338" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">访问一个活跃的数据狗帐户。</li><li id="6c46" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">安装了Kubernetes命令行工具(kubectl)的工作站，用于与部署在AKS中的Kubernetes集群进行交互。</li><li id="2021" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq kw kx ky kz bi translated">在您的工作站上安装工作舵。</li></ol><h1 id="1c24" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">实施步骤:</strong></h1><p id="e261" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lf jg jh ji lg jk jl jm lh jo jp jq ha bi translated">我们可以使用<a class="ae li" href="https://docs.datadoghq.com/agent/kubernetes/?tab=helm" rel="noopener ugc nofollow" target="_blank">舵图</a>或直接使用<a class="ae li" href="https://docs.datadoghq.com/agent/kubernetes/?tab=daemonset" rel="noopener ugc nofollow" target="_blank"> DaemonSet </a>对象YAML定义来部署Datadog代理。</p><p id="cc29" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">数据狗配置</strong></p><p id="76d1" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">让我们使用舵图法，按照以下步骤操作。</p><ol class=""><li id="2774" class="kp kq hh iv b iw ix ja jb je lj ji lk jm ll jq kw kx ky kz bi translated">如果这是全新安装，请通过执行以下命令添加Helm Datadog repo</li></ol><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="fc3a" class="lx js hh lt b fi ly lz l ma mb"><em class="mc">helm repo add datadog https://helm.datadoghq.com</em></span><span id="f00f" class="lx js hh lt b fi md lz l ma mb"><em class="mc">helm repo update</em></span></pre><p id="e3f7" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">2.更新<em class="mc"> values.yaml </em>文件以启用“普罗米修斯刮擦”配置部分。使用Datadog<a class="ae li" href="https://github.com/DataDog/helm-charts/blob/master/charts/datadog/values.yaml" rel="noopener ugc nofollow" target="_blank"><em class="mc">values . YAML</em></a><em class="mc"/>配置文件作为参考，创建自己的<em class="mc"> values.yaml </em>文件。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="6cae" class="lx js hh lt b fi ly lz l ma mb"><em class="mc">prometheusScrape:</em></span><span id="58ed" class="lx js hh lt b fi md lz l ma mb"><em class="mc">    enabled: true</em></span></pre><p id="8f65" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">3.从Datadog UI中的<a class="ae li" href="https://app.datadoghq.com/organization-settings/api-keys" rel="noopener ugc nofollow" target="_blank">组织设置</a>页面检索您的Datadog API密钥，并运行以下命令</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="5d6c" class="lx js hh lt b fi ly lz l ma mb"><em class="mc">helm install datadog -f values.yaml  --set datadog.apiKey=&lt;DATADOG_API_KEY&gt; datadog/datadog --set targetSystem=linux</em></span></pre><p id="5f79" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">以上步骤将把Datadog代理作为daemonset安装到您的Kubernetes集群中。</p><p id="bd1f" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">易碎数据配置</strong></p><p id="1bf4" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">配置易碎数据，以支持将指标摄取到Datadog。</p><p id="b61c" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">有两个可能的选项来启用Datadog中来自Crunchy Data PostgreSQL集群的可观察性和指标摄取。让我们详细讨论这两者，并为实现选择最佳方案。</p><p id="d3cc" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">选项1:直接集成易碎数据PostgreSQL pods </strong></p><p id="c93a" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在这种方法中，Datadog代理将直接连接到Crunchy Data PostgreSQL集群数据库。它将使用基于用户名和密码的身份验证进行连接，然后从数据库中提取所需的指标。随后，它会将这些指标发送到Datadog服务器。</p><p id="fa4e" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">出于以下原因，我们不推荐这种方法。</p><ul class=""><li id="3885" class="kp kq hh iv b iw ix ja jb je lj ji lk jm ll jq lm kx ky kz bi translated">我们需要在每个我们想要监控的数据数据库中创建一个用户和角色。</li><li id="06ec" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated">Datadog代理使用基于用户名和密码的身份验证连接到数据库以收集指标。这有时会变得喋喋不休，并可能导致数据库性能问题。</li><li id="6494" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated">该选项仅提供数量非常有限的指标。</li></ul><p id="971a" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">备选方案2:基于PgMonitor和出口商的prometheus废料处理</strong></p><p id="ef91" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在这种方法中，Datadog代理不会直接连接到易碎的数据PostgreSQL集群数据库。相反，易碎的数据PostgreSQL pods将暴露特定端口和端点上基于普罗米修斯的指标(在pgMonitor和操作员的帮助下)。我们将配置Datadog代理来监听这个端点，以获取公开的指标。随后，数据狗代理会将这些指标发送到数据狗服务器。</p><p id="19bc" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这种方法解耦了Datadog代理和数据库之间的直接交互，从而有助于我们运行两个组件，而不会相互干扰。</p><p id="c2f2" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这是我们推荐的收集由pgMonitor堆栈和操作者公开的数据指标的方法。</p><p id="c0ce" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这个选项是合适的，因为Datadog代理不直接与数据库对话。相反，Datadog代理将废弃pgMonitor和操作员在端口9187上公开的所有指标。这种方法通过将数据压缩到Datadog中来获取几乎所有可用的指标。将获取大约463个自定义指标。</p><p id="ba2f" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">所需配置变更:</strong></p><p id="8b34" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">完整的数据Postgres运营商部署代码可以在<a class="ae li" href="https://github.com/CrunchyData/postgres-operator-examples/tree/main/helm" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="567d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">用以下内容更新“postgres-operator”的“Postgres”文件夹下的<em class="mc"> values.yaml </em>文件。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="4dd7" class="lx js hh lt b fi ly lz l ma mb"><em class="mc">monitoring: true</em></span><span id="b8a2" class="lx js hh lt b fi md lz l ma mb"><em class="mc">instances:</em></span><span id="6a75" class="lx js hh lt b fi md lz l ma mb"><em class="mc">   - name: '&lt;name_your_instance&gt;'</em></span><span id="02f2" class="lx js hh lt b fi md lz l ma mb"><em class="mc">     metadata:</em></span><span id="d93d" class="lx js hh lt b fi md lz l ma mb"><em class="mc">      labels:</em></span><span id="630d" class="lx js hh lt b fi md lz l ma mb"><em class="mc">       tags.datadoghq.com/env: "&lt;add_environment_name_here&gt;"</em></span><span id="eac7" class="lx js hh lt b fi md lz l ma mb"><em class="mc">       tags.datadoghq.com/service: "postgrescluster-&lt;add_cluster_name_here&gt;"</em></span><span id="9b93" class="lx js hh lt b fi md lz l ma mb"><em class="mc">       tags.datadoghq.com/version: "&lt;add_postgres_version_number_here&gt;"</em></span><span id="26ae" class="lx js hh lt b fi md lz l ma mb"><em class="mc">metadata:</em></span><span id="2afd" class="lx js hh lt b fi md lz l ma mb"><em class="mc">   annotations:</em></span><span id="aec1" class="lx js hh lt b fi md lz l ma mb"><em class="mc">     ad.datadoghq.com/database.check_names: '["openmetrics"]'</em></span><span id="ca19" class="lx js hh lt b fi md lz l ma mb"><em class="mc">     ad.datadoghq.com/database.init_configs: '[{}]'</em></span><span id="ee89" class="lx js hh lt b fi md lz l ma mb"><em class="mc">     ad.datadoghq.com/database.instances: '[{"prometheus_url":    "http://%%host%%:9187/metrics","namespace": "crunchy_data","metrics": ["*"]}]’</em></span></pre><p id="aa96" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">上面的代码确实支持对pod的监控。此外，它还做了另外两件事。</p><ul class=""><li id="2f62" class="kp kq hh iv b iw ix ja jb je lj ji lk jm ll jq lm kx ky kz bi translated">第一个是，标记您的松散数据Postgres pods，以便可以根据集群名称和环境名称过滤掉Datadog中的指标。当您跨多个帐户和环境管理多个集群时，拥有这些标记非常有帮助。</li><li id="0930" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated">第二个是，它向易碎的数据Postgres集群容器添加了注释。这是自动发现Datadog代理的pod所必需的。通过自动发现，Datadog代理可以检测本机Prometheus注释，并自动安排OpenMetrics检查，以收集Kubernetes中的pod公开的Prometheus指标。</li></ul><p id="64d2" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">如果您想了解有关自动发现的更多信息，请点击<a class="ae li" href="https://docs.datadoghq.com/getting_started/containers/autodiscovery/?tabs=adannotationsv2agent736" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><p id="d181" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">元数据部分中添加的注释包括一个检查名称、暴露指标的prometheus url以及将捕获所有指标的名称空间名称(在我们的例子中，我们将其称为<em class="mc">‘crunchy _ data’</em>)。与<em class="mc">“指标”</em>相对的<em class="mc"> * </em>表示，我们希望公开所有可用的指标。</p><p id="fcc8" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在Postgres部署的<em class="mc"> values.yaml </em>文件中添加上述配置后，通过使用修改后的<em class="mc"> values.yaml </em>重新部署来更新集群。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="c70c" class="lx js hh lt b fi ly lz l ma mb"><em class="mc">helm upgrade &lt;release_name&gt; &lt;chart_directory&gt; -f values.yaml -n &lt;namespace_name&gt;</em></span></pre><p id="0639" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">以上命令将升级您的集群。</p><h1 id="0c00" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">数据狗中的验证:</strong></h1><p id="72ee" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lf jg jh ji lg jk jl jm lh jo jp jq ha bi translated">等待几分钟，您将在Datadog中看到指标。</p><p id="8d23" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">登录Datadog UI后，请从左侧菜单导航至指标→摘要。</p><p id="a609" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">它将打开新的一页。在公制标签对应的文本框中输入<em class="mc">‘crunchy _ data’</em>,然后按回车键。</p><p id="8169" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">如果您还记得的话，我们在配置自动发现时已经给了<em class="mc">‘crunchy _ data’</em>作为名称空间名称。如果您提供了任何不同的名称，请相应地进行搜索。</p><p id="c1d9" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">我们得到了近463个自定义指标，如下所示。</p><figure class="lo lp lq lr fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es me"><img src="../Images/d1f91b9067b00139a6dab1d667264414.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UmC8FYjD9SBS13ES"/></div></div></figure><p id="5c9d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">如需了解所披露指标的详细信息，请点击<a class="ae li" href="https://access.crunchydata.com/documentation/pgmonitor/4.6/exporter/#metrics-collected" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><p id="0e37" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">一旦这些指标在您的Datadog帐户中可用，您也可以在这些指标上创建监视器/警报。也许，我会在我的下一篇文章中谈到这一点。</p><h1 id="06e7" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">概要</strong>:</h1><p id="6e87" class="pw-post-body-paragraph it iu hh iv b iw kr iy iz ja ks jc jd je lf jg jh ji lg jk jl jm lh jo jp jq ha bi translated">在本文中，我们展示了如何通过Datadog来观察您的复杂数据PostgreSQL集群。</p><p id="6f9e" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这将让您鸟瞰运行在您的基础设施中的数据库PostgreSQL集群。出现诸如高利用率、死锁、复制延迟、空闲连接等问题时。等等。，我们就可以根据Datadog中的指标做出明智的决策，从而更好地为我们的应用和服务提供服务。</p><h1 id="1c1d" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">参考文献:</strong></h1><ul class=""><li id="e618" class="kp kq hh iv b iw kr ja ks je kt ji ku jm kv jq lm kx ky kz bi translated"><a class="ae li" href="https://www.crunchydata.com/" rel="noopener ugc nofollow" target="_blank">https://www.crunchydata.com/</a></li><li id="764b" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><a class="ae li" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank">https://www.postgresql.org/</a></li><li id="6289" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><a class="ae li" href="https://www.datadoghq.com/" rel="noopener ugc nofollow" target="_blank">https://www.datadoghq.com/ </a></li><li id="0bad" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><a class="ae li" href="https://azure.microsoft.com/en-us/services/kubernetes-service/" rel="noopener ugc nofollow" target="_blank">https://azure.microsoft.com/en-us/services/kubernetes-service/</a></li><li id="b414" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><a class="ae li" href="https://kubernetes.io/docs/reference/kubectl/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/docs/reference/kubectl/</a></li><li id="74d8" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><a class="ae li" href="https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/</a></li><li id="7de2" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><a class="ae li" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank">https://helm.sh/</a></li><li id="c831" class="kp kq hh iv b iw la ja lb je lc ji ld jm le jq lm kx ky kz bi translated"><a class="ae li" href="https://docs.datadoghq.com/containers/kubernetes/prometheus/?tabs=helm" rel="noopener ugc nofollow" target="_blank">https://docs.datadoghq.com/containers/kubernetes/prometheus?tabs=helm (T11)</a></li></ul></div></div>    
</body>
</html>