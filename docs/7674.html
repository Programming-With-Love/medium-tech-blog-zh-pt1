<html>
<head>
<title>How we embraced the new release of Apache Kafka</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们如何拥抱阿帕奇卡夫卡的新版本</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/how-we-embraced-the-new-release-of-apache-kafka-9cf617546bb6?source=collection_archive---------1-----------------------#2017-04-14">https://medium.com/walmartglobaltech/how-we-embraced-the-new-release-of-apache-kafka-9cf617546bb6?source=collection_archive---------1-----------------------#2017-04-14</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="1241" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正如我们之前的帖子所介绍的(<a class="ae jc" rel="noopener" href="/walmartlabs/tech-transformation-real-time-messaging-at-walmart-8787f5ab19e8">链接1 </a>、<a class="ae jc" rel="noopener" href="/walmartlabs/kafka-ecosystem-on-walmarts-cloud-983570dff1f2#.7vpklr9md">链接2</a>)【Walmart.com】背后的许多应用程序都由高度可扩展的分布式流媒体平台<a class="ae jc" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi">阿帕奇卡夫卡</strong> </a>提供支持。随着高速革命，卡夫卡有了新的里程碑，<a class="ae jc" href="https://archive.apache.org/dist/kafka/0.10.1.0/RELEASE_NOTES.html" rel="noopener ugc nofollow" target="_blank">发布0.10 </a>。随着这一版本的发布，Kafka及其生态系统达到了一个新的成熟水平。在这篇文章中，我想分享我们最近关于Kafka 0.10发布的有趣结果。下一篇文章将更多地关注Kafka周围的流媒体、大数据和<a class="ae jc" href="http://hadoop.apache.org/" rel="noopener ugc nofollow" target="_blank"> Hadoop </a>生态系统。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/eb5ca181536cb031b734e421646f8c8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*kV768OHeCILNIYVCNPUyuQ.jpeg"/></div><figcaption class="jl jm et er es jn jo bd b be z dx">Kafka 0.10 and its Downstream Consumers around it</figcaption></figure><h2 id="0e6f" class="jp jq hh bd jr js jt ju jv jw jx jy jz ip ka kb kc it kd ke kf ix kg kh ki kj bi translated">消费者补偿存储:卡夫卡主题</h2><p id="8e06" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">在早期的Kafka版本中(0.8.2之前)，消费者将他们的补偿提交给动物园管理员。在上一个假期，我们的Zookeeper集群经历了大量的写操作，这是由许多用户频繁提交offset造成的。除了增加Zookeeper的容量(例如，SSD作为存储)，Kafka现在还提供了一种替代方法，可以将消费者补偿存储到一个特殊的、独立的Kafka主题中，该主题是可复制的、高度可用的。</p><p id="4543" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">考虑到这个新选项，我们进行了一些性能评估，以便更好地理解它，然后从Zookeeper迁移出来作为消费者补偿的存储。</p><p id="a035" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们在沃尔玛的<a class="ae jc" href="https://www.openstack.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi"> OpenStack </strong> </a>云上使用了8台虚拟机(VM)。在8个虚拟机之上，由沃尔玛的开源PaaS - <a class="ae jc" href="http://www.oneops.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi"> OneOps </strong> </a>部署Kafka release 0.10.1.0，形成1个Kafka集群。每台虚拟机都有以下规格:</p><ul class=""><li id="ca55" class="kp kq hh ig b ih ii il im ip kr it ks ix kt jb ku kv kw kx bi translated">8个CPU内核、24GB内存、1Gbps网卡、160GB磁盘(由固态硬盘备份)</li></ul><p id="cefb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Zookeeper集群在3个专用虚拟机上外部运行，也由<a class="ae jc" href="http://www.oneops.com/" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">OneOps</strong></a><strong class="ig hi"/>使用<a class="ae jc" href="https://github.com/oneops/circuit-oneops-1/tree/master/components/cookbooks/zookeeper" rel="noopener ugc nofollow" target="_blank"> Zookeeper cookbook </a>部署。</p><p id="eb32" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">创建了八个Kafka主题:每个主题有100个分区，两个副本，并设置了合理的保留策略以避免磁盘溢出。其他主题配置保持默认设置。</p><p id="b857" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了生成和使用工作负载(消息大小10KB)，我们使用了每个Apache Kafka版本附带的<a class="ae jc" href="https://github.com/apache/kafka/blob/trunk/bin/kafka-producer-perf-test.sh" rel="noopener ugc nofollow" target="_blank">生产者</a>和<a class="ae jc" href="https://github.com/apache/kafka/blob/trunk/bin/kafka-consumer-perf-test.sh" rel="noopener ugc nofollow" target="_blank">消费者性能测试套件</a>。为了减少网络延迟并完全加载Kafka集群，8个生产者和8个消费者被部署在与Kafka相同的数据中心中的独立虚拟机上。</p><p id="f640" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所有生产者和消费者都使用默认配置，只是我们在消费者端调整了以下配置:</p><ul class=""><li id="88fc" class="kp kq hh ig b ih ii il im ip kr it ks ix kt jb ku kv kw kx bi translated">auto.commit.interval.ms:使用者偏移量自动提交给Kafka或Zookeeper的频率(以毫秒为单位)</li></ul><p id="d0d8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">这是我们的观察结果之一:</strong></p><p id="a025" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当使用Kafka topic存储消费者补偿时，<strong class="ig hi">观察到一个小的性能损失</strong> (~7%的损失)。<em class="ky">这仅发生在提交用户偏移量的频率非常高时，可能会使磁盘过载</em>。</p><p id="2b05" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了验证这一点，我们设置<strong class="ig hi">auto . commit . interval . ms = 50</strong>来模拟提交偏移量的高频率，并注意到Kafka主题的写流量(<em class="ky"> _consumers_offsets_ </em>)很有趣:12k消息/秒仅生成1.2 MB/秒，转化为微小的消息大小，大约100字节:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es kz"><img src="../Images/8aeaa7b9658e9437ebc4633bb84d6280.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5h4FnBHvXt2huF_F3gbVGg.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx">Write bandwidth (MB/s) for Kafka topic (<em class="le">_consumers_offsets_</em>) that stores consumer offsets</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lf"><img src="../Images/c2596573e0f4719ec61e14b6d053d7b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v4MTyo06tRDQi6ytbr1lhw.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx">Number of message per second for Kafka topic (<em class="le">_consumers_offsets_</em>) that stores consumer offsets</figcaption></figure><p id="b2d9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于<em class="ky"> _consumers_offsets_ </em>主题在200个分区的情况下被复制了3次，因此可以合理地推断，代价可能是由于偏移量(微小的消息)必须被同步写入(至少两次)这一事实。然而，当提交频率不是很高时，没有观察到性能下降。以下是<strong class="ig hi">auto . commit . interval . ms</strong>= 50到5000之间的详细数字(默认为5000):</p><ol class=""><li id="3337" class="kp kq hh ig b ih ii il im ip kr it ks ix kt jb lg kv kw kx bi translated">Kafka吞吐量:533 MB/s对580MB/s</li><li id="150e" class="kp kq hh ig b ih lh il li ip lj it lk ix ll jb lg kv kw kx bi translated">消费者吞吐量:每秒53300条消息对每秒58000条消息</li></ol><p id="828d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所以<strong class="ig hi">我们初步的收获</strong>是:对于那些应该最小化重新处理消息的情况(为了实现这一点，消费者需要频繁地提交偏移量)，如果消费者偏移量存储在Kafka中，可能会潜在地存在一个小的性能损失。如果磁盘I/O带宽足够大，这可能是不可见的。总的来说，我们认为Kafka主题中的消费者偏移仍然比过载和停止Zookeeper要好，这会导致更糟糕的情况(例如，连接超时，无法选举领导者)。</p><h2 id="119b" class="jp jq hh bd jr js jt ju jv jw jx jy jz ip ka kb kc it kd ke kf ix kg kh ki kj bi translated"><strong class="ak"> SSL </strong>(安全套接字层)</h2><p id="e83f" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">为了服务于关键的业务用例(比如运送客户交易数据)，客户和Kafka之间的通信必须是安全的。为此，我们投资为Kafka 0.10版本启用SSL。我们将简要分享我们对SSL 的<strong class="ig hi">性能权衡的观察。</strong></p><p id="46b4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">毫无疑问，启用SSL会降低Kafka的性能，因为需要额外的加密和授权。如上所述，我们在SSL和非SSL之间进行了性能评估，以量化我们必须为SSL付出的性能损失。</p><p id="1031" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们实现了从生产者到Kafka和从Kafka到消费者的SSL，而没有SSL代理间通信。</p><p id="74fe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">基于上述设置，我们的结果显示，启用SSL时，性能会下降20%左右。例如，460 MB/s对580MB/s</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lm"><img src="../Images/ec5c6dfaac2f05ce347e4fb11aac7df2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ej-2NlCV5JEdRXMK4_Rs4A.png"/></div></div><figcaption class="jl jm et er es jn jo bd b be z dx">Kafka cluster throughput comparison between non-SSL and SSL</figcaption></figure><p id="89eb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">还要注意，当启用SSL时，Kafka broker上的CPU使用率明显高于非SSL，因此与未启用SSL时相比，Kafka变得更受<strong class="ig hi"> CPU限制</strong>。理论上，增加更多的CPU容量应该有助于提高性能。</p><p id="46a6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此外，我们启用了SSL代理间通信。不出所料，在换取额外安全级别的过程中，性能进一步下降。</p><p id="d613" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">处罚的根本原因主要是因为卡夫卡在JDK使用的SSL引擎。OpenSSL可能是一个很有前途的替代品，应该运行得更快，而且<a class="ae jc" href="https://issues.apache.org/jira/browse/KAFKA-2561" rel="noopener ugc nofollow" target="_blank">有一张票</a>可以跟踪这一点。</p><h2 id="40e7" class="jp jq hh bd jr js jt ju jv jw jx jy jz ip ka kb kc it kd ke kf ix kg kh ki kj bi translated">邮件丢失预防</h2><p id="afea" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">在一些用例中，小的消息丢失是可接受的，例如监控、机器学习、预测。但是，对于业务关键案例，如财务报告、会计对账，应尽量减少或防止消息丢失。</p><p id="7979" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Kafka从0.9版本开始将“无消息丢失”定位为一等公民，一个例子是<a class="ae jc" href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=27846330" rel="noopener ugc nofollow" target="_blank"> MirrorMaker </a>，<a class="ae jc" href="https://github.com/apache/kafka/blob/0.10.1/core/src/main/scala/kafka/tools/MirrorMaker.scala#L54" rel="noopener ugc nofollow" target="_blank">其默认配置</a>是防止消息丢失。为了证明MirrorMaker在大多数情况下不会丢失消息，我们进行了严格的“混乱”测试:</p><p id="d11c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">除了退回和终止MirrorMaker进程之外，还在MirrorMaker计算机上采取了以下操作:</p><ul class=""><li id="ac5c" class="kp kq hh ig b ih ii il im ip kr it ks ix kt jb ku kv kw kx bi translated">阻止端口的全部范围</li><li id="183a" class="kp kq hh ig b ih lh il li ip lj it lk ix ll jb ku kv kw kx bi translated">关闭网络(/sbin/服务网络停止)</li><li id="3ae9" class="kp kq hh ig b ih lh il li ip lj it lk ix ll jb ku kv kw kx bi translated">网络数据包丢失(例如，eth0: /sbin/tc qdisc add dev eth0根句柄1000 netem丢失10%的流量)</li></ul><p id="e710" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从所有的混乱测试中，我们确实看到，由于混乱场景中的重新发送逻辑，MirrorMaker可能发送了<strong class="ig hi">5–10%的重复消息</strong>。但是，我们没有看到消息丢失，这是信任MirrorMaker作为Kafka集群之间可靠的数据传输方法的一个好信号。</p><h2 id="560a" class="jp jq hh bd jr js jt ju jv jw jx jy jz ip ka kb kc it kd ke kf ix kg kh ki kj bi translated">下一步是什么？</h2><p id="bc44" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">我们计划围绕Kafka介绍流媒体、大数据和<a class="ae jc" href="http://hadoop.apache.org/" rel="noopener ugc nofollow" target="_blank"> Hadoop </a>生态系统，以及它如何为<a class="ae jc" href="http://www.walmart.com/" rel="noopener ugc nofollow" target="_blank">Walmart.com</a>带来商业价值</p><p id="e467" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">推特:<a class="ae jc" href="https://twitter.com/NingZhang6" rel="noopener ugc nofollow" target="_blank"> @ningZhang6 </a></p></div></div>    
</body>
</html>