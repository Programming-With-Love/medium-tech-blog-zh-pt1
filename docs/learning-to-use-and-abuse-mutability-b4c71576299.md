# 学习使用和滥用可变性

> 原文：<https://medium.com/google-developer-experts/learning-to-use-and-abuse-mutability-b4c71576299?source=collection_archive---------0----------------------->

![](img/01dc3e9e0931feb8b8c6d3a0a96a79d4.png)

我是一个老 Java 人，我从来没有分配我的许多思想去思考可变性的哲学。与其他语言不同，Java 无法精确控制哪些是可变的，哪些是不可变的。我从来没有想到 Java 对象有这个特性。相反，我总是称它们为*“没有 setter 的 Java 类”*。*“一旦设置了值就不能修改的 Java 类”*。在一个近乎科学的世界里，这是一个非常不科学的措辞。可变性是命令式语言的默认设置，我们只是不太考虑它。缺乏意识，我们的思维惯性地工作在我们所学的范式上。

![](img/1244d0344de42aa6f7fde6ea25b0f30e.png)

在我的职业生涯中，我看到许多语言可以区分类的可变性。这很酷，但是因为我从来没怎么用过它(我大部分时间都在安卓和 J2EE 上工作),所以我放弃了它。这不在我的势力范围之内。

一年前，我开始和科特林一起工作。它一直是我发展道路上的一盏明灯，我尽可能地使用它并倡导它(我也策划了[科特林周刊](http://kotlinweekly.net)，如果你想订阅每周一次的话)。如果你碰巧是为 Android 开发的，你很可能会用 Java 来做。Java 的 1.0 版本[发布于 1995 年](http://www.oracle.com/technetwork/java/javase/overview/javahistory-index-198355.html)。没错，22 年前。当时的世界是一个非常不同的地方，Java 是为了应对当时的挑战而设计的。我们所知的智能手机并不存在。这两款手机都不像现在这样容易买到。Java 发布的时候，Windows 95 甚至还没有面向大众(没错，Java 就是这么老)。易贝刚刚开始。

我喜欢把 IT 世界比作股票市场。20 世纪 60 年代，通用汽车是占主导地位的公司，没有人能与之竞争。美国政府甚至考虑强行将其拆分成小部分，以避免巨大的垄断。今天，通用汽车作为一个行尸走肉，多亏了巨额救助才得以生存。在 20 世纪 90 年代，没有人会对苹果公司下一毛钱的赌注。今天，苹果是全球最大的公司。

> 今天的星星是明天的残骸。今天的失败是明天激动人心的转变——J . l .柯林斯，[通往财富的简单道路](http://amzn.to/2kKBGB9)

Java 经历了许多补丁和更新。我并不是在批评这种语言:我确实靠讲 Java 谋生——尽管我并不仅限于讲 Java。但与此同时，新的明星正在崛起，在这里我想到了科特林。直截了当地说，Kotlin 区分了可变集合和不可变集合。开箱即用。

最近，我在[谷歌专家](https://developers.google.com/experts/)项目[的同事迈克·纳希莫维奇](https://medium.com/u/6ebfb5fe99f9?source=post_page-----b4c71576299--------------------------------)在推特上写了以下内容:

这也让我的大脑开始工作。我最近写了一篇博文，[“关于如何正确使用 volatile 和 synchronized”](/google-developer-experts/on-properly-using-volatile-and-synchronized-702fc05faac2#.nitcvxkfz)。我意识到线程和同步很难。哦，伙计，很多边缘案例，很多概念碰撞，太多抽象了。这个解决方案是一个开箱即用的解决方案。我有时使用它，我总是把它看作一个黑客。

在这篇介绍之后，让我们来探索 Java 中的可变性及其所有好处。为了更有效地解决这个问题，让我们提供以下定义作为公理:

> 不可变类是一个一旦创建就不能改变状态的类。

很简单。如果你在 Java 领域，现在你可以想出一些如何使一个类不可变的线索。

*   所有字段必须是私有的。这是 OO 编程范例的另一个公理。如果字段是私有的，则不能在外部更改。如果，作为奖励，也是最终的，你不能意外地改变它们。
*   **不提供设定器**。把这一点和前一点结合起来。如果字段是私有的，并且没有提供 setter，那么这个类字段将始终保持不变。
*   **子类不应该覆盖方法**。否则他们会欺骗我们的不变性。这很简单。只需将该类声明为最终类。

在这个例子中检查它看起来像什么:

我们已经讨论了理论部分。现在我们已经正式把知识写在纸上了。我们现在能用这个做什么？

## 好人

*   不可变对象可以让生活变得更容易。不可变对象是自动线程安全的，并且没有同步问题。哇，大 pro！它们使得并发编程更加安全和简洁。你调试过并发编程问题吗？大多数错误是由于线程间共享状态造成的。想象一下只要扫一眼就能摆脱它。值得一试。
*   不可变对象不需要复制构造函数或克隆的实现。为了简单起见。
*   你听说过约书亚·布洛赫在《有效的 Java》中创造的术语“失败原子性”吗？这意味着当一个不可变对象抛出任何异常时，它永远不会导致对象处于不确定状态。很大的荣誉。

## 丑陋的

*   为了改变对象而复制它们会耗尽我们的资源，尤其是在处理复杂的数据结构时。此外，改变具有不同身份的对象也可以更直观。
*   我们对模型世界的感知是基于可变的对象。

# 我该怎么办？

我听说过“易变是万恶之源”。我喜欢有多种选择，不把任何事情当作教条。多种选择通常意味着你有更多的选择。

在《有效的 Java》中，约书亚·布洛克写道:

> “类应该是不可变的，除非有非常好的理由让它们可变。如果一个类不能成为不可变的，那么尽可能地限制它的可变性。”

不变性可以解决许多问题，使您的生活更加轻松，尤其是在并发环境中工作时。但是，如果您默认使用它，它可能会过度设计并使事情变得更加复杂。因此，了解您的战争，并应用更适合的解决方案。

感谢[泽维尔·胡拉多](https://twitter.com/xavierjurado)和[戴维·冈萨雷斯](https://twitter.com/dggonzalez)对文章的投入！

我在我的[推特账户](https://twitter.com/eenriquelopez)中写下我对软件工程和生活的想法。如果你喜欢这篇文章或者它确实帮助了你，请分享它，喜欢它和/或留下评论。这是给业余作家加油的货币。