<html>
<head>
<title>Cloud Custodian — Things I Wish I Knew At The Beginning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云管理员—我希望一开始就知道的事情</h1>
<blockquote>原文：<a href="https://medium.com/globant/cloud-custodian-things-i-wish-i-knew-at-the-beginning-2743cf948066?source=collection_archive---------0-----------------------#2022-07-25">https://medium.com/globant/cloud-custodian-things-i-wish-i-knew-at-the-beginning-2743cf948066?source=collection_archive---------0-----------------------#2022-07-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="7068" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">简介</strong></p><p id="1515" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">云托管是一个开源工具，最初是一家美国金融公司的项目，后来成为由社区维护的CNCF项目。您可以将云托管定义为云治理和合规性的平台，在某种意义上，它允许您使用相似的语法和策略与三大云服务提供商进行交互。</p><p id="46ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你可以找到相当多的文档和文章解释如何开始使用云托管，我特别推荐一篇由<a class="ae jc" rel="noopener" href="/@jbgachot?source=post_page-----d8e468fb4ab4--------------------------------"> Jean-Brice GACHOT </a>撰写的文章，标题为<a class="ae jc" rel="noopener" href="/manomano-tech/cloud-custodian-overview-and-deployment-of-cloud-governance-d8e468fb4ab4">云托管——云治理的概述和部署</a>，这对于理解如何让托管在AWS多帐户架构上运行非常有帮助。<a class="ae jc" href="https://cloudcustodian.io/docs/index.html" rel="noopener ugc nofollow" target="_blank">官方文档</a>也非常具有描述性，包括所有CC特性和示例策略，以指导您完成使用云托管可以做的所有事情。该文档对于每个想要实现托管的人来说都是一个很好的起点，但是本文将更侧重于提供我们在实现云托管时发现的特征的提示。虽然我在这里展示的一些东西可以在官方文档中找到，但我想浓缩一些我们发现的怪癖和解决方案。</p></div><div class="ab cl jd je go jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="ha hb hc hd he"><p id="57e2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本文将回顾以下部分:</p><ul class=""><li id="c4d0" class="jk jl hh ig b ih ii il im ip jm it jn ix jo jb jp jq jr js bi translated"><strong class="ig hi">快速查找资源</strong></li><li id="2a87" class="jk jl hh ig b ih jt il ju ip jv it jw ix jx jb jp jq jr js bi translated"><strong class="ig hi">缓存周期设置为0的测试</strong></li><li id="4ea7" class="jk jl hh ig b ih jt il ju ip jv it jw ix jx jb jp jq jr js bi translated"><strong class="ig hi">不要忘记先进行一次测试</strong></li><li id="a1de" class="jk jl hh ig b ih jt il ju ip jv it jw ix jx jb jp jq jr js bi translated"><strong class="ig hi">JMS path查询和函数</strong></li><li id="5c43" class="jk jl hh ig b ih jt il ju ip jv it jw ix jx jb jp jq jr js bi translated"><strong class="ig hi">结论</strong></li></ul><p id="5f14" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">快速查找资源</strong></p><p id="0c5a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当你已经为多账户托管执行正确地设置了你的<a class="ae jc" href="https://cloudcustodian.io/docs/tools/c7n-org.html" rel="noopener ugc nofollow" target="_blank"> c7n-org，包括角色和区域，当你需要获得多个账户或区域的快速库存或资源列表时，它会是一个方便的工具。它还可以提供一些调查孤立或遗留资源的信息。例如，这个基本策略提供了许多有趣的信息:</a></p><figure class="jy jz ka kb fd kc"><div class="bz dy l di"><div class="kd ke l"/></div><figcaption class="kf kg et er es kh ki bd b be z dx">Simple lambda policy to retrieve all resources</figcaption></figure><p id="65d1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">输出:</p><figure class="jy jz ka kb fd kc er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es kj"><img src="../Images/47d2df8167cc63a6ccba46c1bf509e71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z5Imyc-unRLs6zBUwJcjUg.png"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx">resources.json from output folder</figcaption></figure><figure class="jy jz ka kb fd kc er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es kq"><img src="../Images/1c7b9686c8813fca3d50618baed7d2df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sP8k5AvXwPjlqBLvlYo_dQ.png"/></div></div><figcaption class="kf kg et er es kh ki bd b be z dx">CSV comma separated list from c7n-org report command</figcaption></figure><p id="bbc3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这里，我能够检索关于AWS lambda函数的信息，这使我能够快速识别未知的孤立IAM角色，我需要找到与哪个资源相关联。您可能会争辩说，通过AWS CLI或其任何SDK都可以实现相同的结果，您可能是对的，但是当您设置了适当的云托管多帐户多区域时，您不需要摆弄凭据和区域，您只需要在策略上写几行，就可以立即获得您需要的所有信息。另一个优点是，您可以用一种简单的yaml语法格式处理保管人策略中的不同值和过滤器。</p><p id="f27f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">缓存周期设置为0的测试</strong></p><p id="27bf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">假设您开始测试云托管策略，比方说评估您的资源是否设置了正确的标签。您首先对已经知道没有正确标记的资源运行策略，策略有效地列出了这些资源，您修复一个或几个资源并重新运行策略，它们应该从报告中删除，对吗？不，你仍然会得到和测试开始时一样的结果。我绞尽脑汁想弄清楚到底发生了什么，结果发现云保管人将默认缓存值设置为15分钟，因此它将保留一个临时文件夹，并向您显示该文件夹的结果，而不是实际的实时资源状态，这样做是为了显示报告，比在云上来回移动和检索元数据更快。但是，当您尝试测试策略的效果以及在资源上完成的修复时，您希望获得实际的实时结果，因此在测试策略时，请确保将缓存周期设置为0:</p><pre class="jy jz ka kb fd kr ks kt ku aw kv bi"><span id="7e8b" class="kw kx hh ks b fi ky kz l la lb">custodian run -s output-folder my-first-policy.yml --cache-period=0</span></pre><p id="1982" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">不要忘了先用预演来测试！</strong></p><p id="9e68" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们举一个例子，看看一个使用无效ami终止EC2实例的策略</p><figure class="jy jz ka kb fd kc"><div class="bz dy l di"><div class="kd ke l"/></div><figcaption class="kf kg et er es kh ki bd b be z dx">Example policy to terminate EC2 instances using invalid AMIs</figcaption></figure><p id="c8d5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此策略有一个非常激进的操作，即终止不符合的实例。这里我可以给你几条建议:首先，先在一个独立的dev或沙盒帐户上测试这一点，其次，在第一次检查哪些资源将受到策略操作的影响时，总是使用模拟运行。</p><pre class="jy jz ka kb fd kr ks kt ku aw kv bi"><span id="92a8" class="kw kx hh ks b fi ky kz l la lb">custodian run -s output-folder ec2-invalid-ami.yml --dryrun</span></pre><p id="49d4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">模拟运行标志将在不实际执行操作的情况下运行策略，为您提供策略可以删除的资源列表。一个额外的措施是使用本地测试的替代凭证，这不允许破坏性的非预期动作。在听到公司因错误执行政策而破坏生产资源的恐怖故事后，我再怎么强调控制政策的测试和执行方式的重要性也不为过。</p><p id="e4aa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">JMS path查询和函数</strong></p><p id="68c9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当你开始更深入地研究云托管的资源过滤功能时，你会发现它是一个非常有用的工具，可以方便地获取资源信息。Cloud Custodian使用JMESPath查询从json输出中正确地过滤资源信息。</p><figure class="jy jz ka kb fd kc"><div class="bz dy l di"><div class="kd ke l"/></div><figcaption class="kf kg et er es kh ki bd b be z dx">ECS service policy with JMESPath query</figcaption></figure><p id="abb8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在此策略中，我们使用关键过滤器来查找AWS ECS服务部署的上次更新时间，但是字段<em class="lc"> deployments[]。updatedAt </em>不能针对年龄值类型运行，您需要将日期类型转换为年龄值类型可以比较的字符串。在这种情况下，我们可以使用JMESPath <em class="lc"> to_string </em>函数来获取适当的数据格式并过滤年龄值。</p><p id="60a6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">结论</strong></p><p id="70f3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">云托管是一个方便的工具，允许跨多个帐户和服务实施治理和合规性。开始的时候可能会有一些障碍，你需要一路克服。如果您面临特殊的需求或用例，您也可以在<a class="ae jc" href="https://gitter.im/cloud-custodian/cloud-custodian" rel="noopener ugc nofollow" target="_blank">云托管Gitter </a>社区上发布您的问题，在那里您可以找到能够帮助您解决问题的专家。</p></div></div>    
</body>
</html>