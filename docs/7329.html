<html>
<head>
<title>Keeping Your Customers up to date.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让您的客户与时俱进。</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/keeping-your-customers-up-to-date-752245acbf82?source=collection_archive---------7-----------------------#2018-08-16">https://medium.com/square-corner-blog/keeping-your-customers-up-to-date-752245acbf82?source=collection_archive---------7-----------------------#2018-08-16</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="726e" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">了解如何在将客户与Square的API同步时利用一些新的API特性。</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/e97cf6c532a87216d5e70d0b42845fc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gnqdEM4giXk_FYg-azm5wg.jpeg"/></div></div></figure><blockquote class="ji jj jk"><p id="9f0c" class="jl jm jn jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们在https://developer.squareup.com/blog<a class="ae ki" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">的新家</a></p></blockquote><p id="17fe" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">Square customer management通常可以满足您的所有需求，但有时您可能需要将您的客户目录与另一个客户数据库或订单管理系统保持同步。幸运的是，我们的API的一些新变化使得这比以往任何时候都更容易。</p><h2 id="e29d" class="km kn hh bd ko kp kq kr ks kt ku kv kw kj kx ky kz kk la lb lc kl ld le lf lg bi translated">概观</h2><p id="9c73" class="pw-post-body-paragraph jl jm hh jo b jp lh ii jr js li il ju kj lj jx jy kk lk kb kc kl ll kf kg kh ha bi translated">在本帖中，我们将介绍Square中的客户目录和不同数据库之间的夜间同步用例。我们将使用一个本地SQLite数据库作为另一个数据库，将客户同步到Node.js进行所有编程。在高层次上，我们将使用<a class="ae ki" href="https://docs.connect.squareup.com/api/connect/v2#endpoint-searchcustomers" rel="noopener ugc nofollow" target="_blank"> SearchCustomers </a>端点从我们的客户目录中查找最近更新和添加的客户，然后将它们插入到我们的SQLite数据库中。然后，我们将在另一端做同样的事情，将客户同步回Square，这些客户可能已经通过其他方式独立添加到我们的其他数据库中。请记住，如果您使用OAuth访问属于Square卖家的数据，您必须获得他们的许可，才能访问或同步与他们的Square帐户相关的任何数据到不同的数据库。</p><h2 id="726a" class="km kn hh bd ko kp kq kr ks kt ku kv kw kj kx ky kz kk la lb lc kl ld le lf lg bi translated">设置:初始化本地数据库并获取API凭据。</h2><p id="299e" class="pw-post-body-paragraph jl jm hh jo b jp lh ii jr js li il ju kj lj jx jy kk lk kb kc kl ll kf kg kh ha bi translated">多亏了<code class="du lm ln lo lp b"><a class="ae ki" href="https://www.npmjs.com/package/sqlite3" rel="noopener ugc nofollow" target="_blank">sqlite3</a></code>包，设置我的本地数据库只需要几行Node.js。我使用一个本地文件(<code class="du lm ln lo lp b">database.db</code>)来存储我的数据库和一个类似于客户对象响应体的表结构。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="c28d" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">使用Square的API访问我的客户目录也同样简单，只要访问一下<a class="ae ki" href="https://connect.squareup.com/apps" rel="noopener ugc nofollow" target="_blank"> Square开发者门户</a>，我就可以获得我的个人访问令牌，这将允许我访问我自己的Square帐户的所有API端点。我还将为Square的API使用<a class="ae ki" href="http://github.com/square/connect-javascript-sdk" rel="noopener ugc nofollow" target="_blank"> JavaScript SDK。我可以用<code class="du lm ln lo lp b">npm install square-connect</code>和<code class="du lm ln lo lp b">require()</code>把它添加到我的应用程序中。</a></p><h2 id="7b78" class="km kn hh bd ko kp kq kr ks kt ku kv kw kj kx ky kz kk la lb lc kl ld le lf lg bi translated">从Square获取最近添加和更新的客户。</h2><p id="ed58" class="pw-post-body-paragraph jl jm hh jo b jp lh ii jr js li il ju kj lj jx jy kk lk kb kc kl ll kf kg kh ha bi translated">有两种类型的信息变化，我们可能希望从我们的Square客户目录同步到我们的另一个数据库:新客户和更新了信息的客户。幸运的是，新的SearchCustomers端点使得通过尽可能少的API调用来获得这两类客户变得很容易。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="ee52" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">为了获得最近创建的客户，我们将对SearchCustomers使用<code class="du lm ln lo lp b">created_at</code>过滤器。这允许我们过滤所有返回的结果，只过滤那些在我们指定的时间窗口内创建的结果。该代码查找最近一天内创建的客户，但也可以轻松地轮询最近5分钟内创建的客户，或者使用目录上次成功同步的时间戳作为窗口的开始。我们还可以使用带有<code class="du lm ln lo lp b">sort_field</code>参数的ListCustomers端点，按照创建日期列出我们的客户，然后遍历该列表，直到到达上次同步日期。搜索客户是一个更好的选择，因为它能够返回更多的客户条目，并且只返回指定时间窗口内的条目。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="f9a1" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">获得最近更新的客户也同样简单。我们将在请求体中为<code class="du lm ln lo lp b">updated_at</code>替换掉<code class="du lm ln lo lp b">created_at</code>参数，并指定相同的时间窗口。与使用ListCustomers端点和必须同步整个客户目录来查找任何更新相比，这是一个很大的改进。</p><p id="b995" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">这种方法有些幼稚，并且不处理分页。如果您在给定的时间窗口内同步超过1000个新创建或更新的客户，您将获得一个<code class="du lm ln lo lp b">cursor</code>参数，您将需要使用该参数来获得下一页结果。你可以在我之前的文章<a class="ae ki" rel="noopener" href="/square-corner-blog/tips-and-tricks-for-api-pagination-5cacc6f017da"><em class="jn">API分页的技巧和诀窍</em> </a> <em class="jn">中了解更多关于分页的知识。</em></p><h2 id="97ad" class="km kn hh bd ko kp kq kr ks kt ku kv kw kj kx ky kz kk la lb lc kl ld le lf lg bi translated">将客户同步到Square</h2><p id="fdd9" class="pw-post-body-paragraph jl jm hh jo b jp lh ii jr js li il ju kj lj jx jy kk lk kb kc kl ll kf kg kh ha bi translated">这里的基本情况也很简单，但是在实践中，对于您自己的数据库来说，可能会稍微复杂一些。我们可以选择不在Square Customer目录中的行，然后通过CreateCustomer端点运行它们。我们可以用许多不同的方式识别这些客户，一个<code class="du lm ln lo lp b">source</code>字段，还没有Square id的条目，或者查看自上次数据库同步以来创建的客户。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="lq lr l"/></div><figcaption class="ls lt et er es lu lv bd b be z dx">Selecting customers from the SQLite database and creating them inside Square</figcaption></figure><h2 id="a139" class="km kn hh bd ko kp kq kr ks kt ku kv kw kj kx ky kz kk la lb lc kl ld le lf lg bi translated">后续步骤</h2><p id="6735" class="pw-post-body-paragraph jl jm hh jo b jp lh ii jr js li il ju kj lj jx jy kk lk kb kc kl ll kf kg kh ha bi translated">这只是我们的客户API中的新特性可以用于的一些有用情况的一个例子。请记住，在您自己的系统中实现这一点时，您可能需要考虑一些权衡。你应该每天、每周、每小时同步吗？您的数据模型将如何在系统间转换？您的实现会有所不同，这取决于您有多少客户，您将他们同步到哪里，以及您希望如何处理这些客户信息。如果您有任何问题，或者想要分享如何同步客户的示例，请随时回复此帖子，在<a class="ae ki" href="https://twitter.com/squaredev" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hi"> twitter </strong> </a>或我们的<a class="ae ki" href="http://squ.re/slack" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hi"> slack社区</strong> </a>和<a class="ae ki" href="https://www.workwithsquare.com/developer-newsletter.html?channel=Online%20Social&amp;sqmethod=Blog" rel="noopener ugc nofollow" target="_blank"> <strong class="jo hi">上告诉我们，注册我们的简讯</strong> </a>以了解最新版本。</p></div></div>    
</body>
</html>