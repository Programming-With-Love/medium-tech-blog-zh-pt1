<html>
<head>
<title>Entity Framework on Azure Functions with Dependency Injection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有依赖注入的Azure函数上的实体框架</h1>
<blockquote>原文：<a href="https://medium.com/globant/entity-framework-on-azure-functions-with-dependency-injection-77208c94a16?source=collection_archive---------0-----------------------#2021-06-09">https://medium.com/globant/entity-framework-on-azure-functions-with-dependency-injection-77208c94a16?source=collection_archive---------0-----------------------#2021-06-09</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="b134" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">介绍</h1><p id="c679" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">本文的目的是展示在Azure函数上使用实体框架，并通过依赖注入将数据存储在SQL数据库中作为后备存储。随着对Azure函数的<a class="ae ka" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-dotnet-dependency-injection" rel="noopener ugc nofollow" target="_blank">依赖注入支持的发布，在Azure函数中使用实体框架感觉更容易了。在软件工程中，<strong class="je hi">依赖注入</strong>是一种技术，其中一个<strong class="je hi">对象接收它<strong class="je hi">依赖的其他对象</strong>。这些其他对象称为依赖关系。在典型的“使用”关系中，接收对象称为客户端，传递(即“注入”)的对象称为服务。</strong></a></p><h1 id="f863" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">背景</h1><p id="5434" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated"><strong class="je hi">提取、转换和加载(ETL) </strong>是一个常见的业务功能，通常对于不同系统之间的集成是必要的。ETL工具的用例是公司将数据从遗留系统转移到更新的系统，以便与新的基础设施兼容。Azure函数是专注于特定问题的小段代码，非常适合处理ETL之类的任务。本文演示了如何创建一个示例函数应用程序来读取CSV文件中的数据，然后使用Azure函数上的<strong class="je hi">实体框架</strong>利用<strong class="je hi">依赖注入将数据存储到数据库中。</strong>Azure Function的依赖注入特性使得在Azure Functions应用中使用实体框架数据库上下文变得非常简单。</p><p id="0390" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated"><strong class="je hi">本文涵盖以下几点:</strong></p><ul class=""><li id="bdd9" class="kg kh hh je b jf kb jj kc jn ki jr kj jv kk jz kl km kn ko bi translated">先决条件</li><li id="6aba" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">示范</li><li id="29c4" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">使用案例</li><li id="a129" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">结论</li><li id="6ea3" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">参考</li></ul><h1 id="dac7" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">先决条件</strong></h1><p id="2d49" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">下面是本文的先决条件:</p><ul class=""><li id="345c" class="kg kh hh je b jf kb jj kc jn ki jr kj jv kk jz kl km kn ko bi translated"><a class="ae ka" href="https://docs.microsoft.com/en-us/dotnet/azure/intro" rel="noopener ugc nofollow" target="_blank">天蓝色为。NET开发者</a></li><li id="d4a6" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated"><a class="ae ka" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview" rel="noopener ugc nofollow" target="_blank">天蓝色功能</a></li><li id="a3d5" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated"><a class="ae ka" href="https://docs.microsoft.com/en-us/ef/core/" rel="noopener ugc nofollow" target="_blank">实体框架</a></li></ul><p id="2568" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">Azure是一个云平台，旨在简化构建现代应用程序的过程。无论你选择完全在Azure中托管你的应用程序，还是用Azure服务扩展你的内部应用程序，Azure都可以帮助你创建可伸缩、可靠和可维护的应用程序。</p><p id="304e" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">Azure Functions是一个无服务器的解决方案，它允许您编写更少的代码，维护更少的基础设施，并节省成本。云基础设施提供保持应用运行所需的所有最新资源，而不是担心部署和维护服务器。</p><p id="a832" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">实体框架是一个开源的ORM框架。微软支持的. NET应用程序。Entity Framework使开发人员能够使用领域特定类的对象来处理数据，而无需关注存储这些数据的底层数据库表和列。</p><h1 id="59b0" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">示范</h1><p id="f233" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">以下是高级步骤:</p><ol class=""><li id="a889" class="kg kh hh je b jf kb jj kc jn ki jr kj jv kk jz ku km kn ko bi translated">创建Azure函数项目</li><li id="46b0" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz ku km kn ko bi translated">参考必需的Nuget包</li><li id="2061" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz ku km kn ko bi translated">设置依赖注入</li><li id="0230" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz ku km kn ko bi translated">在本地测试Azure功能</li><li id="acd4" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz ku km kn ko bi translated">发布功能App</li></ol><p id="09ab" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated"><strong class="je hi"> 1。创建Azure功能项目</strong></p><p id="0c7c" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">第一步是在Visual Studio中创建新项目，并选择Azure Functions模板。这将为您提供创建Azure函数的框架结构。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/2bce508a318103f065ed31fe7b694b54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xY8sv4a1cSXzhUQo"/></div></div></figure><p id="0bcf" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">在下一个窗口中，您可以选择您希望该功能成为的触发器类型，出于演示目的，我选择了一个计时器触发器，它将在使用ncron安排的指定时间运行。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lh"><img src="../Images/a8df38a4bf348383f316205e41268fae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NbLDNUVGKegpg9bq"/></div></div></figure><p id="e2fa" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated"><strong class="je hi"> 2。参考所需的Nuget包</strong></p><p id="11b7" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">现在，为了使用依赖注入，您需要验证两件事:</p><ol class=""><li id="31b2" class="kg kh hh je b jf kb jj kc jn ki jr kj jv kk jz ku km kn ko bi translated">微软。NET.Sdk.Functions至少是1.0.28</li><li id="996d" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz ku km kn ko bi translated">安装Microsoft。Azure.Functions.Extensions包来提供使用依赖注入的API。</li></ol><p id="4ec8" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">选择与版本兼容的正确版本号非常重要。你正在运行的网络。我在跑步。NET core 3.1，这就是我用过的。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="li lj l"/></div></figure><p id="0b4a" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">我还参考了微软。azure . functions . extensions nu get包，它让我们可以访问依赖注入特性。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="li lj l"/></div></figure><p id="04fa" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">我的数据库模式非常简单。下面是创建我用于测试的表的SQL。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="li lj l"/></div></figure><p id="8818" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">我还更新了我的local.settings.json，添加了一个可以用于本地测试的连接字符串:</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="li lj l"/></div></figure><p id="0642" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">我已经为我的数据项实体和一个自定义DbContext创建了一个实体框架模型</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="li lj l"/></div></figure><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="li lj l"/></div></figure><p id="66b9" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated"><strong class="je hi"> 3。设置依赖注入</strong></p><p id="f13c" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">为了为我们的函数应用程序设置依赖注入，我们在程序集上使用FunctionsStartup属性来指示一个启动类，它将在函数应用程序启动时运行。在从FunctionsStartup继承的那个类中，我们重写了Configure方法。这允许我们从配置中检索SQL连接字符串，并在服务中注册一个DbContext，这将允许我们将MyDbContext注入到函数中。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="li lj l"/></div></figure><p id="6779" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">依赖注入现在为我们提供了在类中定义函数的能力，这些类将它们的依赖注入到它们的构造函数中。因此，这里我定义了一个MyTimerFunction类，它的构造函数接受一个函数可以使用的MyDbContext。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="li lj l"/></div></figure><p id="7220" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">现在，我们已经准备好从csv文件中读取数据，并将数据插入数据库。下面我们从csv文件中读取数据并返回数据对象，然后使用之前定义的MyDbContext将这些数据对象插入到表中。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="li lj l"/></div></figure><p id="0705" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated"><strong class="je hi"> 4。本地测试Azure功能</strong></p><p id="a12a" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">为了在本地调试定时器触发器的代码，我们需要添加下面的方法签名。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="li lj l"/></div></figure><p id="3efa" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">示例运行输出如下:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lk"><img src="../Images/6136cc9dc0060ddf823ffcd418812ea7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*T2DXtSPWNPwdfEhG"/></div></div></figure><p id="7bb2" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated"><strong class="je hi"> 5。发布功能App </strong></p><p id="52a1" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">一旦我们确定该功能按预期运行，我们就可以继续部署Azure功能了。您将需要根据所使用的内容修改连接字符串。出于演示的目的，我在Azure 的<strong class="je hi"> Redhat虚拟机上安装了<strong class="je hi"> SQL Express </strong>，并将其用作我的<strong class="je hi">数据库</strong>。要部署Azure功能，右键单击项目并选择publish。</strong></p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ll"><img src="../Images/57de058baa72c3de5c8808fe45deb9a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*av4VruHj_VAOzIcL"/></div></div></figure><p id="608e" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">然后选择<strong class="je hi">目标</strong>作为<strong class="je hi"> Azure </strong>并点击下一步。选择<strong class="je hi">具体目标</strong>为<strong class="je hi">Azure Function App(Windows)</strong>后接<strong class="je hi">订阅名称</strong>和<strong class="je hi">您要部署功能App的资源组</strong>。您可以使用现有的功能应用程序，也可以创建一个新的功能应用程序，然后单击完成。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lm"><img src="../Images/e8eeb2d66873dbbb0ac5c33d0b8d5605.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_wve_AkLy1_lN12c"/></div></div></figure><p id="770a" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">对我来说，由于我在虚拟机上使用了SQL Express，所以我必须允许来自功能应用程序可用的所有可能IP地址的流量通过SQL端口。为了获得所有IP地址的列表，我使用了下面的命令。你可以在这里阅读<a class="ae ka" href="https://docs.microsoft.com/en-us/azure/azure-functions/ip-addresses" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="li lj l"/></div></figure><p id="1f73" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">就是这样，你已经通过依赖注入成功地在Azure函数上使用了实体框架。</p><p id="ac00" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">你可以点击查看示例代码<a class="ae ka" href="https://github.com/kunalborker/AzureFunctionWithEF.git" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="bede" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">使用案例</h1><p id="6ea7" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">上述实现有许多应用。传统的方法通常包括设置专用的FTP服务器，然后部署计划的作业来解析文件并翻译它们以供业务使用。无服务器架构使这项工作变得更加容易，因为文件上传时可以触发触发器。另一个实时应用是利用API从第三方工具/应用中获取数据，这些第三方工具/应用不以指定的间隔/触发来保留数据，并存储它们以备将来使用。</p><h1 id="dc45" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">结论</h1><p id="713e" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在这篇文章中，我们演示了如何将依赖注入Azure函数应用程序并将数据导入存储。在Azure函数中使用依赖注入的能力意味着可以使用经过验证的设计模式来更好地编写解决方案，以获得更好的可维护性和可测试性。</p><h1 id="8713" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">参考</h1><ul class=""><li id="8a80" class="kg kh hh je b jf jg jj jk jn ln jr lo jv lp jz kl km kn ko bi translated"><a class="ae ka" href="https://www.codeproject.com/Articles/5251396/Use-Azure-Functions-to-process-a-CSV-File-and-impo" rel="noopener ugc nofollow" target="_blank">https://www . code project . com/Articles/5251396/Use-Azure-Functions-to-process-a-CSV-File-and-impo</a></li><li id="7758" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated"><a class="ae ka" href="https://www.entityframeworktutorial.net/code-first/configure-entity-mappings-using-fluent-api.aspx" rel="noopener ugc nofollow" target="_blank">https://www . entityframework tutorial . net/code-first/configure-entity-mappings-using-fluent-API . aspx</a></li><li id="a49f" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated"><a class="ae ka" href="https://www.sqlshack.com/logging-messages-from-azure-functions-to-azure-sql-database/" rel="noopener ugc nofollow" target="_blank">https://www . SQL shack . com/logging-messages-from-azure-functions-to-azure-SQL-database/</a></li><li id="ed67" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated"><a class="ae ka" href="https://markheath.net/post/ef-core-di-azure-functions" rel="noopener ugc nofollow" target="_blank">https://markheath.net/post/ef-core-di-azure-functions</a></li></ul></div></div>    
</body>
</html>