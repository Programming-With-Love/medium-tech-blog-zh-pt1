<html>
<head>
<title>Use WorkManager for immediate background execution</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用工作管理器进行即时后台执行</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/use-workmanager-for-immediate-background-execution-a57db502603d?source=collection_archive---------0-----------------------#2020-07-23">https://medium.com/androiddevelopers/use-workmanager-for-immediate-background-execution-a57db502603d?source=collection_archive---------0-----------------------#2020-07-23</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/9d75749f53126902cc9971fc5738b8f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*anmvTpe4iHt70XHER5A0WQ.png"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">Header image by <a class="ae hu" href="https://medium.com/u/224e59676537?source=post_page-----a57db502603d----------------------" rel="noopener">Virginia Poltrack</a></figcaption></figure><div class=""/><div class=""><h2 id="a00c" class="pw-subtitle-paragraph iu hw hx bd b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl dx translated">有些任务不应该被推迟</h2></div><p id="2ea5" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">当你必须在后台执行长时间运行的任务时，你会遇到Android 8.0引入的后台执行限制。这些限制激励开发人员改善用户对整个平台的体验。<br/>为了更容易适应不同的用例，我们还通过向WorkManager添加功能，改善了开发人员在处理后台限制时的体验。</p><blockquote class="ki"><p id="0ef2" class="kj kk hx bd kl km kn ko kp kq kr kh dx translated"><strong class="ak">我们建议您使用工作管理器执行长时间运行的<em class="ks">即时</em>任务</strong>。</p></blockquote><p id="e223" class="pw-post-body-paragraph jm jn hx jo b jp kt iy jr js ku jb ju jv kv jx jy jz kw kb kc kd kx kf kg kh ha bi translated">继续学习，了解使用WorkManager立即执行长时间运行的任务的好处，以及如何设置一切。</p></div><div class="ab cl ky kz go la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ha hb hc hd he"><h1 id="a98c" class="lf lg hx bd lh li lj lk ll lm ln lo lp jd lq je lr jg ls jh lt jj lu jk lv lw bi translated">API简介</h1><p id="a97b" class="pw-post-body-paragraph jm jn hx jo b jp lx iy jr js ly jb ju jv lz jx jy jz ma kb kc kd mb kf kg kh ha bi translated">从WorkManager <a class="ae hu" href="https://developer.android.com/jetpack/androidx/releases/work#version_230_3" rel="noopener ugc nofollow" target="_blank">版本2.3.0 </a>开始，每个工作者都可以访问在前台服务中运行任务的方法。Worker基类<code class="du mc md me mf b"><a class="ae hu" href="https://developer.android.com/reference/androidx/work/ListenableWorker" rel="noopener ugc nofollow" target="_blank">ListenableWorker</a></code>提供了一个新的<code class="du mc md me mf b"><a class="ae hu" href="https://developer.android.com/reference/kotlin/androidx/work/ListenableWorker#setforegroundasync" rel="noopener ugc nofollow" target="_blank">setForegroundAsync()</a></code>函数。</p><p id="d93c" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">这篇文章使用<code class="du mc md me mf b"><a class="ae hu" href="https://developer.android.com/reference/kotlin/androidx/work/CoroutineWorker" rel="noopener ugc nofollow" target="_blank">CoroutineWorker</a></code>作为示范。在协同工作器中，<code class="du mc md me mf b">setForegroundAsync()</code>被包装在一个挂起的<code class="du mc md me mf b"><a class="ae hu" href="https://developer.android.com/reference/kotlin/androidx/work/CoroutineWorker#setforeground" rel="noopener ugc nofollow" target="_blank">setForeground()</a></code>函数中。该类还提供了挂起的<code class="du mc md me mf b">doWork</code>函数，该函数允许在主线程之外运行代码。但是这篇文章的所有内容也适用于其他工人阶级的相应功能。</p><p id="89e7" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">当您使用setForeground(Async)时，一旦满足约束，计划的任务将立即在前台服务中运行。另外，WorkManager会为您处理服务的生命周期。并且，后台工作的10分钟时间限制不适用于您在前台服务中运行的worker中所做的工作。</p><h1 id="dfa0" class="lf lg hx bd lh li mg lk ll lm mh lo lp jd mi je lr jg mj jh lt jj mk jk lv lw bi translated">立即开始执行</h1><p id="ba73" class="pw-post-body-paragraph jm jn hx jo b jp lx iy jr js ly jb ju jv lz jx jy jz ma kb kc kd mb kf kg kh ha bi translated">让我们看看如何让一个现有的工人在前台服务中执行工作。</p><p id="8c70" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">我们的出发点是一个非常简化的<code class="du mc md me mf b">doWork()</code>函数。代码异步执行，根据成功与否，返回对应的<code class="du mc md me mf b">Result</code>。</p><figure class="ml mm mn mo fd hj"><div class="bz dy l di"><div class="mp mq l"/></div></figure><p id="4d7e" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">在<code class="du mc md me mf b">doWork()</code>中，您还将告诉WorkManager任务应该立即在前台服务中运行。</p><p id="ac2e" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">为此，您必须创建一个<code class="du mc md me mf b"><a class="ae hu" href="https://developer.android.com/reference/androidx/work/ForegroundInfo" rel="noopener ugc nofollow" target="_blank">ForegroundInfo</a></code>对象并将其提供给<code class="du mc md me mf b">setForeground()</code>。ForegroundInfo接受一个通知id以及将作为参数显示的<code class="du mc md me mf b"><a class="ae hu" href="https://developer.android.com/reference/android/app/Notification" rel="noopener ugc nofollow" target="_blank">Notification</a></code>。<br/>一旦满足约束，该信息用于设置和运行前台服务。</p><h1 id="fcd6" class="lf lg hx bd lh li mg lk ll lm mh lo lp jd mi je lr jg mj jh lt jj mk jk lv lw bi translated">设置前景信息</h1><p id="89d8" class="pw-post-body-paragraph jm jn hx jo b jp lx iy jr js ly jb ju jv lz jx jy jz ma kb kc kd mb kf kg kh ha bi translated">正确设置ForegroundInfo就像1，2，3:</p><ol class=""><li id="4d6d" class="mr ms hx jo b jp jq js jt jv mt jz mu kd mv kh mw mx my mz bi translated">创建通知</li><li id="cf9f" class="mr ms hx jo b jp na js nb jv nc jz nd kd ne kh mw mx my mz bi translated">创建通知渠道</li><li id="e088" class="mr ms hx jo b jp na js nb jv nc jz nd kd ne kh mw mx my mz bi translated">向ForegroundInfo提供通知</li></ol><p id="eb4c" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">在下面的代码中，<code class="du mc md me mf b">createForegroundInfo()</code>调用<code class="du mc md me mf b">createNotification()</code>，后者依次填充通知并创建相应的通道。</p><figure class="ml mm mn mo fd hj"><div class="bz dy l di"><div class="mp mq l"/></div></figure><h1 id="dc76" class="lf lg hx bd lh li mg lk ll lm mh lo lp jd mi je lr jg mj jh lt jj mk jk lv lw bi translated">在前台服务中运行工作</h1><p id="e64b" class="pw-post-body-paragraph jm jn hx jo b jp lx iy jr js ly jb ju jv lz jx jy jz ma kb kc kd mb kf kg kh ha bi translated">现在让我们把东西放在一起。因为我们已经有了一个实现的<code class="du mc md me mf b">doWork()</code>函数，我们可以调用<code class="du mc md me mf b">setForeground()</code>并通过调用<code class="du mc md me mf b">createForegroundInfo()</code>传递所需的信息。</p><figure class="ml mm mn mo fd hj"><div class="bz dy l di"><div class="mp mq l"/></div></figure><blockquote class="nf ng nh"><p id="6b0a" class="jm jn ni jo b jp jq iy jr js jt jb ju nj jw jx jy nk ka kb kc nl ke kf kg kh ha bi translated">⚠️⚠️⚠️ <br/>在你的长期运行任务开始之前调用<code class="du mc md me mf b">setForeground()</code> <strong class="jo hy">。<br/> </strong>否则，您的员工将被视为非前台服务，直到<code class="du mc md me mf b">setForeground()</code>被调用，这可能会导致不想要的结果，如工作被取消。<br/> ⚠️⚠️⚠️</p></blockquote><h1 id="aa1c" class="lf lg hx bd lh li mg lk ll lm mh lo lp jd mi je lr jg mj jh lt jj mk jk lv lw bi translated">🐾后续步骤</h1><p id="7db0" class="pw-post-body-paragraph jm jn hx jo b jp lx iy jr js ly jb ju jv lz jx jy jz ma kb kc kd mb kf kg kh ha bi translated">既然你已经知道了何时以及如何使用长时间运行的工作者，你就可以开始在你的应用中实现它们了。</p><p id="eb99" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">👩‍💻👨🏽‍💻要在示例中查看这一点，请查看GitHub 上的<a class="ae hu" href="https://github.com/android/architecture-components-samples/tree/master/WorkManagerSample" rel="noopener ugc nofollow" target="_blank">工作管理器示例。在前台服务中运行工作的代码可以在</a><a class="ae hu" href="https://github.com/android/architecture-components-samples/blob/master/WorkManagerSample/lib/src/main/java/com/example/background/workers/BaseFilterWorker.kt" rel="noopener ugc nofollow" target="_blank"> BaseFilterWorker </a>类和<a class="ae hu" href="https://github.com/android/architecture-components-samples/commit/160f148b5ea4c943028c73acd4667fd134a8674e" rel="noopener ugc nofollow" target="_blank"> this commit </a>中找到。</p><p id="982f" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">🔖关于长时间运行的工人和前台服务的详细指南，请看一下<a class="ae hu" href="https://developer.android.com/topic/libraries/architecture/workmanager/advanced/long-running" rel="noopener ugc nofollow" target="_blank">长时间运行工人的高级工作管理器指南</a>。</p><p id="ac31" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">🦮请务必查看更新的<a class="ae hu" href="https://developer.android.com/guide/background" rel="noopener ugc nofollow" target="_blank">后台处理指南</a>并通读Android上的<a class="ae hu" href="https://developer.android.com/kotlin/coroutines" rel="noopener ugc nofollow" target="_blank"> Kotlin协同程序</a>以了解更多关于该主题的信息。</p><p id="8f4b" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">📚为了了解更多关于工作管理器的信息，<a class="ae hu" rel="noopener" href="/@lylalyla">林珈安</a>和<a class="ae hu" rel="noopener" href="/@pmaggi">皮埃特罗</a>创建了一个<a class="ae hu" rel="noopener" href="/androiddevelopers/introducing-workmanager-2083bcfc4712">博客系列</a>来指导你从工作管理器的基础到高级特性。</p><p id="425a" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">🐛在<a class="ae hu" href="http://goo.gle/workmanager-issue" rel="noopener ugc nofollow" target="_blank"> Google IssueTracker </a>上报告你面临的任何问题。这将有助于我们对新出现的功能和错误修复进行优先排序。</p><p id="0216" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">📝请在下面的评论中或者在推特上让我知道运行即时任务对你有什么帮助。</p></div></div>    
</body>
</html>