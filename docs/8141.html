<html>
<head>
<title>Packet Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据包分析</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/packet-analysis-c5ea5e101048?source=collection_archive---------3-----------------------#2022-08-25">https://medium.com/walmartglobaltech/packet-analysis-c5ea5e101048?source=collection_archive---------3-----------------------#2022-08-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="4d72" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">阅读十六进制，使用BPF和更多</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/82b3bd8ad4f531e3d56f579a1ae610e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ib4hzOj2CsEfOBX2_wa14w.jpeg"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Photo credit: Pixabay/Gerd Altmann</figcaption></figure><p id="4b78" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">阅读和筛选数据包捕获的能力是一项基本技能，有助于快速有效地排除故障和隔离问题。这篇文章快速浏览了一下以太网、TCP和IP报头，介绍了BPF，最后通过将我们所学的知识与Unix/Linux附带的一些CLI工具结合起来，尝试解决一个问题陈述。</p><p id="a69c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们开始讨论标题之前，我们需要了解一些术语:</p><p id="2a41" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">1个十六进制字符= 4位</p><p id="dc22" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">半字节= 4位</p><p id="f596" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">字节= 8位</p><p id="2280" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">字= 16位</p><p id="1a5d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">双字= 32位= 4字节</p><h1 id="82ba" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">头球</h1><p id="91f2" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">标题字段使用它们的偏移量来引用。偏移编号总是从0开始，每个数字代表1个字节。例如，以太网报头的长度为14个字节，偏移量从0到13，6个字节的目的MAC地址占用偏移量0到5。</p><h1 id="5714" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">以太网报头</h1><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es kv"><img src="../Images/3e56048459cdf1f2dd1f14fe082844b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rbq74abkd6vyeQA5uQF5bg.png"/></div></div></figure><p id="2322" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以太网报头长14字节，包含目的MAC、源MAC和以太网类型字段。</p><p id="a259" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以太类型字段标识遵循以太网的封装协议。一些常见的以太网类型值包括IPv4的“0x0800”、VLAN的“0x8100”和ARP的“0x0806”。</p><ul class=""><li id="b3d2" class="kw kx hh ig b ih ii il im ip ky it kz ix la jb lb lc ld le bi translated">以太网报头之后是有效载荷(最大1500字节)和用于检测帧损坏的4字节CRC。这使得以太网帧的总长度为1518字节。</li></ul><h1 id="43ef" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">IPv4标头</h1><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lf"><img src="../Images/c1e3a0c983a822999d9589270fd642bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-mA1vUbZQ2_NalCyCn3bwQ.png"/></div></div></figure><p id="bf46" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">IP负责在互联网上传送数据包。这是一种不可靠的协议，它不努力保证数据包的传送。可靠传输是传输层(或应用程序本身)的工作，检测并重新传输丢失的数据包。IP报头字段包括:</p><p id="9330" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">IP版本:识别IP版本的4位字段。</p><p id="1b50" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">报头长度:用双字表示IP报头的长度。例如，如果这里的数字是5，它意味着5个双字，也就是5×4字节，总标题长度为20字节。事实上，IP报头至少有20个字节长，如果使用选项，可以达到60个字节。为什么是60字节？因为，头长4位，二进制最大值是1111，十进制是15。所以，15*4 = 60字节。</p><p id="b22b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">DSCP和ECN: 6位差异化服务代码点(DSCP)允许对流量类型进行分类，并为特定类型的流量(如语音)提供网络优先级。2位显式拥塞通知(ECN)允许路由器检测和管理网络上的拥塞情况。ECN位与TCP报头中的拥塞窗口缩减(CWR)和ECN标志一起工作。</p><p id="2610" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">总长度:该字段表示IP数据包的总长度，即IP报头、传输报头和有效载荷。</p><p id="b987" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">IP ID:这是分配给每个新数据包的随机数。IP ID字段通常只在我们处理碎片化的IP数据包时才成为焦点。</p><p id="a7aa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">碎片位:3个高位表示保留(X)，不碎片化(D)和更多碎片跟随(M)。13个低阶位表示分段在分段IP数据包中的位置。</p><p id="5084" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">生存时间:TTL确保数据包不会漫无目的地存在于网络中。数据包每经过一跳，TTL就会减少1。当数据包的TTL为0时，它将被丢弃。traceroute是使用最广泛的故障排除工具之一，它使用TTL来确定网络路径上的路由器/跳数。</p><p id="c22b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">协议:该域标识嵌入式协议，其中最常见的值是0x06 (TCP)、0x01 (ICMP)和0x11 (UDP)。</p><p id="6eb0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">校验和:帮助识别传输中损坏的数据包。接收主机应该默默地丢弃校验和无效的数据包。</p><p id="9ccd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">源地址和目的地址:这是32位字段，分别位于偏移量12–15和16–19。</p><p id="d014" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">选项:IP选项最初旨在帮助排除故障，如果使用，会将IP报头大小扩展到20字节以上。一些IP选项包括严格源路由(SSR)和宽松源路由(LSR)。</p><h1 id="0b28" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">TCP报头</h1><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lg"><img src="../Images/e2eacd02f64963f8a796cbe689d91caa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KSz6MYqNFPKLYmsuNThhbQ.png"/></div></div></figure><p id="0bac" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">TCP负责提供可靠和有保证的数据包传输，这是IP所不能做到的。让我们快速看一下TCP报头。</p><p id="fe6f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">源端口和目的端口:16位字段，占据TCP报头的0-3个偏移量。源端口通常大于1024，目的端口是指服务器正在等待连接的服务/应用程序，例如SSL的443或HTTP的80。</p><p id="8e08" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">序列号:序列号允许单个TCP流中的多个数据段在目的地正确排序。它的值随着有效载荷中字节数的增加而增加，因此另一种思考方式是，它允许计算在连接中流动的数据量。</p><p id="28ba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">确认号:目的地通过向发送方发送响应来确认接收到的数据，响应中设置了ACK标志和一个数字，该数字的值为接收数据段中的数据量+序列号。那就是:</p><p id="7dd3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">确认号=(接收的数据量)+序列号。</p><p id="bb83" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">序列号和确认号共同作用，使TCP成为可靠的协议，知道有多少数据已到达目的地，哪些数据丢失，需要重新传输。</p><p id="1227" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">报头长度:这用双字表示TCP报头长度。因为双字是4个字节，所以将该字段中的数字乘以4可以得到TCP报头的字节数。</p><p id="6396" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">标志:占用offset13，TCP可以打开或关闭标志位来表示各种信号。一个快速记住旗帜的方法是记忆法“U(rg)ns killed A(CK)ttackers P(ush)ester R(ST)eal S(yn)security F(in)olk”。以下是按照记忆顺序对这些标志的快速解释。</p><p id="5f13" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">紧急:URG标志表示紧急指针字段有效。</p><p id="1eb9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">确认:ACK表示确认字段中的值有效。在正常的通信流中，在初始SYN之后，ACK标志总是被设置。</p><p id="e813" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">推送:PSH标志指示接收主机立即将其TCP缓冲区中的数据刷新到接收进程/应用程序。</p><p id="94e3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Reset: Rst标志用于突然结束连接，例如，当主机在非监听端口上收到连接请求时，接收主机不做任何处理，而是将Reset标志发送回请求主机。</p><p id="5662" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">同步:当主机想要建立新的连接时，使用SYN标志。发起主机和目的主机都使用各自独立的SYN来建立相互连接。SYN标志计为一个字节。</p><p id="20e1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">完成:当连接正常终止时，使用FIN标志。像SYN一样，连接的两端都发送单独的FIN，并且像SYN一样，FIN也算作一个字节。</p><p id="c203" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">显式拥塞通知回应(ECE):该位打开，通知发送主机降低数据发送速率。</p><p id="39b7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">拥塞窗口减少(CWR):当发送主机从接收方接收到设置了ECE位的数据段时，发送主机将其发送缓冲区减少一半，并设置CWR标志以指示已采取纠正措施。</p><p id="4412" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">IP报头的ECN位和TCP报头的ECE和CWR位一起使用，以指示拥塞通知的存在(在3次TCP握手期间)和以后的支持。</p><p id="d3ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">窗口大小:接收主机用来向发送主机通知其缓冲区大小的动态流量控制机制。当接收主机的TPC缓冲区开始变满时，窗口大小变小。</p><p id="4afb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">校验和:TCP使用由源IP地址和目的IP地址组成的伪报头，作为额外的检查，以确保主机没有收到发往不同主机的数据包。TCP校验和仅由通信端点/主机验证。</p><p id="588b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">紧急指针:与URG标志一起使用，表示当前序列号与该字段中的值之间的数据应在主机缓冲区中的任何其他数据之前立即处理。即紧急指针指示紧急数据结束的字节偏移。</p><p id="4863" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">选项:与IP选项不同，TCP选项被广泛使用。使用的一些常见选项包括:最大数据段大小(MSS ),用于指示主机可以发送的最大有效负载大小；选择性确认(SACK ),用于确认非连续字节的数据；窗口比例，用于允许主机增加其接收缓冲区。</p><h1 id="a9d6" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">读取十六进制</h1><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lh"><img src="../Images/f9effb90371c9689a6ad6d375833557c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t-vvM24Q6GevQdH5Z7Lg3g.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Photo credit: Pixabay/Christoph Schutz</figcaption></figure><p id="84b3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是一个十六进制包的例子。让我们利用所提供的标题/偏移信息确定一些参数，并尝试一些十六进制到十进制的转换。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es li"><img src="../Images/98b5c7b583b94bde5d884c41b0361761.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*siI8ek8IyPt04qKI4vlmuQ.png"/></div></div></figure><p id="033f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">黄色突出显示的部分代表以太网报头。</p><ul class=""><li id="4c65" class="kw kx hh ig b ih ii il im ip ky it kz ix la jb lb lc ld le bi translated">数据包的前6个字节代表目的MAC地址，后面是源MAC地址。</li><li id="358a" class="kw kx hh ig b ih lj il lk ip ll it lm ix ln jb lb lc ld le bi translated">以太网帧“0x0800”的最后2个字节(即偏移量12，13)表示封装的协议是IP</li></ul><p id="b289" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来是以蓝色突出显示的IP报头。</p><ul class=""><li id="c186" class="kw kx hh ig b ih ii il im ip ky it kz ix la jb lb lc ld le bi translated">偏移量0表示IP版本和报头长度。在这个数据包中，IP版本是v4，报头长度是20字节(5*4双字)。因此，该数据包中不使用IP选项。</li><li id="07a6" class="kw kx hh ig b ih lj il lk ip ll it lm ix ln jb lb lc ld le bi translated">偏移量9处的IP协议字段的值‘0x 06’表示TCP。</li></ul><p id="649d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在20字节的IP报头之后，TCP报头以绿色突出显示。</p><ul class=""><li id="00e6" class="kw kx hh ig b ih ii il im ip ky it kz ix la jb lb lc ld le bi translated">偏移量2和3包含十六进制的目的端口号‘0x 01 bb’。十六进制是以16为基数的计数系统。为了将其转换为十进制，我们将16提升到每个十六进制字符的位置，并乘以相应的十六进制字符。然后求和得到十进制的结果。</li><li id="9c6b" class="kw kx hh ig b ih lj il lk ip ll it lm ix ln jb lb lc ld le bi translated">这看起来如下:</li></ul><blockquote class="lo lp lq"><p id="444f" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">(16 x 0) + (16 x 1 ) + (16 x b) + (16⁰ x b)</p><p id="34a4" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">= 0 + 256 + (16x11) + (1x11)</p><p id="8c80" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi">= 443</p></blockquote><p id="1aff" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们使用来自Wireshark的同一个数据包的屏幕截图来证实我们的数据包演练:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lv"><img src="../Images/ffc33a4e860569779310385e18076b97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9SbRdSu1ALF3GBGLY-Ya8g.png"/></div></div></figure><h1 id="3511" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">伯克利分组过滤器(BPF)</h1><p id="9909" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">BPF是一种架构和机制，旨在允许在网络数据包到达应用程序的途中对其进行过滤，并尽早丢弃不需要的数据包[1]。Tcpdump是一个使用BPF来实现过滤功能的工具的例子[2]。BPF现在引入了额外的功能来扩展内核功能，允许跨网络、安全、分析和监控创建新的应用程序[3]。与此相关的是，为了更详细地了解扩展BPF (eBPF)的令人兴奋的应用，请看沃尔玛的L3AF项目<a class="ae lw" rel="noopener" href="/walmartglobaltech/introducing-walmarts-l3af-project-how-do-we-use-ebpf-to-provide-network-visibility-in-a-8b9ae4d26200">这里</a>。</p><p id="34aa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过对BPF的快速介绍，让我们看看如何将表达式放在一起，以帮助更好地分析数据包捕获。</p><h1 id="7fc2" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">BPF格式</h1><p id="f1c9" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">我们可能已经熟悉的格式，使用表达式根据关键字(如协议、端口、网络以及它们的组合)来过滤流量。例如，' icmp '，' udp端口53 '，' net x.x.x.0/24 '。</p><blockquote class="lo lp lq"><p id="47af" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">语法:tcpdump<keyword>T3】</keyword></p><p id="47c5" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">tcpdump -r demo.pcap -ntc1 'dst端口443 '</p><p id="3551" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">IP 192 . 168 . 1 . 1 . 52255 &gt; 40 . 103 . 10 . 38 . 443:标志[。]，序列号2667572664:2667574014，ack 3107627624，win 4096，长度1350</p></blockquote><p id="c7f2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果我们想更深入地挖掘，例如，只找到设置了SYN标志的TCP包，该怎么办？从协议报头中，我们可以使用偏移值来查找所需的字段。考虑下面的例子——这里我们要求tcpdump查找TCP的第13个偏移量(即标志字段)中的值，其中值为“2”。</p><blockquote class="lo lp lq"><p id="a6c2" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">语法:tcpdump <protocol> <length is="" optional=""> <relation> <value/></relation></length></protocol></p><p id="fdd6" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">TCP dump-r demo . pcap-NTC 1 ' TCP[13]= 0x 02 '</p><p id="1cda" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">IP 192 . 168 . 1 . 1 . 52262 &gt; 13 . 107 . 139 . 11 . 443:Flags[S]，seq 2517098632，win 65535，options [mss 1350，nop，wscale 6，nop，nop，TS val 35399207 ecr 0，sackOK，eol]，长度0</p></blockquote><p id="46e2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们怎么知道标志值需要是‘2’呢？</p><p id="8cac" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们仔细看看TCP flags字段—这是一个1字节的字段，用十六进制表示为2个字符。每个十六进制字符为4位长(即1个半字节)。每个字段的值以二进制表示为2，自乘到标志位置的幂。2(即2)，因此指示我们的过滤器查找设置了“Syn”标志的数据包。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lx"><img src="../Images/e3f26de22e5e9700a0c6a3a216c6fd3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZCpBQMWCQP5BiYzGPP9Q4g.png"/></div></div></figure><h1 id="8e98" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">比特屏蔽</h1><p id="8464" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">检查正好1字节长的字段很简单。如果您希望查找4位值(例如，IP版本)或查找特定字段而不考虑其他值，例如，查找“Syn”和“Ack”数据包而不考虑是否设置了“ECN”标志，该怎么办？</p><p id="7fed" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们使用称为位屏蔽的东西，它使用逻辑AND运算来消除不需要的位。让我们看一个例子。</p><p id="e49d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">假设您想要搜索使用选项的IP数据包，即IP报头大小大于标准的20字节。IP报头值位于IP报头偏移量0的低位半字节:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ly"><img src="../Images/29dae2b48a74ca7c5024bd59a4f58103.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-JpBYB2WiSbfqkGjiPnVRA.png"/></div></div></figure><p id="e03d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因为“报头长度”表示双字的数量，所以该字段中的值5表示20字节的IP报头(即，5 * 4双字)。由于IP版本和报头长度共同占据一个偏移字段(即1字节)，我们必须在表达式中包含这两个字段。例如，ip[0] &gt; 0x45会过滤数据包大小大于20字节的IPv4数据包。ip[0] &gt; 0x75怎么样？这将不起作用，因为值7(不正确的IP版本号)将排除所有IPv4数据包。</p><p id="9fd4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此，解决方案是以某种方式消除IP版本值。输入位屏蔽。</p><p id="55ad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">考虑典型IPv4数据包中的IP版本和报头长度字段。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ly"><img src="../Images/6e9ffb51de88937e89161055be400a3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VedvqZxzj72V8vv2p9FHJQ.png"/></div></div></figure><p id="ded7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，考虑我们想要的版本和头长度值。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lz"><img src="../Images/043f40a15538b4e1893473cf664c7c74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t46iElnXsg2oib56Wo_QVw.png"/></div></div></figure><p id="bb7e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，我们必须选择一个合适的位屏蔽，当它与offset 0中的值进行逻辑“与”运算时，会产生我们想要的输出。当两个值都为真时，逻辑AND返回真(即1)，否则返回假(即0)。换句话说，在掩码位中使用0来消除值，使用1来保留值。</p><p id="a7b4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">十六进制的掩码值0000 1111–0x0f怎么样？</p><p id="1fea" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们将该掩码值与典型IPv4数据包的偏移量0中的值进行AND运算。我们发现我们得到了所需的值0000 0110，即十六进制的0x05。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ma"><img src="../Images/4d9b1d70c76221e21fae8094293cd0af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TOEtoXCQIo3qq4PgSkGbaA.png"/></div></div></figure><p id="b6fe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，我们的BPF表达式仅过滤使用IP选项的数据包(即，报头大小大于20字节)，是“ip[0] &amp; 0x0f &gt; 0x05”。</p><p id="5146" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">类似地，用于过滤具有‘Syn’和‘Ack’字段的分组的掩码，不管其他标志并且没有‘ECN’，将是‘0011 1111(十六进制的0x3f)’,并且对应的BPF表达式将是‘TCP[13]&amp; 0x3f = 0x 12’。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mb"><img src="../Images/cc68cf6d188fbe0f97924557ab4e15a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-abpBwqz9boxSY4GCwTtZg.png"/></div></div></figure><h1 id="3b0e" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">把所有的放在一起</h1><p id="a614" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">假设您拥有一个大型数据包捕获，您想要找到所有接受连接的IP和监听端口。如何识别服务器是否接受连接？寻找以“Syn-Ack”回应的IP是一个很好的起点。</p><p id="11f7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先，我们可以使用“Editcap”将分析范围缩小到特定的时间范围。例如:</p><blockquote class="lo lp lq"><p id="21b8" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">edit cap-A " 2021–12–27 15:05:11 "-B " 2021–12–27 15:05:12 " demo . pcap demo-extract . pcap</p></blockquote><p id="ef12" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Capinfos是一个帮助显示关于捕获文件元数据的工具。使用此工具验证文件大小，我们观察到原始文件为12MB，提取的文件大小为973kB。</p><blockquote class="lo lp lq"><p id="0061" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">capinfos demo.pcap | grep大小</p><p id="8afa" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">文件大小:12MB</p><p id="d570" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">capiinfos demo-extract . pcap | grep size</p><p id="21a1" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">文件大小:973kB</p></blockquote><p id="233c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在让我们使用tcpdump和我们之前构建的BPF表达式来过滤设置了“Syn”和“Ack”的数据包。(注意，tcpdump中的‘Ack’表示为一个句点。)</p><blockquote class="lo lp lq"><p id="6ca6" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">TCP dump-r demo . pcap-nt ' TCP[13]&amp; 0x3f = 0x 12 '</p></blockquote><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mc"><img src="../Images/269649b4c6ae12d909317bbe5eb348bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EWtqDhK8UfLEvjwboK5Cow.png"/></div></div></figure><p id="e808" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们得到了我们的输出，尽管格式冗长而笨拙。更别说还有接近200+的线。让我们看看是否可以调整这个输出。</p><p id="96e2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在基于Unix/Linux的系统中，我们可以通过管道将一个工具的输出作为另一个工具的输入——您从“|”左边的工具获取输出，并将其作为输入传递给右边的工具。这里，我们将tcpdump的输出作为Cut的输入。</p><p id="bf3a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用剪切工具，我们可以将输出视为列，在这种情况下，我们将'&gt;'视为分隔符，只提取第一列。</p><blockquote class="lo lp lq"><p id="a800" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">TCP dump-r demo . pcap-nt ' TCP[13]&amp; 0x3f = 0x 12 ' | cut-d ' &gt; '-f1</p></blockquote><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es md"><img src="../Images/04cf125c83ea11e85a6f0d2b0662b45a.png" data-original-src="https://miro.medium.com/v2/resize:fit:708/format:webp/1*k_ylyaaBonXnGeLGwSmxGQ.png"/></div></figure><p id="f5f7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们也从输出中删除字母“IP”。现在，我们使用一个空格“”作为分隔符，并匹配第2列。</p><blockquote class="lo lp lq"><p id="da56" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">TCP dump-r demo . pcap-nt ' TCP[13]&amp; 0x3f = 0x 12 ' | cut-d ' &gt; '-f1 | cut-d ' '-F2</p></blockquote><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es me"><img src="../Images/b323b351df51439424bad60bbc96048f.png" data-original-src="https://miro.medium.com/v2/resize:fit:736/format:webp/1*Re2ndh8HeHewE1UzRKkLlQ.png"/></div></figure><p id="3940" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是一个更清晰的输出，但是我们仍然有200多行要处理。我们通过sort和uniq传递输出，得到只有11行的输出。</p><blockquote class="lo lp lq"><p id="bd96" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">TCP dump-r demo . pcap-nt ' TCP[13]&amp; 0x3f = 0x 12 ' | cut-d ' &gt; '-f1 | cut-d ' '-F2 | sort-V | uniq</p></blockquote><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es mf"><img src="../Images/1000cf0a6c35e7975e32685de23651f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:740/format:webp/1*ia1KVdcp7tIe81mZb1uIVQ.png"/></div></figure><p id="5f5f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最终输出是可管理的唯一IP和端口列表，这些IP和端口正在主动侦听和接受连接。您的环境中有这么多web服务器吗？运行在临时端口59456上的服务是有意的吗？您的组织知道吗？</p><h1 id="18f5" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">结论</h1><p id="317d" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">我们快速浏览了一些重要的协议报头，介绍了BPF，并演示了如何使用内置的CLI工具将冗长的输出变成清晰、易于管理的输出。本文只是触及了TCP/IP报头和包分析的皮毛。</p><p id="837d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于已经了解所讨论主题的人来说，希望这是一个很好的复习。对于其他人，希望你学到了一些新东西，可以在工作中用于分析/故障排除任务。请让我知道你对内容的想法。</p><h1 id="6973" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">参考</h1><p id="23fb" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">1.<a class="ae lw" href="https://www.tcpdump.org/papers/bpf-usenix93.pdf" rel="noopener ugc nofollow" target="_blank">https://www.tcpdump.org/papers/bpf-usenix93.pdf</a></p><p id="bb0b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2.https://lwn.net/Articles/437981/<a class="ae lw" href="https://lwn.net/Articles/437981/" rel="noopener ugc nofollow" target="_blank"/></p><p id="3097" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">3.<a class="ae lw" href="https://www.brendangregg.com/bpf-performance-tools-book.html" rel="noopener ugc nofollow" target="_blank">https://www . brendang regg . com/bpf-performance-tools-book . html</a></p><p id="820d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">4.SANS SEC503 — GCIA</p><p id="492b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">5.TCP/IP指南— Charles M. Kozierok</p><p id="f7ef" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">6.https://www.wireshark.org/docs/man-pages/editcap.html<a class="ae lw" href="https://www.wireshark.org/docs/man-pages/editcap.html" rel="noopener ugc nofollow" target="_blank"/></p><p id="a1b4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">7.首都信息—【https://www.wireshark.org/docs/man-pages/capinfos.html T4】</p></div></div>    
</body>
</html>