# 介绍沃尔玛的 L3AF 项目:我们如何使用 eBPF 在多云环境中提供网络可见性

> 原文：<https://medium.com/walmartglobaltech/introducing-walmarts-l3af-project-how-do-we-use-ebpf-to-provide-network-visibility-in-a-8b9ae4d26200?source=collection_archive---------0----------------------->

这是介绍 L3AF 项目的三篇系列文章中的第一篇，该项目使用 eBPF 和相关技术提供内核功能即服务。

# eBPF 入门

传统上，运行在用户空间的应用程序通过系统调用来访问内核资源。但是现在，eBPF 提出了一个新的模型，允许我们在内核中运行定制的沙盒代码。使用 eBPF，可以通过简单的程序扩展/定制内核功能。这些程序可以与所需的内核事件相关联，因此只要事件发生，它们就会被执行。打个比方，eBPF 程序之于内核，就像插件之于代理或 web 服务器一样。

让我们更详细地看看 eBPF 是如何实现这一点的。eBPF 在内核中作为一个迷你 VM 运行。这个迷你虚拟机提供了一个沙盒环境，它与低级网络挂钩(如 XDP/TC)以及探测机制(如 kprobes、uprobes 和 tracepoints)进行了现成的集成。有了这个架构，现在可以编写高效的 eBPF 程序并在内核中运行它们。eBPF 内核程序用 C 编写，编译成 eBPF 字节码。

eBPF 还提供了一种安全可靠的方式在内核中完成所有这些工作。验证步骤确保 eBPF 程序可以安全运行。它验证程序是否满足几个条件，例如，它确保程序不会崩溃，并且总是运行到完成(不存在无限循环)。实时(JIT)编译步骤将程序的通用字节码翻译成机器专用的指令集，以优化程序的执行速度。这使得 eBPF 程序可以像本地编译的内核代码一样高效地运行。

关于 eBPF 的更多详情，请参考 https://ebpf.io/

![](img/4a39cc401a162bf8dd18ff01dc89222a.png)

eBPF Integrations and Hooks

# L3AF 简介

沃尔玛全球技术公司正在一个名为 L3AF 的项目下开发 eBPF 领域的一些最前沿的产品。L3AF 借助用 Go 编写的高级控制平面，提供基于 eBPF 的网络和可观测性解决方案。

在网络领域，L3AF 通过提供 eBPF 程序的完整生命周期管理来实现内核功能即服务，eBPF 程序用于检测、检查和拦截流量。这些 eBPF 程序使用 XDP 和 TC 等低级网络挂钩，为我们提供了一个超高性能的可编程网络数据平面，它在 Linux 网络堆栈的较高层和较低层之前执行。

在可观察性方面，L3AF 通过收集和聚合内核中事件源生成的定制信息，提供了一个精选指标列表。这些指标提供了关于集群/节点利用率、下游/上游网络性能以及跨多个云的流量分布的详细信息。与其他程序相比，L3AF 提供了对系统性能的更深入的可见性，这些程序依赖于操作系统(like /proc) **公开的静态计数器和计量器。通过保持完全的兼容性，包括对 Prom QL 的支持，L3AF 还提供了与普罗米修斯**T3 的现成集成。****

在这个博客系列中，我们关注 L3AF 的网络解决方案，它支持内核功能即服务(KFaaS)。

# 网络前景、挑战和解决方案

随着企业采用混合云战略并将工作负载从私有云迁移到公共云，一些有趣的机会变得显而易见:

*   迫切需要在公共云中获得与私有云相同级别的网络可见性。
*   由于与网络相关的限制和成本，混合云环境需要对流量进行更好的控制。
*   随着企业转向对称部署，用基于软件的解决方案取代私有云中基于硬件的数据包处理解决方案以实现与公共云同等的功能至关重要。

让我们深入探讨一下这些功能差距及其基于 eBPF 的解决方案:

## 交通流量日志

随着企业开始从公共云中提供实时流量，将流量数据导出到安全解决方案变得越来越重要，这些安全解决方案可跨扩展的网络和云提供高级威胁防护。

私有云通过专用网络设备(基于硬件的解决方案)提供流量数据。然而，由于基础架构层是共享的，公共云中的租户无法享受类似级别的访问/网络可见性。我们考虑了解决这个问题的选项，例如添加一个网络跳来处理流量数据(使用 NetFlow 协议)。这种配置增加了流量延迟，并且还在流量入口堆栈中增加了另一个管理层。

作为最佳解决方案，L3AF 项目开发了一个 eBPF 程序(内核函数)，直接从基于 Linux 的边缘代理服务器提取和导出流元数据。

![](img/c68e2179f33db3653a5996f9996148f9.png)

eBPF based Flow Exporter Solution

如图所示，eBPF 内核函数(TC)从每个入站和出站数据包中检索流属性，并在 eBPF 映射中将它们更新为流记录。eBPF 映射是各种类型的通用键值存储，可以在用户和内核空间之间共享数据。流记录映射包含一个 5 元组(sa、da、sp、dp、proto)作为关键字，以及其他流属性，如分组/字节计数器、最后看到的、TCP 标志等。作为价值观。

用户空间中的流导出器定期读取流记录，并计算自上次轮询以来的流统计数据。通过在另一个最后记录映射中保存流状态(在每次读取之后),计算连续读取之间的计数器增量。这使我们能够准确地跟踪活跃的流量。

一旦必要的流属性就绪，就会根据 [RFC](https://datatracker.ietf.org/doc/html/rfc7011) 创建 IPFIX 消息，并将其导出到任何安全威胁检测和分析工具。

主要优势如下:

*   除了节省基础设施成本，L3AF 的解决方案还通过消除通过额外网络跳的需要，显著降低了流量的整体延迟。
*   这个解决方案使用更灵活的开源 IPFIX 协议，而不是 NetFlow。与 NetFlow 不同，IPFIX 允许导出可变长度的自定义字段(如 URL ),这提供了增强的可见性。

## 流量镜像

商业成功的最佳方式是提供令人惊叹的客户体验。当顾客在网上购物时，整体体验的质量往往会影响他们*。*在沃尔玛，我们希望了解顾客如何与我们的网站互动。

我们有一些分析解决方案，可以处理数据流并提供所需的分析。但是这些解决方案需要感兴趣的数据，并且这种兴趣会随时间而变化。通过自动化收集这些数据的过程，有机会节省宝贵的时间和金钱。

在公共云中收集感兴趣的数据的最有效方法之一是从边缘代理服务器收集。但是，它也是一个关键的跃点，负责处理站点的所有入站流量，并且对性能非常敏感。

因此，我们开始探索一些商业解决方案，其中一些列在这里:

*   运行独立代理，该代理将镜像代理虚拟机上的 100%流量。然而，这将导致:

​ ​ ​​​ ​ ​​​ ​ ​​​ ​ ​​​ ​ 1.因为我们要镜像 100%的数据，所以流量开销很大。​ ​​​ ​ ​​​ ​

​ ​ ​​​ ​ ​​​ ​ ​​​ ​ ​​​ ​ ​​​​2.额外的许可成本(我们决定镜像的每网卡美元)。

​ ​ ​​​ ​ ​​​ ​ ​​​ ​ ​​​ ​ ​​3.主机资源的开销。

*   使用公共云本地提供的流量镜像服务。然而，这不是一个一致的解决方案，因为许多类型的公共云要么不提供这种解决方案，要么不提供过滤感兴趣的数据的必要功能。

为了克服这些限制，L3AF 项目开发了一个基于 eBPF 的软件解决方案，将过滤和镜像功能封装在一起。该解决方案支持 5 元组(sa、da、sp、dp、proto)中的一个或多个自定义过滤器，并且还允许我们仅捕获报头数据(如果需要)，从而限制带宽利用率。

![](img/b00691e7bfcf5247c703eb9bc14f0253.png)

eBPF based Traffic Mirroring Solution

此外，鉴于 eBPF 是非常轻量级、高性能和安全的，该解决方案已经在源端(即，在边缘代理上)实现。因此，在边缘代理上，我们将镜像功能附加到处理实际流量的主网卡。该解决方案使用 TC hook 检查每个传入/传出数据包，并将其与过滤器(基于 5 元组)进行匹配。如果匹配成功，它会克隆数据包并重定向到辅助网卡，该网卡会将流量转发到 GUE 隧道上的分析系统。

主要优势如下:

*   与主要用于私有云的基于硬件的解决方案(tap)不同，我们通过基于软件的解决方案实现了用例。这种基于软件的解决方案直接在主机上运行，因此消除了额外的硬件故障点，并节省了基础架构成本。
*   传统的云解决方案将 100%的流量镜像到位于集中式云中的聚合层。因此，在发送流量和将优化的流量接收回我们的云订阅时，会产生额外的流量成本。定制的过滤功能允许我们仅将我们关心的流量镜像到分析系统。
*   由于 eBPF 解决方案可以动态编程以连接/分离，它们提供了选择性选择应用程序/域的灵活性，我们希望以无缝的方式动态地了解这些应用程序/域。

在这篇博文中，我们回顾了一些网络可见性的用例。在这个由三部分组成的系列中，我们的下一篇博客将关注 L3AF 如何使用 XDP 提供大规模的高性能网络解决方案。

*这篇博客是根据 L3AF 项目的工程师*[*Ragalahari*](https://www.linkedin.com/in/raga-lahari-505b4822/)*和*[*Kan thi*](https://www.linkedin.com/in/kanthipavuluri/)*的意见撰写的。*