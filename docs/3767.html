<html>
<head>
<title>Build your own Client VPN in AWS and authenticate users to it with Okta IdP in an automated fashion.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS中构建您自己的客户端VPN，并使用Okta IdP以自动化的方式向它认证用户。</h1>
<blockquote>原文：<a href="https://medium.com/globant/build-your-own-client-vpn-in-aws-and-authenticate-users-to-it-with-okta-idp-in-an-automated-fashion-2c918e4604a4?source=collection_archive---------0-----------------------#2021-10-15">https://medium.com/globant/build-your-own-client-vpn-in-aws-and-authenticate-users-to-it-with-okta-idp-in-an-automated-fashion-2c918e4604a4?source=collection_archive---------0-----------------------#2021-10-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/546085a29ccf8833cf2b566109a86991.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RO2Wejxi0lf4CP3qF2Ee5A.png"/></div></div></figure><h1 id="b6e9" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated"><strong class="ak">简介</strong></h1><p id="5d47" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">众所周知，全球所有公司每天都在努力实现最可靠、最牢不可破和最强大的方法来保护数据。其中一种方法是尝试通过实施虚拟专用网络(VPN)来加密传输中的数据，从而保护私有网络，无论是在内部还是在云环境中。但是现在数据被安全地加密了，我们如何确保最终用户是我们组织中值得信任的人呢？</p><p id="afbe" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">我们希望实现一种方法，将我们的用户与任何应用程序或设备连接起来，而无需自己构建和维护集成。</p><p id="4387" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">在本文中，我想指导您如何在AWS中构建自己的客户端VPN，并将其与安全声明标记语言(SAML 2.0-base federated)、Okta身份提供者(IdP)集成，以便通过Terraform以自动化的方式向我们的VPN认证用户，管理2个提供者和不同的环境。</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kq"><img src="../Images/f68b0ba76cb952f333add65db55dde12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/format:webp/1*olChW2aVlCjd6VuZ0ryu5w.jpeg"/></div></div></figure><p id="672d" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated"><strong class="jp hi">注意</strong>:我假设你知道Terraform的基础知识，比如创建变量和获取输出，所以我将跳过代码中的解释。</p><h1 id="5b72" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">工具</h1><ul class=""><li id="f020" class="kv kw hh jp b jq jr ju jv jy kx kc ky kg kz kk la lb lc ld bi translated">Okta为你提供了一个30天的免费试用帐号，我们将在这个教程中使用，你可以在这里创建它(【https://www.okta.com/free-trial/】)。</li><li id="d7c1" class="kv kw hh jp b jq lf ju lg jy lh kc li kg lj kk la lb lc ld bi translated">在这里可以找到Okta Terraform提供者(<a class="ae le" href="https://registry.terraform.io/providers/okta/okta/latest/docs" rel="noopener ugc nofollow" target="_blank">https://registry . terra form . io/providers/Okta/Okta/latest/docs</a>)和AWS提供者(<a class="ae le" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs" rel="noopener ugc nofollow" target="_blank">https://registry . terra form . io/providers/hashi corp/AWS/latest/docs</a>)。</li><li id="bc05" class="kv kw hh jp b jq lf ju lg jy lh kc li kg lj kk la lb lc ld bi translated">我们将使用免费的AWS帐户。然而，AWS客户端VPN没有免费层，我们在这里要注意避免收费。</li></ul><h1 id="65bf" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated"><strong class="ak">配料</strong></h1><p id="957d" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">由于所有的资源都将通过terraform创建和管理，我们只需要从Okta和AWS获得我们的凭证就可以访问。我们去抓住他们。</p><p id="5110" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">当我们准备好我们的免费Okta帐户时，让我们记下一些将在以后帮助我们的事情。</p><ul class=""><li id="9f72" class="kv kw hh jp b jq kl ju km jy lk kc ll kg lm kk la lb lc ld bi translated">基本URL。</li><li id="9be7" class="kv kw hh jp b jq lf ju lg jy lh kc li kg lj kk la lb lc ld bi translated">组织名称。</li><li id="1bbe" class="kv kw hh jp b jq lf ju lg jy lh kc li kg lj kk la lb lc ld bi translated">API令牌。</li></ul><figure class="kr ks kt ku fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ln"><img src="../Images/07a248cbe47f87492be4d5c00fdc6eb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uLYGoBeCgfXeb4mdbTrkKA.jpeg"/></div></div></figure><p id="19dd" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">在我的例子中，我的ORG_NAME将是“dev-8354988 ”,我的BASE_URL是“okta.com ”,不要担心，在你读这篇文章的时候，我已经删除了这个okta帐户。</p><p id="385a" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">在左侧面板中创建API令牌&gt;“安全”&gt;“API”&gt;“令牌”&gt;“创建令牌”。然后输入一个名称，并将该令牌复制到记事本中。小心，除非你把令牌复制到别的地方，否则你不会再看到它。</p><p id="165f" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">让我们跳到我们的AWS帐户，转到IAM控制台，创建一个具有管理权限的基本IAM编程用户，保存凭据，并创建一个具有填充权限的IAM角色。</p><h1 id="5300" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated"><strong class="ak">架构</strong></h1><figure class="kr ks kt ku fd ii er es paragraph-image"><div class="er es lo"><img src="../Images/586a63ffaa9f6c8ae95031b70a34c0be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*cRhv2VinnR3VXe2c_A2Xzw.jpeg"/></div></figure><p id="3b6d" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">平台提供商将帮助我们提供基础设施。</p><p id="0661" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">在AWS中，我们将提供:</p><ul class=""><li id="39e7" class="kv kw hh jp b jq kl ju km jy lk kc ll kg lm kk la lb lc ld bi translated">一个IAM IdP将与Okta的客户端VPN的SAML 2.0应用程序兼容。</li><li id="5abc" class="kv kw hh jp b jq lf ju lg jy lh kc li kg lj kk la lb lc ld bi translated">Amazon Certificate Manager中的证书导入，用于加密客户端VPN软件和客户端VPN端点之间的通信。</li><li id="e5ac" class="kv kw hh jp b jq lf ju lg jy lh kc li kg lj kk la lb lc ld bi translated">客户端VPN(本测试使用默认的亚马逊虚拟私有云(亚马逊VPC))。</li></ul><p id="0b92" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">在俄克拉荷马州，我们将提供:</p><ul class=""><li id="eb1f" class="kv kw hh jp b jq kl ju km jy lk kc ll kg lm kk la lb lc ld bi translated">用于AWS客户端VPN的SAML 2.0应用程序。</li><li id="de7e" class="kv kw hh jp b jq lf ju lg jy lh kc li kg lj kk la lb lc ld bi translated">一个用户和一个组使用它来进行身份验证。</li></ul><h1 id="45a7" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">游戏攻略</h1><p id="a8da" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">让我们开始构建我们将为此使用的Terraform代码，所以首先，创建main.tf来指定下一个:</p><ul class=""><li id="feaa" class="kv kw hh jp b jq kl ju km jy lk kc ll kg lm kk la lb lc ld bi translated">AWS和Okta提供商。</li><li id="7e33" class="kv kw hh jp b jq lf ju lg jy lh kc li kg lj kk la lb lc ld bi translated">S3的一个后端来存储我们的terraform.tfstate</li><li id="196b" class="kv kw hh jp b jq lf ju lg jy lh kc li kg lj kk la lb lc ld bi translated">创建的角色将由Terraform承担。</li></ul><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="e7a7" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">之后，我们将在同一个文件中构建Okta和AWS使用的模块。</p><p id="fa43" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">对于Okta:</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="f318" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">对于AWS:</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="0c21" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">正如您可能注意到的，这些是我们将用于此资源调配的所有变量和模块，因此现在我将跳过每个资源的模块和变量配置。</p><p id="05cd" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">让我们跳到我们将用于开发/QA的环境变量。在这里，我们可以定义模板中使用的所有变量，以便只管理这个文件，避免在代码中硬编码值。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="07b5" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">记住使用您自己的Aws帐户ID、VPC ID和子网ID。</p><p id="a50d" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">为此测试指定的客户端CIDR数据块为“10 . 10 . 0 . 0/22 ”, DNS将为Google DNS，CloudFlare DNS适用于此测试。</p><p id="610e" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">现在让我们来看看Okta配置，我们将分为3个模块，如您所见，应用程序、群组和用户。</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div class="er es lr"><img src="../Images/7472982f90a02995ad9ac81958dd2b4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:498/format:webp/1*UqrsTgu0WqPhWtnSaiOaAQ.png"/></div><figcaption class="ls lt et er es lu lv bd b be z dx">Okta Modules</figcaption></figure><p id="8f85" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated"><strong class="jp hi">注意:</strong>对于Okta提供者，我们必须在提供者的每个模块中指定版本，就像我们在主文件中做的一样，你可以在一个单独的。您的模块中的tf文件。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="e613" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">对于应用程序，我们将使用AWS客户端VPN的预配置应用程序。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="0b58" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">我们还将创建一个应用组分配，这将帮助我们将Okta中创建的组分配到应用客户端VPN，两者都在同一个应用模块中。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="36f4" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">对于组，我们必须创建组并为此组指定一个名称，这很重要，因为组名必须与我们稍后将创建的客户端VPN授权中的名称完全匹配。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="1603" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">对于Okta用户和应用程序模块，我们必须创建用户并将其分配给一个组。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="17f7" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">这个用户必须是我们刚刚创建的组的成员。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="dfb3" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">这就是我们在Okta需要做的所有配置，在这里你可以管理你的用户、群组成员、应用分配等。并将它应用到您的多种环境中，而不必每次都重新编写代码或手动完成。请记住，应该为用户或群组分配应用程序，否则，在认证后，应用程序将无法工作。</p><p id="861a" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">到目前为止，我们已经看到了如何配置Okta资源，如一个简单的用户、一个组和一个SAML应用程序，它们将帮助我们向AWS客户端VPN进行身份验证，现在让我们看看如何配置AWS资源。</p><p id="c57c" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">在继续之前，我们需要生成一个简单的证书以导入AWS证书管理器。有许多关于如何生成一个文件的资源，我们需要chain.crt、ca.crt和密钥，您可以在您的“acm”模块中创建带有这些扩展名的文件。</p><p id="5433" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">分为4个模块，这是我们需要的。</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div class="er es lw"><img src="../Images/77cfa14c15c165d1311ca5b9428b74e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:368/format:webp/1*jgjqd3g96lpv_MLngVkpBw.png"/></div></figure><p id="17ee" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">通过此代码，我们将提供以下资源:</p><ul class=""><li id="9008" class="kv kw hh jp b jq kl ju km jy lk kc ll kg lm kk la lb lc ld bi translated">我们将向AWS ACM导入一个证书。</li><li id="4259" class="kv kw hh jp b jq lf ju lg jy lh kc li kg lj kk la lb lc ld bi translated">将创建客户端VPN、路由和授权。</li><li id="c60c" class="kv kw hh jp b jq lf ju lg jy lh kc li kg lj kk la lb lc ld bi translated">IAM中的IdP与我们的Okta帐户匹配。</li><li id="b8d6" class="kv kw hh jp b jq lf ju lg jy lh kc li kg lj kk la lb lc ld bi translated">一个简单的安全组，允许我们的客户端VPN的一些规则。</li></ul><p id="0dc6" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">为了导入证书，一旦证书位于我们的模块目录中，我们就要使用“File”函数从我们的模块中调用这些资源。</p><p id="25c2" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">我们需要前面生成的文件中所述的下一个文件:</p><ul class=""><li id="a57a" class="kv kw hh jp b jq kl ju km jy lk kc ll kg lm kk la lb lc ld bi translated">私有密钥</li><li id="7aef" class="kv kw hh jp b jq lf ju lg jy lh kc li kg lj kk la lb lc ld bi translated">证书_正文</li><li id="56fa" class="kv kw hh jp b jq lf ju lg jy lh kc li kg lj kk la lb lc ld bi translated">证书链</li></ul><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="87ca" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">对于IAM中的IdP，我们需要XML格式的“元数据”输出，我们可以在Okta Module &gt; app中轻松生成，如果您再次向上滚动并检查main.tf中的模块IAM，您会注意到我们从该资源中调用了该属性。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="2b8c" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">对于安全组，我们将创建一个所有流量都开放的安全组，源将是我们为客户端VPN选择的子网。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="239f" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">最后，对于客户端VPN配置，我们需要配置以下资源，首先我们需要创建客户端以使用联合身份验证，并使用我们在IAM中创建的客户端，以及所需的基本配置。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="6bdf" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">然后，我们需要子网关联和客户端VPN的路由。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="5eff" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">您可能注意到，在路由中，我们使用了一个局部变量和一个名为“Routes_All”的变量，这是因为我们将使用该资源中的一些值，并独立地操纵它，而不考虑其余的资源。</p><p id="69b9" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">但首先让我们创建授权，这将像客户端VPN中的“组”一样进行配置，我们给它的名称应该与我们刚才在Okta中创建的组的名称相匹配，如果该组不匹配，我们的用户将无法到达任何网络。</p><p id="2844" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">对于最佳实践，我们希望将不同资源中的授权分开，以限制每个团队或用户应该到达的路线，例如开发人员团队应该以他们自己的帐户到达开发人员-VPC，或者第三方团队应该到达他们自己的VPC，而不能到达网络的其余部分，为此目的的每个资源应该这样配置:</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="b024" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">同样，我们使用本地资源来完成这项工作。此外，我们使用“For_each”元参数来更好地管理每个路由和每个授权。</p><p id="64ce" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">本地文件如下所示:</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="78bc" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">在这种情况下我们只需要把路由添加到我们自己的VPC来测试和授权相同的路由。路由是我们希望使用客户端到达的远程VPC或子网，授权是Okta和AWS中的组将到达的路由，如果没有明确地在授权中，但是在路由中，用户将不能到达目的地。</p><p id="9818" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">哇，我们终于有代码了！我们去部署它！</p><p id="9878" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">还记得我们创建Okta API和我们记下的所有值吗？让我们把它们放入环境变量中。</p><p id="3f6a" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">$ Env:OKTA _ ORG _ NAME<br/>$ Env:OKTA _ BASE _ URL<br/>$ Env:OKTA _ API _ TOKEN</p><p id="5557" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">AWS凭证也是如此。</p><p id="44f6" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">$ Env:AWS _ ACCESS _ KEY _ ID<br/>$ Env:AWS _ SECRET _ ACCESS _ KEY</p><p id="0700" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">一旦我们有了这些，我们就可以运行“<em class="lx"> Terraform Init </em>来初始化它，最重要的是，您想要创建一个工作区<em class="lx">“terra form workspace new dev _ workspace”</em>来隔离您的多个环境，否则您的部署将被覆盖，运行一个快速验证来查看是否有任何东西出现，如果没有，我们可以使用我们的“<em class="lx">来运行“<em class="lx"> Terraform计划</em>。tfvars" </em>查看要在我们想要应用和测试的环境中创建的资源。</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ly"><img src="../Images/dc82cc8999e2386f6b14b01246ca6332.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wakf7_9mwBe7_3eg.png"/></div></div></figure><p id="4db6" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">然后，应用更改并等待资源完全创建，这一部分可能需要5分钟以上。</p><p id="dc1c" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">在等待资源提供的时候，很可能你已经收到了Okta邀请用户的邮件，我们去接受邀请吧。</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div class="er es lz"><img src="../Images/04af0233147f58bd614e61bf9a93342e.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/format:webp/1*JzJdXDuyNo2UdY1q7kWurA.png"/></div></figure><p id="e21c" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">此链接将重定向到为您的用户设置新密码，并将您重定向到最终用户Okta网站，您将在那里看到客户端VPN应用程序。</p><p id="26e5" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">现在，转到AWS控制台&gt; VPC &gt;客户端VPN端点，在我们新创建的摘要中，您将看到<em class="lx">“自助服务门户URL”</em>，复制该URL并导航到它。在那里你可以下载VPN的配置文件和客户端VPN客户端的安装程序，一旦安装完毕，我们必须对其进行配置。</p><ol class=""><li id="3506" class="kv kw hh jp b jq kl ju km jy lk kc ll kg lm kk ma lb lc ld bi translated">打开以前安装的客户端VPN应用程序，进入“文件”并点击“管理配置文件”。</li></ol><figure class="kr ks kt ku fd ii er es paragraph-image"><div class="er es mb"><img src="../Images/b42e515a278de0da4fb18ab6e20be739.png" data-original-src="https://miro.medium.com/v2/resize:fit:718/0*4r4rdSf8AlJMrveY"/></div></figure><p id="7ebf" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated"><strong class="jp hi"> 2 </strong>。单击“添加配置文件”,并在显示名称中键入您想要标识VPN的名称。在“VPN配置文件”中浏览。下载ovpn文件，点击“添加配置文件”，然后点击“完成”。</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div class="er es mc"><img src="../Images/cbf61c3b88dbd6103789b633ae28198e.png" data-original-src="https://miro.medium.com/v2/resize:fit:956/format:webp/1*SyAqWLXJ3xAP1hnoSeazow.png"/></div></figure><p id="8b14" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated"><strong class="jp hi"> 3 </strong>。点击“连接”，这将打开并重定向到您的Okta帐户，如果您已登录，您将看到以下消息，如果没有，它将要求您登录。</p><p id="1fad" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">这就对了。您应该能够通过自己的VPN私下访问您的AWS资源！让我们快速测试一下，在您的VPC中配置一个EC2实例，对于SG入站规则，打开来自源172.31.0.0/16的ICMP流量，准备好后尝试ping实例私有IPv4地址。</p><h1 id="7805" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">结论</h1><p id="a49b" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">在这篇博文中，我们探讨了保护VPN访问的解决方案，通过使用AWS和Okta实现联合身份验证，所有这些都通过Terraform模板进行管理，几乎不接触两个控制台，使用最佳实践，不硬编码任何机密或值，这还可以通过为Okta用户启用MFA来实现更高的安全性。您可以通过多种方式将其集成到您环境的管道中，例如，每次测试代码时都会触发Jenkins管道，然后将新的身份认证组或路由推送到生产环境，或者在复杂的网络中，使用Transit Gateway，您可以将可达性扩展到任何组织中的更多VPC。</p><p id="8430" class="pw-post-body-paragraph jn jo hh jp b jq kl js jt ju km jw jx jy kn ka kb kc ko ke kf kg kp ki kj kk ha bi translated">别忘了！在开始时提到，AWS客户端VPN不是免费的，如果您想避免被收费，只需运行<em class="lx">“terra form destroy”</em>即可回滚之前部署的所有资源。</p><h1 id="c3c0" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated"><strong class="ak">参考文献</strong></h1><div class="md me ez fb mf mg"><a href="https://docs.aws.amazon.com/vpn/latest/clientvpn-admin/client-authentication.html#federated-authentication" rel="noopener  ugc nofollow" target="_blank"><div class="mh ab dw"><div class="mi ab mj cl cj mk"><h2 class="bd hi fi z dy ml ea eb mm ed ef hg bi translated">证明</h2><div class="mn l"><h3 class="bd b fi z dy ml ea eb mm ed ef dx translated">身份验证在AWS云的第一个入口点实施。它用于确定客户端是否…</h3></div><div class="mo l"><p class="bd b fp z dy ml ea eb mm ed ef dx translated">docs.aws.amazon.co</p></div></div></div></a></div><div class="md me ez fb mf mg"><a href="https://www.okta.com/integrations/aws-clientvpn/#overview" rel="noopener  ugc nofollow" target="_blank"><div class="mh ab dw"><div class="mi ab mj cl cj mk"><h2 class="bd hi fi z dy ml ea eb mm ed ef hg bi translated">AWS客户端VPN</h2><div class="mn l"><h3 class="bd b fi z dy ml ea eb mm ed ef dx translated">Amazon Web Services (AWS)客户端VPN是一种完全托管、按需付费的VPN服务，可以灵活地扩展或缩减…</h3></div><div class="mo l"><p class="bd b fp z dy ml ea eb mm ed ef dx translated">www.okta.com</p></div></div><div class="mp l"><div class="mq l mr ms mt mp mu in mg"/></div></div></a></div><div class="md me ez fb mf mg"><a href="https://www.globant.com/stay-relevant/partnerships/aws" rel="noopener  ugc nofollow" target="_blank"><div class="mh ab dw"><div class="mi ab mj cl cj mk"><h2 class="bd hi fi z dy ml ea eb mm ed ef hg bi translated">亚马逊网络服务和AWS数据| Globant</h2><div class="mn l"><h3 class="bd b fi z dy ml ea eb mm ed ef dx translated">从帮助组织使用数据产生新的商业价值和竞争优势，到构建和部署…</h3></div><div class="mo l"><p class="bd b fp z dy ml ea eb mm ed ef dx translated">www.globant.com</p></div></div><div class="mp l"><div class="mv l mr ms mt mp mu in mg"/></div></div></a></div></div></div>    
</body>
</html>