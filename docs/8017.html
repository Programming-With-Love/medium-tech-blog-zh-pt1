<html>
<head>
<title>Design ML Model &amp; Code Deployment System</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">设计ML模型和代码部署系统</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/design-ml-model-code-deployment-system-e1f2f8404786?source=collection_archive---------0-----------------------#2021-06-03">https://medium.com/walmartglobaltech/design-ml-model-code-deployment-system-e1f2f8404786?source=collection_archive---------0-----------------------#2021-06-03</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="accf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这篇文章中，我们将讨论多区域数据中心的ML模型和代码部署系统的设计，包括归档、灾难恢复、低延迟和多实例部署。我们将该产品创建为一键式部署系统，以在沃尔玛搜索中加快ML模型和代码的生产部署。</p><blockquote class="jc jd je"><p id="6e6b" class="ie if jf ig b ih ii ij ik il im in io jg iq ir is jh iu iv iw ji iy iz ja jb ha bi translated"><strong class="ig hi">功能需求:</strong> <br/>用户应该能够从用户界面部署代码和ML模型。</p><p id="174e" class="ie if jf ig b ih ii ij ik il im in io jg iq ir is jh iu iv iw ji iy iz ja jb ha bi translated">不同的模型可以部署到单个环境中的多个实例。比方说，对于环境开发，在每个实例中可以有不同的模型。</p><p id="5820" class="ie if jf ig b ih ii ij ik il im in io jg iq ir is jh iu iv iw ji iy iz ja jb ha bi translated">模型存储应在blob存储中存档。</p><p id="75a7" class="ie if jf ig b ih ii ij ik il im in io jg iq ir is jh iu iv iw ji iy iz ja jb ha bi translated">如果任何分布式blob存储关闭，应该启用灾难发现。</p><p id="f4df" class="ie if jf ig b ih ii ij ik il im in io jg iq ir is jh iu iv iw ji iy iz ja jb ha bi translated"><strong class="ig hi">非功能需求:</strong></p><p id="0232" class="ie if jf ig b ih ii ij ik il im in io jg iq ir is jh iu iv iw ji iy iz ja jb ha bi translated">模型和包到分布式blob存储区的上载和下载延迟应该非常低。应该在大约1分钟内。</p><p id="8c14" class="ie if jf ig b ih ii ij ik il im in io jg iq ir is jh iu iv iw ji iy iz ja jb ha bi translated">每日部署数量将为100。</p><p id="1634" class="ie if jf ig b ih ii ij ik il im in io jg iq ir is jh iu iv iw ji iy iz ja jb ha bi translated">部署服务应该高度可用。</p></blockquote><figure class="jk jl jm jn fd jo er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es jj"><img src="../Images/e63a9ef60f8752aebf74bd71769a6601.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*x7xzao-Y_x0rea5sprrntw.png"/></div></div></figure><h2 id="6e16" class="jv jw hh bd jx jy jz ka kb kc kd ke kf ip kg kh ki it kj kk kl ix km kn ko kp bi translated">用户流量:</h2><p id="38cf" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">如下图所示，开发人员可以选择他/她喜欢在开发/阶段/生产环境中部署的端点/实例。这又会将模型和包推送到blob存储(blob存储)。</p><h2 id="840c" class="jv jw hh bd jx jy jz ka kb kc kd ke kf ip kg kh ki it kj kk kl ix km kn ko kp bi translated"><strong class="ak">容量估计:</strong></h2><p id="d46f" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">通常情况下，机器学习模型二进制文件非常大。</p><p id="0a93" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">ML模型和包文件大小:<strong class="ig hi"> 4 GB </strong></p><p id="d6d3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">搜索服务每天处理的部署数量:<strong class="ig hi"> 100 </strong></p><p id="b8fc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">环境数量(开发、阶段和生产):<strong class="ig hi"> 3 </strong></p><p id="01d0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一个月的Blob存储空间:<strong class="ig hi"> 4 GB * 100 * 30 * 3=~ 36 TB </strong></p><p id="663b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">西、南、东三个数据中心的存储(灾难恢复)=~ <strong class="ig hi"> 36 TB * 3 = 108 TB </strong></p><p id="b1ca" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一年的存储=<strong class="ig hi">108 TB * 12 = 1296 TB = ~ 1.2 PB</strong>(我们将在归档过程中再次讨论这一点)</p><h2 id="baf3" class="jv jw hh bd jx jy jz ka kb kc kd ke kf ip kg kh ki it kj kk kl ix km kn ko kp bi translated"><strong class="ak">高层次设计:</strong></h2><figure class="jk jl jm jn fd jo er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es kv"><img src="../Images/133460affcf9e5a38d8505d621f363da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lDDua4k82L79bYLN_A03Gw.png"/></div></div><figcaption class="kw kx et er es ky kz bd b be z dx">High Level Design — 10000 feet overview</figcaption></figure><h2 id="73ca" class="jv jw hh bd jx jy jz ka kb kc kd ke kf ip kg kh ki it kj kk kl ix km kn ko kp bi translated">API设计:</h2><p id="514a" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">部署API:POST/deploy/:model name/:model version？数据中心= DC-all &amp;端点=variant-2</p><p id="274a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">取消部署API: POST <strong class="ig hi"> / </strong>取消部署/:modelName/:modelVersion？数据中心=dc-all &amp;端点=变量-2</p><h2 id="0663" class="jv jw hh bd jx jy jz ka kb kc kd ke kf ip kg kh ki it kj kk kl ix km kn ko kp bi translated"><strong class="ak">数据库设计:</strong></h2><figure class="jk jl jm jn fd jo er es paragraph-image"><div class="er es la"><img src="../Images/e84b7e66708333a3957d4d9221b3e9ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*pRzKth1zangqQgRVlELZRA.png"/></div></figure><p id="1d17" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们使用CloudSql来存储部署的元数据。在部署/取消部署API调用时，我们将创建一个条目来存储部署。这将帮助我们跟踪部署的历史、状态、失败、工作流失败和用户详细信息。</p><p id="6aa7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们将blob存储用于ML模型和包存储。为了使其高度可用并避免单点故障，我们在三个区域(南部、西部和东部blob store)建立了blob store副本。</p><h2 id="b16d" class="jv jw hh bd jx jy jz ka kb kc kd ke kf ip kg kh ki it kj kk kl ix km kn ko kp bi translated"><strong class="ak">算法设计:</strong></h2><figure class="jk jl jm jn fd jo er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es lb"><img src="../Images/9be2af974b0ae8087a01000bbc952f10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ujpvp7Uh6Pxt_9dNOAjm0A.jpeg"/></div></div></figure><p id="6339" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">部署API流程:</strong></p><p id="7f9c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当用户在带有环境和实例的客户端UI中单击Deploy时，我们将使用我们的Deploy API来异步触发工作流(airflow DAG ),这将模型和包推到所有三个区域的blob存储中。如果模型和包未能存储在任何区域blob存储区中，则部署将停止/失败。我们将把该部署的元数据存储到blob存储中的application.properties中。在这种情况下，该文件将在所有三个区域的blob存储的以下路径中具有该部署的模型名称和版本。在部署工作流成功完成后，我们会将元数据数据库中的部署状态更新为<strong class="ig hi">实时/已部署</strong></p><p id="51cb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">目录路径:</strong>容器/数据/模型_名称/环境/应用程序.属性</p><p id="3e12" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">示例:<a class="ae lc" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank">s</a>earch/<a class="ae lc" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank">data</a>/re ranking _ model/<a class="ae lc" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank">dev</a>/application . properties</p><p id="7cb2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在运行时，在每日重启或手动部署时，我们将从上述路径中读取application.properties，并从特定于区域的blob存储中下载模型和包，并在系统启动时加载它。这将减少系统启动期间的下载延迟，因为我们连接到区域特定的blob存储。</p><p id="1d56" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">取消部署API流程:</strong></p><p id="7099" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当用户在带有环境和实例的客户端UI中单击取消部署时，我们将使用我们的取消部署API来异步触发工作流(airflow DAG ),这将从所有三个区域的blob存储中删除模型和包。在取消部署工作流成功完成后，我们会将元数据数据库中的部署状态更新为<strong class="ig hi">取消部署</strong>。同样，application.properties文件也将使用空数据记录进行更新，它将等待下一次部署。</p><h2 id="7ee4" class="jv jw hh bd jx jy jz ka kb kc kd ke kf ip kg kh ki it kj kk kl ix km kn ko kp bi translated">工作流程设计:</h2><p id="4fea" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">我们将遵循下面的目录结构来存储模型并打包到所有三个区域的blob存储中。</p><p id="6d7f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">目录路径:</strong>容器/数据/模型名称/环境/端点/版本</p><p id="bebc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">例:<a class="ae lc" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank">s</a>earch/<a class="ae lc" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank">data</a>/re ranking _ model/<a class="ae lc" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank">dev</a>/<strong class="ig hi">variant-1</strong>/1 . 0 . 32</p><h2 id="4b75" class="jv jw hh bd jx jy jz ka kb kc kd ke kf ip kg kh ki it kj kk kl ix km kn ko kp bi translated">每个环境的多实例部署</h2><p id="9ac9" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">在客户端UI中，用户从env (dev、stage、prod)中为要部署的特定模型和包选择数据中心(blob-store-all)和端点(variant-1、variant-2)。</p><p id="43ee" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在微服务运行时，我们将为每个实例配置环境变量。在下面的例子中，我们将有一个名为<strong class="ig hi"> endpoint </strong>的环境变量，它的值将被用来跟踪相应区域的blob存储中的目录路径。</p><pre class="jk jl jm jn fd ld le lf lg aw lh bi"><span id="c8a2" class="jv jw hh le b fi li lj l lk ll">- name: dev-variant-01<br/>  flows: [master]<br/>  target:<br/>    - cluster_id: [north-dev-a3]<br/>  helm:<br/>    values:<br/>      scaling:<br/>        enabled: true<br/>      env:<br/>        endpoint: variant-1</span><span id="d6c9" class="jv jw hh le b fi lm lj l lk ll">deploy_env: dev</span></pre><h2 id="dee1" class="jv jw hh bd jx jy jz ka kb kc kd ke kf ip kg kh ki it kj kk kl ix km kn ko kp bi translated"><strong class="ak">存档流程</strong></h2><p id="f8f3" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">在任何给定的时间点，解决方案被设计为在blob存储中仅存储两个版本。因此，存档过程通过取消部署工作流来处理。在这种情况下，UI中的每个部署都会自动触发取消部署API调用，以删除/归档该环境中的最后一个旧部署。这将帮助我们清理大量空间，因为我们之前的<strong class="ig hi"> 1.2 PB </strong>在所有副本中已经减少到<strong class="ig hi"> 72 GB </strong>。</p><p id="36fe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">两个版本:4GB + 4GB = 8GB</p><p id="e044" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">三种环境:3 * 8GB = 24 GB</p><p id="ca79" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有三个数据中心/副本:24 * 3 = <strong class="ig hi"> 72GB </strong></p><h2 id="5168" class="jv jw hh bd jx jy jz ka kb kc kd ke kf ip kg kh ki it kj kk kl ix km kn ko kp bi translated">灾难恢复</h2><p id="3ac3" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">自动化流程:创建按需DAG以实现此工作流。二进制文件和包jar的副本保存在GCP Blob存储中。我们有下载GCP和Blob存储容器中的所有目录的功能。当整个blob存储损坏时，我们将使用GCP blob存储，并将其复制到所有区域特定的blob存储中。</p><h2 id="b731" class="jv jw hh bd jx jy jz ka kb kc kd ke kf ip kg kh ki it kj kk kl ix km kn ko kp bi translated"><strong class="ak">延迟指标</strong></h2><p id="63ed" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated"><strong class="ig hi">将4GB的模型和包</strong>以更短的延迟上传到所有三个区域的blob存储区是相当具有挑战性的。我们使用blob存储Python、Java SDKs和异步处理，从45分钟的上传延迟开始。但是后来当我们使用blob store cli进行优化时，延迟降低到了<strong class="ig hi"> 1分40秒</strong>。</p><figure class="jk jl jm jn fd jo er es paragraph-image"><div class="er es ln"><img src="../Images/cb133b82dcf62c3aba7d5a6dcedc2b03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1054/format:webp/1*kNo468HcDynkWQLYE4fWyw.png"/></div></figure><p id="89fa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">类似地，<strong class="ig hi">下载延迟</strong>在服务启动期间使用blob Storage Python SDK花费了<strong class="ig hi"> 1分钟</strong>。</p><h2 id="6588" class="jv jw hh bd jx jy jz ka kb kc kd ke kf ip kg kh ki it kj kk kl ix km kn ko kp bi translated"><strong class="ak">总结</strong></h2><p id="ab3d" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">这篇博客涵盖了实现代码部署系统的各种设计观点和挑战。我们还了解了如何为创建任何新产品维护高可用性和灾难恢复。如果你有任何后续想法，请在评论中留下。</p></div></div>    
</body>
</html>