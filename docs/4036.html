<html>
<head>
<title>Apache Beam GCP Pipeline Message Conversion Framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Beam GCP管道消息转换框架</h1>
<blockquote>原文：<a href="https://medium.com/globant/apache-beam-gcp-pipeline-message-conversion-framework-396e217fe461?source=collection_archive---------1-----------------------#2022-11-25">https://medium.com/globant/apache-beam-gcp-pipeline-message-conversion-framework-396e217fe461?source=collection_archive---------1-----------------------#2022-11-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/4a178fbaceb28503a82799de0cc837a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4PfzySU60F20Wg97fMo_nw.jpeg"/></div></div></figure><p id="9503" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><a class="ae jn" href="https://en.wikipedia.org/wiki/Big_data" rel="noopener ugc nofollow" target="_blank"> BigData </a>正在三个方面扩展:数据量、速度和多样性。它支持通过<a class="ae jn" href="https://www.geeksforgeeks.org/difference-between-batch-processing-and-stream-processing/" rel="noopener ugc nofollow" target="_blank">批处理和</a>流处理数据。一个<a class="ae jn" href="https://beam.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Beam </a>是一个用于批处理和流用例的开源高级统一编程模型。使用Apache Beam，可以使用SDK(<a class="ae jn" href="https://www.java.com/" rel="noopener ugc nofollow" target="_blank">Java</a>、<a class="ae jn" href="https://www.python.org/" rel="noopener ugc nofollow" target="_blank"> Python </a>、<a class="ae jn" href="https://go.dev/" rel="noopener ugc nofollow" target="_blank"> Go </a>和<a class="ae jn" href="https://www.scala-lang.org/" rel="noopener ugc nofollow" target="_blank"> Scala </a>)创建大数据处理管道。</p><p id="cb97" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Apache Beam消息框架是一个消息转换、消息处理和消息构建框架。本文的读者应该对Apache Beam管道和管道术语有所了解。这个故事对在<a class="ae jn" href="https://en.wikipedia.org/wiki/Data_science" rel="noopener ugc nofollow" target="_blank">数据科学</a>和大数据处理领域工作的读者很有帮助。</p><p id="753a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">本文旨在提供一个关于<a class="ae jn" href="https://www.techtarget.com/whatis/definition/framework" rel="noopener ugc nofollow" target="_blank">框架</a>的想法，该框架提供了对消息进行<a class="ae jn" href="https://cloud.google.com/pubsub/docs/overview" rel="noopener ugc nofollow" target="_blank"> Pubsub </a>转换、序列化、反序列化和错误处理所需的样板代码。</p><h1 id="55ae" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">相关使用案例</strong></h1><p id="cdff" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">我们将关注以下使用案例:</p><ul class=""><li id="bea3" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">序列化和反序列化一条<a class="ae jn" href="https://cloud.google.com/pubsub/docs/reference/rest/v1/PubsubMessage" rel="noopener ugc nofollow" target="_blank">发布子消息</a>。</li><li id="785f" class="kr ks hh ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">构建发布消息所需的消息属性。</li><li id="342b" class="kr ks hh ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">从入站(传入)发布消息构建错误消息。</li><li id="a604" class="kr ks hh ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">根据错误消息构建消息属性。</li><li id="976b" class="kr ks hh ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">创建一个PubsubMessage，用于发布(传出)到一个<a class="ae jn" href="https://cloud.google.com/" rel="noopener ugc nofollow" target="_blank"> GCP </a>(谷歌云平台)主题。</li><li id="78ca" class="kr ks hh ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">用所需的属性验证发布消息。</li><li id="0e53" class="kr ks hh ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">消息的异常处理程序。</li></ul><h1 id="cd77" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">框架的关键组成部分</strong></h1><p id="dd9e" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">以下部分显示了消息转换的重要类、字段和方法。</p><ul class=""><li id="7ed1" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated"><code class="du lf lg lh li b"><strong class="ir hi">ObjectMapper</strong></code> <strong class="ir hi"> </strong>字段及其使用<a class="ae jn" href="https://en.wikipedia.org/wiki/Jackson_(API)" rel="noopener ugc nofollow" target="_blank"> Jackson JSON库</a>进行<strong class="ir hi">序列化</strong>和<strong class="ir hi">反序列化</strong>的配置。</li></ul><pre class="lj lk ll lm fd ln li lo bn lp lq bi"><span id="41ef" class="lr jp hh li b be ls lt l lu lv">public static final ObjectMapper OBJECT_MAPPER;<br/>static {<br/>  OBJECT_MAPPER = new ObjectMapper();<br/>  objectMapperDefaultConfiguration(OBJECT_MAPPER);<br/>  OBJECT_MAPPER<br/>    .setSerializationInclusion(JsonInclude.Include.NON_NUL);<br/>  OBJECT_MAPPER<br/>    .setSerializationInclusion(JsonInclude.Include.NON_EMPTY);<br/>}<br/><br/>public static void objectMapperDefaultConfiguration(<br/>  ObjectMapper objectMapper) {<br/>  objectMapper.configure(<br/>    DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);<br/>  objectMapper.enable(SerializationFeature.INDENT_OUTPUT);<br/>  objectMapper.configure(<br/>    SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, false);<br/>  objectMapper.registerModule(new JavaTimeModule());<br/>}</span></pre><ul class=""><li id="a31e" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">用简单的方法创建<code class="du lf lg lh li b"><strong class="ir hi">PubsubMessage</strong></code> <strong class="ir hi"> </strong>。</li></ul><pre class="lj lk ll lm fd ln li lo bn lp lq bi"><span id="1707" class="lr jp hh li b be ls lt l lu lv">public static PubsubMessage createPubSubMessage(byte[] payload,<br/>  Map &lt; String, String &gt; attributes) {<br/>  PubsubMessage pubsubMessage;<br/>  if (Objects.nonNull(payload) &amp;&amp; Objects.nonNull(attributes)) {<br/>    pubsubMessage = new PubsubMessage(payload, attributes);<br/>  } else if (Objects.nonNull(payload) &amp;&amp;<br/>    Objects.isNull(attributes)) {<br/>    pubsubMessage = new PubsubMessage(payload, new HashMap &lt; &gt; ());<br/>  } else if (Objects.isNull(payload) &amp;&amp;<br/>    Objects.nonNull(attributes)) {<br/>    pubsubMessage = new PubsubMessage(<br/>      ERROR_EMPTY_PUBSUB_MESSAGE.getBytes(), attributes);<br/>  } else {<br/>    pubsubMessage = new PubsubMessage(<br/>      ERROR_EMPTY_PUBSUB_MESSAGE.getBytes(), new HashMap &lt; &gt; ());<br/>  }<br/>  return pubsubMessage;<br/>}</span></pre><ul class=""><li id="ab56" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">纤薄的<code class="du lf lg lh li b">PubsubMessage</code>以一种简单的方式。</li></ul><pre class="lj lk ll lm fd ln li lo bn lp lq bi"><span id="0e44" class="lr jp hh li b be ls lt l lu lv">public static String readablePubSubMessage(<br/>  PubsubMessage pubSubMessage) {<br/>  if (Objects.isNull(pubSubMessage) ||<br/>    Objects.isNull(pubSubMessage.getPayload())) {<br/>    return ERROR_EMPTY_PUBSUB_MESSAGE;<br/>  } else {<br/>    return new String(pubSubMessage.getPayload(),<br/>      StandardCharsets.UTF_8);<br/>  }<br/>}</span></pre><ul class=""><li id="2a7b" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">以简单的方式读取<code class="du lf lg lh li b">PubsubMessage</code>有效载荷。</li></ul><pre class="lj lk ll lm fd ln li lo bn lp lq bi"><span id="f4fd" class="lr jp hh li b be ls lt l lu lv">public static StringBuilder pubSubMessagePayload(<br/>  PubsubMessage pubSubMessage) {<br/>  StringBuilder sb = new StringBuilder(500);<br/>  if (Objects.nonNull(pubSubMessage) &amp;&amp;<br/>    Objects.nonNull(pubSubMessage.getPayload())) {<br/>    sb.append(new String(pubSubMessage.getPayload(),<br/>      StandardCharsets.UTF_8));<br/>  }<br/>  return sb;<br/>}</span></pre><ul class=""><li id="f627" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">使用<a class="ae jn" href="https://en.wikipedia.org/wiki/Builder_pattern" rel="noopener ugc nofollow" target="_blank">构建器模式</a>构建<code class="du lf lg lh li b">ErrorMessage</code>(消息)的<code class="du lf lg lh li b">ErrorMessageBuilder</code>类。</li></ul><pre class="lj lk ll lm fd ln li lo bn lp lq bi"><span id="b78a" class="lr jp hh li b be ls lt l lu lv">public class ErrorMessage implements Serializable {<br/>  private String details;<br/>  private String cause;<br/>  private String step;<br/>  private String system;<br/>  private String messageSource;<br/>  private String messageVersion;<br/>  private String messageType;<br/>  private String messageFormat;<br/>  private List &lt; RequiredField &gt; fieldErrors;<br/>  public ErrorMessage(ErrorMessageBuilder builder) {<br/>    this.details = builder.details;<br/>    this.cause = builder.cause;<br/>    this.step = builder.step;<br/>    this.system = builder.system;<br/>    this.messageSource = builder.messageSource;<br/>    this.messageVersion = builder.messageVersion;<br/>    this.messageType = builder.messageType;<br/>    this.messageFormat = builder.messageFormat;<br/>    this.fieldErrors = builder.fieldErrors;<br/>  }<br/>  public static class ErrorMessageBuilder {<br/>    private String details;<br/>    private String cause;<br/>    private String step;<br/>    private String system;<br/>    private String messageSource;<br/>    private String messageVersion;<br/>    private String messageType;<br/>    private String messageFormat;<br/>    private List &lt; RequiredField &gt; fieldErrors;<br/>  }<br/>  public ErrorMessageBuilder withDetails(String details) {<br/>    this.details = details;<br/>    return this;<br/>  }<br/>  public ErrorMessageBuilder withCause(String cause) {<br/>    this.cause = cause;<br/>    return this;<br/>  }<br/>  public ErrorMessageBuilder withStep(String step) {<br/>    this.step = step;<br/>    return this;<br/>  }<br/>  public ErrorMessageBuilder withSystem(String system) {<br/>    this.system = system;<br/>    return this;<br/>  }<br/>  public ErrorMessageBuilder withMessageSource(String messageSource) {<br/>    this.messageSource = messageSource;<br/>    return this;<br/>  }<br/>  public ErrorMessageBuilder withMessageVersion(String messageVersion) {<br/>    this.messageVersion = messageVersion;<br/>    return this;<br/>  }<br/>  public ErrorMessageBuilder withMessageType(String messageType) {<br/>    this.messageType = messageType;<br/>    return this;<br/>  }<br/>  public ErrorMessageBuilder withMessageFormat(String messageFormat) {<br/>    this.messageFormat = messageFormat;<br/>    return this;<br/>  }<br/>  public ErrorMessageBuilder withFieldErrors(List &lt; FieldError &gt;<br/>    fieldErrors) {<br/>    this.fieldErrors = fieldErrors;<br/>    return this;<br/>  }<br/>  public ErrorMessage build() {<br/>    return new ErrorMessage(this);<br/>  }<br/>}<br/>}</span></pre><ul class=""><li id="fcfe" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">消息属性验证器方法。</li></ul><pre class="lj lk ll lm fd ln li lo bn lp lq bi"><span id="4cf1" class="lr jp hh li b be ls lt l lu lv">public static boolean validateMessageAttributes(Map &lt; String, String &gt;<br/>  attributes)</span></pre><ul class=""><li id="cef4" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated"><code class="du lf lg lh li b">PubsubMessage</code>错误处理器。</li></ul><pre class="lj lk ll lm fd ln li lo bn lp lq bi"><span id="c006" class="lr jp hh li b be ls lt l lu lv">public static PubsubMessage pubSubErrorHandler(<br/>  String payload, Map &lt; String, String &gt; attributes, Exception e)</span></pre><ul class=""><li id="6050" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">使用<code class="du lf lg lh li b">PubsubMessage</code>有效负载和其他属性创建一个<code class="du lf lg lh li b">ErrorMessage</code>。</li></ul><pre class="lj lk ll lm fd ln li lo bn lp lq bi"><span id="300c" class="lr jp hh li b be ls lt l lu lv">public static Message createErrorMessage(<br/>  String payload, String cause, String type, String version, String<br/>  ...args)</span></pre><ul class=""><li id="59e2" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated"><code class="du lf lg lh li b">PubsubMessage</code>异常处理程序。</li></ul><pre class="lj lk ll lm fd ln li lo bn lp lq bi"><span id="53ab" class="lr jp hh li b be ls lt l lu lv">public static Message &lt; ? &gt; pubSubExceptionHandler(<br/>  PubsubMessage pubSubMessage, String cause, String type,<br/>  Exception e)</span></pre><ul class=""><li id="6001" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">定义类型为<code class="du lf lg lh li b">String</code>的不同通用消息，可以使用<code class="du lf lg lh li b"><a class="ae jn" href="https://docs.oracle.com/javase/7/docs/api/java/text/MessageFormat.html" rel="noopener ugc nofollow" target="_blank">MessageFormat</a>.format()</code>进行替换。</li></ul><p id="ebfd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">方法<code class="du lf lg lh li b">validateMessageAttributes()</code>、<code class="du lf lg lh li b">pubSubErrorHandler()</code>、<code class="du lf lg lh li b">createErrorMessage()</code>和<code class="du lf lg lh li b">pubSubExceptionHandler()</code>的实现细节有意留给开发者决定。他们可以扩展功能定义来满足自己的需求。</p><h1 id="7010" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">结论</h1><p id="2b1f" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">作为读者，我希望通过这篇文章，您可能已经了解了如何使用Apache Beam开发一个有助于消息处理和转换的框架。</p><p id="1b86" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">感谢您的阅读！</p></div></div>    
</body>
</html>