<html>
<head>
<title>Strangling away a database-client from a project</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从项目中扼杀数据库客户端</h1>
<blockquote>原文：<a href="https://blog.kotlin-academy.com/strangling-away-a-database-client-from-a-project-4b6f8b2d8b08?source=collection_archive---------1-----------------------#2020-02-02">https://blog.kotlin-academy.com/strangling-away-a-database-client-from-a-project-4b6f8b2d8b08?source=collection_archive---------1-----------------------#2020-02-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="1af1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在我们基于Vert-X的Kotlin项目中，我们的团队使用<strong class="jm io"> Jetbrains/Exposed </strong>进行所有数据库交互。随着时间的推移，我们希望从ORM中迁移出来，转而使用<strong class="jm io">vietj/reactive-postgres-client</strong>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d5355779c0dee64626a5e08a4a30525c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FqJJZ8jTtQSUgqezTavIzA.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">These vines would one day completely cover the wall, but it does so slowly, and step by step.</figcaption></figure><p id="29f6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们项目中所有与数据库相关的代码都封装在存储库类中。因此，我们只需要用使用reactive-pg-client驱动程序的新版本的存储库类替换它们，将更改推向生产，并以一品脱结束一天的工作。</p><p id="c2b0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">很简单。我要补充的是，这是分层架构和<a class="ae ky" href="https://en.wikipedia.org/wiki/Single-responsibility_principle" rel="noopener ugc nofollow" target="_blank"> SRP </a>的胜利。</p><p id="44b6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然而，我认为这样一个简单的转换可能会带来一些问题:</p><ol class=""><li id="417d" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">将<strong class="jm io">中的所有代码切换到</strong>将意味着代码到主分支的延迟集成。如果有人和你在相同的代码区域工作，这也可能导致合并冲突和可能的返工。</li><li id="6649" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">如果新的reactive-pg-client库在生产中没有按预期工作，您必须有一种方法通过切换特性来立即恢复到旧的实现。</li></ol><p id="b53a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">第1点与<a class="ae ky" href="https://martinfowler.com/articles/continuousIntegration.html" rel="noopener ugc nofollow" target="_blank"> <em class="ln">持续集成</em> </a> (CI)的工程文化有关，第2点与拥有低<a class="ae ky" href="https://en.wikipedia.org/wiki/Mean_time_to_recovery" rel="noopener ugc nofollow" target="_blank"> <em class="ln">平均恢复时间</em> </a> <em class="ln">有关。</em>这两点在我极力推荐的一本书中都有广泛的论述，<a class="ae ky" href="https://www.amazon.co.uk/Accelerate-Software-Performing-Technology-Organizations-ebook/dp/B07B9F83WM" rel="noopener ugc nofollow" target="_blank"><em class="ln"/></a><em class="ln">。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/113e87eda1a09757ba508948f43ebf28.png" data-original-src="https://miro.medium.com/v2/resize:fit:928/format:webp/1*q9nZRpmtHaRJgIrq0etHoQ.png"/></div></figure><h2 id="2c7c" class="lp lq in bd lr ls lt dn lu lv lw dp lx jv ly lz ma jz mb mc md kd me mf mg mh bi translated"><strong class="ak">科特林代表</strong></h2><p id="7f47" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">一种方法是<a class="ae ky" href="https://martinfowler.com/bliki/StranglerFigApplication.html" rel="noopener ugc nofollow" target="_blank">扼杀者无花果模式，</a>我们可以使用Kotlin代理来完成这项工作。要了解更多关于Kotlin代表的信息，请点击这里阅读。</p><p id="0148" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">简而言之，使用Kotlin委托，您可以定义一个接口的实现，其中我们可以将所有未被覆盖的<em class="ln">属性委托给另一个实现。</em></p><p id="695a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">回到我的团队的用例，这将意味着我们将有一个现有存储库接口的新实现，它使用reactive-postgres-client库，并将所有未被覆盖的方法/功能委托给现有的公开存储库。代码将如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="0b90" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在上面的例子中，因为<code class="fe mp mq mr ms b">saveGuest()</code>没有在<code class="fe mp mq mr ms b">ReactivePgClientBasedRepository</code>中实现，这个类将使用在<code class="fe mp mq mr ms b">DefaultRepository</code>类中定义的实现。是的，所有这些看起来确实非常像<a class="ae ky" href="https://sourcemaking.com/design_patterns/decorator" rel="noopener ugc nofollow" target="_blank"> <em class="ln">装饰者</em> </a> <em class="ln"> </em>设计模式。</p><h2 id="1c1a" class="lp lq in bd lr ls lt dn lu lv lw dp lx jv ly lz ma jz mb mc md kd me mf mg mh bi translated">在代码中使用新的存储库</h2><p id="377c" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">下一步是将新存储库的实例注入到需要它们的类中。如何做到这一点的确切方式取决于您的DI框架。然而，我们必须利用特性切换来选择必须注入哪个存储库实例——新版本还是旧版本。</p><p id="4d1b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是为了在生产中事情不像预期的那样工作的情况下，我们将能够快速切换回旧的实现，而不必进行代码更改。</p><p id="db8d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您正在使用Spring框架，并且如果特性标志是使用像环境变量这样简单的东西实现的，那么一种方法就是使用<code class="fe mp mq mr ms b">@ConditionalOnProperty</code>注释。这里有一个例子。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="a801" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe mp mq mr ms b">@ConditionalOnProperty</code>确保只有在定义了属性<code class="fe mp mq mr ms b">featuretoggles.useReactivePgClientRepository</code>的情况下才会加载<code class="fe mp mq mr ms b">ReactivePgClientBasedRepository</code> bean。<code class="fe mp mq mr ms b">@Primary</code>确保存储库优先于旧的<code class="fe mp mq mr ms b">ExposedBasedRepository</code></p><p id="33fd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，如果应用程序像这样启动，我们将使用新的存储库:</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="8c22" class="lp lq in ms b gy mx my l mz na">FEATURETOGGLES_USEPGREACTIVECLIENTREPOSITORY=true ./gradlew bootRun</span></pre><p id="0050" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果在未定义环境变量的情况下启动旧的基于公开的存储库:</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="d3d9" class="lp lq in ms b gy mx my l mz na">./gradlew bootRun</span></pre><h2 id="6df1" class="lp lq in bd lr ls lt dn lu lv lw dp lx jv ly lz ma jz mb mc md kd me mf mg mh bi translated">重用现有的数据库集成测试</h2><p id="9d47" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">我们还希望为新的存储库类重用现有的集成测试，而不是编写新的测试。</p><p id="cd35" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您正在使用JUnit5，您可以使用一个<a class="ae ky" href="https://www.baeldung.com/parameterized-tests-junit-5" rel="noopener ugc nofollow" target="_blank">参数化测试</a>将您的两个存储库实例传递到您的测试用例中，并让测试照常运行。</p><p id="e316" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">例如，您可能有这样的现有存储库测试</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="4bca" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">将它转换成参数化的测试，并对这两种类型的存储库运行断言</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="d0ae" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">由于JUnit5的<code class="fe mp mq mr ms b">@MethodSource</code>的工作方式，我们需要<code class="fe mp mq mr ms b">@JvmStatic</code>。</p><p id="4775" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这样，我们可以确保我们的新存储库与旧存储库完全一样。</p><h2 id="d841" class="lp lq in bd lr ls lt dn lu lv lw dp lx jv ly lz ma jz mb mc md kd me mf mg mh bi translated">更快、更频繁地将代码合并到master中</h2><p id="8daf" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">由于我们使用了Kotlin委托，我们可以在实现新存储库中的每个方法时将代码合并到master中，我们不必等到所有方法都实现了。这允许团队的其他成员更快地看到最新版本的代码，这意味着合并冲突的机会更少，而且拉请求也更小，更易于管理。</p><h2 id="836b" class="lp lq in bd lr ls lt dn lu lv lw dp lx jv ly lz ma jz mb mc md kd me mf mg mh bi translated"><strong class="ak">总结</strong></h2><p id="f70e" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">我希望这篇文章对你有用，如果你不得不这样做的话。</p><p id="ee9f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">始终重视:</p><ol class=""><li id="fe95" class="kz la in jm b jn jo jr js jv lb jz lc kd ld kh le lf lg lh bi translated">在您的母版中拥有生产就绪代码</li><li id="a4a1" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">经常整合以掌握</li><li id="b5b7" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">重复使用现有的测试，以及</li><li id="850d" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">利用这种语言(在这个例子中是Kotlin)尽可能快速简单地做一些事情。</li></ol><h2 id="64f4" class="lp lq in bd lr ls lt dn lu lv lw dp lx jv ly lz ma jz mb mc md kd me mf mg mh bi translated">链接:</h2><ol class=""><li id="faf9" class="kz la in jm b jn mi jr mj jv nb jz nc kd nd kh le lf lg lh bi translated">反应式Pg客户:【http://www.julienviet.com/reactive-pg-client/guide/java/ T2】</li><li id="9e26" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">扼杀者模式:<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/architecture/patterns/strangler" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/azure/architecture/patterns/stranger</a></li><li id="a6cd" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">科特林的代表模式:<a class="ae ky" href="https://kotlinlang.org/docs/reference/delegation.html" rel="noopener ugc nofollow" target="_blank">https://kotlinlang.org/docs/reference/delegation.html</a></li><li id="0348" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">SpringBoot中的简单特征-切换:<a class="ae ky" href="https://reflectoring.io/spring-boot-conditionals/" rel="noopener ugc nofollow" target="_blank">https://medium . com/@ abyu/feature-toggles-in-spring boot-kot Lin-app-56 E3 DBE F9 a 86</a></li><li id="10f0" class="kz la in jm b jn li jr lj jv lk jz ll kd lm kh le lf lg lh bi translated">如何使用参数化测试:<a class="ae ky" href="https://www.baeldung.com/parameterized-tests-junit-5" rel="noopener ugc nofollow" target="_blank">https://www.baeldung.com/parameterized-tests-junit-5</a></li></ol></div><div class="ab cl ne nf hr ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ig ih ii ij ik"><h1 id="02b6" class="nl lq in bd lr nm nn no lu np nq nr lx ns nt nu ma nv nw nx md ny nz oa mg ob bi translated">单击👏说“谢谢！”并帮助他人找到这篇文章。</h1><p id="e437" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">了解卡帕头最新的重大新闻。学院，<a class="ae ky" href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a" rel="noopener ugc nofollow" target="_blank">订阅时事通讯</a>，<a class="ae ky" href="https://twitter.com/ktdotacademy" rel="noopener ugc nofollow" target="_blank">观察Twitter </a>并在媒体上关注我们。</p><p id="fe6b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您需要Kotlin工作室，请查看我们如何帮助您:<a class="ae ky" href="https://www.kt.academy/" rel="noopener ugc nofollow" target="_blank"> kt.academy </a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a"><div class="gh gi oc"><img src="../Images/3146970f03e44cb07afe660b0d43e045.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*54OqlYA4etu7wfpmMP5TKQ.png"/></div></a></figure></div></div>    
</body>
</html>