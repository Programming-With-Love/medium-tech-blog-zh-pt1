<html>
<head>
<title>Building Pinterest’s A/B testing platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建Pinterest的A/B测试平台</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/building-pinterests-a-b-testing-platform-ab4934ace9f4?source=collection_archive---------0-----------------------#2016-04-08">https://medium.com/pinterest-engineering/building-pinterests-a-b-testing-platform-ab4934ace9f4?source=collection_archive---------0-----------------------#2016-04-08</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="1e8e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">硕翔| Pinterest工程师，数据</p><p id="de09" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作为一家数据驱动的公司，我们非常依赖实验来指导产品和功能。在任何给定的时间，我们都有大约1000个实验在运行，并且每天都在增加。因为我们在不断增加实验的数量并记录相应的数据，所以我们需要一个可靠的、简单易用的平台，工程师可以使用它而不会出错。为了消除实验人员的常见错误，我们引入了轻量级配置UI、QA工作流和简化的API，支持跨多个平台的A/B测试。(有关我们的仪表板和数据管道的更多信息，请查看我们之前的<a class="ae jc" href="https://engineering.pinterest.com/blog/scalable-ab-experiments-pinterest" rel="noopener ugc nofollow" target="_blank">实验帖子</a>。)</p><p id="eb2e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在构建实验平台时，我们优先考虑以下要求:</p><ol class=""><li id="ded8" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">实时配置更改:我们需要能够实时快速关闭或增加实验，而无需为每个配置更改部署代码，特别是在修复站点事件时。</li><li id="57f1" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">轻量级过程:设置实验不应该比普通的特性发布更复杂，还应该防止用户犯可预见的错误。</li><li id="ecdc" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">客户端不可知:用户不需要为每个平台学习新的实验方法。</li><li id="4d27" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">分析:为了做出更好的实验决策，我们构建了一个更易于使用的新分析仪表板。</li><li id="11ec" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">可伸缩性:我们需要整个系统在在线服务和离线实验数据处理方面都可以伸缩。</li></ol><h2 id="50a2" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">简化过程</h2><p id="f68a" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">Pinterest的实验遵循一个共同的模式:</p><ol class=""><li id="c17a" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">创建具有初始配置的实验，创建假设并记录测试该假设的方法。</li><li id="c23f" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">向Pinners展示实验，添加新组，禁用组，并通过过滤器修改受众。</li><li id="e64c" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">通过将代码发送给所有Pinners或回滚并记录结果来完成实验。</li></ol><p id="f217" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们之前的框架中，这些更改是通过代码处理的，但是我们希望在UI中构建这些更改以提供交互式反馈和验证，并在基于配置的框架中独立于代码发布来推动更改。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es kr"><img src="../Images/d45220d0b793f02f8d917d6bdb1a44e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FAUJkRfh7HYfN60Q.png"/></div></div></figure><p id="d414" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">常见的实验错误，如语法错误，不平衡的组分配，重叠的组或违反实验程序，都是交互式验证。我们还主动提供typeahead搜索建议，以减少人工输入的数量，如图2所示。现在做一个实验改变通常只需点击几下鼠标。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es ld"><img src="../Images/942b201783b1d39303dc2053c968780b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/0*gMnKpRgXpql-p6br.png"/></div></figure><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es le"><img src="../Images/e315345a63a1981432eec8c74d44e704.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/0*7rguszFUlbKob8ls.png"/></div></figure><p id="2177" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了使配置可以被任意客户端实时访问，我们利用我们的内部系统以序列化格式存储所有实验设置，并在几秒钟内将它们同步到我们实验系统的每个主机。典型的配置文件在反序列化后包含以下内容:</p><pre class="ks kt ku kv fd lf lg lh li aw lj bi"><span id="007b" class="jr js hh lg b fi lk ll l lm ln">{"holiday_special": <br/>    {<br/>          "group_ranges": {<br/>              "enabled": {"percent": 5.0, "ranges": [0, 49]}, <br/>              "hold_out": {"percent": 5.0, "ranges": [50, 99]}<br/>           }, <br/>          "key": "holiday_special", <br/>           “global filter”: user_country(‘US’),<br/>           “overwrite_filter”: {“enabled”: is_employee()},<br/>           "unauth_exp": 0, <br/>           "version": 1<br/>      }<br/>  }</span></pre><p id="e00f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">配置和代码分离的好处是实验设置的即时更新，这意味着像增加治疗组的流量这样的配置更改不需要部署代码。这将实验从生产部署时间表中解放出来，并大大加快了迭代的速度，尤其是在需要紧急更改的时候。</p><h2 id="6093" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">质量保证</h2><p id="eece" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">一个实验可能会影响数百万个Pinners，因此我们对实验操作和关键的质量保证工具有很高的标准。实验web应用程序还配备了一个审查工具，为每个实验更改创建一个审查流程。图3显示了修改组范围和过滤器的待定更改。审阅者通过用户界面指定，并将通过电子邮件通知。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es lo"><img src="../Images/7e226748fb2114ecc7f77f40fd04447e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/0*LueBfzQndxSMwzVT.png"/></div></figure><p id="c2b8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于大多数实验，我们有一个由平台开发人员、用户和数据科学家组成的跨团队助手小组。几乎每一项变更都需要由助手审核，助手会仔细检查计划、假设、关键结果、触发逻辑、过滤器设置、小组验证和文档。这样的过程在我们的web应用程序中强制执行，因此每次更改都需要填充一个助手。我们还有一个定期的实验助手培训计划，以确保每个团队至少有一个人获得认证。</p><p id="448a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">实验通常与将控制/处理组信息嵌入到决策逻辑中的代码更改相关联。我们要求实验用户通过Pull Requests按钮在实验平台中添加一个Pull Request (PR)链接，这样帮助者和分析师可以更容易地跟踪实验行为，并在需要时进行潜在的调试。此外，我们还将每个变更作为注释发送给Phabricator(我们的存储库管理工具)中相应的PR，如图4所示。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es lp"><img src="../Images/ca2f02bd0fbb7badeb22470fa518814a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*s2adMzjd2sXmi-Cg.png"/></div></figure><p id="1e3f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">用户可以在UI中创建正在进行的实验的测试副本(如图1所示)。然后，它们将被移植到图5所示的测试面板。在测试面板中所做的任何更改都不会影响生产中的实验，只有测试工程师可以看到，他们可以使用一键复制到生产按钮在生产中启用它。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es lq"><img src="../Images/9bce73b329aa624d6c13e84b640858f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/format:webp/0*HtjPwdVsz8U1LWKQ.png"/></div></figure><h2 id="e68d" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">应用程序接口</h2><p id="fc59" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">实验API是用户将调用的接口，用于将他们的应用程序代码链接到他们通过UI进行的实验设置。提供的两种关键方法是:</p><pre class="ks kt ku kv fd lf lg lh li aw lj bi"><span id="03ab" class="jr js hh lg b fi lk ll l lm ln">def get_group(self, experiment_name)<br/><br/>  def activate_experiment(self, experiment_name)</span></pre><p id="9ae7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">具体来说，<em class="lr"> get_group </em>方法返回调用者将被定向到的组的名称。在内部，通过基于实验信息计算散列值来计算组，并且该方法没有副作用。另一方面，调用<em class="lr"> activate_experiment </em>向日志记录系统发送消息，并对分析结果做出贡献。这两种方法足以涵盖大多数用例，通常以下列方式使用:</p><pre class="ks kt ku kv fd lf lg lh li aw lj bi"><span id="ba43" class="jr js hh lg b fi lk ll l lm ln"># Get the experiment group given experiment name and gatekeeper object, without actually triggering the experiment.<br/>group = gk.get_group("example_experiment_name")<br/> <br/># Activate/trigger experiment. It will return experiment group if any.<br/>group = gk.activate_experiment("example_experiment_name")<br/> <br/># Application code showing treatment based on group.<br/>if group in ['enabled', 'employees']:<br/>  # behavior for enabled group<br/>  pass<br/>else:<br/>  # behavior for control group<br/>  pass</span></pre><p id="cbd5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">上面代码中的gatekeeper对象<em class="lr"> gk </em>是实验所需的用户/会话/元信息的包装器。除了上面显示的Python库，我们还实现了一个单独的JVM (Scala和Java)库。还支持Javascript和移动应用程序(Android &amp; iOS)。</p><h2 id="06c4" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">设计和建筑</h2><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es ls"><img src="../Images/5dcd0d89ba1040b10826498106d7366e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/0*tKJd1kXZ38PY1yAw.png"/></div></figure><p id="fa84" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">实验平台在逻辑上被划分为三个组件:配置系统、一组API和分析管道。它们由以下单向数据流连接:</p><ol class=""><li id="ef6b" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">Configuration system将用户在web UI上所做的更改保存到我们的实验数据库中，该数据库的信息定期以分钟级的粒度以序列化格式发布给每个服务。</li><li id="66e6" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">实验客户机获取实验配置并调用API来确定实验逻辑，比如实验类型和组分配。</li><li id="1645" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">各种客户端生成的实验激活日志通过我们内部的<a class="ae jc" href="http://www.slideshare.net/DiscoverPinterest/singer-pinterests-logging-infrastructure" rel="noopener ugc nofollow" target="_blank">歌手服务</a>发送到Kafka，分析管道将根据用户定义的指标创建实验报告，并在仪表板上交付。</li></ol><h2 id="4587" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">摘要</h2><p id="d022" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">该系统于去年夏天推出，支持Pinterest内部的大多数实验。团队特定的功能，如实时指标仪表板、实验电子邮件通知、交互式文档和协作工具以及SEO API/UI也正在添加到系统中。如果你对实验框架和分析平台感兴趣，<a class="ae jc" href="https://careers.pinterest.com/careers/engineering/san-francisco" rel="noopener ugc nofollow" target="_blank">加入我们</a>！</p><p id="cdbb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">鸣谢:Pinterest的多个团队为实验框架的形成提供了深刻的反馈和建议。主要贡献者包括硕翔、Bryant Xiao、Justin Mejorada Pier、Jooseong Kim、和数据工程团队的其他成员。</p></div></div>    
</body>
</html>