# Pinterest 德鲁伊假日负载测试

> 原文：<https://medium.com/pinterest-engineering/pinterest-druid-holiday-load-testing-4bd9b9ee1308?source=collection_archive---------2----------------------->

伊莎贝尔·塔拉姆|高级软件工程师；王剑|高级软件工程师；顾|高级软件工程师；杨熠|高级软件工程师；实时分析团队工程经理 Kapil Bajaj

像许多公司一样，Pinterest 在一年的最后三个月看到了流量的增加。我们需要确保我们的系统为流量的增加做好准备，这样我们就不会遇到任何意外的问题。这一点尤其重要，因为 Pinners 在这个时候来到 Pinterest 进行假期规划和购物。因此，我们每年都用额外的负载测试我们的系统。在此期间，我们验证我们的系统能够处理预期的流量增长。在德鲁伊上，我们看几个检查来验证:

*   **查询:**我们确保服务能够处理 QPS 的预期增长，同时支持我们客户需要的 P99 延迟 SLA。
*   **接收:**我们验证了实时接收能够处理数据的增长。
*   **数据量增加:**我们确认存储系统有足够的容量来处理增加的数据量。

在本帖中，我们将提供如何运行假日负载测试的细节，并验证 Druid 是否能够处理上述预期的增加。

![](img/4e98cd3ffcd8091142c44e43066a3092.png)

Pinterest traffic increases as users look for inspiration for holidays.

# 我们如何运行负载测试

如上所述，我们团队关注的领域包括:

*   系统能处理增加的查询流量吗？
*   系统能否应对数据接收的增加？
*   系统能否应对数据量的增加？

## 系统能处理增加的查询流量吗？

测试查询流量和 SLA 是假日负载测试的主要目标。在我们的 Druid 系统中，我们有两个不同的负载测试选项。第一个选项基于 Druid 数据中的当前数据集生成查询，然后在 Druid 中运行这些查询。另一个选项捕获真实的生产查询，并在 Druid 中重新运行这些查询。这两种选择各有利弊。

**样品对比生产查询**

第一个选项——使用生成的查询——很容易随时运行，不需要像捕获查询这样的准备工作。但是，这种类型的测试可能无法准确显示系统在生产场景中的行为。与使用生成的查询测试相比，真实的生产查询可能看起来不同，涉及不同的数据、查询类型和时间范围。此外，在这种类型的测试中，任何极限情况都将被忽略。

第二个选项的优势是具有真实的生产查询，这将非常类似于我们期望在任何未来流量中看到的查询。然而，这里的缺点是设置测试更加复杂，因为需要捕获生产查询，并且在执行假日测试时可能需要更新以匹配新的时间表。在 Druid 中，今天与一周后运行相同的查询可能会产生不同的延迟结果，因为数据将经过不同的主机阶段，其中数据在最初几天/几周由更快的高内存主机支持，而对于较旧的数据则由较慢的磁盘阶段支持。

我们决定继续进行真正的生产查询，因为我们的优先任务之一是尽可能地复制生产用例。我们利用了一个 Druid 原生特性，该特性自动记录发送到 Druid 代理主机的任何查询(代理主机处理 Druid 集群中的所有查询工作)。

**测试环境设置**

假日测试不在生产环境中进行，因为这可能会对生产流量产生负面影响。然而，测试需要一个与生产环境尽可能相似的环境设置。因此，我们创建了一个生产环境的副本，它是短暂的，仅用于测试。要测试查询流量，唯一需要的阶段是代理、历史阶段和协调器。我们在生产环境中有几层历史阶段，我们也在测试环境中复制了相同的设置。我们还确保使用相同的主机类型、配置、池大小等。

我们用于测试的数据是从生产中复制过来的。我们使用一个简单的 MySQL 转储来创建存储在生产环境中的所有数据段的副本。一旦转储被添加到测试环境中的 MySQL 实例，协调器将自动触发数据在测试环境的历史阶段中被复制。

但是，在启动拷贝之前，我们需要确定需要哪些数据。这将取决于客户团队及其查询请求的时间范围。在某些情况下，可能不需要复制所有数据，只需复制最近几天、几周或几个月的数据即可。

![](img/afea2801a33f967e2e02a49a3671a08a.png)

Test environment is set up with the same configuration and hosts as Prod environment.

我们的测试系统首先连接到测试环境中的代理主机，然后从日志文件中加载查询，并将它们发送到代理主机。我们使用多线程实现来增加发送到代理节点的 QPS。首先，我们运行测试来确定需要多少线程作为匹配生产流量的基线—例如，300 个 QPS。基于此，我们可以定义需要使用多少线程来测试预期的假日流量(标准流量的两倍、三倍或更多倍)。

在我们的用例中，我们加载了特定日期(例如 10 月 1 日)之前收到的数据。此时，我们在同一天或前一天重新运行捕获的日志文件，以匹配生产行为。我们的测试脚本还能够更新查询中的时间范围，以匹配当前时间或预定义的时间，从而允许运行任何日志文件并将其转换为测试环境中可用的数据。

**评估结果**

为了确定我们系统的健康状况，我们使用现有指标来比较代理和历史节点上的 QPS 和 P99 延迟，并通过代理的 CPU 使用率等指标来确定系统健康状况。这些指标帮助我们识别任何瓶颈。

![](img/5d02f5c6682887f8f94dafd9f0084291.png)

Query response time with normal traffic and 2x increase on basic system setup.

典型的瓶颈可能包括历史节点或代理节点。

对于增加的 QPS，历史节点可能显示更高的延迟，这又会增加整体延迟。为了解决这一问题，我们将添加镜像主机并增加数据副本的数量，以支持更高负载下更好的延迟。实施此步骤需要时间，因为需要添加主机和加载数据，这可能需要几个小时，具体取决于数据大小。因此，这应该在生产系统的流量增加之前完成。

如果代理节点不再能够处理传入的查询流量，则需要增加代理池的大小。如果在测试环境甚至生产环境中出现这种情况，那么增加池大小会快得多，而且也可能是临时增加。

在测试环境中使用增加的数据量进行测试有助于我们确定需要哪些步骤来支持预期的假日流量变化。我们可以提前进行这些配置更改，并且我们可以让支持团队了解更改以及系统在指定 SLA 内能够处理的最大流量(客户团队的 QPS 和 P99 延迟要求)。

## 系统能否应对数据接收的增加？

测试实时数据接收能力类似于测试查询性能。可以从基于摄取数据的维度/基数估计支持的摄取率开始。然而，这只是一个指南，对于一些高优先级的用例，尽早测试是一个好主意。

我们建立了一个具有相同容量、配置等的测试环境。作为生产环境。然而，在这一步，可能需要客户团队的一些帮助，因为我们还需要测试来自 Kafka topic 等摄取源的更多数据。

在审查摄入测试时，我们关注几个关键指标。摄取延迟应该很低，成功和被拒绝事件(由于超出拒绝窗口)的数量应该非常接近生产环境中的可比值。我们还包括对摄取数据的验证，以及霸王和中层管理人员阶段的一般系统健康状况，这些阶段处理实时数据的摄取。

![](img/1266cc9d71fc7611feab9ca5329debfb.png)

Sample metrics for successfully ingested events, rejected events and kafka ingestion lag.

![](img/3a8213d2359b9a86d0abb12b761e58b0.png)

Sample metrics for successfully ingested events, rejected events and kafka ingestion lag.

![](img/7f67c8a275b6399150494e0add9b2bdc.png)

Sample metrics for successfully ingested events, rejected events and kafka ingestion lag.

## 系统能否应对数据量的增加？

评估系统是否能够处理数据量的增加可能是最简单、最快速的检查，尽管与前面的步骤一样重要。为此，我们看一下协调器 UI:在这里我们可以看到所有历史阶段、池大小以及它们当前运行的容量。一旦客户提供了有关数据量预期增长的详细信息，计算假期期间以及之后一段时间内需要存储的额外数据量就变得相当简单了。

![](img/ae5b1d193b0b500f8d0a46b2cc820564.png)

The space is at a healthy percentage (~70%) allowing for some growth.

**结果**

在我们今年进行的测试中，我们发现我们的历史阶段处于非常好的状态，能够处理假期期间预期的额外流量。但是，我们确实看到，如果流量达到某个阈值，代理池可能需要一些额外的主机。我们已经确保与客户团队和支持团队保持这种沟通，以便团队成员意识到并知道池的大小可能需要增加。

**学习**

假期测试的时机非常关键。这个项目有一个固定的结束日期，在此日期之前，在任何流量增加之前，需要完成系统中的所有更改，并且团队需要确保在结果到期之前将所有部分准备就绪。正如许多项目和这个项目一样，我们需要为时间表和需求的意外变化留出额外的缓冲时间。

Druid 是一个后端服务，只要表现良好，它并不总是许多客户团队的首选。因此，在测试开始之前联系客户团队以获得他们对预期假日流量增长的估计是不是一个好主意。我们的一些客户主动联系我们；然而，对治理团队的任何容量增加请求的截止日期已经过去了。在这些情况下，或者在客户团队还不确定的情况下，对流量增长做一个大致的估计并用这些数字开始测试是一个好的做法。

跟踪每年的假期计划和应用的变化也是一个很好的实践。拥有每年变化的历史记录，并跟踪实际增长与之前做出的原始估计，将有助于对下一年预期的流量增长做出有根据的估计。

在假期更新之前了解代理的容量和历史阶段的详细信息，可以使团队更容易评估假期后减少集群的容量，并考虑每月的有机增长。

# 未来的工作

在今年的用例中，我们选择了捕获代理日志的选项来检索我们想要回放给 Druid 的查询。这个选项目前对我们有效，尽管我们计划将来研究其他选项来捕获查询。日志文件选项很适合一次性需求，但是持续记录查询并将它们存储在 Druid 中会很有用。这有助于调试问题和识别可能需要一些调整来获得性能改进的高延迟查询。

*要在 Pinterest 了解更多工程知识，请查看我们的* [*工程博客*](https://medium.com/pinterest-engineering) *，并访问我们的*[*Pinterest Labs*](https://www.pinterestlabs.com/?utm_source=medium&utm_medium=blog-article-post&utm_campaign=tallam-et-al-december-9-2021)*网站。要查看和申请空缺职位，请访问我们的* [*职业*](https://www.pinterestcareers.com/?utm_source=medium&utm_medium=blog-article-post&utm_campaign=tallam-et-al-december-9-2021) *页面。*