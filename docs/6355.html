<html>
<head>
<title>Debugging Ad Delivery At Pinterest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Pinterest调试广告投放</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/debugging-ad-delivery-at-pinterest-8b7b1f562afc?source=collection_archive---------0-----------------------#2022-06-24">https://medium.com/pinterest-engineering/debugging-ad-delivery-at-pinterest-8b7b1f562afc?source=collection_archive---------0-----------------------#2022-06-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="4147" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Nishant Roy |广告服务平台工程经理</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/7d2a99e08d0f0428c4190aad9884217b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aJw3Du8ATrc4Tt5S"/></div></div></figure><h1 id="00ba" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">简介和背景</h1><p id="3a19" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">Pinterest广告服务平台在2021年从成千上万的广告商那里交付了超过25亿美元的广告支出。我们的客户运营团队平均每月会收到600多张来自广告商的罚单，这些广告商希望了解他们在我们平台上的表现。我们收到的最常见的问题之一是，为什么一个特定的广告商/广告活动没有充分利用其预算。这个问题需要对一个广告推荐系统进行深入分析，该系统由5+微服务、1M+代码行和100+活跃开发者组成，每天服务超过9000万个请求。这篇博客描述了我们如何建立一个系统来快速回答这些问题，而不需要深入的技术知识或背景。我们有三个主要目标:</p><ul class=""><li id="aba7" class="kr ks hh ig b ih ii il im ip kt it ku ix kv jb kw kx ky kz bi translated">通过缩短解决问题的时间来提高广告商的满意度</li><li id="522e" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated">自动进行数据分析，并为广告客户提供建议，以提高投放率</li><li id="b46c" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated">覆盖系统中的所有组件(索引、预算/速度、候选人生成、排名、广告漏斗、拍卖等)。)</li></ul><h1 id="a8f8" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">设计/挑战</h1><h2 id="e731" class="lf jp hh bd jq lg lh li ju lj lk ll jy ip lm ln kc it lo lp kg ix lq lr kk ls bi translated">数据覆盖范围</h2><p id="ce52" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">大多数可用于调试的数据都是请求级别的，并且经过大量采样以降低成本，这意味着我们没有足够的数据来了解所有广告商的系统行为。我们需要广泛覆盖所有广告客户，在广告推荐系统的所有阶段进行计数，而不会产生巨大的日志和存储成本。</p><h2 id="7fe9" class="lf jp hh bd jq lg lh li ju lj lk ll jy ip lm ln kc it lo lp kg ix lq lr kk ls bi translated">解决方案:Druid上的聚合数据管道</h2><p id="52ec" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">在研究了我们的选项之后，我们选择使用<a class="ae lt" href="https://druid.apache.org/" rel="noopener ugc nofollow" target="_blank"> Druid </a>作为我们的存储解决方案，原因如下:</p><ul class=""><li id="d5bb" class="kr ks hh ig b ih ii il im ip kt it ku ix kv jb kw kx ky kz bi translated"><strong class="ig hi">通过Kafka的实时高摄取率:</strong>每个广告请求可能包含数千个候选人，我们需要记录所有这些id的数据。我们已经广泛使用Kafka进行日志记录，所以我们能够重用Druid的很多基础设施。通过将Kafka与Druid结合使用，我们的管道可以在不超过几分钟延迟的情况下为调试实时提供数据。</li><li id="0db7" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated"><strong class="ig hi">支持聚合查询:</strong>我们期望的查询模式是检索给定时间段内某个ID的计数。Druid针对时间序列数据进行了优化，并提供了很大的聚合灵活性，因此它符合我们的要求。</li><li id="fb01" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated"><strong class="ig hi">低延迟和存储成本:</strong> Druid允许我们提供id级别计数的实时可见性。此外，Druid支持摄取时的聚合，这可以最小化存储数据的大小。</li></ul><p id="876f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面是我们的日志模式和一个Druid响应的示例:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lu"><img src="../Images/4d347726ce705e6a664123ecf27d13b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kLTyiCkzp2J7msVcxJf0xQ.png"/></div></div></figure><p id="db42" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有了这些数据，我们现在可以回答如下问题:</p><ul class=""><li id="784e" class="kr ks hh ig b ih ii il im ip kt it ku ix kv jb kw kx ky kz bi translated">一场运动在哪个阶段最容易被淘汰？</li><li id="69f9" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated">每个阶段的平均配平率是多少？</li><li id="3dcb" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated">营销活动的修剪率或插入率每天都在发生怎样的变化？</li></ul><p id="ebaa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过回答这些问题，我们可以快速了解糟糕的广告投放是由系统中的bug(例如，某个阶段的代码更改)还是糟糕的活动配置(例如，非常低的出价或预算)引起的。</p><h1 id="5412" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">微服务</h1><p id="5af5" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">我们的广告投放系统由几个不同的系统组成，每个系统都有自己的职责(候选人生成、调整、评分、投标/预算管理、索引、内容安全过滤等)。活动表现不佳的根本原因可能在于这些系统中的任何一个，这些系统由Pinterest的多个不同团队所有，这使得分类和解决交付问题变得非常困难。</p><h2 id="2e58" class="lf jp hh bd jq lg lh li ju lj lk ll jy ip lm ln kc it lo lp kg ix lq lr kk ls bi translated">解决方案:统一调试UI</h2><p id="2000" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">为了简化调试过程，我们构建了一个统一的UI来可视化从广告投放过程中涉及的所有系统记录的数据。用户现在可以输入一个活动ID，只需几秒钟就可以查看所有系统的详细调试信息。我们现在可以轻松回答以下问题:</p><ul class=""><li id="46a1" class="kr ks hh ig b ih ii il im ip kt it ku ix kv jb kw kx ky kz bi translated">哪个阶段的配平率最高？</li><li id="01fa" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated">是否有过多的内容过滤？</li><li id="bf58" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated">市场活动在索引中不活跃吗？</li><li id="693a" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated">预算有变化吗？</li><li id="7601" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated">广告商对他们的活动设置做了任何改变吗？</li></ul><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/14b7dbbd7d5601ab61dd0855f87e4f06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_fOOVj6LRRFqjJoA"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx"><em class="lz">Fig 1: Unified Debugging UI with tabs for each system in the ad delivery process</em></figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ma"><img src="../Images/9556789d4db3e09b5f7ce16448c958bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uNP26Qk4ni6a7HoS"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx"><em class="lz">Fig 2: Trimmed counts by stage in the ad funnel</em></figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/807ac556b077292c9ca6d0b98ec2464c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fjkpZXFTHJsmfMBz"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx"><em class="lz">Fig 3: Campaign spend against target spend and daily budget</em></figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/b4937ddfa353a3af40a3209f7b3719f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MVOtSjsH41pOv7mb"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx"><em class="lz">Fig 4: Number of active vs filtered pins from a campaign in the ads index</em></figcaption></figure><h1 id="b4b0" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">非工程团队的可访问性</h1><p id="5826" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">为了使交付调试成为一个简单且可扩展的过程，我们希望让非工程团队(如客户运营和销售)了解我们的系统，以及可以采取哪些措施来改善广告交付。</p><h2 id="3954" class="lf jp hh bd jq lg lh li ju lj lk ll jy ip lm ln kc it lo lp kg ix lq lr kk ls bi translated">解决方案:一行摘要诊断和建议</h2><p id="0fee" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">我们的交付调试器提供了简单的、一行的活动健康状况摘要，以及可以改进广告交付的更改建议。这些总结不需要对我们的技术系统有深入的了解，因为它们不需要工程团队的帮助，所以可以更容易、更快地解决一些交付问题。摘要是预先编写的，并且是基于启发式规则选择的，这些启发式规则是我们基于先前的经验和我们对广告投放系统的了解而人工确定的。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/93ee28beb1ba87e2eaa253329977d931.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LnTKieXsbpR-DEpB"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx"><em class="lz">Fig 5: One-line summary showing which serving funnel stage may be limiting delivery</em></figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/320085b87fd393d2a5e1bc8e81c84cd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7kNVQYInx5pgS3BF"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx"><em class="lz">Fig 6: One-line summary showing which retrieval stage may be limiting delivery</em></figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/b2413db133b26fdab883548496148d26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VM_aAFzXTkdWRFtb"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx"><em class="lz">Fig 7: One-line summary showing that no stage is overacting, suggesting the problem lies in a different system</em></figcaption></figure><p id="b500" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果需要更多的技术理解，我们还添加了关于端到端系统的详细文档，以及广告漏斗中的每个阶段，它的作用，以及在特定阶段出现意外或不良行为时推荐的解决方案。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mb"><img src="../Images/17cfae3400e0904579960e2d9d50baea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TXR4gBAoM-bVeKJpo0jLmQ.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx"><em class="lz">Fig 8: Delivery Debugger technical documentation</em></figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mc"><img src="../Images/ebaa63986f07c3acf93e90f5ccc316f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sGAe-R5Lc-5CDLY3lb369w.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx"><em class="lz">Fig 9: Definitions and recommended solutions for each stage in the ad delivery funnel</em></figcaption></figure><h1 id="d6e8" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">影响</h1><p id="12c0" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">2021年，我们的客户运营团队共收到7270张罚单，其中只有78张需要上报给工程团队进行进一步调查。这意味着99%的故障单都是在没有工程团队任何支持的情况下解决的。有趣的是，我们在客户运营团队中的合作伙伴说，由于交付调试器工具，至少60–70%的票证由他们的团队独立解决，他们每天都依赖于该工具。</p><p id="4f5b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此外，在2021年，提出第一个解决方案(向广告商发送分析和建议)平均需要47个小时，完整的解决方案需要67个小时。</p><p id="6572" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">另一个清楚表明Delivery Debugger影响的指标是需要上报给工程团队的原始票据数量:2019年110张，2020年106张，2021年只有78张。随着我们继续迭代该工具，对专用工程支持的需求正在下降，允许团队将更多的时间花在更大的项目上，而不是调试。</p><p id="fba7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，对于升级到工程团队的票证(如图10所示)，只有2%的错误没有解决；从图11中可以看出，我们90%的时间都达到了固定的服务级别协议。</p><p id="74ba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的交付调试程序现在每月被工程和非工程团队的数百名Pinterest员工使用，以高效地分类和解决广告交付错误。我们很高兴能够继续让这个工具更强大，让我们的团队在未来变得更加有效。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/9d27352edadb498cd4afe88cf96e2803.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZD10-aFzZhHoAuy6"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx"><em class="lz">Fig 10: Breakdown of ad delivery bug ticket status</em></figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/eafdc8bd00f29af531d0305bd7beb6f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6O9ocntSZsJkr58D"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx"><em class="lz">Fig 11: Ad delivery bug fix SLA metrics</em></figcaption></figure><h1 id="5b8e" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">未来的改进</h1><p id="b0c0" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">虽然我们已经为许多系统增加了承保范围，但仍有扩展空间。我们的下一步将是添加广泛的检查来分类预算问题，并提供预算变更如何影响交付的单行摘要。在此之后，我们计划扩展我们的工具，以覆盖广告定位配置，以分流因定位规格太窄或太宽而导致的交付问题。随着我们的系统和产品变得越来越复杂，不断需要改进我们的交付调试器，以保持我们的广告推荐系统具有高水平的可观察性。</p><h1 id="563c" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">承认</h1><p id="3ab7" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">这个项目是多个团队中几个工程师努力工作的结果。特别感谢王泽宇，他在3年多的时间里构建了这个工具和底层框架，也感谢丹妮尔·拉扎，在过去的一年里，他接管了所有权并不断更新，以跟上不断变化的业务和产品需求。此外，我还要感谢Sreshta Vijayaraghavan、Zack Drach、Alexander Rhee、Kenny Valdivia、Alejandro Iglesias、刘明思、ani kite ket kar、胡成成、Shawn Nguyen、Sameer Bhide、Andrei Curelea、谢旦、刘海臣、杨韬、张数、周慧清、徐昂、Filip亚罗什、王伟鸿、叶明Shi、Keshava Subramanya以及工程团队中的其他许多人所做的贡献。我还要感谢我们客户运营团队的合作伙伴，Rivy Obinomen，Erika Martin，Katie Apple和其他许多人，感谢他们持续的支持和反馈，帮助提高了交付调试程序的质量。</p><p id="0567" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="md">要在Pinterest了解更多工程知识，请查看我们的</em> <a class="ae lt" href="https://medium.com/pinterest-engineering" rel="noopener"> <em class="md">工程博客</em> </a> <em class="md">，并访问我们的</em><a class="ae lt" href="https://www.pinterestlabs.com/?utm_source=medium&amp;utm_medium=blog-article-link&amp;utm_campaign=roy-june-24-2022" rel="noopener ugc nofollow" target="_blank"><em class="md">Pinterest Labs</em></a><em class="md">网站。要查看和申请空缺职位，请访问我们的</em> <a class="ae lt" href="https://www.pinterestcareers.com/?utm_source=medium&amp;utm_medium=blog-article-link&amp;utm_campaign=roy-june-24-2022" rel="noopener ugc nofollow" target="_blank"> <em class="md">招聘</em> </a> <em class="md">页面</em></p></div></div>    
</body>
</html>