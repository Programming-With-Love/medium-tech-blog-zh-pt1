<html>
<head>
<title>Two birds with one home — cloned Vagrant multi-machines!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一家两鸟——克隆流浪多机！</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/two-birds-with-one-home-cloned-vagrant-multi-machines-2ee5ba75fad8?source=collection_archive---------3-----------------------#2020-02-06">https://medium.com/oracledevs/two-birds-with-one-home-cloned-vagrant-multi-machines-2ee5ba75fad8?source=collection_archive---------3-----------------------#2020-02-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/9930eef43ed1b017742ba6f2e9cbd571.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IeZXyR08QbvBcMVBRc7YQw.jpeg"/></div></div></figure><p id="5a47" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">vagger使创建单个虚拟机变得很容易。这很好，但是如果您想要多个虚拟机呢？</p><p id="d542" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">幸运的是，多个虚拟机使用travel很容易，只需编辑一下travel文件。</p><p id="47d2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">此外，vagger可以创建多个虚拟机，每个虚拟机都是单个主虚拟机的克隆。</p><p id="fa39" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">vagger与各种虚拟机管理程序兼容，但出于我们的目的，我将使用Oracle VirtualBox创建2个虚拟机克隆。</p></div><div class="ab cl jn jo go jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ha hb hc hd he"><p id="434d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">OEL8流浪盒最近已经在Github的Oracle库中发布了。下载整个存储库，包括OEL8组件，如下所示:</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="f10d" class="kd ke hh jz b fi kf kg l kh ki">&gt; git clone <a class="ae kj" href="https://github.com/oracle/vagrant-boxes" rel="noopener ugc nofollow" target="_blank">https://github.com/oracle/vagrant-boxes</a></span></pre><p id="9673" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">开箱即用，位于\OracleLinux\8目录中的流浪者文件将使用最新的OEL8配置单个虚拟主机。</p><p id="472e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然而，要获得多台机器，需要编辑流浪者文件。所以所有的代码块都将放在主块中。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="7f20" class="kd ke hh jz b fi kf kg l kh ki">Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|<br/>..<br/>&lt;put_virtual_machine_configurations_in_here&gt;<br/>..<br/>end</span></pre><p id="6f6e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">对于第一个代码块，您可能希望为每个虚拟机创建一个资源限制。让我们从每个虚拟机接收最大1GB内存和1个CPU核心开始。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="a3fc" class="kd ke hh jz b fi kf kg l kh ki">  # hardware bound<br/>  config.vm.provider "virtualbox" do |vb|<br/>    vb.memory = 1024<br/>    vb.cpus = 1</span><span id="bd2f" class="kd ke hh jz b fi kk kg l kh ki">    # create a master VM before creating the linked clones<br/>    vb.linked_clone = true<br/>  end</span></pre><p id="b690" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在第一个代码块的末尾，我配置了“linked_clone = true”。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="3515" class="kd ke hh jz b fi kf kg l kh ki">    # create a master VM before creating the linked clones<br/>    vb.linked_clone = true</span></pre><p id="0f1c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">从流浪者文档中,“链接_克隆=真”执行以下操作:</p><blockquote class="kl km kn"><p id="f13f" class="ip iq ko ir b is it iu iv iw ix iy iz kp jb jc jd kq jf jg jh kr jj jk jl jm ha bi translated">默认情况下，通过导入基本框来创建新机器。对于大的机器，这在时间(导入操作)和空间(新机器包含基本机器映像的副本)方面产生了很大的开销。使用链接克隆可以大大减少这种开销。</p><p id="d0aa" class="ip iq ko ir b is it iu iv iw ix iy iz kp jb jc jd kq jf jg jh kr jj jk jl jm ha bi translated">链接克隆基于主虚拟机，该虚拟机是通过在第一次需要时只导入一次基本虚拟机来生成的。对于链接克隆，仅创建差异磁盘映像，其中父磁盘映像属于主虚拟机。</p></blockquote><p id="a344" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在，让我们配置第一个虚拟机的属性。我们将分配一个主机名和静态IP地址。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="6183" class="kd ke hh jz b fi kf kg l kh ki">  # create a linked clone of the master VM<br/>  config.vm.define "email-MTA" do |mta|<br/>    mta.vm.box_check_update = false<br/>    mta.vm.box = "ol8-latest"<br/>    mta.vm.box_url = "<a class="ae kj" href="https://yum.oracle.com/boxes/oraclelinux/latest/ol8-latest.box" rel="noopener ugc nofollow" target="_blank">https://yum.oracle.com/boxes/oraclelinux/latest/ol8-latest.box</a>"</span><span id="984e" class="kd ke hh jz b fi kk kg l kh ki">    mta.vm.define "ol8-smtp-mta"</span><span id="f433" class="kd ke hh jz b fi kk kg l kh ki">    # name of the virtual machine instance<br/>    mta.vm.hostname = "smtp-mta.host.com"</span><span id="7092" class="kd ke hh jz b fi kk kg l kh ki">    # assign a static IP<br/>    mta.vm.network "private_network", ip: "192.168.1.9"<br/>  end</span></pre><p id="ca50" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在配置第二个虚拟机。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="ce2e" class="kd ke hh jz b fi kf kg l kh ki"># create a linked clone of the master VM<br/>  config.vm.define "email-MDA" do |mda|<br/>    mda.vm.box_check_update = false<br/>    mda.vm.box = "ol8-latest"<br/>    mda.vm.box_url = "<a class="ae kj" href="https://yum.oracle.com/boxes/oraclelinux/latest/ol8-latest.box" rel="noopener ugc nofollow" target="_blank">https://yum.oracle.com/boxes/oraclelinux/latest/ol8-latest.box</a>"</span><span id="4e96" class="kd ke hh jz b fi kk kg l kh ki">    mda.vm.define "ol8-smtp-mda"</span><span id="b5d2" class="kd ke hh jz b fi kk kg l kh ki">    # name of the virtual machine instance<br/>    mda.vm.hostname = "smtp-mda.host.com"</span><span id="5f0c" class="kd ke hh jz b fi kk kg l kh ki">    # assign a static IP<br/>    mda.vm.network "private_network", ip: "192.168.1.10"<br/>  end</span></pre><p id="2712" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在，我们可以开始了，所以用travel启动虚拟机。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="0e07" class="kd ke hh jz b fi kf kg l kh ki">&gt; vagrant up</span></pre><p id="141d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">OEL8最新的流浪汉盒子会被下载，流浪汉可以告诉我们目前为止下载了哪些流浪汉盒子。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="13ec" class="kd ke hh jz b fi kf kg l kh ki">&gt; cd "C:\Program Files\Oracle\VirtualBox"</span><span id="bd50" class="kd ke hh jz b fi kk kg l kh ki">&gt; vagrant box list<br/>ol7-latest (virtualbox, 0)<br/>ol8-latest (virtualbox, 0)</span><span id="c968" class="kd ke hh jz b fi kk kg l kh ki">&gt;</span></pre><p id="7b45" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">启动后，要确定所有与After相关的虚拟机的状态，只需使用“global-status”子句。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="308c" class="kd ke hh jz b fi kf kg l kh ki">&gt; vagrant global-status<br/>id       name               provider   state    directory<br/>------------------------------------------------------------------------------------------------------<br/>ece1d42  email-MTA          virtualbox running  C:/Users/oracle/vagrant-boxes/OracleLinux/8<br/>28e35ce  email-MDA          virtualbox running  C:/Users/oracle/vagrant-boxes/OracleLinux/8</span><span id="9e17" class="kd ke hh jz b fi kk kg l kh ki">The above shows information about all known Vagrant environments<br/>on this machine. This data is cached and may not be completely<br/>up-to-date (use "vagrant global-status --prune" to prune invalid<br/>entries). To interact with any of the machines, you can go to that<br/>directory and run Vagrant, or you can use the ID directly with<br/>Vagrant commands from any directory. For example:<br/>"vagrant destroy 1a2b3c4d"</span><span id="bb30" class="kd ke hh jz b fi kk kg l kh ki">&gt;</span></pre><p id="b9f0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Oracle VirtualBox CLI还会告诉我们哪些虚拟机正在运行。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="c1fc" class="kd ke hh jz b fi kf kg l kh ki">&gt; VBoxManage list runningvms<br/>"email_email-MTA_1580297020948_19483" {d65d7083-fc34-4d1b-9c75-31b9a0de35c3}<br/>"email_email-MDA_1580297795595_41309" {5dac821c-69fd-4638-986a-98a21bef643b}</span><span id="ba57" class="kd ke hh jz b fi kk kg l kh ki">&gt;</span></pre><p id="5459" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Oracle VirtualBox GUI还显示有2个虚拟机正在运行。</p><figure class="ju jv jw jx fd ii er es paragraph-image"><div class="er es ks"><img src="../Images/12a6861576445a9f30d3f5eeae15cec2.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*_d51LVSq-wsQ2Q-fFUvoVQ.jpeg"/></div></figure><p id="a01a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">但是，克隆这两个正在运行的虚拟机的基础虚拟机已按预期关闭。</p><figure class="ju jv jw jx fd ii er es paragraph-image"><div class="er es kt"><img src="../Images/5b43ff6ce1f539f42bbde00a7337ee15.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*35Y4E1eLGmw8S1h8TwRsZg.jpeg"/></div></figure></div><div class="ab cl jn jo go jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ha hb hc hd he"><p id="f231" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在，我们可以在单个虚拟机中确认登录。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="d9ae" class="kd ke hh jz b fi kf kg l kh ki">&gt; vagrant ssh email-MTA</span><span id="8761" class="kd ke hh jz b fi kk kg l kh ki">Welcome to Oracle Linux Server release 8.0 (GNU/Linux package kernel-uek is not installed)</span><span id="38fc" class="kd ke hh jz b fi kk kg l kh ki">The Oracle Linux End-User License Agreement can be viewed here:</span><span id="f616" class="kd ke hh jz b fi kk kg l kh ki">* /usr/share/eula/eula.en_US</span><span id="7d61" class="kd ke hh jz b fi kk kg l kh ki">For additional packages, updates, documentation and community help, see:</span><span id="851e" class="kd ke hh jz b fi kk kg l kh ki">* <a class="ae kj" href="http://yum.oracle.com/" rel="noopener ugc nofollow" target="_blank">http://yum.oracle.com/</a></span><span id="ff44" class="kd ke hh jz b fi kk kg l kh ki">[vagrant@smtp-mta ~]$</span></pre><p id="530d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在登录到另一个虚拟机。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="9761" class="kd ke hh jz b fi kf kg l kh ki">&gt; vagrant ssh email-MDA</span><span id="8cbe" class="kd ke hh jz b fi kk kg l kh ki">Welcome to Oracle Linux Server release 8.0 (GNU/Linux package kernel-uek is not installed)</span><span id="2863" class="kd ke hh jz b fi kk kg l kh ki">The Oracle Linux End-User License Agreement can be viewed here:</span><span id="58d8" class="kd ke hh jz b fi kk kg l kh ki">* /usr/share/eula/eula.en_US</span><span id="1f89" class="kd ke hh jz b fi kk kg l kh ki">For additional packages, updates, documentation and community help, see:</span><span id="380e" class="kd ke hh jz b fi kk kg l kh ki">* <a class="ae kj" href="http://yum.oracle.com/" rel="noopener ugc nofollow" target="_blank">http://yum.oracle.com/</a></span><span id="7758" class="kd ke hh jz b fi kk kg l kh ki">[vagrant@smtp-mda ~]$</span></pre><p id="2c3f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">两个虚拟机的关闭与单个游离虚拟机的关闭相同。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="2d73" class="kd ke hh jz b fi kf kg l kh ki">&gt; vagrant halt<br/>==&gt; email-MDA: Attempting graceful shutdown of VM...<br/>==&gt; email-MTA: Attempting graceful shutdown of VM...</span><span id="808e" class="kd ke hh jz b fi kk kg l kh ki">&gt;</span></pre></div><div class="ab cl jn jo go jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ha hb hc hd he"><p id="5379" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">请记住，我们在浮动文件中使用了特殊的“linked_clone = true”配置。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="146f" class="kd ke hh jz b fi kf kg l kh ki">    # create a master VM before creating the linked clones<br/>    vb.linked_clone = true</span></pre><p id="4abc" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们现在可以看到使用基本虚拟机和克隆虚拟机组合对存储要求的影响。基本虚拟机的大小为:</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="648d" class="kd ke hh jz b fi kf kg l kh ki">&gt; dir "OL8U0_x86_64_1574143390111_30607"|find "File"</span><span id="3836" class="kd ke hh jz b fi kk kg l kh ki">4 File(s)  1,689,990,382 bytes</span><span id="18a9" class="kd ke hh jz b fi kk kg l kh ki">&gt;</span></pre><p id="8dae" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因此，克隆的基本虚拟机大约为1.5 GB。</p><p id="d9f9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">2个克隆虚拟机的大小在此处确定:</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="6c21" class="kd ke hh jz b fi kf kg l kh ki">&gt; dir "email_email-MDA_1580297795595_41309"|find "File"</span><span id="6b9d" class="kd ke hh jz b fi kk kg l kh ki">2 File(s)         11,430 bytes</span><span id="98e0" class="kd ke hh jz b fi kk kg l kh ki">&gt; dir "email_email-MTA_1580297020948_19483"|find "File"</span><span id="20d5" class="kd ke hh jz b fi kk kg l kh ki">2 File(s)         11,430 bytes</span><span id="da55" class="kd ke hh jz b fi kk kg l kh ki">&gt;</span></pre><p id="b0ab" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因此，我们实际上有3台虚拟机:</p><ul class=""><li id="5268" class="ku kv hh ir b is it iw ix ja kw je kx ji ky jm kz la lb lc bi translated">1.6 GB的单基础虚拟机。</li><li id="29a7" class="ku kv hh ir b is ld iw le ja lf je lg ji lh jm kz la lb lc bi translated">2个总共只有KB的克隆虚拟机。</li></ul><p id="fb59" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果没有“linked_clone = true”配置，我们将有2个各1.6 GB的虚拟机，总共3.2 GB。</p><p id="c725" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">相反，我们有一个1.6 GB的基本虚拟机和两个小得多的克隆，总容量远低于3.2 GB。</p><p id="c909" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Paul Guerin是一名专注于Oracle数据库的国际顾问。Paul在东南亚的全球交付中心工作，但他的客户来自澳大利亚、欧洲、亚洲和北美。此外，他还出席了一些世界领先的甲骨文会议，包括甲骨文2013年世界开放大会。自2015年以来，他的工作一直是IOUG最佳实践技巧小册子以及AUSOUG、Oracle Technology Network和Oracle Developers (Medium)出版物的主题。2019年，他被授予My Oracle支持社区最有价值贡献者。他是一名DBA OCP，并将继续参与Oracle ACE计划。</p></div></div>    
</body>
</html>