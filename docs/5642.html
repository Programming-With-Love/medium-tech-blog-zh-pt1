<html>
<head>
<title>4. Adding HTTPS Support to OCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">4.增加HTTPS对OCI的支持</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/adding-https-support-to-oci-a96f6e7213f?source=collection_archive---------0-----------------------#2019-08-20">https://medium.com/oracledevs/adding-https-support-to-oci-a96f6e7213f?source=collection_archive---------0-----------------------#2019-08-20</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/a1711b9c36386e51c48cc277d29ef5a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RnT9RunW6RCBoe3QtRxb3A.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Image courtesy of Shutterstock.com</figcaption></figure><p id="ec9d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在本系列的前几篇文章中，我们创建了一个网站，然后学习了如何在服务器重启时自动启动它，以及如何根据需要扩展它。到目前为止，web服务器只使用HTTP作为它的协议。我们希望增加HTTPS支持，这样我们最终能够让用户安全地登录到网站。</p><p id="8638" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在本文中，我们将执行以下步骤:</p><ol class=""><li id="1b46" class="jr js hh iv b iw ix ja jb je jt ji ju jm jv jq jw jx jy jz bi translated">创建一个web服务器来支持在端口8080上传输静态文件</li><li id="cf9e" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">配置负载平衡器以支持web流量</li><li id="f55f" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">注册一个DNS名称，并将其指向我们的负载平衡器</li><li id="6446" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">从证书颁发机构注册SSL证书</li><li id="e9ab" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">配置负载平衡器以支持HTTPS</li></ol><blockquote class="kf kg kh"><p id="309b" class="it iu ki iv b iw ix iy iz ja jb jc jd kj jf jg jh kk jj jk jl kl jn jo jp jq ha bi translated"><strong class="iv hi">先决条件</strong> <br/>您需要注册一个域名，并能够编辑该域名的DNS记录，以便更改相关的IP地址。你可以向大多数虚拟主机提供商注册一个新域名。<br/>您还需要完成本系列的前三篇文章，并且<strong class="iv hi">而不是</strong>已经删除了您在第三篇文章中创建的服务器和负载均衡器。<br/> <a class="ae km" rel="noopener" href="/oracledevs/getting-started-with-oracle-cloud-infrastructure-6b048dad480c">第1篇—OCI入门</a>，<br/> <a class="ae km" rel="noopener" href="/oracledevs/automatically-starting-your-web-server-2b7b793dfcb4">第2篇—自动启动您的Web服务器</a>，<br/> <a class="ae km" rel="noopener" href="/oracledevs/scaling-your-oci-web-server-203895180102">第3篇—扩展您的OCI Web服务器</a>。</p></blockquote><p id="e99a" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">为了节省一些现金，并保持试用帐户的精神，我们将从<a class="ae km" href="https://www.sslforfree.com/" rel="noopener ugc nofollow" target="_blank">SSLforFree.com</a>那里获得我们的SSL证书。为了验证我们对SSLforFree.com域名的所有权，我们需要能够在端口80上发布“验证”文件。</p><h1 id="6a40" class="kn ko hh bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">创建我们的静态文件Web服务器</h1><p id="e89e" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">我们将创建第二台web服务器来处理端口8080上对静态文件的请求(sslforfree.com用于验证您对主机的所有权)。如果您已经拥有负载平衡器的有效SSL证书，请随意跳到最后一步<strong class="iv hi"> <em class="ki">配置您的负载平衡器以使用HTTPS </em> </strong>。</p><blockquote class="kf kg kh"><p id="ed1c" class="it iu ki iv b iw ix iy iz ja jb jc jd kj jf jg jh kk jj jk jl kl jn jo jp jq ha bi translated"><strong class="iv hi">为什么是8080端口？如果我们让web服务器监听端口80，我们必须以root用户的身份启动它们。这通常被认为是不安全的。我们将在端口8080上运行我们的服务器，然后让负载平衡器将流量从端口80转发到端口8080。</strong></p></blockquote><h2 id="be9b" class="lq ko hh bd kp lr ls lt kt lu lv lw kx je lx ly lb ji lz ma lf jm mb mc lj md bi translated">创建新的Node.js项目</h2><p id="0b50" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">打开一个命令行，导航到本地计算机上要创建新节点应用程序的文件夹/目录。我将mine命名为<strong class="iv hi"> <em class="ki"> staticServer </em> </strong>，因此在我用来存储所有节点项目的主目录中，我键入:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="6af9" class="lq ko hh mj b fi mn mo l mp mq">mkdir staticServer<br/>cd staticServer<br/>npm init</span></pre><p id="ba26" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在本地机器上的staticServer文件夹中，创建<strong class="iv hi"> <em class="ki"> index.js </em> </strong>文件，并赋予其以下内容:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="d582" class="lq ko hh mj b fi mn mo l mp mq">const http = require('http');<br/>const fs = require('fs');<br/>hostname = '0.0.0.0';<br/>const port = 8080;</span><span id="000e" class="lq ko hh mj b fi mr mo l mp mq">const server = http.createServer((req, res) =&gt; {<br/>   var currentDate = new Date();<br/>   var utcDate = currentDate.toUTCString();<br/>   var absURL = '/home/opc/staticServer' + req.url;</span><span id="ea00" class="lq ko hh mj b fi mr mo l mp mq">   if(req.method === 'GET') {<br/>      // This is a request to get a file.<br/>      console.log('GET ' + req.url + ' : ' + utcDate);<br/>      // Is this a health check?<br/>      if (req.url === '/healthcheck') {<br/>         // Yes, this is a health check. Report that we are healthy<br/>         res.statusCode = 200;<br/>         res.setHeader('Content-Type', 'text/plain');<br/>         res.end("Healthy\n");<br/>      } else if (fs.existsSync(absURL) &amp;&amp; !fs.lstatSync(absURL).isDirectory()) {<br/>         // This is a request for a static file<br/>         console.log('GET ' + absURL + ' : exists!');<br/>         res.statusCode = 200;<br/>         res.setHeader('Content-Type', 'text/plain');<br/>         // Open the file and read it synchronously<br/>         var contents = fs.readFileSync('/home/opc/staticServer' + req.url, 'utf8');<br/>         res.write(contents);<br/>         res.end("\n");<br/>      } else {<br/>         // This is a request for a file that doesn't exist or<br/>         // a directory. We don't support such requests<br/>         console.log('ILLEGAL REQUEST: ' + req.method + ' ' + absURL);<br/>         res.statusCode = 403;<br/>         res.end('FORBIDDEN\n');<br/>      }<br/>   } else {<br/>      // This is an unknown / unsupported request<br/>      console.log('UNKNOWN REQUEST: ' + req.method + ' ' + req.url);<br/>      res.statusCode = 400;<br/>      res.end('Unknown request\n');<br/>   }<br/>});</span><span id="c2c4" class="lq ko hh mj b fi mr mo l mp mq">server.listen(port, hostname, () =&gt; {<br/>   console.log(`Server running at <a class="ae km" rel="noopener ugc nofollow" target="_blank" href="/${hostname}:${port}/`);">http://${hostname}:${port}/`);</a><br/>});</span></pre><p id="f0db" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">现在使用<strong class="iv hi"> <em class="ki"> scp </em> </strong>将您的本地<strong class="iv hi"> <em class="ki"> staticServer/ </em> </strong>文件夹复制到您的两个计算实例上:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="fa82" class="lq ko hh mj b fi mn mo l mp mq">scp -r -i <em class="ki">~/oci_key</em> ~/Downloads/nodeWorkspace/staticServer  <a class="ae km" href="mailto:opc@129.213.52.76" rel="noopener ugc nofollow" target="_blank"><em class="ki">opc</em>@</a>&lt;your IP address&gt;:/home/opc</span></pre><h2 id="6942" class="lq ko hh bd kp lr ls lt kt lu lv lw kx je lx ly lb ji lz ma lf jm mb mc lj md bi translated">为端口8080添加无状态入口规则</h2><p id="cbaf" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">现在，我们需要允许流量通过端口8080到达我们的web服务器。为此，我们需要创建一个新的无状态入口规则，该规则将向任何IP地址开放端口8080。为此，使用汉堡菜单导航至<strong class="iv hi"> <em class="ki">联网- &gt;虚拟云网络</em> </strong>，并在虚拟云网络列表中点击您的VCN。在<strong class="iv hi"> <em class="ki">资源</em> </strong>部分下，单击<strong class="iv hi"> <em class="ki">安全列表</em> </strong>链接，然后单击您的VCN的默认安全列表(如果您一直在关注本系列文章，您应该只会看到1个安全列表)。点击蓝色<strong class="iv hi"> <em class="ki">添加入口规则</em> </strong>按钮，添加一个新的无状态入口规则，如下图所示。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ms"><img src="../Images/fbfeb254c21a847e7b283fd1c1b612a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m-MZTXGlSKJ7XVQsTSDAnA.png"/></div></div></figure><h2 id="96e5" class="lq ko hh bd kp lr ls lt kt lu lv lw kx je lx ly lb ji lz ma lf jm mb mc lj md bi translated">在防火墙中打开端口8080</h2><p id="7429" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">您将需要在<strong class="iv hi"> <em class="ki">的防火墙中打开每个</em> </strong>的web服务器实例的8080端口。SSH到您的每个web服务器实例，并执行以下命令:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="5f0c" class="lq ko hh mj b fi mn mo l mp mq">sudo firewall-cmd --permanent --add-port=8080/tcp<br/>sudo firewall-cmd --reload</span></pre><p id="f652" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">一旦你完成了这些步骤，你就准备好继续前进了。</p><h1 id="7fb7" class="kn ko hh bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">为Web流量配置负载平衡器</h1><p id="f540" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">现在我们需要配置我们的负载平衡器来支持端口80上的web流量，并将该流量转发到我们的两个web服务器实例上的端口8080。</p><h2 id="733e" class="lq ko hh bd kp lr ls lt kt lu lv lw kx je lx ly lb ji lz ma lf jm mb mc lj md bi translated">为我们的静态Web服务器创建一个后端集</h2><p id="27e5" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">我们为静态文件web服务器编写的代码监听端口8080。我们需要创建一个后端集，专门列出这两台服务器。我们的侦听器(在下一步中创建)将使用这个后端集来路由它在端口80上获得的流量。这是在OCI环境中进行端口转发的一种方式。点击蓝色<strong class="iv hi"> <em class="ki">创建后台设置</em> </strong>按钮即可开始。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mt"><img src="../Images/8e182115e59898782b89fe0e364d4cba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D0VtyJqtaOakkl84L4_mKg.png"/></div></div></figure><p id="e971" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">将后端集命名为<strong class="iv hi"> <em class="ki"> http8080 </em> </strong>(我确实喜欢简单、明确的名称)。接受<strong class="iv hi"> <em class="ki">流量分配策略</em> </strong>和<strong class="iv hi"> <em class="ki">会话持久性</em> </strong>的默认值。在此向导中向下滚动以访问下半部分。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mu"><img src="../Images/9b725c0e9a71f9b4acda47ee47ce0f95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PqPVNJRZFL0UQdaPzUu8ww.png"/></div></div></figure><p id="4f81" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">现在，您可以为后端配置运行状况检查。将<strong class="iv hi"> <em class="ki">协议</em> </strong>设置为<strong class="iv hi"> <em class="ki"> HTTP </em> </strong>，将<strong class="iv hi"> <em class="ki">端口</em> </strong>设置为<strong class="iv hi"> <em class="ki"> 8080 </em> </strong>。将<strong class="iv hi"> <em class="ki">间隔</em> </strong>设置为<strong class="iv hi"> <em class="ki"> 100000 </em> </strong> (100秒，或者你喜欢的任何合理值)。重试次数<strong class="iv hi"><em class="ki"/></strong>为<strong class="iv hi"> <em class="ki"> 3 </em> </strong>(该值的一般经验法则)。将<strong class="iv hi"> <em class="ki">状态码</em> </strong>设置为<strong class="iv hi"> <em class="ki"> 200 </em> </strong>，并将<strong class="iv hi"> <em class="ki"> URL路径</em> </strong>设置为<strong class="iv hi"> <em class="ki"> /healthcheck </em> </strong>，因为这是我们的服务器正在监听的URL。最后，将<strong class="iv hi"> <em class="ki">响应体正则表达式</em> </strong>设置为<strong class="iv hi"> <em class="ki">健康</em> </strong>。准备好后按下<strong class="iv hi"> <em class="ki">创建</em> </strong>按钮。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mv"><img src="../Images/ec93b08632fded1f1e5f080a405b7c78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P_7NRWfdHYaJ5-YflB3R_g.png"/></div></div></figure><p id="a279" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">请稍等片刻，等待新的后端集创建完成。一旦它出现在后端集列表中，您就可以继续操作了。</p><p id="7980" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">既然您的后端集已经创建，我们需要为它分配后端。点击您新创建的<strong class="iv hi"> <em class="ki"> http8080 </em> </strong>后端集，向下滚动<strong class="iv hi"> <em class="ki">资源</em> </strong>部分。点击<strong class="iv hi"><em class="ki"/></strong>链接。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div class="er es mw"><img src="../Images/cfb0ebf031fea10e88dbebd94700608b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/1*dbi1JjwM_7JLZAG_2DAaCQ.png"/></div></figure><p id="2077" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">点击<strong class="iv hi"> <em class="ki">添加后端</em> </strong>按钮。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mx"><img src="../Images/da37e4df9b384ee0ed2033511889800e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LPdjPGDGwanKWn6JhYA2jA.png"/></div></div></figure><p id="f4fb" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">选择列出的两个web服务器，并分别将它们的<strong class="iv hi"> <em class="ki">端口</em> </strong>设置为<strong class="iv hi"> <em class="ki"> 8080 </em> </strong>。将<strong class="iv hi"> <em class="ki"> webserver2 </em> </strong>的<strong class="iv hi"> <em class="ki">权重</em> </strong>设置为<strong class="iv hi"> <em class="ki"> 2 </em> </strong>，因为它是一个更强的实例。接受其余的默认设置，滚动到底部点击蓝色的<strong class="iv hi"> <em class="ki">添加</em> </strong>按钮。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es my"><img src="../Images/c51806cf25338fe624d127af2471b1c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y8hEdS05O0QA_JnY6pZa9w.png"/></div></div></figure><h2 id="a53d" class="lq ko hh bd kp lr ls lt kt lu lv lw kx je lx ly lb ji lz ma lf jm mb mc lj md bi translated">在端口80上创建一个监听器</h2><p id="eff9" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">我们将修改现有的负载平衡器，使其也监听端口80。SSL使用端口443，但作为我们设置的一部分，我们需要向web流量开放端口80，以便我们可以向SSLforFree.com验证我们拥有我们正在请求证书的服务器。</p><p id="4b15" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">使用页面左侧的资源菜单单击<strong class="iv hi"> <em class="ki">监听器</em> </strong>链接。然后点击<strong class="iv hi"> <em class="ki">创建监听器</em> </strong>按钮开始。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mz"><img src="../Images/2f0937a9e572ed913ed90794f76cfc37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*krMeBVlxr-bRkmVXMGpImQ.png"/></div></div></figure><p id="4d85" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">将新的监听器命名为<strong class="iv hi"> <em class="ki"> listener80 </em> </strong>，并接受默认的协议和端口。选择<strong class="iv hi"> <em class="ki"> http8080 </em> </strong>后端设置并按下<strong class="iv hi"> <em class="ki">创建</em> </strong>按钮。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es na"><img src="../Images/9be6c9847d45a38328e964799fde13dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pNKnQpVjxcofFS5IcSh0OA.png"/></div></div></figure><h2 id="1062" class="lq ko hh bd kp lr ls lt kt lu lv lw kx je lx ly lb ji lz ma lf jm mb mc lj md bi translated">为端口80创建入口规则</h2><p id="f056" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">现在，我们需要允许流量到达端口80上的负载平衡器。为此，我们需要创建一个新的无状态入口规则，该规则将向任何IP地址开放端口80。为此，使用汉堡菜单导航至<strong class="iv hi"> <em class="ki">联网- &gt;虚拟云网络</em> </strong>，并在虚拟云网络列表中点击您的VCN。在<strong class="iv hi"> <em class="ki">资源</em> </strong>部分下，单击<strong class="iv hi"> <em class="ki">安全列表</em> </strong>链接，然后单击您的VCN的默认安全列表(如果您一直在关注本系列文章，您应该只会看到1个安全列表)。点击蓝色<strong class="iv hi"> <em class="ki">添加入口规则</em> </strong>按钮，添加一个新的无状态入口规则，如下图所示。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es nb"><img src="../Images/f25a8c30d5461461a267364e7de75796.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qm7yKrgOgJVJDuxDZ40quQ.png"/></div></div></figure><h2 id="4825" class="lq ko hh bd kp lr ls lt kt lu lv lw kx je lx ly lb ji lz ma lf jm mb mc lj md bi translated">测试静态文件服务器</h2><p id="edba" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">在继续之前，让我们确保新的监听器工作正常。打开两个SSH控制台，每个控制台对应一个计算实例(webserver1和webserver2)。在每个SSH控制台上，执行以下命令:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="7568" class="lq ko hh mj b fi mn mo l mp mq">cd /home/opc/staticServer<br/>node index.js &amp;</span></pre><p id="4808" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这将启动静态内容web服务器。现在回到你的网络浏览器，看看下面的网址</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="bd86" class="lq ko hh mj b fi mn mo l mp mq">http:&lt;your load balancer IP&gt;/sample.txt</span></pre><p id="167a" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">您应该会在浏览器窗口中看到sample.txt文件的内容。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es nc"><img src="../Images/2559c198d1fbb8693299fe81a7e2ed39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AZ-4-n25AVSWVagFYVRiCQ.png"/></div></div></figure><h1 id="9242" class="kn ko hh bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">注册一个DNS名称</h1><p id="2b91" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">虽然有可能为一个IP地址获得一个SSL证书，但在现实世界中这是不可能的。通常，我们需要一个域名证书。您将需要一个注册的域名，您可以修改其DNS记录以将该名称指向您的负载平衡器。我已经注册了jeffdavies.org域名，所以我只是进入我的托管服务提供商，编辑该域名的DNS记录，以指向我的负载平衡器。请注意，当您编辑域名记录时，可能需要几个小时才能看到效果。</p><p id="39e7" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">注册DNS名称并指向负载平衡器的IP地址后，您可以在浏览器中使用以下URL对其进行测试:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="2bc7" class="lq ko hh mj b fi mn mo l mp mq">http://&lt;your DNS&gt;/sample.txt</span></pre><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es nd"><img src="../Images/20f383ed0ad3bca5291354665adc256d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xf6dSwuZ6HjOre57DqamLQ.png"/></div></div></figure><h1 id="2960" class="kn ko hh bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">注册SSL证书</h1><p id="79c6" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">现在我们准备取得一些重大进展。到目前为止，所有的工作主要集中在能够提供SSLforFree.com(或您正在使用的任何SSL提供商)所需的一些静态文件，以验证我们拥有注册SSL证书的域名和服务器。它通过给我们一些静态文件放在我们的web服务器上来执行验证，这些文件应该可以通过端口80使用我们的域名获得。</p><blockquote class="ne"><p id="ebfe" class="nf ng hh bd nh ni nj nk nl nm nn jq dx translated">免责声明 : <br/>我不支持或认可SSLforFree.com。我只是在使用它，因为它是最先满足我需求的网站之一，并且在我的搜索引擎中出现得较早。</p></blockquote><p id="b8ce" class="pw-post-body-paragraph it iu hh iv b iw no iy iz ja np jc jd je nq jg jh ji nr jk jl jm ns jo jp jq ha bi translated">前往SSLforFree.com，在文本栏上输入你的域名。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es nt"><img src="../Images/7d933eb4f766e384c95185fdd82fe3eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0OtrL9x14U2Jw98mHKA7cQ.png"/></div></div></figure><p id="2412" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">点击绿色按钮，你会看到3种不同的方法来验证你的域名和服务器的所有权。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es nu"><img src="../Images/c5c909b0685b74fd42c42f071959df46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_JzI_Sbf8n1CYqZ5NwaYJA.png"/></div></div></figure><p id="923c" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">我本可以选择手动验证(DNS)方法，但是这有什么意思呢？在使用OCI时，为静态文件创建一个临时web服务器更有指导意义！</p><p id="431d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">点击<strong class="iv hi"> <em class="ki">中间的</em> </strong>手动验证按钮。现在事情变得有点复杂，我在这里的作用不是记录如何使用SSLforFree.com，所以让我总结一下您需要经历的过程:</p><ul class=""><li id="c050" class="jr js hh iv b iw ix ja jb je jt ji ju jm jv jq nv jx jy jz bi translated">下载手动验证文件</li><li id="b7b5" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq nv jx jy jz bi translated">将它们复制到SSLforFree.com说明页中命名的目录结构中</li><li id="2a7f" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq nv jx jy jz bi translated">像前面一样，使用scp命令更新2个web服务器实例上的文件。</li><li id="d156" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq nv jx jy jz bi translated">按下SSLforFree.com的“验证”按钮来验证您的文件。</li><li id="8545" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq nv jx jy jz bi translated">从SSLforFree.com下载所有SSL证书(证书、私钥和CA包)。这将作为<strong class="iv hi"> <em class="ki"> sslforfree.zip </em> </strong>下载到您的浏览器中。</li><li id="99a6" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq nv jx jy jz bi translated">解压缩<strong class="iv hi"><em class="ki">SSL forfree . zip</em></strong>文件，这样您就可以看到它包含的3个证书。</li></ul><h1 id="ef56" class="kn ko hh bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">将负载平衡器配置为使用HTTPS</h1><p id="2991" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">将负载平衡器配置为使用HTTPS非常快，但如果您是OCI的新手，这不一定直观。不过，这个过程很简单，我现在就来带您了解一下。</p><h2 id="9133" class="lq ko hh bd kp lr ls lt kt lu lv lw kx je lx ly lb ji lz ma lf jm mb mc lj md bi translated">添加入口规则</h2><p id="f908" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">添加允许所有IP地址连接到端口443的入口规则，如下所示:</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es nw"><img src="../Images/426fe56f43d718e8e8b1af03b539f882.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GDK3vyCXR2MQIrWMrDHrYg.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Open port 443 in our security list</figcaption></figure><h2 id="8ef7" class="lq ko hh bd kp lr ls lt kt lu lv lw kx je lx ly lb ji lz ma lf jm mb mc lj md bi translated">添加主机名</h2><p id="f7d1" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">现在导航到负载平衡器的仪表板页面。在左侧<strong class="iv hi"> <em class="ki">资源</em> </strong>标题下，点击<strong class="iv hi"> <em class="ki">主机名</em> </strong>链接。为您的域创建一个<strong class="iv hi"> <em class="ki">主机名</em> </strong>条目。我设置了<strong class="iv hi"> <em class="ki">名称</em> </strong>和<strong class="iv hi"> <em class="ki">主机名</em> </strong>字段来匹配我的域名。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es nx"><img src="../Images/d619aee3c3d14e93256ee5d289a18616.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0YpcuMq3vTySgop-5hctSQ.png"/></div></div></figure><h2 id="4f27" class="lq ko hh bd kp lr ls lt kt lu lv lw kx je lx ly lb ji lz ma lf jm mb mc lj md bi translated">添加证书</h2><p id="077e" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">同样位于<strong class="iv hi"> <em class="ki">资源</em> </strong>栏目下的页面是一个<strong class="iv hi"> <em class="ki">证书</em> </strong>链接。创建新证书。在你从SSLforFree.com下载的ZIP文件中有3个证书文件。您将在此对话框中使用它们。将证书命名为<strong class="iv hi"> <em class="ki"> SSL </em> </strong>并将<strong class="iv hi"><em class="ki">certificate . CRT</em></strong>文件拖放到第一个下拉框中。勾选<strong class="iv hi"> <em class="ki">指定CA证书</em> </strong>复选框，将<strong class="iv hi"><em class="ki">CA _ bundle . CRT</em></strong>文件拖拽到第二个拖拽框中。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ny"><img src="../Images/26c8568ea1ca866a65440b8f0f7aa635.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RBpqXF7BsCHteC2SW7a_Vw.png"/></div></div></figure><p id="9c3c" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">最后，选中<strong class="iv hi"> <em class="ki">指定私钥</em> </strong>复选框，将<strong class="iv hi"> <em class="ki"> private.key </em> </strong>文件拖放到第三个下拉框中。点击底部的蓝色<strong class="iv hi"> <em class="ki">添加证书</em> </strong>按钮完成该过程。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es nz"><img src="../Images/edf3a294801f4b183476636a1f05ac9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ec9nnvyNGxcDm1lSvsDWOg.png"/></div></div></figure><p id="0f74" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">现在我们准备添加我们的HTTPS听众！在<strong class="iv hi"> <em class="ki">资源</em> </strong>部分下点击<strong class="iv hi"> <em class="ki">监听器</em> </strong>链接，创建一个新的监听器。将侦听器命名为HTTPS，并选择您刚才创建的主机名。选中<strong class="iv hi"> <em class="ki">使用SSL </em> </strong>复选框，并且<strong class="iv hi"> <em class="ki">端口</em> </strong>字段应自动更改为443。对于后端集，选择侦听端口3000的集，而不是侦听端口8080的集！为什么？因为我们安装在端口8080上的web服务器只是为了帮助我们验证SSLforFree.com对该域的所有权而创建的，出于安全原因，我们将很快删除它。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es nz"><img src="../Images/398cafccfe196d3b74c224ebca381d29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4J-r5pQZ32tWeV_1eqFVvg.png"/></div></div></figure><p id="3f0b" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">点击底部蓝色的<strong class="iv hi"> <em class="ki">创建</em> </strong>按钮创建监听器。</p><h2 id="3e3c" class="lq ko hh bd kp lr ls lt kt lu lv lw kx je lx ly lb ji lz ma lf jm mb mc lj md bi translated">测试HTTPS</h2><p id="9d1e" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">测试服务器非常简单。打开浏览器窗口以:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="9560" class="lq ko hh mj b fi mn mo l mp mq">https://&lt;yourdomain name&gt;</span></pre><p id="c0ed" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">您将看到显示的<strong class="iv hi"> <em class="ki">健康</em> </strong>消息。注意地址栏中的小锁图标，确认HTTPS正在使用中。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div class="er es oa"><img src="../Images/b5a32c6f144252311df35b57f5a784cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*Zdjmu5R1tnA4XdTzQtrznA.png"/></div></figure><h1 id="21f4" class="kn ko hh bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">安全，安全，安全</h1><p id="bae7" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">现在，我们已经安装了HTTPS，并且运行良好。然而，我们仍然有一些清理工作要做。那些在端口8080上运行的服务器是一个安全隐患。我们不需要他们运行，他们是一个安全风险，因为他们会盲目地提供你要求的任何文件。它们可能都以位置<strong class="iv hi"><em class="ki">/home/OPC/static server</em></strong>为前缀，但是我不认为黑客会使用一些文件路径欺骗来找到解决方法。最好是我们关闭整个服务器，只在端口3000上运行web服务器。</p><p id="0d36" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">打开到每个计算机实例的SSH连接，并停止每个web服务器。有很多方法可以做到这一点，但是我建议使用<strong class="iv hi"> <em class="ki"> ps </em> </strong>命令来查看每个实例中运行在8080上的服务器的进程id，然后使用<strong class="iv hi"> <em class="ki"> kill </em> </strong>命令来停止该进程。以下是我使用的一些命令示例:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="e1f9" class="lq ko hh mj b fi mn mo l mp mq">ps -aux | grep node</span></pre><p id="3943" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这在我的一台服务器上返回了以下响应:</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ob"><img src="../Images/4f123f805acdacdc99fbdb1729084ca7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6xXa_y4anuL3xcvEuOOW3A.png"/></div></div></figure><p id="aa70" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">由此我可以看出我需要杀死的进程的ID为15093(运行<strong class="iv hi"> <em class="ki">节点index.js </em> </strong>的那个来自<strong class="iv hi"> <em class="ki"> opc </em> </strong>用户)。所以我把它插入命令行:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="a891" class="lq ko hh mj b fi mn mo l mp mq">kill 15093</span></pre><p id="81a4" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这将结束实例上的web服务器。现在我们需要去掉端口80上的监听器，它将信息路由到那些(现在已经不存在的)web服务器。导航到您的负载平衡器并删除端口80的监听器。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es oc"><img src="../Images/62396ccaee226ede434ecdeeacaf7356.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qvfr4OqeYouJWtQQAo5Fsg.png"/></div></div></figure><p id="3ce5" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">同样，删除为<strong class="iv hi"> <em class="ki"> http8080 </em> </strong>设置的后端。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es od"><img src="../Images/9e23cec84746ac0e4ed377e6346c5d22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MxbyzYHCOM_oRfN4dxGjoQ.png"/></div></div></figure><p id="b780" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">最后，不需要允许直接访问运行在端口3000上的web服务器。所以我们也可以删除那个监听器。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es oe"><img src="../Images/22ffac85bff78ee915e40e5d6d195ccf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MQmshDLtLsZ2jbyHAPva6g.png"/></div></div></figure><p id="b743" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">请记住，我们还在每个计算机实例的防火墙中打开了端口8080。是时候堵住我们防火墙的漏洞了。SSH到每个实例，并执行以下命令:</p><pre class="me mf mg mh fd mi mj mk ml aw mm bi"><span id="fa64" class="lq ko hh mj b fi mn mo l mp mq">sudo firewall-cmd --permanent --remove-port=8080/tcp</span><span id="da69" class="lq ko hh mj b fi mr mo l mp mq">sudo firewall-cmd --reload</span></pre><p id="fb25" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">此外，在安全列表中，删除允许访问端口8080的规则。然而，在您的VCN的安全列表页面中，编辑端口3000的入口规则。将源CIDR地址设置为您的负载均衡器的IP地址，并附加“<strong class="iv hi"> <em class="ki"> /32 </em> </strong>”。这将锁定端口3000，以便只有负载平衡器可以访问它。我们不需要从外部直接访问我们各自的web服务器。</p><figure class="me mf mg mh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es of"><img src="../Images/94dc7ff16d7a018462e252a82f6d6800.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KoyRXIj7yypRCZiNJGB-SA.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Pardon my crude efforts at redaction.</figcaption></figure><p id="56e1" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">现在我对安全方面的事情感觉好一点了。没有什么比关闭港口更能让我睡得好一点了。</p><h1 id="bcda" class="kn ko hh bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">概括起来</h1><p id="6b26" class="pw-post-body-paragraph it iu hh iv b iw ll iy iz ja lm jc jd je ln jg jh ji lo jk jl jm lp jo jp jq ha bi translated">现在我们已经让HTTPS在我们的web服务器上工作了，我们可以继续做更大更好的事情，比如认证用户，这是本系列的下一篇文章。如果你觉得这很有帮助，请一定给我发一个掌声！感谢阅读。</p></div></div>    
</body>
</html>