# 改善用户体验:解决 Pinterest 的核心数据不一致问题

> 原文：<https://medium.com/pinterest-engineering/improve-user-experience-solving-core-data-inconsistencies-at-pinterest-d4b64b5d79a1?source=collection_archive---------2----------------------->

黄之陈|软件工程师，核心服务

# 背景

![](img/8b29be1673d643e82592cfa511a0aaae.png)

随着 Pinterest 的快速增长，挑战自然会出现。作为一名品酒师，你可能已经注意到了一些你的数据看起来不“正确”的情况，并且你可能因此有过负面的经历。例如:如左图所示，您个人资料中的“引脚数”显示的引脚数不正确。

我们称这些引用完整性场景为“数据不一致”，因为存储在一个后端的数据与存储在另一个后端的数据不匹配。如你所见，这些不一致直接影响了 Pinners 的体验，因为我们向他们展示了过时的内容。此外，这些不一致对我们团队的维护成本贡献很大。如果 Pinner 发现他们的数据是错误的，他们可能会向我们的运营团队报告。当运营团队无法使用常规运营解决这些问题时，他们会为我们创建 bug 单。为了改善用户体验，以及减少团队的维护工作，我们希望建立一个工具，自动检测和修复这些不一致。

# 核心模型

这个项目着重于解决我们的三个核心模型之间的不一致性:引脚、电路板和引脚。

我们使用 MySQL 作为主要的数据存储库来存储 Pinners 创建的内容。为了存储上亿个引脚、电路板和其他数据，许多 MySQL 数据库实例形成了一个 MySQL 集群，该集群被分割成多个逻辑碎片，以便更有效地管理和服务数据。所有数据都分散在这些碎片中。

下面是我们存储在 MySQL 中的这三个模型之间的简化关系:

![](img/66293a4344f4a2803f06f641b79b6913.png)

# 挑战

不幸的是，由于在多个流中异步处理数据，数据不一致不可避免地被带入我们的数据存储。

我们的数据库是分片的，一些写入是异步的，这意味着有时我们不能在一个事务中完成更新。例如，当您创建一个管脚时，它应该插入到管脚表、管脚-管脚关系表和板-管脚关系表中。理想情况下，我们在一个事务中完成这三个更新，但是有时我们想要更新的三个表不在同一个 shard 中，或者这三个更新是异步的。如果我们成功地写入一个表，而其他表失败，就会发生不一致。

# 解决办法

## 体系结构

![](img/cd2c305efbfb9af9d4121dd74e202680.png)

我们希望通过构建一个自动检测和自动解决数据不一致的工具来解决这个问题。该工具最重要的部分由两部分组成:

1.  粉红框中显示的存在性验证作业用于检查数据库中数据的存在性。存在性检查作业将在每次写入三个核心对象(引脚、电路板和引脚)时触发。
2.  橙色框中显示的 Stat 验证作业用于检查 stats 的准确性。其中一项统计检查工作会检查使用者统计资料，其中会储存 Pinner 公用 pin 的数目。另一个检查电路板统计数据，存储电路板的管脚数。

存在检查作业比统计检查作业更轻，因为它们只需要查询数据是否在表中。统计检查工作需要更多的计算，因为他们需要获取准确的数据，因为我们正在验证一个特定的数字。例如，当检查电路板统计数据时，我们需要获得电路板的所有引脚，以便计算这个数字。所有这些作业都是使用[pinlate](/@Pinterest_Engineering/pinlater-an-asynchronous-job-execution-system-b8664cb8aa7d)的异步作业，这是 Pinterest 内部作业调度和执行工具。与我们现有的其他作业调度工具相比，Pinlater 是最轻量级的，它提供了高吞吐量和可调整的出列率。除此之外，入队到出队的延迟非常低，接近实时。

如上图所示，整个流程是:

1.  当我们的服务检测到核心对象的写操作时，这个工具被触发，并且它将代理作业与一些参数(例如唯一的对象 id、操作类型和附加参数)一起排队。
2.  然后，此代理作业将使其中一个存在检查作业排队。
3.  如果创建了 Pin，boardstats 应增加 1。如果 Pin 被删除，boardstats 应减少 1。也就是说，一些操作可能会影响统计，所以我们可能也想将统计作业排队。
4.  一旦这些异步作业出列并执行，作业逻辑将检查数据库和缓存，以确保数据一致。
5.  如果它检测到任何不一致，它将修复不一致，并将作业重新排队以再次检查，以确保它是一致的。

## 延迟和有限作业执行

值得注意的一点是，工作被延迟执行。为什么？首先，某些作业会在更新之前排队，因为我们希望确保即使更新因数据库问题或网络故障而失败，这些作业也会排队。因此，作业需要等待更新被执行。第二，数据库更新后，可能会有一些异步工作要做，比如清理缓存或删除引脚(如果是板删除)。此外，不同的作业可能有不同的延迟时间。

另一个重要部分是有限的统计作业执行。首先，这是什么？如前所述，如果创建或删除了一个 Pin，boardstats 将被修改，因此，每个 Pin 的创建或删除都将触发一次 board stats 检查作业的可能排队。如果您删除了一个包含 100 个引脚的板，该 board_id 的板统计作业将排队 100 次。这是对计算资源的浪费，并给我们的服务带来额外的负载，因为每个作业都将在线查询数据。为了解决这个问题，我们使用 memcache 来存储已经入队的 ID，并检查 ID 是否在缓存中。如果它在缓存中，这意味着已经有一个作业排队，我们不需要再次排队。当统计信息检查作业出队并执行时，它将删除缓存条目，以便下次它可以再次入队。即使它未能删除缓存，缓存也有一个 TTL，因此 ID 一旦过期就会被删除。

# 结果

我们已经有六个月没有收到任何客户支持票了，因为不一致的问题已经被自动解决了。此外，我们系统中所有新出现的不一致问题都在 24 小时内得到了解决。

# 感谢

感谢卡皮尔·巴贾杰、黎齐和 Pinterest 核心服务团队的其他成员！