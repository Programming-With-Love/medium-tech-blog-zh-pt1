<html>
<head>
<title>Pinterest Visual Signals Infrastructure: Evolution from Lambda to Kappa Architecture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pinterest视觉信号基础设施:从Lambda到Kappa架构的演变</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/pinterest-visual-signals-infrastructure-evolution-from-lambda-to-kappa-architecture-f8f58b127d98?source=collection_archive---------1-----------------------#2020-11-17">https://medium.com/pinterest-engineering/pinterest-visual-signals-infrastructure-evolution-from-lambda-to-kappa-architecture-f8f58b127d98?source=collection_archive---------1-----------------------#2020-11-17</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="bd41" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Ankit Patel |内容获取和媒体平台软件工程师</p><p id="b03b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">随着对来自Pinterest庞大视觉数据集的机器学习信号的需求不断增长，我们决定进一步研究我们产生和服务这些信号的基础设施。我们特别感兴趣的几个参数是信号可用性、基础设施复杂性和成本优化、技术集成、开发速度和监控。在本帖中，我们将描述我们从<a class="ae jc" href="https://hazelcast.com/glossary/kappa-architecture/" rel="noopener ugc nofollow" target="_blank"> Lambda架构</a>到受<a class="ae jc" href="https://milinda.pathirage.org/kappa-architecture.com/" rel="noopener ugc nofollow" target="_blank"> Kappa架构</a>启发的新型实时信号基础设施的旅程。</p><h1 id="9323" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">背景</h1><p id="c8bd" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">为了理解现有的视觉信号基础设施，我们需要理解Pinterest的一些基本内容处理系统。Pinterest的内容获取和媒体平台，以前称为视频和图像平台(VIP)，负责摄取、处理和提供应用程序每个表面上的所有Pinterest内容。我们每天都在大规模地摄取媒体。这篇文章不会详细介绍摄取和服务部分，它将主要关注处理部分，因为这是最神奇的地方。</p><p id="8b64" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">媒体通过50个不同的管道摄入。管道是VIP系统中的名称空间，例如Pinner上传的内容、抓取的图像、购物图像、视频关键帧、用户个人资料图像等。每个管道映射到为其服务的用例定制的定制媒体处理配置。</p><p id="5a75" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当我们开始构建我们的视觉信号处理基础设施时，我们利用了这种现有的命名空间理念，并围绕管道划分了我们的视觉信号。Pinterest自主研发的信号处理和服务技术栈名为Galaxy。Galaxy中以不同实体id为关键字的名称空间称为联接或Galaxy。每个VIP管道都被映射到对应的星系。有时我们将多个相似的管道组合成一个星系，因为它们关系密切。</p><h1 id="c4c0" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">λ架构</h1><p id="abb7" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">直到最近，我们还在使用下图所示的Lambda架构来计算媒体内容中的视觉信号。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kg"><img src="../Images/19c712473a307880111b4486762303c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SoHh7Z-xkSKyVdi3"/></div></div></figure><p id="60a4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正如您在上图中看到的，这个架构有两种模式:在线和离线。先来讨论下线下架构。</p><ol class=""><li id="e471" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated">计划运行夜间工作流(基于Hadoop的map-reduce作业)。我们计算特定日期的增量唯一映像签名，并创建一个新分区。</li><li id="31a7" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">然后，我们创建成批的图像签名，并对处理这些批处理的PinLater作业进行排队。</li><li id="fb6d" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">我们用信号计算所需的ML模型构建了一个GPU集群，然后开始处理PinLater作业。这是一个昂贵的集群。</li><li id="d049" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">我们从亚马逊S3下载图像，对其运行模型推理，然后将输出存储在S3。然后，我们将降低GPU集群的速度，以优化EC2支出。</li><li id="a3a1" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">该信号以带Protobuf编码值的分隔字节格式生成。</li><li id="198a" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">我们启动了一个工作流，将这个输出转换成等价的Apache Thrift编码，因为Pinterest大量使用Thrift作为其网络格式和数据存储。</li><li id="8d82" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">节俭输出存储在镶木地板柱状蜂房表。下游批处理客户端使用此输出。</li><li id="7da1" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">为了支持实时RPC客户端，我们有一个最终的工作流，将配置单元分区上传到Rockstore键值对数据库。</li><li id="024b" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">Galaxy Signal Service提供了一个RPC API来为我们的在线客户端从Rockstore中查找这些信号。</li></ol><p id="2d31" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正如你所看到的，在上面的设计中有很多移动的部分。尽管随着时间的推移，这些流程变得更加成熟和稳定，但是VIP团队的工程师在工作时经常会遇到问题。一些最大的问题是:</p><ul class=""><li id="7923" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb lg ky kz la bi translated">依赖于其他工作流的工作流</li><li id="3a0a" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb lg ky kz la bi translated">消费者必须等待24小时才能收到信号</li><li id="9820" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb lg ky kz la bi translated">应用程序逻辑问题极难调试</li><li id="54af" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb lg ky kz la bi translated">粒度重试是不存在的，要么全有，要么全无</li><li id="141c" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb lg ky kz la bi translated">由于这些系统的性质造成的延迟</li></ul><p id="250f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">随着我们继续构建由这些机器学习信号驱动的其他功能，更快地产生这些信号的需求成为了整个公司的优先事项。这就是在线模式发挥作用的地方:</p><ol class=""><li id="21d8" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated">我们实时为每个图像签名创建PinLater作业。</li><li id="9a4d" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">在这项工作中，我们调用运行机器学习模型推理服务的GPU集群来计算信号，并将其结果直接存储到基于键值对的Rockstore数据库中。GSS(银河信号服务)然后将服务这个信号。</li><li id="8acd" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">然后，我们通过Kafka发布一个事件，通知下游消费者信号的可用性。</li><li id="c416" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">下游客户端使用该事件，并实时从GSS获取信号。</li></ol><p id="d68b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">VIP并不是Pinterest中唯一被这种新的信号处理范式吸引的团队。其他团队对实时计算信号的想法感到兴奋。与基于hadoop的工作流的黑匣子相比，它提供了对信号生成的更多可见性。这种方法有多种好处，例如:</p><ul class=""><li id="53e9" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb lg ky kz la bi translated">更好的开发者体验</li><li id="9e0d" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb lg ky kz la bi translated">更容易调试、测试和部署变更</li><li id="df7c" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb lg ky kz la bi translated">粒度重试</li><li id="f792" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb lg ky kz la bi translated">低延迟信号</li></ul><p id="b0d8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，它也有它的缺点。主要的是:</p><ul class=""><li id="dbf8" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb lg ky kz la bi translated">像group bys和signal joins这样的复杂操作是不可能用像Pinlater这样简单的事件驱动处理框架来完成的。我们需要一个健壮的流处理框架，比如Apache Flink。</li><li id="3b22" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb lg ky kz la bi translated">运行重复GPU集群的额外成本，该集群持续处理与批处理流水线相同的管脚。</li><li id="9afc" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb lg ky kz la bi translated">没有解决共同需求的共享基础设施。</li></ul><h1 id="0534" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">卡帕建筑</h1><p id="4009" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">最后，Pinterest的信号平台团队看到了一个解决所有信号开发人员这一问题的机会，并建立了下一个版本的信号开发基础设施，称为“近实时星系”，或简称为NRTG。选择的技术是Apache Kafka和Apache Flink。Flink似乎是专门为解决上述问题而设计的。鉴于Signal Platform团队已经有了一个使用Galaxy Dataflow APIs在批处理技术上构建信号的框架，将其扩展到流技术上可以说是最佳的前进方式，而不会导致大量的重构、重写或重新发明。</p><p id="6c6d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">VIP团队决定成为该计划的早期采用者之一，因为我们的媒体信号是Pinterest整个信号树中最上游的一些信号，所以在平台仍在建设中时，它自然是最容易装载的。我们找出了想要试验的信号，并开始了这项任务。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kg"><img src="../Images/f9dda9bcedc7af6a6b694be0b4de834f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hXS08XluB7Peg3Aj"/></div></div></figure><p id="5eeb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">它的要点非常简单:您可以编写一个简单的flink作业来计算流中的信号(在Apache Flink上)。NRTG将通过利用标准设计模式和注释使这个过程变得简单快捷。</p><p id="6208" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">基于这些注释，上面提到的NRTG框架完成了对信号开发人员隐藏的大部分繁重工作。这个中间件层管理配置和到底层本地Flink的映射。这使得signal开发速度非常快，因为开发人员不需要详细学习Flink，因为他们已经熟悉这些注释。Pinterest的Xenon (Flink)平台团队提供部署和维护Flink应用程序的基础设施能力。</p><p id="5468" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦我们加入NRTG，我们希望关闭现有的批处理工作流设置。有许多消费者批量消费这些信号。我们必须从我们的流媒体渠道为他们提供一个可行的解决方案。为了模拟我们信号的每日配置单元表，我们编写了一个简化的工作流，该工作流获取KVStore的每日转储，并将其转换为现有的配置单元输出。重新计算信号值不需要GPU计算，数据只是在流中计算，通过每日转储移动到S3，并过滤为正确的格式。这不仅让我们节省了GPU成本，还将复杂的工作流设计简化为简单的数据转换工作。随着FlinkSQL的积极开发，我们将能够完全将离线部分从Spark/Hadoop迁移到Flink。</p><h1 id="9459" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="e85d" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">迁移到这种新的快速信号基础设施是Pinterest在信号生成方面美好未来的开始。它允许信号开发人员以更少的学习曲线快速构建信号。底层Flink功能也支持高级信号设计。尽管批量回填支持是NRTG正在进行的一项工作，信号生产者需要调整输出以避免对消费者造成干扰，但其好处仍然超过了现有lambda基础设施中复制的成本。NRTG团队已经在路线图中提供了这一点，通过将Hive集成作为框架的一部分来提供端到端支持。在一个平台下实现信号的端到端生命周期将极大地有利于Pinterest不同团队的创新和产品化想法。它降低了基础架构的复杂性，我们能够在GPU和其他计算资源上实现成本优化。我们希望Pinterest的其他团队也能步我们的后尘，通过迁移到一个更简单、更健壮的架构来提高他们的开发速度，就像这篇博客中描述的那样。</p><p id="61fe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个项目是Pinterest多个团队的共同努力:视频和图像平台(VIP)、近实时星系(NRTG)、Xenon、Hermes、Rockstore和视觉搜索。</p></div></div>    
</body>
</html>