# 排出与 Oracle 的死连接。网络快速连接故障转移

> 原文：<https://medium.com/oracledevs/drain-dead-connections-with-oracle-net-fast-connection-failover-9de5c11ec484?source=collection_archive---------0----------------------->

![](img/cb5e9b8e1000bb9de062a11897f4ea25.png)

一个常见的高可用性(HA)应用程序难题发生在数据库离线进行修补或维护时。最终用户可能会遇到 ORA-03113(通信通道上的文件结束)或类似错误，即使在数据库重新联机后也是如此。发生此错误的原因是，当数据库脱机时，它的连接变成孤立的，并保留在池中。由于应用程序无法区分无效连接和有效连接，这些“死”连接可能会被无意中分配给最终用户。

典型的方式。NET 管理员解决这个问题的方法是通过 ODP.NET clear pool()或 ClearAllPools()方法重置池，或者在数据库脱机时重新启动应用程序。另一种方法是 for。NET 开发人员启用 ODP.NET 验证连接池设置。所有这些解决方案都有明显的缺点。清除池或重新启动应用程序会删除有效和无效的连接，并影响服务级别，直到池重置。对于每次连接尝试，连接验证都需要额外的数据库往返。这些高可用性解决方案牺牲了性能并增加了管理员开销，以解决最终用户接收到死连接的问题。首选的解决方案是让数据提供者自动检测数据库何时脱机，然后主动删除无效的连接。这将确保最终用户不再被分配死连接，同时应用程序保持其服务水平。

当 ODP.NET 使用 Oracle 快速连接故障切换(FCF)时，这是可能的。当数据库资源(如 Oracle Real Application Clusters 服务、服务成员、节点或 Data Guard 数据库)出现故障时，FCF 会通过快速应用程序通知(FAN)通知 ODP.NET 连接池，以便主动快速地仅删除被切断的连接。不需要等待 TCP 超时，因为对于许多应用程序来说，这需要太长时间。有效的连接不会受到影响，继续为最终用户提供服务。随着被切断的连接从池中排出，没有机会分配无效的连接。最终用户继续他们的工作，并不知道发生了任何数据库故障或维护。具体来说，ODP.NET·FCF 做了以下工作:

*   主动从池中排出无效连接
*   强制等待关闭的数据库响应的线程退出现有调用，以避免挂起。当该连接返回到池中时，与该连接相关联的任何资源都将被释放，因为它不再有效。
*   如果断开的连接删除导致连接计数低于最小池大小，则在下一次连接请求时，建立到剩余 Oracle 数据库实例的新连接。

除了只移除被切断的连接，ODP.NET·FCF 还在几个方面有所创新。

1.  它提供了端到端的高可用性解决方案。它不仅是单纯的数据库高可用性，也不是单纯的应用程序高可用性。
2.  运行时不需要管理员手动干预。NET 代码更改在设计时是必需的。管理员只需在数据库服务器上为他们现有的应用程序启用该功能。就是这样！

默认情况下，ODP.NET 会自动启用 FCF。如果在 ODP.NET 连接字符串中关闭了连接池或 FCF (HA 事件属性),应用程序可以禁用 FCF。以下是启用 FCF 的默认值:

*   `Pooling=true`
*   `HA Events=true`

这就是现有的 ODP.NET 应用程序如何在不修改代码或做很小改动的情况下采用 FCF。

ODP.NET 核心、管理型 ODP.NET 和非管理型 ODP.NET 均提供 FCF。它可以与当前支持 FAN 的任何数据库服务器版本以及专用的 Oracle 自治数据库一起使用。要了解关于和范的更多信息，请阅读关于这些主题的文档。

ODP。NET FCF 为计划内停机和计划外停机场景提供了真正的全包式端到端高可用性解决方案，使其易于集成到现有应用中。