<html>
<head>
<title>Today I Learned: Beware with pointer in Golang!!!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">今天我学到了:小心戈兰语的教鞭！！！</h1>
<blockquote>原文：<a href="https://medium.easyread.co/today-i-learned-beware-with-pointer-in-golang-7764f2060a93?source=collection_archive---------4-----------------------#2018-08-09">https://medium.easyread.co/today-i-learned-beware-with-pointer-in-golang-7764f2060a93?source=collection_archive---------4-----------------------#2018-08-09</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="dd73" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">今天在Golang中自定义JSON编组时的错误</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/425eb7ab9083ea3aaaeea2821501deb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BXubFQ9P5SvJr2Ob-8e9dw.png"/></div></div></figure><p id="7fd6" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">所以，今天的bug和要学习的一课是关于非/指针接收器函数，它发生在我为我的struct做定制编组JSON的时候。我被困了几个小时来解决这个问题。<br/>场景是，我有一个结构，比如说一个<code class="fe lk ll lm ln b">ClassRoom</code>结构，而<code class="fe lk ll lm ln b">ClassRoom</code>有很多学生。每一个学生都按照他们的分数或者别的什么排名上升，不管它是什么，:D，这只是一个例子来描述我们真实的案例结构。类似，只是名称不同。</p><pre class="kd ke kf kg gt lo ln lp lq aw lr bi"><span id="645a" class="ls lt in ln b gy lu lv l lw lx">type ClassRoom struct {<br/> Name     string          `json:"name"`<br/> Students map[int]Student `json:"students"`<br/>}<br/>type Students struct {<br/> Name string `json:"name"`<br/> Age  int    `json:"age"`<br/>}</span></pre><p id="c8ad" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">对于这个结构，如果我们将它编组到JSON，结果将如下所示:</p><pre class="kd ke kf kg gt lo ln lp lq aw lr bi"><span id="e720" class="ls lt in ln b gy lu lv l lw lx">{<br/>  "name": "D3TI2-Classmate",<br/>  "students": {<br/>    "1": {<br/>      "name": "Iman Tumorang",<br/>      "age": 17<br/>    },<br/>    "2": {<br/>      "name": "Christin Tumorang",<br/>      "age": 18<br/>    },<br/>    "3": {<br/>      "name": "Idola Manurung",<br/>      "age": 18<br/>    }<br/>  }<br/>}</span></pre><p id="e9af" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">但是对于API的要求，我们希望JSON结果没有学生的排名。我们只想看起来像这样:</p><pre class="kd ke kf kg gt lo ln lp lq aw lr bi"><span id="b9b2" class="ls lt in ln b gy lu lv l lw lx">{<br/>  "name": "D3TI2-Classmate",<br/>  "students": [<br/>    {<br/>      "name": "Iman Tumorang",<br/>      "age": 17<br/>    },<br/>    {<br/>      "name": "Christin Tumorang",<br/>      "age": 18<br/>    },<br/>    {<br/>      "name": "Idola Manurung",<br/>      "age": 18<br/>    }<br/>  ]<br/>}</span></pre><p id="74ee" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">嗯，根据我的经验，在Golang做这件事是很容易的。我们只是创建一个以<code class="fe lk ll lm ln b">ClassRoom</code>为接收者的函数，其名称与<code class="fe lk ll lm ln b"><a class="ae ly" href="https://golang.org/src/encoding/json/encode.go?s=8333:8392#L211" rel="noopener ugc nofollow" target="_blank">Marshaler</a></code>接口中的函数名称相同</p><pre class="kd ke kf kg gt lo ln lp lq aw lr bi"><span id="e7dd" class="ls lt in ln b gy lu lv l lw lx">func (s ClassRoom) <strong class="ln io">MarshalJSON</strong>() ([]byte, error) {<br/> arrStudent := []Student{}<br/> arrKey := []int{}<br/> for k, _ := range s.Students {<br/>  arrKey = append(arrKey, k)<br/> }<br/> sort.Ints(arrKey)</span><span id="09fa" class="ls lt in ln b gy lz lv l lw lx">for _, pos := range arrKey {<br/>  arrStudent = append(arrStudent, s.Students[pos])<br/> }<br/> return json.Marshal(struct {<br/>  Name     string    `json:"name"`<br/>  Students []Student `json:"students"`<br/> }{<br/>  Name:     s.Name,<br/>  Students: arrStudent,<br/> })<br/>}</span></pre><p id="e672" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">就这么简单。但是当我试着测试它的时候。JSON结果不像我们预期的那样正确。我在这个问题上被卡住了几个小时，:D，我真傻😅</p><h1 id="d687" class="ma lt in bd mb mc md me mf mg mh mi mj jt mk ju ml jw mm jx mn jz mo ka mp mq bi translated"><strong class="ak">发布</strong></h1><p id="fb82" class="pw-post-body-paragraph ko kp in kq b kr mr jo kt ku ms jr kw kx mt kz la lb mu ld le lf mv lh li lj ig bi translated">在代码修复之前，代码更像下面这样。如果我们看到这里，它就像这里没有任何问题。但结果是错误的。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mw mx l"/></div></figure><h1 id="e699" class="ma lt in bd mb mc md me mf mg mh mi mj jt mk ju ml jw mm jx mn jz mo ka mp mq bi translated">固定</h1><p id="fd06" class="pw-post-body-paragraph ko kp in kq b kr mr jo kt ku ms jr kw kx mt kz la lb mu ld le lf mv lh li lj ig bi translated">在厌倦了寻找解决方案之后，当我偶然用一个指针对象调用JSON marshall时，我发现了这个问题。</p><pre class="kd ke kf kg gt lo ln lp lq aw lr bi"><span id="8a30" class="ls lt in ln b gy lu lv l lw lx">sample := <strong class="ln io">&amp;</strong>ClassRoom{ // <em class="my">See the ampersand symbol</em> "<strong class="ln io">&amp;</strong>"<br/>  Name:     "D3TI2-Classmate",<br/>  Students: students,<br/> }<br/>_,_= json.Marshal(sample)</span></pre><p id="04c9" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这就是问题所在。在我的自定义MarshalJSON中，我让接收器是一个指针。因此，如果我试图封送一个非指针对象，我的自定义MarshalJSON将不会被调用。但是，如果我封送一个非指针对象，它将成功封送。</p><p id="a408" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">总结一下:<br/>如果我用一个<strong class="kq io">指针</strong>接收器来定制MarshalJSON</p><pre class="kd ke kf kg gt lo ln lp lq aw lr bi"><span id="75a3" class="ls lt in ln b gy lu lv l lw lx">func (s <strong class="ln io">*</strong>ClassRoom)MarshalJSON() ([]byte, error){<br/>  // Other codes<br/>}</span></pre><p id="13c1" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后当我想封送对象时，我必须将一个<strong class="kq io">指针</strong>对象传递给<code class="fe lk ll lm ln b">json.Marhsal</code></p><pre class="kd ke kf kg gt lo ln lp lq aw lr bi"><span id="8d16" class="ls lt in ln b gy lu lv l lw lx">sample := <strong class="ln io">&amp;</strong>ClassRoom{ // <em class="my">See the ampersand symbol</em> "<strong class="ln io">&amp;</strong>"<br/>  Name:     "D3TI2-Classmate",<br/>  Students: students,<br/> }<br/>_,_= json.Marshal(sample)</span></pre><p id="9d02" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">对于<strong class="kq io">非指针(值)</strong>接收器也是如此。</p><p id="a8de" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果我用一个<strong class="kq io">非指针(值)</strong>接收器来定制MarshalJSON</p><pre class="kd ke kf kg gt lo ln lp lq aw lr bi"><span id="0b69" class="ls lt in ln b gy lu lv l lw lx">func (s ClassRoom)MarshalJSON() ([]byte, error){<br/>  // Other codes<br/>}</span></pre><p id="5a79" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后当我想要封送对象时，我必须传递一个<strong class="kq io">非指针(值)</strong>对象给<code class="fe lk ll lm ln b">json.Marhsal</code></p><pre class="kd ke kf kg gt lo ln lp lq aw lr bi"><span id="3326" class="ls lt in ln b gy lu lv l lw lx">sample := ClassRoom{ // <em class="my">Without the ampersand symbol</em> "<strong class="ln io">&amp;</strong>"<br/>  Name:     "D3TI2-Classmate",<br/>  Students: students,<br/> }<br/>_,_= json.Marshal(sample)</span></pre></div><div class="ab cl mz na hr nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ig ih ii ij ik"><p id="27a9" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">嗯，这对我来说是一个非常愚蠢的问题，因为它真的让我愤怒了几个小时。这让我在决定使用<strong class="kq io">指针</strong>还是<strong class="kq io">非指针</strong>接收器时更加谨慎。</p></div></div>    
</body>
</html>