<html>
<head>
<title>Introduction to Drone.io CI/CD platform Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Drone.io CI/CD平台简介第3部分</h1>
<blockquote>原文：<a href="https://medium.com/globant/introduction-to-drone-io-ci-cd-platform-part-3-15a3831cabf2?source=collection_archive---------3-----------------------#2022-09-05">https://medium.com/globant/introduction-to-drone-io-ci-cd-platform-part-3-15a3831cabf2?source=collection_archive---------3-----------------------#2022-09-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="er es ie"><img src="../Images/bec617d3a3a6b3cfd8801cb5db976884.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/0*cxX3whDsn3bOpcUe"/></div></figure><h1 id="ae80" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">介绍</h1><p id="4118" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">这是这个“Drone.io CI/CD简介”系列的第三部分，也是最后一部分。在这最后一篇文章中，我们将讨论一些最后的重要主题来完成无人机概述，例如:</p><ul class=""><li id="86cb" class="kh ki hh jl b jm kj jq kk ju kl jy km kc kn kg ko kp kq kr bi translated">无人机命令行界面</li><li id="532a" class="kh ki hh jl b jm ks jq kt ju ku jy kv kc kw kg ko kp kq kr bi translated">库伯内特的秘密整合</li><li id="4f9d" class="kh ki hh jl b jm ks jq kt ju ku jy kv kc kw kg ko kp kq kr bi translated">构建促销和回滚</li><li id="a98c" class="kh ki hh jl b jm ks jq kt ju ku jy kv kc kw kg ko kp kq kr bi translated">如何进行调试</li></ul><p id="a497" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">与前几篇文章一样，我们将演示所有这些功能，并提供如何设置它们的详细说明和动手实验。</p><h1 id="ac7f" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">先决条件</h1><p id="867e" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">在继续之前，请记住浏览之前的文章(第<a class="ae la" rel="noopener" href="/globant/introduction-to-drone-io-ci-cd-platform-1d43f8bc1728">部分第一篇</a>和第<a class="ae la" rel="noopener" href="/globant/introduction-to-drone-io-ci-cd-platform-part-2-fa9fdc6a3659">两篇</a>)，设置并运行实验室，以便能够执行本文中的任务。简单回顾一下，如果您一直在笔记本电脑上阅读这些文章系列，并且已经完成了所有必要的设置，并且想要让它运行起来以阅读本文，您需要:</p><ul class=""><li id="f6f2" class="kh ki hh jl b jm kj jq kk ju kl jy km kc kn kg ko kp kq kr bi translated">启动<em class="lb"> ngrok </em>并记下分配的主机名。</li><li id="5835" class="kh ki hh jl b jm ks jq kt ju ku jy kv kc kw kg ko kp kq kr bi translated">转到GitHub OAuth应用程序设置页面，用新的ngrok主机名更新<em class="lb">主页URL </em>和<em class="lb">应用程序回调URL </em>。</li><li id="fa84" class="kh ki hh jl b jm ks jq kt ju ku jy kv kc kw kg ko kp kq kr bi translated">转到存储库<em class="lb"> webhook设置</em>并使用新的ngrok主机名更新主机名。</li><li id="bfb6" class="kh ki hh jl b jm ks jq kt ju ku jy kv kc kw kg ko kp kq kr bi translated">启动minikube集群(如果您已经完成了前面的实验，您应该已经安装和配置了Drone，并且部署了示例留言簿应用程序)。</li></ul><p id="9a8f" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">让我们回顾一下让实验准备好继续本文的实验所需的命令。首先，运行下面的<em class="lb"> kubectl </em>命令，使用端口转发来公开无人机服务器:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="5c8b" class="ll im hh lh b fi lm ln l lo lp">$ sudo kubectl — namespace drone port-forward svc/drone 80:80</span></pre><p id="cd3c" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">访问<a class="ae la" href="http://localhost" rel="noopener ugc nofollow" target="_blank"> http://localhost </a>，应该可以访问无人机web界面。<em class="lb"> .drone.yaml </em>文件位于<a class="ae la" href="https://github.com/juanluisbaptiste/kubernetes-engine-samples" rel="noopener ugc nofollow" target="_blank"><em class="lb">kubernetes-engine-samples</em></a>库的根目录下。在这个存储库中，我们在这个实验中使用了<a class="ae la" href="https://github.com/juanluisbaptiste/kubernetes-engine-samples/tree/main/guestbook" rel="noopener ugc nofollow" target="_blank">留言簿</a>应用程序。Kubernetes清单在那个文件夹里面，前端代码在<a class="ae la" href="https://github.com/juanluisbaptiste/kubernetes-engine-samples/tree/main/guestbook/php-redis" rel="noopener ugc nofollow" target="_blank"> <em class="lb"> php-redis </em> </a>文件夹里面。要访问前端应用程序，您可以使用<em class="lb"> minikube服务</em>命令:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="1ad0" class="ll im hh lh b fi lm ln l lo lp">$ minikube service frontend -n guestbook-demo</span></pre><p id="8d5c" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">现在我们准备继续！</p><h1 id="8796" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">无人机命令行界面(CLI)</h1><p id="149d" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">Drone <a class="ae la" href="https://docs.drone.io/quickstart/cli/" rel="noopener ugc nofollow" target="_blank">提供命令行界面</a>程序，与Drone服务器远程交互。该CLI可用于在服务器上执行管理任务，如查看日志、管理用户、机密和<a class="ae la" href="https://docs.drone.io/template/" rel="noopener ugc nofollow" target="_blank">管道模板</a>。它还可以用来管理存储库、构建作业、cronjobs或<a class="ae la" href="https://docs.drone.io/cli/drone-exec/" rel="noopener ugc nofollow" target="_blank">执行本地构建</a>。在本节中，我们将回顾其中的一些任务。</p><h2 id="17e7" class="ll im hh bd in lq lr ls ir lt lu lv iv ju lw lx iz jy ly lz jd kc ma mb jh mc bi translated">安装和配置</h2><p id="f57a" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">CLI程序的安装相当简单，基本上，将平台的二进制文件下载到用户路径下的一个目录中，并赋予它执行权限。例如，对于Linux，您可以使用以下命令:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="4078" class="ll im hh lh b fi lm ln l lo lp">$ curl -L <a class="ae la" href="https://github.com/harness/drone-cli/releases/latest/download/drone_linux_amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/harness/drone-cli/releases/latest/download/drone_linux_amd64.tar.gz</a> | tar zx</span><span id="681a" class="ll im hh lh b fi md ln l lo lp">$ sudo install -t /usr/local/bin drone</span></pre><p id="859e" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">其他平台看官方<a class="ae la" href="https://docs.drone.io/cli/install/" rel="noopener ugc nofollow" target="_blank">安装说明</a>。</p><h2 id="d8b8" class="ll im hh bd in lq lr ls ir lt lu lv iv ju lw lx iz jy ly lz jd kc ma mb jh mc bi translated">使用</h2><p id="c136" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">安装二进制文件后，需要使用环境变量对其进行<a class="ae la" href="https://docs.drone.io/cli/configure/" rel="noopener ugc nofollow" target="_blank">配置</a>以连接到无人机服务器。首先，导出无人机服务器地址:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="f7dd" class="ll im hh lh b fi lm ln l lo lp">$ export DRONE_SERVER=http://drone.mycompany.com</span></pre><p id="853f" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">对于本实验，服务器地址将是ngrok主机名。然后，导出无人机个人令牌:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="e6af" class="ll im hh lh b fi lm ln l lo lp">$ export DRONE_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9…</span></pre><p id="5c8c" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">请记住，个人令牌是从无人机服务器web界面中的用户配置文件页面获得的。导出前面的变量后，可以执行CLI命令。要测试CLI命令，请运行以下命令:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="3848" class="ll im hh lh b fi lm ln l lo lp">$ drone info<br/>User: yourgithubusername<br/>Email: juan@youremaildomain.com</span></pre><h1 id="b21c" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">Kubernetes秘密集成</h1><p id="babc" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">Drone.io可以<a class="ae la" href="https://docs.drone.io/secret/external/" rel="noopener ugc nofollow" target="_blank">与许多外部秘密存储工具</a>集成，并允许存储在那些工具中的秘密在一个管道中使用。有了这个功能，就可以用Kubernetes的秘密代替无人机秘密了。为了让无人机能够获取Kubernetes的秘密，需要做三件事:</p><ul class=""><li id="3aeb" class="kh ki hh jl b jm kj jq kk ju kl jy km kc kn kg ko kp kq kr bi translated">安装<a class="ae la" href="https://docs.drone.io/runner/extensions/kube/" rel="noopener ugc nofollow" target="_blank">无人机Kubernetes secrets扩展</a></li><li id="8dca" class="kh ki hh jl b jm ks jq kt ju ku jy kv kc kw kg ko kp kq kr bi translated">创造Kubernetes的秘密</li><li id="aadb" class="kh ki hh jl b jm ks jq kt ju ku jy kv kc kw kg ko kp kq kr bi translated">将秘密资源添加到无人机管道中，以访问Kubernetes秘密。</li></ul><h2 id="097d" class="ll im hh bd in lq lr ls ir lt lu lv iv ju lw lx iz jy ly lz jd kc ma mb jh mc bi translated">扩展安装</h2><p id="0481" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">使用舵图也可以安装延伸件<a class="ae la" href="https://github.com/drone/charts/blob/498bf298c0000acafa47b43308f4d06c6ab40e66/charts/drone-kubernetes-secrets/README.md" rel="noopener ugc nofollow" target="_blank">。首先，扩展需要配置一个Helm <em class="lb"> values.yaml </em>文件，如下所示:</a></p><figure class="lc ld le lf fd ii"><div class="bz dy l di"><div class="me mf l"/></div><figcaption class="mg mh et er es mi mj bd b be z dx">Example Drone.io Kubernetes secrets extension config file</figcaption></figure><p id="83d2" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">用自己的秘密替换SECRET_KEY的值。您可以使用<em class="lb"> openssl </em>命令创建一个随机的:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="7e26" class="ll im hh lh b fi lm ln l lo lp">$ openssl rand -hex 16<br/>a6ca63b531427e3165224112e02b1697</span></pre><p id="a246" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">此外，正如您在前面的示例中看到的，扩展将在默认名称空间中查找秘密，因此如果您想要使用不同的名称空间，那么必须用要使用的名称空间更新<em class="lb"> secretNamespace </em>和<em class="lb"> KUBERNETES_NAMESPACE </em>的值。查看<a class="ae la" href="https://docs.drone.io/runner/extensions/kube/" rel="noopener ugc nofollow" target="_blank">文档</a>,了解设置共享秘密之外的其他变量。</p><p id="a647" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">将该文件另存为<em class="lb">drone-kubernetes-secrets . YAML</em>，然后使用以下Helm命令安装扩展:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="dd43" class="ll im hh lh b fi lm ln l lo lp">$ helm install — namespace drone drone-kubernetes-secrets drone/drone-kubernetes-secrets -f drone-kubernetes-secrets-values.yaml</span><span id="46e6" class="ll im hh lh b fi md ln l lo lp">NAME: drone-kubernetes-secrets<br/>LAST DEPLOYED: Wed Jul 20 15:22:50 2022<br/>NAMESPACE: drone<br/>STATUS: deployed<br/>REVISION: 1<br/>TEST SUITE: None</span></pre><p id="05e7" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">要检查扩展是否已成功安装，请检查pod日志:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="ba1c" class="ll im hh lh b fi lm ln l lo lp">$ kubectl — namespace drone logs \<br/>-l ‘app.kubernetes.io/name=drone-kubernetes-secrets’ \<br/>-l ‘app.kubernetes.io/component=drone-kubernetes-secrets’</span><span id="c956" class="ll im hh lh b fi md ln l lo lp">time=”2020–01–29T00:02:18Z” level=info msg=”server listening on address :3000"</span></pre><p id="57e8" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">如果您在最后一行看到一条消息说“服务器监听地址:3000”，那么这个扩展正在按预期工作。下一步是更新运行程序，并配置它们使用Kubernetes secrets扩展。为此，需要更新跑步者的舵值文件，在文件的<em class="lb"> env: </em>部分添加以下配置变量:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="6bd4" class="ll im hh lh b fi lm ln l lo lp">DRONE_SECRET_PLUGIN_ENDPOINT: <a class="ae la" href="http://drone-kubernetes-secrets:3000" rel="noopener ugc nofollow" target="_blank">http://drone-kubernetes-secrets:3000</a><br/>DRONE_SECRET_PLUGIN_TOKEN: your-shared-secret-value-here</span></pre><p id="68d6" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">将<em class="lb">DRONE _ SECRET _ PLUGIN _ TOKEN</em>变量的值替换为先前在Kubernetes secrets安装期间配置的密码值。保持<em class="lb">DRONE _ SECRET _ PLUGIN _ ENDPOINT</em>的值不变。然后，使用Helm更新跑步者的安装:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="4c9a" class="ll im hh lh b fi lm ln l lo lp">$ helm upgrade — namespace drone drone-runner-kube drone/drone-runner-kube -f drone-runner-kube-values.yaml</span><span id="2c59" class="ll im hh lh b fi md ln l lo lp">Release “drone-runner-kube” has been upgraded. Happy Helming!<br/>NAME: drone-runner-kube<br/>LAST DEPLOYED: Wed Jul 20 15:26:32 2022<br/>NAMESPACE: drone<br/>STATUS: deployed<br/>REVISION: 2<br/>TEST SUITE: None</span></pre><h2 id="3386" class="ll im hh bd in lq lr ls ir lt lu lv iv ju lw lx iz jy ly lz jd kc ma mb jh mc bi translated">库伯内特的秘密创作</h2><p id="edee" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">现在，使用<em class="lb"> kubectl </em>创建Kubernetes秘密。我们将创建在前一篇文章中使用的留言簿示例应用程序管道中使用的所有秘密:</p><ul class=""><li id="cc5a" class="kh ki hh jl b jm kj jq kk ju kl jy km kc kn kg ko kp kq kr bi translated">Docker Hub凭据</li><li id="eb34" class="kh ki hh jl b jm ks jq kt ju ku jy kv kc kw kg ko kp kq kr bi translated">minikube参数(CA证书、服务器地址和令牌)</li></ul><p id="35b4" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">该清单文件可用作创建机密的模板:</p><figure class="lc ld le lf fd ii"><div class="bz dy l di"><div class="me mf l"/></div><figcaption class="mg mh et er es mi mj bd b be z dx">Kubernetes example secrets manifest file</figcaption></figure><p id="c2f6" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">所有值都需要进行base 64编码。要对简单值进行编码，可以使用以下命令:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="fa5c" class="ll im hh lh b fi lm ln l lo lp">$ echo -n value | base64</span></pre><p id="06a1" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">举个例子，</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="6b0f" class="ll im hh lh b fi lm ln l lo lp">$ echo -n juanluisbaptiste | base64<br/>anVhbmx1aXNiYXB0aXN0ZQ==</span></pre><p id="8ed6" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">使用该命令对docker hub用户名和密码以及minikube服务器地址进行编码。注意使用-n参数来避免添加行尾，这是至关重要的。</p><p id="cdde" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">对于minikube CA证书，我们可以参考上一篇文章，因为我们之前已经用以下命令对其进行了编码:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="7585" class="ll im hh lh b fi lm ln l lo lp">$ cd ~/.minikube<br/>$ cat ca.crt|base64 -w 0</span></pre><p id="4aab" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">请注意-w 0参数的使用，它用于禁用换行，因此我们在一行中获得编码值，这是因为证书值的长度而需要的。</p><p id="94ca" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">为了对minikube令牌进行编码，我们还可以使用上一篇文章中给出的命令来获取它的值，但是要做一个小的修改。之前，令牌值已经进行了base 64编码，并在提取时被解码，因此将修改命令以避免base64解码:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="2c58" class="ll im hh lh b fi lm ln l lo lp">$ kubectl get secret `kubectl get secret -n kube-system|grep default|awk ‘{print $1}’|grep -v NAME` -o go-template=’{{ .data.token }}’ -n kube-system<br/>S0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCakNDQWU2Z0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFR<br/>[…]</span></pre><p id="c046" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">所有值编码后，将它们复制粘贴到之前的秘密清单文件中，并保存为<em class="lb">kubernetes-secrets . YAML</em>。然后，在默认名称空间中使用以下命令创建机密:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="64a6" class="ll im hh lh b fi lm ln l lo lp">$ kubectl apply -f kubernetes-secrets.yaml -n default<br/>secret/docker configured<br/>secret/k8s configured</span></pre><h2 id="279b" class="ll im hh bd in lq lr ls ir lt lu lv iv ju lw lx iz jy ly lz jd kc ma mb jh mc bi translated">将机密资源添加到管道</h2><p id="d275" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">最后要做的是将新的秘密资源添加到新的Kubernetes秘密的无人机管道中。在<em class="lb"> .drone.yml </em>文件的开头添加以下秘密定义:</p><figure class="lc ld le lf fd ii"><div class="bz dy l di"><div class="me mf l"/></div><figcaption class="mg mh et er es mi mj bd b be z dx">Secret resource definitions added to .drone.yaml</figcaption></figure><p id="4752" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">有了这些秘密资源定义，管道使用的秘密值将从先前创建的Kubernetes秘密中获取。</p><h1 id="5489" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">管道促销</h1><p id="30fa" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">管道提升是一个非常酷的特性，可以用来将构建输出移动或“提升”到目标环境。提升允许将已经构建在管道中的代码部署到不同的环境中(开发、测试、试运行、生产等)。)，通过运行一个只执行部署步骤的新管道。这些环境是应该部署应用程序的基础设施，例如Kubernetes集群。这些形象促销有许多优点:</p><ul class=""><li id="2021" class="kh ki hh jl b jm kj jq kk ju kl jy km kc kn kg ko kp kq kr bi translated">创建可重复的部署:确信每次一个构建被提升到不同的环境，它将总是被部署的相同的代码。</li><li id="4962" class="kh ki hh jl b jm ks jq kt ju ku jy kv kc kw kg ko kp kq kr bi translated">缩短新版本的发布时间:使用促销时，带有新应用程序代码的映像只构建一次，然后在不同环境之间移动，直到它最终出现在开发和运营团队之间摩擦最少的理想环境中。</li><li id="2855" class="kh ki hh jl b jm ks jq kt ju ku jy kv kc kw kg ko kp kq kr bi translated">创建正在部署的版本的审计跟踪:随时了解每个环境中部署了哪些映像版本。</li><li id="d6bf" class="kh ki hh jl b jm ks jq kt ju ku jy kv kc kw kg ko kp kq kr bi translated">职责分离:让QA团队在他们的质量测试通过后在环境之间推广新版本，而不是在QA需要时让运营团队去做。通过这种方式，开发团队可以以版本化的方式提供新的应用程序版本，QA和发布经理可以在他们有信心的时候，按照他们自己的步调测试和发布这些新版本。</li><li id="d17f" class="kh ki hh jl b jm ks jq kt ju ku jy kv kc kw kg ko kp kq kr bi translated">轻松地将升级后的映像版本回滚到以前的版本。</li></ul><h2 id="829f" class="ll im hh bd in lq lr ls ir lt lu lv iv ju lw lx iz jy ly lz jd kc ma mb jh mc bi translated">促销如何运作</h2><p id="7bed" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">当提升一个构建时，Drone启动应用程序管道的新构建。这个新的内部版本有自己的内部版本号，并从正在升级的内部版本中继承所有的内部版本参数。新的构建将把它的事件类型设置为<em class="lb"> promote </em>，通过在管道中的触发条件中使用它，可以将它用于基础设施中的部署环境。</p><p id="b25a" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">无人机管道应该定义在某处部署应用程序所需的步骤，然后，可以使用<em class="lb">触发器</em>(在管道级别)或<em class="lb"> when </em>条件(在步骤级别)中的<em class="lb"> promote </em>事件类型，结合任何其他所需的条件来选择部署目标。</p><p id="c59b" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">在<a class="ae la" rel="noopener" href="/globant/introduction-to-drone-io-ci-cd-platform-part-2-fa9fdc6a3659">的上一篇文章</a>中，我们已经定义了一个部署到本地minikube集群的管道，所以我们将从那里继续演示这个特性。</p><h2 id="6de5" class="ll im hh bd in lq lr ls ir lt lu lv iv ju lw lx iz jy ly lz jd kc ma mb jh mc bi translated">推广管道</h2><p id="5570" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">继续上一篇文章中的实验，要使用管道提升功能，需要完成两项任务。首先，我们必须修改无人机管道，并将其分成两个不同的管道:一个用于构建和标记图像，另一个用于将其部署到特定的环境。其次，必须修改应用程序的前端清单文件，以部署在构建管道中构建并使用git标签标记的图像标签。这也将允许我们从以前的部署管道中回滚到特定的版本。</p><p id="4e51" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">要拆分管道，请添加一个新的管道定义，为其命名，并将部署步骤移到其中。这是文件外观的一个例子，但是你可以在这里看到完成的文件<a class="ae la" href="https://github.com/juanluisbaptiste/kubernetes-engine-samples/blob/main/.drone.yml" rel="noopener ugc nofollow" target="_blank"/>:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="4b85" class="ll im hh lh b fi lm ln l lo lp">[ … <em class="lb">secrets definitions here</em> … ]<br/>---<br/>kind: pipeline<br/>type: kubernetes<br/>name: build</span><span id="aa26" class="ll im hh lh b fi md ln l lo lp">steps:<br/>  - name: Build docker image<br/>    image: plugins/docker<br/>    settings:<br/>      repo: juanluisbaptiste/guestbook-demo<br/>      dockerfile: guestbook/php-redis/Dockerfile<br/>      context: guestbook/php-redis<br/>      username:<br/>        from_secret: docker_username<br/>      password:<br/>        from_secret: docker_password<br/>    tags:<br/>      - latest<br/>      - ${DRONE_BUILD_NUMBER}<br/>    when:<br/>      event:<br/>        - push<br/>        - pull_request<br/>        - custom<br/>  <strong class="lh hi">- name: Tag docker image<br/>    image: plugins/docker<br/>    settings:<br/>      repo: juanluisbaptiste/guestbook-demo<br/>      dockerfile: guestbook/php-redis/Dockerfile<br/>      context: guestbook/php-redis<br/>      username:<br/>        from_secret: docker_username<br/>      password:<br/>        from_secret: docker_password<br/>    tags:<br/>      - latest<br/>      - ${DRONE_TAG}<br/>    when:<br/>      event:<br/>        - tag<br/>---<br/>kind: pipeline<br/>type: kubernetes<br/>name: deploy</strong></span><span id="d728" class="ll im hh lh b fi md ln l lo lp"><strong class="lh hi">steps:<br/></strong>- name: Deploy frontend deployment<br/>  image: danielgormly/drone-plugin-kube:0.2.0<br/>  settings:<br/>    <strong class="lh hi">image_tag: ${DRONE_TAG}<br/>    </strong>template: guestbook/frontend-deployment.yaml<br/>    namespace: guestbook-demo<br/>    ca:<br/>      from_secret: k8s_crt<br/>    server:<br/>      from_secret: k8s_server<br/>    token:<br/>      from_secret: k8s_token<br/>  <strong class="lh hi">trigger:<br/>    event:<br/>      - promote<br/>      - rollback<br/>    target:<br/>      - production</strong></span><span id="f9c3" class="ll im hh lh b fi md ln l lo lp">[ … <em class="lb">rest of deployment steps</em> … ]</span></pre><p id="0bf2" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">我用粗体突出显示了新的部分。请注意，我们添加了另一个步骤来标记构建管道中的图像。如何定义它并不是最佳的方法，因为映像被构建了两次(映像应该只在构建步骤中构建，但这足以演示这个特性)。还要注意，这个新步骤的条件被定义为用<em class="lb">标签</em>事件触发，在标签部分，有一个标签使用了<em class="lb"> ${DRONE_TAG} </em>变量。该变量包含触发构建的git标记的值。</p><p id="89ca" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">现在，进入部署流程。为了简单起见，我们将只有一个部署示例应用程序的环境。通常，一个项目至少有一个试运行和生产环境，但是对于本演示，只有生产环境就足够了。</p><p id="0f49" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">在<em class="lb">部署</em>管道中，注意在第一个部署步骤，即部署前端应用程序的步骤中，我们定义了一个名为<em class="lb"> image_tag </em>的变量，该变量接收<em class="lb"> ${DRONE_TAG} </em>变量。该变量被传递给前端应用程序清单，并用作模板变量。该管道的触发器定义了两个事件:<em class="lb"> promote </em>和<em class="lb"> rollback </em>，并添加了另一个名为<em class="lb"> target </em>的触发器。此目标触发器用于定义执行管道(或步骤，如果在步骤级别定义的话)的环境。在他的例子中，目标是<em class="lb">生产</em>环境。</p><p id="0043" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">现在，必须修改前端应用程序清单文件以使用该变量:</p><figure class="lc ld le lf fd ii"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="af3d" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">Kubernetes部署插件可以将清单文件解析为模板，并用它们的值替换像<em class="lb"> image_tag </em>这样的变量。这意味着要部署的前端映像是标记有<em class="lb"> ${DRONE_TAG} </em>变量值的映像。这些修改完成后，我们就准备做管道推广了！</p><p id="3dce" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">首先将这些更改提交到您的回购中。现在，编辑<a class="ae la" href="https://github.com/juanluisbaptiste/kubernetes-engine-samples/blob/main/guestbook/php-redis/index.html" rel="noopener ugc nofollow" target="_blank">留言簿/php-redis/index.html </a>文件，并在某处添加一些文本来模拟创建新版本前端应用程序的更改。例如，将文本“v2.0.0”添加到h2标题，并提交和推送更改:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="c382" class="ll im hh lh b fi lm ln l lo lp">[…]</span><span id="9696" class="ll im hh lh b fi md ln l lo lp">&lt;h2&gt;Guestbook v2.0.0&lt;/h2&gt;</span><span id="5321" class="ll im hh lh b fi md ln l lo lp">[…]</span></pre><p id="14ff" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">构建管道中的构建映像步骤将触发并构建映像。请注意，现在部署步骤不会触发，因为它们现在位于单独的管道中:</p><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="er es mk"><img src="../Images/8da3cbbe606ce713b60a9c858e6cc5d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*o0cFGYF10VDtC65A"/></div></div></figure><p id="bee4" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">等到构建完成，创建一个值为“v2.0.0”的git标记:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="d885" class="ll im hh lh b fi lm ln l lo lp">$ git tag v.2.0.0</span></pre><p id="08b9" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">按下标签，现在来自构建管道的<em class="lb">标签</em>步骤将被触发。</p><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="er es mp"><img src="../Images/507f76b7fc387f952b6ef49546c67b8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*M1n0ET50Jwur3YmM"/></div></div></figure><p id="a8f4" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">完成后，您可以在docker hub存储库中检查您是否有一个用该标签标记的图像。现在我们已经准备好提升构建了。在git标签触发的构建中，点击右上角的三点菜单并选择<em class="lb"> Promote </em>:</p><figure class="lc ld le lf fd ii er es paragraph-image"><div class="er es mq"><img src="../Images/61fbaa50d660d7f0aecec3cc9a714239.png" data-original-src="https://miro.medium.com/v2/resize:fit:342/0*sLdjYIiDiNHRDV_h"/></div></figure><p id="260a" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">在<em class="lb">目标</em>字段中，写入<em class="lb">生产</em>(这是我们在部署管道中触发器的<em class="lb">目标</em>字段中定义的环境的名称)，保留其余字段不变，然后单击“部署”。</p><figure class="lc ld le lf fd ii er es paragraph-image"><div class="er es mr"><img src="../Images/95804569365846e2f20da2dc1b78446a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/0*yqlukGLRhwwre4rf"/></div></figure><p id="f29c" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">现在<em class="lb">部署</em>管道将开始在<em class="lb">生产</em>目标环境中部署带有git标签的前端应用程序映像:</p><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="er es ms"><img src="../Images/873ee9a0c17f697f50442d13bcee0a37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FsrnlZSf_socuenU"/></div></div></figure><p id="ac92" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">转到前端应用程序URL，我们刚才对<em class="lb">index.html</em>文件所做的更改应该是可见的:</p><figure class="lc ld le lf fd ii er es paragraph-image"><div class="er es mt"><img src="../Images/2a8476da04a3bf62748739f76eba6691.png" data-original-src="https://miro.medium.com/v2/resize:fit:1044/0*X5WfszGheqJH6cAB"/></div></figure><p id="c8b6" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">构建按预期得到了提升和部署。您可以检查窗格，并看到它们是重新创建的:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="dc26" class="ll im hh lh b fi lm ln l lo lp">$ kubectl -n drone get pods<br/>NAME                             READY STATUS  RESTARTS AGE<br/>frontend-56d74fbb4b-crj9t        1/1   Running 0        36s<br/>frontend-56d74fbb4b-qcfz5        1/1   Running 0        48s<br/>frontend-56d74fbb4b-zw9tt        1/1   Running 0        30s<br/>redis-follower-594666cdcd-dbd4f  1/1   Running 6        2d<br/>redis-follower-594666cdcd-l6s8c  1/1   Running 6        2d<br/>redis-leader-fb76b4755-bhfzh     1/1   Running 6        2d</span></pre><p id="1ee8" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">还要检查使用的图像标签:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="4c69" class="ll im hh lh b fi lm ln l lo lp">$ kubectl describe pod/frontend-56d74fbb4b-crj9t</span><span id="550d" class="ll im hh lh b fi md ln l lo lp">[...]<br/>Containers:<br/>  php-redis:<br/>    Container ID: docker://426fb895586bd1415faaba8cb84b6a7edc475a5a7a82162132e2415f3270c86a<br/>    Image: <strong class="lh hi">juanluisbaptiste/guestbook-demo:v2.0.0<br/></strong>[...]</span></pre><p id="209c" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">现在，让我们对前端应用程序做另一个修改。再次编辑<em class="lb">index.html</em>文件，并将版本文本更改为“v2.1.0”:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="567b" class="ll im hh lh b fi lm ln l lo lp">[…]</span><span id="978c" class="ll im hh lh b fi md ln l lo lp">&lt;h2&gt;Guestbook v2.1.0&lt;/h2&gt;</span><span id="9329" class="ll im hh lh b fi md ln l lo lp">[…]</span></pre><p id="9d79" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">提交并推送更改，等待构建完成，并创建一个值为“v2.1.0”的git标记:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="df84" class="ll im hh lh b fi lm ln l lo lp">$ git tag v.2.1.0</span></pre><p id="b2ad" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">按下标签以触发部署，等待它完成，然后再次升级这个新的构建(版本2.1.0):</p><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="er es mu"><img src="../Images/03cc5ab920d5796a93dd614124bb7c2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Y1IgyEeDvvQc63hf"/></div></div></figure><p id="47c8" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">管道完成后，返回前端应用程序并重新加载页面，您应该会看到新的变化:</p><figure class="lc ld le lf fd ii er es paragraph-image"><div class="er es mv"><img src="../Images/e82f2f3d277c1d3447979d6891c1b160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/0*swJuKG47qxin5Anw"/></div></figure><p id="e5a7" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">如您所见，升级构建是跨环境移动应用程序新版本的一种简单而方便的方式。也可以使用CLI界面执行促销。这个例子也可以这样做:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="7da3" class="ll im hh lh b fi lm ln l lo lp">$ drone build promote juanluisbaptiste/kubernetes-engine-samples 68 production</span><span id="986c" class="ll im hh lh b fi md ln l lo lp">Number: 70<br/>Status: pending<br/>Event: promote<br/>Commit: 1fbf81df2adf8753df698fc9ae1546127d54aa6e<br/>Branch:<br/>Ref: refs/tags/v2.1.0<br/>Author: juanluisbaptiste &lt;juan@xxxxxx.tech&gt;<br/>Message: Increase version text to v2.1.0</span></pre><p id="8193" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">在一组成功的测试完成后，您可以使用cli以编程方式进行管道升级。现在我们可以检查如何回滚到以前的版本。</p><h2 id="2b9e" class="ll im hh bd in lq lr ls ir lt lu lv iv ju lw lx iz jy ly lz jd kc ma mb jh mc bi translated">回滚管道</h2><p id="fd1d" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">一个<em class="lb">回滚</em>是在一个环境中部署一个以前的应用程序版本，例如因为在升级完成后，出现了一些错误，不幸的是在测试期间没有被发现。继续这个示例，我们将从2.1.0版回滚到2.0.0版。</p><p id="43e9" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">转到v2.0.0的升级版本:</p><figure class="lc ld le lf fd ii er es paragraph-image"><div class="er es mw"><img src="../Images/4c2f867571f15bbb1f6fd883446ba073.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/0*qC2F1QcH2KMqrFto"/></div></figure><p id="abd5" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">再次点击右上角的三点菜单，但这次点击<em class="lb">回滚</em>选择框(我知道，在推广窗口中有回滚选项很奇怪！)，再次在目标上放置<em class="lb">生产</em>，并点击“部署”:</p><figure class="lc ld le lf fd ii er es paragraph-image"><div class="er es mx"><img src="../Images/dd6cc17f2f4ef42230947be89fc54c42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*3nfaWkaJ_Sko6D8K"/></div></figure><p id="7b7b" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">部署管道将启动。单击<em class="lb">克隆</em>作业，注意它签出的git ref:</p><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="er es my"><img src="../Images/06d151bb1d4d7701dadc856a53d616c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XfmMhuKGIot60TwA"/></div></div></figure><p id="fbfd" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">如您所见，是v2.0.0标记，管道正在使用回滚部署的正确版本。管道完成后，回到前端应用程序和刷新，你应该会再次看到旧的2.0.0版本！</p><figure class="lc ld le lf fd ii er es paragraph-image"><div class="er es mz"><img src="../Images/5028f18f6c854e2712737aafe7d0d4bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/0*-xPGS_jAbkjkHCav"/></div></figure><h1 id="3d19" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">排除故障</h1><p id="441f" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">如果您的无人机设置有问题，无论是服务器设置还是在执行构建管道时，都有一些工具可以帮助您调试问题并找出发生了什么。调试问题时要做的第一件事是查看<a class="ae la" href="https://docs.drone.io/cli/drone-log/" rel="noopener ugc nofollow" target="_blank">日志</a>。无人机有两种类型的日志:</p><ul class=""><li id="5cdb" class="kh ki hh jl b jm kj jq kk ju kl jy km kc kn kg ko kp kq kr bi translated">服务器和代理日志</li><li id="edcb" class="kh ki hh jl b jm ks jq kt ju ku jy kv kc kw kg ko kp kq kr bi translated">管道构建日志</li></ul><p id="60ed" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">要查看服务器或代理日志，使用<em class="lb"> kubectl </em>命令，例如:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="a51f" class="ll im hh lh b fi lm ln l lo lp">$ kubectl -n drone get pods</span><span id="ce6b" class="ll im hh lh b fi md ln l lo lp">NAME                                READY STATUS  RESTARTS AGE<br/>drone-6c4c8dd65c-7rxdn              1/1   Running 2        4d<br/>drone-runner-kube-7f79d87b75-fffn5  1/1   Running 2        4d</span><span id="56bf" class="ll im hh lh b fi md ln l lo lp">$ kubectl -n drone logs drone-6c4c8dd65c-7rxdn — tail 10</span><span id="a9cc" class="ll im hh lh b fi md ln l lo lp">{“arch”:””,”kernel”:””,”kind”:”pipeline”,”level”:”debug”,”msg”:”manager: request queue item”,”os”:””,”time”:”2022–07-20T02:36:55Z”,”type”:”kubernetes”,”variant”:””}{“arch”:””,”kernel”:””,”kind”:”pipeline”,”level”:”debug”,”msg”:”manager: context canceled”,”os”:””,”time”:”2022–07–20T02:37:25Z”,”type”:”kubernetes”,”variant”:””}{“arch”:””,”kernel”:””,”kind”:”pipeline”,”level”:”debug”,”msg”:”manager: request queue item”,”os”:””,”time”:”2022–07-20T02:37:35Z”,”type”:”kubernetes”,”variant”:””}{“arch”:””,”kernel”:””,”kind”:”pipeline”,”level”:”debug”,”msg”:”manager: context canceled”,”os”:””,”time”:”2022–07–20T02:38:05Z”,”type”:”kubernetes”,”variant”:””}{“arch”:””,”kernel”:””,”kind”:”pipeline”,”level”:”debug”,”msg”:”manager: request queue item”,”os”:””,”time”:”2022–07-20T02:38:15Z”,”type”:”kubernetes”,”variant”:””}{“arch”:””,”kernel”:””,”kind”:”pipeline”,”level”:”debug”,”msg”:”manager: context canceled”,”os”:””,”time”:”2022–07–20T02:38:45Z”,”type”:”kubernetes”,”variant”:””}{“arch”:””,”kernel”:””,”kind”:”pipeline”,”level”:”debug”,”msg”:”manager: request queue item”,”os”:””,”time”:”2022–07-20T02:38:55Z”,”type”:”kubernetes”,”variant”:””}{“arch”:””,”kernel”:””,”kind”:”pipeline”,”level”:”debug”,”msg”:”manager: context canceled”,”os”:””,”time”:”2022–07–20T02:39:25Z”,”type”:”kubernetes”,”variant”:””}{“arch”:””,”kernel”:””,”kind”:”pipeline”,”level”:”debug”,”msg”:”manager: request queue item”,”os”:””,”time”:”2022–07-20T02:39:35Z”,”type”:”kubernetes”,”variant”:””}{“arch”:””,”kernel”:””,”kind”:”pipeline”,”level”:”debug”,”msg”:”manager: context canceled”,”os”:””,”time”:”2022–07–20T02:40:05Z”,”type”:”kubernetes”,”variant”:””}</span></pre><p id="2286" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">要查看代理日志，请运行相同的命令，但使用代理窗格。如果需要，可以使用<a class="ae la" href="https://docs.drone.io/runner/nomad/configuration/reference/drone-debug/" rel="noopener ugc nofollow" target="_blank"> <em class="lb"> DRONE_DEBUG </em> </a>和<a class="ae la" href="https://docs.drone.io/runner/nomad/configuration/reference/drone-trace/" rel="noopener ugc nofollow" target="_blank"> <em class="lb"> DRONE_TRACE </em> </a>环境变量增加日志的详细程度。要设置这些变量，请将它们添加到服务器或代理Helm配置文件中(本实验中的<em class="lb">drone-server-values . YAML</em>和<em class="lb">drone-runner-kube-values . YAML</em>)，并重新部署服务器和代理。要查看无人机存储库的日志，请使用以下命令:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="cb58" class="ll im hh lh b fi lm ln l lo lp">drone log view &lt;repo/name&gt; &lt;build&gt; &lt;stage&gt; &lt;step&gt;</span></pre><p id="3ddf" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">例如:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="8e81" class="ll im hh lh b fi lm ln l lo lp">$ drone log view kubernetes-engine-samples 23 1 1</span><span id="1db2" class="ll im hh lh b fi md ln l lo lp">Initialized empty Git repository in /drone/src/.git/<br/>+ git fetch origin +refs/heads/main:<br/>From <a class="ae la" href="https://github.com/juanluisbaptiste/kubernetes-engine-samples" rel="noopener ugc nofollow" target="_blank">https://github.com/juanluisbaptiste/kubernetes-engine-samples</a><br/>* branch main -&gt; FETCH_HEAD<br/>* [new branch] main -&gt; origin/main<br/>+ git checkout dd284331e3d24b5c9ab1b29cf5a0c00c18afbb10 -b main</span></pre><p id="ecfa" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">说实话，不得不一步一步地查看构建的日志，而不是能够在一次调用中获取管道的整个日志，这有点奇怪。</p><p id="6186" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">当然，CLI也可用于触发回滚:</p><pre class="lc ld le lf fd lg lh li lj aw lk bi"><span id="9948" class="ll im hh lh b fi lm ln l lo lp">$ drone build rollback juanluisbaptiste/kubernetes-engine-samples 63 production</span></pre><h1 id="98b3" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">结论</h1><p id="8f25" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">自从我们开始探索Drone.io持续集成和交付平台的旅程以来，我们已经走了很多路。我们从<a class="ae la" rel="noopener" href="/globant/introduction-to-drone-io-ci-cd-platform-1d43f8bc1728">简单的docker部署到测试无人机的一些核心功能</a>，到<a class="ae la" rel="noopener" href="/globant/introduction-to-drone-io-ci-cd-platform-part-2-fa9fdc6a3659">使用minikube </a>在本地Kubernetes集群中部署无人机，在那里我们测试了其他更高级的功能，如与Kubernetes secrets的集成、管道提升和回滚，以及其多功能CLI工具的使用。还有许多特性需要探索，但是我们到目前为止所介绍的内容可以让您很好地掌握它的一些主要特性。</p><p id="645a" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">从很多年前开始使用到0.5版本左右，我看到了Drone.io突飞猛进的进步。可用的插件很少，这几年来发生了巨大的变化，尽管Jenkins等其他更传统的CI/CD平台更广泛地支持与第三方工具的集成，但drone已经有超过100个可用的插件，涵盖了最流行的工具。但Drone.io的亮点在于其管道的简单性、占地面积小以及安装和运行起来有多简单。作为一个用docker容器构建的云原生工具，由于Helm charts，它的安装变得很简单，即使在Kubernetes中也是如此。此外，由于插件是作为docker映像构建的，因此可以用任何语言编写，使用环境变量来公开其配置，这使得根据需要扩展其功能变得相当容易。</p><p id="a0f3" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">我认为，仍然缺少的一个特性是赋予Kubernetes部署一些爱。目前，部署到Kubernetes集群的唯一方法是使用开源插件，这些插件不是由Drone.io开发的，而是由第三方贡献者开发的。不幸的是，我认为这不会得到改善，因为Drone.io的母公司Harness提供了自己的持续交付解决方案，作为持续集成工具来补充Drone.io。我明白这一点，但我希望Drone.io能够为基本用例提供一个功能正常的Kubernetes部署插件。</p><p id="1b42" class="pw-post-body-paragraph jj jk hh jl b jm kj jo jp jq kk js jt ju kx jw jx jy ky ka kb kc kz ke kf kg ha bi translated">我希望你喜欢阅读这一系列关于Drone.io的文章，就像我喜欢写它们一样，发现它们很有用，也很有见地。</p></div></div>    
</body>
</html>