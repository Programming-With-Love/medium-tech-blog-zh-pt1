# 使用 Flyway 进行数据库迁移

> 原文：<https://medium.com/capital-one-tech/database-migrations-with-flyway-16b6478e55a6?source=collection_archive---------2----------------------->

![](img/d49e1eff5aa397d3b0a4710dd890399f.png)

作为 Capital One 的软件工程师，我为我们的商业银行开发新的应用程序。我和我的团队最近为我们银行的关系经理和分析师开发了一个 web 应用形式的数据管理工具。该团队包括两名软件工程师、四名数据分析师和科学家，以及一名产品经理。在原型开发的前五个月，我们相互协作，定义了一个能够满足用户分析需求的数据库模式。

在此期间，我和我的技术主管决定开发模式迁移工具，以便在设计数据库时简化开发。我们选定的数据库是 Flyway。Flyway 是一个开源数据库迁移工具，支持开发人员将版本控制实践应用到他们的数据库中。当我们查看其他几种模式迁移工具时，这种工具似乎最适合我们的特定用例。

为什么我们需要模式迁移工具？

# 模式迁移和工具的好处

随着敏捷方法的进步和在 21 世纪初被广泛采用，对模式迁移工具的需求变得越来越大。允许数据库设计随着应用程序的发展而发展的技术允许工程师更有效地迭代软件。

在此期间，数据库迁移工具越来越受欢迎。模式迁移为数据库增加了版本控制功能。迁移是增量管理的，并且是可逆的。Flyway 之类的工具可以在处理多个环境(如开发、测试和生产)或切换分支时防止数据库模式不匹配。它们允许开发人员从头开始重新创建数据库，这在创建新环境时很有价值。迁移工具增加了应用程序将在数据库的当前状态下运行的保证。例如，这可以防止开发人员遇到*列未找到*的错误。

# 飞行路线概述

Flyway 对数据库所做的更改被称为**迁移**。在 Flyway 中，迁移有两种类型；它们可以是**版本化的**或**可重复的**，版本化是最常见的。

版本化迁移有一个**版本**、**描述**和**校验和**，并且按顺序应用一次。可重复迁移有一个描述和一个校验和，每次校验和改变时都会重新应用。当需要更改数据库的模式时，开发人员会添加一个 SQL 脚本，通常在 **db/migrations** 目录中。

在将 Flyway 指向数据库后，它开始扫描应用程序的文件系统以进行迁移。第一次运行第一次迁移时，它创建一个名为 s **chema_version** 的表，该表有几列，包括**版本**、**描述**、**脚本**和**校验和**。该表用于跟踪数据库的状态。迁移根据版本号进行排序，并按顺序执行。

在每次应用迁移之后， **schema_version** 表会相应地更新。每次 Flyway 扫描应用程序的文件系统以进行迁移时，它都会查询 **schema_version** 表以查看数据库的版本，并相应地升级数据库。

可用但未应用的迁移称为待定迁移。

# 我们使用案例的优势

使用迁移工具的最大优点是，它确保软件版本总是与数据库的匹配状态一起交付。这对我们的产品尤其重要，因为我们正在快速迭代，需要快速自信地部署功能，以便收集用户反馈。

将 Flyway 集成到现有项目中很简单，因为设置时几乎不需要配置。该过程中最少的步骤包括通过在配置文件 **conf/flyway.conf** 中指定 url、用户名和密码来将工具指向数据库。

Flyway 严格的迁移规则加强了纪律，从而形成了最佳实践。这类似于在 git 中禁用强制推送。Flyway 执行的严格规则与在部署到环境后保持 SQL 文件不变的实践相一致。由于我们的团队努力遵循最佳软件工程实践，Flyway 对我们的产品来说是合适的。

作为一个几乎没有数据库迁移工具经验的人，Flyway 很容易学习和使用。所有模式迁移都是增量捕获的。该 API 公开了六个基本方法——迁移、清理、信息、验证、基线和修复。(您可以在这里了解关于这些命令[的更多信息)。这些方法使我们的团队能够将 Flyway 集成到 CircleCI 部署命令中。](https://flywaydb.org/documentation/commandline/)

最后，Flyway 既灵活又强大——它能够修改列名，并且只需几个简单的命令就可以将数据从一列转移到另一列。

# 我们用例的缺点

如前所述，Flyway 在迁移文件更改方面非常严格。签入迁移后，很难对其进行更改。更改文件的内容或名称可能会导致每台装有该文件早期版本的计算机上的迁移失败。

即使需要进行简单的更改——比如调整字段名——通常也需要一个新的迁移脚本。当我和我的技术主管快速迭代时，我们发现自己每周都在添加 Flyway 脚本。这导致我们的迁移文件夹中有多余的文件。在原型开发的前五个月，我们的应用程序只部署在一个开发环境中，几乎不需要在应用程序中保留微小的模式变化。

> *值得一提的是，可以编辑先前执行的迁移，但只有高级用户才能这样做，因为它需要更新* ***模式 _ 版本*** *表中的一行，以调整校验和值。*

当团队成员在不同的分支上并行工作时，版本号可能会冲突。有一些流程可以解决这个问题，比如为版本号使用时间戳而不是整数，并设置选项**out of forder = true**。

逆向迁移，比如删除在之前的迁移中添加的列，可能很棘手，通常需要开发人员创建数据备份。

# 我们应用程序的最终结果

事后看来，如果我们后来在应用程序和数据库设计成熟时集成了 Flyway，我的团队可以更好地利用它。为了在原型开发的第一阶段实现快速迭代，我认为我们的两人工程团队拥有一个定义初始模式的 SQL 文件、一个模拟数据文件和一个用模拟数据集加载表的脚本就足够了。

使用这种方法，我们可以通过修改 git 分支中的初始模式和模拟数据文件来修改模式。每次合并到主数据库或部署到环境后，通过 CircleCI 启动的步骤，数据库将使用模式和模拟数据集进行转储、拆卸、重新创建和重新加载。我认为 Flyway 最适合应用于存在多种环境的应用程序中，并且围绕数据库更改的决策不太稳定。

Flyway 是一个有价值的工具，它的许多优点超过了缺点。在我们产品的开发过程中，它确保了我们的应用程序总是以数据库的匹配状态运行。当从我们的主分支提取变更时，遇到数据库不匹配错误的风险几乎为零。我们的迁移文件夹也是历史的记录；我们的团队能够跟踪我们的数据库设计随时间的变化。

由于我和我的技术主管与我们团队的数据科学家进行了交叉协作，提供数据库状态的透明度是关键。在我们 CICD 平台的帮助下，每次迁移的部署对我们来说几乎没有停机时间。

Flyway 是我第一次使用迁移工具，它被证明在管理数据库状态方面是有效的。如果在正确的阶段集成到应用程序中，它有可能变得更加健壮。

# 承认

感谢 [Bruce Harris](/@bruceharris) 在审核过程中提供的有益建议。

*声明:这些观点仅代表作者个人观点。除非本帖中另有说明，否则 Capital One 不属于所提及的任何公司，也不被其认可。使用或展示的所有商标和其他知识产权都是其各自所有者的所有权。本文为 Capital One 2018。*