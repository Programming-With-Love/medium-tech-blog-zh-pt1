<html>
<head>
<title>Anthos in a nutshell</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">简而言之</h1>
<blockquote>原文：<a href="https://medium.com/globant/anthos-in-a-nutshell-1004fd203c33?source=collection_archive---------1-----------------------#2022-11-10">https://medium.com/globant/anthos-in-a-nutshell-1004fd203c33?source=collection_archive---------1-----------------------#2022-11-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="38cd" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">如何跨多个云提供商管理和协调多集群。</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/480c9c28e5948b77611d1729f638e7b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g5-nqcP-hQUHr-v7"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Anthos as an orchestrator for different technologies</figcaption></figure><p id="b357" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated"><a class="ae ki" href="https://cloud.google.com/anthos/" rel="noopener ugc nofollow" target="_blank"> Anthos </a>是一个<a class="ae ki" href="https://kubernetes.io" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a> (K8S)分布式代理，负责跨不同平台应用多集群范围的配置。</p><p id="0651" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">Anthos依靠版本控制软件来存储和分发集群配置和部署。</p><blockquote class="kj kk kl"><p id="bc61" class="jm jn km jo b jp jq ii jr js jt il ju kn jw jx jy ko ka kb kc kp ke kf kg kh ha bi translated">K8S <strong class="jo hi"> <em class="hh"> </em> </strong>的治理和审计过程的语义取决于组织的需求。</p></blockquote><p id="26fa" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">在本文中，我们将回顾一个部署Anthos的基本参考架构。我们还将向由Anthos管理的板载K8S集群展示所需的准备工作。</p><h2 id="88cf" class="kq kr hh bd ks kt ku kv kw kx ky kz la jv lb lc ld jz le lf lg kd lh li lj lk bi translated">参考架构</h2><p id="3104" class="pw-post-body-paragraph jm jn hh jo b jp ll ii jr js lm il ju jv ln jx jy jz lo kb kc kd lp kf kg kh ha bi translated">遵循跨不同提供商连接多个K8S集群的基本参考体系结构。这使我们能够通过单一控制台进行管理和配置。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es lq"><img src="../Images/e0cc8d87aeb3ae084d5b6c4963cfc66c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/0*PjupWp4MW30VNUS5.png"/></div><figcaption class="ji jj et er es jk jl bd b be z dx">Anthos architecture reference</figcaption></figure><p id="377a" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">每个必需的K8S集群都需要一个嵌入在集群领域中的组件。所述组件执行对主谷歌云平台(GCP)项目的回调函数。这个特定的项目也称为宿主项目。它的主要目标是管理和配置k8车队。</p><blockquote class="kj kk kl"><p id="7c72" class="jm jn km jo b jp jq ii jr js jt il ju kn jw jx jy ko ka kb kc kp ke kf kg kh ha bi translated"><strong class="jo hi"><em class="hh"/></strong><a class="ae ki" href="https://cloud.google.com/anthos/config-management" rel="noopener ugc nofollow" target="_blank">Anthos Config</a><strong class="jo hi"><em class="hh"/></strong>存储库<strong class="jo hi"> <em class="hh"> </em> </strong>可以托管在任何支持命令的<code class="du lr ls lt lu b">git</code>接口的源存储库中。也就是说，只要谷歌Kubernetes引擎(GKE)对它有读取权限。</p></blockquote><h2 id="bb48" class="kq kr hh bd ks kt ku kv kw kx ky kz la jv lb lc ld jz le lf lg kd lh li lj lk bi translated">K8S簇的制备</h2><p id="ed30" class="pw-post-body-paragraph jm jn hh jo b jp ll ii jr js lm il ju jv ln jx jy jz lo kb kc kd lp kf kg kh ha bi translated">准备每个K8S集群由Anthos<strong class="jo hi"><em class="km"/></strong>管理需要四个步骤:</p><ul class=""><li id="fe91" class="lv lw hh jo b jp jq js jt jv lx jz ly kd lz kh ma mb mc md bi translated">对于每个集群:在集群中安装Anthos配置管理:</li></ul><pre class="ix iy iz ja fd me lu mf mg aw mh bi"><span id="cad0" class="kq kr hh lu b fi mi mj l mk ml">kubectl apply -f <a class="ae ki" href="https://cloud.google.com/anthos-config-management/docs/downloads#manifest" rel="noopener ugc nofollow" target="_blank"><strong class="lu hi"><em class="km">config-management-operator.yaml</em></strong></a></span></pre><blockquote class="kj kk kl"><p id="a85c" class="jm jn km jo b jp jq ii jr js jt il ju kn jw jx jy ko ka kb kc kp ke kf kg kh ha bi translated">访问Anthos配置管理工具可以在<a class="ae ki" href="https://cloud.google.com/anthos-config-management/docs/downloads" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></blockquote><ul class=""><li id="dc01" class="lv lw hh jo b jp jq js jt jv lx jz ly kd lz kh ma mb mc md bi translated">创建YAML部署文件(每个集群一个)，并考虑以下关键因素:</li></ul><pre class="ix iy iz ja fd me lu mf mg aw mh bi"><span id="b9a7" class="kq kr hh lu b fi mi mj l mk ml">…<br/>apiVersion: configmanagement.gke.io/v1<br/>kind: ConfigManagement<br/>metadata:<br/> name: config-management<br/> namespace: config-management-system<br/>spec:<br/> clusterName: <strong class="lu hi"><em class="km">cluster_name</em></strong><br/> git:<br/> syncRepo: <strong class="lu hi"><em class="km">url_to_git_path</em></strong><br/> syncBranch: <strong class="lu hi"><em class="km">git_branch</em></strong><br/> secretType: ssh<br/> policyDir: “<strong class="lu hi"><em class="km">custom_directory</em></strong>”<br/>…</span></pre><blockquote class="kj kk kl"><p id="afbf" class="jm jn km jo b jp jq ii jr js jt il ju kn jw jx jy ko ka kb kc kp ke kf kg kh ha bi translated"><code class="du lr ls lt lu b">cluster_name</code>对于每个分类必须是唯一的。结果，你将会有和你必须管理的集群一样多的<code class="du lr ls lt lu b">config_management_cluster_name.yaml</code>文件。</p></blockquote><ul class=""><li id="2ec8" class="lv lw hh jo b jp jq js jt jv lx jz ly kd lz kh ma mb mc md bi translated">为每个集群应用以前的配置:</li></ul><pre class="ix iy iz ja fd me lu mf mg aw mh bi"><span id="71bb" class="kq kr hh lu b fi mi mj l mk ml">kubectl apply -f config_management_<strong class="lu hi"><em class="km">cluster_name</em></strong>.yaml</span></pre><ul class=""><li id="fc04" class="lv lw hh jo b jp jq js jt jv lx jz ly kd lz kh ma mb mc md bi translated">对于每个集群:在K8S中配置git访问凭证</li></ul><pre class="ix iy iz ja fd me lu mf mg aw mh bi"><span id="d81e" class="kq kr hh lu b fi mi mj l mk ml">#kubectl create secret generic git-creds — namespace=config-management-system — from-file=ssh=<strong class="lu hi">PATH_TO_PRIVATE_KEY</strong></span></pre><p id="1f47" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">这是根据中央存储库同步所有集群所需的配置。</p><p id="f079" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">现在，唯一合理的问题是我们如何知道同步的状态，答案以名为<code class="du lr ls lt lu b">nomos</code>的二进制形式出现。</p><p id="983b" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">二进制包<code class="du lr ls lt lu b">nomos</code>也可以从<a class="ae ki" href="https://cloud.google.com/anthos-config-management/docs/downloads#nomos_command" rel="noopener ugc nofollow" target="_blank"> Anthos下载页面</a>下载。用<code class="du lr ls lt lu b">Go</code>写的，各种平台都有。基本用法如下:</p><pre class="ix iy iz ja fd me lu mf mg aw mh bi"><span id="9081" class="kq kr hh lu b fi mi mj l mk ml">#nomos -h<br/>Set up and manage a Anthos Configuration Management directory (version v1.1.1-rc.4)Usage:<br/>  nomos [command]Available Commands:<br/>  help        Help about any command<br/>  hydrate     <br/>  init        Initialize a Anthos Configuration Management directory<br/>  status      Prints the status of all clusters with Configuration Management installed.<br/>  version     Prints the version of ACM for each cluster as well this CLI<br/>  vet         Validate a Anthos Configuration Management directoryFlags:<br/>  -h, --help   help for nomosUse "nomos [command] --help" for more information about a command.</span></pre><p id="c600" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">这意味着当您运行<code class="du lr ls lt lu b">nomos status</code>时，它将输出每个被管理集群的状态。</p><pre class="ix iy iz ja fd me lu mf mg aw mh bi"><span id="9065" class="kq kr hh lu b fi mi mj l mk ml">#nomos status<br/>Connecting to clusters...<br/>Current   Context    Status       Last Synced Token   Sync Branch<br/>-------   -------    ------       -----------------   -----------<br/>*         cluster_1  SYNCED       1b664887            master   <br/>          cluster_2  SYNCED       1b664887            master</span></pre><p id="5a70" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">在这种情况下，<code class="du lr ls lt lu b">kubectl</code>连接到<code class="du lr ls lt lu b">cluster_1</code>。这样的集群与提交id为<code class="du lr ls lt lu b">1b664887</code>的存储库完全同步。同样，同步发生在资源库的<code class="du lr ls lt lu b">main</code>分支上。对此类分支的任何提交都将触发每个集群上的更新。</p><p id="51ce" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">最后是托管所有集群配置所需的文件夹结构。</p><p id="24a4" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">我们可以使用<code class="du lr ls lt lu b"><a class="ae ki" href="https://cloud.google.com/anthos-config-management/docs/how-to/nomos-command#init" rel="noopener ugc nofollow" target="_blank">nomos init</a></code>命令来建立一个基本的集群结构。一旦执行，它将创建如下所示的树:</p><pre class="ix iy iz ja fd me lu mf mg aw mh bi"><span id="9982" class="kq kr hh lu b fi mi mj l mk ml"><strong class="lu hi"><em class="km">cluster_1</em></strong><br/>├── README.md<br/>├── cluster<br/>├── clusterregistry<br/>├── namespaces<br/>└── system<br/>    ├── README.md<br/>    └── repo.yaml</span></pre><p id="31eb" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">要获得关于存储库结构和语义的完整参考，您可以查看<a class="ae ki" href="https://cloud.google.com/anthos-config-management/docs/concepts/repo" rel="noopener ugc nofollow" target="_blank"> Anthos参考指南</a>。</p><p id="5f5d" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">要验证一个现有的存储库，您可以使用<code class="du lr ls lt lu b"><a class="ae ki" href="https://cloud.google.com/anthos-config-management/docs/how-to/nomos-command#vet" rel="noopener ugc nofollow" target="_blank">nomos vet</a></code>命令。</p><pre class="ix iy iz ja fd me lu mf mg aw mh bi"><span id="19a8" class="kq kr hh lu b fi mi mj l mk ml">nomos vet --path=./cluster_1</span></pre><p id="5e9a" class="pw-post-body-paragraph jm jn hh jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">最后，您可以从一个空的配置存储库开始，或者使用一个现有的演示存储库。在<a class="ae ki" href="https://github.com/GoogleCloudPlatform/csp-config-management" rel="noopener ugc nofollow" target="_blank">演示报告</a>中，有一个<code class="du lr ls lt lu b"><a class="ae ki" href="https://github.com/GoogleCloudPlatform/csp-config-management/tree/1.0.0/foo-corp" rel="noopener ugc nofollow" target="_blank">foo-corp</a></code>集群配置供您检查和执行最基本的部署。</p><h2 id="51b3" class="kq kr hh bd ks kt ku kv kw kx ky kz la jv lb lc ld jz le lf lg kd lh li lj lk bi translated">结论</h2><p id="5dd3" class="pw-post-body-paragraph jm jn hh jo b jp ll ii jr js lm il ju jv ln jx jy jz lo kb kc kd lp kf kg kh ha bi translated">总之，我们看到了如何在每个集群(GKE或其他)上配置Anthos。我们还看到了如何检查集群状态和初始化存储库来托管集群配置。</p></div></div>    
</body>
</html>