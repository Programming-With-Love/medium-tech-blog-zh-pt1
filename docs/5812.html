<html>
<head>
<title>The Kubernetes Node Doctor</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">库伯内特淋巴结医生</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/the-kubernetes-node-doctor-6e44b9b4193c?source=collection_archive---------0-----------------------#2021-08-25">https://medium.com/oracledevs/the-kubernetes-node-doctor-6e44b9b4193c?source=collection_archive---------0-----------------------#2021-08-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/3f14b097717a3bcbeadaf211e33cf835.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XeYtDpUF7ZIA4Rg3GskkDQ.jpeg"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">A doctor for something other than worker nodes</figcaption></figure><div class=""/><h1 id="e617" class="it iu hw bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">介绍节点医生</h1><p id="e17a" class="pw-post-body-paragraph jr js hw jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">我们很高兴地<a class="ae kp" href="https://docs.oracle.com/en-us/iaas/releasenotes/changes/565b4160-c473-442e-8ad6-4a1696d29ec9/" rel="noopener ugc nofollow" target="_blank">宣布面向Kubernetes (OKE)工作节点故障排除工具的新Oracle容器引擎的可用性，我们称之为节点医生</a>。<a class="ae kp" href="https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengtroubleshooting_topic-node_troubleshooting.htm" rel="noopener ugc nofollow" target="_blank">节点医生</a>现在预装在所有OKE工作节点上。</p><p id="9182" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">Node Doctor专注于与Kubernetes和Oracle云基础设施(OCI)之间的交集相关的常见问题，其中大多数问题会影响Kubernetes工作节点的运行状况。Node Doctor运行许多检查，以确保工作节点按预期运行。例如，Node Doctor可用于指示某个节点上的pod数量是否过多，从而导致kubelet(在每个工作节点上运行的主节点代理)出现问题，或者某个节点是否正在运行已知的错误版本的依赖项(如runC ),并且应该被回收。</p><p id="84e5" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">Node Doctor旨在解决与OKE集群工作节点相关的常见基础设施级别问题。如果用户发现自己的workers节点有问题，例如Kubernetes节点状况不是“活动”或者节点状态不是“就绪”,则应该使用Node Doctor对其节点进行故障诊断。Node Doctor提供了对潜在问题的见解，因此您可以让您的节点重新联机。它还可用于捕获有用的数据，以便与Oracle技术支持共享。我们构建了Node Doctor，让客户能够自己解决问题。</p><figure class="kw kx ky kz fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es kv"><img src="../Images/6d7ec2823b6c4ea9d485e175de6f7e30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ffZG3CjXH1FJYR4hhWshWQ.png"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">Node Troubleshooting with Node Doctor</figcaption></figure><p id="8f56" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">要解决节点问题，只需导航到包含有问题节点的节点池，然后单击<strong class="jt hx">解决节点问题</strong>。这将打开一个关于如何访问节点和运行节点医生的多选项对话框。我们知道我们的用户遵循不同的方法来确保他们的节点按照他们的安全实践受到保护。记住这一点，我们选择支持多个路径来访问节点和运行Node Doctor。对其工作节点拥有SSH访问权限的用户可以通过SSH连接，并自己运行命令。没有SSH访问权限的用户可以利用OCI计算功能，该功能允许拥有正确权限的用户在节点上运行命令，即使没有SSH访问权限。有关在OCI计算主机上运行命令的更多信息，请参见<a class="ae kp" href="https://docs.oracle.com/en-us/iaas/Content/Compute/Tasks/runningcommands.htm" rel="noopener ugc nofollow" target="_blank">在实例上运行命令</a>。</p><h1 id="6fad" class="it iu hw bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">核心功能</h1><p id="bbe3" class="pw-post-body-paragraph jr js hw jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">节点医生有两个功能，<strong class="jt hx">检查节点问题</strong>和<strong class="jt hx">生成支持包</strong>:</p><h2 id="7492" class="la iu hw bd iv lb lc ld iz le lf lg jd kc lh li jh kg lj lk jl kk ll lm jp ln bi translated">检查节点问题</h2><pre class="kw kx ky kz fd lo lp lq lr aw ls bi"><span id="c629" class="la iu hw lp b fi lt lu l lv lw">sudo /usr/local/bin/node-doctor.sh --check</span></pre><p id="4fe7" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">该命令将执行一些前提条件检查，以确保worker节点的基础就位。这包括验证Kubernetes工作节点上运行的主节点代理kubelet是否处于活动状态，是否运行正确的版本，以及是否可以访问Kubernetes API服务器。确认满足前提条件后，它将检查各种常见问题，并根据检查结果在问题旁边打印<code class="du lx ly lz lp b">PASS</code>或<code class="du lx ly lz lp b">FAIL</code>。它还会将检查的输出保存在日志文件中，以供将来参考。如果其中一项检查失败，Node Doctor还会打印补救步骤和适用的文档链接。例如，特定的网络相关问题，包括不活动的proxymux证书或不可访问的kube-apiserver，将返回以下输出:</p><pre class="kw kx ky kz fd lo lp lq lr aw ls bi"><span id="aa39" class="la iu hw lp b fi lt lu l lv lw">Network related failures have been detected. Please validate the network settings. Common mistakes include not using a service gateway, incorrect security list rules, and specifying the wrong subnet. </span><span id="e520" class="la iu hw lp b fi ma lu l lv lw">https://docs.oracle.com/en-us/iaas/Content/ContEng/Concepts/contengnetworkconfig.htm</span><span id="dce5" class="la iu hw lp b fi ma lu l lv lw">https://docs.oracle.com/en-us/iaas/Content/ContEng/Concepts/contengnetworkconfigexample.htm"]</span></pre><p id="b326" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">这就是节点医生<code class="du lx ly lz lp b">--check</code>命令的实际效果:</p><pre class="kw kx ky kz fd lo lp lq lr aw ls bi"><span id="7131" class="la iu hw lp b fi lt lu l lv lw">$ sudo /usr/local/bin/node-doctor.sh -c<br/>/usr/local/bin/oke-node-doctor does not exist.<br/>Verified OK<br/>chmod: cannot access ‘oke-node-doctor’: No such file or directory<br/>INFO: Successfully downloaded node doctor.<br/>Running node doctor...<br/>PASS node health...<br/>PASS DNS lookup...<br/>PASS kubelet cert rotation flag...<br/>PASS kubelet logs...<br/>PASS service health...<br/>PASS instance metadata...<br/>PASS image and instance info...<br/>PASS yum status...<br/>PASS flannel status...<br/>PASS coredns status...<br/>PASS proxymux-client status...<br/>PASS kube-proxy status...<br/>PASS pods in ImagePullBackOff...<br/>PASS pods failed mounting volume...<br/>PASS runc version...<br/>PASS pod usage...<br/>​<br/>NODE DOCTOR REPORT<br/>------------------<br/>16/16 checks passed<br/>0 Signal(s) generated<br/>​<br/>Node doctor scan is complete. Report has been saved at /var/log/oke-node-doctor/oke-node-doctor-814.log</span></pre><h2 id="be16" class="la iu hw bd iv lb lc ld iz le lf lg jd kc lh li jh kg lj lk jl kk ll lm jp ln bi translated">生成支持包</h2><pre class="kw kx ky kz fd lo lp lq lr aw ls bi"><span id="b751" class="la iu hw lp b fi lt lu l lv lw">sudo /usr/local/bin/node-doctor.sh --generate</span></pre><p id="1b19" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">该命令将执行上述<code class="du lx ly lz lp b">--check</code>命令的动作，还将生成一个支持包，一个包含诊断信息的. tar文件，可与Oracle技术支持共享。我的Oracle支持(MOS)将提供有关如何上传的信息。tar文件，包含支持票据的捆绑包。</p><p id="0cbb" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">这就是节点医生<code class="du lx ly lz lp b">--generate</code>命令的实际效果:</p><pre class="kw kx ky kz fd lo lp lq lr aw ls bi"><span id="5cb6" class="la iu hw lp b fi lt lu l lv lw">sudo /usr/local/bin/node-doctor.sh --generate</span><span id="0feb" class="la iu hw lp b fi ma lu l lv lw">$ sudo /usr/local/bin/node-doctor.sh -g<br/>INFO: /usr/local/bin/oke-node-doctor already exists and MD5 match.<br/>Running node doctor...<br/>PASS node health...<br/>PASS DNS lookup...<br/>PASS kubelet cert rotation flag...<br/>PASS kubelet logs...<br/>PASS service health...<br/>PASS instance metadata...<br/>PASS image and instance info...<br/>PASS yum status...<br/>PASS flannel status...<br/>PASS coredns status...<br/>PASS proxymux-client status...<br/>PASS kube-proxy status...<br/>PASS pods in ImagePullBackOff...<br/>PASS pods failed mounting volume...<br/>PASS runc version...<br/>PASS pod usage...<br/>​<br/>NODE DOCTOR REPORT<br/>------------------<br/>16/16 checks passed<br/>0 Signal(s) generated<br/>​<br/>Node doctor scan is complete. Report has been saved at /var/log/oke-node-doctor/oke-node-doctor-2127.log<br/>Generating node doctor bundle...<br/>Generated /tmp/oke-support-bundle-2021-07-12T18-01-12.tar</span></pre><h1 id="738e" class="it iu hw bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">节点池工作请求</h1><p id="4dc9" class="pw-post-body-paragraph jr js hw jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">我们最近重新审视了我们公开节点池和控制平面CRUD操作的工作请求的方式。作为这一更改的一部分，我们为每个请求添加了详细信息，包括日志消息、错误消息和相关资源。除了Node Doctor提供的信息之外，这为有用的诊断提供了另一个来源。可以从控制台、SDK、CLI、API和其他界面访问工作请求的详细信息。例如，其群集无法创建的用户可以导航到特定于其群集的控制台的“工作请求详细信息”页面，并查看日志以了解有关失败的详细信息。更多信息，请参见<a class="ae kp" href="https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengviewingworkrequests.htm#contengviewingworkrequests." rel="noopener ugc nofollow" target="_blank">查看工作请求</a>。</p><figure class="kw kx ky kz fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es kv"><img src="../Images/59fd936b9bf6c97715f198e244d321f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KLmcuEQkVLDufTeMtBZIkg.png"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">Node Pool Work Requests</figcaption></figure><h1 id="f3b8" class="it iu hw bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">未来计划</h1><p id="418b" class="pw-post-body-paragraph jr js hw jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">随着时间的推移，Node Doctor将继续得到增强，以包括我们发现的其他问题、症状和解决方案。</p><p id="6502" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">最初发表于<a class="ae kp" href="https://blogs.oracle.com/cloud-infrastructure/post/simplifying-kubernetes-node-troubleshooting-with-node-doctor" rel="noopener ugc nofollow" target="_blank">blogs.oracle.com</a>。</p></div></div>    
</body>
</html>