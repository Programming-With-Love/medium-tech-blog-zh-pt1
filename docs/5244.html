<html>
<head>
<title>KVM + iSCSI Part I: iSCSI Boot With iPXE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">KVM + iSCSI第一部分:带iPXE的iSCSI引导</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/kvm-iscsi-part-i-iscsi-boot-with-ipxe-f533f2666075?source=collection_archive---------0-----------------------#2017-05-19">https://medium.com/oracledevs/kvm-iscsi-part-i-iscsi-boot-with-ipxe-f533f2666075?source=collection_archive---------0-----------------------#2017-05-19</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/d0705fce3596f2d25fa341b46edd1b04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*30eRYtDnF1WBf2uaiKW5gQ.jpeg"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">Computer Keyboard copyright <a class="ae hu" href="https://www.flickr.com/photos/marciecasas/" rel="noopener ugc nofollow" target="_blank">marciecasas</a> <a class="ae hu" href="https://creativecommons.org/licenses/by/2.0/legalcode" rel="noopener ugc nofollow" target="_blank">CC BY</a></figcaption></figure><div class=""/><p id="7832" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">虽然可以将<a class="ae hu" href="https://www.linux-kvm.org/page/Main_Page" rel="noopener ugc nofollow" target="_blank"> kvm </a>连接到<a class="ae hu" href="https://en.wikipedia.org/wiki/ISCSI" rel="noopener ugc nofollow" target="_blank"> iSCSI </a>目标，并将其用作虚拟机的备份磁盘，但直接从iSCSI目标引导可能会有好处。它从磁盘读取和写入中移除了几层间接层，这可以显著改善延迟。为了做到这一点，需要一个助手从bios跳到远程内核。这可以通过一个叫做<a class="ae hu" href="http://ipxe.org/" rel="noopener ugc nofollow" target="_blank"> iPXE </a>的开源软件来实现。</p><h2 id="81b8" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">先决条件</h2><p id="a9ed" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr ha bi translated">首先，安装以下支持软件:</p><ul class=""><li id="8a46" class="ks kt hx iw b ix iy jb jc jf ku jj kv jn kw jr kx ky kz la bi translated">QEMU-系统-x86</li><li id="1016" class="ks kt hx iw b ix lb jb lc jf ld jj le jn lf jr kx ky kz la bi translated">QEMU-utils(fedora上的qemu-img)</li><li id="8db5" class="ks kt hx iw b ix lb jb lc jf ld jj le jn lf jr kx ky kz la bi translated">ipxe-QEMU(fedora上的ipxe-roms-qemu)</li><li id="2f40" class="ks kt hx iw b ix lb jb lc jf ld jj le jn lf jr kx ky kz la bi translated">targetcli</li><li id="5ab0" class="ks kt hx iw b ix lb jb lc jf ld jj le jn lf jr kx ky kz la bi translated">iproute2(大多数linux发行版都安装了这个)</li><li id="10c9" class="ks kt hx iw b ix lb jb lc jf ld jj le jn lf jr kx ky kz la bi translated">vnc客户端</li></ul><h2 id="506f" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">网络安装程序</h2><p id="f7bc" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr ha bi translated">首先为虚拟机创建一个隔离的网桥:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="7fdf" class="js jt hx ll b fi lp lq l lr ls">sudo ip link add virbr0 type bridge<br/>sudo ip link set up virbr0</span></pre><p id="64aa" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">接下来，允许qemu使用桥:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="b598" class="js jt hx ll b fi lp lq l lr ls">echo "allow virbr0" | sudo tee -a /etc/qemu/bridge.conf</span></pre><p id="fbbb" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最后，在桥上给虚拟机管理程序一个地址:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="5b39" class="js jt hx ll b fi lp lq l lr ls">sudo ip addr add 192.168.10.1/24 dev virbr0</span></pre><h2 id="c9ca" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">iSCSI目标设置</h2><p id="b8ac" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr ha bi translated">您将需要一个简单的linux映像来进行测试。Cirros是一个非常小的基于busybox的发行版，非常适合测试:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="9989" class="js jt hx ll b fi lp lq l lr ls">curl -O  <a class="ae hu" href="http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img" rel="noopener ugc nofollow" target="_blank">http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img</a></span></pre><p id="0198" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">接下来，将其从qcow格式转换为原始驱动器:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="d3e4" class="js jt hx ll b fi lp lq l lr ls">qemu-img convert -O raw cirros-0.3.4-x86_64-disk.img cirros.raw</span></pre><p id="0667" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">将转换后的图像设置为背景存储:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="7aa9" class="js jt hx ll b fi lp lq l lr ls">sudo targetcli /backstores/fileio/ \<br/>create cirros $PWD/cirros.raw 100M false</span></pre><p id="0fe8" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">然后，使一个新的iSCSI lun在虚拟机管理程序ip上可用:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="5b54" class="js jt hx ll b fi lp lq l lr ls">sudo targetcli /iscsi create iqn.2016-01.com.example:cirros<br/>sudo targetcli \<br/>/iscsi/iqn.2016-01.com.example:cirros/tpg1/luns \<br/>create /backstores/fileio/cirros<br/>sudo targetcli \<br/>/iscsi/iqn.2016-01.com.example:cirros/tpg1/portals \<br/>create 192.168.10.1</span></pre><p id="5963" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最后，设置ACL并确保驱动器是可写的:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="cb61" class="js jt hx ll b fi lp lq l lr ls">sudo targetcli \<br/>/iscsi/iqn.2016-01.com.example:cirros/tpg1 set attribute \ authentication=0 demo_mode_write_protect=0 \<br/>generate_node_acls=1 cache_dynamic_acls=1</span></pre><h2 id="04c1" class="js jt hx bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">踢</h2><p id="9147" class="pw-post-body-paragraph iu iv hx iw b ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn kr jp jq jr ha bi translated">现在设置完成了，用一些合理的选项运行qemu:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="1950" class="js jt hx ll b fi lp lq l lr ls">sudo qemu-system-x86_64                `# funky name for kvm` \<br/>-smp cpus=2                            `# the more, the better` \<br/>-display vnc=0.0.0.0:0                 `# to access the display` \<br/>-boot order=n                          `# boot from the NIC` \<br/>-netdev bridge,br=virbr0,id=virtio0    `# use our bridge` \<br/>-device virtio-net-pci,netdev=virtio0  `# use a virtio-net device` \</span></pre><p id="33f0" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">可以使用dhcp选项将ipxe配置为引导，但我们将手动配置接口。这意味着我们必须通过vnc控制台连接到我们的来宾才能使用ipxe命令行。您应该能够使用大多数vnc软件连接到虚拟机管理程序机器的ip上的端口5900。我在macbook pro上用的是<a class="ae hu" href="https://sourceforge.net/projects/chicken/" rel="noopener ugc nofollow" target="_blank">鸡</a>。</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="40b8" class="js jt hx ll b fi lp lq l lr ls">ifopen net0<br/>set net0/ip 192.168.10.10<br/>set net0/netmask 255.255.255.0<br/>sanboot iscsi:192.168.10.1::::iqn.2016-01.com.example:cirros</span></pre><p id="72b3" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这将为guest虚拟机设置一个ip地址，并告诉它从您之前创建的iSCSI目标启动。您应该会看到cirros在vnc控制台中启动。您已经直接从iSCSI目标启动了一个虚拟机。恭喜你！如果你想提高网络性能，你可以在<a class="ae hu" rel="noopener" href="/@vishvananda/kvm-iscsi-part-ii-pci-passthrough-a-virtual-function-1fbc1ed40311">第二部分</a>中学习如何用<a class="ae hu" href="http://blog.scottlowe.org/2009/12/02/what-is-sr-iov/" rel="noopener ugc nofollow" target="_blank"> SR-IOV </a>做同样的事情。</p></div></div>    
</body>
</html>