<html>
<head>
<title>Jest v18 to v23 Migration Notes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jest v18到v23迁移注意事项</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/jest-v18-to-v23-migration-notes-b726cf6aafcf?source=collection_archive---------5-----------------------#2019-05-16">https://medium.com/walmartglobaltech/jest-v18-to-v23-migration-notes-b726cf6aafcf?source=collection_archive---------5-----------------------#2019-05-16</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/0ef4eb5b632def4d0fe96fa0749bc84c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BQAkWG-LsUZX2iGBgQbRTg.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Jest Image from <a class="ae it" href="https://jestjs.io/" rel="noopener ugc nofollow" target="_blank">https://jestjs.io/</a></figcaption></figure><p id="935f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Jest是由脸书创建的一个令人愉快的Javascript测试框架。它被许多公司广泛使用，包括我们——沃尔玛网上杂货店。</p><p id="db4a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们很久以前就开始用Jest了(18版)，但是直到最近才有机会升级。由于v18是一个过时的版本，我们因此缺乏许多主要的新功能，我们计划开始这次升级:从v18到v23。</p><p id="dff3" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我的任务是从v18升级到最新的v23。因为我找不到任何关于如何进行这种迁移的好文章，所以我决定写这篇文章。我将详细介绍在升级过程中遇到的5个主要问题。</p><h1 id="8322" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">为什么这么做？</h1><p id="ffd4" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">Jest v23让测试变得令人愉快，以下是一些亮点:</p><ul class=""><li id="1d23" class="kv kw hh iw b ix iy jb jc jf kx jj ky jn kz jr la lb lc ld bi translated">交互式快照模式:允许我们遍历每个失败套件中的每个失败快照，以查看失败的快照，并选择单独更新/跳过每个快照。</li><li id="ee0e" class="kv kw hh iw b ix le jb lf jf lg jj lh jn li jr la lb lc ld bi translated">快照属性匹配器:允许我们向快照匹配器传递指定数据结构的属性，而不是特定的值。</li><li id="6168" class="kv kw hh iw b ix le jb lf jf lg jj lh jn li jr la lb lc ld bi translated">Jest each:允许我们定义一个测试用例表，然后用指定的列值对每一行进行测试。</li><li id="da2c" class="kv kw hh iw b ix le jb lf jf lg jj lh jn li jr la lb lc ld bi translated">调试挂起测试:当Jest不存在时，允许我们调试并找到打开的句柄。</li><li id="8039" class="kv kw hh iw b ix le jb lf jf lg jj lh jn li jr la lb lc ld bi translated">其他几个亮点:自定义异步匹配器、非对称匹配器和新匹配器等。</li></ul><p id="0314" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">要查看完整的博客，请点击查看<a class="ae it" href="https://jestjs.io/blog/2018/05/29/jest-23-blazing-fast-delightful-testing" rel="noopener ugc nofollow" target="_blank">。完整的变更列表，请参见</a><a class="ae it" href="https://github.com/facebook/jest/blob/master/CHANGELOG.md" rel="noopener ugc nofollow" target="_blank">变更日志</a>。</p><h1 id="2736" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">如何对作品进行分段？</h1><p id="9600" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">由于沃尔玛在线杂货应用程序有一个很大的代码库，而我们拥有的Jest版本已经过时，我们需要提前计划如何分割迁移工作。</p><ul class=""><li id="0ec0" class="kv kw hh iw b ix iy jb jc jf kx jj ky jn kz jr la lb lc ld bi translated">首先，我们需要更新全局状态中的依赖项和配置，以确保Jest v23可以成功地开始其测试工作。</li><li id="4dae" class="kv kw hh iw b ix le jb lf jf lg jj lh jn li jr la lb lc ld bi translated">然后我们可以通过模块/文件夹分开更新测试。</li><li id="3020" class="kv kw hh iw b ix le jb lf jf lg jj lh jn li jr la lb lc ld bi translated">一切解决后，一起测试它们。</li></ul><h1 id="6b16" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">依赖关系和配置更新</h1><figure class="lk ll lm ln fd ii er es paragraph-image"><div class="er es lj"><img src="../Images/d8e174124155e3aca678c3d367e01b19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*IVrkqM8tqnSo0eZenH3GxQ.jpeg"/></div><figcaption class="ip iq et er es ir is bd b be z dx">image from <a class="ae it" href="https://www.lgc.org/wordpress/wp-content/uploads/2016/11/code-changes.jpg" rel="noopener ugc nofollow" target="_blank">https://www.lgc.org/wordpress/wp-content/uploads/2016/11/code-changes.jpg</a></figcaption></figure><ul class=""><li id="b064" class="kv kw hh iw b ix iy jb jc jf kx jj ky jn kz jr la lb lc ld bi translated"><strong class="iw hi"> package.json </strong></li></ul><p id="0c0f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">首先我们需要更新<a class="ae it" href="https://jestjs.io/docs/en/23.x/getting-started.html" rel="noopener ugc nofollow" target="_blank"> Jest v23 </a>所需的版本依赖。</p><p id="055c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">package.json:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="0573" class="lt jt hh lp b fi lu lv l lw lx">...<br/>"jest": "23.6.0",<br/>"jest-localstorage-mock": "2.4.0",<br/>...</span></pre><p id="a1ed" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="ly">注意:</em> <code class="du lz ma mb lp b"><a class="ae it" href="https://www.npmjs.com/package/jest-localstorage-mock" rel="noopener ugc nofollow" target="_blank"><em class="ly">jest-localstorage-mock</em></a></code> <em class="ly">模块用于运行依赖于localStorage/sessionStorage的web测试。我们的杂货应用程序有多个地方需要使用本地存储和会话存储API来模拟功能。</em></p><p id="06eb" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">确保运行<code class="du lz ma mb lp b">npm install </code>来安装新模块。</p><ul class=""><li id="fda6" class="kv kw hh iw b ix iy jb jc jf kx jj ky jn kz jr la lb lc ld bi translated"><strong class="iw hi"> jest.config.js </strong></li></ul><p id="f430" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">从Jest v19开始，<code class="du lz ma mb lp b">testPatDirs </code>被重命名为<code class="du lz ma mb lp b">roots </code>以避免在配置Jest时产生混淆。</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="dd23" class="lt jt hh lp b fi lu lv l lw lx">{<br/>  ...<br/>  "roots": ["test/"]<br/>}</span></pre><h1 id="8713" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">常见错误和修复</h1><figure class="lk ll lm ln fd ii er es paragraph-image"><div class="er es mc"><img src="../Images/d066ef1282f2d15ec3fe658186e75d21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*ElyjJ0PvRLT0xD4E9W6QVQ.jpeg"/></div><figcaption class="ip iq et er es ir is bd b be z dx">image from <a class="ae it" href="https://www.google.com/url?sa=i&amp;source=images&amp;cd=&amp;cad=rja&amp;uact=8&amp;ved=0ahUKEwjXhamr-PXhAhXrwIsBHcDACeAQMwixASg4MDg&amp;url=http%3A%2F%2Fwww.uswarwatch.org%2Fcategory%2Fissues%2F&amp;psig=AOvVaw1DFAzOeDI7UiDfzyLcYuwJ&amp;ust=1556649211421770&amp;ictx=3&amp;uact=3" rel="noopener ugc nofollow" target="_blank">Issues — uswarwatch.org</a></figcaption></figure><ul class=""><li id="b4b8" class="kv kw hh iw b ix iy jb jc jf kx jj ky jn kz jr la lb lc ld bi translated"><strong class="iw hi">快照故障</strong></li></ul><p id="9c6c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Jest v19增加了一个快照版本，并将JSX的右括号放在新的一行。这些突破性的变化将导致大量快照测试用例失败。为了解决这个问题，我们需要更新我们的快照工件。您可以使用一个标志来运行Jest，该标志将告诉它重新生成快照:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="da60" class="lt jt hh lp b fi lu lv l lw lx">jest --<!-- -->updateSnapshot</span></pre><p id="8ae2" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">比较更改时，您应该会看到类似于以下内容的更改:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="f23f" class="lt jt hh lp b fi lu lv l lw lx">+ // Jest Snapshot v1, <a class="ae it" href="https://goo.gl/fbAQLP" rel="noopener ugc nofollow" target="_blank">https://goo.gl/fbAQLP</a><br/>+</span><span id="d089" class="lt jt hh lp b fi md lv l lw lx">-       framePadding="0" /&gt;<br/>+       framePadding="0"<br/>+     /&gt;</span></pre><ul class=""><li id="bb12" class="kv kw hh iw b ix iy jb jc jf kx jj ky jn kz jr la lb lc ld bi translated"><strong class="iw hi"> JSDOM重新配置</strong></li></ul><p id="3159" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">从JSDOM v11开始，<code class="du lz ma mb lp b">window</code>上的<code class="du lz ma mb lp b">top</code>属性在规范中被标记为<code class="du lz ma mb lp b">[Unforgeable]</code>，这意味着它是一个不可配置的自有属性，因此不能被JSDOM中运行的正常代码覆盖或隐藏，即使使用了<code class="du lz ma mb lp b">Object.defineProperty</code>。</p><p id="0fe6" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">由于上述原因，您可能会看到如下错误消息:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="4c90" class="lt jt hh lp b fi lu lv l lw lx">TypeError: Cannot redefine property: pathname at Function.defineProperty (&lt;anonymous&gt;)</span><span id="1638" class="lt jt hh lp b fi md lv l lw lx">...<br/>&gt; 744 |     Object.defineProperty(window.location, 'pathname', {<br/>...</span></pre><p id="7192" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们遵循的解决方案来自<a class="ae it" href="https://github.com/facebook/jest/issues/890" rel="noopener ugc nofollow" target="_blank">这个线程</a>，它建议删除全局状态，并分配一个新的来解冻窗口位置对象。我们在<code class="du lz ma mb lp b">jest/setup.js</code>文件中设置了这个:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="91a7" class="lt jt hh lp b fi lu lv l lw lx">const oldLocation = global.window.location;<br/>delete global.window.location;<br/>global.window.location = {...oldLocation};</span></pre><p id="031e" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">类似地，我们将相同的规则应用于窗口<code class="du lz ma mb lp b">sessionStorage </code>对象:</p><pre class="lk ll lm ln fd lo lp lq lr aw ls bi"><span id="b9f8" class="lt jt hh lp b fi lu lv l lw lx">const oldSessionStorage = global.window.sessionStorage;<br/>delete global.window.sessionStorage;<br/>global.window.sessionStorage = {...oldSessionStorage};</span></pre><p id="0ee8" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果你想了解更多关于JSDOM的知识，你可以点击<a class="ae it" href="https://github.com/jsdom/jsdom#reconfiguring-the-jsdom-with-reconfiguresettings" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><ul class=""><li id="daf3" class="kv kw hh iw b ix iy jb jc jf kx jj ky jn kz jr la lb lc ld bi translated"><strong class="iw hi"> addSnapshotSerializer </strong></li></ul><p id="f6b8" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Jest 19+中提供了快照序列化程序，我们使用Jest的默认序列化程序:<a class="ae it" href="https://github.com/adriantoine/enzyme-to-json" rel="noopener ugc nofollow" target="_blank"> enzyme-to-json </a>。这用于调整和格式化快照的输出，使其更具可读性。</p><h1 id="2a23" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">退关货物</h1><figure class="lk ll lm ln fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es me"><img src="../Images/3653829a6732cc17e630d03bd927496e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ebRWA5H09n05kifLD1EmjA.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">image from contenthub-static.grammarly.com</figcaption></figure><p id="49d8" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">非常感谢我的经理桑杰·诺罗尼亚、我的导师大卫·奥查德、杰弗瑞·麦克里菲和阿梅亚·科什蒂，感谢他们一直以来的帮助和支持。也感谢Dat Vong帮助我评论这篇文章。</p></div></div>    
</body>
</html>