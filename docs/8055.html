<html>
<head>
<title>Introducing Walmart’s L3AF Project: Control plane, chaining eBPF programs, and open-source plans.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">介绍沃尔玛的L3AF项目:控制平面、链接eBPF程序和开源计划。</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/introducing-walmarts-l3af-project-control-plane-chaining-ebpf-programs-and-open-source-plans-b96c54823ada?source=collection_archive---------0-----------------------#2021-08-24">https://medium.com/walmartglobaltech/introducing-walmarts-l3af-project-control-plane-chaining-ebpf-programs-and-open-source-plans-b96c54823ada?source=collection_archive---------0-----------------------#2021-08-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="12a1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是介绍L3AF项目的三篇系列文章中的第三篇，该项目使用eBPF和相关技术提供内核功能即服务。虽然这篇博客可以独立阅读，但我们建议在阅读这篇博客之前先阅读第一篇<a class="ae jd" rel="noopener" href="/walmartglobaltech/introducing-walmarts-l3af-project-how-do-we-use-ebpf-to-provide-network-visibility-in-a-8b9ae4d26200"><em class="jc"/></a><em class="jc">和第二篇</em><a class="ae jd" rel="noopener" href="/walmartglobaltech/introducing-walmarts-l3af-project-xdp-based-packet-processing-at-scale-81a13ff49572"><em class="jc"/></a><em class="jc">博客。</em></p><p id="d603" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">eBPF的受欢迎程度正在快速增长。越来越多的eBPF程序被编写来解决各种各样的问题。一些创业公司正在围绕eBPF构建技术，脸书、网飞甚至微软等大型技术公司都在采用eBPF来解决大规模问题。在沃尔玛，我们也采用eBPF，并用它来解决类似的问题。</p><p id="a42b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最初采用eBPF时，我们面临的一个挑战是如何大规模地管理和协调多个eBPF项目。我们需要在一个给定的节点上运行大量eBPF程序，在使用多个云提供商的混合云环境中，我们在许多DC上有数千个节点。由于缺乏企业级解决方案，我们决定开发自己的控制平台。这个控制平面在我们的网络基础设施中编排和组成独立的eBPF程序，以解决关键的业务问题。我们的控制平面是L3AF的重要组成部分。</p><h1 id="972c" class="je jf hh bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">启用内核功能即服务</h1><p id="b8c4" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">我们的控制平面由多个组件组成，这些组件协同工作以协调eBPF计划:</p><ul class=""><li id="10d2" class="kh ki hh ig b ih ii il im ip kj it kk ix kl jb km kn ko kp bi translated">L3AF守护进程(L3AFD)，运行在KF运行的每个节点上。L3AFD读取配置数据，并管理节点上运行的KFs的执行和监控。L3AFD写在<a class="ae jd" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Golang </a>里。</li><li id="c6c9" class="kh ki hh ig b ih kq il kr ip ks it kt ix ku jb km kn ko kp bi translated">部署API，用户调用它来生成配置数据。这些配置数据包括将运行哪些KFs、它们的执行顺序以及每个KF的配置参数。</li><li id="9e2c" class="kh ki hh ig b ih kq il kr ip ks it kt ix ku jb km kn ko kp bi translated">存储配置数据的数据库和KV存储。</li><li id="2c0a" class="kh ki hh ig b ih kq il kr ip ks it kt ix ku jb km kn ko kp bi translated">存储KF字节码的数据存储。</li></ul><p id="72bf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里以图形方式显示了控制平面:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/02928f15049145d10c569f83504f7f62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1hYVErSTQKhiYA-R4lhIwQ.jpeg"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx">L3AF Ecosystem</figcaption></figure><p id="32dd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如上图所示，eBPF KFs可以是社区开发的，也可以是第三方供应商开发的，或者是L3AF提供的。L3AF构建引擎提取内核函数源代码，针对不同的内核版本编译源代码，并将字节码推送到工件管理解决方案。</p><p id="d1a9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当用户想要部署KF时，他们可以使用适当的参数调用L3AFD API。该请求将生成一个新的配置(KV对),该配置将保存在数据库中，并使用配置分发机制跨所有主机分发。</p><p id="ab10" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦L3AFD读取了这个新配置，它就会按照定义的参数在Linux主机上编排内核函数。如果用户给定一组内核函数，那么L3AFD可以按照用户想要的顺序编排所有这些函数。</p><p id="9d18" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">按顺序执行eBPF程序被称为“链接”，它相当复杂(至少对于我们在生产中使用的内核版本来说)。让我们深入探究L3AFD如何让这一切成为可能。下图附有一些解释:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ll"><img src="../Images/00ab133b961b7624ded66acdffeb1e53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JTa1ZC8eL9tJyRXjJp6Ccg.jpeg"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx">L3AFD Orchestration</figcaption></figure><p id="722f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在高层次上，此图显示的是L3AFD通过利用eBPF映射来链接eBPF KFs。链接是通过将下一个程序的文件描述符(fd)存储在前一个程序创建的映射中来实现的。给定的eBPF内核程序然后通过使用bpf_tail_call内核功能调用下一个eBPF内核程序。这种情况重复发生，直到到达链的末端。</p><p id="a10f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">实际上，对于每个链，只有第一个eBPF内核程序连接到网络接口。链中的后续eBPF程序基本上是代表第一个程序调用的。因此，需要一个“根”直通程序。根程序允许链重建，而无需将eBPF程序分离或重新附加到接口。</p><p id="f7d2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下是创建链所涉及的步骤列表:</p><ul class=""><li id="0e43" class="kh ki hh ig b ih ii il im ip kj it kk ix kl jb km kn ko kp bi translated">L3AFD接收的配置包括网络接口和程序类型(XDP、TC入口和TC出口)。它还包含一个序列号，指示KF在链中的位置。根据配置中可用的信息，L3AFD将工件从KF数据存储下载到节点上。</li><li id="fdb9" class="kh ki hh ig b ih kq il kr ip ks it kt ix ku jb km kn ko kp bi translated">如果序列号为1(KF是第一个eBPF程序)，那么L3AFD将执行以下操作:</li></ul><pre class="kw kx ky kz fd lm ln lo lp aw lq bi"><span id="47cf" class="lr jf hh ln b fi ls lt l lu lv">1. Start the appropriate type of root program (i.e., XDP or TC) depending on the program type. This root program will use libbpf APIs or TC hooks to attach the root kernel bytecode to the Network Interface.</span><span id="e041" class="lr jf hh ln b fi lw lt l lu lv">2. Start the “user prog1” of the first KF using APIs with start arguments and this “user prog1” loads the bytecode of “kernel func1” and updates func1 fd into the root map using eBPF APIs.</span></pre><ul class=""><li id="5308" class="kh ki hh ig b ih ii il im ip kj it kk ix kl jb km kn ko kp bi translated">如果序列号是X(在链中间的某处)，L3AFD将执行以下操作:</li></ul><pre class="kw kx ky kz fd lm ln lo lp aw lq bi"><span id="3da7" class="lr jf hh ln b fi ls lt l lu lv">1. Start the KF and update the next KF’s program fd (X+1) to the progX map.</span><span id="2ee1" class="lr jf hh ln b fi lw lt l lu lv">2. Update the progX map into the previous KF’s program map (X-1) like an insertion in the linked list using Cilium’s eBPF <a class="ae jd" href="https://pkg.go.dev/github.com/cilium/ebpf%22" rel="noopener ugc nofollow" target="_blank">library</a> APIs.</span></pre><ul class=""><li id="5370" class="kh ki hh ig b ih ii il im ip kj it kk ix kl jb km kn ko kp bi translated">如果序列号是Z(链中的最后一个KF)，那么L3AFD将执行以下操作:</li></ul><pre class="kw kx ky kz fd lm ln lo lp aw lq bi"><span id="6deb" class="lr jf hh ln b fi ls lt l lu lv">1. Start the KF and update the progZ map into the previous KF’s program map (Z-1).</span></pre><p id="7cd1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">L3AF坚持“一次构建，处处部署”的原则，我们将为任何环境构建一次部署包(即多个内核版本)，并在部署时设置配置。</p><p id="ff46" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">L3AFD也有其他职责。它监视KF运行状况，收集可配置的KF指标，并管理KF资源利用率。这些健康和指标数据以与PromQL兼容的格式导出。</p><p id="4484" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">L3AFD提供了用于配置的API，因此用户可以使用他们现有的系统将配置分发到L3AFD节点。例如，用户可以使用etcd、consul或定制的内部解决方案向L3AF节点分发配置数据。然后，可以实现一个小服务来将配置数据转换为L3AFD API调用。L3AF团队对旨在为混合云环境标准化配置分布的各种项目感兴趣，L3AF的未来版本可能会朝着这个方向发展。</p><p id="0e06" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">说到未来，这对于L3AF来说只是一个开始。我们对未来有许多激动人心的想法。</p><h1 id="04d7" class="je jf hh bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">未来计划</h1><p id="082f" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">eBPF是尖端技术。eBPF特性经常被添加到新的内核版本中。此外，新的用户空间工具和库正在出现，这在几年前我们开始开发L3AF时是不可用的。</p><p id="9d13" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">目前，如上图所示，L3AFD执行单独的C用户空间程序，加载相应的eBPF内核函数。然而，已经创建了一个纯Go eBPF用户空间<a class="ae jd" href="https://pkg.go.dev/github.com/cilium/ebpf%22%20/" rel="noopener ugc nofollow" target="_blank">库</a>(由Cilium创建)。我们计划利用这个库来移植我们所有的C用户空间代码，这将简化我们的用户空间代码并扩展用户空间eBPF程序的功能。我们计划将新的Go用户空间程序实现为基于RPC的插件，以改进过程控制和通信。</p><p id="b6b1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如前所述，KF链接非常复杂。但是，在Linux内核版本5.10及更高版本中可以简化。有了这些内核版本，libxdp和它的xdp调度器功能使得事情变得更加简单(但是我们将保持对旧内核链接的支持)。使用TC的用户空间工具也可以简化TC链接。</p><p id="fa3f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们L3AF项目的另一个关键部分是建立一个“内核函数市场”，在那里KF开发者和用户可以共享他们自己签名的KFs并从其他人那里下载KFs。然后，L3AF可以用于编排和组合来自市场的选定KFs，以满足多种业务需求。内核功能市场的一个重要先决条件是开源L3AF项目，这是沃尔玛和我们团队的首要任务。</p><p id="47d7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们关于沃尔玛eBPF网络解决方案的三部分博客系列到此结束。我们已经讨论了网络可见性、XDP包处理和开发我们自己的控制平面。这些部分组合在一起，形成了我们的L3AF模型，我们用它来以创新的方式解决难题。在结束之前，我们想概述一下L3AF型号的优势。</p><h1 id="5310" class="je jf hh bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">L3AF模型的优势</h1><p id="d156" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">许多商业解决方案可以聚合流量并将其路由到相关的监控和分析工具。然而，这些解决方案是专有的，这限制了它们提供由它们的工程师开发的特性和功能。L3AF背后的想法是提供一个开放的、可扩展的平台，该平台提供某些开箱即用的内核功能。此外，用户还可以根据自己的使用案例和需求，向我们的KF生态系统动态添加产品。</p><p id="2443" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此外，L3AF可以支持需要在流量的直接路径中采取行动的用例。这类用例的几个例子是数据包标记、速率限制、负载平衡和流量导向。这种用例不可能用传统的基于代理的解决方案来实现，因为它们中的大多数仍然在TCP/IP栈中运行它们的程序。L3AF利用eBPF，这允许我们以超低开销在内核中运行这些。此外，它还提供了其他商业工具无法提供的功能，除非它们经历了重大的设计和体系结构级别的更改。这些都给了L3AF在这个领域的先发优势。</p><p id="3068" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">总而言之，以下是我们L3AF模型的主要优势:</p><h2 id="c898" class="lr jf hh bd jg lx ly lz jk ma mb mc jo ip md me js it mf mg jw ix mh mi ka mj bi translated">技术优势如下:</h2><ul class=""><li id="d2d8" class="kh ki hh ig b ih kc il kd ip mk it ml ix mm jb km kn ko kp bi translated">所有内核功能的一站式商店，从而避免供应商和云锁定。</li><li id="d41b" class="kh ki hh ig b ih kq il kr ip ks it kt ix ku jb km kn ko kp bi translated">跨主机分布内核功能，消除网络中的设备和集中阻塞点(并尽可能靠近源)。</li><li id="2191" class="kh ki hh ig b ih kq il kr ip ks it kt ix ku jb km kn ko kp bi translated">支持内核函数链接，以实现所需的工作流。</li><li id="5c6e" class="kh ki hh ig b ih kq il kr ip ks it kt ix ku jb km kn ko kp bi translated">将eBPF用于数据路径，因此提供了超高的性能。</li><li id="e086" class="kh ki hh ig b ih kq il kr ip ks it kt ix ku jb km kn ko kp bi translated">减少执行L3AFD管理的内核功能可能需要的任何额外跳数。</li></ul><h2 id="3b07" class="lr jf hh bd jg lx ly lz jk ma mb mc jo ip md me js it mf mg jw ix mh mi ka mj bi translated">商业利益如下:</h2><ul class=""><li id="1c70" class="kh ki hh ig b ih kc il kd ip mk it ml ix mm jb km kn ko kp bi translated">根据用户需求配置、定制和监控内核功能的灵活平台。</li><li id="bb5b" class="kh ki hh ig b ih kq il kr ip ks it kt ix ku jb km kn ko kp bi translated">降低许可费用和管理众多厂商产品内核功能并使它们协同工作的开销。</li><li id="ffa3" class="kh ki hh ig b ih kq il kr ip ks it kt ix ku jb km kn ko kp bi translated">降低跨平台实现新内核功能的集成成本，避免受到跨平台最低公分母的限制。</li><li id="1314" class="kh ki hh ig b ih kq il kr ip ks it kt ix ku jb km kn ko kp bi translated">减少网络跳数，避免额外的公共云流量成本和瓶颈。</li><li id="3966" class="kh ki hh ig b ih kq il kr ip ks it kt ix ku jb km kn ko kp bi translated">提供尖端技术解决方案，其功能在商业工具中尚属空白。</li></ul><p id="8391" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">L3AF项目还在可观测性、监控和跟踪领域开发解决方案。我们将继续通过博客分享我们的工作，因为我们致力于开源这个项目。感谢收听！</p><p id="ff4d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本博客是根据L3AF项目工程师桑托什·费尔南德斯和 <a class="ae jd" href="https://www.linkedin.com/in/bgmerrell/" rel="noopener ugc nofollow" target="_blank"> <em class="jc">布莱恩</em> </a> <em class="jc">的意见撰写的。</em></p></div></div>    
</body>
</html>