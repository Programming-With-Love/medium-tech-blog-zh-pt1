<html>
<head>
<title>Managing your GCP inventory with Cloud Asset API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用云资产API管理您的GCP库存</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/managing-your-gcp-inventory-with-cloud-asset-api-fef257d82a4d?source=collection_archive---------1-----------------------#2022-05-06">https://medium.com/google-developer-experts/managing-your-gcp-inventory-with-cloud-asset-api-fef257d82a4d?source=collection_archive---------1-----------------------#2022-05-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="d29f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用云资产API和BigQuery的云函数来跟踪你的谷歌云平台(GCP)库存。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/b0d490c8a023b5f67dfc935935f98cfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*gJhYfL8D7eKxqbhV.png"/></div><figcaption class="jk jl et er es jm jn bd b be z dx">Image from Google</figcaption></figure><h1 id="a2ef" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">介绍</h1><p id="5467" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">本文的目的是在云中推广良好的内务管理习惯。我指的是确保资源得到清理，尤其是在较低的环境中，一旦项目进入生产阶段，这些资源有时会被遗忘。诚然，内务处理任务是云不那么性感的部分；工程师和建筑师只想建造东西和玩新玩具，而不是跟踪他们提供的资源。</p><p id="3414" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我希望向您展示如何使用云函数调用<a class="ae kr" href="https://cloud.google.com/asset-inventory" rel="noopener ugc nofollow" target="_blank">云资产API </a>，并将数据导出到BigQuery，您可以使用各种BI工具将这些数据可视化。Cloud Scheduler可用于定期调用云功能，随着时间的推移，您可以构建足够多的数据集来帮助检测异常。</p><h1 id="d624" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">先决条件</h1><p id="1d4a" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">为此，我们需要启用以下API:</p><ul class=""><li id="b5a2" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><strong class="ig hi">云资产API </strong></li><li id="1081" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><strong class="ig hi">云函数API </strong></li><li id="2866" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><strong class="ig hi">云构建API </strong></li><li id="bbd0" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><strong class="ig hi">云发布/订阅API </strong></li><li id="fb49" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><strong class="ig hi">云调度器API </strong></li><li id="4826" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><strong class="ig hi">大查询API </strong></li></ul><p id="7d80" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于我们将运行一个使用默认App Engine服务帐户(<em class="lg">PROJECT _ ID</em>@ appspot . gserviceaccount . com)的云函数，因此您需要将以下IAM角色添加到服务帐户的权限中:</p><ul class=""><li id="393c" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><strong class="ig hi">角色/cloudasset.viewer </strong></li><li id="c05f" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><strong class="ig hi">角色/发布订阅者</strong></li><li id="a639" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><strong class="ig hi">roles/big query . data editor</strong></li></ul><p id="58c6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们还将创建一个BigQuery数据集，将云资产数据导出到:</p><pre class="jd je jf jg fd lh li lj lk aw ll bi"><span id="f6ae" class="lm jp hh li b fi ln lo l lp lq">bq mk \<br/>  --data_location northamerica-northeast1 \<br/>  --dataset cloud_assets</span></pre><p id="29ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因为我们将使用发布/订阅触发器，所以我将创建一个主题:</p><pre class="jd je jf jg fd lh li lj lk aw ll bi"><span id="1d88" class="lm jp hh li b fi ln lo l lp lq">gcloud pubsub topics create cf-cloudasset-trigger</span></pre><h1 id="2aed" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">代码</h1><p id="2f23" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">用以下两个文件创建一个文件夹(我将使用Python运行时):</p><ul class=""><li id="306d" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><code class="du lr ls lt li b">requirements.txt</code></li></ul><pre class="jd je jf jg fd lh li lj lk aw ll bi"><span id="45cc" class="lm jp hh li b fi ln lo l lp lq">google-cloud-asset==3.8.1</span></pre><ul class=""><li id="e200" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><code class="du lr ls lt li b">main.py</code> ( <em class="lg">导出_资产</em>功能)</li></ul><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="lu lv l"/></div></figure><p id="589b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我找不到明确说明如何设置分区键的Python包文档，但它在<em class="lg"> google-cloud-asset </em>包<a class="ae kr" href="https://github.com/googleapis/python-asset/blob/main/google/cloud/asset_v1/types/asset_service.py#L833" rel="noopener ugc nofollow" target="_blank">代码</a>和<a class="ae kr" href="https://cloud.google.com/ruby/docs/reference/google-cloud-asset-v1/latest/Google-Cloud-Asset-V1-PartitionSpec-PartitionKey" rel="noopener ugc nofollow" target="_blank"> Ruby </a>文档中。我强烈建议设置一个分区键，以利用BigQuery中的<a class="ae kr" href="https://cloud.google.com/bigquery/docs/partitioned-tables" rel="noopener ugc nofollow" target="_blank">分区表</a>(另一种方法是每天有一个单独的表)。对于导出，我将调用<a class="ae kr" href="https://cloud.google.com/asset-inventory/docs/reference/rest/v1/TopLevel/exportAssets" rel="noopener ugc nofollow" target="_blank"> <em class="lg"> exportAssets </em> </a>方法(如果您愿意，它也可以作为JSON文件导出到GCS bucket)。</p><p id="839a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">至于<code class="du lr ls lt li b">asset_types</code>，如果不指定，将提取所有的资产类型，但是您可能不想提取所有的资产类型，因此您可以指定一个<a class="ae kr" href="https://cloud.google.com/asset-inventory/docs/supported-asset-types#searchable_asset_types" rel="noopener ugc nofollow" target="_blank">资产类型</a>的列表，它也支持正则表达式，正如我在我的例子中所做的那样。比如:<em class="lg">”。* . Google APIs . com . * Instance "</em>将匹配计算引擎实例、云SQL实例、文件存储实例等。</p><p id="8bcb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用<code class="du lr ls lt li b">gcloud</code>部署功能，并将我们之前创建的发布/订阅主题设置为触发主题:</p><pre class="jd je jf jg fd lh li lj lk aw ll bi"><span id="8cac" class="lm jp hh li b fi ln lo l lp lq">gcloud functions deploy export-cloudasset-to-bq \<br/>  --runtime python39 \<br/>  --entry-point export_tasks \<br/>  --trigger-topic cf-cloudasset-trigger \<br/>  --region northamerica-northeast1 \<br/>  --memory 256MB</span></pre><h1 id="0762" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">云调度程序</h1><p id="2253" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">我们将希望我们的云功能按计划运行，为此我们将使用<a class="ae kr" href="https://cloud.google.com/scheduler" rel="noopener ugc nofollow" target="_blank">云调度器</a>，它非常易于使用，并支持cron格式的调度，这对于像我这样具有系统管理员背景的人来说非常令人欣慰。</p><pre class="jd je jf jg fd lh li lj lk aw ll bi"><span id="d04a" class="lm jp hh li b fi ln lo l lp lq">gcloud scheduler jobs create pubsub daily-cf-cloudasset-export-job \<br/>  --location northamerica-northeast1 \<br/>  --schedule "0 6 * * *" \<br/>  --topic cf-cloudasset-trigger \<br/>  --message-body "Cloud Asset to BigQuery"</span></pre><p id="9363" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">默认情况下，时间是UTC时间，但是如果您愿意，可以指定不同的时区。</p><p id="cd7a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注意:</strong>我每天将我的云资产数据导出到BigQuery一次，但是您可能希望每12小时运行一次(即<code class="du lr ls lt li b">0 */12 * * *</code>)。如果您决定以更高的频率导出，您将希望设置<code class="du lr ls lt li b">output_config.bigquery_desintation.force = False</code>,以便它不会覆盖当天的任何现有数据(记住它是按日期分区的！).</p><h1 id="227b" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">其他使用案例</h1><p id="8845" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">云资产API还可以用于定位不活动的资源，这些资源可能会被删除/清理。为此，我将使用<a class="ae kr" href="https://cloud.google.com/asset-inventory/docs/reference/rest/v1/TopLevel/searchAllResources" rel="noopener ugc nofollow" target="_blank"><em class="lg">search all resources</em></a>方法——这是小型/特定搜索的理想方法，因为结果是分页的，如果您碰巧查询大型数据集，可能会导致大量API调用。以下示例将返回任何已被保留但未被使用的<a class="ae kr" href="https://cloud.google.com/compute/docs/reference/rest/v1/addresses" rel="noopener ugc nofollow" target="_blank">全球或地区地址</a>(因为Google会为此向您收费):</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="lu lv l"/></div></figure><p id="9320" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以上只是一个例子，但是有许多选项/条件可以传递到查询中，以帮助您发现项目或整个组织中浪费的资源。</p><h1 id="faf1" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">后续步骤</h1><p id="70e2" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">如果您想了解更多信息，请参见以下链接中的示例:</p><ul class=""><li id="9a50" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><a class="ae kr" href="https://cloud.google.com/asset-inventory/docs/exporting-to-bigquery" rel="noopener ugc nofollow" target="_blank">导出到BigQuery </a></li><li id="8da0" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><a class="ae kr" href="https://cloud.google.com/asset-inventory/docs/exporting-to-cloud-storage" rel="noopener ugc nofollow" target="_blank">导出到云存储</a></li><li id="dcbb" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><a class="ae kr" href="https://cloud.google.com/asset-inventory/docs/searching-resources-samples" rel="noopener ugc nofollow" target="_blank">搜索资源样本</a></li></ul><h1 id="d620" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">可视化数据</h1><p id="03d5" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">我建议使用BI工具，如<a class="ae kr" href="https://cloud.google.com/bigquery/docs/visualize-data-studio" rel="noopener ugc nofollow" target="_blank"> Data Studio </a>或<a class="ae kr" href="https://cloud.google.com/bigquery/docs/looker" rel="noopener ugc nofollow" target="_blank"> Looker </a>来可视化正在导出到BigQuery的云资产数据。一张图片胜过千言万语，条形图或折线图可以帮助您快速检测GCP库存中的任何异常或峰值。</p><p id="2e5a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">不幸的是，可视化方面不是我的强项，但这里有一个我在Data Studio中为我的示例项目创建的示例时间序列图:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es lw"><img src="../Images/1309889b34427d7372bc2f43bd171032.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_79Yl8-M2aL1N7Wn.png"/></div></div></figure><p id="d7a3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">它只花了我5分钟来创造，我相信有更多经验的人将能够更具视觉吸引力的东西。</p><p id="9007" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注意:</strong>顶部的表格显示了收集数据的7天内的总记录数，而时间序列图表使用了每天的计数。</p></div></div>    
</body>
</html>