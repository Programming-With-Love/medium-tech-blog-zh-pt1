# 开源的 Knox，一个秘密密钥管理服务

> 原文：<https://medium.com/pinterest-engineering/open-sourcing-knox-a-secret-key-management-service-3ec3a47f5bb?source=collection_archive---------0----------------------->

Devin Lundberg | Pinterest 基础设施工程师

Pinterest 在日常运营中需要许多内部机密，例如第三方整合的登录凭证和用于保护通过 HTTPS 传输的用户数据的密钥。随着我们的扩展，在保持机密性的同时仍然允许审计和轮换是至关重要的。为了解决这些问题，我们建立了 Knox，这是一种帮助开发人员编写安全代码以保护 Pinterest 和 Pinners 的服务。今天，我们[开源 Knox](https://github.com/pinterest/knox) 以使其他公司能够安全地存储和管理他们自己的信息，如凭证、密钥和密码，并为每个人提高互联网的安全性。

## 历史

在 Knox 之前，秘密存储在 Pinterest 的源代码控制中，任何工程师都可以根据开发需要使用这些信息。随着工程师数量的增长，恶意软件和网络钓鱼的风险也在增加，这可能导致这些秘密被泄露。此外，接触机密的工程师越多，确定机密泄露的源头就越困难。此外，轮换这些信息需要随着代码的变化重新部署我们的服务，并且没有机制来逐步轮换机密以限制 Pinners 的停机时间。

## 特征

为了解决这些问题，我们建造了 Knox，它被设计成只让机器和在任何给定时间需要它们的用户能够访问秘密。Knox 跟踪访问密钥的人，并由一个简单而强大的版本控制系统构建，因此密钥可以随着时间的推移而轮换。

除了这些重要的功能，Knox 是可扩展的，因此我们可以轻松地过渡到更安全的身份验证、审计和存储机制。Knox 还提供高可用性，考虑到 Pinterest 的每个请求都需要至少一个存储在 Knox 中的秘密，这一点很重要。最后，Knox 为开发人员提供了一个简单的交互界面，因此他们可以继续快速移动并迭代我们的产品。

## 诺克斯是如何工作的

Knox 有两个重要部分:服务器和客户端。Knox 服务器负责实施访问控制、审计所有操作、执行所有与密钥管理相关的任务，并将加密的密钥保存到数据库中。客户端是用户和机器与 Knox 交互的方式。它还为服务提供了一个密钥缓存机制，以防止 Knox 服务器关闭 Pinterest，并允许更快地访问密钥，从而有效地服务于请求。GitHub wiki 有更多关于服务器[和客户端](https://github.com/pinterest/knox/wiki/Knox-API-Serve)[的信息。](https://github.com/pinterest/knox/wiki/Knox-Client)

![](img/ee9e4e176f5af3fc02576320508a2eec.png)

## 逐渐旋转

当我们第一次构建 Knox 时，没有其他开源的密钥管理解决方案。去年，其他几个解决方案已经开源，与 Knox 有相似之处。然而，使 Knox 与众不同的一个关键因素是逐渐旋转密钥的能力，这是非常有益的。

让我们假设一个简单的场景，我们有一个客户端和一个服务器。客户端需要向服务器验证一个秘密。如果这个秘密需要循环，需要发生两个步骤:服务器需要更新以接受这个新的秘密，客户端需要更新以发送它。如果这两个步骤不同时发生，客户机对服务器的请求将同时失败。要么客户机在服务器理解它之前得到新的秘密，要么服务器得到新的秘密并拒绝旧的秘密。当我们同时控制客户端和服务器时，这个问题可以使用 quorums 和 paxos 之类的协议来解决，这些协议是为一致性而设计的，但需要时间并增加了代码库的复杂性。当客户在我们的控制之外时(比如当客户是 Pinner，秘密是他们签名的 cookie)，你不能协调这样的行动。

更好的解决方案是支持多个活动密码，并让服务器接受新旧密码，直到开发人员确认轮换完成。Knox 在其数据模型中内置了这种旋转，旨在允许这些类型的工作流，使旋转更容易，不太可能破坏东西。其他任何密钥管理解决方案都不是这样的。

## 入门指南

Knox 现在可以在 [GitHub](http://github.com/pinterest/knox) 上下载。从 GitHub 页面，您可以通过下载、编译和运行二进制文件来轻松设置您自己的开发服务器和客户端。wiki 中包含了关于重新配置该开发设置的信息，以便将 Knox 用作基础设施的一部分。

*鸣谢:帮助构建 Knox 的贡献者包括 Devin Lundberg、Amine Kamel、Zack Drach、马特·琼斯和 Jon Parise。*