<html>
<head>
<title>Adventures in big data wonderland: Going down the Pinterest Path</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">大数据奇境历险记:沿着Pinterest之路前行</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/adventures-in-big-data-wonderland-going-down-the-pinterest-path-49f6af21f6b5?source=collection_archive---------6-----------------------#2019-08-16">https://medium.com/pinterest-engineering/adventures-in-big-data-wonderland-going-down-the-pinterest-path-49f6af21f6b5?source=collection_archive---------6-----------------------#2019-08-16</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="ef9d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Tamara Louie |数据科学家，Discovery</p><p id="f2a6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你有没有开始在Pinterest上寻找植物，却以购买枕头而告终？你有没有发现自己在寻找一个新想法时陷入重重困境，不知道自己是如何到达那里的，也不知道自己是从哪里开始的？</p><p id="5f24" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当品酒人处于探索心态时，他们可能不确定他们想要什么，直到他们看到它。他们可以从一个总的想法开始，探索相邻的兴趣，深入到一个更具体的想法，或者转向一个完全不同的焦点。</p><p id="b95d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这种行为表现的一种方式是通过“Pinterest路径”，这是一个描述会话中一系列点击的术语(“特写”)。例如，你可能开始搜索一个徒步旅行背包，转而寻找在马丘比丘徒步旅行的灵感，然后寻找秘鲁食物的创意。你不仅找到了一个可以购买的徒步旅行背包，现在你也受到了启发，正在制定旅行和美食计划。通常，Pinterest路径有助于将可能不太相似的想法联系起来，从而帮助Pinners发现新想法。</p><h1 id="2629" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">如何进入Pinterest路径？</h1><p id="96cd" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">Pinterest是一个发现引擎，它通过品味图连接各种想法，因此对于Pinterest上的每个Pin，都有相关的Pin(在视觉和语义上与该Pin相似的Pin)，我们一直在努力<a class="ae kf" rel="noopener" href="/@Pinterest_Engineering/keeping-related-pins-fresh-6b0e2876d7e">保持新鲜</a>。</p><p id="7a80" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">相关图钉允许您浏览与原始图钉直接相关的一个又一个想法。输入Pinterest路径从相关大头针开始，这是当你点击一个大头针并在“更像这样”下看到相关推荐时所看到的内容(参见下面的图1)。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kg"><img src="../Images/5d05b578342178fe25d932c4a066c897.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*A1M8boRKkTPOMAWR"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx"><em class="kw">Figure 1. Example of a Related Pins session.</em></figcaption></figure><h1 id="38f7" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">一个Pinterest路径是如何发挥出来的？</h1><p id="d1a5" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">Pinterest路径的一个例子如图2(下图)所示。</p><ol class=""><li id="8f2b" class="kx ky hh ig b ih ii il im ip kz it la ix lb jb lc ld le lf bi translated">Pinner用植物点击了一个大头针。</li><li id="d410" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated">此人在下面产生的“相关大头针”部分看到了其他想法，并决定单击与最初单击的大头针具有相似颜色主题和整体美感的客厅大头针。</li><li id="4576" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated">Pinner然后在起居室中找到对特定枕头的兴趣，并在相关的Pins部分中找到该枕头。</li></ol><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es ll"><img src="../Images/a7cf5453185be34478c3fe54e7124359.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*W-jrpvBmGEbGOHRS"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx"><em class="kw">Figure 2: Example of a Pinterest Path.</em></figcaption></figure><p id="bf20" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinners可以在Pinterest路径上深入数百层，花几个小时浏览数千个pin，一路上寻找灵感。</p><h1 id="5db4" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated"><strong class="ak">将Pinterest路径构建成图</strong></h1><p id="fc0d" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">当考虑如何可视化和构建这些复杂的Pinterest路径时，将Pinterest路径想象成一个图会很有用。该图中的节点是单个引脚，边是一个引脚和另一个引脚之间发生的特写动作。鉴于潜在的Pin交互数据是如何存储的，将Pinterest路径构建为一个图被证明有点棘手。</p><h2 id="07ef" class="lm jd hh bd je ln lo lp ji lq lr ls jm ip lt lu jq it lv lw ju ix lx ly jy lz bi translated">很难直接从关系数据库中的数据创建图表</h2><p id="9639" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">我们经常以处理过的Hive表的形式访问非常大的数据源。我们感兴趣的信息存储在Hive表的许多行中，表示单个Pinner会话的行不存储标识Pinterest路径中第一个Pin的信息。因此，很难将所有不同的行归属于同一个原始Pinterest路径Pin(参见下面的图3)。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es ll"><img src="../Images/0348d851ea4bed42e43cbe0b16d224db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zr7-Tf19uIaQu0bU"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx"><em class="kw">Figure 3. Example of a Pinterest Path stored in Hive. In this case, it would be difficult to know in Hive that row 3 was part of the same Pinterest Path, originating from Pin A.</em></figcaption></figure><p id="5c88" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们希望避免向会话数据中添加新的日志记录，因此我们需要弄清楚如何使用Hive来有效地聚合识别和量化Pinterest路径所需的信息。这需要识别Hive数据中源自原始Pin的所有行，并创建关于每个Pinterest路径的深度和宽度的摘要信息。虽然描述起来很简单，但这种类型的操作在SQL中可能非常笨拙且效率低下。</p><h2 id="641c" class="lm jd hh bd je ln lo lp ji lq lr ls jm ip lt lu jq it lv lw ju ix lx ly jy lz bi translated"><strong class="ak">使用Python map-reduce脚本创建解决方案</strong></h2><p id="34cf" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">解决方案是在Hive中创建一个自定义Python map-reduce脚本，以读入Pinterest路径数据，对其进行处理，并将聚合的网络数据写入另一个Hive表。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es ll"><img src="../Images/3a40e5383041cd60752b17cf8c2293f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yjQCms4Ojv3_4fSN"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx"><em class="kw">Figure 4. Example of using a Python map-reduce script in Hive for a Pinterest Path example.</em></figcaption></figure><p id="b277" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">来自Apache Hive团队的文档被用作资源。图5(如下)显示了用于调用定制Python map-reduce脚本的Hive语法示例</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es ma"><img src="../Images/5cda9ba2974e3df2ae73de1ea4f8c670.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IX9qN_vVmOYQ6RlbqYpk4Q.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx"><em class="kw">Figure 5. Example Hive syntax to utilize custom Python map-reduce script.</em></figcaption></figure><h2 id="3f28" class="lm jd hh bd je ln lo lp ji lq lr ls jm ip lt lu jq it lv lw ju ix lx ly jy lz bi translated"><strong class="ak">在扩大生产规模时识别并修复错误</strong></h2><p id="74f3" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">当使用单个示例进行测试时，我们的第一个解决方案运行良好，输出了预期的Pinterest路径统计数据。但是，在生产数据上运行时，输出不正确。</p><p id="a806" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们在生产中遇到这个问题的一个原因是需要将来自相同会话的行发送到相同的reducer，以执行定制的reduce操作。如果给定会话的一些行被发送到不同的归约器，结果可能是同一会话的两个或更多条目(每个条目来自不同的归约器)，每个条目都低估了最终的网络统计数据。</p><p id="397e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Hive中通过子句指定<a class="ae kf" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+SortBy#LanguageManualSortBy-SyntaxofClusterByandDistributeBy" rel="noopener ugc nofollow" target="_blank"> CLUSTER通过指定应该将哪些行分组发送给每个reducer解决了这个问题。该解决方案实现了离线测试中观察到的预期输出，这使我们能够安全地将这项工作启动到每天处理数百万行数据的生产数据作业中，以找到Pinterest路径。</a></p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es ll"><img src="../Images/9c40632dbb395fcf1cb12b10bc08abd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Hffq5dxHhoW05-hU"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx"><em class="kw">Figure 6. Example of using CLUSTER BY syntax to send rows from the same session to the same reducers.</em></figcaption></figure><p id="0ce3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最终的Hive查询如下图7所示。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mb"><img src="../Images/0b9c16cd32bb129e2561425035e076ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ki0hMdainvOWsSKsF-_d7A.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx"><em class="kw">Figure 7. Example Hive syntax to utilize custom Python map-reduce script, incorporating CLUSTER BY syntax. In this case, sent all rows with the same value of field “session” to the same reducers.</em></figcaption></figure><p id="1851" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这项工作强调了在生产中验证数据查询功能与在开发期间使用的示例数据相同的重要性，以及在从Hive数据构建复杂的网络统计数据时可能出现的挑战。</p><p id="2dba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，我们已经解决了这些数据处理问题，并使我们的工作流程生产化，我们能够更好地理解Pinterest用户的口味。Pinterest路径的一些常见切入点来自DIY、家居装饰和女性时尚别针。Pinners可以在这些Pinterest路径上花费数小时，深入到单个主题或多个主题的数百个层次，在此过程中发现新的想法。</p><p id="4b16" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest的本质是给每个人带来创造他们热爱的生活的灵感，让人们探索，直到找到最适合他们的答案。无论是在相关的大头针中从一个想法跳到另一个想法，从镜头视觉搜索中缩小推荐范围，还是在新的“更多想法”标签中浏览类似的大头针，我们都在继续寻找方法来帮助人们找到最适合他们的想法——立即，或者冒险进入他们自己的Pinterest之路。</p><p id="12b5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">鸣谢:我要感谢相关的Pins团队，以及黄芝琪和丹·弗兰科斯基，感谢他们的广泛讨论、指导和帮助，使这个项目成为现实。</p></div></div>    
</body>
</html>