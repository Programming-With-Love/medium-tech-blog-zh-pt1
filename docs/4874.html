<html>
<head>
<title>Advent of Kotlin, week 4: Interface Mocking</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">科特林的来临，第四周:界面模拟</h1>
<blockquote>原文：<a href="https://blog.kotlin-academy.com/advent-of-kotlin-week-4-mocking-cde699ec9963?source=collection_archive---------0-----------------------#2018-12-16">https://blog.kotlin-academy.com/advent-of-kotlin-week-4-mocking-cde699ec9963?source=collection_archive---------0-----------------------#2018-12-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/fd7d3a1d1787e71c9e404b328fc80daa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nLp3MyGV5_xaTtDo4ihMRQ.png"/></div></div></figure><p id="45a1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">欢迎来到科特林降临的最后一周<a class="ae kt" rel="noopener ugc nofollow" target="_blank" href="/the-advent-of-kotlin-2018-week-1-229e442a143">。后面还有许多巨大的挑战，前面还有最后一个也是最具挑战性和最开放的任务。这次我们会觉得有点像嘲讽库的开发者。</a></p><p id="a7a0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们每天都在使用类似<a class="ae kt" href="https://site.mockito.org/" rel="noopener ugc nofollow" target="_blank"> Mockito </a>或<a class="ae kt" href="https://mockk.io/" rel="noopener ugc nofollow" target="_blank">mock</a>这样的嘲讽库。我们信任它们，并期望它们总是正确工作。我们经常把嘲讽当成开发必备，也经常忘记实现一个嘲讽库有多难。老实说，自从我开始深入研究这些库，我就有一种感觉，它们的存在以及它们的良好运行是一个奇迹。很高兴有人花了这么多时间让这一切成为可能。一部分是为了表示敬意，一部分是因为对你使用的所有东西的工作原理有所了解是有好处的，本周我们将实现一个非常简单的接口模仿JVM。</p><p id="6f13" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要弄清楚的是:类模仿更复杂，通常使用一些额外的库如ByteBuddy来完成。尽管由于Java的支持，界面模仿变得更加容易。我们将使用的对象是<a class="ae kt" href="https://docs.oracle.com/javase/7/docs/api/java/lang/reflect/Proxy.html" rel="noopener ugc nofollow" target="_blank">代理</a>。</p><h1 id="3e36" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">界面模拟</h1><p id="b838" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">我们想要实现的是一种创建对象mock的方法，它的行为类似于一个接口，但它不是实现一个接口，而是基于某种规范来操作。例如，在<a class="ae kt" href="https://mockk.io/" rel="noopener ugc nofollow" target="_blank">mock</a>中，我们可以用以下方式指定它:</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="906d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如你所见，在<code class="fe md me mf mg b">every</code>中，我们指定当我们请求方法时应该返回什么。我们没有实现一个库，也不需要DSL，所以我们可以用一个更简单的API来代替它:</p><p id="0302" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这里我们可以看到方法<code class="fe md me mf mg b">setReturnValue</code>只说明应该返回什么，方法<code class="fe md me mf mg b">setBody</code>可以用来指定这个函数的整体。我们也应该能够使用论点。</p><h1 id="ee83" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">接口代理</h1><p id="72e0" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">这个任务相对简单，因为Java内置了对代理接口的支持。什么是接口代理？它是一个伪装成接口的对象，它不实现方法，而是将所有调用指向同一个函数。让我们看一个例子:</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="9121" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如何使用这个代理的一个很好的例子是<a class="ae kt" href="https://square.github.io/retrofit/" rel="noopener ugc nofollow" target="_blank">改造</a>。在这个库中，我们使用方法和注释在接口中定义网络调用:</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="5538" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用这些定义，我们可以创建实例并使用它们进行互联网呼叫:</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="516f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">正如您所猜测的，方法返回一个代理。<a class="ae kt" href="https://github.com/square/retrofit/blob/master/retrofit/src/main/java/retrofit2/Retrofit.java#L128" rel="noopener ugc nofollow" target="_blank">在这里你可以看到它的代码</a>。每个用法都被传递给同一个处理程序，然后根据接口中使用的注释，构造网络调用。</p><p id="38c6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">同样的方式，我们可以实现界面模拟。对于每个实例，我们可以只保存关于每个调用应该如何被服务的信息，并在使用这个方法时使用它。最大的问题是我们如何传递这些信息？答案是你需要允许一个特殊的录制模式。</p><figure class="lx ly lz ma gt jo gh gi paragraph-image"><a href="https://leanpub.com/effectivekotlin/c/3YYtCtqCC6a4"><div class="gh gi mh"><img src="../Images/0742a8ad0cfd3851db2d28061bf6f214.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xbef0K0JtDZ6F2vBVUDZsg.jpeg"/></div></a></figure><h1 id="7ab6" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">记录方式</h1><p id="2090" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">最大的问题是如何传递一条应该返回或调用的信息。我们不能将它直接传递给对象，因为它已经被模仿了，并且它没有任何方法，除了接口上的那些方法。我们需要在调用这些方法时传递这些信息:</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="3417" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">怎么会？最简单的回答就是这次切换一些录音模式。这并不漂亮，也不是线程安全的，但是如果我们假设在同一时间只有一个测试运行，并且这些是测试而不是生产代码，这就很好了。</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="0b12" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">那么在我们的代理中，我们会说:</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="8116" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你有更好的主意，就去做吧。请记住，这里的首要任务是让它发挥作用。这是一个困难且非常不寻常的问题，需要一些黑客技术。Java不是为支持模仿而构建的。</p><h1 id="2613" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">工作</h1><p id="3dca" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">实现简单的接口模拟来实现这一点:</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="af93" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你更有野心，你可以推进它，也允许一些争论。我们可以假设它们作为列表<code class="fe md me mf mg b">Any</code>传递给函数:</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="3626" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">用单一和多种方法测试不同的接口。当一个体被两次设置为相同的方法时会发生什么？</p><h1 id="443e" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">应用挑战</h1><p id="a86d" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">本周末，我们将分享我们最喜欢的解决方案。如果你想让我们考虑你的解决方案，你需要在Twitter上分享一个代码链接(可以是GitHub片段或Kotlin REPL的链接)，标签为#AdventOfKotlin18。或者，您可以将您的解决方案发送到电子邮件contact@kt.academy。最后期限是12月23日中午12点(欧洲中部时间)。更多详情<a class="ae kt" rel="noopener ugc nofollow" target="_blank" href="/the-advent-of-kotlin-2018-week-1-229e442a143">此处</a>，祝好运:)</p><h1 id="423f" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">结果</h1><p id="3c35" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">这是一项深思熟虑的任务，然而还是有英雄解决了它。我要向他们每一个人表示祝贺。我从以下方面得到了很好的回答:</p><ul class=""><li id="af44" class="mi mj in jx b jy jz kc kd kg mk kk ml ko mm ks mn mo mp mq bi translated">何塞·伊格纳西奥·阿辛波佐(<a class="ae kt" href="https://stackoverflow.com/users/6783451/jose-ignacio-acin-pozo" rel="noopener ugc nofollow" target="_blank"> SO </a>，<a class="ae kt" href="https://github.com/Ganet" rel="noopener ugc nofollow" target="_blank"> GitHub </a>)</li><li id="7471" class="mi mj in jx b jy mr kc ms kg mt kk mu ko mv ks mn mo mp mq bi translated">克里斯蒂安·福赫斯</li><li id="bda9" class="mi mj in jx b jy mr kc ms kg mt kk mu ko mv ks mn mo mp mq bi translated">巴拉兹·内梅思</li><li id="7ed8" class="mi mj in jx b jy mr kc ms kg mt kk mu ko mv ks mn mo mp mq bi translated">彼得·古利亚斯</li><li id="587f" class="mi mj in jx b jy mr kc ms kg mt kk mu ko mv ks mn mo mp mq bi translated">奥利弗·佩雷斯</li></ul><p id="de08" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">每个人都正确地实现了基本的模仿功能。这个功能可以用这个极简的实现来展示:</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="d1d1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后可以添加一些DSL，如Oliver Perez的实现:</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="d253" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在<a class="ae kt" href="https://github.com/olivierperez/AdventOfCode2018" rel="noopener ugc nofollow" target="_blank">他的知识库</a>上查看一下。</p><p id="dc81" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这个挑战最难的部分是使用<code class="fe md me mf mg b">any()</code>而不是一个参数。最后，我们需要使用这个函数，所以需要传递一些东西。应该是什么？</p><p id="4faf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最简单的想法是让用户决定它应该是什么:</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="e0f3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这个解决方案是克里斯蒂安·福赫斯发来的，我必须说，这个技巧的简单性给我留下了深刻的印象。整个实现都在Github上:</p><div class="mw mx gp gr my mz"><a href="https://github.com/fuchsch1234/AdventOfKotlin2018" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd io gy z fp ne fr fs nf fu fw im bi translated">fuchsch1234/AdventOfKotlin2018</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">通过在GitHub上创建帐户，为fuchsch1234/AdventOfKotlin2018开发做出贡献。</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">github.com</p></div></div><div class="ni l"><div class="nj l nk nl nm ni nn jt mz"/></div></div></a></div><p id="5cdc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我最喜欢的实现是何塞·伊格纳西奥·阿信·波佐发的(<a class="ae kt" href="https://stackoverflow.com/users/6783451/jose-ignacio-acin-pozo" rel="noopener ugc nofollow" target="_blank"> SO </a>，<a class="ae kt" href="https://github.com/Ganet" rel="noopener ugc nofollow" target="_blank"> GitHub </a>)。这是我们这周的冠军。令人惊讶的是，这是第一个send实现。整个代码组织良好，功能强大，这就是他如何解决获取任何值的问题:</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="386d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">换句话说:如果它是一个原语或者一个已知类型，使用一个特殊映射中的实例。否则，使用不带任何参数的构造函数创建实例。此外，缓存值不会为已创建的类型创建新的实例。这近乎完美。通过检查这个构造函数是否存在，如果不存在，就用多一个参数检查一个构造函数，这可能会向前推进一步。然后用同样的方法创建随机值来填充这些参数。不完美，但足够好了。如你所见，编写嘲讽库绝对不容易。</p><p id="f2bb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">该解决方案以及之前的所有解决方案都可以在GitHub上找到:</p><div class="mw mx gp gr my mz"><a href="https://github.com/Ganet/AdventOfKotlin2018" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd io gy z fp ne fr fs nf fu fw im bi translated">Ganet/AdventOfKotlin2018</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">Kt的AdventOfKotlin 2018每周练习。学院- Ganet/AdventOfKotlin2018</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">github.com</p></div></div><div class="ni l"><div class="no l nk nl nm ni nn jt mz"/></div></div></a></div><p id="efc9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">干得好！</p></div><div class="ab cl np nq hr nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ig ih ii ij ik"><h2 id="1ff1" class="nw kv in bd kw nx ny dn la nz oa dp le kg ob oc li kk od oe lm ko of og lq oh bi translated">单击👏说“谢谢！”并帮助他人找到这篇文章。</h2><p id="5260" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">你需要Kotlin工作室吗？访问我们的网站<a class="ae kt" href="https://www.kt.academy/" rel="noopener ugc nofollow" target="_blank">看看我们能为您做些什么。</a></p><p id="2ae5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">了解卡帕头最新的重大新闻。Academy，<a class="ae kt" href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a" rel="noopener ugc nofollow" target="_blank">订阅时事通讯</a>，<a class="ae kt" href="https://twitter.com/ktdotacademy" rel="noopener ugc nofollow" target="_blank">观察Twitter </a>并在medium上关注我们。</p><figure class="lx ly lz ma gt jo gh gi paragraph-image"><a href="http://eepurl.com/diMmGv"><div class="gh gi mh"><img src="../Images/3146970f03e44cb07afe660b0d43e045.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*54OqlYA4etu7wfpmMP5TKQ.png"/></div></a></figure></div></div>    
</body>
</html>