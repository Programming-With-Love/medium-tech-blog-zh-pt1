<html>
<head>
<title>High Availability Kafka Service in Microsoft Azure Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">微软Azure云中的高可用性Kafka服务</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/high-availability-kafka-service-in-microsoft-azure-cloud-5c26f69bf4ef?source=collection_archive---------0-----------------------#2019-06-18">https://medium.com/walmartglobaltech/high-availability-kafka-service-in-microsoft-azure-cloud-5c26f69bf4ef?source=collection_archive---------0-----------------------#2019-06-18</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/95d0b885f8dcf3bad1c12c7cecf4673d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bZc0CRA2jhfqY9qIkwIvJw.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Safe replicas, safe teams!</figcaption></figure><p id="2776" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Apache Kafka是一个分布式流平台，在大多数环境中，通过适当的配置设置可以实现高可用性。但是，如果你想在微软Azure中建立一个Kafka集群，使用其独特的容错域和更新域风格以及虚拟机的<a class="ae jr" href="https://azure.microsoft.com/en-us/support/legal/sla/virtual-machines/v1_8/" rel="noopener ugc nofollow" target="_blank"> SLA，高可用性Kafka服务可能会受到损害，即使你严格遵循来自HCC </a> (Hortonworks社区连接)的<a class="ae jr" href="https://community.hortonworks.com/articles/185086/ha-design-and-deployment-considerations-for-deploy.html" rel="noopener ugc nofollow" target="_blank">建议。</a></p><h1 id="bd40" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated"><strong class="ak">目标</strong></h1><p id="12b5" class="pw-post-body-paragraph it iu hh iv b iw kq iy iz ja kr jc jd je ks jg jh ji kt jk jl jm ku jo jp jq ha bi translated">构建一个Kafka Azure客户端工具，在微软Azure云中实现高可用性Kafka服务。</p><h1 id="d9f7" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated"><strong class="ak">背景</strong></h1><p id="f491" class="pw-post-body-paragraph it iu hh iv b iw kq iy iz ja kr jc jd je ks jg jh ji kt jk jl jm ku jo jp jq ha bi translated">如果您可以正确管理kafka和主题配置，例如使用正确的副本因子实现冗余，并使用rack awareness (kafka 0.10)在机架间传播副本，Kafka应用程序将具有高可用性和对节点故障的弹性。但是，如果您在Microsoft Azure Cloud上设置Kafka集群，机架感知功能将会受到影响。</p><p id="5a25" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Microsoft Azure上的虚拟机可能会受到一些情况的影响:计划外的硬件维护、意外停机和计划内维护。虚拟机将经历意外停机(重新启动),在某些情况下还会丢失临时驱动器。除此之外，虚拟机可以重新启动并重新定位到不同的服务器或不同的机架。为了减少一个或多个此类事件对您系统的影响，微软建议用户在一个<strong class="iv hi">可用性集</strong>中配置多个虚拟机，以实现高可用性和冗余。</p><p id="f194" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">什么是<a class="ae jr" href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/tutorial-availability-sets" rel="noopener ugc nofollow" target="_blank"> <strong class="iv hi">可用性集</strong> </a>？<br/>可用性集是数据中心内虚拟机的逻辑分组，用于提供冗余和可用性。Azure云中的每个虚拟机都被底层Azure平台分配了一个<strong class="iv hi">容错域</strong>和一个<strong class="iv hi">更新域</strong>。<strong class="iv hi">故障域</strong>定义了共享公共电源和网络交换机的一组虚拟机(类似于机架的概念)。<strong class="iv hi">更新域</strong>表示可以同时重启的虚拟机组和底层物理硬件。</p><figure class="kw kx ky kz fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kv"><img src="../Images/d4745e6ef67fc06525a7fe0651835a26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dx0DIncovX_laGSOncG9Ng.png"/></div></div></figure><p id="a6b2" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">意识到Azure VM维护和意外停机可能会影响高可用性Kafka服务，微软在其HDinsight托管服务中提供了一个重新平衡工具。该工具将为现有主题分区提供重新平衡特性，但不为主题创建提供，并且不会意识到VM(代理)域在重新启动后发生了变化。此工具只能在特定的Microsoft托管服务环境中使用。因此，我们需要一个独立的工具，它是通用的，任何Kafka实例或集群都可以访问。</p><h1 id="1b1b" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">范围和特点</h1><p id="922d" class="pw-post-body-paragraph it iu hh iv b iw kq iy iz ja kr jc jd je ks jg jh ji kt jk jl jm ku jo jp jq ha bi translated">我们的Kafka Azure客户端工具可以像Kafka客户端一样使用，以实现Azure云中的高可用性。它具有以下特点</p><ul class=""><li id="3853" class="la lb hh iv b iw ix ja jb je lc ji ld jm le jq lf lg lh li bi translated">在高可用性集中创建主题分区</li><li id="a882" class="la lb hh iv b iw lj ja lk je ll ji lm jm ln jq lf lg lh li bi translated">重新平衡存在风险的现有分区，将它们重新分配到高可用集</li></ul><p id="2fba" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">它还具有以下附加功能</p><ul class=""><li id="2697" class="la lb hh iv b iw ix ja jb je lc ji ld jm le jq lf lg lh li bi translated">设置cronjob以检测虚拟机域更改，并自动触发受影响分区的重新平衡作业，重新分配分区以使它们再次高可用。</li><li id="cf4e" class="la lb hh iv b iw lj ja lk je ll ji lm jm ln jq lf lg lh li bi translated">可用作java API，由任何java程序调用以创建主题，在具有高可用性特征的Azure环境中重新分配主题分区。</li></ul><h1 id="6394" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">例子</h1><p id="b5ae" class="pw-post-body-paragraph it iu hh iv b iw kq iy iz ja kr jc jd je ks jg jh ji kt jk jl jm ku jo jp jq ha bi translated"><em class="lo">答:以下示例在2个容错域和3个更新域上创建了6台虚拟机。本课题分为三个部分:P0，P1，P3。每个分区有2个副本:副本1、副本2 </em></p><p id="5542" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">(左)所有分区都存在高可用性风险，原因如下所述。</p><p id="a7ad" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">(右)使用Kafka Azure客户端工具重新平衡话题后。所有3个分区的副本都被重新分配给适当的代理(VM)并实现了<strong class="iv hi">高可用性—副本都在不同的容错域和不同的更新域上。</strong></p><figure class="kw kx ky kz fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lp"><img src="../Images/18d716e10fe66eaba7f80e7aa7b90005.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EAy0GfBMch6XO-iME1E6BA.png"/></div></div></figure><p id="ff3d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><em class="lo"> B:这个例子解释了在代理关闭并在不同的更新域上启动后，如何重新实现高可用性，这使得驻留在这个代理上的副本的高可用性有风险。</em></p><p id="bae8" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">1.主题由Kafka Azure客户端工具创建，具有高可用性。</p><p id="1422" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">2.代理3关闭，并在不同的容错域和更新域上启动。从FD2UD2变成了FD1UD4。分区1和分区2存在高可用性风险，因为代理2和代理3位于同一个故障域FD1上。更新域作业将检测代理3的域更改，并重新平衡代理3上的分区</p><p id="5f3b" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">3.代理3会自动触发重新平衡作业。在为分区1和分区2重新分配副本后，再次实现了高可用性。</p><figure class="kw kx ky kz fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lq"><img src="../Images/2a496d5778411b33c54d1d30fcf21998.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LNpd-8HkLfwRm-VE9WzbRg.png"/></div></div></figure><h1 id="f79b" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">技术细节</h1><p id="5e64" class="pw-post-body-paragraph it iu hh iv b iw kq iy iz ja kr jc jd je ks jg jh ji kt jk jl jm ku jo jp jq ha bi translated">为了1)高效地为所有分区的副本找到一组高可用性代理2)在Kafka集群中公平地分布副本，实现了以下算法和逻辑来实现目标。</p><ul class=""><li id="7862" class="la lb hh iv b iw ix ja jb je lc ji ld jm le jq lf lg lh li bi translated">制定一个FaultDomain/UpdateDomain列表，从中可以按顺序获得可用性集<br/>，例如Azure云中的20个虚拟机，其中有3个FaultDomain和20个UpdateDomain</li></ul><figure class="kw kx ky kz fd ii"><div class="bz dy l di"><div class="lr ls l"/></div></figure><ul class=""><li id="2319" class="la lb hh iv b iw ix ja jb je lc ji ld jm le jq lf lg lh li bi translated">通过选择随机的起点来获得公平的副本分布。领导者和跟随者的数量将被考虑来选择复制品的领导者。</li><li id="2110" class="la lb hh iv b iw lj ja lk je ll ji lm jm ln jq lf lg lh li bi translated">当代理虚拟机驻留在从随机起点开始违反顺序设置的可用性的环境中时，该工具会将计算的FDUD列表中的窗口切换到下一个索引。</li></ul><figure class="kw kx ky kz fd ii"><div class="bz dy l di"><div class="lr ls l"/></div></figure><ul class=""><li id="ba78" class="la lb hh iv b iw ix ja jb je lc ji ld jm le jq lf lg lh li bi translated">在某些情况下，例如大多数代理都关闭了，或者只有1或2个容错域被利用。FDUD列表可能导致“没有高可用集可用”。但是您仍然希望创建主题以避免数据丢失，可以使用“-force”选项来创建主题或重新分配副本。当Kafka集群恢复正常时，您可以触发重新平衡任务，将分区副本移回高可用性集。</li><li id="5970" class="la lb hh iv b iw lj ja lk je ll ji lm jm ln jq lf lg lh li bi translated">虚拟机故障域和更新域信息将被创建并作为ZNode存储在zookeeper中。(/brokers/domains/ <brokerid> → FD0UD0)</brokerid></li></ul><h1 id="077f" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">卡夫卡未决问题</h1><p id="9a20" class="pw-post-body-paragraph it iu hh iv b iw kq iy iz ja kr jc jd je ks jg jh ji kt jk jl jm ku jo jp jq ha bi translated">在开发过程中，我们遇到了一些Kafka开放的副本重新分配功能的问题。我们对Kafka Azure客户端工具进行了一些改进，以解决一些未解决的问题。对于一些人来说，我们将在未来进行改进，并在Kafka解决他们的问题后采用新的协议。</p><ul class=""><li id="aa36" class="la lb hh iv b iw ix ja jb je lc ji ld jm le jq lf lg lh li bi translated"><a class="ae jr" href="https://issues.apache.org/jira/browse/KAFKA-1792" rel="noopener ugc nofollow" target="_blank"> KAFKA-1792 </a>改变“生成”的行为，以产生具有公平副本分配和最小重新分配数量的分配配置</li></ul><p id="ada3" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">重新分配分区是一项劳动密集型任务，并且[-generate]选项不会考虑当前的副本分配，也不会尝试最小化代理之间的副本移动次数。大型副本重新分配可能会影响群集性能。这是写在上面的卡夫卡公开票。</p><p id="fbc8" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Kafka Azure客户端工具中的改进:重新平衡功能能够将特定的代理Id作为参数，并且只重新分配驻留在该代理上的分区，以最小化副本移动的数量。</p><ul class=""><li id="d997" class="la lb hh iv b iw ix ja jb je lc ji ld jm le jq lf lg lh li bi translated"><a class="ae jr" href="https://issues.apache.org/jira/browse/KAFKA-5601" rel="noopener ugc nofollow" target="_blank"> KAFKA-5601 </a>重构重新分配分区命令以使用AdminClient</li></ul><p id="49a0" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">目前，重分配分区命令(由kafka-reassign-partitions.sh使用)直接与ZooKeeper对话。让它使用AdminClient API会更好。Kafka Azure客户端工具也使用ReassignPartitionsCommand通过ZooKeeper重新分配副本。当这个Kafka open ticket解析后，我们可以相应地将其更改为使用AdminClient API。</p><p id="99ca" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Kafka Azure客户端工具中的改进:新的主题创建使用了新的AdminClient API。</p><h1 id="2f0b" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">未来的其他改进</h1><p id="d8b5" class="pw-post-body-paragraph it iu hh iv b iw kq iy iz ja kr jc jd je ks jg jh ji kt jk jl jm ku jo jp jq ha bi translated">在为副本分配代理时，可以考虑磁盘使用情况。</p><p id="91d0" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">自动将一些分区负载重新分配给新加入的代理，以实现更好的公平分配和负载平衡。</p><h1 id="0957" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">设计图</h1><p id="b7fa" class="pw-post-body-paragraph it iu hh iv b iw kq iy iz ja kr jc jd je ks jg jh ji kt jk jl jm ku jo jp jq ha bi translated">序列图</p><figure class="kw kx ky kz fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lt"><img src="../Images/11bcf5667098be5573ae0e4129e62e45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7g3GLepomVxX1xrD0et9xw.png"/></div></div></figure><figure class="kw kx ky kz fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lu"><img src="../Images/d0ce2707cd9babe0750586ebace43c63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HsPETUcbZvnf11i7r2o2ng.png"/></div></div></figure><p id="87c3" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">类图</p><figure class="kw kx ky kz fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lv"><img src="../Images/e91f4de645286d53e1ab2696e3b345f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RYy7gHMOLRmqb8pEboamYg.png"/></div></div></figure><h1 id="36c0" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">参考</h1><div class="lw lx ez fb ly lz"><a href="https://docs.microsoft.com/en-us/azure/hdinsight/kafka/apache-kafka-high-availability" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab dw"><div class="mb ab mc cl cj md"><h2 class="bd hi fi z dy me ea eb mf ed ef hg bi translated">借助Apache Kafka - Azure HDInsight实现高可用性</h2><div class="mg l"><h3 class="bd b fi z dy me ea eb mf ed ef dx translated">了解如何在Azure HDInsight上使用Apache Kafka确保高可用性。了解如何重新平衡分区副本…</h3></div><div class="mh l"><p class="bd b fp z dy me ea eb mf ed ef dx translated">docs.microsoft.com</p></div></div><div class="mi l"><div class="mj l mk ml mm mi mn in lz"/></div></div></a></div><div class="lw lx ez fb ly lz"><a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/tutorial-availability-sets#availability-set-overview" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab dw"><div class="mb ab mc cl cj md"><h2 class="bd hi fi z dy me ea eb mf ed ef hg bi translated">教程Azure中Windows虚拟机的高可用性</h2><div class="mg l"><h3 class="bd b fi z dy me ea eb mf ed ef dx translated">在本教程中，您将学习如何使用……提高虚拟机(VM)的可用性和可靠性</h3></div><div class="mh l"><p class="bd b fp z dy me ea eb mf ed ef dx translated">docs.microsoft.com</p></div></div><div class="mi l"><div class="mo l mk ml mm mi mn in lz"/></div></div></a></div><div class="lw lx ez fb ly lz"><a href="https://community.hortonworks.com/articles/185086/ha-design-and-deployment-considerations-for-deploy.html" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab dw"><div class="mb ab mc cl cj md"><h2 class="bd hi fi z dy me ea eb mf ed ef hg bi translated">高可用性Kafka服务的设计和部署考虑事项</h2><div class="mg l"><h3 class="bd b fi z dy me ea eb mf ed ef dx translated">文章本文的目标是涵盖高可用性Apache Kafka的关键设计和部署考虑事项…</h3></div><div class="mh l"><p class="bd b fp z dy me ea eb mf ed ef dx translated">community.hortonworks.com</p></div></div><div class="mi l"><div class="mp l mk ml mm mi mn in lz"/></div></div></a></div></div></div>    
</body>
</html>