<html>
<head>
<title>Argo workflows as alternative to Cloud Composer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Argo工作流是Cloud Composer的替代方案</h1>
<blockquote>原文：<a href="https://medium.com/compendium/argo-workflows-as-alternative-to-cloud-composer-db4db2bea1af?source=collection_archive---------1-----------------------#2020-05-05">https://medium.com/compendium/argo-workflows-as-alternative-to-cloud-composer-db4db2bea1af?source=collection_archive---------1-----------------------#2020-05-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="3750" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">背景</h1><p id="0b68" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在以前的帖子(<a class="ae ka" rel="noopener" href="/grensesnittet/copy-data-from-cloud-sql-to-bigquery-using-apache-airflow-b51bdb277463">调度作业#1 </a>、<a class="ae ka" rel="noopener" href="/grensesnittet/copy-data-from-cloud-sql-to-bigquery-using-apache-airflow-cloud-composer-part-2-33aa02bf456a">调度作业#2 </a>)中，我一直在写如何使用<a class="ae ka" href="https://cloud.google.com/composer" rel="noopener ugc nofollow" target="_blank">GCPs Cloud Composer</a>(<a class="ae ka" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank">air flow</a>)进行工作流调度。</p><p id="bf2e" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">Cloud Composer一直困扰我的一个问题是高昂的价格(每月最低380美元！).对于小型集群和少量工作，在美元和基础设施上的花费实际上并没有增加所提供的价值。</p><p id="7bca" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">我们内部的Computas应用程序就是一个很好的例子。</p><p id="4d02" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">它曾经在kubernetes集群中作为cron-jobs运行。从某种意义上说，我们开始获得作业之间的依赖性，所以cron不再是一个真正的选项。</p><blockquote class="kg kh ki"><p id="71bf" class="jc jd kj je b jf kb jh ji jj kc jl jm kk kd jp jq kl ke jt ju km kf jx jy jz ha bi translated">computas的每个员工都安装了一个应用程序，让您可以访问所有其他员工的信息——图像、电话、邮件..此外，它还包含每个员工的个人信息，如假期，病假和kks预算。</p><p id="2731" class="jc jd kj je b jf kb jh ji jj kc jl jm kk kd jp jq kl ke jt ju km kf jx jy jz ha bi translated">Computas每年也有几个内部会议，有几个平行的轨道。使用我们创建的应用程序，每个员工都可以决定去哪个赛道。这个的主数据在JIRA。</p></blockquote><p id="6f15" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">该应用程序使用firebase作为其后端。为了用本地系统的相关数据填充firebase，我们有几个ETL作业。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es kn"><img src="../Images/dfa3be6faaf5e0d53af374c1873e2e72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NavWwNzCn_Cnjf7hUGFOVA.png"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx">Conceptual diagram of the infrastructure involved</figcaption></figure><p id="8cbb" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">如果我们要启动一个composer集群来处理这个ETL，成本将会过高，因为基础设施的其余部分每月不到100美元..</p><h1 id="feb6" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">Argo工作流</h1><figure class="ko kp kq kr fd ks er es paragraph-image"><div class="er es ld"><img src="../Images/05b33ddcb2ec6e6ca2344b0eddd190fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:916/0*F-GeSTVyXAA8-Ic4"/></div><figcaption class="kz la et er es lb lc bd b be z dx">Argo workflows to the rescue!</figcaption></figure><p id="749d" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">有几种方法可以运行composer managed。一个不错的选择是在一个虚拟机上运行<a class="ae ka" rel="noopener" href="/grensesnittet/install-apache-airflow-on-a-google-cloud-platform-virtual-machine-f9a5b01b6c33"> airflow，但是考虑到这些作业已经是kubernetes cron作业，我们想要一个能够以最小的开销轻松安装到kubernetes集群并按原样运行作业的东西。</a></p><p id="5326" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated"><a class="ae ka" href="https://github.com/argoproj/argo" rel="noopener ugc nofollow" target="_blank"> Argo workflows </a>是kubernetes的原生产品，与airflow相比占用的空间相对较小。它使用定制资源来描述作业，并部署一个控制器来运行它们——所有这些都是kubernetes固有的概念。这意味着Argo不需要外部数据库来保存状态，因为状态保存在资源本身中。</p><p id="f229" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">它也有一个(简单的)用户界面，但是默认情况下，它不会暴露在互联网上。</p><p id="50f1" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">工作流可以按cron-schedule运行，也可以作为一次性作业运行。对于我们的用例，cron-schedule最适合我们。如果作业已经在运行，您可以配置要执行的操作(禁止、取消现有、跳过..)</p><p id="1a2d" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">工作流在yaml中定义。</p><p id="e10d" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">阿尔戈也有丰富的生态系统。例如，它有<a class="ae ka" href="https://github.com/argoproj/argo-events/blob/master/docs/index.md" rel="noopener ugc nofollow" target="_blank">插件来做事件驱动架构</a>(即，在消费pubsub消息等之后产生工作流)，这在Composer中做起来有点麻烦<a class="ae ka" href="https://cloud.google.com/composer/docs/how-to/using/triggering-with-gcf" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="b45c" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">部署工作流</h1><p id="2674" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">Argo workflows在定义工作流时有一个非常好的概念，这使得ci-cd过程在mono-repos和micro repos中都非常容易。一个工作流可以由几个模板组成，一个模板可以与一个docker图像(带版本)一起构建。这意味着您的构建过程可以构建一个命名的模板，当它可用时，工作流将会选择它。这意味着提交代码后，构建过程就完成了，工作流就可以运行了。</p><p id="32f0" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">将此与您在cloud composer中的制作方式进行比较:</p><ul class=""><li id="3515" class="le lf hh je b jf kb jj kc jn lg jr lh jv li jz lj lk ll lm bi translated">首先创建一个触发器，它将repo文件夹同步到一个bucket进行提交..</li><li id="b2e0" class="le lf hh je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm bi translated">然后在后台，这个桶每30秒同步到每个气流工作者。</li><li id="6d5e" class="le lf hh je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm bi translated">并且您不断刷新ui中的dag，直到您看到DAG更改的内容</li><li id="bb1b" class="le lf hh je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm bi translated">然后你运行你的工作..</li></ul><h1 id="558e" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">使用IAP创建入口</h1><p id="b9e5" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">Argo工作流没有开箱即用的入口。当然，您可以根据需要创建一个隧道来查看argo ui，但是每次您想要对事物进行概述时这样做并不是最佳的。不要担心，这是很容易暴露argo服务器到互联网上！</p><ul class=""><li id="ec97" class="le lf hh je b jf kb jj kc jn lg jr lh jv li jz lj lk ll lm bi translated">你需要拥有一个域名。</li><li id="e7d8" class="le lf hh je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm bi translated">在域中创建一个A记录，指向您的负载平衡器的IP</li><li id="5189" class="le lf hh je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm bi translated">修补argo服务器，使其可以被L7 LB暴露</li></ul><pre class="ko kp kq kr fd ls lt lu lv aw lw bi"><span id="4c4d" class="lx if hh lt b fi ly lz l ma mb">kubectl patch svc argo-server -n argo -p '{"spec": {"type": "NodePort"}}'</span></pre><ul class=""><li id="246f" class="le lf hh je b jf kb jj kc jn lg jr lh jv li jz lj lk ll lm bi translated">使用GKE用户界面创建入口，并选择argo服务器。</li></ul><figure class="ko kp kq kr fd ks er es paragraph-image"><div class="er es mc"><img src="../Images/136f9309612012a3d97d854fad327ff0.png" data-original-src="https://miro.medium.com/v2/resize:fit:880/format:webp/1*TYdKBrxSYQZdEV2xypttgg.png"/></div><figcaption class="kz la et er es lb lc bd b be z dx">select argo-server and hit “Create ingress”</figcaption></figure><ul class=""><li id="9649" class="le lf hh je b jf kb jj kc jn lg jr lh jv li jz lj lk ll lm bi translated">在LB上启用IAP，这样您需要登录才能访问资源</li></ul><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es md"><img src="../Images/adaa3e95b38540349fe68a7e7c4088a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eEADGlXoTrLHUP95CGdGcg.png"/></div></div><figcaption class="kz la et er es lb lc bd b be z dx">In the IAP ui you can add who should be allowed to your site!</figcaption></figure><h1 id="9ae4" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">所有的气流操作员呢？</h1><p id="aa0c" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">你将失去一些东西，那就是所有的气流操作器。你可以通过运行gcloud/any docker镜像和“gsutil”、“bq”等bash命令来模仿其中的一些/大部分。但是，如果您的用例是使用大量内置的气流操作符，argo工作流不适合您。</p><h1 id="c46d" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">其他要点—作曲家vs argo</h1><p id="8b46" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated"><strong class="je hi">自动缩放</strong></p><ul class=""><li id="6e86" class="le lf hh je b jf kb jj kc jn lg jr lh jv li jz lj lk ll lm bi translated">Argo自动缩放开箱即用。您可以拥有一个带有自动扩展节点池的小型集群，它将正常工作。</li><li id="3d6e" class="le lf hh je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm bi translated">另一方面，Composer不会——主要是因为谷歌对它的配置。如果操作得当，气流可以轻松自动缩放..有一些<a class="ae ka" rel="noopener" href="/traveloka-engineering/enabling-autoscaling-in-google-cloud-composer-ac84d3ddd60">中型帖子提供了一些关于如何实现这一目标的解决方案</a></li></ul><p id="ff75" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated"><strong class="je hi"> UI </strong></p><ul class=""><li id="04d6" class="le lf hh je b jf kb jj kc jn lg jr lh jv li jz lj lk ll lm bi translated">Argo有一个很好的极简UI，但是没有气流的所有特性</li><li id="e090" class="le lf hh je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm bi translated">Composer有你需要的所有特性，但是看起来很垃圾(希望这在某个时候会改变)。</li></ul><p id="c9ac" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated"><strong class="je hi">调度的根本区别</strong></p><ul class=""><li id="bba4" class="le lf hh je b jf kb jj kc jn lg jr lh jv li jz lj lk ll lm bi translated">阿尔戈以克朗的身份带着匕首跑。</li><li id="982d" class="le lf hh je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm bi translated">Composer在开始时间为的特定时间运行作业。(并为您回填)</li></ul><p id="d659" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated"><strong class="je hi">伐木</strong></p><ul class=""><li id="b5e7" class="le lf hh je b jf kb jj kc jn lg jr lh jv li jz lj lk ll lm bi translated">Argo日志存储在kubernetes资源中，这意味着一旦作业被删除，它们也会被删除。(除非运到stackdriver)。流式日志是在用户界面中实时完成的。</li><li id="4aa8" class="le lf hh je b jf ln jj lo jn lp jr lq jv lr jz lj lk ll lm bi translated">Composer日志存储在存储桶中并进行版本控制。</li></ul><h1 id="3455" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">结束语</h1><p id="4d24" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">总而言之，我真的很喜欢阿尔戈。我现在已经部署了两次(一次是内部部署，一次是作为Cloud Composer的替代品在客户身上部署)，两个地方都运行得非常好。</p><p id="6ed6" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">它是Composer的一个很好的替代品，尤其是如果您已经有一个kubernetes集群，并且想要在该集群中调度作业！</p><p id="b05d" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">对于那些每月380美元的最低费用对工作流程安排来说太贵的人来说，这也是一个很好的选择。</p><p id="1cbc" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">作曲家仍有其角色要扮演；这是一个强大的管理解决方案，您不需要了解任何kubernetes，就可以从第一天开始专注于创造商业价值！</p></div></div>    
</body>
</html>