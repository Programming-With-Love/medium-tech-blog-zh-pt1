<html>
<head>
<title>Inspecting Android Traffic using Proxyman + apk-mitm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Proxyman + apk-mitm检查Android流量</h1>
<blockquote>原文：<a href="https://medium.easyread.co/inspecting-android-traffic-using-proxyman-apk-mitm-a3e1fa6308c8?source=collection_archive---------0-----------------------#2021-01-12">https://medium.easyread.co/inspecting-android-traffic-using-proxyman-apk-mitm-a3e1fa6308c8?source=collection_archive---------0-----------------------#2021-01-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/9c0652dc42fd4fcaabc133cdb035a32a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TntQBetqhQbeNF5VjSkv3A.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by <a class="ae jz" href="https://pixabay.com/photos/stock-iphone-business-mobile-phone-624712/" rel="noopener ugc nofollow" target="_blank">pixabay.com</a></figcaption></figure><h1 id="838c" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">介绍</h1><p id="9f72" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">大家好！还是跟我分享一些与软件工程领域技术相关的经验、想法或者看法吧。在这篇文章中，我想分享一下我检查移动应用程序网络请求的经验，尤其是对于Android平台！</p><p id="5476" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">如果我们在web app上聊天，检查对服务器的网络请求是非常容易的。对于Chrome或Firefox，只需进入开发者工具，查看网络选项卡。我们可以监控请求类型，如方法、URL、标题、正文以及响应。</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mb"><img src="../Images/4e44c90b64bd381ef0092d905bf877b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6VymqX_Z0B885RBs"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Source by <a class="ae jz" href="https://gohighbrow.com/using-the-browsers-developer-tools-to-inspect-the-pages-you-visit/" rel="noopener ugc nofollow" target="_blank">gohighbrow</a></figcaption></figure><p id="ea46" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">但是，如果我们想在移动设备上做同样的事情呢？因为对于手机浏览器，我们没有任何与开发者工具类似的选项。此外，当我们希望看到移动应用的网络时，这是不可能的。</p><h1 id="a021" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">代理人</h1><p id="1114" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">答案是，我们可以使用代理等工具来帮助我们捕获设备和服务器之间的网络。这种方法叫做中间人，因为我们把代理放在中间连接。更多图片见下图。</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/4a32dbe9911a52921fbddc4a48ed8664.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/0*0rdKUJmysF44Y5A_"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Source by <a class="ae jz" href="https://www.researchgate.net/figure/An-illustration-of-the-MITM-attack_fig1_327034906" rel="noopener ugc nofollow" target="_blank">researchgate</a></figcaption></figure><p id="6058" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">例如，有许多代理服务:</p><ul class=""><li id="9bfc" class="mh mi in la b lb lw lf lx lj mj ln mk lr ml lv mm mn mo mp bi translated">代理人(<a class="ae jz" href="https://proxyman.io/" rel="noopener ugc nofollow" target="_blank">https://代理人. io </a>)</li><li id="855b" class="mh mi in la b lb mq lf mr lj ms ln mt lr mu lv mm mn mo mp bi translated">米特普罗克(【https://mitmproxy.org】T2</li><li id="bf7d" class="mh mi in la b lb mq lf mr lj ms ln mt lr mu lv mm mn mo mp bi translated">查理(【https://www.charlesproxy.com】T4)</li><li id="db9b" class="mh mi in la b lb mq lf mr lj ms ln mt lr mu lv mm mn mo mp bi translated">等等</li></ul><p id="20ba" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">我个人会选择Proxyman，因为我是Mac用户，它是基于GUI的。如果您对基于CLI更感兴趣，可以尝试使用mitmproxy。他们俩不是你最喜欢的吗？也许你可以用另一个适合你的代理人。谷歌一下就知道了。这是我提到的代理的一些外观。</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mb"><img src="../Images/a3a1dc05e1beffec9732d6891903c8a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9f23yhPeuxN0ZxkQ"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Source by <a class="ae jz" href="https://proxyman.io" rel="noopener ugc nofollow" target="_blank">proxyman</a></figcaption></figure><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mb"><img src="../Images/96157c769a75f27061beac069f146de1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wCKmjw12h8FNvobX"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Source by <a class="ae jz" href="https://mitmproxy.org" rel="noopener ugc nofollow" target="_blank">mitmproxy</a></figcaption></figure><figure class="mc md me mf gt jo gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/a004011f710bb973ba5b16eaa209682c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*puURZ7zcbLNi4gQqu5Iocw.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Source by <a class="ae jz" href="https://www.charlesproxy.com" rel="noopener ugc nofollow" target="_blank">charles</a></figcaption></figure><p id="d5ad" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">完成安装并运行代理后，我们将得到监听端口。如果默认端口与系统上现有的端口冲突，也不用担心。我们可以很容易地换成另一个。下面是Proxyman如何运行并获得监听端口的图片。</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mb"><img src="../Images/9269ff2e62f3c7e64d4f57fdddd93ed2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pw9g3YAlVKhWju7T"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 1 Proxyman Running Status</figcaption></figure><h1 id="398d" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">Android配置</h1><p id="f33f" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">之后，下一步就是在Android手机上进行配置。如果我们没有任何Android手机，我们可以使用类似Genymotion(<a class="ae jz" href="https://www.genymotion.com/" rel="noopener ugc nofollow" target="_blank">https://www.genymotion.com</a>)的模拟器。</p><p id="31dd" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">确保电话和代理服务器之间的网络在同一个网络上。转到SSID配置，选择手动代理并添加代理主机名+端口作为代理信息。</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mw"><img src="../Images/3755585a85af5b3837dc145356b63b96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EbQ5quQQRMYorpp6"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 2 Android Proxy Configuration</figcaption></figure><p id="c3db" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">代理配置完成后，我们需要为Android手机设置SSL。因为我使用的是Proxyman，我们需要打开<a class="ae jz" href="http://proxy.man/ssl" rel="noopener ugc nofollow" target="_blank">http://proxy.man/ssl</a>网址并下载证书。在真正的Android手机中，只需打开证书并按照安装即可。但是对于仿真器的情况，步骤有一点不同。我们需要从设置- &gt;安全- &gt;从SD卡安装。</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mx"><img src="../Images/2170fb48cf58c106030d19dd01e2a75c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*He16WMnU8GdoEKbM"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 3 Android Certificate Installation</figcaption></figure><h1 id="fe2e" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">测试</h1><p id="2fc0" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">尝试通过使用移动浏览器打开网站来捕获网络。在这种情况下，我试图捕捉雅虎网站的网络请求。正如我们在下图中看到的，网络将被捕获，如果我们需要查看响应，我们需要单击“<strong class="la io">仅启用此域</strong>”，并尝试应用相同的请求。详见图4 &amp; 5。</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mb"><img src="../Images/047d93a1a495abda62d1a9a308669574.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vy9WUGxV8MeZwm4y"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 4 Mobile Browser Network Captured</figcaption></figure><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/0dd643890390ef26740409cb4c0edcef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vYfsJy84NUTowpoG"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 5 HTTPS Response</figcaption></figure><p id="96b6" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">如果在浏览器中捕捉网络似乎没有任何问题，那么移动应用呢？嗯，我正在尝试用简单的应用程序获取货币信息。而且和“图6”一样，还在工作！</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mb"><img src="../Images/258de9184d3bc49f6b2974d92440d064.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qbv3V5Zx4tiSPM3-"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 6 Mobile Application Network Captured</figcaption></figure><h1 id="bab1" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">真实设备问题</h1><p id="3e6f" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">对Genymotion执行的上一步。如果使用真实设备呢？因为在真实设备中做比在模拟器中做更舒服。但是，似乎真正的设备有一个关于SSL握手失败的问题。图7显示了网络如何由于一些错误而变红。</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mb"><img src="../Images/3b8beba253af46fc0ba4e2da3e86653d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MIJQ_28pHqKZOiVk"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 7 Real Device Issue on Network Captured</figcaption></figure><h1 id="6e72" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">apk-mitm</h1><p id="9290" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">我们能做什么来解决SSL握手在真实设备上失败的问题？一个解决方案可能是使用这个叫做apk-mitm(<a class="ae jz" href="https://github.com/shroudedcode/apk-mitm" rel="noopener ugc nofollow" target="_blank">https://github.com/shroudedcode/apk-mitm</a>)的工具</p><p id="2cd3" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">什么是apk-mitm？从他们的官方github网站:</p><blockquote class="mz na nb"><p id="7041" class="ky kz nc la b lb lw ld le lf lx lh li nd ly ll lm ne lz lp lq nf ma lt lu lv ig bi translated">自动为HTTPS检查准备安卓APK文件的CLI应用程序</p></blockquote><p id="1e0e" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">自动化整个过程。你只需要给它一个APK文件，<code class="fe ng nh ni nj b">apk-mitm</code>就会:</p><ul class=""><li id="ec36" class="mh mi in la b lb lw lf lx lj mj ln mk lr ml lv mm mn mo mp bi translated">使用<a class="ae jz" href="https://ibotpeaches.github.io/Apktool/" rel="noopener ugc nofollow" target="_blank"> Apktool </a>解码APK文件</li><li id="7a58" class="mh mi in la b lb mq lf mr lj ms ln mt lr mu lv mm mn mo mp bi translated">修改应用的<code class="fe ng nh ni nj b">AndroidManifest.xml</code>使其成为<code class="fe ng nh ni nj b"><a class="ae jz" href="https://developer.android.com/guide/topics/manifest/application-element#debug" rel="noopener ugc nofollow" target="_blank">debuggable</a></code></li><li id="25ec" class="mh mi in la b lb mq lf mr lj ms ln mt lr mu lv mm mn mo mp bi translated">替换应用程序的<a class="ae jz" href="https://developer.android.com/training/articles/security-config" rel="noopener ugc nofollow" target="_blank">网络安全配置</a>以允许用户添加证书</li><li id="c499" class="mh mi in la b lb mq lf mr lj ms ln mt lr mu lv mm mn mo mp bi translated"><a class="ae jz" href="https://mobile-security.gitbook.io/mobile-security-testing-guide/android-testing-guide/0x05c-reverse-engineering-and-tampering#patching-example-disabling-certificate-pinning" rel="noopener ugc nofollow" target="_blank">插入</a> <code class="fe ng nh ni nj b"><a class="ae jz" href="https://mobile-security.gitbook.io/mobile-security-testing-guide/android-testing-guide/0x05c-reverse-engineering-and-tampering#patching-example-disabling-certificate-pinning" rel="noopener ugc nofollow" target="_blank">return-void</a></code> <a class="ae jz" href="https://mobile-security.gitbook.io/mobile-security-testing-guide/android-testing-guide/0x05c-reverse-engineering-and-tampering#patching-example-disabling-certificate-pinning" rel="noopener ugc nofollow" target="_blank">操作码</a>禁用<a class="ae jz" href="https://owasp.org/www-community/controls/Certificate_and_Public_Key_Pinning#what-is-pinning" rel="noopener ugc nofollow" target="_blank">证书锁定</a>逻辑</li><li id="d5a2" class="mh mi in la b lb mq lf mr lj ms ln mt lr mu lv mm mn mo mp bi translated">使用<a class="ae jz" href="https://ibotpeaches.github.io/Apktool/" rel="noopener ugc nofollow" target="_blank"> Apktool </a>对打了补丁的APK文件进行编码</li><li id="215d" class="mh mi in la b lb mq lf mr lj ms ln mt lr mu lv mm mn mo mp bi translated">使用<a class="ae jz" href="https://github.com/patrickfav/uber-apk-signer" rel="noopener ugc nofollow" target="_blank">超级签名者</a>对打了补丁的APK文件进行签名</li></ul><p id="99b2" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">正如我们可以看到上面的描述，我们需要生APK。我们可以从<a class="ae jz" href="https://apkpure.com/" rel="noopener ugc nofollow" target="_blank"> APKPure </a>或类似地点获得，或使用<a class="ae jz" href="https://github.com/Aefyr/SAI" rel="noopener ugc nofollow" target="_blank"> SAI </a>出口。然后，我们只需要运行这个安装+执行命令，整个过程将如图8所示。</p><pre class="mc md me mf gt nk nj nl nm aw nn bi"><span id="8309" class="no kb in nj b gy np nq l nr ns">$ npm install -g apk-mitm<br/>$ npx apk-mitm &lt;path-to-apk&gt;</span></pre><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nt"><img src="../Images/9652dba59b2fe3169a25f7f7f487cb17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*e6qSH8_RJ0bxawOd"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 8 Patching APK</figcaption></figure><p id="d70f" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">完成安装修补的APK后，尝试打开应用程序并查看捕获的请求。瞧啊。来自修补的APK的请求没有关于SSL握手失败的问题！</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mb"><img src="../Images/a3e11e2bb908677c2a688df1e5974e16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vrrryFdsFv2jr6ii"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 9 Real Device Issue Solved</figcaption></figure><h1 id="fca4" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">证书锁定问题</h1><p id="076d" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">不幸的是，在我的案例中，我遇到了一个关于实现证书锁定的应用程序的问题。如果你是第一次听说它，你可以参考这里的详细内容。虽然apk-mitm说他们有禁用证书锁定的逻辑，但这对我不起作用。代理控制台上仍然出现“SSL握手失败”的错误。</p><h1 id="8a81" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">结论</h1><p id="91d1" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">对这个实验的总结可以列举在下面几点上:</p><ul class=""><li id="f1fa" class="mh mi in la b lb lw lf lx lj mj ln mk lr ml lv mm mn mo mp bi translated">Proxyman可以很好地捕捉Android (Genymotion)的浏览器和应用程序网络请求。</li><li id="6e15" class="mh mi in la b lb mq lf mr lj ms ln mt lr mu lv mm mn mo mp bi translated">在真正的Android设备上捕获网络应用程序需要使用<code class="fe ng nh ni nj b">apk-mitm</code>进行额外处理。</li><li id="5901" class="mh mi in la b lb mq lf mr lj ms ln mt lr mu lv mm mn mo mp bi translated">Proxyman可以很好地捕捉iOS(真实设备)的浏览器和应用程序网络请求。由于主题区的原因，我没有分享iOS的细节，但我一直在尝试。</li><li id="1c32" class="mh mi in la b lb mq lf mr lj ms ln mt lr mu lv mm mn mo mp bi translated">尽管我们使用的是打了补丁的APK，但实现了证书锁定的Android应用程序可能会因为SSL握手失败而失败。</li></ul><p id="e5a3" class="pw-post-body-paragraph ky kz in la b lb lw ld le lf lx lh li lj ly ll lm ln lz lp lq lr ma lt lu lv ig bi translated">我希望这篇文章有用，并看到你对另一个主题！谢谢大家！</p></div></div>    
</body>
</html>