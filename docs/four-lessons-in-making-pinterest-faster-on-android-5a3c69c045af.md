# 在 Android 上让 Pinterest 更快的四个教训

> 原文：<https://medium.com/pinterest-engineering/four-lessons-in-making-pinterest-faster-on-android-5a3c69c045af?source=collection_archive---------2----------------------->

阿拉·罗森茨威格和王麟|性能 TPM，性能工程师

作为工程师，我们直觉地知道更快的应用程序对 Pinners 来说是更好的体验，但我们也有证据表明[当网页加载更快时，用户增长会提高](/@Pinterest_Engineering/driving-user-growth-with-performance-improvements-cfc50dafadd7)。去年，我们在我们的平台上加倍提高了性能，这样无论我们的 2 亿月活跃用户在世界各地，无论他们使用什么设备，Pinterest 都可以帮助他们发现和做他们喜欢的事情——希望不用等太久。

全球不同设备的连接速度差异很大，但有两点是一致的:

*   全球大多数智能手机都是安卓设备(略低于 90%)。
*   Pinterest 在 Android 上运行速度一直较慢。

由于超过 75%的 Pinterest 注册来自美国以外，我们需要加快我们的 Android 应用程序，并在不断开发和新功能添加可能会减慢速度的情况下保持这一速度。这篇文章将涵盖我们学到的四个关键经验，这些经验将提高 Pinterest 的性能。

## **1。定义一个以用户为中心的指标确保了我们确实改善了体验。**

我们仔细思考了如何根据我们所知的对 Pinners 最重要的事情做出最大的改变。对于 Pinterest 上的每个主要操作——比如加载 home feed、点击查看大头针特写或搜索——我们定义了一个名为 Pinner Wait Time (PWT)的指标。每个指标测量从 Pinner 发起一个动作(例如轻敲一个 Pin)到从 Pinner 的角度认为该动作完成(即加载 Pin 特写视图)的时间。

## **2。防止退化是保持应用程序快速运行的首要方法。**

一旦我们对每个交互有了一个基线测量，我们想要确保我们没有减慢事情的速度。为了寻求测试精度和警报功能，我们选择使用 [NimbleDroid](https://nimbledroid.com) ，这是一种基于云的连续性能测试工具，可以轻松地与我们的流程集成，并产生可操作的结果。利用他们的框架，我们创建了回归测试，这些测试运行在由代码更改生成的 Android 版本上，并在 PWT 指标增加到指定阈值内时提醒我们。当没有警报时，我们知道我们的应用程序运行良好，增强了合并拉取请求并将其发布给 Pinners 的信心。当我们收到警报时，我们在大约 21 小时内解决了回归问题，这远远少于以前识别和修复回归问题所需的多天时间。

由于这些测试是在禁用所有 A/B 实验的构建上运行的，我们还需要一种方法来检测新体验的影响。我们向我们的内部实验仪表板添加了性能数据和更多回归警报，这使我们能够确定哪些实验降低了应用程序的速度，并了解延迟增加如何影响 Pinners 在各种表面上的参与。

在 NimbleDroid 和实验警报之间，我们在六个月的过程中检测到了大约 30 次减速回归。由于我们的警报阈值是 100 毫秒，如果将这些回归发布到我们的生产应用程序中，将会导致至少三秒钟的额外等待时间。在每天进行的数亿次操作中，这可能会浪费大量时间。通过在周期的早期捕捉回归，它们永远不会被发布给 Pinners。

## **3。开发优化性能的最佳实践。**

除了回归测试，NimbleDroid 还提供了分析每个交互的机会。例如，我们发现在加载 Pin 特写视图时，我们没有使用初始 feed 响应中已经可用的数据来显示所有必要的信息。这一疏忽导致了额外的往返行程，并降低了整体加载时间。提交一个补丁并通过 NimbleDroid 测试运行，证实了改进使 Pin 特写加载时间加快了 60%。

与此一致，我们配置了 NimbleDroid，以便在事情变得更快时发送警报，这有助于验证优化和错误修复，就像上面的场景一样。这些警报还有助于在我们通过 QA 测试的搜索功能中发现功能回归。

我们还希望改善“冷启动”的体验——应用程序打开和 home feed 首次加载所需的时间。通过测试，我们发现 Gson 中的反射类型适配器对于应用程序的冷启动来说非常昂贵，因此我们在编译时生成类型适配器，并使 JSON 解析更加有效，从而在 Pinner 的冷启动时间中节省了大约 30 毫秒。

速度的可见性至关重要，尤其是对于让 Pinterest 如此有用的关键交互。我们依靠 NimbleDroid 来洞察我们如何实现我们的目标，不仅保持而且改善我们平台的 PWT。

探索这些优化强化了高效解析数据的重要性，以及我们提出的网络请求越少(越小)越好。无论是加载初始主页还是 Pin 特写，我们使用本地存储的数据越多，Pinner 就能越快地看到他们正在寻找的内容。这种影响在国际国家中更为严重，在这些国家中，每次网络往返都会给整体 PWT 增加额外的时间。

## **4。更快的应用程序鼓励更多的参与。**

我们在优化的地方看到了一致的模式。缩短完成一项行动所需的时间会让 Pinners 更加投入:

*   当 home feed 加载得更快时，更多的 Pinners 会滚动到 Pins 的第一页，并查看更多的 Pins。
*   当我们加快观看大头针特写的时间时，人们不太可能不耐烦地点击屏幕两次，这最终会导致意外的大头针点击。

受到这些结果的鼓舞，我们开始将绩效工作的重点放在其他互动上，以继续探索提高绩效和参与度之间的关系。我们将继续监控每个拉取请求的每个关键用户流，以检测任何性能退化。这种防止倒退的内心平静让我们有空间和时间专注于对我们最重要的事情——为世界各地的 Pinners 提供令人惊叹的体验。

![](img/c2e708437034ef3a06c845ca00e483ca.png)

*特别感谢艾菲·巴拉克、瑞安·库克、玛丽卡·波特和卡尔·鲁伯*