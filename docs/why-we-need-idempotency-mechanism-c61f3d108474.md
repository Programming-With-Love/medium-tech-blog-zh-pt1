# 为什么我们需要幂等机制

> 原文：<https://medium.easyread.co/why-we-need-idempotency-mechanism-c61f3d108474?source=collection_archive---------3----------------------->

## 一次就够了…

![](img/351975d866ca550cf096ece256232bc3.png)

Photo by [Photos by Lanty](https://unsplash.com/@photos_by_lanty?utm_source=medium&utm_medium=referral) on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)

幂等性是一种策略，它确保一个事件执行多次会得到相同的结果。例如，HTTP 请求上的`GET`方法。如果用`GET`方法调用端点，会得到相同的结果。但是`POST`方法不是等幂的，因为每次用`POST`方法调用一个端点都会在数据库上创建一条新记录(数据库状态改变)。

# 当我们需要的时候。

想象一下这个场景。我们的支付后端有一个端点在`transactions`表上添加一条新记录，这是它使用的`POST`方法。我们的前端应用程序—具有重试机制—调用端点来进行新的事务。我们的后端接收请求，进行新的交易，并减少用户的余额。

但不知何故，网络故障发生了，前端应用程序没有收到响应。由于时间限制，前端应用程序会重试发送相同的请求。我们的后端接收请求，进行新的交易，并减少用户的余额。

你知道实际发生了什么吗？用户的余额减少了两倍。我们不希望我们的客户因为这次失败而生气。我们如何解决这个问题？

# 使请求幂等

为了使请求幂等，我们需要为每个请求创建一个惟一的标识符。每次前端应用程序创建一个新的请求，它会生成一个唯一的标识符，发送到后端。我们可以把它放在请求头或请求体上。我不知道把它放在哪里是最好的做法，但关键是我们的前端将为每个请求发送一个唯一的标识符。

每次后端收到来自前端应用程序的请求时，它都会检查请求的唯一标识符是否存在。后端应该有一个存储唯一标识符的机制。也许我们可以用 [Redis](https://redis.io/) 暂时存储。

如果请求的唯一标识符不存在，这意味着它是一个新的请求，该请求将被处理。请求的唯一标识符和响应主体将被存储到我们的缓存中。如果请求的唯一标识符存在——意味着请求以前曾经被处理过，后端将返回缓存的响应体，而不再次处理请求。

这是我们实现等幂的方法之一。我还是不知道有没有另一种方法可以实现幂等。幂等性对于确保一个请求——使状态改变——不会被执行多次非常有用。

~宣传💻 ☕️