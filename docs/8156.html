<html>
<head>
<title>Performance Saver for Hot Topic Issue</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">热门话题问题的性能保护程序</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/performance-saver-for-hot-topic-issue-d87d9fa6ea39?source=collection_archive---------4-----------------------#2022-11-14">https://medium.com/walmartglobaltech/performance-saver-for-hot-topic-issue-d87d9fa6ea39?source=collection_archive---------4-----------------------#2022-11-14</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="0776" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">搜索热门话题的小指南</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/5aba5a9be7c969bb86aefe1e35dc54df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FwnrU8epJ4AWupqz33la9A.jpeg"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Photo credit: Pixabay</figcaption></figure><p id="e731" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们设计并实现了很多搜索平台，就像这篇博客提到的:<a class="ae js" rel="noopener" href="/walmartglobaltech/tricks-to-make-your-search-10x-faster-using-solr-and-cassandra-f6af53d5a25c">使用Solr和Cassandra </a>让你的搜索速度提高10倍的技巧。我们可以从搜索引擎和NoSQL数据库中获得很多好处。如果你有任何设计问题，请阅读上面的博客。</p><p id="6560" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这篇博客中，我们将讨论在设计甚至实现搜索平台后可能面临的一些其他情况。</p></div><div class="ab cl jt ju go jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="ha hb hc hd he"><h1 id="476c" class="ka kb hh bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">议程</h1><ul class=""><li id="0285" class="ky kz hh ig b ih la il lb ip lc it ld ix le jb lf lg lh li bi translated">情况陈述和动机</li><li id="05a3" class="ky kz hh ig b ih lj il lk ip ll it lm ix ln jb lf lg lh li bi translated">新方法</li><li id="90bc" class="ky kz hh ig b ih lj il lk ip ll it lm ix ln jb lf lg lh li bi translated">从新设计中获益</li><li id="2c98" class="ky kz hh ig b ih lj il lk ip ll it lm ix ln jb lf lg lh li bi translated">摘要</li></ul></div><div class="ab cl jt ju go jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="ha hb hc hd he"><h1 id="c6ca" class="ka kb hh bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">情况陈述和动机</h1><blockquote class="lo lp lq"><p id="4f54" class="ie if lr ig b ih ii ij ik il im in io ls iq ir is lt iu iv iw lu iy iz ja jb ha bi translated">在考虑了速度是我们这里的第一公民和数据量之后，我们真正考虑的是<strong class="ig hi">【NoSQL】</strong>加上<strong class="ig hi">搜索引擎</strong>在一起。</p></blockquote><p id="ee35" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在某些情况下，除了获取原始数据，我们还需要处理如何处理聚合数据。那么MongoDB作为细节级存储将是一个不错的选择。而CosmosDB-Mongo API将是HIPAA数据的另一个不错的选择。</p><p id="f624" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们之前的博客中，我们使用下面的初始设计来达到这些要求。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lv"><img src="../Images/e118b82d48610b88a506876017c0a44c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S5tTwXWua6sVfINe"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Figure 1 - initial design</figcaption></figure><p id="3bcd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">根据图1，在面对一些热点话题数据点之前，我们流程的性能表现良好。我们大约有0.3%的数据包含大量记录(超过500，000条)。因为CosmosDB有一些性能问题，我们试图做更多的头脑风暴来找到下面的两个备份计划:</p><ol class=""><li id="d486" class="ky kz hh ig b ih ii il im ip lw it lx ix ly jb lz lg lh li bi translated">装载前进行预计算，</li><li id="2dd6" class="ky kz hh ig b ih lj il lk ip ll it lm ix ln jb lz lg lh li bi translated">横向拆分热门话题数据——只需将0.3%的数据放入另一个集合+改进索引设计。</li></ol><p id="fa3d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在对这些方法进行了测试和概念验证之后，仍然存在一些薄弱环节。</p><ol class=""><li id="383d" class="ky kz hh ig b ih ii il im ip lw it lx ix ly jb lz lg lh li bi translated">如果我们使用预计算，将不会有动态聚合，因为我们无法对一些方法(如mod、mid或更复杂的流程)进行多一级聚合。</li><li id="f03d" class="ky kz hh ig b ih lj il lk ip ll it lm ix ln jb lz lg lh li bi translated">因为即使对于0.3%的数据来说，数据大小也是非常大的，即使这些数据都在一个分片下，ComosDB仍然需要处理这些数量的数据，这在进行聚合时会影响性能。更糟糕的情况是会出现超时问题。</li></ol><h1 id="cb7b" class="ka kb hh bd kc kd ma kf kg kh mb kj kk kl mc kn ko kp md kr ks kt me kv kw kx bi translated">新方法</h1><h2 id="5afd" class="mf kb hh bd kc mg mh mi kg mj mk ml kk ip mm mn ko it mo mp ks ix mq mr kw ms bi translated">挑战</h2><ul class=""><li id="8902" class="ky kz hh ig b ih la il lb ip lc it ld ix le jb lf lg lh li bi translated">如何利用现有的套件解决这个问题？</li><li id="1b8e" class="ky kz hh ig b ih lj il lk ip ll it lm ix ln jb lf lg lh li bi translated">我们如何平衡努力和表现？</li><li id="00d9" class="ky kz hh ig b ih lj il lk ip ll it lm ix ln jb lf lg lh li bi translated">我们如何提供动态聚合？</li></ul><p id="b9f1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们找到了一种方法来做一个弹性搜索作为一个“负载平衡器”,通过一些小的改变来帮助提高性能。我在下面提出了两种方法，在获取性能和动态聚集之间做了一些权衡。</p><h2 id="9a94" class="mf kb hh bd kc mg mh mi kg mj mk ml kk ip mm mn ko it mo mp ks ix mq mr kw ms bi translated">解决方法</h2><ol class=""><li id="af2a" class="ky kz hh ig b ih la il lb ip lc it ld ix le jb lz lg lh li bi translated"><strong class="ig hi"> <em class="lr">综合动态聚合和可接受性能</em> </strong></li></ol><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mt"><img src="../Images/a1ce843ec151f13ffc4421fc27d667e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RxvNgza8n6qgWFUY"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Figure 2 - comprehensive<em class="mu"> dynamic aggregation and acceptable performance</em></figcaption></figure><p id="eeee" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在图2中，我们在CosmosDB Mongo和BigQuery中保留了相同的数据。在弹性搜索索引中，我们有一个字段来决定用户可以从哪个数据源获取数据(CosmosDB Mongo或BigQuery)。</p><p id="68cf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这种设计中，我们有以下优点和缺点:</p><ul class=""><li id="0102" class="ky kz hh ig b ih ii il im ip lw it lx ix ly jb lf lg lh li bi translated">我们没有复杂的加载逻辑，因为我们在两个数据库上模拟相同的数据。</li><li id="080a" class="ky kz hh ig b ih lj il lk ip ll it lm ix ln jb lf lg lh li bi translated">我们有高度的聚合灵活性。</li><li id="68ca" class="ky kz hh ig b ih lj il lk ip ll it lm ix ln jb lf lg lh li bi translated">我们可以将获取时间减少到10秒，但这仍然不是一个完美的性能。</li></ul><p id="0de0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2.<strong class="ig hi"> <em class="lr">部分</em> </strong> d <strong class="ig hi"> <em class="lr">动态聚合和超级性能</em> </strong></p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mt"><img src="../Images/81751a7a24f9dac8ee1af384014eb8da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IOyJVw7kQn4h5ift"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Figure 3 - p<em class="mu">art</em> d<em class="mu">ynamic aggregation and super performance</em></figcaption></figure><p id="c2e4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在图3中，设计原理与图2相同。我们用另一个Mongo集合替换BigQuery，并对各种聚合进行预计算。</p><p id="8209" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这种设计中，我们有以下优点和缺点:</p><ul class=""><li id="b311" class="ky kz hh ig b ih ii il im ip lw it lx ix ly jb lf lg lh li bi translated">我们将有复杂的加载和获取逻辑，因为有两种不同的数据格式——扁平化和聚集。</li><li id="8476" class="ky kz hh ig b ih lj il lk ip ll it lm ix ln jb lf lg lh li bi translated">对于0.3%的数据，我们有一个聚合限制。</li><li id="356c" class="ky kz hh ig b ih lj il lk ip ll it lm ix ln jb lf lg lh li bi translated">我们可以有完美的抓取性能</li></ul><h1 id="3663" class="ka kb hh bd kc kd ma kf kg kh mb kj kk kl mc kn ko kp md kr ks kt me kv kw kx bi translated">从新设计中获益</h1><p id="ed02" class="pw-post-body-paragraph ie if hh ig b ih la ij ik il lb in io ip mv ir is it mw iv iw ix mx iz ja jb ha bi translated">我为所有三种方法中的普通和热门话题创建了一个度量标准。这两种新方法都将获取时间从30秒提高到10秒甚至几毫秒。</p><pre class="jd je jf jg fd my mz na nb aw nc bi"><span id="52a0" class="mf kb hh mz b fi nd ne l nf ng">+-----------+------------+---------------------+-----------------+<br/>|    Size   |  CosmosDB  | <!-- -->CosmosDB+BQ+nonagg<!-- -->  |   <!-- -->CosmosDB+agg  <!-- -->| <br/>+-----------+------------+---------------------+-----------------+<br/>|  normal   |  267 (ms)  |     267 (ms)        |     267 (ms)    |<br/>| hot topic | 29383 (ms) |    10000 (ms)       |     200(ms)     |<br/>+-----------+------------+---------------------+-----------------+</span></pre><p id="90f9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">除了缩短获取时间，我们还可以获得以下好处:</p><ul class=""><li id="e869" class="ky kz hh ig b ih ii il im ip lw it lx ix ly jb lf lg lh li bi translated">两种新方法都易于设置</li><li id="3318" class="ky kz hh ig b ih lj il lk ip ll it lm ix ln jb lf lg lh li bi translated">作为“负载平衡器”的弹性搜索</li><li id="aefd" class="ky kz hh ig b ih lj il lk ip ll it lm ix ln jb lf lg lh li bi translated">支持</li><li id="a972" class="ky kz hh ig b ih lj il lk ip ll it lm ix ln jb lf lg lh li bi translated">节省了使用额外资源的巨大成本。</li></ul><h1 id="ceb8" class="ka kb hh bd kc kd ma kf kg kh mb kj kk kl mc kn ko kp md kr ks kt me kv kw kx bi translated">摘要</h1><p id="0fa0" class="pw-post-body-paragraph ie if hh ig b ih la ij ik il lb in io ip mv ir is it mw iv iw ix mx iz ja jb ha bi translated">使用新方法可以快速改善一些搜索平台问题。还有一些其他潜在的解决方案，我们可以在未来的博客中讨论。</p></div></div>    
</body>
</html>