<html>
<head>
<title>Packing the Room: pre-populate your database with this one method</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">收拾房间:用这种方法预先填充你的数据库</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/packing-the-room-pre-populate-your-database-with-this-one-method-333ae190e680?source=collection_archive---------0-----------------------#2019-08-13">https://medium.com/androiddevelopers/packing-the-room-pre-populate-your-database-with-this-one-method-333ae190e680?source=collection_archive---------0-----------------------#2019-08-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/04f4f85f42a4ee4e632d17907429b3c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Tfm617S6X6_V4G1j-v45g.png"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">Illustration by <a class="ae hu" href="http://twitter.com/vpoltrack" rel="noopener ugc nofollow" target="_blank">Virginia Poltrack</a></figcaption></figure><div class=""/><p id="28db" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">假设您想要用打包在APK中或从服务器下载的数据预填充数据库。无论您是想使用SQLite还是Room来完成这项工作，都有几件事情需要处理:打开数据库、验证模式、锁定数据库文件并处理线程同步、复制所有内容并关闭数据库。</p><p id="92c5" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">从Room 2.2(目前在alpha中)开始，您可以通过调用一个方法来预填充您的数据库:<code class="du js jt ju jv b"><a class="ae hu" href="https://developer.android.com/reference/android/arch/persistence/room/RoomDatabase.Builder" rel="noopener ugc nofollow" target="_blank">RoomDatabase.Builder</a>#createFromAsset()</code>或<code class="du js jt ju jv b">createFromFile()</code>，这取决于您预打包的数据库的位置。请继续阅读，了解如何使用这些方法、使用预打包数据库的一些技巧以及涉及迁移时会发生什么。</p><h1 id="4b59" class="jw jx hx bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><code class="du js jt ju jv b">createFromAsset()</code></h1><p id="1863" class="pw-post-body-paragraph iu iv hx iw b ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr ha bi translated">如果你的预打包数据库是你的应用程序的<code class="du js jt ju jv b">assets/</code>文件夹的一部分，使用<code class="du js jt ju jv b">createFromAsset()</code>传递资产的路径作为参数。例如，如果您的数据库位于:<code class="du js jt ju jv b">assets/database/myapp.db</code>，您将通过<code class="du js jt ju jv b">“database/myapp.db”</code>:</p><pre class="kz la lb lc fd ld jv le lf aw lg bi"><span id="ba25" class="lh jx hx jv b fi li lj l lk ll">Room.databaseBuilder(appContext, TestDatabase.class, “Sample.db”)<br/>    .createFromAsset(“database/myapp.db”)<br/>    .build()</span></pre><h1 id="5b11" class="jw jx hx bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">createFromFile()</h1><p id="4db9" class="pw-post-body-paragraph iu iv hx iw b ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr ha bi translated">如果您的数据库不在<code class="du js jt ju jv b">assets/</code>文件夹中，例如您从服务器下载并保存到磁盘，使用<code class="du js jt ju jv b">createFromFile()</code>并传递<code class="du js jt ju jv b">File</code>。</p><pre class="kz la lb lc fd ld jv le lf aw lg bi"><span id="5134" class="lh jx hx jv b fi li lj l lk ll">Room.databaseBuilder(appContext, TestDatabase.class, “Sample.db”)<br/>    .createFromFile(File(“mypath”))<br/>    .build()</span></pre><blockquote class="lm ln lo"><p id="4a41" class="iu iv lp iw b ix iy iz ja jb jc jd je lq jg jh ji lr jk jl jm ls jo jp jq jr ha bi translated">🚫在内存中，数据库不支持通过<code class="du js jt ju jv b">createFromAsset</code>或<code class="du js jt ju jv b">createFromFile</code>预填充数据库，如果你尝试这样做的话<code class="du js jt ju jv b">RoomDatabase.build()</code>方法将抛出一个<code class="du js jt ju jv b">IllegalArgumentException</code>。</p></blockquote><h1 id="6262" class="jw jx hx bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">文件权限</h1><p id="d1d1" class="pw-post-body-paragraph iu iv hx iw b ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr ha bi translated">Room不会打开您提供的数据库，而是复制它。因此，如果您使用的是<code class="du js jt ju jv b">File</code>，请确保您有读取权限，以便Room可以复制它。</p><h1 id="90c6" class="jw jx hx bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">数据库验证</h1><p id="ff9c" class="pw-post-body-paragraph iu iv hx iw b ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr ha bi translated">当从一个版本迁移到另一个版本时，Room确保数据库的有效性，因此当从资产或文件创建数据库时，它应用相同的有效性检查。就像这样，它确保了您正在复制数据的数据库的模式匹配。</p><blockquote class="lm ln lo"><p id="5552" class="iu iv lp iw b ix iy iz ja jb jc jd je lq jg jh ji lr jk jl jm ls jo jp jq jr ha bi translated">💡Room允许通过<code class="du js jt ju jv b">@Database</code>注释中的<code class="du js jt ju jv b"><a class="ae hu" href="https://developer.android.com/reference/android/arch/persistence/room/Database#exportschema" rel="noopener ugc nofollow" target="_blank">exportSchema</a></code>参数导出数据库模式。因此，当您创建预打包的数据库时，请使用其中定义的模式。</p></blockquote><h1 id="454a" class="jw jx hx bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">数据库迁移</h1><p id="bc07" class="pw-post-body-paragraph iu iv hx iw b ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr ha bi translated">一般来说，当数据库模式改变时，在<code class="du js jt ju jv b">@RoomDatabase</code>注释中增加数据库版本，或者实现迁移或者<a class="ae hu" href="https://developer.android.com/training/data-storage/room/migrating-db-versions#handle-missing-migrations" rel="noopener ugc nofollow" target="_blank">启用破坏性迁移</a>。Room会查看设备上已安装的版本和应用程序中定义的最新版本。</p><p id="a6bb" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">例如，假设设备上的数据库版本为2，而您的应用程序的数据库版本(在<code class="du js jt ju jv b">@RoomDatabase</code>中定义)为4。下面我们来看看当预打包的数据库也加入到组合中时，在不同的场景中会发生什么:</p><p id="4e8c" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hy"> 1。破坏性迁移</strong>已启用，并且<strong class="iw hy">预打包数据库</strong>的<strong class="iw hy">版本比您的应用程序中定义的</strong>版本旧，则数据库被丢弃，数据不会被复制。</p><p id="4371" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">示例:如果预打包的数据库版本为3，并且启用了破坏性迁移，则该数据库将被删除，并且不会复制数据。</p><p id="194d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hy"> 2。破坏性迁移</strong>已启用，并且<strong class="iw hy">预打包数据库</strong>的<strong class="iw hy">版本</strong>与您的应用程序中定义的版本相同，然后删除数据库，并从预打包数据库中复制数据。</p><p id="2274" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">示例:如果预打包的数据库是版本4，如应用程序的数据库版本，并且启用了破坏性迁移，则该数据库将被删除，数据将从预打包的数据库中复制。</p><p id="edd2" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hy"> 3。实施了迁移</strong>，并且<strong class="iw hy">预打包数据库的版本</strong>比您的<code class="du js jt ju jv b">@RoomDatabase</code>注释中的版本旧，那么Room将复制数据并运行迁移。</p><p id="0e61" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">示例:如果预打包的数据库是版本3，并且您实施了以下迁移:从版本2到版本3和从版本3到版本4，那么将运行从版本2到版本3的迁移，将复制数据库，然后运行从版本3到版本4的迁移。</p><figure class="kz la lb lc fd hj"><div class="bz dy l di"><div class="lt lu l"/></div></figure><blockquote class="lm ln lo"><p id="d64e" class="iu iv lp iw b ix iy iz ja jb jc jd je lq jg jh ji lr jk jl jm ls jo jp jq jr ha bi translated">💡作为一个最佳实践，确保预打包的数据库是与在<code class="du js jt ju jv b">@RoomDatabase</code>注释中声明的最新版本相同的版本。这样，您可以避免处理迁移案例。</p><p id="6bd7" class="iu iv lp iw b ix iy iz ja jb jc jd je lq jg jh ji lr jk jl jm ls jo jp jq jr ha bi translated">📖在这篇博文的<a class="ae hu" rel="noopener" href="/androiddevelopers/testing-room-migrations-be93cdb0d975">中阅读更多关于室内迁移的信息，在这里</a>阅读更多关于测试迁移的信息<a class="ae hu" rel="noopener" href="/androiddevelopers/understanding-migrations-with-room-f01e04b07929">。</a></p></blockquote></div><div class="ab cl lv lw go lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="ha hb hc hd he"><p id="005d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，您可以通过应用程序中的数据或文件轻松填充房间数据库。Room保护您数据的完整性，并在必要时帮助您执行迁移。请在下面的评论中告诉我们您如何在应用中使用预打包的数据库！</p><p id="d74a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">感谢<a class="mc md ge" href="https://medium.com/u/78430ce91f3a?source=post_page-----333ae190e680--------------------------------" rel="noopener" target="_blank">丹尼尔·圣地亚哥</a>、<a class="mc md ge" href="https://medium.com/u/22c02a30ae04?source=post_page-----333ae190e680--------------------------------" rel="noopener" target="_blank">尼克·布彻</a>和<a class="mc md ge" href="https://medium.com/u/e0a4c9469bb5?source=post_page-----333ae190e680--------------------------------" rel="noopener" target="_blank">何塞·阿尔塞雷卡</a>！💚</p></div></div>    
</body>
</html>