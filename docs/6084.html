<html>
<head>
<title>Open-sourcing KingPin, building blocks for scaling Pinterest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开源中心，扩展Pinterest的基石</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/open-sourcing-kingpin-building-blocks-for-scaling-pinterest-8febe81f2c1c?source=collection_archive---------3-----------------------#2016-03-04">https://medium.com/pinterest-engineering/open-sourcing-kingpin-building-blocks-for-scaling-pinterest-8febe81f2c1c?source=collection_archive---------3-----------------------#2016-03-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="55df" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">张数| Pinterest基础设施工程师</p><p id="36df" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当我们第一次开始构建Pinterest时，我们使用Python作为我们的开发语言，这有助于我们快速可靠地构建。多年来，我们围绕Python构建了许多工具，包括<a class="ae jc" href="https://github.com/pinterest/pinball" rel="noopener ugc nofollow" target="_blank"> Pinball </a>、<a class="ae jc" href="https://github.com/pinterest/mysql_utils" rel="noopener ugc nofollow" target="_blank"> MySQL_utils </a>和<a class="ae jc" href="https://github.com/pinterest/pymemcache" rel="noopener ugc nofollow" target="_blank"> pymemcache </a>，以及一组日常用于服务通信和配置管理的库。今天我们发布这个工具集，<a class="ae jc" href="https://github.com/pinterest/kingpin" rel="noopener ugc nofollow" target="_blank"> KingPin </a>，作为我们最新的开源包。</p><p id="7100" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">KingPin包含了我们在扩展Pinterest时学到的一些最佳实践，包括:</p><ul class=""><li id="9d18" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">一个本地守护进程来处理<a class="ae jc" href="https://zookeeper.apache.org/" rel="noopener ugc nofollow" target="_blank"> ZooKeeper的</a>单点故障(SPOF)问题。该守护程序运行在大约20K台主机上，在不到10秒的时间内提供配置数据。</li><li id="2f66" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">用于增强功能的Python节俭客户端包装器。我们通过这个Python客户端在Pinterest上每秒发送几十万个请求。</li><li id="6d0c" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">配置管理框架。我们有超过400种配置通过这个框架进行更新和使用。</li></ul><h2 id="3033" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">中枢使用案例</h2><p id="7f7c" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">在以下任何情况下，您都可以尝试使用KingPin:</p><ul class=""><li id="bc8a" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">您的栈也是面向Python的，运行在AWS上。</li><li id="e25e" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">你想让你的ZooKeeper集群更健壮，更有弹性。</li><li id="2c43" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">您正在构建一个配置系统，并希望您的配置支持一组丰富的数据结构，如列表、映射、集合和JSON。</li><li id="4ea3" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">您希望使用S3来存储一些最重要的元数据。</li><li id="6837" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">您正在使用Thrift并寻找一个更可靠的客户端库。</li></ul><h2 id="e744" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">中枢建筑</h2><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es kr"><img src="../Images/42845fe6cec3d5ecb5465f7a11f68510.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vxQocjkcU75Dp7YX.png"/></div></div></figure><p id="dd2a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">KingPin具有以下协同工作的组件:</p><ul class=""><li id="8984" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated"><strong class="ig hi">Kazoo Utils:</strong>Kazoo<a class="ae jc" href="https://kazoo.readthedocs.org/en/latest/" rel="noopener ugc nofollow" target="_blank">的包装器，它实现了我们用于RPC框架、服务发现和本地Kazoo APIs的一些增强的Utils。</a></li><li id="6b90" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi"> Thrift Utils: </strong>一个<a class="ae jc" href="https://engineering.pinterest.com/blog/how-we-use-gevent-go-fast" rel="noopener ugc nofollow" target="_blank"> greenlet-safe包装器</a>，用于Python Thrift客户端，内置了错误处理、重试处理、负载平衡和连接池管理。</li><li id="bdb5" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi">配置实用程序:</strong>一个在<a class="ae jc" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank"> S3 </a>上存储配置的系统，使用ZooKeeper作为通知系统向订阅者广播更新。(参见我们之前的<a class="ae jc" href="https://engineering.pinterest.com/blog/serving-configuration-data-scale-high-availability" rel="noopener ugc nofollow" target="_blank">博文</a>了解更多细节。)</li><li id="1f5e" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">ZK更新监视器:一个本地守护进程和服务器，将订阅的配置和服务器集从ZooKeeper和S3同步到本地磁盘。这是我们如何使用ZooKeeper容错的关键部分。(关于这个设计的更多信息，请看<a class="ae jc" href="https://engineering.pinterest.com/blog/zookeeper-resilience-pinterest" rel="noopener ugc nofollow" target="_blank">这篇博文</a>。)</li><li id="1c27" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi"> Decider: </strong>我们用来控制在线逻辑流程的实用程序，一个典型的用例是实验控制。设置了决策器，因此每个A/B测试实验都可以实时打开或关闭，而无需部署任何代码。决策器是建立在配置工具之上的。</li><li id="cb63" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi">托管数据结构:</strong>Python中一个方便的映射/列表数据结构抽象，构建在配置工具之上。</li><li id="7e48" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi">元配置管理器:</strong>管理所有配置/服务器集和依赖关系(订阅)的系统，构建在配置实用程序之上。</li></ul><h2 id="2ae4" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">实时配置管理和部署</h2><p id="e8b6" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">KingPin的另一个用例是实时管理配置。例如，工程师可以通过<a class="ae jc" href="https://github.com/pinterest/kingpin/blob/master/kingpin/metaconfig/metaconfig_utils.py" rel="noopener ugc nofollow" target="_blank">元配置管理器</a>创建一个新的配置，并将其添加到我们称之为“依赖”的订阅中</p><p id="ce00" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">配置内容作为基本事实存储在S3中，并使用ZooKeeper来跟踪和传播更新。为了正确下载订阅的配置，<a class="ae jc" href="https://github.com/pinterest/kingpin/blob/master/kingpin/zk_update_monitor/zk_update_monitor.py" rel="noopener ugc nofollow" target="_blank"> ZK更新监视器</a>必须在订阅者机器上运行。</p><p id="c405" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">应用程序可以读取文件并解码成Python对象，以便使用各种API进行CRUD操作。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es ld"><img src="../Images/4d3b73e41daef77ae3713c4ae76be005.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/0*QWDBeBUoPRYTyl71.png"/></div></figure><h2 id="5c29" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">服务发现</h2><p id="0911" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">我们依靠KingPin在Pinterest内部走向SOA(面向服务的架构)。SOA的一个基本构件是服务发现。服务客户机需要知道服务端点的地址，以便连接并向它们发送请求。KingPin提供了一个<a class="ae jc" href="https://github.com/pinterest/kingpin/blob/master/kingpin/zk_register/zk_register.py" rel="noopener ugc nofollow" target="_blank">脚本</a>供服务端点向ZooKeeper注册，这样服务客户机就可以使用端点列表(“serverset”)。</p><p id="a4a8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">类似地，ZK更新监视器从ZooKeeper下载服务器集，并将其放入本地文件。当服务器节点加入或离开时，服务器集会动态变化。</p><p id="f91b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用Thrift Utils中提供的<a class="ae jc" href="https://github.com/pinterest/kingpin/blob/master/kingpin/thrift_utils/thrift_client_mixin.py#L380" rel="noopener ugc nofollow" target="_blank"> Mixin </a>，Thrift客户机读取本地服务器集文件，并使用任何<a class="ae jc" href="https://github.com/pinterest/kingpin/blob/master/kingpin/kazoo_utils/hosts.py#L155" rel="noopener ugc nofollow" target="_blank"> HostSelector </a>算法与端点对话。Mixin还管理连接池，并允许用户根据特定的用例设置各种超时和重试策略。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es le"><img src="../Images/668060d3035974af6d6f8dc9632a0c96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/0*L5DlxHWlceCuke1x.png"/></div></figure><h2 id="32a0" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">入门指南</h2><p id="be31" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">我们在基础设施的各个部分使用KingPin。例如，ZK更新监视器运行在Pinterest的每个盒子上，实时部署最新的配置和服务器集。托管数据结构用于提供写入罕见读取频繁的配置数据，例如我们用来过滤垃圾邮件的域黑名单。每一个节俭的客户都使用Python服务框架。这里有数百个决策者控制在线逻辑，开启和关闭各种实验。</p><p id="2cfb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您现在可以访问<a class="ae jc" href="https://github.com/pinterest/kingpin" rel="noopener ugc nofollow" target="_blank">源代码</a>、<a class="ae jc" href="https://github.com/pinterest/kingpin/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">操作指南</a>和<a class="ae jc" href="https://github.com/pinterest/kingpin/tree/master/examples" rel="noopener ugc nofollow" target="_blank">示例</a>供自己使用。如果您有任何问题或意见，请拨打<a class="ae jc" href="mailto:kingpin-dev@googlegroups.com" rel="noopener ugc nofollow" target="_blank">kingpin-dev@googlegroups.com</a>联系我们。</p><p id="2a2e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lf">鸣谢:KingPin是Pinterest engineering的共同努力，多年来已经有了显著的发展。供稿者包括陈晓芳、Tracy Chou、Dannie Chu、Pavan Chitumalla、Steve Cohen、Jayme Cox、Michael Fu、洪家成、、Yash Nelapati、Aren Sandersen、Aleksandar Veselinovic、Chris Walters、和。感谢Jon Parise在开源过程中给予的支持。</em></p></div></div>    
</body>
</html>