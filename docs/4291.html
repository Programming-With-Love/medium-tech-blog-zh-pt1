<html>
<head>
<title>Tips on building a reliable, secure &amp; scalable architecture using Google Apps Script</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Apps脚本构建可靠、安全且可扩展的架构的技巧</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/tips-on-building-a-reliable-secure-scalable-architecture-using-google-apps-script-615afd4d4066?source=collection_archive---------1-----------------------#2020-04-22">https://medium.com/google-developer-experts/tips-on-building-a-reliable-secure-scalable-architecture-using-google-apps-script-615afd4d4066?source=collection_archive---------1-----------------------#2020-04-22</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/23828faf7eba687c07e4f98be10f75c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*q6c6gdCCmpHfkOAS"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo by <a class="ae it" href="https://unsplash.com/@alexabad?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Àlex Rodriguez</a> on <a class="ae it" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="208f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">大多数围绕使用Apps脚本创建的解决方案或自动化的对话最终会达到一个点，即能够解决围绕其可靠性、安全性和可扩展性的问题成为一个挑战，如果与在其他平台(如AWS、GCP、Firebase等)上构建类似的应用程序相比，这一点更为突出。).</p><p id="605c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">一些最常见的摩擦点包括-</p><ul class=""><li id="e6f7" class="js jt hh iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">管理并发执行</li><li id="aa5f" class="js jt hh iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">能够安全地存储、访问和管理API密钥、令牌等。</li><li id="b818" class="js jt hh iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">灵活扩展，而不会达到那些<a class="ae it" href="https://developers.google.com/apps-script/guides/services/quotas" rel="noopener ugc nofollow" target="_blank">配额和限制</a></li></ul><p id="7220" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果有人在打造下一个Spotify或网飞，我不会推荐使用<a class="ae it" href="https://gsuite.google.com/products/apps-script/" rel="noopener ugc nofollow" target="_blank"> G Suite的应用脚本</a>(显然😂)但是，根据中小型企业使用的应用程序的类型，我们仍然可以通过轻松地使用一些鲜为人知的服务来非常有效地利用这个平台。<br/>虽然这并不是说Apps脚本能够适应每一种用例，但是可以把这种讨论看作是改进现有应用的方法。</p><p id="91c8" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在这篇文章中，我们将看到如何通过解决这些问题的一部分来导航我们的方法，并且探索我们可以从一开始就烘焙一些解决方案的方法！</p><h1 id="f6e4" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">可靠性</h1><p id="6533" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">在我使用Apps脚本的前6个月，它主要是作为一个webhook来捕获和存储电子表格中的数据，我遇到了丢失条目的问题，有时甚至是不准确的条目，使整个数据集不可靠。我花了一些时间才明白这是因为端点上的并发点击(当<a class="ae it" href="https://developers.google.com/apps-script/guides/web#deploying_a_script_as_a_web_app" rel="noopener ugc nofollow" target="_blank">将脚本部署为web应用</a>时我们得到的链接)。很久以后，我才接触到Apps Script提供的'<a class="ae it" href="https://developers.google.com/apps-script/reference/lock/lock" rel="noopener ugc nofollow" target="_blank">锁服务</a>，它就是为处理这种情况而设计的。</p><blockquote class="lj lk ll"><p id="e8f0" class="iu iv lm iw b ix iy iz ja jb jc jd je ln jg jh ji lo jk jl jm lp jo jp jq jr ha bi translated">该服务允许脚本阻止对代码段的并发访问。当有多个用户或进程修改共享资源并希望防止冲突时，这很有用。</p></blockquote><p id="40a1" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">幸运的是，我甚至不需要自己创建一个例子来说明它的用法，因为'<a class="ae it" href="https://developers.google.com/apps-script/reference/lock/lock" rel="noopener ugc nofollow" target="_blank"> Lock </a>'类的现有文档中已经有了一个关于这个场景的例子。</p><p id="f12c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这是文档中的一个快照，供参考-</p><figure class="lr ls lt lu fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lq"><img src="../Images/9b9a3700c35812280f8cac82f411a663.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TDlKsvg_W6bZYBjz"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx"><a class="ae it" href="https://developers.google.com/apps-script/reference/lock/lock" rel="noopener ugc nofollow" target="_blank">Lock Class</a> in Google Apps Script</figcaption></figure><p id="4be8" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">也有不同的<a class="ae it" href="https://developers.google.com/apps-script/reference/lock/lock#methods" rel="noopener ugc nofollow" target="_blank">实现方法</a>可用，根据您想要构建的架构类型，您可以选择返回一个布尔值或者让函数抛出一个异常。</p><p id="a183" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在您现有的开发环境中引入“<a class="ae it" href="https://developers.google.com/apps-script/reference/lock/lock-service" rel="noopener ugc nofollow" target="_blank">锁服务</a>，肯定会在可靠性方面给您带来提升。</p><h1 id="7fbd" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">安全性</h1><p id="cf55" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">大多数连接到第三方服务的应用程序脚本的开源示例在代码库中至少有一个(如果不是更多的话)变量，这些变量将被声明为API密钥、令牌或其他秘密的占位符。现在，想象一下，如果您计划与您的同事或客户共享这个实现，很有可能您也必须向他们公开您的硬编码凭证；在我与其他技术专家的几乎所有对话和个人经历中，这都被认为是一个主要的安全*风险。</p><p id="5d96" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">* <em class="lm">出于本文的目的，我将把我的范围限制在这个(特定)场景的</em> <strong class="iw hi"> <em class="lm">安全性</em> </strong> <em class="lm">上。</em></p><p id="1f9b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我们以<a class="ae it" href="https://github.com/gsuitedevs/solutions/blob/master/feedback-sentiment-analysis/src/Code.js" rel="noopener ugc nofollow" target="_blank">反馈-情感-分析</a>解决方案为例，其中第2行有一个占位符供您设置API键</p><figure class="lr ls lt lu fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lv"><img src="../Images/2d59dd3ac81b707fb2c61d710e5901c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sO0z7HtsYm5OJYbv"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Example solution: <a class="ae it" href="https://github.com/gsuitedevs/solutions/blob/master/feedback-sentiment-analysis/src/Code.js" rel="noopener ugc nofollow" target="_blank">feedback-sentiment-analysis</a></figcaption></figure><p id="e5f7" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">给定在Google Sheets中<a class="ae it" href="https://developers.google.com/apps-script/guides/menus" rel="noopener ugc nofollow" target="_blank">创建自定义菜单</a>的实现(第17行)，您可以放心地假设这是一个容器绑定脚本(同样，没有找到可安装的触发器)。</p><p id="b365" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">解决这些情况的一个方法是-</p><ul class=""><li id="c823" class="js jt hh iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">引入一个“<a class="ae it" href="https://developers.google.com/apps-script/guides/dialogs#prompt_dialogs" rel="noopener ugc nofollow" target="_blank">提示</a>”对话框，用户可以在执行应用程序时输入API凭证(可能是第一次)</li></ul><figure class="lr ls lt lu fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lw"><img src="../Images/4750b686f5252f6d33c13886c755ef31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*suIlncL3g4EFhtpQ"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx"><a class="ae it" href="https://developers.google.com/apps-script/guides/dialogs#prompt_dialogs" rel="noopener ugc nofollow" target="_blank">Prompt dialogs</a> in Google Apps Script</figcaption></figure><ul class=""><li id="8376" class="js jt hh iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">然后使用'<a class="ae it" href="https://developers.google.com/apps-script/guides/properties" rel="noopener ugc nofollow" target="_blank">属性服务</a>'将该信息存储为文档、用户或脚本属性的一部分(取决于用例)</li></ul><p id="a762" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">通过这种方式，所有这些重要的凭证和机密都不会以可见的方式显示给每个人使用，如果有人试图以编程方式从设置的属性中检索信息，您总是可以跟踪日志来识别用户。</p><p id="b6ad" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这类似于为Google Apps脚本构建<a class="ae it" href="https://github.com/gsuitedevs/apps-script-oauth2" rel="noopener ugc nofollow" target="_blank"> OAuth2库时使用的方法。</a></p><h1 id="5ca0" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">可量测性</h1><p id="a8c7" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">不允许应用脚本无限扩展的一个重要因素是它的<a class="ae it" href="https://developers.google.com/apps-script/guides/services/quotas" rel="noopener ugc nofollow" target="_blank">配额和限制</a>。在这篇文章中，我将展示在两个最重要的方面变得聪明的方法</p><ol class=""><li id="fbe2" class="js jt hh iw b ix iy jb jc jf ju jj jv jn jw jr lx jy jz ka bi translated">脚本运行时—适用于每一次执行<br/>(不要与“自定义函数运行时”混淆)</li><li id="9ffb" class="js jt hh iw b ix kb jb kc jf kd jj ke jn kf jr lx jy jz ka bi translated">URL获取调用—适用于用户/帐户的每日阈值</li></ol><h1 id="a49e" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">脚本运行时</h1><p id="cd63" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">通常，当迭代一大组电子表格数据时，您需要更高的运行时间，但更多时候，会出现错误——“超出最大执行时间”。</p><figure class="lr ls lt lu fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ly"><img src="../Images/fccf4517d3e74e789231473f81df04e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*O1usyE1aNOicVKHE"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">“Exceeded maximum execution time” error in Google Apps Script</figcaption></figure><p id="3ed2" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">一种更好的方法是，不直接通过循环运行主函数，您还可以跟踪每个循环执行了多长时间，并在脚本达到其运行时阈值之前，通过生成一个基于时间的触发器<a class="ae it" href="https://developers.google.com/apps-script/reference/script/clock-trigger-builder" rel="noopener ugc nofollow" target="_blank">以编程方式终止脚本，主函数足够智能，可以识别其最后一个检查点是什么，并在下次调用时从那里开始，而不是重新开始， 从顶部——这可以很容易地通过电子表格中的标记或者通过将该信息存储在</a><a class="ae it" href="https://developers.google.com/apps-script/reference/properties/properties-service#getScriptProperties()" rel="noopener ugc nofollow" target="_blank">脚本属性</a>中来实现。</p><p id="3d69" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">关于这个实现的更详细的介绍可以在我不久前撰写的原始文章中找到。</p><h1 id="2111" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">URL获取调用</h1><p id="388b" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">可能有几个例子，你可能最终会消耗大量的URL获取调用。-</p><ul class=""><li id="40db" class="js jt hh iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">虽然普遍不受欢迎，但您可能必须轮询API以了解其任意数量的资源的更新状态</li><li id="14f6" class="js jt hh iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">考虑到更大的日期范围，通过data studio的连接器服务与它连接也可以证明URL获取调用的大量使用</li><li id="32a0" class="js jt hh iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">对于您正在查询的数据集，一些第三方API服务可能有大量的分页，或者有多个跳转来捕获必要的信息</li></ul><p id="c72c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我们以data studio连接器用例为例！在这里，为了节省URL获取调用，您可以利用Apps脚本的'<a class="ae it" href="https://developers.google.com/apps-script/reference/cache" rel="noopener ugc nofollow" target="_blank">缓存服务</a>，其中一个用户在给定时间点请求的数据可以存储在<a class="ae it" href="https://developers.google.com/apps-script/reference/cache/cache-service#getscriptcache" rel="noopener ugc nofollow" target="_blank">脚本缓存</a>中，供另一个用户在大约相同的时间请求相同的信息集(或子集)时使用。</p><p id="3238" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">然后，由代码逻辑首先检查缓存中请求的数据，如果在数据存储的日期范围内，则返回该数据，而不是进行另一个URL获取调用。</p><p id="a869" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在'<a class="ae it" href="https://developers.google.com/apps-script/reference/cache/cache" rel="noopener ugc nofollow" target="_blank"> Cache </a>'类文档中可以找到一个不同的、尽管很好的例子，它讲述了获取一个响应非常慢的RSS提要</p><figure class="lr ls lt lu fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lz"><img src="../Images/6cbddbdb899e0a8767d26f77c50edf79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rpPbUTu5AkuSqylO"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx"><a class="ae it" href="https://developers.google.com/apps-script/reference/cache/cache" rel="noopener ugc nofollow" target="_blank">Cache Class</a> in Google Apps Script</figcaption></figure><p id="d35f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">虽然这解决了一个稍微不同的痛点，但是您也可以使用相同的方法来保存您的URL获取调用。</p><p id="289b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">本文讨论的一些服务在大多数实现中并没有被重点强调，甚至没有被考虑过，虽然它们并没有描绘出完美的解决方案，但我希望了解它们的存在会有所帮助。</p><p id="26f3" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果您碰巧知道针对这些结构提高效率的更好方法，请告诉我们😊或者通过<a class="ae it" href="https://twitter.com/schoraria911" rel="noopener ugc nofollow" target="_blank"> Twitter </a> (DMs开放)<a class="ae it" href="https://www.linkedin.com/in/schoraria/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>或者在这里的评论区。</p></div></div>    
</body>
</html>