# çª—å£æ’å…¥+ç‰‡æ®µè¿‡æ¸¡

> åŸæ–‡ï¼š<https://medium.com/androiddevelopers/windows-insets-fragment-transitions-9024b239a436?source=collection_archive---------2----------------------->

## æ‚²æƒ¨çš„æ•…äº‹

![](img/62891816e492ce0ddacbee5cff581786.png)

[Cat Window](https://flic.kr/p/92WJtS)

è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘å†™çš„å…³äºç‰‡æ®µè½¬æ¢çš„ç³»åˆ—æ–‡ç« çš„ç¬¬äºŒç¯‡ã€‚ä¸‹é¢æ˜¯ç¬¬ä¸€ä¸ªï¼Œå®ƒè®¾ç½®äº†å¦‚ä½•è®©ç‰‡æ®µè¿‡æ¸¡å·¥ä½œã€‚

[](/google-developers/fragment-transitions-ea2726c3f36f) [## ç‰‡æ®µè½¬æ¢

### è®©ä»–ä»¬å·¥ä½œ

medium.com](/google-developers/fragment-transitions-ea2726c3f36f) 

> åœ¨æˆ‘ç»§ç»­ä¹‹å‰ï¼Œæˆ‘å‡è®¾ä½ çŸ¥é“ä»€ä¹ˆæ˜¯çª—å£æ’å…¥ï¼Œä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•è¢«åˆ†æ´¾çš„ã€‚å¦‚æœä½ ä¸çŸ¥é“ï¼Œæˆ‘å»ºè®®ä½ çœ‹çœ‹è¿™ä¸ªæ¼”è®²(æ˜¯çš„ï¼Œæ˜¯æˆ‘å†™çš„ğŸ™‹)

[](https://chris.banes.me/talks/2017/becoming-a-master-window-fitter-lon/) [## æˆä¸ºçª—æˆ·è£…é…å·¥å¤§å¸ˆğŸ”§

### çª—å£æ’å…¥é•¿æœŸä»¥æ¥ä¸€ç›´æ˜¯å¼€å‘äººå‘˜å›°æƒ‘çš„æ¥æºï¼Œè¿™æ˜¯å› ä¸ºå®ƒä»¬ç¡®å®éå¸¸ä»¤äººå›°æƒ‘â€¦

å…‹é‡Œæ–¯.è´æ©æ–¯.æˆ‘](https://chris.banes.me/talks/2017/becoming-a-master-window-fitter-lon/) 

æˆ‘è¦å¦ç™½ä¸€ä»¶äº‹ã€‚å½“æˆ‘å†™è¿™ä¸ªç³»åˆ—çš„ç¬¬ä¸€ç¯‡åšæ–‡æ—¶ï¼Œæˆ‘åœ¨è§†é¢‘ä¸Šåšäº†ä¸€ç‚¹æ‰‹è„šã€‚æˆ‘å®é™…ä¸Šé‡åˆ°äº†ä¸€ä¸ªçª—å£æ’å…¥çš„é—®é¢˜ï¼Œè¿™æ„å‘³ç€æˆ‘å®é™…ä¸Šç»“æŸäº†å¦‚ä¸‹:

![](img/65d8c85ad5eb0fe14102af16e8010333.png)

Transition breaks status bar handling

Woopsï¼Œä¸å®Œå…¨æ˜¯æˆ‘åœ¨ç¬¬ä¸€ä¸ªå¸–å­é‡Œå±•ç¤ºçš„ğŸ¤ã€‚æˆ‘ä¸æƒ³æŠŠç¬¬ä¸€ç¯‡æ–‡ç« å†™å¾—å¤ªå¤æ‚ï¼Œæ‰€ä»¥å†³å®šæŠŠå®ƒå•ç‹¬å†™å‡ºæ¥ã€‚æ— è®ºå¦‚ä½•ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œå½“æ·»åŠ è½¬æ¢æ—¶ï¼Œæˆ‘ä»¬çªç„¶å¤±å»äº†æ‰€æœ‰çš„çŠ¶æ€æ å¤„ç†ï¼Œè§†å›¾è¢«æ¨åˆ°äº†çŠ¶æ€æ çš„åé¢ã€‚

## é—®é¢˜æ˜¯

è¿™ä¸¤ä¸ªç‰‡æ®µéƒ½å¤§é‡ä½¿ç”¨çª—å£å°å›¾æ¥ç»˜åˆ¶ç³»ç»Ÿæ çš„åé¢ã€‚ç‰‡æ®µ A ä½¿ç”¨ä¸€ä¸ª [CoordinatorLayout](https://developer.android.com/reference/android/support/design/widget/CoordinatorLayout.html) å’Œ [AppBarLayout](https://developer.android.com/reference/android/support/design/widget/AppBarLayout.html) ï¼Œè€Œç‰‡æ®µ B ä½¿ç”¨è‡ªå®šä¹‰çª—å£åµŒå…¥å¤„ç†(é€šè¿‡ applywindowsetslistener ä¸Šçš„[)ã€‚ä¸ç®¡å®ç°å¦‚ä½•ï¼Œè¿™ç§è½¬æ¢éƒ½ä¼šæŠŠä¸¤è€…éƒ½æä¹±ã€‚](https://developer.android.com/reference/android/support/v4/view/OnApplyWindowInsetsListener.html)

é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿå½“æ‚¨ä½¿ç”¨ç‰‡æ®µè½¬æ¢æ—¶ï¼Œé€€å‡º(ç‰‡æ®µ A)å’Œè¿›å…¥(ç‰‡æ®µ B)å†…å®¹è§†å›¾çš„å®é™…æƒ…å†µå¦‚ä¸‹:

1.  è¿‡æ¸¡å·²å®Œæˆã€‚
2.  å› ä¸ºæˆ‘ä»¬åœ¨ç‰‡æ®µ A ä¸Šä½¿ç”¨äº†é€€å‡ºè¿‡æ¸¡ï¼Œæ‰€ä»¥è§†å›¾ A ä¿æŒä¸å˜ï¼Œå¹¶ä¸”è¿‡æ¸¡åœ¨å…¶ä¸Šè¿è¡Œã€‚
3.  è§†å›¾ B è¢«æ·»åŠ åˆ°å®¹å™¨è§†å›¾ä¸­ï¼Œå¹¶ç«‹å³è®¾ç½®ä¸ºä¸å¯è§ã€‚
4.  å¼€å§‹ç‰‡æ®µ B çš„è¿›å…¥å’Œâ€œå…±äº«å…ƒç´ è¿›å…¥â€è½¬æ¢ã€‚
5.  è§†å›¾ B è¢«è®¾ç½®ä¸ºå¯è§ã€‚
6.  å½“ç‰‡æ®µ A çš„é€€å‡ºè½¬æ¢å®Œæˆæ—¶ï¼Œè§†å›¾ A ä»å®¹å™¨è§†å›¾ä¸­ç§»é™¤ã€‚

è¿™å¬èµ·æ¥ä¸é”™ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆå®ƒä¼šçªç„¶å½±å“çª—å£æ’å…¥çš„å¤„ç†å‘¢ï¼Ÿè¿™éƒ½æ˜¯å› ä¸ºåœ¨è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œä¸¤ä¸ªç‰‡æ®µçš„è§†å›¾éƒ½å‡ºç°åœ¨å®¹å™¨ä¸­ã€‚

è¿™å¬èµ·æ¥å¾ˆå¥½ï¼Œå¯¹å—ï¼Ÿåœ¨æˆ‘çš„åœºæ™¯ä¸­ï¼Œä¸¤ä¸ªç‰‡æ®µçš„è§†å›¾éƒ½æƒ³è¦å¤„ç†å’Œä½¿ç”¨çª—å£æ’å…¥ï¼Œå› ä¸ºå®ƒä»¬éƒ½å¸Œæœ›çœ‹åˆ°å±å¹•ä¸Šå”¯ä¸€çš„â€œä¸»â€è§†å›¾ã€‚ä½†æ˜¯åªæœ‰ä¸€ä¸ªè§†å›¾ä¼šæ”¶åˆ°çª—å£æ’å…¥:ç¬¬ä¸€ä¸ªå­è§†å›¾ã€‚è¿™æ˜¯ç”±äº ViewGroup [åˆ†æ´¾çª—å£æ’å…¥](https://android.googlesource.com/platform/frameworks/base/+/refs/heads/master/core/java/android/view/ViewGroup.java#6928)çš„æ–¹å¼ï¼Œå³é€šè¿‡ä¾æ¬¡è¿­ä»£å…¶å­å…ƒç´ ï¼Œç›´åˆ°å…¶ä¸­ä¸€ä¸ªå…ƒç´ æ¶ˆè€—äº†è¿™äº›æ’å…¥ã€‚å¦‚æœç¬¬ä¸€ä¸ªå­©å­(è¿™é‡Œçš„ç‰‡æ®µ A)æ¶ˆè€—äº† insetsï¼Œé‚£ä¹ˆä»»ä½•åç»­çš„å­©å­(è¿™é‡Œçš„ç‰‡æ®µ B)éƒ½å¾—ä¸åˆ°å®ƒä»¬ï¼Œæˆ‘ä»¬å°±ç»“æŸäº†è¿™ç§æƒ…å†µã€‚

è®©æˆ‘ä»¬å†æ¥ä¸€éï¼Œä½†æ˜¯è¿™ä¸€æ¬¡å¢åŠ äº†è°ƒåº¦çª—å£æ’å…¥çš„æ—¶é—´:

1.  äº¤æ˜“å·²å®Œæˆã€‚
2.  ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é€€å‡ºè½¬æ¢ï¼Œè§†å›¾ A ä¿æŒä¸å˜ï¼Œè½¬æ¢åœ¨å…¶ä¸Šè¿è¡Œã€‚
3.  è§†å›¾ B è¢«æ·»åŠ åˆ°å®¹å™¨è§†å›¾ä¸­ï¼Œå¹¶ç«‹å³è®¾ç½®ä¸ºä¸å¯è§ã€‚
4.  **çª—å£å°å›¾è¢«è°ƒåº¦ã€‚æˆ‘ä»¬å¸Œæœ›è§†å›¾ B(å­è§†å›¾ 1)è·å¾—å®ƒä»¬ï¼Œä½†æ˜¯è§†å›¾ A(å­è§†å›¾ 0)å†æ¬¡è·å¾—å®ƒä»¬ã€‚**
5.  å¼€å§‹ç‰‡æ®µ B çš„è¿›å…¥å’Œâ€œå…±äº«å…ƒç´ è¿›å…¥â€è½¬æ¢ã€‚
6.  è§†å›¾ B è¢«è®¾ç½®ä¸ºå¯è§ã€‚
7.  å½“ç‰‡æ®µ A çš„é€€å‡ºè½¬æ¢å®Œæˆæ—¶ï¼Œè§†å›¾ A è¢«ç§»é™¤ã€‚

## ä¿®å¤

ä¿®å¤å®é™…ä¸Šç›¸å¯¹ç®€å•:æˆ‘ä»¬åªéœ€è¦ç¡®ä¿ä¸¤ä¸ªè§†å›¾
éƒ½æ¥æ”¶åˆ°çª—å£æ’å…¥ã€‚

æˆ‘è¿™æ ·åšçš„æ–¹æ³•æ˜¯åœ¨å®¹å™¨è§†å›¾ä¸­æ·»åŠ ä¸€ä¸ª[on applywindowsetslistener](https://developer.android.com/reference/android/support/v4/view/OnApplyWindowInsetsListener.html)(åœ¨æœ¬ä¾‹ä¸­æ˜¯åœ¨ä¸»æœºæ´»åŠ¨ä¸­),å®ƒæ‰‹åŠ¨å°†ä»»ä½• insets åˆ†æ´¾ç»™å®ƒçš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä½¿ç”¨ insets ä¹‹å‰ã€‚

```
fragment_container.setOnApplyWindowInsetsListener { view, insets ->
  var consumed = false

  (view as ViewGroup).forEach { child ->
    *// Dispatch the insets to the child*
    val childResult = child.dispatchApplyWindowInsets(insets)
    *// If the child consumed the insets, record it*
    if (childResult.isConsumed) {
      consumed = true
    }
  }

  *// If any of the children consumed the insets, return
  // an appropriate value*
  if (consumed) insets.consumeSystemWindowInsets() else insets
}
```

åœ¨æˆ‘ä»¬åº”ç”¨ä¹‹åï¼Œä¸¤ä¸ªç‰‡æ®µéƒ½æ”¶åˆ°äº†çª—å£æ’å…¥ï¼Œæˆ‘ä»¬å¾—åˆ°äº†æˆ‘åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­å®é™…æ˜¾ç¤ºçš„ç»“æœ:

![](img/6fd20be0fd63551f9ef5c169da38b98a.png)

## å¥–é‡‘éƒ¨åˆ†ğŸ’ƒ:ç¡®ä¿è¯·æ±‚

æˆ‘å·®ç‚¹å¿˜äº†å†™ä¸€ä»¶ç›¸å…³çš„å°äº‹ã€‚å¦‚æœä½ åœ¨ç‰‡æ®µä¸­å¤„ç†çª—å£æ’å…¥ï¼Œéšå¼åœ°(é€šè¿‡ä½¿ç”¨ AppBarLayout ç­‰)æˆ–æ˜¾å¼åœ°ï¼Œä½ éœ€è¦ç¡®ä¿ä½ è¯·æ±‚ä¸€äº›æ’å…¥ã€‚ä½¿ç”¨ [requestApplyInsets()](https://developer.android.com/reference/android/support/v4/view/ViewCompat.html#requestApplyInsets(android.view.View)) å¾ˆå®¹æ˜“åšåˆ°è¿™ä¸€ç‚¹:

```
override funonViewCreated(view: View, icicle: Bundle) {
  super.onViewCreated(view, savedInstanceState)
  *// yadda, yadda* **ViewCompat.requestApplyInsets(view)**
}
```

ä½ å¿…é¡»è¿™æ ·åšï¼Œå› ä¸ºåªæœ‰å½“æ•´ä¸ªè§†å›¾å±‚æ¬¡ç»“æ„**çš„èšåˆç³»ç»Ÿ ui å¯è§æ€§å€¼å‘ç”Ÿå˜åŒ–**æ—¶ï¼Œçª—å£æ‰ä¼šè‡ªåŠ¨å‘ä¸‹å‘é€ insetsã€‚ç”±äºå¯èƒ½æœ‰ä¸¤ä¸ªç‰‡æ®µæä¾›å®Œå…¨ç›¸åŒçš„å€¼çš„æ—¶å€™ï¼Œèšé›†å€¼ä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥ç³»ç»Ÿå°†å¿½ç•¥â€œæ”¹å˜â€ã€‚