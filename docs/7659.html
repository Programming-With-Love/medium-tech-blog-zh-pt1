<html>
<head>
<title>Kafka Ecosystem on Walmart’s Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">沃尔玛云上的卡夫卡生态系统</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/kafka-ecosystem-on-walmarts-cloud-983570dff1f2?source=collection_archive---------2-----------------------#2016-12-09">https://medium.com/walmartglobaltech/kafka-ecosystem-on-walmarts-cloud-983570dff1f2?source=collection_archive---------2-----------------------#2016-12-09</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="967c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们之前的<a class="ae jc" rel="noopener" href="/walmartlabs/tech-transformation-real-time-messaging-at-walmart-8787f5ab19e8#.p7maleepr">博客</a>中，我们介绍了“为什么”我们将沃尔玛的Kafka服务从共享裸机迁移到新的“自助式”Kafka部署，该部署由<a class="ae jc" href="https://www.youtube.com/watch?v=pdWSWs08LMg" rel="noopener ugc nofollow" target="_blank"> OpenStack </a>和<a class="ae jc" href="http://www.oneops.com/" rel="noopener ugc nofollow" target="_blank"> OneOps </a>提供支持。今天，我想介绍一下卡夫卡的生态系统是什么样子的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/2269680de33d37914c0e81105d65d87f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sYchmsP723AInyd2_GXK1w.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Kafka Ecosystem at Walmart</figcaption></figure><p id="a267" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">上图没有完全捕捉所有实时管道，但旨在突出关键组件及其之间的关系。</p><h2 id="c0df" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ip ke kf kg it kh ki kj ix kk kl km kn bi translated">核心服务</h2><ul class=""><li id="7bf9" class="ko kp hh ig b ih kq il kr ip ks it kt ix ku jb kv kw kx ky bi translated"><strong class="ig hi"> Kafka Brokers </strong>:我们目前正在推出Kafka版本0.10.1.0，采用了<a class="ae jc" href="https://kafka.apache.org/documentation#java" rel="noopener ugc nofollow" target="_blank">建议的JVM参数，</a>以利用与0.8系列相比更好的稳定性和可靠性。</li><li id="ef61" class="ko kp hh ig b ih kz il la ip lb it lc ix ld jb kv kw kx ky bi translated"><strong class="ig hi"> MirrorMaker </strong>:它用于将某些主题从一个Kafka集群复制到另一个Kafka集群，通常跨数据中心。我们创建了一个内部代码补丁来支持完整的主题重命名。</li><li id="ef82" class="ko kp hh ig b ih kz il la ip lb it lc ix ld jb kv kw kx ky bi translated"><strong class="ig hi"> Kafka REST代理</strong>:支持非Java客户端的基于HTTP的代理。这对于我们现有的系统非常有用，因为它们可能会为了方便而牺牲一点点吞吐量，例如，不用自己的编程语言编写Kafka客户端。</li><li id="b22c" class="ko kp hh ig b ih kz il la ip lb it lc ix ld jb kv kw kx ky bi translated"><strong class="ig hi"> Kafka Connect </strong>:用于将Kafka数据存储在永久存储器中，如HDFS。好处包括:(1)基于Hadoop的应用程序现在可以使用Kafka数据，以及(2)针对数据丢失的另一个保护级别。</li></ul><h2 id="e228" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ip ke kf kg it kh ki kj ix kk kl km kn bi translated">卡夫卡UI</h2><p id="ccbe" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip le ir is it lf iv iw ix lg iz ja jb ha bi translated">Apache Kafka没有UI，所以我们继承了开源的Kafka Manager ,因为它有简洁的UI设计和完善的操作特性。我们不足的几个地方之一是“监控”为了补救这一点，在我们自己的Kafka Manager分支中，我们在Kafka Manager的每个页面中添加了受欢迎的Kafka指标的监控图。例如，代理级页面:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lh"><img src="../Images/6b3e26a68c5ac4560335c35e0da896a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YRIWkJh097Ony1KFAx7iVA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Kafka Manager with Monitoring</figcaption></figure><p id="15ad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过点击监控图，我们甚至可以看到不同历史时刻的监控图。(例如，过去1/2/4小时、过去一天/一周/一个月，甚至是去年)。举个例子，</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es li"><img src="../Images/f40df775b8320c1915f8dcf5f2d23847.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zk7ht7uAv-B7HrVKi-OsZA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Monitoring Graphs across Different Historical Moments</figcaption></figure><p id="55be" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">消费者滞后，表示消费者落后于生产者的程度，也可以形象化为这张图。例如:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lj"><img src="../Images/5e9c183c9330cae0742f99756ac95ae5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ob3zNEYSc0yTDpdWe9uHPQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Kafka Consumer Lag with Monitoring Graph</figcaption></figure><h2 id="7a04" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ip ke kf kg it kh ki kj ix kk kl km kn bi translated">部署</h2><p id="228d" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip le ir is it lf iv iw ix lg iz ja jb ha bi translated">为了获得更好的性能，我们建议用户在一个数据中心部署Kafka集群，但是如果整个数据中心都停机，这将会有一个可用性问题。</p><p id="7856" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">事实上，我们的许多Kafka用例都有一些共性:</p><ol class=""><li id="a4c4" class="ko kp hh ig b ih ii il im ip lk it ll ix lm jb ln kw kx ky bi translated"><strong class="ig hi">本地生产者</strong>:数据源独立位于2-3个主要数据中心，没有重复。例如，Walmart.com<a class="ae jc" href="https://www.walmart.com/" rel="noopener ugc nofollow" target="_blank">的</a>由跨多个数据中心的许多应用程序提供支持，如果我们想要收集它们的日志，源位于2-3个地方，但是没有重复的日志。</li><li id="74b6" class="ko kp hh ig b ih kz il la ip lb it lc ix ld jb ln kw kx ky bi translated"><strong class="ig hi">全球消费者</strong>:下游应用程序希望全面了解来自所有数据中心的数据。例如，应用程序性能监控(APM)工具需要获取所有日志，以便显示指标并提醒数据中心的哪个应用程序出现了问题。</li></ol><p id="86cc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了满足“本地生产者”、“全球消费者”和跨数据中心的高可用性(应用程序级，例如APM)，部署计划通常如下所示:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lo"><img src="../Images/2e8d516d571d92b6db5e3d0b2652745a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZmBiQsQUM__f2qzsHa-UTg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Kafka Deployment to achieve High Availability for Application</figcaption></figure><p id="e771" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从上图来看，生产者只向本地Kafka集群生产，每个数据中心的消费者同时收听两个(甚至更多)话题:一个是“本地”话题，另一个是来自其他集群的“镜像”话题。</p><p id="3397" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，如果数据中心停机，Kafka集群和MirrorMaker离线，应用程序的VIP应该切换到工作数据中心(如果需要)。暂时，工作的消费者只能看到本地消息，但是依赖于消费者的应用程序仍然在运行。</p><p id="30dc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当数据中心恢复时，Kafka群集将恢复工作，MirrorMaker将从数据中心停机时开始复制数据。</p><h2 id="52be" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ip ke kf kg it kh ki kj ix kk kl km kn bi translated">监控管道</h2><p id="c299" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip le ir is it lf iv iw ix lg iz ja jb ha bi translated">我们使用<a class="ae jc" href="https://github.com/jmxtrans/jmxtrans" rel="noopener ugc nofollow" target="_blank"> jmxtrans </a>作为JMX和监控后端之间的桥梁。目前我们支持两个监控后端:<a class="ae jc" href="https://graphite.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> Graphite </a>和<a class="ae jc" href="http://ganglia.info/" rel="noopener ugc nofollow" target="_blank"> Ganglia </a>，这由用户在部署Kafka时选择。</p><ul class=""><li id="6999" class="ko kp hh ig b ih ii il im ip lk it ll ix lm jb kv kw kx ky bi translated">Ganglia:我们使用单播模式来最小化网络“抖动”,因为网络通常是云上主机之间的“细”管道。</li><li id="39fe" class="ko kp hh ig b ih kz il la ip lb it lc ix ld jb kv kw kx ky bi translated">Graphite:适用于希望在Graphite上使用<a class="ae jc" href="http://Grafana" rel="noopener ugc nofollow" target="_blank"> Grafana </a>构建漂亮仪表板的用户。</li></ul><p id="0c75" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们未来工作的一部分是支持用于存储指标的可伸缩时序数据存储，如<a class="ae jc" href="https://github.com/influxdata/influxdb" rel="noopener ugc nofollow" target="_blank"> influxdb </a>、<a class="ae jc" href="https://github.com/kairosdb/kairosdb" rel="noopener ugc nofollow" target="_blank"> kariosdb </a>。</p><h2 id="3c6c" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ip ke kf kg it kh ki kj ix kk kl km kn bi translated">沃尔玛的物流加工</h2><p id="5304" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip le ir is it lf iv iw ix lg iz ja jb ha bi translated">随着许多开源系统的出现，流处理领域一直在蓬勃发展。在沃尔玛，我们主要使用<a class="ae jc" href="http://spark.apache.org/streaming/" rel="noopener ugc nofollow" target="_blank"> Spark Streaming </a>和<a class="ae jc" href="http://storm.apache.org/" rel="noopener ugc nofollow" target="_blank"> Storm: </a> Storm提供了具有巨大可扩展性的光速流处理基础设施，而Spark拥有<a class="ae jc" href="https://spark-summit.org/2014/wp-content/uploads/2014/07/Lambda-Architecture-Jim-Scott..pdf" rel="noopener ugc nofollow" target="_blank"> lambda架构</a> <strong class="ig hi"> </strong>用于批处理/ETL和流工作负载。Spark和Storm都很好地使用了Kafka，并且它们的用例覆盖广泛:A/B测试、电子邮件定位、产品库存更新和监控仪表板。</p><h2 id="5d76" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ip ke kf kg it kh ki kj ix kk kl km kn bi translated">摘要</h2><p id="5c45" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip le ir is it lf iv iw ix lg iz ja jb ha bi translated">我们计划继续致力于Kafka core及其生态系统。该计划是将卡夫卡置于更多更具挑战性的制作场景中，只要问题可以用“流”的概念来建模和解决。</p><p id="0860" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请在Twitter上找到我:<a class="ae jc" href="https://twitter.com/NingZhang6" rel="noopener ugc nofollow" target="_blank"> @NingZhang6 </a></p></div></div>    
</body>
</html>