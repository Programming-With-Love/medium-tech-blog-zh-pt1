<html>
<head>
<title>Effective architecture for Multiplatform native development in Kotlin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kotlin中多平台本机开发的有效架构</h1>
<blockquote>原文：<a href="https://blog.kotlin-academy.com/architecture-for-multiplatform-development-in-kotlin-cc770f4abdfd?source=collection_archive---------0-----------------------#2017-12-11">https://blog.kotlin-academy.com/architecture-for-multiplatform-development-in-kotlin-cc770f4abdfd?source=collection_archive---------0-----------------------#2017-12-11</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="a94f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我的导师经常说“如果你在一个项目中使用Ctrl-C Ctrl-V，你就做错了”。这句话深深地打动了我，开始了我寻找越来越好的代码重用性的故事。今天我真的很自豪。在过去的几周里，我一直致力于一个伟大的想法，这个想法在本地开发中引入了一个新层次的可重用性。现在我已经准备好展示结果、想法和背后的架构。享受:)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4ef898e999c5a9a20c710cae9d602602.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qZfgAQ8us1w9z3Z9."/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="https://kt.academy/workshop"><div class="gh gi ku"><img src="../Images/3a56ace9079f060f9ee79ad3ed6b6756.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HxsEmnZGeKgLuGPFgNaLzA.png"/></div></a></figure><h1 id="88c7" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">演示</h1><p id="bb8f" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">让我们从<a class="ae ly" href="https://github.com/MarcinMoskala/KotlinAcademyApp" rel="noopener ugc nofollow" target="_blank">示例应用程序</a>的演示开始。</p><p id="5997" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是卡帕头。学院原生安卓应用:(<a class="ae ly" href="https://play.google.com/store/apps/details?id=org.kotlinacademy.mobile" rel="noopener ugc nofollow" target="_blank"> Google Play </a>)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/d62da3ea956a964beebeb18f351b5e5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:736/1*FLfFp81mxH1UsjIrtt_4_w.gif"/></div></figure><p id="f15e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是卡帕头。用React写的学院网站:(<a class="ae ly" href="https://kotlin-academy.herokuapp.com/#/" rel="noopener ugc nofollow" target="_blank">链接</a>)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ma"><img src="../Images/0afb80f3b9cce100ce2b29b9dccaaa3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*UzwbChSUMAi8yFpP8bqFWA.gif"/></div></div></figure><p id="e894" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是<a class="ae ly" href="https://twitter.com/edvinsyse" rel="noopener ugc nofollow" target="_blank"> Edvin Syse </a>在<a class="ae ly" href="https://github.com/edvin/tornadofx" rel="noopener ugc nofollow" target="_blank">torrofax</a>中写的桌面应用:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/daf461bd0c1c2d8f252a7d680f115f82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*cqvbdgANqLym_uWOyf6tww.gif"/></div></figure><p id="ec06" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是Android手表应用程序:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/27e1f38af364b6e75795c626f117d88a.png" data-original-src="https://miro.medium.com/v2/resize:fit:560/1*DOG76eoQ01xhll19_W9jRw.gif"/></div></figure><p id="1c8e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">很快还会有<strong class="jm io">火狐插件</strong>、<strong class="jm io"> Chrome插件</strong>和<strong class="jm io"> iOS </strong>客户端(如果你不信，那就去看看<a class="ae ly" rel="noopener ugc nofollow" target="_blank" href="/multiplatform-native-development-in-kotlin-now-with-ios-a8546f436eec?gi=11c0e748f8dc">这篇文章</a>或者<a class="ae ly" href="https://github.com/jetbrains/kotlinconf-app" rel="noopener ugc nofollow" target="_blank">这个资源库</a>)。</p><p id="6a6a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">尽管这些应用程序是在不同的框架中为不同的平台编写的，但它们都具有相同的行为。这种行为的单独实现对于创建、维护和单元测试来说是巨大的时间浪费。幸运的是，<strong class="jm io">在它们之间共享的单个模块中实现一次。</strong></p><h1 id="da9a" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">科特林</h1><p id="e66a" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">完全公开:整个项目是用Kotlin写的。它是由JetBrains开发的开源语言。Kotlin是一种具有相同语法和stdlib的单一语言，目前可用于4种不同的变体:</p><ul class=""><li id="67f4" class="md me in jm b jn jo jr js jv mf jz mg kd mh kh mi mj mk ml bi translated">Kotlin/JVM编译成JVM字节码(或者<a class="ae ly" href="https://forensics.spreitzenbarth.de/2012/08/27/comparison-of-dalvik-and-java-bytecode/" rel="noopener ugc nofollow" target="_blank"> DVM字节码</a>)。它与Java完全互操作:我们实际上可以将Java项目中的单个文件从Java更改为Kotlin，一切都会运行良好。这就是Kotlin在Android开发中迅速流行的原因。它甚至被Google视为Android的第一类语言。</li><li id="a03a" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated">Kotlin/JS编译成JavaScript。它还与JavaScript高度互操作。在Kotlin中实现React项目变得越来越流行。</li><li id="7dfe" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated">Kotlin/Native编译成原生字节码。它可以用来实现iOS应用程序。Kotlin/Native仍处于早期测试阶段，但JetBrains已经展示了用它编写的不同项目(查看Kotlin/Native中的<a class="ae ly" href="https://github.com/JetBrains/kotlin-native" rel="noopener ugc nofollow" target="_blank">示例</a>、<a class="ae ly" href="https://github.com/jetbrains/kotlinconf-app" rel="noopener ugc nofollow" target="_blank"> iOS应用</a>或<a class="ae ly" href="https://github.com/jetbrains/kotlinconf-spinner" rel="noopener ugc nofollow" target="_blank"> iOS和Android应用</a>)。</li><li id="38da" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated">普通科特林模是一种特殊的模。它不依赖于任何平台，但由于特殊的机制，它可以使用平台特定的类型和功能(这些类型需要在<em class="mr">平台模块</em>中为每个平台定义，以用于那个<em class="mr">公共模块</em>)。这种类型称为<em class="mr">预期声明</em>，它们的平台相关声明称为<em class="mr">实际声明</em>。<a class="ae ly" href="https://kotlinlang.org/docs/reference/multiplatform.html" rel="noopener ugc nofollow" target="_blank">在这里</a>你可以找到更多关于<em class="mr">通用</em>和<em class="mr">平台模块</em>的信息。</li></ul><p id="4ed2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用这些组件，我们可以创建一个真正的多平台项目。我们可以在Kotlin中实现所有客户端:Android mobile、Android Watch、Kotlin/JVM中的桌面；Kotlin/JS中的web、Firefox插件、Chrome插件；Kotlin/Native的iOS和Apple Watch。在一个项目和一种语言中包含所有内容是很好的。此外，使用普通和简单的Kotlin模块，我们还可以引入将改进这个项目并使其更容易实现的架构。</p><h1 id="d431" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">想法</h1><p id="3334" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">假设我们需要在web、Android和桌面上创建具有后端和客户端多平台项目(当iOS的多平台支持更加成熟时，我们将添加iOS)。</p><p id="47f0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了保持代码的组织性、可重用性和可测试性，这个项目的每个部分都需要有自己的架构。对于Android来说，最流行的架构是<a class="ae ly" href="https://medium.com/@marcinmoskala/mvc-vs-mvp-vs-mvvm-vs-mvi-ce72907d330" rel="noopener"> MVP </a>。以一种简化的方式，它将以下层分开:</p><ul class=""><li id="4adb" class="md me in jm b jn jo jr js jv mf jz mg kd mh kh mi mj mk ml bi translated"><em class="mr">演示者</em> —实现业务逻辑的实例(应用程序如何运行)。</li><li id="278e" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated"><em class="mr">视图</em>—<em class="mr">视图</em>是一个被动界面，它显示数据并将用户交互发送给演示者。它包括实现表示逻辑(应用程序看起来是什么样子)的难以单元测试的元素。</li><li id="26cd" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated"><em class="mr">模型— </em>它通常被定义为一个界面，该界面定义了要在用户界面中显示或以其他方式操作的数据。</li></ul><p id="7fe6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">虽然MVP定义中的<em class="mr">模型</em>远未得到很好的定义，但在Android中，有一种通用的方法来定义以下两种类型的元素:</p><ul class=""><li id="aa51" class="md me in jm b jn jo jr js jv mf jz mg kd mh kh mi mj mk ml bi translated">数据模型——代表我们在应用程序中使用的数据结构的对象。</li><li id="856b" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated">存储库——演示者和用例用来与数据库、网络等进行通信的对象。</li></ul><p id="2896" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们还将提取一些具体的业务逻辑规则到具有单一职责的更小的类中，我们将称之为<em class="mr">用例</em>。尽管在我们的结构中，它们将与<em class="mr">主持人</em>一起出现，因为它们扮演类似的角色，并且它们总是被主持人使用(除了<code class="fe ms mt mu mv b">backend</code>以外的任何地方)。</p><p id="0a7a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="mr">业务逻辑(演示者</em>和<em class="mr">用例</em>)是我们应用程序最重要的部分，它<strong class="jm io">必须经过单元测试</strong>！虽然<em class="mr">演示者</em>需要与<em class="mr">视图</em>和<em class="mr">存储库</em>进行交互，但它应该在接口后面与它们进行交互。考虑到这一点，我们可以在下图中展示该体系结构的所有元素:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mw"><img src="../Images/9dfbd98bf9a521ba71a866b4c13eec34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lmb9twmYOyt__Pwq_hty7Q.png"/></div></div></figure><p id="633f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">需要注意的重要一点是，所有客户端都可以具有相同的结构:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mx"><img src="../Images/792121825c886c50fc3610e0c79007c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1dSEKY-k4dp-mylICozTTw.png"/></div></div></figure><p id="0133" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe ms mt mu mv b">backend</code>也有它的层次。我们使用以下架构:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi my"><img src="../Images/332b02af94a014898744925d476c9392.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*yxu-ERpgLwREjTEcFH_LJQ.png"/></div></figure><p id="1317" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">请注意，上面介绍的所有架构都有一个共同的元素— <em class="mr">数据模型</em>。所有这些都是相似或相同的模型，重新实现是对时间和精力的巨大浪费！这就是为什么它应该被提取到单个模块中:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/f24639c39eb070f44dbc5404321b89b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZPRxMNTfnN-1C04cFASYJg.png"/></div></div></figure><p id="6421" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">除了<em class="mr">数据模型</em>，<code class="fe ms mt mu mv b">common</code>还可以包括所有其他模块需要的其他元素。我们是否需要<code class="fe ms mt mu mv b">sha1</code>函数计算hash来提高API安全性？我们可以将其放置在<em class="mr">公共模块</em> <code class="fe ms mt mu mv b">common</code>中，并在<code class="fe ms mt mu mv b">backend</code>和所有客户端中使用相同的功能。</p><p id="cbb9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">事实上，我们经常希望在数据模型中使用特定于平台的类型。在<a class="ae ly" href="https://github.com/MarcinMoskala/KotlinAcademyApp" rel="noopener ugc nofollow" target="_blank">示例项目</a>中，我定义了代表时间点的<code class="fe ms mt mu mv b">DateTime</code>类。在幕后，它使用Java <code class="fe ms mt mu mv b">Calendar</code>和Java Script <code class="fe ms mt mu mv b">Date</code>。为了允许它，我们需要为<code class="fe ms mt mu mv b">DateTime</code>定义预期的声明。然后我们需要用实际声明定义<em class="mr">平台模块</em>:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/e5922941eaf7159d46f44daa0756049d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bXE4A5b3Dq5XDU_XsJcCEw.png"/></div></div></figure><p id="c68e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">客户机之间共享的、等待提取的更大的代码片段是客户机的表示逻辑。所有的客户都扮演相同的角色，所以他们应该共享<em class="mr">演示者</em>和<em class="mr">用例</em>！我们可以将它们全部提取到<code class="fe ms mt mu mv b">common-client</code>模块。我们应该和他们一起移动<em class="mr">存储库接口</em>和<em class="mr">视图接口</em>:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/e79bb19b7e07e29fca9f2ef2601c3b63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i_6vkKat2bBtjB44OM7jjA.png"/></div></div></figure><p id="f44d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">那么<em class="mr">库</em>呢？它们目前在客户端模块中定义，我们必须通过构造函数将它们传递给<em class="mr">呈现者</em>。相反，我们可以将它们移动到<em class="mr">平台模块</em>，然后我们将能够:</p><ul class=""><li id="524c" class="md me in jm b jn jo jr js jv mf jz mg kd mh kh mi mj mk ml bi translated">在<code class="fe ms mt mu mv b">common-client</code>模块中实现依赖注入</li><li id="b2bf" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated">为所有平台重用存储库</li></ul><p id="aa12" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这个<em class="mr">平台模块</em>将总是包括其他元素，比如需要依赖于平台的客户端类型。这是我们的架构在这次改变后的样子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/48b669f9005be2b19783d7c1fc26a3ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lc9lenXiTHL9mYTKux9GHw.png"/></div></div></figure><p id="f822" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是这个项目的结构外观。</p><h1 id="d614" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">Android通用模块</h1><p id="ed54" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">假设我们需要在应用程序中添加Android Watch客户端。这就产生了一种情况，即提取包含共享元素的Android公共模块是合理的，如:</p><ul class=""><li id="e0ba" class="md me in jm b jn jo jr js jv mf jz mg kd mh kh mi mj mk ml bi translated">资源(图像、文本、颜色)</li><li id="7526" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated">Android助手功能，如视图绑定助手，回收视图类等。</li></ul><p id="b1bb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">该模块是对我们多平台架构的合理补充:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/38c8802642976b789221ac5066b66397.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*udKL2WXIuO4lO48JpIOqXA.png"/></div></div></figure><h1 id="ea28" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">大型多平台项目</h1><p id="ff26" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">上述结构呈现了<a class="ae ly" href="https://github.com/MarcinMoskala/KotlinAcademyApp" rel="noopener ugc nofollow" target="_blank">的当前状态，示例</a>实现了4个不同的客户端。尽管示例项目的目标是成为一个大型的多平台项目，但是这个任务还远远没有完成。我们希望包括尽可能多的客户！目前的计划包括iOS应用、Firefox插件、Chrome插件、Android TV、Android Car和Apple Watch。如果你有更多的想法，或者如果你想通过结识这样的客户来尝试自己，那就感到受欢迎(<a class="ae ly" href="https://github.com/MarcinMoskala/KotlinAcademyApp" rel="noopener ugc nofollow" target="_blank">投稿</a>或<a class="ae ly" href="mailto:marcinmoskala@gmail.com" rel="noopener ugc nofollow" target="_blank">联系我</a>)。我们享受每一份贡献。这个大型多平台项目的架构看起来更像这样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/bb3feb3a7e46535af45c19196936e5f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jW3HSFNqNZb8i0pRaERtbQ.png"/></div></div></figure><h1 id="961e" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">体系结构</h1><p id="d68b" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">由于这种架构，我们不仅获得了巨大的代码可重用性，而且每样东西都有自己的位置。它包含以下模块:</p><ul class=""><li id="4cf3" class="md me in jm b jn jo jr js jv mf jz mg kd mh kh mi mj mk ml bi translated"><code class="fe ms mt mu mv b">common</code> —包含所有其他模块共享的元素。一般是<em class="mr">数据模型</em>和辅助函数。这个模块也可能包含其他元素，如果它们在客户端和后端都使用的话。</li><li id="0999" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated"><code class="fe ms mt mu mv b">common-js</code>和<code class="fe ms mt mu mv b">common-jvm</code> —包含<code class="fe ms mt mu mv b">common</code>模块的所有平台特定类型。</li><li id="bd37" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated"><code class="fe ms mt mu mv b">common-client </code> —包含所有客户端的业务逻辑。一般放在<em class="mr">演示者</em>和<em class="mr">用例</em>中。</li><li id="0b3c" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated"><code class="fe ms mt mu mv b">common-client-js</code>和<code class="fe ms mt mu mv b">common-client-jvm </code> —包含<code class="fe ms mt mu mv b">common-client</code>的平台特定部分。在这个实现中，我决定将客户端存储库放在那里，因为我们希望将它们注入到<em class="mr">演示者</em>中，并且它们是特定于平台的(相同的Java网络库可以在Android和桌面上使用)。</li><li id="227f" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated"><code class="fe ms mt mu mv b">web</code>、<code class="fe ms mt mu mv b">desktop</code>和其他客户端模块—包含每个客户端的视图。该视图实现了来自<code class="fe ms mt mu mv b">common-client</code>的视图接口，并将事件传递给<em class="mr">演示者</em>。</li><li id="d0ce" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated"><code class="fe ms mt mu mv b">backend</code> —包含后端实现。</li><li id="e4f7" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated"><code class="fe ms mt mu mv b">android</code>和其他为单一平台构建的客户端通用模块—包含共享元素，如资源或助手功能。</li></ul><p id="c63d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有了这个架构，我们可以达到代码重用的顶峰。由于这一点，我们不必为每个客户分别实现<em class="mr">业务逻辑</em>。同样，业务逻辑中的<em class="mr">变化也可以在单个地方应用。当我们检查某个业务逻辑在一个客户机中工作时，我们可以确定它在所有其他客户机中也工作。这样，不仅简化了手动测试，而且对于<code class="fe ms mt mu mv b">common-client</code>模块，单元测试现在只需执行一次。</em></p><p id="3b03" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">理论足够了，让我们看看一些代码，并在实践中讨论这个不同模块的关键元素。因为这篇文章已经够长了，所以不会进行深入的分析。我们将在下一篇文章中对不同方面进行更深入的分析。它们将在下周一陆续在Kt播出。学院。但是，这篇文章应该给出足够的解释，以开始你自己的项目或对<a class="ae ly" href="https://github.com/MarcinMoskala/KotlinAcademyApp" rel="noopener ugc nofollow" target="_blank">示例项目</a>(感觉受欢迎；)).</p><h1 id="8132" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">公共模块</h1><p id="e8bb" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated"><code class="fe ms mt mu mv b">common</code>模块包括以下Kotlin文件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/fe9cbe2c9d42408fb1c88676ad257b45.png" data-original-src="https://miro.medium.com/v2/resize:fit:496/format:webp/1*KSuiTzYUb7NaoEbHrJIKlQ.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">common module source set</figcaption></figure><p id="8406" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="mr">子包<code class="fe ms mt mu mv b">data</code>中的数据模型</em>包括以下类:</p><ul class=""><li id="9d2b" class="md me in jm b jn jo jr js jv mf jz mg kd mh kh mi mj mk ml bi translated">表示项目中使用的数据</li><li id="afa5" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated">表示API DTO(通过API传递的对象模型)</li></ul><p id="0a81" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">例如，这是一个<code class="fe ms mt mu mv b">News</code>类:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/6a4589cf0d023b5b73ebcbeefe0ff638.png" data-original-src="https://miro.medium.com/v2/resize:fit:966/format:webp/1*FRL94sV9fnKrh4Sb3jF_5A.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">News class in common module</figcaption></figure><p id="10f4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你注意到注释了吗？就是<a class="ae ly" href="https://github.com/Kotlin/kotlinx.serialization" rel="noopener ugc nofollow" target="_blank"> kotlinx.serialization </a>注解。我们需要它来反序列化Kotlin/JS中的对象。<code class="fe ms mt mu mv b">News</code>的列表通过封装在<code class="fe ms mt mu mv b">NewsData</code>类中的API传递:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/5887f9acab4afb247ed94425f9c78ab0.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/1*CBIdERS_X3cO7GpzVIQprw.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">NewsData class in common module</figcaption></figure><p id="3f81" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">背后的原因可以在这里找到<a class="ae ly" href="https://youtrack.jetbrains.com/issue/KT-21341" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="6176" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">另一件需要注意的事情是，<code class="fe ms mt mu mv b">News</code>包含了类型为<code class="fe ms mt mu mv b">DateTime</code>的参数。这是一个表示时间点的类。使用<em class="mr">预期声明</em>在<code class="fe ms mt mu mv b">common</code>模块中定义:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/b0a44b62cfb120cde7ab30f6115b07ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:856/format:webp/1*QZZB5OwcU0ixNGvmKvoNTw.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">DateTime expected declaration in common module</figcaption></figure><p id="200a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">它的声明是极简的，因为我们目前不需要更多。我们用它来订购客户的新闻。这也是它实现<code class="fe ms mt mu mv b">Comparable&lt;DateTime&gt;</code>接口的原因。序列化需要使用方法<code class="fe ms mt mu mv b">toDateFormatString</code>和扩展函数<code class="fe ms mt mu mv b">parseDate</code>。<code class="fe ms mt mu mv b">DATE_FORMAT</code>规定API的格式。其<em class="mr">实际声明</em>定义为<code class="fe ms mt mu mv b">common-js</code>和<code class="fe ms mt mu mv b">common-jvm</code>:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/ff960eda376dbae891e73aba608f82fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wILpaXY9zl88kCfYuAt9dw.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">DateTimeJs in <code class="fe ms mt mu mv b">common-js</code></figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/7f740d0da4f649f40030c8bd404138c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dEQRiiRuMzP6Dw7PNWo7Bw.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">DateTimeJVM in common-jvm</figcaption></figure><p id="8889" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe ms mt mu mv b">DateTime</code>是自定义类型，因此我们需要为它指定序列化，以便能够通过API传递<code class="fe ms mt mu mv b">News</code>。所有的Kotlin/JVM项目都在使用<a class="ae ly" href="https://github.com/google/gson" rel="noopener ugc nofollow" target="_blank"> Gson </a>来序列化和反序列化对象，所以我们可以在<code class="fe ms mt mu mv b">common-jvm</code>中定义<code class="fe ms mt mu mv b">Gson</code>实例。我们需要为那里的<code class="fe ms mt mu mv b">DateTime</code>类添加转换器:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/9d93329d93722502d854e574079be990.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*gRDCpaoX6hRRIxqq1lanhw.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk"><a class="ae ly" href="https://github.com/google/gson" rel="noopener ugc nofollow" target="_blank">Gson</a> instance defines in common-jvm</figcaption></figure><p id="424b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">注意<code class="fe ms mt mu mv b">backend</code>和<code class="fe ms mt mu mv b">common-client-jvm</code>都依赖于<code class="fe ms mt mu mv b">common-jvm</code>，所以我们可以在两者中都使用<code class="fe ms mt mu mv b">gson</code>。</p><p id="4e48" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">类似地，在<code class="fe ms mt mu mv b">common-js</code>中，我们定义了用于序列化和反序列化JSON的<a class="ae ly" href="https://github.com/Kotlin/kotlinx.serialization" rel="noopener ugc nofollow" target="_blank">kotlinx . serialization</a>JSON实例，我们用<code class="fe ms mt mu mv b">DateTime</code>序列化器来定义它:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/46ab6218f8d198817e512ff499cefdce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*ByIgb7iJb2LyP924SNELiA.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk"><a class="ae ly" href="https://github.com/Kotlin/kotlinx.serialization" rel="noopener ugc nofollow" target="_blank">kotlinx.serialization</a> JSON instance defined in common-js</figcaption></figure><p id="ecbd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们可以通过API传递<code class="fe ms mt mu mv b">News</code>,它可以在客户端被正确地反序列化。</p><p id="a269" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以在<code class="fe ms mt mu mv b">common</code>模块中找到的另一件事是带有端点部分名称的属性:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/c18ca312aa4aa280389fb29f826fe86b.png" data-original-src="https://miro.medium.com/v2/resize:fit:866/format:webp/1*PXVAktAG-Sktk2MqYOKuWw.png"/></div></figure><p id="eb00" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当它们是在一个地方定义的，那么在需要改变的情况下，我们就不必去寻找所有引用它们的地方。我们可以只改变单个属性的值。</p><h1 id="935b" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">公共客户端模块</h1><p id="0f68" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated"><code class="fe ms mt mu mv b">common-client</code>模块包括<em class="mr">演示者</em>和<em class="mr">带有客户业务逻辑的用例</em>。让我们简单描述一下其中一个<em class="mr">演示者</em>来了解它是如何工作的。我们将描述控制显示新闻的视图的<code class="fe ms mt mu mv b">NewsPresenter</code>。其业务逻辑规则如下:</p><ul class=""><li id="7c87" class="md me in jm b jn jo jr js jv mf jz mg kd mh kh mi mj mk ml bi translated">创建视图后，它加载并显示新闻列表。在新闻加载过程中，会显示加载器。</li><li id="c6fa" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated">当用户请求刷新时，加载新闻。在刷新期间，显示刷新指示器。</li><li id="ea00" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated">新闻每60秒悄悄刷新一次。</li><li id="bcdb" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated">新闻按发生的降序显示。</li><li id="f4cd" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated">当任何新闻加载返回错误时，它被显示。</li></ul><p id="f732" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这就是我们如何表示由这个<em class="mr">演示者</em>控制的<em class="mr">视图</em>:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/b9f615ca3e2ea3454cbfcc842e9f5608.png" data-original-src="https://miro.medium.com/v2/resize:fit:632/format:webp/1*qgA2Bp_B11sL1feElrObpw.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">NewsView in common-client</figcaption></figure><p id="f6aa" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe ms mt mu mv b">BaseView</code>还指定了显示和记录错误的方法:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/f3a32d0be890d92d92cf66c1c2e57a07.png" data-original-src="https://miro.medium.com/v2/resize:fit:642/format:webp/1*iH1LWc0AVrj8wjosHtY7Xg.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">BaseView in common-client</figcaption></figure><p id="6c95" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下面是<em class="mr">演示者</em>的实现:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/971b920d592f0a6ed741fd105b54d6df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oahjtbEoUkusggvERKxIIQ.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">NewsPresenter in common-client</figcaption></figure><h2 id="3d66" class="nv kw in bd kx nw nx dn lb ny nz dp lf jv oa ob lj jz oc od ln kd oe of lr og bi translated">演示者生命周期</h2><p id="9f5d" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated"><code class="fe ms mt mu mv b">NewsPresenter</code>扩展了<code class="fe ms mt mu mv b"> BasePresenter</code>类，该类负责在<em class="mr"> presenter </em>销毁期间取消所有已启动的作业(以防止数据泄露)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/c5e7399e8d3443c2e9d05d95deac0d4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/format:webp/1*V2FfLvjYa93-xyE85L3Aug.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">BasePresenter in common-client</figcaption></figure><p id="4e98" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">它还实现了指定基本<em class="mr">演示者</em>生命周期方法的<code class="fe ms mt mu mv b">Presenter</code>接口:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/c732fd712659f0bbea186af72f9f16c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:408/format:webp/1*mB-f7wUHGxsjufyCq6RJVg.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">Presenter in common-client</figcaption></figure><p id="d37a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="mr">视图</em>在视图创建和销毁过程中需要调用这个方法。我们将在后面看到如何确保它适用于Android。</p><h2 id="c112" class="nv kw in bd kx nw nx dn lb ny nz dp lf jv oa ob lj jz oc od ln kd oe of lr og bi translated">演示者中的Kotlin协同程序</h2><p id="15b1" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated"><em class="mr">演示者</em>正在使用Kotlin协同程序进行并发。在<em class="mr">公共模块</em>中还不支持协程，所以我们必须用我们需要的方法指定预期的声明:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/5fe2b4b0f2fb64af1c4be4865c617be8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1082/format:webp/1*bs6zfurydv9VM9E4gr8Urg.png"/></div></figure><p id="c1e5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这就是<em class="mr">实际声明</em>在<code class="fe ms mt mu mv b">common-client-jvm</code>中的实现方式:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/85f2026f8a5921439af68f2a436d2faa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*yv_yHye5WvV6uADdsp-YKw.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">Expected declarations from common-client-jvm for actual declarations in common-client coroutines functions</figcaption></figure><h2 id="60a2" class="nv kw in bd kx nw nx dn lb ny nz dp lf jv oa ob lj jz oc od ln kd oe of lr og bi translated">依赖注入的轻量级替代方案</h2><p id="83d5" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated"><code class="fe ms mt mu mv b">NewsPresenter</code>使用<code class="fe ms mt mu mv b">NewsRepository</code>和<code class="fe ms mt mu mv b">PeriodicCaller</code>。它们都是使用依赖注入的轻量级替代方案提供的。它使用以下类别:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/9e8f614621de87b6a4cf4be256c4486d.png" data-original-src="https://miro.medium.com/v2/resize:fit:826/format:webp/1*XfNnvBAIJgB6Se1PRWib_g.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">Provider class used as a lightweight alternative to dependency injection. Defined in common module because used both in backend and in common-client.</figcaption></figure><p id="e6f1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当我们有一个我们想要注入的类时，我们需要使它的<em class="mr">伴随对象</em>扩展<code class="fe ms mt mu mv b">Provider</code>，并且我们覆盖<code class="fe ms mt mu mv b">create</code>方法:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/ac457db5d35f5b203ba318c9f7dd389b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z01I6FB9UmGqaT9JZEIqmQ.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">PeriodicCaller class defined in common-client module</figcaption></figure><p id="b8eb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这之后，我们可以使用以下方法轻松获得实例:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi on"><img src="../Images/e496bef722f66c60e0ae66c4a210cb8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:836/format:webp/1*PQdzZ6yWAElGazBd-ghj1g.png"/></div></figure><p id="a4f3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">出于单元测试的目的，我们也可以很容易地覆盖这个实例(查看<a class="ae ly" href="https://github.com/MarcinMoskala/KotlinAcademyApp/tree/master/android/mobile/src/test/java/org/kotlinacademy" rel="noopener ugc nofollow" target="_blank">单元测试</a>)。</p><p id="7f71" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe ms mt mu mv b">NewsRepository</code>是公共客户端中定义的接口:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/a0a2284d43f78fcf3a2b6a71afd90976.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FrGQvjceE4cTO9khVIy4Dw.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">NewsRepository class defined in common-client module</figcaption></figure><h2 id="063f" class="nv kw in bd kx nw nx dn lb ny nz dp lf jv oa ob lj jz oc od ln kd oe of lr og bi translated">存储库实现</h2><p id="d8a4" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">新闻存储库实现需要使用目前无法在<em class="mr">公共模块</em>中定义的网络库。所有的客户端仓库都在<em class="mr">平台模块</em> <code class="fe ms mt mu mv b">common-client-js</code>和<code class="fe ms mt mu mv b">common-client-jvm</code>中指定，我们使用<code class="fe ms mt mu mv b">RepositoriesProvider</code> <em class="mr">预期声明</em>提供:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi op"><img src="../Images/8ed52f165aa06d3fbca37de163f0b7bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*MtyvyRauBmGxQYW5WdsX6g.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">ReporitoriesProvider in common-client</figcaption></figure><p id="8cde" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">从<code class="fe ms mt mu mv b">common-client-jvm</code>开始<code class="fe ms mt mu mv b">NewsRepository</code>的实际申报和实施:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/f518a31120c27cb437015cd150daeab4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*qL6z7Co805dzF2oTwDu-tw.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">ReposirotyProvider from common-client-jvm</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi or"><img src="../Images/282a1f80b9066c5bbcd5ff79ff0da661.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*lQ4uXuQDGO-H2R1ruYSY7A.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">Implementation of NewsRepository defined in common-client-jvm</figcaption></figure><p id="c223" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这就是我们理解<code class="fe ms mt mu mv b">NewsPresenter</code>如何工作所需要的一切。它的行为也可以从单元测试的角度来看(它的单元测试可以在<a class="ae ly" href="https://github.com/MarcinMoskala/KotlinAcademyApp/blob/master/android/mobile/src/test/java/org/kotlinacademy/NewsPresenterUnitTest.kt" rel="noopener ugc nofollow" target="_blank">这里</a>找到，很快我将发表只关注单元测试<em class="mr">公共模块</em>的文章)。为了真正理解演示者，我们需要看到他们在客户端中的使用，所以让我们看看<code class="fe ms mt mu mv b">NewsPresenter</code>是如何在Android和web客户端中使用的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="https://leanpub.com/effectivekotlin/c/3YYtCtqCC6a4"><div class="gh gi os"><img src="../Images/0742a8ad0cfd3851db2d28061bf6f214.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xbef0K0JtDZ6F2vBVUDZsg.jpeg"/></div></a></figure><h1 id="7ec9" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">客户</h1><p id="fed0" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">不同客户如何使用<em class="mr">的详细描述主持人</em>将在关于特定客户的文章中介绍(我们将在下周的周一发表这篇文章)。现在，让我们讨论简化的<code class="fe ms mt mu mv b">NewsActivity</code>(下面的实现只包含连接到presenter的元素)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/771a346353a95c8dccda140ed7bfdeb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1306/format:webp/1*ml3pYQ_jQzlBfByo4hrFAA.png"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">Simplified version of Android NewsActivity. You can find full class <a class="ae ly" href="https://github.com/MarcinMoskala/KotlinAcademyApp/blob/master/android/mobile/src/main/java/org/kotlinacademy/view/news/NewsActivity.kt" rel="noopener ugc nofollow" target="_blank">here</a>.</figcaption></figure><p id="39c7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Activity实现了<code class="fe ms mt mu mv b">NewsView</code>接口，并覆盖了它的所有成员。<code class="fe ms mt mu mv b">loading</code>绑定到<code class="fe ms mt mu mv b">ProgressView</code>可见性，刷新绑定到列表的刷屏刷新。可以使用<a class="ae ly" href="https://github.com/MarcinMoskala/KotlinAndroidViewBindings" rel="noopener ugc nofollow" target="_blank">kotlinandroidviewindings</a>库。<code class="fe ms mt mu mv b">showList</code>将新闻映射到适配器中，并在列表中显示它们。我们不需要显式调用<em class="mr"> presenter </em>生命周期方法，因为它们在<code class="fe ms mt mu mv b">BaseActivity</code>中被调用:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/0fe70414b25341c0ff058c6797b14795.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7hs0BfafwSIYzja1xny3wg.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">BaseActivity in Android</figcaption></figure><p id="098f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe ms mt mu mv b">BaseActivity</code>也实现了<code class="fe ms mt mu mv b">BaseView</code>并覆盖了它的方法，这是因为我们不必在每个活动中定义<code class="fe ms mt mu mv b">showError</code>和<code class="fe ms mt mu mv b">logError</code>。更多关于Android实现和其他支持多平台Kotlin项目的技巧，我将在另一篇关于Android的文章中描述。</p><p id="75f7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在<code class="fe ms mt mu mv b">web</code>模块中应用了类似的方法，尽管React的工作方式与Android完全不同:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi gj"><img src="../Images/0fc9ffa1082e15c33955f7c7fc1374d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Zj8HLDUlwE0EeHH26Ja6A.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">NewsComponent in web</figcaption></figure><p id="3f96" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您可以查看存储库示例，或者等待关于这一部分的文章。</p><h1 id="f153" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">后续步骤</h1><p id="804c" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">正如我已经提到的，在这个示例项目背后还有很多计划:</p><ul class=""><li id="1e20" class="md me in jm b jn jo jr js jv mf jz mg kd mh kh mi mj mk ml bi translated">我们想让它大规模多平台化，并实现尽可能多的不同的原生客户端</li><li id="1889" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated">并非项目中的所有内容都已完成(查看项目中的todo注释)</li></ul><p id="47b0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">还有一些目前难以实现的改进，但我们希望有这些改进，因为它们可能对其他多平台Kotlin项目非常有帮助:</p><ul class=""><li id="6349" class="md me in jm b jn jo jr js jv mf jz mg kd mh kh mi mj mk ml bi translated">网络API应该为<code class="fe ms mt mu mv b">backend</code>和所有平台库实现一次。为此，我们需要特殊的网络库来支持它。虽然有可能。我将在单独的文章中提出这个想法。</li><li id="7891" class="md me in jm b jn mm jr mn jv mo jz mp kd mq kh mi mj mk ml bi translated">可以提取像颜色或翻译这样的元素。这很难，因为在大多数平台中，有不同的机制来定义它们。目前，这可能是使用脚本或Gradle插件完成的。或者，如果所有视图都用Kotlin DSL实现(在这个项目中只有Android不是)，那么可能会引入一些机制来返回标签和特定语言的字符串。</li></ul><h1 id="f3be" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">与React Native或Flutter等其他解决方案相比，它的优势是什么？</h1><p id="51b8" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">这里最重要的一点是，我们实际上是在本地框架中创建本地应用程序。如果您查看这些不同的应用程序，您会很容易注意到它们的视图和行为方式是特定于平台的。在Android中，我们使用Android支持库中的<code class="fe ms mt mu mv b">CoordinatorLayout</code>。在web中，设计是现代网站的典型特征。在桌面，我们看到新的窗口。</p><p id="f5ef" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以利用每个平台的所有工具和优势。在Android中，有用于跟踪错误的碰撞算法。在网络上，有推特和脸书的分享按钮。在桌面上，我们在新窗口中显示评论。</p><p id="b57d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">应用程序是本地的，我们不依赖任何绑定或桥。我们可以做以前能做的一切，我们的多平台架构支持我们尽可能提高效率。</p></div><div class="ab cl ov ow hr ox" role="separator"><span class="oy bw bk oz pa pb"/><span class="oy bw bk oz pa pb"/><span class="oy bw bk oz pa"/></div><div class="ig ih ii ij ik"><p id="fd83" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下一篇文章:</p><div class="pc pd gp gr pe pf"><a rel="noopener  ugc nofollow" target="_blank" href="/images-sharing-in-gradle-multiprojects-aba5e6bc8b1a"><div class="pg ab fo"><div class="ph ab pi cl cj pj"><h2 class="bd io gy z fp pk fr fs pl fu fw im bi translated">梯度多项目中的图像共享</h2><div class="pm l"><h3 class="bd b gy z fp pk fr fs pl fu fw dk translated">Gradle多项目非常棒！我们可以用Android，后端，前端，以及我们需要的任何东西来制作单个项目…</h3></div><div class="pn l"><p class="bd b dl z fp pk fr fs pl fu fw dk translated">blog.kotlin-academy.com</p></div></div><div class="po l"><div class="pp l pq pr ps po pt ks pf"/></div></div></a></div><div class="pc pd gp gr pe pf"><a rel="noopener  ugc nofollow" target="_blank" href="/extracting-multiplatform-common-modules-in-android-4a564cc03e0a"><div class="pg ab fo"><div class="ph ab pi cl cj pj"><h2 class="bd io gy z fp pk fr fs pl fu fw im bi translated">Android中多平台通用模块的提取</h2><div class="pm l"><h3 class="bd b gy z fp pk fr fs pl fu fw dk translated">你知道如何制作Android项目，但现在你想让它们多平台化。你听说了新的可能性…</h3></div><div class="pn l"><p class="bd b dl z fp pk fr fs pl fu fw dk translated">blog.kotlin-academy.com</p></div></div><div class="po l"><div class="pu l pq pr ps po pt ks pf"/></div></div></a></div><div class="pc pd gp gr pe pf"><a rel="noopener  ugc nofollow" target="_blank" href="/shared-client-logic-in-multiplatform-kotlin-project-2509bc36ff51"><div class="pg ab fo"><div class="ph ab pi cl cj pj"><h2 class="bd io gy z fp pk fr fs pl fu fw im bi translated">多平台Kotlin项目中的共享客户端逻辑</h2><div class="pm l"><h3 class="bd b gy z fp pk fr fs pl fu fw dk translated">我们已经展示了多平台Kotlin项目的架构。它的核心思想是我们如何定义客户逻辑…</h3></div><div class="pn l"><p class="bd b dl z fp pk fr fs pl fu fw dk translated">blog.kotlin-academy.com</p></div></div><div class="po l"><div class="pv l pq pr ps po pt ks pf"/></div></div></a></div><div class="pc pd gp gr pe pf"><a rel="noopener  ugc nofollow" target="_blank" href="/testing-common-modules-66b39d641617"><div class="pg ab fo"><div class="ph ab pi cl cj pj"><h2 class="bd io gy z fp pk fr fs pl fu fw im bi translated">测试通用模块</h2><div class="pm l"><h3 class="bd b gy z fp pk fr fs pl fu fw dk translated">在具有良好架构的Kotlin多平台项目中，我们在公共-客户端公共模块中拥有完整的业务逻辑…</h3></div><div class="pn l"><p class="bd b dl z fp pk fr fs pl fu fw dk translated">blog.kotlin-academy.com</p></div></div><div class="po l"><div class="pw l pq pr ps po pt ks pf"/></div></div></a></div></div><div class="ab cl ov ow hr ox" role="separator"><span class="oy bw bk oz pa pb"/><span class="oy bw bk oz pa pb"/><span class="oy bw bk oz pa"/></div><div class="ig ih ii ij ik"><h2 id="0a3a" class="nv kw in bd kx nw nx dn lb ny nz dp lf jv oa ob lj jz oc od ln kd oe of lr og bi translated">学到了什么？单击👏说“谢谢！”并帮助他人找到这篇文章。</h2><p id="48bb" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">如果你认为这很重要，与他人分享。</p><p id="a4d0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你需要Kotlin工作室吗？请访问我们的网站,看看我们能为您做些什么。</p><p id="b392" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要在Twitter上提到我，请使用<a class="ae ly" href="https://twitter.com/marcinmoskala" rel="noopener ugc nofollow" target="_blank"> @marcinmoskala </a>。</p><p id="8e43" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我要感谢<a class="ae ly" href="https://twitter.com/edvinsyse" rel="noopener ugc nofollow" target="_blank"> Edvin Syse </a>对范例项目的重要贡献。也感谢Ilya Gorbunov对本文的重要更正。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="http://eepurl.com/diMmGv"><div class="gh gi ki"><img src="../Images/5ce68714efe3efc036e06786166954ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uDqv_d5NZnPUJA0FeZqhqQ.png"/></div></a></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ma"><img src="../Images/77f73b2843c7321d074810231e681255.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*oKagsKgwb58Hot8vtthl3g.gif"/></div></div></figure></div></div>    
</body>
</html>