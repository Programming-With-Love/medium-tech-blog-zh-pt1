<html>
<head>
<title>Extending Terraform OKE with a helm chart</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用舵图扩展地形图</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/extending-terraform-oke-with-a-helm-chart-a51ae0df29d4?source=collection_archive---------1-----------------------#2019-04-24">https://medium.com/oracledevs/extending-terraform-oke-with-a-helm-chart-a51ae0df29d4?source=collection_archive---------1-----------------------#2019-04-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="576b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在设计<a class="ae jc" href="https://github.com/oracle/sample-oke-for-terraform" rel="noopener ugc nofollow" target="_blank"> Terraform OKE </a>供应脚本时，我们想要做的事情之一就是使其可重用。这意味着扩展基本样例回购并添加您自己的扩展。</p><p id="5d81" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本帖中，我们将使用helm charts为OKE部署一个redis集群。Terraform有一个<a class="ae jc" href="https://www.terraform.io/docs/providers/helm/index.html" rel="noopener ugc nofollow" target="_blank">头盔供应商</a>，所以我们将使用它。</p><p id="53c9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先，像我们之前做的那样克隆回购:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="f96e" class="jm jn hh ji b fi jo jp l jq jr">git clone <a class="ae jc" href="https://github.com/oracle/sample-oke-for-terraform.git" rel="noopener ugc nofollow" target="_blank">https://github.com/oracle/sample-oke-for-terraform.git</a> tfoke<br/>cd tfoke</span></pre><p id="6710" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">按照<a class="ae jc" href="https://github.com/oracle/sample-oke-for-terraform/blob/master/docs/instructions.md" rel="noopener ugc nofollow" target="_blank">指令</a>创建你的地形变量文件。</p><h2 id="3bc0" class="jm jn hh bd js jt ju jv jw jx jy jz ka ip kb kc kd it ke kf kg ix kh ki kj kk bi translated">添加helm提供程序和存储库</h2><p id="f8ae" class="pw-post-body-paragraph ie if hh ig b ih kl ij ik il km in io ip kn ir is it ko iv iw ix kp iz ja jb ha bi translated">在oke模块中，创建一个文件redis.tf，首先我们需要配置helm provider。因为我们已经有了kubeconfig文件，所以我们将使用File Config方法。将以下内容添加到redis.tf:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="a153" class="jm jn hh ji b fi jo jp l jq jr">provider "helm" {<br/>    kubernetes {<br/>        config_path = "${path.root}/generated/kubeconfig"<br/>    }<br/>}</span></pre><p id="9115" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，我们将添加一个helm存储库:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="2304" class="jm jn hh ji b fi jo jp l jq jr">data "helm_repository" "stable" {<br/>    name = "stable"<br/>    url = "https://kubernetes-charts.storage.googleapis.com"<br/>}</span></pre><h2 id="8420" class="jm jn hh bd js jt ju jv jw jx jy jz ka ip kb kc kd it ke kf kg ix kh ki kj kk bi translated">使用舵释放添加redis</h2><p id="51a7" class="pw-post-body-paragraph ie if hh ig b ih kl ij ik il km in io ip kn ir is it ko iv iw ix kp iz ja jb ha bi translated">我们将使用<a class="ae jc" href="https://github.com/helm/charts/tree/master/stable/redis" rel="noopener ugc nofollow" target="_blank"> redis头盔图</a>创建一个头盔释放。但是，我们希望helm仅在工作节点变为活动状态后部署。在<a class="ae jc" href="https://github.com/oracle/sample-oke-for-terraform/blob/master/modules/oke/activeworker.tf" rel="noopener ugc nofollow" target="_blank">示例报告</a>中，有一个null _ resource“is _ worker _ active ”,您可以使用它来设置显式依赖关系。将以下内容添加到redis.tf中:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="b70c" class="jm jn hh ji b fi jo jp l jq jr">resource "helm_release" "redis" {</span><span id="cce5" class="jm jn hh ji b fi kq jp l jq jr">    depends_on = ["null_resource.is_worker_active",    "local_file.kube_config_file"]</span><span id="4ea0" class="jm jn hh ji b fi kq jp l jq jr">    provider = "helm"<br/>    name = "oke-redis"<br/>    repository = "${data.helm_repository.stable.metadata.0.name}"<br/>    chart = "redis"<br/>    version = "6.4.5"</span><span id="3c15" class="jm jn hh ji b fi kq jp l jq jr">    set {<br/>        name  = "cluster.enabled"<br/>        value = "true"<br/>    }</span><span id="efc3" class="jm jn hh ji b fi kq jp l jq jr">    set {<br/>        name = "cluster.slaveCount"<br/>        value = "3"<br/>    }<br/>   <br/>    set {<br/>        name = "master.persistence.size"<br/>        value = "50Gi"<br/>    }<br/>}</span></pre><p id="cce7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您更喜欢使用yaml文件自定义helm版本，请在oke模块下创建一个名为resources的文件夹，并将文件values.yaml从redis chart repo复制到redis_values.yaml:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="e118" class="jm jn hh ji b fi jo jp l jq jr">curl -o modules/oke/resources/redis_values.yaml https://raw.githubusercontent.com/helm/charts/master/stable/redis/values.yaml</span></pre><p id="4b71" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从terraform代码中删除redis版本中的单独设置，并添加以下内容:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="0290" class="jm jn hh ji b fi jo jp l jq jr">values = [<br/>   "${file("${path.module}/resources/redis_values.yaml")}"<br/>]</span></pre><p id="0a58" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您的发布应该如下所示:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="dd4e" class="jm jn hh ji b fi jo jp l jq jr">resource "helm_release" "redis" {</span><span id="6dd8" class="jm jn hh ji b fi kq jp l jq jr">  depends_on = ["null_resource.is_worker_active",    "local_file.kube_config_file"]</span><span id="0d51" class="jm jn hh ji b fi kq jp l jq jr">  provider = "helm"<br/>    name = "my-redis-release"<br/>    repository = "${data.helm_repository.stable.metadata.0.name}"<br/>    chart = "redis"<br/>    version = "6.4.5"</span><span id="4bfa" class="jm jn hh ji b fi kq jp l jq jr">  values = [<br/>    "${file("${path.module}/resources/redis_values.yaml")}"<br/>  ]<br/>}</span></pre><p id="9889" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，您也可以组合上述两种配置方法，但我更喜欢将我的方法放在一个位置。您可以更改yaml文件中的值，例如，我将默认的cluster.slaveCount更改为3，将persistence.size更改为50Gi。</p><p id="632b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">运行terraform init下载helm provider，然后再次应用:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="113b" class="jm jn hh ji b fi jo jp l jq jr">terraform init<br/>terraform apply -auto-approve</span></pre><p id="eeed" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">登录堡垒，做一个舵手列表:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="0721" class="jm jn hh ji b fi jo jp l jq jr">helm list</span><span id="0c3e" class="jm jn hh ji b fi kq jp l jq jr">NAME            REVISION        UPDATED                         STATUS          CHART           APP VERSION     NAMESPACE                        <br/>oke-redis       1               Wed Apr 24 12:05:40 2019        DEPLOYED        redis-6.4.5     4.0.14          default</span></pre><p id="a12e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，获取redis图表提供的注释:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="ebbe" class="jm jn hh ji b fi jo jp l jq jr">helm status</span></pre><h2 id="eb8d" class="jm jn hh bd js jt ju jv jw jx jy jz ka ip kb kc kd it ke kf kg ix kh ki kj kk bi translated">与Redis集群交互</h2><p id="b634" class="pw-post-body-paragraph ie if hh ig b ih kl ij ik il km in io ip kn ir is it ko iv iw ix kp iz ja jb ha bi translated">当您运行helm status时，可以获得以下步骤。</p><ol class=""><li id="61b0" class="kr ks hh ig b ih ii il im ip kt it ku ix kv jb kw kx ky kz bi translated">获取Redis密码:</li></ol><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="20a7" class="jm jn hh ji b fi jo jp l jq jr">export REDIS_PASSWORD=$(kubectl get secret --namespace default oke-redis -o jsonpath="{.data.redis-password}" | base64 --decode)</span></pre><p id="f658" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2.运行Redis pod:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="a1fb" class="jm jn hh ji b fi jo jp l jq jr">kubectl run --namespace default oke-redis-client --rm --tty -i --restart='Never' \                                                            <br/>    --env REDIS_PASSWORD=$REDIS_PASSWORD \                                                                                                       <br/>   --image docker.io/bitnami/redis:4.0.14 -- bash</span></pre><p id="47de" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">3.使用Redis cli连接:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="1266" class="jm jn hh ji b fi jo jp l jq jr">redis-cli -h oke-redis-master -a $REDIS_PASSWORD</span></pre><p id="c789" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">4.键入redis命令:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="4acd" class="jm jn hh ji b fi jo jp l jq jr">oke-redis-master:6379&gt; ping                                                                                                                      <br/>PONG</span></pre><h2 id="c35e" class="jm jn hh bd js jt ju jv jw jx jy jz ka ip kb kc kd it ke kf kg ix kh ki kj kk bi translated">检查您的集群</h2><p id="9b58" class="pw-post-body-paragraph ie if hh ig b ih kl ij ik il km in io ip kn ir is it ko iv iw ix kp iz ja jb ha bi translated">回想一下，在yaml文件中，我们将redis从服务器的数量设置为3。让我们验证一下:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="eb9c" class="jm jn hh ji b fi jo jp l jq jr">kubectl get pods<br/>NAME                               READY   STATUS    RESTARTS   AGE                                                                              <br/>oke-redis-master-0                 1/1     Running   0          42m                                                                              <br/>oke-redis-slave-79c45c57d8-67bxj   1/1     Running   1          42m                                                                              <br/>oke-redis-slave-79c45c57d8-s6znq   1/1     Running   0          42m                                                                              <br/>oke-redis-slave-79c45c57d8-wnfrh   1/1     Running   0          42m</span></pre><p id="3d9f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您可以看到有3个pod在运行redis slaves。</p><h2 id="bd50" class="jm jn hh bd js jt ju jv jw jx jy jz ka ip kb kc kd it ke kf kg ix kh ki kj kk bi translated">更新您的版本</h2><p id="0c39" class="pw-post-body-paragraph ie if hh ig b ih kl ij ik il km in io ip kn ir is it ko iv iw ix kp iz ja jb ha bi translated">比如说，我们现在想更新头盔版本来改变一些设置，比如把奴隶的数量从3个变成2个。我们可以使用helm cli手动完成:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="044e" class="jm jn hh ji b fi jo jp l jq jr">helm upgrade oke-redis stable/redis --set cluster.slaveCount=2</span></pre><p id="8503" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">或者，我们可以在redis_values.yaml中更改它，然后再次运行terraform apply:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="5253" class="jm jn hh ji b fi jo jp l jq jr">..<br/>..<br/>..<br/>module.oke.helm_release.redis: Still modifying… (ID: oke-redis, 10s elapsed)<br/>module.oke.helm_release.redis: Still modifying… (ID: oke-redis, 20s elapsed)<br/>module.oke.helm_release.redis: Still modifying… (ID: oke-redis, 30s elapsed)<br/>module.oke.helm_release.redis: Still modifying… (ID: oke-redis, 40s elapsed)<br/>module.oke.helm_release.redis: Still modifying… (ID: oke-redis, 50s elapsed)<br/>module.oke.helm_release.redis: Still modifying… (ID: oke-redis, 1m1s elapsed)<br/>module.oke.helm_release.redis: Modifications complete after 1m9s (ID: oke-redis)</span><span id="4d23" class="jm jn hh ji b fi kq jp l jq jr">Apply complete! Resources: 1 added, 1 changed, 1 destroyed.</span></pre><p id="2da2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">同时，从另一个终端，我们可以看到正在更新的pod数量:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="5103" class="jm jn hh ji b fi jo jp l jq jr">kubectl get pods -w</span><span id="ba6b" class="jm jn hh ji b fi kq jp l jq jr">oke-redis-master-0                 0/1     Terminating   0          61s                                                                          <br/>oke-redis-slave-6bd9dc8d89-jdrs2   0/1     Running       0          3s                                                                           <br/>oke-redis-slave-6bd9dc8d89-kvc8r   0/1     Running       0          3s                                                                           <br/>oke-redis-slave-6fdd8c4b56-44qpb   0/1     Terminating   0          63s</span></pre><p id="ab99" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在以后的文章中，我们将研究扩展terraform-oci-oke模块的其他方法，以便在oke上部署软件。</p></div></div>    
</body>
</html>