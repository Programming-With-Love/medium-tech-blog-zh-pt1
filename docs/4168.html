<html>
<head>
<title>Chaining LiveData like RxJava with Kotlin extension</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Kotlin扩展链接像RxJava这样的LiveData</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/chaining-livedata-like-rxjava-with-kotlin-extension-e3a2c15ac11?source=collection_archive---------5-----------------------#2018-05-18">https://medium.com/google-developer-experts/chaining-livedata-like-rxjava-with-kotlin-extension-e3a2c15ac11?source=collection_archive---------5-----------------------#2018-05-18</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="c2ed" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你没有看过我关于<a class="ae jc" rel="noopener" href="/@henrytao/nonnull-livedata-with-kotlin-extension-26963ffd0333">非空LiveData </a>的文章，你需要看一下。同样的想法将在这里重复使用。</p><p id="4582" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你不了解RxJava，你还需要从https://github.com/ReactiveX/RxJava<a class="ae jc" href="https://github.com/ReactiveX/RxJava" rel="noopener ugc nofollow" target="_blank">那里了解一下。</a></p><p id="9074" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本文中，我们将讨论如何借鉴RxJava的一些思想，并将其应用到LiveData中。当然，感谢Kotlin扩展。它有助于开发人员更轻松地工作。对不起Java！目标将是这样的:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="415c" class="jm jn hh ji b fi jo jp l jq jr">val liveData: MutableLiveData&lt;Boolean&gt; = MutableLiveData()<br/>liveData<br/>  .distinct()<br/>  .filter { it == false }<br/>  .map { true }<br/>  .nonNull()<br/>  .observe(lifecycleOwner, { result -&gt;<br/>    // result is non-null and always true<br/>  })</span></pre></div><div class="ab cl js jt go ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="ha hb hc hd he"><h1 id="388c" class="jz jn hh bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">最简单的方法</h1><p id="6104" class="pw-post-body-paragraph ie if hh ig b ih kw ij ik il kx in io ip ky ir is it kz iv iw ix la iz ja jb ha bi translated">我们以<code class="du lb lc ld ji b">distinct</code>为例。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="f5b4" class="jm jn hh ji b fi jo jp l jq jr">val liveData: MutableLiveData&lt;Boolean&gt; = MutableLiveData()<br/>liveData<br/>  .distinct()<br/>  .observe(lifecycleOwner, { result -&gt;<br/>    // new result is different from previous result<br/>  })</span></pre><p id="09fc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了做到这一点，您需要为LiveData创建<code class="du lb lc ld ji b">distinct</code>和<code class="du lb lc ld ji b">observe</code>扩展。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="8327" class="jm jn hh ji b fi jo jp l jq jr"><strong class="ji hi">fun </strong>&lt;T&gt; LiveData&lt;T&gt;.distinct(): LiveData&lt;T&gt; {<br/>    <strong class="ji hi">val </strong>mediatorLiveData: MediatorLiveData&lt;T&gt; = MediatorLiveData()<br/>    mediatorLiveData.addSource(<strong class="ji hi">this</strong>) <strong class="ji hi">{<br/>        if </strong>(<strong class="ji hi">it </strong>!= mediatorLiveData.<em class="le">value</em>) {<br/>            mediatorLiveData.<em class="le">value </em>= <strong class="ji hi">it<br/>        </strong>}<br/>    <strong class="ji hi">}<br/>    return </strong>mediatorLiveData<br/>}</span><span id="9c9f" class="jm jn hh ji b fi lf jp l jq jr"><strong class="ji hi">fun </strong>&lt;T&gt; LiveData&lt;T&gt;.observe(owner: LifecycleOwner, observer: (t: T?) -&gt; Unit) {<br/>    observe(owner, <em class="le">Observer </em><strong class="ji hi">{ </strong>observer(<strong class="ji hi">it</strong>) <strong class="ji hi">}</strong>)<br/>}</span></pre><p id="dc9b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">其他方法也可以遵循同样的模式，比如<code class="du lb lc ld ji b">filter</code>、<code class="du lb lc ld ji b">map</code> …</p><h1 id="e766" class="jz jn hh bd ka kb lg kd ke kf lh kh ki kj li kl km kn lj kp kq kr lk kt ku kv bi translated">支持非空</h1><p id="4670" class="pw-post-body-paragraph ie if hh ig b ih kw ij ik il kx in io ip ky ir is it kz iv iw ix la iz ja jb ha bi translated">支持非空有点棘手。正如我在<a class="ae jc" rel="noopener" href="/@henrytao/nonnull-livedata-with-kotlin-extension-26963ffd0333">非空LiveData </a>文章中提到的，您需要有<code class="du lb lc ld ji b">NonNullMediatorLiveData</code>来区分空和非空观察者。因此，您可能需要为每个扩展方法复制您的逻辑。您的过滤器扩展将如下所示:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="fe16" class="jm jn hh ji b fi jo jp l jq jr"><strong class="ji hi">fun </strong>&lt;T&gt; LiveData&lt;T&gt;.distinct(): LiveData&lt;T&gt; {<br/>    <strong class="ji hi">val </strong>mediatorLiveData: MediatorLiveData&lt;T&gt; = MediatorLiveData()<br/>    mediatorLiveData.addSource(<strong class="ji hi">this</strong>) <strong class="ji hi">{<br/>        if </strong>(<strong class="ji hi">it </strong>!= mediatorLiveData.<em class="le">value</em>) {<br/>            mediatorLiveData.<em class="le">value </em>= <strong class="ji hi">it<br/>        </strong>}<br/>    <strong class="ji hi">}<br/>    return </strong>mediatorLiveData<br/>}</span><span id="f943" class="jm jn hh ji b fi lf jp l jq jr">// Exactly same logic but return NonNullMediatorLiveData<br/><strong class="ji hi">fun </strong>&lt;T&gt; NonNullMediatorLiveData&lt;T&gt;.distinct(): LiveData&lt;T&gt; {<br/>    <strong class="ji hi">val </strong>mediatorLiveData: NonNullMediatorLiveData&lt;T&gt; = NonNullMediatorLiveData()<br/>    mediatorLiveData.addSource(<strong class="ji hi">this</strong>) <strong class="ji hi">{<br/>        if </strong>(<strong class="ji hi">it </strong>!= mediatorLiveData.<em class="le">value</em>) {<br/>            mediatorLiveData.<em class="le">value </em>= <strong class="ji hi">it<br/>        </strong>}<br/>    <strong class="ji hi">}<br/>    return </strong>mediatorLiveData<br/>}</span><span id="7f13" class="jm jn hh ji b fi lf jp l jq jr"><strong class="ji hi">fun </strong>&lt;T&gt; LiveData&lt;T&gt;.observe(owner: LifecycleOwner, observer: (t: T?) -&gt; Unit) {<br/>    observe(owner, <em class="le">Observer </em><strong class="ji hi">{ </strong>observer(<strong class="ji hi">it</strong>) <strong class="ji hi">}</strong>)<br/>}</span></pre><p id="9a65" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在你可以不顾顺序一起做<code class="du lb lc ld ji b">distinct</code>和<code class="du lb lc ld ji b">nonNull</code>。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="391b" class="jm jn hh ji b fi jo jp l jq jr">val liveData: MutableLiveData&lt;Boolean&gt; = MutableLiveData()<br/>liveData<br/>  .nonNull()<br/>  .distinct()<br/>  .observe(lifecycleOwner, { result -&gt;<br/>    // new result is different from previous result<br/>  })</span><span id="7713" class="jm jn hh ji b fi lf jp l jq jr">// or <br/>liveData<br/>  .distinct()<br/>  .nonNull()<br/>  .observe(lifecycleOwner, { result -&gt;<br/>    // new result is different from previous result<br/>  })</span></pre><h1 id="0654" class="jz jn hh bd ka kb lg kd ke kf lh kh ki kj li kl km kn lj kp kq kr lk kt ku kv bi translated">用MediatorObserver润色代码</h1><p id="7032" class="pw-post-body-paragraph ie if hh ig b ih kw ij ik il kx in io ip ky ir is it kz iv iw ix la iz ja jb ha bi translated">复制逻辑是不好的。我们可以通过定义<code class="du lb lc ld ji b">interface MediatorObserver&lt;IN, OUT&gt;</code>来改进。您的代码看起来会更整洁，如下所示:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="d7e7" class="jm jn hh ji b fi jo jp l jq jr"><strong class="ji hi">private class </strong>DistinctExt&lt;T&gt; : MediatorObserver&lt;T, T&gt; {<br/><br/>    <strong class="ji hi">override fun </strong>run(source: LiveData&lt;T&gt;, mediator: MediatorLiveData&lt;T&gt;, value: T?) {<br/>        <strong class="ji hi">if </strong>(value != mediator.<em class="le">value</em>) {<br/>            mediator.<em class="le">value </em>= value<br/>        }<br/>    }<br/>}<br/><br/><strong class="ji hi">fun </strong>&lt;T&gt; LiveData&lt;T&gt;.distinct(): LiveData&lt;T&gt; = <em class="le">createMediator</em>(<strong class="ji hi">this</strong>, DistinctExt())<br/><strong class="ji hi">fun </strong>&lt;T&gt; NonNullMediatorLiveData&lt;T&gt;.distinct(): NonNullMediatorLiveData&lt;T&gt; = <em class="le">createMediator</em>(<strong class="ji hi">this</strong>, DistinctExt())</span></pre><p id="56fe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">更多信息，请看<a class="ae jc" href="https://github.com/henrytao-me/livedata-ktx/blob/master/livedata-ktx/src/main/java/me/henrytao/livedataktx/LiveData.kt" rel="noopener ugc nofollow" target="_blank"> LiveData.kt </a>。</p><h1 id="955b" class="jz jn hh bd ka kb lg kd ke kf lh kh ki kj li kl km kn lj kp kq kr lk kt ku kv bi translated">准备使用库</h1><p id="d198" class="pw-post-body-paragraph ie if hh ig b ih kw ij ik il kx in io ip ky ir is it kz iv iw ix la iz ja jb ha bi translated">你可以试试https://github.com/henrytao-me/livedata-ktx。在build.gradle中添加一行代码，准备开始工作:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="2b64" class="jm jn hh ji b fi jo jp l jq jr">implementation "me.henrytao:livedata-ktx:LATEST_VERSION"</span></pre><h1 id="1043" class="jz jn hh bd ka kb lg kd ke kf lh kh ki kj li kl km kn lj kp kq kr lk kt ku kv bi translated">感觉缺少方法？</h1><p id="5242" class="pw-post-body-paragraph ie if hh ig b ih kw ij ik il kx in io ip ky ir is it kz iv iw ix la iz ja jb ha bi translated">请通过创建<a class="ae jc" href="https://github.com/henrytao-me/livedata-ktx/issues" rel="noopener ugc nofollow" target="_blank">问题</a>来提出您的需求。我会尽快支持它。</p><p id="f7f5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我知道你的想法和快乐编码！</p></div></div>    
</body>
</html>