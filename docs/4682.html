<html>
<head>
<title>Faster, More Reliable CI Builds with Yarn</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用纱线构建更快、更可靠的CI</h1>
<blockquote>原文：<a href="https://medium.com/javascript-scene/faster-more-reliable-ci-builds-with-yarn-7dbc0ef31580?source=collection_archive---------5-----------------------#2016-10-30">https://medium.com/javascript-scene/faster-more-reliable-ci-builds-with-yarn-7dbc0ef31580?source=collection_archive---------5-----------------------#2016-10-30</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/85bfa389d084ea3bde8c54621cbedc7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vxvqDkdjyRhXHMbjENXyZw.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">McKay Savage (CC BY 2.0)</figcaption></figure><p id="36a1" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">你可能听说过纱线。它旨在作为npm客户端的更快、更可靠的替代方案。让包在本地更快地安装固然很好，但是要真正从Yarn中获得最大收益，您还应该将它与您的持续集成服务器一起使用。</p><p id="2b38" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">当与持续集成服务器配对时，Yarn可以减少由于不同安装的包解析不同而导致的随机CI故障的数量。</p><p id="3497" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">因为缓慢的安装和随机的CI故障会降低您整个团队的速度，它们会对您团队的生产力产生倍增的拖累效应。随机故障甚至比缓慢的安装更令人沮丧，因为当某个东西失败时，您必须确定它是否是一个间歇性的错误，或者是转移软件包的结果。说起来容易做起来难。</p><p id="cc02" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">纱来救援了！</p><figure class="js jt ju jv fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es jr"><img src="../Images/f3c694354cfe09248ca5d2e49ae7e565.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m6zlwvyKm9BPeFQCKvGQEQ.png"/></div></div></figure><h1 id="81e3" class="jw jx hh bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">纱线不是</h1><ul class=""><li id="65b9" class="ku kv hh iv b iw kw ja kx je ky ji kz jm la jq lb lc ld le bi translated">国家预防机制登记册的替代品</li></ul><p id="120f" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Yarn不是npm包注册表的替代品。它不是一个竞争包库生态系统。这不是鲍尔惨败的重演。</p><p id="8da3" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">它是一个使用npm软件包注册表的客户端。</p><h1 id="c2ac" class="jw jx hh bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">纱线是</h1><ul class=""><li id="d7ab" class="ku kv hh iv b iw kw ja kx je ky ji kz jm la jq lb lc ld le bi translated">更快的安装。</li><li id="de6d" class="ku kv hh iv b iw lf ja lg je lh ji li jm lj jq lb lc ld le bi translated">确定性依赖——使用<code class="du lk ll lm ln b">yarn.lock</code>,您每次都将获得安装在相同目录结构中的相同包的相同版本。</li></ul><h1 id="89d1" class="jw jx hh bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">转向纱线</h1><p id="2b49" class="pw-post-body-paragraph it iu hh iv b iw kw iy iz ja kx jc jd je lo jg jh ji lp jk jl jm lq jo jp jq ha bi translated">当Yarn发布的时候，我立刻意识到它可能是有价值的，但是我等了几天才从其他人那里听到它是否符合承诺。</p><p id="f72c" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">当有消息称它对人们很有效时，我决定开始在一个应用程序项目中使用它。</p><h2 id="ecc2" class="lr jx hh bd jy ls lt lu kc lv lw lx kg je ly lz kk ji ma mb ko jm mc md ks me bi translated">安装纱线</h2><p id="e408" class="pw-post-body-paragraph it iu hh iv b iw kw iy iz ja kx jc jd je lo jg jh ji lp jk jl jm lq jo jp jq ha bi translated">Yarn团队建议像安装本地应用程序一样安装Yarn。<strong class="iv hi">我建议你忽略他们的安装文档</strong>。</p><p id="82b9" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">没有原生的Mac安装程序，所以在Mac上，他们推荐自制。除非你用了自制软件安装Node(这我不推荐——用<a class="ae mf" href="https://github.com/creationix/nvm" rel="noopener ugc nofollow" target="_blank"> nvm代替</a>，省去了很多头疼的事，方便在节点版本之间切换)，否则<strong class="iv hi">就不要用自制软件安装Yarn </strong>。</p><p id="7bc1" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Homebrew还会安装Node，它会将<code class="du lk ll lm ln b">node</code>和<code class="du lk ll lm ln b">npm</code>全局命令重新链接到Homebrew路径，打破你之前的Node设置。</p><p id="cacc" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">除了家酿路线的依赖性管理问题，如果你将macOS升级到最新版本，它将通过扰乱<code class="du lk ll lm ln b">usr/local</code>的所有权来破坏家酿，所以你也将有那个混乱需要整理。</p><p id="ca0e" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">谢天谢地，还有一个更好的选择:</strong></p><pre class="js jt ju jv fd mg ln mh mi aw mj bi"><span id="4890" class="lr jx hh ln b fi mk ml l mm mn">npm install -g yarn</span></pre><p id="4538" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">额外收获:当你设置你的CI服务器时，你也应该有<code class="du lk ll lm ln b">npm</code>可用，这样你就可以<strong class="iv hi">使用同一个安装程序在你需要的任何地方安装</strong><code class="du lk ll lm ln b"><strong class="iv hi">yarn</strong></code><strong class="iv hi"/>。</p><p id="e851" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">具有讽刺意味的是，是的:我建议您安装一个JavaScript包管理器来安装您的新JavaScript包管理器。我确信这是Yarn团队推荐Mac安装自制软件的真正原因。主要是为了避免这种有点尴尬的讽刺。但是相信我。</p><blockquote class="mo"><p id="8844" class="mp mq hh bd mr ms mt mu mv mw mx jq dx translated"><code class="du lk ll lm ln b">npm</code>是有经验的JavaScript开发者安装Yarn的最简单也是最好的方法。</p></blockquote><p id="4b64" class="pw-post-body-paragraph it iu hh iv b iw my iy iz ja mz jc jd je na jg jh ji nb jk jl jm nc jo jp jq ha bi translated">Yarn团队会告诉你OS原生包依赖管理器是最好的方法，因为它可以跟踪你所有的包依赖。我明白这种逻辑，但实际上，<em class="nd">它只在Linux上成立</em>。<strong class="iv hi"> Homebrew不是macOS的原生包依赖管理器。它不会也不应该管理你在Mac上的所有应用依赖。</strong></p><p id="23f2" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Yarn的主要依赖是Node，<strong class="iv hi">自制并不是安装Node </strong>的最佳方式。那么为什么要用自制软件来管理纱线依赖性呢？</p><p id="6062" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Windows有自己的故事，我不太熟悉，所以我不会评论他们的安装说明对Windows用户有多好。</p><p id="6f71" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">你知道什么可以在Mac、Windows和Linux上运行，只需要一套指令，没有平台特有的麻烦吗？<strong class="iv hi">国家预防机制。</strong></p><h1 id="c4f3" class="jw jx hh bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">使用纱线</h1><p id="fa08" class="pw-post-body-paragraph it iu hh iv b iw kw iy iz ja kx jc jd je lo jg jh ji lp jk jl jm lq jo jp jq ha bi translated">简而言之，这些是您需要记住的命令:</p><p id="91a9" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">添加一个依赖:</strong></p><p id="04c3" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><code class="du lk ll lm ln b">yarn add &lt;packagename&gt;</code></p><p id="4a29" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">添加开发依赖:</strong></p><p id="535b" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><code class="du lk ll lm ln b">yarn add --dev &lt;packagename&gt;</code></p><p id="6a8b" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">删除依赖关系:</strong></p><p id="2898" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><code class="du lk ll lm ln b">yarn remove &lt;packagename&gt;</code></p><p id="9bd1" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">安装:</strong></p><p id="8759" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><code class="du lk ll lm ln b">yarn</code> <em class="nd">(安装是默认行为)</em></p><figure class="js jt ju jv fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ne"><img src="../Images/257dd360e57db2c694744c7f82d931aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*FdFjSsPAyHmg1nft-VuqSw.gif"/></div></div></figure><p id="3d57" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">大多数时候这就是你需要的。</p><h1 id="b73b" class="jw jx hh bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">锁定文件</h1><p id="310d" class="pw-post-body-paragraph it iu hh iv b iw kw iy iz ja kx jc jd je lo jg jh ji lp jk jl jm lq jo jp jq ha bi translated">Yarn使用<code class="du lk ll lm ln b">yarn.lock</code>文件完成了确定性依赖魔法。这应该是一种更加可靠的<code class="du lk ll lm ln b">npm shrinkwrap</code>形式。关键区别在于npm的安装程序算法不是确定性的，甚至是收缩的。Yarn的安装程序算法是确定性的。这意味着在一台机器上安装的、使用相同锁文件的内容，将与在另一台机器上安装的内容完全相同。</p><blockquote class="mo"><p id="ddc2" class="mp mq hh bd mr ms mt mu mv mw mx jq dx translated">不要。它的存在是为了确保确定性依赖解析，以避免“在我的机器上工作”的错误。</p></blockquote><p id="c4f1" class="pw-post-body-paragraph it iu hh iv b iw my iy iz ja mz jc jd je na jg jh ji nb jk jl jm nc jo jp jq ha bi translated">为了让锁文件为您工作，<strong class="iv hi">您必须将它签入git。</strong></p><h1 id="f0be" class="jw jx hh bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">设置持续集成</h1><p id="06d9" class="pw-post-body-paragraph it iu hh iv b iw kw iy iz ja kx jc jd je lo jg jh ji lp jk jl jm lq jo jp jq ha bi translated">正如我在安装步骤中提到的，您可以用<code class="du lk ll lm ln b">npm install -g yarn</code>安装yarn，这将在大多数CI服务器上工作。下面是Travis-CI用户的示例<code class="du lk ll lm ln b">.travis.yml</code>:</p><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="nf ng l"/></div></figure><h1 id="230f" class="jw jx hh bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">纱线在现实中是如何工作的？</h1><p id="91c4" class="pw-post-body-paragraph it iu hh iv b iw kw iy iz ja kx jc jd je lo jg jh ji lp jk jl jm lq jo jp jq ha bi translated">如果你对安装速度有多快感到好奇，以下是我从测试应用程序中提取的从头开始安装的数据:</p><p id="8719" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">使用国家预防机制:</strong></p><pre class="js jt ju jv fd mg ln mh mi aw mj bi"><span id="a6b3" class="lr jx hh ln b fi mk ml l mm mn">$ time npm install<br/>0m30.193s</span></pre><p id="42ee" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">使用纱线:</strong></p><pre class="js jt ju jv fd mg ln mh mi aw mj bi"><span id="2b7e" class="lr jx hh ln b fi mk ml l mm mn">$ time yarn<br/>0m44.835s</span></pre><p id="aa01" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi"> <em class="nd">哎呀！</em>T9】</strong></p><p id="749f" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Yarn的主要卖点是它应该比npm更快，但在我对真实项目的测试中，它在从头安装所有依赖项时实际上要慢一些。</p><p id="e088" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">添加新的依赖怎么办？</p><p id="0889" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">使用国家预防机制:</strong></p><pre class="js jt ju jv fd mg ln mh mi aw mj bi"><span id="219a" class="lr jx hh ln b fi mk ml l mm mn">$ time npm install lodash<br/>0m6.204s</span></pre><p id="56f6" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">使用纱线:</strong></p><pre class="js jt ju jv fd mg ln mh mi aw mj bi"><span id="f6d0" class="lr jx hh ln b fi mk ml l mm mn">$ time yarn add lodash<br/>0m2.948s</span></pre><p id="2f91" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">好吧，这才像话。我仍然担心从头开始安装的时间，但是现在，用yarn添加包的速度大约是npm的两倍。</p><p id="5316" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">显然，从头安装还有改进的空间(这决定了CI安装的速度)，但我现在很满意。</p><p id="0d87" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">对此要有所保留，因为这些东西可以从一个操作系统改变到另一个操作系统，从一个版本补丁改变到下一个版本:</p><blockquote class="mo"><p id="641b" class="mp mq hh bd mr ms mt mu mv mw mx jq dx translated">Yarn添加新包装的速度大约是npm的两倍。<br/>从头安装时，Yarn比npm慢。</p></blockquote><h1 id="585c" class="jw jx hh bd jy jz ka kb kc kd ke kf kg kh nh kj kk kl ni kn ko kp nj kr ks kt bi translated">结论</h1><p id="e811" class="pw-post-body-paragraph it iu hh iv b iw kw iy iz ja kx jc jd je lo jg jh ji lp jk jl jm lq jo jp jq ha bi translated">到目前为止，我对纱线的体验基本上是好的。</p><p id="433e" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">我刚刚开始在生产中测试它，所以我还不能自信地谈论它的可靠性，但我很乐观。</p><p id="5b08" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">如果真的如预期的那样，Yarn可以为你的团队节省很多时间。到目前为止，我的结果喜忧参半。</p><h2 id="6c71" class="lr jx hh bd jy ls lt lu kc lv lw lx kg je ly lz kk ji ma mb ko jm mc md ks me bi translated">你应该使用纱线吗？</h2><p id="59e6" class="pw-post-body-paragraph it iu hh iv b iw kw iy iz ja kx jc jd je lo jg jh ji lp jk jl jm lq jo jp jq ha bi translated">现在说绝对同意还为时过早，但我会乐观地点头表示同意。我支持Yarn团队解决这些问题，并随着时间的推移不断改进。</p></div><div class="ab cl nk nl go nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ha hb hc hd he"><h1 id="637a" class="jw jx hh bd jy jz nr kb kc kd ns kf kg kh nt kj kk kl nu kn ko kp nv kr ks kt bi translated"><a class="ae mf" href="https://ericelliottjs.com/product/lifetime-access-pass/" rel="noopener ugc nofollow" target="_blank">跟随埃里克·埃利奥特学习JavaScript】</a></h1></div><div class="ab cl nk nl go nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ha hb hc hd he"><p id="241d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi"> <em class="nd">埃里克·艾略特</em> </strong> <em class="nd">著有</em> <a class="ae mf" href="http://pjabook.com" rel="noopener ugc nofollow" target="_blank"> <em class="nd">【编程JavaScript应用】</em> </a> <em class="nd">(奥赖利)，以及</em> <a class="ae mf" href="http://ericelliottjs.com/product/lifetime-access-pass/" rel="noopener ugc nofollow" target="_blank"> <em class="nd">【跟埃里克·艾略特学JavaScript】</em></a><em class="nd">。他为Adobe Systems</em><strong class="iv hi"><em class="nd"/></strong><em class="nd"/><strong class="iv hi"><em class="nd">尊巴健身</em></strong><em class="nd"/><strong class="iv hi"><em class="nd">华尔街日报</em></strong><em class="nd"/><strong class="iv hi"><em class="nd">【ESPN</em></strong><em class="nd"/><strong class="iv hi"><em class="nd">BBC</em></strong><em class="nd">等顶级录音师贡献了软件经验</em></p><p id="61a2" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">他大部分时间都在旧金山湾区和世界上最美丽的女人在一起。</p></div></div>    
</body>
</html>