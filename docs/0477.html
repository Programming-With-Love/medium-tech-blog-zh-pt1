<html>
<head>
<title>Migrating to AndroidX: tips, tricks, and guidance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">迁移到AndroidX:提示、技巧和指南</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/migrating-to-androidx-tip-tricks-and-guidance-88d5de238876?source=collection_archive---------0-----------------------#2020-03-25">https://medium.com/androiddevelopers/migrating-to-androidx-tip-tricks-and-guidance-88d5de238876?source=collection_archive---------0-----------------------#2020-03-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/eb41c8c37a3cb9fa832382d6c6669c99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NtJWVS8GIVdHMjQ-"/></div></div></figure><div class=""/><div class=""><h2 id="6eeb" class="pw-subtitle-paragraph ip hr hs bd b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg dx translated">充分利用最新的喷气背包。</h2></div><p id="06ef" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">Jetpack是一套库、工具和指南，帮助您更轻松地编写高质量的应用程序。Jetpack 通过最佳实践、限制样板代码和简化复杂任务，使编码变得更加容易。所有这些都是为了让您能够专注于您真正关心的代码。</p><p id="a4f5" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">AndroidX是Jetpack中所有库的包名。可以将AndroidX视为用于开发、测试、版本化和发布Jetpack库的开源项目。</p><p id="a7cb" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">回到I/O 2018，我们<a class="ae kd" href="https://android-developers.googleblog.com/2018/05/hello-world-androidx.html" rel="noopener ugc nofollow" target="_blank">宣布</a>支持库将被重构到AndroidX名称空间中，这随着支持库28和AndroidX 1.0的发布而完成。</p><h1 id="6396" class="ke kf hs bd kg kh ki kj kk kl km kn ko iy kp iz kq jb kr jc ks je kt jf ku kv bi translated">为什么要迁移？</h1><p id="d402" class="pw-post-body-paragraph jh ji hs jj b jk kw it jm jn kx iw jp jq ky js jt ju kz jw jx jy la ka kb kc ha bi translated">现在是从使用Android支持库迁移到AndroidX的时候了。这背后有四个原因:</p><ol class=""><li id="85af" class="lb lc hs jj b jk jl jn jo jq ld ju le jy lf kc lg lh li lj bi translated">Android支持库已经走到了生命的尽头。28.0是Android支持名称空间的最后一个版本，不再维护该名称空间。因此，如果您想要以前已经进入支持库的bug修复或新特性，您需要迁移到AndroidX。</li><li id="a0d0" class="lb lc hs jj b jk lk jn ll jq lm ju ln jy lo kc lg lh li lj bi translated">更好的包装管理。使用AndroidX，您可以获得标准化和独立的版本，以及更好的标准化命名和更频繁的发布。</li><li id="3349" class="lb lc hs jj b jk lk jn ll jq lm ju ln jy lo kc lg lh li lj bi translated">其他库已经迁移到使用AndroidX名称空间库，包括Google Play服务、Firebase、Butterknife、Mockito 2和SQLDelight等。</li><li id="589a" class="lb lc hs jj b jk lk jn ll jq lm ju ln jy lo kc lg lh li lj bi translated">所有新的Jetpack库都将在AndroidX命名空间中发布。因此，例如，为了利用<a class="ae kd" href="https://developer.android.com/jetpack/compose" rel="noopener ugc nofollow" target="_blank"> Jetpack Compose </a>或<a class="ae kd" href="https://developer.android.com/camerax" rel="noopener ugc nofollow" target="_blank"> CameraX </a>，您需要迁移到AndroidX名称空间。</li></ol><h1 id="0c9f" class="ke kf hs bd kg kh ki kj kk kl km kn ko iy kp iz kq jb kr jc ks je kt jf ku kv bi translated">准备迁移</h1><p id="9857" class="pw-post-body-paragraph jh ji hs jj b jk kw it jm jn kx iw jp jq ky js jt ju kz jw jx jy la ka kb kc ha bi translated">在开始迁移到AndroidX之前，您应该:</p><ul class=""><li id="2877" class="lb lc hs jj b jk jl jn jo jq ld ju le jy lf kc lp lh li lj bi translated">备份您的项目。如果你使用的是<a class="ae kd" href="https://source.android.com/setup/develop" rel="noopener ugc nofollow" target="_blank">源码控制工具</a>，仍然建议你做一个备份，因为迁移会改变你项目中的许多文件。</li><li id="9292" class="lb lc hs jj b jk lk jn ll jq lm ju ln jy lo kc lp lh li lj bi translated">创建一个新分支，在其上进行迁移更改。</li><li id="d4f0" class="lb lc hs jj b jk lk jn ll jq lm ju ln jy lo kc lp lh li lj bi translated">如果可能的话，在迁移期间暂停或最小化开发(至少不要尝试重构或引入新特性)，因为这将有助于减少可能发生的合并冲突的数量。</li></ul><h1 id="c9f4" class="ke kf hs bd kg kh ki kj kk kl km kn ko iy kp iz kq jb kr jc ks je kt jf ku kv bi translated">移动</h1><p id="8649" class="pw-post-body-paragraph jh ji hs jj b jk kw it jm jn kx iw jp jq ky js jt ju kz jw jx jy la ka kb kc ha bi translated">在整个迁移过程中，重点是解决错误、编译应用程序以及通过所有测试。</p><h1 id="42ff" class="ke kf hs bd kg kh ki kj kk kl km kn ko iy kp iz kq jb kr jc ks je kt jf ku kv bi translated">步骤1:更新以支持库版本28</h1><p id="d1f3" class="pw-post-body-paragraph jh ji hs jj b jk kw it jm jn kx iw jp jq ky js jt ju kz jw jx jy la ka kb kc ha bi translated">不建议从旧版本的支持库(比如26或27)直接迁移到AndroidX:不仅需要解决名称空间的变化，还需要解决旧版本和AndroidX之间的API变化。</p><p id="21c7" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">因此，建议您更新到版本28，解决所有的API更改，并确保您的应用程序可以与版本28一起编译。</p><p id="d4d8" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">Support Library version 28和AndroidX 1.0是二进制等价的，这意味着在这两个版本之间只有包名发生了变化:所有的API都是相同的。这意味着从28移植到AndroidX时，需要修复的东西应该很少。</p><h1 id="afd0" class="ke kf hs bd kg kh ki kj kk kl km kn ko iy kp iz kq jb kr jc ks je kt jf ku kv bi translated">步骤2:启用Jetifier</h1><p id="6a92" class="pw-post-body-paragraph jh ji hs jj b jk kw it jm jn kx iw jp jq ky js jt ju kz jw jx jy la ka kb kc ha bi translated">Jetifier帮助迁移第三方依赖项以使用AndroidX。Jetifier将改变这些依赖项的字节码，使它们与使用AndroidX的项目兼容。然而，Jetifier不会改变你的源代码或者迁移你生成的代码。</p><p id="2a48" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">要在您的应用中启用Jetifier，请将以下内容添加到您的<code class="du lq lr ls lt b">gradle.properties</code>文件中:</p><pre class="lu lv lw lx fd ly lt lz ma aw mb bi"><span id="c914" class="mc kf hs lt b fi md me l mf mg">android.useAndroidX=true</span><span id="c8e7" class="mc kf hs lt b fi mh me l mf mg">android.enableJetifier=true</span></pre><p id="91b0" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">现在，当代码自动完成导入库时，您将导入该库的AndroidX版本，而不是旧的支持库版本。</p><h1 id="2ad4" class="ke kf hs bd kg kh ki kj kk kl km kn ko iy kp iz kq jb kr jc ks je kt jf ku kv bi translated">第三步。更新依赖关系</h1><p id="7872" class="pw-post-body-paragraph jh ji hs jj b jk kw it jm jn kx iw jp jq ky js jt ju kz jw jx jy la ka kb kc ha bi translated">在开始迁移之前，您应该将每个第三方库(如Butterknife、Glide、Mockito 2和SqlDelight)更新到库的最新版本。不这样做可能会导致无法解释的编译错误。</p><p id="de23" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">如果你使用的是代码生成库，Jetifier不会修改这些。因此，您需要检查代码生成库是否与AndroidX兼容。</p><p id="b63d" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">如果您考虑跳过步骤2和3，以下是您可能会遇到的一些错误:</p><ul class=""><li id="eb58" class="lb lc hs jj b jk jl jn jo jq ld ju le jy lf kc lp lh li lj bi translated">您使用的第三方代码与AndroidX不兼容。在这种情况下，类似于下面的堆栈跟踪将向您显示它正在尝试拉入旧版本的支持库:</li></ul><pre class="lu lv lw lx fd ly lt lz ma aw mb bi"><span id="577a" class="mc kf hs lt b fi md me l mf mg">…</span><span id="867e" class="mc kf hs lt b fi mh me l mf mg">Error : Program type already present: android.support.v4.app.INotificationSideChannel$Stub$Proxy |</span><span id="0f90" class="mc kf hs lt b fi mh me l mf mg">Reason: Program type already present: android.support.v4.app.INotificationSideChannel$Stub$Proxy</span><span id="cfc0" class="mc kf hs lt b fi mh me l mf mg">…</span></pre><ul class=""><li id="2e56" class="lb lc hs jj b jk jl jn jo jq ld ju le jy lf kc lp lh li lj bi translated">如果您有一个部分迁移的项目，您可能会得到一个重复的类错误，它试图从支持库和AndroidX中获取相同的代码。堆栈跟踪将显示如下内容:</li></ul><pre class="lu lv lw lx fd ly lt lz ma aw mb bi"><span id="b642" class="mc kf hs lt b fi md me l mf mg">…</span><span id="87a3" class="mc kf hs lt b fi mh me l mf mg">Duplicate class android.support.v4.app.INotificationSideChannel found in modules classes.jar (androidx.core:core:1.0.0) and classes.jar (com.android.support:support-compat:28.0.0)</span><span id="80ab" class="mc kf hs lt b fi mh me l mf mg">…</span></pre><h1 id="52f2" class="ke kf hs bd kg kh ki kj kk kl km kn ko iy kp iz kq jb kr jc ks je kt jf ku kv bi translated">步骤4:更新你的源代码</h1><p id="f79e" class="pw-post-body-paragraph jh ji hs jj b jk kw it jm jn kx iw jp jq ky js jt ju kz jw jx jy la ka kb kc ha bi translated">您有3种选择来更新您的源代码以使用AndroidX:</p><ul class=""><li id="5eaf" class="lb lc hs jj b jk jl jn jo jq ld ju le jy lf kc lp lh li lj bi translated">安卓工作室</li><li id="2883" class="lb lc hs jj b jk lk jn ll jq lm ju ln jy lo kc lp lh li lj bi translated">手动更新</li><li id="f638" class="lb lc hs jj b jk lk jn ll jq lm ju ln jy lo kc lp lh li lj bi translated">Bash脚本</li></ul><p id="2014" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">如果你使用Android Studio 3.2稳定版或更高版本，你可以使用<strong class="jj ht">重构</strong>菜单上的<strong class="jj ht">迁移到AndroidX </strong>选项来更新你的源代码。这是推荐的方法，因为Android Studio可以检查您的源代码，以便在重构时做出正确的决定。</p><figure class="lu lv lw lx fd hj er es paragraph-image"><div class="er es mi"><img src="../Images/5be72ab6cc0de7ce966cc3d4e9ec0c1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1118/0*0mKr2N0HKyJw3Yfs"/></div></figure><p id="ecc1" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">如果您不使用Android Studio或采用更复杂的应用程序架构，迁移到AndroidX选项不包括这一点，您应该利用<a class="ae kd" href="https://developer.android.com/jetpack/androidx/migrate/class-mappings" rel="noopener ugc nofollow" target="_blank">类映射csv文件</a>来实现查找和替换bash脚本。这个脚本应该找到android.support类的所有源代码实例，然后用它们的AndroidX等价物替换它们。</p><p id="a325" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">更具体地说，脚本应该获取提供类映射的CSV文件，然后运行一个grep命令，后跟一个sed命令来替换包名。但是，由于这是一种强力迁移方法，这种基本的查找和替换可能无法充分或正确地完成迁移。</p><p id="e320" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">此外，更新也可以手动完成。</p><p id="0c02" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">如果您决定采用手动方法，请访问迁移到AndroidX页面，在这里您可以找到一个<a class="ae kd" href="https://developer.android.com/jetpack/androidx/migrate/artifact-mappings" rel="noopener ugc nofollow" target="_blank">工件映射</a>，它详细描述了支持库包及其对应的类映射是AndroidX。您也可以从该页面下载CSV文件。</p><p id="3d05" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">就这样，您现在应该有一个编译和使用AndroidX的项目了。</p><h1 id="dd88" class="ke kf hs bd kg kh ki kj kk kl km kn ko iy kp iz kq jb kr jc ks je kt jf ku kv bi translated">那些讨厌的例外</h1><p id="e12f" class="pw-post-body-paragraph jh ji hs jj b jk kw it jm jn kx iw jp jq ky js jt ju kz jw jx jy la ka kb kc ha bi translated">虽然我们在这里讨论的工具和流程应该可以指导大多数应用程序顺利完成迁移，但我们发现，在某些情况下，您可能需要手动进行更改。</p><h1 id="9387" class="ke kf hs bd kg kh ki kj kk kl km kn ko iy kp iz kq jb kr jc ks je kt jf ku kv bi translated">版本配置文件</h1><p id="068e" class="pw-post-body-paragraph jh ji hs jj b jk kw it jm jn kx iw jp jq ky js jt ju kz jw jx jy la ka kb kc ha bi translated">您需要手动重新应用定义库版本的变量。举例来说，您的<code class="du lq lr ls lt b">build.gradle</code>文件在迁移前可能如下所示:</p><pre class="lu lv lw lx fd ly lt lz ma aw mb bi"><span id="9f76" class="mc kf hs lt b fi md me l mf mg">ext.versions = [</span><span id="741c" class="mc kf hs lt b fi mh me l mf mg">    ‘drawer’ : ‘28.0.0’,</span><span id="caee" class="mc kf hs lt b fi mh me l mf mg">    ‘rview’ : ‘28.0.0’</span><span id="d8bb" class="mc kf hs lt b fi mh me l mf mg">]</span><span id="2b86" class="mc kf hs lt b fi mh me l mf mg">implementation “com.android.support:drawerlayout:${versions.drawer}”</span><span id="f3f4" class="mc kf hs lt b fi mh me l mf mg">implementation “com.android.support:recyclerview-v7:${versions.rview}”</span></pre><p id="ad01" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">然后，在运行迁移工具后，您会得到这样的结果:</p><pre class="lu lv lw lx fd ly lt lz ma aw mb bi"><span id="1ceb" class="mc kf hs lt b fi md me l mf mg">ext.versions = [</span><span id="eb52" class="mc kf hs lt b fi mh me l mf mg">    ‘drawer’ : ‘28.0.0’,</span><span id="29d6" class="mc kf hs lt b fi mh me l mf mg">    ‘rview’ : ‘28.0.0’</span><span id="6573" class="mc kf hs lt b fi mh me l mf mg">]</span><span id="f925" class="mc kf hs lt b fi mh me l mf mg">implementation “androidx.drawerlayout:drawerlayout:1.0.0”</span><span id="ebba" class="mc kf hs lt b fi mh me l mf mg">implementation “androidx.recyclerview:recyclerview:1.0.0”</span></pre><p id="754f" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">DrawerLayout和RecyclerView使用的是AndroidX包，但是版本号现在是内嵌的。此外，版本变量编号也没有改变。因此，您需要对此进行手动更新:</p><pre class="lu lv lw lx fd ly lt lz ma aw mb bi"><span id="6cd9" class="mc kf hs lt b fi md me l mf mg">ext.versions = [</span><span id="3a97" class="mc kf hs lt b fi mh me l mf mg">    ‘drawer’ : ‘1.0.0’,</span><span id="2596" class="mc kf hs lt b fi mh me l mf mg">    ‘rview’ : ‘1.0.0’<br/>]</span><span id="fd00" class="mc kf hs lt b fi mh me l mf mg">implementation “androidx.drawerlayout:drawerlayout:${versions.drawer}”</span><span id="709e" class="mc kf hs lt b fi mh me l mf mg">implementation “androidx.recyclerview:recyclerview:${versions.rview}”</span></pre><h1 id="b8fd" class="ke kf hs bd kg kh ki kj kk kl km kn ko iy kp iz kq jb kr jc ks je kt jf ku kv bi translated">ProGuard和构建脚本</h1><p id="1c91" class="pw-post-body-paragraph jh ji hs jj b jk kw it jm jn kx iw jp jq ky js jt ju kz jw jx jy la ka kb kc ha bi translated">迁移工具不会自动更新ProGuard和任何相关的构建脚本。所以，如果你正在使用它们，并且其中有包名，你需要手动编辑它们。</p><h1 id="5583" class="ke kf hs bd kg kh ki kj kk kl km kn ko iy kp iz kq jb kr jc ks je kt jf ku kv bi translated">获取最新的稳定版本</h1><p id="21c4" class="pw-post-body-paragraph jh ji hs jj b jk kw it jm jn kx iw jp jq ky js jt ju kz jw jx jy la ka kb kc ha bi translated">迁移工具引入了AndroidX库的最新版本。因此，您可能会得到一些库的alpha版本，而不是稳定版本。例如，迁移前的支持库版本可能是:</p><pre class="lu lv lw lx fd ly lt lz ma aw mb bi"><span id="9811" class="mc kf hs lt b fi md me l mf mg">implementation ‘com.android.support:appcompat-v7:28.0.0’</span></pre><p id="f420" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">迁移后，您将使用相应的AndroidX库的alpha版本:</p><pre class="lu lv lw lx fd ly lt lz ma aw mb bi"><span id="4e66" class="mc kf hs lt b fi md me l mf mg">implementation ‘androidx.appcompat:appcompat:1.1.0-alpha01’</span></pre><p id="291c" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">因此，如果您更喜欢使用库的稳定版本，您将需要手动更新版本:</p><pre class="lu lv lw lx fd ly lt lz ma aw mb bi"><span id="41e5" class="mc kf hs lt b fi md me l mf mg">implementation ‘androidx.appcompat:appcompat:1.0.2’</span></pre><h1 id="da45" class="ke kf hs bd kg kh ki kj kk kl km kn ko iy kp iz kq jb kr jc ks je kt jf ku kv bi translated">更多帮助和资源</h1><p id="16f5" class="pw-post-body-paragraph jh ji hs jj b jk kw it jm jn kx iw jp jq ky js jt ju kz jw jx jy la ka kb kc ha bi translated">您可以在developer.android.com<a class="ae kd" href="https://developer.android.com/jetpack/androidx/migrate" rel="noopener ugc nofollow" target="_blank">迁移到AndroidX </a>页面上找到关于此过程、工具以及您可能遇到的问题的更多信息。该页面包括AndroidX项目的概述、迁移指南、旧支持库到新的stable和alpha AndroidX版本的映射表以及编写迁移脚本所需的CSV文件。</p><p id="006a" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">在其他地方，也有一篇文章详细介绍了格子示例项目中<a class="ae kd" rel="noopener" href="/androiddevelopers/cross-stitching-plaid-and-androidx-7603a192348e">向AndroidX的迁移。</a></p><p id="0540" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">最后，还有一个<a class="ae kd" href="https://issuetracker.google.com/issues?q=componentid:460323" rel="noopener ugc nofollow" target="_blank">问题追踪器</a>，在那里你可以看到团队正在处理的迁移工具问题。当然，您可以使用页面左上角的按钮，在此报告您在迁移工具中发现的任何问题。</p><h1 id="11a0" class="ke kf hs bd kg kh ki kj kk kl km kn ko iy kp iz kq jb kr jc ks je kt jf ku kv bi translated">最后的想法</h1><p id="342e" class="pw-post-body-paragraph jh ji hs jj b jk kw it jm jn kx iw jp jq ky js jt ju kz jw jx jy la ka kb kc ha bi translated">如果您还没有升级到AndroidX，这是一个很好的时机，可以利用Jetpack库为您的应用程序提供的简化开发。通过遵循本文中的指导，您应该会发现，在大多数情况下，迁移是一件简单易行的事情。</p></div><div class="ab cl mj mk go ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ha hb hc hd he"><p id="2144" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">你对安卓有什么想法吗？请在下面的评论中告诉我们，或者使用#AndroidStudio发推文，我们将从@AndroidDev回复，在那里我们定期分享关于如何在Android上取得成功的新闻和提示。</p></div></div>    
</body>
</html>