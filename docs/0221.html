<html>
<head>
<title>How Airbnb safeguards changes in production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Airbnb如何保护生产中的变化</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/how-airbnb-safeguards-changes-in-production-c83e94bfc52?source=collection_archive---------1-----------------------#2022-09-06">https://medium.com/airbnb-engineering/how-airbnb-safeguards-changes-in-production-c83e94bfc52?source=collection_archive---------1-----------------------#2022-09-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="1bdb" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">第二部分:近实时实验</h1><p id="7d4c" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">作者:<a class="ae ka" href="https://www.linkedin.com/in/michaelcl/" rel="noopener ugc nofollow" target="_blank">迈克·林</a>，<a class="ae ka" href="https://www.linkedin.com/in/preetiramasamy/" rel="noopener ugc nofollow" target="_blank">普雷蒂·拉马萨米</a>，<a class="ae ka" href="https://www.linkedin.com/in/toby-mao/" rel="noopener ugc nofollow" target="_blank">托比·毛</a>，<a class="ae ka" href="https://www.linkedin.com/in/zack-loebel-begelman-85407698/" rel="noopener ugc nofollow" target="_blank">扎克·罗贝尔-贝格尔曼</a></p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es kb"><img src="../Images/1f0e84d74c961becaf045507e8c2f43c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TwziuVGxkiaD4XKu4A2-pA.jpeg"/></div></div></figure><p id="122a" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">在我们的第一篇帖子<a class="ae ka" rel="noopener" href="/airbnb-engineering/how-airbnb-safeguards-changes-in-production-9fc9024f3446">中，我们讨论了对近乎实时的安全部署系统的需求，以及一些支持其决策的统计数据。在本帖中，我们将介绍Safe部署的各种组件背后的架构和工程选择。</a></p><p id="72dc" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">设计一个接近实时的实验系统需要在速度、精度、成本和弹性之间做出明确的权衡。早期的决定是将接近实时的结果限制在实验的前24小时——有足够的时间来捕捉任何主要问题，并过渡到使用来自批处理管道的综合结果。想法是一旦批量结果可用，实验者将不再需要实时结果。以下部分描述了在Safe部署系统的每个组件中的附加设计决策。</p><h1 id="baeb" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">高级设计</h1><p id="6a47" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">外管局部署系统的技术范围由3个主要部分组成:</p><ol class=""><li id="3345" class="ks kt hh je b jf kn jj ko jn ku jr kv jv kw jz kx ky kz la bi translated"><strong class="je hi"> Ramp Controller </strong>，一个<a class="ae ka" href="https://flink.apache.org/" rel="noopener ugc nofollow" target="_blank"> Flink </a>作业，作为集中协调器，通过Kafka向NRT提供实验配置，并通过HTTP调用Measured调用统计计算。</li><li id="0c08" class="ks kt hh je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la bi translated"><strong class="je hi">近实时(NRT)管道</strong>，另一个Flink作业，提取度量，用分配信息(治疗和主题信息)连接和丰富那些度量，并将丰富的度量存储到S3。</li><li id="73f9" class="ks kt hh je b jf lb jj lc jn ld jr le jv lf jz kx ky kz la bi translated"><strong class="je hi"> Measured </strong>，这是一个python库(通过Python HTTP服务器和worker pool调用),它使用来自S3的丰富的度量，聚合它们，并运行stats来确定任何变化是否显著。</li></ol><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es lg"><img src="../Images/c028b6bbc956e5f9b1aa9746352e8506.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dO4dDyRoREQgfsh9"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx">Fig 1: Architecture Diagram of the Safe Deploy system</figcaption></figure><h1 id="1586" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">斜坡控制器</h1><p id="b939" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">斜坡控制器根据测量结果执行自动实验斜坡。它分阶段增加实验曝光，慢慢曝光更多的受试者，并在每个阶段监测指标影响。如果观察到任何异常负面的指标，斜坡控制器将立即关闭实验，以最小化不良变化的影响。它支持多种斜坡算法，但大多数用户使用简单的基于时间的算法。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es ll"><img src="../Images/e79449f36b6a56b1e56c618cf4a3fcfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Uu8Z0bAhhrDH9CSQ"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx">Figure 2: Ramping process</figcaption></figure><p id="58e4" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">Ramp Controller被设计成无状态的，并且对任何作业失败都有弹性。在实验开始的几秒钟内，它向卡夫卡发布元数据，触发NRT开始加入该实验的事件。元数据包括NRT将写入的S3中的路径。此时，斜坡控制器的核心循环将开始:</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es lm"><img src="../Images/7e134ee90de29095de2ef9d85a913cd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ypoetTDVqKYg0ID8_EpTNA.png"/></div></div></figure><p id="c8cd" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">结果是在实验的前24小时内计算出来的，随着新文件发布到S3，会消耗新的指标。当百分比变化小于-20%且调整后的p值小于或等于0.01时，该指标被标记为异常。通过利用度量计算的测量框架，我们可以获得定制的聚合、更丰富的统计模型、计算性能度量的能力以及度量的维度缩减。</p><p id="ddc8" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">在克服了扩展管道和调整决策方面的这些技术挑战后，我们准备与实验负责人一起审查系统并推动采用。</p><h1 id="75e7" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">近实时(NRT)管道</h1><p id="c268" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">我们使用Apache Flink在Java和Scala中构建了新的NRT管道。它从大量Kafka流中读取:包含基于原始用户的事件(印象、预订请求等)的事件流。)、渐变控制器发出的包含实验元数据的流，以及包含为所有实验发出的原始分配事件的流，这些实验也由批处理管道使用。</p><p id="f443" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">此前，Airbnb曾试图为所有的实验任务建立一个在线数据存储，但这没有规模，最终被关闭。通过缩小范围，特别是将NRT管道限制在实验的前24小时，我们能够存储赋值的有界子集。使用实验元数据的<a class="ae ka" href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/datastream/fault-tolerance/broadcast_state/" rel="noopener ugc nofollow" target="_blank">广播连接</a>让我们过滤任务事件，Flink使<a class="ae ka" href="https://nightlies.apache.org/flink/flink-docs-master/docs/dev/datastream/fault-tolerance/state/#state-time-to-live-ttl" rel="noopener ugc nofollow" target="_blank">老化数据</a>变得微不足道。</p><p id="edef" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">提取内容被写入一个独立的库中，以便测量定义可以在批处理和流式传输中重用。为了提高性能，度量提取使用基于json字段的存在和值的倒排索引来确定首先提取哪些事件，然后只对相关事件运行提取。我们不仅从每个事件中提取度量，还提取维度。因为我们希望限制这项工作的复杂性，所以我们只支持来自同一个事件的维度作为度量本身。</p><p id="fd86" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">我们的第一个困难是如何处理无序出现的度量和任务。当将分配事件连接到度量时，我们希望数据在不同的时间过期，并且分配数据应该存储整整24小时。因为测量事件的数量意味着我们不能将它们保留24小时，所以我们在5分钟后保留一个短的缓冲区丢弃测量。实现这个目标所需的外部连接需要使用<a class="ae ka" href="https://nightlies.apache.org/flink/flink-docs-master/api/java/org/apache/flink/streaming/api/functions/co/KeyedCoProcessFunction.html" rel="noopener ugc nofollow" target="_blank">键控协同流程api </a>构建一个自定义连接。</p><p id="b2cb" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">一旦数据被连接，我们就在Flink内部缓冲它，以减少小实验的文件总数。我们编写了一个简单的键控过程stage，它根据我们想要输出多少并发文件的时间戳来散列事件。因为Flink要求密钥机制是确定性的，所以我们在时间戳上散列是很重要的。基于事件计数和时间缓冲事件，一旦分区达到基于事件或基于时间的阈值，就发出缓冲列表。这个阶段允许我们对输出的文件数量进行更精细的控制。</p><p id="dc83" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">我们利用Flink内置的支持拼花和S3的<a class="ae ka" href="https://nightlies.apache.org/flink/flink-docs-release-1.15/docs/connectors/datastream/filesystem/#parquet-format" rel="noopener ugc nofollow" target="_blank">作为文件接收器</a>来写文件。为了提供恰好一次的语义，Flink将只在出现检查点时写文件。由NRT流水线输出的文件被斜坡控制器用来做出决定。为了保持低延迟，我们每5分钟检查一次。</p><h1 id="fefe" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">衡量过的</h1><p id="7ef9" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">Measured是一个定义和计算指标的框架。它包括一个Scala库，用于从NRT管道利用的原始事件中提取度量和维度，以及一个Python库，用于定义度量(基于这些度量)、统计模型和可视化。本节重点介绍Python库，以及如何使用它来计算指标。</p><p id="dc36" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">为了提供跨平台的一致结果，我们运行与用户通过Python HTTP作业服务器和工作池运行的相同的测量作业。NRT度量评估就是其中之一，它使用Python工作池从S3下载事件文件。一旦文件被下载，这个任务就利用<a class="ae ka" href="https://duckdb.org/" rel="noopener ugc nofollow" target="_blank"> duckdb </a>的<a class="ae ka" href="https://duckdb.org/docs/data/parquet" rel="noopener ugc nofollow" target="_blank">拼花阅读器功能</a>聚集到用户级别。一旦我们有了一个本地用户集合，这项工作就会评估第一篇文章中讨论的各种顺序模型。作业完成后，这些评估的结果存储在MySQL数据库中，供UI或Ramp控制器通过HTTP检索。</p><h1 id="590a" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">采用</h1><p id="3ab7" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">安全部署的完整愿景包括保护生产中的任何变化。然而，为了获得经验和信任，我们最初将精力集中在A/B测试上。我们知道，像任何异常检测系统一样，Safe部署，尤其是自动执行补救步骤的系统，在采用时会面临某些挑战，包括:</p><ul class=""><li id="713c" class="ks kt hh je b jf kn jj ko jn ku jr kv jv kw jz ln ky kz la bi translated">对NRT指标的信任度与现有的批量指标相似，但不完全相同</li><li id="6093" class="ks kt hh je b jf lb jj lc jn ld jr le jv lf jz ln ky kz la bi translated">实验升温和停止过程中控制权的放弃</li><li id="43ee" class="ks kt hh je b jf lb jj lc jn ld jr le jv lf jz ln ky kz la bi translated">假阳性可能会因强制重启而减慢实验速度</li></ul><p id="11e8" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">在Safe部署之前，近四分之一的Airbnb团队有一个手动过程来增加实验。这包括增加实验的曝光度，手动验证性能指标，并重复直到达到目标曝光度。这往往掩盖了显著但不明显的负面影响。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es lo"><img src="../Images/cf167ab9f9fcbdb58c3fa921ca8bafa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*B_kTvecFqvuTWE17"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx">Figure 3: Illustration of how a controlled experiment provides greater sensitivity</figcaption></figure><p id="33bf" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">我们将Safe部署作为现有过程的补充，提高了检测负面影响的灵敏度，同时仍然允许实验人员根据自己的监控随时停止实验。我们还不断改进用于减少假阳性和假阴性的统计方法。自一年前默认启用Safe部署以来，它已被用于超过85%的实验启动，并帮助防止了数十起事件，及早标记了错误配置，最大限度地减少了对Airbnb业务的负面影响和补救工作中浪费的工程资源。</p><h1 id="a4ec" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">冰山一角</h1><p id="02b8" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">保护实验是减少Airbnb事件的一个重要步骤，然而，完整的愿景包括来自其他渠道的变化。不同通道的变化分布如图4所示。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kh ki di kj bf kk"><div class="er es lp"><img src="../Images/1b8a49a3e8ffdf1ea58fd1132fab4ea7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7Il9QJd_KJZcnBHp"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx">Figure 4: Distribution of changes pushed to production by channel</figcaption></figure><p id="0fba" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">我们以不同的方式处理每个剩余的渠道:</p><ul class=""><li id="0ab8" class="ks kt hh je b jf kn jj ko jn ku jr kv jv kw jz ln ky kz la bi translated">特征标志与实验相统一，以获得安全部署能力</li><li id="dc21" class="ks kt hh je b jf lb jj lc jn ld jr le jv lf jz ln ky kz la bi translated">为内容管理系统提供了API，用于以编程方式创建与内容更改相关的实验，并通过安全部署进行升级</li><li id="6a8f" class="ks kt hh je b jf lb jj lc jn ld jr le jv lf jz ln ky kz la bi translated">代码部署通过Spinnaker运行安全部署以及预先存在的自动金丝雀分析与每个部署</li></ul><p id="7972" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">(我们认为基础架构配置超出了范围，因为这些较低级别的更改需要完全不同的方法来解决。)</p><p id="b275" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">使用Spinnaker部署的代码占了生产中绝大部分的变更，需要大量的工作才能实现。本系列的下一篇文章将介绍我们如何通过改变Spinnaker的流量路由、服务配置和动态创建的配置来实现这一点。</p><p id="7945" class="pw-post-body-paragraph jc jd hh je b jf kn jh ji jj ko jl jm jn kp jp jq jr kq jt ju jv kr jx jy jz ha bi translated">有兴趣在Airbnb工作吗？查看我们的<a class="ae ka" href="https://careers.airbnb.com/" rel="noopener ugc nofollow" target="_blank">空缺职位</a>。</p><h1 id="4773" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">承认</h1><p id="4173" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">只有通过Airbnb基础设施和数据科学团队的共同努力，安全部署才成为可能。我们要感谢<a class="ae ka" href="https://www.linkedin.com/in/jingwei-lu-5701222/" rel="noopener ugc nofollow" target="_blank">陆经纬</a>、<a class="ae ka" href="https://www.linkedin.com/in/wei-hou-93a069a4/" rel="noopener ugc nofollow" target="_blank">魏浩</a>以及溪流基础设施团队的其他成员，他们帮助实施并随后扩大了NRT管道的规模。此外，感谢坎迪斯·张、【埃里克·艾弗森、、<a class="ae ka" href="https://www.linkedin.com/in/minyong-lee-1a302466/" rel="noopener ugc nofollow" target="_blank">李敏勇、</a>、里德·安德森、<a class="ae ka" href="https://www.linkedin.com/in/shant-torosean-606aa354/" rel="noopener ugc nofollow" target="_blank">尚特·托伦西安</a>、<a class="ae ka" href="https://www.linkedin.com/in/tatiana-xifara/" rel="noopener ugc nofollow" target="_blank">塔蒂亚娜·希法拉</a>以及许多帮助构建指标并验证其正确性的数据科学家。还要感谢<a class="ae ka" href="https://www.linkedin.com/in/kodnous/" rel="noopener ugc nofollow" target="_blank"> Kate Odnus </a>、<a class="ae ka" href="https://www.linkedin.com/in/kedar-bellare-3048128a/" rel="noopener ugc nofollow" target="_blank"> Kedar Bellare </a>和<a class="ae ka" href="https://www.linkedin.com/in/pmaccart/" rel="noopener ugc nofollow" target="_blank"> Phil MacCart </a>，他们是早期采用者，为我们提供了宝贵的反馈。此外还有<a class="ae ka" href="https://www.linkedin.com/in/kocolosk/" rel="noopener ugc nofollow" target="_blank">亚当·科洛斯基</a>、<a class="ae ka" href="https://www.linkedin.com/in/rstata/" rel="noopener ugc nofollow" target="_blank">雷米·斯塔塔</a>和<a class="ae ka" href="https://www.linkedin.com/in/ronnyk/" rel="noopener ugc nofollow" target="_blank">罗尼·科哈维</a>在全公司范围内的努力。我们还要感谢为Safe部署做出贡献的应急准备小组的其他成员:<a class="ae ka" href="https://www.linkedin.com/in/adriankuhn/" rel="noopener ugc nofollow" target="_blank">阿德里安·库恩</a>、<a class="ae ka" href="https://www.linkedin.com/in/antoinecreux/" rel="noopener ugc nofollow" target="_blank">安托万·克鲁</a>、<a class="ae ka" href="https://www.linkedin.com/in/george-l-9b946655/" rel="noopener ugc nofollow" target="_blank">乔治·李</a>、<a class="ae ka" href="https://www.linkedin.com/in/krishna-bhupatiraju-1ba1a524/" rel="noopener ugc nofollow" target="_blank">克里希纳·布帕蒂拉朱</a>、<a class="ae ka" href="https://www.linkedin.com/in/shao-xie-0b84b64/" rel="noopener ugc nofollow" target="_blank">邵燮</a>和<a class="ae ka" href="https://www.linkedin.com/in/vincent-chan-70080423/" rel="noopener ugc nofollow" target="_blank">文森特·陈</a>。</p><blockquote class="lq lr ls"><p id="1ffd" class="jc jd lt je b jf kn jh ji jj ko jl jm lu kp jp jq lv kq jt ju lw kr jx jy jz ha bi translated">所有产品名称、徽标和品牌都是其各自所有者的财产。本网站中使用的所有公司、产品和服务名称仅用于识别目的。使用这些名称、标志和品牌并不意味着认可。</p></blockquote></div></div>    
</body>
</html>