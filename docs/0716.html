<html>
<head>
<title>Improving App Performance with Baseline Profiles</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过基线配置文件提高应用性能</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/improving-app-performance-with-baseline-profiles-aefb909a6184?source=collection_archive---------4-----------------------#2022-05-02">https://medium.com/androiddevelopers/improving-app-performance-with-baseline-profiles-aefb909a6184?source=collection_archive---------4-----------------------#2022-05-02</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="5633" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc">或者如何将启动时间提高40% </em></p><p id="8991" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc">由DevRel工程师Kateryna Semenova发布；拉胡尔·拉维库马尔，软件工程师；克里斯·克赖克，软件工程师</em></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/760b751f77082e374cb928ddf69cde24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UZIE8fDslF9neqjq"/></div></div></figure><h1 id="bc8b" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">为什么启动时间很重要？</h1><p id="6820" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">许多应用程序发现应用程序性能和用户参与度之间的相关性。人们期望应用程序能够<strong class="ig hi">响应</strong>和<strong class="ig hi">快速</strong>加载。<a class="ae ks" href="https://support.google.com/googleplay/android-developer/answer/9844486" rel="noopener ugc nofollow" target="_blank">启动时间</a>是应用性能和质量的主要指标之一。</p><p id="f264" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的一些合作伙伴已经为app启动优化投入了大量的时间和资源。例如，看看脸书的故事。</p><p id="a76e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这篇博文中，我们将讨论<strong class="ig hi">基线配置文件</strong>以及它们如何提高应用和库的性能，包括启动时间<strong class="ig hi">提高40% </strong>。虽然这篇博客文章关注的是启动，但是基线配置文件也显著改善了jank。</p><h1 id="7592" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">历史</h1><p id="de06" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">Android 9 (API level 28)在Play Cloud 中引入了<a class="ae ks" href="https://android-developers.googleblog.com/2019/04/improving-app-performance-with-art.html" rel="noopener ugc nofollow" target="_blank"> ART优化配置文件，以改善应用启动时间。平均而言，我们已经看到，当云配置文件可用时，应用程序在各种设备上的冷启动速度至少快15%。</a></p><p id="f200" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当应用程序在安装或更新后第一次启动时，它的代码以解释模式运行，直到它被JIT ted。在APK中，Java和Kotlin代码被编译为dex字节码，但由于存储和加载完全编译的应用程序的成本，没有完全编译为机器代码(从Android 6开始)。应用程序中经常使用的类和方法以及应用程序启动时使用的类和方法都记录在一个配置文件中。一旦设备进入空闲模式，<a class="ae ks" href="https://source.android.com/devices/tech/dalvik/configure%23how_art_works" rel="noopener ugc nofollow" target="_blank"> ART </a>就会根据这些配置文件编译应用程序。这加快了后续应用程序的启动。</p><p id="6476" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从Android 9(API 28级)开始，Google Play也提供了云概要文件。当一个应用程序在设备上运行时，ART生成的配置文件由Play Store应用程序上传，并聚合到云中。一旦为某个应用程序上传了足够多的配置文件，Play应用程序就会将汇总的配置文件用于后续安装。</p><h1 id="cb8a" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">问题</h1><p id="4acd" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">虽然云配置文件在可用时很棒，但它们并不总是在安装了应用程序后就可以使用。收集和汇总配置文件通常需要几天时间，当许多应用程序每周更新时，这是一个问题。许多用户会在云配置文件可用之前安装更新。谷歌Android团队开始寻找其他方法来改善档案的延迟。</p><h1 id="49a6" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">解决办法</h1><p id="dfe3" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated"><a class="ae ks" href="https://developer.android.com/studio/profile/baselineprofiles" rel="noopener ugc nofollow" target="_blank">基线配置文件</a>是一种新的机制，提供可以在Android 7 (API级别24)和更高版本上使用的配置文件。基线档案是由<a class="ae ks" href="https://developer.android.com/studio/releases/gradle-plugin" rel="noopener ugc nofollow" target="_blank"> Android Gradle插件</a>使用应用程序和库提供的人类可读的档案格式生成的艺术档案。一个例子可能是这样的:</p><pre class="je jf jg jh fd kt ku kv kw aw kx bi"><span id="9aa9" class="ky jq hh ku b fi kz la l lb lc">HSPLandroidx/compose/runtime/ComposerImpl;-&gt;updateValue(Ljava/lang/Object;)V HSPLandroidx/compose/runtime/ComposerImpl;-&gt;updatedNodeCount(I)I HLandroidx/compose/runtime/ComposerImpl;-&gt;validateNodeExpected()V PLandroidx/compose/runtime/CompositionImpl;-&gt;applyChanges()V HLandroidx/compose/runtime/ComposerKt;-&gt;findLocation(Ljava/util/List;I)I</span></pre><p id="cbaa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">二进制配置文件存储在APK资产目录(assets/dexopt/baseline.prof)中的特定位置。</p><p id="da8b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">基线配置文件在构建时创建，作为APK的一部分发送到Play，然后在下载应用程序时从Play发送给用户。它们填补了ART云剖面管道中的空白，当云剖面尚不可用时，它们会自动与云剖面合并。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/dbe0f3d96a92ca0cb79f932186934435.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oNBuWDP-AlAB1xd6"/></div></div></figure><p id="8906" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">基线概要文件的最大好处之一是它们可以在本地<a class="ae ks" href="https://developer.android.com/studio/profile/baselineprofiles#creating-profile-rules" rel="noopener ugc nofollow" target="_blank">开发和评估</a>，因此开发人员可以看到真实的最终用户性能改进。与云配置文件相比，它们在较低版本的Android(7及更高版本)上也受支持，云配置文件仅从Android 9开始提供。</p><h1 id="ae80" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">影响</h1><p id="2151" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">2021年初，谷歌地图从两周的发布周期转为一周的发布周期。更频繁的更新意味着更频繁地丢弃本地预编译，以及更多的用户在没有Play Cloud Profiles的情况下经历缓慢的启动。通过使用基线资料，谷歌地图<strong class="ig hi">的平均启动时间缩短了30% </strong>，搜索量也相应增加了2.4%<strong class="ig hi">，对于这样一个成熟的应用来说，这是一个巨大的进步。</strong></p><p id="df19" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">库中的代码就像应用程序的代码一样——默认情况下，它没有完全编译，如果它在启动的关键路径上做了大量工作，这可能会是一个问题。</p><p id="481b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae ks" href="https://developer.android.com/jetpack/compose" rel="noopener ugc nofollow" target="_blank"> Jetpack Compose </a>是一个UI库，它不是Android系统映像的一部分，因此在安装时不会完全编译，这与Android View toolkit的大部分代码不同。这导致了性能问题，尤其是应用程序的前几次冷启动。</p><p id="3062" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了解决这个问题，Compose <a class="ae ks" href="https://developer.android.com/jetpack/compose/ergonomics#profile-inst" rel="noopener ugc nofollow" target="_blank">使用了描述文件安装程序</a>。它提供了基线配置文件规则，可以减少启动时间和编写应用程序的时间。</p><p id="5c4a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Google PlayStore的搜索结果页面已经用Compose重写。在整合了Compose的基线配置文件规则后，<strong class="ig hi">显示初始搜索结果页面的时间缩短了约40% </strong>。</p><p id="e0bc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Android团队还向相关的<a class="ae ks" href="https://developer.android.com/jetpack/androidx/" rel="noopener ugc nofollow" target="_blank"> AndroidX </a>库添加了基线配置文件。这有利于所有使用这些库的Android应用程序。约束布局已发现<a class="ae ks" href="https://github.com/androidx/constraintlayout/pull/423" rel="noopener ugc nofollow" target="_blank">运输配置文件规则</a> <strong class="ig hi">减少动画帧时间超过一毫秒</strong>。</p><h1 id="4035" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">如何使用基线配置文件</h1><p id="aa64" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated"><strong class="ig hi">创建自定义基线配置文件</strong></p><p id="415c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所有的应用和库开发者都可以从基线配置文件中获益。理想情况下，开发人员为他们最关键的用户旅程创建配置文件，以确保这些旅程具有一致的快速性能，无论云配置文件是否可用。查看<a class="ae ks" href="https://developer.android.com/studio/profile/baselineprofiles#creating-profile-rules" rel="noopener ugc nofollow" target="_blank">详细指南</a>，了解如何为应用和库开发人员设置基线配置文件。</p><p id="dd6c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您现在还没有准备好为您的应用程序生成基线配置文件，您仍然可以通过更新您的依赖项来从中受益。如果你使用Android Gradle Plugin 7.3.0或更高版本构建，你会在你的APK中获得已经由库提供的基线配置文件(例如<a class="ae ks" href="https://cs.android.com/search?q=baseline-prof.txt&amp;ss=androidx%2Fplatform%2Fframeworks%2Fsupport" rel="noopener ugc nofollow" target="_blank"> Jetpack </a>)。Google Play会在安装时使用这些描述文件编译您的应用程序。您可以补充这些概要文件<a class="ae ks" href="https://developer.android.com/studio/profile/baselineprofiles#creating-profile-rules" rel="noopener ugc nofollow" target="_blank">，作为构建您的应用程序</a>的一部分。</p><p id="2c02" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">不要忘记衡量改进。遵循<a class="ae ks" href="https://developer.android.com/studio/profile/baselineprofiles#measuring-improvements" rel="noopener ugc nofollow" target="_blank">关于如何使用本地生成的配置文件测量启动</a>的步骤。</p><p id="7008" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">提供反馈</strong></p><p id="dae1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请分享您的反馈，让我们知道您的体验！</p></div><div class="ab cl ld le go lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ha hb hc hd he"><p id="d4e4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc">最初发表于</em><a class="ae ks" href="https://android-developers.googleblog.com/2022/01/improving-app-performance-with-baseline.html" rel="noopener ugc nofollow" target="_blank"><em class="jc">【https://android-developers.googleblog.com】</em></a><em class="jc">。</em></p></div></div>    
</body>
</html>