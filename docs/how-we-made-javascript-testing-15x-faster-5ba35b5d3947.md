# 我们如何将 JavaScript 测试速度提高 15 倍

> 原文：<https://medium.com/pinterest-engineering/how-we-made-javascript-testing-15x-faster-5ba35b5d3947?source=collection_archive---------5----------------------->

大卫·韦斯特| Pinterest 网站工程师

测试是我们工程基础设施的重要支柱。我们在任何给定的时间都有数百个 A/B 实验在运行。为了保持这些实验的顺利进行，在构建过程中运行大量的测试是非常关键的。

不幸的是，在数百个测试文件和数十个同步实验的压力下，我们的 Javascript 测试框架开始出现问题。它很慢，需要 15 分钟来运行全套测试，并且经常由于实验改变行为和网络/浏览器问题而中断。结果，对系统的信任降低了，测试被从我们的自动化构建过程中移除，直到系统被修复。

这是一个极好的机会来重新审视我们的 web 测试框架，保留有用的东西，抛弃无用的东西，构建一个适合我们的测试框架。其结果是我们新的 web 测试框架，我们称之为 [Affogato](https://www.pinterest.com/search/pins/?q=affogato) (是的，以浓缩咖啡和冰淇淋饮料命名，因为自动化测试覆盖面很可爱！).

![](img/dd78bbb3bd0d808131d13fa9fb779cd3.png)

## 加快测试速度

我们试图通过在多个并行的无头浏览器中运行来优化我们的 JavaScript 测试框架。但是完整的套件仍然需要太长时间，并且这种设置会导致不可预测的机器资源争用问题。从资源的角度来看，浏览器是饥饿的野兽。

这就是 [jsdom](https://github.com/tmpvar/jsdom) 化险为夷的地方。它是一个 node.js 命令行实用程序，实现了 [WHATWG DOM](https://dom.spec.whatwg.org/) 和 [HTML](https://html.spec.whatwg.org/multipage/) 标准，不涉及渲染、绘画和其他使浏览器消耗 CPU 和内存的任务。内部基准测试显示，在我们的大多数测试中，速度显著提高了 5 到 20 倍。DOM 密集型测试的性能提升最大。

为了利用我们的构建系统，它利用任意数量的处理器内核，我们将我们的测试套件分成小块，供我们的测试运行人员使用。随着我们的测试数量扩展到数千个，我们可以扩展运行测试的内核数量。虽然我们预计最终必须在多台机器上运行测试套件，但速度的提高确保了一台强大的计算机在可预见的未来足够快。

## 使测试可靠

确保我们的测试可靠可信需要多方面的方法。首先，我们通过使用 fixturess 避免了昂贵的数据查找和网络传输，fixture 是包含 JSON 数据的文件，描述了要测试的对象。测试框架使用 fixtures 来创建适当的模拟对象。Fixtures 使得测试各种对象状态变得容易，而不需要手动编写样板代码来实例化模拟对象。

不幸的是，如果不降低测试的功能或表达能力，网络请求不可能从 web 测试中完全消除。如果开发人员想要测试一些调用我们的服务器端 API 的 web 代码，我们想要促进这种冲动，而不是阻碍它。为了消除在进行这些服务器端调用时由网络中断引起的测试失败，我们编写了一个 XHR 记录器，它监听 ajax 请求并将响应保存到文件中，以便以后回放。为了避免重构 web 代码来支持这个记录器，我们直接修补了 JavaScript XHR 对象。记录器的额外副作用是平均减少 30%的测试运行时间。

## 让测试写起来令人愉快

由于多个实验总是在运行，单个实验可以改变 JavaScript 和我们的 API 中任意数量的代码路径。这意味着实验需要成为我们测试框架中的顶级概念，并且为给定的单元测试设置“实验环境”应该尽可能简单。我们用一些丰富的语法糖包装了 [Mocha](http://mochajs.org/) 框架，使得在给定的测试中可以轻松地针对任意数量的实验。利用[兴农。JS](http://sinonjs.org/) 及其沙箱，每次测试完成后，全局环境会自动清理。ES6 promise polyfill 用于简化异步测试的编写。

最后，出于一点点奇思妙想，我们对咖啡和奶油的隐喻进行了充分的研究，因此编写测试从键入“cream.sugar(…)”开始。我们认为没有人会反对与如此甜美的东西一起工作。

## 把这一切联系在一起

整个测试套件的运行速度比以前快了一个数量级，从 15 分钟减少到 1 分钟。自从我们开始在内部使用这个框架的三个月以来，还没有任何由不可靠的测试导致的测试失败的报告。它测试实验的能力已经彻底解决了一些难以理解的代码中反复出现的与实验相关的错误。此外，对新框架的内部反馈是积极的。

性能和可靠性的提高使我们可以一直运行测试。每当工程师保存一个 web 文件，相关的测试就会立即运行，如果测试失败，就会发出警报。当一个 pull 请求(PR)被提交到我们的 web 存储库时，我们使用 Jenkins 运行测试，如果有失败，就拒绝 PR。这种快速反馈使得调试测试更加容易和快速。花在调试测试失败上的时间直线下降，对我们测试的信任度提高了，测试也定期重新编写。

*大卫·韦斯特是网络团队*的软件工程师

*鸣谢:Pinterest 测试的飞跃发展得益于徐克雷、Jeremy Stanley 和网络团队的巨大贡献。*

*获取 Pinterest 工程新闻和更新，关注我们的工程*[*Pinterest*](https://www.pinterest.com/malorie/pinterest-engineering-news/)*，* [*脸书*](https://www.facebook.com/pinterestengineering) *和* [*推特*](https://twitter.com/PinterestEng) *。有兴趣加入团队吗？查看我们的* [*招聘网站*](https://about.pinterest.com/en/careers/engineering-product) *。*