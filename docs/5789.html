<html>
<head>
<title>Hardening the OCI Terraform provider authentication security</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">强化OCI Terraform提供商身份验证安全性</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/hardening-the-oci-terraform-provider-authentication-security-c0f2b92ffb3a?source=collection_archive---------0-----------------------#2021-06-09">https://medium.com/oracledevs/hardening-the-oci-terraform-provider-authentication-security-c0f2b92ffb3a?source=collection_archive---------0-----------------------#2021-06-09</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/151937ecad67954297eb75f1e1a7ef5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZB12FKikq9PGWwn7.jpg"/></div></div></figure><p id="d7db" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你想从你的机器<em class="jn">，</em>上运行Terraform脚本，你需要确保你是安全的。Terraform非常强大，如果一个流氓演员设法冒充你，他们可能会完全访问你的OCI环境，这取决于你被授权做什么。</p><p id="3f5c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您刚刚开始使用OCI，您可能已经创建了一个<em class="jn">未加密的API密钥</em>，并在您的OCI CLI和/或Terraform脚本中使用了它。如果有，<em class="jn">请删除它，现在！</em></p><p id="cb95" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如何知道自己使用的是未加密的密钥？如果你的地形看起来像这样</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="accc" class="jx jy hh jt b fi jz ka l kb kc">provider "oci" {<br/>  tenancy_ocid          = "ocid1.tenancy.oc1......"<br/>  user_ocid             = "ocid1.user.oc1......"<br/>  fingerprint           = "aa:bb:cc:dd:ee:ff:..."<br/>  private_key_path      = "~/.oci/mykey.pem"<br/>}</span></pre><p id="7afd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">并且它工作，那么是的，你正在使用未加密的密钥。你怎么知道？因为如果密钥被加密，OCI提供者将不会抱怨丢失密码短语。</p><p id="7095" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我大概不用强调这有多糟糕，对吧？只是用了“你有的东西”。有些东西会被偷。我确信您的本地存储和备份驱动器都是加密的，但是您仍然不应该在任何生产环境中使用未加密的密钥。</p><p id="d76e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">使用密码加密密钥</strong></p><p id="3b58" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">假设你有一个密码加密的密钥(如果你没有，请遵循这些步骤<a class="ae kd" href="https://docs.oracle.com/en-us/iaas/Content/API/Concepts/apisigningkey.htm" rel="noopener ugc nofollow" target="_blank">),故事还没有结束。问题是，如何管理密码短语本身？</a></p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="34a7" class="jx jy hh jt b fi jz ka l kb kc">provider "oci" {<br/>  tenancy_ocid          = "ocid1.tenancy.oc1......"<br/>  user_ocid             = "ocid1.user.oc1......"<br/>  fingerprint           = "aa:bb:cc:dd:ee:ff:..."<br/>  private_key_path      = "~/.oci/mykey.pem"<br/>  private_key_password  = "hunter2"<br/>}</span></pre><p id="37cd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">那显然不是解决方案。这并不比使用未加密的密钥更好，在我的书中，这甚至更糟。</p><p id="2b03" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">显然，我们需要将密码作为变量传递，但是我们如何安全地做到这一点呢？</p><p id="ce12" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">人们希望将变量声明为sensitive会使tf编写echo:</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="cb15" class="jx jy hh jt b fi jz ka l kb kc">provider "oci" {<br/>  ...<br/>  private_key_password  = var.private_key_password<br/>}</span><span id="d46c" class="jx jy hh jt b fi ke ka l kb kc">variable private_key_password {<br/>  sensitive=true<br/>}</span></pre><p id="adf8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">但是目前，tf只在打印plan/apply时编辑变量输出，而在明文中愉快地回应它。也许那并不可怕，但我对此不太满意。<em class="jn">有一个tf </em> <a class="ae kd" href="https://github.com/hashicorp/terraform/issues/28122" rel="noopener ugc nofollow" target="_blank"> <em class="jn">问题</em> </a> <em class="jn">要改一下，</em>以防你想给你的+1。</p><figure class="jo jp jq jr fd ii er es paragraph-image"><div class="er es kf"><img src="../Images/f80dfd7c84960c95570a2323c1a2d9d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:944/format:webp/1*s-5igIbNEKlMYja6vByBIw.png"/></div></figure><p id="6942" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">那现在怎么办？设置TF_VAR或传递passphrase作为参数会更糟糕，因为您的passphrase会出现在您的shell历史文件中。呀！</p><p id="caaa" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">另一种方法是创建一个简单的shell脚本，提示输入密码，分配一个变量并调用terraform，如下所示:</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="9354" class="jx jy hh jt b fi jz ka l kb kc">read -r -s -p "private_key_password: " TFPWD<br/>TF_VAR_private_key_password=$TFPWD terraform "$@"</span></pre><p id="2ed0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这个脚本会提示输入密码短语，而<em class="jn">不会回显。</em>然后in会给TF_VAR_ variable赋值，并调用terraform，传递任何参数给它。</p><figure class="jo jp jq jr fd ii er es paragraph-image"><div class="er es kg"><img src="../Images/282fe0ec369cf71d9867cf5d748d49c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:916/format:webp/1*rX103hbMkbuiXaHULMdAAQ.png"/></div></figure><p id="a329" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">提示terraform使用加密密钥执行后:</p><figure class="jo jp jq jr fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kh"><img src="../Images/5e5f10291b58ce1f341691e3ce440475.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GVfIJ-f62R2brUh9v5JLhw.png"/></div></div></figure><p id="0373" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">好的一面是，只要terraform在运行，密码就会保存在内存中。一旦它完成并且控制返回到bash，<em class="jn">变量就消失了</em>。</p><p id="3ee1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">诚然，这并没有消除风险，因为控制你的机器的黑客也可能安装键盘记录器，但至少我们增加了另一个攻击者需要解决的问题。</p><p id="bbed" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">跳过密钥，使用安全令牌认证</strong></p><p id="0244" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">还有另一个选择，就是根本不用按键！相反，您可以将提供者配置为<a class="ae kd" href="https://docs.oracle.com/en-us/iaas/Content/API/SDKDocs/clitoken.htm" rel="noopener ugc nofollow" target="_blank">使用安全令牌</a>认证。</p><p id="1e03" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">假设您已经安装了OCI CLI，首先调用</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="3690" class="jx jy hh jt b fi jz ka l kb kc">oci session authenticate</span></pre><p id="092a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">你将需要选择OCI地区，一旦你这样做，它将打开一个网页浏览器，并验证你对OCI租赁。一旦您通过验证，它将询问您想要创建的配置文件名:</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="62f4" class="jx jy hh jt b fi jz ka l kb kc">Completed browser authentication process!</span><span id="3dfe" class="jx jy hh jt b fi ke ka l kb kc">Enter the name of the profile you would like to create:</span></pre><p id="8d70" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我把我的叫做“tf”(没有引号)。现在，我可以配置提供者使用令牌:</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="8be5" class="jx jy hh jt b fi jz ka l kb kc">provider "oci" {<br/>  auth = "SecurityToken"<br/>  config_file_profile = "tf"<br/>}</span></pre><p id="2b34" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">记住，代币只有一个小时的有效期。您可以使用以下内容刷新它</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="78a9" class="jx jy hh jt b fi jz ka l kb kc">oci session refresh --profile &lt;profile_name&gt;</span></pre><p id="a8ea" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">但是一旦过期，就从</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="3a41" class="jx jy hh jt b fi jz ka l kb kc">oci session authenticate</span></pre><p id="f9bd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">用相同的配置文件名保存它(在我的例子中是“tf”)，你就可以开始了！</p><p id="13e9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="jn">这不是甲骨文的官方博客。这里的信息可能过时或不正确。观点是我自己的。</em></p></div></div>    
</body>
</html>