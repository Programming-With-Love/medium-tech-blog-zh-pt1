<html>
<head>
<title>Introduction to Terraform Skeleton</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform骨骼简介</h1>
<blockquote>原文：<a href="https://medium.com/globant/introduction-to-terraform-skeleton-dc6858302756?source=collection_archive---------0-----------------------#2022-07-19">https://medium.com/globant/introduction-to-terraform-skeleton-dc6858302756?source=collection_archive---------0-----------------------#2022-07-19</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="19a8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一次又一次，我不得不面对同一个问题:“我应该如何减少我的<strong class="ig hi"> <em class="jc"> terraform </em> </strong>代码以充分利用它？”。</p><p id="8c7b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">无论你是一名新手还是一名经验丰富的CloudOps工程师，你都会立即同意，拥有一种方法或者更确切地说是一种方法论是缓解学习曲线以及加快游戏速度的关键。</p><p id="6357" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这篇文章中，我展示了一种方法和一个模板:创建、管理和扩展你的<strong class="ig hi"> <em class="jc"> terraform </em> </strong>项目。</p><p id="d6ab" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">都在模块里:<strong class="ig hi"> <em class="jc"> terraform </em> </strong>模块是处理IaC时的基本积木。虽然还有其他感兴趣的领域，如<strong class="ig hi"> <em class="jc">环境</em> </strong>和<strong class="ig hi"> <em class="jc">组件</em> </strong>。</p><p id="8c46" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">举例来说，假设我们想要管理一个名为<strong class="ig hi"> <em class="jc"> acme </em> </strong>的组织，我们需要应对四个不同的组成部分:</p><ul class=""><li id="e553" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated"><strong class="ig hi"> <em class="jc"> iam </em> </strong>:保存角色和服务账户管理的信息和定义。例如，RACI矩阵的实现。</li><li id="bd34" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi"> <em class="jc">计算</em> </strong>:主机定义虚拟机和计算能力相关的任务。</li><li id="7c44" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi">联网</strong>:支持网络定义、子网以及防火墙。</li><li id="fc83" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi">存储</strong>:控制存储相关任务的定义和行为。</li></ul><p id="6910" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了创建一个空的文件夹结构，我们提供了一个<a class="ae jr" href="https://github.com/globant/gcp-sandbox/blob/wip_terraformer/terraformer/terraformer.py" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi"><em class="jc">terra former . py</em></strong></a>脚本，当按如下方式执行时，它会自动填充这个结构:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="7220" class="kb kc hh jx b fi kd ke l kf kg"><strong class="jx hi">#python terraformer.py --project acme --subsystems compute iam networking storage --environments dev prod</strong></span><span id="b3dd" class="kb kc hh jx b fi kh ke l kf kg"><strong class="jx hi">#tree acme</strong><br/>acme/<br/>├── compute<br/>│   ├── environments<br/>│   │   ├── dev<br/>│   │   │   ├── main.tf<br/>│   │   │   ├── outputs.tf<br/>│   │   │   ├── terraform.tfvars<br/>│   │   │   └── variables.tf<br/>│   │   └── prod<br/>│   │       ├── main.tf<br/>│   │       ├── outputs.tf<br/>│   │       ├── terraform.tfvars<br/>│   │       └── variables.tf<br/>│   ├── modules<br/>│   │   └── README.md<br/>│   └── shared<br/>│       └── remotes.tf<br/>├── iam<br/>│   ├── environments<br/>│   │   ├── dev<br/>│   │   │   ├── main.tf<br/>│   │   │   ├── outputs.tf<br/>│   │   │   ├── terraform.tfvars<br/>│   │   │   └── variables.tf<br/>│   │   └── prod<br/>│   │       ├── main.tf<br/>│   │       ├── outputs.tf<br/>│   │       ├── terraform.tfvars<br/>│   │       └── variables.tf<br/>│   ├── modules<br/>│   │   └── README.md<br/>│   └── shared<br/>│       └── remotes.tf<br/>├── modules<br/>│   └── README.md<br/>├── networking<br/>│   ├── environments<br/>│   │   ├── dev<br/>│   │   │   ├── main.tf<br/>│   │   │   ├── outputs.tf<br/>│   │   │   ├── terraform.tfvars<br/>│   │   │   └── variables.tf<br/>│   │   └── prod<br/>│   │       ├── main.tf<br/>│   │       ├── outputs.tf<br/>│   │       ├── terraform.tfvars<br/>│   │       └── variables.tf<br/>│   ├── modules<br/>│   │   └── README.md<br/>│   └── shared<br/>│       └── remotes.tf<br/>└── storage<br/>    ├── environments<br/>    │   ├── dev<br/>    │   │   ├── main.tf<br/>    │   │   ├── outputs.tf<br/>    │   │   ├── terraform.tfvars<br/>    │   │   └── variables.tf<br/>    │   └── prod<br/>    │       ├── main.tf<br/>    │       ├── outputs.tf<br/>    │       ├── terraform.tfvars<br/>    │       └── variables.tf<br/>    ├── modules<br/>    │   └── README.md<br/>    └── shared<br/>        └── remotes.tf</span></pre><p id="23b4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">自动化结构背后的思想是最大化组件的可重用性，同时保持环境和组件的通用性。</p><ul class=""><li id="81c5" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated"><strong class="ig hi"> acme/modules </strong>:托管项目范围的<strong class="ig hi"> <em class="jc"> terraform </em> </strong>模块，以便全面重用。</li><li id="06ec" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi">acme/{ component }/modules</strong>:容纳<strong class="ig hi"> <em class="jc"> terraform </em> </strong>组件级模块。</li><li id="7ccf" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi">acme/{ component }/{ environment }</strong>:包含任何给定环境的此类模块的定义和实例化。</li></ul><p id="da9e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们有意在我们的<a class="ae jr" href="https://github.com/globant/gcp-sandbox/tree/wip_terraformer/terraformer/acme" rel="noopener ugc nofollow" target="_blank">存储库代码</a>下留了一个例子，以显示一个基本的基础设施，包含一个VPC、一个子网、一个服务帐户、一个桶以及一个基于debian的VM。</p><p id="8b98" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于外部模块，有几种方法来填充它们:</p><ul class=""><li id="3803" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">将它们托管在一个单独的git存储库中。这将允许您将指向您现有存储库的<strong class="ig hi"> <em class="jc"> acme/modules </em> </strong>文件夹初始化为<strong class="ig hi"> <em class="jc"> git子模块</em> </strong>。</li><li id="6a7b" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">将它们托管在共享文件系统中。允许你将<strong class="ig hi"> <em class="jc"> symlink </em> </strong>你的<strong class="ig hi"> <em class="jc"> acme/modules </em> </strong>文件夹给它。</li><li id="afc5" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">将它们作为一个更大项目的一部分托管在一个<strong class="ig hi"> <em class="jc"> git存储库</em> </strong>(我们的例子)中。以这种方式，您可以通过从外部来源提取模块来填充<strong class="ig hi"> <em class="jc"> acme </em> </strong>的模块。要实现这一点，您可以使用git资源库(在我们的例子中是GitHub <a class="ae jr" href="https://github.com/globant/gcp-sandbox/tree/wip_terraformer/terraform-modules" rel="noopener ugc nofollow" target="_blank">分支</a>)支持的<strong class="ig hi"> <em class="jc"> svn </em> </strong>原语(<strong class="ig hi"> <em class="jc"> svn ls </em> </strong>和<strong class="ig hi"> <em class="jc"> svn export </em> </strong>)。</li></ul><p id="d898" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你查看GitHub，你可以通过使用下面的代码片段(结合了<strong class="ig hi"> <em class="jc"> svn ls </em> </strong>和<strong class="ig hi"> <em class="jc"> svn export </em> </strong>)来检查<strong class="ig hi"> <em class="jc"> acme </em> </strong>的模块是从我们的<strong class="ig hi"> <em class="jc"> git库</em> </strong>中提取的。</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="6f52" class="kb kc hh jx b fi kd ke l kf kg">#cd acme/modules<br/>#for dir in $(<strong class="jx hi">svn ls</strong> <a class="ae jr" href="https://github.com/globant/gcp-sandbox/branches/wip_terraformer/terraform-modules/" rel="noopener ugc nofollow" target="_blank">https://github.com/globant/gcp-sandbox/branches/wip_terraformer/terraform-modules/</a>); do <strong class="jx hi">svn export</strong> <a class="ae jr" href="https://github.com/globant/gcp-sandbox/branches/wip_terraformer/terraform-modules/$dir" rel="noopener ugc nofollow" target="_blank">https://github.com/globant/gcp-sandbox/branches/wip_terraformer/terraform-modules/$dir</a>; done</span></pre><p id="c948" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">acme项目的完整展示如下:</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="cf6d" class="kb kc hh jx b fi kd ke l kf kg">acme/<br/>├── compute<br/>│   ├── environments<br/>│   │   ├── dev<br/>│   │   │   ├── main.tf<br/>│   │   │   ├── outputs.tf<br/>│   │   │   ├── remotes.tf<br/>│   │   │   ├── terraform.tfvars<br/>│   │   │   └── variables.tf<br/>│   │   └── prod<br/>│   │       ├── main.tf<br/>│   │       ├── outputs.tf<br/>│   │       ├── remotes.tf<br/>│   │       ├── terraform.tfvars<br/>│   │       └── variables.tf<br/>│   ├── modules<br/>│   │   └── README.md<br/>│   └── shared<br/>│       └── remotes.tf<br/>├── iam<br/>│   ├── environments<br/>│   │   ├── dev<br/>│   │   │   ├── main.tf<br/>│   │   │   ├── outputs.tf<br/>│   │   │   ├── terraform.tfvars<br/>│   │   │   └── variables.tf<br/>│   │   └── prod<br/>│   │       ├── main.tf<br/>│   │       ├── outputs.tf<br/>│   │       ├── terraform.tfvars<br/>│   │       └── variables.tf<br/>│   ├── modules<br/>│   │   └── README.md<br/>│   └── shared<br/>│       └── remotes.tf<br/>├── modules<br/>│   ├── README.md<br/>│   ├── gcs_bucket<br/>│   │   ├── main.tf<br/>│   │   ├── outputs.tf<br/>│   │   └── variables.tf<br/>│   ├── gcs_compute<br/>│   │   ├── main.tf<br/>│   │   ├── outputs.tf<br/>│   │   └── variables.tf<br/>│   ├── gcs_service_account<br/>│   │   ├── main.tf<br/>│   │   ├── outputs.tf<br/>│   │   └── variables.tf<br/>│   ├── gcs_subnet<br/>│   │   ├── main.tf<br/>│   │   ├── outputs.tf<br/>│   │   └── variables.tf<br/>│   └── gcs_vpc<br/>│       ├── main.tf<br/>│       ├── outputs.tf<br/>│       └── variables.tf<br/>├── networking<br/>│   ├── environments<br/>│   │   ├── dev<br/>│   │   │   ├── main.tf<br/>│   │   │   ├── output.tf<br/>│   │   │   ├── terraform.tfvars<br/>│   │   │   └── variables.tf<br/>│   │   └── prod<br/>│   │       ├── main.tf<br/>│   │       ├── output.tf<br/>│   │       ├── terraform.tfvars<br/>│   │       └── variables.tf<br/>│   ├── modules<br/>│   │   └── README.md<br/>│   └── shared<br/>│       └── remotes.tf<br/>└── storage<br/>    ├── environments<br/>    │   ├── dev<br/>    │   │   ├── main.tf<br/>    │   │   ├── output.tf<br/>    │   │   ├── terraform.tfvars<br/>    │   │   └── variables.tf<br/>    │   └── prod<br/>    │       ├── main.tf<br/>    │       ├── output.tf<br/>    │       ├── terraform.tfvars<br/>    │       └── variables.tf<br/>    ├── modules<br/>    │   └── README.md<br/>    └── shared<br/>        └── remotes.tf</span></pre><p id="2d72" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当您深入研究任何一个<strong class="ig hi"><em class="jc">acme/{ component }/{ environment }/main . TF</em></strong>时，您可以看到它保存了现有模块的实例化信息，当与<strong class="ig hi"><em class="jc">terraform . TF vars</em></strong>一起使用时，它可以非常灵活。</p><pre class="js jt ju jv fd jw jx jy jz aw ka bi"><span id="fe5f" class="kb kc hh jx b fi kd ke l kf kg">...<br/>provider "google" {<br/>...<br/>}<br/>terraform {<br/>  backend "gcs" {<br/>  ...<br/>  }<br/>}<br/>module "default_vm" {<br/>  <strong class="jx hi">source             = "../../../modules/gcs_compute"</strong><br/>  ...<br/>}</span></pre><p id="340b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">结论</strong></p><p id="2ed6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">总之，我们展示了一种初始化新的或未来的terraform项目的方法，同时为重构现有项目腾出了空间。利用通用terraform模块结构是跨多个组织甚至多个云提供商实现可重用性的关键。</p></div></div>    
</body>
</html>