<html>
<head>
<title>Composable Datatypes with Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带函数的可组合数据类型</h1>
<blockquote>原文：<a href="https://medium.com/javascript-scene/composable-datatypes-with-functions-aec72db3b093?source=collection_archive---------1-----------------------#2017-08-07">https://medium.com/javascript-scene/composable-datatypes-with-functions-aec72db3b093?source=collection_archive---------1-----------------------#2017-08-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/b5319c93f5a4237f1472d1686f5b1e6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uVpU7iruzXafhU2VLeH4lw.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Smoke Art Cubes to Smoke — MattysFlicks — (CC BY 2.0)</figcaption></figure><blockquote class="it iu iv"><p id="69e6" class="iw ix iy iz b ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju ha bi translated"><strong class="iz hi">注:</strong>这是《作曲软件》系列<strong class="iz hi"> s </strong> <a class="ae jv" href="https://leanpub.com/composingsoftware" rel="noopener ugc nofollow" target="_blank"> <strong class="iz hi">(现在一本书！)</strong> </a>关于从基础开始学习JavaScript ES6+中的函数式编程和组合软件技术。敬请关注。还会有更多这样的事情发生！<br/> <a class="ae jv" rel="noopener" href="/javascript-scene/why-composition-is-harder-with-classes-c3e627dcd0aa"> &lt;上一个</a> | &lt; &lt; <a class="ae jv" rel="noopener" href="/javascript-scene/composing-software-an-introduction-27b72500d6ea">从第1部分开始</a> | <a class="ae jv" rel="noopener" href="/javascript-scene/javascript-monads-made-simple-7856be57bfe8">下一个&gt; &gt; </a></p></blockquote><p id="7369" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">在JavaScript中，最简单的组合方式是函数组合，函数只是一个可以添加方法的对象。换句话说，您可以这样做:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="ca69" class="ki kj hh ke b fi kk kl l km kn">const t = value =&gt; {<br/>  const fn = () =&gt; value;</span><span id="b098" class="ki kj hh ke b fi ko kl l km kn">  fn.toString = () =&gt; `t(${ value })`;</span><span id="c1e7" class="ki kj hh ke b fi ko kl l km kn">  return fn;<br/>};<br/></span><span id="24cf" class="ki kj hh ke b fi ko kl l km kn">const someValue = t(2);</span><span id="3c90" class="ki kj hh ke b fi ko kl l km kn">console.log(<br/>  someValue.toString() // "t(2)"<br/>);</span></pre><p id="946a" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">这是一个返回数字数据类型实例的工厂。但是请注意，这些实例不是简单的对象。相反，它们是函数，像任何其他函数一样，您可以组合它们。让我们假设它的主要用例是对其成员求和。也许在他们作曲的时候把他们相加是有意义的。</p><p id="cc5a" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">首先，我们建立一些规则(四=表示“相当于”):</p><ul class=""><li id="1094" class="ks kt hh iz b ja jb je jf jw ku jx kv jy kw ju kx ky kz la bi translated"><code class="du kp kq kr ke b">t(x)(t(0)) ==== t(x)</code></li><li id="5de2" class="ks kt hh iz b ja lb je lc jw ld jx le jy lf ju kx ky kz la bi translated"><code class="du kp kq kr ke b">t(x)(t(1)) ==== t(x + 1)</code></li></ul><p id="63d7" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">您可以使用我们已经创建的方便的<code class="du kp kq kr ke b">.toString()</code>方法在JavaScript中表达这一点:</p><ul class=""><li id="3315" class="ks kt hh iz b ja jb je jf jw ku jx kv jy kw ju kx ky kz la bi translated"><code class="du kp kq kr ke b">t(x)(t(0)).toString() === t(x).toString()</code></li><li id="00fe" class="ks kt hh iz b ja lb je lc jw ld jx le jy lf ju kx ky kz la bi translated"><code class="du kp kq kr ke b">t(x)(t(1)).toString() === t(x + 1).toString()</code></li></ul><p id="851c" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">我们可以把这些转化成一种简单的单元测试:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="bc91" class="ki kj hh ke b fi kk kl l km kn">const assert = {<br/>  same: (actual, expected, msg) =&gt; {<br/>    if (actual.toString() !== expected.toString()) {<br/>      throw new Error(`NOT OK: ${ msg }<br/>        Expected: ${ expected }<br/>        Actual:   ${ actual }<br/>      `);<br/>    }</span><span id="eb00" class="ki kj hh ke b fi ko kl l km kn">    console.log(`OK: ${ msg }`);<br/>  }<br/>};<br/></span><span id="d13d" class="ki kj hh ke b fi ko kl l km kn">{<br/>  const msg = 'a value t(x) composed with t(0) ==== t(x)';<br/>  const x = 20;<br/>  const a = t(x)(t(0));<br/>  const b = t(x);<br/>  assert.same(a, b, msg);<br/>}</span><span id="dafe" class="ki kj hh ke b fi ko kl l km kn">{<br/>  const msg = 'a value t(x) composed with t(1) ==== t(x + 1)';<br/>  const x = 20;<br/>  const a = t(x)(t(1));<br/>  const b = t(x + 1);<br/>  assert.same(a, b, msg);<br/>}</span></pre><p id="cb8b" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">这些测试一开始会失败:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="a22f" class="ki kj hh ke b fi kk kl l km kn">NOT OK: a value t(x) composed with t(0) ==== t(x)<br/>        Expected: t(20)<br/>        Actual:   20</span></pre><p id="31a8" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">但是我们可以通过三个简单的步骤让它们通过:</p><ol class=""><li id="a7d4" class="ks kt hh iz b ja jb je jf jw ku jx kv jy kw ju lg ky kz la bi translated">将<code class="du kp kq kr ke b">fn</code>函数改为返回<code class="du kp kq kr ke b">t(value + n)</code>的<code class="du kp kq kr ke b">add</code>函数，其中<code class="du kp kq kr ke b">n</code>是传递的参数。</li><li id="1e7e" class="ks kt hh iz b ja lb je lc jw ld jx le jy lf ju lg ky kz la bi translated">向<code class="du kp kq kr ke b">t</code>类型添加一个<code class="du kp kq kr ke b">.valueOf()</code>方法，这样新的<code class="du kp kq kr ke b">add()</code>函数可以将<code class="du kp kq kr ke b">t()</code>的实例作为参数。<code class="du kp kq kr ke b">+</code>运算符将使用<code class="du kp kq kr ke b">n.valueOf()</code>的结果作为第二个操作数。</li><li id="0bde" class="ks kt hh iz b ja lb je lc jw ld jx le jy lf ju lg ky kz la bi translated">用<code class="du kp kq kr ke b">Object.assign()</code>将方法分配给<code class="du kp kq kr ke b">add()</code>功能。</li></ol><p id="ad31" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">当你把所有这些放在一起，它看起来像这样:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="62a6" class="ki kj hh ke b fi kk kl l km kn">const t = value =&gt; {<br/>  const add = n =&gt; t(value + n);</span><span id="29cb" class="ki kj hh ke b fi ko kl l km kn">  return Object.assign(add, {<br/>    toString: () =&gt; `t(${ value })`,<br/>    valueOf: () =&gt; value<br/>  });<br/>};</span></pre><p id="4b34" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">然后测试通过:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="6da0" class="ki kj hh ke b fi kk kl l km kn">"OK: a value t(x) composed with t(0) ==== t(x)"<br/>"OK: a value t(x) composed with t(1) ==== t(x + 1)"</span></pre><p id="55b0" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">现在您可以用函数组合来组合<code class="du kp kq kr ke b">t()</code>的值:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="3332" class="ki kj hh ke b fi kk kl l km kn">// Compose functions from top to bottom:<br/>const pipe = (...fns) =&gt; x =&gt; fns.reduce((y, f) =&gt; f(y), x);</span><span id="494f" class="ki kj hh ke b fi ko kl l km kn">// Sugar to kick off the pipeline with an initial value:<br/>const sumT = (...fns) =&gt; pipe(...fns)(t(0));</span><span id="598a" class="ki kj hh ke b fi ko kl l km kn">sumT(<br/>  t(2),<br/>  t(4),<br/>  t(-1)<br/>).valueOf(); // 5</span></pre><h1 id="5b57" class="lh kj hh bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">您可以对任何数据类型执行此操作</h1><p id="b9fe" class="pw-post-body-paragraph iw ix hh iz b ja me jc jd je mf jg jh jw mg jk jl jx mh jo jp jy mi js jt ju ha bi translated">你的数据采取什么形状并不重要，只要有一些有意义的合成操作就行。对于列表或字符串，它可以是连接。对于DSP，可能是信号求和。当然，许多不同的操作可能对相同的数据有意义。问题是，哪种操作最能代表构图的概念？换句话说，这样表达的话，哪种操作最有利？：</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="9b59" class="ki kj hh ke b fi kk kl l km kn">const result = compose(<br/>  value1,<br/>  value2,<br/>  value3<br/>);</span></pre><h1 id="09cc" class="lh kj hh bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">可组合货币</h1><p id="b718" class="pw-post-body-paragraph iw ix hh iz b ja me jc jd je mf jg jh jw mg jk jl jx mh jo jp jy mi js jt ju ha bi translated">货币安全是一个开源库，实现了这种可组合的功能数据类型。JavaScript的<code class="du kp kq kr ke b">Number</code>类型无法准确表示美元的某些分数。</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="1665" class="ki kj hh ke b fi kk kl l km kn">.1 + .2 === .3 // false</span></pre><p id="4cd3" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">Moneysafe通过将美元金额提高到美分来解决这个问题:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="1f5e" class="ki kj hh ke b fi kk kl l km kn">npm install --save moneysafe</span></pre><p id="f088" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">然后:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="4bd2" class="ki kj hh ke b fi kk kl l km kn">import { $ } from 'moneysafe';</span><span id="3ab9" class="ki kj hh ke b fi ko kl l km kn">$(.1) + $(.2) === $(.3).cents; // true</span></pre><p id="704b" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">分类帐语法利用了Moneysafe将值提升到可组合函数中的事实。它公开了一个简单的函数组合实用程序，称为分类帐:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="e498" class="ki kj hh ke b fi kk kl l km kn">import { $ } from 'moneysafe';<br/>import { $$, subtractPercent, addPercent } from 'moneysafe/ledger';</span><span id="d57f" class="ki kj hh ke b fi ko kl l km kn">$$(<br/>  $(40),<br/>  $(60),<br/>  // subtract discount<br/>  subtractPercent(20),<br/>  // add tax<br/>  addPercent(10)<br/>).$; // 88</span></pre><p id="c7e7" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">返回值是提取的货币类型的值。它公开了方便的<code class="du kp kq kr ke b">.$</code> getter，该getter将内部浮点美分值转换成美元，四舍五入到最接近的美分。</p><p id="182c" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">结果是一个直观的界面来执行分类帐风格的货币计算。</p><h1 id="c0af" class="lh kj hh bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">测试你的理解能力</h1><p id="b165" class="pw-post-body-paragraph iw ix hh iz b ja me jc jd je mf jg jh jw mg jk jl jx mh jo jp jy mi js jt ju ha bi translated">克隆货币安全:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="ff86" class="ki kj hh ke b fi kk kl l km kn">git clone <a class="ae jv" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:ericelliott/moneysafe.git</span></pre><p id="1257" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">运行安装程序:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="d674" class="ki kj hh ke b fi kk kl l km kn">npm install</span></pre><p id="bf2d" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">使用观察控制台运行单元测试。它们都应该通过:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="fcb8" class="ki kj hh ke b fi kk kl l km kn">npm run watch</span></pre><p id="b47a" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">在新的终端窗口中，删除实现:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="82fd" class="ki kj hh ke b fi kk kl l km kn">rm source/<a class="ae jv" href="https://github.com/ericelliott/moneysafe/blob/master/source/moneysafe.js" rel="noopener ugc nofollow" target="_blank">moneysafe.js</a> &amp;&amp; touch source/moneysafe.js</span></pre><p id="a091" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">再看一下手表控制台测试。您应该会看到一个错误。</p><p id="693d" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">你的任务是使用单元测试和文档作为指导，从头开始重新实现<code class="du kp kq kr ke b">moneysafe.js</code>。</p><p id="28c8" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">我为会员录制了一个7集的视频漫游系列。这是第一集:</p><figure class="jz ka kb kc fd ii"><div class="bz dy l di"><div class="mj mk l"/></div></figure><p id="eee9" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">会员们，金钱安全演练在<a class="ae jv" href="https://ericelliottjs.com/premium-content/shotgun-the-moneysafe-series/" rel="noopener ugc nofollow" target="_blank">散弹枪系列</a>中有售。</p><p id="d2bb" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">不是会员？<a class="ae jv" href="https://ericelliottjs.com/product/lifetime-access-pass/" rel="noopener ugc nofollow" target="_blank">现在报名</a>。</p><p id="78f9" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated"><a class="ae jv" rel="noopener" href="/javascript-scene/javascript-monads-made-simple-7856be57bfe8"> <strong class="iz hi"> <em class="iy">接下来:JavaScript单子制作简单&gt; </em> </strong> </a></p><h1 id="fd17" class="lh kj hh bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">后续步骤</h1><p id="e44a" class="pw-post-body-paragraph iw ix hh iz b ja me jc jd je mf jg jh jw mg jk jl jx mh jo jp jy mi js jt ju ha bi translated">想了解更多关于JavaScript函数组合的知识吗？</p><p id="6a7e" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated"><a class="ae jv" href="http://ericelliottjs.com/product/lifetime-access-pass/" rel="noopener ugc nofollow" target="_blank">跟着Eric Elliott学JavaScript】。如果你不是会员，你就错过了！</a></p><figure class="jz ka kb kc fd ii er es paragraph-image"><a href="https://ericelliottjs.com/product/lifetime-access-pass/"><div class="er es ml"><img src="../Images/ebd7dfc9ae8d8938e30bdbdbe428fd4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3njisYUeHOdyLCGZ8czt_w.jpeg"/></div></a></figure></div><div class="ab cl mm mn go mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ha hb hc hd he"><p id="5e7e" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated"><strong class="iz hi"> <em class="iy">埃里克·艾略特</em> </strong> <em class="iy">著有</em> <a class="ae jv" href="http://pjabook.com" rel="noopener ugc nofollow" target="_blank"> <em class="iy">【编程JavaScript应用】</em> </a> <em class="iy">(奥赖利)，以及</em> <a class="ae jv" href="http://ericelliottjs.com/product/lifetime-access-pass/" rel="noopener ugc nofollow" target="_blank"> <em class="iy">【跟埃里克·艾略特学JavaScript】</em></a><em class="iy">。他为Adobe Systems</em><strong class="iz hi"><em class="iy"/></strong><em class="iy"/><strong class="iz hi"><em class="iy">尊巴健身</em></strong><em class="iy"/><strong class="iz hi"><em class="iy">华尔街日报</em></strong><em class="iy"/><strong class="iz hi"><em class="iy">【ESPN</em></strong><em class="iy"/><strong class="iz hi"><em class="iy">BBC</em></strong><em class="iy">等顶级录音师贡献了软件经验</em></p><p id="98ef" class="pw-post-body-paragraph iw ix hh iz b ja jb jc jd je jf jg jh jw jj jk jl jx jn jo jp jy jr js jt ju ha bi translated">他把大部分时间花在他想去的任何地方和世界上最漂亮的女人一起工作。</p></div></div>    
</body>
</html>