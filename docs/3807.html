<html>
<head>
<title>User Session Management In Xamarin Forms</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Xamarin表单中的用户会话管理</h1>
<blockquote>原文：<a href="https://medium.com/globant/user-session-management-in-xamarin-forms-b12f823fdf8?source=collection_archive---------1-----------------------#2022-01-06">https://medium.com/globant/user-session-management-in-xamarin-forms-b12f823fdf8?source=collection_archive---------1-----------------------#2022-01-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/ce703aa495645af6f6b1c0a1fb752a02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LxSmh8M9KQTY6sd5tIhUTQ.jpeg"/></div></div></figure><p id="e4e3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">你好，读者，特别是移动应用程序开发人员，他们在这里可以获得一些帮助和参考，了解我们如何在Xamarin forms应用程序中管理用户会话。</p><p id="2269" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">直接跳到主题，我们在开发过程中都遇到过这样的问题，需要处理用户会话，检测用户在特定时间内的不活动状态，并对其执行一些操作。一个典型的场景包括用户在“N”分钟不活动后从应用程序注销到登录屏幕。</p><p id="dd1e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">从用户的角度来看，应用程序的不活动包括用户没有与我们的应用程序交互、触摸、滚动、点击或进行任何类型的活动。对于这样的场景，我们需要处理自动注销，并将用户重定向到登录屏幕(取决于业务需求)。</p><p id="51b5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在Xamarin表单应用程序中，没有这样的内置条款，我们需要根据业务需求来构建。所以让我们把这项任务分成两部分。</p><blockquote class="jn jo jp"><p id="3725" class="ip iq jq ir b is it iu iv iw ix iy iz jr jb jc jd js jf jg jh jt jj jk jl jm ha bi translated"><strong class="ir hi">第1部分:</strong>创建会话管理器，并添加启动、停止和扩展会话的方法。<br/> <strong class="ir hi">第二部分:</strong>检测用户与Android和iOS应用的交互，并与会话管理器交互以管理会话。</p></blockquote><p id="9828" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">让我们从第1部分开始编写一些代码。<br/>这里我们创建了<strong class="ir hi"><em class="jq">appsession manager . cs</em></strong><em class="jq">作为singleton a类。</em></p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="fc4c" class="kd ke hh jz b fi kf kg l kh ki">using System;<br/>using System.Diagnostics;<br/>using Xamarin.Forms;</span><span id="c60b" class="kd ke hh jz b fi kj kg l kh ki">namespace SessionManager<br/>{<br/>    public sealed class AppSessionManager<br/>    {<br/>        private static readonly Lazy&lt;AppSessionManager&gt; lazy = new Lazy&lt;AppSessionManager&gt;();<br/>        public static AppSessionManager Instance { get { return lazy.Value; } }</span><span id="d764" class="kd ke hh jz b fi kj kg l kh ki">private Stopwatch StopWatch = new Stopwatch();<br/>        private readonly int _sessionThreasholdMinutes = 1;</span><span id="0726" class="kd ke hh jz b fi kj kg l kh ki">public AppSessionManager()<br/>        {<br/>            SessionDuration = TimeSpan.FromMinutes(_sessionThreasholdMinutes);<br/>        }</span><span id="5d22" class="kd ke hh jz b fi kj kg l kh ki">private TimeSpan SessionDuration;</span><span id="709f" class="kd ke hh jz b fi kj kg l kh ki">public void EndSession()<br/>        {<br/>            if (StopWatch.IsRunning)<br/>            {<br/>                StopWatch.Stop();<br/>            }<br/>        }</span><span id="33ec" class="kd ke hh jz b fi kj kg l kh ki">public void ExtendSession()<br/>        {<br/>            if (StopWatch.IsRunning)<br/>            {<br/>                StopWatch.Restart();<br/>            }<br/>        }</span><span id="785a" class="kd ke hh jz b fi kj kg l kh ki">public void StartSession()<br/>        {<br/>            if (!StopWatch.IsRunning)<br/>            {<br/>                StopWatch.Restart();<br/>            }<br/>            Console.WriteLine("Session Started at " + DateTime.Now.ToLongTimeString());<br/>            Device.StartTimer(new TimeSpan(0, 0, 1), () =&gt;<br/>            {<br/>                bool isTimerRunning = true;</span><span id="2d91" class="kd ke hh jz b fi kj kg l kh ki">if (StopWatch.IsRunning &amp;&amp; StopWatch.Elapsed.Minutes &gt;= SessionDuration.Minutes) //User was inactive for N minutes<br/>                {<br/>                    RedirectAndInformInactivity();<br/>                    EndSession();<br/>                    isTimerRunning = false;<br/>                }<br/>                Console.WriteLine("Current Time Elapsed -" + StopWatch.Elapsed.ToString());<br/>                return isTimerRunning;<br/>            });</span><span id="69c3" class="kd ke hh jz b fi kj kg l kh ki">}</span><span id="8d51" class="kd ke hh jz b fi kj kg l kh ki">//TODO</span><span id="70ea" class="kd ke hh jz b fi kj kg l kh ki">private void RedirectAndInformInactivity()<br/>        {<br/>            Device.BeginInvokeOnMainThread(() =&gt;<br/>            {<br/>                Application.Current.MainPage.DisplayAlert("Session Expired", "Your session has expired", "Restart");<br/>            });<br/>        }<br/>    }<br/>}</span></pre><p id="c05e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在上面的类中，我们指定需要检测不活动状态的分钟数。如果需要定义应用程序生命周期内不活动的动态时间限制，您也可以将其设为属性。它有启动、停止和延长当前会话的方法，这些方法将被应用程序使用。</p><p id="631b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">应用程序启动时或根据业务需求，需要启动会话。添加后，下面的行将启动新的会话。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="3333" class="kd ke hh jz b fi kf kg l kh ki">AppSessionManager.Instance.StartSession();</span></pre><p id="4784" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因此，Xamarin Android和Xamarin iOS都提供了不同的方法来实现这一点，并检测用户与应用程序的交互。</p><blockquote class="jn jo jp"><p id="ea27" class="ip iq jq ir b is it iu iv iw ix iy iz jr jb jc jd js jf jg jh jt jj jk jl jm ha bi translated"><strong class="ir hi"> <em class="hh"> Xamarin Android实现:</em> </strong></p><p id="0b7e" class="ip iq jq ir b is it iu iv iw ix iy iz jr jb jc jd js jf jg jh jt jj jk jl jm ha bi translated"><em class="hh"> Android项目提供了一个简单的实现。覆盖Android项目中</em><strong class="ir hi"><em class="hh">main activity . cs</em></strong><em class="hh">中的以下方法。<br/>当用户与应用程序交互并调用AppSessionManager的ExtendSession方法来重启计时器时，该方法被调用，如上面的实现所示。</em></p></blockquote><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="ce56" class="kd ke hh jz b fi kf kg l kh ki">public override void OnUserInteraction()<br/>        {<br/>            base.OnUserInteraction();<br/>            AppSessionManager.Instance.ExtendSession();<br/>            Console.WriteLine("Touch detected. Extending user session");<br/>        }</span></pre><blockquote class="jn jo jp"><p id="8d8b" class="ip iq jq ir b is it iu iv iw ix iy iz jr jb jc jd js jf jg jh jt jj jk jl jm ha bi translated"><strong class="ir hi"> Xamarin iOS实施:</strong></p></blockquote><p id="bf32" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在iOS上，我们需要创建一个如下图所示的继承UIApplication的自定义UIApplication类，并修改<strong class="ir hi"> <em class="jq"> Main.cs </em> </strong>文件以使用自定义UIApplication类。</p><ol class=""><li id="4c94" class="kk kl hh ir b is it iw ix ja km je kn ji ko jm kp kq kr ks bi translated">创建CustomUIApplication类(您可以随意命名)</li></ol><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="f5a5" class="kd ke hh jz b fi kf kg l kh ki">using System;<br/>using System.Linq;<br/>using UIKit;</span><span id="6606" class="kd ke hh jz b fi kj kg l kh ki">namespace SessionManager.iOS<br/>{</span><span id="d57e" class="kd ke hh jz b fi kj kg l kh ki">public class SessionManagerApp : UIApplication<br/>    {<br/>        public SessionManagerApp() : base()<br/>        {<br/>        }</span><span id="e5ce" class="kd ke hh jz b fi kj kg l kh ki">public SessionManagerApp(IntPtr handle) : base(handle)<br/>        {<br/>        }</span><span id="2556" class="kd ke hh jz b fi kj kg l kh ki">public SessionManagerApp(Foundation.NSObjectFlag t) : base(t)<br/>        {<br/>        }</span><span id="7a37" class="kd ke hh jz b fi kj kg l kh ki">public override void SendEvent(UIEvent uievent)<br/>        {<br/>            if (uievent.Type == UIEventType.Touches)<br/>            {<br/>                if (uievent.AllTouches.Cast&lt;UITouch&gt;().Any(t =&gt; t.Phase == UITouchPhase.Began))<br/>                {<br/>                    AppSessionManager.Instance.ExtendSession();<br/>                    Console.WriteLine("Touch detected. Extending user session");<br/>                }<br/>            }<br/>            base.SendEvent(uievent);<br/>        }<br/>    }<br/>}</span></pre><p id="bb61" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">2.修改<strong class="ir hi"> <em class="jq"> Main.cs </em> </strong>并添加以下代码。</p><pre class="ju jv jw jx fd jy jz ka kb aw kc bi"><span id="d542" class="kd ke hh jz b fi kf kg l kh ki">public class Application<br/>    {<br/>        static void Main(string[] args)<br/>        {<br/>            UIApplication.Main(args, typeof(SessionManagerApp), typeof(AppDelegate));<br/>        }<br/>    }</span></pre><p id="caee" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">你都准备好了！！现在，您的android和iOS项目中已经有了检测用户交互并使用AppSessionManager将会话延长到下一个“N”分钟的函数。</p><p id="6b06" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您需要将逻辑放在AppSessionManager.cs中，以便在会话过期时将用户重定向到所需的页面(检查TODO)。</p><p id="f97d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">你可以在这里查看这个项目的Git库<a class="ae kt" href="https://github.globant.com/Rohit-Kelkar/SessionManager" rel="noopener ugc nofollow" target="_blank">https://github.globant.com/Rohit-Kelkar/SessionManager</a></p><p id="3929" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">干杯！</p></div></div>    
</body>
</html>