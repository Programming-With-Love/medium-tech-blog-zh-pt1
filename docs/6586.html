<html>
<head>
<title>Don’t let Zombie EC2 instances run wild!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不要让僵尸EC2实例横行！</h1>
<blockquote>原文：<a href="https://medium.com/quick-code/dont-let-zombie-ec2-instances-run-wild-852364479df7?source=collection_archive---------3-----------------------#2019-02-21">https://medium.com/quick-code/dont-let-zombie-ec2-instances-run-wild-852364479df7?source=collection_archive---------3-----------------------#2019-02-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="be77" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当我试图向我的亲戚解释我这些天在做什么的时候，我试着做了一个关联，并说了类似于“<em class="jc">你知道你看《网飞》？这是由云“</em>”驱动的，所以显而易见的回答总是<em class="jc">“那么他们是如何设法存储所有这些电影的呢？他们一定有无限的能力？”</em>。是也不是，对吧？虽然公共云确实提供了在您需要时轻松、廉价地构建新实例的能力，但强大的能力也意味着巨大的责任。几乎我们接触过的每个客户都在利用Terraform/ansi ble/cloud formation或某种自动化来协调配置和部署流程，这意味着他们可以轻松地创建可重复的部署，并且不会有太多雪花四处飘散。</p><p id="00d7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们还发现，在大多数组织中，开发人员擅长旋转资源和将应用程序上线。然而，大多数开发/测试环境以及“僵尸”资源的扩散似乎都发生在及时地将它们关闭的地方。你会惊讶地发现，我们最终发现有多少实例、弹性IP、EBS卷很好地存在于AWS帐户中，并增加了账单。没有一个监控、可观测系统选择或报告它们。</p><p id="e126" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这篇博客中，我们将探索几个项目:</p><ol class=""><li id="d5b2" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">识别AWS中的僵尸实例</li><li id="5e87" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">设置策略以正确报告这些实例</li><li id="f234" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">使用批准工作流的自动化方法创建补救步骤</li></ol></div><div class="ab cl jr js go jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="ha hb hc hd he"><p id="e0a9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">识别AWS中的僵尸实例</strong></p><p id="260c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们从一些超级简单直接的东西开始，我们只想得到一个被停止的实例的列表。你可能想知道为什么我描述一个停止的实例，而AWS却说我们没有为这个实例付费。虽然这是准确的，但我们仍然为EBS卷付费，我们还为保持实例运行的每秒钟计费，最少一分钟，即使实例保持空闲并且我们没有连接到它。参考<a class="ae jy" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html" rel="noopener ugc nofollow" target="_blank"> AWS实例生命周期</a>获得更多信息。</p><p id="ff83" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">那么，当AWS EC2实例控制台没有显示所有地区的所有实例时，我们如何获得这个列表呢？我们可以使用<a class="ae jy" href="https://docs.aws.amazon.com/cli/latest/reference/ec2/describe-instances.html" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>编写脚本，也可以使用VMware的CloudHealth来完成这一任务，等等。根据您希望完成这项工作的速度和运营团队的技能，编写脚本可能可行，也可能不可行。在我们即将开始的僵尸大战中，像VMware的CloudHealth这样的多云平台可能是你的朋友。</p><p id="1c8f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要识别所有地区和所有客户的所有已停止实例，只需浏览至“资产”&gt;“AWS ”,然后通过几个选项进行筛选，如下所示。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es jz"><img src="../Images/43ef19e9dce7dbf9b2cebf25a57cd29c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GXID2rZtDMq41uj7vHaIlQ.png"/></div></div></figure><p id="3108" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您愿意，我们可以通过按时间段进一步筛选，识别有无标签的资源，从而细化我们的搜索。</p><p id="a02f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过几个简单的步骤，我们可以看到我们的朋友Sean在测试Cloud9时将几个实例留在了停止状态。通过CloudHealth平台，我还能够启动/停止EC2实例或运行Lambda函数。如果我让他放松，我可能会问他这些东西该怎么办！</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kl"><img src="../Images/72e443814f669a9c4a18393b815254e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gtNRjHSaObAhV4EWdUwu0Q.png"/></div></div></figure><p id="955f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此，让我们进入稍微复杂一点的东西，看看自动触发器。</p></div><div class="ab cl jr js go jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="ha hb hc hd he"><p id="f6fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">设置策略以正确报告这些实例</strong></p><p id="2cde" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我在CloudHealth中探索的一个领域是治理策略。在“设置”下浏览到“治理”,然后单击“策略”。所需策略的最终状态如下所示。该策略设置为每小时运行一次，在其中一个地区(在本例中为加拿大)的所有AZ之一中，查找最大CPU使用率至少14天低于5%的EC2实例。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es km"><img src="../Images/da63b9a1e0e9479664bdd75fa6555620.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VTjjX_UxPcL-39S6DEc28Q.png"/></div></div></figure><p id="299d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们深入研究一下组件，尤其是规则和操作部分，看看我们到底是如何做到这一点的。</p><div class="ka kb kc kd fd ab cb"><figure class="kn ke ko kp kq kr ks paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><img src="../Images/bbcdd8a70dbc30139155b1f24f9118b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1698/format:webp/1*GqzPkD-sT1qPJkxZxogd2w.png"/></div></figure><figure class="kn ke kt kp kq kr ks paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><img src="../Images/da4bc32ce436bbeb1647725393b14f3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:304/format:webp/1*9nSEAOImhjzr6hMBFNTrgA.png"/></div></figure></div><p id="47ff" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要设置此策略块，我们有几个选项可供选择，如上所示。我们对性能指标感兴趣，所以我们选择了性能。在“测量”选项卡下，我们有几个选项可供选择。为了简单起见，我们将使用CPU %。</p><p id="68f9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">“条件”选项卡允许我们以惊人的方式分割匹配条件。匹配条件可以基于AWS帐户、实例类型、操作系统、视角(我们之前已经讨论过)或者基于可用性区域。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es ku"><img src="../Images/34cd26c661f4963bca8c427a6dcefa1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cvLKem89FVKWkrv_6mRs3g.png"/></div></div></figure><p id="6242" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦我们定义了块和匹配条件，我们需要定义我们想要实现什么动作。我们可以选择实施基于批准的工作流，如针对<a class="ae jy" rel="noopener" href="/@bahubalishetti/reactive-policy-management-of-rds-usage-in-dev-test-environments-c1e97374a54c">RDS实例的主动策略管理</a>所述的<a class="kv kw ge" href="https://medium.com/u/91f04d3c8a41?source=post_page-----852364479df7--------------------------------" rel="noopener" target="_blank"> Bahubali Shetti </a>。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div class="er es kx"><img src="../Images/15e1d872cc91001fe89e5d9d8c30bed0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*w6qEd1E6KAWmu0-KlDUlpw.png"/></div></figure><p id="caf0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对我个人来说，删除EC2实例，即使得到批准，似乎也是一个极端的步骤。为了确保万无一失，我想拍摄快照，然后删除该实例。这是我们可以用Lambda函数实现的。我们也可以简单地给自己发电子邮件，或者更好地给所有者发电子邮件，让他去采取行动。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es ky"><img src="../Images/00394784dbb6b3ebd33f2cfcbfd7313f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Io0lQ9TtdU7-ugAdplebw.png"/></div></div></figure><p id="3e0c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">不要忘记点击测试规则，使规则实际上是生效和寻找资源！我们再次看到两个没有清理的实例。预计费用约为每月10美元，即每年约120美元。将其扩展到大型团队和整个AWS环境，现在我们可以节省大量成本。</p><p id="3900" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，这在警报中看起来如何？我们会收到一封精美的电子邮件，其中包含一个CSV文件，其中包含所有已确定的资源。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kz"><img src="../Images/c8dfe6e7bac6208d4e88a6cae3f98858.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0nrzZqMDDpMISzksRNMROA.png"/></div></div></figure></div><div class="ab cl jr js go jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="ha hb hc hd he"><p id="1aa8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">补救步骤，使用批准工作流程的自动化方法</strong></p><p id="dd4b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，我们已经确定了这些僵尸资源，让我们看看如何通过批准工作流创建一个简单的开箱即用的自动化补救。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div class="er es la"><img src="../Images/aea66a65618ad8eae4299936db2eb405.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*yFgY3HoWKj50fbrZldjkfg.png"/></div></figure><p id="0277" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如上所述，我们利用Stop EC2实例操作，将我自己作为该操作的批准者。我们也可以选择利用我们的朋友<em class="jc">透视组</em>选项来限制这一行动的范围。如果你还没有使用过Perspective，我强烈建议你开始研究它！</p><p id="3b2d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦行动被评估，我们会收到一封类似于上面看到的电子邮件，只是这次，我们可以选择“授权”行动，如下所示。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es lb"><img src="../Images/38c14893c51c126f1008fe3f73adbc06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q7ocrw6WA-SLko4d7LcvmQ.png"/></div></div></figure><p id="f9f6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦我们点击指令，我们会得到一个选项来授权并提供我们希望对其执行操作的帐户的访问密钥/秘密密钥。如果您担心访问密钥/秘密密钥的共享，它们永远不会被传递给CloudHealth服务。我们利用亚马逊AWS对跨对象资源共享(CORS)的支持，从AWS安全令牌服务请求一组临时安全凭证，该令牌进而用于代表您执行操作。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es lc"><img src="../Images/9a7af5b82c6d3aa0477d74ad0116776b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b6GP2Dp-vT-qqfTAvdrkXA.png"/></div></div></figure><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es ld"><img src="../Images/166fd7119c4440057b7edb1d42c75064.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K-TJrnzJN-iiGZQcXCTt5A.png"/></div></div></figure></div><div class="ab cl jr js go jt" role="separator"><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw jx"/><span class="ju bw bk jv jw"/></div><div class="ha hb hc hd he"><p id="cfea" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">利用λ函数进行修复</strong></p><p id="04ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，上面我们给出的回答是一个非常简单的问题。实际上，我们希望在关闭实例之前对EBS卷进行快照，如果没有任何迹象表明实例正在被使用，那么最终会终止。我们将在接下来的几个步骤中描述如何着手构建多步骤动作工作流。我们希望调用的高级步骤是:</p><ol class=""><li id="9f5f" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">一个lambda函数，用于对与定义的标准相匹配的实例进行快照。如果我们愿意，我们可以选择利用授权，但是因为我们在上面展示了它，我们将跳过这一个。</li><li id="1c70" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">等待5分钟，确保功能完成</li><li id="2acb" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">停止EC2实例，最后，</li><li id="a6fb" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">向#aws-cost通道发送一个时差通知，以便捕获事件。</li></ol><p id="b203" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们使用的lambda函数如下所示:</p><pre class="ka kb kc kd fd le lf lg lh aw li bi"><span id="32a2" class="lj lk hh lf b fi ll lm l ln lo">import sys<br/>import botocore<br/>import boto3<br/>from botocore.exceptions import ClientError<br/>from arnparse import arnparse</span><span id="e913" class="lj lk hh lf b fi lp lm l ln lo">def lambda_handler(event, context):<br/>    ec2 = boto3.resource('ec2', region_name='&lt;<strong class="lf hi"><em class="jc">insert region</em></strong> &gt;')<br/>    ec2_client= boto3.client('ec2')<br/>    lambdaFunc = boto3.client('lambda')<br/>    print('Trying to get Environment variable')<br/>    if event['resource_arns']:<br/>        for item in event['resource_arns']:<br/>            citem=arnparse(item)<br/>            if citem.resource_type=='instance':<br/>                ec2instance=str(citem.resource)<br/>                try:<br/>                    volumes=ec2_client.describe_instance_attribute(InstanceId=ec2instance, Attribute='blockDeviceMapping')<br/>                    VolumeId=volumes['BlockDeviceMappings'][0]['Ebs']['VolumeId']<br/>                    response = ec2.create_snapshot(VolumeId=VolumeId)<br/>                    print('Success :: snapshotting', ec2instance)<br/>                except ClientError as e:<br/>                    print(e)<br/>    else:<br/>        print("No resources found")</span><span id="4b07" class="lj lk hh lf b fi lp lm l ln lo">return { 'message' : "Script execution completed. See Cloudwatch logs for complete output" }</span></pre><p id="a324" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">CloudHealth的输出如下所示:</p><pre class="ka kb kc kd fd le lf lg lh aw li bi"><span id="e5c4" class="lj lk hh lf b fi ll lm l ln lo">{<br/>  "resource_arns": [<br/>    "arn:aws:ec2:<em class="jc">region</em>:<em class="jc">account-id</em>:instance:<em class="jc">instance-id</em>",<br/>  ],<br/>  "function_name": "ec2-testing-lambda",<br/>  "region": "<em class="jc">region</em>"<br/>}</span></pre><p id="e9fc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦在AWS控制台中创建了Lambda函数，大约需要15分钟该函数才能在CloudHealth中作为一个操作使用。一旦它可用，我们就可以构建一个如下所示的操作:</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div class="er es lq"><img src="../Images/1eb246e47fb8837cc5733c8c5140364c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*aR3dToeP8ip_9WIQMoSArg.png"/></div></figure><p id="55cb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">总之，我们利用Cloudhealth平台的一些现成功能，通过自动化审批工作流来帮助识别和终止僵尸EC2实例。此工作流将继续在后台运行，并且肯定有助于以自动方式收回未使用的资源。你还有其他想讨论的用例吗？请随意在下面写一行。</p><p id="fff4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">~ <a class="kv kw ge" href="https://medium.com/u/91f04d3c8a41?source=post_page-----852364479df7--------------------------------" rel="noopener" target="_blank">巴胡巴利·谢蒂</a>和<a class="kv kw ge" href="https://medium.com/u/30809b351432?source=post_page-----852364479df7--------------------------------" rel="noopener" target="_blank">帕布·巴拉蒂</a>(云宣传@ VMware)</p></div></div>    
</body>
</html>