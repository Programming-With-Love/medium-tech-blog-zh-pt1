<html>
<head>
<title>Rock-Solid K3s on OCI — part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">坚如磐石的Solid K3s第三部分</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/rock-solid-k3s-on-oci-part-3-129efce08b81?source=collection_archive---------1-----------------------#2022-11-16">https://medium.com/oracledevs/rock-solid-k3s-on-oci-part-3-129efce08b81?source=collection_archive---------1-----------------------#2022-11-16</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/1f6e556f001ac716126f961fbadbfdc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:724/format:webp/1*MOnRCw7YAniziVSZw-X4ig.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo by Leon Macapagal: <a class="ae it" href="https://www.pexels.com/photo/aerial-view-of-city-buildings-beside-water-6622898/" rel="noopener ugc nofollow" target="_blank">https://www.pexels.com/photo/aerial-view-of-city-buildings-beside-water-6622898/</a></figcaption></figure><p id="ffa1" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这是在OCI免费帐户中使用K3s系列的第三部分。如果您错过了前面的部分，您真的需要从头开始:</p><ul class=""><li id="d61e" class="js jt hh iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated"><a class="ae it" rel="noopener" href="/@timclegg/rock-solid-k3s-on-oci-part-1-dbfeaa69d670">第1部分—简介和OCI基础设施</a></li><li id="ef16" class="js jt hh iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><a class="ae it" rel="noopener" href="/@timclegg/rock-solid-k3s-on-oci-part-2-4f7b95faca88">第二部分— K3s安装</a></li></ul><p id="b548" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们现在准备设置我们新创建的K3s环境与OCI的集成。这是一个令人兴奋的方面，因为它将允许管理OCI负载平衡器、块存储卷等。</p><h1 id="d3ca" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">添加OCI容器注册凭据</h1><p id="b7a7" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated"><a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/Registry/home.htm" rel="noopener ugc nofollow" target="_blank"> OCI集装箱登记处</a> (OCIR)将用于存储集装箱图像。我们将为将要构建/部署的容器化应用程序使用私有容器注册中心。这意味着K3s将需要OCI证书，以便与私人集装箱登记处合作。</p><pre class="lj lk ll lm fd ln lo lp lq aw lr bi"><span id="9a72" class="ls kh hh lo b fi lt lu l lv lw">kubectl create secret docker-registry ocirsecret --docker-server=&lt;region&gt;.<a class="ae it" href="http://ocir.io/" rel="noopener ugc nofollow" target="_blank">ocir.io</a> --docker-username='&lt;namespace&gt;/&lt;username&gt;' --docker-password='&lt;OCI_auth_token&gt;' --docker-email='&lt;your_oci_email&gt;'</span></pre><p id="c808" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">查看一下<a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/Registry/Concepts/registryprerequisites.htm#regional-availability" rel="noopener ugc nofollow" target="_blank"> OCIR文档</a>，了解您所在地区的不同地区URL。</p><p id="cfe5" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">确保使用正确的用户名格式(<em class="lx"> &lt;名称空间&gt; / &lt;用户名&gt; </em>或者如果您使用的是IDCS，<em class="lx"> &lt;名称空间&gt;/Oracle identitycloudservice/&lt;用户名&gt; </em>)。密码将是与您的帐户相关联的身份验证令牌。查看<a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/Registry/Tasks/registrypullingimagesfromocir.htm" rel="noopener ugc nofollow" target="_blank"> OCI文档</a>了解更多信息。</p><h1 id="d153" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">设置<a class="ae it" href="https://github.com/oracle/oci-cloud-controller-manager" rel="noopener ugc nofollow" target="_blank"> OCI云控制器管理器</a></h1><p id="d2b9" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated"><a class="ae it" href="https://github.com/oracle/oci-cloud-controller-manager" rel="noopener ugc nofollow" target="_blank"> OCI云控制器管理器</a>与K8s(在这种情况下是K3s实现)和您的OCI帐户交互，管理OCI可能需要的负载平衡器(LBs)。</p><p id="f1fd" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">首先创建几个目录:</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="abe4" class="mb kh hh lo b be mc md l me lw">sudo mkdir /etc/kubernetes<br/>sudo mkdir /etc/oci</span></pre><p id="5de3" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">将以下内容放入<em class="lx">/etc/OCI/cloud-provider . YAML</em>(此时这应该是新创建的文件)。</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="f78e" class="mb kh hh lo b be mc md l me lw"># Copied from https://raw.githubusercontent.com/oracle/oci-cloud-controller-manager/master/manifests/provider-config-instance-principals-example.yaml<br/>useInstancePrincipals: true<br/>compartment: &lt;OCID of compartment&gt;<br/>vcn: &lt;OCID of k3s VCN&gt;<br/><br/>loadBalancer:<br/>  # subnet1 configures one of two subnets to which load balancers will be added.<br/>  subnet1: &lt;OCID of LB Subnet&gt;<br/>  securityListManagementMode: None<br/><br/>rateLimiter:<br/>  rateLimitQPSRead: 20.0<br/>  rateLimitBucketRead: 5<br/>  rateLimitQPSWrite: 20.0<br/>  rateLimitBucketWrite: 5</span></pre><p id="de24" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">示例(使用nano):</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="480c" class="mb kh hh lo b be mc md l me lw">sudo nano /etc/oci/cloud-provider.yaml</span></pre><p id="42b3" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">然后将内容(如上)与您的环境的值(OCIDs)粘贴在一起。</p><p id="71a6" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在在K3s中创建秘密:</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="ef9a" class="mb kh hh lo b be mc md l me lw">kubectl create secret generic oci-cloud-controller-manager -n kube-system --from-file=cloud-provider.yaml=/etc/oci/cloud-provider.yaml</span></pre><h1 id="070f" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">安装OCI云控制器管理器</h1><p id="91fd" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">在server1实例上运行以下命令:</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="747f" class="mb kh hh lo b be mc md l me lw">export RELEASE=$(curl -s "https://api.github.com/repos/oracle/oci-cloud-controller-manager/releases" | jq .[0].tag_name | tr -d "\"")<br/>kubectl apply -f https://github.com/oracle/oci-cloud-controller-manager/releases/download/${RELEASE}/oci-cloud-controller-manager-rbac.yaml<br/><br/>curl -L https://github.com/oracle/oci-cloud-controller-manager/releases/download/${RELEASE}/oci-cloud-controller-manager.yaml | sed 's/        node-role.kubernetes.io\/control-plane: ""/        node-role.kubernetes.io\/control-plane: "true"/g' &gt; oci-cloud-controller-manager.yaml<br/>kubectl apply -f oci-cloud-controller-manager.yaml</span></pre><p id="339b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">运行以下命令以获取运行窗格:</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="6263" class="mb kh hh lo b be mc md l me lw">kubectl -n kube-system get po</span></pre><p id="0410" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">它应该显示如下内容:</p><figure class="lj lk ll lm fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mf"><img src="../Images/e8bf235ce4b9353f8d2eb846e2c966b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hIOcTeeUwxcWgnqIdcKv4w.png"/></div></div></figure><h1 id="1e1d" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">配置SELinux</h1><p id="99e1" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">您可能会在某个时候看到一些SELinux错误，类似于以下内容(参见<em class="lx"> /var/log/messages </em>):</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="0514" class="mb kh hh lo b be mc md l me lw">Aug 26 05:45:54 server1 setroubleshoot[226499]: failed to retrieve rpm info for /sys/fs/cgroup<br/>Aug 26 05:45:55 server1 setroubleshoot[226499]: SELinux is preventing ip6tables from ioctl access on the directory /sys/fs/cgroup.</span></pre><p id="0bf7" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这可以通过运行以下命令来解决:</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="1b07" class="mb kh hh lo b be mc md l me lw">sudo ausearch -c 'ip6tables' --raw | audit2allow -M my-ip6tables<br/>sudo semodule -X 300 -i my-ip6tables.pp</span></pre><h1 id="3616" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">安装nginx-ingress</h1><p id="c5b0" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">我们将设置一个nginx入口控制器，它将允许我们通过一个负载均衡器路由不同服务的请求。我们将跟随</p><p id="8c44" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我们从下载最新的nginx ingress清单开始。沿着<a class="ae it" href="https://kubernetes.github.io/ingress-nginx/deploy/#oracle-cloud-infrastructure" rel="noopener ugc nofollow" target="_blank">方向</a>，运行:</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="b353" class="mb kh hh lo b be mc md l me lw">curl https://raw.githubusercontent.com/kubernetes/ingress-nginx/$(curl -s "https://api.github.com/repos/kubernetes/ingress-nginx/releases" | jq '.[] | [select(.tag_name | startswith("controller-"))]' | jq -cs '.[0] | .[].tag_name' | tr -d "\"")/deploy/static/provider/cloud/deploy.yaml &gt; ingress-nginx-test.yml</span></pre><p id="6993" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们需要修改我们刚刚创建的文件(<em class="lx"> ingress-nginx.yml </em>)中的服务，添加配置将要创建的OCI LB所需的注释:</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="03f3" class="mb kh hh lo b be mc md l me lw">&lt;snip&gt;<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  labels:<br/>    app.kubernetes.io/component: controller<br/>    app.kubernetes.io/instance: ingress-nginx<br/>    app.kubernetes.io/name: ingress-nginx<br/>    app.kubernetes.io/part-of: ingress-nginx<br/>    app.kubernetes.io/version: 1.3.1<br/>  name: ingress-nginx-controller<br/>  namespace: ingress-nginx<br/>  annotations:<br/>    oci.oraclecloud.com/load-balancer-type: "lb"<br/>    service.beta.kubernetes.io/oci-load-balancer-shape: "flexible"<br/>    service.beta.kubernetes.io/oci-load-balancer-shape-flex-min: "10"<br/>    service.beta.kubernetes.io/oci-load-balancer-shape-flex-max: "10"<br/>    service.beta.kubernetes.io/oci-load-balancer-subnet1: "&lt;LB Subnet OCID &gt;"<br/>    oci.oraclecloud.com/oci-network-security-groups: "&lt;LB NSG OCID&gt;"<br/>    service.beta.kubernetes.io/oci-load-balancer-security-list-management-mode: "None"<br/>    oci.oraclecloud.com/node-label-selector: "k3s.io/role=agent"<br/>spec:<br/>&lt;snip&gt;</span></pre><p id="6451" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">通过应用以下程序安装它:</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="7e83" class="mb kh hh lo b be mc md l me lw">kubectl apply -f ingress-nginx.yml</span></pre><p id="0bff" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">此时，您应该能够看到服务:</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="5a0c" class="mb kh hh lo b be mc md l me lw">kubectl get service -n ingress-nginx</span></pre><p id="528e" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您应该会看到如下所示的内容:</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="1105" class="mb kh hh lo b be mc md l me lw">$ kubectl get service -n ingress-nginx<br/>NAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)                      AGE<br/>ingress-nginx-controller-admission   ClusterIP      10.43.2.45      &lt;none&gt;           443/TCP                      9h<br/>ingress-nginx-controller             LoadBalancer   10.43.142.214   &lt;public_ip&gt;      80:30173/TCP,443:30297/TCP   9h<br/>$</span></pre><p id="8b67" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="lx">入口nginx控制器</em>上的<em class="lx">外部IP </em>字段将用于访问我们将要部署的不同应用。这是OCI负载平衡器(LB)使用的公共IP地址。</p><h1 id="6592" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">安装OCI集装箱存储接口(CSI)(可选)</h1><p id="52a6" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">这是一个可选步骤。如果您希望能够让OCI云控制器管理器管理OCI数据块卷(可能连接到一个pod)，这可能是您感兴趣的。</p><p id="dc16" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">以下步骤基于<a class="ae it" href="https://github.com/oracle/oci-cloud-controller-manager/blob/master/container-storage-interface.md" rel="noopener ugc nofollow" target="_blank"> CSI指示</a>:</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="b8fd" class="mb kh hh lo b be mc md l me lw">kubectl create secret generic oci-volume-provisioner -n kube-system --from-file=config.yaml=/etc/oci/cloud-provider.yaml<br/><br/>export RELEASE=export RELEASE=$(curl -s "https://api.github.com/repos/oracle/oci-cloud-controller-manager/releases" | jq .[0].tag_name | tr -d "\"")<br/>kubectl apply -f https://github.com/oracle/oci-cloud-controller-manager/releases/download/${RELEASE}/oci-csi-node-rbac.yaml<br/><br/>curl -L https://github.com/oracle/oci-cloud-controller-manager/releases/download/${RELEASE}/oci-csi-controller-driver.yaml | sed 's/        node-role.kubernetes.io\/master: ""/        node-role.kubernetes.io\/master: "true"/g' &gt; oci-csi-controller-driver.yaml<br/>kubectl apply -f oci-csi-controller-driver.yaml<br/><br/>kubectl apply -f https://github.com/oracle/oci-cloud-controller-manager/releases/download/${RELEASE}/oci-csi-node-driver.yaml<br/>kubectl apply -f https://raw.githubusercontent.com/oracle/oci-cloud-controller-manager/master/manifests/container-storage-interface/storage-class.yaml</span></pre><p id="1652" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">应用以上清单后，检查pod是否正在运行(可能需要一两分钟完成):</p><pre class="lj lk ll lm fd ln lo ly bn lz ma bi"><span id="24bd" class="mb kh hh lo b be mc md l me lw">kubectl -n kube-system get po | grep csi-oci-controller<br/>kubectl -n kube-system get po | grep csi-oci-node</span></pre><h1 id="a84a" class="kg kh hh bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">包装它</h1><p id="1163" class="pw-post-body-paragraph iu iv hh iw b ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn li jp jq jr ha bi translated">哇，我们在这个系列的这一部分已经完成了很多！我们已经设置了OCI云控制器，以及nginx入口控制器。接下来的事情是部署几个应用程序来看看这一切的行动。让我们在下一部分这样做…</p></div><div class="ab cl mg mh go mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ha hb hc hd he"><p id="2bd3" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">与此同时，请在<a class="ae it" href="https://bit.ly/odevrel_slack" rel="noopener ugc nofollow" target="_blank"> Oracle开发人员闲置频道</a>与我们聊天！</p></div></div>    
</body>
</html>