<html>
<head>
<title>Using Terraform with Oracle PaaS Service Manager (PSM)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Terraform与Oracle PaaS服务管理器(PSM)结合使用</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/using-terraform-with-oracle-paas-service-manager-psm-d21f2ddbae3f?source=collection_archive---------2-----------------------#2018-06-13">https://medium.com/oracledevs/using-terraform-with-oracle-paas-service-manager-psm-d21f2ddbae3f?source=collection_archive---------2-----------------------#2018-06-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="1a0a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">虽然面向Oracle云平台的<a class="ae jc" href="https://www.terraform.io/docs/providers/oraclepaas/index.html" rel="noopener ugc nofollow" target="_blank"> Terraform提供商</a>支持越来越多的资源用于在Oracle云上部署和供应<a class="ae jc" href="http://cloud.oracle.com/paas" rel="noopener ugc nofollow" target="_blank"> Oracle PaaS </a>服务，但该提供商目前并不支持所有的<a class="ae jc" href="https://www.oracle.com/cloud/what-is-paas/" rel="noopener ugc nofollow" target="_blank"> PaaS </a>服务。因此，如果您需要在Terraform配置中提供一项Oracle云平台提供商尚不支持的额外服务，该怎么办呢？一种方法是将Terraform与<strong class="ig hi">Oracle PaaS Service Manager(PSM)CLI</strong>工具结合使用。</p><h2 id="342f" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">将Terraform与PSM一起使用的限制</h2><p id="4271" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">在深入了解如何将PSM与Terraform结合使用的细节之前，有必要先强调一下这种方法的一些局限性。</p><ul class=""><li id="5e08" class="kd ke hh ig b ih ii il im ip kf it kg ix kh jb ki kj kk kl bi translated">PSM CLI必须安装在运行terraform的本地计算机上</li><li id="65c5" class="kd ke hh ig b ih km il kn ip ko it kp ix kq jb ki kj kk kl bi translated">使用PSM和Terraform创建服务仅处理创建/销毁用例。在Terraform中修改实例配置将导致实例被销毁和重新创建。</li><li id="dc90" class="kd ke hh ig b ih km il kn ip ko it kp ix kq jb ki kj kk kl bi translated">Terraform不会检测或纠正所需状态和当前配置状态之间的任何差异。</li><li id="87f6" class="kd ke hh ig b ih km il kn ip ko it kp ix kq jb ki kj kk kl bi translated">不要同时运行针对不同环境的多个配置任务，因为它们可能会覆盖彼此的设置。</li></ul><h1 id="fb3d" class="kr je hh bd jf ks kt ku jj kv kw kx jn ky kz la jq lb lc ld jt le lf lg jw lh bi translated">从Terraform调用PSM</h1><p id="5189" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">Terraform将使用<a class="ae jc" href="https://www.terraform.io/docs/provisioners/local-exec.html" rel="noopener ugc nofollow" target="_blank"> local-exec </a> provisioner调用PSM，因此PSM cli工具必须安装在运行Terraform的本地主机上。有关安装说明，请参考<a class="ae jc" href="https://docs.oracle.com/en/cloud/paas/java-cloud/pscli/abouit-paas-service-manager-command-line-interface.html" rel="noopener ugc nofollow" target="_blank"> PaaS服务管理器文档</a>。</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="b1fb" class="jd je hh ln b fi lr ls l lt lu">$ psm --version<br/>Oracle PaaS CLI client<br/>Version 1.1.23</span></pre><p id="e9e3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您完成了<a class="ae jc" href="https://docs.oracle.com/en/cloud/paas/java-cloud/pscli/configuring-command-line-interface.html" rel="noopener ugc nofollow" target="_blank">配置命令行界面</a>的步骤，您将会看到PSM工具针对一个目标环境配置了一组凭证，这些设置存储在<code class="du lv lw lx ln b">~/.psm/</code>下的本地用户帐户中。</p><p id="97fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了确保PSM针对Terraform正在配置的正确环境，我们需要在每组PSM配置命令之前调用<code class="du lv lw lx ln b">psm setup</code>，传入目标环境的详细信息。我们可以使用<code class="du lv lw lx ln b">local_file</code>资源来创建所需的安装配置文件</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="6c51" class="jd je hh ln b fi lr ls l lt lu">resource "local_file" "psm_setup" {<br/>  filename = "psm-setup-payload.json"<br/>  content  = &lt;&lt;JSON<br/>  {<br/>      "username":"${var.psm_user}",<br/>      "password":"${var.psm_password}",<br/>      "identityDomain":"${var.psm_domain}"<br/>  }<br/>JSON<br/>}</span><span id="36ed" class="jd je hh ln b fi ly ls l lt lu">data "local_file" "psm_setup" {<br/>  depends_on = [ "local_file.psm_setup" ]<br/>  filename = "${local_file.psm_setup.filename}"<br/>}</span></pre><p id="f939" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用<code class="du lv lw lx ln b">local-exec</code> provisioner调用<code class="du lv lw lx ln b">psm setup</code>，将本地配置文件名传递给<code class="du lv lw lx ln b">--config-payload</code>选项。</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="da57" class="jd je hh ln b fi lr ls l lt lu">resource ... {</span><span id="bc20" class="jd je hh ln b fi ly ls l lt lu">  provisioner "local-exec" {<br/>    command = "<strong class="ln hi">psm setup --config-payload</strong> ${<strong class="ln hi">data.local_file.psm_setup.filename</strong>}"<br/>  }<br/>  ...<br/>}</span></pre><p id="79c4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">任何后续的PSM调用现在都将针对已配置的环境。</p><h1 id="5bd8" class="kr je hh bd jf ks kt ku jj kv kw kx jn ky kz la jq lb lc ld jt le lf lg jw lh bi translated">使用PSM调配PaaS服务</h1><p id="a76d" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">PSM cli通过将服务配置JSON有效负载传递给所需服务的<code class="du lv lw lx ln b">create-service</code>动作来提供新服务。PSM文档中提供了每项服务的示例负载，通过从CLI运行help命令，例如</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="b266" class="jd je hh ln b fi lr ls l lt lu">$ psm IntegrationCloud create-service help</span></pre><p id="7dc3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了从Terraform调用PSM和所需的服务创建有效负载，我们遵循上面使用的相同模式来执行PSM设置，即:</p><ol class=""><li id="4df4" class="kd ke hh ig b ih ii il im ip kf it kg ix kh jb lz kj kk kl bi translated">使用<code class="du lv lw lx ln b">local_file</code>资源创建JSON有效负载，设置适当的属性值</li><li id="c9b7" class="kd ke hh ig b ih km il kn ip ko it kp ix kq jb lz kj kk kl bi translated">调用所需的PSM cli命令，引用配置文件</li></ol><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="1fcc" class="jd je hh ln b fi lr ls l lt lu">resource "local_file" "integration_service" {<br/>  filename = "integration-cloud-${var.service_name}-create-service.json"<br/>  content  = &lt;&lt;JSON<br/>  {<br/>    "vmPublicKeyText": "${file("~/.ssh/id_rsa.pub")}",<br/>    "featureSet": "ics",<br/>    "serviceName": "icsdemo1",<br/>    "description": "created by Terraform and PSM",<br/>    "cloudStorageContainer": "${var.backup_storage_container}",<br/>    "cloudStorageUser": "${var.backup_storage_user}",<br/>    "cloudStoragePassword": "${var.backup_storage_password}",<br/>    "confirmation": true,<br/>    "meteringFrequency": "HOURLY",<br/>    "components": {<br/>      "WLS": {<br/>       "dbServiceName": "${var.database_service_name}",<br/>       "dbaName": "${var.database_user}",<br/>       "dbaPassword": "${var.database_password}",<br/>       "managedServerCount": 2<br/>      }<br/>    }<br/>  }<br/>JSON<br/>}</span><span id="f2aa" class="jd je hh ln b fi ly ls l lt lu">data "local_file" "integration_service" {<br/>  depends_on = [ "local_file.integration_service" ]<br/>  filename = "${local_file.integration_service.filename}"<br/>}</span><span id="3402" class="jd je hh ln b fi ly ls l lt lu">resource null_resource "integration_service" {</span><span id="84fd" class="jd je hh ln b fi ly ls l lt lu">  triggers {<br/>    payload = "${md5(local_file.integration_service.content)}"<br/>  }</span><span id="a173" class="jd je hh ln b fi ly ls l lt lu">  provisioner "local-exec" {<br/>    command = "<strong class="ln hi">psm setup --config-payload</strong> ${<strong class="ln hi">data.local_file.psm_setup.filename</strong>}"<br/>  }<br/>  <br/>  provisioner "local-exec" {<br/>    command     = "<strong class="ln hi">psm IntegrationCloud create-service</strong> --wait-until-complete true <strong class="ln hi">--config-payload</strong> ${<strong class="ln hi">data.local_file.integration_service.filename</strong>}"  }</span><span id="e701" class="jd je hh ln b fi ly ls l lt lu">}</span></pre><p id="67e0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意<code class="du lv lw lx ln b">psm setup</code>命令在<code class="du lv lw lx ln b">create-service</code>之前执行，这是为了确保正确的环境设置应用于该特定部署。</p><p id="4748" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在<code class="du lv lw lx ln b">triggers</code>块中使用了配置内容的MD5散列，因此对配置的任何更改都将触发资源的重新创建。</p><h2 id="cd82" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">添加销毁时间置备程序</h2><p id="0878" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">为了确保PaaS服务在<code class="du lv lw lx ln b">terraform destroy</code>上被销毁，或者当服务定义发生变化并且需要重新创建实例时，我们需要添加一个销毁时间供应器。同样，除了要执行的主PSM命令之外，我们还调用<code class="du lv lw lx ln b">psm setup</code>来确保以正确的环境为目标，因为PSM配置在最初应用后可能已经更改。</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="6c5f" class="jd je hh ln b fi lr ls l lt lu">resource null_resource "integration_service" {<br/>  <br/>  ...</span><span id="95b6" class="jd je hh ln b fi ly ls l lt lu">  provisioner "local-exec" {<br/>    <strong class="ln hi">when        = "destroy"</strong><br/>    command     = "<strong class="ln hi">psm setup --config-payload</strong> ${<strong class="ln hi">data.local_file.psm_setup.filename</strong>}"<br/>  }</span><span id="f9db" class="jd je hh ln b fi ly ls l lt lu">  provisioner "local-exec" {<br/>    <strong class="ln hi">when        = "destroy"<br/></strong>    command     = "<strong class="ln hi">psm IntegrationCloud delete-service</strong> --wait-until-complete true <strong class="ln hi">--service-name ${var.service_name}</strong> --dba-name ${var.database_user} --dba-password ${var.database_password} --skip-backup-on-terminate ${var.skip_backup_on_terminate} --force true"<br/>  }<br/>}</span></pre><h1 id="cc3b" class="kr je hh bd jf ks kt ku jj kv kw kx jn ky kz la jq lb lc ld jt le lf lg jw lh bi translated">从PaaS服务实例获取属性</h1><p id="a699" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">已配置实例的属性，无论是使用上述方法配置的还是已经配置的，都可以使用PSM cli作为<code class="du lv lw lx ln b">external</code>数据源读回到Terraform中</p><p id="d364" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du lv lw lx ln b"><a class="ae jc" href="https://www.terraform.io/docs/providers/external/index.html" rel="noopener ugc nofollow" target="_blank">external</a></code>数据源类型执行返回JSON数据结构的本地命令，并将结果放入Terraform状态。不幸的是，Terraform并不完全支持从PSM命令返回的JSON样式，但是可以通过一个简单的包装器脚本提取所需的属性并返回一个简化的JSON响应来解决这个问题。</p><p id="5047" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面的<code class="du lv lw lx ln b">psm_get_jcs.sh</code>示例使用<code class="du lv lw lx ln b">jq</code>获取Java云服务实例响应并提取属性子集</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="fe4b" class="jd je hh ln b fi lr ls l lt lu">#!/usr/bin/env bash<br/># usage psm_get_jcs.sh &lt;service-name&gt;</span><span id="2d38" class="jd je hh ln b fi ly ls l lt lu">RESP=$(psm jcs service -s $1 -of json)</span><span id="75ce" class="jd je hh ln b fi ly ls l lt lu">echo $RESP | jq "{ service_name: .serviceName, fmw_root: .FMW_ROOT, wls_root: .WLS_ROOT }"</span></pre><p id="7ae7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以上只是一个有限的例子，根据您的具体需求添加附加属性。要测试包装器脚本的输出:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="2fdf" class="jd je hh ln b fi lr ls l lt lu">$ ./psm_get_jcs.sh jcsdemo1<br/><strong class="ln hi">{<br/>"service_name": </strong>"jcsdemo1"<strong class="ln hi">,<br/>"fmw_root": </strong>"https://129.144.208.50:7002/em"<strong class="ln hi">,<br/>"wls_root": </strong>"https://129.144.208.50:7002/console"<br/><strong class="ln hi">}</strong></span></pre><p id="66d8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当从数据源<code class="du lv lw lx ln b">external</code>调用包装器脚本时，从脚本返回的JSON属性在数据源<code class="du lv lw lx ln b">result</code>属性下可用。例如，获取Java云服务实例WLS服务实例的IP地址:</p><pre class="li lj lk ll fd lm ln lo lp aw lq bi"><span id="0ba1" class="jd je hh ln b fi lr ls l lt lu">data "external" "jcs" {<br/>  program = ["./psm_get_jcs.sh", "${var.service-name}"]<br/>}</span><span id="c73e" class="jd je hh ln b fi ly ls l lt lu">output "wls_ip" {<br/>  value = "${replace(element(split(":",data.external.jcs.<strong class="ln hi">result.wls_root</strong>),1),"////","")}"<br/>}</span></pre></div></div>    
</body>
</html>