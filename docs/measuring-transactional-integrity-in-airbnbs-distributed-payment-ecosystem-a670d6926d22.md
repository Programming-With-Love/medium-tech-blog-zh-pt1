# 衡量 Airbnb 分布式支付生态系统中的交易完整性

> 原文：<https://medium.com/airbnb-engineering/measuring-transactional-integrity-in-airbnbs-distributed-payment-ecosystem-a670d6926d22?source=collection_archive---------1----------------------->

## *在分布式支付生态系统中，准确测量和跟踪交易的端到端状态和内容以确保整个支付周期的一致性至关重要。*

*作者尼纳德·希斯蒂和威廉·贝茨*

![](img/34bfa9376685524d9d154ac09705f77e.png)

*在分布式支付生态系统中，准确衡量和跟踪交易的端到端状态和内容以确保整个支付周期的一致性至关重要。如果没有可靠的跟踪，可能会发生数据泄露和错误，从而导致支付周期中各方(包括消费者、商家、网关和收单机构)的收入损失或成本增加。在分布式支付系统中，交易完整性很难精确测量。在任何给定的交易中涉及多个系统和实体的情况下，跟踪支付状态可能是乏味的，并且难以及时获得。

借助大数据工具，Airbnb 正在通过各种支付状态追踪每笔交易的内容，以确保支付周期的每一部分都处于一致的状态。对账过程不仅产生数据和见解，使团队能够跟踪和减少意外的交易行为，而且使系统能够在检测到异常时“自我修复”。*

# 背景

随着支付技术的快速发展，商家在处理支付交易时面临着不断发展的局面。支付网关等新增值实体的出现为商家带来了越来越大的好处，通过提供保险服务和支付处理的单一 API 集成实现了简化。通过与支付网关的集成，Airbnb 已经能够通过各种处理实体在全球范围内快速扩展，而对我们的在线交易处理只需进行最小的更改。

也就是说，与任何新的增值实体的集成都是有成本的。支付过程中的每一个新实体都增加了一个额外的层次，交易的完整性可以在这个层次上受到影响。交易完整性的破坏会给社区成员带来麻烦，增加客户支持的工作量，以及运营效率开销。

# 什么是事务完整性？

通常，[事务](https://en.wikipedia.org/wiki/Database_transaction)代表在 RDMS(关系数据库管理系统)中执行的一个工作单元，具有[原子](https://en.wikipedia.org/wiki/Atomicity_(database_systems))、[一致](https://en.wikipedia.org/wiki/Consistency_(database_systems))、[隔离](https://en.wikipedia.org/wiki/Isolation_(database_systems))和[持久](https://en.wikipedia.org/wiki/Durability_(database_systems))属性。就支付而言，交易完整性代表了一种毫不意外的、准确的资金流动。金融交易的准确性可以通过各种属性来验证，如金额、货币、状态、支付方式，甚至是及时性。

在 Airbnb，交易完整性包括内部和外部资金流动。这意味着，我们不仅希望内部系统之间的支付属性完全一致，而且希望支付涉及的所有外部合作伙伴之间的支付属性完全一致。

# 问题陈述

Airbnb 是一个连接客人和主人的住宿平台，可以实现全球旅行。Airbnb 的支付是实现社区信任的关键因素，无论是在平台上还是平台外。为了保持这种信任，我们必须以最大的准确性正确处理客人和东道主社区之间的付款，这一点至关重要。

Airbnb 是一个全球品牌，在全球 190 多个国家和 40 多种货币中运营，包括难以触及的市场和支付生态系统中通常不支持的市场。在当今世界，全球转移资金的单一处理器关系根本不存在。因此，Airbnb 集成了少数网关和数十个处理器，以实现全球覆盖和支付冗余。该系统包括系统成熟度不同、集成模式不同(API 调用、批处理和 URL 重定向)以及交易结算周期差异很大的处理器。例如，Airbnb 支持处理完全同步的支付方式，如各大信用卡/借记卡网络，以及可能需要几天才能结算的支付方式，如[巴西 Boletos](https://business.ebanx.com/en/blog/boleto-bancario-everything-you-need-to-know) 。

![](img/a998d88c154a1e8add805e2ac0159f6c.png)

Diagram Depicting Various Payment Integration Methods At Airbnb

对于一个传统的在线商家来说，在线购物的结果是资金流入系统。然而，最近随着共享经济的兴起，我们开始见证双边市场的增长。Airbnb 就是这样一个例子——连接全世界的旅行者和主人。因此，Airbnb 的支付处理双向资金流动，不仅处理向我们平台的支付，还处理所有向主机的支付。

流出到我们主机的很大一部分资金是通过批处理与银行直接集成的。批量交易处理包括两个步骤。首先，我们以符合规范的格式向银行发送一组交易请求。然后，我们处理银行发回的响应文件，其中包含对交易请求的响应。虽然批处理适合处理较大的事务量，但是批处理本质上使我们的系统不同步，直到批处理响应文件被处理。因为这个过程可能需要几个小时才能完成，所以批处理被证明是维护事务完整性的一个困难的障碍。

即使在 Airbnb 交易的最简单的例子中，客人和主人之间的预订，也至少有两个金融交易与之相关联。第一笔金融交易发生在客人向 Airbnb 支付预订费用时，第二笔发生在 Airbnb 在提供服务后几小时内向主人付款时。然而，旅行计划的变化比我们想象的更频繁。附加支付功能，如变更、存款/分期付款、团体旅行、预扣税、增值税等。所有这些都大大增加了与预订相关的金融交易的数量和复杂性。此外，Airbnb 平台上的许多预订是跨境的，涉及多种货币，这进一步增加了我们资金流动的复杂性。

# Airbnb 的“新”支付网关

Airbnb 的市场近年来出现了爆炸式增长，支付是扩张的关键支撑。直到最近几年，Airbnb 的大部分业务和金融交易逻辑都是在一个单一的 rails 应用程序中执行的。为了提高可扩展性，Airbnb 在面向服务的架构上进行了大量投资。作为这一战略的一部分，我们着手构建一个内部支付网关，以封装各种处理器之间的所有网络通信，并处理应用程序执行资金流动的“负担”。我们新的支付网关是一个具有专用数据存储的 Java 服务。该数据存储托管各种支付方式，并作为金融交易的记录系统。

这种新服务代表了交易完整性的两种不同挑战。首先，额外的内部网关会增加支付执行过程中的跳数，如果它的行为不一致或无法处理网关或处理器响应，将会产生“不同步”交易。其次，当我们在新的支付网关上增加流量时，将有两个采用 Airbnb 内部系统的交易商店——一个传统交易商店和一个新的支付网关交易商店。在任何长时间内，我们都承受不起两个数据存储区的一致性出现任何偏差。这两个挑战保证了对事务完整性的额外考虑。

# 什么是“不同步”事务？

如果支付处理链中的任何系统未能响应和/或其后续系统未能正确使用资金流动的响应，就会产生“不同步”交易。此外，链中任何实体对 API 响应的不正确处理都会导致“不同步”的事务。

![](img/ac8fe43c88a4c79a01d3991ee0ada920.png)

Diagram Depicting Various Entities Payment Must Be Passed Through During The Payment Process

# 解决方案简介

及时测量这个分布式系统迷宫中的事务完整性，并随后检测和响应任何异常是一个挑战。使用许多不同成熟度的系统，几乎不可能通过不同系统(平台、支付网关、支付处理器等)中的各种状态来即时跟踪交易。—任何时候。

想到的一个潜在解决方案是使用支付网关 API 进行交易记录比较。这种方法的缺点是很难使用 API 来衡量内部事务存储和外部事务存储之间的比较。事实上，一些外部实体甚至不通过 API 提供这些信息。此外，可能需要专用的比较系统来执行对实体的 API 调用以进行事务分析，从而避免对实时流量的任何潜在影响，这是大多数 web 服务无法容忍的情况。

# Airbnb 的处理器交易报告系统

几乎所有的处理器和网关都通过安全文件传输协议(SFTP)向商家提供交易报告和详细信息。这些交易报告是在商定的 SLA 内作为结算的一部分提供给商家的。通常，商家通过平台交易记录、处理器结算文件和银行对账单之间的三方对账来对账平台上的所有资金流动。Airbnb 有一项专门的服务，可以导入、提取和导出每个处理器文件。具体而言，该服务:

*   将每日交易报告从我们的支付合作伙伴导入 S3，
*   将报告提取到特定于报告的临时表中，
*   以一致的格式导出这些报告。

此外，它还具有检测重复文件和避免重复处理同一文件的逻辑。许多处理器/网关以 CSV 格式提供这些报告，并且每个实体在报告中使用它们自己的词汇。这些交易详细信息随后存储在数据存储中，并作为导出的一部分发送出去进行核对。

![](img/5a532c6c3d7bb66860dc753c1424d441.png)

Diagram Depicting Overall TI Pipeline

Airbnb 的系统使用一组预定的作业在专用服务器上执行这些活动。虽然该系统无法访问 Airbnb 的平台交易，但我们能够使用额外的工具来组合这些数据源，以端到端地跟踪交易。每个数据库的快照在 HDFS 定期可用。这使得在不离开网络边界的情况下跟踪整个生态系统中的交易成为可能。这还意味着这是一个 IO 绑定问题。大数据技术非常适合通过 map-reduce 解决大规模数据比较问题。

# 综合解决方案

因此，我们决定采用分段的方式来解决这个问题，将所有支付活动分为四大类——支付、退款、支出和退货。每个类别都有一个专用的 hive 管道，用于为该类别内所有内部和外部支付实体的所有交易生成交易级报告。这提供了理解类别内和类别间趋势的能力。通过计算这些组合类别的移动平均值，我们能够产生一个数字来代表 Airbnb 支付生态系统中的交易完整性。这个数字使我们能够衡量改进，发现问题，并设定一个总体目标。

通过这种方法，我们能够定期跟踪自零日(Airbnb 的支付网关开始接收大量流量的那一天)以来每个阶段的每笔交易。创建了一个类别中所有交易的规范化视图后，可以根据发现的异常类型对异常交易进行进一步分组。然后，异常属性可以直接与业务用例联系起来，比如延迟支付或不匹配的事务属性。由于具有类似异常的事务通常需要类似的数据补救和/或代码修复，这些错误分组有助于我们确定修复工作的优先级。

![](img/8ae823f123f33b808757034133599239.png)

Bird’s Eye View Transactional Integrity Status

![](img/fb67b3e7bfeb9d4d82a580ecb52f44a8.png)

Chart Depicting Categorical Transactional Integrity Status

# 使用传统工具进行支付对账是不够的

交易完整性计划在许多方面不同于支付对账流程。交易完整性测量需要从第零天(假设定义的系统开始日期)开始比较每一笔交易，而对账通常会遗漏已经匹配的交易。完整性测量技术还可以扩展到任何数量的保存交易记录的系统—这可以包括一个以上的内部/外部系统。

通常支付对账是通过匹配平台和处理器单独交易来完成的。这排除了交易完整性可能崩溃的关键环节，因为它不提供流程每个阶段的比较结果，而仅提供总体情况。付款对账是通过匹配一组识别属性来完成的，而不是在两个模型之间执行深度比较。我们分析的许多第三方对账技术集中在会计方面，并提供了流程管理工具包，但这些功能并不直接有助于交易完整性。

此外，付款对账只在资金换手时进行。但是，有一些交易类型(如撤销授权)资金不会移动，但仍可能对我们的客户和/或系统性能产生影响。为了维护一个健康的支付系统，比较*所有*类型的交易而不是一个子集是很重要的。

# 大数据工具包— Hive、Hadoop、HDFS、气流和 S3

Hive 能够用最少的解释直接比较不同模式表示的不同事务模型，而不需要任何额外的集成。这给了我们快速迭代解决方案的能力。Hive 提供了一个类似 SQL 的接口来查询数据，但它最大的优势是有效地执行大规模的 map-and-reduce 作业。有了它，就有可能比较整个生态系统中每一笔交易的各种交易属性，如金额、货币、使用的工具、交易代码、状态等。

Hadoop 还提供了可伸缩性，其 [MapReduce](https://en.wikipedia.org/wiki/MapReduce) 机制非常适合大型和不断增长的数据集之间的比较。HDFS 让我们能够定期对事务完整性进行快照，以生成一段时间内有意义的趋势。亚马逊 S3 为归档目的提供了一个经济高效的数据存储库，并与我们的大数据工具包有效配合。Airbnb 开发的服务 Airflow 提供了一个调度工具来编排数据操作，允许我们执行中间计算的各个步骤，并生成交易级别的报告。

# **监控交易完整性(Druid、超集和自动化报告)**

仪表板和自动化报告对于提高组织对系统问题的认识以及提供长期衡量绩效的工具至关重要。如果没有清晰的报告，及时识别影响客户和业务的事件通常既困难又耗时。

在 Airbnb，我们能够利用基于低延迟分布式数据存储库 [Druid](http://druid.io/) 构建的 OLAP 系统，来接收我们的交易管道，并以可扩展的方式交互探索大数据。利用[超集](/airbnb-engineering/superset-scaling-data-access-and-visual-insights-at-airbnb-3ce3e9b88a7f)作为仪表板工具，我们能够不断显示整个支付系统的最新健康指标。借助我们报告工具中内置的强大支付分类，我们能够看到各种系统问题随时间推移的进展情况，在某些情况下，这些趋势有助于我们以可扩展的方式处理大量历史问题，从而管理这些问题。

![](img/98e0d372a0d249faa142d78db519484d.png)

Chart Depicting Anomaly Detection Example

异常检测是我们交易完整性项目的另一个重要成果。我们的 OLAP 系统使我们能够轻松配置跨各种维度切割的异常检测算法，在我们的数据管道着陆后不久，就可以自动通过电子邮件/slack 通知任何异常情况。

# 交易完整性分析的主要成功之处

事务完整性分析帮助我们识别和确定问题的大小，从简单的集成错误到围绕最终一致性的更细微的边缘情况。它还帮助我们微调各种系统参数，如套接字超时、错误处理和重试机制。

在事务完整性数据和辅助工具的帮助下，在不同步的事务影响到我们的社区之前主动同步它们变得更加容易。这不仅大大减少了数量大、复杂性低的支持请求，还极大地改善了支付对账，带来了更准确的财务报告和简化的运营。

深度数据分析还帮助我们轻松监控和了解处理器问题和不当行为。在我们的分析框架之上构建强大的警报功能，使我们的系统能够主动通知我们在线交易处理中的处理器故障或缺失/不符合 SLA 的交易报告。

# 展望未来

虽然迄今为止，我们在监控和改善交易完整性数据方面取得了很大进展，但要实现完美的交易完整性，未来仍有许多工作要做。

如今，在 Airbnb，我们的系统旨在通过自动重试失败的交易来实现“最终一致性”。重试解决了由于超时、瞬时系统问题、网络连接丢失、中断等原因，我们的系统没有在允许的时间范围内从下游处理实体收到反馈的情况。这使我们的系统能够与我们的处理伙伴“同步”。

然而，安全地重试一个支付请求需要一个强大的幂等保证来执行一个且只有一个资金移动，这对于每一个可能的用例来说都很难实现。通过事务完整性分析，我们了解了如何处理打破幂等性保证的各种边缘情况，并且我们正在重新设计我们的框架，以实现近乎完美的幂等性。

此外，为了在整个分布式系统中有效地跟踪事务，需要跨处理器的规范化事务分类。事务完整性的计算要求所有数据在 Hive 中都可用。事件驱动的方法可以帮助我们很好地解决这两个问题，方法是设计一个标准化的结算事件模式，每个处理器记录系统都可以使用它来共享其活动。这些结算事件可以有选择地用网关信息来修饰，并且可以在我们的数据仓库中被捕获，以允许交易完整性测量和分析。它们也可以由我们的在线交易系统使用，或者流入创建票据、提供实时分析和自动修复底层交易以实现一致性的工具。

如果你有兴趣研究复杂的分布式支付系统，或者给我们的交易完整性数字增加一个额外的“9”，这甚至可能需要重建我们支付系统的某些部分，Airbnb 正在[招聘](https://www.airbnb.com/careers/departments/engineering/payments)！

*对卢·科萨克的思想领导力和原型大呼小叫。非常感谢 Sam Wyman、Alice Liang、Khaled Hussein、Brian Wey 和 Cynthia Adams 的慷慨捐助。*