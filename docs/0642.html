<html>
<head>
<title>Better physical stories with Google’s Nearby APIs (Part 1 of 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">更好的谷歌附近的API的物理故事(第1部分，共3部分)</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/better-physical-stories-with-googles-nearby-apis-280be707bbf9?source=collection_archive---------5-----------------------#2021-06-18">https://medium.com/androiddevelopers/better-physical-stories-with-googles-nearby-apis-280be707bbf9?source=collection_archive---------5-----------------------#2021-06-18</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/eb44040e259fe55db7f5f3a96e4a7c4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zdLrTw5bUlC0kkiKCXFllA.png"/></div></div></figure><div class=""/><p id="52c6" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">作为Google Play服务的一部分，谷歌向那些希望通过将物理上的接近融入到他们的故事中来增强其最终用户体验的开发者提供附近API。附近的API基于许多不同的技术，如蓝牙和Wi-Fi。然而，您不需要了解这些技术中的任何一种就可以获得它们的所有好处。附近的API抽象掉了所有这些细节，留给你一个即插即用的界面，让你专注于应用的业务逻辑。</p><p id="6412" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Nearby专注于需要物理距离的开发者之旅。API将这些物理通信分为三类:</p><ul class=""><li id="6d1e" class="jn jo hs ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated"><a class="ae jw" href="https://developers.google.com/nearby/messages/overview" rel="noopener ugc nofollow" target="_blank">单向消息检测</a></li><li id="f7ac" class="jn jo hs ir b is jx iw jy ja jz je ka ji kb jm js jt ju jv bi translated"><a class="ae jw" href="https://developers.google.com/nearby/connections/overview" rel="noopener ugc nofollow" target="_blank">双向通信</a></li><li id="1e70" class="jn jo hs ir b is jx iw jy ja jz je ka ji kb jm js jt ju jv bi translated">使用<a class="ae jw" href="https://developers.google.com/nearby/fast-pair/spec" rel="noopener ugc nofollow" target="_blank">快速配对</a>进行设备配对</li></ul><p id="e73b" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们将教你如何使用这些选项和它们的好处。</p><p id="d555" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们将从<em class="kc">消息检测</em>开始，演示如何以及为什么您可以将<a class="ae jw" href="https://developers.google.com/nearby/messages/overview" rel="noopener ugc nofollow" target="_blank">附近的消息API </a>集成到您的应用程序中。然后，我们将带您浏览几个场景，在这些场景中，<a class="ae jw" href="https://developers.google.com/nearby/connections/overview" rel="noopener ugc nofollow" target="_blank">near Connections API</a>的<em class="kc">双向通信</em>功能可能会让您的应用受益。最后，我们将解释<em class="kc">设备配对</em>与<a class="ae jw" href="https://developers.google.com/nearby/fast-pair/spec" rel="noopener ugc nofollow" target="_blank">快速配对</a>及其对最终用户的好处。</p><p id="d9cf" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因为Nearby是一个Google Play服务API，它只能在带有<a class="ae jw" href="https://play.google.com/store?&amp;utm_source=na_Med&amp;utm_medium=hasem&amp;utm_content=Nov0520&amp;utm_campaign=Evergreen&amp;pcampaignid=MKT-EDR-na-us-1000189-Med-hasem-py-Evergreen-Nov0520-Text_Search_BKWS-id_100752_%7cEXA%7cONSEM_kwid_43700045371544949&amp;gclid=Cj0KCQjwna2FBhDPARIsACAEc_VuoRETPMZbx6nqYga7yxX7E7larJfJwpAUNma5bgtA_1xB9k_zBRoaAvaeEALw_wcB&amp;gclsrc=aw.ds" rel="noopener ugc nofollow" target="_blank">谷歌Play商店</a>的Android设备上使用。</p><h1 id="a54e" class="kd ke hs bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">用附近的消息收回你的物理空间</h1><h2 id="b118" class="lb ke hs bd kf lc ld le kj lf lg lh kn ja li lj kr je lk ll kv ji lm ln kz lo bi translated">附近系列的第1部分</h2><p id="4682" class="pw-post-body-paragraph ip iq hs ir b is lp iu iv iw lq iy iz ja lr jc jd je ls jg jh ji lt jk jl jm ha bi translated">移动技术使我们能够通过从用户体验中移除距离来重新定义距离。Gmail和Meet等消息应用程序，以及Docs和Sheets等生产力应用程序，使人们能够实时聊天、聚会和协作，而不管他们在地球上的物理位置如何，也不管他们是否在地球上。</p><p id="d5f3" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">有些时候，让技术意识到物理上的接近可以让我们的体验更加神奇。以下是几个例子:</p><ul class=""><li id="eabb" class="jn jo hs ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated">一群朋友注意到彼此的存在，可以在购物中心的美食广场一起享受即兴午餐</li><li id="4915" class="jn jo hs ir b is jx iw jy ja jz je ka ji kb jm js jt ju jv bi translated">当超级购物者走进他们最喜欢的百货商店时，他们被提醒可以享受15%的折扣，作为对他们业务的感谢。</li><li id="3073" class="jn jo hs ir b is jx iw jy ja jz je ka ji kb jm js jt ju jv bi translated">一个本地新闻应用程序将本地媒体结合起来，捕捉不同的观点并进行实时合作。</li></ul><p id="ce3f" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">考虑到这些关键的用户旅程，附近的消息API允许您的应用程序的感兴趣的用户在物理上非常接近时检测到彼此——无论用户是在Android还是iOS上。API为您处理面向用户的权限请求:API检查应用程序的权限并向用户请求权限，然后用户可以授予所需的权限。为了让API工作，发布消息的用户必须授予应用程序<a class="ae jw" href="https://developer.android.com/reference/android/Manifest.permission#BLUETOOTH" rel="noopener ugc nofollow" target="_blank">蓝牙权限</a>，希望接收消息的用户必须授予应用程序蓝牙和<a class="ae jw" href="https://developer.android.com/reference/android/Manifest.permission#ACCESS_FINE_LOCATION" rel="noopener ugc nofollow" target="_blank">位置权限</a>(注意，从Android S开始，用户不再需要授予位置权限来接收广播)。</p><p id="5f87" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">API将近距离定义为大约100米的半径，但允许大约5英尺的圆。</p><p id="4817" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要在您的项目中使用附近的API，请包含以下Gradle依赖项(始终使用最新版本的<a class="ae jw" href="https://developers.google.com/nearby/messages/android/get-started#step_4_configure_your_project" rel="noopener ugc nofollow" target="_blank"/>):</p><figure class="lu lv lw lx fd hj"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="271e" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">附近的消息API通过将设备分组为<em class="kc">发布者</em>或<em class="kc">订阅者</em>来工作:</p><ul class=""><li id="c6f5" class="jn jo hs ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated"><em class="kc">发布器</em>是一种发送广播消息向任何可能感兴趣的人宣布其存在的设备。</li><li id="19a2" class="jn jo hs ir b is jx iw jy ja jz je ka ji kb jm js jt ju jv bi translated"><em class="kc">订户</em>是对某些出版物表示出兴趣的设备。</li></ul><p id="1f6f" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">比如我和我所有的朋友都是ExampleApp的狂热用户。我使用ExampleApp将我的午餐地点广播给我附近的任何一个朋友，他们都表示有兴趣听我的消息。</p><p id="6bc3" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">ExampleApp将允许我朋友的设备检测来自我的设备的广播，因此尽管广播本身是无差别的，但ExampleApp负责通过仅提醒我的朋友我的活动来使其有用。</p><p id="51ee" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了更好地理解API是如何实现其目标的，让我们来看看这些事务实际上是如何发生的。假设有三个设备，其中设备X是发布者，设备Y和Z是订阅者。这三个设备都在使用ExampleApp。</p><ol class=""><li id="72c3" class="jn jo hs ir b is it iw ix ja jp je jq ji jr jm ma jt ju jv bi translated">设备X发布消息(例如“Hello World”)。</li><li id="01cf" class="jn jo hs ir b is jx iw jy ja jz je ka ji kb jm ma jt ju jv bi translated">ExampleApp设备X上的App将消息上传到附近的Google服务器，并收到一个随机的UUID作为响应(比如“Hello World”= &gt; 123)。</li><li id="1e66" class="jn jo hs ir b is jx iw jy ja jz je ka ji kb jm ma jt ju jv bi translated">设备X开始BLE广告，广告该UUID直到发布停止。</li><li id="c0de" class="jn jo hs ir b is jx iw jy ja jz je ka ji kb jm ma jt ju jv bi translated">设备Y和Z检测到BLE广告。</li><li id="067f" class="jn jo hs ir b is jx iw jy ja jz je ka ji kb jm ma jt ju jv bi translated">使用Wi-Fi，设备Y和Z将UUID上传到附近的服务器。</li><li id="63d3" class="jn jo hs ir b is jx iw jy ja jz je ka ji kb jm ma jt ju jv bi translated">如果UUID和应用程序的签名完全匹配，谷歌附近的服务器就会返回原始信息。(附近的API提供了app“签名”所以不用担心那部分。)</li><li id="1a91" class="jn jo hs ir b is jx iw jy ja jz je ka ji kb jm ma jt ju jv bi translated">ExampleApp现在可以以任何创造性的方式使用X接近Y和Z的知识。</li></ol><figure class="lu lv lw lx fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es mb"><img src="../Images/082157024331890b7ebd04f4ba02d412.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*m1WbSDvQyfRjI70f"/></div></div></figure><p id="0d4d" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir ht">图1:附近的消息流</strong></p><p id="08bf" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您的用户不需要拥有Google帐户就可以使用附近的消息API。然而，因为你的应用将使用谷歌附近的服务器，你需要一个<a class="ae jw" href="https://accounts.google.com/signup/v2/webcreateaccount?continue=https%3A%2F%2Faccounts.google.com%2FManageAccount%3Fnc%3D1&amp;flowName=GlifWebSignIn&amp;flowEntry=SignUp" rel="noopener ugc nofollow" target="_blank">谷歌账户</a>来注册你的应用。</p><p id="2231" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一旦你创建了一个谷歌账户，你必须通过<a class="ae jw" href="https://console.developers.google.com/flows/enableapi?apiid=copresence&amp;keyType=CLIENT_SIDE_ANDROID&amp;reusekey=true" rel="noopener ugc nofollow" target="_blank">谷歌开发者控制台</a>完成获取API密钥的典型过程:</p><ol class=""><li id="e8c1" class="jn jo hs ir b is it iw ix ja jp je jq ji jr jm ma jt ju jv bi translated">转到<a class="ae jw" href="https://console.cloud.google.com/apis/credentials" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/apis/credentials</a></li><li id="e13a" class="jn jo hs ir b is jx iw jy ja jz je ka ji kb jm ma jt ju jv bi translated">点击“<em class="kc"> +创建凭证</em>”并选择“<em class="kc"> API密钥</em></li><li id="a891" class="jn jo hs ir b is jx iw jy ja jz je ka ji kb jm ma jt ju jv bi translated">复制创建的API密钥，并将其粘贴到Android项目的清单文件中</li></ol><figure class="lu lv lw lx fd hj"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="ea92" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">开发者现在可以使用<code class="du mc md me mf b">Nearby.getMessagesClient(this).publish(mMessage)</code>发布消息，其中<code class="du mc md me mf b"> message</code>代表你想要广播的<code class="du mc md me mf b">Message</code>。</p><p id="d53b" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你是一个<em class="kc">用户</em>，你不需要一个<code class="du mc md me mf b">Message</code>，只需要一个回叫来接收信息。</p><figure class="lu lv lw lx fd hj"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="4890" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">同一个应用程序可以既是发布者又是订阅者。例如，如果我和我的朋友都想在商场找到对方共进午餐，那么很有可能我们都在广播我们共进午餐的意图，同时又在倾听对方。</p><p id="62cb" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">非常重要的一点是，一旦用户离开你的应用程序中提示他们使用附近功能的功能，就要停止发布和订阅，以节省电池和保护用户隐私。</p><p id="813b" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要停止发布，请致电:</p><figure class="lu lv lw lx fd hj"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="157c" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要停止订阅，请致电:</p><figure class="lu lv lw lx fd hj"><div class="bz dy l di"><div class="ly lz l"/></div></figure><h1 id="ba16" class="kd ke hs bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">最佳实践</h1><p id="0c13" class="pw-post-body-paragraph ip iq hs ir b is lp iu iv iw lq iy iz ja lr jc jd je ls jg jh ji lt jk jl jm ha bi translated">我们不建议使用附近的服务器来回发送消息(即使这是可能的)。</p><p id="63ff" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">首先，“Hello World”消息没有加密，你不应该通过附近的服务器发布敏感信息。相反，一旦您通过附近的API验证了物理上的接近，您就可以转换到类似于<a class="ae jw" href="https://firebase.google.com/docs/cloud-messaging" rel="noopener ugc nofollow" target="_blank">Firebase Cloud Messaging</a>(FCM)的东西来继续通信。</p><p id="ab73" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">其次，如果您持续使用附近的服务器作为消息服务，电池寿命可能会受到影响。</p><p id="bcd5" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">附近的消息API可以在前台模式或后台模式下运行。在后台模式下，电池消耗很少，因为当你打开屏幕时，API只扫描几秒钟。然而，在前台模式下，API将一直扫描，这意味着如果屏幕关闭并且附近的消息发现了信标，它最终会唤醒应用处理器，而这些唤醒是非常昂贵的，通常是正常电池消耗率的2.5倍至3.5倍。</p><p id="0199" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因此，如上所述，一旦你与附近的消息建立了邻近关系，你应该过渡到像<a class="ae jw" href="https://firebase.google.com/docs/cloud-messaging" rel="noopener ugc nofollow" target="_blank">Firebase Cloud Messaging</a>(FCM)这样的服务，而不是依赖附近的消息进行持续的通信。</p><h1 id="af93" class="kd ke hs bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">摘要</h1><p id="d5d1" class="pw-post-body-paragraph ip iq hs ir b is lp iu iv iw lq iy iz ja lr jc jd je ls jg jh ji lt jk jl jm ha bi translated">附近的消息API非常适合设备间的单向通信。它允许设备向感兴趣的人广播消息，API可以在Android和iOS上使用。</p><p id="923e" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">有关如何利用附近消息API的更多信息，请访问我们的<a class="ae jw" href="https://developers.google.com/nearby/messages/overview" rel="noopener ugc nofollow" target="_blank">文档</a>和<a class="ae jw" href="https://github.com/android/connectivity-samples/tree/main/NearbyMessagesDevices" rel="noopener ugc nofollow" target="_blank">示例</a>。请继续关注本系列的第2部分，我们将讨论附近的连接API。</p><p id="55c1" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">查看本博客系列的第2部分，点击<a class="ae jw" rel="noopener" href="/androiddevelopers/two-way-communication-without-internet-nearby-connections-b118530cb84d?source=user_profile---------1----------------------------">查看更多内容。</a></p></div></div>    
</body>
</html>