<html>
<head>
<title>Open-sourcing PINRemoteImage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开源PINRemoteImage</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/open-sourcing-pinremoteimage-ae83ee0f3e8a?source=collection_archive---------0-----------------------#2015-07-24">https://medium.com/pinterest-engineering/open-sourcing-pinremoteimage-ae83ee0f3e8a?source=collection_archive---------0-----------------------#2015-07-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="8431" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Garrett Moon | Pinterest工程师，iOS</p><p id="27dc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本周<a class="ae jc" href="http://www.oscon.com/open-source-2015/public/schedule/detail/41854?cmp=tw-prog-confsched-info-os15_sessions" rel="noopener ugc nofollow" target="_blank">我们宣布</a>开源<a class="ae jc" href="https://github.com/pinterest/PINRemoteImage" rel="noopener ugc nofollow" target="_blank"> PINRemoteImage </a>，这是一个我们用来每天下载超过30亿张图片到Pinterest iOS应用程序并快速呈现给数千万Pinners的库。因此，如果你有一个图像密集型应用程序，这项技术允许你下载、缓存(在磁盘和内存上)和预取图像，以可靠地向用户显示图像，而不是编写新的代码。与其他类似技术不同，PINRemoteImage在避免死锁的同时保持了以下特性，甚至可以改善慢速连接的体验。</p><p id="5854" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">PINRemoteImage功能包括:</p><ul class=""><li id="f70f" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">下载和处理优先级</li><li id="5abe" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">主线程外的图像解压缩</li><li id="359c" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">吸引人的模糊渐进JPEGs</li><li id="c9ff" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">图像后处理</li><li id="9451" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">根据最近的网络状况自动选择和下载不同的图像</li><li id="1860" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">可选支持<a class="ae jc" href="https://github.com/Flipboard/FLAnimatedImage" rel="noopener ugc nofollow" target="_blank">FLAnimatedImage</a>(Flipboard的GIF库)</li><li id="e20e" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">对WebP的可选支持</li><li id="fcb7" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">从不阻塞主线程</li></ul><h2 id="2540" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">动机</h2><p id="c707" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">显示远程图像是Pinterest功能的核心部分，因此图像的下载和显示需要简单高效。有许多现有的库提供这种类型的功能，但我们发现它们通常有局限性，例如当同时请求大量图像时会出现死锁，或者只有当所有下载的图像大小相同时才能提高效率。PINRemoteImage诞生于对高效、线程安全的图像下载库的需求。</p><h2 id="7941" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">它是如何工作的</h2><p id="16af" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">要下载一个图像并在UIImageView上设置它，最简单的方法是使用内置的category方法setImageFromURL:。调用这个函数可以处理从下载图像到缓存图像并在UIImageView上设置图像的所有事情。PINRemoteImage已经包含了几个类别，但是通过实现一个定义好的协议PINRemoteImageCategory，编写一个新的类别变得很容易。实现这个协议进一步简化:几乎所有实例方法都调用PINRemoteImageCategory上的匹配类方法。</p><p id="ba8e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您更愿意直接使用图像，您可以在PINRemoteImageManager的共享实例上调用方法，它是PINRemoteImage的主要类。它将合并下载、缓存提取和图像处理操作，因此无论您请求多少次下载图像，下载和磁盘缓存提取都只会发生一次。如果您需要修改可能不会在UIView类别中显示的选项，也可以使用它。</p><p id="0342" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所有到磁盘和内存的缓存都由我们的开源对象缓存库PINCache处理。</p><h2 id="5f41" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">处理图像</h2><p id="b4d2" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">PINRemoteImage还支持处理图像并将结果图像存储在图像缓存中。例如，下面的代码将下载一个图像，调整其大小并应用圆角半径:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="7ede" class="jr js hh kw b fi la lb l lc ld">[imageView setImageFromURL:heroURL processorKey:@"rounded-hero" processor:^UIImage *(PIRemoteImageManagerResult *result, NSUInteger *cost)<br/>{<br/>    UIImage *image = result.image;<br/>    CGFloat radius = 7.0f;<br/>    CGSize targetSize = CGSizeMake(100, 100);<br/>    CGRect imageRect = CGRectMake(0, 0, targetSize.width, targetSize.height);<br/>    UIGraphicsBeginImageContext(imageRect.size);<br/>    [[UIBezierPath bezierPathWithRoundedRect:imageRect cornerRadius:radius] addClip];<br/>    <br/>    CGFloat widthMultiplier = targetSize.width / image.size.width;<br/>    CGFloat heightMultiplier = targetSize.height / image.size.height;<br/>    CGFloat sizeMultiplier = MAX(widthMultiplier, heightMultiplier);<br/>    <br/>    CGRect drawRect = CGRectMake(0, 0, image.size.width * sizeMultiplier, image.size.height * sizeMultiplier);<br/>    if (CGRectGetMaxX(drawRect) &gt; CGRectGetMaxX(imageRect)) {<br/>        drawRect.origin.x -= (CGRectGetMaxX(drawRect) - CGRectGetMaxX(imageRect)) / 2.0;<br/>    }<br/>    if (CGRectGetMaxY(drawRect) &gt; CGRectGetMaxY(imageRect)) {<br/>        drawRect.origin.y -= (CGRectGetMaxY(drawRect) - CGRectGetMaxY(imageRect)) / 2.0;<br/>    }<br/>    <br/>    [image drawInRect:drawRect];<br/>    UIImage *processedImage = UIGraphicsGetImageFromCurrentImageContext();<br/>    UIGraphicsEndImageContext();<br/>    return processedImage;<br/>}];</span></pre><p id="6923" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个方法可以被调用多次，而图像只被处理一次。</p><h2 id="e1f1" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">对抗慢速连接</h2><p id="187a" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">PINRemoteImage有几种方法可以改善在慢速连接上下载图像的体验，包括支持Google的WebP格式。如果webp可用(例如，通过包含WebP cocoa pod ), PINRemoteImage将检测WebP下载，并使用WebP库对其进行适当解码:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="1e96" class="jr js hh kw b fi la lb l lc ld">[imageView setImageFromURL:[NSURL URLWithString:@”webPImage.webp”]];</span></pre><p id="e8c1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">或者，如果你正在下载渐进JPEGs，PINRemoteImage支持显示应用了吸引人的模糊的图像的渐进扫描(当不通过GIF过滤时更吸引人，因为该功能仅在iOS 8和更高版本上可用)。若要支持渐进式扫描，请通过调用setUpdateWithProgress:YES在UIImageView上启用更新，或者在PINRemoteImageManager上使用渐进式方法之一:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="17c5" class="jr js hh kw b fi la lb l lc ld">[imageView setUpdateWithProgress:YES];<br/>[imageView setImageFromURL[NSURLURLWithString:@”progressiveJPEG.jpg”]];</span></pre><figure class="kr ks kt ku fd lf er es paragraph-image"><div class="er es le"><img src="../Images/8032b7834ad194d1ff2967dc0a430cf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:910/0*jG3zp8MNSZx_iTbS.gif"/></div></figure><p id="43bc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">支持慢速连接的最后一种方法是为库提供几个不同质量的URL。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="9a14" class="jr js hh kw b fi la lb l lc ld">[imageView setImageFromURLs:@[[NSURL URLWithString:@"lowQualityURL"],<br/>                                  [NSURL URLWithString:@"mediumQualityURL"],<br/>                                  [NSURL URLWithString:@"highQualityURL"]]];</span></pre><p id="bf39" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">PINRemoteImage将根据最近观察到的网络状况下载其中一个图像。因此，如果最后几个图像下载缓慢，它会选择一个较低质量的图像下载。如果您想将这些图像升级到更高质量的版本，您可以告诉图像管理器应该升级低质量的图像，并再次在图像视图上设置图像URL:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="314f" class="jr js hh kw b fi la lb l lc ld">[[PINRemoteImageManager sharedManager] setShouldUpgradeLowQualityImages:YES completion:nil];<br/>[imageView setImageFromURLs:@[[NSURL URLWithString:@"lowQualityURL"],<br/>                                  [NSURL URLWithString:@"mediumQualityURL"],<br/>                                  [NSURL URLWithString:@"highQualityURL"]]];</span></pre><h2 id="fe8e" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">支持FLAnimatedImage</h2><p id="4294" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">PINRemoteImage还提供了对FLAnimatedImage的本地支持，这是一个内存高效的GIF解码器和播放器。如果您有FLAnimatedImageView的实例，下载和设置GIF就像在UIImageView上一样简单:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="59a0" class="jr js hh kw b fi la lb l lc ld">[flaAnimatedImageView setImageFromURL:[NSURLURLWithString:@”gifURL.gif”];</span></pre><h2 id="5511" class="jr js hh bd jt ju jv jw jx jy jz ka kb ip kc kd ke it kf kg kh ix ki kj kk kl bi translated">贡献给PINRemoteImage</h2><p id="4bf6" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">正如我们的其他开源贡献一样，我们相信社区可以将PINRemoteImage做得更好。无论是通过拉请求还是错误报告，我们都很高兴能让PINRemoteImage变得更好。首先，请查看我们的GitHub资源库，在这里您可以看到如何安装和使用PINRemoteImage，以及使用一个示例应用程序(它充满了小猫)。</p><p id="ff1b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="li">盖瑞特·穆恩</em> </strong> <em class="li">是iOS团队的一名软件工程师。</em></p><p id="147f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="li">获取Pinterest工程新闻和更新，关注我们的工程</em><a class="ae jc" href="https://www.pinterest.com/malorie/pinterest-engineering-news/" rel="noopener ugc nofollow" target="_blank"><em class="li">Pinterest</em></a><em class="li">，</em> <a class="ae jc" href="https://www.facebook.com/pinterestengineering" rel="noopener ugc nofollow" target="_blank"> <em class="li">脸书</em> </a> <em class="li">和</em><a class="ae jc" href="https://twitter.com/PinterestEng" rel="noopener ugc nofollow" target="_blank"><em class="li">Twitter</em></a><em class="li">。有兴趣加入团队吗？查看我们的</em> <a class="ae jc" href="https://about.pinterest.com/en/careers/engineering-product" rel="noopener ugc nofollow" target="_blank"> <em class="li">招聘网站</em> </a> <em class="li">。</em></p></div></div>    
</body>
</html>