<html>
<head>
<title>How to use Actions on Google Client Library on Azure Functions Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Azure Functions Node.js上使用Google客户端库上的操作</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/how-to-use-actions-on-google-client-library-on-azure-functions-node-js-178d5ecd04e3?source=collection_archive---------4-----------------------#2019-01-04">https://medium.com/google-developer-experts/how-to-use-actions-on-google-client-library-on-azure-functions-node-js-178d5ecd04e3?source=collection_archive---------4-----------------------#2019-01-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="2ab9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你是一个经常使用Azure Functions Node.js的开发者，你可以用Azure Functions Node.js为谷歌助手构建你的动作，谷歌一直在为Node.js提供谷歌客户端库上的动作。</p><div class="jc jd ez fb je jf"><a href="https://github.com/actions-on-google/actions-on-google-nodejs" rel="noopener  ugc nofollow" target="_blank"><div class="jg ab dw"><div class="jh ab ji cl cj jj"><h2 class="bd hi fi z dy jk ea eb jl ed ef hg bi translated">谷歌上的操作/谷歌节点上的操作</h2><div class="jm l"><h3 class="bd b fi z dy jk ea eb jl ed ef dx translated">用于Google上操作的Node.js客户端库。通过以下方式为actions-on-Google/actions-on-Google-nodejs开发做出贡献…</h3></div><div class="jn l"><p class="bd b fp z dy jk ea eb jl ed ef dx translated">github.com</p></div></div><div class="jo l"><div class="jp l jq jr js jo jt ju jf"/></div></div></a></div><p id="d5dd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你可以用Azure Functions上的客户端库实现你的实现代码。但是，你需要使用一些技巧。在这个故事中，我打算介绍如何在Azure Functions Node.js环境中使用Google客户端库上的操作。</p><h1 id="88c3" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">体系结构</h1><p id="1127" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">我假设您想要在Azure函数上实现您的实现代码，以处理来自Dialogflow的请求，如下所示:</p><figure class="kz la lb lc fd ld er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es ky"><img src="../Images/564e71f6d2594ea0ace82c218d4712c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Sp0j8mrlp6wZnKvpyXbtgg.png"/></div></div></figure><p id="2c3e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">不幸的是，Azure Functions Node.js与<a class="ae lj" href="https://www.npmjs.com/package/express" rel="noopener ugc nofollow" target="_blank"> express </a>不兼容。有必要在Google客户端库的express和Actions之间使用一些桥梁。但是，我可以给你提供一个好消息。你可以使用azure-function-express库来连接它们。</p><div class="jc jd ez fb je jf"><a href="https://github.com/yvele/azure-function-express" rel="noopener  ugc nofollow" target="_blank"><div class="jg ab dw"><div class="jh ab ji cl cj jj"><h2 class="bd hi fi z dy jk ea eb jl ed ef hg bi translated">伊夫勒/天蓝色-功能-快捷</h2><div class="jm l"><h3 class="bd b fi z dy jk ea eb jl ed ef dx translated">⚡️Allows Express.js使用Azure函数。为yvele/azure-function-express开发做出贡献，创建一个…</h3></div><div class="jn l"><p class="bd b fp z dy jk ea eb jl ed ef dx translated">github.com</p></div></div><div class="jo l"><div class="lk l jq jr js jo jt ju jf"/></div></div></a></div><h1 id="793b" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">先决条件</h1><p id="ea86" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">您需要准备以下内容:</p><ul class=""><li id="bd17" class="ll lm hh ig b ih ii il im ip ln it lo ix lp jb lq lr ls lt bi translated">您已经在Azure上注册了您的帐户。</li><li id="1caf" class="ll lm hh ig b ih lu il lv ip lw it lx ix ly jb lq lr ls lt bi translated">您已经安装了<a class="ae lj" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>并登录到Azure。</li><li id="aa19" class="ll lm hh ig b ih lu il lv ip lw it lx ix ly jb lq lr ls lt bi translated">您已经安装了<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local#install-the-azure-functions-core-tools" rel="noopener ugc nofollow" target="_blank"> Azure功能核心工具</a>。</li><li id="c98d" class="ll lm hh ig b ih lu il lv ip lw it lx ix ly jb lq lr ls lt bi translated">你已经了解了如何在谷歌云平台或亚马逊网络服务上为谷歌助手构建动作。</li><li id="064c" class="ll lm hh ig b ih lu il lv ip lw it lx ix ly jb lq lr ls lt bi translated">您已经在Google project上有了您的操作，并且您的Dialogflow代理已经连接到AoG项目。</li></ul><p id="0861" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你不知道如何构建动作，你可以用codelabs来研究一下:</p><div class="jc jd ez fb je jf"><a href="https://codelabs.developers.google.com/codelabs/actions-1/index.html#0" rel="noopener  ugc nofollow" target="_blank"><div class="jg ab dw"><div class="jh ab ji cl cj jj"><h2 class="bd hi fi z dy jk ea eb jl ed ef hg bi translated">为Google Assistant构建操作(第1级)</h2><div class="jm l"><h3 class="bd b fi z dy jk ea eb jl ed ef dx translated">这个codelab是多模块教程的一部分。每个模块可以单独学习，也可以按照学习顺序学习…</h3></div><div class="jn l"><p class="bd b fp z dy jk ea eb jl ed ef dx translated">codelabs.developers.google.com</p></div></div><div class="jo l"><div class="lz l jq jr js jo jt ju jf"/></div></div></a></div><div class="jc jd ez fb je jf"><a href="https://codelabs.developers.google.com/codelabs/actions-2/index.html#0" rel="noopener  ugc nofollow" target="_blank"><div class="jg ab dw"><div class="jh ab ji cl cj jj"><h2 class="bd hi fi z dy jk ea eb jl ed ef hg bi translated">为Google Assistant构建操作(第2级)</h2><div class="jm l"><h3 class="bd b fi z dy jk ea eb jl ed ef dx translated">此codelab模块是多模块教程的一部分。每个模块可以单独学习，也可以按学习顺序学习…</h3></div><div class="jn l"><p class="bd b fp z dy jk ea eb jl ed ef dx translated">codelabs.developers.google.com</p></div></div><div class="jo l"><div class="ma l jq jr js jo jt ju jf"/></div></div></a></div><h1 id="67b8" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">创建您的功能</h1><p id="6bfa" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">让我们开始在Azure上创建你的函数。如果您没有资源组和存储帐户，请使用以下命令创建它们:</p><pre class="kz la lb lc fd mb mc md me aw mf bi"><span id="3d0f" class="mg jw hh mc b fi mh mi l mj mk">$ az group create --name &lt;RESOURCE_GROUP_NAME&gt; --location &lt;LOCATION_NAME&gt;<br/>$ az storage account create --name &lt;STORAGE_ACCOUNT_NAME&gt; --resource-group &lt;RESOURCE_GROUP_NAME&gt; --location &lt;LOCATION_NAME&gt; --sku Standard_LRS</span></pre><p id="dbdf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，用下面的命令创建您的函数:</p><pre class="kz la lb lc fd mb mc md me aw mf bi"><span id="bf72" class="mg jw hh mc b fi mh mi l mj mk">$ az functionapp create --resource-group &lt;RESOURCE_GROUP_NAME&gt; --consumption-plan-location &lt;LOCATION_NAME&gt; --name &lt;FUNCTION_NAME&gt; --storage-account &lt;STORAGE_ACCOUNT_NAME&gt; --runtime node<br/>$ func init &lt;FUNCTIONAPP_NAME&gt;<br/>$ cd &lt;FUNCTIONAPP_NAME&gt;<br/>$ func new --name &lt;FUNCTION_NAME&gt; --template "HttpTrigger"</span></pre><h1 id="24e1" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">安装依赖项</h1><p id="f6cd" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">创建函数后，执行以下命令创建您的<code class="du ml mm mn mc b">package.json</code>文件:</p><pre class="kz la lb lc fd mb mc md me aw mf bi"><span id="b4b3" class="mg jw hh mc b fi mh mi l mj mk">$ cd &lt;FUNCTION_NAME&gt;<br/>$ npm init</span></pre><p id="7395" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您将从命令中询问一些问题，但基本上您可以通过按回车键来回答所有问题。然后，通过以下命令安装依赖项:</p><pre class="kz la lb lc fd mb mc md me aw mf bi"><span id="def6" class="mg jw hh mc b fi mh mi l mj mk">$ npm install --save actions-on-google express azure-function-express</span></pre><p id="2baa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将创建<code class="du ml mm mn mc b">node_modules</code>,并将依赖项安装到目录中。</p><h1 id="189c" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">编写履行代码</h1><p id="33e8" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">通过上面的命令，已经在<code class="du ml mm mn mc b">&lt;FUNCTION_NAME&gt;</code>目录下创建了<code class="du ml mm mn mc b">index.js</code>文件。用以下代码替换<code class="du ml mm mn mc b">index.js</code>文件的内容:</p><pre class="kz la lb lc fd mb mc md me aw mf bi"><span id="d21c" class="mg jw hh mc b fi mh mi l mj mk">const {dialogflow} = require('actions-on-google');<br/>const express = require('express');<br/>const {createHandler} = require('azure-function-express');</span><span id="e34d" class="mg jw hh mc b fi mo mi l mj mk">const app = dialogflow();</span><span id="065c" class="mg jw hh mc b fi mo mi l mj mk">app.intent('Default Welcome Intent', conv =&gt; {<br/>    conv.close('Hello, Azure!');<br/>});</span><span id="1a07" class="mg jw hh mc b fi mo mi l mj mk">// Put other intent handlers here.</span><span id="b46e" class="mg jw hh mc b fi mo mi l mj mk">const expressApp = express();<br/>expressApp.post('/api/&lt;FUNCTION_NAME&gt;', app);</span><span id="2c9f" class="mg jw hh mc b fi mo mi l mj mk">module.exports = createHandler(expressApp);</span></pre><p id="146e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此外，您需要将认证模式更改为<code class="du ml mm mn mc b">anonymous</code>进行测试。用<code class="du ml mm mn mc b">function.json</code>文件中的<code class="du ml mm mn mc b">anonymous</code>替换<code class="du ml mm mn mc b">authLevel</code>值。</p><pre class="kz la lb lc fd mb mc md me aw mf bi"><span id="e576" class="mg jw hh mc b fi mh mi l mj mk">{<br/>  ...<br/>  "bindings": [<br/>    {<br/>      "authLevel": "anonymous",<br/>      ...<br/>    }<br/>  ]<br/>}</span></pre><h1 id="6b6a" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">设置代理以避免问题</h1><p id="da6c" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">不幸的是，当前的Azure函数有一个关于处理字符集的问题。因此，上面的代码不起作用。</p><div class="jc jd ez fb je jf"><a href="https://github.com/Azure/azure-functions-nodejs-worker/issues/168" rel="noopener  ugc nofollow" target="_blank"><div class="jg ab dw"><div class="jh ab ji cl cj jj"><h2 class="bd hi fi z dy jk ea eb jl ed ef hg bi translated">内容类型请求头的字符集被忽略问题#168 …</h2><div class="jm l"><h3 class="bd b fi z dy jk ea eb jl ed ef dx translated">内容类型响应头的字符集在特定情况下似乎被忽略了。如果请求有一个…</h3></div><div class="jn l"><p class="bd b fp z dy jk ea eb jl ed ef dx translated">github.com</p></div></div><div class="jo l"><div class="mp l jq jr js jo jt ju jf"/></div></div></a></div><p id="859e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作为解决上述问题的方法，设置一个代理来强制覆盖一个<code class="du ml mm mn mc b">Accept-Charset</code>请求头。为此，在<code class="du ml mm mn mc b">&lt;FUNCTIONAPP_NAME&gt;</code>目录中创建一个新的<code class="du ml mm mn mc b">proxies.json</code>文件，并在该文件中编写以下代码:</p><pre class="kz la lb lc fd mb mc md me aw mf bi"><span id="dcaf" class="mg jw hh mc b fi mh mi l mj mk">{<br/>  "$schema": "http://json.schemastore.org/proxies",<br/>  "proxies": {<br/>    "proxy1": {<br/>      "matchCondition": {<br/>        "methods": [<br/>          "POST"<br/>        ],<br/>        "route": "/api/&lt;FUNCTION_NAME&gt;"<br/>      },<br/>      "backendUri": "https://localhost/api/&lt;FUNCTION_NAME&gt;",<br/>      "requestOverrides": {<br/>        "backend.request.headers.Accept-Charset": "utf-8"<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="8841" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该代理仅将Accept-Charset请求头值覆盖为“utf-8”。因此，您的函数可以将响应作为UTF-8字符串返回。</p><p id="8c7e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当然，如果问题得到解决，这个代理就没有必要了。</p><h1 id="946b" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">部署和测试</h1><p id="e3dc" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">最后，使用以下命令将您的实现部署到Azure:</p><pre class="kz la lb lc fd mb mc md me aw mf bi"><span id="aac5" class="mg jw hh mc b fi mh mi l mj mk">$ func azure functionapp publish &lt;FUNCTIONAPP_NAME&gt;</span></pre><p id="fb0d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">部署后，该命令显示函数的端点URL。在您的Dialogflow代理上将该URL注册为fulfillment webhook URL。然后，在动作模拟器上调用您的动作。</p><h1 id="9722" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">结论</h1><p id="ae1f" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">在这个故事中，我介绍了如何在Azure Functions Node.js上使用Google Client Library上的操作。不幸的是，有一个问题，您需要通过变通方法(即使用代理)来避免这个问题。但是，您可以在简单地解决问题后删除代理。</p><p id="3b32" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你正在使用Azure函数，试着在Azure上为Google Assistant构建你的动作！</p></div></div>    
</body>
</html>