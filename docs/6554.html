<html>
<head>
<title>Kotlin/Native iOS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ç§‘ç‰¹æ—/åŸç”ŸiOS</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/quick-code/kotlin-native-ios-a1a73d7390fe?source=collection_archive---------1-----------------------#2018-12-28">https://medium.com/quick-code/kotlin-native-ios-a1a73d7390fe?source=collection_archive---------1-----------------------#2018-12-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="108b" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">3.åç¨‹å’ŒK/Nçš„ä¸å˜æ€§</h2></div><h1 id="7ab5" class="iw ix hh bd iy iz ja jb jc jd je jf jg in jh io ji iq jj ir jk it jl iu jm jn bi translated">ååŒç¨‹åº</h1><p id="be63" class="pw-post-body-paragraph jo jp hh jq b jr js ii jt ju jv il jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿè¿™ä¸ª<a class="ae kk" href="https://kotlinlang.org/docs/reference/coroutines/coroutines-guide.html" rel="noopener ugc nofollow" target="_blank">å®˜æ–¹æŒ‡å—</a>å¯¹äºç†è§£ä»€ä¹ˆæ˜¯åç¨‹ä»¥åŠå¦‚ä½•ä½¿ç”¨åç¨‹éå¸¸æœ‰å¸®åŠ©ã€‚</p><p id="8705" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">æœ¬ç« çš„ä¸»é¢˜æ˜¯åœ¨K/Nä¸­ä½¿ç”¨åç¨‹åŠå…¶å½“å‰çŠ¶æ€ã€‚</p><h1 id="016f" class="iw ix hh bd iy iz ja jb jc jd je jf jg in jh io ji iq jj ir jk it jl iu jm jn bi translated">æ›´æ–°æ¢¯åº¦</h1><p id="5e3d" class="pw-post-body-paragraph jo jp hh jq b jr js ii jt ju jv il jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">è¦ä½¿ç”¨K/Nä¸­çš„ååŒç¨‹åºï¼Œè¯·æ›´æ–°<code class="du kq kr ks kt b">sharedNative/build.gradle</code>ä¸­çš„ä¾èµ–å…³ç³»ã€‚</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="277a" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated"><code class="du kq kr ks kt b">kolinx-coroutines-core-common</code>å’Œ<code class="du kq kr ks kt b">kotlinx-coroutines-core-native</code>æ˜¯æ–°çš„ã€‚ä¸€æ›´ï¼Œåœ¨<code class="du kq kr ks kt b">settings.gradle</code> <a class="ae kk" href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/native/README.md" rel="noopener ugc nofollow" target="_blank">åŠ ä¸€è¡Œ</a> <code class="du kq kr ks kt b">enableFeaturePreview('GRADLE_METADATA')</code>ã€‚</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="3272" class="lf ix hh kt b fi lg lh l li lj">include ':app'<br/>include ':sharedNative'<br/><br/>enableFeaturePreview('GRADLE_METADATA')</span></pre><p id="426c" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">ç„¶åï¼Œ<code class="du kq kr ks kt b">Sync Now</code>ã€‚</p><h1 id="aa97" class="iw ix hh bd iy iz ja jb jc jd je jf jg in jh io ji iq jj ir jk it jl iu jm jn bi translated">ä½¿ç”¨iOSä¸­çš„åç¨‹</h1><p id="1f00" class="pw-post-body-paragraph jo jp hh jq b jr js ii jt ju jv il jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">ç°åœ¨ï¼Œæ‚¨å¯ä»¥åœ¨å…¬å…±æ¨¡å—ä¸­ä½¿ç”¨åç¨‹APIã€‚åœ¨<code class="du kq kr ks kt b">actual.kt</code>ä¸­ï¼Œå®šä¹‰è¿™ä¸ª<code class="du kq kr ks kt b">CoroutineDispatcher</code>ã€‚</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="abe1" class="lf ix hh kt b fi lg lh l li lj">private class MainDispatcher: CoroutineDispatcher() {<br/>    override fun dispatch(context: CoroutineContext, block: Runnable) {<br/>        <em class="lk">dispatch_async</em>(<em class="lk">dispatch_get_main_queue</em>()) <strong class="kt hi">{ </strong>block.run() <strong class="kt hi">}<br/>    </strong>}<br/>}</span></pre><p id="c441" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">åç¨‹è°ƒåº¦ç¨‹åºç¡®å®šç›¸åº”çš„åç¨‹ä½¿ç”¨ä»€ä¹ˆçº¿ç¨‹æ¥æ‰§è¡Œã€‚</p><p id="86d4" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">æ¥ä¸‹æ¥ï¼Œå®šä¹‰<code class="du kq kr ks kt b">CoroutineScope</code>ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè¿è¡Œåœ¨iOSäº‹ä»¶å¾ªç¯ä¸Šçš„ä½œç”¨åŸŸã€‚</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="1190" class="lf ix hh kt b fi lg lh l li lj">internal class MainScope: CoroutineScope {<br/>    private val dispatcher = MainDispatcher()<br/>    private val job = <em class="lk">Job</em>()<br/><br/>    override val coroutineContext: CoroutineContext<br/>        get() = dispatcher + job<br/>}</span></pre><p id="d056" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">ä½œç”¨åŸŸç”¨äºç”Ÿæˆåç¨‹ã€‚æˆ‘ä¸æƒ³è®©å®ƒåœ¨iOSä¸­å¯è§ï¼Œæ‰€ä»¥ç”¨<code class="du kq kr ks kt b">internal</code>å®šä¹‰äº†<code class="du kq kr ks kt b">MainScope</code>ç±»ã€‚ä½†æ˜¯è®¿é—®çº§åˆ«å–å†³äºæ‚¨ã€‚</p><blockquote class="ll lm ln"><p id="d446" class="jo jp lk jq b jr kl ii jt ju km il jw lo kn jz ka lp ko kd ke lq kp kh ki kj ha bi translated">åç¨‹ä½œç”¨åŸŸæ˜¯æ–°åç¨‹çš„ä½œç”¨åŸŸã€‚è¿™æ„å‘³ç€æ¯ä¸ªåç¨‹æ„å»ºå™¨éƒ½ç»§æ‰¿äº†ä½œç”¨åŸŸçš„<code class="du kq kr ks kt b">coroutineContext</code>ã€‚ç”±äºè¿™ä¸ªåŸå› ï¼Œä¸Šä¸‹æ–‡å…ƒç´ å’Œ<strong class="jq hi">å–æ¶ˆ</strong>éƒ½è¢«è‡ªåŠ¨ä¼ æ’­ã€‚ä¾‹å¦‚ï¼Œä½œç”¨åŸŸçš„å–æ¶ˆè°ƒç”¨ä½œç”¨åŸŸå†…å¯åŠ¨çš„åç¨‹çš„å–æ¶ˆã€‚</p></blockquote><p id="2324" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">è®©æˆ‘ä»¬è¯•ç€è°ƒç”¨åç¨‹ã€‚åœ¨<code class="du kq kr ks kt b">actual.kt</code>ä¸­å®šä¹‰<code class="du kq kr ks kt b">showHelloCoroutine</code>åŠŸèƒ½ï¼Œåœ¨<code class="du kq kr ks kt b">common.kt</code>ä¸­å®šä¹‰<code class="du kq kr ks kt b">helloCoroutine</code>æš‚åœåŠŸèƒ½ã€‚<code class="du kq kr ks kt b">launch</code>å‡½æ•°æ˜¯<code class="du kq kr ks kt b">CoroutineScope</code>ç±»çš„æ‰©å±•å‡½æ•°ã€‚è¿™æ˜¯ä¸€ä¸ªååŒç¨‹åºç”Ÿæˆå™¨ã€‚</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="cb0e" class="lf ix hh kt b fi lg lh l li lj">fun showHelloCoroutine() {<br/>    MainScope().launch {<br/>        helloCoroutine()<br/>    }<br/>}</span><span id="b91f" class="lf ix hh kt b fi lr lh l li lj">---above: actual.kt--------below: common.kt------</span><span id="efc0" class="lf ix hh kt b fi lr lh l li lj">internal suspend fun helloCoroutine() {<br/>    println("Hello Coroutines!")<br/>}</span></pre><p id="ed53" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">æˆ‘ä»¬å¯ä»¥è¿™æ ·ç§°å‘¼å®ƒã€‚</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="09ae" class="lf ix hh kt b fi lg lh l li lj">ActualKt.showHelloCoroutine()</span><span id="68e4" class="lf ix hh kt b fi lr lh l li lj">// Hello Coroutines!</span></pre><p id="7d7a" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">è¿™é‡Œæˆ‘åˆ†æˆä¸¤ä¸ªå‡½æ•°ã€‚ä¸€ä¸ªç±»ä¼¼äºåç¨‹åŒ…è£…å‡½æ•°ï¼Œå¦ä¸€ä¸ªæ˜¯æŒ‚èµ·å‡½æ•°ã€‚</p><p id="b7a3" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒæŒ‚èµ·å‡½æ•°æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘ä»¬å¸Œæœ›å…±äº«å®ƒä»¬ã€‚æ‰€ä»¥åœ¨è¿™é‡Œï¼Œæˆ‘åœ¨<code class="du kq kr ks kt b">common.kt</code>ä¸­å®šä¹‰äº†<code class="du kq kr ks kt b">helloCoroutine</code>æš‚åœåŠŸèƒ½ï¼Œä»¥ä¾¿åœ¨Androidä¸­ä½¿ç”¨ã€‚</p><p id="4038" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">å¦ä¸€æ–¹é¢ï¼ŒæŒ‚èµ·å‡½æ•°è¿˜ä¸èƒ½ç›´æ¥ä»iOSä¸­ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä¸ºæŒ‚èµ·å‡½æ•°å‡†å¤‡äº†smthï¼Œå°±åƒä¸€ä¸ªåŒ…è£…å‡½æ•°ã€‚</p><blockquote class="ll lm ln"><p id="c817" class="jo jp lk jq b jr kl ii jt ju km il jw lo kn jz ka lp ko kd ke lq kp kh ki kj ha bi translated">æš‚åœåŠŸèƒ½æ­¤æ—¶ä¸ä¼šå¯¼å‡ºåˆ°æ¡†æ¶ä¸­ã€‚ä½†æ˜¯å…³äºè¿™ä¸ªæœ‰ä¸€ä¸ª<a class="ae kk" href="https://github.com/JetBrains/kotlin-native/issues/2438" rel="noopener ugc nofollow" target="_blank">é—®é¢˜</a>ã€‚</p></blockquote><h1 id="bbfa" class="iw ix hh bd iy iz ja jb jc jd je jf jg in jh io ji iq jj ir jk it jl iu jm jn bi translated">Ktorå®¢æˆ·ç«¯çš„HTTPè¯·æ±‚ã€‚</h1><p id="f1a2" class="pw-post-body-paragraph jo jp hh jq b jr js ii jt ju jv il jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">ä¸Šé¢çš„ä¾‹å­æœ‰ç‚¹æ— èŠï¼Œåªæ˜¯åœ¨æ§åˆ¶å°ä¸Šæ‰“å°ã€‚æˆ‘ä»¬å°†åœ¨è¿™é‡Œç”¨<a class="ae kk" href="https://github.com/ktorio/ktor" rel="noopener ugc nofollow" target="_blank"> Ktor </a>å®ç°HTTPè¯·æ±‚ã€‚</p><h2 id="2ee2" class="lf ix hh bd iy ls lt lu jc lv lw lx jg jx ly lz ji kb ma mb jk kf mc md jm me bi translated">æ›´æ–°æ¢¯åº¦</h2><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="b0ab" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">(2019å¹´1æœˆ16æ—¥æ›´æ–°)</p><h2 id="1f5c" class="lf ix hh bd iy ls lt lu jc lv lw lx jg jx ly lz ji kb ma mb jk kf mc md jm me bi translated">ç®€å•çš„è¯·æ±‚</h2><p id="09aa" class="pw-post-body-paragraph jo jp hh jq b jr js ii jt ju jv il jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">åœ¨<code class="du kq kr ks kt b">common.kt</code>ä¸­åˆ›å»ºä¸€ä¸ªAPIç±»</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="9245" class="lf ix hh kt b fi lg lh l li lj">class Api {<br/>    private val client = HttpClient()<br/><br/>    internal suspend fun request(urlString: String): String {<br/>        val result: String = client.<em class="lk">call</em>(urlString) <strong class="kt hi">{<br/>            </strong>method = HttpMethod.Get<br/>        <strong class="kt hi">}</strong>.response.<em class="lk">readText</em>()<br/>        return result<br/>    }<br/>}</span></pre><p id="a433" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">HttpClientç±»åŒ…å«åœ¨Ktoråº“ä¸­ã€‚è¯·æ±‚æŒ‚èµ·å‡½æ•°ç”¨<code class="du kq kr ks kt b">Get</code> httpæ–¹æ³•è°ƒç”¨<code class="du kq kr ks kt b">client.call</code>ã€‚</p><p id="8036" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">æ¥ä¸‹æ¥ï¼Œä¸ºè¿™ä¸ªsuspendå‡½æ•°å®šä¹‰ä¸€ä¸ªåŒ…è£…å‡½æ•°ï¼Œä½œä¸º<code class="du kq kr ks kt b">actual.kt</code>ä¸­Apiç±»çš„æ‰©å±•å‡½æ•°ã€‚</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="721a" class="lf ix hh kt b fi lg lh l li lj">fun Api.request(completion: (String) -&gt; Unit) {<br/>    MainScope().<em class="lk">launch </em><strong class="kt hi">{<br/>        </strong>val result = request("https://tools.ietf.org/rfc/rfc8216.txt")<br/>        completion(result)<br/>    <strong class="kt hi">}<br/></strong>}</span></pre><p id="9a1a" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">è¿™å°†https://tools.ietf.org/rfc/rfc8216.txtä½œä¸ºä¸€ä¸ªå‚æ•°ä¼ é€’ã€‚RFC8216æ³¨å†Œäº†ä»€ä¹ˆï¼Ÿä½ å¾ˆå¿«å°±ä¼šçœ‹åˆ°ã€‚</p><p id="9807" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">è®©æˆ‘ä»¬å°è¯•åœ¨ViewController.swiftä¸­è°ƒç”¨å®ƒ</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="0079" class="lf ix hh kt b fi lg lh l li lj">Api().request {<br/>    print($0)<br/>    return .init()<br/>}</span></pre><p id="2d48" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">Kotlin lambdaè¿”å›å•å…ƒæ˜¯ä½œä¸ºé—­åŒ…å¯¼å‡ºçš„ï¼Œè¿”å›<code class="du kq kr ks kt b">KotlinUnit</code>ï¼Œä¸æ˜¯Voidã€‚å› æ­¤éœ€è¦æœ€åä¸€æ¬¡è¿”å›ã€‚</p><p id="e348" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">æ— è®ºå¦‚ä½•ï¼Œè¿™å°†å¼‚æ­¥æ‰§è¡Œå¹¶æ‰“å°HTTPå®æ—¶æµæ–‡æ¡£ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¥è‡ªiOSçš„httpè¯·æ±‚ğŸ‰</p><blockquote class="ll lm ln"><p id="0d25" class="jo jp lk jq b jr kl ii jt ju km il jw lo kn jz ka lp ko kd ke lq kp kh ki kj ha bi translated">ç›®å‰ï¼Œåç¨‹ä»…æ”¯æŒ<strong class="jq hi">ä¸»çº¿ç¨‹</strong>ã€‚ä½†æ˜¯ï¼Œæ”¯æŒ<strong class="jq hi">çš„å¤šçº¿ç¨‹</strong>åç¨‹æ˜¯<a class="ae kk" href="https://github.com/Kotlin/kotlinx.coroutines/issues/462" rel="noopener ugc nofollow" target="_blank">å‘å¸ƒçš„</a>ã€‚</p></blockquote><h1 id="d781" class="iw ix hh bd iy iz ja jb jc jd je jf jg in jh io ji iq jj ir jk it jl iu jm jn bi translated">K/Nä¸å˜æ€§</h1><h2 id="570f" class="lf ix hh bd iy ls lt lu jc lv lw lx jg jx ly lz ji kb ma mb jk kf mc md jm me bi translated">å†°å†»çš„</h2><p id="72cf" class="pw-post-body-paragraph jo jp hh jq b jr js ii jt ju jv il jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">åœ¨K/Nä¸­ï¼Œ<em class="lk">ä¸å˜æ€§</em>æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶å±æ€§ã€‚è¿™å¯ä»¥é€šè¿‡ä½¿ç”¨<code class="du kq kr ks kt b">kotlin.native.concurrent</code>ä¸­çš„<code class="du kq kr ks kt b">freeze()</code>åŠŸèƒ½æ¥å®ç°ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code class="du kq kr ks kt b">isFrozen</code>æ£€æŸ¥å†»ç»“çŠ¶æ€ã€‚</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="2326" class="lf ix hh kt b fi lg lh l li lj">package kotlin.native.concurrent<br/><br/>public val kotlin.Any?.<em class="lk">isFrozen</em>: kotlin.Boolean /* compiled code */</span></pre><p id="5d72" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">è¿™æ˜¯<code class="du kq kr ks kt b">kotlin.native.concurrent</code>å¥—è£…çš„ä¸€éƒ¨åˆ†ã€‚<code class="du kq kr ks kt b">isFrozen</code>å±æ€§åœ¨è¿™é‡Œå®šä¹‰ã€‚<code class="du kq kr ks kt b">Any?</code>ç±»å‹æ˜¾ç„¶å…·æœ‰<code class="du kq kr ks kt b">isFrozen</code>å±æ€§ã€‚</p><p id="b642" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">K/Nä¿è¯äº†é‡è¦çš„ä¸å˜é‡ï¼Œ<code class="du kq kr ks kt b"><strong class="jq hi">mutable XOR global</strong></code>ã€‚è¿™æ„å‘³ç€å¯¹è±¡è¦ä¹ˆæ˜¯ä¸å¯å˜çš„ï¼Œè¦ä¹ˆå¯ä»¥ä»å•çº¿ç¨‹è®¿é—®ã€‚</p><p id="409e" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">æœ‰äº›å¯¹è±¡åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯å†»ç»“çš„ï¼Œä¾‹å¦‚</p><ul class=""><li id="d27b" class="mf mg hh jq b jr kl ju km jx mh kb mi kf mj kj mk ml mm mn bi translated">ç§‘ç‰¹æ—ç­‰åŸå§‹ç±»å‹ã€‚å¼¦ä¹ï¼Œkotlin.Int</li><li id="6f4c" class="mf mg hh jq b jr mo ju mp jx mq kb mr kf ms kj mk ml mm mn bi translated"><code class="du kq kr ks kt b">object</code>å•èƒ</li><li id="b5dd" class="mf mg hh jq b jr mo ju mp jx mq kb mr kf ms kj mk ml mm mn bi translated">æšä¸¾ç±»</li></ul><p id="24d9" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">è¿™äº›çŠ¶æ€å¾ˆå®¹æ˜“æ£€æŸ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚åœ¨<code class="du kq kr ks kt b">actual.kt</code>ä¸­ï¼Œ</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="kz la l"/></div></figure><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="e07c" class="lf ix hh kt b fi lg lh l li lj"><strong class="kt hi">primitive int              isFrozen: true<br/>primitive string           isFrozen: true<br/>class object               isFrozen: false<br/>class object with freeze() isFrozen: true<br/>object singleton           isFrozen: true<br/>enum class                 isFrozen: true</strong></span></pre><p id="61d9" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">å¦‚æœä¸€ä¸ªçªå˜æ“ä½œè¢«åº”ç”¨åˆ°ä¸€ä¸ªå†»ç»“çš„ç‰©ä½“ä¸Šï¼Œ<code class="du kq kr ks kt b">InvalidMutabilityException</code>è¢«æŠ›å‡ºã€‚</p><h2 id="033f" class="lf ix hh bd iy ls lt lu jc lv lw lx jg jx ly lz ji kb ma mb jk kf mc md jm me bi translated"><strong class="ak">ä¸æ­£ç¡®çš„å¼•ç”¨å¼‚å¸¸</strong></h2><p id="ae1d" class="pw-post-body-paragraph jo jp hh jq b jr js ii jt ju jv il jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">é»˜è®¤æƒ…å†µä¸‹ï¼Œç±»å¯¹è±¡ä¸è¢«å†»ç»“ã€‚å¹¶ä¸”K/Nä¿è¯<code class="du kq kr ks kt b">mutable XOR global</code>ã€‚</p><p id="fb00" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">å¦‚æœæˆ‘ä»¬è®¿é—®ä¸€ä¸ªæ²¡æœ‰å†»ç»“çš„å¯¹è±¡ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿè¯•è¯•è¿™ä¸ªï¼Œåœ¨<code class="du kq kr ks kt b">actual.kt</code>ä¸­å®šä¹‰ä¸‹é¢çš„å‡½æ•°ã€‚</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="cdbb" class="lf ix hh kt b fi lg lh l li lj">fun passNotFrozenObject(completion: (Hello) -&gt; Unit) {<br/>    val hello = Hello()<br/>    completion(hello)<br/>}</span></pre><p id="bee0" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">åœ¨<code class="du kq kr ks kt b">ViewController.swift</code>ä¸­ã€‚</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="2be3" class="lf ix hh kt b fi lg lh l li lj">ActualKt.passNotFrozenObject { hello in<br/>    DispatchQueue.global(qos: .background).async {<br/>        print(hello)<br/>    }<br/>    return .init()<br/>}</span></pre><p id="0b13" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">è¿™æ®µä»£ç å´©æºƒäº†</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="ddeb" class="lf ix hh kt b fi lg lh l li lj"><strong class="kt hi">Uncaught Kotlin exception: kotlin.native.IncorrectDereferenceException: illegal attempt to access non-shared org.kotlin.mpp.mobile.Hello@19f3d08 from other thread</strong></span></pre><p id="7d7e" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">ä»å¦ä¸€ä¸ªçº¿ç¨‹è®¿é—®å¯¹è±¡æ—¶æŠ›å‡ºã€‚</p><p id="d43a" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">é€šè¿‡freeze()ä¿®å¤æ­¤å´©æºƒï¼Œä¾‹å¦‚</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="c7cb" class="lf ix hh kt b fi lg lh l li lj">fun passNotFrozenObject(completion: (Hello) -&gt; Unit) {<br/>    val hello = Hello().freeze()<br/>    completion(hello)<br/>}</span></pre><p id="ad17" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">è¿™å°†èµ·ä½œç”¨ï¼Œæ§åˆ¶å°ä¸Šå°†æ˜¾ç¤ºä»¥ä¸‹å†…å®¹</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="1b9d" class="lf ix hh kt b fi lg lh l li lj"><strong class="kt hi">org.kotlin.mpp.mobile.Hello@1e470c8</strong></span></pre><p id="6cfc" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">è¿™äº›å‚è€ƒèµ„æ–™å¯èƒ½æœ‰åŠ©äºæˆ‘ä»¬ç†è§£</p><ul class=""><li id="0f45" class="mf mg hh jq b jr kl ju km jx mh kb mi kf mj kj mk ml mm mn bi translated"><a class="ae kk" href="https://github.com/JetBrains/kotlin-native/blob/cfe2d2b7ce4aef41b45747d7c4d2d6238fd1808d/runtime/src/main/cpp/Memory.cpp#L467" rel="noopener ugc nofollow" target="_blank">https://github . com/JetBrains/kot Lin-native/blob/cfe 2d 7 ce 4 AEF 41 b 45747d 7 C4 d2d 6238 FD 1808d/runtime/src/main/CPP/memory . CPP # L467</a></li><li id="f588" class="mf mg hh jq b jr mo ju mp jx mq kb mr kf ms kj mk ml mm mn bi translated"><a class="ae kk" href="https://github.com/JetBrains/kotlin-native/blob/328413337b9dcab1dba6dd4d3cf5975d617e60d1/runtime/src/main/cpp/Memory.h#L30" rel="noopener ugc nofollow" target="_blank">https://github . com/JetBrains/kot Lin-native/blob/328413337 b 9 dcab 1 DBA 6 DD 4d 3 cf 5975d 617 e 60d 1/runtime/src/main/CPP/memory . h # L30</a></li></ul><h2 id="a534" class="lf ix hh bd iy ls lt lu jc lv lw lx jg jx ly lz ji kb ma mb jk kf mc md jm me bi translated">@ThreadLocalå’Œ@ SharedImmutable</h2><p id="2ef7" class="pw-post-body-paragraph jo jp hh jq b jr js ii jt ju jv il jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">å½“æ‚¨ä½¿ç”¨éåŸå§‹ç±»å‹çš„é¡¶çº§å…¨å±€å˜é‡æ—¶ï¼ŒThreadLocalæˆ–SharedImmutableæ³¨é‡Šæœ‰æ—¶å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ã€‚</p><p id="fffb" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">è¯•ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚åœ¨<code class="du kq kr ks kt b">actual.kt</code>ä¸­å®šä¹‰è¿™ä¸ªé¡¶å±‚å˜é‡ã€‚</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="1a87" class="lf ix hh kt b fi lg lh l li lj">val hello = Hello()</span></pre><p id="eefe" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">å¹¶ä»ViewController.swiftä¸­çš„ä¸åŒçº¿ç¨‹è®¿é—®å®ƒã€‚</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="edc5" class="lf ix hh kt b fi lg lh l li lj">print(Thread.current)<br/>print(ActualKt.hello)<br/>DispatchQueue.global(qos: .background).async {<br/>    print(Thread.current)<br/>    print(ActualKt.hello)<br/>}</span><span id="a26f" class="lf ix hh kt b fi lr lh l li lj">// output on console<br/><strong class="kt hi">&lt;NSThread: 0x600002e9e8c0&gt;{number = 1, name = main}<br/>org.kotlin.mpp.mobile.Hello@3ba2e28<br/>&lt;NSThread: 0x600002e16640&gt;{number = 3, name = (null)}<br/>Uncaught Kotlin exception: kotlin.native.IncorrectDereferenceException:</strong></span></pre><p id="4d6b" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">ä¸€ä¸ªç±»å¯¹è±¡æ²¡æœ‰è¢«å†»ç»“ï¼Œæ‰€ä»¥ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ç”¨è¿™ä¸ªæ€ä¹ˆæ ·ï¼Ÿ</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="f7bc" class="lf ix hh kt b fi lg lh l li lj">val hello = Hello().freeze()</span></pre><p id="51e2" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">å³ä½¿è¿™ä¸ª<code class="du kq kr ks kt b">hello</code>å¯¹è±¡è¢«å†»ç»“ä¹Ÿæ²¡æœ‰å˜åŒ–ï¼ï¼</p><p id="0ede" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">äº‹å®ä¸Šï¼Œå¯¹äºé¡¶çº§å˜é‡ï¼Œéœ€è¦ä½¿ç”¨<code class="du kq kr ks kt b">@SharedImmutable</code>æˆ–<code class="du kq kr ks kt b">@ThreadLocal</code>æ³¨é‡Šã€‚</p><ul class=""><li id="f16e" class="mf mg hh jq b jr kl ju km jx mh kb mi kf mj kj mk ml mm mn bi translated">SharedImmutable:ä½¿å¯¹è±¡å†»ç»“(ä¸å¯å˜)å¹¶å¯ä»å¦ä¸€ä¸ªçº¿ç¨‹è®¿é—®</li><li id="a8a7" class="mf mg hh jq b jr mo ju mp jx mq kb mr kf ms kj mk ml mm mn bi translated">ThreadLocal:ä½¿å¯¹è±¡çŠ¶æ€æˆä¸ºçº¿ç¨‹æœ¬åœ°çš„å’Œå¯å˜çš„(æ”¹å˜åçš„çŠ¶æ€ä¸ä¼šåæ˜ åˆ°å…¶ä»–çº¿ç¨‹)ã€‚</li></ul><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="c022" class="lf ix hh kt b fi lg lh l li lj">@SharedImmutable<br/>val hello = Hello()</span></pre><p id="4f58" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">ç„¶åï¼Œæ§åˆ¶å°ä¸ŠæˆåŠŸæ˜¾ç¤ºä»¥ä¸‹è¡Œã€‚</p><pre class="ku kv kw kx fd lb kt lc ld aw le bi"><span id="6189" class="lf ix hh kt b fi lg lh l li lj"><strong class="kt hi">&lt;NSThread: 0x600002c468c0&gt;{number = 1, name = main}<br/>org.kotlin.mpp.mobile.Hello@39032e8<br/>&lt;NSThread: 0x600002c92080&gt;{number = 3, name = (null)}<br/>org.kotlin.mpp.mobile.Hello@39032e8</strong></span></pre><blockquote class="ll lm ln"><p id="a209" class="jo jp lk jq b jr kl ii jt ju km il jw lo kn jz ka lp ko kd ke lq kp kh ki kj ha bi translated">è¿™äº›æ³¨é‡Šå¯èƒ½ä¼šåœ¨æœªæ¥ç‰ˆæœ¬ä¸­æ¶ˆå¤±ã€‚</p></blockquote><h1 id="7006" class="iw ix hh bd iy iz ja jb jc jd je jf jg in jh io ji iq jj ir jk it jl iu jm jn bi translated">æ‘˜è¦</h1><p id="e610" class="pw-post-body-paragraph jo jp hh jq b jr js ii jt ju jv il jw jx jy jz ka kb kc kd ke kf kg kh ki kj ha bi translated">æˆ‘ä»‹ç»äº†åç¨‹å’ŒK/Nçš„ä¸å˜æ€§ã€‚</p><p id="dc37" class="pw-post-body-paragraph jo jp hh jq b jr kl ii jt ju km il jw jx kn jz ka kb ko kd ke kf kp kh ki kj ha bi translated">æˆ‘æƒ³åœ¨ä¸‹ä¸€ç« å±•ç¤ºä¸€ä¸ªä½¿ç”¨ååº”å¼ç¼–ç¨‹å’Œæ¶æ„æ¡†æ¶çš„ä¾‹å­ã€‚(<em class="lk">å³å°†æ¨å‡º</em>)</p><h1 id="ed8e" class="iw ix hh bd iy iz ja jb jc jd je jf jg in jh io ji iq jj ir jk it jl iu jm jn bi translated">å‚è€ƒ</h1><ul class=""><li id="b175" class="mf mg hh jq b jr js ju jv jx mt kb mu kf mv kj mk ml mm mn bi translated"><a class="ae kk" href="https://kotlinlang.org/docs/reference/coroutines/coroutine-context-and-dispatchers.html" rel="noopener ugc nofollow" target="_blank">https://kot linlang . org/docs/reference/coroutines/coroutine-context-and-dispatchers . html</a></li><li id="2000" class="mf mg hh jq b jr mo ju mp jx mq kb mr kf ms kj mk ml mm mn bi translated">https://ktor.io/quickstart/quickstart/gradle.html<a class="ae kk" href="https://ktor.io/quickstart/quickstart/gradle.html" rel="noopener ugc nofollow" target="_blank"/></li><li id="4ccc" class="mf mg hh jq b jr mo ju mp jx mq kb mr kf ms kj mk ml mm mn bi translated"><a class="ae kk" href="https://kotlinlang.org/docs/reference/native/immutability.html" rel="noopener ugc nofollow" target="_blank">https://kot linlang . org/docs/reference/native/immut ability . html</a></li></ul></div></div>    
</body>
</html>