<html>
<head>
<title>Automatic SMS Verification with SMS user consent</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">经SMS用户同意的自动SMS验证</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/automatic-sms-verification-with-sms-user-consent-da8c16135e25?source=collection_archive---------0-----------------------#2019-08-06">https://medium.com/androiddevelopers/automatic-sms-verification-with-sms-user-consent-da8c16135e25?source=collection_archive---------0-----------------------#2019-08-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/4287844c405b52b41de15b4895e16ddb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LCeoKUok8X5vfX4RS1FVhA.jpeg"/></div></div></figure><div class=""/><p id="b0f5" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你在应用程序中使用一次性代码实现短信验证，请查看新的短信用户同意API。</p><p id="5f0c" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">短信验证是向应用程序添加第二种验证形式的常用方法。通过向用户的电话号码发送包含一次性代码(如“1234”或“481236”)的短信，他们可以将代码输入到您的应用程序中，以确认他们收到了短信。</p><blockquote class="jn"><p id="f34f" class="jo jp hs bd jq jr js jt ju jv jw jm dx translated">发件人:短信</p><p id="e87c" class="jo jp hs bd jq jr js jt ju jv jw jm dx translated">信息:您的一次性代码是1234。</p></blockquote><p id="d5f8" class="pw-post-body-paragraph ip iq hs ir b is jx iu iv iw jy iy iz ja jz jc jd je ka jg jh ji kb jk jl jm ha bi translated">但是——说实话。没有人真正喜欢打出一次性代码。这既乏味又容易出错。因此，虽然它有助于验证您的应用程序，但让体验尽可能无缝也很重要。</p><p id="d6c1" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">SMS用户同意API让您的应用程序提示用户允许阅读包含一次性代码的单个SMS消息的文本。然后，您的应用程序可以解析消息，并自动完成短信验证流程！</p><figure class="kd ke kf kg fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es kc"><img src="../Images/874c8db367346223409a32a72ad26e2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cLl4OwHwmAxBs3M2"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx">Ask the user to read a single text message containing a one-time-code.</figcaption></figure><p id="7ce4" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您已经在使用SMS检索器API，SMS用户同意API不会弃用或替换它。我们添加了第二个API，因为有时应用程序无法修改消息来支持SMS检索器API。</p><p id="429e" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在实现短信用户同意之前，你应该检查一下<a class="ae kl" href="https://developers.google.com/identity/sms-retriever/overview" rel="noopener ugc nofollow" target="_blank">短信检索器API </a>，看看它是否适用于你的应用。如果你能使用它，它会提供更好的用户体验，因为用户可以跳过提示！</p><h1 id="db3e" class="km kn hs bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">API概述</h1><figure class="kd ke kf kg fd hj"><div class="bz dy l di"><div class="lk ll l"/></div><figcaption class="kh ki et er es kj kk bd b be z dx">Introducing the SMS User Consent API.</figcaption></figure><p id="e62a" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这篇文章涵盖了使用API的基础知识——足以让你熟悉方向。要获得完整的API指南(包括一个示例实现),请查看<a class="ae kl" href="https://developers.google.com/identity/sms-retriever/user-consent/overview" rel="noopener ugc nofollow" target="_blank">文档</a>!</p><p id="31ab" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">SMS用户同意API是Google Play服务的一部分。要使用它，您至少需要以下库的版本<code class="du lm ln lo lp b">17.0.0</code>:</p><pre class="kd ke kf kg fd lq lp lr ls aw lt bi"><span id="869d" class="lu kn hs lp b fi lv lw l lx ly">implementation "com.google.android.gms:play-services-auth:17.0.0"<br/>implementation "com.google.android.gms:play-services-auth-api-phone:17.1.0"</span></pre><h2 id="e586" class="lu kn hs bd ko lz ma mb ks mc md me kw ja mf mg la je mh mi le ji mj mk li ml bi translated">第一步:开始收听短信</h2><p id="1cdd" class="pw-post-body-paragraph ip iq hs ir b is mm iu iv iw mn iy iz ja mo jc jd je mp jg jh ji mq jk jl jm ha bi translated">SMS用户许可将侦听包含一次性代码的传入SMS消息长达五分钟。在启动之前，它不会查看任何发送的消息。</p><p id="a651" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">SMS用户许可绝不会提示不包含一次性代码(4-10个字符，至少有一个数字)或来自用户联系人的消息。</p><p id="b192" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你知道发送一次性代码的电话号码，你可以指定<code class="du lm ln lo lp b">senderPhoneNumber</code>，如果你不知道<code class="du lm ln lo lp b">null</code>将匹配任何号码。</p><p id="0697" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要启动SMS用户同意，您可以使用<code class="du lm ln lo lp b">SmsRetriever</code>对象:</p><pre class="kd ke kf kg fd lq lp lr ls aw lt bi"><span id="f5c6" class="lu kn hs lp b fi lv lw l lx ly">smsRetriever.startSmsUserConsent(<br/>    senderPhoneNumber /* or null */)</span></pre><h2 id="1098" class="lu kn hs bd ko lz ma mb ks mc md me kw ja mf mg la je mh mi le ji mj mk li ml bi translated">步骤2:请求同意阅读邮件</h2><p id="a92d" class="pw-post-body-paragraph ip iq hs ir b is mm iu iv iw mn iy iz ja mo jc jd je mp jg jh ji mq jk jl jm ha bi translated">一旦你的应用收到包含一次性代码的消息，它将通过广播得到通知。在这一点上，你没有阅读该消息的许可——相反，你会得到一个<code class="du lm ln lo lp b">Intent</code>,你可以开始提示用户同意。</p><figure class="kd ke kf kg fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es mr"><img src="../Images/b474adf7e2f2fdf329588795c3e520a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Bgiuf3q78lBKX6Aw"/></div></div><figcaption class="kh ki et er es kj kk bd b be z dx">Use the Intent passed to your BroadcastReceiver to show the SMS User Consent prompt.</figcaption></figure><p id="83bf" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在您的<code class="du lm ln lo lp b">BroadcastReceiver</code>中，您使用<code class="du lm ln lo lp b">extras</code>中的<code class="du lm ln lo lp b">Intent</code>来显示提示。</p><p id="88ae" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当您启动该意图时，它将提示用户允许阅读一条消息。</p><p id="a843" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">他们将看到他们将与您的应用程序共享的全部文本。</p><pre class="kd ke kf kg fd lq lp lr ls aw lt bi"><span id="53ab" class="lu kn hs lp b fi lv lw l lx ly">val consentIntent = extras.getParcelable&lt;Intent&gt;(<br/>    SmsRetriever.EXTRA_CONSENT_INTENT)</span><span id="d9f0" class="lu kn hs lp b fi ms lw l lx ly">startActivityForResult(<br/>    consentIntent, <br/>    SMS_CONSENT_REQUEST)</span></pre><h2 id="2695" class="lu kn hs bd ko lz ma mb ks mc md me kw ja mf mg la je mh mi le ji mj mk li ml bi translated">步骤3:解析一次性代码并完成短信验证</h2><p id="1035" class="pw-post-body-paragraph ip iq hs ir b is mm iu iv iw mn iy iz ja mo jc jd je mp jg jh ji mq jk jl jm ha bi translated">当用户点击<code class="du lm ln lo lp b">“Allow”</code>——是时候真正阅读消息了！在<code class="du lm ln lo lp b">onActivityResult</code>里面你可以从资料中得到短信的全文:</p><pre class="kd ke kf kg fd lq lp lr ls aw lt bi"><span id="0646" class="lu kn hs lp b fi lv lw l lx ly">val message = data.<br/>    getStringExtra(<br/>        SmsRetriever.EXTRA_SMS_MESSAGE)</span></pre><p id="acd6" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然后，您解析SMS消息，并将一次性代码传递到您的后端！</p><h1 id="2673" class="km kn hs bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">了解更多信息</h1><p id="e32d" class="pw-post-body-paragraph ip iq hs ir b is mm iu iv iw mn iy iz ja mo jc jd je mp jg jh ji mq jk jl jm ha bi translated">SMS用户同意API帮助您为用户提供良好的用户体验。通过自动解析一次性代码，用户能够轻松地完成短信验证流程，这样他们就可以回到他们正在做的事情。</p><p id="b40f" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要了解更多信息，包括完整的代码清单，请查看文档！</p><ul class=""><li id="9393" class="mt mu hs ir b is it iw ix ja mv je mw ji mx jm my mz na nb bi translated"><a class="ae kl" href="https://developers.google.com/identity/sms-retriever/user-consent/overview" rel="noopener ugc nofollow" target="_blank">通过短信用户同意API进行一键式短信验证</a></li><li id="023c" class="mt mu hs ir b is nc iw nd ja ne je nf ji ng jm my mz na nb bi translated"><a class="ae kl" href="https://developers.google.com/identity/sms-retriever/user-consent/request" rel="noopener ugc nofollow" target="_blank">请求一次性同意阅读短信验证码</a></li></ul></div></div>    
</body>
</html>