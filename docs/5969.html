<html>
<head>
<title>How to Use Azure AD to Secure OCI API Gateway With OAuth and JWT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Azure AD通过OAuth和JWT保护OCI API网关</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/how-to-use-azure-ad-to-secure-oci-api-gateway-with-oauth-and-jwt-d3762072ff42?source=collection_archive---------0-----------------------#2022-09-30">https://medium.com/oracledevs/how-to-use-azure-ad-to-secure-oci-api-gateway-with-oauth-and-jwt-d3762072ff42?source=collection_archive---------0-----------------------#2022-09-30</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="a40d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Azure AD是Azure中流行的身份和访问管理(IAM)服务。它是基于云的，可以作为OAuth 2.0 IdP，使得跨多云的SSO变得容易和流畅。OCI API网关是一个坚如磐石的API管理解决方案，用于保护和控制OCI的API。API网关可以使用Azure AD OAuth功能来保护和授权API端点。如何基于JWT在OCI的Azure AD和API Gateway之间设置OAuth SSO？Azure AD和API Gateway之间JWKS密钥不兼容怎么办？如何在OCI配置API网关使用Azure AD发行的JWT？继续阅读，找出答案。</p><p id="4ac1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">先决条件:</p><ul class=""><li id="d3f1" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">你有权使用OCI和Azure的租约。</li><li id="8cd2" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">您有一个客户端应用程序，需要连接到OCI的API网关。我将使用Visual Builder进行演示。不过，你可以使用你的任何一个，因为应用程序在Azure AD中注册，并为JWT发行实现简单的<a class="ae jq" href="https://learn.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow" rel="noopener ugc nofollow" target="_blank"> OAuth客户端凭证流</a>。</li><li id="7d95" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">你对OCI的<a class="ae jq" href="https://docs.oracle.com/en-us/iaas/Content/APIGateway/Concepts/apigatewayoverview.htm" rel="noopener ugc nofollow" target="_blank"> API网关</a>和<a class="ae jq" href="https://docs.oracle.com/en-us/iaas/Content/Functions/Concepts/functionsoverview.htm" rel="noopener ugc nofollow" target="_blank">函数</a>有基本的了解。</li><li id="e880" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">您已经在OCI为API网关和功能创建了一个虚拟云网络(VCN)。</li></ul><h1 id="a65c" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">介绍</h1><p id="0382" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">在多云时代，最好在不同的超大规模云中使用分布式组件。此示例将确保Azure AD OAuth IdP使用JWT令牌和OAuth客户端凭据流保护OCI的API部署。该流程通常易于使用，因为它需要从Azure AD IdP导出(1) JWKS密钥，并将它们导入OCI API网关。然后，客户端应用程序调用Azure AD IdP来(2)使用客户端凭据发布JWT，并从响应中获取JWT。最后，客户端应用程序向JWT提供针对OCI受保护API网关资源的(3)请求。下面按照体系结构顺序描述了提到的三个步骤。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/f0717d15868c9165841cdf26160a6b2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nQ4oLCiUwd6eoDI9.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx">Ideal architecture</figcaption></figure><p id="c9e9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于JWKS中与键中缺少<code class="du lk ll lm ln b">alg</code>字段相关的某些限制，我们需要在OCI开发JWKS适配器组件，作为上面序列(1)的代理。JWKS适配器通过添加必需的<code class="du lk ll lm ln b">alg</code>字段来动态修改JWKS，将其设置为<code class="du lk ll lm ln b">RS256</code>。此外，JWKS适配器通过从密钥中移除<code class="du lk ll lm ln b">x5c</code>来减小JWKS的总大小。JWKS适配器是使用函数构建的，API网关是OCI。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lo"><img src="../Images/2416a41405f4297247b0ead4c6d7b648.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*G74tFlu6FDybUXTy.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx">Target architecture with JWKS Adapter component</figcaption></figure><p id="d63f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">目标架构由四个主要组件组成:</p><ul class=""><li id="3fc2" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">(A)活动目录OAuth IdP [Azure]</li><li id="3cb7" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">JWKS适配器[OCI]</li><li id="bf8b" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">安全API [OCI]</li><li id="0051" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">客户应用程序</li></ul><p id="e26a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">JWKS适配器(B)在安全API和(A) Active Directory OAuth IdP之间扮演反向代理的角色。该序列从API Gateway (3)从另一个API部署中检索适配的jwk开始，充当该功能的门面。API部署(2)调用函数，函数(1)调用Azure JWKS并动态修改它。当消息被返回给最初的请求者JWKS适配器时，它是一组来自Azure的修改过的JWKS，准备在API Gateway中使用。</p><p id="c479" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">确保遵循以下步骤:</p><ol class=""><li id="f167" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb lp ji jj jk bi translated">配置(A) Azure Active Directory OAuth IdP</li><li id="c961" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb lp ji jj jk bi translated">使用OCI函数构建和部署(B) JWKS适配器</li><li id="c6d7" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb lp ji jj jk bi translated">使用API网关和JWT部署安全API</li></ol><h1 id="fbcd" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">1.配置(A) Azure Active Directory OAuth IdP</h1><p id="caaf" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">在Azure控制台上打开Azure Active Directory。从左侧菜单中选择<code class="du lk ll lm ln b">App registrations</code>并按下<code class="du lk ll lm ln b">New registration</code>按钮，注册一个新应用程序。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/c209b92e8d5d7d36909f7f85e48d3214.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*m-8alXniRHWCcnmg.png"/></div></div></figure><p id="41fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">给应用程序起一个友好的名字，选择选项<code class="du lk ll lm ln b">Accounts in this organizational directory only (Default Directory only - Single tenant)</code>并按下<code class="du lk ll lm ln b">Register</code>。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/98e083134c810a00368aeab9bf9441dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SGqvc2_qLFulBBZ5.png"/></div></div></figure><p id="1f0e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意<code class="du lk ll lm ln b">Application (client) ID</code>，因为我们将在令牌生成API中使用它作为凭证。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/cbccc11dcec1a0f5e48c2abb7ff8a6e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mu3GTBWrkL-EDF54.png"/></div></div></figure><p id="c048" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从左侧菜单中选择<code class="du lk ll lm ln b">Certificates &amp; secrets</code>并按下<code class="du lk ll lm ln b">New client secret</code>按钮。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/1a4ce81e2069d0eda7eb525a2fccdfd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yvHfU7CqjD8U3rlV.png"/></div></div></figure><p id="520b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">输入简短的密码描述并选择到期选项。默认情况下，密码的到期时间设置为6个月。这个秘密将与步骤3中的<code class="du lk ll lm ln b">Application (client) ID</code>配对。最后，按下<code class="du lk ll lm ln b">Add</code>按钮。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/e2c6bf668d910071aa11f742081c62da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2FkwWKb_ZyTnHvsp.png"/></div></div></figure><p id="905d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过复制<code class="du lk ll lm ln b">Value</code>字段记录秘密。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/03c7d266582c3d944717404c20d08fae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KBPrPGZuwUDiupNv.png"/></div></div></figure><p id="f417" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从左侧菜单中选择<code class="du lk ll lm ln b">Token configuration</code>并按下<code class="du lk ll lm ln b">Add optional claim</code>按钮。然后选择<code class="du lk ll lm ln b">Access</code>令牌类型并选择<code class="du lk ll lm ln b">aud</code>声明。按下<code class="du lk ll lm ln b">Add</code>按钮完成动作。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/8304c656bbc6648173f2fe4a01c78c81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*R1r3ZeuWOF_-Z_L9.png"/></div></div></figure><p id="f0d3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从左侧菜单返回到<code class="du lk ll lm ln b">Overview</code>，按<code class="du lk ll lm ln b">Endpoints</code>按钮并复制<code class="du lk ll lm ln b">OAuth 2.0 token endpoint (v1)</code> URL，该URL将用于JWT代币的发行。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/43eaffabc77ae26a56b3a7d695de7f69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0DcYJEFtue1xhQLw.png"/></div></div></figure><h1 id="a240" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">2.使用OCI函数构建和部署(B) JWKS适配器</h1><p id="88ad" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">按下<code class="du lk ll lm ln b">Create application</code>按钮，为JWKS适配器功能创建一个应用程序。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/aec2472c5f7ff45344e35d8a0ee58046.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dbCusPQ4DtMSkDOi.png"/></div></div></figure><p id="e06d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">确保您配置了正确的VCN，并准备好托管JWKS适配器功能。输入一个名称(如<code class="du lk ll lm ln b">jwks-adapter</code>)并按<code class="du lk ll lm ln b">Create</code>。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/ab6246a6d8134476b73b9707b7cfaf5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*neNCs9-2ikOfWu4h.png"/></div></div></figure><p id="ccaf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">创建应用程序后，从左侧菜单中选择<code class="du lk ll lm ln b">Getting started</code>并遵循<code class="du lk ll lm ln b">Setup fn CLI on Cloud Shell</code>指南。按照步骤1到7进行操作。您需要通过按按钮或选择页面右上方的图标来启动云壳。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/2d5d6554556f65bc8045b17e2597c765.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*q7fi7_Nd0xuv4q3H.png"/></div></div></figure><p id="31f4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">保持云Shell打开，从GitHub克隆适配器功能</p><pre class="kv kw kx ky fd lr ln ls lt aw lu bi"><span id="a03e" class="lv js hh ln b fi lw lx l ly lz">git clone <a class="ae jq" href="https://github.com/ivandelic/how-to-use-azure-ad-to-secure-oci-api-gateway-with-oauth-and-jwt.git" rel="noopener ugc nofollow" target="_blank">https://github.com/ivandelic/how-to-use-azure-ad-to-secure-oci-api-gateway-with-oauth-and-jwt.git</a></span></pre><p id="e16a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">进入克隆的存储库，并将适配器功能部署到步骤1中创建的应用程序。确保<code class="du lk ll lm ln b">--app</code>参数等于应用程序名称。</p><pre class="kv kw kx ky fd lr ln ls lt aw lu bi"><span id="9c85" class="lv js hh ln b fi lw lx l ly lz">fn -v deploy --app jwks-adapter</span></pre><p id="c418" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过调用来测试新部署的函数</p><pre class="kv kw kx ky fd lr ln ls lt aw lu bi"><span id="e19e" class="lv js hh ln b fi lw lx l ly lz">fn invoke jwks-adapter azure-jwks-transformator</span></pre><p id="0a07" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果配置正确，它应该返回类似于:</p><pre class="kv kw kx ky fd lr ln ls lt aw lu bi"><span id="9043" class="lv js hh ln b fi lw lx l ly lz">ivan_delic@cloudshell:~ (eu-frankfurt-1)$ fn invoke jwks-adapter azure-jwks-transformator {"keys":[{"kty":"RSA","use":"sig","kid":"nOo3ZDrODXEK1jKWhXslHR_KXEg","x5t":"nOo3ZDrODXEK1jKWhXslHR_KXEg","n":"oaLLT9hkcSj2tGfZsjbu7Xz1Krs0qEicXPmEsJKOBQHauZ_kRM1HdEkgOJbUznUspE6xOuOSXjlzErqBxXAu4SCvcvVOCYG2v9G3-uIrLF5dstD0sYHBo1VomtKxzF90Vslrkn6rNQgUGIWgvuQTxm1uRklYFPEcTIRw0LnYknzJ06GC9ljKR617wABVrZNkBuDgQKj37qcyxoaxIGdxEcmVFZXJyrxDgdXh9owRmZn6LIJlGjZ9m59emfuwnBnsIQG7DirJwe9SXrLXnexRQWqyzCdkYaOqkpKrsjuxUj2-MHX31FqsdpJJsOAvYXGOYBKJRjhGrGdONVrZdUdTBQ","e":"AQAB","alg":"RS256"},...]}</span></pre><p id="68f0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从OCI菜单中找到你的API网关，选择<code class="du lk ll lm ln b">Deployments</code>，按<code class="du lk ll lm ln b">Create deployment</code>。这将使我们的适配器函数成为可调用的。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/cfd8ecf4d65143fa8e9a6e57282ae565.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*P7mKJ-uo6V4ZUtix.png"/></div></div></figure><p id="be14" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">填充<code class="du lk ll lm ln b">Name</code>和<code class="du lk ll lm ln b">Path</code>并按下<code class="du lk ll lm ln b">Next</code>。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/f70b8dfbe6d909ac0cd6408bf75b1ac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9V04Kfw5a8_MN6Y1.png"/></div></div></figure><p id="c93f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将部署留给<code class="du lk ll lm ln b">No Authentication</code>，因为它将只用于代理和修改Azure JWKS，并使其适应API Gateway的预期格式。按下<code class="du lk ll lm ln b">Next</code>继续。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/37328ff5ae0773acbbcd3bb60952d336.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pIP7bMPVO_yc5JXS.png"/></div></div></figure><p id="4b2e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">创建一条路线，定义一个<code class="du lk ll lm ln b">Path</code>和<code class="du lk ll lm ln b">Methods</code>。用<code class="du lk ll lm ln b">Oracle functions</code>类型选择<code class="du lk ll lm ln b">Single backend</code>。选择在前面步骤中部署的应用程序和功能。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/c8774f92ead4d8cd4549c2e00393dfbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*q0-EXqIjqVO2SsV7.png"/></div></div></figure><p id="1b74" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">查看部署并按下<code class="du lk ll lm ln b">Create</code>。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/7579ae74038e201d27136c28b2bb6743.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*txvBiATkG5UbhGtV.png"/></div></div></figure><p id="c90e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">等到展开处于<code class="du lk ll lm ln b">Active</code>状态，复制<code class="du lk ll lm ln b">Endpoint</code>。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/4d7c2b0280ecba9987f63fa1028344cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Lulcigogm6InbtJv.png"/></div></div></figure><p id="1af5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用Postman或类似的工具来测试端点。它应该检索带有修改值的Azure JWKS。粘贴复制的端点，并在其后添加步骤10中的<code class="du lk ll lm ln b">Route</code>路径。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/49c5cea39a195f9e0bc32185d65191e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EGPGEPi3R--uO5LC.png"/></div></div></figure><h1 id="a2e2" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">3.使用API网关和JWT部署安全API</h1><p id="7d05" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">从OCI菜单中找到您的API网关，选择<code class="du lk ll lm ln b">Deployments</code>，然后按<code class="du lk ll lm ln b">Create deployment</code>。我们将创建一个由JWT保护的API。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/2de75af4a2618216ce90e68cf145cd7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xhyZWrJGuCZDbYHu.png"/></div></div></figure><p id="fbaa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">填充<code class="du lk ll lm ln b">Name</code>和<code class="du lk ll lm ln b">Path</code>并按下<code class="du lk ll lm ln b">Next</code>。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/4482dc8939c57a55098df30290270118.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uICUe_nAkhxS2R1X.png"/></div></div></figure><p id="b9d4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们将使用JSON Web Token (JWT)来保护API。在认证步骤下，选择<code class="du lk ll lm ln b">Single Authentication</code>。将JWT令牌位置选择到<code class="du lk ll lm ln b">Header</code>，并将标题名称定义到<code class="du lk ll lm ln b">Authorization</code>。使用认证方案<code class="du lk ll lm ln b">Bearer</code>。按下<code class="du lk ll lm ln b">Next</code>继续。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/c924fa6e6848574d0c2d77e3b454beb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QBwZR0BQWxYmR_tR.png"/></div></div></figure><p id="9f0c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">定义<code class="du lk ll lm ln b">Allowed issuer</code>和<code class="du lk ll lm ln b">Allowed audience</code>。既然我们用的是v1令牌API，<code class="du lk ll lm ln b">Allowed issuer</code>就应该设为<code class="du lk ll lm ln b">https://sts.windows.net/{tenant-id}/</code>。将{tenant-id}替换为您的Azure租户id。<code class="du lk ll lm ln b">Allowed audience</code>应该包含<code class="du lk ll lm ln b">aud</code>索赔值，默认情况下，除非明确设置，否则为<code class="du lk ll lm ln b">00000002-0000-0000-c000-000000000000</code>。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/f44513b5ce197522e33f625a20d9afea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WuEWexi_dL8g-rzS.png"/></div></div></figure><p id="ea21" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于公钥，确保选择<code class="du lk ll lm ln b">Remote JWKS</code>并输入<code class="du lk ll lm ln b">JWKS URI</code>以匹配<code class="du lk ll lm ln b">JWKS Adapter</code>功能的部署</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/0aee599d3616017a2fac910022f26393.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*06acknpirV230i2L.png"/></div></div></figure><p id="099e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">创建一条路线，定义一个<code class="du lk ll lm ln b">Path</code>和<code class="du lk ll lm ln b">Methods</code>。用<code class="du lk ll lm ln b">Stock response</code>类型选择<code class="du lk ll lm ln b">Single backend</code>。定义简单的正文和状态代码。按下一步继续。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/cd408c3df56cc9733bc61a74435c7199.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NoMBQlX2dGVScUSG.png"/></div></div></figure><p id="3579" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">查看部署并按下<code class="du lk ll lm ln b">Create</code>。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/4cd4a73310c71679425af14d885a4124.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5TgP8GWvsatz6Uzx.png"/></div></div></figure><p id="250c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">等到展开处于<code class="du lk ll lm ln b">Active</code>状态，复制<code class="du lk ll lm ln b">Endpoint</code>。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/c80b8bb7588faf930f41adc8d1f608e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zxCt9Mum3vSyBzJI.png"/></div></div></figure><p id="7201" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用Postman从Azure AD中检索JWT令牌。输入令牌API URL<a class="ae jq" href="https://login.microsoftonline.com/%7Btenant-id%7D/oauth2/token" rel="noopener ugc nofollow" target="_blank">https://login.microsoftonline.com/{tenant-id}/oauth2/token</a>，同时用您的Azure租户id替换{tenant-id}。发送请求并复制<code class="du lk ll lm ln b">access_token</code>值。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/0b8e0ffe9fe0fe40a863067f91be8e74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*z8oc4_mxTqmGQwk7.png"/></div></div></figure><p id="686d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，使用Postman测试安全的API端点。粘贴复制的端点，并在其后添加步骤6中的<code class="du lk ll lm ln b">Route</code>路径。添加授权头，使用承载方案，并粘贴上一步中颁发的JWT令牌。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lq"><img src="../Images/795e5a0aa356c88fe8870cd6d76256d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NdlLo5PJ9wnGhXnP.png"/></div></div></figure><p id="6b12" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">就是这样。您已经使用Azure AD JWT保护了API网关部署。</p></div><div class="ab cl ma mb go mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ha hb hc hd he"><p id="58ba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你对甲骨文开发人员在他们的自然栖息地发生的事情感到好奇，来<a class="ae jq" href="https://bit.ly/odevrel_slack" rel="noopener ugc nofollow" target="_blank">加入我们的公共休闲频道</a>！</p><p id="e6ee" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您还没有注册，现在就可以<a class="ae jq" href="https://signup.cloud.oracle.com/?language=en" rel="noopener ugc nofollow" target="_blank">注册Oracle云免费层帐户</a>。如果你对如何开始学习OCI感兴趣，注册是第一步，没有必要跟着这篇文章走。</p></div></div>    
</body>
</html>