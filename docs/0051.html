<html>
<head>
<title>Unlocking Horizontal Scalability in Our Web Serving Tier</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在我们的Web服务层中释放水平可伸缩性</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/unlocking-horizontal-scalability-in-our-web-serving-tier-d907449cdbcf?source=collection_archive---------0-----------------------#2016-10-13">https://medium.com/airbnb-engineering/unlocking-horizontal-scalability-in-our-web-serving-tier-d907449cdbcf?source=collection_archive---------0-----------------------#2016-10-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="4785" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由<a class="ae jc" href="https://www.linkedin.com/in/liang-guo-04189a" rel="noopener ugc nofollow" target="_blank">郭亮</a></p></div><div class="ab cl jd je go jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="ha hb hc hd he"><p id="5419" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Airbnb的网络应用由Ruby on Rails和Java提供支持。面向web的应用程序是一个单片Rails应用程序，它运行在许多web服务器上。Web请求由Rails应用程序处理，它与几个不同的Java服务对话，例如搜索服务或列表定价服务。在Airbnb的技术栈中，MySQL数据库扮演着存储核心商业数据的关键角色。我们按应用程序对数据库进行分区，以便于容量规划。例如，用户的消息线程和列表日历管理与核心预订流程是分开的，它们应该在自己的数据库中进行管理。2015年，我们本着按功能划分核心数据库的精神，做了几项数据库操作(参见这篇<a class="ae jc" rel="noopener" href="/airbnb-engineering/how-we-partitioned-airbnb-s-main-database-in-two-weeks-55f7e006ff21#.squ902fhn">工程博客文章</a>了解我们是如何做的)。随着站点流量每年以惊人的速度增长，基础架构团队通过横向扩展应用程序服务器层以获得计算容量，以及纵向分区数据库以获得数据库扩展空间来做出响应。在2015年夏季旺季，这种双层架构一直运行得非常好。然而，MySQL数据库的一个值得注意的资源问题是来自应用服务器的数据库连接数不断增加。</p><h1 id="71e3" class="jk jl hh bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">问题</h1><p id="0c11" class="pw-post-body-paragraph ie if hh ig b ih ki ij ik il kj in io ip kk ir is it kl iv iw ix km iz ja jb ha bi translated">我们使用AWS的关系数据库服务(RDS)来运行MySQL实例。RDS使用MySQL server的community edition，它采用一个连接一个线程的连接管理模型。MySQL服务器中的线程模型很可能会遇到著名的<a class="ae jc" href="http://www.kegel.com/c10k.html" rel="noopener ugc nofollow" target="_blank"> C10K问题</a>。C10K问题是，在不显著增加运行线程数量的情况下，MySQL服务器可以接受和服务的连接数有一个上限，这将严重降低MySQL服务器的性能。在MySQL中，<em class="kn"> Threads_running </em>计数器测量并发执行的查询数量。然而，由于InnoDB存储引擎线程并发性有限，这一指标的峰值实际上意味着MySQL数据库中的客户端查询堆积如山。当这种情况发生时，MySQL查询延迟增加，请求在整个堆栈中排队，错误率激增。</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es ko"><img src="../Images/fdc7883aec351ec9ab30274209462e2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zy326_u1siK5QoFXcFjY-Q.png"/></div></div></figure><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es la"><img src="../Images/13b5ea371959a48d7c0635e827eaf604.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xzo_R_HPSr_YyIZ6QciEgg.png"/></div></div></figure><p id="13cb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在生产中，我们遇到了几起严重的数据库事件，表现为正在运行的MySQL服务器线程数量激增。上图显示了<em class="kn"> Threads_running </em>峰值和同时出现的应用程序错误率峰值。虽然根本原因可能是由于编写不当的查询或底层存储系统中断，但MySQL数据库服务器通常需要很长时间才能恢复。通常，工程师不得不求助于手动终止连接作为稳定手段。</p><p id="52c3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">尽管运行spike的线程很糟糕，但最紧迫的问题甚至不是消防数据库事件，因为它们会导致站点停机。这是数据库连接的限制。运行面向web的应用程序的应用服务器直接连接到核心RDS数据库。MySQL服务器为每个客户端连接分配线程堆栈和其他资源。尽管可以调整线程堆栈的大小以允许处理更多的客户端连接，但这是一种有限的资源。大量线程也会导致调度和上下文切换问题。当RDS MySQL服务器达到资源限制时，客户端将无法创建连接。数据库连接限制限制了应用服务器处理不断增长的流量的能力。在2015年夏末，由于预见到2016年夏季流量的扩展瓶颈，基础设施可扩展性团队的工程师开始寻找可行的解决方案。</p><h1 id="0233" class="jk jl hh bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">Airbnb MaxScale数据库代理</h1><p id="c062" class="pw-post-body-paragraph ie if hh ig b ih ki ij ik il kj in io ip kk ir is it kl iv iw ix km iz ja jb ha bi translated">公平地说，MySQL有一个动态线程池特性，然而，它只在MySQL企业版中可用。MySQL的Percona服务器和MariaDB也有类似的服务。由于Airbnb使用AWS MySQL RDS，我们无法访问MySQL线程池功能。我们不得不寻找一个外部代理来解决连接限制。我们调查了几种不同的开源技术，我们选择了MariaDB MaxScale。MariaDB MaxScale是一个MySQL数据库代理，支持客户端应用程序和一组后端MySQL服务器之间的智能查询路由。然而，MaxScale没有解决连接限制问题，因为它需要为每个客户端连接建立一个后端MySQL服务器连接。因为我们寻找的是连接池，所以我们决定派生MariaDB MaxScale并自己实现它。</p><h2 id="5cf5" class="lb jl hh bd jm lc ld le jq lf lg lh ju ip li lj jy it lk ll kc ix lm ln kg lo bi translated"><strong class="ak">连接池</strong></h2><p id="ab48" class="pw-post-body-paragraph ie if hh ig b ih ki ij ik il kj in io ip kk ir is it kl iv iw ix km iz ja jb ha bi translated">在Airbnb MaxScale中，连接池是通过将N个客户端连接复用到M个后端MySQL服务器连接上来实现的。在客户端连接请求完成与后端MySQL服务器的成功认证之后，代理切断后端连接和客户端连接之间的链接，并将其驻留在后端服务器的连接池中。服务器连接池的大小是可配置的，通常是一个很小的数字。因为我们分叉了MariaDB MaxScale 1.3开发人员分支，所以我们能够利用持久连接特性来实现服务器连接池。当收到客户端连接的查询时，MaxScale在池中挑选一个后端连接，将其与客户端连接链接，并将查询转发到后端MySQL服务器。MaxScale了解客户端会话的事务上下文，因此它知道在事务提交之前保持链接的后端连接。该链接必须被保留并用于将查询结果转发回客户端。</p><p id="4fcf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个连接池实现中的一个挑战是知道何时解除后端连接到池的链接，以及何时将后端连接返回到池。一个查询响应由一个或多个MySQL包组成。因为MaxScale在客户端连接和后端连接之间保持一对一的链接，所以它只是在响应包到达时转发它们。在连接池模式下，过早地断开后端连接会导致客户端无限期地等待完整的MySQL数据包。为了正确转发MySQL查询响应，我们通过遵循COM_QUERY_RESPONSE的MySQL客户端服务器协议来实现MySQL数据包。这样，Airbnb MaxScale在看到查询响应的完整MySQL包之前，不会取消后端连接的链接。除了转发响应之外，它还允许我们测量查询响应大小以进行监控。</p><h2 id="0f1a" class="lb jl hh bd jm lc ld le jq lf lg lh ju ip li lj jy it lk ll kc ix lm ln kg lo bi translated"><strong class="ak">请求节流</strong></h2><p id="82f7" class="pw-post-body-paragraph ie if hh ig b ih ki ij ik il kj in io ip kk ir is it kl iv iw ix km iz ja jb ha bi translated">在生产中，典型的服务器连接池大小被配置为10。对于Airbnb MaxScale代理服务器的许多实例，MySQL服务器上的数据库连接数是数百个。在正常情况下，只有一小部分连接在使用中。当发生底层存储中断或高成本查询时，查询执行会变得很慢，并且每个MaxScale代理服务器实例上的服务器连接池会明显耗尽。我们将该症状视为后端MySQL服务器可能遇到并发线程运行峰值问题的信号，并通过终止客户端连接来主动抑制客户端请求。在生产中，请求限制已被证明非常有助于防止由于存储系统暂时停机而导致的数据库事故。</p><h2 id="d8ea" class="lb jl hh bd jm lc ld le jq lf lg lh ju ip li lj jy it lk ll kc ix lm ln kg lo bi translated"><strong class="ak">查询黑名单</strong></h2><p id="87aa" class="pw-post-body-paragraph ie if hh ig b ih ki ij ik il kj in io ip kk ir is it kl iv iw ix km iz ja jb ha bi translated">MaxScale使用嵌入式MySQL解析器进行查询路由。它实际上在其查询分类器模块中为每个MySQL查询构建了一个解析树。我们利用Airbnb MaxScale中的查询解析树查找错误查询块列表。这个特性的动机是保护我们免受Ruby VM堆内存损坏。内存损坏会导致Rails ActiveRecord生成的MySQL查询语句被损坏，从而导致其条件谓词被完全删除。这篇<a class="ae jc" href="http://webuild.envato.com/blog/tracking-down-ruby-heap-corruption/" rel="noopener ugc nofollow" target="_blank">博文</a>详细解释了令人讨厌的Ruby堆损坏问题。</p><p id="1805" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">MySQL解析树使得检查MySQL查询的谓词列表变得容易。查询块列表功能利用MySQL解析树来查找update和delete语句中是否存在格式错误的谓词条件，并拒绝此类语句。为了提供更多的保护，我们还屏蔽了没有任何谓词条件的MySQL更新和删除语句。我们部署了具有查询阻止列表功能的Airbnb MaxScale，它保护我们免受至少一个可怕的损坏查询实例的影响，该实例可能会对我们的一个核心数据库表造成损坏。</p><h2 id="caa8" class="lb jl hh bd jm lc ld le jq lf lg lh ju ip li lj jy it lk ll kc ix lm ln kg lo bi translated"><strong class="ak">数据库代理即服务</strong></h2><p id="6fc4" class="pw-post-body-paragraph ie if hh ig b ih ki ij ik il kj in io ip kk ir is it kl iv iw ix km iz ja jb ha bi translated">MariaDB MaxScale支持多工作线程模型。出于实际原因，我们选择在Airbnb MaxScale代理服务器中使用单个工作线程，并且我们部署了许多实例来实现并发。在Airbnb，我们使用<a class="ae jc" href="http://nerds.airbnb.com/smartstack-service-discovery-cloud/" rel="noopener ugc nofollow" target="_blank">智能堆栈</a>进行服务发现。我们部署了一个Airbnb MaxScale服务器集群，作为每个核心生产MySQL数据库的数据库代理服务。应用程序发现并连接到数据库代理服务，而不是MySQL数据库。通过应用服务器和MySQL服务器之间的Airbnb MaxScale数据库代理服务，web应用层可以根据容量需求进行水平扩展。作为核心架构中的一个新层，数据库代理服务也可以通过启动新的Airbnb MaxScale代理服务器实例进行水平扩展。</p><p id="e06f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该图展示了三层架构，其中不同的数据库代理服务部署在不同的核心MySQL数据库前面。</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es lp"><img src="../Images/1795062fd693dbe078a5e54af0b4892b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l33PEh03d-xgLZiv3XGeYg.png"/></div></div></figure><h2 id="c82c" class="lb jl hh bd jm lc ld le jq lf lg lh ju ip li lj jy it lk ll kc ix lm ln kg lo bi translated"><strong class="ak">延迟影响</strong></h2><p id="5312" class="pw-post-body-paragraph ie if hh ig b ih ki ij ik il kj in io ip kk ir is it kl iv iw ix km iz ja jb ha bi translated">Airbnb MaxScale数据库代理引入了一个额外的网络跃点。MaxScale代理中的计算是轻量级的，因为它只请求路由和响应转发。我们在Airbnb MaxScale中添加的连接池特性非常简单，不会增加开销。由于担心额外的网络跳可能会产生延迟影响，我们在SmartStack中实施了可用性区域感知请求路由。SmartStack用于将请求路由到随机可用性区域(AZ)中的后端服务器。AZ感知路由允许应用程序服务器向同一可用性区域中的数据库代理服务器发送请求。我们使用数据库工作负载重放框架进行了广泛的压力测试，发现延迟问题非常小，甚至可以忽略不计。当我们准备推出时，我们对Airbnb MaxScale有很高的信心。</p><h1 id="67fa" class="jk jl hh bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">结果</h1><p id="f06c" class="pw-post-body-paragraph ie if hh ig b ih ki ij ik il kj in io ip kk ir is it kl iv iw ix km iz ja jb ha bi translated">2016年早些时候，我们将Airbnb MaxScale部署到生产中。在一次平稳的操作中，我们将monolithic Rails应用程序连接从直接连接到MySQL服务器切换到数据库代理服务层。MaxScale符合MySQL协议。将连接切换到Airbnb MaxScale不需要任何客户端应用程序更改。下图显示了当我们执行操作时，一个核心数据库上的数据库连接数急剧下降。</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div class="er es lq"><img src="../Images/7205aee25d37d7166aa49407066ded2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*Vqt0Id-KWIigYWO_AaNcJw.png"/></div></figure><p id="2cff" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">相应地，应用程序的连接转移到了新的Airbnb MaxScale数据库代理服务。当我们部署新的数据库代理时，我们的一些MySQL数据库处于数据库连接限制的边缘。因此，它在关键时刻投入了生产。</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div class="er es lr"><img src="../Images/73d2e438eeb72a5f79972fea8c0a053b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*z4hDV4vhjl4JpBbh0L172g.png"/></div></figure><p id="d26a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">借助连接池数据库代理，我们能够通过添加更多服务器来扩展应用服务器层，而无需增加MySQL服务器线程。我们带着平静的心态进入了2016年夏季，我们将拥有在夏季高峰期处理另一项创纪录流量所需的服务能力。</p><p id="f370" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">今天，我们有超过15个Airbnb MaxScale数据库代理服务在生产中，每个都用于不同的核心MySQL数据库，并具有不同的配置容量。数百个MaxScale服务器实例在web应用服务器和MySQL数据库之间处理请求。自动请求节流已经有效地作为一种背压机制工作，并且它本质上取代了工程师手动终止连接。它一直运行可靠，在生产中没有出现过一例死机的情况。</p><p id="a26e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Airbnb engineering，我们坚信开源。到目前为止，我们在Airbnb MaxScale上的生产体验非常好。我们希望与社区分享它，因此我们宣布我们已经开源Airbnb MaxScale。完整的源代码和文档可以在<a class="ae jc" href="https://github.com/airbnb/MaxScale" rel="noopener ugc nofollow" target="_blank"> github </a>上找到。请尝试一下，并随时与我们分享您的评论和请求。如果你觉得解决这类问题很有趣，我们正在招聘有才华的基础设施工程师，请和我们一起工作。</p></div><div class="ab cl jd je go jf" role="separator"><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji jj"/><span class="jg bw bk jh ji"/></div><div class="ha hb hc hd he"><h2 id="fd25" class="lb jl hh bd jm lc ld le jq lf lg lh ju ip li lj jy it lk ll kc ix lm ln kg lo bi translated">在<a class="ae jc" href="http://airbnb.io" rel="noopener ugc nofollow" target="_blank"> airbnb.io </a>查看我们所有的开源项目，并在Twitter上关注我们:<a class="ae jc" href="https://twitter.com/AirbnbEng" rel="noopener ugc nofollow" target="_blank">@ Airbnb eng</a>+<a class="ae jc" href="https://twitter.com/AirbnbData" rel="noopener ugc nofollow" target="_blank">@ Airbnb data</a></h2></div></div>    
</body>
</html>