<html>
<head>
<title>How to use Ktor client on Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Android上使用Ktor客户端</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/how-to-use-ktor-client-on-android-dcdeddc066b9?source=collection_archive---------0-----------------------#2021-02-18">https://medium.com/google-developer-experts/how-to-use-ktor-client-on-android-dcdeddc066b9?source=collection_archive---------0-----------------------#2021-02-18</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="962a" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">使用Ktor客户端走向Kotlin多平台</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/bbfaf8d07ad395f1ed26d15032bd681c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jgsM06S1jUYdSDXNKbc52g.png"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx"><a class="ae jm" href="https://github.com/ktorio/ktor" rel="noopener ugc nofollow" target="_blank">https://github.com/ktorio/ktor</a></figcaption></figure><p id="0bad" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">Ktor是一个异步开源框架，用于创建微服务和web应用。它是由Jetbrains和Kotlin一起开发的。它易于安装和使用，如果您想在执行管道中添加一个步骤，它是可扩展的。由于<a class="ae jm" href="https://developer.android.com/kotlin/coroutines" rel="noopener ugc nofollow" target="_blank">协程</a>和<a class="ae jm" href="https://kotlinlang.org/docs/reference/multiplatform.html" rel="noopener ugc nofollow" target="_blank">多平台</a>，它的异步属性允许它接收多个请求。</p><p id="2fa5" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">Ktor是多平台的，是的多平台！这意味着我们可以在任何地方部署Ktor应用程序，并且不仅仅是作为服务器，我们还可以使用Ktor客户端在Android、iOS或JS上消费微服务。Ktor客户端允许你发出请求和处理响应，用<a class="ae jm" href="https://ktor.io/docs/http-client-features.html" rel="noopener ugc nofollow" target="_blank">特性</a>扩展它的功能，比如认证、JSON序列化等等。</p><p id="7a32" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">我们将学习如何配置，如何创建客户端实例，以及如何使用REST API。</p><p id="0963" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">让我们从在构建梯度中包含以下依赖项开始。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="kj kk l"/></div></figure><p id="a9e1" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">第一个依赖项是处理网络请求的<a class="ae jm" href="https://ktor.io/docs/http-client-engines.html" rel="noopener ugc nofollow" target="_blank">引擎</a>，在这种情况下，我们将使用android客户端。第二个依赖项用于JSON <a class="ae jm" href="https://ktor.io/docs/json-feature.html" rel="noopener ugc nofollow" target="_blank">序列化和反序列化</a>设置，建议用于多平台项目。第三个依赖项是<a class="ae jm" href="https://github.com/Kotlin/kotlinx.serialization" rel="noopener ugc nofollow" target="_blank"> kotlinx.serialization </a>，用于实体序列化。最后，第四个用于<a class="ae jm" href="https://ktor.io/docs/features-logging.html" rel="noopener ugc nofollow" target="_blank">记录HTTP请求</a>。</p><p id="4d68" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">现在，我们继续在项目gradle中包含<a class="ae jm" href="https://github.com/Kotlin/kotlinx.serialization" rel="noopener ugc nofollow" target="_blank"> kotlinx.serialization </a>插件。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="kj kk l"/></div></figure><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="kj kk l"/></div></figure><p id="5bbb" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">现在让我们配置引擎并创建客户机实例。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="kj kk l"/></div></figure><p id="06e4" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">根据<a class="ae jm" href="https://ktor.io/docs/http-client-engines.html#dependencies" rel="noopener ugc nofollow" target="_blank">引擎</a> (Android、Apache、OKHttp等)，你可以拥有不同的属性。我们在此配置中执行了以下操作:</p><ul class=""><li id="53b4" class="kl km hh jp b jq jr jt ju jw kn ka ko ke kp ki kq kr ks kt bi translated">首先，我们通过添加各种属性，用kotlinx.serialization配置JSON序列化程序/反序列化程序。我们还定义了一个超时周期。</li><li id="d0b9" class="kl km hh jp b jq ku jt kv jw kw ka kx ke ky ki kq kr ks kt bi translated">其次，我们配置日志来创建HTTP请求日志。</li><li id="3482" class="kl km hh jp b jq ku jt kv jw kw ka kx ke ky ki kq kr ks kt bi translated">第三，我们配置一个观察器，它将记录响应的所有状态。</li><li id="034e" class="kl km hh jp b jq ku jt kv jw kw ka kx ke ky ki kq kr ks kt bi translated">最后，我们可以为每个HTTP请求设置默认值。在这种情况下，我们在标题中定义属性，这些属性将出现在所有请求中。</li></ul><p id="0e0a" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">搞定了。Ktor现在已经配置好了，实例可以使用了。保持冷静，这是一次性工作。让我们使用它！</p><p id="b328" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">我们开始定义实体:</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="kj kk l"/></div></figure><p id="74d9" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">我们继续配置用户Api:</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="kj kk l"/></div></figure><p id="0f0e" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">我们继续配置存储库:</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="kj kk l"/></div></figure><p id="53ce" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">最后，我们将使用扩展函数处理异常:</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="kj kk l"/></div></figure><h1 id="f4e7" class="kz la hh bd lb lc ld le lf lg lh li lj in lk io ll iq lm ir ln it lo iu lp lq bi translated">更新—测试客户端</h1><p id="f9b8" class="pw-post-body-paragraph jn jo hh jp b jq lr ii js jt ls il jv jw lt jy jz ka lu kc kd ke lv kg kh ki ha bi translated">如果您需要为使用Ktor客户端的方法创建单元测试，您应该使用框架提供的<a class="ae jm" href="https://ktor.io/docs/http-client-testing.html#test-client" rel="noopener ugc nofollow" target="_blank"> MockEngine </a>类，该类允许您定义具有所需内容的响应。</p><p id="0941" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">首先创建一个MockEngine实例，然后作为参数传递给HttpClient类。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="kj kk l"/></div><figcaption class="ji jj et er es jk jl bd b be z dx">Testing a Ktor client</figcaption></figure></div><div class="ab cl lw lx go ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ha hb hc hd he"><p id="cdab" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">恭喜你。我们已经用Ktor配置、创建了客户机，并创建了对API的请求。它的优点是实现简单，是多平台的，在内部使用协程，不使用注释，并且有多种配置选项，这取决于使用案例和需求。一个缺点是，它的设置和使用比其他方式要繁琐一些。</p><p id="350c" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">希望你觉得有用，记得分享这篇文章。</p><p id="c491" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">随时欢迎任何评论！</p><h1 id="06da" class="kz la hh bd lb lc ld le lf lg lh li lj in lk io ll iq lm ir ln it lo iu lp lq bi translated"><strong class="ak">资源</strong></h1><ul class=""><li id="0843" class="kl km hh jp b jq lr jt ls jw md ka me ke mf ki kq kr ks kt bi translated">【https://ktor.io/ T4】</li><li id="f6e7" class="kl km hh jp b jq ku jt kv jw kw ka kx ke ky ki kq kr ks kt bi translated"><a class="ae jm" href="https://developer.android.com/kotlin/coroutines" rel="noopener ugc nofollow" target="_blank">https://developer.android.com/kotlin/coroutines</a></li><li id="0572" class="kl km hh jp b jq ku jt kv jw kw ka kx ke ky ki kq kr ks kt bi translated"><a class="ae jm" href="https://kotlinlang.org/docs/reference/multiplatform.html" rel="noopener ugc nofollow" target="_blank">https://kotlinlang.org/docs/reference/multiplatform.html</a></li><li id="4eb6" class="kl km hh jp b jq ku jt kv jw kw ka kx ke ky ki kq kr ks kt bi translated"><a class="ae jm" href="https://ktor.io/docs/http-client-engines.html" rel="noopener ugc nofollow" target="_blank">https://ktor.io/docs/http-client-engines.html</a></li><li id="a38f" class="kl km hh jp b jq ku jt kv jw kw ka kx ke ky ki kq kr ks kt bi translated"><a class="ae jm" href="https://github.com/Kotlin/kotlinx.serialization" rel="noopener ugc nofollow" target="_blank">https://github.com/Kotlin/kotlinx.serialization</a></li><li id="8b40" class="kl km hh jp b jq ku jt kv jw kw ka kx ke ky ki kq kr ks kt bi translated"><a class="ae jm" href="https://ktor.io/docs/http-client-testing.html" rel="noopener ugc nofollow" target="_blank">https://ktor.io/docs/http-client-testing.html</a></li></ul></div></div>    
</body>
</html>