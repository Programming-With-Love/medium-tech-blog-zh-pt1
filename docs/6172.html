<html>
<head>
<title>Secret management in multi-tenant environments</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">多租户环境中的秘密管理</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/secret-management-in-multi-tenant-environments-debc9236a744?source=collection_archive---------2-----------------------#2018-03-23">https://medium.com/pinterest-engineering/secret-management-in-multi-tenant-environments-debc9236a744?source=collection_archive---------2-----------------------#2018-03-23</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="6d19" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Jeremy Krach |软件工程师，基础设施安全</p><p id="250a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest的开源秘密管理服务Knox ，现在支持SPIFFE x509身份文档作为一种认证方法。这一更新使Knox能够在Kubernetes这样的多租户环境中管理机密。</p><p id="2475" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Knox在Pinterest的基础设施中被广泛用于向生产系统提供秘密。在一台主机对应一个“服务”身份的环境中，Knox ACLs是完全表达性的。然而，今天的微服务基础设施利用Docker和Kubernetes等工具将多个容器化的服务部署到单个多租户主机上。在这个世界上，Knox需要重新评估它的服务概念。</p><p id="a551" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">幸运的是，SPIFFE的人们已经做了大量的工作来定义一个模式，为服务提供一个身份(<a class="ae jc" href="https://spiffe.io" rel="noopener ugc nofollow" target="_blank">详细的规范在这里</a>)。在这个上下文中，主要思想是可以将URI主题替换名称添加到典型的x509证书中，以提供具有唯一身份的服务。一般格式如下所示:sp iffe://trust-domain/arbitrary-path</p><p id="7971" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Knox目前通过检查标准x509客户端证书的主机名来验证机器。通过此更新，Knox可以通过检查证书中的URI San来验证任何具有SPIFFE身份的服务。以下是包含SPIFFE身份的证书示例:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div></figure><p id="54fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果一个客户端使用这个证书向Knox认证，Knox会将其身份存储为sp iffe://Pinterest . com/service _ a。</p><p id="b39c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们还添加了通过Knox客户端在ACL中指定这些服务身份的功能。可以使用-S参数并提供SPIFFE标识来指定新的条目类型，如下例所示。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div></figure><p id="369c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过在您的环境中指定KNOX_SERVICE_AUTH而不是KNOX_MACHINE_AUTH，KNOX将知道使用SPIFFE标识符而不是主机名:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div></figure><p id="187d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用上面具有spiffe://example.com/service_a标识的证书，该请求将被批准。相反，如果我们运行下面的示例，我们将无法使用示例证书获得密钥。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div></figure><p id="7f30" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，service_b(可能在同一个系统上)可以使用它自己的具有正确身份的证书来获得这个密钥。</p><p id="d1d7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了在生产中使用它，您需要一种机制来为多租户系统上运行的每个服务提供证书。<a class="ae jc" href="https://github.com/spiffe/spire" rel="noopener ugc nofollow" target="_blank"> SPIRE </a>，SPIFFE的参考实现，是一个很好的起点。</p><p id="260c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Pinterest，我们已经有了一个内部PKI，它使用AWS向主机提供证书来证明身份。通过用Kubernetes证明层扩展这个PKI，单个pod现在能够请求包含嵌入式SPIFFE身份的证书。</p><p id="5572" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在GitHub上看看这些变化和由诺克斯主演的<a class="ae jc" href="https://github.com/pinterest/knox" rel="noopener ugc nofollow" target="_blank">即将出现的新变化。</a></p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jk"><img src="../Images/c2e708437034ef3a06c845ca00e483ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:290/format:webp/1*VS-SIyipZqIIfQYxAvva3A.png"/></div></figure></div></div>    
</body>
</html>