<html>
<head>
<title>How we built new bulk editing tools</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们如何构建新的批量编辑工具</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/how-we-built-new-bulk-editing-tools-a1384a852daa?source=collection_archive---------4-----------------------#2015-01-07">https://medium.com/pinterest-engineering/how-we-built-new-bulk-editing-tools-a1384a852daa?source=collection_archive---------4-----------------------#2015-01-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="777e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">肯·墨菲| Pinterest工程师，拯救</p><p id="7414" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">随着系统中的引脚数量增长到300多亿，难怪人们最需要的功能是能够将大量引脚移动到另一个电路板并更好地管理它们。</p><p id="6f78" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">上个月，一个由两名工程师、一名设计师和一名产品经理组成的小团队构建了我们的第一套组织工具，以允许<a class="ae jc" href="https://blog.pinterest.com/post/105361940479/a-new-way-to-edit-pins-on-the-web" rel="noopener ugc nofollow" target="_blank">批量编辑</a>。现在，Pinners可以一次对几个引脚执行操作。例如，一个Pinner可以将15个引脚移动到一个新的电路板上，删除5个不太正确的引脚或将30个引脚复制到另一个电路板上。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/913bbdfcc6f9872038660f200743ebf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*tR9YDdthwmmnBjUD.png"/></div></figure><p id="953c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">构建移动、编辑和组织多个大头针的工具不是一件容易的事情。我们遇到了两个关键的挑战:同步和顺序完成任务。</p><h2 id="c284" class="jl jm hh bd jn jo jp jq jr js jt ju jv ip jw jx jy it jz ka kb ix kc kd ke kf bi translated">前端同步</h2><p id="d5c5" class="pw-post-body-paragraph ie if hh ig b ih kg ij ik il kh in io ip ki ir is it kj iv iw ix kk iz ja jb ha bi translated">第一个挑战是保持web不同组件的同步。</p><p id="3497" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">像许多web框架一样，我们的框架将站点分成不同的组件(我们称之为“模块”)。批量编辑工具需要几个不同的模块和持续的通信来保持一切顺利运行，这导致了该特性的两个设计问题。</p><p id="1db3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先，不同的模块应该如何相互通信？模块能够以三种方式对话:</p><ol class=""><li id="7cf4" class="kl km hh ig b ih ii il im ip kn it ko ix kp jb kq kr ks kt bi translated">1.父母可以直接把信息传递给他们的孩子。</li><li id="7103" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb kq kr ks kt bi translated">2.孩子们可以引发一些事件，这些事件会浮现在他们的父母面前。父母可以监听事件并做出相应的反应。</li><li id="83aa" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb kq kr ks kt bi translated">3.模块可以订阅一个通道，其他模块可以向该通道发布消息，这是一种发布-订阅模式。</li></ol><p id="2e23" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">批量编辑使用所有这些方法来帮助模块之间的相互交流，但是它特别依赖于发布-订阅模式(也称为“PubSub”)。许多需要通信的模块没有直接的父子关系，因此需要发布-订阅模式。</p><p id="8942" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第二个设计决策是如何控制不同模块执行动作的顺序，比如发送消息和执行动画。例如，当Pinner点击“移动大头针”按钮开始编辑时。</p><p id="597b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">编辑按钮被渲染和动画化以过渡到页面上。该纸板页面上的所有图钉上也会出现一个复选框。</p><p id="3a9d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个决定导致了JavaScript Promises和JavaScript库<a class="ae jc" href="http://ricostacruz.com/jquery.transit/" rel="noopener ugc nofollow" target="_blank"> Transit </a>的使用。承诺让我们运行一个函数，并在完成后运行其他代码，而无需处理回调。我们使用promises来调用API，并在成功或失败时向不同的模块发送消息，告诉它进入或退出批量编辑模式。</p><p id="3614" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Transit允许我们从JavaScript运行CSS动画，甚至允许我们将动画链接在一起。这给了我们细粒度的控制，当不同的元素进入和离开页面。</p><h2 id="c4b8" class="jl jm hh bd jn jo jp jq jr js jt ju jv ip jw jx jy it jz ka kb ix kc kd ke kf bi translated">竞赛条件</h2><p id="e5ef" class="pw-post-body-paragraph ie if hh ig b ih kg ij ik il kh in io ip ki ir is it kj iv iw ix kk iz ja jb ha bi translated">我们遇到的第二个关键挑战是比赛条件。批量编辑需要一次完成许多任务。按顺序完成这些任务可能会导致服务器超时，并向Pinner返回一条无用的错误消息。</p><p id="a33e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了解决这个问题并为Pinners创造更好的体验，我们使用Python的barrier库来并行运行每个单独的任务。整个移动的长度取决于最慢的移动需要多长时间。</p><p id="57e6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">不幸的是，许多批量执行的操作都是按顺序执行的。我们面临的最大挑战是保持电路板和用户缓存最新。</p><p id="d5bd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于我们的各种缓存，我们使用两种不同的技术，Memcache和Redis。Redis是一个更高级的键值存储，它允许键和值有不同的数据结构。Memcache仅限于使用字符串，并且由于传统原因仍然存在。我们的大部分缓存都是在Redis中实现的。用户和板卡缓存仍由Memcache存储。</p><p id="9d64" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当我们从存储列表中删除pin_id(每个pin的唯一标识符)时，我们的代码将执行以下操作:</p><ol class=""><li id="33c5" class="kl km hh ig b ih ii il im ip kn it ko ix kp jb kq kr ks kt bi translated">1.从Memcache获取列表</li><li id="47f3" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb kq kr ks kt bi translated">2.检查pin_id是否在列表中，如果是，则将其删除</li><li id="6aa8" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb kq kr ks kt bi translated">3.将列表写回Memcache</li></ol><p id="d7fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这导致步骤1和3之间的竞争条件。如果两个单独的批量操作同时从Memcache获取列表，两个操作都可能删除一个pin_id，最后一次写回Memcache会覆盖第一个pin_id的删除。作为临时解决方案，我们将缓存更新移到批量移动完成后执行。</p><p id="8d31" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们接下来的步骤是简化许多单独的任务，以便能够处理多个项目。例如，向我们的Memcache客户端添加方法，允许它一次添加或删除多个项目。这通过减少排队的网络请求和任务的总数而提高了效率。</p><p id="4c79" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最终，我们希望使用Stingray，这是由我们的BlackOps(垃圾邮件/滥用)团队开发的通用流处理器。黄貂鱼会让我们:</p><p id="18d6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你热衷于解决这样的软件工程挑战，看看我们的<a class="ae jc" href="https://about.pinterest.com/en/careers/engineering-product" rel="noopener ugc nofollow" target="_blank">职业网站</a>！</p><p id="44fe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kz">肯·墨菲是平纳体验团队的软件工程师。</em></p><p id="1ff9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kz">获取Pinterest工程新闻和更新，关注我们的工程</em><a class="ae jc" href="https://www.pinterest.com/malorie/pinterest-engineering-news/" rel="noopener ugc nofollow" target="_blank"><em class="kz">Pinterest</em></a><em class="kz">，</em> <a class="ae jc" href="https://www.facebook.com/pinterestengineering" rel="noopener ugc nofollow" target="_blank"> <em class="kz">脸书</em> </a> <em class="kz">和</em><a class="ae jc" href="https://twitter.com/PinterestEng" rel="noopener ugc nofollow" target="_blank"><em class="kz">Twitter</em></a><em class="kz">。有兴趣加入团队吗？查看我们的</em> <a class="ae jc" href="https://about.pinterest.com/en/careers/engineering-product" rel="noopener ugc nofollow" target="_blank"> <em class="kz">招聘网站</em> </a> <em class="kz">。</em></p><ul class=""><li id="e5f9" class="kl km hh ig b ih ii il im ip kn it ko ix kp jb la kr ks kt bi translated">利用有限的并行形式。</li><li id="efc8" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb la kr ks kt bi translated">自动将我们的输入分成多个作业。如果我们想移动300个引脚，它可以自动将其分解为10个引脚的任务，并处理它们。</li><li id="3da2" class="kl km hh ig b ih ku il kv ip kw it kx ix ky jb la kr ks kt bi translated">回滚改变了，所以如果我们想移动10个图钉，而其中一个图钉没有移动，Stingray会恢复其他9个图钉的移动。这比移动其他引脚的当前状态好得多，并且引脚会显示一条错误消息。</li></ul></div></div>    
</body>
</html>