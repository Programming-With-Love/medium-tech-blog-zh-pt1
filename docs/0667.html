<html>
<head>
<title>Using WorkManager on Android 12</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Android 12上使用工作管理器</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/using-workmanager-on-android-12-f7d483ca0ecb?source=collection_archive---------0-----------------------#2021-09-16">https://medium.com/androiddevelopers/using-workmanager-on-android-12-f7d483ca0ecb?source=collection_archive---------0-----------------------#2021-09-16</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/b7d63d650173c9bb576b591ae7594270.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GN5zwv5GsI70OJ1TlD1SsQ.png"/></div></div></figure><div class=""/><p id="636e" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Android 12 (API level 31)引入<a class="ae jn" href="https://developer.android.com/about/versions/12/foreground-services" rel="noopener ugc nofollow" target="_blank">前台服务启动限制</a>。由于这些限制，针对Android 12或更高版本的应用程序不再能够在后台运行时启动前台服务，除了<a class="ae jn" href="https://developer.android.com/guide/components/foreground-services#background-start-restriction-exemptions" rel="noopener ugc nofollow" target="_blank">少数特殊情况</a>。这意味着，如果您的应用程序当前不处于免除后台启动限制的状态，调用<code class="du jo jp jq jr b"><a class="ae jn" href="https://developer.android.com/reference/androidx/work/ListenableWorker#setForegroundAsync(androidx.work.ForegroundInfo)" rel="noopener ugc nofollow" target="_blank">setForeground</a></code>可能会导致<a class="ae jn" href="https://developer.android.com/reference/android/app/ForegroundServiceStartNotAllowedException" rel="noopener ugc nofollow" target="_blank">异常</a>。</p><p id="ec62" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因此，在WorkManager 2.7中，我们可以在遵守后台限制的同时轻松安排重要工作。有了<a class="ae jn" href="https://developer.android.com/about/versions/12/foreground-services#expedited-jobs" rel="noopener ugc nofollow" target="_blank">加急作业</a>，应用程序现在可以轻松地执行<strong class="ir ht">短而高优先级的任务</strong>，比如发送聊天消息或上传图片到社交网络。加速作业是启动任务的推荐方式，即使用户将应用程序放在后台，这些任务也应该立即运行并继续。</p><p id="3b9a" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要快速安排工作，请使用工作请求生成器中的<code class="du jo jp jq jr b">setExpedited()</code>方法:</p><pre class="js jt ju jv fd jw jr jx jy aw jz bi"><span id="e26b" class="ka kb hs jr b fi kc kd l ke kf">val request = OneTimeWorkRequestBuilder&lt;HighPriorityWorker&gt;()       <br/>   .setExpedited(OutOfQuotaPolicy.RUN_AS_NON_EXPEDITED_WORK_REQUEST)   <br/>   .build() </span><span id="7007" class="ka kb hs jr b fi kg kd l ke kf">WorkManager.getInstance(context).enqueue(request)</span></pre><p id="eaac" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">调用<code class="du jo jp jq jr b">setExpedited()</code>告诉框架这项工作很重要，应该优先于其他调度的工作。注意，我们还向<code class="du jo jp jq jr b">setExpedited()</code>传递了一个<code class="du jo jp jq jr b"><a class="ae jn" href="https://developer.android.com/reference/androidx/work/OutOfQuotaPolicy" rel="noopener ugc nofollow" target="_blank">OutOfQuotaPolicy</a></code>参数。加急作业受到基于<a class="ae jn" href="https://developer.android.com/topic/performance/appstandby" rel="noopener ugc nofollow" target="_blank">应用待机桶</a>的配额的限制，因此<code class="du jo jp jq jr b"><em class="kh">OutOfQuotaPolicy</em></code>参数告诉工作管理器，如果你的应用试图在超出配额时运行加急作业，该怎么办:要么完全放弃加急作业请求(<code class="du jo jp jq jr b"><a class="ae jn" href="https://developer.android.com/reference/androidx/work/OutOfQuotaPolicy#DROP_WORK_REQUEST" rel="noopener ugc nofollow" target="_blank">DROP_WORK_REQUEST</a></code>)，要么退回到将作业视为常规作业请求(<code class="du jo jp jq jr b"><a class="ae jn" href="https://developer.android.com/reference/androidx/work/OutOfQuotaPolicy#RUN_AS_NON_EXPEDITED_WORK_REQUEST" rel="noopener ugc nofollow" target="_blank">RUN_AS_NON_EXPEDITED_WORK_REQUEST</a></code>)。</p><blockquote class="ki kj kk"><p id="6c77" class="ip iq kh ir b is it iu iv iw ix iy iz kl jb jc jd km jf jg jh kn jj jk jl jm ha bi translated">将配额视为执行加急工作的时间限制。仅仅因为它重要，并不意味着它可以永远运行下去。</p></blockquote><p id="4db7" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">WorkManager 2.7向后兼容，可以在12版之前的Android上运行。在运行Android 11或更老版本的设备上调用<code class="du jo jp jq jr b">setExpedited()</code>时，WorkManager会默认使用前台服务，而不是加急作业。</p><p id="36ea" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要查看工作管理器的<code class="du jo jp jq jr b">setExpedited()</code> API，请查看我们官方的<a class="ae jn" href="https://github.com/android/architecture-components-samples/blob/efe4f716c8670f5c3ce5dd9eb252b80d9d4241db/WorkManagerSample/lib/src/main/java/com/example/background/ImageOperations.kt#L94" rel="noopener ugc nofollow" target="_blank">工作管理器示例</a>和关于加速作业的<a class="ae jn" href="https://developer.android.com/topic/libraries/architecture/workmanager/how-to/define-work#expedited-jobs" rel="noopener ugc nofollow" target="_blank">文档。</a></p><p id="c1bf" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">你还可以在官方<a class="ae jn" href="https://developer.android.com/jetpack/androidx/releases/work" rel="noopener ugc nofollow" target="_blank">发行说明</a>中看到每个工作管理器版本中所做的更改和改进的详细列表，以及<a class="ae jn" href="https://developer.android.com/jetpack/androidx/releases/work#2.6.0" rel="noopener ugc nofollow" target="_blank">工作管理器2.6 </a>和<a class="ae jn" href="https://developer.android.com/jetpack/androidx/releases/work#2.7.0" rel="noopener ugc nofollow" target="_blank">工作管理器2.7 </a>的具体发行说明。</p><p id="2d1d" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最后，如果您有任何与工作管理器相关的特性请求或问题，请随时<a class="ae jn" href="https://issuetracker.google.com/issues/new?component=409906" rel="noopener ugc nofollow" target="_blank">在我们的公共跟踪器</a>中提交问题。</p></div></div>    
</body>
</html>