<html>
<head>
<title>Debugging a series of miscalculations in osquery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">调试osquery中的一系列计算错误</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/debugging-a-series-of-miscalculations-in-osquery-14cce2cfe39c?source=collection_archive---------0-----------------------#2017-08-18">https://medium.com/square-corner-blog/debugging-a-series-of-miscalculations-in-osquery-14cce2cfe39c?source=collection_archive---------0-----------------------#2017-08-18</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><blockquote class="ie"><p id="b2eb" class="if ig hh bd ih ii ij ik il im in io dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae ip" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><h1 id="1ead" class="iq ir hh bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">什么是<a class="ae ip" href="https://stackedit.io/osquery.io" rel="noopener ugc nofollow" target="_blank"> osquery </a>？</h1><p id="14e1" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk io ha bi translated">osquery是脸书的一个开源工具，它为系统信息提供了一个SQL接口。</p><p id="87e4" class="pw-post-body-paragraph jo jp hh jq b jr kl jt ju jv km jx jy jz kn kb kc kd ko kf kg kh kp kj kk io ha bi translated">在整个夏天，我一直致力于将osquery结果集成到我们的内部资产跟踪器中，以实现自动化/验证目的。它对于监控各种统计数据非常有用，SQL接口使它易于使用。</p><h1 id="2168" class="iq ir hh bd is it iu iv iw ix iy iz ja jb kq jd je jf kr jh ji jj ks jl jm jn bi translated">发现计算错误</h1><h2 id="6e1f" class="kt ir hh bd is ku kv kw iw kx ky kz ja jz la lb je kd lc ld ji kh le lf jm lg bi translated">较小的linux磁盘大小？</h2><p id="24e3" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk io ha bi translated">我已经收集了大约2周的数据，当我将UI改为显示人类可读的数字时，我注意到主机的总磁盘大小为0.58 GB (585871964字节)。拥有这么小的磁盘似乎不合逻辑，所以我在那台主机上使用<code class="du lh li lj lk b">sudo fdisk -l</code>查找实际的磁盘大小，它是300 GB (299966445568字节。)</p><p id="19de" class="pw-post-body-paragraph jo jp hh jq b jr kl jt ju jv km jx jy jz kn kb kc kd ko kf kg kh kp kj kk io ha bi translated">结果是<code class="du lh li lj lk b">585871964 * 512 = 299966445568</code>产生了正确的大小。但是512到底是什么？</p><h2 id="03d4" class="kt ir hh bd is ku kv kw iw kx ky kz ja jz la lb je kd lc ld ji kh le lf jm lg bi translated">什么是<a class="ae ip" href="https://en.wikipedia.org/wiki/Block_%28data_storage%29" rel="noopener ugc nofollow" target="_blank">块大小</a>？</h2><p id="6d34" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk io ha bi translated">计算存储中的基本数据原语是字节，但是，出于效率原因，许多存储设备以更大的单位(块大小)执行I/O操作。由于磁盘上扇区的物理概念，历史上它是512字节(但也可能不同)。</p><p id="a2d2" class="pw-post-body-paragraph jo jp hh jq b jr kl jt ju jv km jx jy jz kn kb kc kd ko kf kg kh kp kj kk io ha bi translated">结果是，尽管文档说明这是以字节为单位返回的，但它实际上是以块大小返回的；在这种情况下是512。<br/>我将它硬编码到我的代码中，并决定向osquery提交一个补丁来修复这个问题，并向设备<code class="du lh li lj lk b">block_size</code>的<code class="du lh li lj lk b">block_devices</code>表中添加一列。</p><h1 id="c9f4" class="iq ir hh bd is it iu iv iw ix iy iz ja jb kq jd je jf kr jh ji jj ks jl jm jn bi translated">抓取更多的bug</h1><p id="ae5a" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk io ha bi translated">当我去修复Linux实现并添加列时，我看到还有一个Darwin实现。出于好奇，我想知道这个问题是否持续存在，于是在我的mac上运行了一下，发现它也不准确。我有一个256GB的型号。</p><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es ll"><img src="../Images/4f37a1314fa393321c25e712f3642f46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PnAQpiTkvCBpU0rOyWyQJg.png"/></div></div><figcaption class="lx ly et er es lz ma bd b be z dx">osqueryi results on my mac</figcaption></figure><p id="95d3" class="pw-post-body-paragraph jo jp hh jq b jr kl jt ju jv km jx jy jz kn kb kc kd ko kf kg kh kp kj kk io ha bi translated">我的SSD是1892089856字节？还是<code class="du lh li lj lk b">1892089856 * 512 = 968750006272</code>？(我希望我有差不多1tb)。天哪，肯定是别的什么东西！<br/>看了一下Darwin的实现，发现它使用了一堆我不知道的IOKit东西。我四处寻求帮助，我们最终找到了我们需要剖析的方法的苹果开源头文件。(我在C语言中了解到，你可以拥有带有隐藏定义的<a class="ae ip" href="https://en.wikipedia.org/wiki/Opaque_pointer" rel="noopener ugc nofollow" target="_blank">不透明结构</a></p><h1 id="1a05" class="iq ir hh bd is it iu iv iw ix iy iz ja jb kq jd je jf kr jh ji jj ks jl jm jn bi translated">不透明的结构一点也不好玩</h1><p id="87f1" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk io ha bi translated">很难弄清楚它在系统级做什么，但是文档给我指出了一个字典<code class="du lh li lj lk b">CFMutableDictionaryRef</code>，它包含了键<code class="du lh li lj lk b">Size</code>的一些内容。在StackOverflow上找到一些代码来打印这本字典，结果它确实返回了正确的数字。这时候，我开始怀疑一个截断错误。</p><p id="0077" class="pw-post-body-paragraph jo jp hh jq b jr kl jt ju jv km jx jy jz kn kb kc kd ko kf kg kh kp kj kk io ha bi translated">运行<code class="du lh li lj lk b">diskutil info -all</code>本地我发现我有<br/>T3】</p><p id="2091" class="pw-post-body-paragraph jo jp hh jq b jr kl jt ju jv km jx jy jz kn kb kc kd ko kf kg kh kp kj kk io ha bi translated">第一本印刷的字典是<code class="du lh li lj lk b">/dev/disk0</code>。尺寸线:</p><pre class="lm ln lo lp fd mb lk mc md aw me bi"><span id="d287" class="kt ir hh lk b fi mf mg l mh mi">17 : &lt;CFString 0x7fffeb91cd20 [0x7fffeb978da0]&gt;{contents = "Size"} = &lt;CFNumber 0x3a70c7000037 [0x7fffeb978da0]&gt;{<strong class="lk hi">value</strong> = +251000193024, <strong class="lk hi">type</strong> = kCFNumberSInt64Type}</span></pre><p id="10f7" class="pw-post-body-paragraph jo jp hh jq b jr kl jt ju jv km jx jy jz kn kb kc kd ko kf kg kh kp kj kk io ha bi translated">立刻注意到了<code class="du lh li lj lk b">type = kCFNumberSInt64Type</code>。</p><h1 id="6347" class="iq ir hh bd is it iu iv iw ix iy iz ja jb kq jd je jf kr jh ji jj ks jl jm jn bi translated">休斯顿，我们有一个截断错误</h1><p id="2f30" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk io ha bi translated">在ruby中将它转换为32位的int，它确认了这就是问题所在。</p><pre class="lm ln lo lp fd mb lk mc md aw me bi"><span id="13dc" class="kt ir hh lk b fi mf mg l mh mi">2.4.1 :001 &gt; x = 251000193024<br/> =&gt; 251000193024<br/>2.4.1 :002 &gt; x &amp; 0xffffffff<br/> =&gt; 1892089856</span></pre><p id="a9f7" class="pw-post-body-paragraph jo jp hh jq b jr kl jt ju jv km jx jy jz kn kb kc kd ko kf kg kh kp kj kk io ha bi translated">我看到有检查是什么类型的<code class="du lh li lj lk b">CFNumber</code>，但由于某种原因，它没有被发现。显然，它被硬编码为一系列嵌套方法调用中的某处的<code class="du lh li lj lk b">kCFNumberIntType</code>。我改成了实际使用号码的<code class="du lh li lj lk b">CFNumberType</code>。</p><p id="b46c" class="pw-post-body-paragraph jo jp hh jq b jr kl jt ju jv km jx jy jz kn kb kc kd ko kf kg kh kp kj kk io ha bi translated">在修复了Darwin实现之后，我决定也以块大小返回它，以保持与Linux实现的一致性。做出这个选择是因为Linux已经提供了块大小，而Darwin实现毫无意义。将<code class="du lh li lj lk b">block_size</code>列添加到两个表中。</p><p id="9158" class="pw-post-body-paragraph jo jp hh jq b jr kl jt ju jv km jx jy jz kn kb kc kd ko kf kg kh kp kj kk io ha bi translated">参见GitHub上的<a class="ae ip" href="https://github.com/facebook/osquery/pull/3539" rel="noopener ugc nofollow" target="_blank"> PR </a> / <a class="ae ip" href="https://github.com/facebook/osquery/issues/3538" rel="noopener ugc nofollow" target="_blank"> Issue </a></p><h1 id="94e6" class="iq ir hh bd is it iu iv iw ix iy iz ja jb kq jd je jf kr jh ji jj ks jl jm jn bi translated">TL；博士；医生</h1><ul class=""><li id="a708" class="mj mk hh jq b jr js jv jw jz ml kd mm kh mn io mo mp mq mr bi translated">处理整数时要注意截断错误</li><li id="4534" class="mj mk hh jq b jr ms jv mt jz mu kd mv kh mw io mo mp mq mr bi translated">让程序员跟踪类型并静默转换通常会导致类型转换错误</li></ul><h2 id="d1b6" class="kt ir hh bd is ku kv kw iw kx ky kz ja jz la lb je kd lc ld ji kh le lf jm lg bi translated">感谢<a class="ae ip" href="https://github.com/eam" rel="noopener ugc nofollow" target="_blank">埃文</a>、<a class="ae ip" href="https://twitter.com/mtauraso" rel="noopener ugc nofollow" target="_blank">迈克尔</a>和<a class="ae ip" href="https://twitter.com/kwiggint" rel="noopener ugc nofollow" target="_blank">肯</a>的所有帮助:)</h2></div></div>    
</body>
</html>