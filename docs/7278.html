<html>
<head>
<title>OAuth with PHP Part Two: refreshing &amp; revoking tokens</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用PHP的OAuth第二部分:刷新和撤销令牌</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/oauth-with-php-part-two-refreshing-revoking-tokens-9ae065537c41?source=collection_archive---------1-----------------------#2017-12-05">https://medium.com/square-corner-blog/oauth-with-php-part-two-refreshing-revoking-tokens-9ae065537c41?source=collection_archive---------1-----------------------#2017-12-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><blockquote class="ie"><p id="920c" class="if ig hh bd ih ii ij ik il im in io dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae ip" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><p id="e735" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm io ha bi translated">这是第1部分的后续，第1部分讨论了从授权码创建访问令牌。</p><p id="411c" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">在我们使用OAuth的PHP旅程的第一部分结束时，我们有两个脚本:一个<code class="du js jt ju jv b">index.php</code>将开始OAuth过程，另一个<code class="du js jt ju jv b">callback.php</code>将接受来自Square的结果，并使用提供的授权代码创建一个访问令牌，您的应用程序可以使用该令牌代表商家使用Square的API。</p><p id="fa5a" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">你新制作的访问令牌将在大约一个月内工作良好，但随后你的令牌将到期，你的应用程序将无法使用Square的API做任何事情，直到商家重新授权该应用程序。这对您的用户来说不太方便，所以幸运的是，有一种方法可以以编程方式刷新您的OAuth凭证，而不需要您的最终用户授权您的应用程序。仅当您的权限不会更改您的应用程序权限时，刷新您的令牌才有效。任何时候你想改变你的应用程序可用的范围，你必须重新向商家进行认证。</p><h2 id="e7f4" class="jx jy hh bd jz ka kb kc kd ke kf kg kh jb ki kj kk jf kl km kn jj ko kp kq kr bi translated">到期日期</h2><p id="1e5a" class="pw-post-body-paragraph iq ir hh is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm io ha bi translated">当您将授权码换成访问令牌时，您将得到如下json响应:</p><pre class="kx ky kz la fd lb jv lc ld aw le bi"><span id="43b4" class="jx jy hh jv b fi lf lg l lh li">{ <br/>  "access_token": "sq0atp-XXXX",<br/>  "token_type": "bearer",<br/>  "expires_at": "2017-12-22T19:11:30Z",<br/>  "merchant_id": "XXXXXXXXX"<br/>}</span></pre><p id="53e3" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">您将希望跟踪那个<code class="du js jt ju jv b">expires_at</code>时间，以便能够及时刷新令牌。您甚至可以在令牌过期后进行刷新，只要您在过期后15天内进行刷新。</p><h2 id="3488" class="jx jy hh bd jz ka kb kc kd ke kf kg kh jb ki kj kk jf kl km kn jj ko kp kq kr bi translated">刷新端点</h2><p id="5f70" class="pw-post-body-paragraph iq ir hh is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm io ha bi translated">刷新您的访问令牌的端点与我们的大多数端点略有不同，因为您需要使用您的<code class="du js jt ju jv b">client_secret</code>而不是标题中的<code class="du js jt ju jv b">access_token</code>进行授权。下面是PHP使用<code class="du js jt ju jv b">file_get_contents</code>代码的样子:</p><pre class="kx ky kz la fd lb jv lc ld aw le bi"><span id="3926" class="jx jy hh jv b fi lf lg l lh li">//Refresh the token<br/>$url = "<a class="ae ip" href="https://connect.squareup.com/oauth2/clients/$client_id/access-token/renew" rel="noopener ugc nofollow" target="_blank">https://connect.squareup.com/oauth2/clients/$client_id/access-token/renew</a>";<br/>$data = array(<br/>    'access_token' =&gt; $access_token<br/> );</span><span id="d4a5" class="jx jy hh jv b fi lj lg l lh li">$options = array(<br/>    'http' =&gt; array(<br/>        'header'  =&gt; "Content-type: application/json\r\n".  <br/>        "Authorization: <strong class="jv hi">Client $client_secret\r\n",</strong><br/>        'method'  =&gt; 'POST',<br/>        'content' =&gt; json_encode($data)<br/>    )<br/>);</span><span id="10ab" class="jx jy hh jv b fi lj lg l lh li">var_dump($options);<br/>$context  = stream_context_create($options);<br/>$result = file_get_contents($url, false, $context);</span><span id="5e68" class="jx jy hh jv b fi lj lg l lh li">echo "Result from /oauth2/clients/$client_id/access-token/renew:";<br/>var_dump($result);</span></pre><blockquote class="lk ll lm"><p id="8aab" class="iq ir jw is b it jn iv iw ix jo iz ja ln jp jd je lo jq jh ji lp jr jl jm io ha bi translated">需要注意的重要一点是，如果一切都正确，但是在请求体中提供了一个无效的<code class="du js jt ju jv b">access_token</code>,您将得到一个404响应，因为找不到访问令牌。</p></blockquote><p id="d1bb" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">如果一切顺利，您应该会得到类似于您第一次获得访问令牌时的响应，现在的刷新日期比您刷新的日期晚一个月:</p><pre class="kx ky kz la fd lb jv lc ld aw le bi"><span id="9f28" class="jx jy hh jv b fi lf lg l lh li">{<br/>  "access_token": "sq0atp-XXXXXXX",<br/>  "token_type": "bearer",<br/>  "expires_at": "2017-12-22T19:49:36Z",<br/>  "merchant_id": "XXXXXXXXX"<br/>}</span></pre><p id="752d" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">这就是刷新您的访问令牌所需做的全部工作！现在，您的应用程序将能够代表其他商家继续发出请求。</p><h2 id="8348" class="jx jy hh bd jz ka kb kc kd ke kf kg kh jb ki kj kk jf kl km kn jj ko kp kq kr bi translated">被撤销端点</h2><p id="088e" class="pw-post-body-paragraph iq ir hh is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm io ha bi translated">撤销访问令牌会删除它对Square商户帐户的任何访问权限。这个端点的访问类似于renew端点，头中有<code class="du js jt ju jv b">client_secret</code>:</p><pre class="kx ky kz la fd lb jv lc ld aw le bi"><span id="b4f7" class="jx jy hh jv b fi lf lg l lh li">//Revoke the token<br/>$url = "<a class="ae ip" href="https://connect.squareup.com/oauth2/revoke" rel="noopener ugc nofollow" target="_blank">https://connect.squareup.com/oauth2/revoke</a>";<br/>$data = array(<br/>    'access_token' =&gt; $access_token,<br/>    'client_id' =&gt; $client_id<br/> );</span><span id="78ab" class="jx jy hh jv b fi lj lg l lh li">$options = array(<br/>    'http' =&gt; array(<br/>        'header'  =&gt; "Content-type: application/json\r\n".  <br/>        "Authorization: Client $client_secret\r\n",<br/>        'method'  =&gt; 'POST',<br/>        'content' =&gt; json_encode($data)<br/>    )<br/>);</span><span id="60ee" class="jx jy hh jv b fi lj lg l lh li">var_dump($options);<br/>$context  = stream_context_create($options);<br/>$result = file_get_contents($url, false, $context);</span><span id="e069" class="jx jy hh jv b fi lj lg l lh li">echo "Result from /oauth2/revoke:";<br/>var_dump($result);</span></pre><p id="b5c0" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">如果您的请求成功，那么API将返回以下响应:</p><pre class="kx ky kz la fd lb jv lc ld aw le bi"><span id="7105" class="jx jy hh jv b fi lf lg l lh li">{<br/>  "success": true<br/>}</span></pre><p id="6831" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">现在，您创建的访问令牌已经失效，不能使用或刷新。您的最终用户需要再次授权您的应用程序，以便您的应用程序能够代表他们使用Square的API。</p><h2 id="0db8" class="jx jy hh bd jz ka kb kc kd ke kf kg kh jb ki kj kk jf kl km kn jj ko kp kq kr bi translated">代码</h2><p id="29de" class="pw-post-body-paragraph iq ir hh is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm io ha bi translated">为了简化一切，我将所有代码(包括来自第一部分的授权)包含在一个页面中，该页面将把您重定向到Square，创建一个访问令牌，更新令牌，然后一次性撤销它。</p><figure class="kx ky kz la fd lq"><div class="bz dy l di"><div class="lr ls l"/></div></figure><p id="e13a" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">现在，您应该有了一个完整的PHP示例，可以用OAuth做任何事情。如果你有任何问题，请在这个帖子上留下评论，当然也可以看看官方的<a class="ae ip" href="https://docs.connect.squareup.com/api/oauth" rel="noopener ugc nofollow" target="_blank"> Square OAuth文档</a>。</p></div></div>    
</body>
</html>