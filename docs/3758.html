<html>
<head>
<title>Dynamic build agents in Jenkins using AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jenkins中使用AWS的动态构建代理</h1>
<blockquote>原文：<a href="https://medium.com/globant/dynamic-build-agents-in-jenkins-using-aws-f71b797910ef?source=collection_archive---------0-----------------------#2021-09-28">https://medium.com/globant/dynamic-build-agents-in-jenkins-using-aws-f71b797910ef?source=collection_archive---------0-----------------------#2021-09-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/></div><div class="ab cl ie if go ig" role="separator"><span class="ih bw bk ii ij ik"/><span class="ih bw bk ii ij ik"/><span class="ih bw bk ii ij"/></div><div class="ha hb hc hd he"><h1 id="64ec" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated"><strong class="ak">简介</strong></h1><p id="528e" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">你有没有经历过你的詹金斯建筑在排队等待下一个有空的遗嘱执行人？结果是，项目中的其他合作者会同时对代码进行更改，导致所有可用的执行器都被他们的更改所触发的构建占用。如果你的是一个紧急的bug修复或者一些接近完成期限的事情，这可能会变得非常令人沮丧。除此之外，执行中的延迟也可能导致问题被发现得太晚，修复变得更加昂贵。</p><p id="5441" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">在本文中，我们将讨论以下几点:<br/> 1-解决方案<br/> 2-先决条件<br/>3-AWS中的配置<br/> 4-在Jenkins中安装插件<br/> 5-在Jenkins中配置EC2-fleet插件<br/> 6-正在运行的插件<br/> 7-故障排除<br/> 8-摘要<br/> 9-参考资料</p><h1 id="a2fe" class="il im hh bd in io km iq ir is kn iu iv iw ko iy iz ja kp jc jd je kq jg jh ji bi translated"><strong class="ak"> 1-解决方案</strong></h1><p id="7b25" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">Jenkins提供了在奴隶上运行的作业，使我们能够扩大我们可以运行的同时作业的数量，超过了主人的能力。传统上，我们会考虑通过添加额外的服务器并将其配置为我们集群的一部分来进行纵向扩展。但这将涉及安装和定期维护的前期成本。我们还必须考虑到，在高需求阶段，我们将利用大部分资源，反之，在低需求阶段，我们的资源将处于闲置状态。因此，能够根据我们的工作负载动态扩展的解决方案应该是最佳选择。</p><p id="1682" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我们可以利用云的“随用随付”模式，在这种模式下，我们不必提前配置基础架构，而是根据我们的使用情况进行计费。它还提供自动扩展等功能，有助于根据工作负载扩展/缩小容错基础架构容量。</p><p id="5e2e" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">Jenkins提供了一个“EC2-Fleet”插件来提供AWS中的构建代理，并利用自动伸缩特性根据队列中的作业进行伸缩。它还替换由于特定Spot实例池中的需求高峰而终止的实例。(假设我们已经配置了使用Spot实例的能力)</p><h1 id="81e4" class="il im hh bd in io km iq ir is kn iu iv iw ko iy iz ja kp jc jd je kq jg jh ji bi translated"><strong class="ak"> 2-先决条件</strong></h1><p id="4415" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">1.拥有EC2和自动缩放操作权限的AWS IAM帐户。</p><p id="b3d5" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">2.Jenkins中拥有安装和配置插件权限的用户。</p><h1 id="c0f6" class="il im hh bd in io km iq ir is kn iu iv iw ko iy iz ja kp jc jd je kq jg jh ji bi translated"><strong class="ak">3-AWS中的配置</strong></h1><p id="d04a" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">1.转到EC2控制台&gt;密钥对。点击“创建密钥对”按钮。当我们配置Jenkins插件以通过ssh启动代理时，将使用这个密钥。</p><p id="72a6" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">a)提供密钥对的名称。</p><p id="1e5c" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">b)选择RSA作为密钥对类型。pem格式</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es kr"><img src="../Images/0a4482961e2f439ac87a88d36b62236b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QGGNGf8RsINr0uUr"/></div></div></figure><p id="c837" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">这将生成密钥，请确保下载并保存它。稍后在设置中会用到它。</p><p id="a001" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">2.转到EC2控制台&gt;启动模板。单击“创建启动模板”按钮。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es ld"><img src="../Images/a3dfdab41a2bb53461c35c7e7349f0be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*A53SLTtGpbJjZvHW"/></div></div></figure><p id="6daf" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">自动缩放提供了启动模板和启动配置来定义用于启动实例的配置信息。但是，启动配置是传统版本，建议使用启动模板，因为它能够拥有多个版本，支持按需提供实例和现场实例，还有许多其他优于启动配置的优点。因此，我们将利用发布模板来实施。</p><p id="e100" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我们可以配置</p><p id="1516" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">a) AMI用于启动实例。我们也可以使用我们自己定制的ami。</p><p id="3243" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">b)实例类型取决于我们希望在这些实例上运行的并发构建和工作负载的数量。</p><p id="5ab4" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">c)启动实例后登录实例的ssh密钥对。</p><p id="1400" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">d)安全组设置。</p><p id="fb7a" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">e) Spot实例详细信息，如果我们计划利用Spot实例来节省成本。</p><p id="c8b2" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">f)将在实例启动时执行的用户数据。</p><p id="80d9" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">创建模板后，它将出现在“启动模板”部分，反映其名称、默认版本、最新版本以及其他详细信息:</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es le"><img src="../Images/fed0e731f9f42bcb87fc0fcedab390ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Mvhmt_7cgwICkMri"/></div></div></figure><p id="9f20" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">3.现在启动模板可用，我们可以创建自动缩放组。转到EC2控制台&gt;自动缩放组，然后单击“创建自动缩放组”按钮。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es lf"><img src="../Images/68dd4eef3ea76e9955433aa3fce2067d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RdOoeG-xoBBa0wdt"/></div></div></figure><p id="4821" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我们需要根据我们的要求配置自动扩展组:</p><p id="e8ab" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">a)从“启动模板”部分的下拉列表中选择启动模板和在之前步骤中创建的版本:</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es lg"><img src="../Images/bc04aac1b577b7ad80e8f8b914141424.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g7MUPYJ1VojnZh6E"/></div></div></figure><p id="8bc0" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">b)为我们的自动扩展组定义网络设置，例如它将使用的VPC和子网。建议在选定的VPC内使用多个子网，以确保高可用性和容错能力。</p><p id="a0d9" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">c)我们可能还希望将一个负载平衡器附加到此配置，这是可选的。</p><p id="2ab9" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">d)配置组大小，其中我们可以提及我们的自动扩展组的最小、最大和所需容量。EC2舰队插件中的设置将覆盖此处指定的数字。</p><p id="0ce1" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">e)发送电子邮件等任何扩大/缩小活动的通知设置都是可选的。</p><p id="344d" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">创建后，自动缩放组将显示在自动缩放组部分下:</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es lh"><img src="../Images/ec51ae2fa7c05ee9161722ed9bf91d6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UI6ETGX73AhGVDWl"/></div></div></figure><h1 id="a247" class="il im hh bd in io km iq ir is kn iu iv iw ko iy iz ja kp jc jd je kq jg jh ji bi translated"><strong class="ak"> 4-在Jenkins中安装插件</strong></h1><p id="c9a9" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">在Jenkins中安装最新版本的EC2-Fleet插件。</p><p id="7c8f" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">进入管理Jenkins &gt;插件管理器，然后安装EC2 Fleet Jenkins插件</p><h1 id="c502" class="il im hh bd in io km iq ir is kn iu iv iw ko iy iz ja kp jc jd je kq jg jh ji bi translated">5-在Jenkins中配置EC2-fleet插件</h1><ol class=""><li id="e501" class="li lj hh jl b jm jn jq jr ju lk jy ll kc lm kg ln lo lp lq bi translated">进入管理Jenkins &gt;管理节点和云&gt;配置云&gt;选择“Amazon EC2 Fleet”</li></ol><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es lr"><img src="../Images/24c6448b06f2e5354f39796a71e16b80.png" data-original-src="https://miro.medium.com/v2/resize:fit:810/0*0rrD1jOtsLq5qGo1"/></div></figure><p id="709d" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">2.我们需要使用IAM用户的访问密钥ID和秘密访问密钥来配置我们的AWS凭证。只有在指定了AWS区域和凭据后，车队列表才可用。作为一项安全最佳实践，我们应该将凭据的范围定为“系统”而不是“全局”。</p><p id="b3bb" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">3.选择我们已经在其中创建了自动缩放组的AWS区域。</p><p id="25e1" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">4.可用的自动缩放组列表将被填充，我们选择我们创建的组。单击“测试连接”以验证其是否正常工作:</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es ls"><img src="../Images/0270e620ac050548dc5f464c64fd3b19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qySfBeXbEJsgRjo3"/></div></div></figure><p id="e8f7" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">5.我们现在必须配置如何通过“Launcher”配置来启动代理。</p><p id="0847" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">a)从下拉列表中选择“通过SSH启动代理”。</p><p id="ae8d" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">b)从“凭据”部分下的下拉列表中选择“ec2-用户”。</p><p id="6f33" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">c)通过从下拉列表中选择“带私钥的ssh用户名”选项，添加ec2用户要使用的SSH密钥。我们将使用之前从AWS EC2控制台下载的密钥，并将其内容粘贴到密钥的文本区域。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es lt"><img src="../Images/a6137cabab42183fe33fc5e55e11cc5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ln2Lmyd85H1E1NgO"/></div></div></figure><p id="efaf" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">d)从“主机密钥验证策略”下拉列表中选择“非验证验证策略”。这个选项在我们使用Spot实例时很有用，因为它们有一个随机的SSH主机指纹。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es lu"><img src="../Images/f8b5dcfcb5887c45d21e5d1d1f1864a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PvtlFMd88vm6ZgXI"/></div></div></figure><p id="6cee" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">6.如果Jenkins master和代理在同一个网络或对等网络中，我们可以选中“Private IP ”(私有IP)框，以便使用私有IP地址在它们之间进行通信。如果未选择此选项，Jenkins master将利用代理的公共IP地址进行通信。因此，必须根据您的网络配置来选择选项。</p><p id="7e57" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">7.为我们的车队指定标签，稍后将在我们的管道或自由式作业中使用该标签，以便在我们的云代理上运行构建。</p><p id="646b" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">8.将“缩减前最大空闲分钟数”配置为您选择的非零值。该值将决定代理在被缩减之前可以保持空闲多长时间。将其值设置为0意味着它永远不会缩小。</p><p id="5fe2" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">9.通过定义“最小集群大小”和“最大集群大小”来确定集群的大小。此处提到的值将覆盖我们原始自动扩展组配置中定义的容量。</p><p id="f82a" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">10.根据基于自动缩放组中AWS实例的物理容量运行的并发构建的数量来配置执行器的数量。我们必须小心不要在一台机器上定义太多的执行器，这会导致构建执行时间的增加。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es lv"><img src="../Images/8971f13e975c4c474379e68bb6af749b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1054/0*e5MJgoIZrOXy7jI9"/></div></figure><h1 id="7157" class="il im hh bd in io km iq ir is kn iu iv iw ko iy iz ja kp jc jd je kq jg jh ji bi translated">6-运行中的插件</h1><ul class=""><li id="9c6e" class="li lj hh jl b jm jn jq jr ju lk jy ll kc lm kg lw lo lp lq bi translated">一旦配置了插件，车队的状态将显示在Jenkins仪表板下:</li></ul><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es lx"><img src="../Images/1838f8240264595aeb4b81fe0aa5a58b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1018/0*fudS-LKdYKXTGiOv"/></div></figure><p id="08b0" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">由于我们已经将车队的最小容量设置为0，并且没有构建运行，因此节点和目标的值也是0。</p><ul class=""><li id="dfeb" class="li lj hh jl b jm kh jq ki ju ly jy lz kc ma kg lw lo lp lq bi translated">我们可以使用pipeline块中的agent指令来配置我们的管道，以使用云代理。</li></ul><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es mb"><img src="../Images/6c855ba2a8995670cfa85688a7c24cdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:586/0*a6tJ9_Hvg5HJRTsT"/></div></div></figure><p id="73d0" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">还可以在各个阶段中设置代理指令，以便只限制管道中的那些阶段使用云代理。为了使自由作业能够利用云代理，我们可以在“标签表达式”中提到该代理，该“标签表达式”与“作业配置”页面的“常规”选项卡中的“限制该项目的运行位置”选项一起提供。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es mc"><img src="../Images/b9889cc4b98b3b1af5db4481777c3313.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*rdPFlw1kaC6gtwMq"/></div></figure><ul class=""><li id="791e" class="li lj hh jl b jm kh jq ki ju ly jy lz kc ma kg lw lo lp lq bi translated">一旦配置为利用云代理的管道或自由作业运行，我们可以在Jenkins中看到以下变化:</li></ul><p id="bacc" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">机群状态显示正在启动(附加到机群名称的id是AWS中正在启动的EC2实例的id)</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es md"><img src="../Images/5b1f2007dcb93fc4b6f1f120b16662d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/0*Qupy1kO6Rk-SroID"/></div></figure><p id="7add" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">代理现在将反映在仪表板&gt;节点下</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es me"><img src="../Images/91d79f5ecaaa3353a4131ef0e1263e76.png" data-original-src="https://miro.medium.com/v2/resize:fit:618/0*gfOW8JpX5fXGedgf"/></div></figure><p id="f352" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hi">指向注释</strong>:</p><p id="1db5" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我们在舰队设置中将“最小集群大小”设置为0，因此构建代理必须等待实例可用。这可以从管道日志和构建代理日志中看出:</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es mf"><img src="../Images/f026d84357b093c3cb97d9859ac1cf52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_picgGU99HGip-yi"/></div></div></figure><p id="ec5c" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">代理日志显示Jenkins正在尝试连接到构建代理，但是实例还不可用，因此在开始构建时会有一些延迟。如果您的构建对时间敏感，不能等待，请确保您有一定数量的实例已经在运行并且可用。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es mg"><img src="../Images/15344c686f4170a798a1c574b2d82203.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*p4IH961Rlu9lCCtf"/></div></div></figure><p id="7b49" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">代理可用并连接后，我们可以在代理日志中看到状态:</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es mh"><img src="../Images/71f375fe5a66ab903c360cd60ccd090f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/0*--dbqnk5qcrKCKu8"/></div></figure><p id="b559" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我们可以在自动扩展组中看到容量更新:</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es mi"><img src="../Images/a5904d4f2de09cb8923075b4d3347005.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QNHphxMSfeo17THq"/></div></div></figure><p id="f0ba" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">构建完成后，如果没有其他构建要运行，代理将被允许按照我们的设备群设置中“缩减规模前的最大空闲分钟数”内配置的值空闲运行，在我们的示例中为5分钟。我们必须小心地选择这个值，否则代理将很快缩减，然后必须重新启动以运行新的构建。</p><p id="371a" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">一旦代理终止，我们可以在我们的自动扩展组的活动历史中验证它</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es mj"><img src="../Images/3492b7b237684ada1969e1b1ac58d747.png" data-original-src="https://miro.medium.com/v2/resize:fit:866/0*Sh8-cHYGhY6_MP8I"/></div></figure><p id="38c9" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">“自动缩放”组中的容量也将反映相同的情况:</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es mk"><img src="../Images/563df3ba318ae190b2e89f094a70abf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jemcLOpRhyG_G9A8"/></div></div></figure><h1 id="2d6b" class="il im hh bd in io km iq ir is kn iu iv iw ko iy iz ja kp jc jd je kq jg jh ji bi translated">7-故障排除</h1><ul class=""><li id="1f5e" class="li lj hh jl b jm jn jq jr ju lk jy ll kc lm kg lw lo lp lq bi translated">如果代理日志中出现java异常，说明“找不到java ”,您可以配置使用用户数据在构建代理上安装Java:</li></ul><p id="0729" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">#!/bin/bash</p><p id="b571" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">最新消息</p><p id="f75b" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">yum install-y Java-1 . 8 . 0-open JDK . x86 _ 64</p><ul class=""><li id="4b61" class="li lj hh jl b jm kh jq ki ju ly jy lz kc ma kg lw lo lp lq bi translated">如果存在连接问题，请检查与自动扩展组关联的安全组中的规则是否允许流量。如果Jenkins和EC2位于不同的网络中，请验证该实例是否有要连接的公共IP地址。</li></ul><h1 id="e409" class="il im hh bd in io km iq ir is kn iu iv iw ko iy iz ja kp jc jd je kq jg jh ji bi translated">8-摘要</h1><p id="1a1a" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">我们的主要目标是在Jenkins中建立一个动态容量，它可以使用Jenkins插件和AWS功能根据我们的工作负载自动扩展。上述设置非常灵活，但我们仍然需要仔细计算以下方面，以优化适合我们工作负载的效率:</p><ol class=""><li id="ce4e" class="li lj hh jl b jm kh jq ki ju ly jy lz kc ma kg ln lo lp lq bi translated">我们车队的集群规模，因为这将决定可用的最小和最大容量。</li><li id="c5a0" class="li lj hh jl b jm ml jq mm ju mn jy mo kc mp kg ln lo lp lq bi translated">我们希望在每台机器上运行的执行器数量。</li><li id="7eec" class="li lj hh jl b jm ml jq mm ju mn jy mo kc mp kg ln lo lp lq bi translated">为我们的舰队配置空闲时间断开。</li><li id="bae4" class="li lj hh jl b jm ml jq mm ju mn jy mo kc mp kg ln lo lp lq bi translated">在我们的车队中包含Spot实例，以最大限度地节约成本。</li></ol><p id="5026" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">如果等待代理的构建数量更频繁地增加，我们可能还需要重新考虑容量。</p><h1 id="2f18" class="il im hh bd in io km iq ir is kn iu iv iw ko iy iz ja kp jc jd je kq jg jh ji bi translated">9-参考文献</h1><p id="36cf" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated"><a class="ae mq" href="https://plugins.jenkins.io/ec2-fleet/" rel="noopener ugc nofollow" target="_blank">https://plugins.jenkins.io/ec2-fleet/</a></p><p id="42ae" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><a class="ae mq" href="https://www.jenkins.io/doc/book/scaling/architecting-for-scale/" rel="noopener ugc nofollow" target="_blank">https://www . Jenkins . io/doc/book/scaling/architecting-for-scale/</a></p><p id="519f" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><a class="ae mq" href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/AutoScalingGroup.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/autoscaling/ec2/user guide/autoscaling group . html</a></p><p id="4bc2" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><a class="ae mq" href="https://www.globant.com/stay-relevant/partnerships/aws" rel="noopener ugc nofollow" target="_blank">AWS Globant (T1)</a></p></div></div>    
</body>
</html>