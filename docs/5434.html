<html>
<head>
<title>15 Minutes to get a Kafka Cluster running on Kubernetes — and start producing and consuming from a Node application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes上运行Kafka集群只需15分钟——并开始从节点应用程序进行生产和消费</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/15-minutes-to-get-a-kafka-cluster-running-on-kubernetes-and-start-producing-and-consuming-from-a-b0fa7f8bcfeb?source=collection_archive---------0-----------------------#2018-04-19">https://medium.com/oracledevs/15-minutes-to-get-a-kafka-cluster-running-on-kubernetes-and-start-producing-and-consuming-from-a-b0fa7f8bcfeb?source=collection_archive---------0-----------------------#2018-04-19</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/090ba98ae93cb39e5a1e13593f2cf262.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lYEWMjG9tvWBUVen."/></div></div></figure><p id="a8fd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我将在研讨会上介绍微服务和通信模式，我需要与会者拥有自己的本地Kafka集群。我已经找到了一种方法，可以让它们在很短的时间内运行起来。得益于以下因素的结合:</p><ul class=""><li id="db1e" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated">库伯内特斯</li><li id="f5b8" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">迷你库贝</li><li id="65ce" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">Yolean/Kubernetes-kafka GitHub Repo和Kubernetes yaml文件创建了我们需要的所有内容(包括Kafka管理器)</li></ul><p id="0833" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">先决条件:</p><ul class=""><li id="5dde" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated">安装了Minikube和Kubectl</li><li id="9595" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">minikube集群正在运行(Minikube启动)</li></ul><p id="d0e5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在我的情况下，版本是:</p><p id="adf5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Minikube: v0.22.3，Kubectl客户端1.9和(Kubernetes)服务器1.7:</p><figure class="kb kc kd ke fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/39b18c7b51044bead91c5159413a1dcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kQ9xZ19wV4shf3PV."/></div></div></figure><p id="9bc1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我经历的步骤:</p><p id="f70e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Git克隆GitHub库:<a class="ae kf" href="https://github.com/Yolean/kubernetes-kafka" rel="noopener ugc nofollow" target="_blank">https://github.com/Yolean/kubernetes-kafka</a></p><p id="6ed9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">从克隆的存储库的根目录中，运行以下kubectl命令:</p><p id="e353" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">(注意:我直到今天才知道kubectl apply–f可以与目录引用一起使用，然后将应用该目录中的所有yaml文件。这非常有用！)</p><p id="d5af" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">kube CTL apply-f ./configure/mini kube-storage class-broker . yml<br/>kube CTL apply-f ./configure/mini kube-storage class-zookeeper . yml</p><p id="f637" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">(注意:我必须注释掉这两个文件中的回收策略属性——可能是因为我运行的是相当旧版本的Kubernetes)</p><p id="8441" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">kubectl应用-f/动物园管理员</p><p id="a63f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">库贝克特尔应用-f ./卡夫卡</p><p id="20c9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">(注意:我不得不将50pzoo和51zoo以及50kafka.yaml中的API版本从apiVersion: apps/v1beta2更改为API version:apps/v1 beta 1——详见<a class="ae kf" href="https://github.com/kubernetes/kubernetes/issues/55894" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes/kubernetes/issues/55894</a>；再次，我应该升级我的Kubernetes版本)</p><p id="53f4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要使Kafka可以从minikube主机访问(在K8S集群本身之外)</p><p id="0313" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">kubectl应用-f/外部-服务</p><p id="3ae6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这将服务公开为NodePort类型，而不是ClusterIP类型，从而使它们可供能够访问Kubernetes主机的客户端应用程序使用。</p><p id="6e76" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我还安装了(雅虎)Kafka管理器:</p><p id="60f1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">kubectl apply-f ./Yahoo-Kafka-manager</p><p id="21bf" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">(我必须将kafka-manager中的API版本从apiVersion: apps/v1beta2更改为apiVersion: apps/v1beta1)</p><p id="8f23" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">此时，Kafka集群正在运行。我可以在Kubernetes仪表板中检查pod和服务，也可以通过命令行上的kubectl来检查。我可以找到能接触到卡夫卡经纪人的港口:</p><figure class="kb kc kd ke fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/947a27b7c28d64e5ff75bc5a64f60ee5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sLupIgFOa0y4obj9."/></div></div></figure><p id="a35e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我可以在指定的端口访问Kafka管理器。</p><figure class="kb kc kd ke fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/c5afc6249dd5c7f8bd835b1129781d9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4RbNm74LvjC8Wy35."/></div></div></figure><p id="3116" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最初，Kafka管理器中看不到任何集群。通过提供图中突出显示的Zookeeper信息(zookeeper.kafka:2181 ),我可以使集群在这个用户界面工具中可见。</p><p id="f231" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最后是吃布丁:有计划地生产和消费去往和来自集群的消息。使用世界上最简单的节点Kafka客户端，很容易看到这些东西正在工作。我印象深刻。</p><p id="3cd7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我已经创建了节点应用程序及其package.json文件。然后添加了kafka-node依赖项(NPM install Kafka-node–save)。接下来，我创建了生产者:</p><pre class="kb kc kd ke fd kg kh ki kj aw kk bi"><span id="23f0" class="kl km hh kh b fi kn ko l kp kq">// before running, either globally install kafka-node (npm install kafka-node) <br/>// or add kafka-node to the dependencies of the local application var kafka = require('kafka-node') <br/>var Producer = kafka.Producer <br/>KeyedMessage = kafka.KeyedMessage; <br/>var client; <br/>KeyedMessage = kafka.KeyedMessage; <br/>var APP_VERSION = "0.8.5" <br/>var APP_NAME = "KafkaProducer" <br/>var topicName = "a516817-kentekens"; <br/>var KAFKA_BROKER_IP = '192.168.99.100:32400'; </span><span id="4dd8" class="kl km hh kh b fi kr ko l kp kq">var kafkaConnectDescriptor = KAFKA_BROKER_IP; <br/>console.log("Running Module " + APP_NAME + " version " + APP_VERSION); </span><span id="5774" class="kl km hh kh b fi kr ko l kp kq">function initializeKafkaProducer(attempt) { <br/>  try { console.log(`Try to initialize Kafka Client at ${kafkaConnectDescriptor} and Producer, attempt ${attempt}`); <br/>  const client = new kafka.KafkaClient({ kafkaHost: kafkaConnectDescriptor }); <br/>  console.log("created client"); <br/>  producer = new Producer(client); <br/>  console.log("submitted async producer creation request");<br/>  producer.on('ready', function () { <br/>    console.log("Producer is ready in " + APP_NAME); <br/>  }); <br/>  producer.on('error', function (err) { <br/>        console.log("failed to create the client or the producer " + JSON.stringify(err)); <br/>  ) <br/>} catch (e) { <br/>  console.log("Exception in initializeKafkaProducer" + JSON.stringify(e)); <br/>  console.log("Try again in 5 seconds");<br/>  setTimeout(initializeKafkaProducer, 5000, ++attempt); <br/>} <br/>}//initializeKafkaProducer </span><span id="28ce" class="kl km hh kh b fi kr ko l kp kq">initializeKafkaProducer(1); <br/>var eventPublisher = module.exports; <br/>eventPublisher.publishEvent = function (eventKey, event) { <br/>  km = new KeyedMessage(eventKey, JSON.stringify(event)); <br/>  payloads = [ { topic: topicName, messages: [km], partition: 0 } ];<br/>  producer.send(payloads, function (err, data) { <br/>    if (err) { <br/>      console.error("Failed to publish event with key " + eventKey + " to topic " + topicName + " :" + JSON.stringify(err)); <br/>    } <br/>    console.log("Published event with key " + eventKey + " to topic " + topicName + " :" + JSON.stringify(data)); <br/>  }); <br/>} //publishEvent</span><span id="8f70" class="kl km hh kh b fi kr ko l kp kq">//example calls: (after waiting for three seconds to give the producer time to initialize) <br/>setTimeout(function () { eventPublisher.publishEvent("mykey", { "kenteken": "56-TAG-2", "country": "nl" }) } , 3000)</span></pre><p id="87a6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然后跑了制片人:</p><figure class="kb kc kd ke fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/4e21985378bb29ece226d661aa5945d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wQn49aI3QJmXaweJ."/></div></div></figure><p id="12c4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">创造消费者:</p><pre class="kb kc kd ke fd kg kh ki kj aw kk bi"><span id="4ed9" class="kl km hh kh b fi kn ko l kp kq">var kafka = require('kafka-node');</span><span id="b228" class="kl km hh kh b fi kr ko l kp kq">var client;<br/>var APP_VERSION = "0.8.5"<br/>var APP_NAME = "KafkaConsumer"<br/>var eventListenerAPI = module.exports;</span><span id="c421" class="kl km hh kh b fi kr ko l kp kq">var Consumer = kafka.Consumer</span><span id="0b41" class="kl km hh kh b fi kr ko l kp kq">var topicName = "a516817-kentekens";</span><span id="ed80" class="kl km hh kh b fi kr ko l kp kq">console.log("Running Module " + APP_NAME + " version " + APP_VERSION);<br/>console.log("Topic " + topicName);</span><span id="018d" class="kl km hh kh b fi kr ko l kp kq">var KAFKA_BROKER_IP = '192.168.99.100:32400';</span><span id="945a" class="kl km hh kh b fi kr ko l kp kq">var consumerOptions = {<br/>  kafkaHost: KAFKA_BROKER_IP,<br/>  groupId: 'local-consume-events-from-event-hub-for-kenteken-applicatie',<br/>  sessionTimeout: 15000,<br/>  protocol: ['roundrobin'],<br/>  fromOffset: 'earliest' // equivalent of auto.offset.reset valid values are 'none', 'latest', 'earliest'<br/>};</span><span id="3798" class="kl km hh kh b fi kr ko l kp kq">var topics = [topicName];</span><span id="8692" class="kl km hh kh b fi kr ko l kp kq">var consumerGroup = new kafka.ConsumerGroup(Object.assign({ id: 'consumerLocal' }, consumerOptions), topics);</span><span id="65f3" class="kl km hh kh b fi kr ko l kp kq">consumerGroup.on('error', onError);<br/>consumerGroup.on('message', onMessage);<br/>consumerGroup.on('connect', function () {</span><span id="ba53" class="kl km hh kh b fi kr ko l kp kq">console.log('connected to ' + topicName + " at " + consumerOptions.host);<br/>})</span><span id="41ec" class="kl km hh kh b fi kr ko l kp kq">function onMessage(message) {<br/>  console.log('%s read msg Topic="%s" Partition=%s Offset=%d'<br/>, this.client.clientId, message.topic, message.partition, message.offset);<br/>}</span><span id="8263" class="kl km hh kh b fi kr ko l kp kq">function onError(error) {<br/>  console.error(error);<br/>  console.error(error.stack);<br/>}</span><span id="c420" class="kl km hh kh b fi kr ko l kp kq">process.once('SIGINT', function () {<br/>  async.each([consumerGroup], function (consumer, callback) {<br/>    consumer.close(true, callback);<br/>  });<br/>});</span></pre><p id="27bf" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">并运行消费者——它适时地消费由发布者发布的事件。太棒了。</p><figure class="kb kc kd ke fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/9f16ef67db063df6da5444e926bd178c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2d-cNBPvPyo-Bq5s."/></div></div></figure><h1 id="f716" class="ks km hh bd kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">资源</h1><p id="60e0" class="pw-post-body-paragraph ip iq hh ir b is lp iu iv iw lq iy iz ja lr jc jd je ls jg jh ji lt jk jl jm ha bi translated">主要资源是GitHub回购:<a class="ae kf" href="https://github.com/Yolean/kubernetes-kafka" rel="noopener ugc nofollow" target="_blank">https://github.com/Yolean/kubernetes-kafka</a>。绝对是好东西。</p><p id="d84b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">也有用:npm包卡夫卡-node—【https://www.npmjs.com/package/kafka-node T2】</p><p id="2e2f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">关于Kubernetes的文档:<a class="ae kf" href="https://kubernetes.io/docs/user-journeys/users/application-developer/foundational/#section-2" rel="noopener ugc nofollow" target="_blank">https://Kubernetes . io/docs/user-journeys/users/application-developer/fundamental/# section-2</a>——参考了Kubectl和Minikube——以及https://www.katacoda.com/courses/kubernetes/playground的卡塔科达游乐场:<a class="ae kf" href="https://www.katacoda.com/courses/kubernetes/playground" rel="noopener ugc nofollow" target="_blank"/></p><p id="038b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><a class="ae kf" href="https://technology.amis.nl/tag/kafka/" rel="noopener ugc nofollow" target="_blank">卡夫卡</a> <a class="ae kf" href="https://technology.amis.nl/tag/kubectl/" rel="noopener ugc nofollow" target="_blank">库贝克</a> <a class="ae kf" href="https://technology.amis.nl/tag/kubernetes/" rel="noopener ugc nofollow" target="_blank">库伯内特</a> <a class="ae kf" href="https://technology.amis.nl/tag/minikube/" rel="noopener ugc nofollow" target="_blank">迷你库贝</a> <a class="ae kf" href="https://technology.amis.nl/tag/node/" rel="noopener ugc nofollow" target="_blank">节点</a></p></div><div class="ab cl lu lv go lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ha hb hc hd he"><p id="d02b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="mb">原载于2018年4月19日</em><a class="ae kf" href="https://technology.amis.nl/2018/04/19/15-minutes-to-get-a-kafka-cluster-running-on-kubernetes-and-start-producing-and-consuming-from-a-node-application/" rel="noopener ugc nofollow" target="_blank"><em class="mb">technology . amis . nl</em></a><em class="mb">。</em></p></div></div>    
</body>
</html>