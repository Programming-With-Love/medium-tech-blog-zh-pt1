<html>
<head>
<title>How to identify cost increases in Amazon Aurora due to I/O consumption and strategies to reduce costs.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何识别由于I/O消耗导致的Amazon Aurora成本增加以及降低成本的策略。</h1>
<blockquote>原文：<a href="https://medium.com/globant/how-to-identify-cost-increases-in-amazon-aurora-due-to-i-o-consumption-and-strategies-to-reduce-fb1eed06ee60?source=collection_archive---------0-----------------------#2021-04-14">https://medium.com/globant/how-to-identify-cost-increases-in-amazon-aurora-due-to-i-o-consumption-and-strategies-to-reduce-fb1eed06ee60?source=collection_archive---------0-----------------------#2021-04-14</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="ad62" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">介绍</h1><p id="7dae" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">我们很多人每天都在用亚马逊Aurora做不同的项目；毫无疑问，它是目前市场上最好的关系数据库。然而，理解数据库的定价通常有点复杂，更困难的是确定节省成本的策略。</p><p id="e4b0" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">在本文中，我将向您展示如何确定和优化Aurora数据库的成本，该数据库的成本在1个月内由于I/O消耗而翻倍。</p><p id="2bc8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">以下几点在<strong class="je hi"> : </strong>一文中有所涉及</p><ol class=""><li id="34f8" class="kf kg hh je b jf ka jj kb jn kh jr ki jv kj jz kk kl km kn bi translated">当前工作量</li><li id="45e0" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kk kl km kn bi translated">数据库成本增加</li><li id="1cf8" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kk kl km kn bi translated">确定根本原因</li><li id="c538" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kk kl km kn bi translated">降低I/O消耗成本的策略</li><li id="3390" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kk kl km kn bi translated">经验教训</li></ol><h1 id="e4b2" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">1.当前工作量</h1><p id="fbab" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">该数据库在生产中运行，支持拉丁美洲成千上万用户的操作；该数据库具有以下特征:</p><ul class=""><li id="98c4" class="kf kg hh je b jf ka jj kb jn kh jr ki jv kj jz kt kl km kn bi translated"><strong class="je hi">实例类型</strong> : db.r5.xlarge</li><li id="cd91" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kt kl km kn bi translated"><strong class="je hi">每秒写入查询数</strong> : 510</li><li id="79b8" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kt kl km kn bi translated"><strong class="je hi">每秒读取查询数</strong> : 6</li><li id="9451" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kt kl km kn bi translated"><strong class="je hi">到数据库的平均连接数</strong> : 100</li><li id="e1ee" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kt kl km kn bi translated"><strong class="je hi">类型:</strong>极光置备MySQL。</li></ul><p id="d146" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">工作负载从多个来源(如web服务器)接收大量查询。</p><h1 id="8075" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">2.数据库成本增加</h1><p id="20b3" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">数据库的成本开始突然增加，一个月内上涨了大约800美元；当我查看细节时，我意识到成本是由于I/O请求，在一个月内从<strong class="je hi">2811123309个</strong>io增加到<strong class="je hi">6000196824个</strong>io。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/69738fcec7cd09a105d8285304bde53e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mahDUB7Y6z-U14UNvN5wCg.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx">AWS Cost Explorer report.</figcaption></figure><p id="bc18" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">在查看AWS Cost Explorer并确定RDS成本增加后，我检查了每月账单以了解这一增加。</p><h2 id="cdb6" class="lk if hh bd ig ll lm ln ik lo lp lq io jn lr ls is jr lt lu iw jv lv lw ja lx bi translated"><strong class="ak">2021年2月</strong></h2><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ly"><img src="../Images/7124e82089a7ff54ee75bdb521ed9258.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RGoZUmUOVFGNASsvIirsOA.png"/></div></div></figure><h2 id="2a8f" class="lk if hh bd ig ll lm ln ik lo lp lq io jn lr ls is jr lt lu iw jv lv lw ja lx bi translated">2021年3月</h2><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lz"><img src="../Images/75a78074deab5c945f59fc5f5c49c2c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y-6nDelGb92_a2iS65bxww.png"/></div></div></figure><h1 id="e28f" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">3.确定根本原因</h1><p id="fdc2" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">当我们的服务成本增加时，最重要的是能够找出根本原因，为此，我们必须开始问自己一些关于工作负载的问题:</p><ul class=""><li id="718f" class="kf kg hh je b jf ka jj kb jn kh jr ki jv kj jz kt kl km kn bi translated">我们最近对工作负载做了哪些更改？</li><li id="cc91" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kt kl km kn bi translated">我们的业务KPI是否有变化，例如，我们的应用程序有更多的用户？</li></ul><p id="5700" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">在此之后，我们必须依靠AWS为我们提供的所有工具来确定原因。</p><h2 id="91f4" class="lk if hh bd ig ll lm ln ik lo lp lq io jn lr ls is jr lt lu iw jv lv lw ja lx bi translated">云观察指标</h2><p id="a72e" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">1-检查VolumeReadIOPs和VolumeWriteIOPs的CloudWatch指标，我们可以看到读取操作的增加</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ma"><img src="../Images/6c85b70168ca9c32886449cd0d9b970c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4tKOQachdafhehJsI8J-Bg.png"/></div></div></figure><h2 id="ddd9" class="lk if hh bd ig ll lm ln ik lo lp lq io jn lr ls is jr lt lu iw jv lv lw ja lx bi translated">性能洞察</h2><p id="7180" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">2-它目前不支持我们正在运行的亚马逊Aurora版本。但是如果你有同样的问题，你应该使用它。</p><h2 id="a92e" class="lk if hh bd ig ll lm ln ik lo lp lq io jn lr ls is jr lt lu iw jv lv lw ja lx bi translated">审计日志+ CloudWatch洞察</h2><p id="b6c5" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">3-为了识别导致高消耗的查询，我们必须在数据库中启用审计日志；一旦启用，我们必须转到CloudWatch Insights并查询日志，以找到这些在数据库中更频繁出现的查询。</p><pre class="kv kw kx ky fd mb mc md me aw mf bi"><span id="9b98" class="lk if hh mc b fi mg mh l mi mj">fields <a class="ae mk" href="http://twitter.com/message" rel="noopener ugc nofollow" target="_blank">@message</a>,<a class="ae mk" href="http://twitter.com/ingestionTime" rel="noopener ugc nofollow" target="_blank">@ingestionTime</a>,<a class="ae mk" href="http://twitter.com/timestamp" rel="noopener ugc nofollow" target="_blank">@timestamp</a><br/>| filter <a class="ae mk" href="http://twitter.com/message" rel="noopener ugc nofollow" target="_blank">@message</a> like /QUERY/ <br/>| limit 1000</span></pre><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ml"><img src="../Images/6e5e02f04d640bb90fd8f2a15868e30b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BxNk0VNL5uB7YCfR6m6Qow.png"/></div></div></figure><p id="1e00" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">在那里，我们已经可以识别数据库上运行的查询，并努力纠正问题。</p><h1 id="316e" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">4.降低I/O消耗成本的策略</h1><p id="5746" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">降低de I/O消耗成本的最佳策略是:</p><p id="75ee" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">1-与您的数据库管理员密切合作，确定是否有可以优化的查询。<br/> 2-像ElastiCache Redis一样在数据库前面添加一个缓存层。但是要考虑ElastiCache集群的成本，并考虑到您必须读取RDS来更新缓存数据库。<br/> 3-将该报告层带到S3，使用Athena进行查询，将其连接到可视化工具。</p><h1 id="c518" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">5.经验教训</h1><p id="090c" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">1-当需要做更详细的故障排除时，临时启用数据库中的日志；在这种情况下，我们使用审计日志；此外，我们还可以启用慢速查询、错误和常规日志。请注意，永久启用这些日志将导致CloudWatch日志的成本增加。</p><p id="0e1c" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">2-当我们的IO数据库成本较高时，了解您的工作负载的执行情况，调查消耗情况，并在应用程序级别进行纠正。</p><p id="70c6" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">3-当成本更多用于读取操作时，寻找替代方案；例如，评估您是否可以将S3 +雅典娜架构用于您的报告。</p><p id="97d8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">4-为了控制数据库模式的变化，使用不同的工具，比如Liquibase + Jenkins，它允许控制数据库中的变化。</p><p id="e15c" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">— <a class="ae mk" href="https://www.czam.dev/" rel="noopener ugc nofollow" target="_blank">卡洛斯·桑布拉诺</a></p></div></div>    
</body>
</html>