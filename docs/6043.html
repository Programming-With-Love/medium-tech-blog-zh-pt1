<html>
<head>
<title>Open-sourcing Pinball</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开源弹球</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/open-sourcing-pinball-47b0dad81326?source=collection_archive---------3-----------------------#2015-03-11">https://medium.com/pinterest-engineering/open-sourcing-pinball-47b0dad81326?source=collection_archive---------3-----------------------#2015-03-11</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="f377" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">刘长书叶茂pawel Garbacki &amp; joo seong Kim | Pinterest工程师</p><p id="3be3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">随着我们继续在快速和动态的环境中构建，我们需要一个灵活的工作流管理器来满足我们的数据处理需求。在尝试了几个选项之后，我们决定自己建造一个。今天，我们正在开源<a class="ae jc" href="https://github.com/pinterest/pinball" rel="noopener ugc nofollow" target="_blank"> Pinball </a>，它旨在满足广泛的数据处理管道的需求，这些管道由从简单的shell脚本到复杂的Hadoop工作负载的作业组成。弹球加入了我们的其他开源项目，如<a class="ae jc" href="https://engineering.pinterest.com/post/84276775924/introducing-pinterest-secor" rel="noopener ugc nofollow" target="_blank"> Secor </a>和<a class="ae jc" href="https://github.com/pinterest/bender" rel="noopener ugc nofollow" target="_blank"> Bender，</a>在我们的<a class="ae jc" href="https://github.com/pinterest?page=1" rel="noopener ugc nofollow" target="_blank"> Github </a>上可用。</p><h2 id="ead3" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">构建高度可定制的工作流管理器</h2><p id="a923" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">新产品功能的开发通常受到支持它们的数据可用性的限制。原始数据通常来自日志，在达到适合下游应用程序摄取的形状之前，会在多个维度上进行切片、切块、合并和过滤。数据转换的过程通常被建模为工作流，抽象地说，工作流是表示处理步骤的节点和描述运行后依赖关系的边的有向图。</p><p id="7fa4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">工作流可能非常复杂。在现实环境中，遇到由数百个节点组成的工作流并不罕见。构建、运行和维护如此复杂的工作流需要专门的工具。Bash脚本不行。</p><p id="deff" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在对一些开源工作流管理器进行试验后，我们发现它们都不够灵活，无法适应我们<a class="ae jc" href="https://engineering.pinterest.com/post/92742371919/powering-big-data-at-pinterest" rel="noopener ugc nofollow" target="_blank">数据处理解决方案</a>不断变化的环境。特别是，当前可用的解决方案要么支持特定类型的作业(例如<a class="ae jc" href="http://oozie.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Oozie </a>针对Hadoop计算进行了优化)，要么抽象地宽泛且难以扩展(例如单片<a class="ae jc" href="http://data.linkedin.com/opensource/azkaban" rel="noopener ugc nofollow" target="_blank"> Azkaban </a>)。考虑到这一点，我们接受了实施高度可定制的工作流管理器版本的挑战，以适应数据处理用例的发展，从执行基本的shell命令到在Hadoop、Hive和Spark上进行复杂的ETL风格的计算。</p><p id="f51d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们所有的工程团队都使用Pinball，它处理数百个工作流和数千个作业，这些作业在我们的Hadoop集群中每天处理近3pb的数据。最大的工作流有500多个作业。工作流生成分析报告，建立搜索索引，训练ML模型，并执行大量其他任务。</p><h2 id="7dcf" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">平台与最终产品</h2><p id="ec60" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">Pinball提供完整的端到端解决方案，开箱即用。同时，它的组件式设计允许容易的改变。Pinball 的<a class="ae jc" href="https://engineering.pinterest.com/post/74429563460/pinball-building-workflow-management" rel="noopener ugc nofollow" target="_blank">工作流管理层建立在实现原子状态更新的通用抽象之上。</a></p><p id="3a4a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从概念上讲，Pinball的体系结构遵循主-工作器(或主-客户机，以避免与我们下面介绍的特殊类型的客户机混淆)范式，其中有状态的中央主充当无状态客户机的当前系统状态的真实来源。客户端有不同的风格，从负责作业执行的工作人员，到控制工作流何时运行的调度程序和允许用户与系统交互的UI，再到命令行工具。所有客户端都使用由主客户端公开的相同语言(协议),它们不直接通信。因此，客户端是独立的，可以很容易地被替换为其他实现。由于Pinball设计的灵活性，它是一个构建定制工作流管理解决方案的平台。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es kd"><img src="../Images/2ff28631922cf63b5b57280126755d29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*e_jtQyrgXGQ-_tPn.png"/></div></figure><p id="d321" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">虽然定制是可能的，但值得强调的是，Pinball附带了默认的客户端实现，允许用户定义、运行和监控工作流。</p><h2 id="e3d2" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">工作流生命周期</h2><p id="8a51" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">工作流是通过配置文件或UI工作流生成器定义的，甚至是从另一个工作流管理系统导入的。Pinball提供了一个可插入的<em class="kl">解析器</em>概念，允许用户以对他们最有意义的格式表达他们的工作流。解析器将一个不透明的工作流定义转换成一组代表工作流作业的<em class="kl">符号</em>，其格式可以被弹球理解。(<a class="ae jc" href="https://engineering.pinterest.com/post/74429563460/pinball-building-workflow-management" rel="noopener ugc nofollow" target="_blank">阅读更多关于弹球的功能。</a>)</p><p id="d37b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">工作流通过命令行工具或UI组件进行部署。部署调用解析器从工作流配置中提取<em class="kl">调度令牌</em>，并将其存储在主服务器中。调度令牌包含元数据，例如工作流配置的位置、工作流应该运行的时间、执行的重复和一个<em class="kl">溢出策略</em>。该策略描述了如果工作流的上一次运行在新的执行到期时尚未完成，系统应该如何操作。示例策略允许中止当前正在运行的工作流，启动与正在运行的工作流实例并行的另一个工作流实例，或者将工作流启动延迟到上一次运行完成。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es kd"><img src="../Images/ac6ac95e2a1d59905aa2a69d81929745.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*ruK9w7Hf3ESJEwv6.png"/></div></figure><p id="1b70" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">到时候，<em class="kl">调度器</em>使用存储在调度令牌中的信息来定位工作流配置，解析它并生成代表该工作流中各个作业的<em class="kl">作业令牌</em>。作业令牌在唯一的<em class="kl">工作流实例</em> ID下被发送到主服务器。工作流实例彼此独立控制，使用户能够灵活地并行运行同一工作流的多个实例。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es kd"><img src="../Images/5fbc247b0959f6daece72f9e937fa7a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*MeFo26NwrWeSFnBM.png"/></div></figure><p id="5e46" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作业令牌由空闲的<em class="kl">工作者</em>来声明和执行。作业由工作人员在子流程中运行的命令行来描述。子流程的输出被捕获并显示在UI中。Pinball将特殊格式的日志行解释为要在UI中公开或传递给下游作业的值。这允许我们在弹球UI中直接嵌入到Hadoop job tracker页面的链接，或者将参数从上游作业传播到其下游依赖项。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es kd"><img src="../Images/9aebbe5b847c836c3affd3c7df7c1691.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*6_E3GD-nqfVymj_g.png"/></div></figure><p id="df9e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果作业失败时需要任何后处理(例如，可能需要删除部分输出)，Pinball提供了将任意清理命令附加到作业配置的能力。即使要求该作业的工人在执行过程中死亡，清理也能保证运行。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es kd"><img src="../Images/8306ece06cc21ae835b4e5aaec310b6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*Ayk88aWgb7TaaC4n.png"/></div></figure><p id="ec3d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">失败的作业可以自动或手动重试。用户可以通过与工作流程图交互来选择要重试的任何作业子集。在处理较大的作业层次结构时，操作的批量化显著提高了可用性。</p><p id="67a6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当工作流实例完成时(失败或成功)，可选的电子邮件通知将发送给工作流所有者。</p><h2 id="2e53" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">工作流配置和作业模板</h2><p id="6fc0" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">对于最终用户来说，workflow manager通常是一个黑盒子，使用精灵魔法来调度和执行他们的工作，但是工作流本身需要以某种方式定义。在设计Pinball时，我们有意识地选择不将配置语法作为系统核心的一部分，以便给开发人员很大的灵活性，以在给定设置中最有意义的方式定义工作流配置。与此同时，我们希望提供一个低门槛的全套服务。因此，我们决定在开源版本中包含一个简化版本的解析器和作业模板。</p><p id="913e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">开箱即用，我们支持基于Python的工作流配置语法。我们还提供了许多作业模板，用于在Hadoop平台上配置简单的shell脚本以及更复杂的计算。我们为EMR和Qubole平台提供了本地支持，并提供了一些强大的功能，例如在弹球UI中嵌入作业链接，以及在作业失败后清理资源。我们还提出了一个条件的概念，允许用户对作业之间的数据依赖关系进行建模(想象一个作业被延迟，直到它需要的数据变得可用)。</p><p id="7b62" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">试试我们的<a class="ae jc" href="https://github.com/pinterest?page=1" rel="noopener ugc nofollow" target="_blank">项目</a>，让我们知道你的想法！如果你有兴趣从内部参与这样的项目，<a class="ae jc" href="https://about.pinterest.com/en/careers/engineering-product" rel="noopener ugc nofollow" target="_blank">加入我们的团队</a>。</p><p id="f811" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kl"> Pawel Garbacki是货币化团队的软件工程师。叶茂、刘长书和Jooseong Kim是数据团队的软件工程师。</em></p><p id="5f3f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kl">鸣谢:感谢Krishna Gade、Mohammad Shahangian、Tongbo Huang、Julia Oh和Roger Wang对弹球项目做出的宝贵贡献。</em></p><p id="6b51" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kl">获取Pinterest工程新闻和更新，关注我们的工程</em><a class="ae jc" href="https://www.pinterest.com/malorie/pinterest-engineering-news/" rel="noopener ugc nofollow" target="_blank"><em class="kl">Pinterest</em></a><em class="kl">，</em> <a class="ae jc" href="https://www.facebook.com/pinterestengineering" rel="noopener ugc nofollow" target="_blank"> <em class="kl">脸书</em> </a> <em class="kl">和</em> <a class="ae jc" href="https://twitter.com/PinterestEng" rel="noopener ugc nofollow" target="_blank"> <em class="kl">推特</em> </a> <em class="kl">。有兴趣加入团队吗？查看我们的</em> <a class="ae jc" href="https://about.pinterest.com/en/careers/engineering-product" rel="noopener ugc nofollow" target="_blank"> <em class="kl">招聘网站</em> </a> <em class="kl">。</em></p></div></div>    
</body>
</html>