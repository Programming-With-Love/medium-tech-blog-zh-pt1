<html>
<head>
<title>Airbnb’s Page Performance Score on iOS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Airbnb在iOS上的页面性能评分</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/airbnbs-page-performance-score-on-ios-36d5f200bc73?source=collection_archive---------2-----------------------#2021-12-13">https://medium.com/airbnb-engineering/airbnbs-page-performance-score-on-ios-36d5f200bc73?source=collection_archive---------2-----------------------#2021-12-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="1c4c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc">这是我们关于</em> <a class="ae jd" rel="noopener" href="/airbnb-engineering/creating-airbnbs-page-performance-score-5f664be0936"> <em class="jc"> Airbnb的页面性能评分</em> </a> <em class="jc">系列的延续，该评分衡量来自任何平台真实用户的多个性能指标。系列:</em> <a class="ae jd" rel="noopener" href="/airbnb-engineering/creating-airbnbs-page-performance-score-5f664be0936"> <em class="jc">第1部分</em> </a> <em class="jc">和</em> <a class="ae jd" rel="noopener" href="/airbnb-engineering/measuring-web-performance-at-airbnb-122da8d3ea3f"> <em class="jc">第2部分</em> </a> <em class="jc">。</em></p><p id="1227" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">尼古拉斯·米勒</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/c9eca3dc2d3b5cd977a1c632e0f3712b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*33B60glCNf0ePfNHrvwYew.jpeg"/></div></div></figure><p id="7402" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Airbnb，我们创建了<a class="ae jd" rel="noopener" href="/airbnb-engineering/creating-airbnbs-page-performance-score-5f664be0936">页面性能评分</a>，为我们的工程师和数据科学家提供大量以用户为中心的性能指标，以更好地了解和改进我们的产品。在本帖中，我们将深入探讨我们如何定义这些指标，并在iOS上使用它们。</p><h1 id="271e" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">页面系统</h1><p id="852a" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">Airbnb上的整个客户旅程分为不同的页面，每个页面都有自己实测的<a class="ae jd" rel="noopener" href="/airbnb-engineering/creating-airbnbs-page-performance-score-5f664be0936">页面性能得分</a> (PPS)。为了支持这种基于页面的性能跟踪系统，我们构建了一个标准化的基础设施，使工程师能够配置代表其功能的页面。</p><p id="19e0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在iOS上，一个页面与一个<em class="jc"> UIViewController </em>相关联。我们在一个<em class="jc"> UIViewController的</em>生命周期中收集性能数据，并且只在<em class="jc">viewdiddeave</em>上发出日志事件。没有<em class="jc">页面名称，</em>通用页面标识符，就无法创建或发送该日志事件。</p><h1 id="a0b2" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">使用仪器</h1><p id="c4fb" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">由于检测这些指标涉及许多边缘情况和复杂性，我们创建了一个页面性能分数状态机类，称为<em class="jc"> PPSStateMachine </em>。这个类封装了跟踪和计算性能指标以及生成日志事件的所有逻辑。任何想要记录PPS事件的工程师都可以通过获取与其<em class="jc"> UIViewController </em>相关联的<em class="jc"> PPSStateMachine </em>并在<em class="jc"> UIViewController的</em>生命周期事件期间调用相关方法来完成。为了使事情变得更简单，我们已经建立了额外的工具和基础设施，因此工程师只需要提供他们的页面的名称和内容的状态—例如，加载、已加载或错误。</p><h1 id="e2f1" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">PPSStateMachine</h1><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kt ku l"/></div></figure><h1 id="f346" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">时间</h1><p id="c037" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">在测量性能时，所有时间都以纳秒为单位进行测量，然后转换为毫秒。通过将纳秒(UInt64)和毫秒(Float64)的概念创建为更具体的类型，我们迫使开发人员在转换为更常用的类型(例如Int、Float)时考虑比例。</p><p id="938a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">获取当前时间时，我们使用单调时钟，该时钟的值单调递增，并且在系统休眠时将继续递增。该值属于64位纳秒类型。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kt ku l"/></div></figure><p id="d29f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当标记持续时间的开始和结束时间时，我们有一个计算变量，它返回以毫秒为单位的当前时间。这使我们能够避免由于铸造造成的大多数准确度和精度误差。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kt ku l"/></div></figure><h2 id="116d" class="kv jr hh bd js kw kx ky jw kz la lb ka ip lc ld ke it le lf ki ix lg lh km li bi translated">例子</h2><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kt ku l"/></div></figure><h1 id="c66b" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">查看关联</h1><p id="f62e" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">每个<em class="jc"> UIViewController </em>都有一个关联的<em class="jc"> PPSStateMachine </em>。这个<em class="jc"> PPSStateMachine </em>可以在开发者想要测量一个名字下的一系列页面时被覆盖。与<em class="jc"> UIViewController </em>相关联允许通过爬行视图响应链在<em class="jc"> UIView </em>上找到<em class="jc"> PPSStateMachine </em>。</p><h1 id="848f" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">版本控制</h1><p id="1747" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">在PPS协议中声明生命周期和语义方法允许我们抽象出分数是如何计算的。除了视频性能等全新指标之外，对PPS公式的大多数更新都不会导致开发人员需要更新各自的功能。在幕后，对公式的任何重大更改都首先通过将潜在值放入记录的事件的元数据中进行测试。一旦验证了潜在值，就可以将其升级为影响页面性能分数的官方值。</p><h1 id="25c4" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">度量实施</h1><h1 id="132f" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">首次布局时间(TTFL)</h1><p id="7b65" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">TTFL在UIViewController的viewDidLoad期间开始，在UIViewController的第一个viewDidLayoutSubviews之后结束。</p><h1 id="dbd0" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">初始装载时间(TTIL)</h1><p id="5932" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">TTIL在UIViewController的viewDidLoad期间开始，并在设置加载的内容后结束一个渲染周期。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lj"><img src="../Images/f539caf60a5e26b2014c562f83258af9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*EW0b3z7ZpIrJhtzI0W2DSA.gif"/></div><figcaption class="lk ll et er es lm ln bd b be z dx">This is for illustrative purposes only and does not necessarily show anything that may or may not be available on Airbnb at any time. The content shown in the image may or may not be correct.</figcaption></figure><h1 id="4c63" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">卷轴线挂起(某物)</h1><p id="37d5" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">STHs报告为故障持续时间与最大帧持续时间之间的差值，根据两倍刷新率的最小阈值进行过滤。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kt ku l"/></div></figure><p id="51e2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae jd" href="https://developer.apple.com/documentation/quartzcore/cadisplaylink" rel="noopener ugc nofollow" target="_blank"><em class="jc">CADisplayLink</em></a>精确观察大多数STHs。<em class="jc">运行循环。模式</em>为<em class="jc"> RunLoop。模式跟踪</em>。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kt ku l"/></div></figure><p id="2b6b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">每次触发显示链接时，我们都会根据旧帧和当前帧进行计算。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lj"><img src="../Images/29c815730f1983d57b7b9619d29d9f16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*D9y4xHtuKdAEf1ytdM-iEQ.gif"/></div><figcaption class="lk ll et er es lm ln bd b be z dx">This is for illustrative purposes only and does not necessarily show anything that may or may not be available on Airbnb at any time. The content shown in the image may or may not be correct.</figcaption></figure><p id="e76c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">主线程挂起(MTH)跟踪可以在iOS上存在，但是，准确跟踪MTH会对性能产生一个小而持续的拖累。在我们的MTH跟踪测试中，CPU无法睡眠，电池电量耗尽，该指标并没有给我们提供比某物更多的关于视觉感知性能的信息。因此，我们决定不在iOS上测量MTH。</p><h1 id="614f" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">附加装载时间(ALT)</h1><p id="6e26" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">ALT在显示加载程序时开始，在加载程序消失并设置内容后的一个渲染周期结束。</p><p id="83e0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了说明这个度量，让我们看一下无限滚动。如果在加载下一页之前到达底部，则记录的ALT是在加载下一页之前加载器(或底部)可见的时间。如果从未到达底部，例如，由于预取，则ALT记录为零。为了准确地记录日志，我们需要知道滚动百分比，底部加载器是否可见，以及跟踪旧状态的状态机。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lj"><img src="../Images/c89fac000f572ba924c6a68520281655.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*WTBC00sL2fp9MW5xom2jpA.gif"/></div><figcaption class="lk ll et er es lm ln bd b be z dx">This is for illustrative purposes only and does not necessarily show anything that may or may not be available on Airbnb at any time. The content shown in the image may or may not be correct.</figcaption></figure><h1 id="1bb7" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">丰富内容加载时间(RCLT)</h1><p id="7d84" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">通过我们的视图抽象<em class="jc"> URLImageView </em>，RCLT对于工程师来说是完全隐藏的，它能够显示来自URL的图像。</p><p id="f201" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">RCLT只跟踪加载程序或占位符可见的时间。如果加载图像被隐藏，那么隐藏的行为标志着RCLT的结束。</p><p id="38f0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在每一个<em class="jc"> URLImageView </em>状态改变时，通过抓取视图的响应链并更新状态机是否加载图像来找到相应的<em class="jc"> PPSStateMachine </em>。<em class="jc"> PPSStateMachine </em>将计算持续时间并删除URL部分，如果持续时间低于指定阈值，则仅保存持续时间，以便日志不会太大。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kt ku l"/></div></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lj"><img src="../Images/2c4ea9ea64962f3621ac85effe7acc6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*FDRRuig-2gi_9IZP"/></div><figcaption class="lk ll et er es lm ln bd b be z dx">This is for illustrative purposes only and does not necessarily show anything that may or may not be available on Airbnb at any time. The content shown in the image may or may not be correct.</figcaption></figure><h1 id="d849" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">摘要</h1><p id="3d92" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">我们目前在iOS上实施的PPS已经允许工程师快速实施和接收真实的性能数据。我们不断发展和扩大我们的工具和基础设施。我们希望您能在贵公司应用并推进我们的知识。</p><h2 id="58a2" class="kv jr hh bd js kw kx ky jw kz la lb ka ip lc ld ke it le lf ki ix lg lh km li bi translated">增值</h2><p id="75b5" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">感谢所有在Native上帮助构建PPS的人:<a class="ae jd" href="https://www.linkedin.com/search/results/all/?keywords=luping%20lin&amp;origin=RICH_QUERY_SUGGESTION&amp;position=0&amp;searchId=58011edb-813b-43c3-9f00-f886aa446e84&amp;sid=VYi" rel="noopener ugc nofollow" target="_blank">陆平·林</a>、<a class="ae jd" href="https://www.linkedin.com/in/hdezninirola/" rel="noopener ugc nofollow" target="_blank">安东尼奥·尼罗拉</a>、<a class="ae jd" href="https://www.linkedin.com/in/kellerbryan19/" rel="noopener ugc nofollow" target="_blank">布莱恩·凯勒</a>、<a class="ae jd" href="https://www.linkedin.com/in/noahsmartin/" rel="noopener ugc nofollow" target="_blank">诺亚·马丁</a>、<a class="ae jd" href="https://www.linkedin.com/in/scheuermann/" rel="noopener ugc nofollow" target="_blank">安德鲁·舒尔曼</a>、<a class="ae jd" href="https://www.linkedin.com/search/results/all/?keywords=joshua%20nelson%20%E2%9C%A8&amp;origin=RICH_QUERY_SUGGESTION&amp;position=0&amp;searchId=959d4aca-c80e-448a-b415-4a732ba7a84d&amp;sid=Rr6" rel="noopener ugc nofollow" target="_blank">乔希·尼尔森</a>、<a class="ae jd" href="https://www.linkedin.com/in/joshpolsky/" rel="noopener ugc nofollow" target="_blank">乔希·波尔斯基</a>、<a class="ae jd" href="https://www.linkedin.com/in/jnvollmer/" rel="noopener ugc nofollow" target="_blank">让-尼古拉斯·沃尔默</a>、<a class="ae jd" href="https://www.linkedin.com/in/wensheng-mao-76ab7142/" rel="noopener ugc nofollow" target="_blank">毛文生</a>以及所有一路帮助过的人。</p></div></div>    
</body>
</html>