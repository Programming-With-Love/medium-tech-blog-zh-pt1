# Azure DevOps ä¸­ Kubernetes é…ç½®çš„è‡ªåŠ¨éªŒè¯

> åŸæ–‡ï¼š<https://medium.com/compendium/automatic-validation-of-kubernetes-config-in-azure-devops-e9ae15d67d3e?source=collection_archive---------1----------------------->

åŒå€¦äº†å› ä¸º YAML æ–‡ä»¶ä¸­çš„ç¼©è¿›é”™è¯¯è€Œå¯¼è‡´çš„å‘å¸ƒå¤±è´¥å—ï¼Ÿå¸Œæœ›è¯­æ³•é”™è¯¯åƒå…¶ä»–ä»£ç ä¸€æ ·è¢«æ„å»ºç®¡é“æ•è·å—ï¼Ÿé‚£ä¹ˆè¿™å¯èƒ½æ˜¯ä½ çš„è§£å†³æ–¹æ¡ˆï¼

![](img/bfb6e7cedf186382f8b798b21270491f.png)

Validation errors again!?

# TLï¼›é€Ÿåº¦ä¸‰è§’å½¢å®šä½æ³•(dead reckoning)

*   æ‚¨å¯ä»¥ä½¿ç”¨ [Kubeval](https://kubeval.instrumenta.dev/) æ¥éªŒè¯æ‚¨çš„ k8s é…ç½®ï¼Œä½œä¸ºæ„å»ºç®¡é“çš„ä¸€éƒ¨åˆ†ã€‚
*   å°†[è¿™ä¸ª](https://gist.github.com/teodoran/afb3b6888a7c40a0a2dc2fb399d4dd57)å’Œ[è¿™ä¸ª](https://gist.github.com/teodoran/9205f1974ef3dc985e1b658bf0c61e50)æ–‡ä»¶æ·»åŠ åˆ° repo ä¸­ä¸€ä¸ªåä¸º *Kubeval* çš„æ–‡ä»¶å¤¹ä¸­ï¼Œå°†[è¿™ä¸¤ä¸ªä»»åŠ¡æ·»åŠ åˆ°ç®¡é“å®šä¹‰](https://gist.github.com/teodoran/b41b282c0f2705924903fe6bca8ffbde)ä¸­ï¼Œå°±å¤§åŠŸå‘Šæˆäº†ï¼*

**æˆ‘å‡è®¾ä½ å·²ç»å¿½ç•¥äº†* [*ä¸­çš„æ‰€æœ‰ bin æ–‡ä»¶å¤¹ã€‚gitignore*](https://git-scm.com/docs/gitignore) *ï¼Œå¹¶åœ¨æ‚¨çš„æ„å»ºç®¡é“ä¸­ä½¿ç”¨åŸºäº Linux çš„ä»£ç†ã€‚*

# å¤šç»™æˆ‘è®²è®²ï¼

## è®°å¾—å—-é¢„æ¼”ï¼Ÿ

Kubectl å¯ä»¥é€šè¿‡ä½¿ç”¨- dry-run æ ‡å¿—åœ¨æœ¬åœ°éªŒè¯ k8s é…ç½®ï¼Œè€Œä¸éœ€è¦å®é™…éƒ¨ç½²ä»»ä½•ä¸œè¥¿ã€‚è¿™å¾ˆå¥½ï¼Œä¹Ÿæ˜¯åœ¨æ‚¨è‡ªå·±çš„æœºå™¨ä¸ŠéªŒè¯é…ç½®çš„ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œä½†æ˜¯è®© Kubectl ä½œä¸ºæ„å»ºç®¡é“çš„ä¸€éƒ¨åˆ†å·¥ä½œå¯èƒ½ä¼šå¾ˆæ£˜æ‰‹ã€‚å› æ­¤ï¼Œå½“æ‚¨åœ¨æäº¤ä¹‹å‰å¿˜è®°éªŒè¯é…ç½®æ—¶ï¼Œæˆ–è€…æ‚¨åªæ˜¯æ‡’å¾—æ‰¾åˆ°å‘½ä»¤å’Œå‚æ•°çš„æ­£ç¡®ç»„åˆï¼Œè€Œåªæ˜¯éªŒè¯ï¼Œè€Œä¸æ˜¯æŠ±æ€¨å…¶ä»–äº‹æƒ…æ—¶ï¼Œæ‚¨å°±é™·å…¥äº†è¿™æ ·ä¸€ç§æƒ…å†µï¼Œåœ¨å‘å¸ƒå¤±è´¥ä¹‹å‰ï¼Œä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆå¥½ğŸ’£

## è¾“å…¥ Kubeval

[Kubeval](https://kubeval.instrumenta.dev/) æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºåœ¨æœ¬åœ°æˆ– CI ç®¡é“ä¸­éªŒè¯ Kubernetes é…ç½®çš„å·¥å…·ã€‚å®ƒæ˜¯[å¼€æºè½¯ä»¶](https://github.com/instrumenta/kubeval/)ï¼Œæ”¯æŒå¤šä¸ª Kubernetes ç‰ˆæœ¬ï¼Œå¹¶ä¸”å¾ˆå¥½åœ°å‘ç°äº†æˆ‘ä»¬åœ¨ç¼–è¾‘éƒ¨ç½²ã€æœåŠ¡ã€å…¥å£ç­‰æ—¶éƒ½ä¼šçŠ¯çš„æ‰€æœ‰å°é”™è¯¯ã€‚

![](img/40107e2e1f0a995ef22a86a77fc07161.png)

Kubeval in action

## é™åˆ¶

å³ä½¿ Kubeval éªŒè¯æˆåŠŸï¼Œå‘å¸ƒä»ç„¶å¯èƒ½å¤±è´¥ï¼Œå› ä¸ºåªæœ‰åœ¨å®é™…é›†ç¾¤ä¸Šæ‰§è¡Œé…ç½®æ—¶æ‰èƒ½å‘ç°ä¸€äº›é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å¼•ç”¨é›†ç¾¤ä¸Šä¸å­˜åœ¨çš„é…ç½®æ˜ å°„ï¼ŒKubeval å°†æ— æ³•æ•æ‰é”™è¯¯ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒè¿˜æ˜¯å¾ˆæ“…é•¿å¤„ç†æ‰€æœ‰â€œæ²¡æœ‰æ‰¾åˆ°é¢„æœŸçš„é”®â€ã€â€œé”™è¯¯çš„ç¼©è¿›â€å’Œâ€œæ— æ•ˆç±»å‹â€çš„é”™è¯¯ã€‚

# å°† Kubeval æ·»åŠ åˆ°æ‚¨çš„æ„å»ºç®¡é“ä¸­

## æ‰¾åˆ°åº“è´ç“¦å°”

Kubeval [ä»¥å‹ç¼©äºŒè¿›åˆ¶](https://kubeval.instrumenta.dev/installation/)çš„å½¢å¼å‘å¸ƒï¼Œå¯ç”¨äºä¸åŒçš„å¹³å°ã€‚å‡è®¾æˆ‘ä»¬ä½¿ç”¨åŸºäº Linux çš„ç®¡é“ä»£ç†ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è„šæœ¬æ¥ä¸‹è½½ã€éªŒè¯å’Œè§£å‹ç¼© *kubeval* å¯æ‰§è¡Œæ–‡ä»¶ã€‚

æ–°å»ºä¸€ä¸ªåä¸º *Kubeval* çš„æ–‡ä»¶å¤¹ï¼Œæ·»åŠ ä¸€ä¸ªåä¸º [use-kubeval.sh](https://gist.github.com/teodoran/afb3b6888a7c40a0a2dc2fb399d4dd57) çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºã€‚

ç”±äºæˆ‘ä»¬ä»äº’è”ç½‘ä¸‹è½½å¹¶è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæˆ‘ä»¬åº”è¯¥éªŒè¯æˆ‘ä»¬å®é™…ä¸Šå·²ç»å¾—åˆ°äº†æˆ‘ä»¬æƒ³è¦çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ¥è‡ªé»‘å®¢æˆ–ä¸­é—´äººæ”»å‡»è€…çš„å¥‡æ€ªä¸œè¥¿ã€‚è¿™å¯ä»¥ç”¨ Linux å®ç”¨ç¨‹åº [*sha256sum*](https://en.wikipedia.org/wiki/Sha1sum) å’Œä¸€ä¸ªæ ¡éªŒå’Œæ–‡ä»¶æ¥å®Œæˆï¼Œæ‰€ä»¥é™¤äº†ä½¿ç”¨-kubeval.shï¼Œæˆ‘ä»¬è¿˜éœ€è¦å‘ *Kubeval* æ–‡ä»¶å¤¹æ·»åŠ ä¸€ä¸ªæ ¡éªŒå’Œæ–‡ä»¶ï¼Œå‘½åä¸º [kubeval-checksum](https://gist.github.com/teodoran/9205f1974ef3dc985e1b658bf0c61e50) ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºã€‚

> å½“ç”¨ä½œ use-kubeval.sh è„šæœ¬çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œâ€œsha256sum -c kubeval-checksumâ€å°†ä¸ºæˆ‘ä»¬ä¸‹è½½çš„æ–‡ä»¶ç”Ÿæˆé˜¿æ²™-256 å“ˆå¸Œï¼Œå¹¶å°†å…¶ä¸å­˜å‚¨åœ¨ kubeval-checksum ä¸­çš„å…ˆå‰ç”Ÿæˆçš„å“ˆå¸Œè¿›è¡Œæ¯”è¾ƒã€‚æ‚¨åº”è¯¥è¯„ä¼°è¿™ä¸ªéªŒè¯ç­–ç•¥å¯¹äºæ‚¨çš„æ„å»ºç³»ç»Ÿæ˜¯å¦è¶³å¤Ÿå®‰å…¨ã€‚å¯ä»¥ç”¨â€œsha 256 sumâ€”tag bin/Kubeval-Linux-amd64 . tar . gzâ€ä¸ºæ–°ç‰ˆæœ¬çš„ kube val ç”Ÿæˆæ–°çš„æ ¡éªŒå’Œã€‚å¦‚æœè¦ä½¿ç”¨æ›´é•¿çš„æ ¡éªŒå’Œå“ˆå¸Œï¼Œå¯ä»¥ä½¿ç”¨â€œsha512sumâ€ã€‚

# å‘ç”Ÿæˆç®¡é“æ·»åŠ éªŒè¯

ç°åœ¨æˆ‘ä»¬éœ€è¦å‘ [azure-pipeline.yml](https://gist.github.com/teodoran/b41b282c0f2705924903fe6bca8ffbde) ç®¡é“å®šä¹‰æ·»åŠ ä¸¤ä¸ªæ­¥éª¤ã€‚ç¬¬ä¸€ä¸ªæ‰§è¡Œ *Kubeval* æ–‡ä»¶å¤¹ä¸­çš„ use-kubeval.shï¼Œç¬¬äºŒä¸ªæ‰§è¡Œ *CI* æ–‡ä»¶å¤¹ä¸­æ‰€æœ‰ YAML æ–‡ä»¶çš„ä¸¥æ ¼éªŒè¯ã€‚

å› ä¸ºæˆ‘ä»¬ä½¿ç”¨ Linux å‘½ä»¤æ¥ä¸‹è½½ã€éªŒè¯å’Œè§£å‹ç¼© kubeval å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰€ä»¥æ‚¨éœ€è¦åœ¨æ„å»ºç®¡é“ä¸­ä½¿ç”¨åŸºäº Linux çš„ vmImageï¼Œæ¯”å¦‚â€œubuntu-latestâ€ã€‚

æ ¹æ®æ‚¨æ˜¯å¦ä½¿ç”¨ Docker ä»¥åŠæ‚¨åœ¨ç®¡é“ä¸­æ”¾ç½® Kubeval-steps çš„ä½ç½®ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å°† *Kubeval* æ–‡ä»¶å¤¹æ·»åŠ åˆ°æ‚¨çš„[ä¸­ã€‚dockerignore](https://docs.docker.com/engine/reference/builder/#dockerignore-file) ï¼Œé¿å…å°†å†…å®¹å¤åˆ¶åˆ°æ‚¨çš„ Docker å›¾åƒä¸­ã€‚

# å…³äºå®‰å…¨æ€§å’Œå‡çº§ Kubeval çš„ä¸€äº›ä¿¡æ¯

å¦‚ use-kubeval.sh è„šæœ¬ä¸­æ‰€è¿°ï¼Œæ‚¨åº”è¯¥æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬çš„ kubeval å¯ç”¨ï¼Œå¦‚æœæœ‰ï¼Œå°±å‡çº§ã€‚åœ¨æ‰€æœ‰å¯é¢„è§çš„æœªæ¥ä½¿ç”¨ v0.14.0 ç‰ˆæœ¬å¯èƒ½æ˜¯ä¸€ä¸ªéå¸¸ç³Ÿç³•çš„æƒ³æ³•ğŸ˜…

*è®°å¾—ä¸ºæ–°ç‰ˆæœ¬çš„ kubeval ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰â€œsha 256 sum-tag bin/kube val-Linux-amd64 . tar . gzâ€çš„æ–°æ ¡éªŒå’Œã€‚*