<html>
<head>
<title>Automatic Virtual IP Failover on Oracle Cloud Infrastructure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Oracle云基础架构上的自动虚拟IP故障转移</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/automatic-virtual-ip-failover-on-oracle-cloud-infrastructure-ce28dc293b04?source=collection_archive---------0-----------------------#2017-10-02">https://medium.com/oracledevs/automatic-virtual-ip-failover-on-oracle-cloud-infrastructure-ce28dc293b04?source=collection_archive---------0-----------------------#2017-10-02</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="076f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在当今世界，高可用性非常重要，因此，自动化虚拟IP故障切换对于保持应用程序的运行至关重要，这样，如果主云服务器出现问题，用户就可以在不受任何影响的情况下执行其职责。</p><p id="815e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本文介绍了如何使用Linux Corosync/pacer以及OCI命令行界面(CLI)在Oracle云基础架构(OCI)上轻松实现VirtualIP故障转移过程的自动化。</p><p id="a2ad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">主要目标是展示如何将<a class="ae jc" href="https://docs.us-phoenix-1.oraclecloud.com/Content/Network/Tasks/managingIPaddresses.htm" rel="noopener ugc nofollow" target="_blank"> OCI辅助IP </a>设置为在出现停机情况时自动进行故障切换。</p><h1 id="7a1b" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">入门指南</h1><p id="9ac0" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">让我们先了解一下将要使用的组件。如上所述，有三个主要组件允许您的虚拟IP (OCI辅助IP)自动进行故障切换:</p><ul class=""><li id="0f35" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated"><a class="ae jc" href="http://clusterlabs.org/corosync.html" rel="noopener ugc nofollow" target="_blank"> Corosync </a>是一个集团通信系统，具有在应用程序中实现高可用性的附加功能。</li><li id="92ca" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated"><a class="ae jc" href="http://clusterlabs.org/pacemaker.html" rel="noopener ugc nofollow" target="_blank">起搏器</a>这是一个开源、高可用性资源管理器，适用于小型和大型集群。</li><li id="b14e" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated"><a class="ae jc" href="https://docs.us-phoenix-1.oraclecloud.com/Content/API/SDKDocs/cli.htm" rel="noopener ugc nofollow" target="_blank"> OCI CLI </a>负责将Linux Corosync/pacer virtuip IP addr 2资源与Oracle云基础架构vNIC辅助IP集成。</li></ul><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/24f7e0d7aee759048f3ff7f793ef7b6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*h3oTHbzIp1QD7bfK.png"/></div></div></figure><h1 id="65c8" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">要求</h1><ul class=""><li id="a74c" class="kg kh hh ig b ih kb il kc ip lg it lh ix li jb kl km kn ko bi translated">至少2个Oracle Linux 7.x OCI实例(虚拟机或BM形状)。也可以使用其他Linux发行版</li><li id="738d" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">coro sync/起搏器</li><li id="bc5e" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">OCI国家牵头倡议</li><li id="7b5f" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">浮动知识产权(即:172.0.0.10/24)</li></ul><p id="7196" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">完成Oracle Linux实例的资源调配后，您将需要按照<a class="ae jc" href="https://docs.us-phoenix-1.oraclecloud.com/Content/API/SDKDocs/cli.htm" rel="noopener ugc nofollow" target="_blank">公共文档</a>中的说明设置OCI命令行界面，安装并配置Corosync/起搏器群集及其要求(一致性、仲裁、资源、约束等)。配置Corosync/起搏器群集和OCI CLI后，您将需要设置VirtualIP资源。下面是一个关于如何使用命令行在coro sync/pacer上设置虚拟化资源的快速示例。同样的过程也可以通过web浏览器UI来完成。</p><blockquote class="lj"><p id="e975" class="lk ll hh bd lm ln lo lp lq lr ls jb dx translated">$ sudo pcs资源创建Cluster_VIP ocf:心跳:ipader 2 IP = 172 . 0 . 0 . 10 CIDR _ net mask = 24 op监控间隔=20s</p></blockquote><p id="284c" class="pw-post-body-paragraph ie if hh ig b ih lt ij ik il lu in io ip lv ir is it lw iv iw ix lx iz ja jb ha bi translated"><strong class="ig hi">注意</strong>:pacer命令中的“cidr_netmask=24”取决于子网大小为/24</p><p id="7a22" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下一步是选择一个Oracle Linux coro syn/Pacemaker OCI节点，并使用OCI控制台分配一个新的OCI辅助IP地址(将基于VCN 172.0.0.0/16使用172.0.0.10 ),如<a class="ae jc" href="https://docs.us-phoenix-1.oraclecloud.com/Content/Network/Tasks/managingIPaddresses.htm" rel="noopener ugc nofollow" target="_blank">公共文档</a>中所述。该OCI二级IP将用作Corosync/Pacemaker浮动IP。</p><h1 id="4fdb" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">将Linux Corosync/Pacemaker与OCI CLI集成</h1><p id="6d2a" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">现在，您已经启动并运行了Oracle Linux Corosync/Pacemaker OCI实例以及OCI CLI，您需要确定将用于自动执行故障切换流程的节点连接虚拟网络接口卡(vnic)Oracle Cloud IDs(OCID)。关于如何做的更多细节可以在<a class="ae jc" href="https://docs.us-phoenix-1.oraclecloud.com/Content/Network/Tasks/managingVNICs.htm" rel="noopener ugc nofollow" target="_blank">这里</a>找到。记下您的集群节点ocid，使用您自己的ocid更新下面的CLI，并在所有节点上运行以下命令来更新Corosync/Pacemaker IPaddr2资源。</p><blockquote class="lj"><p id="e4d2" class="lk ll hh bd lm ln lo lp lq lr ls jb dx translated">$ sudo sed-I ' 64i \ # # # # OCI虚拟网卡变量\ '/usr/lib/ocf/resource . d/heart beat/IP addr 2</p><p id="6dab" class="lk ll hh bd lm ln lo lp lq lr ls jb dx translated">$ sudo sed-I ' 65i \ server = " ` hostname-s ` " \ '/usr/lib/ocf/resource . d/heart beat/IP addr 2</p><p id="c133" class="lk ll hh bd lm ln lo lp lq lr ls jb dx translated">$ sudo sed-I ' 66i \ node 1 vNIC = " ocid 1 . vNIC . oc1 . phx . node 1-vNIC-OCID " \ '/usr/lib/ocf/resource . d/heart beat/IP addr 2</p><p id="797f" class="lk ll hh bd lm ln lo lp lq lr ls jb dx translated">$ sudo sed-I ' 67i \ node 2 vNIC = " ocid 1 . vNIC . oc1 . phx . node 2-vNIC-OCID " \ '/usr/lib/ocf/resource . d/heart beat/IP addr 2</p><p id="03bf" class="lk ll hh bd lm ln lo lp lq lr ls jb dx translated">$ sudo sed-I ' 68i \ vnicip = " 172 . 0 . 0 . 10 " \ '/usr/lib/ocf/resource . d/heart beat/IP addr 2</p><p id="c82f" class="lk ll hh bd lm ln lo lp lq lr ls jb dx translated">$ sudo sed-I ' 614 I \ # # # # # OCI/IP addr集成\ '/usr/lib/ocf/resource . d/heart beat/IP addr 2</p><p id="05a7" class="lk ll hh bd lm ln lo lp lq lr ls jb dx translated">$ sudo sed-I ' 615 I \ if[$ server = " node 1 "]；然后\ '/usr/lib/ocf/resource . d/heart beat/IP addr 2</p><p id="572e" class="lk ll hh bd lm ln lo lp lq lr ls jb dx translated">$ sudo sed-I ' 616 I \/root/bin/OCI network vnic assign-private-IP-unassign-if-has-assigned-vnic-id $ node 1 vnic-IP-address $ vnicip \ '/usr/lib/ocf/resource . d/heart beat/IP addr 2</p><p id="29cd" class="lk ll hh bd lm ln lo lp lq lr ls jb dx translated">$ sudo sed-I ' 617 I \ else \ '/usr/lib/ocf/resource . d/heart beat/IP addr 2</p><p id="4d7c" class="lk ll hh bd lm ln lo lp lq lr ls jb dx translated">$ sudo sed-I ' 618 I \/root/bin/OCI network vnic assign-private-IP-unassign-if-has-assigned-vnic-id $ node 2 vnic-IP-address $ vnicip \ '/usr/lib/ocf/resource . d/heart beat/IP addr 2</p><p id="b7ca" class="lk ll hh bd lm ln lo lp lq lr ls jb dx translated">$ sudo sed-I ' 619 I \ fi \ '/usr/lib/ocf/resource . d/heart beat/IP addr 2</p></blockquote><p id="c1ef" class="pw-post-body-paragraph ie if hh ig b ih lt ij ik il lu in io ip lv ir is it lw iv iw ix lx iz ja jb ha bi translated"><strong class="ig hi">注:</strong></p><ol class=""><li id="5c2b" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb ly km kn ko bi translated">将ocid 1 . vNIC . oc1 . phx . node 1-vNIC-OCID和ocid 1 . vNIC . oc1 . phx . node 2-vNIC-OCID替换为您自己的OCI vNICs ocid。</li><li id="3c7c" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb ly km kn ko bi translated">如果您在不同的位置安装了OCI CLI，请替换/root/bin/ path。</li><li id="b0ac" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb ly km kn ko bi translated">用您自己的集群节点主机名条目替换“节点1”和“节点2”主机名条目。</li><li id="48e3" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb ly km kn ko bi translated">上面的示例是针对2个Oracle Linux 7.4 Corosync/Pacemaker云节点的，如果您的集群有2个以上的节点，可以很容易地针对其他节点进行调整。</li></ol><h1 id="53ec" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">测试虚拟化故障转移</h1><p id="91be" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">您的配置已经完成，现在是测试虚拟化故障转移的时候了。您可以通过模拟崩溃、禁用启动虚拟IP的节点或简单地通过命令行将Corosync/Pacemaker VirtualIP资源从一个节点移动到另一个节点来实现。</p><p id="80cf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下示例假设您的VirtualIP (Cluster_VIP)资源正在节点1上运行，因此，要将其移动到节点2，您需要运行以下命令:</p><blockquote class="lj"><p id="e65a" class="lk ll hh bd lm ln lo lp lq lr ls jb dx translated">$ sudo pcs资源移动Cluster_VIP节点2</p></blockquote><h1 id="6627" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo lz jq jr js ma ju jv jw mb jy jz ka bi translated">示范</h1><p id="3685" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">观看此<a class="ae jc" href="https://youtu.be/MbM4H5i1rVE" rel="noopener ugc nofollow" target="_blank">OCI自动虚拟化故障转移视频(4分钟)</a>了解故障转移如何在停机或资源迁移过程中自动发生，而不会影响您的最终用户访问通信。</p><p id="2d7b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="mc">注意——自由级用户可能会体验到其帐户所含服务的变化。</em></p></div></div>    
</body>
</html>