# A/B 测试的监控和警报—实时检测问题

> 原文：<https://medium.com/walmartglobaltech/monitoring-and-alerting-for-a-b-testing-detecting-problems-in-real-time-4fe4f9b459b6?source=collection_archive---------1----------------------->

![](img/1d9857700cc46cdf43714a6a6c9c3beb.png)

Photo credit: [a_roesler](https://pixabay.com/en/red-warning-alert-bulb-light-2708362/)

在 WalmartLabs，我们正在构建 Expo，这是一个针对我们网站和应用的 A/B 测试框架。我们拥有的一个关键组件是监控和警报，以监控 A/B 测试环境的不同方面。该系统需要检测实验中的任务或用户行为何时出现问题，并向相关人员发出警报。

# 概观

在本文中，我将详细介绍 A/B 测试团队构建的两个警报应用程序，用于监视我们的实时报告系统，并确保系统和在 A/B 测试框架中进行的实验按预期正常工作。

在继续之前，我想首先描述一下 A/B 测试是如何工作的，以便观众对流程有更好的理解。

在 A/B 测试中，每个用户将被分配到不同的实验变量。实验可以是用户界面的改变，后端算法的改变，比如搜索算法，或者任何可能影响用户行为的可以测量的东西。UI A/B 测试的一个简单的例子是购买按钮有两种不同的设计。一个设计有一个红色的大按钮，另一个是蓝色的小按钮。这些设计中的每一个都是一种变化。当前在生产中运行的变化称为“控制”。在设置好变体之后，Expo 将在这两个(或更多)变体之间划分流量，并基于用户行为，为每个变体生成指标。例如，一个指标可以是转换率，在我们的例子中是访问我们网站并进行购买的访问者的百分比。如果这些变化的度量值之间的差异在统计上是显著的，我们选择获胜者并在生产中使用它。

为了生成这些指标，我们有两项工作。一个是实时作业，为我们实时提供快速、原始的指标数据。另一项工作是每天运行，并从更准确的数据源为我们提供更精确的计算。

# 访问者数量的异常检测

我们跟踪的指标之一是每分钟访问该网站并被分配到一个实验的独立用户的数量。实时作业跟踪这个数字，并将该指标推送到时序数据库。我们注意到，在分配或实时作业中可能会出现问题，导致该指标出现峰值或下降，我们希望在出现这种情况时得到通知。找到差异的一个简单的解决方案是取几分钟前的短时间内的平均值( *average_s_time* )，并将其与最近 3 个小时的较长时间内的平均值( *average_l_time* )进行比较，然后我们会期望 *average_s_time* 与 *average_l_time* 不会相差太多。考虑到这些值遵循正态分布，我们能够用 3-sigma 测试评估 *average_s_time* 与更长时间的值，并决定我们是否有过去几分钟的警报。起初这似乎是一个好主意，但这种方法最终会产生大量误报警报，从而降低警报系统的可信度。

这种行为的原因是因为数据是周期性的，平均值会根据窗口大小和我们计算平均值的时间而波动。因此，我们需要以某种方式规范数据，并从数据中移除周期性因素。

一个有用的算法已经出来一段时间了，就是用黄土或 STL 对时间序列进行季节分解([https://www.otexts.org/fpp/6/5)](https://www.otexts.org/fpp/6/5))。该算法将时间序列数据分解为三个不同的数据集:季节、趋势和余数。下图显示了一个时间序列数据示例以及这三个数据集的情况。

![](img/fbbe15d356ac55e2b2965711560a370e.png)

International airline passengers: monthly totals in thousands for 1949–1960 ([https://tinyurl.com/yb45ca2n](https://tinyurl.com/yb45ca2n))

正如你所看到的，余数是没有季节性和趋势的原始数据，你可以更容易地跟踪这个图表中的突然变化。通过对剩余数据应用之前的算法，我们现在能够实时捕捉问题，同时最大限度地减少误报警报。

# 实时实验度量警报(RTEMA)

当一个实验者设计一个实验，并在他们之间分配流量时，尽快知道实验是否有问题是非常关键的。例如，其中一个变体中可能有一个 bug，它阻止了客户前往结账页面。我们希望确保我们捕捉到这种类型的错误，如果其中一个变化的数据偏离很大，系统就会发出警报。

正如概述中提到的，Expo 实时跟踪不同的指标。其中大多数是基于比率的，这意味着它来自两个数的除法。例如，转换率指标来自于买东西的顾客数量除以所有访问者的数量。然而，一些指标，如分配的访问者数量不是比率。以下算法每 15 分钟运行一次。每个变化都有自己的指标值，由实时报告系统按分钟、小时和天生成。

上面的算法很容易得到，所以我不再赘述。该系统观察的另一个指标是两种变化的访问者数量。如果它没有接近为每个变化配置的流量比例，它将发送警报。

为了使算法变得更加实用并减少误报警报的数量，我们对原始算法进行了以下改进:

*   正如您在第 9 行中看到的，每个指标都有自己的阈值，而不是使用全局阈值。然而，我们必须以某种方式确定它的正确值。为此，我们选择了一些健康的实验进行采样，并应用第 8 行中的相同算法来为*阈值(M)* 找到合适的值。
*   我们做的另一个调整是忽略低流量实验。如果游客的数量不超过一个特定的数字，我们就不走了。
*   该算法的初始实现是回顾 15 分钟，如果发现任何异常，就发送警报。我们把算法改成了两轮运行。在第一轮中，它会在过去 15 分钟内为每个实验找到可能的异常指标，然后在更长的时间内以更小的阈值(默认情况下为*阈值(M)/2* )再次查看，如果我们从第一轮获得的指标也通过了第二轮，它会发出警报。

有了这些变化，我们大大减少了假阳性警报，同时系统通过在实验者发现之前发送真实警报来挽救我们。

# 结论

警报是 WalmartLabs 生态系统的重要组成部分，因为即使是很小的问题也会导致客户或收入的重大损失。虽然我们有不同的工具来监控一般性能和错误，但是有些系统需要额外的考虑来发现异常行为。在本文中，我们展示了两个在 Expo 中遇到的此类需求的例子，以及我们如何实施监控和警报来检测访客分配或变化指标中的问题，以便能够保持系统的质量。

作为本文的最后一部分，我想提及我们在开发这些算法时遵循的三个要点。

*   保持简单:这是当方法是启发式的时候我们采取的原则，我们想要开发一个与真实数据一起工作的算法。对于上述两种算法，我们从调整数据开始，并制作了一个简单的算法原型，在找到它们的弱点后，我们迭代改进它。这使得开发过程变得更加容易，同时根据真实数据查看算法的输出更加实际，并且更容易为下一步做出正确的决定。
*   使它可信:当你开发一个定制的警报系统时，你应该注意误报警报。由于真实数据的性质，不可避免地会出现某些误报警报，但是我们需要考虑这一因素，否则人们会开始质疑整个警报系统的可信度。
*   将算法的参数具体化:这一部分可能很明显，我们需要从代码中提取参数，并在运行时给出。我之所以放在这里，是因为这和上一节有点关系。我们需要实时处理真正的正面警报。我们可能希望实时调整参数，或者能够关闭压倒我们的警报，然后解决问题的根本原因。