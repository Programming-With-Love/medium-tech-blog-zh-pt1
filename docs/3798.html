<html>
<head>
<title>Introduction to drone.io CI/CD platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">drone.io CI/CD平台简介</h1>
<blockquote>原文：<a href="https://medium.com/globant/introduction-to-drone-io-ci-cd-platform-1d43f8bc1728?source=collection_archive---------0-----------------------#2021-12-23">https://medium.com/globant/introduction-to-drone-io-ci-cd-platform-1d43f8bc1728?source=collection_archive---------0-----------------------#2021-12-23</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="1768" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">介绍</h1><p id="14d1" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在一个充斥着CI/CD产品的世界里，谁会认为还有空间给另一个呢？这篇文章介绍了另一个在CI/CD领域的玩家<a class="ae ka" href="https://www.drone.io/" rel="noopener ugc nofollow" target="_blank"> Drone.io </a>，由于一系列独特的功能，它在该领域的其他玩家中脱颖而出，近年来获得了很大的人气。无人机是一个开源的持续集成和交付平台，完全建立在docker之上。这是真正的码头本地；所有组件都是docker容器，应用程序中所有管道步骤的执行也是作为容器进行的。Docker是一种用于隔离构建和部署的封装方法。</p><p id="ece2" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">无人机拥有超过5万名用户，并被一些知名公司使用，如易贝、<a class="ae ka" href="https://open.blogs.nytimes.com/2017/01/12/continuous-deployment-to-google-cloud-platform-with-drone/" rel="noopener ugc nofollow" target="_blank">、纽约时报</a>、<a class="ae ka" href="https://devnetsandbox.cisco.com/sandbox-instructions/CICD_Pipeline/helloworld.html" rel="noopener ugc nofollow" target="_blank">思科</a>和VMWare等。他们最近被<a class="ae ka" href="https://harness.io/" rel="noopener ugc nofollow" target="_blank"> Harness </a>收购，从那以后他们发布了第二版，也就是我们将在本文中回顾的版本。</p><p id="9438" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">我们将在本地设置无人机，因此您可以测试无人机并试用它来了解它的多种功能。使用helm charts在Kubernetes上部署也非常容易，但这超出了本文的范围，我们的想法是专注于学习Drone的特性，而不是如何在生产环境中正确部署它。我们将在后面的文章中讨论这个问题。</p><p id="0ba6" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">本文将回顾以下部分:</p><ul class=""><li id="2c6a" class="kg kh hh je b jf kb jj kc jn ki jr kj jv kk jz kl km kn ko bi translated">特征</li><li id="9464" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">体系结构</li><li id="b9c1" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">装置</li><li id="64c5" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">使用</li><li id="c448" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">结论</li></ul><h1 id="fd50" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">特征</h1><p id="7ad5" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">以下是无人机的主要功能列表:</p><ul class=""><li id="9bb7" class="kg kh hh je b jf kb jj kc jn ki jr kj jv kk jz kl km kn ko bi translated">Drone是非常轻量级的，因为它是用Go编写的，所有组件都作为docker容器运行。这使得在几分钟内就可以在许多平台或云提供商中轻松部署无人机。默认情况下，每个管道步骤都在运行时自动下载的独立docker容器中执行。此外，与Jenkins等其他CI/CD产品相比，Drone的学习曲线非常低。</li><li id="55e4" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">Runners可用于多种操作系统和架构，包括Linux amd64、Linux arm/arm64、Windows和Mac服务器。有了如此广泛的平台支持，单个产品可以用于多种用例场景:从传统的云部署到物联网，再到本机Windows或Mac版本。</li><li id="4ca6" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">可扩展的架构:Drone为不同的云提供商提供自动缩放器，这些云提供商将根据需求启动runners，通过避免为他们分配专用资源的需要，帮助开发人员节省他们的云账单。</li><li id="9045" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">它可以在内部安装，也可以作为具有附加功能的SaaS产品，因此您可以选择最适合您需求的产品。</li><li id="2bf5" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">功能可以通过插件和扩展来扩展。插件为管道增加功能，为无人机核心本身增加扩展。插件非常容易开发，因为它们可以用任何语言编写，并且在容器中独立运行。</li><li id="ee1d" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">管道以YAML格式定义，具有简单且定义明确的语法。</li><li id="7132" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">不同的数据库后端选项。默认情况下，它使用SQLite，开箱即用，但对于生产部署，它可以使用外部PostgreSQL或MySQL数据库。</li><li id="4511" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">而且越到最后越好，是开源！</li></ul><p id="8e3a" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">但是无人机也有一些缺点，到目前为止我注意到了以下几点:</p><ul class=""><li id="d054" class="kg kh hh je b jf kb jj kc jn ki jr kj jv kk jz kl km kn ko bi translated">无人机服务器必须可以通过互联网访问，这样SCM平台才能访问无人机服务器上的webhooks。</li><li id="d21b" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">虽然Drone有大约100个插件，但这并不像Jenkins等其他产品的插件数量那么多。</li><li id="cb61" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">它只支持git SCM平台，但是对于任何现代项目来说，这都不是问题。</li><li id="60c9" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">一个无人机服务器实例一次只能访问一个git SCM平台，如果您使用多个平台，那么您将需要实例化多个无人机服务器，每个SCM一个。</li></ul><h1 id="6120" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">体系结构</h1><p id="41dd" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">Drone有一个非常简单的基于客户端和服务器的架构，它由三个部分组成:</p><ul class=""><li id="8636" class="kg kh hh je b jf kb jj kc jn ki jr kj jv kk jz kl km kn ko bi translated">无人机服务器</li><li id="fa21" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">无人机特工(称为奔跑者)</li><li id="d123" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">无人机管道配置文件(在每个git存储库上)</li></ul><p id="2a3f" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">下图更详细地描述了其体系结构:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/9a0d9d72ffceb38004662f1752a8bb0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_QSWVDyXD_jLyxGW"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx">Drone architecture diagram</figcaption></figure><h2 id="2ae2" class="lk if hh bd ig ll lm ln ik lo lp lq io jn lr ls is jr lt lu iw jv lv lw ja lx bi translated">服务器</h2><p id="5788" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">无人机服务器是主要组件。它是一个go二进制文件，被打包成一个docker映像，可以作为docker容器在Linux、Mac、Windows机器上或在Kubernetes集群中运行。还有一个SaaS版本，但这不是我们在这篇文章中要谈论的。</p><p id="00e2" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">服务器负责监控SCM平台(如GitHub、Bitbucket、Gitea等)中的git存储库的变化，然后根据存储在存储库中的配置文件指示运行程序做什么。这个文件就是通常所说的管道定义。服务器使用OAuth向git存储库认证，使用共享秘密向运行者认证。</p><p id="79c2" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">当Drone服务器在服务器上被激活时，它会自动在git存储库上创建一个webhook。然后，当一个事件发生时，例如一个开发人员将一些代码推送到一个分支，webhook被触发，无人机服务器被通知这个事件。当这种情况发生时，无人机服务器从git存储库中提取无人机配置文件，解析它，并在适当的运行器上对其上的指定任务(管道步骤)进行排队。</p><h2 id="810f" class="lk if hh bd ig ll lm ln ik lo lp lq io jn lr ls is jr lt lu iw jv lv lw ja lx bi translated">赛跑运动员</h2><p id="522e" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">运行者执行存储库的无人机配置文件中指定的步骤。与服务器一样，运行程序被打包成docker映像，也可以作为docker容器在Linux、Mac、Windows机器上、Kubernetes集群上或直接在VM上运行。有几种类型的跑步者:</p><ul class=""><li id="f24c" class="kg kh hh je b jf kb jj kc jn ki jr kj jv kk jz kl km kn ko bi translated"><em class="ly"> Docker runner: </em>这个runner是一个守护进程，它在短暂的Docker容器中执行管道步骤。它在Linux、Mac或Windows机器上作为容器运行。它可以作为单个docker runner安装，或者安装在多台机器上以创建一个构建集群。</li><li id="93d2" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated"><em class="ly"> Kubernetes runner: </em>这个runner是一个独立的服务，在pod内部执行管道。</li><li id="d0e8" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated"><em class="ly">本地执行运行器:</em>这个运行器是一个守护进程，它使用默认的shell直接在主机上执行构建管道，而不需要隔离。对于不能在容器内执行的工作负载，或者不容易适应基于容器的管道的工作负载，建议使用该方法。这个运行器对于不支持容器的操作系统和架构特别有用。</li><li id="0906" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated"><em class="ly"> SSH运行程序:</em>该运行程序使用SSH协议在远程服务器上执行管道命令。管道命令直接在远程服务器上执行，没有隔离，使用默认的shell。</li><li id="31ce" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated"><em class="ly">适用于DigitalOcean、AWS和Macstadium的云运行器:</em>这种类型的运行器推荐用于需要特权访问完整虚拟机的管道，不适合在容器内执行。这些运行器在专用的短暂虚拟机中执行管道，并为不受信任的工作负载提供安全隔离。</li></ul><p id="2af3" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">运行程序一次运行一个任务，因此为了能够并行运行多个任务，必须使用多个运行程序。</p><h2 id="3af2" class="lk if hh bd ig ll lm ln ik lo lp lq io jn lr ls is jr lt lu iw jv lv lw ja lx bi translated">配置文件</h2><p id="3fa8" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">配置文件定义了一组步骤，这些步骤定义了git存储库的管道。这是一个位于git存储库中的YAML文件，命名为<em class="ly"> .drone.yml </em>。在最近的Drone版本中，已经引入了一些定义该配置文件的其他格式，如<a class="ae ka" href="https://jsonnet.org/" rel="noopener ugc nofollow" target="_blank"> Jsonet </a>和<a class="ae ka" href="https://docs.bazel.build/versions/main/skylark/language.html" rel="noopener ugc nofollow" target="_blank"> Starlark </a>为更复杂的管道带来了模板和脚本功能，但为了简单起见，我们将使用默认的YAML格式。</p><h2 id="75b0" class="lk if hh bd ig ll lm ln ik lo lp lq io jn lr ls is jr lt lu iw jv lv lw ja lx bi translated">插件和扩展</h2><p id="4c1c" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">无人机的功能可以用<a class="ae ka" href="http://plugins.drone.io/" rel="noopener ugc nofollow" target="_blank">插件</a>和<a class="ae ka" href="https://docs.drone.io/extensions/overview/" rel="noopener ugc nofollow" target="_blank">扩展</a>来扩展。插件为应用程序管道增加了新的功能，这些动作可以作为管道的一部分来执行。目前，无人机已经有数百个不同类型任务的插件。比如通知插件(slack，telegram，email)，部署(ECS，EKS)，发布(docker，ECR，GCR，npm，scp，rsync)监控(Datadog)等。Drone没有Jenkins等其他CI/CD平台那么多插件，但由于插件可以用任何语言编写，并封装在docker容器中，因此创建新的插件非常容易。因此，如果你错过了其他CI/CD系统中的任何功能，它可以很容易地作为一个插件添加到Drone。</p><p id="fd7c" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">另一端的扩展扩展了Drone的核心功能，例如，添加新的ACL控件、流水线处理规则、secrets后端、配置文件林挺等。</p><h1 id="58e6" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">装置</h1><p id="5bb3" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">一般来说，由于Drone作为docker容器运行，它的设置非常简单。在本实验中，我们将使用本地docker容器，用于部署在您计算机中的服务器和运行程序。但如前所述，由于无人机需要通过互联网公开访问，我们需要使用一个隧道工具，如<a class="ae ka" href="https://ngrok.com/" rel="noopener ugc nofollow" target="_blank"> ngrok </a>来使服务器可以被本地计算机上的SCM平台访问。如果您可以访问云提供商上的虚拟机，您可以跳过这一步，使用虚拟机的主机名，只需确保HTTP和HTTPS端口可以公开访问。</p><p id="15a2" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">Ngrok设置说明不在本文讨论范围之内(为了避免不必要的冗长)，但基本上你需要做的是在<a class="ae ka" href="https://ngrok.com/" rel="noopener ugc nofollow" target="_blank">ngrok.com</a>和<a class="ae ka" href="https://dashboard.ngrok.com/get-started/setup" rel="noopener ugc nofollow" target="_blank">注册，然后按照这些说明</a>进行设置。记下通道配置中的主机名，因为我们以后会用到它。</p><h2 id="7dea" class="lk if hh bd ig ll lm ln ik lo lp lq io jn lr ls is jr lt lu iw jv lv lw ja lx bi translated">先决条件:</h2><ul class=""><li id="f82d" class="kg kh hh je b jf jg jj jk jn lz jr ma jv mb jz kl km kn ko bi translated">Docker和docker-compose安装在您的计算机上。</li><li id="9171" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">指向无人机服务器的可公开访问的主机名。因为本实验是本地安装，所以我们将使用ngrok主机名。</li><li id="9f48" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">SCM平台OAuth ID和令牌。在这篇文章中，我们将使用GitHub，参考<a class="ae ka" href="https://docs.drone.io/server/overview/" rel="noopener ugc nofollow" target="_blank">官方文档</a>中关于如何设置其他SCM平台的说明。</li><li id="8c88" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">为服务器和运行程序之间的通信定义一个密码。这只是一串文本，将用作它们之间的密码。</li><li id="97d4" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">GitHub和Docker Hub帐户。</li></ul><p id="376f" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">满足所有先决条件后，启动和运行无人机需要以下步骤:</p><p id="8ed7" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated"><strong class="je hi">在SCM平台中创建OAuth认证。</strong></p><p id="6506" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">进入你的GitHub账户，导航到<a class="ae ka" href="https://github.com/settings/developers" rel="noopener ugc nofollow" target="_blank">开发者设置</a>，从左侧菜单中选择OAuth应用。单击“新建OAuth应用程序”按钮并填写字段。在这里，您需要部署无人机的主机名。回拨网址<em class="ly">必须</em>以“/登录”结尾:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es mc"><img src="../Images/3709664cbc252403c357b650e8f53828.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/0*LjHOsT6hez870y7-"/></div></figure><p id="e444" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">单击“注册应用程序”按钮。在下一个屏幕上，单击“生成新的客户端密码”按钮，然后在要求生成新的访问密码时输入您的密码:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es md"><img src="../Images/213404d17d43fc468973770bdc90e29e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hXZJN8-J2WYS1Jxt"/></div></div></figure><p id="aaf6" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">记下客户端ID和密码。</p><p id="8402" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated"><strong class="je hi">配置无人机服务器和运行器。</strong></p><p id="1671" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">服务器配置是使用环境变量完成的。为了简化设置，我们将使用<em class="ly"> docker-compose </em>。创建一个名为<em class="ly">的文本文件。env </em>为了存储配置服务器和运行程序的环境变量，请参考<a class="ae ka" href="https://docs.drone.io/server/reference/" rel="noopener ugc nofollow" target="_blank">官方文档</a>以获得对它们的更深入的解释。</p><p id="5f25" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">添加以下变量:</p><pre class="kv kw kx ky fd me mf mg mh aw mi bi"><span id="095b" class="lk if hh mf b fi mj mk l ml mm"># Server configuration<br/>DRONE_SERVER_HOST=&lt;ngrok hostname&gt;<br/>DRONE_SERVER_PROTO=http<br/>DRONE_GITHUB_CLIENT_ID=&lt;github client ID&gt;<br/>DRONE_GITHUB_CLIENT_SECRET=&lt;github secret&gt;<br/>DRONE_RPC_SECRET=&lt;Drone secret&gt;<br/>DRONE_TLS_AUTOCERT=false<br/>DRONE_USER_CREATE=username:&lt;github_username&gt;,admin:true</span><span id="c4f3" class="lk if hh mf b fi mn mk l ml mm"># Runners configuration<br/>DRONE_RPC_HOST=&lt;ngrok hostname&gt;<br/>DRONE_RPC_PROTO=http<br/>DRONE_RUNNER_NAME="Drone.io_runner" # It CANNOT contain spaces!</span></pre><p id="c1c2" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">现在我们需要为docker-compose创建配置文件来启动服务器和运行器容器。创建一个名为<em class="ly"> docker-compose.yml </em>的文件，内容如下:</p><pre class="kv kw kx ky fd me mf mg mh aw mi bi"><span id="4fb0" class="lk if hh mf b fi mj mk l ml mm">version: '3.8'</span><span id="bf45" class="lk if hh mf b fi mn mk l ml mm">services:<br/>  drone:<br/>    image: 'drone/drone:2'<br/>    volumes:<br/>      - "/var/run/docker.sock:/var/run/docker.sock"<br/>      - "./volumes/drone:/data"<br/>      - '/etc/localtime:/etc/localtime:ro'<br/>    restart: always<br/>    ports:<br/>      - 80:80<br/>    env_file:<br/>    - .env</span><span id="222e" class="lk if hh mf b fi mn mk l ml mm">  drone-agent:<br/>    image: drone/drone-runner-docker:1<br/>    command: agent<br/>    restart: always<br/>    depends_on:<br/>      - drone<br/>    volumes:<br/>      - /var/run/docker.sock:/var/run/docker.sock<br/>      - '/etc/localtime:/etc/localtime:ro'<br/>    env_file:<br/>      - .env</span></pre><p id="883b" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">我们需要为HTTP使用端口80，因为我们没有SSL证书。Drone内置了<a class="ae ka" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">让我们用Drone_TLS_AUTOCERT变量加密</a>支持，但是要使用它，我们需要拥有DRONE可用的DNS域，因为DRONE使用ACME HTTP挑战进行域验证。</p><p id="224d" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">现在你可以启动无人机了:</p><pre class="kv kw kx ky fd me mf mg mh aw mi bi"><span id="5b47" class="lk if hh mf b fi mj mk l ml mm">$ docker-compose up</span></pre><p id="46fc" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">等待容器启动几秒钟，然后在浏览器中打开ngrok主机名，如果Drone启动成功，您应该会看到如下屏幕:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/9bb88b3f43fd3630c0b0852923b0e1f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*T-dE-eY8HIQDzDog"/></div></div></figure><p id="5d93" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">点击“继续”。接下来将要求您注册，如果您不想订阅，请将字段留空，然后单击“提交”:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/4646c9b52709de7b79e9ae9888d1e99f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JoxOe6pWBY10U_xb"/></div></div></figure><p id="caaf" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">GitHub会要求你授权无人机，点击“授权”:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es mo"><img src="../Images/587caf04e418eb7f4c55ab4cf97cd66e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/0*Ei611KcQZ70C6CdD"/></div></figure><p id="c477" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">现在，您将看到无人机仪表板，其中列出了您的所有存储库:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mp"><img src="../Images/994164ff62d2e5a32043406eca974f62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-JflxA3IetNswgxO"/></div></div></figure><p id="8994" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">恭喜，你的无人机服务器已经启动并运行了！！</p><h1 id="d2ff" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">使用</h1><p id="7d92" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">设置好无人机服务器和运行器后，必须配置应用程序的管道。为此，我们需要创建一个名为<em class="ly"> .drone.yml </em>的文件，并将其放在应用程序的根文件夹中。这个文件将告诉Drone要执行的任务，比如构建、测试和部署应用程序。例如，使用适当的docker映像构建代码，将其打包(在docker容器中或作为npm包)，并将其部署到某个地方，如docker或npm注册表。</p><p id="585e" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">在本实验中，我们将使用这张<a class="ae ka" href="https://github.com/juanluisbaptiste/docker-hello-world" rel="noopener ugc nofollow" target="_blank"> hello world docker图片</a>。该应用程序的管道将构建图像并将其推送到docker hub。这是一个非常基本的例子，将有助于我们展示无人机的工作流程和基本功能。在下一篇文章中，我们将做一个更完整的例子，也在远程系统中部署应用程序。</p><p id="11cf" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">首先，请派生示例存储库。这是您将在该应用程序中找到的<em class="ly"> .drone.yml </em>文件:</p><pre class="kv kw kx ky fd me mf mg mh aw mi bi"><span id="a0ab" class="lk if hh mf b fi mj mk l ml mm">---<br/>kind: pipeline<br/>type: docker<br/>name: hello-world<br/>steps:<br/>- name: docker<br/> image: plugins/docker<br/> settings:<br/>   repo:&lt;dockerhub_username&gt;/docker-hello-world<br/>   username:<br/>     from_secret: docker_username<br/>   password:<br/>     from_secret: docker_password<br/>   tags:<br/>     - latest</span></pre><p id="74fd" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">用你的dockerhub用户替换<em class="ly">&lt;Docker Hub _ username&gt;</em>。在设置部分，我们将为docker hub的用户名和密码设置密码，稍后会详细介绍。完成这些更改后，提交并推动它们。</p><p id="dadb" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">转到您的docker hub帐户，创建一个新的存储库。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mp"><img src="../Images/9dd50f461ca05cb7fbafe1293e57a40b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yKLpSQ1vOhs7TVeG"/></div></div></figure><p id="ea80" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">给它一个名称，将其可见性设置为Public，并选择<em class="ly"> GitHub </em>作为源代码存储库，这样您就可以选择这个实验室的存储库。如果您还没有链接您的GitHub帐户，那么请先<a class="ae ka" href="https://hub.docker.com/settings/linked-accounts" rel="noopener ugc nofollow" target="_blank">这样做</a>以便能够选择实验室存储库:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mq"><img src="../Images/eef56eb0a91f591b990cfd8a61ea3844.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FqxO-Ln17nlMd73s"/></div></div></figure><p id="a70d" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">保留其他字段的默认值，然后单击“Create”创建docker hub存储库。接下来，我们需要同步无人机服务器中的GutHub存储库。因为我们添加了一个新的GitHub存储库，所以我们需要让Drone知道它。转到无人机仪表盘，点击屏幕右上方的“同步”按钮:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mp"><img src="../Images/ced48084ea35cea2695cf22e5da12139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*X3ocWqR_UgxaE6Uv"/></div></div></figure><p id="579f" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">搜索<em class="ly"> docker-hello-world </em>存储库并点击它。由于这是一个新的存储库，您将进入<em class="ly">设置</em>页面。点击“+激活存储库”按钮:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mp"><img src="../Images/2711a112a9ed589414f00dd7cfafb3d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oDADNhpstqkozisV"/></div></div></figure><p id="47f0" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">现在添加docker hub凭证作为机密。单击左侧的“秘密”菜单项，然后单击“+新秘密”按钮创建新的秘密:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mp"><img src="../Images/cbc828a3fea63532da04bc4290fa04ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nenT3q_HLYzZF3h7"/></div></div></figure><p id="0919" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">创建两个密码，“docker_username”和“docker_password ”,并为您的帐户设置相应的值:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es mr"><img src="../Images/b9c28987b2009a70280bb2fd4f6e3fdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:898/0*Vwfd6JlHrvnyv2Az"/></div></figure><p id="f540" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">现在我们已经准备好启动测试构建了！单击“Builds”选项卡，然后单击“+NEW BUILD”按钮手动启动一个构建:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mp"><img src="../Images/e9f865215ffa5481f79fc08ebd357e9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gitFMPkqrTDs2drt"/></div></div></figure><p id="2cde" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">通常，将提交推送到存储库时将启动构建(并且根据<em class="ly"> .drone.yml </em>文件中的规则)。将出现一个窗口来定制构建，保留默认设置，然后单击“Create”按钮:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es ms"><img src="../Images/a4400306935b0cd83a34d2ddca5173f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/0*a0c0iJZ0Mu0jyZIq"/></div></figure><p id="7dc6" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">管道执行现在将开始，您可以看到正在执行的步骤及其输出和执行状态:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mp"><img src="../Images/80575c8201c44a05bd3700a12a49590f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IBTbnKhA0PwYWmWu"/></div></div></figure><p id="6477" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">还有一个管道步骤的图形视图，可以帮助理解管道的工作流程:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/04c56ff91658875cbcdfb781b86731df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*T9Y5ug5k2wogNYbz"/></div></div></figure><p id="acf0" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">几分钟后，管道执行应该已经完成。看看最后一次执行的结果:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/753b54e214764177a8b739e8436d28db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c-EMRl8f8KuQc1yD"/></div></div></figure><p id="2448" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">去docker hub看看有没有新图像！</p><h1 id="bc58" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">结论</h1><p id="fe67" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">这是一个非常简单的设置，并不反映为生产使用而构建和部署的应用程序需要什么，但它可以展示无人机的基本功能、设置的简易性以及管道配置的简单性。</p><p id="0eb2" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">无人机是为云时代打造的现代CI/CD产品。它可能没有Jenkins、CircleCI或“在此插入您首选的CI/CD产品”等其他更成熟(和更老)的产品的所有功能，但作为容器原生产品，它具有云更需要的许多其他功能。</p><p id="f097" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">首先，它易于部署，作为docker的原生版本，可以在几分钟内非常容易和快速地启动和运行无人机，甚至在Kubernetes集群上，我们将在未来的文章中介绍这一点。</p><p id="18db" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">其次，Arm硬件架构的支持使其可以用于不同于云的各种其他行业，如物联网和嵌入式系统。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div class="er es mt"><img src="../Images/7481e2bcfa51c69fb8174be35a025b1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:590/format:webp/0*sFT3Zobl_AtlHfeM.png"/></div></figure><p id="c8eb" class="pw-post-body-paragraph jc jd hh je b jf kb jh ji jj kc jl jm jn kd jp jq jr ke jt ju jv kf jx jy jz ha bi translated">在<a class="ae ka" href="https://www.globant.com/studio/cloud-ops" rel="noopener ugc nofollow" target="_blank">https://www.globant.com/studio/cloud-ops</a>拜访我们</p></div></div>    
</body>
</html>