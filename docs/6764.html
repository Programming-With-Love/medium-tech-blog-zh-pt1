<html>
<head>
<title>Rack middleware vs Rack application vs Rack (the gem) vs Rack (the architecture)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">机架中间件vs机架应用vs机架(gem) vs机架(架构)</h1>
<blockquote>原文：<a href="https://medium.com/quick-code/rack-middleware-vs-rack-application-vs-rack-the-gem-vs-rack-the-architecture-912cd583ed24?source=collection_archive---------4-----------------------#2019-12-17">https://medium.com/quick-code/rack-middleware-vs-rack-application-vs-rack-the-gem-vs-rack-the-architecture-912cd583ed24?source=collection_archive---------4-----------------------#2019-12-17</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="47b8" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">Rack到底是什么？</h2></div><p id="26db" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">标题中有一大堆不同类型的机架！在我深入定义它们之前，我将简要概述一下什么是Rack。</p><p id="79bb" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">首先，你可以在这里阅读R <a class="ae js" href="https://github.com/rack/rack" rel="noopener ugc nofollow" target="_blank"> ack文档以获得官方定义。</a></p><p id="2453" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这一切都是因为我最近开始(强烈推荐)诺亚·吉布的<a class="ae js" href="https://rebuilding-rails.com/" rel="noopener ugc nofollow" target="_blank">重建Rails </a>，第一步的一部分是创建一个Rack应用程序。在这一点上，诺亚对Rack的描述非常有用。</p><blockquote class="jt ju jv"><p id="98ea" class="iw ix jw iy b iz ja ii jb jc jd il je jx jg jh ji jy jk jl jm jz jo jp jq jr ha bi translated">Rack是将您的框架连接到Ruby应用服务器(如Mongrel、Thin、Lighttpd、Passenger、WEBrick或Unicorn)的利器。应用服务器是一种特殊类型的web服务器，通常使用Ruby运行服务器应用程序。在真实的生产环境中，您将在应用服务器前面运行一个web服务器，如Apache或NGinX。</p></blockquote><p id="274e" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我是一个图表人，所以下面是用图表表示的上述定义:</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div class="er es ka"><img src="../Images/9ec50e7ada94029f7b1689aeb7a5e818.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eONEWn6WojlaN3fiBj4Rcw.jpeg"/></div><figcaption class="ki kj et er es kk kl bd b be z dx">I got this from <a class="ae js" rel="noopener" href="/ruby-on-rails-web-application-development/custom-400-500-error-pages-in-ruby-on-rails-exception-handler-3a04975e4677">this</a> medium article</figcaption></figure><p id="60d7" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">正如你所看到的，它在图中既有Sinatra又有Rails，这很好地描述了框架是如何非常容易地切换出来的(这实际上是使用Rack的一大优势)。</p></div><div class="ab cl km kn go ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ha hb hc hd he"><h2 id="7538" class="kt ku hh bd kv kw kx ky kz la lb lc ld jf le lf lg jj lh li lj jn lk ll lm ln bi translated">定义所有不同类型的机架</h2><p id="9bf1" class="pw-post-body-paragraph iw ix hh iy b iz lo ii jb jc lp il je jf lq jh ji jj lr jl jm jn ls jp jq jr ha bi translated">在作为诺亚教程的一部分构建了一个基本的Rack应用程序后，我变得很好奇，想了解更多关于Rack的知识。我的同事Sebastian最近写了一些定制的框架中间件，有人建议框架中间件是我面临的问题的原因或解决方案(我不得不耸耸肩，相信他们，因为我没有更深入的知识)。我的同事Dan甚至写了一篇文章<a class="ae js" href="https://www.simplybusiness.co.uk/about-us/tech/2019/07/rack-middleware-pattern-description/" rel="noopener ugc nofollow" target="_blank">，揭露了Rack中间件</a>的核心设计模式！感觉是时候动手了，当我动手的时候，我不断看到Rack被称为宝石、架构、中间件和应用程序。我不知道你怎么想，但我对Racks身份危机感到困惑，所以我想我应该写这篇博客来定义和对比它们。</p><p id="d8cf" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi"> Rack(宝石):</strong>正如我们在诺亚的定义中看到的，Rack是红宝石宝石。这是在<a class="ae js" href="https://rubygems.org/gems/rack/versions/1.6.4" rel="noopener ugc nofollow" target="_blank"> RubyGems </a>上。这意味着，如果您在应用程序中包含Rack gem，您将可以访问它的库。你可以在它的<a class="ae js" href="https://github.com/rack/rack/blob/master/lib/rack.rb" rel="noopener ugc nofollow" target="_blank"> lib文件夹</a>中看到你有权访问的方法。</p><p id="3f1a" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi"> Rack(架构):</strong> Rack不仅仅是一块宝石，它还是一种架构(或设计模式)。为什么？因为它定义了一个非常简单的接口，任何符合这个接口的代码都可以在一个机架应用中使用。(感谢<a class="ae js" href="https://thoughtbot.com/upcase/videos/rack" rel="noopener ugc nofollow" target="_blank">思维机器人</a>)</p><p id="6685" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi">Rack application</strong>:Rack application是响应<em class="jw"> call </em>方法的任何Ruby对象，它接受单个散列参数，并以字符串数组的形式返回包含响应状态代码、HTTP响应头和响应体的数组。(<a class="ae js" href="https://www.thoughtco.com/what-is-rack-2908122" rel="noopener ugc nofollow" target="_blank">来源</a>)。最简单的例子:</p><pre class="kb kc kd ke fd lt lu lv lw aw lx bi"><span id="d42d" class="kt ku hh lu b fi ly lz l ma mb">class MyApp<br/>  def call(env)<br/>     [ 200, {"Content-type" =&gt; "text/plain"}, ["hello world"]]<br/>  end<br/>end<br/>rack_application = MyApp.new</span></pre><p id="484c" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">实际上，那是一种谎言。从技术上讲，响应体不需要是一个字符串数组，它只需要响应<code class="du mc md me lu b">each</code>方法。</p><p id="149d" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi"> Rack中间件:</strong>记住Rack是服务器和你的ruby应用程序(比如Rails或者Sinatra)之间的一个接口(也就是在中间)。例如，如果您使用Rails，那么Rails本身不支持HTTP，这意味着所有来自互联网的HTTP请求(例如，来自浏览器的请求)在到达您的Rails应用程序之前都要经过Rack中间件的过滤。</p><p id="4435" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">中间件被安排在一个堆栈中(您可以通过运行<code class="du mc md me lu b">rails middleware</code>来<a class="ae js" href="https://guides.rubyonrails.org/rails_on_rack.html#inspecting-middleware-stack" rel="noopener ugc nofollow" target="_blank">检查中间件堆栈</a>以查看您的rails应用程序正在使用什么中间件，以及使用的顺序)。每个中间件都是一个遵循Rack规范的Ruby对象(参见上面的Rack应用程序定义)，每个中间件都将执行并调用堆栈中下一个中间件上的<code class="du mc md me lu b">call</code>方法(传递<code class="du mc md me lu b">request</code>)，然后将响应传递回调用者。这里有一个图表会有所帮助:</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mf"><img src="../Images/65947256dac2c967c48b40c4e39ffa94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l0DGWLxAnNieqeTyw5AYug.png"/></div></div><figcaption class="ki kj et er es kk kl bd b be z dx">Stolen from Dans <a class="ae js" href="https://www.simplybusiness.co.uk/about-us/tech/2019/07/rack-middleware-pattern-description/" rel="noopener ugc nofollow" target="_blank">excellent article</a></figcaption></figure><p id="2601" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果你(像我一样)好奇rails在哪里定义了它的中间件堆栈，Rails <a class="ae js" href="https://github.com/rails/rails/blob/master/railties/lib/rails/application.rb#L86" rel="noopener ugc nofollow" target="_blank">会自动加载一个默认的中间件堆栈</a>，它是在<code class="du mc md me lu b"><a class="ae js" href="https://github.com/rails/rails/blob/master/railties/lib/rails/application/default_middleware_stack.rb#L15" rel="noopener ugc nofollow" target="_blank">ActionDispatch</a></code>中定义的，来自<a class="ae js" href="https://github.com/rails/rails/tree/master/actionpack" rel="noopener ugc nofollow" target="_blank"> ActionPack </a>。</p><p id="b942" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这整个中间件部分的灵感来自于<a class="ae js" href="https://www.engineyard.com/blog/understanding-rack-apps-and-middleware" rel="noopener ugc nofollow" target="_blank">这篇出色的博文</a>中的中间件部分，如果你想阅读更多或者以稍微不同的方式听到它，那么一定要去看看。它还包括从运行rails服务器(运行<code class="du mc md me lu b">config.ru</code>文件)开始发生的事情的更多细节，参见“Rails如何使用Rack”一节。</p></div><div class="ab cl km kn go ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ha hb hc hd he"><p id="60df" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我希望这能对你有所帮助，如果你发现了什么错误，或者你认为有什么有用的地方需要补充，请告诉我！</p></div></div>    
</body>
</html>