<html>
<head>
<title>Real-time User Signal Serving for Feature Engineering</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">服务于特征工程的实时用户信号</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/real-time-user-signal-serving-for-feature-engineering-ead9a01e5b?source=collection_archive---------1-----------------------#2019-12-05">https://medium.com/pinterest-engineering/real-time-user-signal-serving-for-feature-engineering-ead9a01e5b?source=collection_archive---------1-----------------------#2019-12-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="fee1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Del Bao，Vikas Kumar:软件工程师，Ads ML Infra</p><p id="d347" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">每月有超过3.2亿的独立访问者来到Pinterest，发现鼓舞人心的内容，这也给了广告商一个独特的机会，让他们的产品出现在具有商业意图的人们面前。</p><p id="80ed" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这种个性化目录的管理需要准确和实时地反映用户的短期兴趣。映射长期兴趣对于显示相关内容同样重要，因为短期兴趣可能会有干扰。</p><p id="e9ac" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">用户功能的一些典型使用场景:</p><ul class=""><li id="26b2" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">基于最近和过去参与的Pin嵌入(我们将每个Pin映射到一个N维向量空间，称为<a class="ae jl" rel="noopener" href="/pinterest-engineering/pinsage-a-new-graph-convolutional-neural-network-for-web-scale-recommender-systems-88795a107f48"> PinSage嵌入</a>)和各种会话窗口，使用用户嵌入信号检索广告。</li><li id="f027" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">提高广告与来自搜索查询的用户兴趣的相关性。通过使用<a class="ae jl" href="https://github.com/facebookresearch/fastText" rel="noopener ugc nofollow" target="_blank"> FastText </a>算法在短/长时间段内从搜索查询中收集用户的几个重要兴趣类别，并将其应用于在其他表面(例如，home feed)上的排名，来产生信号。</li></ul><p id="26d8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了帮助机器学习工程师捕捉用户倾向，我们开发了一种实时用户信号服务，作为消费用户参与数据以及计算和服务用户特征的平台。有了这个新平台，开发人员只需花费最少的精力，就可以利用ML算法构建、测试和试验新的用户信号，并为我们的服务系统提供个性化的现场和应用内用户信号。</p><p id="80e9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">自发布以来，该平台在整个公司广受欢迎，并为创作者参与、广告检索、检索中的购物和搜索排名提供了多个用例。该系统以最低的基础设施成本，在Pinterest规模上可靠地实时产生和提供用户信号。</p><p id="d832" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这里，我们将分享更多关于我们如何设计系统来实现这些目标。</p><h1 id="5988" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">在我们建造的幕后</h1><h1 id="70a5" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">用户信号平台的支柱</h1><p id="8abc" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">用户信号平台的五大支柱是:</p><ol class=""><li id="d0ef" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb ku ji jj jk bi translated"><strong class="ig hi">时效性。事件反馈回路的实时性对于展示新鲜内容至关重要。以黑色星期五为例——想象一个品酒人买了一条牛仔裤，然后收到打折广告购买同一条牛仔裤的错误经历。</strong></li><li id="c6c3" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb ku ji jj jk bi translated"><strong class="ig hi">灵活的用户环境。</strong>用户环境描述了可用于表征用户情况的任何相关信息。Pinterest内容是根据用户背景量身定制的。定制过程可以由两种类型的信息提供信息:显示意图的短期洞察力，以及包括人口统计、行为和长期偏好的长期洞察力。这就要求具有开发者API的平台具有丰富的会话语义。</li><li id="a424" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb ku ji jj jk bi translated"><strong class="ig hi">伸缩性。</strong> Pinterest每秒从用户那里获得120万个事件。大规模的个性化是一个挑战，所以我们的系统需要把每一个Pinneras当作一个个体，而不是观众的一部分。这意味着计算资源是在用户级别上分配的，而不是在目标用户组上。</li><li id="cf93" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb ku ji jj jk bi translated"><strong class="ig hi">开发者速度。</strong> Pinterest是一家数据驱动的公司，我们依靠实验和A/B测试来做出关键决策。机器学习实践者依靠正确的抽象在平台上实现和验证他们的算法。</li><li id="07c3" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb ku ji jj jk bi translated"><strong class="ig hi">建造简单。</strong>为了产生最终信号，系统有许多数据获取路径。这通常涉及异步代码和复杂的未来/承诺处理。我们希望选择正确的框架来构建核心基础逻辑，以使代码简单易读。</li></ol><p id="2dee" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了提高服务性能和加快开发速度，需要考虑几个设计因素。</p><h1 id="30de" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">通用物化器</h1><p id="663d" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">物化器负责将外部数据与用户事件连接起来。我们致力于设计一个通用的物化容器来减轻开发人员的编码工作。另一个目标是降低数据获取成本，以便我们可以实现最小的事件处理延迟。这是在Pinterest规模上实现事件处理及时性的必要条件。</p><p id="c657" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们应用<a class="ae jl" href="https://en.wikipedia.org/wiki/Separation_of_concerns" rel="noopener ugc nofollow" target="_blank">关注点分离原则</a>:将请求规范和获取执行分成两层。功能请求表示为数据源、请求关键字和功能关键字。数据管道由执行引擎驱动。添加一个新特性可以归结为通过实体化API简单地指定请求规范，这只需要几行代码。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es kv"><img src="../Images/199a915bce8e6bc90877d3b806599f14.png" data-original-src="https://miro.medium.com/v2/resize:fit:60/0*fbSja2_t1zHmNPJP"/></div></figure><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es ld"><img src="../Images/57208e2167de885dee5356987cbbc48d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/0*VWRVHWqgSbxs6z0l.png"/></div><figcaption class="le lf et er es lg lh bd b be z dx"><strong class="bd jt">Materializer container separation of concerns</strong></figcaption></figure><h2 id="1dc4" class="li js hh bd jt lj lk ll jx lm ln lo kb ip lp lq kf it lr ls kj ix lt lu kn lv bi translated">有状态聚合</h2><p id="76af" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">聚合是从用户事件会话中计算统计数据。每个信号具有50k QPS，系统不能完全重新计算用户的所有事件，特别是在长期用户环境中，例如90天。因此，聚合器采用<a class="ae jl" href="https://en.wikipedia.org/wiki/Incremental_computing" rel="noopener ugc nofollow" target="_blank">增量计算模型</a>，在远程状态存储中具有中间状态。</p><p id="5e61" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">与在请求时间重新计算每个事件相比，该模型有两个好处:</p><ul class=""><li id="99a5" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><strong class="ig hi">事件存储</strong>对存储的事件有资源限制(通常是七天)。通过增量计算，用户的历史事件被保存在聚合状态中。该平台能够提供能够捕捉长期用户倾向的信号。</li><li id="9a89" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated"><strong class="ig hi">延迟</strong>大幅改善，因为之前的计算被保留在状态中。</li></ul><p id="ea6a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下图说明了计算范例。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es lw"><img src="../Images/838aff94c4b598c78d76f13f02d8b0a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*S1mS2IyPMzuqPpAh.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx"><strong class="bd jt">State 1 contains the aggregation results of the past X events. The next request comes, aggregator fetches the state 1 and Y later arrived events, and compute a state 2</strong></figcaption></figure><h2 id="b062" class="li js hh bd jt lj lk ll jx lm ln lo kb ip lp lq kf it lr ls kj ix lt lu kn lv bi translated">视图/聚合分离</h2><p id="479a" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">视图是面向客户端的层，负责状态的轻量级转换。我们将视图和聚合器分开，以满足两个需求:<strong class="ig hi">灵活的用户环境</strong>和<strong class="ig hi">可伸缩性</strong>。</p><p id="f88e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">关注点分离原则再次敲我们的门:状态代表计算的重担。View将状态转换成一个紧凑的特性，具有适合于客户端、ML和服务系统的定制会话定义。此外，通过在多个视图之间共享状态，我们可以进一步节省重复的计算并扩展系统。</p><h2 id="fb18" class="li js hh bd jt lj lk ll jx lm ln lo kb ip lp lq kf it lr ls kj ix lt lu kn lv bi translated">Dagger和API抽象</h2><p id="8e7c" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">核心基础设施的开发也需要简单:我们构建的框架的核心逻辑严重依赖于数据依赖:物化的外部数据源、事件序列和远程聚合器状态等。这类框架的规范编程模型是基于<a class="ae jl" href="https://en.wikipedia.org/wiki/Dependency_inversion_principle" rel="noopener ugc nofollow" target="_blank">dependency _ inversion _ principle</a>的设计原则。<a class="ae jl" href="https://en.wikipedia.org/wiki/Dependency_injection" rel="noopener ugc nofollow" target="_blank">依赖注入</a>是将依赖(服务或数据)传递给使用它的对象的概念。我们采用<a class="ae jl" href="https://github.com/google/dagger" rel="noopener ugc nofollow" target="_blank"> Dagger2 </a>，一个轻量级异步DI框架，由Google和Square开源以满足这一需求。</p><p id="b272" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">另一方面，Dagger2的学习曲线相对较高，因此作为一个开发人员平台，我们让我们的开发人员API与Dagger无关。具体来说，</p><h2 id="e687" class="li js hh bd jt lj lk ll jx lm ln lo kb ip lp lq kf it lr ls kj ix lt lu kn lv bi translated">聚合器和视图API</h2><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es mb"><img src="../Images/ff76115873d151bd24ed4daa51bf3e90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/0*q3I0xS1r6ncDXTB5.png"/></div><figcaption class="le lf et er es lg lh bd b be z dx"><strong class="bd jt">Aggregator API (updateState) defines a generic stateful computation</strong></figcaption></figure><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es mc"><img src="../Images/347a9eb0e4ff72401b03e98a19a7b844.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*eHscMwinaAYV-ycxiDFoPA.png"/></div><figcaption class="le lf et er es lg lh bd b be z dx"><strong class="bd jt">View API defines state dependencies and state derivation</strong></figcaption></figure><h1 id="c409" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">融合在一起:建筑</h1><h2 id="c0cf" class="li js hh bd jt lj lk ll jx lm ln lo kb ip lp lq kf it lr ls kj ix lt lu kn lv bi translated">事件到用户信号的旅程</h2><p id="3ba5" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">在这里，我们展示了用户事件如何不断地流经信号生产管道，并通过管道传输到Pinterest ML &amp; serving系统。</p><p id="6e17" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这始于用户与Pinterest网站的互动，如点击一个大头针或创建搜索查询，然后返回到后端，并在用户许可的情况下被跟踪。原始约定事件是轻量级的，使得跟踪对于基础设施是可行的。下一步是用丰富的内容信息丰富它们(例如，大头针有各种类别来表示其感兴趣的主题)。利用丰富的事件，管道可以进一步将事件的时间序列压缩成用户的即时、短期和/或长期倾向的紧凑表示。这种转变是通过各种聚合和尖端的ML算法实现的。</p><p id="d02a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是一张显示所有组件如何组合在一起的图表。我们采用双组件架构:异步(离线)事件驱动处理和在线处理。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es md"><img src="../Images/b3474b26a14469b535fbbdaf450657e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/format:webp/0*RuuqJjw1THPmy6kl.png"/></div><figcaption class="le lf et er es lg lh bd b be z dx"><strong class="bd jt">Signal production and serving data flow</strong></figcaption></figure><h2 id="1946" class="li js hh bd jt lj lk ll jx lm ln lo kb ip lp lq kf it lr ls kj ix lt lu kn lv bi translated">异步事件驱动处理</h2><p id="472d" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">信号处理之旅的第一步是读取原始事件，并将其与基于内容的外部特征相融合。这包括三个部分:</p><ul class=""><li id="5f56" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><strong class="ig hi"> Kafka </strong>:从Kafka消费的日志消息包含精简的信息，例如userid、pinid和动作类型。</li><li id="97e9" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated"><strong class="ig hi">:物化:</strong>是一个从外部数据源获取用户事件并用内容特性(pin特性、查询特性等)丰富它的过程。</li><li id="588f" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated"><strong class="ig hi">物化事件存储:</strong>物化用户事件被写入时序数据存储。它充当离线处理和在线查询之间的中介。</li></ul><h1 id="7061" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">服务时间处理</h1><p id="4ceb" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">聚合在请求时在线发生</p><ul class=""><li id="679c" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><strong class="ig hi">聚合:</strong>聚合可以选择性地从事件存储中获取预先计算的状态和用户事件的增量集，以计算用户特征。在这个阶段，我们设计了一组API，并创建了一个层来将ML算法空间与计算引擎分离。</li></ul><h1 id="77bb" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">结果</h1><h2 id="7704" class="li js hh bd jt lj lk ll jx lm ln lo kb ip lp lq kf it lr ls kj ix lt lu kn lv bi translated">接近实时</h2><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es me"><img src="../Images/55024aaf0132d95dea4301edc7613175.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YSo9_0DVvr4lBgIZ"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx">p99 of end-to-end latency is about 10 seconds between user engagement on Pinterest and when that event was ready for serving, with a total volume of 1.2 million per second.</figcaption></figure><h2 id="555f" class="li js hh bd jt lj lk ll jx lm ln lo kb ip lp lq kf it lr ls kj ix lt lu kn lv bi translated">面向可扩展性的服务器性能</h2><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es mf"><img src="../Images/a63866f4d9e0f55a4cb9301197612922.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*Sl8rDhb3SztpL0y18IDSpA.png"/></div><figcaption class="le lf et er es lg lh bd b be z dx">With the stateful aggregation, we were able to reduce p99 of server latency to under 35ms compared to no state of 100ms.</figcaption></figure><h2 id="0465" class="li js hh bd jt lj lk ll jx lm ln lo kb ip lp lq kf it lr ls kj ix lt lu kn lv bi translated">开发速度快且易于构建</h2><p id="450f" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">由于采用了Dagger2框架，我们在一个月内就引入了核心基础设施。三名工程师花了大约两周时间开发了五个信号，以加速我们一些最重要的广告检索和排名计划。</p><h1 id="934e" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">下一步是什么</h1><p id="f52a" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">接下来，我们将开发一个新的数据处理架构，将聚合转移到事件时间，并将整个Pinterest的用户信号统一到这个实时基础设施。</p><p id="0ba4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="mg">鸣谢:</em> </strong> <em class="mg">非常感谢谢泗阳为设计提供咨询，、、赵、徐、Nishant Roy和整个Ads ML Infra团队，以及George Yiu、Se Won Jang、赖清贤、Connell、、Han、Jessica Chan、Saurabh Joshi和王思涵，他们帮助改善和扩展了基础设施。</em></p><p id="2f4c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="mg">我们还要特别感谢内容个性化团队的Arun Prasad、和，以及Ads检索团队的John Zheng、Pihui Wei、Ge、Peifeng Yin、和Xiaofang Chen，感谢他们与我们合作开发了首批用户信号并加载到平台上。</em></p><blockquote class="mh"><p id="a1b8" class="mi mj hh bd mk ml mm mn mo mp mq jb dx translated"><em class="mr">我们正在建造世界上第一个视觉发现引擎。全球超过3.2亿人使用Pinterest来梦想、计划和准备他们在生活中想做的事情。</em> <a class="ae jl" href="https://careers.pinterest.com/careers" rel="noopener ugc nofollow" target="_blank"> <em class="mr">来加入我们吧！</em> </a></p></blockquote></div></div>    
</body>
</html>