<html>
<head>
<title>Scaling Airbnb’s Experimentation Platform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">扩展Airbnb的实验平台</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/https-medium-com-jonathan-parks-scaling-erf-23fd17c91166?source=collection_archive---------5-----------------------#2017-05-10">https://medium.com/airbnb-engineering/https-medium-com-jonathan-parks-scaling-erf-23fd17c91166?source=collection_archive---------5-----------------------#2017-05-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/a65062ec3d7625c15219bee52964d2ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JcmsZSlAOhoimpM55d2RHw.png"/></div></div></figure><p id="c901" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在Airbnb，我们在用户体验和产品功能上不断迭代。这可能包括改变网站或原生应用的外观和感觉，优化我们的智能定价和搜索排名算法，甚至为我们的电子邮件活动确定正确的内容和时间。对于这项工作的大部分，我们利用我们的内部A/B测试平台——实验报告框架(ERF ),来验证我们的假设并量化我们工作的影响。阅读关于ERF 的<a class="ae jn" rel="noopener" href="/airbnb-engineering/experiment-reporting-framework-4e3fcd29e6c0">基础知识和我们关于口译实验的</a><a class="ae jn" rel="noopener" href="/airbnb-engineering/4-principles-for-making-experimentation-count-7a5f1a5268a">哲学</a>。<br/><br/>ERF于2014年推出，最初是一种工具，它允许用户用一种通用的配置语言定义指标，然后计算并展示这些指标，用于一小组实验。从那以后，在ERF中运行的并发实验的数量从几十个(2014年)增长到大约500个并发实验(在本文发表时)。更令人印象深刻的是，每天计算的指标数量呈指数级增长，从几十个开始(2014年)。今天，我们每天计算大约2500个不同的指标，以及大约50000个不同的实验/指标组合。我们还引入了几个高级功能(例如维度削减、全球覆盖、预分配偏差检查)，这些功能增加了我们的扩展挑战。这篇文章探索了我们在Airbnb解决这些问题的建筑方法，以及我们在这个过程中必须考虑的权衡。</p><figure class="jp jq jr js fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es jo"><img src="../Images/0c783468b0f1c57b2673bc7ee0da8a28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3gN23hMZaTvZ8FX0ROQIJA.png"/></div></div></figure><h1 id="fde2" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">初始设计</h1><p id="8a9b" class="pw-post-body-paragraph ip iq hh ir b is kr iu iv iw ks iy iz ja kt jc jd je ku jg jh ji kv jk jl jm ha bi translated">ERF结果最初是通过每天执行的Ruby脚本计算的。这个脚本是一个简单的查询生成器，它为每个实验组装并运行一个巨大的、单一的Hive查询。这种方法有几个问题:</p><ol class=""><li id="3d5c" class="kw kx hh ir b is it iw ix ja ky je kz ji la jm lb lc ld le bi translated">查询会多次扫描源表，导致效率低下。</li><li id="8243" class="kw kx hh ir b is lf iw lg ja lh je li ji lj jm lb lc ld le bi translated">查询的整体性质不支持“检查点”；因此，当遇到故障时，必须重新处理所有工作。这就形成了一个反馈回路。由于查询需要更多的时间来完成，这增加了失败的可能性。这反过来导致更多的集群拥塞，并最终导致查询运行时间更长。</li><li id="4663" class="kw kx hh ir b is lf iw lg ja lh je li ji lj jm lb lc ld le bi translated">依赖性检查要求所有度量表在实验可以被处理之前着陆。</li></ol><p id="420f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">随着采用的增加，最初的ERF管道无法扩展，导致Hadoop集群陷入困境，最终用户不满意。</p><h1 id="a126" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">迁移到气流</h1><p id="9108" class="pw-post-body-paragraph ip iq hh ir b is kr iu iv iw ks iy iz ja kt jc jd je ku jg jh ji kv jk jl jm ha bi translated">为了解决这些问题，用Python重新编写了ERF，以在<a class="ae jn" href="https://airflow.incubator.apache.org/" rel="noopener ugc nofollow" target="_blank"> Airflow </a>中运行，这是一个在Airbnb开发并开源的工作负载编排器，利用了“配置即代码”的原则。这使得电流变流体管道能够被构造成由更小的工作单元组成的动态生成气流管道(也称为Dag)。今天，我们利用5个气流管道来计算电流变流体分配、来源、指标和维度，每个都由数千个任务组成。</p><h1 id="a0f3" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">通过公制计算</h1><p id="9b8f" class="pw-post-body-paragraph ip iq hh ir b is kr iu iv iw ks iy iz ja kt jc jd je ku jg jh ji kv jk jl jm ha bi translated">在过渡到气流的过程中，我们不再一次计算一个实验的所有指标，而是将处理单元转移到“事件源”(即定义几个指标的查询)。这种方法的主要优点是只扫描源表一次，从而节省了大量计算资源。这也解决了“依赖性问题”,在这种情况下，一个不完整的指标有时会阻碍特定实验的所有指标。今天，大多数实验的指标都是独立计算的。在迁移到Airflow并重新架构我们的数据管道后，ERF的运行时间从24小时以上减少到了大约45分钟。<br/> <br/>以下是“游客行程”的事件源定义示例。该文件定义了两个用于计算指标的事件，并在这些事件的基础上创建了两个额外的聚合。</p><figure class="jp jq jr js fd ii er es paragraph-image"><div class="er es lk"><img src="../Images/431190c54275b166c2e03cd660aae07c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1220/format:webp/1*uQO0xGdXyqNYkJ8DhQXnxA.png"/></div></figure><p id="afc8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在某一天，ERF独立处理大约350个这样的“事件源”。这比针对每个指标(2.5k)或每个指标/实验组合(50k)执行查询更具可伸缩性。下图显示了计算单个事件源所需任务的气流图。每个气流管道包含大约350个并行执行的数据流。</p><figure class="jp jq jr js fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ll"><img src="../Images/ddac6ad54096d40e8e690021f3314895.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hGuOHylUg8Rrbn7lZyTyQA.png"/></div></div></figure><h1 id="ff74" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak">公制等级</strong></h1><p id="52bc" class="pw-post-body-paragraph ip iq hh ir b is kr iu iv iw ks iy iz ja kt jc jd je ku jg jh ji kv jk jl jm ha bi translated">随着ERF稳定性的提高和更加灵活/直观的配置语法，它的应用很快开始蓬勃发展。这导致了更多的实验和新度量标准的大量涌入。随着一些实验采用100或更多的度量，事情很快失去控制。高级用户不知道哪些指标是重要的，UI过度拥挤使得很难快速找到顶级指标。这也使得很难确保关键业务指标的SLA。为了解决这些问题，我们引入了一个度量层次结构。</p><ul class=""><li id="7246" class="kw kx hh ir b is it iw ix ja ky je kz ji la jm lm lc ld le bi translated"><em class="ln">核心指标:</em>每个实验都需要采用核心指标，这是一个预先定义的关键业务指标列表。这确保了所有实验负责人都知道他们的影响(即使没有预期)。</li><li id="c20d" class="kw kx hh ir b is lf iw lg ja lh je li ji lj jm lm lc ld le bi translated"><em class="ln">目标指标:</em>每个实验可以指定一个目标指标列表。它们被固定在UI的顶部，以提高关键指标的可见性。</li><li id="52e2" class="kw kx hh ir b is lf iw lg ja lh je li ji lj jm lm lc ld le bi translated"><em class="ln">认证指标:</em>数据工程团队认证了大约50%的ERF指标。这些指标有SLA保证，对其定义的更改受到严格审核。所有<em class="ln">核心指标</em>都保证是<em class="ln">认证指标</em>。</li></ul><h1 id="c263" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">尺寸切割</h1><p id="b985" class="pw-post-body-paragraph ip iq hh ir b is kr iu iv iw ks iy iz ja kt jc jd je ku jg jh ji kv jk jl jm ha bi translated">尺寸切割是电流变流体中最有用的特性之一。这允许用户根据用户属性(例如地理、语言、平台)和活动本身的属性(例如“即时预订”与非“即时预订”)来划分指标。这两种类型的属性之间有重要的区别，这将在下面讨论。<br/> <br/> <strong class="ir hi">主题级维度</strong></p><p id="c3fb" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">受试者水平的属性使我们能够观察实验人群群组/部分的反应。如前所述，这些维度是在主题级别定义的，对应于实验中每个来宾或主人的一些属性。例如，我们可以专门查看来自特定地区(如欧洲、法国、巴黎)的客人的治疗表现。<br/> <br/> <strong class="ir hi">事件级维度</strong> <br/> <br/>随着ERF的采用开始增加，我们注意到一种模式，用户正在创建度量的变体，将维度细节嵌入定义本身。例如，用户创建了3个独立的预订指标来独立衡量Android、iOS和Web上的预订情况。这是对现有预订指标的补充。这种方法被证明是不可扩展的，并且导致了UI的过度拥挤。为了解决这个问题，我们引入了事件级维度。<br/> <br/>事件级属性是事件的原子属性，允许我们将指标细分为其组成部分(例如，我们可以通过用于预订的设备或目的地的地理位置来探索预订)。事件级维度的一个关键区别是，度量是针对整个实验群体计算的。主题级维度按维度划分事件和作业，而实验的所有事件级片段使用相同的总体规模。例如，通过是否可即时预订来考虑预订的事件级维度缩减。在这种情况下，预订和即时预订本质上被认为是针对同一人群计算的不同指标。<br/> <br/> <strong class="ir hi">预计算和UI </strong> <br/> <br/> ERF目前预计算每个指标的大约50个维度，并在ERF UI中即时提供这些信息(见下面的gif)。这是ERF中最耗费资源的计算，因为数据通常是按维度分解的，并使用分组集进行聚合。生成的大量统计数据也需要特别注意，因为这些数据必须加载到服务于UI的MySQL数据库中，并针对查询性能进行优化。</p><figure class="jp jq jr js fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lo"><img src="../Images/06f1ce31bd6cbe6d2042542fb87e3e64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*zH7l-Oeb3SMq_U4xGWprUg.gif"/></div></div></figure><p id="d109" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">通过ERF Explorer进行交互式分析</strong></p><figure class="jp jq jr js fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lp"><img src="../Images/3f56c9727efcc1a5cca274d66bd9c917.png" data-original-src="https://miro.medium.com/v2/resize:fit:568/format:webp/1*qba7wT9VMoy3ZgokWFK5UQ.png"/></div></div></figure><p id="97a9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">预计算维度削减的引入取得了巨大的成功，但让用户希望更深入地研究度量。为了满足这一需求，我们推出了ERF Explorer，这是一个支持维度下钻和过滤的专用UI。ERF Explorer利用中间数据集(由主要ERF管道留下)通过Presto动态计算统计数据。该工具支持多级深入/过滤和其他高级分析，如量化实验交互。这使得用户能够回答几乎任何关于他们实验的问题，而无需编写一个数据库查询。</p><h1 id="2751" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">管道逻辑和实体</h1><p id="c071" class="pw-post-body-paragraph ip iq hh ir b is kr iu iv iw ks iy iz ja kt jc jd je ku jg jh ji kv jk jl jm ha bi translated">下图描述了计算电流变流体指标和尺寸切割所需的实体。菱形图表示加入上下文信息(例如分配、维度)并将数据聚合到所需粒度的ETL作业。在这种情况下，目标是计算每个实验处理的一阶和二阶矩。这又用于计算增量和p值统计数据。<br/> <br/>这种流水线架构的主要目标是组织数据，使计算需求最小化，防止重复处理。例如，我们从experiment_events表中计算事件级维度(参见步骤5)，但是选择从subject_summary表中计算主题级维度。这极大地提高了效率，因为数据已经在连接键(即subject_id，experiment)上聚合了。</p><figure class="jp jq jr js fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lq"><img src="../Images/56f51156395934af651f24be7eb79a2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LCorSPR99m3aL4V6cgnzeg.png"/></div></div></figure><figure class="jp jq jr js fd ii er es paragraph-image"><div class="er es lr"><img src="../Images/28b01381152129a45e2b8afd0b13de67.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*1MDdFIclmlYMyfyBFiz2OA.png"/></div></figure><h1 id="8387" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">未来的工作</h1><p id="d09f" class="pw-post-body-paragraph ip iq hh ir b is kr iu iv iw ks iy iz ja kt jc jd je ku jg jh ji kv jk jl jm ha bi translated">过去几年，我们在Airbnb的实验中取得了巨大的进步。对于工程组织来说，这是一个重要的杠杆，使团队能够准确地评估新特性的质量，并以更高的频率迭代。尽管有这些收获，Airbnb在这一领域仍有许多正在进行的工作。一个主要项目是利用ERF中的度量定义来驱动公司范围的仪表板，支持切片和切片功能(由Druid提供支持)。我们还有一个正在进行的项目，以建立对实时指标和定制工具的支持，用于分析站点性能数据。</p><p id="5ad5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">特别感谢Maxime Beauchemin、Adrian Kuhn、Jeff Feng和Gurer Kiratli。</p><p id="6e13" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="ln">在</em><a class="ae jn" href="http://airbnb.io/" rel="noopener ugc nofollow" target="_blank"><em class="ln">Airbnb . io</em></a><em class="ln">查看我们所有的开源项目，并在Twitter上关注我们:@AirbnbEng + @AirbnbData </em></p></div></div>    
</body>
</html>