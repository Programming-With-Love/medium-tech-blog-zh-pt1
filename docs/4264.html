<html>
<head>
<title>Overcoming the pitfalls of Google App Engine Cron</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">克服谷歌应用引擎Cron的缺陷</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/pitfalls-of-using-cron-jobs-with-google-app-engine-bf005f8bf7e6?source=collection_archive---------0-----------------------#2019-10-22">https://medium.com/google-developer-experts/pitfalls-of-using-cron-jobs-with-google-app-engine-bf005f8bf7e6?source=collection_archive---------0-----------------------#2019-10-22</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/af87c659bace17eef9e34b5cfd7fb0f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*afZUCqsL-nk4Nshxdbps4w.png"/></div></div></figure><p id="3487" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在https://roobits.com<a class="ae jn" href="https://roobits.com" rel="noopener ugc nofollow" target="_blank">的数据管道中大量使用了GCP之后，我们一直在寻找一种有效的方式来调度特定的任务定期运行</a></p><p id="8939" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">例如，在之前的博客中，您可能还记得我们允许企业以每秒的速度从他们的网站/应用程序中收集事件，并将它们存储到BigQuery中，以便以后进行检索/分析。</p><div class="jo jp ez fb jq jr"><a rel="noopener follow" target="_blank" href="/google-developer-experts/trimming-down-over-95-of-your-bigquery-costs-using-file-loads-d08dd3d8b2fd"><div class="js ab dw"><div class="jt ab ju cl cj jv"><h2 class="bd hi fi z dy jw ea eb jx ed ef hg bi translated">使用文件加载降低95%以上的大查询成本</h2><div class="jy l"><h3 class="bd b fi z dy jw ea eb jx ed ef dx translated">TL；dr:使用文件加载</h3></div><div class="jz l"><p class="bd b fp z dy jw ea eb jx ed ef dx translated">medium.com</p></div></div><div class="ka l"><div class="kb l kc kd ke ka kf in jr"/></div></div></a></div><p id="b613" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">虽然我们的主要目标是实时完成这项工作，但我们的一些客户要求以更低的成本进行批量选择。</p><p id="db98" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了实现这一点，我们可以将传入的请求保存到App Engine实例中的一个文本文件中，并运行一个cron作业将该文件加载到BigQuery中(<strong class="ir hi">记住，将文件加载到BigQuery中是免费的！每隔几分钟。</strong></p><p id="7f57" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">令人欣慰的是，App Engine有一个内置的cron服务，允许您编写一个简单的<code class="du kg kh ki kj b"><strong class="ir hi">cron.yaml</strong></code>，其中包含您希望作业运行的时间以及它应该到达的端点，就是这样！</p><p id="c7c7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">App Engine将确保cron在您指定的时间执行。</p><p id="123f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这里有一个示例<code class="du kg kh ki kj b"><strong class="ir hi">cron.yaml</strong></code>，它每2分钟到达我们AppEngine部署中的<code class="du kg kh ki kj b"><strong class="ir hi">/upload</strong></code>端点。</p><pre class="kk kl km kn fd ko kj kp kq aw kr bi"><span id="5b4c" class="ks kt hh kj b fi ku kv l kw kx"><strong class="kj hi">cron:<br/>description: "Bigquery Load Job"<br/>url: /upload<br/>schedule: every 2 mins</strong></span></pre></div><div class="ab cl ky kz go la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ha hb hc hd he"><h1 id="89c2" class="lf kt hh bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">然而…</h1><p id="a351" class="pw-post-body-paragraph ip iq hh ir b is mc iu iv iw md iy iz ja me jc jd je mf jg jh ji mg jk jl jm ha bi translated">虽然理论上听起来不错，但App Engine提供的解决方案在我们的用例中却失败了。<br/>为什么，你可能会问！</p><p id="5e6e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">原因很简单，cron作业将只在您的应用引擎部署的一个<strong class="ir hi">实例</strong>上运行！</p><p id="0194" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这对我们来说是一个交易破坏者，因为我们有超过12个应用引擎实例在运行，每个实例都有一个包含过去2分钟用户数据的文本文件。</p><p id="11b7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">由于cron作业只针对一个实例，<strong class="ir hi">那么我们基本上错过了总数据的90%以上</strong>，这是完全不可接受的！</p><p id="fe42" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">不仅如此，使用cron job，您还<strong class="ir hi">无法将您部署的服务的特定版本作为目标</strong>,这使得我们无法进行A/B测试。</p><p id="c8fd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Cron job还受限于这样一个事实，即它只能在您在<code class="du kg kh ki kj b"><strong class="ir hi">cron.yaml</strong></code>中指定的端点发出<code class="du kg kh ki kj b"><strong class="ir hi">/get</strong></code>请求，从而使您的服务器容易受到爬虫和其他攻击者的攻击。</p><blockquote class="mh mi mj"><p id="c3b8" class="ip iq mk ir b is it iu iv iw ix iy iz ml jb jc jd mm jf jg jh mn jj jk jl jm ha bi translated"><strong class="ir hi"> <em class="hh">编辑:</em> </strong> <em class="hh">您可以通过设置AppEngine中的</em> <code class="du kg kh ki kj b"><em class="hh">X-Appengine-Cron</em></code> <em class="hh">头来验证您的cron请求。请访问此页面了解更多信息:</em></p></blockquote><div class="jo jp ez fb jq jr"><a href="https://cloud.google.com/appengine/docs/flexible/nodejs/scheduling-jobs-with-cron-yaml#validating_cron_requests" rel="noopener  ugc nofollow" target="_blank"><div class="js ab dw"><div class="jt ab ju cl cj jv"><h2 class="bd hi fi z dy jw ea eb jx ed ef hg bi translated">使用cron.yaml调度作业</h2><div class="jy l"><h3 class="bd b fi z dy jw ea eb jx ed ef dx translated">App Engine Cron服务允许您配置在定义的时间或定期运行的定期计划任务…</h3></div><div class="jz l"><p class="bd b fp z dy jw ea eb jx ed ef dx translated">cloud.google.com</p></div></div><div class="ka l"><div class="mo l kc kd ke ka kf in jr"/></div></div></a></div></div><div class="ab cl ky kz go la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ha hb hc hd he"><h1 id="b51d" class="lf kt hh bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">可供选择的事物</h1><p id="ec6c" class="pw-post-body-paragraph ip iq hh ir b is mc iu iv iw md iy iz ja me jc jd je mf jg jh ji mg jk jl jm ha bi translated">由于使用cron作业是不可能的，我们开始寻找替代方案，第一个是<strong class="ir hi">云调度器</strong>。</p><p id="4e7d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">而Cloud Scheduler拥有我们想要的一切，包括针对特定版本、实例、服务的选项，还向处理cron功能背后的逻辑运行的端点发送POST请求。</p><p id="1ddc" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">虽然AppEngine提供的cron是免费的，但是<strong class="ir hi"> Cloud Scheduler每月每个任务收取0.1美元</strong>。</p><p id="6112" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">假设我们必须每2分钟运行一个作业，如果我们使用云调度程序，我们必须承担的总成本是<strong class="ir hi"> 0.1$ </strong>。</p><p id="ecd3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">同样需要注意的是，使用Cloud Scheduler创建的前3个任务是免费的，所以如果你有一个应该每月运行多次的脚本，你不需要支付任何费用！</p><p id="3d42" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="mk">感谢</em><a class="mp mq ge" href="https://medium.com/u/1047e5240ceb?source=post_page-----bf005f8bf7e6--------------------------------" rel="noopener" target="_blank"><em class="mk">vine et garg</em></a><em class="mk">指出云调度器是按作业定价的，而不是按执行定价的！</em></p></div><div class="ab cl ky kz go la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ha hb hc hd he"><p id="fb37" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们偶然发现的第二个解决方案是使用我们自己的定制cron，它运行在我们的服务器上。</p><p id="96bd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">虽然它需要我们编写一个基本的脚本来跟踪已经过去的时间，但它是免费的，没有App Engine的cron所具有的任何限制。</p><p id="b634" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们最终在部署在App Engine上的服务器中编写了以下代码片段。</p><pre class="kk kl km kn fd ko kj kp kq aw kr bi"><span id="4b14" class="ks kt hh kj b fi ku kv l kw kx"><strong class="kj hi">let job = new CronJob('2 * * * * *', function() {<br/>    uploadFile(function(err){<br/>        if(err) console.log(err);<br/>        else return "Valid Cron";<br/>    });<br/>});</strong></span><span id="8716" class="ks kt hh kj b fi mr kv l kw kx"><strong class="kj hi">job.start();</strong></span></pre><p id="ac26" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们创建的作业每两分钟运行一次，并调用方法<code class="du kg kh ki kj b"><strong class="ir hi">uploadFile</strong></code> <strong class="ir hi"> </strong>将文件加载到BigQuery中。</p><p id="1c4e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这也可以在每个实例上运行，因为它不会影响公开的API，所以它消除了我们之前遇到的关于解决方案的实用性和安全性的所有问题。</p></div><div class="ab cl ky kz go la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ha hb hc hd he"><h1 id="d7b1" class="lf kt hh bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="96b8" class="pw-post-body-paragraph ip iq hh ir b is mc iu iv iw md iy iz ja me jc jd je mf jg jh ji mg jk jl jm ha bi translated">如果你是一个和我们处境相似的人，我认为花时间编写你的定制cron作业是值得的，而不是依赖于预先构建的服务。</p><p id="fdfb" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">虽然它需要我们编写一些代码，但正如您所看到的，它只有几行代码，我们从中获得的好处值得我们投入15分钟的时间。</p><p id="a510" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="mk">感谢阅读！如果你喜欢这个故事，请点击</em><strong class="ir hi"><em class="mk"/></strong>👏<strong class="ir hi"> <em class="mk">按钮</em> </strong> <em class="mk"> </em> <strong class="ir hi"> <em class="mk">并分享</em> </strong> <em class="mk">帮助别人找到！欢迎留言评论</em>💬<em class="mk">下图。</em></p><p id="6bd0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="mk">有反馈？下面我们来连线推特上的</em><a class="ae jn" href="https://twitter.com/harshithdwivedi" rel="noopener ugc nofollow" target="_blank"><em class="mk"/></a><em class="mk">。</em></p></div></div>    
</body>
</html>