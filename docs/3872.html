<html>
<head>
<title>Cloud Custodian: Easy way to explore instances in AWS cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云管理员:探索AWS云中实例的简单方法</h1>
<blockquote>原文：<a href="https://medium.com/globant/cloud-custodian-easy-way-to-explore-instances-in-aws-cloud-2544e075303d?source=collection_archive---------0-----------------------#2022-05-04">https://medium.com/globant/cloud-custodian-easy-way-to-explore-instances-in-aws-cloud-2544e075303d?source=collection_archive---------0-----------------------#2022-05-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/cc92b3b4c322c36acbc3c4298e2f8d46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_74Xig9xhuUy84wlQ0syGQ.jpeg"/></div></div></figure><p id="6bc3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">根据您公司的指导原则，较旧的机器可能代表一个漏洞。公司可能更喜欢使用旧的、经过更多测试的代码版本，但是通常认为每台机器都应该有最新的操作系统和软件版本。但是，要更新机器，您需要首先识别它们！如果您使用AWS控制台GUI，并为每个实例花费20秒，那么您将花费大约3分钟来查找10个实例，而1000个实例将花费5个多小时！所以你需要一个更简单快捷的方法。</p><p id="19ff" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">云托管是一种工具，可以帮助您在几秒钟内探索并更改云环境。在本文中，我们将通过使用这个工具来重点查找过时的、较旧的机器，这样我们就可以在以后删除、更新或替换它们。</p><h1 id="9105" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">入门指南</h1><p id="7303" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated"><a class="ae kq" href="https://cloudcustodian.io/docs/index.html" rel="noopener ugc nofollow" target="_blank">云托管</a>是一个Python工具，它可以统一数十个脚本，组织使用这些脚本来管理支持AWS、Azure和GCP环境的云帐户。对于这个例子，我们将使用AWS。对于Python，官方文档推荐3.6版或更高版本。</p><p id="0b31" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">关于安装过程，请参考此<a class="ae kq" href="https://cloudcustodian.io/docs/quickstart/index.html#install-cloud-custodian" rel="noopener ugc nofollow" target="_blank">链接</a>，并根据您的操作系统遵循步骤。对于Linux系统，我们将首先根据标准用Python创建一个虚拟环境，然后安装c7n包。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="0573" class="la jo hh kw b fi lb lc l ld le">python3 –m venv custodian<em class="lf"><br/></em>source custodian/bin/activate<em class="lf"><br/></em>pip install c7n</span></pre><p id="b4ff" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您需要设置写入和读取IAM权限，以允许云保管者访问。请看这个<a class="ae kq" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/tutorial_cross-account-with-roles.html" rel="noopener ugc nofollow" target="_blank"> AWS IAM教程</a>。对于本例，IAM角色需要对EC2资源的读写权限。</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lg"><img src="../Images/4891b10f3fbc7a272152296539afa440.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wtSM9QMbOR0r97WFYx7_oA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx">IAM Role</figcaption></figure><h2 id="deae" class="la jo hh bd jp ll lm ln jt lo lp lq jx ja lr ls kb je lt lu kf ji lv lw kj lx bi translated">该政策</h2><p id="731b" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">要开始使用云托管，我们需要创建一个包含策略的YAML文件，该策略包括资源、过滤器和操作。您可以组合过滤器和操作来满足您的需求。</p><ul class=""><li id="35aa" class="ly lz hh ir b is it iw ix ja ma je mb ji mc jm md me mf mg bi translated">资源:这是过滤和应用动作的资源类型(例如EC2)。</li><li id="79e0" class="ly lz hh ir b is mh iw mi ja mj je mk ji ml jm md me mf mg bi translated">过滤器:我们可以使用基于任何标准的过滤器来指定目标资源，例如名称、日期或标签。</li><li id="6bb4" class="ly lz hh ir b is mh iw mi ja mj je mk ji ml jm md me mf mg bi translated">动作:它定义了云托管者将对过滤的资源做什么。</li></ul><p id="7076" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">有关政策的更多信息，请查看此<a class="ae kq" href="https://cloudcustodian.io/docs/aws/gettingstarted.html" rel="noopener ugc nofollow" target="_blank">链接</a>。在这种情况下，我们需要标记旧的实例。由于我们正在寻找超过60天的运行实例，我们将策略文件命名为“ec2-old-dev.yml ”,并将其保存到名为“policies”的文件夹中。</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div class="er es mm"><img src="../Images/7010c1f80a3d9f7ace0455302909ede8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/1*A2rZm-otvOco1p9E2XL3NQ.png"/></div><figcaption class="lh li et er es lj lk bd b be z dx">Policy example</figcaption></figure><p id="df2b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">“ec2-old-dev.yml”文件将根据一个名为“Environment”的标签过滤所有正在运行的ec2资源，该标签包含值“dev”并且超过60天。在那些EC2资源被过滤后，该策略将创建一个名为“old”的新标签，其值为“true”。</p><p id="6af3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">使用以下命令，我们可以确认策略是否准确和一致。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="107e" class="la jo hh kw b fi lb lc l ld le">custodian validate policies/ec2-old-dev.yaml<br/>custodian.commands:INFO configuration valid:policies/ec2-old-dev.yml</span></pre><p id="9a3b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在我们有了策略文件，让我们看看如何使用它。</p><h2 id="d744" class="la jo hh bd jp ll lm ln jt lo lp lq jx ja lr ls kb je lt lu kf ji lv lw kj lx bi translated"><strong class="ak">托管运行</strong></h2><p id="da09" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">当我们使用run命令时，Cloud Custodian会将资源、过滤器和操作作为输入，将其转换为API调用。</p><p id="066c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要运行该策略，我们需要指定一些参数。</p><ul class=""><li id="ce4e" class="ly lz hh ir b is it iw ix ja ma je mb ji mc jm md me mf mg bi translated"><code class="du mn mo mp kw b">-s</code>:保存结果的路径。</li><li id="57f3" class="ly lz hh ir b is mh iw mi ja mj je mk ji ml jm md me mf mg bi translated">策略文件:要执行的策略。</li><li id="c21d" class="ly lz hh ir b is mh iw mi ja mj je mk ji ml jm md me mf mg bi translated">区域:执行的区域。</li></ul><p id="415e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">示例:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="3fee" class="la jo hh kw b fi lb lc l ld le">custodian run \<br/>-s output policies/ec2-old-dev.yml \<br/>--cache-period 0 \<br/>--region=us-west-1 \<br/>--profile=your-profile</span></pre><p id="a518" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这个命令将创建一个名为“output”的文件夹，另一个名为“ec2-old-dev”的文件夹，以及一个名为“resources.json”的文件。</p><ul class=""><li id="1dac" class="ly lz hh ir b is it iw ix ja ma je mb ji mc jm md me mf mg bi translated"><code class="du mn mo mp kw b">--region=us-west-1</code>:这是政策将适用的地区</li><li id="6ff9" class="ly lz hh ir b is mh iw mi ja mj je mk ji ml jm md me mf mg bi translated"><code class="du mn mo mp kw b">--profile=your-profile</code>:包含AWS环境访问权限的概要文件。</li><li id="4bac" class="ly lz hh ir b is mh iw mi ja mj je mk ji ml jm md me mf mg bi translated"><code class="du mn mo mp kw b">--cache-period</code>:我们可以使用这个选项来最小化API调用。默认选项将在本地存储数据15分钟。</li></ul><p id="7fe5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">策略被应用，那些符合过滤器的正在运行的实例有一个名为“old”的新标记，其值为我们在策略中指定的“true”。</p><p id="fda8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们可以在AWS控制台中检查所有这些EC2资源上的新标记。</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mq"><img src="../Images/9f8a2213a5b8de9429073704f178eb89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sm-4kZKmIhEz8YpJxDGIsw.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx">EC2 instance tagged</figcaption></figure><h2 id="31d4" class="la jo hh bd jp ll lm ln jt lo lp lq jx ja lr ls kb je lt lu kf ji lv lw kj lx bi translated"><strong class="ak">托管报告</strong></h2><p id="659d" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">或者，您可以基于前面的命令创建一个报告，并获得您需要的所有信息。命令报告需要一些参数。</p><ul class=""><li id="6be7" class="ly lz hh ir b is it iw ix ja ma je mb ji mc jm md me mf mg bi translated"><code class="du mn mo mp kw b">-s</code>:这与“运行”命令中的参数相同。report命令指定“resources.json”文件的位置。</li><li id="5c83" class="ly lz hh ir b is mh iw mi ja mj je mk ji ml jm md me mf mg bi translated">策略文件:来自“运行”命令的相同策略。</li><li id="ff8f" class="ly lz hh ir b is mh iw mi ja mj je mk ji ml jm md me mf mg bi translated">区域:运行上一个命令的区域。</li><li id="bdf4" class="ly lz hh ir b is mh iw mi ja mj je mk ji ml jm md me mf mg bi translated"><code class="du mn mo mp kw b">--no-default-fields</code>:从报告中删除默认字段。</li><li id="cd0c" class="ly lz hh ir b is mh iw mi ja mj je mk ji ml jm md me mf mg bi translated"><code class="du mn mo mp kw b">--field</code>:要包含在报表中的字段。例:<code class="du mn mo mp kw b">--field ID=ImageId</code></li></ul><p id="6aae" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">示例:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="622b" class="la jo hh kw b fi lb lc l ld le">custodian report -s /output policies/ec2-old-dev.yml \<br/>--region=us-west-1 \<br/>--profile=your-profile \<br/>--no-default-fields \<br/>--field ID=ImageId</span></pre><p id="7c66" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您将从终端上的前一个命令中得到一个结果。只有经过筛选的资源和指定的字段，在本例中只有ImageId。</p><p id="a7c4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">该命令的结果将是</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="fa14" class="la jo hh kw b fi lb lc l ld le">“ID”<br/>“i-AAABBB”<br/>“i-CCCDDD”<br/>“i-EEEFFF”</span></pre><p id="f8c9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">选项“<code class="du mn mo mp kw b">--field ID=ImageId</code>”将创建一个名为“ID”的列，并将只提供存储在“ImageId”上的信息。此外，名为“<code class="du mn mo mp kw b">--no-default-fields</code>”的选项将从报告中移除默认值，并从“字段”参数中仅获取必需的字段。</p><p id="ede7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们可以通过在命令末尾添加“<code class="du mn mo mp kw b">&gt; results.csv</code>”将输出保存为CSV文件。</p><p id="910e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您想保存历史或制作音频文件，保管人报告非常有用，因为您可以通过电子邮件发送文件或在任何通信渠道上共享文件</p><p id="ef57" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在我们有了一个根据规范过滤的实例列表，我们可以决定是更新它还是替换它。</p><p id="672a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">例如，我们可以决定停止标记为“old”且值为“true”的所有实例。为了实现这个目标，我们有几个选项，对于这个例子，我们将使用AWS CLI和这个脚本</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="bb73" class="la jo hh kw b fi lb lc l ld le">aws ec2 stop-instances --instance-ids $(aws ec2 describe-instances --query ‘Reservations[].Instances[].InstanceId’ --filters “Name=tag:old,Values=true” --output text) --region=us-west-1 --profile=your-profile</span></pre><p id="f967" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您还可以创建一个Jenkins作业，该作业将基于标记停止所有实例，请查看此<a class="ae kq" href="https://www.thegeekdiary.com/how-to-stop-and-start-ec2-instance-using-jenkins/" rel="noopener ugc nofollow" target="_blank">链接</a>了解更多信息。</p><h1 id="955a" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">摘要</h1><p id="1ed8" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">云托管是一个灵活的工具，可以帮助您根据需要探索和修改AWS环境。</p><p id="3db4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在本文中，您可以验证如何以一种简单快捷的方式探索基础设施并做出改变。</p><p id="6680" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">有关该工具的更多信息，请访问<a class="ae kq" href="https://cloudcustodian.io/" rel="noopener ugc nofollow" target="_blank">官方文档</a>。</p></div></div>    
</body>
</html>