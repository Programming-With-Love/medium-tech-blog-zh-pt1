<html>
<head>
<title>The story of battling with 10x Traffic</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">与10倍流量作战的故事</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/the-story-of-battling-with-10x-traffic-711589c8878b?source=collection_archive---------0-----------------------#2021-04-23">https://medium.com/walmartglobaltech/the-story-of-battling-with-10x-traffic-711589c8878b?source=collection_archive---------0-----------------------#2021-04-23</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="42da" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">实时报道</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/777c72bdd6fc59f19cd048d1e71f74d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3eXA49Ou-JEkPz7kIhsJMw.jpeg"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Photo credit: <a class="ae jm" href="https://pixabay.com/illustrations/jesus-christ-god-holy-spirit-4779546/" rel="noopener ugc nofollow" target="_blank">jeffjacobs1990</a></figcaption></figure><p id="ad6e" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">去年在我的<a class="ae jm" rel="noopener" href="/walmartlabs/real-time-data-processing-for-monitoring-and-reporting-a-practical-use-case-of-spark-structured-8e4f91f6f3a7">上一篇文章</a>中，我描述了沃尔玛的A/B测试平台<em class="kj"> Expo </em>的实时spark作业管道的整体架构。从那以后，我们的系统发生了很多变化。鉴于疫情的情况，网上购物者的数量大幅增长。我们观察到，一夜之间，我们的监控管道接收的流量增加了5到10倍。因此，我写这篇博客是为了简要回顾我们是如何平稳地向云迁移的，以及为了应对我们所面临的挑战，我们对我们的架构所做的改变。</p><h1 id="8a7c" class="kk kl hh bd km kn ko kp kq kr ks kt ku in kv io kw iq kx ir ky it kz iu la lb bi translated">背景</h1><p id="6f10" class="pw-post-body-paragraph jn jo hh jp b jq lc ii js jt ld il jv jw le jy jz ka lf kc kd ke lg kg kh ki ha bi translated">简而言之，我们有一个spark结构化流作业，从Kafka接收数据，将会话状态保存在内存和检查点中，并将指标推送到我们的时间序列数据库中，供实验人员进一步评估。虽然总体而言，流量增加对Walmart.com非常有利，但这意味着我们的监控系统会承受更大的压力，导致将指标推送到管道时出现延迟。</p><p id="76d4" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">在这篇文章中，我将介绍我们面临的所有挑战，以及我们为处理如此巨大的流量所采取的措施。当前系统已经运行了六个月，几乎没有停机时间<strong class="jp hi">。目前，它每秒处理<strong class="jp hi">15-25万条消息</strong>，每分钟推出大约<strong class="jp hi">300万条记录</strong>，从我们开始实验到我们的数据库中有指标之间的延迟不到<strong class="jp hi"> 3分钟</strong>。在正常情况下，我们的系统大约运行<strong class="jp hi">100–150个并发实验</strong>，这些实验放大了监控系统处理的数据量。</strong></p><p id="426d" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">概括一下，我在这里复制了整体架构，更多细节你可以阅读我之前的文章。我也把新的架构放在下面，作为这篇文章其余部分的参考。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lh"><img src="../Images/b3bb3abe4ef8d6ec784b808fb8345437.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nGIbFPpl_1QKxZCTyQEbhw.png"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">The old architecture of the monitoring system</figcaption></figure><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es li"><img src="../Images/a392c74f797f0f38824097568bdb3f20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WuxMCXTbzVEAkcm7i5FzHg.png"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">The new architecture of the monitoring system currently running in production</figcaption></figure></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><h1 id="a2e7" class="kk kl hh bd km kn lq kp kq kr lr kt ku in ls io kw iq lt ir ky it lu iu la lb bi translated">问题和行动</h1><p id="1679" class="pw-post-body-paragraph jn jo hh jp b jq lc ii js jt ld il jv jw le jy jz ka lf kc kd ke lg kg kh ki ha bi translated">在这一节中，我将我们面临的问题以及我们为解决问题所采取的措施进行了分类。我们做的一个主要改变是将整个管道转移到谷歌云，以确保我们有足够的资源进行扩展。之前的工作是在我们的私有数据中心进行的，我们团队的预留容量即将用完，因此我们决定将整个管道迁移到GCP。我在本文剩余部分的重点将是我们在管道中观察到的问题本身。</p><h2 id="3f98" class="lv kl hh bd km lw lx ly kq lz ma mb ku jw mc md kw ka me mf ky ke mg mh la mi bi translated"><strong class="ak">卡夫卡与调度员比率</strong></h2><p id="e4a4" class="pw-post-body-paragraph jn jo hh jp b jq lc ii js jt ld il jv jw le jy jz ka lf kc kd ke lg kg kh ki ha bi translated"><strong class="jp hi">发布</strong></p><p id="2522" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">通常，每个流作业要么是CPU密集型的，要么是I/O密集型的。虽然我们的监控系统的性质不同。我们的流媒体管道分为三个阶段。在第一阶段，该作业从Kafka获取大约150 GB(2–3GB/秒)的数据，这是一项繁重的I/O操作。在第二阶段，它开始处理来自前一阶段的数据，并在系统中创建/更新会话。这一步是CPU密集型的。第三阶段是将指标发送到数据库。这一步不需要太多时间。</p><ol class=""><li id="01dd" class="mj mk hh jp b jq jr jt ju jw ml ka mm ke mn ki mo mp mq mr bi translated"><strong class="jp hi">摄取率:</strong>我们有一个流调度程序，它评估事件并决定将事件重定向到其他主题以进行进一步处理。这种重定向不需要任何时间，调度程序发送数据的速度比用户快。我们注意到，dispatcher向主题发送数据的速率高于我们可以消耗(I/O)和处理(CPU)的速率。</li></ol><p id="3f65" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated"><strong class="jp hi">行动</strong></p><ol class=""><li id="b492" class="mj mk hh jp b jq jr jt ju jw ml ka mm ke mn ki mo mp mq mr bi translated"><strong class="jp hi">尽早丢弃不必要的数据:</strong>我们采取的早期行动之一是彻底重新评估指向主题的信标类型。世博会自2015年开始举办，我们有相当数量的历史元数据。这些数据显示了我们的实验者更感兴趣的信标类型。我们根据主题中的信标评估了历史元数据，发现主题中大约有<em class="kj"> 43% </em>的数据不会影响实验结果。因此，我们在调度程序中很早就过滤掉了这些信标。dispatcher中的过滤比作业的管道更便宜，因为在流式作业中，每一秒都很重要，每一毫秒都会累积起来，造成很大的延迟。这一改变缓解了延迟，并且管道能够赶上进度。</li><li id="e7b3" class="mj mk hh jp b jq ms jt mt jw mu ka mv ke mw ki mo mp mq mr bi translated"><strong class="jp hi">根据流量模式划分数据:</strong>我们将移动和网络流量分开，并将其重定向到各自的主题。这使我们有机会为每个主题创建单独的作业，并独立于其他主题处理每个主题。</li><li id="023b" class="mj mk hh jp b jq ms jt mt jw mu ka mv ke mw ki mo mp mq mr bi translated"><strong class="jp hi">添加更多的分区和计算:</strong>Kafka消费群中的并行度受到分区数量的限制。如果您有足够的资源，更多的分区会带来更高的吞吐量。我们将每个主题的分区数量从360个增加到490个，这有助于我们更快地从Kafka获取数据。我们还增加了spark集群中的计算数量，以克服任务中CPU密集型的部分。</li></ol></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><h2 id="17d5" class="lv kl hh bd km lw lx ly kq lz ma mb ku jw mc md kw ka me mf ky ke mg mh la mi bi translated">KairosDB</h2><p id="be29" class="pw-post-body-paragraph jn jo hh jp b jq lc ii js jt ld il jv jw le jy jz ka lf kc kd ke lg kg kh ki ha bi translated"><strong class="jp hi">问题</strong></p><p id="636f" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">另一个问题是KairosDB。KairosDB是围绕Cassandra的一个包装器，它向外部公开了一个rest API。</p><ol class=""><li id="4e64" class="mj mk hh jp b jq jr jt ju jw ml ka mm ke mn ki mo mp mq mr bi translated"><strong class="jp hi"> KairosDB摄取率:</strong>在疫情之前，我们对KairosDB很满意，但随着流量的每一次激增，我们发现我们不能将其作为一个可靠的组件，我们需要认真考虑系统的这一部分。KairosDB在内部使用本地队列来处理高吞吐量流量，但在突发流量期间，它会丢弃数据并延迟推送数据。即使在新冠肺炎之前，我们也有几次因为机器人或者一些流量爆发(如PS5交易)而导致峰值，KairosDB令我们失望。</li><li id="8894" class="mj mk hh jp b jq ms jt mt jw mu ka mv ke mw ki mo mp mq mr bi translated"><strong class="jp hi"> KairosDB内存管理:</strong>KairosDB的另一个问题是当我们查询大范围的时间时出现内存异常。由于这种内存管理不善，我们不得不多次重启服务。</li><li id="c3d7" class="mj mk hh jp b jq ms jt mt jw mu ka mv ke mw ki mo mp mq mr bi translated"><strong class="jp hi">数据保留政策:</strong>KairosDB中的指标没有压缩，我们很难接受其他团队提出的延长保留期或向当前渠道添加更多指标的请求。我们在实时管道中设置了一个两天的TTL策略，但我们收到了许多增加该数量的请求。我们甚至很难轻松地添加更多的指标。每次我们收到添加新指标的请求时，我们都必须小心谨慎。我们还不得不推迟请求，比如用我们的监控系统捕获图像的点击和印象指标，因为这几乎会使我们捕获的指标翻倍。</li></ol><p id="9d51" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated"><strong class="jp hi">动作</strong> ‍</p><ol class=""><li id="4a9b" class="mj mk hh jp b jq jr jt ju jw ml ka mm ke mn ki mo mp mq mr bi translated"><strong class="jp hi">评估其他选项:</strong>甚至在流量增加之前，我们就注意到KairosDB可能是一个问题。所以，我们开始更换我们的时间序列数据库。我们评估了多个数据库，最终得到了两个选项:<strong class="jp hi"><em class="kj">elastic search</em></strong>和<strong class="jp hi"> <em class="kj"> M3DB </em> </strong>。虽然Elasticsearch是一个强大的搜索引擎，其聚合框架可以帮助我们很多，但我们发现与其他时间序列数据库相比，它需要大量的内存和空间。随着数据量的增长，查询速度也越来越慢。另一方面，M3DB确实大放异彩。我们通过运行两个独立的作业将生产数据推送到M3DB并让它运行两周，使系统负载加倍。M3DB能够轻松处理负载。M3DB出色的另一个因素是压缩数据的能力，这有助于我们在生产中将指标的TTL延长到30天。我们还向系统添加了印象和图像点击等指标(带有多个属性和标签)。</li><li id="9a39" class="mj mk hh jp b jq ms jt mt jw mu ka mv ke mw ki mo mp mq mr bi translated"><strong class="jp hi">给一个数据库摄取的时间:</strong>我们把Kafka作为我们spark app和M3DB之间的中间件。推送Kafka主题比推送数据库更快，因为它只是附加到一个片段文件，这也可以批量完成。通过这种设置，另一个作业可以将指标发送到所需的数据库。对于KairosDB，我们设置了一个logstash集群，对于M3DB，我们使用一个内部java应用程序将指标发送到数据库。我们通过Grafana图表比较KairosDB和M3DB的结果，对两个数据库进行了全面的测试，以确保我们不会因为这种转换而看到任何不一致。</li></ol><p id="9347" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">通过上述更改，我们能够添加更多指标，而不必担心系统的稳定性，将保留时间增加到30天，并且在过去六个月中指标数据零下降。</p></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><h2 id="37a9" class="lv kl hh bd km lw lx ly kq lz ma mb ku jw mc md kw ka me mf ky ke mg mh la mi bi translated">代码和配置耦合</h2><p id="4449" class="pw-post-body-paragraph jn jo hh jp b jq lc ii js jt ld il jv jw le jy jz ka lf kc kd ke lg kg kh ki ha bi translated"><strong class="jp hi">发布</strong></p><ol class=""><li id="4fbf" class="mj mk hh jp b jq jr jt ju jw ml ka mm ke mn ki mo mp mq mr bi translated"><strong class="jp hi">元数据和代码的卷积:</strong>UI之前的实现是直接调用KairosDB来获取度量，并基于那些计算硬编码的公式。很难给系统添加新的公式。公式是不同指标的组合。例如，转换率来自两个不同的指标，客户数量除以总访客数量。很多时候，实验者需要一个新的公式，它是我们系统中当前指标的组合，但是为了添加它，团队需要改变代码。这部分代码与Expo UI服务错综复杂，很难维护。</li></ol><p id="927c" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated"><strong class="jp hi">动作</strong></p><p id="7f41" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated"><strong class="jp hi">时序数据库包装服务(<em class="kj"> tsdb-ws </em> ): </strong>当我们决定用另一个未知数据源切换KairosDB时，我们知道最终我们也需要更改UI代码。因此，我们决定将通信接口与我们当前和未来的数据源(KairosDB、M3DB、Elaticsearch)统一起来。</p><p id="1fe3" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">为此，我们使用KOA(node . js框架)开发了一个时序数据库包装服务(<em class="kj"> tsdb-ws </em>)。为了做到这一点，我们用一个逻辑键空间分隔每个租户，并为该租户定义每个公式的含义，并将这种关系放入一个存储库中。每个公式都可以是模板文字。在这种情况下，UI将发送适当的有效载荷来生成完整的表达式。</p><p id="badd" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">除了公式部分之外，我们在配置文件中还有一个元数据部分，以便提供UI呈现图表所需的一切(就像图表的标题一样，这是一个百分比图表或数字图表等)</p><p id="c778" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">UI应用程序点击<code class="du mx my mz na b"><em class="kj">/&lt;:keyspace&gt;</em></code> <em class="kj"> </em>获得适当的数据，在给定的时间段内批量请求多个公式。<em class="kj"> tsdb-ws </em>服务查看公式列表，<em class="kj">找到公式和指标之间的依赖图，</em>并基于此通过<em class="kj">一次调用</em>获取整个数据。返回值由公式的元数据修饰。</p><p id="b868" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">使用这种架构，我们不需要任何代码更改。每次实验者需要更多的公式在UI中显示时，我们可以很容易地将它们添加到资源库中，它会在UI中呈现为图表。</p><p id="9716" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">此外，这个设置帮助我们从KairosDB平稳过渡到M3DB。UI不需要知道我们正在使用的底层数据库是什么。当我们觉得M3DB已经准备好了，并且我们有了一个合适的设置，我们只是切换tsdb-ws中的标志来使用M3DB，而UI甚至不知道它。</p></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><h1 id="8f43" class="kk kl hh bd km kn lq kp kq kr lr kt ku in ls io kw iq lt ir ky it lu iu la lb bi translated">包裹</h1><p id="9b27" class="pw-post-body-paragraph jn jo hh jp b jq lc ii js jt ld il jv jw le jy jz ka lf kc kd ke lg kg kh ki ha bi translated">大约两年前，我们开始为世博会建立一个高度可用的监控系统。在过去的两年里，我们的建筑适应了不同的环境。目前的系统运行顺利，我们有计划确保它可以扩展到下一个10倍的流量。我们现在确信，这是我们和我们的客户应该采取的正确策略。</p></div></div>    
</body>
</html>