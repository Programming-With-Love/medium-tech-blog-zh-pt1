<html>
<head>
<title>Multisite Drupal based application deployment using Jenkins</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Jenkins进行基于多站点Drupal的应用程序部署</h1>
<blockquote>原文：<a href="https://medium.com/globant/multisite-drupal-based-application-deployment-using-jenkins-7735dd23f00a?source=collection_archive---------0-----------------------#2021-03-08">https://medium.com/globant/multisite-drupal-based-application-deployment-using-jenkins-7735dd23f00a?source=collection_archive---------0-----------------------#2021-03-08</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="63d9" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">简介</strong></h1><p id="3a67" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在本文中，您将学习如何通过Jenkins使用SSH协议在远程应用服务器上构建和部署多站点Drupal应用程序。您还将学习如何在运行时从GitHub存储库中获取分支以进行代码构建。</p><p id="f196" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">Drupal multisite特性是大型组织的有效解决方案，这些组织通常需要不止一个网站，而是一组相关的网站，易于管理。Drupal multisite已经在教育网站、政府网站、企业网站等中流行起来。多个站点组合在同一个Drupal安装中，这是Drupal多站点特性的基本要素。不是一个网站，你有一个网站的集合，这些网站是从一个地方创建、管理、部署和更新的，因为它们共享一个代码库。每个多站点都有自己的数据库、配置、文件和基本域或URL。关于多站点Drupal应用程序设置，请参考<a class="ae kf" href="https://www.drupal.org/docs/multisite-drupal/set-up-a-multisite" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><p id="8494" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">Jenkins是一个流行的开源工具，用于执行持续集成和构建自动化。Jenkins在整个生命周期中管理和控制软件交付过程，包括构建、文档、测试、打包、阶段、部署、静态代码分析等等。你有没有想过为什么詹金斯如此受欢迎，尤其是在最近几年？其受欢迎的主要因素之一是詹金斯管道的灵活性，如果你正在寻找这样的詹金斯管道教程，这个博客是你的首选。</p><h1 id="51af" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">本文涵盖以下要点</strong></h1><p id="48ec" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">1.背景<br/> 2。主要部分<br/> 3。先决条件<br/> 4。假设<br/> 5。遵循<br/> 6的步骤。优点<br/> 7。缺点8。结论<br/> 9。参考</p><h1 id="d05a" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak"> 1。背景</strong></h1><p id="a44c" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">今天，你们中的许多人在多站点Drupal应用程序的自动化部署中面临问题，因此导致了手动干预。在手动部署过程中，您最终可能会在命令执行中出错。在本文中，您将学习如何自动化Drupal多站点应用程序部署过程。</p><h1 id="d123" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak"> 2。主要部分</strong></h1><p id="9dd2" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">管道是由管道插件(以前称为“工作流”)支持的Jenkins作业，使用简单的文本脚本构建，这些脚本使用基于Groovy编程语言的管道DSL(特定领域语言)。Groovy语言提供的大多数功能对脚本管道的用户都是可用的，这意味着它可以是一个非常有表现力和灵活的工具，用它可以创作连续的交付管道。</p><p id="c80b" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">脚本化管道从Jenkins文件的顶部向下连续执行，像Groovy或其他语言中的大多数传统脚本一样，提供流控制，因此依赖于Groovy表达式。</p><h1 id="278d" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak"> 3。先决条件</strong></h1><p id="717d" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">对于下面的这篇文章，先决条件是必需的:</p><ul class=""><li id="8adc" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">对Jenkins管道的基本了解</li><li id="59e8" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">SSH协议如何工作</li><li id="e2ac" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">Git和GitHub的基础知识</li><li id="c5a2" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">使用drush(<strong class="je hi">Dru</strong>pal<strong class="je hi">sh</strong>ell)命令编译、构建和部署Drupal应用程序的知识。</li></ul><h1 id="eaa4" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak"> 4。假设</strong></h1><p id="2bd7" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">4.1对于这篇文章，我们假设你已经用默认的推荐插件安装了Jenkins，在此之上我们需要从Jenkins插件管理器安装下面的插件。</p><ul class=""><li id="3c2a" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">SSH管道插件</li><li id="cc3d" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">Git参数插件</li></ul><p id="72c5" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">4.2在本文中，我们将参考以下服务器进行理论解释和命令执行-</p><ul class=""><li id="c84a" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">Jenkins服务器— 192.x.x.5</li><li id="3ebb" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">Jenkins端口—使用HTTP协议的8080</li><li id="edfe" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">Drupal应用程序开发服务器— 192.x.x.6</li><li id="df2a" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">Drupal应用程序UAT服务器— 192.x.x.7</li></ul><p id="fea6" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">4.3本文中讨论的Drupal应用程序有如下3个站点示例:</p><ul class=""><li id="4503" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">site1.com</li><li id="876a" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">site2.com</li><li id="90ca" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">site3.com</li></ul><p id="3d7c" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">因此，所有网站的源代码基础(即业务逻辑)都是相同的，唯一的区别是用户界面，我们有不同的主题。为了构建基于主题的应用程序，我们在Jenkins pipeline中使用了输入选择参数。</p><p id="02b8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">4.4一般来说，我们可以有3个应用程序环境，即开发(开发)、UAT/阶段(用户验收测试)和生产(生产/现场)，根据本文，我们应该从Jenkins服务器连接到所有应用程序环境。</p><p id="9676" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">4.5远程Drupal应用程序上的应用程序目录结构假定为</p><p id="267f" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">对于父目录— /var/www/multisites/web/</p><p id="78c0" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">对于基于多站点功能的自定义主题文件夹-</p><ul class=""><li id="387e" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">/var/www/multi sites/web/themes/custom/site 1</li><li id="c22a" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">/var/www/multi sites/web/themes/custom/site 2</li><li id="90f9" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">/var/www/multi sites/web/themes/custom/site 3</li></ul><p id="77d2" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">4.6 Drupal应用程序特定依赖项的安装被认为是由系统/基础架构管理员完成的。</p><h1 id="acb5" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak"> 5。要遵循的步骤</strong></h1><p id="e32d" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">下面是我们将在本文中讨论的实现分类列表:</p><p id="f823" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">5.1为远程服务器配置无密码访问的步骤。</p><p id="25ff" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">5.2添加参数化作业的属性</p><p id="a27a" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">5.3 SSH管道插件和支持的详细信息</p><p id="fcf8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">5.4准备执行命令。</p><p id="ffe0" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">5.5完整的管道结构</p><h2 id="5405" class="ku if hh bd ig kv kw kx ik ky kz la io jn lb lc is jr ld le iw jv lf lg ja lh bi translated"><strong class="ak"> 5.1为远程服务器配置无密码访问的步骤</strong></h2><ul class=""><li id="08bd" class="kg kh hh je b jf jg jj jk jn li jr lj jv lk jz kl km kn ko bi translated">为了配置Jenkins服务器和远程应用服务器之间的无密码访问，我们需要配置公钥-私钥对认证。</li></ul><p id="1b35" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">命令:</p><p id="0a70" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">使用以下命令在Jenkins服务器上生成公钥-私钥</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="2333" class="ku if hh lq b fi lu lv l lw lx">ssh-keygen</span></pre><p id="7926" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">在密钥生成期间检查说明，并输入密码短语</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="9dcd" class="ku if hh lq b fi lu lv l lw lx">Enter the passphrase</span></pre><p id="c0e5" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">创建密钥后，将公钥从Jenkins服务器复制到远程应用服务器</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="b167" class="ku if hh lq b fi lu lv l lw lx">ssh-copy-id -i id_rsa.pub ritesh@192.x.x.6</span><span id="4a38" class="ku if hh lq b fi ly lv l lw lx">ssh-copy-id -i id_rsa.pub ritesh@192.x.x.7</span></pre><ul class=""><li id="07d9" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">一旦在Jenkins服务器和远程应用服务器之间设置了无密码连接，然后在Jenkins中配置私钥。要添加凭据，请遵循以下步骤:</li></ul><p id="c709" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">打开Jenkins网址:http://192 . x . x . 5:8080/credentials/store/system/</p><p id="5e1e" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi"> <em class="lz">注意:您可以输入您的Jenkins IP和各自的端口。</em>T3】</strong></p><ul class=""><li id="1d12" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">单击要添加凭据的域。默认情况下会有全局凭证，所以单击它。</li><li id="cb76" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">在左侧，单击添加凭据。如需更多详细信息，请查看以下截图:</li></ul><figure class="ll lm ln lo fd mb er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es ma"><img src="../Images/3e311d0c9ca3d3029b613ef9454a9165.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J1jGEiEGuL08GTds-xQbQw.png"/></div></div><figcaption class="mi mj et er es mk ml bd b be z dx">Add credentials with username and private key</figcaption></figure><p id="8d05" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">现在，一旦我们添加了凭证，我们就需要将它与Jenkins管道绑定。</p><ul class=""><li id="38fc" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">创建一个Jenkins管道，假设我们已经创建了一个名为<strong class="je hi"> Drupal应用程序管道</strong>的管道项目</li><li id="a0b7" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">项目创建后，点击url:</li></ul><p id="03d4" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">http://<a class="ae kf" href="http://192.168.1.5:8080/credentials/store/system/" rel="noopener ugc nofollow" target="_blank">192 . x . x . 5:8080</a>/job/Drupal应用程序管道/管道-语法/</p><p id="3514" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi"> <em class="lz">注意:在上面的url中Drupal应用管道是项目的名称。您可以输入您的Jenkins IP和各自的端口。</em>T11】</strong></p><ul class=""><li id="c54f" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">打开管道代码段生成器，并选择withCredentials:将凭据绑定到变量</li></ul><figure class="ll lm ln lo fd mb er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mm"><img src="../Images/f96159c87b5ef5602c0a377862790692.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3jGn6DuoYTRuo48MycpnBQ.png"/></div></div><figcaption class="mi mj et er es mk ml bd b be z dx">Create code snippet for withCredentials</figcaption></figure><ul class=""><li id="64e0" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">从样本步骤中选择<strong class="je hi">和</strong>选项，并填写如下截图所示的详细信息。</li></ul><figure class="ll lm ln lo fd mb er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mn"><img src="../Images/9f23897132fb1cf2f7b3ff72cfbb7c69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nGHoVpqHlHCVeglmXrS7NA.png"/></div></div><figcaption class="mi mj et er es mk ml bd b be z dx">Bind credentials with variables</figcaption></figure><ul class=""><li id="fdb3" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">完成上述步骤后，复制生成的管道语法并准备以下管道结构:</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="adb3" class="ku if hh lq b fi lu lv l lw lx">node {</span><span id="96a2" class="ku if hh lq b fi ly lv l lw lx">withCredentials([sshUserPrivateKey(credentialsId: ‘Remote-Server-Access-Creds’, keyFileVariable: ‘PASSWORDLESS’, passphraseVariable: ‘PASSWORD’, usernameVariable: ‘USERNAME’)]) {</span><span id="261c" class="ku if hh lq b fi ly lv l lw lx">//Some code block</span><span id="2b1a" class="ku if hh lq b fi ly lv l lw lx">}</span><span id="e45d" class="ku if hh lq b fi ly lv l lw lx">}</span></pre><h2 id="61a9" class="ku if hh bd ig kv kw kx ik ky kz la io jn lb lc is jr ld le iw jv lf lg ja lh bi translated">5.2 <strong class="ak">添加参数化作业的属性</strong></h2><p id="b0b2" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">parameters指令提供了触发管道时应该提供的参数列表。这些用户指定参数的值通过params对象可用于管道步骤。</p><p id="e11b" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">该参数可以是以下类型之一</p><ul class=""><li id="3ebf" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">线</li><li id="a94a" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">文本</li><li id="94ec" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">布尔代数学体系的</li><li id="ab75" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">选择</li><li id="f911" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">密码</li></ul><p id="a29a" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">在这篇文章中，我们将涵盖选择参数，我们也将涵盖Git参数，这是从' Git参数插件'派生的。我们将使用如下三个参数:</p><ol class=""><li id="76ca" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz mo km kn ko bi translated"><strong class="je hi">选择参数</strong>:用于定义应用的多个站点名，配置的参数值是静态的。</li><li id="7215" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz mo km kn ko bi translated"><strong class="je hi">选择参数</strong>:用于显示需要编译、构建和部署代码的应用服务器的数量。为了简化，我们将使用“主机名-服务器名”。所有配置的参数值将是静态的。</li></ol><p id="6e8a" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">示例:</p><p id="784a" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">UAT</p><p id="2c18" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">开发-192.x.x.6</p><p id="612e" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">要生成选择参数片段，请遵循以下步骤:</p><ul class=""><li id="ec8b" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">对于管道代码段生成器，请点击以下url:</li></ul><p id="f4d1" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">打开詹金斯网址:<a class="ae kf" href="http://192.168.1.5:8080/credentials/store/system/" rel="noopener ugc nofollow" target="_blank">http://192 . x . x . 5:8080/credentials/store/system/</a></p><p id="9c35" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi"> <em class="lz">注意:您可以输入您的Jenkins IP和各自的端口。</em>T3】</strong></p><figure class="ll lm ln lo fd mb er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mp"><img src="../Images/faa8b1049beeed3739a0135481148063.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ObsEhmUBIYiZ_MZ81-cUiQ.png"/></div></div></figure><ul class=""><li id="6a8e" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">从示例步骤中选择“属性:设置作业属性”。</li><li id="b2c5" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">勾选选项“<strong class="je hi">该项目已参数化</strong>，这将显示添加参数的各种选项。</li><li id="fdca" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">选择选择参数并填写详细信息，如下图所示:</li></ul><figure class="ll lm ln lo fd mb er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mq"><img src="../Images/d02277d15ba5cd04b4140d651ed08049.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZTDQ6aVZBK0d_HnsL48BeA.png"/></div></div><figcaption class="mi mj et er es mk ml bd b be z dx">Add multiple site name as parameter</figcaption></figure><ul class=""><li id="831a" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">接下来，为远程应用服务器添加另一个选择参数。</li></ul><figure class="ll lm ln lo fd mb er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mr"><img src="../Images/1c3f9045bccdfe30c6b697a0292e394e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TO-FEgB50RvuK6JCk8DfJw.png"/></div></div><figcaption class="mi mj et er es mk ml bd b be z dx">Add multiple server type with IP</figcaption></figure><p id="5187" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">3.<strong class="je hi"> Git参数</strong>:该参数将用于在运行时获取GitHub分支的所有列表，并显示以供选择。您只能选择一个分支，因为它将是类型选择参数。</p><ul class=""><li id="da51" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">要生成git参数片段，请按照下面的屏幕截图输入详细信息:</li></ul><figure class="ll lm ln lo fd mb er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es ms"><img src="../Images/6b6a0c3231d3d7bcac7f4689402ab2c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kYcrKg68AkZEoekrMcfrBA.png"/></div></div></figure><ul class=""><li id="ef44" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">现在，我们已经在管道片段生成器中添加了所有三个参数，因此单击代码的“生成管道脚本”按钮。</li></ul><figure class="ll lm ln lo fd mb er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mt"><img src="../Images/61b576b2b46a8b8728daa1436a7d43b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OeXra_6L9W-jPljCSDp5Vg.png"/></div></div><figcaption class="mi mj et er es mk ml bd b be z dx">Pipeline snippet for three properties</figcaption></figure><p id="2aef" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">至此，Jenkins管道将如下所示:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="c6cc" class="ku if hh lq b fi lu lv l lw lx"><em class="lz">node {</em></span><span id="629d" class="ku if hh lq b fi ly lv l lw lx">withCredentials([sshUserPrivateKey(credentialsId: ‘Remote-Server-Access-Creds’, keyFileVariable: ‘PASSWORDLESS’, passphraseVariable: ‘PASSWORD’, usernameVariable: ‘USERNAME’)]) {</span><span id="63ed" class="ku if hh lq b fi ly lv l lw lx">properties([parameters([choice(choices: [‘site1’, ‘site2’, ‘site3’], description: ‘Select site for building the application’, name: ‘sitename’), choice(choices: [‘UAT-192.x.x.7’, ‘DEV-192.x.x.6’], description: ‘Select the server for deploying the application’, name: ‘Application-Servers’), gitParameter(branch: ‘’, branchFilter: ‘.*’, defaultValue: ‘origin/master’, description: ‘’, name: ‘BRANCH’, quickFilterEnabled: false, selectedValue: ‘NONE’, sortMode: ‘NONE’, tagFilter: ‘*’, type: ‘PT_BRANCH’, useRepository: ‘<a class="ae kf" href="mailto:git@github.globant.com" rel="noopener ugc nofollow" target="_blank">git@github.globant.com</a>:ritesh-goyal/jenkins-pipeline.git’)])])</span><span id="40ee" class="ku if hh lq b fi ly lv l lw lx">// .. Some code block ..</span><span id="3f8a" class="ku if hh lq b fi ly lv l lw lx">}</span><span id="6799" class="ku if hh lq b fi ly lv l lw lx">}</span></pre><h2 id="dbb4" class="ku if hh bd ig kv kw kx ik ky kz la io jn lb lc is jr ld le iw jv lf lg ja lh bi translated">5.3<strong class="ak">SSH管道插件和支持的详细信息</strong></h2><ul class=""><li id="d512" class="kg kh hh je b jf jg jj jk jn li jr lj jv lk jz kl km kn ko bi translated">SSH管道步骤使用远程(map)设置，然后在远程节点上执行命令。一旦命令被执行，它就会返回输出。它在内部使用Groovy SSH的库。</li><li id="3f0a" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">以下是远程地图设置示例。</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="a4d3" class="ku if hh lq b fi lu lv l lw lx">def remote = [:]</span><span id="4328" class="ku if hh lq b fi ly lv l lw lx">remote.name = &lt;Name of the server i.e., UAT / DEV / Prod&gt;</span><span id="43b8" class="ku if hh lq b fi ly lv l lw lx">remote.host = &lt;Hostname or IP address of the server&gt;</span><span id="7f76" class="ku if hh lq b fi ly lv l lw lx">remote.allowAnyHosts = true</span><span id="dd1a" class="ku if hh lq b fi ly lv l lw lx">remote.user = &lt;User-ID for server login&gt;</span><span id="871e" class="ku if hh lq b fi ly lv l lw lx">remote.identityFile = Passwordless</span><span id="9137" class="ku if hh lq b fi ly lv l lw lx">remote.passphrase = &lt;Password for private-key&gt;</span></pre><ul class=""><li id="a421" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">为了在远程服务器上执行命令，我们将使用管道插件中的sshCommand步骤。</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="eb28" class="ku if hh lq b fi lu lv l lw lx">sshCommand remote: remote, command: "for i in {1..5}; do echo -n \"Loop \$i \"; date ; sleep 1; done"</span></pre><ul class=""><li id="622e" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">因此，从上面的命令中，我们了解到它使用远程(地图)设置配置，然后执行定义的命令。</li></ul><h2 id="74b2" class="ku if hh bd ig kv kw kx ik ky kz la io jn lb lc is jr ld le iw jv lf lg ja lh bi translated">5.4 <strong class="ak">准备执行</strong>的命令</h2><ol class=""><li id="13ef" class="kg kh hh je b jf jg jj jk jn li jr lj jv lk jz mo km kn ko bi translated">为了在远程drupal应用服务器上执行命令，我们将使用下面用groovy编写的Jenkins管道语法来准备命令，并将它们存储在变量中</li><li id="5e0e" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz mo km kn ko bi translated">在Jenkins脚本化管道中定义变量时，使用的语法是— <strong class="je hi"> def </strong></li></ol><ul class=""><li id="b0c3" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">定义用于从选择参数中捕获用户输入的站点变量。</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="c8fd" class="ku if hh lq b fi lu lv l lw lx"> site = params.sites.trim()</span><span id="de61" class="ku if hh lq b fi ly lv l lw lx">String[] server = params.servers.trim().split("-");</span></pre><ul class=""><li id="b336" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">定义<em class="lz"> branchname </em>变量，用于在运行时使用Git参数插件列表获取分支。插件获取“原点/UAT”<em class="lz">、</em>“原点/开发”中的名称..etc格式。为此，我们需要更改“原点/UAT”——&gt;“UAT”，所以我们使用replaceAll函数。</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="e155" class="ku if hh lq b fi lu lv l lw lx">branchname = params.BRANCH.trim()</span><span id="dda4" class="ku if hh lq b fi ly lv l lw lx">def branch = params.BRANCH.trim().replaceAll("origin/","")</span></pre><ul class=""><li id="7ac1" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">设置远程服务器上Drupal应用程序的默认路径</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="b81d" class="ku if hh lq b fi lu lv l lw lx">def defaultPath = "cd /var/www/multisites/web/"</span></pre><ul class=""><li id="4beb" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">我们将定义主题文件夹，并将设置特定站点的自定义主题的路径，以便基于该站点构建和部署应用程序。</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="7aa3" class="ku if hh lq b fi lu lv l lw lx">def themesfolder</span><span id="4208" class="ku if hh lq b fi ly lv l lw lx">if ( site == 'site1') {</span><span id="5635" class="ku if hh lq b fi ly lv l lw lx">themesfolder = "${defaultPath}themes/custom/site1"</span><span id="5479" class="ku if hh lq b fi ly lv l lw lx">} else if(site == 'site2') {</span><span id="bde9" class="ku if hh lq b fi ly lv l lw lx">themesfolder = "${defaultPath}themes/custom/site2"</span><span id="6d4c" class="ku if hh lq b fi ly lv l lw lx">} else {</span><span id="9823" class="ku if hh lq b fi ly lv l lw lx">themesfolder = "${defaultPath}themes/custom/site3"</span><span id="6585" class="ku if hh lq b fi ly lv l lw lx">}</span></pre><ul class=""><li id="3175" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">以下命令清除远程应用服务器上的缓存。站点名称来自choice参数。</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="c1ba" class="ku if hh lq b fi lu lv l lw lx">def cacheClear = "${defaultPath}; drush -l ${site} cr"</span></pre><ul class=""><li id="f78b" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">启用应用程序的维护模式</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="dc5a" class="ku if hh lq b fi lu lv l lw lx">def enableMaintenance = "${defaultPath}; drush -l ${site} sset system.maintenance_mode 1"</span></pre><ul class=""><li id="b321" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">从远程应用服务器上的git存储库中提取源代码</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="29b1" class="ku if hh lq b fi lu lv l lw lx">def gitpull = "${defaultPath}; git pull origin ${branch}"</span></pre><ul class=""><li id="016f" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">我们需要在composer.json配置文件旁边安装composer实用程序。标准情况下，composer.json配置放在默认路径之前的一个文件夹中。对于这一步，请确保您的路径。</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="4b82" class="ku if hh lq b fi lu lv l lw lx">def composer = "${defaultPath}../; composer install"</span></pre><ul class=""><li id="bc7b" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">执行数据库查询</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="3ad8" class="ku if hh lq b fi lu lv l lw lx">def updateDB = "${defaultPath}; drush -l ${site} updb -y"</span></pre><ul class=""><li id="b744" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">导入应用程序的迁移配置</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="5c6b" class="ku if hh lq b fi lu lv l lw lx">def importConfig = "${defaultPath}; drush -l ${site} cim -y"</span></pre><ul class=""><li id="cda2" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">禁用应用程序的维护模式</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="e8a3" class="ku if hh lq b fi lu lv l lw lx">def disableMaintenance = "${defaultPath}; drush -l ${site} sset system.maintenance_mode 0"</span></pre><ul class=""><li id="c818" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">使用npm实用程序在应用程序的特定站点(即站点1、站点2、站点3)目录中安装节点</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="ccf2" class="ku if hh lq b fi lu lv l lw lx">def nodeInstall = "${themesfolder}; npm install"</span></pre><ul class=""><li id="b467" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">在应用程序的特定站点(即站点1、站点2、站点3)目录中执行gulp命令</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="dc0e" class="ku if hh lq b fi lu lv l lw lx">def gulp = "${themesfolder}; gulp"</span></pre><h2 id="287b" class="ku if hh bd ig kv kw kx ik ky kz la io jn lb lc is jr ld le iw jv lf lg ja lh bi translated">5.5 <strong class="ak">完整的管道结构</strong></h2><p id="3cd0" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">到目前为止，我们已经看到了Drupal应用程序的CI/CD管道所需的Jenkins管道的各种组件。让我们来看看整个Jenkins脚本管道代码，不同的阶段有不同的命令要在远程Drupal应用程序上执行。要查看完整的管道代码，请参考公开发布的GitHub URL <a class="ae kf" href="https://github.com/Ritesh-globant/multi-site-drupal-application-jenkins-project/blob/main/Jenkinsfile" rel="noopener ugc nofollow" target="_blank">(多站点Drupal应用程序Jenkins项目)</a>。</p><p id="c2c4" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">对于管道执行，单击Jenkins项目中的“使用参数构建”选项，并遵循界面中所示的步骤。</p><figure class="ll lm ln lo fd mb er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mu"><img src="../Images/a62673c7bd1f1746097cce87e89713de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Io2qmhaABNTKGuRfIz3F1Q.png"/></div></div></figure><ul class=""><li id="27e1" class="kg kh hh je b jf ka jj kb jn ki jr kj jv kk jz kl km kn ko bi translated">选择要为其构建Drupal站点的站点名称。</li><li id="a72e" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">选择您想要签出并构建Drupal应用程序的分支名称。这里所有的分支都是在运行时获取的。</li><li id="76ae" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">选择要部署Drupal应用程序的服务器。</li><li id="8e14" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">单击Build按钮，以便触发管道。</li></ul><p id="24e1" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">管道的执行输出如下所示:</p><figure class="ll lm ln lo fd mb er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mv"><img src="../Images/095f5c5c0038ebbb958fcb119e38e4c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yNtT14G06TJpatYdR_QIDQ.png"/></div></div><figcaption class="mi mj et er es mk ml bd b be z dx">Output of the Job</figcaption></figure><p id="9eb5" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi"> <em class="lz">注意:所有的命令(如上图所示)都在终端服务器上执行，终端服务器是在管道执行时作为参数选择的。</em> </strong></p><h1 id="bc81" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak"> 6。优点</strong></h1><ul class=""><li id="b068" class="kg kh hh je b jf jg jj jk jn li jr lj jv lk jz kl km kn ko bi translated">这个管道将帮助您通过SSH协议执行多个远程命令。</li><li id="4e92" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">SSH命令的执行是安全的，因为我们使用的是在Jenkins中预先配置的密码私有密钥。</li><li id="dae3" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">它将帮助您在管道运行时获取和选择Git分支。与多分支詹金斯管道项目相比，它提供了更好的控制。</li><li id="c7b5" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">拥有多个站点的Drupal应用程序可以通过这个管道有效地处理。</li></ul><h1 id="49c2" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak"> 7。缺点</strong></h1><ul class=""><li id="661c" class="kg kh hh je b jf jg jj jk jn li jr lj jv lk jz kl km kn ko bi translated">由于参数化构建，需要手动触发管道，因为用户需要选择分支名称、要部署的服务器和构建应用程序的站点。</li></ul><h1 id="ce83" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak"> 8。结论</strong></h1><ul class=""><li id="5ea3" class="kg kh hh je b jf jg jj jk jn li jr lj jv lk jz kl km kn ko bi translated">使用这个管道，您可以使用SSH协议在远程服务器上编译、构建和部署您的多站点Drupal应用程序。</li><li id="3df2" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">我们可以使用文章中所示的插件在运行时获取git分支，并选择特定的服务器进行部署。</li><li id="6481" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">Drupal命令也可以被类似应用程序或用例的其他命令所替代。</li></ul><h1 id="c5bc" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak"> 9。参考文献</strong></h1><ul class=""><li id="ae08" class="kg kh hh je b jf jg jj jk jn li jr lj jv lk jz kl km kn ko bi translated"><a class="ae kf" href="https://www.jenkins.io/doc/book/pipeline/syntax/#parameters" rel="noopener ugc nofollow" target="_blank">https://www.jenkins.io/doc/book/pipeline/syntax/#parameters</a></li><li id="925d" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated"><a class="ae kf" href="https://plugins.jenkins.io/git-parameter/" rel="noopener ugc nofollow" target="_blank">https://plugins.jenkins.io/git-parameter/</a></li><li id="e4a7" class="kg kh hh je b jf kp jj kq jn kr jr ks jv kt jz kl km kn ko bi translated">https://github.com/jenkinsci/ssh-steps-plugin#Configuration<a class="ae kf" href="https://github.com/jenkinsci/ssh-steps-plugin#Configuration" rel="noopener ugc nofollow" target="_blank"/></li></ul></div></div>    
</body>
</html>