<html>
<head>
<title>Power of Android Test Orchestrator for OOM (Out Of Memory) error while running espresso test cases</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">运行espresso测试案例时出现OOM(内存不足)错误</h1>
<blockquote>原文：<a href="https://medium.com/globant/oom-out-of-memory-error-while-running-espresso-test-cases-power-of-android-test-orchestrator-721ac7012f86?source=collection_archive---------3-----------------------#2020-06-07">https://medium.com/globant/oom-out-of-memory-error-while-running-espresso-test-cases-power-of-android-test-orchestrator-721ac7012f86?source=collection_archive---------3-----------------------#2020-06-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/63fe781373be2c7a0344ccf645fd628b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*jt6E1yKKs3GnfkYL2lMiNQ.gif"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Gif from: <a class="ae it" href="https://www.journaldev.com/23067/android-espresso" rel="noopener ugc nofollow" target="_blank">https://www.journaldev.com/23067/android-espresso</a></figcaption></figure><p id="2ce7" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当我们有超过150–200个为我们的应用程序编写的自动化测试用例，需要大约1到1.5小时才能完全运行时。在运行测试用例时，我们可能会面临OOM(内存不足)错误的问题。</p><p id="8196" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">基本上，当一个接一个地运行多个测试用例时，设备的堆大小不断增加，在某个点之后，可能会导致OOM错误。</p><p id="254b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您可以尝试多种解决方案，例如:</p><ol class=""><li id="4a44" class="js jt hh iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">增加RAM的内存</li><li id="da0e" class="js jt hh iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">按模块划分测试用例</li></ol><p id="c9ed" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi"> Android Test Orchestrator可以帮助我们解决这个问题</strong></p><p id="7d21" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在我们的项目中从头开始应用Android Test Orchestrator增加了我们自动化测试套件的可靠性。</p><p id="4b24" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Android Test orchestrator提供了一个标志，在每个测试用例完成后清除所有的包数据。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="277e" class="kp kq hh kl b fi kr ks l kt ku"><em class="kv">testInstrumentationRunnerArguments clearPackageData: 'true'</em></span></pre><p id="9ea1" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当您使用上述标志添加test orchestrator时，它会在每次测试后从设备的CPU和内存中删除所有共享状态。</p><p id="6a30" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果应用程序中出现应用程序崩溃，所有测试套件都会停止，而不会出现任何测试断言失败报告。当我们一起运行多个测试用例时，这种崩溃有时是令人头痛的。</p><p id="be16" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">因为Android Test Orchestrator创建了一个独立的工具实例。因此，如果有一个应用程序崩溃，那么这只会对当前的仪器崩溃，其他测试不会受到影响。</p><h1 id="c41e" class="kw kq hh bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">准备好实现Android Test Orchestrator了吗？</h1><p id="d749" class="pw-post-body-paragraph iu iv hh iw b ix lt iz ja jb lu jd je jf lv jh ji jj lw jl jm jn lx jp jq jr ha bi translated">我们将从Gradle启用android test orchestrator。</p><p id="cc0b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">将以下几行添加到Gradle文件中</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="8335" class="kp kq hh kl b fi kr ks l kt ku"><em class="kv">android {  <br/> defaultConfig {</em><br/><em class="kv">       ...</em><br/>       <em class="kv">testInstrumentationRunner "android.support.test.runner.AndroidJUnitRunner"</em><br/>       <em class="kv">testInstrumentationRunnerArguments clearPackageData: 'true'</em><br/><em class="kv">}<br/>testOptions {</em><br/> <em class="kv">execution 'ANDROID_TEST_ORCHESTRATOR'</em><br/><em class="kv"> }</em><br/><em class="kv">}</em> </span><span id="2ef8" class="kp kq hh kl b fi ly ks l kt ku"><em class="kv">dependencies {</em><br/><em class="kv">androidTestImplementation 'com.android.support.test:runner:1.0.2'</em><br/><em class="kv">androidTestUtil 'com.android.support.test:orchestrator:1.0.2' </em><br/><em class="kv">}</em></span></pre><p id="0623" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">注意:检查并使用上述依赖项的最新版本。</strong>如果你参考了android官方文档，你会注意到存在android依赖项。如果要添加androidx依赖项，请确保所有应用程序依赖项都应为androidx类型。</p><p id="a590" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">通过从命令行执行以下命令来运行Android Test Orchestrator:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="9279" class="kp kq hh kl b fi kr ks l kt ku"><em class="kv">./gradlew connectedCheck</em></span></pre><p id="ec43" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">注意:</strong>如果您使用的是最新版本，请更新您的项目等级，如下所示:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="5db1" class="kp kq hh kl b fi kr ks l kt ku"><em class="kv">dependencies {   </em> <br/><em class="kv"> classpath 'com.android.tools.build:gradle:</em>4.0.0<em class="kv">'</em> <br/><em class="kv">}</em></span></pre><p id="0ac9" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">并运行上面的命令。如果您在低于3.0的任何版本中使用Gradle build tools，您还必须更新项目的依赖设置。如果您的Gradle版本是旧的，您可能会发现错误“没有测试发现”。请更新你的简历。</p></div></div>    
</body>
</html>