<html>
<head>
<title>Creating a Chatbot with Square Checkout and Twilio Studio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建一个带有Square Checkout和Twilio Studio的聊天机器人</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/creating-a-chatbot-with-square-checkout-and-twilio-studio-750c8bddb1f5?source=collection_archive---------5-----------------------#2018-05-17">https://medium.com/square-corner-blog/creating-a-chatbot-with-square-checkout-and-twilio-studio-750c8bddb1f5?source=collection_archive---------5-----------------------#2018-05-17</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="cb94" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">了解如何创建一个机器人来与您的客户交谈并帮助销售！</h2></div><blockquote class="iw"><p id="1870" class="ix iy hh bd iz ja jb jc jd je jf jg dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae jh" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><figure class="jj jk jl jm jn jo er es paragraph-image"><div class="er es ji"><img src="../Images/c48be8b2a3a054908dc89bc464f670f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/1*SF6vn0-V5HeHijjeTuLzdg.gif"/></div></figure><h1 id="e132" class="jr js hh bd jt ju jv jw jx jy jz ka kb in kc io kd iq ke ir kf it kg iu kh ki bi translated">试试吧！文本(479)-888–5188与机器人交谈📲</h1><p id="7e1b" class="pw-post-body-paragraph kj kk hh kl b km kn ii ko kp kq il kr ks kt ku kv kw kx ky kz la lb lc ld jg ha bi translated">从语音命令到聊天机器人，消费者正在以全新的方式参与(和购买)事物。但这不仅仅是价值数十亿美元的科技公司的事情。新工具使得聊天机器人对于最小的开发者来说也是可行的，因此任何人都可以利用它来提供独特的购买和订购体验。让我们通过短信创建一个基本的基于对话的购买体验，您可以将它用作您自己的基于消息的购买体验的模板。</p><h1 id="c409" class="jr js hh bd jt ju jv jw jx jy jz ka kb in kc io kd iq ke ir kf it kg iu kh ki bi translated">💡这个想法💡</h1><p id="42b8" class="pw-post-body-paragraph kj kk hh kl b km kn ii ko kp kq il kr ks kt ku kv kw kx ky kz la lb lc ld jg ha bi translated">我们最初的目标是一个网上商店，广告一个号码，你可以发短信完成你的购物。当客户发送号码信息时，他们会收到一条脚本信息，其中包含他们可以购买的不同产品。从那里，他们可以选择一个项目，并获得一个链接到一个结帐页面，以完成购买。</p><figure class="lf lg lh li fd jo er es paragraph-image"><div class="er es le"><img src="../Images/1f9e55515e720ad23e3ff301b30c4387.png" data-original-src="https://miro.medium.com/v2/resize:fit:1014/format:webp/1*3ql_tSeNrQ18Y4AsUHx8EQ.png"/></div></figure><p id="67df" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">为此，我们将构建一个示例聊天机器人来帮助人们从我的虚拟商店Tristan's Awesome Hats订购假帽子。我们出售三种尺寸的帽子(小号、中号和大号)，我在我虚构的网站上宣传我的聊天机器人号码<code class="du lo lp lq lr b">(479)-888–5188</code>:这个博客帖子。</p><h1 id="9eca" class="jr js hh bd jt ju jv jw jx jy jz ka kb in kc io kd iq ke ir kf it kg iu kh ki bi translated">Twilio工作室</h1><p id="6301" class="pw-post-body-paragraph kj kk hh kl b km kn ii ko kp kq il kr ks kt ku kv kw kx ky kz la lb lc ld jg ha bi translated">我为这个项目选择了SMS，因为它是美国和世界上最普遍的通信形式之一，但它应该很容易移植到任何其他交易消息平台。Twilio碰巧发布了一款测试版的新产品，可能非常适合这种用例:<a class="ae jh" href="https://www.twilio.com/studio" rel="noopener ugc nofollow" target="_blank"> Twilio Studio </a>，这是一款可视化工具，利用了Twilio提供的许多其他消息和电话服务，但简化了设置和配置。这是一个很好的选择，因为许多发送和接收逻辑可以用studio流直接处理，不需要太多的开发时间。</p><h1 id="0118" class="jr js hh bd jt ju jv jw jx jy jz ka kb in kc io kd iq ke ir kf it kg iu kh ki bi translated">实施流程:</h1><h2 id="58d3" class="ls js hh bd jt lt lu lv jx lw lx ly kb ks lz ma kd kw mb mc kf la md me kh mf bi translated">扳机</h2><figure class="lf lg lh li fd jo er es paragraph-image"><div class="er es mg"><img src="../Images/b80aacc755f81587266e0ab9da9e4da0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/1*ESUpiq_lpqV-mgvdcU35GQ.png"/></div><figcaption class="mh mi et er es mj mk bd b be z dx">SMS’s will go through the flow, but voice calls and HTTP requests will fail by design.</figcaption></figure><p id="6ac7" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">Twilio Studio中的单个项目称为流。每个流都有一个触发器，在这种情况下，它将接收一条传入的SMS消息。这是我的客户如何进入与机器人的对话:通过发送我附加到这个流的号码。</p><h2 id="cc5f" class="ls js hh bd jt lt lu lv jx lw lx ly kb ks lz ma kd kw mb mc kf la md me kh mf bi translated"><strong class="ak">发送欢迎消息</strong></h2><figure class="lf lg lh li fd jo er es paragraph-image"><div class="er es ml"><img src="../Images/5a8dd1a9fb36154656c703f199b5b790.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*jScJ7Baan74mVgPFEen7Pw.png"/></div></figure><p id="aa9f" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">客户发送号码信息后，就是推销时间了！Tristan's Awesome Hats只卖一种帽子，但在欢迎词中，我会问一个基本问题来确认订单的尺寸。我将使用一个预制的<code class="du lo lp lq lr b">Send &amp; Wait For Reply</code>小部件来完成这项工作。连接到我的传入消息触发器，此小部件将向我的客户发送:</p><pre class="lf lg lh li fd mm lr mn mo aw mp bi"><span id="d854" class="ls js hh lr b fi mq mr l ms mt">Hey, I hope you are looking for an Awesome Hat! Would you like a small, medium, or large hat?</span></pre><h2 id="8711" class="ls js hh bd jt lt lu lv jx lw lx ly kb ks lz ma kd kw mb mc kf la md me kh mf bi translated">处理响应</h2><p id="4c41" class="pw-post-body-paragraph kj kk hh kl b km kn ii ko kp kq il kr ks kt ku kv kw kx ky kz la lb lc ld jg ha bi translated">发送消息并等待响应有三种可能的结果:得到回复、没有得到回复和消息失败。</p><ul class=""><li id="a7f0" class="mu mv hh kl b km lj kp lk ks mw kw mx la my jg mz na nb nc bi translated">如果消息失败，我会认为有可疑的事情在发生&amp;只要结束这个流。</li><li id="a4e9" class="mu mv hh kl b km nd kp ne ks nf kw ng la nh jg mz na nb nc bi translated">如果我没有得到回应，可能是我的顾客分心了，所以我会在一段时间后发送另一条消息，要求他们确认尺寸。</li></ul><figure class="lf lg lh li fd jo er es paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="er es ni"><img src="../Images/b2c91990ed58a0272adea6a6e848b4ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/1*2HKZ0mo8yARVaHHmf86iuA.png"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx">If your memories are leaking out of your head, you might want to buy two!</figcaption></figure><ul class=""><li id="3ffd" class="mu mv hh kl b km lj kp lk ks mw kw mx la my jg mz na nb nc bi translated">如果他们对此没有回应，那么我会认为他们不再感兴趣——我们可以结束流程。</li></ul><p id="5ece" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">如果我们确实得到了回复，无论是来自后续跟进，还是来自第一条消息，我们都需要弄清楚客户是否真的订购了一顶帽子，或者他们是否随机回复了一些东西。为了对消息进行一些基本的条件评估，我们可以使用基于… 小部件的<strong class="kl hi"> Split。这个小部件为我们提供了相当多的条件操作符，用于客户的消息正文，比如<code class="du lo lp lq lr b">equal to</code>、<code class="du lo lp lq lr b">contains</code>，甚至是一个正则表达式。在这种情况下，我们将使用三个“<strong class="kl hi">包含</strong>”转换来查找消息中的词语<code class="du lo lp lq lr b">small</code>、<code class="du lo lp lq lr b">medium</code>或<code class="du lo lp lq lr b">large</code>。</strong></p><figure class="lf lg lh li fd jo er es paragraph-image"><div class="er es nn"><img src="../Images/0c42409efd44eb23b2f15adf3591aeff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/format:webp/1*15KmZC0cfr2YSs4s5s4gWw.png"/></div></figure><p id="f6dd" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">如果消息中没有指定的大小，我们可以用另一个<strong class="kl hi">Send&amp;Wait For Reply Widget</strong>发送一个要求更清晰的响应:</p><pre class="lf lg lh li fd mm lr mn mo aw mp bi"><span id="d928" class="ls js hh lr b fi mq mr l ms mt">I was actually looking for a hat size. Tell me your size, either  "medium", "small" or "large".</span></pre><p id="6847" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">如果我们得到了一个尺寸，那么结帐魔术就该发生了。我们将为此使用一个新的小部件，即<strong class="kl hi"> Run函数</strong>。这将使我们的流程执行我们已经设置好的<a class="ae jh" href="https://www.twilio.com/functions" rel="noopener ugc nofollow" target="_blank"> Twilio函数</a>。</p><figure class="lf lg lh li fd jo er es paragraph-image"><div class="er es no"><img src="../Images/ad3c3db8de7123039060f88bbdfaf302.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*AIJJMiZReinNJuFIfh1ufg.gif"/></div><figcaption class="mh mi et er es mj mk bd b be z dx">Wow! Serverless really is easy!</figcaption></figure><h2 id="d81b" class="ls js hh bd jt lt lu lv jx lw lx ly kb ks lz ma kd kw mb mc kf la md me kh mf bi translated">结账功能</h2><p id="7685" class="pw-post-body-paragraph kj kk hh kl b km kn ii ko kp kq il kr ks kt ku kv kw kx ky kz la lb lc ld jg ha bi translated">Twilo函数是一个相当新的无服务器环境，可以用JavaScript编程。我们不需要建立一个只会等着别人发信息的服务器，Twilo可以处理更多的认证和运行时设置。我不会去创建函数，因为Twilio有很棒的文档，我在之前已经<a class="ae jh" rel="noopener" href="/square-corner-blog/text-for-your-sales-using-twilio-functions-and-square-e30d6537b720">谈到过它们，但是有一点一定要记住，你需要在</a><a class="ae jh" href="https://www.twilio.com/console/runtime/functions/manage" rel="noopener ugc nofollow" target="_blank"> Twilio控制台</a>中的&gt;配置下添加<code class="du lo lp lq lr b">square-connect</code>包，以访问<a class="ae jh" href="https://github.com/square/connect-javascript-sdk" rel="noopener ugc nofollow" target="_blank"> Square的Javascript SDK </a>。</p><figure class="lf lg lh li fd jo er es paragraph-image"><div class="er es np"><img src="../Images/ac72f8244ad3e2c4f252ea8238e70489.png" data-original-src="https://miro.medium.com/v2/resize:fit:572/format:webp/1*TAnmHp_mmA1LoezQOGUWqw.png"/></div></figure><p id="906b" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">Twilio Studio中的function小部件允许您将流中的额外数据传递给函数，所以我将传递消息的文本，该消息是客户指定的帽子尺寸和他们发送短信的号码，这样我就可以将它们与Square中的事务一起存储。</p><p id="ceb7" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">下面是我的完整函数代码:</p><figure class="lf lg lh li fd jo"><div class="bz dy l di"><div class="nq nr l"/></div></figure><p id="0e85" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">让我们来看一些不同的部分:</p><pre class="lf lg lh li fd mm lr mn mo aw mp bi"><span id="a933" class="ls js hh lr b fi mq mr l ms mt">var SquareConnect = require('square-connect');<br/>var Twilio = require('twilio');<br/>    <br/>var accessToken = context.accessToken;<br/>var locationId = context.locationId;<br/>    <br/>var messageBody = event.message;<br/>var number = event.number;</span></pre><p id="1312" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">在第一部分中，我们首先初始化Square的Javascript SDK和Twilio的，然后设置几个变量，稍后我们将在位置和访问令牌中使用这些变量。为了更好的安全性，这些凭证作为环境变量存储在我的函数的config页中。它们在运行时通过<code class="du lo lp lq lr b">context</code>参数传递给函数。</p><figure class="lf lg lh li fd jo er es paragraph-image"><div class="er es ns"><img src="../Images/030eca311f8f50be191e0ea3ce4fb81a.png" data-original-src="https://miro.medium.com/v2/resize:fit:894/format:webp/1*C1Ca8Vmwq6YDkwdS_uyW3Q.png"/></div><figcaption class="mh mi et er es mj mk bd b be z dx">My environment configuration for the checkout function.</figcaption></figure><p id="e13e" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">您可以看到，我正在使用我的沙盒访问令牌和位置，因为我不想实际上向任何人收费，也不必获得任何帽子来发货！我从Studio流中传入的数据也被分配给一对变量。</p><pre class="lf lg lh li fd mm lr mn mo aw mp bi"><span id="3fc4" class="ls js hh lr b fi mq mr l ms mt">var defaultClient = SquareConnect.ApiClient.instance;<br/>var oauth2 = defaultClient.authentications['oauth2'];<br/>oauth2.accessToken = accessToken;<br/>var checkoutApi = new SquareConnect.CheckoutApi();</span></pre><p id="5a15" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">在这里，我们完成SDK设置的其余部分，设置身份验证并初始化Square Checkout的代码。</p><pre class="lf lg lh li fd mm lr mn mo aw mp bi"><span id="bcea" class="ls js hh lr b fi mq mr l ms mt">var orderRequest ={<br/>  idempotency_key: new Date().getTime().toString(),<br/>  line_items: [{<br/>    quantity: '1',<br/>    base_price_money:{<br/>      amount: 1500,<br/>      currency: 'USD'<br/>    },<br/>    note:"Ordered via SMS: " + number,<br/>  }]<br/>};</span></pre><p id="1df0" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">这个<code class="du lo lp lq lr b">orderRequest</code>保存将为结帐表单创建的<a class="ae jh" href="https://docs.connect.squareup.com/articles/orders-api-overview" rel="noopener ugc nofollow" target="_blank">订单</a>的数据。此订单只有一个项目，我们是临时创建项目，而不是从我们的目录中指定一个项目。这个机器人的一个很好的扩展可能是从我的商店的项目目录中列出项目，或者让客户通过短信搜索他们想要的项目和变化。</p><pre class="lf lg lh li fd mm lr mn mo aw mp bi"><span id="4469" class="ls js hh lr b fi mq mr l ms mt">var itemName;<br/>if (messageBody.toLowerCase().includes("small")) {<br/>  itemName = "Awesome Hat (small)";<br/>} else if (messageBody.toLowerCase().includes("medium")) {<br/>  itemName = "Awesome Hat (medium)";<br/>} else if (messageBody.toLowerCase().includes("large")) {<br/>  itemName = "Awesome Hat (large)";<br/>} else {<br/>  console.error("Something has gone wrong!");<br/>  callback(null, twiml);<br/>}</span></pre><p id="2654" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">一个简单的if-else块动态设置顺序中项目的名称。如果客户使用<code class="du lo lp lq lr b">small</code>、<code class="du lo lp lq lr b">medium</code>或<code class="du lo lp lq lr b">large</code>指定了一个项目，那么他们应该会看到订单上有所反映。我们也可以很容易地使用这样的逻辑从时间目录中选择特定的项目。</p><p id="801d" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">设置好订单后，我们可以用一个幂等键和另一个要求送货地址的选项来充实结帐请求的其余部分，格式如下:</p><pre class="lf lg lh li fd mm lr mn mo aw mp bi"><span id="dc7e" class="ls js hh lr b fi mq mr l ms mt">var checkoutRequest = {<br/>      idempotency_key: new Date().getTime().toString(),<br/>      order: orderRequest,<br/>      ask_for_shipping_address: true<br/>    }</span></pre><p id="6d5f" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">然后，我们将结帐请求(包括上面创建的订单)传递给我们的<code class="du lo lp lq lr b">checkoutApi</code>对象的<code class="du lo lp lq lr b">createCheckout</code>方法，如下所示:</p><pre class="lf lg lh li fd mm lr mn mo aw mp bi"><span id="f242" class="ls js hh lr b fi mq mr l ms mt">checkoutApi.createCheckout(locationId, checkoutRequest)</span></pre><p id="fb63" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated"><code class="du lo lp lq lr b">createCheckout</code>函数(以及SDK中发出http请求的所有函数)返回一个<a class="ae jh" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" rel="noopener ugc nofollow" target="_blank">承诺</a>，帮助我们控制执行流程。我们希望向客户发送一条消息，其中包含一个支付产品的链接，但只有在我们创建了指向结账页面的链接之后。为此，我们在链接到<code class="du lo lp lq lr b">createCheckout()</code>调用的<code class="du lo lp lq lr b">then()</code>中包含了发送消息的逻辑:</p><figure class="lf lg lh li fd jo"><div class="bz dy l di"><div class="nq nr l"/></div></figure><p id="9229" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">因为这个函数运行在Twilio的环境中，它已经可以访问核心的Twilio功能，所以响应消息所需要的只是将一些带有消息体的TwiML传递给回调函数。顾客应该会收到一条带有结帐链接的消息，他们可以用它来购买我的一顶漂亮的帽子。</p><h2 id="8550" class="ls js hh bd jt lt lu lv jx lw lx ly kb ks lz ma kd kw mb mc kf la md me kh mf bi translated">完整的流程</h2><p id="8557" class="pw-post-body-paragraph kj kk hh kl b km kn ii ko kp kq il kr ks kt ku kv kw kx ky kz la lb lc ld jg ha bi translated">所有组件就绪后，以下是完整的工作室流程:</p><figure class="lf lg lh li fd jo er es paragraph-image"><div role="button" tabindex="0" class="nj nk di nl bf nm"><div class="er es nt"><img src="../Images/18682383bb3c00436bcff04f44a97429.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/format:webp/1*FoJ7lCXEOc46EIY3shFnig.png"/></div></div></figure><p id="6ab0" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">顾客可以与我的商店交谈，选择帽子尺寸，并通过舒适的信息完成购买。你自己试试！text<strong class="kl hi">(479)-888–5188</strong>来聊聊进入流量说不定还能买到假帽子！(别担心，你肯定不会被收费，而且你几乎肯定不会得到一顶帽子😉。)</p><p id="1a94" class="pw-post-body-paragraph kj kk hh kl b km lj ii ko kp lk il kr ks ll ku kv kw lm ky kz la ln lc ld jg ha bi translated">我希望你对这篇文章感兴趣！你可以通过<a class="ae jh" href="https://www.workwithsquare.com/developer-newsletter.html?channel=Online%20Social&amp;sqmethod=Blog" rel="noopener ugc nofollow" target="_blank">注册</a>我们每月的开发者通讯来保持联系。请尝试这一流程，尝试创建您的one messaging订购体验，并与Twitter上的<a class="ae jh" href="https://twitter.com/squaredev" rel="noopener ugc nofollow" target="_blank"> @SquareDev </a>或我们的<a class="ae jh" href="http://squ.re/slack" rel="noopener ugc nofollow" target="_blank"> Slack社区</a>分享。</p></div></div>    
</body>
</html>