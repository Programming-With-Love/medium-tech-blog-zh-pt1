<html>
<head>
<title>Automatically delete your Firebase Storage Files from Firestore with Cloud Functions for Firebase</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Firebase的云功能从Firestore中自动删除Firebase存储文件</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/automatically-delete-your-firebase-storage-files-from-firestore-with-cloud-functions-for-firebase-36542c39ba0d?source=collection_archive---------1-----------------------#2019-01-21">https://medium.com/google-developer-experts/automatically-delete-your-firebase-storage-files-from-firestore-with-cloud-functions-for-firebase-36542c39ba0d?source=collection_archive---------1-----------------------#2019-01-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div class="er es hf"><img src="../Images/309043869331031bc2984052eece9464.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/format:webp/1*ubAGP-gaON8X0aA2_xYv8w.png"/></div></figure><div class=""/><p id="85ac" class="pw-post-body-paragraph il im ho in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">举个例子，你有一个漂亮的Firebase应用程序，可以让你上传文件，这些文件保存在Firebase存储中，并把文件的路径写入Firestore文档或集合。然后，用户将能够从您的应用程序中查看这些文件。</p><p id="f336" class="pw-post-body-paragraph il im ho in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">然而，也有用户删除这些文档或集合的用例，但这不会删除存储中的文件。因此，如果你不做一些家务，你的储存很快就会用完。</p><h1 id="34d2" class="jj jk ho bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">云功能可助您一臂之力！</h1><p id="9159" class="pw-post-body-paragraph il im ho in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">Firebase的云函数允许您编写可以通过触发器执行的代码，即HTTP触发器和后台触发器。使用云功能，您可以处理云Firestore中的事件，比如每次创建、更新或删除文档时。让我们进一步探索我们的用例。</p><h1 id="131f" class="jj jk ho bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">现在是示范时间！</h1><p id="a274" class="pw-post-body-paragraph il im ho in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">这里我有一个Cloud Firestore，收藏名为<code class="du km kn ko kp b">posts</code>。每个post都有一个<code class="du km kn ko kp b">caption</code>和一个<code class="du km kn ko kp b">images</code>数组，其中基本上包含了存储桶的图像路径。这样，当我在应用程序上加载内容时，我可以使用路径来获取图像并显示它们。</p><figure class="kr ks kt ku fd hj er es paragraph-image"><div class="er es kq"><img src="../Images/299331057d87b76204a0b0781ed62d5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*maxohJ56uSKD4Knri_tIrw.png"/></div><figcaption class="kv kw et er es kx ky bd b be z dx">Cloud Firestore schema</figcaption></figure><figure class="kr ks kt ku fd hj er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es kz"><img src="../Images/b7d7a48dece884b920f5620e4d689e31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zmKUnwWYK_ADHpjLpgP35A.png"/></div></div><figcaption class="kv kw et er es kx ky bd b be z dx">Firebase Storage bucket structure</figcaption></figure><figure class="kr ks kt ku fd hj er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es le"><img src="../Images/acc8c40951173d75e2ebd2dd18b2a85e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ichcMpa42GL5dkTQWSk1Qg.png"/></div></div><figcaption class="kv kw et er es kx ky bd b be z dx">Finally here’s how the app looks like!</figcaption></figure><h1 id="3a67" class="jj jk ho bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">删除文件夹中的所有文件</h1><p id="42d0" class="pw-post-body-paragraph il im ho in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">当用户点击删除按钮时，我们实际上发出了一个<code class="du km kn ko kp b">documentReference.delete()</code>来删除Firestore上的帖子。这本身不会对存储中的文件产生任何影响。为了实现这一点，让我们编写一个云函数来删除与这篇文章完全相关的文件夹:</p><p id="951e" class="pw-post-body-paragraph il im ho in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hp">注意:这是用打字稿写的。</strong></p><figure class="kr ks kt ku fd hj"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="6b64" class="pw-post-body-paragraph il im ho in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">当<code class="du km kn ko kp b">document("posts/{postId}")</code>上有<code class="du km kn ko kp b">onDelete()</code>删除时，我们触发后台功能。<code class="du km kn ko kp b">postId</code>是被用户删除的文档的键，我们可以从<code class="du km kn ko kp b">context.params</code>中获取。</p><p id="8054" class="pw-post-body-paragraph il im ho in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">我们可以使用<strong class="in hp"> Firebase Admin SDK </strong>中提供的<strong class="in hp"> Google云存储API</strong>来访问存储桶并删除文件，而不是遍历您的<code class="du km kn ko kp b">post.images</code>属性来逐个删除文件。<code class="du km kn ko kp b"><strong class="in hp">prefix</strong></code>允许你指定路径，以便它只删除你想要的文件，因为我们的存储结构利用<code class="du km kn ko kp b">postId</code>来轻松地分隔后图像。</p><blockquote class="lh li lj"><p id="a189" class="il im lk in b io ip iq ir is it iu iv ll ix iy iz lm jb jc jd ln jf jg jh ji ha bi translated">附注:请注意，我们在初始化时不需要向Firebase Admin SDK提供凭证，因为云Firestore和实时数据库触发器已经有足够的凭证，不需要额外的设置。这不是很棒吗？</p></blockquote><h1 id="5666" class="jj jk ho bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">删除文件夹中的一些文件</h1><p id="6941" class="pw-post-body-paragraph il im ho in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">有时，用户只想删除文档中的一些图像，而不是全部图像，这些文件也应该从存储器中删除:</p><p id="03f6" class="pw-post-body-paragraph il im ho in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">注意:这是用打字稿写的。</p><figure class="kr ks kt ku fd hj"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="452d" class="pw-post-body-paragraph il im ho in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">在这里，我们实际上是在听<code class="du km kn ko kp b">onUpdate()</code>，因为我们已经用较少的照片更新了<code class="du km kn ko kp b">images</code>字段。<code class="du km kn ko kp b"><strong class="in hp">onUpdate</strong></code> <strong class="in hp">为您提供</strong> <strong class="in hp">更新发生前和更新后的数据快照。</strong>通过这种方式，您可以比较并找出哪些图像被删除，然后遍历以准备删除数据。最后<code class="du km kn ko kp b">Promise.all</code>让我们确保每个图像删除的所有承诺都已解决。</p><blockquote class="lh li lj"><p id="072f" class="il im lk in b io ip iq ir is it iu iv ll ix iy iz lm jb jc jd ln jf jg jh ji ha bi translated">附注:如果您有大量图像要删除，我会创建一个名为images的集合，而不是使用一个字符串数组来保存所有这些图像，这样我就可以轻松地连接<code class="du km kn ko kp b">onDelete</code>事件处理程序来监听<code class="du km kn ko kp b">posts/{postId}/images/{imageId}</code>以获得要删除的确切的<code class="du km kn ko kp b">imageId</code>图像，这样我就不需要编写更多的逻辑来判断哪些图像被删除了。</p></blockquote><h1 id="d527" class="jj jk ho bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">演示时间！</h1><p id="4ff8" class="pw-post-body-paragraph il im ho in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">请观看此视频，了解实际运行的代码。</p><figure class="kr ks kt ku fd hj"><div class="bz dy l di"><div class="lo lg l"/></div></figure><h1 id="d363" class="jj jk ho bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">结论</h1><p id="67bc" class="pw-post-body-paragraph il im ho in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">Firebase的云功能提供了创建一个真正的无服务器应用程序所需的东西，并扩展了在Firebase中做更多事情的可能性。我强烈建议您查阅<a class="ae lp" href="https://firebase.google.com/docs/functions/" rel="noopener ugc nofollow" target="_blank">文档</a>并了解您可以利用Firebase的云功能实现什么。</p></div></div>    
</body>
</html>