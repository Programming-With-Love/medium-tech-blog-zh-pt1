<html>
<head>
<title>Containerization at Pinterest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pinterest的集装箱化</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/containerization-at-pinterest-92295347f2f3?source=collection_archive---------0-----------------------#2017-09-08">https://medium.com/pinterest-engineering/containerization-at-pinterest-92295347f2f3?source=collection_archive---------0-----------------------#2017-09-08</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="bded" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Lida Li，Rodrigo menez es &amp; Yong Wen Xu | Pinterest工程师，云计算管理平台&amp; SRE</p><p id="4a61" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在过去的一年里，Pinterest的云管理平台和站点可靠性工程团队一直专注于将我们的工作负载从EC2实例转移到Docker容器。到目前为止，我们已经迁移了超过一半的无状态服务，包括100%的API。这篇博文分享了我们在整个过程中的学习和经历。</p><p id="ce75" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">近年来，像Mesos和Kubernetes这样的Docker和容器编排技术已经成为我们行业的热门话题，展示了构建基于容器的平台的明显优势。对我们来说，实施容器平台可以带来以下好处:</p><ul class=""><li id="9e56" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">通过消除学习像Puppet这样的工具的需要来提高开发速度。</li><li id="a2aa" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">为更好的可靠性提供不变的基础设施。</li><li id="34ce" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">提高我们升级底层基础设施的灵活性。</li><li id="a98f" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">提高基础设施的效率。</li></ul><p id="18e3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们在2016年初开始了我们的调查、评估和测试。最初，我们计划不仅将我们的工作负载迁移到Docker容器，而且同时通过采用容器协调器技术以多租户方式运行它们。随着过程的发展，我们决定采取分阶段的方法。我们首先将我们的服务转移到Docker，以释放在Puppet上花费的工程时间，并拥有一个不可变的基础设施。目前，我们正在采用容器编排技术，以更好地利用资源和利用开源容器编排技术。</p><h2 id="89f4" class="jq jr hh bd js jt ju jv jw jx jy jz ka ip kb kc kd it ke kf kg ix kh ki kj kk bi translated">迁移前</h2><p id="d971" class="pw-post-body-paragraph ie if hh ig b ih kl ij ik il km in io ip kn ir is it ko iv iw ix kp iz ja jb ha bi translated">在容器化之前，Pinterest上的工作服务是如下图所示进行创作和启动的:</p><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es kq"><img src="../Images/ed2caf6142161ae2856926bf7ed6777d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ISeB2be5MFuUzLT-."/></div></div></figure><ul class=""><li id="2142" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">有一个基本的Amazon机器映像(AMI ),带有操作系统、公共共享包和已安装的工具。对于一些服务，主要是这些大型复杂的服务，也有一个特定于服务的AMI，它建立在包含服务依赖包的基础AMI之上。</li><li id="d628" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">除此之外，我们有两个部署工具:Puppet和<a class="ae lc" rel="noopener" href="/@Pinterest_Engineering/open-sourcing-teletraan-a-code-deployment-system-198372cb6dd6"> Teletraan </a>。Puppet用于提供cron作业、服务发现、指标和日志记录等基础组件及其配置文件。Teletraan部署了我们的生产服务代码和一些机器学习模型。</li><li id="d28e" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">这些服务由包括Monit、Supervisor和Upstart在内的各种流程经理运行。</li></ul><p id="9ce2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，这一过程有几个难点:</p><ul class=""><li id="22b5" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">工程师需要参与AMI构建，并学习这些流程管理器的各种配置语言，包括Puppet。</li><li id="cc16" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">傀儡更改可以在没有精细粒度控制的情况下随时应用于主机。</li><li id="84b5" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">随着时间的推移，主机上的环境发生了变化，导致了操作问题。</li></ul><h2 id="1e00" class="jq jr hh bd js jt ju jv jw jx jy jz ka ip kb kc kd it ke kf kg ix kh ki kj kk bi translated">迁移</h2><p id="f506" class="pw-post-body-paragraph ie if hh ig b ih kl ij ik il km in io ip kn ir is it ko iv iw ix kp iz ja jb ha bi translated">由于规模和复杂性，迁移基础设施对Pinterest这样的公司来说是一项挑战。编程语言的差异、跨技术堆栈的技术依赖性、对性能和可用性的严格要求以及技术债务都需要考虑在内。</p><p id="46c2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的容器化始于CMP和SRE团队拥有的一些小型、非关键的应用程序。同时，我们开始在他们的开发和测试环境中将关键服务放入容器中。以此为基础，围绕容器化的努力开始在应用程序中得到更广泛的采用。</p><p id="8b95" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们迁移的第一批应用程序之一是我们的主要API系列。我们认为，尽早迁移我们最大、最复杂的系统之一将有助于我们从一开始就发现并解决相当多的问题。这一过程帮助我们创建并巩固了更广泛的基础设施所需的一套更完整的工具。它还降低了将来花费时间重写工具以包含其他特性的风险。</p><p id="06af" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们早期最关心的是性能。虽然Docker网络非常适合开发，但众所周知，它会对生产环境中的性能产生负面影响。这促使我们决定使用主机网络，而不依赖Docker网络。我们运行了几个测试，以确保不存在会阻止我们的API在容器中运行的问题。</p><p id="fdba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于API迁移，我们确保有一套全面的指标来比较在容器内和容器外运行。这一过程帮助我们找到了漏洞，使得监控Docker中运行的内容和主机本身上运行的内容无法区分。它还帮助我们从测试的早期阶段发现由转换过程引起的问题，并最终给了我们推进生产所需的信心。迁移过程在不到一个月的时间内就完成了，同时我们还在监控回归或问题。幸运的是，这是一个相当平静的过程，没有造成任何中断。</p><h2 id="9bdf" class="jq jr hh bd js jt ju jv jw jx jy jz ka ip kb kc kd it ke kf kg ix kh ki kj kk bi translated">迁移后</h2><p id="67f2" class="pw-post-body-paragraph ie if hh ig b ih kl ij ik il km in io ip kn ir is it ko iv iw ix kp iz ja jb ha bi translated">在我们使用API舰队作为基础构建了原语之后，我们的容器化工作继续进行。我们已经能够利用为支持我们最复杂的应用程序之一而创建的工具来支持其他应用程序的迁移。</p><p id="f89d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的docker平台现在看起来如下:</p><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="er es ld"><img src="../Images/b7c2af6cc8cfb6d82ec13bcc12e0efec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*stuQlWfGNOEjOaJ5."/></div></div></figure><ul class=""><li id="eef8" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">所有集装箱服务只有一个AMI。所有特定于服务的依赖项都放在这个容器中。除了服务容器之外，所有支持组件(服务发现、度量、日志、服务代理等。)在Docker容器中运行，与服务容器一起工作。</li><li id="8755" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">工程师们仍然使用Teletraan接口来部署他们的容器，但它现在可以与Telefig一起工作，这是一个我们构建的工具，用于启动和停止容器以及管理容器之间的依赖关系。</li><li id="bb3a" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">Docker容器引擎现在扮演着进程管理器的角色来监控和重启容器。引擎的重新启动策略设置为除非-停止，并且-live-restore开关打开。</li></ul><p id="6631" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面是我们如何运行这些Docker容器的更详细的介绍:</p><ul class=""><li id="8f94" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">我们所有的容器现在都在— net=host中运行，这为我们提供了本地网络性能。我们的AWS依赖项(如IAM角色和安全组)也可以在这种模式下工作，无需任何代码更改。</li><li id="9015" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">Amazon ECR是我们的主要Docker注册表。我们托管一个从ECR复制的辅助Docker注册表，为生产提供高可用性。</li><li id="74c8" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">工程师们在一个YAML文件中描述这项服务，该文件的语法与Docker compose文件非常相似。它包含一组特定于Pinterest的原语，这样开发人员就不需要编写冗长的配置。</li><li id="90ab" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">每个容器的标签格式都是[Name]:[git commit hash],代表一个惟一的构建。</li><li id="d045" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">我们在Ubuntu上运行我们自己定制的最新Linux内核。</li><li id="bf30" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">我们从Docker 1.11开始，现在在Docker 17.03.1-ce上运行我们的船队。</li></ul><h2 id="e4d5" class="jq jr hh bd js jt ju jv jw jx jy jz ka ip kb kc kd it ke kf kg ix kh ki kj kk bi translated">下一步是什么</h2><p id="7bb3" class="pw-post-body-paragraph ie if hh ig b ih kl ij ik il km in io ip kn ir is it ko iv iw ix kp iz ja jb ha bi translated">我们已经完成了服务容器化的第一阶段目标。在下一阶段，我们将采用容器编排并构建一个多租户集群，为长期运行的服务和批处理作业提供一个统一的接口。</p><figure class="kr ks kt ku fd kv er es paragraph-image"><div class="er es le"><img src="../Images/c2e708437034ef3a06c845ca00e483ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:290/format:webp/1*VS-SIyipZqIIfQYxAvva3A.png"/></div></figure></div><div class="ab cl lf lg go lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ha hb hc hd he"><p id="e00b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lm">鸣谢:Pinterest的许多工程师共同致力于构建容器平台</em>，<em class="lm">包括Jayme Cox、毛庚、、、Saurabh Joshi、、Ruth Wong和Suli Xu。宋宝刚负责Pinterest容器化的设计和初期工作。</em></p></div></div>    
</body>
</html>