<html>
<head>
<title>Unified Flink Source at Pinterest: Streaming Data Processing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pinterest的统一Flink源代码:流数据处理</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/unified-flink-source-at-pinterest-streaming-data-processing-c9d4e89f2ed6?source=collection_archive---------4-----------------------#2021-07-15">https://medium.com/pinterest-engineering/unified-flink-source-at-pinterest-streaming-data-processing-c9d4e89f2ed6?source=collection_archive---------4-----------------------#2021-07-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="a712" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">鲁牛和陈琴|软件工程师，流处理平台团队</p><p id="2262" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了更好地服务于Pinners、创作者和广告商，Pinterest利用Flink作为其流处理引擎。Flink是一个在数据流上进行状态计算的数据处理引擎。它提供了丰富的流API、精确一次支持和状态检查点，这些对于构建稳定且可扩展的流应用程序至关重要。如今，在Alibaba、网飞和优步等公司的任务关键型使用情形中，都广泛使用了Flink。</p><p id="919c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Xenon是Pinterest基于Flink的流媒体处理平台。我们的使命是构建一个可靠、可扩展、易于使用和高效的流平台，以实现数据驱动的产品和及时的决策。该系统包括:</p><ul class=""><li id="6e61" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">可靠且最新的Flink计算引擎</li><li id="cd94" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">改进了Pinterest在流应用程序开发方面的开发速度</li><li id="4694" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">平台可靠性和效率</li><li id="8120" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">安全性和合规性</li><li id="648f" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">文档、用户教育和社区</li></ul><p id="55ed" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Xenon促成了几个关键使用情形，包括:</p><ul class=""><li id="36d2" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">广告实时摄取、支出和报告—根据预算限制实时计算支出，以快速调整预算节奏并为广告商更新更及时的报告结果。</li><li id="fca0" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">快速信号—在内容创建后让内容信号快速可用，并在ML管道中使用这些信号以获得定制的用户体验。</li><li id="7b02" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">实时信任与安全—尽可能缩短内容创建时间，从而降低不安全内容的级别。</li><li id="f86b" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">内容激活—将新鲜的创建者内容和表面参与度指标分发给创建者，以便他们可以在最小的反馈延迟内优化其内容。</li><li id="4199" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">购物—通过近乎实时地更新产品元数据，提供值得信赖的购物产品体验。</li><li id="462f" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">实验—准确地向工程师交付指标，以加快实验设置、验证和评估。</li></ul><h1 id="09a8" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">流数据架构</h1><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es ko"><img src="../Images/31f7c9da0fe467c8d7db602499c9d219.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KaFBwqOB56IvT6M8"/></div></div><figcaption class="la lb et er es lc ld bd b be z dx">Figure 1: the setup of streaming data infrastructure at Pinterest</figcaption></figure><ol class=""><li id="8a66" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb le ji jj jk bi translated">辛格是一家高性能的日志代理公司，他将服务主机的日志消息上传到卡夫卡的<a class="ae lf" href="https://www.confluent.io/blog/running-kafka-at-scale-at-pinterest/" rel="noopener ugc nofollow" target="_blank">。Singer支持多种日志格式，并保证日志消息至少传递一次。</a></li><li id="1cec" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb le ji jj jk bi translated">Merced是Secor的一个变种，它把数据从卡夫卡移到S3。Merced保证从卡夫卡到S3只有一次的消息持久性。</li><li id="0f27" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb le ji jj jk bi translated">我们的大多数Flink应用程序从卡夫卡消费，并根据不同的使用情形输出到卡夫卡、Druid或RocksStore。</li></ol><p id="3207" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">尽管我们所有的用例都使用来自卡夫卡的数据，但仅仅访问卡夫卡并不能满足所有的用户需求:</p><ol class=""><li id="6909" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb le ji jj jk bi translated">一些用例需要访问历史数据；不过，卡夫卡的数据保留时间很短，从3天到不到8小时。</li><li id="3722" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb le ji jj jk bi translated">我们要求所有用例在投入生产之前都要经过负载测试。通过倒带Kafka来模拟负载是不可伸缩的。</li><li id="c1d3" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb le ji jj jk bi translated">通过Kafka重放历史数据是一种选择，但这增加了运营成本，基础设施成本增加了20倍。</li></ol><p id="ef90" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">多亏了默塞德，我们手头有了历史数据。因此，我们能够提供一个单一的API，将历史数据和实时数据连接起来，这就是无限日志的概念。用户能够查找任何偏移量或时间戳，而不用担心哪个存储系统保存数据。</p><p id="53e4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这种设计带来了几个好处:</p><ol class=""><li id="d213" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb le ji jj jk bi translated">在Merced(又名有界流)和Kafka(又名无界流)中，主题的编码和模式是相同的。不需要额外的努力来将它们转换成一致的视图。</li><li id="4f5f" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb le ji jj jk bi translated">Merced在S3上存储数据，并保留原始的事件排序和分区，只需很少的基础架构成本。通过Merced重放数据就像从卡夫卡那里读取原始数据一样。</li></ol><h1 id="8c04" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">统一源中的功能</h1><h2 id="6d5a" class="lg jr hh bd js lh li lj jw lk ll lm ka ip ln lo ke it lp lq ki ix lr ls km lt bi translated">一个用于实时和历史数据的API</h2><p id="832b" class="pw-post-body-paragraph ie if hh ig b ih lu ij ik il lv in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated">以下是实施的简要总结:</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es lz"><img src="../Images/6be9bd6acc68bfc33dc2d643406630d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_g99k9h3V6pJ5I_K"/></div></div><figcaption class="la lb et er es lc ld bd b be z dx">Figure 2: Unified Source Implementation</figcaption></figure><ol class=""><li id="631a" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb le ji jj jk bi translated">UnifiedSource扩展了<a class="ae lf" href="https://ci.apache.org/projects/flink/flink-docs-master/api/java/org/apache/flink/streaming/api/functions/source/RichParallelSourceFunction.html" rel="noopener ugc nofollow" target="_blank">RichParallelSourceFunction</a>。每个子任务运行UnifiedSource的一个实例，每个实例同时启动FlinkKafkaConsumer和MercedFileSource。FlinkKafkaConsumer由Flink开箱提供；MercedFileSource能够将Merced输出转换为流格式。</li><li id="1d9e" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb le ji jj jk bi translated">在分区调度过程中，保证单个子任务中的FlinkKafkaConsumer和MercedFileSource得到属于同一个分区的数据，支持从读取文件到Kafka的无缝过渡。</li><li id="4d55" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb le ji jj jk bi translated">为了获取属于同一个分区的所有文件，MercedSource监听了一个由Merced Notification system发布的Kafka主题。这样，我们能够处理迟到的事件。</li><li id="bd3d" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb le ji jj jk bi translated">Merced输出按小时分区，文件命名对Kafka的创建时间和分区进行编码。因此，MercedFileSource能够读取文件并重新创建相同的事件排序和分区。</li><li id="de62" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb le ji jj jk bi translated">UnifiedSource遵循Flink最佳实践<a class="ae lf" href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/event_timestamps_watermarks.html#timestamps-per-kafka-partition" rel="noopener ugc nofollow" target="_blank">从Kafka </a>生成水印。API强制用户提供一个时间戳提取器，KafkaSource使用它从源代码生成水印。通过这种方式，我们标准化了Flink应用中的水印生成。类似地，MercedFileSource将多个分区的水印更新组合成一个水印流。</li><li id="750a" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb le ji jj jk bi translated">Merced在Kafka中观察迟到的事件，并写回已经被UnifiedSource使用的先前的数据分区。</li><li id="3100" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb le ji jj jk bi translated">有时，跨多个Merced分区的事件时间偏差会导致不断增长的水印间隙，从而导致下游检查点压力。我们使用<a class="ae lf" href="https://issues.apache.org/jira/browse/FLINK-10887" rel="noopener ugc nofollow" target="_blank"> GlobalAggregateManager </a>实现了跨子任务的水印同步，以将水印保持在全局范围内。</li></ol><h2 id="c1b2" class="lg jr hh bd js lh li lj jw lk ll lm ka ip ln lo ke it lp lq ki ix lr ls km lt bi translated">流量控制和资源同步</h2><p id="88e0" class="pw-post-body-paragraph ie if hh ig b ih lu ij ik il lv in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated">与处理无界流不同，处理和重新处理历史数据需要额外的功能，如流量控制和源同步，以实现稳定的操作。</p><p id="a16c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里有一个简化的用例来解释这个问题:</p><p id="7500" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一个产品团队希望近乎实时地了解平台上的受众如何查看最近七天发布的pin。因此，产品团队使用XenonUnifiedSource构建了一个Flink作业，以获取已发布的Kafka日志图片和Kafka日志视图。为了让Flink作业发布有意义的信息，我们使用一个统一的源来按顺序提取最近七天发布的pin。</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es ma"><img src="../Images/f177ac5e7995a8da360a39354c9a7d7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jYN5YLdjOtyCvhseLuXktg.png"/></div></div></figure><p id="4988" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里使用filesource或Kafka source有两个问题:</p><p id="7a94" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">视图主题比发布的pin大得多，因此它会消耗大量带宽并减慢发布的pin的回填。因为管道是以事件时间的方式编写的，这导致了内部连接操作符中低水位线进程的减慢。随着时间的推移，越来越多的事件被缓冲在内部连接中，等待被清除。这会导致背压和检查点故障。</p><p id="c345" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了应对流量控制问题，我们开发了每个主题级别的速率限制。大头针的视图被限制在一个较低的比率，并为发布的图片主题快速前进腾出空间。</p><p id="0d47" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">视图主题应该“等待”，直到整整七天的pin发布完成。否则，低匹配率几乎是肯定的。在Flink术语中，在图片主题水印视图超过“当前”之前，来自已发布pin的水印应该前进到“当前”(启动作业的时间)</p><p id="3293" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">针对同步问题，我们开发了基于<a class="ae lf" href="https://www.mpich.org/static/docs/latest/www3/MPI_Allreduce.html" rel="noopener ugc nofollow" target="_blank"> allreduce </a>的水印同步实现，并定期更新每个主题的速率限制器阈值。当来自所有子任务的水印达到“当前”时，图片源ratelimiter的视图仅被授予提取Kafka主题的配额。</p><h1 id="338e" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">使用UnifiedSource构建可靠的Flink应用</h1><p id="6725" class="pw-post-body-paragraph ie if hh ig b ih lu ij ik il lv in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated">UnifiedSource的好处不仅限于轻松访问实时和历史数据。它还提供了其他好处:</p><ol class=""><li id="bdcb" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb le ji jj jk bi translated">UnifiedSource提供了开箱即用的功能，如反序列化器、水印生成、流量控制和损坏的消息度量。这使得Flink开发人员可以专注于业务逻辑实现。</li><li id="8f36" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb le ji jj jk bi translated">用户现在能够通过加载固定数据集来生成确定性结果，并根据代码更改或框架升级来验证正确性。</li><li id="e765" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb le ji jj jk bi translated">在Pinterest，关键的Flink作业在进入生产之前需要经过负载测试。通过UnifiedSource模拟流量负载比倒带Kafka偏移量更具可扩展性和成本效益。</li></ol><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es mb"><img src="../Images/2855b0c02f3466868731d0df6f28dd80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g-_YWlHFmMrytcXG"/></div></div><figcaption class="la lb et er es lc ld bd b be z dx"><em class="mc">(simulating large load through UnifiedSource)</em></figcaption></figure><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es md"><img src="../Images/7961630ca940c0969358ca23f68cd732.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ciDjrdPS7xfHDNBN"/></div></div><figcaption class="la lb et er es lc ld bd b be z dx"><em class="mc">watermark change when transferring from file to Kafka</em></figcaption></figure><h1 id="5d53" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">我们在招人</h1><p id="cc8e" class="pw-post-body-paragraph ie if hh ig b ih lu ij ik il lv in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated">我们一直在发展我们的流处理平台，未来会有有趣的挑战和机遇。如果您有兴趣与我们一起应对大数据挑战，<a class="ae lf" href="https://www.pinterestcareers.com/#utm_source=medium&amp;utm_medium=blog-article-link&amp;utm_campaign=niu-qin-july-15-2021" rel="noopener ugc nofollow" target="_blank">加入我们</a>！</p><h1 id="83c8" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">感谢</h1><p id="ee77" class="pw-post-body-paragraph ie if hh ig b ih lu ij ik il lv in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated">感谢陈汉娜和张昂的评论。感谢Divye Kapoor和Karthik Anantha Padmanabhan在近实时星系框架中的集成。感谢我们的客户团队、广告测量、核心产品索引、内容质量，感谢早期采用和反馈。感谢全流处理平台团队的支持。</p><h1 id="543b" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">参考</h1><p id="cf15" class="pw-post-body-paragraph ie if hh ig b ih lu ij ik il lv in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated"><a class="ae lf" href="https://github.com/pinterest/singer" rel="noopener ugc nofollow" target="_blank">GitHub:Pinterest/歌手</a></p><p id="c0bb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae lf" href="https://engineering.fb.com/core-data/logdevice-a-distributed-data-store-for-logs/" rel="noopener ugc nofollow" target="_blank"> LogDevice:日志的分布式数据存储</a></p><p id="c455" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae lf" href="https://netflixtechblog.com/keystone-real-time-stream-processing-platform-a3ee651812a" rel="noopener ugc nofollow" target="_blank"> Keystone实时流处理平台|网飞科技博客</a></p><p id="c7da" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae lf" href="https://netflixtechblog.com/distributed-time-travel-for-feature-generation-389cccdd3907" rel="noopener ugc nofollow" target="_blank">用于特征生成的分布式时间旅行|网飞科技博客</a></p><p id="d8dd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae lf" href="https://eng.uber.com/kappa-architecture-data-stream-processing/" rel="noopener ugc nofollow" target="_blank">为实时数据流处理设计生产就绪的Kappa架构</a></p><p id="e0ef" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae lf" href="https://aws.amazon.com/blogs/big-data/build-and-run-streaming-applications-with-apache-flink-and-amazon-kinesis-data-analytics-for-java-applications/" rel="noopener ugc nofollow" target="_blank">使用Apache Flink和Amazon Kinesis Data Analytics for Java Applications构建和运行流媒体应用</a></p><p id="afed" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae lf" href="https://cwiki.apache.org/confluence/display/FLINK/FLIP-134%3A+Batch+execution+for+the+DataStream+API" rel="noopener ugc nofollow" target="_blank"> FLIP-134:数据流API的批处理执行</a></p></div></div>    
</body>
</html>