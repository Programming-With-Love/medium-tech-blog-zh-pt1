<html>
<head>
<title>Container Registry — pushing and storing containers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">集装箱登记-推动和储存集装箱</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/container-registry-pushing-and-storing-containers-1cb8005198e5?source=collection_archive---------0-----------------------#2022-05-12">https://medium.com/oracledevs/container-registry-pushing-and-storing-containers-1cb8005198e5?source=collection_archive---------0-----------------------#2022-05-12</a></blockquote><div><div class="dt gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ew ey ig ih ii ij es et paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="es et if"><img src="../Images/cd4cd4583aae0dfdfd72fbd71d2896dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7R5YVfe5Q5PzOPaJYk5hUg.png"/></div></div></figure><p id="1762" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您想要管理可部署的资源时，容器注册中心就像Kubernetes服务一样重要。该注册中心可以是公共Docker存储库或其他东西。在大多数情况下，注册中心需要是私有的，这样您就不会将您的产品资产暴露给潜在的外部篡改。因此，我们需要一个服务，比如甲骨文的容器注册OCIR。</p><p id="c22c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本博客的其余部分将介绍如何将您构建的容器推入OCIR，以及如果您对注册中心如何工作做出假设，可能会使用户出错的“陷阱”。</p><h1 id="ea15" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">构建容器</h1><p id="75fd" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">让我们假设您正在本地构建您的微服务或审查第三方服务以供使用。在这两种情况下，您都希望手动地将您的资产推入OCIR，而不是让自动化的构建管道为您完成。</p><p id="45fb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了更容易看到发生了什么，我们可以利用来自<a class="ae jo" href="https://github.com/oracle-devrel" rel="noopener ugc nofollow" target="_blank"> Oracle的Github repo </a>的一些代码(例如<a class="ae jo" href="https://github.com/mp3monster/oci-arch-oke-graphql/tree/main/ref-data-svc" rel="noopener ugc nofollow" target="_blank">正在开发的这个</a>)或者你可以使用经典的hello world容器(<a class="ae jo" href="https://github.com/whotutorials/docker-busybox-hello-world/blob/master/Dockerfile" rel="noopener ugc nofollow" target="_blank">https://Github . com/who tutorials/docker-busybox-hello-world/blob/master/docker file</a>)。在本文的其余部分，我们将假设这是为Oracle架构中心提供的代码开发的代码。</p><pre class="ks kt ku kv fe kw kx ky kz aw la bi"><span id="f405" class="lb jq hi kx b fj lc ld l le lf">docker build -t event-data-svc .</span></pre><p id="e9f3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将在本地创建一个容器，我们可以看到使用以下命令列出的容器:</p><pre class="ks kt ku kv fe kw kx ky kz aw la bi"><span id="03cd" class="lb jq hi kx b fj lc ld l le lf">docker images</span></pre><figure class="ks kt ku kv fe ij es et paragraph-image"><div class="es et lg"><img src="../Images/b089d82bc2f895e87e91872a4e347596.png" data-original-src="https://miro.medium.com/v2/resize:fit:272/0*OYsqhCorbDxYNNVY"/></div></figure><h1 id="ebfd" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">OCIR的设置</h1><p id="5436" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我们需要一个OCIR作为目标，因此最简单的方法是在其中一个区域中手动创建一个OCIR实例，为了便于说明，我们将使用Ashburn(简称为<em class="lh"> IAD </em>)。为了提高可见性，我们可以将注册表放在一个单独的区间中，作为根的子元素。让我们假设我们将调用注册表<em class="lh"> GraphQL </em>。因此，在创建OCIR之前，根据需要设置隔离舱。</p><figure class="ks kt ku kv fe ij es et paragraph-image"><div class="es et li"><img src="../Images/d743d27d99cdf2db941fba2f468db073.png" data-original-src="https://miro.medium.com/v2/resize:fit:444/0*3RG6ufV_D6KLNhgM"/></div></figure><p id="be13" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在截图中，你可以看到我已经创建了一个注册表，它在UI中非常快速和简单(在菜单中，它在<em class="lh">开发者服务</em>部分)。</p><figure class="ks kt ku kv fe ij es et paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="es et lj"><img src="../Images/e9dc5585ec33eb34bc85889cd2470daf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Y8pNNk84s0yXV9_x"/></div></div></figure><figure class="ks kt ku kv fe ij es et paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="es et lk"><img src="../Images/a460fe95eb9224d0155b898bd4882d65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EZQ27S6mGE1gcfS9"/></div></div></figure><p id="a6f9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，我们单击按钮来创建特定的OCIR。</p><figure class="ks kt ku kv fe ij es et paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="es et ll"><img src="../Images/4260d33ee282445024f718c90721f38d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*afeaKhoE5QoaxKP8"/></div></div></figure><h1 id="8c04" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">部署…</h1><p id="453b" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">创建了映像，并准备好了回购，我们可以开始将容器推到OCIR。</p><p id="6cc8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下一步是标记创建的图像。由于标签需要使用公式<em class="lh"> &lt;区域名称&gt; / &lt;租赁名称/ &lt;注册表名称&gt; : &lt;版本&gt; </em>来反映图像的去向，因此必须小心操作。所有的注册中心都将由<em class="lh"> &lt;地区短码&gt; .ocir.io </em>来寻址，在我们的例子中，它将是<em class="lh"> iad.ocir.io </em>。</p><pre class="ks kt ku kv fe kw kx ky kz aw la bi"><span id="00f0" class="lb jq hi kx b fj lc ld l le lf">docker tag graph-svr:latest iad.ocir.io/ociobenablement/graphql-svr:v0.1-dev</span></pre><p id="f957" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可能已经意识到，应用的标签有效地告诉OCI将容器放在OCIR的哪个实例中。弄错这一点可能是前面提到的陷阱的核心，我们将很快对此进行阐述。</p><p id="f3c7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要登录，您需要一个身份验证令牌，因为它是作为密码传递的。为了简单起见，我在docker命令中传递了令牌，Docker会警告您该令牌不安全，并建议将其作为提示的一部分传递。注意:在这篇文章发表时，我的令牌已经被更改了。用户名建立在<em class="lh"> &lt;云租用名称&gt;</em>/<em class="lh">identity cloudservice</em>/<em class="lh">&lt;用户名&gt; </em>的结构上。只需要包含<em class="lh"> identitycloudservice </em>片段，因为您的身份验证是通过IDCS管理的，就像这里的情况一样。最后一位是适当的OCIR地区地址的URI，就像我们以前使用的一样。</p><pre class="ks kt ku kv fe kw kx ky kz aw la bi"><span id="bc40" class="lb jq hi kx b fj lc ld l le lf">docker login -u ociobenablement/identitycloudservice/philip.wilkins@oracle.com -p XXXXXXXXXXX iad.ocir.io</span></pre><p id="a6de" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有了成功的认证响应，我们现在可以推送容器了。值得注意的是，Docker认证的连接将超时，这就是为什么我们在连接之前将一切就绪。push命令非常简单，因为它是分配给工件的标记名，包括版本号。</p><pre class="ks kt ku kv fe kw kx ky kz aw la bi"><span id="05e0" class="lb jq hi kx b fj lc ld l le lf">docker push iad.ocir.io/ociobenablement/graphql/graph-svr:v0.1-dev</span></pre><figure class="ks kt ku kv fe ij es et paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="es et ll"><img src="../Images/3bb9e35f39901b889dfe0602bfd010ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*A45HaK21MayV8Kyr"/></div></div></figure><h1 id="5be3" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">避开陷阱</h1><p id="dcd9" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">当我们处理从<a class="ae jo" href="https://git-scm.com/" rel="noopener ugc nofollow" target="_blank"> Git </a>到<a class="ae jo" href="https://subversion.apache.org/" rel="noopener ugc nofollow" target="_blank"> SVN </a>或<a class="ae jo" href="https://archiva.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Archiva </a>到<a class="ae jo" href="https://www.sonatype.com/products/nexus-repository" rel="noopener ugc nofollow" target="_blank"> Nexus </a>的存储库时，我们处理的是一个拥有多种不同资产以及这些资产的多个版本的存储库。因此，当我们唯一地识别一个资产时，我们希望根据服务器/位置、存储库、资产名称和版本来命名。然而，这里每个存储库都是为一种类型的资产设计的，但是有多个版本。实际上，Docker存储库以同样的方式工作(但是扩展路径的影响是不同的)。</p><p id="3f2c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这意味着很容易意外定义带有额外元素的标签。根据您的OCI租用权限，如果您走错了路，OCI会创建一个新的根分区容器存储库，其名称是租用后名称元素的组合，并将您的工件放在该存储库中，而不是您期望的那个。</p><p id="d4e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以通过几种方式来解决这个问题，第一个也可能是最好的选择是将资产装载到OCIR的过程自动化，因为一旦这个过程正确，它就会保持正确。另一个是采用一个原则，即永远不要将存储库放在租约的根位置，这意味着您可以显式删除在该分区中创建存储库的权限(由于策略继承，您需要显式授予分区层次结构中其他位置的权限)。如果标签是错误的，这将导致推送容器的过程由于特权而失败。</p><h1 id="ce4b" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">结构差异的视觉表征</h1><figure class="ks kt ku kv fe ij es et paragraph-image"><div class="es et lm"><img src="../Images/24c217ae7f2ed0c635e3136d855f7bd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:598/0*s6Lb82R-fd3ZrQg5"/></div></figure><figure class="ks kt ku kv fe ij es et paragraph-image"><div class="es et lm"><img src="../Images/34b12e82da425a113b51c472b376f68f.png" data-original-src="https://miro.medium.com/v2/resize:fit:598/0*awLdCvlHDcDKtSif"/></div></figure><h1 id="cb02" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">浓缩成一个简单的脚本</h1><p id="14d8" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">这些步骤可以简化为一个简单的平台中立脚本，如下所示:</p><pre class="ks kt ku kv fe kw kx ky kz aw la bi"><span id="c801" class="lb jq hi kx b fj lc ld l le lf">docker build -t event-data-svc . docker tag event-data-svc:latest iad.ocir.io/ociobenablement/event-data-svc:latest docker login -u ociobenablement/identitycloudservice/philip.wilkins@oracle.com -p XXXXX iad.ocir.io docker push iad.ocir.io/ociobenablement/event-data-svc:latest</span></pre><p id="2d85" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该脚本将需要针对每个正在构建的容器进行修改，但是您可以很容易地将其参数化或配置为驱动程序。</p><h1 id="74a3" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">关于注册管理机构标准的说明</h1><p id="2ad3" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">甲骨文集装箱登记处采用了OCIR的<a class="ae jo" href="https://opencontainers.org/" rel="noopener ugc nofollow" target="_blank">开放登记处</a>标准。开放注册中心受<a class="ae jo" href="https://www.linuxfoundation.org/" rel="noopener ugc nofollow" target="_blank"> Linux基金会</a>的管理。该标准已被所有主要的hyperscaler(Google、AWS、Azure等)采用。).本标准所有技术规范信息均通过<a class="ae jo" href="https://github.com/opencontainers" rel="noopener ugc nofollow" target="_blank"> GitHub </a>发布，不通过主网站发布。</p><h1 id="f5e5" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">参考</h1><ul class=""><li id="639b" class="ln lo hi is b it kn ix ko jb lp jf lq jj lr jn ls lt lu lv bi translated"><a class="ae jo" href="https://www.oracle.com/webfolder/technetwork/tutorials/obe/oci/registry/index.html" rel="noopener ugc nofollow" target="_blank">将映像推送到Oracle云基础架构注册中心</a></li><li id="2d77" class="ln lo hi is b it lw ix lx jb ly jf lz jj ma jn ls lt lu lv bi translated"><a class="ae jo" href="https://docs.oracle.com/en-us/iaas/Content/Registry/Tasks/registrycreatingarepository.htm#notesreposcreation" rel="noopener ugc nofollow" target="_blank">关于存储库创建的说明</a></li><li id="72f9" class="ln lo hi is b it lw ix lx jb ly jf lz jj ma jn ls lt lu lv bi translated"><a class="ae jo" href="https://docs.oracle.com/en/middleware/fusion-middleware/12.2.1.4/ikedg/using-oci-container-registry.html#GUID-41F49FED-CD6B-4E50-B87A-953C7D20C127" rel="noopener ugc nofollow" target="_blank">创建容器注册表</a></li><li id="ccab" class="ln lo hi is b it lw ix lx jb ly jf lz jj ma jn ls lt lu lv bi translated"><a class="ae jo" href="https://opencontainers.org/" rel="noopener ugc nofollow" target="_blank">开放注册</a></li><li id="a445" class="ln lo hi is b it lw ix lx jb ly jf lz jj ma jn ls lt lu lv bi translated"><a class="ae jo" href="https://docs.oracle.com/en-us/iaas/Content/Registry/Concepts/registrypolicyrepoaccess.htm#Policies_to_Control_Repository_Access" rel="noopener ugc nofollow" target="_blank">控制存储库访问的策略</a></li></ul></div><div class="ab cl mb mc gp md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="hb hc hd he hf"><p id="91f9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="lh">原载于2022年5月12日</em><a class="ae jo" href="https://blog.mp3monster.org/2022/05/12/container-registry-pushing-and-storing-containers/" rel="noopener ugc nofollow" target="_blank"><em class="lh">【http://blog.mp3monster.org】</em></a><em class="lh">。</em></p></div></div>    
</body>
</html>