<html>
<head>
<title>Integrate CATF Time with Lighthouse Audit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">整合CATF时间和灯塔审计</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/integrate-catf-time-with-lighthouse-audit-2cc4852d0698?source=collection_archive---------2-----------------------#2021-12-16">https://medium.com/walmartglobaltech/integrate-catf-time-with-lighthouse-audit-2cc4852d0698?source=collection_archive---------2-----------------------#2021-12-16</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="56b6" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">检查灯塔报告中的性能指标和CATF时间</h2></div><h2 id="95ec" class="iw ix hh bd iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">什么是CATF？</h2><p id="777d" class="pw-post-body-paragraph ju jv hh jw b jx jy ii jz ka kb il kc jh kd ke kf jl kg kh ki jp kj kk kl km ha bi translated">折叠上方的内容(CATF)是指观众在向下滚动之前看到的内容。<br/>在这里，我们测量在文件夹上方呈现内容所需的时间。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es kn"><img src="../Images/fbdff4044cc106be1b34863448a6901b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pey-KZTAZMCYtP4w_FBwGQ.png"/></div></div></figure><p id="85e5" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">图片来源:【https://www.walmart.com/ T4】</p><h2 id="400c" class="iw ix hh bd iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">为什么CATF时间很重要？</h2><p id="f4b2" class="pw-post-body-paragraph ju jv hh jw b jx jy ii jz ka kb il kc jh kd ke kf jl kg kh ki jp kj kk kl km ha bi translated">根据研究，如果用户在网页上长时间看到加载器，离开该网站的概率更高，因为这降低了用户的兴趣。为了改善用户体验，减少CATF时间是很重要的，以便内容尽快可见。</p><h2 id="e399" class="iw ix hh bd iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">问题陈述</h2><p id="41b1" class="pw-post-body-paragraph ju jv hh jw b jx jy ii jz ka kb il kc jh kd ke kf jl kg kh ki jp kj kk kl km ha bi translated">如果你真的认为改善CATF是一次性的活动，那么你错了。随着代码的增长，CATF往往会随着时间而退化。如果没有适当的常规检查点来测量、跟踪和修复性能下降，就会发生这种情况。</p><h2 id="d812" class="iw ix hh bd iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">建议</h2><p id="c33c" class="pw-post-body-paragraph ju jv hh jw b jx jy ii jz ka kb il kc jh kd ke kf jl kg kh ki jp kj kk kl km ha bi translated">计算拉式请求(PR)合并流的CATF时间，并将其上传到监控仪表板，以便我们将来参考。</p><h2 id="e73c" class="iw ix hh bd iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">如何测量CATF时间？</h2><p id="641a" class="pw-post-body-paragraph ju jv hh jw b jx jy ii jz ka kb il kc jh kd ke kf jl kg kh ki jp kj kk kl km ha bi translated">我们可以用灯塔来测量。它是一个开源的自动化工具，用于提高网页质量。它为我们提供了一些与网站性能检查相关的指标。但默认情况下，CATF时间不存在。Lighthouse为我们提供了创建定制审计的灵活性，即我们可以根据自己的需求添加或编辑各种指标。我们可以通过添加自定义审计来扩展它的功能。我们可以从Lighthouse的文档<a class="ae le" href="https://github.com/GoogleChrome/lighthouse/blob/master/docs/architecture.md" rel="noopener ugc nofollow" target="_blank">中读到更多关于light house架构的细节。</a></p><p id="e94e" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">现在，作为一个开发者，这个问题浮现在脑海中，在折痕上方标记的点应该是什么？由于每个设备的屏幕高度不同，折叠内容上方和下方之间的分叉点应该是什么？</p><p id="47d9" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">对于这一点，让我们从沃尔玛网站的主页上举个例子。在移动设备上，直到顶部横幅的内容都包含在文件夹上方的内容中。</p><p id="e105" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">在本教程中，我们将讨论如何将CATF指标融入灯塔审计。</p><h2 id="b1ad" class="iw ix hh bd iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">流程图</h2><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es lf"><img src="../Images/0138c5b14b1eb1809c4e75a8be6a4ed5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*laj_z8MEPO98SarQ5ml_eQ.png"/></div></div></figure><h2 id="a564" class="iw ix hh bd iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">标记CATF时间</h2><p id="a214" class="pw-post-body-paragraph ju jv hh jw b jx jy ii jz ka kb il kc jh kd ke kf jl kg kh ki jp kj kk kl km ha bi translated">我们创建了一个React组件，ATFMarker。我们将在这里为CATF设定时间。我们使用了<code class="du lg lh li lj b"><a class="ae le" href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/mark" rel="noopener ugc nofollow" target="_blank">performance.mark</a></code>函数，它在名称<code class="du lg lh li lj b">atf-marker</code>和<code class="du lg lh li lj b">performance.clearMarks</code>下创建一个时间戳来清除之前的值。</p><pre class="ko kp kq kr fd lk lj ll lm aw ln bi"><span id="008b" class="iw ix hh lj b fi lo lp l lq lr">useEffect(() =&gt; {<br/>  performance.clearMarks("atf-marker");<br/>  performance.mark("atf-marker");<br/>},[]);</span></pre><p id="de52" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">我们将在文件夹上方的内容末尾包含一个ATFMarker组件。</p><pre class="ko kp kq kr fd lk lj ll lm aw ln bi"><span id="cfe8" class="iw ix hh lj b fi lo lp l lq lr">&lt;div&gt;<br/>  &lt;TopBanner/&gt;<br/>&lt;/div&gt;<br/>&lt;ATFMarker/&gt;</span></pre><p id="b0f9" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">只要ATFMarker组件在客户机上呈现，它就标记时间戳。它表示ATFMarker完成客户端渲染的时刻，我们认为这是在折叠内容之上进行渲染所花费的时间。因为我们已经标记了<code class="du lg lh li lj b">atf-marker</code>时间戳，所以在Lighthouse报告中它将位于<code class="du lg lh li lj b">user-timings</code>下。</p><h2 id="ee87" class="iw ix hh bd iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">配置NX计算CATF时间？</h2><p id="b6de" class="pw-post-body-paragraph ju jv hh jw b jx jy ii jz ka kb il kc jh kd ke kf jl kg kh ki jp kj kk kl km ha bi translated">在沃尔玛，我们使用<a class="ae le" href="https://nx.dev/" rel="noopener ugc nofollow" target="_blank"> nx </a>来管理我们的monorepo架构。我们创建了一个执行程序<a class="ae le" href="https://nx.dev/latest/angular/executors/using-builders" rel="noopener ugc nofollow" target="_blank">来运行我们的代码。<br/>我们已经创建了一个<code class="du lg lh li lj b">wm-workspace-library</code>生成器，用于生成一个空的基于工作空间的库。它扩展了<code class="du lg lh li lj b">@nrwl/workspace:library</code>生成器，并添加了一些沃尔玛特有的变化。<br/>我们可以使用NX扩展创建一个库。我们将在工作空间库中生成它，因为它用于管理我们的代码库。</a></p><p id="b15a" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">点击NX扩展-&gt;生成-&gt; WM-工作空间-库</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es ls"><img src="../Images/2c67b8c0cfa87b19b2fa313e02f4be6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B5QtHsYuzw_2A868vYQ9Ig.png"/></div></div></figure><p id="d1fa" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">提供范围和名称，然后单击Run。这里我们提供名称为<code class="du lg lh li lj b">performance</code>，范围为<code class="du lg lh li lj b">workspace</code>。它在workspace下创建一个名为<em class="lt"> performance </em>的库。在性能库中，我们将编写代码。</p><p id="821d" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">或者我们也可以使用shell命令来生成它。</p><pre class="ko kp kq kr fd lk lj ll lm aw ln bi"><span id="fe62" class="iw ix hh lj b fi lo lp l lq lr">pnpm g wm-workspace-library -- --name=&lt;scope&gt;/&lt;name&gt; --forceGenerate</span></pre><p id="bdad" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">我们在<code class="du lg lh li lj b">workspace.json</code>中配置我们的工作空间。该文件包含工作空间项目及其架构师目标。假设我们有一个<code class="du lg lh li lj b">demo-app</code>，我们将为它定义一个<code class="du lg lh li lj b">browser-perf</code>目标。每个目标都使用一个运行该目标的执行器。</p><pre class="ko kp kq kr fd lk lj ll lm aw ln bi"><span id="1d54" class="iw ix hh lj b fi lo lp l lq lr">"demo-app": {<br/>  "root": "apps/demo/app",<br/>  "sourceRoot": "apps/demo/app",<br/>  "projectType": "application",<br/>  "targets": {<br/>    "browser-perf": {<br/>      "executor": "./libs/workspace/performance/src/executors:run",<br/>      "options": {<br/>        "urls": ["/url1","/url2"],<br/>        "serveTarget": "demo-app:serve"<br/>      }<br/>     },....</span></pre><p id="7992" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">当我们运行下面的命令时，性能库下的代码被执行。</p><pre class="ko kp kq kr fd lk lj ll lm aw ln bi"><span id="c025" class="iw ix hh lj b fi lo lp l lq lr">nx run demo-app:browser-perf</span></pre><p id="e9f8" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">在选项内部，我们提供了一个URL数组，我们将在上面运行灯塔。<br/>在executors文件夹中创建一个<a class="ae le" href="https://nx.dev/latest/angular/executors/using-builders#defining-an-executor-schema" rel="noopener ugc nofollow" target="_blank"> schema.json </a>文件，以定义一个模式来验证输入。</p><h2 id="a030" class="iw ix hh bd iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">与灯塔CI集成</h2><p id="f031" class="pw-post-body-paragraph ju jv hh jw b jx jy ii jz ka kb il kc jh kd ke kf jl kg kh ki jp kj kk kl km ha bi translated">使用Lighthouse CI，我们可以将其自动化，并进一步增强该功能。<br/> Lighthouse CI通常通过以下方式使用:</p><ul class=""><li id="224a" class="lu lv hh jw b jx kz ka la jh lw jl lx jp ly km lz ma mb mc bi translated">作为持续集成的一部分运行Lighthouse CI。</li><li id="456c" class="lu lv hh jw b jx md ka me jh mf jl mg jp mh km lz ma mb mc bi translated">使用Lighthouse CI GitHub操作运行并评论每个pull请求。</li><li id="2bd5" class="lu lv hh jw b jx md ka me jh mf jl mg jp mh km lz ma mb mc bi translated">通过Lighthouse Server提供的仪表板跟踪性能。</li></ul><h2 id="7a89" class="iw ix hh bd iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">如何在本地机器上运行Lighthouse CI</h2><p id="cd88" class="pw-post-body-paragraph ju jv hh jw b jx jy ii jz ka kb il kc jh kd ke kf jl kg kh ki jp kj kk kl km ha bi translated">在继续之前，我们先讨论几个命令:</p><p id="4e8b" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated"><a class="ae le" href="https://github.com/GoogleChrome/lighthouse-ci/blob/main/docs/configuration.md#collect" rel="noopener ugc nofollow" target="_blank">lhci collect</a>——它用于运行灯塔并将其结果收集到本地<code class="du lg lh li lj b">.lighthouseci/</code>文件夹中。</p><pre class="ko kp kq kr fd lk lj ll lm aw ln bi"><span id="ec70" class="iw ix hh lj b fi lo lp l lq lr">Options: --url  A URL to run Lighthouse on. Use this flag multiple times to evaluate multiple URLs.<br/>To run on multiple URLs<br/>lhci collect --url=https://example-1.com --url=<a class="ae le" href="https://example-2.com" rel="noopener ugc nofollow" target="_blank">https://example-2.com</a></span></pre><p id="9f33" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated"><a class="ae le" href="https://github.com/GoogleChrome/lighthouse-ci/blob/main/docs/configuration.md#assert" rel="noopener ugc nofollow" target="_blank"> lhci断言</a> —在这种情况下，我们可以定义聚合结果的多种策略，以及在哪个结果下我们需要显示警告、错误等。</p><p id="27cd" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated"><a class="ae le" href="https://github.com/GoogleChrome/lighthouse-ci/blob/main/docs/configuration.md#upload" rel="noopener ugc nofollow" target="_blank"> lhci上传</a> —将<code class="du lg lh li lj b">.lighthouseci/</code>文件夹中的运行结果保存到所需的目标<br/> <code class="du lg lh li lj b">Options: --outputDir [filesystem only] The directory in which to dump Lighthouse results.</code></p><p id="b2dc" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated"><a class="ae le" href="https://github.com/GoogleChrome/lighthouse-ci/blob/main/docs/configuration.md#autorun" rel="noopener ugc nofollow" target="_blank"> lhci自动运行</a> <strong class="jw hi"> — </strong>自动运行，使用合理的默认值，<a class="ae le" href="https://github.com/GoogleChrome/lighthouse-ci/blob/main/docs/configuration.md#collect" rel="noopener ugc nofollow" target="_blank"> lhci收集</a>，<a class="ae le" href="https://github.com/GoogleChrome/lighthouse-ci/blob/main/docs/configuration.md#assert" rel="noopener ugc nofollow" target="_blank"> lhci断言</a>和<a class="ae le" href="https://github.com/GoogleChrome/lighthouse-ci/blob/main/docs/configuration.md#upload" rel="noopener ugc nofollow" target="_blank"> lhci上传</a>，具体取决于您配置中的选项</p><p id="b412" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">Lighthouse CI配置可以通过配置文件、环境变量和CLI标记覆盖来管理。如果您想为灯塔提供一些特定的配置，在根目录下创建一个包含与灯塔相关的<a class="ae le" href="https://github.com/GoogleChrome/lighthouse-ci/blob/main/docs/configuration.md" rel="noopener ugc nofollow" target="_blank">配置</a>的<code class="du lg lh li lj b">.lighthouserc.js</code>文件。</p><p id="bfab" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">现在要在本地运行lhci，需要三个步骤。添加lhci/cli包。<br/> 2。启动服务器<br/> 3。运行lhci命令</p><p id="ea8f" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">让我们来讨论这些步骤:</p><p id="8957" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">在本地代码库中添加lhci/cli包。</p><pre class="ko kp kq kr fd lk lj ll lm aw ln bi"><span id="ffc4" class="iw ix hh lj b fi lo lp l lq lr">npm install -g @lhci/cli<br/>Let’s write code to start the server and run lhci on different URLs.<br/>From the <!-- -->workspace.json<!-- --> , we have provided URLs.</span></pre><p id="ea38" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">我们可以使用调用执行器的<code class="du lg lh li lj b"><a class="ae le" href="https://nx.dev/l/a/executors/using-builders" rel="noopener ugc nofollow" target="_blank">runExecutor</a></code>实用程序来启动服务器。它将在配置中找到目标，找到执行器，构造选项(就像您在终端中调用它一样)并调用执行器。它返回一个iterable，我们可以从这里评估基本URL。</p><p id="9402" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">现在我们运行lhci命令<code class="du lg lh li lj b">autorun</code> <br/>我们使用<code class="du lg lh li lj b"><a class="ae le" href="https://www.npmjs.com/package/execa" rel="noopener ugc nofollow" target="_blank">execa</a></code>来执行带有参数的命令</p><pre class="ko kp kq kr fd lk lj ll lm aw ln bi"><span id="7b8b" class="iw ix hh lj b fi lo lp l lq lr">const args = [“autorun”,`--collect.url=${url1}` `--collect.url=${url2}`]</span><span id="b686" class="iw ix hh lj b fi mi lp l lq lr">const lhResult = await execa(lhciPath, args, {stdio: “inherit”});</span></pre><p id="7f2b" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">在<code class="du lg lh li lj b">.lighthouseci</code>文件夹中，记录了输出的HTML和JSON文件。我们可以从那些JSON文件中读取数据。您可以在<a class="ae le" href="https://github.com/GoogleChrome/lighthouse/blob/master/lighthouse-core/config/default-config.js#L424" rel="noopener ugc nofollow" target="_blank">默认灯塔配置</a>中看到所有预定义的审计。</p><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es mj"><img src="../Images/41a8a94f97161d34748c695cc2e32aa2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qyM9rMnPNA26Rj6YvuTHvg.png"/></div></div><figcaption class="mk ml et er es mm mn bd b be z dx">atf-marker in JSON file</figcaption></figure><figure class="ko kp kq kr fd ks er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es mo"><img src="../Images/567c9c1df84399b0e7f8addcc54774ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6HCdQBPf94hgFNWbvPnl4A.png"/></div></div><figcaption class="mk ml et er es mm mn bd b be z dx">atf-marker in html file</figcaption></figure><p id="ebc6" class="pw-post-body-paragraph ju jv hh jw b jx kz ii jz ka la il kc jh lb ke kf jl lc kh ki jp ld kk kl km ha bi translated">在JSON输出文件中，我们也有<code class="du lg lh li lj b">atf-marker</code>数据。我们可以根据自己的需求来使用。我们已经提取了所需的数据并将其写入一个文件，比如demo.json. <br/>在CI合并流中，我们读取demo.json文件并将数据发送到监控仪表板。</p><h2 id="241d" class="iw ix hh bd iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">未来的工作</h2><p id="b4e2" class="pw-post-body-paragraph ju jv hh jw b jx jy ii jz ka kb il kc jh kd ke kf jl kg kh ki jp kj kk kl km ha bi translated">我们也将把它添加到CI的PR流中，这样开发者就可以在他们的PR合并之前知道CATF时间。</p><h2 id="b21f" class="iw ix hh bd iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">潜在问题</h2><p id="b4c2" class="pw-post-body-paragraph ju jv hh jw b jx jy ii jz ka kb il kc jh kd ke kf jl kg kh ki jp kj kk kl km ha bi translated">由于Lighthouse加载页面来查找指标，随着URL的增加，这变成了一个耗时的过程。要解决这个问题，我们应该批量运行URL。</p><h2 id="7ae0" class="iw ix hh bd iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt bi translated">结论</h2><p id="e88e" class="pw-post-body-paragraph ju jv hh jw b jx jy ii jz ka kb il kc jh kd ke kf jl kg kh ki jp kj kk kl km ha bi translated">为了检查与性能相关的数据，Lighthouse为我们提供了一些默认的指标。我们可以通过添加自定义指标和更新审计来扩展它们。</p></div></div>    
</body>
</html>