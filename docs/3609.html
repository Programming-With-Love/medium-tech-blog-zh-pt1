<html>
<head>
<title>Boost serverless app performance with Amazon RDS Proxy and Amazon Aurora</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">借助Amazon RDS代理和Amazon Aurora提升无服务器应用性能</h1>
<blockquote>原文：<a href="https://medium.com/globant/boost-serverless-app-performance-with-amazon-rds-proxy-and-amazon-aurora-e466695884f1?source=collection_archive---------0-----------------------#2021-01-15">https://medium.com/globant/boost-serverless-app-performance-with-amazon-rds-proxy-and-amazon-aurora-e466695884f1?source=collection_archive---------0-----------------------#2021-01-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="d2ba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">RDS代理服务推出后，我和费利佩·梅希亚一起开始测试这项服务，看看它如何应用在无服务器架构中。我们首先测试了几个在Aurora MySQL数据库上执行并发写任务的lambdas函数，以及RDS代理如何在这些类型的场景中帮助我们。经过几次测试和衡量，我想分享一下我所学到的东西。</p><p id="4677" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">RDS代理是一种完全受管的AWS服务，充当应用层和数据库层之间的代理层，负责:</p><ul class=""><li id="17b3" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">池和共享数据库连接</li><li id="0f2c" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">提高应用可用性。</li><li id="dcb6" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">提高数据安全性。</li></ul><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es jr"><img src="../Images/a04794bfa0b93ac0d565dedf983fdbe2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M3BBg4F1cNX6PdDnARXjPQ.png"/></div></div></figure><p id="87b9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，当我们开始使用无服务器架构和关系数据库(Aurora MySQL)时，我们遇到了一些有趣的挑战:</p><ul class=""><li id="dcb4" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated"><strong class="ig hi">数据库性能和连接管理:</strong>通过拥有同步连接，我们的数据库必须使用其计算资源来管理这些连接，并在出现流量高峰时支持它们的升级。</li><li id="2859" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi">故障转移时间:</strong>当无服务器架构中有关键应用时，可用性将始终是优先考虑的问题，因此，我们必须在服务和可用性之间寻求有效的成本关系。</li><li id="588b" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi">安全性:</strong>如何通过多个lambda函数处理数据库的连接字符串、用户名和密码？</li></ul><h2 id="d958" class="kd ke hh bd kf kg kh ki kj kk kl km kn ip ko kp kq it kr ks kt ix ku kv kw kx bi translated">带RDS代理的典型无服务器架构</h2><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es ky"><img src="../Images/5c3812ab489dcd466ab38befaec1881d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tz5Tu_AOGUoQF-_-4Tr96Q.png"/></div></div></figure><h1 id="1041" class="kz ke hh bd kf la lb lc kj ld le lf kn lg lh li kq lj lk ll kt lm ln lo kw lp bi translated">连接管理</h1><ul class=""><li id="8cdd" class="jd je hh ig b ih lq il lr ip ls it lt ix lu jb ji jj jk jl bi translated"><strong class="ig hi">多路复用:</strong>在您的会话中完成一个事务后，代理可以重用每个连接。这种事务级重用被称为多路复用。</li><li id="c204" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi">借用:</strong>当RDS代理从池中删除一个连接以重用它时，就会发生这种情况。一旦完成，他把它放回游泳池。</li><li id="9786" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi">固定:</strong>在某些情况下，RDS代理不确定是否可以在会话之外重用连接，在这些情况下，会话将保持在同一连接上，直到会话结束。</li></ul><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es lv"><img src="../Images/24da0a1925d991da640de9c459dd9cc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I_m_lodHyi4vAlkTM1bRUA.png"/></div></div></figure><h1 id="ba48" class="kz ke hh bd kf la lb lc kj ld le lf kn lg lh li kq lj lk ll kt lm ln lo kw lp bi translated">故障转移时间</h1><p id="49ee" class="pw-post-body-paragraph ie if hh ig b ih lq ij ik il lr in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated">当主实例出现更新问题或连接问题时，可能会发生故障转移。在故障转移期间，RDS代理继续接受来自同一个源的连接，并自动将它们定向到将充当主实例的新实例。</p><p id="1e41" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这些故障切换期间，客户端不会受到以下影响:</p><ul class=""><li id="e35c" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">故障转移时域名系统(DNS)传播延迟。</li><li id="7fef" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">本地DNS缓存。</li><li id="981f" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">连接超时。</li><li id="399b" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">不确定哪个数据库实例是当前的编写器。</li><li id="10eb" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">在不关闭连接的情况下，等待来自变得不可用的前编写器的查询响应。</li></ul><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es lz"><img src="../Images/9d738d44dfe94559a3353825e6cced67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nYzuLT5nzG1UsMvS4GtvXw.png"/></div></div></figure><h1 id="e841" class="kz ke hh bd kf la lb lc kj ld le lf kn lg lh li kq lj lk ll kt lm ln lo kw lp bi translated">安全性</h1><p id="2ec4" class="pw-post-body-paragraph ie if hh ig b ih lq ij ik il lr in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated">RDS代理支持TLS协议版本1.0、1.1和1.2。您可以使用比您在底层数据库中使用的TLS版本更高的TLS版本来连接到代理。</p><p id="9fc8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于连接到数据库的lambda函数，一切都必须通过Secrets Manager服务来完成，其中有一个在代理中配置的秘密。在lambda级别，我们将其指向RDS代理。</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="jx jy di jz bf ka"><div class="er es lv"><img src="../Images/9396e1459bf90b1da9cf6aa5ea0507ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u6pJuVY2xBSQ4rE9oazYfA.png"/></div></div></figure><h1 id="fb92" class="kz ke hh bd kf la lb lc kj ld le lf kn lg lh li kq lj lk ll kt lm ln lo kw lp bi translated">执行的测试</h1><p id="f7a9" class="pw-post-body-paragraph ie if hh ig b ih lq ij ik il lr in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated"><strong class="ig hi">基础设施部署:</strong>整个基础设施是用CDK + TS部署的，像这样部署整个基础设施是一个有趣的挑战，然而，与CDK + Python相比，TS的文档并不完整。</p><p id="df72" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">数据库配置</strong></p><figure class="js jt ju jv fd jw"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="f877" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">极光主数据库实例</strong></p><figure class="js jt ju jv fd jw"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="368c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> Aurora备用数据库实例</strong></p><figure class="js jt ju jv fd jw"><div class="bz dy l di"><div class="ma mb l"/></div></figure><h2 id="d0c4" class="kd ke hh bd kf kg kh ki kj kk kl km kn ip ko kp kq it kr ks kt ix ku kv kw kx bi translated">λ函数</h2><p id="f5ba" class="pw-post-body-paragraph ie if hh ig b ih lq ij ik il lr in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated">它是在Python 3.7中开发的，它实际上是一个脚本，通过两个周期在数据库中执行循环写入任务，并依次显示它何时在数据库中写入每个记录:</p><figure class="js jt ju jv fd jw"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="9149" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，在所描述的场景中，所有lambda函数都在数据库上执行写任务，故障转移在两个场景中执行，在每个场景中总共运行了15个测试:</p><ul class=""><li id="7196" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated"><strong class="ig hi">没有RDS代理的故障转移:</strong>在这个场景中，我们在故障转移时有10-12秒的数据库不可用。</li><li id="d4c2" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi">使用RDS代理的故障转移:</strong>在这个场景中，只有30%的测试不可用1秒，其余70%没有不可用。</li></ul><p id="5a80" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们的场景中进行测试后，我们证明随着时间的推移，故障转移性能提高了<strong class="ig hi"> <em class="mc"> 90%。</em>T15】</strong></p><h1 id="1b6e" class="kz ke hh bd kf la lb lc kj ld le lf kn lg lh li kq lj lk ll kt lm ln lo kw lp bi translated">吸取的教训</h1><ul class=""><li id="8c51" class="jd je hh ig b ih lq il lr ip ls it lt ix lu jb ji jj jk jl bi translated">每当AWS发布一个新的服务，我建议等待3-6个月在生产环境中使用它。由于文档通常不完整，AWS支持人员不太了解服务，您可能很难尝试做复杂的事情。</li><li id="7381" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">如果您要实现RDS代理，请考虑成本以及它们对项目的影响。</li><li id="2a95" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">对于生产环境，我明确建议使用代理来提高安全性、连接和故障转移。</li><li id="b345" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">在执行的测试中，故障转移时间减少了90%,在某些情况下，没有出现不可用的情况。</li></ul><p id="83e9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">— <a class="ae jc" href="https://www.linkedin.com/in/carlos-zambrano-aws/" rel="noopener ugc nofollow" target="_blank">卡洛斯·桑布拉诺</a></p></div></div>    
</body>
</html>