<html>
<head>
<title>How Airbnb Safeguards Changes in Production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Airbnb如何保护生产中的变化</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/how-airbnb-safeguards-changes-in-production-9fc9024f3446?source=collection_archive---------1-----------------------#2022-07-11">https://medium.com/airbnb-engineering/how-airbnb-safeguards-changes-in-production-9fc9024f3446?source=collection_archive---------1-----------------------#2022-07-11</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="920b" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">第一部分:Airbnb实验平台的演变</h2></div><p id="2342" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">作者:<a class="ae js" href="https://www.linkedin.com/in/michaelcl/" rel="noopener ugc nofollow" target="_blank"/>，<a class="ae js" href="https://www.linkedin.com/in/toby-mao/" rel="noopener ugc nofollow" target="_blank">托比·毛</a>，<a class="ae js" href="https://www.linkedin.com/in/zack-loebel-begelman-85407698/" rel="noopener ugc nofollow" target="_blank">扎克·罗贝尔-比格尔曼</a></p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/be74ab8c3dcd5934decdced381909964.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0J4whYTNqGPUdUme"/></div></div></figure><h1 id="d488" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">介绍</h1><p id="6233" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">随着Airbnb发展成为一家拥有1200多名开发人员的公司，推动我们产品变化的平台和渠道的数量——以及我们投入生产的日常变化的数量——也大幅增长。面对这种增长，我们需要不断扩展我们的能力，以便在错误进入生产之前检测到它们。然而，错误不可避免地会错过生产前的验证，因此我们也在机制上进行大量投资，以便在错误进入生产时快速检测错误。在这篇博文中，我们将讨论一个保护生产变化的系统的动机和基础，我们称之为安全部署。接下来的两篇文章将详细介绍我们如何将技术架构应用到传统的A/B测试和代码部署中。</p><h1 id="8060" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">持续交付和超越</h1><p id="7661" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">Airbnb的持续交付团队最近写了关于<a class="ae js" rel="noopener" href="/airbnb-engineering/continuous-delivery-at-airbnb-6ac042bc7876">我们采用Spinnaker </a>的文章，Spinnaker是一款现代CI/CD管弦乐器。Spinnaker在部署期间支持<a class="ae js" href="https://spinnaker.io/docs/guides/user/canary/" rel="noopener ugc nofollow" target="_blank">自动金丝雀分析(ACA) </a>，根据请求分割微服务流量，以比较代码版本，查看性能、错误率或其他关键指标是否受到负面影响。如果新版本的指标下降，Spinnaker会自动回滚部署，从而显著减少修复错误推送的时间。</p><p id="4797" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Airbnb的ACA确实在部署过程的早期发现了大量错误。但是，它有一些限制:</p><ul class=""><li id="b0ff" class="lc ld hh iy b iz ja jc jd jf le jj lf jn lg jr lh li lj lk bi translated"><strong class="iy hi">通道:</strong> Spinnaker的ACA测试针对微服务的变化。然而，微服务更新并不是唯一可以推送到生产中的错误来源。例如，Android和iOS应用通过各自的应用商店遵循发布流程。Airbnb的许多“生产推送”可能根本不涉及新代码，并通过配置更改严格应用。这些变化包括营销活动或用Airbnb的<a class="ae js" rel="noopener" href="/airbnb-engineering/airbnbs-promotions-and-communications-platform-6266f1ffe2bd">内部内容管理系统</a>创建的网站内容。虽然看起来是良性的，但通过这些系统推动可能会产生巨大的影响。例如，当营销活动被错误地应用于除一个国家之外的所有国家，而不是针对某个特定国家的原始意图时，就曾引发过一次事故。这个简单的错误导致全球几乎所有用户的搜索结果都是空的，并且需要一个多小时来识别和恢复。</li><li id="0ddc" class="lc ld hh iy b iz ll jc lm jf ln jj lo jn lp jr lh li lj lk bi translated"><strong class="iy hi">端到端业务度量:</strong> Spinnaker的ACA由本地系统度量驱动，比如微服务的本地性能和错误率；而不是端到端的业务指标，比如搜索点击率和预订率。虽然基于本地系统指标的回滚是有价值的，但还不够，因为我们一些代价最大的错误会影响端到端业务指标，但不会影响本地系统指标。例如，在2020年，一个简单的前端更改被部署到生产中，而没有在不支持所用CSS的特定浏览器上进行测试，从而阻止用户在该浏览器上预订旅行。这对系统指标没有影响，但是直接影响了业务指标。<br/> <br/>不幸的是，向Spinnaker的ACA系统添加业务指标是不可能的，因为Spinnaker根据请求随机分配流量，因此同一个用户可能会暴露于多个变量。然而，业务度量通常是基于用户的，并且要求每个用户有一个固定的变量分配。更重要的是，这是不可能的，因为业务指标需要端到端地测量，当两个微服务同时进行ACA时，Spinnaker无法区分这两个服务对端到端业务指标的各自影响。</li><li id="7bca" class="lc ld hh iy b iz ll jc lm jf ln jj lo jn lp jr lh li lj lk bi translated"><strong class="iy hi">粒度:</strong> Spinnaker的ACA测试是在整个微服务的层面上进行的。然而，在一个微服务中，经常会同时处理两个特性。当ACA失败时，很难判断是哪个特性导致了失败。</li></ul><p id="a503" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">虽然我们非常依赖Spinnaker在Airbnb的ACA，但很明显，在情况需要时，有机会补充它并解决上述限制。</p><h1 id="1518" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">实验报告框架</h1><p id="ebd9" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">长期以来，A/B测试一直是Airbnb产品开发中的一个固定项目。虽然在反事实分析中与ACA有一些相同的性质，但是A/B测试已经集中于确定一个新的特性是否改善业务结果，而不是确定该特性是否导致系统回归。多年来，Airbnb开发了我们的实验报告框架(ERF ),在六个平台上运行数百个并发A/B实验，以确定新功能是否会产生积极影响。</p><p id="297a" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">ERF解决了上面列出的ACA的局限性:</p><ul class=""><li id="86cb" class="lc ld hh iy b iz ja jc jd jf le jj lf jn lg jr lh li lj lk bi translated"><strong class="iy hi"> Channels: </strong>对于每个新平台，都引入了一个ERF客户端来支持其上的A/B测试。这包括移动、web和后端微服务。还引入了API来为配置系统提供一种将配置更改视为A/B测试的途径。</li><li id="9474" class="lc ld hh iy b iz ll jc lm jf ln jj lo jn lp jr lh li lj lk bi translated"><strong class="iy hi">端到端业务度量:</strong> ERF主要由端到端业务度量驱动<em class="lq"/>。在技术方面，它根据用户而不是请求进行随机化，并且它能够区分同时运行的数百个实验的影响。ERF接入Airbnb的<a class="ae js" rel="noopener" href="/airbnb-engineering/airbnb-metric-computation-with-minerva-part-2-9afe6695b486">中央指标系统</a>来访问产品和业务团队定义的数千个业务指标和维度，以衡量对Airbnb整体而言最重要的是什么。</li><li id="e729" class="lc ld hh iy b iz ll jc lm jf ln jj lo jn lp jr lh li lj lk bi translated"><strong class="iy hi">粒度:【Spinnaker的ACA在整个微服务的级别上运行其实验，ERF则基于嵌入代码中的基本特性标志来运行其实验。因此，如果在同一个微服务中同时开发多个特性，ERF可以确定哪个特性会影响业务指标。</strong></li></ul><p id="6dca" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">ERF的上述特征解决了ACA的局限性，但是ERF也有它自己的局限性:它是一个生成交互式报告的日常批处理系统，供人类决策者使用。为了解决Spinnaker的ACA的局限性，ERF需要发展成一个接近实时的系统，可以直接控制部署过程，而无需人工干预。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lr"><img src="../Images/e8986e045f79e6a828de9a530c4cc704.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rOQST4-KYXGe253y"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">Figure 1: Areas of the ERF Platform augmented to support near real-time experimentation</figcaption></figure><p id="2e51" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这种演变对ERF背后的数据科学及其软件架构都有影响。我们在这篇文章中描述了前者，并将在本系列的下一篇文章中描述后者。</p><h1 id="9b8c" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">实时ERF——数据科学</h1><p id="dd9d" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">固体数据科学的基础是固体数据工程。在数据工程方面，我们需要重新审视实时计算的业务指标的定义。batch ERF系统计算的指标是为准确性而设计的，可以利用复杂的连接和预处理来实现这一点。接近实时的指标没有这种优势，需要简化以满足低延迟要求。</p><p id="b92c" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们不仅必须建立新的度量标准，而且我们知道我们还必须建立新的统计测试。安全部署系统不能有噪音，否则人们会停止使用它。像T-Test这样的传统方法会遇到各种各样的问题，这些问题在实时系统中实现时会非常棘手。两个特别的问题是由于(1) <a class="ae js" href="http://library.usc.edu.ph/ACM/KKD%202017/pdfs/p1517.pdf" rel="noopener ugc nofollow" target="_blank">偷看</a>(在预定的时间量之前查看)和(2)严重扭曲的数据导致的假阳性。</p><p id="5a86" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当监控一个指标是否实时改变时，用户希望在模型确信这是真的时得到通知。然而，天真地这样做导致了第一个问题，偷看。在传统的A/B测试中，统计测试仅在预定时间后应用一次，因为有可能重要的结果是由于随机性而不是实际效果。对于实时ERF，我们不只是进行一次测试，因为，根据我们等待测试的时间，我们可能会花费太长时间来检测一些错误，或者错过其他需要更长时间才能发现的错误。相反，我们希望每5分钟检查(查看)一次模型，以便我们能够快速做出反应。在p值为0.05的情况下运行100次A/A比较，可以预期有大约5个实际上是假阳性的重要结果。我们可以将这个问题转化为多次计算同一数据集的p值。每次评估都有5%的假阳性几率，因此多次评估后，出现一次或多次假阳性的几率接近100%。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lw"><img src="../Images/6482264a7cec67af1a84ac66970f24bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GHdgh0pCLSG87czD"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">Figure 2: Increasing evaluations inevitably lead to false positives</figcaption></figure><p id="2cef" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为了在没有噪声的情况下平衡早期检测，我们利用<a class="ae js" href="https://en.wikipedia.org/wiki/Sequential_analysis" rel="noopener ugc nofollow" target="_blank">顺序分析</a>。顺序方法不假设固定的样本大小(即，检查一次模型)，并允许我们持续监控指标，而不用担心由于窥视而导致的假阳性。校正假阳性(<a class="ae js" href="https://en.wikipedia.org/wiki/Type_I_and_type_II_errors#Type_I_error" rel="noopener ugc nofollow" target="_blank">类型1错误</a>)的一种方法是应用<a class="ae js" href="https://en.wikipedia.org/wiki/Bonferroni_correction" rel="noopener ugc nofollow" target="_blank"> Bonferroni校正</a>。如果您对模型进行四次统计显著性检查，并希望保证5%的总体假阳性率，则需要将p值除以4，这意味着只有p值等于或低于1.25%的结果才有效。但是，这样做太保守了，因为每个检查都是依赖的。它们是相互依赖的，因为每次检查都有相同的数据基础，只是随着时间的推移增加了额外的观察。顺序模型考虑了这种依赖性，同时保证比Bonferroni更有效的假阳性率。我们使用两种不同的序列模型，SSRM ( <a class="ae js" href="https://arxiv.org/abs/2011.03567" rel="noopener ugc nofollow" target="_blank">序列样本比率不匹配</a>)用于计数指标，而<a class="ae js" href="https://arxiv.org/abs/1906.09712" rel="noopener ugc nofollow" target="_blank">序列分位数</a> (Howard，Ramdas)用于分位数指标。</p><p id="177d" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为了保持稳健，我们需要解决的第二个问题是处理有偏差的数据。像延迟这样的性能指标可能有非常大的尾部。假设正态分布的模型不会有效，因为中心极限定理不会生效。通过应用顺序分位数，我们可以忽略关于指标分布的假设，直接测量任意分位数之间的差异。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lx"><img src="../Images/9e23631fe19506e780f37f778029fefd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_UUUc7wmcL3jUKei"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">Figure 3: Metrics may have non-normal distributions</figcaption></figure><p id="7f42" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最后，许多重要的措施不是独立的。延迟和印象等指标具有用户内部相关性，因此数据中的每个事件都不能被视为独立的单元。为了抵消偏差，在评估统计模型之前，我们首先将所有度量聚合到用户指标中。</p><h1 id="4a39" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">结论</h1><p id="04d3" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">有了近乎实时地评估业务指标的统计方法，我们现在可以检测到Spinnaker看不到的问题，或者需要太多准备时间来依赖传统的ERF实验的问题。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lr"><img src="../Images/98918db1a9a2a6055a6ae2e5ed32f6ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nmC6mnUBfe98hcxo"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">Figure 4: How Real-time ERF fits between Spinnaker and Traditional ERF</figcaption></figure><p id="24f6" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">实施新创建的近实时指标和统计方法需要进一步的工程设计，但更具挑战性的是，它需要改变Airbnb的实验文化。在接下来的帖子中，我们将详细介绍我们的近实时指标管道是如何构建的，这些指标如何推动自动化决策制定，以及我们如何推动整个公司的采用。</p><p id="fff1" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">有兴趣在Airbnb工作吗？查看这些开放的角色:</p><p id="917d" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><a class="ae js" href="https://careers.airbnb.com/positions/4262326/" rel="noopener ugc nofollow" target="_blank">度量基础设施高级软件工程师</a></p><p id="c3e0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><a class="ae js" href="https://careers.airbnb.com/positions/4216371/" rel="noopener ugc nofollow" target="_blank">实时流处理平台软件工程师</a></p><p id="49d3" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><a class="ae js" href="https://careers.airbnb.com/positions/2403782/" rel="noopener ugc nofollow" target="_blank">软件工程师— ML Ops平台</a></p><p id="8822" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><a class="ae js" href="https://careers.airbnb.com/positions/2410642/" rel="noopener ugc nofollow" target="_blank">云基础设施软件工程师</a></p><h1 id="b080" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">增值</h1><p id="f56d" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">感谢<a class="ae js" href="https://www.linkedin.com/in/adriankuhn/" rel="noopener ugc nofollow" target="_blank">阿德里安·库恩</a>、<a class="ae js" href="https://www.linkedin.com/in/alex-shaojie-deng-b572347/" rel="noopener ugc nofollow" target="_blank">亚历克斯·邓</a>、<a class="ae js" href="https://www.linkedin.com/in/antoinecreux/" rel="noopener ugc nofollow" target="_blank">安托万·克鲁</a>、<a class="ae js" href="https://www.linkedin.com/in/erikriverson/" rel="noopener ugc nofollow" target="_blank">埃里克·艾弗森</a>、<a class="ae js" href="https://www.linkedin.com/in/george-l-9b946655/" rel="noopener ugc nofollow" target="_blank">乔治·李</a>、<a class="ae js" href="https://www.linkedin.com/in/krishna-bhupatiraju-1ba1a524/" rel="noopener ugc nofollow" target="_blank">克里希纳·布帕蒂拉朱</a>、<a class="ae js" href="https://www.linkedin.com/in/preetiramasamy/" rel="noopener ugc nofollow" target="_blank">普雷蒂·拉马萨米</a>、<a class="ae js" href="https://www.linkedin.com/in/rstata/" rel="noopener ugc nofollow" target="_blank">雷米·斯塔塔</a>、里德·安德森<a class="ae js" href="https://www.linkedin.com/in/ronnyk/" rel="noopener ugc nofollow" target="_blank">罗尼·科哈维</a>、<a class="ae js" href="https://www.linkedin.com/in/shao-xie-0b84b64/" rel="noopener ugc nofollow" target="_blank">邵谢</a></p></div></div>    
</body>
</html>