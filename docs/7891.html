<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/deep-dive-azure-cosmos-partitions-and-partitionkey-14e898f371cd?source=collection_archive---------0-----------------------#2020-07-17">https://medium.com/walmartglobaltech/deep-dive-azure-cosmos-partitions-and-partitionkey-14e898f371cd?source=collection_archive---------0-----------------------#2020-07-17</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/04bcdf06dd38ca798d92fe7db3e5199f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O9E3MltOWuTODsNbmkY5oQ.png"/></div></div></figure><p id="f1b7" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated"><strong class="ht ip"> <em class="iq">深究蔚蓝宇宙分区键和分区</em> </strong></p></div><div class="ab cl ir is go it" role="separator"><span class="iu bw bk iv iw ix"/><span class="iu bw bk iv iw ix"/><span class="iu bw bk iv iw"/></div><div class="ha hb hc hd he"><p id="bb1b" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated"><strong class="ht ip">如何有效地为Azure Cosmos建模</strong></p><p id="679b" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">您希望构建具有这些功能的应用程序吗？</p><ol class=""><li id="0884" class="iy iz hs ht b hu hv hy hz ic ja ig jb ik jc io jd je jf jg bi translated">高度可扩展(读写吞吐量)</li><li id="1512" class="iy iz hs ht b hu jh hy ji ic jj ig jk ik jl io jd je jf jg bi translated">可维护的数据一致性</li><li id="447b" class="iy iz hs ht b hu jh hy ji ic jj ig jk ik jl io jd je jf jg bi translated">在区域停机/灾难恢复期间保持一致的业务连续性</li></ol><p id="94d5" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">那么Cosmos DB非常适合您的应用程序。但是您需要深入了解Cosmos是如何工作的，这样您就可以相应地为您的应用程序建模，然后您就可以实现期望的吞吐量。</p><p id="fb86" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated"><strong class="ht ip">分区密钥先决条件</strong></p><p id="858e" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">一个<em class="iq">分区键</em>是一个唯一的数据集，它有很高的基数，或者很大范围的可能值。</p><p id="af13" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">在设计时，<strong class="ht ip"> <em class="iq">选择正确的分区键</em> </strong>很重要。一旦您选择了分区键并接收了数据，就不可能再对其进行更改，除非您将数据移动到具有已更改分区键的新容器中。通常，对于繁重的读取密集型应用程序，您可以基于大多数读取调用模式/过滤器来选择分区键。</p><p id="b399" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">例如，假设您正在构建一个应用程序来托管一个组织的用户群。为此，您可以使用<strong class="ht ip"> userId </strong>作为分区键。与用户相关的所有文档或数据将被映射到<strong class="ht ip"> userId </strong>分区键。</p><figure class="jn jo jp jq fd hj er es paragraph-image"><div class="er es jm"><img src="../Images/9bbe3273b1735f80accf19a8389efa06.png" data-original-src="https://miro.medium.com/v2/resize:fit:958/format:webp/1*h1Ol-CA2ah59EX2Vz5xBzA.png"/></div><figcaption class="jr js et er es jt ju bd b be z dx">PartitionKey Example</figcaption></figure><p id="4436" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated"><strong class="ht ip">什么是合成分区键</strong></p><p id="16f8" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">通常，分区键可以是文档中的一个JSON (Java Script Object Notation)属性，用于将数据分布到多个分区。但是，可能会出现需要在文档中使用两个或更多属性来为分区键建模的情况。这叫做<em class="iq">合成分区键</em>。</p><p id="1b77" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">例如，如果您正在对多租户应用程序建模，建议使用<strong class="ht ip"> tenant-Id </strong>作为分区键的一部分，并使用合成分区键。您还可以有两个或更多属性派生唯一数据的可选用例。</p><figure class="jn jo jp jq fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es jv"><img src="../Images/6e0f91c4148aeeac3d644235fa079277.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BNB8cZby97ZLTp76plqpZQ.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx">PartitionKey versus Synthetic PartitionKey</figcaption></figure><p id="fa51" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated"><strong class="ht ip"> Cosmos DB分区</strong></p><p id="8a76" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">现在我们已经详细了解了分区键和各种要建模的场景，让我们深入了解一下Cosmos是如何进行分区的。</p><p id="cb5f" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">Cosmos通过将数据存储到分区中来扩展每个容器，这种方法允许您扩展和执行吞吐量。有两种类型的宇宙划分</p><ol class=""><li id="1f49" class="iy iz hs ht b hu hv hy hz ic ja ig jb ik jc io jd je jf jg bi translated">逻辑分区</li><li id="e9a2" class="iy iz hs ht b hu jh hy ji ic jj ig jk ik jl io jd je jf jg bi translated">物理分区</li></ol><p id="6e6c" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">下面介绍了每个分区的意义和用法。</p><p id="40e6" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated"><strong class="ht ip">逻辑分区</strong></p><p id="ece7" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">一个<em class="iq">逻辑分区</em>包含一组属于同一分区键的文档。一个逻辑分区可以有一个<strong class="ht ip"> <em class="iq"> 20GB限制</em> </strong>。请确保对您的分区键进行建模，以便您可以使用同一个分区键管理所有相关的文档。在上面的用例中(我们使用userId作为partitionKey)，与单个用户相关的多个文档可以被分组到一个逻辑分区中。</p><figure class="jn jo jp jq fd hj er es paragraph-image"><div class="er es jw"><img src="../Images/b732ff3ac45bc32515ea91b0475e6e16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/1*q2OtCwPgYthqGWT4zXYKvw.png"/></div><figcaption class="jr js et er es jt ju bd b be z dx">Logical Partition</figcaption></figure><p id="d0eb" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated"><strong class="ht ip">物理分区</strong></p><p id="86c7" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">一个<em class="iq">物理分区</em>是文档的实际存储。首先，您的容器可能创建了一个物理分区。每个分区可存储高达<strong class="ht ip"><em class="iq"/></strong>的50GB数据，并可提供高达<strong class="ht ip"> <em class="iq">每秒10000个</em> </strong> <strong class="ht ip"> <em class="iq">请求单位</em></strong>(<strong class="ht ip"><em class="iq">【RU/s】</em></strong>)。一个或多个逻辑分区映射到一个物理分区。当数据大小超过50GB时，Cosmos会自动创建一个新的物理分区。分区键的值被散列，以便它可以进入特定的物理分区。可能会对现有的物理分区进行拆分，以便系统可以在所有可用的物理分区之间散列分区键。属于单个逻辑分区的数据将被映射/存储到新的/相同的物理分区上。添加新的物理分区应该不会影响应用程序的可用性。</p><figure class="jn jo jp jq fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es jx"><img src="../Images/9e4392a9b2dff92d9f9d68ce93e3af9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*anuElEPZMZfW8ebE"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx">Range of Partition Addresses Hashing</figcaption></figure><figure class="jn jo jp jq fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es jy"><img src="../Images/45bfbc0b9523ce0fa51dc5847e50aa7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pIdy7QJNdbiVARLo3ZIohw.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx">Logical versus Physical partition</figcaption></figure><p id="51d6" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated"><strong class="ht ip">吞吐量注意事项</strong></p><p id="9f74" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">Cosmos跨物理分区扩展容器吞吐量。请求单位(RU)是吞吐量的度量单位。您可以在数据库或容器级别提供ru(预期吞吐量所需的)。被供应的ru在物理分区之间平均分配</p><p id="b3e7" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated"><strong class="ht ip">数据库吞吐量供应的工作原理</strong></p><p id="8d4f" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">数据库中提供的吞吐量在数据库中创建的所有容器之间共享。可以把它想象成一个所有容器共享的池。当您提供数据库吞吐量时，Cosmos限制使用25个容器。共享数据库所需的最小吞吐量为<strong class="ht ip"> 1，000 ru</strong>T34】。</p><p id="2712" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">一旦数据库创建了<em class="iq"> x </em>数量的物理分区(基于供应的ru)并且创建了容器，系统就在数据库级的<em class="iq"> x </em>数量的物理分区上共享和分配每个容器。</p><p id="2269" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">比如说。，假设有三个物理分区和五个容器。所有五个容器将共享这三个分区。现在，假设两个容器最终增长并需要更多吞吐量。在这种情况下，系统会创建一组新的三个物理分区，只有这两个容器会分配额外的分区。现在，每个容器将被映射到在数据库级别创建的不同物理分区。因此，如果一个容器需要全部吞吐量，那么它可以完全使用所供应的ru，而另一个容器可能最终具有速率限制/节流。</p><figure class="jn jo jp jq fd hj er es paragraph-image"><div class="er es jz"><img src="../Images/0c2cb623eb7d56d365c23b3f04357185.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/1*3s6V52zW60UkDyOvp9n8pw.png"/></div><figcaption class="jr js et er es jt ju bd b be z dx">Provisioning Database Throughput</figcaption></figure><p id="cc6b" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated"><strong class="ht ip">集装箱吞吐量供应如何工作</strong></p><p id="e529" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">在容器级别调配的吞吐量专用于或专门保留给该容器。这意味着，无论您是否使用了所调配的吞吐量，您都会收到该吞吐量并为此付费。一个集装箱所需的最小吞吐量是<strong class="ht ip"> 400个俄罗斯单位<em class="iq">。</em> </strong>重要的是使用或减少ru集，仅在需要扩展吞吐量时才增加。</p><p id="5b89" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated">容器提供的吞吐量总是跨物理分区分布。假设您有五个物理分区，设置吞吐量大约为10，000；在这种情况下，每个物理分区将分配到2，500个ru。如果您看到更多与映射到一个分区的分区键数据相关的调用，那么即使您在容器中分配了足够的ru(10，000 ),也可能会有速率限制(如果消耗了2，500个ru)。</p><p id="5ec4" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated"><strong class="ht ip">注意:</strong>一旦您有了调配的吞吐量，您就不能在共享数据库和专用容器吞吐量之间移动，反之亦然。唯一的方法是创建一个新的容器/数据库并移动数据。</p><figure class="jn jo jp jq fd hj er es paragraph-image"><div class="er es ka"><img src="../Images/5450a3faf9a522bbba45d6b03e7d1e93.png" data-original-src="https://miro.medium.com/v2/resize:fit:760/format:webp/1*uCEe3Df7cbislAzLh3OEiw.png"/></div><figcaption class="jr js et er es jt ju bd b be z dx">Provisioning Dedicated Container Throughput</figcaption></figure><p id="c67a" class="pw-post-body-paragraph hq hr hs ht b hu hv hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ha bi translated"><strong class="ht ip">在数据库和集装箱吞吐量之间进行选择时的考虑事项</strong></p><figure class="jn jo jp jq fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es kb"><img src="../Images/f33bafdc6ca8a3128f6e40188e5a0f50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LvVwd-MWcsk8LU5i5aYTUg.png"/></div></div></figure><figure class="jn jo jp jq fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/04bcdf06dd38ca798d92fe7db3e5199f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O9E3MltOWuTODsNbmkY5oQ.png"/></div></div></figure></div></div>    
</body>
</html>