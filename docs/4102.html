<html>
<head>
<title>Add offline support to any Web app</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向任何Web应用程序添加离线支持</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/add-offline-support-to-any-web-app-c20edc4bea0e?source=collection_archive---------2-----------------------#2016-07-24">https://medium.com/google-developer-experts/add-offline-support-to-any-web-app-c20edc4bea0e?source=collection_archive---------2-----------------------#2016-07-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/74e2e60f74dee724e04c7efbbc319776.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t3bueNVfw0x5axWchxOkSw.jpeg"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx"><a class="ae hu" href="http://blog.htc.com/wp-content/uploads/2013/05/Seashells_TAKAGI.jpg" rel="noopener ugc nofollow" target="_blank">http://blog.htc.com/wp-content/uploads/2013/05/Seashells_TAKAGI.jpg</a></figcaption></figure><div class=""/><p id="14a9" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最近，我参加了<a class="ae hu" href="https://www.angularattack.com/" rel="noopener ugc nofollow" target="_blank"> AngularAttack 2016黑客马拉松</a>，并构建了“<a class="ae hu" href="https://www.angularattack.com/entries/101-angularlabs-london" rel="noopener ugc nofollow" target="_blank">让我看看</a>”:一个帮助失明人士看世界的应用。这个应用程序是使用<a class="ae hu" href="http://blog.ionic.io/built-with-ionic-2-let-me-see/" rel="noopener ugc nofollow" target="_blank"> Ionic2 </a>(当然还有<a class="ae hu" href="https://angular.io/" rel="noopener ugc nofollow" target="_blank"> Angular2 </a>)构建的。但最重要的是，我希望应用程序是渐进式的，所以我添加了对离线缓存的支持，以获得更好的即时加载。让我告诉你我是如何简单快速地添加…</p><blockquote class="js"><p id="b8f7" class="jt ju hx bd jv jw jx jy jz ka kb jr dx translated">哦！对了，《让我看看》得了创新奖！</p></blockquote></div><div class="ab cl kc kd go ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="ha hb hc hd he"><p id="19af" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在我们开始之前，我假设您已经有一个现有的web应用程序。我将使用“让我看看”作为一个例子，但是我们将一起走过的步骤将适用于任何现代的单页面应用程序。</p><p id="d212" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们开始吧。这是我们应用程序的结构…</p><figure class="kk kl km kn fd hj er es paragraph-image"><div class="er es kj"><img src="../Images/034e66488fedc78d56564fcc43876a88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*iIma-I9umOw49SNTkjRqzA.png"/></div></figure><p id="4cb4" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">正如你所看到的，这是一个简单的Ionic2应用程序，带有一些额外的用于<a class="ae hu" href="https://www.firebase.com/" rel="noopener ugc nofollow" target="_blank"> Firebase </a>的配置文件，因为这个应用程序是由<a class="ae hu" href="http://letmesee.firebaseapp.com" rel="noopener ugc nofollow" target="_blank">托管在Firebase</a>上的。但是让我们在另一篇博文中讨论这个问题。</p><p id="5723" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您应该注意到的是<em class="ko">SW-pre cache-config . JSON</em>文件的存在。该文件由<a class="ae hu" href="https://github.com/GoogleChrome/sw-precache" rel="noopener ugc nofollow" target="_blank">维修工人预缓存</a>(<em class="ko">SW-预缓存</em>)工具使用。</p><blockquote class="js"><p id="02d9" class="jt ju hx bd jv jw jx jy jz ka kb jr dx translated"><a class="ae hu" href="http://www.urbandictionary.com/define.php?term=Tl%3BDr&amp;defid=57118" rel="noopener ugc nofollow" target="_blank">Tl；服务工作者预缓存允许我们预缓存应用程序外壳所需的所有必要资源。它还会自动为我们生成服务器工作文件！</a></p></blockquote><p id="c007" class="pw-post-body-paragraph iu iv hx iw b ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn kt jp jq jr ha bi translated">以下是<em class="ko"> sw-precache </em>工具的工作原理…</p><p id="afe9" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">首先，您必须决定是否要将该工具作为命令行界面(CLI)全局使用:</p><pre class="kk kl km kn fd ku kv kw kx aw ky bi"><span id="e5a9" class="kz la hx kv b fi lb lc l ld le">$ npm install --global sw-precache</span></pre><p id="19c8" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">像这样使用它:</p><pre class="kk kl km kn fd ku kv kw kx aw ky bi"><span id="9943" class="kz la hx kv b fi lb lc l ld le">$ sw-precache --sw-file='www/sw.js' \<br/>              --static-file-globs='www/**/*.html'</span></pre><p id="6fd2" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">或者在本地使用您的构建系统:</p><pre class="kk kl km kn fd ku kv kw kx aw ky bi"><span id="36e5" class="kz la hx kv b fi lb lc l ld le">$ npm install --save-dev sw-precache</span></pre><p id="7485" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">并配合自己的构建系统使用(<a class="ae hu" href="http://gulpjs.com/" rel="noopener ugc nofollow" target="_blank"> Gulp </a>、<a class="ae hu" href="https://webpack.github.io/" rel="noopener ugc nofollow" target="_blank">web pack</a>……)。</p><p id="cc45" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">然后，我们需要提供一个配置文件:<em class="ko">SW-pre cache-config . JSON .</em>这是我们的“让我看看”应用程序的外观:</p><pre class="kk kl km kn fd ku kv kw kx aw ky bi"><span id="d21b" class="kz la hx kv b fi lb lc l ld le">{<br/>  "swFile": "www/sw.js",<br/>  "staticFileGlobs": [<br/>    "www/manifest.json",<br/>    "www/**/*.css",<br/>    "www/**/*.{ttf,woff,woff2,eof}",<br/>    "www/**/*.js",<br/>    "www/**/*.html",<br/>    "www/**/*.{png,jpg,gif,svg,mp3}"<br/>  ],<br/>  "handleFetch": true,<br/>  "stripPrefix": "www/",<br/>  "cacheId": "let-me-see-v1",<br/>  "maximumFileSizeToCacheInBytes": 4194304,<br/>  "ignoreUrlParametersMatching": "[/./]",<br/>  "verbose": true<br/>}</span></pre><p id="cc57" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我快速解释一下其中的一些选项:</p><ul class=""><li id="d482" class="lf lg hx iw b ix iy jb jc jf lh jj li jn lj jr lk ll lm ln bi translated"><strong class="iw hy"> swFile </strong>:将要生成的service worker文件的路径(这个选项没有记载——参见<a class="ae hu" href="https://github.com/GoogleChrome/sw-precache/blob/master/cli.js#L36" rel="noopener ugc nofollow" target="_blank">这个文件</a>)；</li><li id="0dea" class="lf lg hx iw b ix lo jb lp jf lq jj lr jn ls jr lk ll lm ln bi translated"><strong class="iw hy"> staticFileGlobs </strong>:一个或多个字符串模式的数组。这些文件将被缓存并脱机使用；</li><li id="c59b" class="lf lg hx iw b ix lo jb lp jf lq jj lr jn ls jr lk ll lm ln bi translated"><strong class="iw hy"> handleFetch </strong>:确定<em class="ko"> fetch </em>事件处理程序是否包含在生成的服务工作者代码中；</li><li id="0542" class="lf lg hx iw b ix lo jb lp jf lq jj lr jn ls jr lk ll lm ln bi translated"><strong class="iw hy"> cacheId </strong>:用于区分缓存的字符串；</li><li id="0a4e" class="lf lg hx iw b ix lo jb lp jf lq jj lr jn ls jr lk ll lm ln bi translated"><strong class="iw hy">maximumFileSizeToCacheInBytes</strong>:设置预缓存列表中文件允许的最大大小(<a class="ae hu" href="https://github.com/GoogleChrome/sw-precache/pull/113" rel="noopener ugc nofollow" target="_blank">不客气</a>)；</li><li id="cc6f" class="lf lg hx iw b ix lo jb lp jf lq jj lr jn ls jr lk ll lm ln bi translated"><strong class="iw hy"> stripPrefix </strong>:在运行时从路径URL的开头删除指定的字符串。</li></ul><p id="9598" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">你可以在<a class="ae hu" href="https://github.com/GoogleChrome/sw-precache#options-parameter" rel="noopener ugc nofollow" target="_blank"> github库</a>中阅读关于这些选项的更详细的文档。</p><p id="bb76" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在我们已经安装好了<em class="ko"> sw-precache </em>工具。我们需要让它与我们的应用程序一起工作。我选择使用<em class="ko"> sw-precache </em>作为吞咽任务，因为Ionic2将它用作构建系统。它甚至提供了挂钩，您可以在其中添加您的定制构建任务。</p><p id="1616" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">那么，让我们创建我们的吞咽任务:</p><pre class="kk kl km kn fd ku kv kw kx aw ky bi"><span id="0997" class="kz la hx kv b fi lb lc l ld le">gulp.task('sw', function(callback) {<br/>  var path = require('path');<br/>  var swPrecache = require('sw-precache');<br/>  var rootDir = 'www';<br/>  var options = <strong class="kv hy">require('./sw-precache-config.json');</strong><br/>  options.ignoreUrlParametersMatching = [/./];<br/>  swPrecache.write(path.join(rootDir, 'sw.js'), options, callback);<br/>});</span></pre><p id="d5d4" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">然后，我们在构建任务之后调用我们的任务，这样当构建完成时，<em class="ko"> sw-precache </em>工具可以为我们生成服务器工作进程:</p><pre class="kk kl km kn fd ku kv kw kx aw ky bi"><span id="accb" class="kz la hx kv b fi lb lc l ld le">//...<br/>gulp.task('build:after', [<strong class="kv hy">'sw'</strong>]);<br/>//...</span></pre><p id="284a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">可选地，我们也可以在<em class="ko">观察</em>任务期间运行<em class="ko">软件</em>任务。这意味着每次在应用程序中编辑文件时，都会自动生成服务工作器:</p><pre class="kk kl km kn fd ku kv kw kx aw ky bi"><span id="4c7f" class="kz la hx kv b fi lb lc l ld le">gulp.task('watch', ['clean'], function(done){<br/>  runSequence(<br/>    ['sass', 'html', 'fonts', 'scripts'],<br/>    <strong class="kv hy">'sw',</strong><br/>    function(){ //...</span></pre><p id="d211" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我也强烈推荐你关闭<strong class="iw hy"> handleFetch </strong>选项，基本上就是关闭<em class="ko"> fetch </em>事件。否则，内容将总是由服务工作者缓存提供；并且您的实时重新加载设置可能无法按预期工作。</p><p id="d123" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">就是这样。你完了！</p><p id="8175" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，您已经为您的Web应用程序添加了离线支持。你可以在github 上看到“让我看看”<a class="ae hu" href="https://github.com/manekinekko/angularattack2016/blob/master/www/sw.js" rel="noopener ugc nofollow" target="_blank">的完全自动生成的服务工人。</a></p><p id="0bc7" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最后但同样重要的是，不要忘记在您的<em class="ko">index.html</em>中注册该服务人员:</p><pre class="kk kl km kn fd ku kv kw kx aw ky bi"><span id="57bb" class="kz la hx kv b fi lb lc l ld le">&lt;script&gt;<br/>   if('serviceWorker' in navigator) {<br/>     navigator.serviceWorker.register('sw.js');<br/>   }<br/>&lt;/script&gt;</span></pre><div class="hg hh ez fb hi lt"><a href="https://github.com/manekinekko/angularattack2016" rel="noopener  ugc nofollow" target="_blank"><div class="lu ab dw"><div class="lv ab lw cl cj lx"><h2 class="bd hy fi z dy ly ea eb lz ed ef hw bi translated">manekinekko/angularattack2016</h2><div class="ma l"><h3 class="bd b fi z dy ly ea eb lz ed ef dx translated">angularattack2016 -让我看看:失明人士的助手应用</h3></div><div class="mb l"><p class="bd b fp z dy ly ea eb lz ed ef dx translated">github.com</p></div></div><div class="mc l"><div class="md l me mf mg mc mh ho lt"/></div></div></a></div></div><div class="ab cl kc kd go ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="ha hb hc hd he"><p id="02b8" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="ko">关注</em><a class="ae hu" href="https://twitter.com/manekinekko" rel="noopener ugc nofollow" target="_blank"><em class="ko">@ manekinekko</em></a><em class="ko">了解更多网络平台。</em></p></div></div>    
</body>
</html>