<html>
<head>
<title>Selfie2Anime with TFLite — Part 2: TFLite Model</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带TFLite的self ie 2动画第2部分:TFLite模型</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/selfie2anime-with-tflite-part-2-tflite-model-84002cf521dc?source=collection_archive---------2-----------------------#2020-07-15">https://medium.com/google-developer-experts/selfie2anime-with-tflite-part-2-tflite-model-84002cf521dc?source=collection_archive---------2-----------------------#2020-07-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="0760" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由ML GDEs<a class="ae jc" href="https://twitter.com/margaretmz" rel="noopener ugc nofollow" target="_blank">Margaret Maynard-Reid</a>和<a class="ae jc" href="https://twitter.com/RisingSayak" rel="noopener ugc nofollow" target="_blank"> Sayak Paul </a>撰写|由<a class="ae jc" href="https://twitter.com/khanhlvg" rel="noopener ugc nofollow" target="_blank"> Khanh LeViet </a>和<a class="ae jc" href="https://twitter.com/hoitab" rel="noopener ugc nofollow" target="_blank"> Hoi Lam </a>审阅</p><p id="fc4c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是关于如何将TF 1.x模型转换为TensorFlow Lite (TFLite)的端到端教程的第2部分，然后将其部署到Android上，以便将自拍图像转换为看似真实的动画。(<a class="ae jc" rel="noopener" href="/@margaretmz/selfie2anime-with-tflite-part-1-overview-f97500800ffe">Part 1</a>|<a class="ae jc" rel="noopener" href="/@margaretmz/selfie2anime-with-tflite-part-2-tflite-model-84002cf521dc">Part 2</a>|<a class="ae jc" rel="noopener" href="/@margaretmz/selfie2anime-with-tflite-part-3-android-app-e47f8a2c92b2">Part 3</a>)本教程是<a class="ae jc" href="https://github.com/margaretmz/awesome-tflite" rel="noopener ugc nofollow" target="_blank"> awesome-tflite </a>系列E2E TFLite教程的第一篇。</p><p id="995b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下是逐步总结:</p><ul class=""><li id="27ce" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">从预训练的U-GAT-IT模型检查点生成一个<code class="du jm jn jo jp b">SavedModel</code>。</li><li id="82dd" class="jd je hh ig b ih jq il jr ip js it jt ix ju jb ji jj jk jl bi translated">使用最新的<code class="du jm jn jo jp b">TFLiteConverter</code>转换SavedModel</li><li id="0a0a" class="jd je hh ig b ih jq il jr ip js it jt ix ju jb ji jj jk jl bi translated">使用转换后的模型在Python中运行推理</li><li id="153c" class="jd je hh ig b ih jq il jr ip js it jt ix ju jb ji jj jk jl bi translated">添加元数据以实现与移动应用的轻松集成</li><li id="a3f1" class="jd je hh ig b ih jq il jr ip js it jt ix ju jb ji jj jk jl bi translated">运行模型基准以确保模型在移动设备上运行良好</li></ul><h1 id="29b1" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">使用TF1保存模型—从预先训练的检查点创建保存的模型</h1><p id="c548" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">请注意，该部分需要在TensorFlow 1.x运行时运行。我们使用TensorFlow 1.14，因为这是编写模型代码的版本。</p><p id="a1fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">U-GAT-IT作者提供了两个检查点:一个在<a class="ae jc" href="https://drive.google.com/file/d/1V6GbSItG3HZKv3quYs7AP0rr1kOCT3QO/view?usp=sharing" rel="noopener ugc nofollow" target="_blank"> 50个时期</a>后提取(约4.6GB)，另一个在<a class="ae jc" href="https://drive.google.com/file/d/19xQK2onIy-3S5W5K-XIh85pAg_RNvBVf/view?usp=sharing" rel="noopener ugc nofollow" target="_blank"> 100个时期</a>后提取(4.7GB)。我们将使用Kaggle的一个更轻便的版本，适合基于移动的部署。</p><h1 id="99f4" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">从Kaggle下载并提取模型检查点</h1><p id="1393" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">所以，重要的事情先来！让我们用<a class="ae jc" href="https://github.com/Kaggle/kaggle-api" rel="noopener ugc nofollow" target="_blank"> Kaggle API </a>从Kaggle下载检查点。在kaggle.com上，进入我的帐户/API，点击“创建新的API令牌”，这将触发<strong class="ig hi"> kaggle </strong>的下载。json，包含您的<strong class="ig hi"> API </strong>凭证。然后在Colab中，您可以指定以下内容并设置环境变量-</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="62b1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们下载检查点并提取它们-</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="debf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">加载模型检查点，连接张量</strong></p><p id="eea4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该步骤通常因型号而异。此步骤遵循的一般工作流程如下:</p><ol class=""><li id="c9f2" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb lf jj jk jl bi translated">定义模型的输入和输出张量。</li><li id="1bb7" class="jd je hh ig b ih jq il jr ip js it jt ix ju jb lf jj jk jl bi translated">实例化模型并连接输入和输出张量，从而可以构建计算图。</li><li id="15b5" class="jd je hh ig b ih jq il jr ip js it jt ix ju jb lf jj jk jl bi translated">在模型图中加载预先训练的检查点。</li><li id="ef00" class="jd je hh ig b ih jq il jr ip js it jt ix ju jb lf jj jk jl bi translated">生成SavedModel。</li></ol><p id="6946" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">值得注意的是，该工作流程中的<strong class="ig hi">步骤2 </strong>可能因型号而异，因此很难事先知道。对于这一节，我们将只关注理解代码的重要部分，对于完整的实现，请查看本教程附带的C <a class="ae jc" href="https://github.com/margaretmz/selfie2anime-e2e-tutorial/blob/master/ml/Selfie2Anime_Model_Conversion.ipynb" rel="noopener ugc nofollow" target="_blank"> olab笔记本</a>。</p><p id="b0db" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们的例子中，输入和输出张量及其细节可以从主模型类的实例中访问。所以，我们将从实例化UGATIT模型类的实例开始-</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="55d2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du jm jn jo jp b">data</code>指型号配置，此处<a class="ae jc" href="https://github.com/taki0112/UGATIT/blob/master/main.py" rel="noopener ugc nofollow" target="_blank">可见</a>。<code class="du jm jn jo jp b">UGATIT</code>级来自这里的<a class="ae jc" href="https://github.com/taki0112/UGATIT/blob/master/UGATIT.py" rel="noopener ugc nofollow" target="_blank"/>。此时，我们的模型应该已经被实例化了。现在我们需要通过加载检查点的会话将检查点加载到模型中，这就是<code class="du jm jn jo jp b">load_checkpoint()</code>方法所做的</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="15fa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此时，创建<code class="du jm jn jo jp b">SavedModel</code>只需要几次击键。记住我们仍然在<code class="du jm jn jo jp b">Session</code>的背景下。</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="5123" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正如我们在上面的代码中看到的，可以从模型图本身访问输入和输出张量。执行完这段代码后，我们应该已经准备好了<code class="du jm jn jo jp b">SavedModel</code>文件。我们可以继续将这个<code class="du jm jn jo jp b">SavedModel</code>转换成TFLite模型。</p><h1 id="077a" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">准备TFLite模型</h1><p id="176c" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">是时候转向TensorFlow 2.x (2.2.0或任何更高的夜间版本)了。在这一节中，我们将使用我们之前生成的<code class="du jm jn jo jp b">SavedModel</code>，并将其转换为一个TFLite平面缓冲区，其大小约为<strong class="ig hi"> 10 MB </strong>，完全可用于移动应用程序。然后，我们将使用一些最新的TensorFlow Lite工具来准备部署模型:</p><ul class=""><li id="8e21" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">使用TFLite模型在Python中运行推理，以确保它在转换后是好的。</li><li id="73ae" class="jd je hh ig b ih jq il jr ip js it jt ix ju jb ji jj jk jl bi translated">通过Android Studio的ML模型绑定插件，向TFLite模型添加元数据，使其更容易集成到Android应用程序中。</li><li id="4507" class="jd je hh ig b ih jq il jr ip js it jt ix ju jb ji jj jk jl bi translated">使用基准测试工具来查看该模型在移动设备上的表现。</li></ul><h1 id="9c51" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">使用TF2将SavedModel转换为TFLite</h1><p id="2e46" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">首先，我们加载保存的模型文件，并从它们中创建一个<a class="ae jc" href="https://www.tensorflow.org/guide/concrete_function" rel="noopener ugc nofollow" target="_blank">具体函数</a></p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="edbb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以这种方式进行转换的优点是，它使我们能够灵活地设置生成的TFLite模型的输入和输出张量的形状。你可以在下面的代码片段中看到这一点-</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="6217" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">建议使用在相应地训练模型期间使用的输入和输出张量的原始形状。在这种情况下，该形状为(1，256，256，3)，1表示批次维度。这是必需的，因为模型期望数据采用以下形式:BATCH_SIZE、IMAGE_SHAPE、IMAGE_SHAPE、NB_CHANNELS。为了进行实际的转换，我们运行以下代码-</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="9195" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">除非我们为<code class="du jm jn jo jp b">converter</code>明确指定任何优化选项，否则模型仍然是浮动模型。您可以从<a class="ae jc" href="https://www.tensorflow.org/lite/performance/model_optimization" rel="noopener ugc nofollow" target="_blank">这里</a>探索TFLite中可用的不同优化选项。</p><h1 id="5f88" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">使用TFLite模型运行推理</h1><p id="47f0" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">在转换之后和部署<code class="du jm jn jo jp b">.tflite</code>模型之前，在Python中运行推理来确认它是否按预期工作总是一个好的实践。</p><p id="ea50" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们已经在一些人脸上尝试了该模型，结果表明它在女性人脸上比男性人脸上产生了更好的结果。仔细观察训练数据集，发现所有人脸都是女性人脸，并且模型存在偏差，因为模型只在女性人脸上训练。</p><p id="9fb5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下是测试结果的屏幕:</p><figure class="ky kz la lb fd lc er es paragraph-image"><div class="er es lg"><img src="../Images/d6da4669ab8d7c5b0c5442f2283f26a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:750/format:webp/1*WYibjX_jwKHjTWVgzvbeLQ.png"/></div></figure><h1 id="4cae" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">向TFLite模型添加元数据</h1><p id="6996" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">让我们向TensorFlow模型添加元数据，这样我们就可以在Android上自动生成模型推理代码。</p><p id="1bf2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">选项A:通过命令行</strong></p><p id="2c17" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您通过命令行使用Python脚本添加元数据，请确保首先在conda或virtualenv环境中使用<code class="du jm jn jo jp b">pip install tflite-support</code>。并按如下方式设置文件夹结构:</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="7515" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后使用metadata _ writer _ for _ selfie 2 anime . py脚本将元数据添加到selfie2anime.tflite模型中:</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="cf05" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">选项a B:通过Colab </strong></p><p id="ba0c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">或者，你可以用这个<a class="ae jc" href="https://github.com/margaretmz/selfie2anime-e2e-tutorial/blob/master/ml/add-meta-data-Colab/Add%20metadata%20to%20selfie2anime.ipynb" rel="noopener ugc nofollow" target="_blank"> Colab笔记本</a>来代替。记得先还<code class="du jm jn jo jp b">$pip install tflite-support</code>。如果您不熟悉在命令行中运行Python脚本，这个选项可能更容易。你只需要在浏览器中启动笔记本，上传selfie2anime.tflite文件，执行所有单元格。</p><p id="a2ce" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">添加元数据</strong></p><p id="d960" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在<code class="du jm jn jo jp b">model_with_metadata</code>文件夹下创建了两个新文件<code class="du jm jn jo jp b">selfie2anime.tflite</code>和<code class="du jm jn jo jp b">selfie2anime.json</code>。这个新的<code class="du jm jn jo jp b">selfie2anime.tflite</code>包含模型元数据，在将模型部署到Android时，我们可以将它用作Android Studio中ML模型绑定的输入。而<code class="du jm jn jo jp b">selfie2anime.json</code>是让你验证加入模型的元数据是否正确。</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="5442" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要了解更多关于TFLite元数据如何工作的信息，请参考这里的文档<a class="ae jc" href="https://www.tensorflow.org/lite/convert/metadata" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="ee22" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">Android上的性能指标评测模型(可选)</h1><p id="0133" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">作为一个可选步骤，我们在部署之前使用了TFLite Android模型基准测试工具来获得Android上的运行时性能。详情请参考基准工具上的说明。</p><p id="9509" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下是高级汇总步骤:</p><ul class=""><li id="c3ff" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">配置Android NDK/SDK——有一些Android SDK/NDK的先决条件，然后用bazel构建工具。</li><li id="908a" class="jd je hh ig b ih jq il jr ip js it jt ix ju jb ji jj jk jl bi translated">构建基准apk</li></ul><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><ul class=""><li id="092b" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">使用adb (Android Debug Bridge)安装基准测试工具，并将selfie2anime.tflite模型推送到Android设备:</li></ul><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><ul class=""><li id="6f46" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">运行基准测试工具</li></ul><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="dfc9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们看到的基准测试结果如下——有点慢:<em class="lj">美国的推理计时:Init: 7135，第一次推理:7428506，预热(平均):7.42851e+06，推理(平均):7.26313e+06 </em></p><figure class="ky kz la lb fd lc er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lk"><img src="../Images/db07bcf2b1de212b25ed9e9242e346bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E_9dn6aWMbikMlNq"/></div></div></figure></div><div class="ab cl lp lq go lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ha hb hc hd he"><p id="c6f9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在您已经有了一个TensorFlow Lite模型，让我们看看如何在Android上实现这个模型(<a class="ae jc" rel="noopener" href="/@margaretmz/selfie2anime-with-tflite-part-3-android-app-e47f8a2c92b2">第3部分</a>)。</p></div></div>    
</body>
</html>