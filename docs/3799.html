<html>
<head>
<title>Terraform Modules : Package and Reuse</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform模块:打包和重用</h1>
<blockquote>原文：<a href="https://medium.com/globant/terraform-modules-package-and-reuse-50d5ec0d5f9d?source=collection_archive---------1-----------------------#2021-12-23">https://medium.com/globant/terraform-modules-package-and-reuse-50d5ec0d5f9d?source=collection_archive---------1-----------------------#2021-12-23</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="9697" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">介绍</h1><p id="fba5" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">随着公共云提供商(如AWS、Google和Microsoft)越来越受欢迎，基础设施即代码(IaC)已经成为主流实践。简而言之，它包括管理一组资源(计算、网络、存储等)。)使用类似于开发人员管理应用程序代码的方法。</p><p id="b418" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">在本文中，我们将快速浏览一下Terraform模块，看看如何创建Terraform模块，使用户能够在任何地方使用相同的代码，并通过使用变量对其进行定制。</p><p id="f4a4" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">Terraform模块允许您将基础架构的不同资源组合成一个统一的资源。您可以在以后进行可能的定制时重用它们，而不必在每次需要时重复资源定义，这对于具有复杂结构的大型项目是有益的。您可以使用您定义的输入变量定制模块实例，也可以使用输出从它们中提取信息。除了创建你自己的定制模块，现有的模块可以在<a class="ae kf" href="https://registry.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform Registry </a>公开获得。</p><h1 id="c018" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">地形模块背景</strong></h1><p id="87b4" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated"><strong class="je hi">模块:打包复用码</strong></p><p id="f077" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">Terraform模块相当于脚本或编程语言中的函数或方法。它们通过提供输入和返回输出来提供创建资源的标准接口。模块还通过增加可读性和允许团队在逻辑块中组织基础设施来简化项目。模块可以很容易地共享，并提供给任何Terraform项目。例如，如果任务是为不同的环境创建多个VPC，则可以多次调用单个VPC模块，而不是为一个完整运行的VPC创建每个必要的资源。</p><p id="ba2e" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">模块结构包含Terraform文件，如<strong class="je hi"> main.tf、output.tf、provider.tf、variable.tf </strong>和<strong class="je hi"> terraform.tfvars.json </strong>。</p><p id="6102" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">让我们理解这些文件的意义:</p><p id="7895" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">provider . TF:-</strong>Terraform依靠名为“providers”的插件与云提供商、SaaS提供商和其他API进行交互。要使用来自给定提供者的资源，您需要在配置中包含关于它的一些信息。由于我们在示例中创建了AWS资源，所以我们在下图中使用AWS作为提供者。</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="cd8f" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi"> main.tf :- </strong>这个文件包含资源配置。参数可以提供输入来定制资源，如下所示:</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="7b91" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi"> variable.tf :- </strong>我们使用这个文件来提及我们已经在<a class="ae kf" href="http://main.tf" rel="noopener ugc nofollow" target="_blank"> main.tf </a>文件中参数化的所有输入变量，如下所示:</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="e90a" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi"> output.tf :- </strong>在这个文件中，我们为模块中引用的资源生成输出。我们已经生成了安全组id的输出，如下所示:</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="964d" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi"> terraform.tfvars.json :- </strong>这是我们向变量传递值的重要文件。我们只需要按照我们的要求在这个文件中进行更改，其余的配置将可以在任何地方重用。</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="1db5" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">动态块:- </strong>最后但同样重要的是，动态块是Terraform提供的最佳特性之一。在像resources这样的顶级块构造中，表达式通常只能在使用<strong class="je hi"> name = expression </strong>形式为参数赋值时使用。这涵盖了许多用途，但有些资源类型在其参数中包含可重复的嵌套块，这些嵌套块通常表示与包含对象相关(或嵌入其中)的独立对象。您可以使用特殊的动态块类型动态构造可重复的嵌套块，这在<strong class="je hi">资源、数据、提供者</strong>和<strong class="je hi"> provisioner </strong>块中受到支持。</p><p id="2c7b" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">我在代码中使用了动态块来实际理解这一点。通常，用户将能够只允许有限的IP访问安全规则资源中的特定端口。但是使用动态块，用户可以向任何端口添加任意数量的IP。在下图中，我们展示了一个动态块的例子。</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><h1 id="fd73" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">先决条件</h1><ul class=""><li id="83a7" class="kn ko hh je b jf jg jj jk jn kp jr kq jv kr jz ks kt ku kv bi translated">Terraform安装包含一个二进制文件，我们可以从Hashicorp的<a class="ae kf" href="https://www.terraform.io/downloads.html" rel="noopener ugc nofollow" target="_blank">下载页面免费下载。</a></li><li id="8d46" class="kn ko hh je b jf kw jj kx jn ky jr kz jv la jz ks kt ku kv bi translated">代码编辑器，如Visual Studio代码或Atom。</li><li id="14d8" class="kn ko hh je b jf kw jj kx jn ky jr kz jv la jz ks kt ku kv bi translated">创建资源的云提供商凭据和权限。</li></ul><h1 id="b567" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">地形模块结构</h1><p id="9959" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在本节中，我们将定义文件夹结构来映射所有Terraform代码。所以这里我们创建了2个文件夹，一个是<strong class="je hi">模块</strong>另一个是<strong class="je hi">资源</strong>。</p><p id="7db3" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">Terraform总是在单个根模块的上下文中运行。一个完整的地形配置包括一个根模块和子模块树(包括根模块调用的模块，这些模块调用的任何模块，等等)。)</p><p id="2e1b" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">模块:- </strong>在模块文件夹中，我们需要添加我们想要创建的所有资源配置。我们将为我们的示例创建一个EC2实例和一个安全组。</p><p id="39cf" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">AWS EC2实例和安全组都创建了terraform文件，如main.tf、outputs.tf和variable.tf。</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="5e0d" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi"> Resources :- </strong>在Resources文件夹中，我们将调用在modules文件夹中创建的模块。我们调用EC2实例模块中的安全组模块，这样安全组将自动连接到EC2。在创建安全组资源时，我们已经从output.tf文件中生成了安全组输出。</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><h1 id="0405" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">地形执行</h1><p id="4a9f" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated"><strong class="je hi">地形初始化:-</strong><strong class="je hi">地形初始化</strong>命令用于初始化包含地形配置文件的工作目录。这是在编写新的Terraform配置或从版本控制中克隆现有配置后应该运行的第一个命令。多次运行该命令是安全的。Terraform依靠称为“提供商”的插件来与云提供商、SaaS提供商和其他API进行交互。</p><p id="d9e9" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi"> terraform init </strong>搜索提供者的配置，然后安装任何与提供者相关的插件。</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lb"><img src="../Images/c0c3dacb1f0974f2c4bc7a9c09aa859a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sP8ksxZ9JgkD1iZe"/></div></div></figure><p id="8703" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">地形计划:-</strong><strong class="je hi">地形计划</strong>命令用于创建一个执行计划。除非明确禁用，否则Terraform会执行刷新，然后确定需要执行哪些操作才能达到配置文件中指定的所需状态。</p><p id="780b" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">地形应用:-</strong><strong class="je hi">地形应用</strong>命令执行地形计划中提出的动作。在执行之后，我们可以看到已经创建了两个资源(EC2实例和安全组),我们还可以看到为安全组id生成的输出。</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lb"><img src="../Images/90ba4d19a7b45da1220c44f794c2d72a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7al06sWHcznEkg0j"/></div></div></figure><p id="460c" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">地形摧毁:- </strong>我们可以用<strong class="je hi">地形摧毁</strong>命令摧毁已创建的基础设施。</p><h1 id="fcdd" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">结论</h1><p id="5e7a" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在这篇文章的剩余部分，我们将通过深入Terraform模块来搭建舞台。如果你从未使用过Terraform，并且正在寻找更多的实践经验，哈希公司网站上的<a class="ae kf" href="https://learn.hashicorp.com/terraform" rel="noopener ugc nofollow" target="_blank">教程</a>会很有用。让我们来谈谈平台提供商。Terraform服务的云提供商超过100家。在Fairwinds，我们使用Terraform的三种型号，即<a class="ae kf" href="https://www.terraform.io/docs/providers/aws/index.html" rel="noopener ugc nofollow" target="_blank"> AWS </a>、<a class="ae kf" href="https://www.terraform.io/docs/providers/google/index.html" rel="noopener ugc nofollow" target="_blank"> GCP </a>和<a class="ae kf" href="https://www.terraform.io/docs/providers/azurerm/index.html" rel="noopener ugc nofollow" target="_blank">天蓝色</a>。提供者支持与特定API的接口，并公开您定义的任何资源。HCL，或HashiCorp语言，是用于定义资源的通用语言，不管使用什么提供者。</p><h1 id="fd6a" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">参考</h1><p id="e5e9" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated"><a class="ae kf" href="https://www.terraform.io/language/modules/develop" rel="noopener ugc nofollow" target="_blank">https://www.terraform.io/language/modules/develop</a></p><p id="a6ba" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><a class="ae kf" href="https://www.terraform.io/language/expressions/dynamic-blocks" rel="noopener ugc nofollow" target="_blank">https://www . terraform . io/language/expressions/dynamic-blocks</a></p><p id="22a5" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">【https://registry.terraform.io/browse/modules T4】</p><p id="5e2b" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><a class="ae kf" href="https://github.com/nileshjaiwal/Terraform-Modules" rel="noopener ugc nofollow" target="_blank">https://github.com/nileshjaiwal/Terraform-Modules</a></p></div></div>    
</body>
</html>