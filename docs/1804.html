<html>
<head>
<title>Using CloudFormation to Create DynamoDB Global Tables</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CloudFormation创建DynamoDB全局表</h1>
<blockquote>原文：<a href="https://medium.com/capital-one-tech/using-cloudformation-to-create-dynamodb-global-tables-2af8597f8a0e?source=collection_archive---------5-----------------------#2021-07-06">https://medium.com/capital-one-tech/using-cloudformation-to-create-dynamodb-global-tables-2af8597f8a0e?source=collection_archive---------5-----------------------#2021-07-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="26df" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">使用CloudFormation在AWS中自动创建DynamoDB基础设施</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/5d14c16af0df83a17e25a1c59ee66b1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FNslZkaLg4Kw7E2f.jpg"/></div></div></figure><p id="0389" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">2021年5月，AWS发布了对DynamoDB全局表的云形成支持。这个备受期待的特性对于那些希望自动化DynamoDB部署的人来说是一个福音。</p><p id="d5ec" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">DynamoDB有许多很棒的特性，这使它成为AWS平台上增长最快的数据存储之一。DynamoDB的主要特性之一是<a class="ae ke" href="https://aws.amazon.com/dynamodb/global-tables/" rel="noopener ugc nofollow" target="_blank">全局表</a>，它允许您跨区域无缝复制数据。我以前在这个博客上写过DynamoDB和全局表的许多<a class="ae ke" href="https://www.capitalone.com/tech/software-engineering/comparing-dynamodb-and-aurora-global-database-and-aurora-multi-master/" rel="noopener ugc nofollow" target="_blank">好处。然而，到目前为止，DynamoDB还缺少一个关键特性:<em class="kf">全局表的自动部署。</em></a></p><h1 id="2804" class="kg kh hh bd ki kj kk kl km kn ko kp kq in kr io ks iq kt ir ku it kv iu kw kx bi translated">将DynamoDB与CloudFormation一起使用</h1><p id="ecad" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated">如果您不熟悉DynamoDB全局表，这个特性允许您将DynamoDB数据库实时复制到其他区域。全局表格提供了几个好处:</p><ul class=""><li id="590e" class="ld le hh jk b jl jm jo jp jr lf jv lg jz lh kd li lj lk ll bi translated">可以在本地区域访问数据，从而提高性能。</li><li id="a218" class="ld le hh jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll bi translated">全局表的主动-主动特性允许每个区域中的更新实时自动复制到其他区域。</li><li id="9e70" class="ld le hh jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll bi translated">由于每个区域都有一份数据副本，提高了数据存储的可用性和持久性，因此获得了跨区域容错能力。</li></ul><p id="0184" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">CloudFormation允许您通过使用模板文件来提供AWS资源，提供基础设施即代码功能。虽然本文专门关注DynamoDB，但是CloudFormation允许您自动创建大多数AWS资源。</p><p id="275d" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">虽然你可以自己阅读<a class="ae ke" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-dynamodb-globaltable.html" rel="noopener ugc nofollow" target="_blank"> CloudFormation文档</a>，但是有一些重要的概念需要记住。全局表被视为顶级组件，等同于标准DynamoDB表，但与标准dynamo db表不同。全局表配置与DynamoDB表共享许多相同的元素，但是有些元素是在副本内部基于每个区域配置的，比如标记。在CloudFormation模板(CFT)中，每个副本都被配置为一个对等体，每个表都在一个列表中定义。这在概念上不同于在AWS控制台中设置DynamoDB表，在AWS控制台中，您通常创建一个初始表，然后在初始表的其他区域中添加全局表。</p><h1 id="06f3" class="kg kh hh bd ki kj kk kl km kn ko kp kq in kr io ks iq kt ir ku it kv iu kw kx bi translated">创建CloudFormation模板的注意事项</h1><p id="5c25" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated">在为DynamoDB全局表创建CloudFormation模板时，需要注意一些限制和特性。</p><ul class=""><li id="ae32" class="ld le hh jk b jl jm jo jp jr lf jv lg jz lh kd li lj lk ll bi translated">CloudFormation仅支持2019.11.21版本的全局表，目前不支持2017.11.29版本。</li><li id="9bce" class="ld le hh jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll bi translated">如果您试图创建一个与同一区域中现有表同名的全局表，则现有表可能会被删除。</li><li id="8a3f" class="ld le hh jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll bi translated">在部署CFT堆栈的同一区域中，必须至少存在一个副本。例如，如果您从us-east-1部署CFT堆栈，则至少有一个副本也必须在us-east-1中。</li></ul><h1 id="36b1" class="kg kh hh bd ki kj kk kl km kn ko kp kq in kr io ks iq kt ir ku it kv iu kw kx bi translated">配置全局表的注意事项</h1><p id="4707" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated">在配置全局表时，一些属性已经在主配置和各个副本之间进行了拆分。</p><ul class=""><li id="8583" class="ld le hh jk b jl jm jo jp jr lf jv lg jz lh kd li lj lk ll bi translated">使用服务器端加密时，属性SSEEnabled和SSEType在模板的主要部分指定，但KMSMasterKeyId在每个副本下指定。当您考虑到KMS键是特定于地区的，并且在每个地区可能有不同的名称时，这是有意义的。尽管为了清楚起见，坚持地区之间的通用命名转换是有意义的。</li><li id="2ce6" class="ld le hh jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll bi translated">最初创建CFT时，只能指定两个复本。如果需要两个以上的副本，则需要更新CFT，但每次更新只能添加或移除一个副本。</li></ul><h1 id="8c76" class="kg kh hh bd ki kj kk kl km kn ko kp kq in kr io ks iq kt ir ku it kv iu kw kx bi translated">DynamoDB全局表示例</h1><p id="a6d1" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated">以下模板在us-east-1和us-west-1中创建了一个名为<em class="kf"> mytable </em>的DynamoDB全局表。</p><pre class="ix iy iz ja fd lr ls lt lu aw lv bi"><span id="6ebb" class="lw kh hh ls b fi lx ly l lz ma">AWSTemplateFormatVersion: 2010-09-09<br/>Description: AWS CloudFormation Template to create global tables<br/>Parameters: {}<br/>Resources:<br/>  globalTableExample:<br/>    Type: 'AWS::DynamoDB::GlobalTable'<br/>    Properties:<br/>      TableName: mytable<br/>      AttributeDefinitions:<br/>        - AttributeName: PK<br/>          AttributeType: S<br/>      KeySchema:<br/>        - AttributeName: PK<br/>          KeyType: HASH<br/>      BillingMode: PAY_PER_REQUEST<br/>      StreamSpecification:<br/>      StreamViewType: NEW_AND_OLD_IMAGES<br/>      SSESpecification:<br/>      SSEEnabled: true<br/>      SSEType: "KMS"<br/>      Replicas:<br/>        - Region: us-east-1<br/>          PointInTimeRecoverySpecification:<br/>          PointInTimeRecoveryEnabled: true<br/>          SSESpecification:<br/>            KMSMasterKeyId: alias/dynamodb-key-east<br/>          Tags:<br/>            - Key: Name<br/>              Value: mytable<br/>            - Key: Region<br/>              Value: east<br/>        - Region: us-west-1<br/>          PointInTimeRecoverySpecification:<br/>          PointInTimeRecoveryEnabled: true<br/>          SSESpecification:<br/>            KMSMasterKeyId: alias/dynamodb-key-west<br/>          Tags:<br/>            - Key: Name<br/>              Value: mytable<br/>            - Key: Region<br/>              Value: west</span></pre><p id="48d9" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">正如我前面提到的，有些属性是全局表共有的，包括一些特定于区域的属性，还有一些属性的完整定义分布在通用属性和特定于区域的属性之间。</p><ul class=""><li id="f6e9" class="ld le hh jk b jl jm jo jp jr lf jv lg jz lh kd li lj lk ll bi translated">表名在所有地区都是通用的，无论是通过CloudFormation、AWS控制台还是其他方法创建，都是如此。</li><li id="37fb" class="ld le hh jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll bi translated">标签是特定于区域的，并在每个副本的定义下声明。</li><li id="206a" class="ld le hh jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll bi translated">SSESpecifiction部分位于模板的主要部分，部分位于每个副本中。</li></ul><p id="0bb2" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">阅读和理解模板定义很重要，因为将元素放在错误的部分会导致CloudFormation失败。当我将测试模板从常规的DynamoDB表转换为全局表时，我自己也犯了这个错误。</p><p id="b762" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">如果您是DynamoDB的新手，并且希望自动化您的表创建过程，CloudFormation是一个可以考虑使用的好工具。如果您像我一样使用DynamoDB已经有一段时间了，这是一个受欢迎的新增功能，最终允许以前需要手动步骤或定制脚本的流程实现自动化。在我个人看来，自动化程度越高越好！</p></div><div class="ab cl mb mc go md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ha hb hc hd he"><p id="9b63" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="kf">最初发表于</em><a class="ae ke" href="https://www.capitalone.com/tech/cloud/dynamodb-global-tables-with-cloudformation/" rel="noopener ugc nofollow" target="_blank">T5【https://www.capitalone.com】</a><em class="kf">。</em></p></div></div>    
</body>
</html>