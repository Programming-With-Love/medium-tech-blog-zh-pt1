<html>
<head>
<title>Keeping your Costs Low in Cosmos DB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Cosmos DB中保持低成本</h1>
<blockquote>原文：<a href="https://medium.com/version-1/cosmos-db-keeping-your-costs-low-d69b5fc91a09?source=collection_archive---------1-----------------------#2021-06-21">https://medium.com/version-1/cosmos-db-keeping-your-costs-low-d69b5fc91a09?source=collection_archive---------1-----------------------#2021-06-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/e3a0536df68f325b36a955c78d109b73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vFqEik5WsFEQEUHmjigzlw.jpeg"/></div></div></figure><p id="2879" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当我在<a class="ae jn" href="https://www.version1.com/" rel="noopener ugc nofollow" target="_blank">版本1 </a>与同事和同事讨论并提到我正在使用Cosmos DB ( <a class="ae jn" href="https://www.version1.com/about-us/our-technology-partnerships/microsoft/" rel="noopener ugc nofollow" target="_blank">微软Azure </a>)的项目时，通常我被问的第一个问题是关于成本，所以我认为写一篇简短的博客解释Cosmos DB的定价方式可能会有用。</p><p id="1551" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Cosmos DB提供了许多工具，让您根据自己的需求控制和限制成本，使其成为一个非常划算的解决方案。下面我将介绍不同的定价方案，并根据我的经验提供一些最佳方案的建议。在我们查看Cosmos DB中可用的不同选项之前，我将简要解释请求单位(RUs ),因为定价选项都是基于RUs的。</p><h2 id="96d8" class="jo jp hh bd jq jr js jt ju jv jw jx jy ja jz ka kb je kc kd ke ji kf kg kh ki bi translated"><strong class="ak">请求单位(RUs) </strong></h2><p id="aa0d" class="pw-post-body-paragraph ip iq hh ir b is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji kn jk jl jm ha bi translated">请求单元是一种性能货币，它抽象出执行Azure Cosmos DB支持的数据库操作所需的系统资源，如CPU、IOPS和内存</p><p id="2072" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><a class="ae jn" href="https://docs.microsoft.com/en-us/azure/cosmos-db/request-units" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/azure/cosmos-db/request-units</a></p><p id="26a8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Cosmos DB中每个数据库操作的成本都用RUs表示。理解这一点很重要，因为Cosmos DB的定价模型是围绕RUs构建的。Cosmos DB要求您为您使用的ru付费，要么预先提供，要么只为您使用的ru付费。如果您的请求超过了供应的ru，您要么会受到性能影响，要么会增加成本。</p><p id="8c65" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因此，如果你保持你的查询和数据小，你使用的逻辑单元的数量将会减少。您也可以手动设置索引等。努力减少每次操作中使用的ru。在上面的链接中有更多关于请求单位的信息，我会写一些在未来保持你的RUs低的技巧。</p><h1 id="e8ce" class="ko jp hh bd jq kp kq kr ju ks kt ku jy kv kw kx kb ky kz la ke lb lc ld kh le bi translated"><strong class="ak">无服务器还是调配吞吐量？</strong></h1><p id="4cb7" class="pw-post-body-paragraph ip iq hh ir b is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji kn jk jl jm ha bi translated">当您设置一个新的Cosmos DB数据库时，您必须在无服务器或预配吞吐量模式之间进行选择。在使用CosmosDB时，根据您的需求选择最佳选项是保持低成本的关键。</p><p id="5748" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">注意:一旦创建了资源，就不能在无服务器和调配的吞吐量容量选项之间切换。</p><figure class="lg lh li lj fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lf"><img src="../Images/3928eb5f462e99333239dd6814f4bd37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_1xqMETMwwoedVBLH8ZPDg.png"/></div></div></figure><h2 id="46a6" class="jo jp hh bd jq jr js jt ju jv jw jx jy ja jz ka kb je kc kd ke ji kf kg kh ki bi translated"><strong class="ak">调配的吞吐量</strong></h2><p id="a840" class="pw-post-body-paragraph ip iq hh ir b is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji kn jk jl jm ha bi translated">当您选择调配的吞吐量模式时，您将决定需要的最大RU/s，并预先进行调配。您可以随时更改最大值，系统会根据您在该小时内配置的最大RU按小时计费。</p><p id="db05" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">例如，如果您将最大RUs设置为10，000，然后在同一小时内降至5，000，您将在第一个小时被收取10，000的费用，然后继续每小时收取5，000 RUs的费用，直到您再次更改。</p><p id="a249" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">注意:您可以选择在每个容器上提供吞吐量，或者在数据库中的所有容器之间共享吞吐量。无论如何，下面描述的选项都是一样的，虽然如果在容器级别进行配置，您的成本可能会更高，但是在性能方面您将有更大的灵活性。</p><p id="412d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一旦创建了调配的吞吐量Cosmos DB资源，就有两个选项来管理可用的RUs —手动或自动扩展。您可以随时在这两者之间切换。</p><ul class=""><li id="1186" class="lk ll hh ir b is it iw ix ja lm je ln ji lo jm lp lq lr ls bi translated"><strong class="ir hi">手动</strong></li></ul><figure class="lg lh li lj fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lt"><img src="../Images/f6eb356c033c61751a3dc0645fa14ae1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3i89C43BihNzm-HG0EKxqg.png"/></div></div></figure><p id="842d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因此，在这个例子中，我将这个数据库的吞吐量设置为400，并得到了这个月的估计成本。无论数据库收到多少请求，这都是我在月底要支付的费用。我可以根据自己的意愿随时更改，如上所述，您将为每小时使用的最高调配值付费。这里所做的任何更改都会立即生效。</p><p id="57ee" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">注意:如果您开始使用比您可用的更多的ru，您将得到一个429错误作为您的响应。根据您的使用情况，只需等待一会儿并重试就可以解决这个问题。随着数据库负载的减少，您最终会得到一个成功的响应。您也可以手动将吞吐量提高到您需要的水平。如果您的流量在一天或一周内波动很大，那么自动缩放选项可能更合适。</p><ul class=""><li id="dd35" class="lk ll hh ir b is it iw ix ja lm je ln ji lo jm lp lq lr ls bi translated"><strong class="ir hi">自动缩放</strong></li></ul><figure class="lg lh li lj fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lu"><img src="../Images/23f8cde25d59cb392ae067e76814028d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B2OXtvu_AR88WDibJUveiQ.png"/></div></div></figure><p id="a5ef" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">正如您在上面看到的，有一个自动缩放选项，这允许您设置最大吞吐量，Cosmos DB将根据需要自动缩放，但永远不会超过您选择的最大值。在写入时，此处允许的最小值为4000RU/s。这意味着它会在安静时一直向下扩展到400 RU/s，但在负载增加时，会根据需要向上扩展到最大值4000 RU/s。</p><p id="8545" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">注意:</strong>最小RU/s值开始为400RU/s，但是随着数据库中数据量的增长，允许的最小值开始以100 RU/s为单位增长。因此，如果数据增长到足够大，您的成本可能会随着最小值从400 RU/s变为500RU/s而增加，以此类推。</p><p id="ec89" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果这是一个问题，您可能需要限制保存在Cosmos DB中的数据，也许删除或存档不再需要的旧数据。这适用于手动和自动缩放选项。</p><p id="1854" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">自动缩放显然是更灵活的选择，但是如果您需要的吞吐量较低，它也可能比手动缩放更昂贵。幸运的是，您可以随时在自动缩放和手动选项之间进行切换，因此您可以尝试这种方式来找到最适合您需求的方式。</p><p id="3c7e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">无服务器</strong></p><p id="99fc" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这是Cosmos DB的最新选项，也可能是最便宜的选项，尽管有一些限制。</p><p id="383b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您选择无服务器模式，您只需为您使用的ru付费。因此，在您的流量非常小且时断时续的情况下，这可能会比上述提供的吞吐量选项便宜得多，另一个好处是，无服务器可以上下扩展以处理任何增加的负载，因此您无需担心手动配置最大RUs和自动扩展设置等。</p><p id="eb93" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">需要注意一些限制。</p><ul class=""><li id="3fe0" class="lk ll hh ir b is it iw ix ja lm je ln ji lo jm lp lq lr ls bi translated">您的账单金额不太容易预测，因此您需要监控使用情况，并可能设置警报等。在Azure Monitor中，如果RU消耗高于您预期的范围，它会通知您。</li><li id="4369" class="lk ll hh ir b is lv iw lw ja lx je ly ji lz jm lp lq lr ls bi translated">无服务器容器的每个容器的数据和索引大小限制为50Gb。</li><li id="d586" class="lk ll hh ir b is lv iw lw ja lx je ly ji lz jm lp lq lr ls bi translated">最大RU/s是5000，所以如果您的使用超过了这个值，您的性能将会受到影响。</li><li id="079e" class="lk ll hh ir b is lv iw lw ja lx je ly ji lz jm lp lq lr ls bi translated">只能在单个区域运行。</li></ul><p id="6ace" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">注意:无服务器只是最近才添加的，所以如果将来对上述限制的更改被添加进来，我不会感到惊讶。</p><p id="36b2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">总结</strong></p><p id="23ed" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如上所述，Cosmos DB有3个主要的定价选项</p><ul class=""><li id="a356" class="lk ll hh ir b is it iw ix ja lm je ln ji lo jm lp lq lr ls bi translated"><strong class="ir hi">无服务器— </strong>对于大多数用例来说，这是最便宜的选择。您只需为您所使用的ru付费，但是价格是不可预测的，并且在存储空间和性能方面有很大的限制。</li><li id="e59a" class="lk ll hh ir b is lv iw lw ja lx je ly ji lz jm lp lq lr ls bi translated"><strong class="ir hi">标准供应吞吐量</strong> —您选择可用ru的最大值，即使未使用该吞吐量，您也会按小时付费。计费是可预测的，您可以随时增加或减少供应的ru。</li><li id="6053" class="lk ll hh ir b is lv iw lw ja lx je ly ji lz jm lp lq lr ls bi translated"><strong class="ir hi">auto scale Provisioned Throughput</strong>—非常类似于标准的Provisioned Throughput选项，但此选项允许您设置最大RU值，当数据库处于安静状态时，它会自动缩小到该最大值的10%，并根据需要扩大。</li></ul><p id="b38d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">感谢您阅读这篇文章。</p><p id="9fd5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您有任何反馈或问题，请随时添加评论，我会尽快回复您。</p><p id="979e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">关于作者</strong></p><p id="0ec7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Craig O Connor目前是版本1的技术/团队负责人。</p></div></div>    
</body>
</html>