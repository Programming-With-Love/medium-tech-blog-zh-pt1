<html>
<head>
<title>Cross-region file replication with Longhorn in Oracle Cloud and Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Oracle云和Kubernetes中的Longhorn跨区域文件复制</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/cross-region-file-replication-with-longhorn-in-oracle-cloud-and-kubernetes-de5a5b82e4b7?source=collection_archive---------0-----------------------#2022-04-21">https://medium.com/oracledevs/cross-region-file-replication-with-longhorn-in-oracle-cloud-and-kubernetes-de5a5b82e4b7?source=collection_archive---------0-----------------------#2022-04-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/4b82a7eedbdf3ceeb404f2f5903eb6c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C0RPx0zOVK8L75p1sDz9nw.png"/></div></div></figure><p id="48fa" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在OCI的多个Kubernetes集群中部署无状态应用程序相对简单。创建您想要的集群数量，使用像<a class="ae jn" href="https://docs.oracle.com/en-us/iaas/Content/TrafficManagement/Concepts/overview.htm" rel="noopener ugc nofollow" target="_blank"> OCI流量控制</a>这样的全局负载平衡器，添加<a class="ae jn" href="https://docs.oracle.com/en-us/iaas/Content/HealthChecks/home.htm#home" rel="noopener ugc nofollow" target="_blank">健康检查</a> <em class="jo">等瞧</em>！</p><p id="7c83" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您的应用程序是有状态的并且有持久性需求，该怎么办？如何确保您的数据保存在另一个区域？在本文中，我们将探索如何使用Longhorn在多个OCI地区复制和持久化您的数据。</p><h2 id="de31" class="jp jq hh bd jr js jt ju jv jw jx jy jz ja ka kb kc je kd ke kf ji kg kh ki kj bi translated">长角牛简介</h2><p id="6bc1" class="pw-post-body-paragraph ip iq hh ir b is kk iu iv iw kl iy iz ja km jc jd je kn jg jh ji ko jk jl jm ha bi translated">Longhorn是Kubernetes的一个分布式块存储系统，并且(在撰写本文时)是一个酝酿中的CNCF项目。您可以在这里阅读有关Longhorn <a class="ae jn" href="https://longhorn.io/docs/1.2.4/what-is-longhorn/" rel="noopener ugc nofollow" target="_blank">的更多信息</a>，但吸引我注意的是“<em class="jo">创建跨集群灾难恢复卷的能力，以便可以从第二个Kubernetes集群</em>的备份中快速恢复主Kubernetes集群中的数据。</p><p id="e926" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这是我们将要探索的用例。</p><h2 id="e2e0" class="jp jq hh bd jr js jt ju jv jw jx jy jz ja ka kb kc je kd ke kf ji kg kh ki kj bi translated">OKE设置</h2><p id="d6dd" class="pw-post-body-paragraph ip iq hh ir b is kk iu iv iw kl iy iz ja km jc jd je kn jg jh ji ko jk jl jm ha bi translated">首先，创建两个OKE集群。您可以使用控制台或使用terraform的<a class="ae jn" href="https://github.com/oracle-terraform-modules/terraform-oci-oke" rel="noopener ugc nofollow" target="_blank"> terraform-oci-oke模块</a>创建它们。我的集群是在悉尼和墨尔本创建的。您可以根据需要选择您的地区。</p><p id="fc51" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我使用Terraform模块创建了集群，并启用了悉尼的操作员。由于我正在使用多个集群，我将安装<a class="ae jn" href="https://github.com/ahmetb/kubectx/" rel="noopener ugc nofollow" target="_blank"> kubectx和kubens </a>来简化我的kubectl命令。如果您正在使用这种方法，那么最好设置它们，这样您就可以方便地切换集群，而无需经常更改kubeconfigs或上下文。对操作员运行以下命令:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="e39e" class="jp jq hh ku b fi ky kz l la lb">oci ce cluster create-kubeconfig --cluster-id &lt;<strong class="ku hi">clusterid</strong>&gt; \<br/>--file $HOME/.kube/config --region ap-melbourne-1 --token-version 2.0.0 --kube-endpoint PUBLIC_ENDPOINT</span><span id="7371" class="jp jq hh ku b fi lc kz l la lb">alias ktx='kubectx'<br/>alias kns='kubens'</span><span id="e31a" class="jp jq hh ku b fi lc kz l la lb"># use the contexts from your config file</span><span id="e667" class="jp jq hh ku b fi lc kz l la lb">ktx sydney=context-cenpnxriqhq<br/>ktx melbourne=context-cydn4hk3qgq</span></pre><p id="200e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要找到上下文的值，可以在$HOME/中检查它们。kube/配置。</p><p id="2f9a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在，要更改集群，只需执行以下操作:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="3879" class="jp jq hh ku b fi ky kz l la lb">[opc@lh-operator ~]$ ktx sydney<br/>✔ Switched to context "sydney".</span></pre><h2 id="5e4d" class="jp jq hh bd jr js jt ju jv jw jx jy jz ja ka kb kc je kd ke kf ji kg kh ki kj bi translated">Longhorn先决条件</h2><p id="df73" class="pw-post-body-paragraph ip iq hh ir b is kk iu iv iw kl iy iz ja km jc jd je kn jg jh ji ko jk jl jm ha bi translated">现在，让我们通过运行Longhorn环境检查脚本来验证我们的集群可以部署Longhorn:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="8ad9" class="jp jq hh ku b fi ky kz l la lb">curl -sSfL <a class="ae jn" href="https://raw.githubusercontent.com/longhorn/longhorn/v1.2.4/scripts/environment_check.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/longhorn/longhorn/v1.2.4/scripts/environment_check.sh</a> -o environment_check.sh</span><span id="8d48" class="jp jq hh ku b fi lc kz l la lb">for ctx in sydney melbourne; do<br/>  ktx $ctx<br/>  bash <!-- -->environment_check.sh<br/>done</span><span id="d15f" class="jp jq hh ku b fi lc kz l la lb">✔ Switched to context "sydney".<br/>daemonset.apps/longhorn-environment-check created<br/>waiting for pods to become ready (0/0)<br/>waiting for pods to become ready (0/3)<br/>waiting for pods to become ready (1/3)<br/>all pods ready (3/3)</span><span id="9994" class="jp jq hh ku b fi lc kz l la lb">MountPropagation is enabled!</span><span id="b93d" class="jp jq hh ku b fi lc kz l la lb">cleaning up...<br/>daemonset.apps "longhorn-environment-check" deleted<br/>clean up complete<br/>✔ Switched to context "melbourne".<br/>daemonset.apps/longhorn-environment-check created<br/>waiting for pods to become ready (0/0)<br/>waiting for pods to become ready (0/3)<br/>all pods ready (3/3)</span><span id="dc0e" class="jp jq hh ku b fi lc kz l la lb">MountPropagation is enabled!</span><span id="4618" class="jp jq hh ku b fi lc kz l la lb">cleaning up...<br/>daemonset.apps "longhorn-environment-check" deleted<br/>clean up complete</span></pre><p id="dc45" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们现在准备在集群中部署Longhorn。</p><h2 id="96db" class="jp jq hh bd jr js jt ju jv jw jx jy jz ja ka kb kc je kd ke kf ji kg kh ki kj bi translated">部署长角牛</h2><p id="0917" class="pw-post-body-paragraph ip iq hh ir b is kk iu iv iw kl iy iz ja km jc jd je kn jg jh ji ko jk jl jm ha bi translated">让我们添加helm repo并更新:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="bc36" class="jp jq hh ku b fi ky kz l la lb">helm repo add longhorn <a class="ae jn" href="https://charts.longhorn.io" rel="noopener ugc nofollow" target="_blank">https://charts.longhorn.io</a><br/>helm repo update</span></pre><p id="761c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">并在两个区域安装Longhorn:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="4088" class="jp jq hh ku b fi ky kz l la lb">for ctx in sydney melbourne; do<br/>  ktx $ctx<br/>  <!-- -->helm install longhorn longhorn/longhorn --namespace longhorn-system --create-namespace<br/>done</span></pre><p id="c6f5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">更改两个集群的默认命名空间:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="44d9" class="jp jq hh ku b fi ky kz l la lb">for ctx in sydney melbourne; do<br/>  ktx $ctx<br/>  <!-- -->kns longhorn-system<br/>done</span></pre><p id="3f5d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">验证两个群集中的pod都在运行:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="c619" class="jp jq hh ku b fi ky kz l la lb">for ctx in sydney melbourne; do<br/>  k get pods<br/>done</span></pre><p id="187d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您应该看到所有的pod都处于运行状态。</p><h2 id="3b54" class="jp jq hh bd jr js jt ju jv jw jx jy jz ja ka kb kc je kd ke kf ji kg kh ki kj bi translated">使用OCI对象存储准备备份</h2><p id="88a0" class="pw-post-body-paragraph ip iq hh ir b is kk iu iv iw kl iy iz ja km jc jd je kn jg jh ji ko jk jl jm ha bi translated">在主区域中创建一个bucket(注意，我将一个区域等同于一个集群)。我们姑且称之为<strong class="ir hi">长角牛</strong>。</p><p id="8ec5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">目前，Longhorn仅支持S3和NFSv4备份。因为OCI对象存储已经提供了一个S3兼容层，我们将使用它。</p><p id="ea30" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">首先，<a class="ae jn" href="https://docs.oracle.com/en-us/iaas/Content/Identity/Tasks/managingcredentials.htm#create-secret-key" rel="noopener ugc nofollow" target="_blank">创建一个客户密钥</a>。请务必记下密钥，因为它不会再次显示。</p><p id="830e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们还需要知道租户的对象存储名称空间。导航到您的租赁页面并查找该值。</p><p id="e685" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在两个集群中，创建相同的机密:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="138b" class="jp jq hh ku b fi ky kz l la lb">for ctx in sydney melbourne; do<br/>  ktx $ctx<br/>  kubectl create secret generic ocisecret \<br/>    --from-literal=AWS_ACCESS_KEY_ID=123456ab7890123c45c \<br/>    --from-literal=AWS_SECRET_ACCESS_KEY=1abcDEF3fgdg9d798dfgdsgd9gHHHD= \<br/> --from-literal=AWS_ENDPOINTS=<strong class="ku hi">&lt;object-storage-namepace&gt;</strong>.compat.objectstorage.<strong class="ku hi">&lt;region&gt;</strong>.oraclecloud.com \<br/> --from-literal=VIRTUAL_HOSTED_STYLE=dHJ1ZQ== \<br/>    -n longhorn-system<br/>done</span></pre><p id="005f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">创建上述秘密，替换访问密钥、秘密访问密钥以及<strong class="ir hi">对象存储名称空间</strong>和<strong class="ir hi">区域</strong>的值。区域值应该是主群的区域。</p><h2 id="d3b4" class="jp jq hh bd jr js jt ju jv jw jx jy jz ja ka kb kc je kd ke kf ji kg kh ki kj bi translated">为Longhorn配置备份目标</h2><p id="a85b" class="pw-post-body-paragraph ip iq hh ir b is kk iu iv iw kl iy iz ja km jc jd je kn jg jh ji ko jk jl jm ha bi translated">让我们在<em class="jo">两个区域</em>中访问Longhorn UI，通过使用端口转发来配置备份目标:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="a1d4" class="jp jq hh ku b fi ky kz l la lb">ktx sydney<br/>kubectl port-forward longhorn-ui-84f97cf569-z9t85 8000:8000</span></pre><p id="8a2c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您现在应该能够在浏览器中访问Longhorn UI，网址为<a class="ae jn" href="http://localhost:8000/:" rel="noopener ugc nofollow" target="_blank"> http://localhost:8000/: </a></p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ld"><img src="../Images/65199be7732c9cb8e43d05bec6798270.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XTDdsi1rnf1C3owwjHg7kw.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx">Longhorn UI</figcaption></figure><p id="53d4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">导航至<strong class="ir hi">设置</strong> &gt; <strong class="ir hi">常规</strong>并寻找备份目标。输入备份目标和您之前创建的密码的名称:</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div class="er es li"><img src="../Images/7fa3d5e597ba8695b962016e49c26051.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*hKcWafzJzQgu9Q9t_R37Dw.png"/></div></figure><p id="569b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然后单击保存。在上面的备份目标中，<strong class="ir hi"> longhorn </strong>是存储桶名称，“ap-sydney-1”是您的<a class="ae jn" href="https://docs.oracle.com/en-us/iaas/Content/General/Concepts/regions.htm" rel="noopener ugc nofollow" target="_blank"> OCI地区标识符</a>。</p><p id="0b15" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在辅助集群中重复上述操作。</p><p id="c5b0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在让我们测试一下备份是否有效。通过运行以下命令，创建一个使用<a class="ae jn" href="https://longhorn.io/docs/1.2.4/volumes-and-nodes/create-volumes/" rel="noopener ugc nofollow" target="_blank"> Longhorn卷</a>的Pod:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="1ea6" class="jp jq hh ku b fi ky kz l la lb">kubectl create -f https://raw.githubusercontent.com/longhorn/longhorn/v1.2.4/examples/pod_with_pvc.yaml</span></pre><p id="359a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在Longhorn UI中，您现在应该能够看到一个卷:</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lj"><img src="../Images/81658483f97d06419f2ae3ff17711f3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NPjKCpwpFSjWk0sOgYCZ4w.png"/></div></div></figure><p id="a550" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">选择并创建备份:</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lk"><img src="../Images/e6651aab6406b9c72865ca7ca77d4ee8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4GSd2465z93yZXe80qA7iA.png"/></div></div></figure><p id="df86" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在OCI控制台中导航，您现在应该会看到一个backupstore子目录:</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ll"><img src="../Images/615e95009f43252c36d4594e43fb707a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zURKnb1_pRIEEyyYgeuMRw.png"/></div></div></figure><p id="033d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在，访问辅助集群中的Longhorn UI，并导航到备份页面:</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lm"><img src="../Images/34642c61bdd27b55350f6f57267913dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wzCdCrs9pld_zB6wlXsBbQ.png"/></div></div></figure><p id="2bad" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在，您应该能够选择备份并创建灾难恢复卷了。</p><p id="33ef" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在卷页面上，您现在可以看到灾难恢复卷:</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ln"><img src="../Images/f2b35c996473946517661c1534c12455.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-rEUmT-Yx8a0g6iXjbxp9g.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx">DR volume</figcaption></figure><p id="423c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">激活它。</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lo"><img src="../Images/0db0be9e9e2b17e0442dfc7559188149.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kNiCoNh0G6e8VogBAsyEfA.png"/></div></div><figcaption class="le lf et er es lg lh bd b be z dx">Activating the DR Volume</figcaption></figure><p id="00ea" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">激活灾难恢复卷后，您可以使用它创建PV/PVC:</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lp"><img src="../Images/f4578c702c7cbc151fca554cd7b84fad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oRLq7pgqApG42rX0W7R1AA.png"/></div></div></figure><h2 id="5c56" class="jp jq hh bd jr js jt ju jv jw jx jy jz ja ka kb kc je kd ke kf ji kg kh ki kj bi translated">数据复制测试场景</h2><p id="eba1" class="pw-post-body-paragraph ip iq hh ir b is kk iu iv iw kl iy iz ja km jc jd je kn jg jh ji ko jk jl jm ha bi translated">我们现在将测试两个群集之间的数据复制。测试大致基于这个<a class="ae jn" href="https://www.youtube.com/watch?v=zJY2uxLtwUk" rel="noopener ugc nofollow" target="_blank">演示</a>。</p><p id="28b6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们将在主要区域部署一个WordPress，创建一些内容，然后切换到次要区域。下面是我们将创建的架构:</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lq"><img src="../Images/9d4a66270e0b545168c34d64eef5fefc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0dAZudGsCjDXyb6UihBOog.png"/></div></div></figure><p id="cf25" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">让我们首先添加bitnami舵图表:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="682b" class="jp jq hh ku b fi ky kz l la lb">helm repo add bitnami <a class="ae jn" href="https://charts.bitnami.com/bitnami" rel="noopener ugc nofollow" target="_blank">https://charts.bitnami.com/bitnami</a><br/>helm repo update</span></pre><h2 id="3dc2" class="jp jq hh bd jr js jt ju jv jw jx jy jz ja ka kb kc je kd ke kf ji kg kh ki kj bi translated">部署WordPress</h2><p id="fe73" class="pw-post-body-paragraph ip iq hh ir b is kk iu iv iw kl iy iz ja km jc jd je kn jg jh ji ko jk jl jm ha bi translated">让我们生成舵图yaml文件:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="21f9" class="jp jq hh ku b fi ky kz l la lb">helm show values bitnami/wordpress &gt; wordpress.yaml</span></pre><p id="7200" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们现在可以编辑它:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="db7a" class="jp jq hh ku b fi ky kz l la lb"># parameters  #values  <br/>wordpressUsername user<br/>wordpressPassword "Secre7Pa55w0rd"</span><span id="9cff" class="jp jq hh ku b fi lc kz l la lb">persistence.storageClass "longhorn"</span><span id="3059" class="jp jq hh ku b fi lc kz l la lb">mariadb.enabled true<br/>mariadb.auth.rootPassword: "aVerySecureR007"<br/>mariadb.auth.password: "bnwp123!@#"<br/>mariadb.primary.persistence.storageClass: "longhorn"</span></pre><p id="5051" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然后，安装WordPress</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="6dc9" class="jp jq hh ku b fi ky kz l la lb">helm install wordpress bitnami/wordpress -f wordpress.yaml <!-- -->--namespace wordpress --create-namespace</span></pre><p id="4360" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">验证是否已创建2个存储类longhorn的PVC。一个是WordPress本身，另一个是数据库:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="a86b" class="jp jq hh ku b fi ky kz l la lb">$ kubectl get pvc<br/>NAME      STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE<br/><strong class="ku hi">data-mysql-0</strong>   Bound    pvc-b2ffe5d4-728f-42d3-8e06-a4caffac260c   8Gi        RWO            longhorn       21m<br/><strong class="ku hi">wordpress      </strong>Bound    pvc-2e3d017a-7663-4ed9-88ea-86dc5e6d8e08   10Gi       RWO            longhorn       69s</span></pre><p id="2f75" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">提取负载平衡器ip:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="d3e1" class="jp jq hh ku b fi ky kz l la lb">export SERVICE_IP=$(kubectl get svc wordpress --output jsonpath=’{.status.loadBalancer.ingress[0].ip}’)</span><span id="ee45" class="jp jq hh ku b fi lc kz l la lb">echo wordpress_url=<a class="ae jn" href="http://$SERVICE_IP/" rel="noopener ugc nofollow" target="_blank">http://$SERVICE_IP/</a></span></pre><p id="6726" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">使用WordPress URL访问WordPress。使用<code class="du lr ls lt ku b">wordpressUsername</code>、<code class="du lr ls lt ku b">wordpressPassword</code>登录，创建一个新帖子。下面是我创建的帖子。它包括一些文字和我上传的长角牛图片。</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lu"><img src="../Images/9eb79c2094a96b534ec6f62e8ef37845.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qRe1uqHlSXbdwDSWoWgU3w.png"/></div></div></figure><h2 id="b575" class="jp jq hh bd jr js jt ju jv jw jx jy jz ja ka kb kc je kd ke kf ji kg kh ki kj bi translated">创建Longhorn备份</h2><p id="26de" class="pw-post-body-paragraph ip iq hh ir b is kk iu iv iw kl iy iz ja km jc jd je kn jg jh ji ko jk jl jm ha bi translated">使用Longhorn UI为数据库和WordPress卷创建快照和备份。</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lv"><img src="../Images/f42c4d11c9dc07d2ff40c05c30ee91a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BR31Fo_BStmGPYgI4jldFw.png"/></div></div></figure><p id="3725" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在备份页面上，您现在会看到另外两个备份:</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lp"><img src="../Images/5f65c072fd4394f5304c83465eb6f339.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*02JtEVXwDfY5T7AORd7zCw.png"/></div></div></figure><h2 id="210e" class="jp jq hh bd jr js jt ju jv jw jx jy jz ja ka kb kc je kd ke kf ji kg kh ki kj bi translated">创建灾难恢复卷</h2><p id="7a77" class="pw-post-body-paragraph ip iq hh ir b is kk iu iv iw kl iy iz ja km jc jd je kn jg jh ji ko jk jl jm ha bi translated">现在，假设我们希望在悉尼进行一些维护，并希望将流量切换到墨尔本的群集。记得将上下文更改为Melbourne，并创建一个“wordpress”名称空间:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="e069" class="jp jq hh ku b fi ky kz l la lb">ktx melbourne</span><span id="65b9" class="jp jq hh ku b fi lc kz l la lb">kubectl create ns wordpress</span></pre><p id="dcfb" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">首先，切换到墨尔本的Longhorn UI。接下来，为数据库和WordPress创建一个灾难恢复卷。现在，您应该能够在“volume”页面中看到您创建的另外两个灾难恢复卷:</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lw"><img src="../Images/b18b80bea25bef019b8164be08fe129a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jaPgjnAzoHcUsLrp9iYpLQ.png"/></div></div></figure><p id="f844" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在，让我们通过从“volume”菜单中选择并激活灾难恢复卷来激活它们:</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lx"><img src="../Images/37b45042663dd36e43506503fe8e509c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7JPposiZF5yiYPL5OghrSA.png"/></div></div></figure><p id="14d0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最后，我们为每一个创建一个PVC。</p><h2 id="0fce" class="jp jq hh bd jr js jt ju jv jw jx jy jz ja ka kb kc je kd ke kf ji kg kh ki kj bi translated">在次要区域部署WordPress</h2><p id="5a0a" class="pw-post-body-paragraph ip iq hh ir b is kk iu iv iw kl iy iz ja km jc jd je kn jg jh ji ko jk jl jm ha bi translated">我们现在准备在墨尔本部署WordPress。将wordpress.yaml复制到wordpress-dr.yaml。您可以保持所有内容不变，除了:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="4418" class="jp jq hh ku b fi ky kz l la lb">persistence.existingClaim: "wordpress"</span></pre><p id="9619" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这将确保当您在二级区域(本例中也称为墨尔本)部署WordPress时，helm chart将重用从DR卷创建的PVC，而不是创建一个新的PVC:</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="b40a" class="jp jq hh ku b fi ky kz l la lb">helm install wordpress bitnami/wordpress -f wordpress-dr.yaml</span></pre><p id="925d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">重复上述步骤，检索辅助区域的负载平衡器IP地址。登录WordPress，你应该会看到你在悉尼发表的文章:</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ly"><img src="../Images/46c52adf35eb4c974ed0fe72b1a4c917.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LYKlXE83_YhLgbzZdUPrbw.png"/></div></div></figure><p id="d6bd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最后，如果你点击你创建的文章，你应该能够看到文本和图片:</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lu"><img src="../Images/9eb79c2094a96b534ec6f62e8ef37845.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qRe1uqHlSXbdwDSWoWgU3w.png"/></div></div></figure><h2 id="4968" class="jp jq hh bd jr js jt ju jv jw jx jy jz ja ka kb kc je kd ke kf ji kg kh ki kj bi translated">结论</h2><p id="3c64" class="pw-post-body-paragraph ip iq hh ir b is kk iu iv iw kl iy iz ja km jc jd je kn jg jh ji ko jk jl jm ha bi translated">在这篇文章中，我想展示如何将Longhorn与OCI对象存储结合使用，将其部署在OKE上，并模拟执行有状态应用程序到另一个OCI地区的OKE集群的灾难恢复切换的过程。在以后的文章中，我们将更多地探索使用Longhorn。</p><p id="b9a2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我希望这篇文章对你有用。</p><p id="208f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">想谈谈吗？加入我们的<a class="ae jn" href="https://oracledevrel.slack.com/join/shared_invite/zt-uffjmwh3-ksmv2ii9YxSkc6IpbokL1g#/shared-invite/email" rel="noopener ugc nofollow" target="_blank">公共休闲频道</a>！</p></div></div>    
</body>
</html>