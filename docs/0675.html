<html>
<head>
<title>Using CameraX Exposure Compensation API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用CameraX曝光补偿API</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/using-camerax-exposure-compensation-api-11fd75785bf?source=collection_archive---------3-----------------------#2021-10-13">https://medium.com/androiddevelopers/using-camerax-exposure-compensation-api-11fd75785bf?source=collection_archive---------3-----------------------#2021-10-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/16ca11ef33dd0e5ecc1f03fee7303afe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zinEvf1keSZYuZojr31ehQ.png"/></div></div></figure><div class=""/><p id="5994" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">相机设备在推动移动设备创新方面至关重要，相机曝光是获得高质量相机图像的关键因素。在这篇博客中，我将讨论应用程序开发人员在处理相机曝光时面临的挑战。然后，我将介绍新的CameraX曝光补偿API如何帮助解决这些挑战，使快速拍摄高质量图像变得更加简单。最后，我将向您展示如何将API集成到您自己的应用程序中。</p><h1 id="1a58" class="jn jo hs bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">背景</h1><p id="9c3c" class="pw-post-body-paragraph ip iq hs ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">在摄影中，曝光是决定相机最终图像的最重要因素之一，大多数摄影师都努力做到正确。自动曝光(AE)模式非常适合大多数常见场景，例如在旅途中快速拍摄图像。但是，在某些情况下，AE模式会做出一些权衡来补偿整体图像质量，有时这些权衡可能不是您想要的。一个例子是逆光，例如，当从室内向窗户或其他明亮的光源拍摄时，或者当在室外拍摄时，太阳在对象的背面。在这些情况下，AE模式会创建一张对明亮背景(照片的高光区域)进行适当曝光的照片，但黑暗前景中的主体可能会太暗或成为剪影。图1显示了三张在室内背光环境下拍摄的照片，条件相同，曝光不同:</p><figure class="kr ks kt ku fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es kq"><img src="../Images/ccf7d222620bcee292403298b7dae335.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mcAaAvD0QI8yWwWKO42bXA.jpeg"/></div></div></figure><p id="646e" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">AE在整体照片质量方面做得很好，但更高的曝光确实给了可收藏的Android小雕像更好的关注。</p><p id="1306" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">传统上，摄影师调整3个控制以达到满意的曝光:</p><ul class=""><li id="8773" class="kv kw hs ir b is it iw ix ja kx je ky ji kz jm la lb lc ld bi translated">光圈:镜头的开口，控制进入相机的光量</li><li id="a03c" class="kv kw hs ir b is le iw lf ja lg je lh ji li jm la lb lc ld bi translated">快门速度:图像曝光的持续时间</li><li id="9ed3" class="kv kw hs ir b is le iw lf ja lg je lh ji li jm la lb lc ld bi translated">ISO(国际标准化组织):相机表面收集光线的灵敏度</li></ul><p id="9202" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">每个控制对图像都有独特的影响:改变光圈可能会修改景深，快门速度可能会模糊或冻结动作，较高的ISO可能会显著增加图像噪点。精确的数学是非常复杂的，但是这些设置有各种组合来获得相同的整体曝光，并且获得完美曝光值的过程可能会很苛刻。为了帮助补偿，CameraX实现了曝光补偿API。</p><h1 id="4e0a" class="jn jo hs bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">曝光补偿API实现</h1><p id="9e69" class="pw-post-body-paragraph ip iq hs ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">曝光补偿API根据生成的自动曝光值，使用曝光补偿指数调整曝光补偿。曝光补偿指数可以是正值(使图像变亮)或负值(使图像变暗)。它将总曝光跨度映射到补偿指数范围，并将曝光量映射到步长。相机设备根据曝光指数在内部改变曝光，减少了控制其他设置以获得相同效果所需的努力。</p><p id="09cb" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">以上面显示的图1为例，相机的默认设置不允许足够的光线照射到我们想要聚焦的对象上，所以我们可以用正指数调整曝光补偿，以获得双/四倍曝光，使对象突出。通过改变曝光补偿指数，相机内部控制快门速度、光圈和ISO以获得适当的曝光。</p><p id="b060" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了访问薪酬指数，CameraX实现了以下功能:</p><ol class=""><li id="e6d4" class="kv kw hs ir b is it iw ix ja kx je ky ji kz jm lj lb lc ld bi translated"><a class="ae lk" href="https://developer.android.com/reference/kotlin/androidx/camera/core/CameraControl#setexposurecompensationindex" rel="noopener ugc nofollow" target="_blank">camera control::setExposureCompensationIndex</a>设置新的曝光补偿指数</li><li id="96a4" class="kv kw hs ir b is le iw lf ja lg je lh ji li jm lj lb lc ld bi translated"><a class="ae lk" href="https://developer.android.com/reference/kotlin/androidx/camera/core/ExposureState" rel="noopener ugc nofollow" target="_blank">曝光状态</a>曝光补偿能力和当前设置，包括:</li></ol><ul class=""><li id="6b69" class="kv kw hs ir b is it iw ix ja kx je ky ji kz jm la lb lc ld bi translated">薪酬调整支持性</li><li id="0dc3" class="kv kw hs ir b is le iw lf ja lg je lh ji li jm la lb lc ld bi translated">支持的补偿范围</li><li id="7a23" class="kv kw hs ir b is le iw lf ja lg je lh ji li jm la lb lc ld bi translated">支持的补偿步长</li><li id="49c0" class="kv kw hs ir b is le iw lf ja lg je lh ji li jm la lb lc ld bi translated">当前薪酬指数值</li><li id="cbd9" class="kv kw hs ir b is le iw lf ja lg je lh ji li jm la lb lc ld bi translated">支持的补偿步长</li><li id="8a80" class="kv kw hs ir b is le iw lf ja lg je lh ji li jm la lb lc ld bi translated">当前薪酬指数值</li></ul><p id="b75c" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">让我们看看如何在CameraX应用程序中使用API来创建正确曝光的图像。</p><h1 id="544e" class="jn jo hs bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">使用曝光补偿API</h1><p id="ebb4" class="pw-post-body-paragraph ip iq hs ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">要在应用程序中使用曝光补偿API，您需要执行以下操作:</p><ul class=""><li id="e4fe" class="kv kw hs ir b is it iw ix ja kx je ky ji kz jm la lb lc ld bi translated">查询曝光补偿能力</li><li id="b502" class="kv kw hs ir b is le iw lf ja lg je lh ji li jm la lb lc ld bi translated">设置新的曝光补偿指数</li><li id="d37c" class="kv kw hs ir b is le iw lf ja lg je lh ji li jm la lb lc ld bi translated">在CameraX确认后，继续跟进行动</li></ul><h1 id="dca3" class="jn jo hs bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">查询曝光补偿指数的范围</h1><p id="f611" class="pw-post-body-paragraph ip iq hs ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">曝光补偿值的范围取决于<a class="ae lk" href="https://developer.android.com/reference/android/hardware/camera2/CameraCharacteristics#INFO_SUPPORTED_HARDWARE_LEVEL" rel="noopener ugc nofollow" target="_blank">相机设备设置和硬件水平</a>；应用程序可以使用ExposureState接口查询支持的范围:</p><figure class="kr ks kt ku fd hj"><div class="bz dy l di"><div class="ll lm l"/></div></figure><h1 id="22a7" class="jn jo hs bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">设置新的曝光补偿指数</h1><p id="ba8b" class="pw-post-body-paragraph ip iq hs ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">如果图像看起来很暗，设置一个正的曝光补偿指数来增加相机确定的正确曝光的亮度。同样，如果图像看起来过于明亮，请设置一个负数。这可以通过setExposureCompensationIndex()来完成:</p><figure class="kr ks kt ku fd hj"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="387f" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">默认情况下，曝光补偿指数的值从“0”开始，新的指数值必须在相机设备支持的范围内。否则CameraX会引发一个<code class="du ln lo lp lq b">IllegalArgument</code>错误。请注意，如果相机设备不支持补偿调整，CameraX会报告支持的范围为[0，0]。</p><p id="62f0" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">例如，以下代码在用户按下UI中的按钮时增加曝光补偿指数，并在曝光指数达到支持的最大值时停止:</p><figure class="kr ks kt ku fd hj"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="8354" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du ln lo lp lq b">setExposureCompensationIndex()</code>是一个<code class="du ln lo lp lq b">async</code>函数，每个摄像机只允许一个未完成的请求。如果应用程序在前一个调用被服务之前再次调用<code class="du ln lo lp lq b">setExposureCompensationIndex()</code>，新的请求将替换前一个请求，而前一个请求将通过<code class="du ln lo lp lq b">OperationCanceledException</code>被取消。通常，新的索引值被快速应用，并且输出流的暴露被相应地改变用于任何<a class="ae lk" href="https://developer.android.com/training/camerax/architecture#combine-use-cases" rel="noopener ugc nofollow" target="_blank">绑定用例</a>。如果应用程序需要知道特定请求的确切执行时间和结果，它可以向函数返回的<a class="ae lk" href="https://developer.android.com/reference/androidx/camera/core/CameraControl#setExposureCompensationIndex(int)" rel="noopener ugc nofollow" target="_blank">ListenableFuture&lt;Int&gt;</a>注册一个监听器。</p><h1 id="c938" class="jn jo hs bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">补偿指数和曝光值(EV)之间的映射</h1><p id="ea59" class="pw-post-body-paragraph ip iq hs ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">曝光值(EV)是一个定量单位，表示曝光补偿的光差量。+1 EV对应的是光的两倍，+2 EV是光的四倍，以此类推。应用程序可以将相同的<em class="lr">曝光值</em>应用于各种相机，甚至在不同的设备上，以获得相似的曝光，但是应用程序不应该出于相同的目的直接应用相同的<em class="lr">索引</em>值，因为索引是相机特定的值。</p><p id="df0f" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">使用补偿API，通过以下方式计算风险值:</p><p id="a00f" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">曝光值(EV) =曝光_补偿_指数*补偿_步长</p><p id="c8a3" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">上面提到的compensation_step是曝光值(EV)可以改变的最小单位。请注意，compensation_step也依赖于相机设备。应用程序可以从<code class="du ln lo lp lq b">ExposureState</code>查询相机的补偿步长，并计算曝光值，如下例所示:</p><figure class="kr ks kt ku fd hj"><div class="bz dy l di"><div class="ll lm l"/></div></figure><p id="3194" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">以曝光补偿指数6和⅓补偿步长为例，曝光补偿计算为+2 EV，这导致默认曝光值的<strong class="ir ht">加倍</strong>。</p><p id="4185" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">通常，补偿步长的步长通常以⅓或的分数单位获得；不太常见的是，一些设备可能提供1甚至更多的增量。在任一方向上支持的最大曝光值(EV)通常为2 EV或3 EV。</p><h1 id="ad78" class="jn jo hs bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">CameraX曝光补偿API可用性</h1><p id="1251" class="pw-post-body-paragraph ip iq hs ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">曝光补偿API在<code class="du ln lo lp lq b">android.camera:camera-core:1.0.0-beta09</code>首次实验性发布。</p><p id="d03a" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">该API在版本<code class="du ln lo lp lq b">android.camera:camera-core:1.1.0-alpha06</code>中作为正式CameraX API的一部分离开了实验阶段。</p><p id="6b22" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最新发布版本请参考【CameraX官方发布说明。</p><h1 id="0bca" class="jn jo hs bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">摘要</h1><p id="876f" class="pw-post-body-paragraph ip iq hs ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">GitHub 上的<a class="ae lk" href="https://github.com/wenhungwww/android-camerax-ev-sample" rel="noopener ugc nofollow" target="_blank">提供了CameraX曝光补偿的示例代码。与CameraX API的其余部分一起，曝光补偿API帮助开发人员创建创新的Android相机应用程序，这些应用程序在竞争激烈的移动应用程序世界中大放异彩。要了解更多关于CameraX的信息，请参考</a><a class="ae lk" href="https://developer.android.com/training/camerax" rel="noopener ugc nofollow" target="_blank">官方文档</a>；为了跟上CameraX的最新发展，请加入CameraX讨论组<a class="ae lk" href="https://groups.google.com/a/android.com/g/camerax-developers" rel="noopener ugc nofollow" target="_blank">。反馈非常有价值，也非常受欢迎:请在这里留下您的回复，在</a><a class="ae lk" href="https://groups.google.com/a/android.com/g/camerax-developers" rel="noopener ugc nofollow" target="_blank">CameraX讨论组</a>上与我们交流，或者通过官方问题跟踪器创建<a class="ae lk" href="https://issuetracker.google.com/issues/new?component=618491&amp;template=1257717" rel="noopener ugc nofollow" target="_blank"> CameraX问题</a>。</p><h1 id="c3ae" class="jn jo hs bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">参考:</h1><ul class=""><li id="dbe8" class="kv kw hs ir b is kl iw km ja ls je lt ji lu jm la lb lc ld bi translated"><a class="ae lk" href="https://developer.android.com/reference/androidx/camera/core/CameraControl#setExposureCompensationIndex(int)" rel="noopener ugc nofollow" target="_blank">setExposureCompensationIndex API</a>，<a class="ae lk" href="https://developer.android.com/reference/androidx/camera/core/ExposureState" rel="noopener ugc nofollow" target="_blank"> ExposureState API </a></li><li id="6e38" class="kv kw hs ir b is le iw lf ja lg je lh ji li jm la lb lc ld bi translated"><a class="ae lk" href="https://developer.android.com/jetpack/androidx/releases/camera" rel="noopener ugc nofollow" target="_blank">发行说明</a></li><li id="286a" class="kv kw hs ir b is le iw lf ja lg je lh ji li jm la lb lc ld bi translated"><a class="ae lk" href="https://developer.android.com/codelabs/camerax-getting-started" rel="noopener ugc nofollow" target="_blank">CameraX入门</a></li><li id="d7c9" class="kv kw hs ir b is le iw lf ja lg je lh ji li jm la lb lc ld bi translated"><a class="ae lk" href="https://github.com/android/camera-samples" rel="noopener ugc nofollow" target="_blank"> GitHub样本</a></li></ul></div></div>    
</body>
</html>