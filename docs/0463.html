<html>
<head>
<title>Data encryption on Android with Jetpack Security</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于Jetpack安全的Android数据加密</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/data-encryption-on-android-with-jetpack-security-e4cb0b2d2a9?source=collection_archive---------0-----------------------#2020-02-25">https://medium.com/androiddevelopers/data-encryption-on-android-with-jetpack-security-e4cb0b2d2a9?source=collection_archive---------0-----------------------#2020-02-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/6aa0e62bc10980f69aaf4032835b5196.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WefQBkBtLer3zIo6"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">Illustration by <a class="ae hu" href="https://twitter.com/VPoltrack" rel="noopener ugc nofollow" target="_blank">Virginia Poltrack</a></figcaption></figure><div class=""/><p id="7441" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hy">更新:2021年4月21日:</strong> Jetpack安全现<a class="ae hu" href="https://developer.android.com/jetpack/androidx/releases/security#1.0.0" rel="noopener ugc nofollow" target="_blank">稳定1.0.0 </a>！<br/> <strong class="iw hy">更新:2021年12月2日:</strong>Jetpack Security<a class="ae hu" href="https://developer.android.com/jetpack/androidx/releases/security#security-crypto-1.1.0-alpha03\" rel="noopener ugc nofollow" target="_blank">1 . 1 . 0–Alpha-03</a>发布，增加了对API level 21+的支持，其中包括重新设计的MasterKey实现。</p><p id="5afa" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">你试过在你的应用程序中加密数据吗？作为一名开发人员，您希望保证数据的安全，并掌握在打算使用的一方手中。但如果你像大多数Android开发者一样，你没有专门的安全团队来帮助正确加密你的应用数据。通过搜索网络来学习如何加密数据，你可能会得到几年前的答案，并提供不正确的例子。</p><p id="62a7" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><a class="ae hu" href="https://developer.android.com/topic/security/data.md" rel="noopener ugc nofollow" target="_blank">Jetpack Security</a>(JetSec)加密库为加密文件和SharedPreferences对象提供了抽象。该库在使用安全且众所周知的<a class="ae hu" href="https://github.com/google/tink/blob/master/docs/PRIMITIVES.md" rel="noopener ugc nofollow" target="_blank">密码原语</a>的同时，促进了<a class="ae hu" href="https://developer.android.com/training/articles/keystore" rel="noopener ugc nofollow" target="_blank"> AndroidKeyStore </a>的使用。使用<code class="du js jt ju jv b">EncryptedFile</code>和<code class="du js jt ju jv b">EncryptedSharedPreferences</code>允许您在本地保护可能包含敏感数据、API密钥、OAuth令牌和其他类型秘密的文件。</p><p id="7802" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为什么要在应用中加密数据？Android不是从5.0开始，<a class="ae hu" href="https://source.android.com/security/encryption" rel="noopener ugc nofollow" target="_blank">默认加密用户数据分区</a>的内容吗？的确如此，但是在一些使用案例中，您可能需要额外的保护级别。如果你的app使用<a class="ae hu" href="https://developer.android.com/training/data-storage/shared" rel="noopener ugc nofollow" target="_blank">共享存储</a>，你就要加密数据。在应用主目录中，如果您的应用处理敏感信息，包括但不限于个人身份信息(PII)、健康记录、财务详情或企业数据，您的应用应加密数据。如果可能的话，我们建议您将此信息与生物特征相关联，以获得额外的保护。</p><p id="1b32" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Jetpack安全基于谷歌的开源跨平台安全项目Tink。如果您需要一般加密、混合加密或类似的东西，Tink可能是合适的。Jetpack安全数据结构与Tink完全兼容。</p><h1 id="1ea0" class="jw jx hx bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">密钥生成</h1><p id="5320" class="pw-post-body-paragraph iu iv hx iw b ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr ha bi translated">在我们开始加密您的数据之前，了解如何保护您的加密密钥是很重要的。Jetpack Security使用一个<em class="kz">主密钥</em>，用于加密所有用于加密操作的子密钥。JetSec在<code class="du js jt ju jv b">MasterKeys</code>类中提供了一个推荐的默认主密钥。该类使用一个基本的AES256-GCM密钥，该密钥是在AndroidKeyStore中生成和存储的。AndroidKeyStore是一个容器，它将加密密钥存储在TEE或StrongBox中，使它们很难被提取。子项存储在一个可配置的<code class="du js jt ju jv b">SharedPreferences</code>对象中。</p><p id="3c5f" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">首先，我们在Jetpack安全中使用了<code class="du js jt ju jv b">AES256_GCM_SPEC</code>规范，这是为一般用例推荐的。AES256-GCM是对称的，在现代设备上通常速度很快。</p><figure class="la lb lc ld fd hj"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="0486" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">对于需要更多配置或处理非常敏感的数据的应用程序，建议构建您的<code class="du js jt ju jv b">KeyGenParameterSpec</code>，选择对您的使用有意义的选项。带<code class="du js jt ju jv b"><a class="ae hu" href="https://developer.android.com/jetpack/androidx/releases/biometric" rel="noopener ugc nofollow" target="_blank">BiometricPrompt</a></code>的限时密钥可以提供额外的保护，防止根设备或受损设备。</p><p id="1f76" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">重要选项:</p><ul class=""><li id="be25" class="lg lh hx iw b ix iy jb jc jf li jj lj jn lk jr ll lm ln lo bi translated"><code class="du js jt ju jv b">userAuthenticationRequired()</code>和<code class="du js jt ju jv b">userAuthenticationValiditySeconds() </code>可用于创建一个有时间限制的密钥。有时间限制的密钥需要使用<code class="du js jt ju jv b">BiometricPrompt</code>对对称密钥的加密和解密进行授权。</li><li id="3df8" class="lg lh hx iw b ix lp jb lq jf lr jj ls jn lt jr ll lm ln lo bi translated"><code class="du js jt ju jv b">unlockedDeviceRequired()</code>设置一个标志，有助于确保在设备未解锁的情况下无法访问密钥。此标志在Android Pie及更高版本上可用。</li><li id="6d32" class="lg lh hx iw b ix lp jb lq jf lr jj ls jn lt jr ll lm ln lo bi translated">使用<code class="du js jt ju jv b">setIsStrongBoxBacked()</code>，在更强大的独立芯片上运行加密操作。这对性能有轻微的影响，但更安全。它在一些运行Android Pie或更高版本的设备上可用。</li></ul><p id="7580" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hy">注意:</strong>如果您的应用程序需要在后台加密数据，您不应使用有时限的密钥或要求设备解锁，因为没有用户在场，您将无法完成此操作。</p><figure class="la lb lc ld fd hj"><div class="bz dy l di"><div class="le lf l"/></div><figcaption class="hq hr et er es hs ht bd b be z dx">Configuration requiring user authentication using BiometricPrompt</figcaption></figure><h1 id="0dd4" class="jw jx hx bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">解锁有时间限制的密钥</h1><p id="d08e" class="pw-post-body-paragraph iu iv hx iw b ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr ha bi translated">如果您的密钥是使用以下选项创建的，您必须使用<code class="du js jt ju jv b">BiometricPrompt</code>来授权设备:</p><ul class=""><li id="e653" class="lg lh hx iw b ix iy jb jc jf li jj lj jn lk jr ll lm ln lo bi translated"><code class="du js jt ju jv b">userAuthenticationRequired</code>是真的</li><li id="a28c" class="lg lh hx iw b ix lp jb lq jf lr jj ls jn lt jr ll lm ln lo bi translated"><code class="du js jt ju jv b">userAuthenticationValiditySeconds</code> &gt; 0</li></ul><p id="8c45" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">用户通过身份验证后，密钥会在“有效秒数”字段中设置的时间内解锁。AndroidKeystore没有查询密钥设置的API，因此您的应用程序必须跟踪这些设置。您应该在向用户显示对话框的活动的<code class="du js jt ju jv b">onCreate()</code>方法中构建您的<code class="du js jt ju jv b">BiometricPrompt</code>实例。</p><p id="6b80" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">解锁限时钥匙的生物计量提示码</p><figure class="la lb lc ld fd hj"><div class="bz dy l di"><div class="le lf l"/></div></figure><h1 id="0f19" class="jw jx hx bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">加密文件</h1><p id="a2c0" class="pw-post-body-paragraph iu iv hx iw b ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr ha bi translated">Jetpack Security包括一个<code class="du js jt ju jv b">EncryptedFile</code>类，它消除了加密文件数据的挑战。与<code class="du js jt ju jv b">File</code>类似，<code class="du js jt ju jv b">EncryptedFile</code>提供了一个用于读取的<code class="du js jt ju jv b">FileInputStream</code>对象和一个用于写入的<code class="du js jt ju jv b">FileOutputStream</code>对象。文件使用<a class="ae hu" href="https://github.com/google/tink/blob/master/docs/PRIMITIVES.md#streaming-authenticated-encryption-with-associated-data" rel="noopener ugc nofollow" target="_blank">流式AEAD加密，它遵循OAE2定义</a>。数据被分成块，并使用AES256-GCM加密，这样就不可能重新排序。</p><figure class="la lb lc ld fd hj"><div class="bz dy l di"><div class="le lf l"/></div></figure><h1 id="82b7" class="jw jx hx bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">加密共享的首选项</h1><p id="59aa" class="pw-post-body-paragraph iu iv hx iw b ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr ha bi translated">如果您的应用程序需要保存键-值对——比如API键——JetSec提供了<code class="du js jt ju jv b">EncryptedSharedPreferences</code>类，该类使用您已经习惯的SharedPreferences接口。</p><p id="33e8" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">密钥和值都是加密的。密钥使用<a class="ae hu" href="https://tools.ietf.org/html/rfc5297" rel="noopener ugc nofollow" target="_blank"> AES256-SIV-CMAC </a>加密，提供确定性密文；值使用AES256-GCM加密，并绑定到加密密钥。该方案允许安全地加密密钥数据，同时仍然允许查找。</p><figure class="la lb lc ld fd hj"><div class="bz dy l di"><div class="le lf l"/></div></figure><h1 id="7c7f" class="jw jx hx bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">更多资源</h1><p id="56fa" class="pw-post-body-paragraph iu iv hx iw b ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn ky jp jq jr ha bi translated"><a class="ae hu" href="https://github.com/android/security-samples/tree/master/FileLocker" rel="noopener ugc nofollow" target="_blank">fileloker</a>是Android Security GitHub示例页面上的一个示例应用。这是一个很好的例子，说明了如何使用Jetpack安全来使用文件加密。</p><p id="990f" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">有关最新进展，请查看这里。如有疑问，欢迎在Twitter上联系我(<a class="ae hu" href="https://twitter.com/jonmarkoff" rel="noopener ugc nofollow" target="_blank"> @jonmarkoff </a>)。</p><p id="2b36" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">加密快乐！</p></div></div>    
</body>
</html>