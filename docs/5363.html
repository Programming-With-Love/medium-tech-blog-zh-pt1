<html>
<head>
<title>Working with Oracle Cloud Infrastructure Classic Security Rules in Terraform: Part 1 — Shared Networks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Terraform中使用Oracle云基础架构经典安全规则:第1部分—共享网络</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/working-with-oracle-cloud-infrastructure-classic-security-rules-in-terraform-part-1-shared-155675ada6b5?source=collection_archive---------0-----------------------#2017-12-15">https://medium.com/oracledevs/working-with-oracle-cloud-infrastructure-classic-security-rules-in-terraform-part-1-shared-155675ada6b5?source=collection_archive---------0-----------------------#2017-12-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="e2f2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本文提供了使用<code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/index.html" rel="noopener ugc nofollow" target="_blank">opc</a></code> Terraform提供者处理安全定义的概述。</p><p id="9e48" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae jg" href="https://cloud.oracle.com/classic" rel="noopener ugc nofollow" target="_blank">Oracle Cloud infra structure Classic</a>(以及Oracle Cloud at Customer)服务提供了两种网络选项- <strong class="ig hi">共享网络</strong>和<strong class="ig hi"> IP网络</strong>。对于本文的第1部分，我们将关注共享的网络安全资源。</p><blockquote class="jh ji jj"><p id="79d7" class="ie if jk ig b ih ii ij ik il im in io jl iq ir is jm iu iv iw jn iy iz ja jb ha bi translated">另请参见<a class="ae jg" rel="noopener" href="/oracledevs/working-with-oracle-cloud-infrastructure-classic-security-rules-in-terraform-part-2-ip-networks-b36c48d87330">在Terraform中使用Oracle云基础设施经典安全规则:第2部分— IP网络</a></p></blockquote><p id="c159" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">建议熟悉<a class="ae jg" href="https://docs.oracle.com/en/cloud/iaas/compute-iaas-cloud/stcsg/network-settings.html" rel="noopener ugc nofollow" target="_blank">共享网络安全概念</a>。Terraform支持的共享网络安全资源有:</p><ul class=""><li id="f105" class="jo jp hh ig b ih ii il im ip jq it jr ix js jb jt ju jv jw bi translated"><code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/opc/r/opc_compute_security_list.html" rel="noopener ugc nofollow" target="_blank">opc_compute_security_list</a></code></li><li id="ea61" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated"><code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/opc/r/opc_compute_sec_rule.html" rel="noopener ugc nofollow" target="_blank">opc_compute_sec_rule</a></code></li><li id="1351" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated"><code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/opc/r/opc_compute_security_ip_list.html" rel="noopener ugc nofollow" target="_blank">opc_compute_security_ip_list</a></code></li><li id="65aa" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated"><code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/opc/r/opc_compute_security_application.html" rel="noopener ugc nofollow" target="_blank">opc_compute_security_application</a></code></li><li id="1e73" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated"><code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/opc/r/opc_compute_security_association.html" rel="noopener ugc nofollow" target="_blank">opc_compute_security_association</a></code></li></ul><p id="5740" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了理解它们是如何协同工作的，让我们来看看它们之间的一般关系。</p><figure class="kd ke kf kg fd kh er es paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="er es kc"><img src="../Images/5c65cadf3f7827fca931630499c8830a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m-ilXiaBjjkceHc7vM6PDg.png"/></div></div></figure><p id="aac6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一个<strong class="ig hi">计算实例</strong>上的共享网络接口可以与一个或多个<strong class="ig hi">安全列表</strong>相关联。<strong class="ig hi">安全规则</strong>为<strong class="ig hi">安全IP列表</strong>和<strong class="ig hi">安全列表</strong>之间或者两个安全列表(<em class="jk">未显示</em>)之间的<strong class="ig hi">安全应用</strong>流量定义了入口和出口流量行为。</p><h1 id="c900" class="ko kp hh bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">定义安全列表</h1><p id="e9be" class="pw-post-body-paragraph ie if hh ig b ih lm ij ik il ln in io ip lo ir is it lp iv iw ix lq iz ja jb ha bi translated">安全列表是与特定实例或实例组直接关联的资源(我们稍后将介绍如何定义该关联)。值得注意的是，安全列表是围绕着<em class="jk"/>所有与该安全列表相关联的实例的墙。安全列表不限制同一安全列表中实例之间的通信。</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="2bea" class="lv kp hh jf b fi lw lx l ly lz">resource "opc_compute_security_list" "my-security-list" {<br/>  name                 = "my-security-list"<br/>  policy               = "DENY"<br/>  outbound_cidr_policy = "PERMIT"<br/>}</span></pre><p id="6c83" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du jc jd je jf b">policy</code>属性定义默认的入口流量过滤，而<code class="du jc jd je jf b">outbound_cidr_policy</code>定义如何过滤出口流量。在此示例中，允许来自实例的所有入站流量和阻止以及出站流量。</p><p id="a069" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后可以添加安全规则以应用特定的流量策略。在这个例子中，我们将添加一个安全规则来允许进入的SSH流量(TCP端口22)。</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="77fa" class="lv kp hh jf b fi lw lx l ly lz">resource "opc_compute_sec_rule" "allow-ssh" {<br/>  name             = "Allow-ssh-access"<br/>  application      = "/oracle/public/ssh"<br/>  source_list      = "seciplist:/oracle/public/public-internet"<br/>  destination_list = "seclist:${opc_compute_security_list.my-security-list.name}"<br/>  action           = "permit"<br/>}</span></pre><p id="9cdd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们对这种配置进行分解，以了解发生了什么。</p><p id="fd54" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du jc jd je jf b"><strong class="ig hi">application</strong></code>定义此规则适用的特定流量类型和端口。许多默认的安全应用程序类型都是预先定义的，包括:</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="a723" class="lv kp hh jf b fi lw lx l ly lz">/oracle/public/all<br/>/oracle/public/icmp<br/>/oracle/public/http<br/>/oracle/public/https<br/>/oracle/public/mysql<br/>/oracle/public/rdp<br/>/oracle/public/ssh</span></pre><p id="0f6a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">完整列表可在计算控制台的“安全应用程序”部分找到。或者，可以定义和引用<code class="du jc jd je jf b">opc_compute_security_application</code>资源(参见下面的<strong class="ig hi">定义安全应用</strong>)。</p><p id="a3d0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du jc jd je jf b"><strong class="ig hi">source_list</strong></code>确定交通来源。这可以是对安全IP列表或其他安全列表资源的引用。<code class="du jc jd je jf b">seciplist:</code>或<code class="du jc jd je jf b">seclist:</code>前缀用于区分被引用的资源类型。在这个例子中，我们使用预定义的安全IP列表<code class="du jc jd je jf b">/oracle/public/public-internet</code>来允许来自任何主机的流量。如果我们希望限制在特定的子网或IP地址范围内，那么我们可以定义并引用一个<code class="du jc jd je jf b">opc_compute_security_ip_list</code>资源(请参见下面的<strong class="ig hi">定义安全IP列表</strong>)。</p><p id="ba47" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du jc jd je jf b"><strong class="ig hi">destination_list</strong></code>为以上定义的安全列表。是安全列表是目标这是入口规则，如果安全列表被设置为源，我们将定义和出口规则。</p><p id="7d8b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du jc jd je jf b"><strong class="ig hi">action</strong></code>设置为<code class="du jc jd je jf b">permit</code>，因此此规则优先于安全列表中为入口流量设置的默认<code class="du jc jd je jf b">DENY</code>策略，以允许此规则定义的流量。</p><h2 id="038e" class="lv kp hh bd kq ma mb mc ku md me mf ky ip mg mh lc it mi mj lg ix mk ml lk mm bi translated">定义安全IP列表</h2><p id="c8a8" class="pw-post-body-paragraph ie if hh ig b ih lm ij ik il ln in io ip lo ir is it lp iv iw ix lq iz ja jb ha bi translated">如上所述，安全IP列表定义了如何基于源或目的IP地址应用安全规则。<code class="du jc jd je jf b">ip_entries</code>可以是单个IP地址，也可以是子网CIDR。</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="2308" class="lv kp hh jf b fi lw lx l ly lz">resource "opc_compute_security_ip_list" "my-ip-list1" {<br/>  name       = "my-ip-list1"<br/>  ip_entries = ["172.16.0.0/24" "192.168.0.1", "192.168.10.1"]<br/>}</span></pre><p id="6183" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">安全IP列表然后可以在一个或多个安全规则中被引用，作为目的地列表的源，例如</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="ca00" class="lv kp hh jf b fi lw lx l ly lz">resource "opc_compute_sec_rule" "allow-ssh" {<br/>  name             = "Allow-ssh-access"<br/><strong class="jf hi">  source_list      = "seciplist:${</strong><strong class="jf hi">opc_compute_security_ip_list</strong><strong class="jf hi">.</strong><strong class="jf hi">my-ip-list1</strong><strong class="jf hi">.name}"</strong><br/>  destination_list = "seclist:${opc_compute_security_list.my-security-list.name}"<br/>  ...<br/>}</span></pre><h2 id="62d6" class="lv kp hh bd kq ma mb mc ku md me mf ky ip mg mh lc it mi mj lg ix mk ml lk mm bi translated">定义安全应用程序</h2><p id="1300" class="pw-post-body-paragraph ie if hh ig b ih lm ij ik il ln in io ip lo ir is it lp iv iw ix lq iz ja jb ha bi translated">安全应用程序根据IP流量类型<code class="du jc jd je jf b">ICMP</code>、<code class="du jc jd je jf b">UDP</code>或<code class="du jc jd je jf b">TCP</code>以及目的端口定义特定的流量分类。</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="9735" class="lv kp hh jf b fi lw lx l ly lz">resource "opc_compute_security_application" "ssh" {<br/>  name     = "ssh"<br/>  protocol = "tcp"<br/>  dport    = "22"<br/>}</span></pre><p id="5c92" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">安全应用程序然后可以在一个或多个安全规则中被引用，例如</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="01b7" class="lv kp hh jf b fi lw lx l ly lz">resource "opc_compute_sec_rule" "allow-ssh" {<br/>  name        = "Allow-ssh-access"<br/><strong class="jf hi">  application = "${</strong><strong class="jf hi">opc_compute_security_application</strong><strong class="jf hi">.ssh.name}"<br/>  ...<br/></strong>}</span></pre><h1 id="a94a" class="ko kp hh bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">将安全性列表与实例相关联</h1><p id="e023" class="pw-post-body-paragraph ie if hh ig b ih lm ij ik il ln in io ip lo ir is it lp iv iw ix lq iz ja jb ha bi translated">有两种方法可以将安全列表与Terraform配置中的实例相关联，要么直接在作为<code class="du jc jd je jf b">networking_info</code>配置一部分的<code class="du jc jd je jf b">opc_compute_instance</code>定义中设置安全列表，要么使用<code class="du jc jd je jf b">opc_compute_security_association</code>资源。</p><p id="6372" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">在为您的配置选择最合适的方法时应小心谨慎，因为两者之间存在一些微妙的差异。</strong></p><p id="4329" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通常首选的方法是直接在计算实例资源定义中声明安全列表。</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="0f19" class="lv kp hh jf b fi lw lx l ly lz">resource "opc_compute_instance" "my-instance" {<br/>  name = "myinstance"<br/>  ...<br/>  networking_info {<br/><strong class="jf hi">    shared_network = true</strong><br/><strong class="jf hi">    sec_lists      = [ "${opc_compute_security_list.my-security-list.name}" ]</strong><br/>  }<br/>}</span></pre><ul class=""><li id="e731" class="jo jp hh ig b ih ii il im ip jq it jr ix js jb jt ju jv jw bi translated"><strong class="ig hi"> PRO </strong>:计算实例<code class="du jc jd je jf b">sec_lists</code>中定义的安全列表在实例创建时关联，这意味着当执行任何cloud-init、opc-init或Terraform provisioner初始化脚本时，它们都在适当的位置。</li><li id="7ff6" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated"><strong class="ig hi">缺点</strong>:从接口<code class="du jc jd je jf b">sec_lists</code>中添加或删除安全列表将强制重新创建实例。</li></ul><p id="19d7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">或者，可以定义一个显式的<code class="du jc jd je jf b">opc_compute_security_association</code>资源，将一个安全列表与一个实例相关联。</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="5c2c" class="lv kp hh jf b fi lw lx l ly lz">resource "opc_compute_security_association" "<!-- -->my-security-list<!-- -->" {<br/>  name    = "my<!-- -->-instance_my-security-list<!-- -->"<br/>  vcable  = "${opc_compute_instance.my<!-- -->-instance<!-- -->.vcable}"<br/>  seclist = "${opc_compute_security_list.<!-- -->my-security-list<!-- -->.name}"<br/>}</span></pre><ul class=""><li id="f915" class="jo jp hh ig b ih ii il im ip jq it jr ix js jb jt ju jv jw bi translated"><strong class="ig hi"> PRO </strong>:安全列表关联允许将安全列表添加到已经运行的实例中，而无需强制重新创建实例。</li><li id="8fd2" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated"><strong class="ig hi"> CON </strong>:安全列表关联在实例启动后<em class="jk">才会应用，这意味着当cloud-init或opc-init脚本试图运行时，流量可能会被阻塞。</em></li></ul><h2 id="65cb" class="lv kp hh bd kq ma mb mc ku md me mf ky ip mg mh lc it mi mj lg ix mk ml lk mm bi translated">小心<code class="du jc jd je jf b">the "<strong class="ak">default</strong>" security list</code></h2><p id="7432" class="pw-post-body-paragraph ie if hh ig b ih lm ij ik il ln in io ip lo ir is it lp iv iw ix lq iz ja jb ha bi translated">最后一点需要注意。当定义具有共享网络接口的计算实例资源时，如果<code class="du jc jd je jf b">sec_lists</code>属性是<em class="jk">而不是</em>定义的，则计算实例将自动与<code class="du jc jd je jf b">default</code>安全列表相关联。</p><p id="05b3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当使用Terraform配置实例时，这通常不是我们想要的行为。如前所述，流量在同一个安全列表内的实例之间不受<em class="jk">和</em>的限制(也就是说，同一个地区或区域内与<code class="du jc jd je jf b">default</code>相关的所有实例都可以访问与<code class="du jc jd je jf b">default</code>相关的所有实例)。这也是为什么一般推荐在实例定义中设置<code class="du jc jd je jf b">sec_lists</code>的原因之一。</p><p id="7c20" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在第2部分中，我们将看看如何定义IP网络的安全规则</p></div></div>    
</body>
</html>