<html>
<head>
<title>Backup PostgreSQL Database to Oracle Cloud Infrastructure Object Storage Bucket</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将PostgreSQL数据库备份到Oracle云基础架构对象存储桶</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/backup-postgresql-database-to-oracle-cloud-infrastructure-object-storage-bucket-6314052c0661?source=collection_archive---------1-----------------------#2021-12-07">https://medium.com/oracledevs/backup-postgresql-database-to-oracle-cloud-infrastructure-object-storage-bucket-6314052c0661?source=collection_archive---------1-----------------------#2021-12-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="e960" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">第2篇文章— PostgreSQL备份到Oracle云基础架构</h2></div><p id="70a0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这是PostgreSQL OCI系列的第二篇文章。在<a class="ae js" rel="noopener" href="/oracledevs/migrate-postgresql-from-aws-rds-to-oracle-cloud-infrastructure-2c5fdff50135">第一篇文章</a>中，我们将PostgreSQL数据库从AWS RDS迁移到Oracle云基础设施(OCI) IaaS上的PostgreSQL。在本文中，我们将把同一个PostgreSQL数据库备份到一个Oracle对象存储(OCI操作系统)存储桶。OCI操作系统是一个几乎无限可扩展的互联网级存储，类似于AWS S3</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/dedea4947b0c4fa527e6c71f8c017581.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kfrLOIFnTYQH-rzF04rTOA.png"/></div></div></figure><h2 id="8b2e" class="kf kg hh bd kh ki kj kk kl km kn ko kp jf kq kr ks jj kt ku kv jn kw kx ky kz bi translated">设置</h2><ol class=""><li id="97ff" class="la lb hh iy b iz lc jc ld jf le jj lf jn lg jr lh li lj lk bi translated">在OCI上安装PostgreSQL实例。参考第一篇@ <a class="ae js" rel="noopener" href="/oracledevs/migrate-postgresql-from-aws-rds-to-oracle-cloud-infrastructure-2c5fdff50135">第三步</a></li></ol><p id="20ca" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">使用<a class="ae js" href="https://github.com/oracle-quickstart/oci-postgresql" rel="noopener ugc nofollow" target="_blank">https://github.com/oracle-quickstart/oci-postgresql</a>部署官方的OCI Github quickstart PostgreSQL</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es ll"><img src="../Images/1cec576495fe8b28f5ca15396883beb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jHOvT_n-SPszqskZzIljAg.png"/></div></div></figure><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es ll"><img src="../Images/28ccc26c947478a5bba2366a04f88b8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Baw8juoYouWEz-AGNYT-MQ.png"/></div></div></figure><p id="2c6d" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">2.在您的租户中创建Oracle对象存储桶，作为您的备份存储库</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lm"><img src="../Images/46f5c4e196de04958ddebbb09b70d631.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NsnAq7yxLfNLrW712S6avw.png"/></div></div></figure><p id="af1a" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">3.将PostgreSQL实例分配给<a class="ae js" href="https://docs.oracle.com/en-us/iaas/Content/Identity/Tasks/callingservicesfrominstances.htm" rel="noopener ugc nofollow" target="_blank">，使用实例主体通过OCI </a>进行身份验证</p><p id="e31f" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">a.创建动态组以匹配实例OCID</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es ln"><img src="../Images/02af8fd0df160bc4e1a15eb50d9f818e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G3aLBMYkhiQEIgxVLKbQfg.png"/></div></div></figure><p id="4b4f" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">b.使用动态组创建策略，以允许访问对象存储和其他OCI服务(如果需要)</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lo"><img src="../Images/b93c6b4e56d135392efaf25fa40e7dcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HChmotUIjLKKA5CcctqEPw.png"/></div></div></figure><p id="c422" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="lp">如果要从非OCI主机备份PostgreSQL数据库，则需要</em> <a class="ae js" href="https://database-heartbeat.com/2021/10/05/auth-cli/" rel="noopener ugc nofollow" target="_blank"> <em class="lp">安装oci-cli并单独配置API密钥。</em></a><em class="lp">OCI上的实例主体避免了在机器上存储API密钥，因此是一种更安全的方法。</em></p><p id="bcec" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">4.在PostgreSQL实例上配置oci-cli以使用实例主体</p><p id="07f1" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果您已经使用我们的OCI Github quickstart代码部署了PostgreSQL，则默认安装oci-cli。</p><p id="38bf" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">a.导出使用实例主体的参数</p><pre class="ju jv jw jx fd lq lr ls lt aw lu bi"><span id="1ae9" class="kf kg hh lr b fi lv lw l lx ly">export OCI_RESOURCE_PRINCIPAL_VERSION=1.1<br/>export OCI_RESOURCE_PRINCIPAL_RPT_ENDPOINT=”<a class="ae js" href="https://database.ap-melbourne-1.oraclecloud.com" rel="noopener ugc nofollow" target="_blank">https://database.ap-melbourne-1.oraclecloud.com</a>"</span></pre><p id="2495" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">b.通过列出存储桶来测试实例主体是否在工作</p><pre class="ju jv jw jx fd lq lr ls lt aw lu bi"><span id="7498" class="kf kg hh lr b fi lv lw l lx ly">oci os bucket list --auth instance_principal --compartment-id ocid1.compartment.oc1..aaaa******************ua</span></pre><p id="d2b6" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">c.同步PostgreSQL备份将在本地驻留的备份目录，并首先手动测试与Oracle对象存储的同步</p><pre class="ju jv jw jx fd lq lr ls lt aw lu bi"><span id="58fb" class="kf kg hh lr b fi lv lw l lx ly">oci os object sync -bn pgmaster-imported-db-backups --src-dir /home/opc/backup --dry-run --auth instance_principal<br/>oci os object sync -bn pgmaster-imported-db-backups --src-dir /home/opc/backup --auth instance_principal</span></pre><p id="ca96" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">5.创建一个主shell脚本来备份PostgreSQL，然后将备份目录同步到Oracle对象存储</p><pre class="ju jv jw jx fd lq lr ls lt aw lu bi"><span id="0c0d" class="kf kg hh lr b fi lv lw l lx ly">#!/bin/bash<br/>export OCI_RESOURCE_PRINCIPAL_VERSION=1.1<br/>export OCI_RESOURCE_PRINCIPAL_RPT_ENDPOINT="<a class="ae js" href="https://database.ap-melbourne-1.oraclecloud.com" rel="noopener ugc nofollow" target="_blank">https://database.ap-melbourne-1.oraclecloud.com</a>"<br/># Oracle Object Storage Vars<br/>bucket='pgmaster-imported-db-backups'<br/>sourcedir='/home/opc/backup' #The directory is same as local backupdir<br/># Local PostgreSQL Backup Vars<br/>hostname=`hostname`<br/>date=`date +"%Y%m%d_%H%M%N"`<br/>backupdir='/home/opc/backup' #The directory is same as local sourcedir<br/>dbname='demo'<br/>filename="$backupdir/${hostname}_${dbname}_${date}"<br/># Backup DBs<br/> pg_dump -U postgres --encoding utf8 -F c -f $filename.dump $dbname<br/> echo "Starting Upload to Oracle Object Storage"<br/> sleep 5<br/># Upload to Oracle Object Storage<br/> oci os object sync -bn $bucket --src-dir $sourcedir --auth instance_principal</span><span id="78c9" class="kf kg hh lr b fi lz lw l lx ly">exit 0</span></pre><p id="7175" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，您可以检查您的OCI存储桶，您会看到备份转储文件出现在那里。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es ma"><img src="../Images/909f3b6c26b5df72a2cecb2ba3fd19f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fhn9-if56ECMeL1JQAmMSg.png"/></div></div></figure><p id="5a8c" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">6.最后，在Crontab中按满足您的RPO(恢复点目标)的时间间隔安排备份脚本</p><pre class="ju jv jw jx fd lq lr ls lt aw lu bi"><span id="5415" class="kf kg hh lr b fi lv lw l lx ly">crontab -e</span><span id="97c1" class="kf kg hh lr b fi lz lw l lx ly">16 14 * * * /home/opc/Backup_Pgsql_to_OCI.sh</span></pre><h2 id="bcd7" class="kf kg hh bd kh ki kj kk kl km kn ko kp jf kq kr ks jj kt ku kv jn kw kx ky kz bi translated">结论</h2><p id="4a39" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf mb jh ji jj mc jl jm jn md jp jq jr ha bi translated">我们可以看到为PostgreSQL到OCI对象存储桶创建完整的数据库备份是多么容易。在生产数据库场景中，您可能需要使用一个足够大的本地挂载点来获取本地数据库备份，然后将其上传到对象存储并从本地存储中清除。</p><p id="1d37" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">使用oci-cli进行同步的一个优点是，任何大于128MB的文件都会使用多部分上传自动上传，因此如果上传失败，您可以继续备份。</p><p id="b815" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">页（page的缩写）s:如果您想备份实例上的所有数据库，那么您可以在shell脚本中使用<em class="lp"> pg_dumpall </em>而不是<em class="lp"> pg_dump </em>。疯狂上剧本！:)</p><h2 id="e5eb" class="kf kg hh bd kh ki kj kk kl km kn ko kp jf kq kr ks jj kt ku kv jn kw kx ky kz bi translated">下一步是什么？</h2><p id="4e9c" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf mb jh ji jj mc jl jm jn md jp jq jr ha bi translated">在本系列的后续文章中，我们将探讨如何使用OCI本地跨区域复制，结合启动和块卷复制将PostgreSQL复制到另一个区域。</p><h2 id="041e" class="kf kg hh bd kh ki kj kk kl km kn ko kp jf kq kr ks jj kt ku kv jn kw kx ky kz bi translated">进一步阅读</h2><p id="16f2" class="pw-post-body-paragraph iw ix hh iy b iz lc ii jb jc ld il je jf mb jh ji jj mc jl jm jn md jp jq jr ha bi translated"><a class="ae js" rel="noopener" href="/oracledevs/migrate-postgresql-from-aws-rds-to-oracle-cloud-infrastructure-2c5fdff50135"> 1 — </a>将PostgreSQL从AWS RDS迁移到OCI PostgreSQL</p></div></div>    
</body>
</html>