<html>
<head>
<title>Rock-solid K3s on OCI — part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">坚如磐石的solid K3s第二部分</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/rock-solid-k3s-on-oci-part-2-4f7b95faca88?source=collection_archive---------0-----------------------#2022-11-09">https://medium.com/oracledevs/rock-solid-k3s-on-oci-part-2-4f7b95faca88?source=collection_archive---------0-----------------------#2022-11-09</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/1f6e556f001ac716126f961fbadbfdc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:724/format:webp/1*MOnRCw7YAniziVSZw-X4ig.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo by Leon Macapagal: <a class="ae it" href="https://www.pexels.com/photo/aerial-view-of-city-buildings-beside-water-6622898/" rel="noopener ugc nofollow" target="_blank">https://www.pexels.com/photo/aerial-view-of-city-buildings-beside-water-6622898/</a></figcaption></figure><p id="26ac" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这是在OCI永远免费租赁中运行K3s系列的第二部分。您应该已经完成了第一部分中的OCI基础设施设置。如果你还没有这样做，回头看看<a class="ae it" rel="noopener" href="/@timclegg/rock-solid-k3s-on-oci-part-1-dbfeaa69d670">第一部分</a>的介绍和所需的OCI资源列表。</p><p id="0d12" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这一部分在我们在<a class="ae it" rel="noopener" href="/@timclegg/rock-solid-k3s-on-oci-part-1-dbfeaa69d670">第一部分</a>中创建的OCI计算实例上设置K3s。让我们忙着安装K3s吧…</p><h1 id="bdd4" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">安装K3s服务器—禁用防火墙</h1><p id="865f" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated"><strong class="iw hi">注意:</strong>对于长期安装来说，这不是最佳实践或推荐的方法(当然不适合生产环境！).这是基于<a class="ae it" href="https://rancher.com/docs/k3s/latest/en/advanced/#additional-preparation-for-red-hat-centos-enterprise-linux" rel="noopener ugc nofollow" target="_blank"> Rancher K3s文档</a>中给出的建议。</p><p id="f7bf" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在服务器上运行以下命令，禁用基于主机的防火墙(<em class="kv"> firewalld </em>)的运行:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="523e" class="lf jt hh lb b fi lg lh l li lj">sudo systemctl stop firewalld<br/>sudo systemctl disable firewalld</span></pre><h1 id="57f1" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">安装K3s服务器—创建K3s配置目录和文件</h1><p id="242c" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">有几个YAML文件将用于配置K3s。继续创建<em class="kv"> /etc/rancher/k3s </em>目录，这些文件将放置在该目录中:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="e485" class="lf jt hh lb b fi lg lh l li lj">sudo mkdir -p /etc/rancher/k3s</span></pre><p id="42e4" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">下面将创建一个kubelet配置文件，这是必需的:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="b491" class="lf jt hh lb b fi lg lh l li lj">sudo su -c 'OCID=$(curl -s -H "Authorization: Bearer Oracle" -L <a class="ae it" href="http://169.254.169.254/opc/v2/instance/" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/opc/v2/instance/</a> | jq .id | tr -d "\"")<br/>printf "apiVersion: <a class="ae it" href="http://kubelet.config.k8s.io/v1beta1" rel="noopener ugc nofollow" target="_blank">kubelet.config.k8s.io/v1beta1</a><br/>kind: KubeletConfiguration<br/>providerID: $(echo $OCID)" &gt; /etc/rancher/k3s/$(hostname)-kubelet.yaml'</span></pre><p id="dda5" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">上面的命令查询OCI实例可用的OCI实例元数据，获取存储在配置文件中的实例OCID。参见<a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/Compute/Tasks/gettingmetadata.htm" rel="noopener ugc nofollow" target="_blank"> OCI文档</a>获取更多关于OCI实例元数据的信息。</p><p id="f03b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">创建附加配置文件:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="433b" class="lf jt hh lb b fi lg lh l li lj">sudo su -c 'printf "write-kubeconfig-mode: \"0644\"<br/>kubelet-arg=config: \"/etc/rancher/k3s/$(hostname)-kubelet.yaml\"<br/>kubelet-arg=cloud-provider: \"external\"<br/>kube-controller-manager-arg=cloud-provider: \"external\"<br/>" &gt; /etc/rancher/k3s/config.yaml'</span></pre><h1 id="0a46" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">安装K3s服务器— K3s安装</h1><p id="5b72" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">运行以下命令来安装K3s服务器:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="88a2" class="lf jt hh lb b fi lg lh l li lj">curl -sfL <a class="ae it" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | INSTALL_K3S_VERSION=$(curl -s "<a class="ae it" href="https://api.github.com/repos/k3s-io/k3s/tags" rel="noopener ugc nofollow" target="_blank">https://api.github.com/repos/k3s-io/k3s/tags</a>" | jq .[0].name | tr -d "\"") sh -s - server --disable-cloud-controller --disable servicelb --disable traefik --kubelet-arg="cloud-provider=external" --kubelet-arg="provider-id=$(curl -s -H "Authorization: Bearer Oracle" -L <a class="ae it" href="http://169.254.169.254/opc/v2/instance/" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/opc/v2/instance/</a> | jq .id | tr -d "\"")"</span></pre><p id="a154" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们将获得最新的K3s版本，并从实例元数据中获得OCID。正在修改一些默认设置，如默认云控制器、Traefik、service LB等。这是因为我们将使用OCI云控制器(稍后安装)将K3s安装与OCI集成。</p><h1 id="8018" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">安装K3s服务器—污染K3s服务器节点</h1><p id="bb9d" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">玷污节点对<a class="ae it" href="https://github.com/oracle/oci-cloud-controller-manager" rel="noopener ugc nofollow" target="_blank"> OCI云控制器管理器</a>很重要:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="bdad" class="lf jt hh lb b fi lg lh l li lj">kubectl taint nodes server1 <a class="ae it" href="http://node-role.kubernetes.io/master=true:NoSchedule" rel="noopener ugc nofollow" target="_blank">node-role.kubernetes.io/master=true:NoSchedule</a></span></pre><p id="79c7" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">此时，您应该已经安装了K3s服务器。让我们继续安装K3s代理程序。</p><h1 id="326b" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">配置K3s代理</h1><p id="4c92" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">我们有两个K3s代理需要设置:agent1.k3s.k3s.oraclevcn.com和agent2.k3s.k3s.oraclevcn.com。虽然我只列出了一次指令，但是您需要在两个代理实例上执行相同的步骤！</p><h1 id="35cb" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">配置K3s代理—禁用防火墙</h1><p id="c8f6" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated"><strong class="iw hi">注意:</strong>对于长期安装来说，这不是最佳实践或推荐的方法(当然不适合生产环境！).这是基于<a class="ae it" href="https://rancher.com/docs/k3s/latest/en/advanced/#additional-preparation-for-red-hat-centos-enterprise-linux" rel="noopener ugc nofollow" target="_blank">牧场主K3s文档</a>中给出的建议。</p><p id="4dbc" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">运行以下命令禁用基于主机的防火墙(<em class="kv"> firewalld </em>):</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="af24" class="lf jt hh lb b fi lg lh l li lj">sudo systemctl stop firewalld<br/>sudo systemctl disable firewalld</span></pre><h1 id="cbc5" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">配置K3s代理—创建K3s配置目录和文件</h1><p id="1298" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">从K3s服务器获取令牌，代理需要该令牌来注册K3s服务器并与之通信。从K3s服务器的SSH会话中，运行:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="7189" class="lf jt hh lb b fi lg lh l li lj">sudo cat /var/lib/rancher/k3s/server/node-token</span></pre><p id="5e29" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这将把K3s令牌输出到屏幕上。把它复制到你的剪贴板上，因为很快就会用到它。</p><p id="898b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">K3s代理也使用YAML文件来配置K3s。我们现在就来建造它们。</p><p id="2f2a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">创建<em class="kv"> /etc/rancher/k3s </em>目录:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="498e" class="lf jt hh lb b fi lg lh l li lj">sudo mkdir -p /etc/rancher/k3s</span></pre><p id="7843" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">下面将创建一个kubelet配置文件，这是必需的:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="f620" class="lf jt hh lb b fi lg lh l li lj">sudo su -c 'OCID=$(curl -s -H "Authorization: Bearer Oracle" -L <a class="ae it" href="http://169.254.169.254/opc/v2/instance/" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/opc/v2/instance/</a> | jq .id | tr -d "\"")<br/>printf "apiVersion: kubelet.config.k8s.io/v1beta1<br/>kind: KubeletConfiguration<br/>providerID: $(echo $OCID)" &gt; /etc/rancher/k3s/$(hostname)-kubelet.yaml'</span></pre><p id="a459" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">上面的命令查询OCI实例可用的OCI实例元数据，获取存储在配置文件中的实例OCID。参见<a class="ae it" href="https://docs.oracle.com/en-us/iaas/Content/Compute/Tasks/gettingmetadata.htm" rel="noopener ugc nofollow" target="_blank"> OCI文档</a>获取更多关于OCI实例元数据的信息。</p><p id="2348" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">创建附加配置文件:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="b001" class="lf jt hh lb b fi lg lh l li lj">sudo su -c 'printf "kubelet-arg=config: \"/etc/rancher/k3s/$(hostname)-kubelet.yaml\"<br/>kubelet-arg=cloud-provider: \"external\"<br/>kube-proxy-arg=healthz-bind-address: "0.0.0.0:10256"<br/>node-label:<br/>- \"<a class="ae it" href="http://k3s.io/role=agent/" rel="noopener ugc nofollow" target="_blank">k3s.io/role=agent\</a>"<br/>server: \"<a class="ae it" href="https://server1.k3s.k3s.oraclevcn.com:6443/" rel="noopener ugc nofollow" target="_blank">https://server1.k3s.k3s.oraclevcn.com:6443\</a>"<br/>selinux: true<br/>" &gt; /etc/rancher/k3s/config.yaml'</span></pre><h1 id="b391" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">配置K3s代理程序—安装K3s代理程序</h1><p id="ba6a" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">运行以下命令安装K3s代理:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="d6ed" class="lf jt hh lb b fi lg lh l li lj">curl -sfL <a class="ae it" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | K3S_URL=<a class="ae it" href="https://server1.k3s.k3s.oraclevcn.com:6443" rel="noopener ugc nofollow" target="_blank">https://server1.k3s.k3s.oraclevcn.com:6443</a> K3S_TOKEN=&lt;YOUR_K3S_TOKEN_HERE&gt; INSTALL_K3S_VERSION=$(curl -s "<a class="ae it" href="https://api.github.com/repos/k3s-io/k3s/tags" rel="noopener ugc nofollow" target="_blank">https://api.github.com/repos/k3s-io/k3s/tags</a>" | jq .[0].name | tr -d "\"") sh -</span></pre><p id="ab58" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">确保您给它的K3s令牌是从K3s服务器复制的！</p><h1 id="71f2" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">验证代理节点</h1><p id="c93f" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">在K3s服务器上(SSH进入bastion，然后进入K3s服务器)，运行以下命令:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="4f66" class="lf jt hh lb b fi lg lh l li lj">kubectl get nodes</span></pre><p id="8b3d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您应该会看到如下所示的内容:</p><figure class="kw kx ky kz fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lk"><img src="../Images/b6fd2ff38bfac26ef283859b42af2b76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zFv9rb6IzVLZuqc7Y0odjQ.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Sample output from kubectl get nodes</figcaption></figure><p id="0e2c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果您没有看到两个K3s代理，请查看缺失实例上的代理安装步骤。</p><h1 id="a6b0" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">包装它</h1><p id="03f2" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">我们现在有K3s运行在我们的OCI永远免费帐户！恭喜你。但是我们还没有完成…接下来我们将设置OCI云控制器管理器，它将允许我们的K3s环境管理诸如OCI负载平衡器和块存储卷之类的东西！这非常值得我们花费时间和精力，所以这将是我们本系列的下一篇文章。</p><p id="183d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果你对甲骨文开发人员在他们的自然栖息地发生的事情感到好奇，来<a class="ae it" href="https://bit.ly/odevrel_slack" rel="noopener ugc nofollow" target="_blank">加入我们的公共休闲频道</a>！</p></div></div>    
</body>
</html>