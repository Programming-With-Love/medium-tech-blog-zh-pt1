<html>
<head>
<title>Sending email through SQL Server using Sendgrid</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Sendgrid通过SQL Server发送电子邮件</h1>
<blockquote>原文：<a href="https://medium.com/globant/how-to-send-email-through-sql-server-using-sendgrid-8851bfa02578?source=collection_archive---------1-----------------------#2022-06-22">https://medium.com/globant/how-to-send-email-through-sql-server-using-sendgrid-8851bfa02578?source=collection_archive---------1-----------------------#2022-06-22</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="5503" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">一种无需SMTP服务器的Azure cloud邮件发送方式</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/a4ebab1933ff480e2394de3d0b5b594d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PhoyX634Ae2mIO4_"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Photo by <a class="ae jm" href="https://unsplash.com/@brett_jordan?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Brett Jordan</a> on <a class="ae jm" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="eae9" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">在本文中，我将向您展示如何在SendGrid帐户和SQL定义的存储过程的帮助下，从您的<a class="ae jm" href="https://docs.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview" rel="noopener ugc nofollow" target="_blank"> Azure SQL托管实例</a>发送电子邮件。</p><p id="e66f" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">为了从本地服务器的自动流程发送电子邮件，我们需要一个<a class="ae jm" href="https://www.techtarget.com/whatis/definition/SMTP-Simple-Mail-Transfer-Protocol#:~:text=SMTP%20(Simple%20Mail%20Transfer%20Protocol)%20is%20a%20TCP%2FIP,sending%20and%20receiving%20e%2Dmail." rel="noopener ugc nofollow" target="_blank"> SMTP </a>服务器。在azure中，我们根本不需要SMTP服务器，SMTP服务器已经被<a class="ae jm" href="https://sendgrid.com/" rel="noopener ugc nofollow" target="_blank"> SendGrid </a>所取代，SendGrid 将用于来自web应用程序或SQL server的各种电子邮件发送活动。</p><p id="f8e7" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">Azure SQL Managed Instance是智能的、可扩展的云数据库服务，它结合了最广泛的SQL Server数据库引擎兼容性和全面管理的常青平台即服务的所有优势。SQL托管实例允许现有的SQL Server客户将其内部应用程序或数据库提升并转移到azure，只需对应用程序和数据库进行最少的更改。</p><p id="2df3" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">在我继续之前，我假设您对Azure SQL托管实例有中级理解。</p><h1 id="46e6" class="kj kk hh bd kl km kn ko kp kq kr ks kt in ku io kv iq kw ir kx it ky iu kz la bi translated"><strong class="ak">问题陈述</strong></h1><p id="44eb" class="pw-post-body-paragraph jn jo hh jp b jq lb ii js jt lc il jv jw ld jy jz ka le kc kd ke lf kg kh ki ha bi translated">我们有一个SQL托管实例，它通过部署在Azure SQL托管实例上的ETL工具<a class="ae jm" href="https://docs.microsoft.com/en-us/sql/integration-services/integration-services-ssis-packages?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">SSIS</a>(SQL Server Integration Services)包从各种数据源消费数据。在完成所有SSIS包之后，如果当天没有加载任何表，就会运行SQL代码并向客户机发送警报。为了发送电子邮件和通知客户端，我们没有SMTP服务器，因此我们需要一个SendGrid帐户，可以在Azure SQL托管实例中使用。</p><p id="195a" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">要继续从Azure SQL托管实例发送电子邮件的端到端实现，我们需要遵循以下步骤:</p><p id="8f6c" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">1.获取SendGrid API密钥</p><p id="53f9" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">2.创建数据库邮件帐户</p><p id="eee3" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">3.创建数据库邮件配置文件</p><p id="fc67" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">4.选择公共配置文件</p><p id="c859" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">5.发送测试电子邮件</p><h2 id="a850" class="lg kk hh bd kl lh li lj kp lk ll lm kt jw ln lo kv ka lp lq kx ke lr ls kz lt bi translated">第一步。获取SendGrid API密钥</h2><p id="7c4d" class="pw-post-body-paragraph jn jo hh jp b jq lb ii js jt lc il jv jw ld jy jz ka le kc kd ke lf kg kh ki ha bi translated">我们需要首先生成API密钥。要生成，请遵循以下步骤:</p><p id="be6d" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">前往'<strong class="jp hi">https://app.sendgrid.com/login</strong>'并使用您的凭证登录。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lu"><img src="../Images/50939222da56261feb6ced30922a6ebf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I6cEDcSmMbKk_XEAWFfEPA.png"/></div></div></figure><p id="9e11" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">展开<strong class="jp hi">设置</strong>并点击<strong class="jp hi"> API键。</strong></p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lv"><img src="../Images/28f8f3ca3a176655445ce79e77199bd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qf4qSiwNWu33q_t2FOlaNw.png"/></div></div></figure><p id="76f9" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">点击右上角的<strong class="jp hi">创建API密钥</strong>按钮，并按照步骤操作。</p><p id="ec4a" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">现在您将拥有一个API密钥。把它保存在记事本或安全的地方。</p><h2 id="41ad" class="lg kk hh bd kl lh li lj kp lk ll lm kt jw ln lo kv ka lp lq kx ke lr ls kz lt bi translated">第二步。创建数据库邮件帐户</h2><p id="9743" class="pw-post-body-paragraph jn jo hh jp b jq lb ii js jt lc il jv jw ld jy jz ka le kc kd ke lf kg kh ki ha bi translated">使用您的凭证连接到您的<strong class="jp hi"> Azure </strong> <strong class="jp hi"> SQL托管实例</strong>到<a class="ae jm" href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver16" rel="noopener ugc nofollow" target="_blank">SSMS</a>(SQL Server Management Studio)，一旦您打开SSMS，您将会看到这样的屏幕。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lw"><img src="../Images/dd761ad79d39442284041141e0bbdd96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jpoKD9yq2hOVyYLt"/></div></div></figure><p id="af5f" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">您必须运行一些<code class="du lx ly lz ma b">t-sql</code>代码来在您的托管实例上启用数据库邮件。这批代码将实现启用数据库邮件:</p><pre class="ix iy iz ja fd mb ma mc md aw me bi"><span id="cbfb" class="lg kk hh ma b fi mf mg l mh mi">use MSDB<br/>EXEC sp_configure 'show advanced options', 1<br/>RECONFIGURE<br/>EXEC sp_configure 'Database Mail XPs', 1<br/>RECONFIGURE</span></pre><p id="dcab" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">现在，您应该创建数据库邮件帐户。这行代码将实现它:</p><pre class="ix iy iz ja fd mb ma mc md aw me bi"><span id="bab5" class="lg kk hh ma b fi mf mg l mh mi">-- In below line, You can give any meaningful name at place of 'DBA SendGrid Account'<br/>IF NOT EXISTS (SELECT 1 FROM msdb.dbo.sysmail_account WHERE [name] = 'DBA SendGrid<br/>Account')<br/>BEGIN<br/>DECLARE <a class="ae jm" href="http://twitter.com/servername" rel="noopener ugc nofollow" target="_blank">@servername</a> NVARCHAR(255) = @@servername<br/>SET <a class="ae jm" href="http://twitter.com/servername" rel="noopener ugc nofollow" target="_blank">@servername</a> = substring(<a class="ae jm" href="http://twitter.com/servername" rel="noopener ugc nofollow" target="_blank">@servername</a>, 1, charindex('.', <a class="ae jm" href="http://twitter.com/servername" rel="noopener ugc nofollow" target="_blank">@servername</a>)-1)<br/>EXECUTE msdb.dbo.sysmail_update_account_sp<br/><a class="ae jm" href="http://twitter.com/account_name" rel="noopener ugc nofollow" target="_blank">@account_name</a> = 'DBA SendGrid Account',<br/><a class="ae jm" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a> = 'DB account for DBAs and SQL Agent',<br/>-- Here in below line, you need to provide email address who want to receive mail:<br/><a class="ae jm" href="http://twitter.com/email_address" rel="noopener ugc nofollow" target="_blank">@email_address</a> = '<a class="ae jm" href="mailto:Email@domain.com" rel="noopener ugc nofollow" target="_blank">Email@domain.com</a>',<br/><a class="ae jm" href="http://twitter.com/display_name" rel="noopener ugc nofollow" target="_blank">@display_name</a> = <a class="ae jm" href="http://twitter.com/servername" rel="noopener ugc nofollow" target="_blank">@servername</a>,<br/><a class="ae jm" href="http://twitter.com/mailserver_name" rel="noopener ugc nofollow" target="_blank">@mailserver_name</a> = 'smtp.sendgrid.net',<br/><a class="ae jm" href="http://twitter.com/mailserver_type" rel="noopener ugc nofollow" target="_blank">@mailserver_type</a> = 'SMTP',<br/><a class="ae jm" href="http://twitter.com/username" rel="noopener ugc nofollow" target="_blank">@username</a> = 'apikey',<br/>-- In below line, under single quotes, you need to provide API Keys which you have generated in step 1 of this article<br/><a class="ae jm" href="http://twitter.com/password" rel="noopener ugc nofollow" target="_blank">@password</a> = 'SG.*********************************',<br/><a class="ae jm" href="http://twitter.com/port" rel="noopener ugc nofollow" target="_blank">@port</a> = 587,<br/><a class="ae jm" href="http://twitter.com/enable_ssl" rel="noopener ugc nofollow" target="_blank">@enable_ssl</a> = 1;<br/>END<br/>ELSE<br/>PRINT 'sysmail_account already configured'</span></pre><h2 id="8dc4" class="lg kk hh bd kl lh li lj kp lk ll lm kt jw ln lo kv ka lp lq kx ke lr ls kz lt bi translated">第三步。创建数据库邮件配置文件</h2><p id="89da" class="pw-post-body-paragraph jn jo hh jp b jq lb ii js jt lc il jv jw ld jy jz ka le kc kd ke lf kg kh ki ha bi translated">如果您想使用SQL代理作业发送电子邮件，应该有一个数据库邮件配置文件配置文件，必须称为'<strong class="jp hi">AzureManagedInstance _ dbmail _ profile</strong>'，您可以在这里找到更多详细信息<a class="ae jm" href="https://docs.microsoft.com/en-us/sql/relational-databases/database-mail/configure-database-mail?view=sql-server-ver15#ProfileSecurityPublic" rel="noopener ugc nofollow" target="_blank"/>。执行这个脚本，它将为您创建一个数据库邮件配置文件。</p><pre class="ix iy iz ja fd mb ma mc md aw me bi"><span id="6b59" class="lg kk hh ma b fi mf mg l mh mi">-- Create a database mail profile (Profile must be called AzureManagedInstance_dbmail_profile)<br/>IF NOT EXISTS (SELECT * FROM msdb..sysmail_profile WHERE name =<br/>'AzureManagedInstance_dbmail_profile')<br/>BEGIN<br/>EXECUTE msdb.dbo.sysmail_add_profile_sp<br/><a class="ae jm" href="http://twitter.com/profile_name" rel="noopener ugc nofollow" target="_blank">@profile_name</a> = 'AzureManagedInstance_dbmail_profile',<br/><a class="ae jm" href="http://twitter.com/description" rel="noopener ugc nofollow" target="_blank">@description</a> = 'Main profile for sending database mail';<br/>-- Associate account with profile<br/>EXECUTE msdb.dbo.sysmail_add_profileaccount_sp<br/><a class="ae jm" href="http://twitter.com/profile_name" rel="noopener ugc nofollow" target="_blank">@profile_name</a> = 'AzureManagedInstance_dbmail_profile',<br/>-- Give the same name which you created above in Point 2 of Step 1<br/><a class="ae jm" href="http://twitter.com/account_name" rel="noopener ugc nofollow" target="_blank">@account_name</a> = 'DBA SendGrid Account',<br/>-- This is the sequence number of the account within the profile.<br/><a class="ae jm" href="http://twitter.com/sequence_number" rel="noopener ugc nofollow" target="_blank">@sequence_number</a> = 1 ;<br/>END<br/>ELSE<br/>PRINT 'DBMail profile already configured'</span></pre><h2 id="41df" class="lg kk hh bd kl lh li lj kp lk ll lm kt jw ln lo kv ka lp lq kx ke lr ls kz lt bi translated">第四步。选择公共配置文件</h2><p id="46b2" class="pw-post-body-paragraph jn jo hh jp b jq lb ii js jt lc il jv jw ld jy jz ka le kc kd ke lf kg kh ki ha bi translated">由于我们已经在上面的步骤3中创建了一个配置文件，我们需要选择这个配置文件，以便它可以用于电子邮件发送活动。要了解更多关于个人资料的信息，您可以参考链接<a class="ae jm" href="https://www.mssqltips.com/sqlservertip/6015/enable-sql-server-agent-mail-profile/" rel="noopener ugc nofollow" target="_blank">邮件个人资料</a>。</p><p id="5479" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">简档可以是默认简档。在这种情况下，用户或角色可以使用配置文件发送电子邮件，而无需显式指定配置文件。如果发送电子邮件的用户或角色具有默认的专用配置文件，数据库邮件将使用该配置文件。如果用户或角色没有默认的私有配置文件，<code class="du lx ly lz ma b">sp_send_dbmail</code>将为<code class="du lx ly lz ma b">msdb</code>数据库使用默认的公共配置文件。如果没有用户或角色的默认私有配置文件，也没有数据库的默认公共配置文件，<code class="du lx ly lz ma b">sp_send_dbmail</code>将返回一个错误。只能将一个配置文件标记为默认配置文件。请按照以下步骤选择配置文件:</p><p id="d6ae" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">从SSMS连接到Azure SQL托管实例。</p><p id="b077" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">进入'<strong class="jp hi">管理&gt;数据库邮件</strong>'。</p><p id="845b" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">右键点击<strong class="jp hi">数据库邮件</strong>和<strong class="jp hi">T21点击<strong class="jp hi">配置数据库邮件。</strong></strong></p><p id="c917" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">点击<strong class="jp hi">下一步。</strong></p><p id="5cf8" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">选择<strong class="jp hi">管理配置文件安全性</strong>并点击<strong class="jp hi">下一步。</strong></p><p id="9b52" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">选择您在上面第3步的第1点中创建的配置文件名的复选框。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mj"><img src="../Images/dca660035d6a202d91f16ce3dddfc7ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SwGg0ljUBC5CGQQb"/></div></div></figure><p id="9820" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">点击<strong class="jp hi">下一个</strong></p><p id="cc93" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">点击<strong class="jp hi">完成</strong></p><h2 id="03b3" class="lg kk hh bd kl lh li lj kp lk ll lm kt jw ln lo kv ka lp lq kx ke lr ls kz lt bi translated">第五步。发送测试电子邮件</h2><p id="af68" class="pw-post-body-paragraph jn jo hh jp b jq lb ii js jt lc il jv jw ld jy jz ka le kc kd ke lf kg kh ki ha bi translated">现在我们完成了所有的配置部分。要测试电子邮件是否正在发送，只需使用如下所示的参数运行存储过程:</p><pre class="ix iy iz ja fd mb ma mc md aw me bi"><span id="bb65" class="lg kk hh ma b fi mf mg l mh mi">-- Send a test email using stored procedure sp_send_dbmail<br/>EXEC msdb.dbo.sp_send_dbmail<br/><a class="ae jm" href="http://twitter.com/profile_name" rel="noopener ugc nofollow" target="_blank">@profile_name</a> = 'AzureManagedInstance_dbmail_profile',<br/>-- Give recipient email address<br/><a class="ae jm" href="http://twitter.com/recipients" rel="noopener ugc nofollow" target="_blank">@recipients</a> = '<a class="ae jm" href="mailto:email@domain.com" rel="noopener ugc nofollow" target="_blank">email@domain.com</a>',<br/><a class="ae jm" href="http://twitter.com/body" rel="noopener ugc nofollow" target="_blank">@body</a> = 'Email successfully sent from managed instance.',<br/><a class="ae jm" href="http://twitter.com/subject" rel="noopener ugc nofollow" target="_blank">@subject</a> = 'OK, this works now. Thats great!';</span></pre><p id="8bed" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">如果你收到了下面截图中提到的电子邮件，意味着你已经成功地设置好了一切，现在你已经完成了。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mk"><img src="../Images/7894b0e253413cf08943174755309480.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YyirHDc8Hp9dza9B"/></div></div></figure><h1 id="08fa" class="kj kk hh bd kl km kn ko kp kq kr ks kt in ku io kv iq kw ir kx it ky iu kz la bi translated"><strong class="ak">结论</strong></h1><p id="51b7" class="pw-post-body-paragraph jn jo hh jp b jq lb ii js jt lc il jv jw ld jy jz ka le kc kd ke lf kg kh ki ha bi translated">通过上述方法，我们已经了解了如何设置一个<a class="ae jm" href="https://docs.microsoft.com/en-us/sql/relational-databases/database-mail/create-a-database-mail-account?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">数据库邮件帐户</a>和<a class="ae jm" href="https://docs.microsoft.com/en-us/sql/relational-databases/database-mail/create-a-database-mail-profile?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">数据库邮件配置文件</a>来使用Azure SQL托管实例发送电子邮件。</p><p id="543b" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">有关Azure SQL托管实例的更多详细信息，请访问此<a class="ae jm" href="https://docs.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview?view=azuresql" rel="noopener ugc nofollow" target="_blank">链接</a>。</p></div></div>    
</body>
</html>