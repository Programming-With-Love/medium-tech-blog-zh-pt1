<html>
<head>
<title>Android 11 storage FAQ</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android 11存储常见问题</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/android-11-storage-faq-78cefea52b7c?source=collection_archive---------0-----------------------#2020-07-01">https://medium.com/androiddevelopers/android-11-storage-faq-78cefea52b7c?source=collection_archive---------0-----------------------#2020-07-01</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/de14acf6439dcd8e0639d02dd4c04976.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mzx-wzsHjrpKtCJjG0sXwA.jpeg"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx"><em class="hu">Illustration by </em><a class="ae hv" href="https://dribbble.com/Molly_Hensley" rel="noopener ugc nofollow" target="_blank"><em class="hu">Molly Hensley</em></a></figcaption></figure><div class=""/><p id="8270" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">在Android 10中首次引入的<a class="ae hv" href="https://developer.android.com/training/data-storage#scoped-storage" rel="noopener ugc nofollow" target="_blank">范围存储</a>旨在保护应用程序和用户数据，并减少文件混乱。从那以后，您提供了许多有价值的反馈，帮助我们改进了该功能，谢谢您。基于您的反馈，Android 11包括几个显著的增强功能。例如，我们已经启用了对媒体文件的<a class="ae hv" href="https://developer.android.com/preview/privacy/storage#media-direct-file-native" rel="noopener ugc nofollow" target="_blank">直接文件路径访问</a>，以提高现有代码和库的兼容性。我们知道，许多应用程序，尤其是像<a class="ae hv" href="https://android-developers.googleblog.com/2020/07/bringing-modern-storage-to-vibers-users.html" rel="noopener ugc nofollow" target="_blank"> Viber </a>这样的复杂应用程序，需要经过深思熟虑的规划来采用范围存储，以便继续支持现有用户，确保遵守当前的存储<a class="ae hv" href="https://developer.android.com/training/data-storage/use-cases" rel="noopener ugc nofollow" target="_blank">最佳实践</a>，并保持向后兼容性。根据与开发人员的对话和公共论坛上的热烈讨论，我们准备了一个常见问题，以帮助您更好地了解作用域存储中的各种功能、行为变化和限制。</p><h1 id="9b2d" class="jt ju hy bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">常见问题解答</h1><h2 id="7fab" class="kr ju hy bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">作用域存储是否允许应用程序使用文件路径访问文件，例如使用文件API？</h2><ul class=""><li id="8c85" class="lf lg hy ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">我们认识到一些应用依赖于直接访问媒体文件路径的代码或库。因此，在Android 11上，具有读取外部存储权限的应用程序能够访问作用域存储环境中具有文件路径的文件。在Android 10设备上，这对于作用域存储环境中的应用程序不可用，除非它们通过设置Android:requestlegacyexternalstarge清单属性<a class="ae hv" href="https://developer.android.com/training/data-storage/use-cases#opt-out-scoped-storage" rel="noopener ugc nofollow" target="_blank">退出</a>。为了确保跨Android版本的连续性，如果你的应用程序针对Android 10或更高版本，你也应该选择退出。有关详细信息，请参见<a class="ae hv" href="https://developer.android.com/training/data-storage/use-cases#access-file-paths" rel="noopener ugc nofollow" target="_blank">范围存储最佳实践</a>。</li></ul><h2 id="e351" class="kr ju hy bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">与媒体存储API相比，文件路径访问的性能如何？</h2><ul class=""><li id="891b" class="lf lg hy ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">性能实际上取决于具体的用例。对于视频播放等顺序读取，文件路径访问可提供与媒体存储相当的性能。但是，对于随机读取和写入，使用文件路径可能会慢两倍。为了获得最快和最一致的读写速度，我们建议使用媒体商店API。</li></ul><h2 id="53ce" class="kr ju hy bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">我的应用程序需要广泛访问共享存储。存储访问框架是唯一可用的选项吗？</h2><ul class=""><li id="2173" class="lf lg hy ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">存储访问框架(SAF)确实是允许用户授予对目录和文件的访问权限的一个选项。但是，请注意，对于某些目录，比如根目录和Android/data目录，存在着<a class="ae hv" href="https://developer.android.com/preview/privacy/storage#file-directory-restrictions" rel="noopener ugc nofollow" target="_blank">访问限制</a>。虽然大多数需要存储访问的应用程序可以使用SAF或Media Store API等最佳实践，但可能会出现应用程序需要广泛访问共享存储或无法利用这些最佳实践高效访问的情况。对于这些情况，我们添加了<a class="ae hv" href="https://developer.android.com/preview/privacy/storage#all-files-access" rel="noopener ugc nofollow" target="_blank"> MANAGE_EXTERNAL_STORAGE </a>权限，以允许访问外部存储上的所有文件，除了Android/data和Android/obb目录。要了解有关Google Play指南的更多信息，请阅读政策帮助中心的<a class="ae hv" href="https://support.google.com/googleplay/android-developer/answer/9956427" rel="noopener ugc nofollow" target="_blank">更新政策</a>。</li></ul><h2 id="21d0" class="kr ju hy bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">哪些类别的应用应该请求<a class="ae hv" href="https://developer.android.com/preview/privacy/storage#all-files-access" rel="noopener ugc nofollow" target="_blank"> MANAGE_EXTERNAL_STORAGE权限</a>？</h2><ul class=""><li id="4dfa" class="lf lg hy ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">MANAGE_EXTERNAL_STORAGE权限适用于具有核心使用情形的应用程序，这些应用程序需要对设备上的文件进行广泛的访问，但无法使用限定范围的存储最佳实践有效地做到这一点。虽然不可能列举所有可能的使用案例，但一些使用案例包括文件管理器、备份和恢复、防病毒应用程序或生产力文件编辑应用程序。</li></ul><h2 id="1a99" class="kr ju hy bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">使用存储访问框架需要Google Play政策批准吗？</h2><ul class=""><li id="776e" class="lf lg hy ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">存储访问框架从Android 4.4开始就在平台中了。通过存储访问框架访问文件可为用户提供更好的控制，因为用户参与挑选文件，不需要任何用户权限。Google Play没有与其使用相关的政策。</li></ul><h2 id="a018" class="kr ju hy bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">与Android 10相比，在Android 11中使用存储访问框架有什么进一步的限制吗？</h2><ul class=""><li id="75ce" class="lf lg hy ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">针对Android 11 (API level 30)并使用存储访问框架的应用将不再能够授予对目录的访问权限，例如SD卡的根目录和下载目录。不考虑目标SDK，Android 11上的存储访问框架不能用于获得对Android/data和Android/obb目录的访问。<a class="ae hv" href="https://developer.android.com/preview/privacy/storage#file-directory-restrictions" rel="noopener ugc nofollow" target="_blank">了解更多关于这些限制和测试行为方式的</a>。</li></ul><h2 id="0cbc" class="kr ju hy bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">应用程序如何测试范围内的存储更改？</h2><ul class=""><li id="6e2d" class="lf lg hy ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">应用程序可以通过<a class="ae hv" href="https://developer.android.com/preview/privacy/storage#test-scoped-storage" rel="noopener ugc nofollow" target="_blank">这些兼容性标志</a>测试与直接文件路径访问或媒体商店API相关的范围存储行为。还有<a class="ae hv" href="https://developer.android.com/preview/privacy/storage#test-file-directory-access" rel="noopener ugc nofollow" target="_blank">另一个兼容性标志</a>来测试使用存储访问框架访问某些路径的限制。</li></ul><h2 id="7bdb" class="kr ju hy bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">作用域存储中的应用程序是否仅限于将文件写入其特定于应用程序的数据目录？</h2><ul class=""><li id="0714" class="lf lg hy ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">在作用域存储中，应用程序可以<a class="ae hv" href="https://developer.android.com/training/data-storage/shared/media#add-item" rel="noopener ugc nofollow" target="_blank">向媒体商店收藏贡献媒体文件</a>。Media Store会根据文件类型将文件放入组织有序的文件夹中，如DCIM、电影、下载等。对于所有这样的文件，应用程序也可以通过文件API继续访问。操作系统维护一个系统，将应用程序归属于每个媒体商店文件，因此应用程序可以读取/写入它们最初贡献给媒体商店的文件，而无需存储权限。</li></ul><h2 id="4d6d" class="kr ju hy bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">使用媒体存储区<a class="ae hv" href="https://developer.android.com/reference/android/provider/MediaStore.MediaColumns#DATA" rel="noopener ugc nofollow" target="_blank">数据列</a>有什么指导，因为它已经被否决了？</h2><ul class=""><li id="023f" class="lf lg hy ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">在Android 10上，作用域存储环境中的应用无法使用文件路径访问文件。为了与这种设计保持一致，我们当时弃用了数据列。根据您对使用现有本机代码或库的需求的反馈，Android 11现在支持范围存储中应用程序的文件路径访问。因此，数据列实际上对某些场景很有用。对于媒体存储中的插入和更新，作用域存储中的应用应使用DISPLAY_NAME和RELATIVE_PATH列。他们不能再为此使用数据列。当读取磁盘上存在的文件的媒体存储条目时，数据列将具有有效的文件路径，该路径可用于文件API或NDK文件库。然而，应用程序应该准备好处理来自这些操作的任何文件I/O错误，并且不应该假设文件总是可用的。</li></ul><h2 id="b4e0" class="kr ju hy bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">对于选择脱离作用域存储的应用程序，它们何时必须与作用域存储兼容？</h2><ul class=""><li id="388e" class="lf lg hy ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">在运行Android 11或更高版本的设备上，应用程序一旦面向Android 11或更高版本，就会被放入范围存储中。</li></ul><h2 id="6323" class="kr ju hy bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">迁移我们当前存储在范围存储之外的数据的建议方法是什么？</h2><ul class=""><li id="b08c" class="lf lg hy ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">preserveLegacyExternalStorage标志允许应用程序在升级时保留传统存储访问权限，即使是针对Android 11。但是请注意，在Android 11的新安装上，这个标志没有任何作用。在瞄准Android 11之前，请进行代码更改以适应作用域存储。<a class="ae hv" href="https://developer.android.com/training/data-storage/use-cases#maintain_access_to_the_legacy_storage_location_for_data_migration" rel="noopener ugc nofollow" target="_blank">了解有关数据迁移最佳实践的更多信息</a>。</li></ul><h2 id="6aea" class="kr ju hy bd jv ks kt ku jz kv kw kx kd jg ky kz kh jk la lb kl jo lc ld kp le bi translated">考虑到一些软件包安装程序，如应用商店，需要访问它，Android/obb目录有什么例外吗？</h2><ul class=""><li id="4047" class="lf lg hy ix b iy lh jc li jg lj jk lk jo ll js lm ln lo lp bi translated">持有<a class="ae hv" href="https://developer.android.com/reference/android/Manifest.permission#REQUEST_INSTALL_PACKAGES" rel="noopener ugc nofollow" target="_blank"> REQUEST_INSTALL_PACKAGES权限</a>的应用可以访问其他应用的Android/obb目录。</li></ul><p id="1751" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">我们希望此常见问题解答对您规划采用作用域存储有用。请访问我们的<a class="ae hv" href="https://developer.android.com/training/data-storage/use-cases" rel="noopener ugc nofollow" target="_blank">最佳实践文档</a>了解更多信息。</p></div></div>    
</body>
</html>