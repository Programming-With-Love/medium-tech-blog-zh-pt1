<html>
<head>
<title>VBA Stomping — Advanced Maldoc Techniques</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">VBA跺脚——先进的马尔多克技术</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/vba-stomping-advanced-maldoc-techniques-612c484ab278?source=collection_archive---------0-----------------------#2018-10-05">https://medium.com/walmartglobaltech/vba-stomping-advanced-maldoc-techniques-612c484ab278?source=collection_archive---------0-----------------------#2018-10-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="1914" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作者:柯克·塞尔(<a class="ae jc" href="https://twitter.com/bigmacjpg" rel="noopener ugc nofollow" target="_blank"> @bigmacjpg </a>)、哈罗德·奥格登(<a class="ae jc" href="https://twitter.com/haroldogden" rel="noopener ugc nofollow" target="_blank">@哈罗德·奥格登</a>)和卡莉·罗伯特(<a class="ae jc" href="https://twitter.com/OrOneEqualsOne" rel="noopener ugc nofollow" target="_blank">@奥伦内夸尔松</a>)</p><h1 id="e118" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">介绍</h1><p id="7a43" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">有一些强大的恶意文档(maldoc)生成技术可以有效地绕过防病毒检测。我们称之为<em class="kg"> VBA跺脚</em>的技术最初是由Vesselin Bontchev博士引起我们注意的(见<a class="ae jc" href="https://github.com/bontchev/pcodedmp" rel="noopener ugc nofollow" target="_blank">这里</a>)。VBA跺脚指的是销毁微软Office文档中的VBA源代码，只在文档文件中留下编译版的宏代码，即p代码。在这种情况下，仅基于VBA源代码的Maldoc检测会失败。在这篇博文中，我们将展示VBA跺脚的详细例子，并介绍一些额外的技巧。</p><h1 id="66cc" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">VBA跺脚</h1><p id="abf5" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">首先，我们将演示VBA踩踏一个简单的，没有恶意的宏。当文档打开时，该文档只显示一个带有文本“ABC”的消息框。VBA源代码和产生的消息框如下所示。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kh"><img src="../Images/3ec4977b3ef9e237a2bbd055701ad1cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:704/format:webp/1*P_mM0Ffo9kzzhtMM1O7oCg.png"/></div></figure><p id="d441" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们感兴趣的是修改上面显示的VBA源代码，同时保持中间的p代码不变。为了这篇博文的目的，我们将专注于当前。docx/。xlsx/。docm/。xlsm (Office 2007+)格式。然而，这里讨论的技术可以很容易地应用于老年人。doc/。xls格式。在Office 2007+文件中，VBA源代码和p代码通常位于名为vbaProject.bin的文件中。请注意，这是默认文件名，但可以重命名。要手动修改这个文件，我们需要首先解压缩压缩的。docm/。xlsm文件，然后在十六进制编辑器中打开vbaProject.bin文件。在本例中，我们将把“ABC”改为“XYZ”，但只是在VBA源代码存储位置，而不是在p-code部分。VBA源代码以压缩形式存储，这解释了您在下图中看到的不可打印或奇怪的字符。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es kp"><img src="../Images/ebe5f48c794cae1c2632cb369eb2a58a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*KGc1XphbyNT5Dws5W8lOPQ.png"/></div></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es ku"><img src="../Images/10b9e145f76f6fdef2543ed2c51c036d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*iHWUB-LOeGuw_8K02Gixpg.png"/></div></figure><p id="0fc1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，我们已经手动编辑了VBA源代码，将“ABC”更改为“XYZ”，我们将在单击 按钮之前，打开文档并检查VBA源代码<strong class="ig hi"> <em class="kg">。</em></strong></p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kv"><img src="../Images/96be46b48beaa33c708dc05ebf3217e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*jqYto7TMBR3MUZPqzdhogw.png"/></div></figure><p id="92dc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">文档已打开，但未启用宏。在代码编辑器中检查宏时，会显示一个带有文本“XYZ”的消息框，但事实并非如此。事实上，只要内容被启用，就会显示一个显示“ABC”的消息框，并且代码编辑器中的源代码会被更新以与之匹配！</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kv"><img src="../Images/7543712ee17b59113976ae1aa9121419.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*VE19x2i45U7r6FXDxov1UA.png"/></div></figure><p id="b8d7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">嗯，那肯定是误导。源代码说“XYZ”将显示在消息框中，但却显示了“ABC”。这是怎么回事？</p><p id="256b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正如Bontchev博士解释的那样，存储在文档中的p代码就是实际执行的代码，只要它与系统上当前的VBA版本兼容。此外，宏编辑器中显示的(一旦启用内容)不是解压缩的VBA源代码，而是反编译的p代码。有意思！</p><p id="609a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果我们在不同版本的Word(使用不同的VBA版本)中打开文档，p代码将无法重用。这将强制VBA源代码被解压缩并重新编译成p代码，导致在消息框中显示“XYZ”。所以现在我们有一个文档，它在一个版本的Office上显示“ABC”，但在另一个版本上显示“XYZ”。</p><p id="a386" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，这是一个重要的警告。VBA盖章的maldoc只能使用与创建该文档相同的VBA版本来执行。可以通过在maldoc生成之前对目标进行侦察以确定要使用的适当Office版本，或者通过生成具有多个Office版本的maldoc并将它们喷向目标来解决此限制。</p><p id="9913" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从防守的角度来看，VBA跺脚有什么影响？Maldoc检测通常仅基于VBA源。甚至许多可用于分析文档的工具也不能识别VBA源代码和p代码之间的差异。Philippe Lagadec通过<a class="ae jc" href="https://github.com/decalage2/oletools/wiki/olevba" rel="noopener ugc nofollow" target="_blank"> olevba脚本</a>对被篡改的文档进行的分析仅显示了解压缩的源代码，缺少p代码细节。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kw"><img src="../Images/45716c776a96f29a684342fe747da104.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*TIq1-TyPn5gxopcr88-U9A.png"/></div></figure><p id="5d23" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由Didier Stevens编写的Python脚本<a class="ae jc" href="https://blog.didierstevens.com/programs/oledump-py/" rel="noopener ugc nofollow" target="_blank"> oledump.py </a>给出了类似的结果，除非使用p-code dumper插件运行。这种情况下的输出表明p代码将导致消息框显示“ABC ”,如下图所示。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kx"><img src="../Images/5d10193d28942579404cf7ad70527338.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*ZmBHbwFxuqbZB9JZzN4yrw.png"/></div></figure><p id="d998" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Bontchev博士发布了一个名为<a class="ae jc" href="https://github.com/bontchev/pcodedmp" rel="noopener ugc nofollow" target="_blank"> pcodedmp.py </a>的Python脚本，用于显示p代码，如下图所示。输出的额外好处是显示操作名，而不是上面的操作码。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es ky"><img src="../Images/2d812948967694f2eed839b567804272.png" data-original-src="https://miro.medium.com/v2/resize:fit:882/format:webp/1*1jU7iSKRyTb93EK5WfIZ3Q.png"/></div></figure><p id="9225" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">除了修改VBA源代码，我们可以通过用零或随机字节覆盖它来彻底清除它(“跺”它)。下面的截图显示了如何在一个十六进制编辑器中手动操作。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kv"><img src="../Images/c2988cbc2a4bb72b8fb39ec6f67982c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*xCsSmTV9k0qFMjUWfQDWuQ.png"/></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kz"><img src="../Images/558aa8bb218d899d6cc5965bba995ee1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1246/format:webp/1*XLiGHjipu6lk7JU8rNxzXw.png"/></div></figure><p id="0089" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这种情况下的结果是VBA编辑器根本不显示宏代码，但在启用内容后，带有文本“ABC”的消息框仍然会出现。现在，我们对该文件重新运行olevba，没有显示vba源代码，而是显示“没有发现可疑关键字或IOC”语句，而不是之前突出显示我们使用了可疑关键字(AutoOpen)的表格。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es ku"><img src="../Images/642ea831764988be2f4b7fa875568d9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*3t0jKe01yE0ydhE2pFXvxA.png"/></div></figure><h1 id="e0f3" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">这是一个多大的问题？</h1><p id="6622" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们现在将更深入地了解Office如何使用压缩的VBA源代码和p代码。这将在我们稍后讨论如何滥用Office功能来轻松修改maldocs以欺骗许多AV扫描器时发挥作用。</p><p id="bc4b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Office文档包含两个可以提取VBA的地方，压缩的VBA源代码和p代码。下表详细说明了在以下情况下使用哪个VBA数据源:</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es la"><img src="../Images/027fa85c8eaf53241e26279208b587eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Eh5SA794dEMFOlkqR8ThDQ.png"/></div></div></figure><p id="0607" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从这个表中我们可以看到，如果我们有有效的p代码，当启用宏时，压缩的VBA源代码将被忽略。所有宏功能都是通过运行p代码来执行的。作为一个攻击者，这告诉我们，我们可以完全破坏或修改压缩的VBA源代码，而仍然让我们的maldoc执行其所需的任务。</p><h1 id="afbf" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">真实世界的例子</h1><p id="e502" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">在一个玩具例子上展示这一点很好，但是这真的是一个合法的威胁吗？让我们通过处理一个已知的恶意文档来更进一步。在这种情况下，我们将从最近的<a class="ae jc" href="https://www.cyber.nj.gov/threat-profiles/trojan-variants/emotet" rel="noopener ugc nofollow" target="_blank"> Emotet </a> maldoc开始，它目前被病毒总数上36/59的供应商检测为恶意。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kv"><img src="../Images/97caaa5ee3b480e1a236c932edb73080.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*vhePAlQl6xO7TLdXXW1mCg.png"/></div></figure><p id="40f1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果我们拿着这份文件，如上所述简单地践踏VBA源代码，检测率会下降到58个反病毒解决方案中的7个！</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kv"><img src="../Images/b9a597601fc8b1e3c45f1d60d01756e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*15XLHrfFRP4PcFoTSX1GCA.png"/></div></figure><p id="a6a5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如你所见，这给网络维护者带来了一个严重的问题。即使手动分析这些文档也会有问题。在这一点上明显的问题是“<em class="kg">VBA跺脚可以通过工具自动执行吗，还是我们总是必须手动编辑Office文档？</em>“这个问题的答案是<strong class="ig hi"> <em class="kg">是的，用工具自动跺VBA</em></strong>当然是有可能的。我们开发了一个POC实用程序，可以自动踩踏任何Office文档中的压缩VBA源代码(这是用来VBA踩踏示例Emotet文档的，不，我们不会发布这个实用程序)。鉴于自动化VBA跺脚是多么容易，这是一个真正的威胁。</p><h1 id="b89d" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">让事情变得更糟</h1><p id="cb34" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">考虑maldoc被设计成在执行恶意有效载荷之后立即关闭MS Word的情况。在与VBA跺脚结合使用时，在启用宏之前，任何脱机VBA源代码提取工具都不会显示VBA源代码，VBA源代码甚至不会显示在Office宏编辑器窗口中。但是启用宏会导致Word立即退出，而不提供查看反编译源代码的机会。虽然我们已经展示了“类似汇编”的p代码是可提取的，但是该p代码很难解释，并且不能在VBA调试器中进行分析。此外，pcode只能在特定的VBA版本上运行。由于这些原因，访问VBA源代码对分析师来说是一个很大的好处。但是对于这样一个文档，如何做到这一点呢？</p><p id="821e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">经过一些试验，我们确定了一个简单的解决方案，一旦启用宏，就停止MS Word执行任何方法。请注意，此解决方案适用于Office 2007+文档，正在进行额外的研究以解决较旧的文档格式。2007+解决方案是从的“word”目录中删除vbaData.xml文件。docm文件，如下所示(使用7-Zip程序很容易做到这一点，无需手动解压缩和重新压缩文档)。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es lb"><img src="../Images/be635481fb56d5e53af5d76b2843ba9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*j953lLi4vkji5nySs3YPeg.png"/></div></figure><p id="bc36" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在可以打开文档并启用内容，导致在VBA代码编辑器中显示反编译的p代码，但不执行代码。在恶意软件作者采取措施阻止分析师访问VBA源代码的情况下，这可能是救命稻草。</p><p id="d19e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">删除vbaData.xml的一个有趣的副作用是，它会导致MS Word在“宏”对话框中错误地没有列出任何宏(见下图)。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kv"><img src="../Images/5f4e45598b9fc7cacff1bbae16754c99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*KIhYa2asfDGRAIWXERhXug.png"/></div></figure><h1 id="7737" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">侦查</h1><p id="de2f" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们在Office文档中编写了一个用于检测VBA跺脚的开源工具，名为“VBA地震仪”。该工具已经在Ubuntu 16.04下进行了测试，可以检测Office文档的编译p代码和VBA源代码中出现的声明的函数/变量名、字符串和注释行之间的差异。该工具可在<a class="ae jc" href="https://github.com/kirk-sayre-work/VBASeismograph" rel="noopener ugc nofollow" target="_blank">https://github.com/kirk-sayre-work/VBASeismograph</a>获得。</p><h1 id="f455" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="87fe" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">在这篇博文中，我们展示了如何修改或破坏Office文档中的压缩VBA源代码，以击败反病毒扫描解决方案，并使maldocs的手动分析更加困难。对这种技术的防御包括检测和标记具有有效p代码但无效或丢失VBA源代码的文档，或者更一般地，检查压缩的VBA源代码和反编译的p代码之间的差异。目前，我们还不知道有任何商业反病毒解决方案进行这种检查，因此这是反病毒扫描解决方案可以改进的潜在领域。</p><p id="bea9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">参见<a class="ae jc" href="http://vbastomp.com" rel="noopener ugc nofollow" target="_blank">vbastomp.com</a>了解VBA跺脚的最新信息。</p></div></div>    
</body>
</html>