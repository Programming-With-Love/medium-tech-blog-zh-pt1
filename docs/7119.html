<html>
<head>
<title>Valet: A Better Place to Put Your Keys</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">贴身男仆:放钥匙的好地方</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/valet-a-better-place-to-put-your-keys-dda59b986f31?source=collection_archive---------4-----------------------#2015-06-04">https://medium.com/square-corner-blog/valet-a-better-place-to-put-your-keys-dda59b986f31?source=collection_archive---------4-----------------------#2015-06-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="6b9f" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">安全地存储您的秘密，无需阅读苹果的SecItem.h</h2></div><p id="f0e1" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="js">作者</em> <a class="jt ju ge" href="https://medium.com/u/5755ab427632?source=post_page-----dda59b986f31--------------------------------" rel="noopener" target="_blank"> <em class="js">丹费德曼</em> </a> <em class="js">和</em> <a class="ae jv" href="http://@TheProfessor22" rel="noopener ugc nofollow" target="_blank"> <em class="js">埃里克穆勒。</em>T11】</a></p><blockquote class="jw"><p id="7d09" class="jx jy hh bd jz ka kb kc kd ke kf jr dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae jv" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><h1 id="6afd" class="kg kh hh bd ki kj kk kl km kn ko kp kq in kr io ks iq kt ir ku it kv iu kw kx bi translated">钥匙链很恐怖</h1><p id="b578" class="pw-post-body-paragraph iw ix hh iy b iz ky ii jb jc kz il je jf la jh ji jj lb jl jm jn lc jp jq jr ha bi translated">如果您曾经不得不仔细研究SecItem.h或与Keychain交互，您会很清楚这是一个可怕的API。你传入一个字典，然后返回一个错误，让你知道至少有一个参数是错误的。想知道是哪个？没有骰子。一旦您最终验证了这些字典参数，仍然没有设置语义。箭筒中仅有的箭头是add和update，但是如果key已经存在于Keychain中，那么添加key/value对将会失败。更糟糕的是，在iOS和Mac上，您应该传递给SecItem*的键/值对之间存在微妙且未记录的差异。</p><p id="93cd" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">痛苦不止于此。Keychain在多线程环境中是一个松散的大炮，因为没有任何东西可以保证Keychain操作的原子性。即使您做的一切都是正确的，您也可能会被SecItemUpdate调用咬到，该调用错误地告诉您它已经成功更新了您传入的元数据——而事实上，它只更新了它应该更新的元素的子集。</p><h1 id="2e0a" class="kg kh hh bd ki kj kk kl km kn ko kp kq in ld io ks iq le ir ku it lf iu kw kx bi translated">…但是你需要它</h1><p id="21b2" class="pw-post-body-paragraph iw ix hh iy b iz ky ii jb jc kz il je jf la jh ji jj lb jl jm jn lc jp jq jr ha bi translated">如果你把你的秘密储存在钥匙串以外的储存机制中，<a class="ae jv" href="https://developer.apple.com/library/ios/documentation/Security/Conceptual/cryptoservices/KeyManagementAPIs/KeyManagementAPIs.html#//apple_ref/doc/uid/TP40011172-CH11-CHDDJIHA" rel="noopener ugc nofollow" target="_blank">你做错了</a>。没有其他安全的地方来存储您的数据。有NSUserDefaults、plists等。但是这些地方储存任何需要安全等级的东西都差得可笑——问问任何使用过iExplorer的人就知道了。如果你认为你很好，因为你已经推出了自己的加密机制，你就违反了加密的基本规则:不要写自己的密码。</p><h1 id="8a85" class="kg kh hh bd ki kj kk kl km kn ko kp kq in ld io ks iq le ir ku it lf iu kw kx bi translated">所以让我们来保管你的钥匙</h1><p id="fcb9" class="pw-post-body-paragraph iw ix hh iy b iz ky ii jb jc kz il je jf la jh ji jj lb jl jm jn lc jp jq jr ha bi translated"><a class="ae jv" href="https://github.com/square/Valet" rel="noopener ugc nofollow" target="_blank"> Valet </a>有一个受NSMapTable启发的API，在引擎盖下使用了Keychain。你习惯的每个Cocoa API都有set/get语义，Valet也是。代客确保原子读取和写入钥匙圈；您永远不会失败，因为您是在多线程上与Valet交互。如果您以前没有接触过Keychain，我们保证您永远也不需要读取SecItem.h，并且您会很快将这些令牌从您的plists迁移到Valet实例中。</p><p id="3dfd" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果你已经花时间学习了钥匙链的来龙去脉，我们很抱歉。但是好的一面是，Valet的API已经在你的词典里了。哦，我们有一个简单的方法可以将您的旧钥匙链项目导入到代客。一旦迁移到Valet，您就再也不需要为errSec*处理编写另一个开关了。只要-canAccessKeychain返回YES，代客呼叫就永远不会失败。</p><p id="0e6e" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">更好的是，你永远不必担心踩坏或删除你不想要的秘密——每个贴身男仆都生活在一个沙盒里。如果两个Valets可以读或写同一个空间，他们将通过isEqual:和==检查。每个代客都基于四个核心属性进行沙盒化:初始化器、标识符、可访问性和类。这个沙盒意味着从一个只有在手机解锁时才可访问的代客迁移到另一个在第一次解锁后可访问的代客保证有效。(您不会被糟糕的SecItemUpdate调用咬到。)当您在您的贴身男仆之间迁移这些项目时，这些项目实际上是从一个贴身男仆复制到另一个贴身男仆，而不是就地更新它们(我们估计这有大约0.5%的无声故障率)。</p><p id="10cf" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最重要的是，代客可以轻松利用钥匙串的全部功能。想要在您编写的多个应用程序之间共享秘密吗？只需将您的共享访问组标识符传递到共享访问组初始化器中。想要通过iCloud将您的秘密同步到其他设备吗？我们有一个贴身男仆。想要将您的秘密存储在Secure Enclave上，要求触控ID或设备的密码来检索每个秘密吗？我们也有贴身男仆。</p><p id="98b3" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">你还在等什么？交出钥匙，继续做你真正想做的工作。</p><p id="5183" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="js">本帖是Square的“</em> <a class="ae jv" href="https://corner.squareup.com/2015/06/a-week-of-ios.html" rel="noopener ugc nofollow" target="_blank"> <em class="js">周iOS </em> </a> <em class="js">”系列的一部分。</em></p></div><div class="ab cl lg lh go li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ha hb hc hd he"><div class="ln lo lp lq fd lr"><a rel="noopener follow" target="_blank" href="/@dfed"><div class="ls ab dw"><div class="lt ab lu cl cj lv"><h2 class="bd hi fi z dy lw ea eb lx ed ef hg bi translated">丹·费德曼</h2><div class="ly l"><h3 class="bd b fi z dy lw ea eb lx ed ef dx translated">请关注丹·费德曼在Medium上的最新活动。57个人在关注丹·费德曼，看看他们的故事…</h3></div><div class="lz l"><p class="bd b fp z dy lw ea eb lx ed ef dx translated">medium.com</p></div></div><div class="ma l"><div class="mb l mc md me ma mf mg lr"/></div></div></a></div><div class="mh mi ez fb mj lr"><a href="http://twitter.com/theprofessor22" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab dw"><div class="lt ab lu cl cj lv"><h2 class="bd hi fi z dy lw ea eb lx ed ef hg bi translated">埃里克·穆勒(@TheProfessor22) |推特</h2><div class="ly l"><h3 class="bd b fi z dy lw ea eb lx ed ef dx translated">埃里克·穆勒的最新推文(@TheProfessor22)。iOS @Square(从注册到skunkworks再到开发者)，prev。…</h3></div><div class="lz l"><p class="bd b fp z dy lw ea eb lx ed ef dx translated">twitter.com</p></div></div><div class="ma l"><div class="mk l mc md me ma mf mg lr"/></div></div></a></div></div></div>    
</body>
</html>