<html>
<head>
<title>How Airbnb Enables Consistent Data Consumption at Scale</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Airbnb如何实现大规模的一致数据消费</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/how-airbnb-enables-consistent-data-consumption-at-scale-1c0b6a8b9206?source=collection_archive---------0-----------------------#2021-09-21">https://medium.com/airbnb-engineering/how-airbnb-enables-consistent-data-consumption-at-scale-1c0b6a8b9206?source=collection_archive---------0-----------------------#2021-09-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="07d0" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">第三部分:构建连贯的消费体验</h2></div><p id="f9e9" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi">通过:</strong> <a class="ae js" href="https://www.linkedin.com/in/apahwa/" rel="noopener ugc nofollow" target="_blank">阿米塔帕瓦</a>，<a class="ae js" href="https://www.linkedin.com/in/cristianrfr/" rel="noopener ugc nofollow" target="_blank">克里斯蒂安菲格罗亚</a>，<a class="ae js" href="https://www.linkedin.com/in/donghan-zhang-670990135/" rel="noopener ugc nofollow" target="_blank">东寒张</a>，<a class="ae js" href="https://www.linkedin.com/in/haimgrosman/" rel="noopener ugc nofollow" target="_blank">海姆格罗斯曼</a>，<a class="ae js" href="https://www.linkedin.com/in/john-bodley-a13327133/" rel="noopener ugc nofollow" target="_blank">约翰博德利</a>，<a class="ae js" href="https://www.linkedin.com/in/jonathan-parks-15617820/" rel="noopener ugc nofollow" target="_blank">乔纳森帕克斯</a>，<a class="ae js" href="https://www.linkedin.com/in/jialingliu1020/" rel="noopener ugc nofollow" target="_blank">刘文秀</a>，<a class="ae js" href="https://www.linkedin.com/in/krishna-bhupatiraju-1ba1a524/" rel="noopener ugc nofollow" target="_blank">克里希纳布帕蒂拉朱</a>，<a class="ae js" href="https://www.linkedin.com/in/shengnan-zhu-89403124/" rel="noopener ugc nofollow" target="_blank">玛吉朱</a>，<a class="ae js" href="https://www.linkedin.com/in/michaelcl/" rel="noopener ugc nofollow" target="_blank">麦克林</a>，<a class="ae js" href="https://www.linkedin.com/in/philip-weiss-391021b1/" rel="noopener ugc nofollow" target="_blank"/></p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jt"><img src="../Images/f47505bc53b3e6cb67715a335394547a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4n3siF32QWxo31_6okaE9g.jpeg"/></div></div></figure><h1 id="baeb" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">介绍</h1><p id="9bda" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">在本系列的第一篇文章中，我们强调了Minerva在改变Airbnb分析工作方式中所扮演的角色。在<a class="ae js" rel="noopener" href="/airbnb-engineering/airbnb-metric-computation-with-minerva-part-2-9afe6695b486">的第二篇文章</a>中，我们深入到Minerva的核心计算基础设施，并解释了我们如何在数据集和团队之间实施数据一致性。在这第三篇也是最后一篇文章中，我们将重点讲述Minerva如何大幅简化和改善我们用户的数据消费体验。具体来说，我们将展示统一指标层(我们称之为Minerva API)如何帮助我们为具有广泛背景和不同数据专业知识水平的用户量身打造多功能数据消费体验。</p><h1 id="da80" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">以度量为中心的方法</h1><p id="4685" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">当数据消费者使用数据来构建业务问题时，他们通常会从指标和维度方面进行思考。例如，一位业务领导可能想知道长期入住(一个维度)占预订(一个指标)的百分比。要回答这个问题，她需要找到要查询的正确的一组表(where)，应用必要的连接或过滤器(how)，然后最终聚合事件(how)以得到正确的答案。</p><p id="fc84" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">虽然许多传统的BI工具试图代表他们的用户抽象这项工作，但他们的大部分数据服务逻辑仍然严重依赖于用户来确定“在哪里”和“如何”。在Airbnb，我们渴望建立更好的用户体验——在这种体验中，用户只需简单地询问指标和维度削减，就可以获得答案，而不必担心“在哪里”或“如何”。这个愿景，我们称之为“以度量为中心的方法”，被证明是一个困难的工程挑战。</p><h2 id="d5dc" class="lc kg hh bd kh ld le lf kl lg lh li kp jf lj lk kr jj ll lm kt jn ln lo kv lp bi translated">挑战一:在哪里</h2><p id="6b15" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">在大多数传统的数据仓库中，数据被组织在表中。这意味着要回答一个查询，BI工具需要将所讨论的指标和维度与包含相关答案的物理表相关联。但是，对于给定的指标和维度组合，可能有许多数据集可以提供答案。这些表通常具有不同程度的数据质量和正确性保证，因此选择正确的表来提供数据是很重要的。</p><h2 id="eb86" class="lc kg hh bd kh ld le lf kl lg lh li kp jf lj lk kr jj ll lm kt jn ln lo kv lp bi translated">挑战二:“如何做”</h2><p id="7357" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">除了“在哪里”，负责“如何”的数据服务逻辑也有许多细微差别。首先，有不同的度量类型:<em class="lq">简单度量</em>由单个物化事件(例如，预订)组成；<em class="lq">过滤指标</em>由根据维度值过滤的简单指标组成(例如，中国的预订量)；而<em class="lq">衍生指标</em>由一个或多个非衍生指标(例如搜索到图书的比率)组成。此外，虽然许多指标是相加的(例如，预订)，但许多其他指标不是:计数差异、百分比和时间点快照不能简单地通过将单个事件相加来计算。在所有场景中，一致地正确计算这些不同的度量类型是一个巨大的挑战。</p><h2 id="6191" class="lc kg hh bd kh ld le lf kl lg lh li kp jf lj lk kr jj ll lm kt jn ln lo kv lp bi translated">挑战三:与下游应用程序集成</h2><p id="2610" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">最后，为了做出基于数据的决策，数据必须在各种各样的环境、应用程序和工具中使用。该指标越普遍、越重要，就越有可能被广泛应用于各种场合。例如，总预订价值(GBV)、预订住宿和收入是Airbnb最常用的指标。它们用于跟踪业务绩效，计算随机控制实验的护栏指标，并用作机器学习模型的功能。在不同的用例中提供这些指标，同时为用户提供正确使用它们的上下文信息是我们的另一个核心挑战。</p><h2 id="d4f2" class="lc kg hh bd kh ld le lf kl lg lh li kp jf lj lk kr jj ll lm kt jn ln lo kv lp bi translated">我们的解决方案</h2><p id="8654" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">我们通过构建Minerva API解决了这些挑战，这是一个度量服务层，充当上游数据模型和下游应用程序之间的接口。有了Minerva API，任何下游应用程序都能够一致、正确地提供数据，而无需知道数据存储在哪里，也无需知道应该如何计算指标。本质上，Minerva API通过连接“什么”和“哪里”来充当“如何”。</p><h1 id="c5f8" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">Minerva API</h1><p id="9f67" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">Minerva API由API web服务器、元数据提取器应用程序和几个与<a class="ae js" href="https://superset.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache超集</a>、<a class="ae js" href="https://www.tableau.com/" rel="noopener ugc nofollow" target="_blank"> Tableau </a>、<a class="ae js" href="https://www.python.org/" rel="noopener ugc nofollow" target="_blank"> Python </a>和<a class="ae js" href="https://www.r-project.org/" rel="noopener ugc nofollow" target="_blank"> R </a>集成的客户端组成。这些组件为下游应用程序提供本地NoSQL和SQL指标查询。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es lr"><img src="../Images/c3055133a0289f63dc2d76b281b9337d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FUP1m7DFm8B6XmaF"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">Minerva API serves as the interface between the consumers and the underlying datasets</figcaption></figure><h2 id="1774" class="lc kg hh bd kh ld le lf kl lg lh li kp jf lj lk kr jj ll lm kt jn ln lo kv lp bi translated">元数据提取器:抽象“何处”</h2><p id="c825" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">我们之前提到过，用户只需向Minerva请求度量和维度缩减，而不必弄清楚“在哪里”。当发出一个数据请求时，Minerva会花费大量精力来计算应该使用它的哪个数据集来满足该请求。</p><p id="5edd" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在挑选最佳数据源之前，Minerva会考虑几个因素，其中最重要的因素之一是数据完整性。这意味着任何被选择来为查询服务的数据源都应该包含给定用户的查询请求所需的所有列，并且必须覆盖查询请求所需的时间范围。</p><p id="58cc" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为了实现这一点，我们构建了一个名为Metadata Fetcher的服务，该服务每隔15分钟定期获取数据源元数据并将其缓存在MySQL数据库中。具体来说，我们定期从S3获取Minerva配置的最新副本(存储在Thrift二进制文件中),以获得Druid中每个有效Minerva数据源的列表。对于每个数据源，我们查询Druid broker以获得它的名称以及相关的度量和维度列表。此外，我们还可以从代理获得最小日期、最大日期和不同日期的计数，以确定是否有任何缺失的数据。每次获取新信息时，我们都会更新MySQL数据库，以维护事实的来源。有了这个元数据获取器，我们就能够在任何给定的时间使用最佳的数据源为数据请求提供服务。</p><h2 id="0d51" class="lc kg hh bd kh ld le lf kl lg lh li kp jf lj lk kr jj ll lm kt jn ln lo kv lp bi translated">数据API:抽象“如何”</h2><p id="4ed4" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">设想一个场景，其中用户有兴趣了解按目的地地区划分的平均每日价格(ADR)的趋势，不包括2021年8月过去4周的私人房间。示例查询的完整规范可能如下所示:</p><pre class="ju jv jw jx fd lw lx ly lz aw ma bi"><span id="02db" class="lc kg hh lx b fi mb mc l md me">{</span><span id="05ca" class="lc kg hh lx b fi mf mc l md me">      metric: ‘price_per_night’,</span><span id="3b14" class="lc kg hh lx b fi mf mc l md me">      groupby_dimension: ‘destination_region’,</span><span id="3989" class="lc kg hh lx b fi mf mc l md me">      global_filter: ‘dim_room_type!=”private-room”’,</span><span id="e271" class="lc kg hh lx b fi mf mc l md me">      aggregation_granularity: ‘W-SAT’,</span><span id="2fd7" class="lc kg hh lx b fi mf mc l md me">      start_date: ‘2021–08–01’,</span><span id="4704" class="lc kg hh lx b fi mf mc l md me">      end_date: ‘2021–09–01’,</span><span id="6f34" class="lc kg hh lx b fi mf mc l md me">      truncate_incomplete_leading_data: ‘true’,</span><span id="4a0c" class="lc kg hh lx b fi mf mc l md me">      truncate_incomplete_trailing_data: ‘true’,</span><span id="cf75" class="lc kg hh lx b fi mf mc l md me">}</span></pre><p id="f228" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当Minerva收到这样的请求时，它不仅需要知道从哪里获取数据，还需要知道如何过滤、组合和聚合数据以创建最终结果。它采用了一种策略，通过数据分析中常用的<a class="ae js" href="https://www.jstatsoft.org/article/view/v040i01" rel="noopener ugc nofollow" target="_blank">拆分-应用-组合范式</a>来实现这一目标。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es mg"><img src="../Images/f487931af9681b2a6482d14c8c945fbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZBoswC0q8u0DvM82"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">Split-Apply-Combine in action for `price_per_night` metric</figcaption></figure><h2 id="e480" class="lc kg hh bd kh ld le lf kl lg lh li kp jf lj lk kr jj ll lm kt jn ln lo kv lp bi translated">步骤1:将请求分割成原子度量请求</h2><p id="624b" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">当Minerva API接收到如上所示的查询请求时，它做的第一件事就是通过创建一组关联的子查询，将任何派生的指标分解成我们称之为Minerva“原子”指标的指标。如果用户查询只指定一个原子Minerva指标，那么第一步基本上是无操作的。</p><p id="5d9b" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在上面的例子中，假设“每晚价格”指标是一个比率指标(派生指标的一个特例)，它包含一个分子(“总预订值”和一个分母(“预订夜数”)，Minerva API将这个请求分成两个子请求。</p><h2 id="0526" class="lc kg hh bd kh ld le lf kl lg lh li kp jf lj lk kr jj ll lm kt jn ln lo kv lp bi translated">步骤2:应用并执行每个子查询</h2><p id="138a" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">使用步骤1中确定的原子指标，Minerva利用存储在S3中的指标配置来推断相关的指标表达式和元数据，以便生成子查询。让我们坚持同一个例子:Minerva数据API查找“gross_booking_value_stays”的指标定义，发现它是一个SUM聚合，对于“nights_booked”指标也是如此。在这两个请求中，全局过滤器“dim_room_type！=“私人房间”适用于确保私人房间不包括在计算中。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es mg"><img src="../Images/e50bc1035bb3b97681b109d55c7afe1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*utscy1Byao92TR23"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">The split-apply-combine paradigm in action for the ADR metric</figcaption></figure><p id="e54c" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">一旦为每个原子度量生成了相关的子查询，Minerva API最终会将查询发送给Druid或Presto。它将查询分割成几个跨越较小时间范围的“片段”,然后在达到资源限制时将结果组合成一个数据帧。API还会在根据聚合粒度汇总数据帧之前截断任何不完整的前导或尾随数据。</p><h2 id="f67f" class="lc kg hh bd kh ld le lf kl lg lh li kp jf lj lk kr jj ll lm kt jn ln lo kv lp bi translated">步骤3:将原子度量结果合并到单个数据帧中</h2><p id="c9d6" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">一旦Minerva汇总了每个原子指标的数据帧，它就会通过连接时间戳列上的数据帧将它们组合成一个数据帧。最后一步，Minerva API执行任何必要的聚合后计算，应用排序和限制，然后以序列化的JSON格式将最终结果返回给客户机。</p><p id="b3ca" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">概括地说，使用Minerva的数据源API和数据API，我们能够抽象出识别“从哪里”获取数据以及“如何”返回数据的过程。这个API充当Minerva的单一抽象层，以满足来自下游应用程序的任何请求。然而，我们的故事并没有就此结束:我们的许多工程挑战涉及如何将不同的应用程序与这个API集成。我们将在下一节探讨这些挑战。</p><h1 id="bcb8" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">数据消费体验</h1><p id="3941" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">考虑到Airbnb中不同的数据消费者，我们开始构建适合不同角色和用例的工具。借助Minerva API，我们构建了广泛的用户界面，提供一致、连贯的数据消费体验。正如我们在第一篇<a class="ae js" rel="noopener" href="/airbnb-engineering/how-airbnb-achieved-metric-consistency-at-scale-f23cc53dea70">文章</a>中简要提到的，有四个主要的集成端点，每个都支持一组不同的工具和受众:</p><ul class=""><li id="febe" class="mh mi hh iy b iz ja jc jd jf mj jj mk jn ml jr mm mn mo mp bi translated"><strong class="iy hi">数据分析:</strong>与Python和R集成，主要用于高级数据分析</li><li id="a521" class="mh mi hh iy b iz mq jc mr jf ms jj mt jn mu jr mm mn mo mp bi translated"><strong class="iy hi">数据探索:</strong>集成商务智能工具，如超集、<a class="ae js" rel="noopener" href="/airbnb-engineering/supercharging-apache-superset-b1a2393278bd#c576">指标浏览器</a>和Tableau，专为精通数据的分析师量身定制，推动洞察</li><li id="c133" class="mh mi hh iy b iz mq jc mr jf ms jj mt jn mu jr mm mn mo mp bi translated"><strong class="iy hi">报告:</strong>与<strong class="iy hi"> </strong> <a class="ae js" rel="noopener" href="/airbnb-engineering/how-airbnb-achieved-metric-consistency-at-scale-f23cc53dea70#efb9"> XRF </a>(高管报告框架)集成，为希望了解企业当前状态的高管受众量身定制</li><li id="65a1" class="mh mi hh iy b iz mq jc mr jf ms jj mt jn mu jr mm mn mo mp bi translated"><strong class="iy hi">实验:</strong>与<strong class="iy hi"> </strong> <a class="ae js" rel="noopener" href="/airbnb-engineering/https-medium-com-jonathan-parks-scaling-erf-23fd17c91166"> ERF </a>(实验报告框架)集成，为任何在Airbnb运行A/B测试的数据科学家、工程师或产品经理量身定制</li></ul><p id="994e" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当构建这些特性时，我们经常在一致性、灵活性和可访问性之间进行权衡。例如，Metric Explorer主要是为不是数据专家的非技术用户构建的。这意味着it需要优化一致性和可访问性，而不是灵活性。Metric Explorer强制执行严格的护栏，防止用户做错误的事情，很少有机会偏离“铺设的路径”。</p><p id="2a87" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在另一个极端，通常受到数据科学家青睐的R和Python客户机要灵活得多。用户可以完全控制如何利用客户端的API来执行自定义分析或可视化。在接下来的几节中，我们将解释这些消费体验是如何在幕后创建的。</p><h2 id="800e" class="lc kg hh bd kh ld le lf kl lg lh li kp jf lj lk kr jj ll lm kt jn ln lo kv lp bi translated">与Metric Explorer集成</h2><p id="909c" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">Metric Explorer创建于Airbnb，因此任何人，无论其数据专业知识水平如何，都可以利用数据做出明智的决策。由于其广泛的目标受众，Metric Explorer优化了可访问性和数据一致性，而不是灵活性。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es mv"><img src="../Images/ea2d5013185e6ddf12c0d1e4254cd203.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OknXUhNkPk0DtU8P"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">The Metric Explorer is great for a non-technical audience who wants to answer high-level business questions</figcaption></figure><p id="9dd9" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在引擎盖下，Metric Explorer的所有指标、维度和相关元数据都来自Minerva的指标库，并被摄取到<a class="ae js" href="https://www.elastic.co/elasticsearch/" rel="noopener ugc nofollow" target="_blank"> Elasticsearch </a>中。在用户对数据执行任何操作之前，这些元数据作为上下文方便地呈现在右边栏上。</p><p id="d3ca" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当用户选择执行数据操作(如分组和过滤)时，Metrics Explorer会按排名顺序显示维度，以便很少或没有业务上下文的用户可以轻松地向下钻取，而无需事先知道维度值，如上图所示。</p><p id="05c3" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当用户切割数据时，Minerva API会自动确定哪个组合是有效的，并且只对存在的切割进行表面处理。在这种体验中，用户不需要知道任何关于底层物理表的信息，所讨论的指标就是来自这个物理表。</p><h2 id="2fe5" class="lc kg hh bd kh ld le lf kl lg lh li kp jf lj lk kr jj ll lm kt jn ln lo kv lp bi translated">与Apache超集集成</h2><p id="714e" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">虽然Metrics Explorer提供了关于指标的高级信息，但是希望更多地分割数据的更有冒险精神的用户可以在超集中这样做。Apache Superset 是Airbnb自助式商务智能解决方案核心的自主开发工具。鉴于超集在公司内部无处不在，我们知道我们需要提供一个与超集功能类似的SQL集成，以便Minerva被广泛采用。</p><p id="1ab2" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">虽然许多应用程序可以通过直接与RESTful端点对话来构建在Minerva API之上，但Apache Superset和Tableau等BI工具的客户端接口更加复杂。通常，这些BI工具使用SQL(通过客户端)，而不是HTTP请求。这意味着Minerva API需要支持一个类似SQL的接口，该接口遵循<a class="ae js" href="https://en.wikipedia.org/wiki/Online_analytical_processing" rel="noopener ugc nofollow" target="_blank"> OLAP </a>类型的查询结构。为了构建这样一个接口，我们向Minerva API添加了一个SQL解析器——利用<a class="ae js" href="https://pypi.org/project/sqlparse/v" rel="noopener ugc nofollow" target="_blank">SQL parse</a>——将SQL语句解析成AST，然后验证并转换成本地HTTP请求。</p><p id="9653" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">遵循DRY原则，我们利用了<a class="ae js" href="https://calcite.apache.org/avatica/" rel="noopener ugc nofollow" target="_blank"> Apache方解石Avatica </a>，它定义了客户端和服务器之间的通用数据库连接API。Minerva API充当Avatica HTTP服务器，客户端或者是带有<a class="ae js" href="https://www.sqlalchemy.org/" rel="noopener ugc nofollow" target="_blank"> SQLAlchemy </a>方言(超集)的自定义<a class="ae js" href="https://www.python.org/dev/peps/pep-0249/" rel="noopener ugc nofollow" target="_blank"> Python数据库API </a>数据库驱动程序，或者是Avatica提供的JDBC连接器(Tableau)。</p><p id="8a72" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">与传统的BI工具不同，在传统的BI工具中，定制的业务逻辑是在工具本身中实现的，Minerva通过类似伪SQL的AGG度量表达式来整合和混淆所有这些逻辑。在下表中，我们比较了在传统BI工具中运行的查询和在超集中运行的查询:</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es mw"><img src="../Images/7b1ff866c8a72e1b9aaf438b0695b97e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HK1IgDif4Uz5Qmm8LLiFPA.png"/></div></div></figure><p id="3299" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在左边的查询中，用户不需要指定应该从哪里计算指标，也不需要指定正确的聚合函数——这些细节被Minerva抽象掉了。</p><p id="cee9" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最后，假设Minerva中有12，000个度量和5，000个维度，并不是所有的度量维度组合都有效。例如，活动列表可以根据主人所在的位置来剪切，但不能根据客人来自的位置来剪切(即，该客人属性对于每个预订预约可能是不同的)。我们向图表控件添加了事件侦听器，以确保只有符合条件的度量和维度组合才会出现在左侧窗格中。这种设计有助于减少认知负荷和简化数据探索过程。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es mv"><img src="../Images/7027699d82f87cc2ae0d323b150aeac4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CqG4C2B6ND0XW17h"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">Superset is metric-centric. Users can query all metrics and dimensions from a single virtual source</figcaption></figure><h2 id="04f2" class="lc kg hh bd kh ld le lf kl lg lh li kp jf lj lk kr jj ll lm kt jn ln lo kv lp bi translated">与XRF集成—执行报告框架</h2><p id="d7d5" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">如<a class="ae js" rel="noopener" href="/airbnb-engineering/how-airbnb-achieved-metric-consistency-at-scale-f23cc53dea70#efb9">第一部分</a>所述，XRF是一个框架，用于生成简洁、高保真的关键业务报告，供高管和领导团队使用。该框架通过Minerva配置进行配置，并完全由Minerva API提供支持。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es mx"><img src="../Images/54cb08e8a1a85801a9ce2fd63e3c935b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hedx5FI-tvWKqhuA"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">XRF automates a lot of repeated manual work and allows us to standardize high fidelity business critical reports</figcaption></figure><p id="9355" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为了管理XRF报告，用户首先定义报告配置，并指定所需的业务指标、维度划分和要应用的全局过滤器。此外，用户可以配置其他控件，例如是否应将指标计算为运行聚合(例如，MTD、QTD或YTD)，以及增长率时间比率比较的适当单位(例如，YoY、MoM或WoW)。一旦指定了这些设置，Minerva API就会执行必要的聚合和最终透视来生成最终报告。</p><p id="598c" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">XRF输出的数据可以通过自定义的GoogleSheetHook呈现在Google sheet中，也可以通过Presto连接呈现在Tableau中。通过利用Minerva中的指标定义及其聚合逻辑，我们在用户选择的表示层中实施了一致性保护。</p><h2 id="7005" class="lc kg hh bd kh ld le lf kl lg lh li kp jf lj lk kr jj ll lm kt jn ln lo kv lp bi translated">与ERF集成—实验报告框架</h2><p id="0c1b" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">与分析或报告用例不同，实验用例的独特之处在于，用于报告的指标只是一个起点。为了做出正确的因果推断，在将指标转换为可用于有效统计比较的汇总统计数据之前，必须将指标与实验分配数据相结合。</p><p id="806d" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">通常，Minerva向ERF提供“原始事件”。根据随机化单元和分析单元，我们使用不同的主题关键字将Minerva数据加入到分配日志中，以便每个事件都有相关的主题以及与之关联的实验组。然后计算汇总统计数据，如平均值、百分比变化和p值，并显示在ERF记分卡中。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es mv"><img src="../Images/b3e4ffdefebf6ca24eb23cbb3ee7d1ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wuT_vRG_w43SvZtf"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">ERF scorecard showing summary statistics for experiments</figcaption></figure><p id="4fa5" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Experimentation UI还直接在工具中公开相关的Minerva元数据。用户可以查看底层Minerva事件的描述和所有权信息。覆盖有ETA信息的沿袭视图允许用户<a class="ae js" rel="noopener" href="/airbnb-engineering/visualizing-data-timeliness-at-airbnb-ee638fdf4710">跟踪ERF指标</a>的进度，并在出现延迟时帮助他们联系相关Minerva指标所有者。</p><figure class="ju jv jw jx fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es my"><img src="../Images/abb347917eb636eb2467b0260617c9b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZtOE_1oe6GUtuY1T"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">ERF displaying metrics metadata, which links to<a class="ae js" rel="noopener" href="/airbnb-engineering/visualizing-data-timeliness-at-airbnb-ee638fdf4710"> SLA Tracker</a> to visualize data lineage and timeliness</figcaption></figure><p id="f06d" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">总之，Minerva及其各种集成使用户能够轻松跟踪其计划报告中的指标，测量由于实验而产生的变化，并探索意外的变化—所有这一切都充满了数据正确和一致的信心。这种信心大大减少了获得见解所花费的时间，增加了对数据的信任，并有助于支持数据驱动的决策制定。</p><h1 id="db56" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">关闭</h1><p id="bfc7" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">Minerva引入了一种思考数据的新方法，它不仅以业务和指标为中心的用户界面为中心，我们还需要使传统的BI工具(主要是SQL)适应Minerva API的界面。在某种意义上，它类似于将一个新的方钉(Minerva)安装到一个现有的圆孔中(BI工具)。</p><p id="8669" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">随着越来越多的组织接受类似于Minerva的度量层概念，我们相信将会有一系列新的挑战等待着我们。也就是说，这种开创性的工作肯定会将分析带到一个新的水平，我们很高兴能为这一领域的领先优势做出贡献。我们希望很快会有更多的公司效仿。</p><h1 id="b942" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">承认</h1><p id="bc69" class="pw-post-body-paragraph iw ix hh iy b iz kx ii jb jc ky il je jf kz jh ji jj la jl jm jn lb jp jq jr ha bi translated">感谢<a class="ae js" rel="noopener" href="/airbnb-engineering/how-airbnb-achieved-metric-consistency-at-scale-f23cc53dea70#8a0a">对这篇博文中的工作和成果</a>做出贡献的每一个人。除了<a class="ae js" rel="noopener" href="/airbnb-engineering/how-airbnb-achieved-metric-consistency-at-scale-f23cc53dea70#8a0a">之前的致谢</a>之外，我们还要感谢那些与我们合作在我们的消费领域采用Minerva的人。</p></div><div class="ab cl mz na go nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ha hb hc hd he"><p id="ed4b" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">所有商标都是其各自所有者的财产。这些的任何使用仅用于识别目的，并不意味着赞助或认可。</p></div></div>    
</body>
</html>