<html>
<head>
<title>Show download progress in a RecyclerView with Ktor-Client and Flow asynchronous data stream</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Ktor客户端和流异步数据流在RecyclerView中显示下载进度</h1>
<blockquote>原文：<a href="https://blog.kotlin-academy.com/show-download-progress-in-a-recyclerview-with-ktor-client-and-flow-asynchronous-data-stream-9debab3d2cb6?source=collection_archive---------2-----------------------#2019-11-25">https://blog.kotlin-academy.com/show-download-progress-in-a-recyclerview-with-ktor-client-and-flow-asynchronous-data-stream-9debab3d2cb6?source=collection_archive---------2-----------------------#2019-11-25</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/77862957eabca8c2603741d8c6bdb07c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MruapnqcSDhxzoOtWj-y_w.jpeg"/></div></div><figcaption class="iw ix gj gh gi iy iz bd b be z dk">photo by <a class="ae ja" href="https://www.flickr.com/photos/psd/" rel="noopener ugc nofollow" target="_blank">Paul Downey</a></figcaption></figure><div class=""/><p id="a71d" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><a class="ae ja" rel="noopener ugc nofollow" target="_blank" href="/download-files-with-ktor-and-coroutines-e96b1cc8b657">在第一个关于用Ktor和Koin </a>下载文件的故事里(真的建议先看完再开始看这个故事！)，我们学习了如何从回收器的角度下载一些文件，但是我很确定你们中的很多人都想知道<strong class="kc je"><em class="ky">嘿，但是显示一个确定的进度条怎么样？</em>”。</strong>事实上，为了更好的用户体验，让用户知道<strong class="kc je"> </strong>等待文件下载<strong class="kc je">的时间是很重要的。因此，在这个故事中，我们将看到协程如何再次派上用场，拯救我们的开发人员的生命！</strong></p></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><p id="8c53" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi lg translated">首先要考虑的是:"<strong class="kc je"> <em class="ky">我如何用Ktor-client获取下载文件的进度？"。</em> </strong>干脆就这样<strong class="kc je"> <em class="ky"> : </em> </strong></p><figure class="lp lq lr ls gt ip"><div class="bz fp l di"><div class="lt lu l"/></div></figure><p id="24e4" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们没有使用任何魔法，只是将我们的<code class="fe lv lw lx ly b">response</code>设置在一个变量中，创建一个<code class="fe lv lw lx ly b">data</code> ByteArray来保存文件的每个<strong class="kc je">块并读取它。在while循环中，我们有每个读取块的<strong class="kc je">进度</strong>。现在我们知道了如何获得下载进度，我们应该考虑如何将它发送给调用者…这是一个密封类的完美场景！</strong></p><blockquote class="lz ma mb"><p id="18e1" class="ka kb ky kc b kd ke kf kg kh ki kj kk mc km kn ko md kq kr ks me ku kv kw kx ig bi translated">当值可以具有有限集合中的一种类型，但不能具有任何其他类型时，密封类用于表示受限制的类层次结构</p></blockquote><p id="ff85" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">调用者方法需要知道当前下载的<strong class="kc je">进度、</strong><strong class="kc je">成功</strong>和<strong class="kc je">失败</strong>。特别是，失败可以传输一个消息直接展现给用户。</p><figure class="lp lq lr ls gt ip"><div class="bz fp l di"><div class="lt lu l"/></div></figure><p id="dd14" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">密封类不足以向列表适配器发送实时进度，对于我们的目的来说，<strong class="kc je"> Kotlin </strong> <a class="ae ja" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-flow/" rel="noopener ugc nofollow" target="_blank"> <strong class="kc je">流</strong> </a>是完美的！</p><blockquote class="lz ma mb"><p id="8e51" class="ka kb ky kc b kd ke kf kg kh ki kj kk mc km kn ko md kq kr ks me ku kv kw kx ig bi translated">流是<em class="jd">一个冷异步数据流，顺序发出值，正常或异常完成。</em></p></blockquote><p id="ee2e" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc je"> <em class="ky">我们可以把它看作是一个emitter的采集器，采集器接收每一个信号(emit)并对每一个信号做一些运算</em> </strong>。这是一个非常简单的解释，但你可以在<a class="ae ja" href="https://medium.com/@elizarov/simple-design-of-kotlin-flow-4725e7398c4c" rel="noopener">kot Lin流的简单设计</a>中找到一个非常好的深度研究！<br/>现在我们可以将<code class="fe lv lw lx ly b">downloadFile</code>方法修改为<strong class="kc je">发射</strong> <code class="fe lv lw lx ly b">DownloadResult</code> …</p><figure class="lp lq lr ls gt ip"><div class="bz fp l di"><div class="lt lu l"/></div></figure><p id="caba" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">…并且<strong class="kc je">在主活动中收集</strong>结果:</p><figure class="lp lq lr ls gt ip"><div class="bz fp l di"><div class="lt lu l"/></div></figure><p id="cd2e" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">不同情况下该怎么办？</p><ul class=""><li id="5898" class="mf mg jd kc b kd ke kh ki kl mh kp mi kt mj kx mk ml mm mn bi translated"><em class="ky">成功:</em>将下载状态设置为假</li><li id="2b0b" class="mf mg jd kc b kd mo kh mp kl mq kp mr kt ms kx mk ml mm mn bi translated"><em class="ky">错误:</em>显示信息并设置错误状态</li><li id="0d93" class="mf mg jd kc b kd mo kh mp kl mq kp mr kt ms kx mk ml mm mn bi translated">进度:显示进度并更新进度条</li></ul><p id="04eb" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">不要忘记使用<code class="fe lv lw lx ly b">withContext(Dispatchers.Main)</code>在主线程上完成所有这些操作</p><figure class="lp lq lr ls gt ip"><div class="bz fp l di"><div class="lt lu l"/></div></figure><p id="8b04" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在让我们看看适配器是如何变化的:</p><figure class="lp lq lr ls gt ip"><div class="bz fp l di"><div class="lt lu l"/></div></figure><p id="3145" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">从上面的代码中，你可以看到使用<code class="fe lv lw lx ly b">onBindViewHolder</code>和<code class="fe lv lw lx ly b">payload</code>来为适配器中的每个视图选择准确的更新，这避免了每个<code class="fe lv lw lx ly b">setProgress</code>在每个项目上令人讨厌的闪烁</p><p id="4fef" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">所以这是最后的结果:</p><figure class="lp lq lr ls gt ip gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/8edbb1c76b433ddc5257fd1d597c4242.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*ChpkWCcTwSG5dneCJI9E3w.gif"/></div></figure><p id="9461" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您可以在这里找到示例项目。编码快乐！</p><div class="im in gp gr io mu"><a href="https://github.com/francescogatto/Ktor-Koin-Files-Download" rel="noopener  ugc nofollow" target="_blank"><div class="mv ab fo"><div class="mw ab mx cl cj my"><h2 class="bd je gy z fp mz fr fs na fu fw jc bi translated">弗朗切斯科加托/Ktor-Koin-文件-下载</h2><div class="nb l"><h3 class="bd b gy z fp mz fr fs na fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nc l"><p class="bd b dl z fp mz fr fs na fu fw dk translated">github.com</p></div></div></div></a></div></div><div class="ab cl kz la hr lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ig ih ii ij ik"><h1 id="0e76" class="nd ne jd bd nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa bi translated">单击👏说“谢谢！”并帮助他人找到这篇文章。</h1><p id="fed1" class="pw-post-body-paragraph ka kb jd kc b kd ob kf kg kh oc kj kk kl od kn ko kp oe kr ks kt of kv kw kx ig bi translated">了解卡帕头最新的重大新闻。学院，<a class="ae ja" href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a" rel="noopener ugc nofollow" target="_blank">订阅时事通讯</a>，<a class="ae ja" href="https://twitter.com/ktdotacademy" rel="noopener ugc nofollow" target="_blank">观察Twitter </a>并在媒体上关注我们。</p><p id="8363" class="pw-post-body-paragraph ka kb jd kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果您需要Kotlin工作室，请查看我们如何帮助您:<a class="ae ja" href="https://www.kt.academy/" rel="noopener ugc nofollow" target="_blank"> kt.academy </a>。</p><figure class="lp lq lr ls gt ip gh gi paragraph-image"><a href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a"><div class="gh gi og"><img src="../Images/3146970f03e44cb07afe660b0d43e045.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*54OqlYA4etu7wfpmMP5TKQ.png"/></div></a></figure></div></div>    
</body>
</html>