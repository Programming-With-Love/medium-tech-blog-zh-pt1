<html>
<head>
<title>Install an SFTP server on OpenShift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在OpenShift上安装SFTP服务器</h1>
<blockquote>原文：<a href="https://medium.com/compendium/install-an-sftp-server-on-openshift-818ea30a4319?source=collection_archive---------0-----------------------#2020-11-11">https://medium.com/compendium/install-an-sftp-server-on-openshift-818ea30a4319?source=collection_archive---------0-----------------------#2020-11-11</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/6eb10eb7426b61550eeab2fea11a31c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VjgXd3DnUwAmHoboqC0U0g.png"/></div></div></figure><h1 id="fd60" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">背景</h1><p id="d27f" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">在工作中，我们需要一台SFTP服务器来测试我们的软件。我自愿在我们的OpenShift测试环境中安装一个，但是遇到了很多正在进行的问题，并且在这个项目上花费了太多的时间。我是OpenShift新手，真的低估了这个任务。</p><p id="b02d" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">我们用的是open shift/okd 3.11版本。作为我们的消息来源，我发现https://github.com/atmoz/sftp的<a class="ae kl" href="https://github.com/atmoz/sftp" rel="noopener ugc nofollow" target="_blank">也在Docker Hub上，下载量超过1亿次。</a></p><p id="43a1" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">GitHub存储库包含几个分支，我选择使用alpine-3.7分支，因为它的大小只有16 MB。</p><p id="8d10" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">在试图修改atmoz/sftp项目以便能够以非root用户身份运行时，我很快就遇到了问题。进展不顺利，我放弃了这一尝试。</p><p id="cb41" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">另一个问题是配置文件CRLF (Windows)和LF (Linux)中的换行符。</p><p id="83c0" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">希望这篇安装日志能对你有所帮助。</p><h1 id="2944" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">安全考虑</h1><p id="5d95" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">你相信消息来源吗？SFTP服务器必须以root身份运行，这违背了OpenShift <a class="ae kl" href="https://docs.openshift.com/container-platform/3.11/install/prerequisites.html#security-warning" rel="noopener ugc nofollow" target="_blank">的建议</a>。我们只在内部使用这个服务器，不对外公开。制作GitHub源项目的一个分支(副本)并使用它。</p><h1 id="f244" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">安装概述</h1><p id="9139" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">安装包括以下内容:</p><ol class=""><li id="4c6e" class="kr ks hh jp b jq km ju kn jy kt kc ku kg kv kk kw kx ky kz bi translated">来自docker hub或GitHub的容器源。</li><li id="5fd3" class="kr ks hh jp b jq la ju lb jy lc kc ld kg le kk kw kx ky kz bi translated">用户的配置映射:<br/> /etc/sftp/users.conf</li><li id="6787" class="kr ks hh jp b jq la ju lb jy lc kc ld kg le kk kw kx ky kz bi translated">ssh密钥和配置的配置映射:<br/>/etc/ssh/ssh _ host _ ed 25519 _ key<br/>/etc/ssh/ssh _ host _ ed 25519 _ key . pub<br/>/etc/ssh/ssh _ host _ RSA _ key<br/>/etc/ssh/ssh/ssh _ host _ RSA _ key . pub<br/>/etc/ssh/sshd _ config</li><li id="3c05" class="kr ks hh jp b jq la ju lb jy lc kc ld kg le kk kw kx ky kz bi translated">允许外部流量到端口30022 -&gt;内部端口22的节点端口</li><li id="ea86" class="kr ks hh jp b jq la ju lb jy lc kc ld kg le kk kw kx ky kz bi translated">用户上传目录的永久卷(PV)存储:<br/> /home/user/upload</li></ol><h1 id="0a24" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">项目</h1><p id="7361" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">登录到OpenShift服务器，为SFTP服务创建一个新的项目/名称空间，或者选择一个现有的项目/名称空间。</p><p id="17f2" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">创建一个新项目:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="7372" class="lo iq hh lk b fi lp lq l lr ls">oc new-project int-sftp --display-name="Internal sftp server"</span></pre><p id="8f9f" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">或者选择一个现有项目:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="5305" class="lo iq hh lk b fi lp lq l lr ls">oc project int-sftp</span></pre><blockquote class="lt lu lv"><p id="67cb" class="jn jo lw jp b jq km js jt ju kn jw jx lx ko ka kb ly kp ke kf lz kq ki kj kk ha bi translated">在整个安装过程中，假设您登录到同一个项目/名称空间。</p></blockquote><h1 id="42ba" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">新应用程序</h1><p id="af49" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">创建新应用程序:</p><p id="914b" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">来自docker hub:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="6178" class="lo iq hh lk b fi lp lq l lr ls">oc new-app atmoz/sftp:alpine-3.7</span></pre><p id="c7c0" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">或者从GitHub存储库中获得:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="308d" class="lo iq hh lk b fi lp lq l lr ls">oc new-app <a class="ae kl" href="https://github.com/atmoz/sftp#alpine-3.7" rel="noopener ugc nofollow" target="_blank">https://github.com/atmoz/sftp#alpine-3.7</a></span></pre><p id="576b" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">看一下逃生舱的日志。预期错误消息:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="59a8" class="lo iq hh lk b fi lp lq l lr ls">mkdir: can't create directory '/var/run/sftp': Permission denied</span></pre><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ma"><img src="../Images/b5690fbcec679fc0526b877ab2c0b238.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6E8a1bi_wOT4odbj2xqWKw.png"/></div></div></figure><h1 id="6e3f" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">允许以root用户身份运行</h1><p id="a0ec" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">将更改当前项目/命名空间(int-sftp)中默认用户的策略，以任何用户ID (root)身份运行:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="5a2e" class="lo iq hh lk b fi lp lq l lr ls">oc adm policy add-scc-to-user anyuid -z default<br/>scc “anyuid” added to: [“system:serviceaccount:int-sftp:default”]</span></pre><p id="31ce" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">要检查哪些用户能够以root用户身份运行，请执行以下操作:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="795f" class="lo iq hh lk b fi lp lq l lr ls">oc edit scc anyuid</span><span id="8ef5" class="lo iq hh lk b fi mb lq l lr ls">users:</span><span id="61c1" class="lo iq hh lk b fi mb lq l lr ls">- system:serviceaccount:int-sftp:default</span></pre><p id="4574" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">要查看“以root用户身份运行”设置是否达到了预期的效果，请缩小并再次放大sftp部署。</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mc"><img src="../Images/2ed0f3c1227bced72d500761065df3ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fELsrt0XcR--E--5Q4SRMA.png"/></div></div></figure><p id="dce5" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">请注意，您会得到预期的错误消息:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="aab0" class="lo iq hh lk b fi lp lq l lr ls">[entrypoint] FATAL: No users provided!</span></pre><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es md"><img src="../Images/193a0beb298bdb019bacd575f095a62c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nNnOZ8p6NTNqkEDIWdxqgw.png"/></div></div></figure><h1 id="25d4" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">SFTP用户配置图</h1><p id="f4da" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">创建一个名为sftp-etc-sftp和key users.conf的新配置映射，内容如下:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="f587" class="lo iq hh lk b fi lp lq l lr ls">foo:123:1001:100:upload<br/>bar:abc:1002:100:upload<br/>baz:xyz:1003:100:upload</span></pre><p id="0341" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">用户配置文件的格式是用户名:密码:UID:GUI:目录。</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es me"><img src="../Images/a3223d0cb4d9a12ecf66237a9e69ee4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dGz_lrIEGWuwTRxy5Hn95A.png"/></div></div></figure><p id="80ee" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">我在Windows上，每行末尾都有CRLF，但是你必须去掉多余的CR字符。通过编辑YAML删除:</p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es mf"><img src="../Images/08d6237c7240a2b2bc70c3829c2cc9b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*qB0DUrXPEKXq0mKfHge2zg.png"/></div></figure><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es mg"><img src="../Images/ce4bf4b0ef77923c4ad0de8ecde7240d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*Xk4xTvN3sSfqi4FaYmmk9A.png"/></div></figure><p id="cfe8" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">请删除“\r”字符，否则，它将成为上传目录名称的一部分，并会导致问题。</p><h1 id="db70" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">装载sftp配置图</h1><p id="ce1b" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">通过转到您的部署&gt; sftp &gt;配置&gt;添加配置文件，将sftp-etc-sftp配置映射挂载到文件系统路径/etc/sftp:</p><p id="d019" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">来源:sftp-etc-sftp <br/>挂载路径:/etc/sftp</p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es mf"><img src="../Images/3bfb7909068e0dbf38bc8222c9c669c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*m18fIzdurwzEIgtth-a6Sw.png"/></div></figure><p id="fe88" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">点击添加按钮。</p><h1 id="4c4a" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">测试配置映射</h1><p id="249e" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">要测试新的配置图，请确保您的pod被重新部署并缩放到一个。如果打开了配置更改时自动重新部署，您可能不需要做任何事情。</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mc"><img src="../Images/2ed0f3c1227bced72d500761065df3ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fELsrt0XcR--E--5Q4SRMA.png"/></div></div></figure><p id="bd8f" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">启动日志:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="a178" class="lo iq hh lk b fi lp lq l lr ls">[entrypoint] Parsing user data: "foo:123:1001:100:upload"<br/>Creating mailbox file: No such file or directory<br/>[entrypoint] Creating directory: /home/foo/upload<br/>[entrypoint] Parsing user data: "bar:abc:1002:100:upload"<br/>Creating mailbox file: No such file or directory<br/>[entrypoint] Creating directory: /home/bar/upload<br/>[entrypoint] Parsing user data: "baz:xyz:1003:100:upload"<br/>Creating mailbox file: No such file or directory<br/>[entrypoint] Creating directory: /home/baz/upload<br/>Generating public/private ed25519 key pair.<br/>Your identification has been saved in /etc/ssh/ssh_host_ed25519_key.<br/>Your public key has been saved in /etc/ssh/ssh_host_ed25519_key.pub.<br/>The key fingerprint is:<br/>SHA256:qNWATmxbbYyHinTx5n10eIml7UG5K2vana9XHcqr3rY root@sftp-3-kwg2c<br/>The key's randomart image is:<br/>+--[ED25519 256]--+<br/>|    .       o.   |<br/>|   . + =   B..   |<br/>|  . * B = = *.   |<br/>| . * * B . +.. . |<br/>|  . + + S . o.. o|<br/>|     o   .. .o  o|<br/>|    .      o  .. |<br/>|         .o..+.  |<br/>|        .ooo*Eo  |<br/>+----[SHA256]-----+<br/>Generating public/private rsa key pair.<br/>Your identification has been saved in /etc/ssh/ssh_host_rsa_key.<br/>Your public key has been saved in /etc/ssh/ssh_host_rsa_key.pub.<br/>The key fingerprint is:<br/>SHA256:aTIlNkPOyXYDXiZ4Yixz2poRwYrmQJ4DuCIRqxljuxU root@sftp-3-kwg2c<br/>The key's randomart image is:<br/>+---[RSA 4096]----+<br/>|oo.o .+ o        |<br/>|+o= **.*         |<br/>|O=.E o% +        |<br/>|XO+ oo * o       |<br/>|O..=  o S        |<br/>| .=    +         |<br/>| .               |<br/>|                 |<br/>|                 |<br/>+----[SHA256]-----+<br/>[entrypoint] Executing sshd<br/>Server listening on 0.0.0.0 port 22.<br/>Server listening on :: port 22.</span></pre><p id="bc42" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">SFTP服务器现在已经启动并运行了！</p><p id="8580" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">仍然缺少的是确保服务器ssh密钥(在启动时生成)和用户上传的文件被永久存储。现在它们将会消失，以防吊舱重新启动。此外，我们不能从外部访问SFTP服务器。</p><h1 id="f80c" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">SSH配置图</h1><p id="bb90" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">如果没有持久的ssh密钥，终端用户将在pod重新启动后由于主机密钥更改而出现登录错误。</p><p id="26e5" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">我们必须确保对ssh密钥的文件访问权限仅限于root用户读取。</p><p id="6f2f" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">创建一个名为sftp-etc-ssh的新配置映射，并添加以下键:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="0ee2" class="lo iq hh lk b fi lp lq l lr ls">ssh_host_ed25519_key<br/>ssh_host_ed25519_key.pub<br/>ssh_host_rsa_key<br/>ssh_host_rsa_key.pub<br/>sshd_config</span></pre><p id="9c37" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">这些文件的内容/值可以通过pod &gt; sftp-N-AAAA &gt;终端和cat命令从运行pod中提取:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="fe04" class="lo iq hh lk b fi lp lq l lr ls">cat /etc/ssh/ssh_host_ed25519_key<br/>cat /etc/ssh/ssh_host_ed25519_key.pub<br/>cat /etc/ssh/ssh_host_rsa_key<br/>cat /etc/ssh/ssh_host_rsa_key.pub<br/>cat /etc/ssh/sshd_config</span></pre><p id="d036" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">或者，您可以使用以下两个命令生成新的密钥。使用空密码。然后查看他们的内容:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="3081" class="lo iq hh lk b fi lp lq l lr ls">ssh-keygen -t ed25519 -f ssh_host_ed25519_key &lt; /dev/null<br/>ssh-keygen -t rsa -b 4096 -f ssh_host_rsa_key &lt; /dev/null</span></pre><p id="8749" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">sshd_config的内容是:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="a8b7" class="lo iq hh lk b fi lp lq l lr ls">Protocol 2<br/>HostKey /etc/ssh/ssh_host_ed25519_key<br/>HostKey /etc/ssh/ssh_host_rsa_key</span><span id="f24c" class="lo iq hh lk b fi mb lq l lr ls"># Faster connection<br/># See: <a class="ae kl" href="https://github.com/atmoz/sftp/issues/11" rel="noopener ugc nofollow" target="_blank">https://github.com/atmoz/sftp/issues/11</a><br/>UseDNS no</span><span id="a9ad" class="lo iq hh lk b fi mb lq l lr ls"># Limited access<br/>PermitRootLogin no<br/>X11Forwarding no<br/>AllowTcpForwarding no</span><span id="597f" class="lo iq hh lk b fi mb lq l lr ls"># Force sftp and chroot jail<br/>Subsystem sftp internal-sftp<br/>ForceCommand internal-sftp<br/>ChrootDirectory %h</span></pre><p id="e738" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">您应该会得到这样的结果:</p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es mh"><img src="../Images/b5f3b46ad48c99e3fa5254f960edaf2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*3rjwjJJGYVsCH7lCQEcusw.png"/></div></figure><h1 id="0414" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">装载ssh配置图</h1><p id="8158" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">通过转至您的部署&gt; sftp &gt;配置&gt;添加配置文件，将sftp-etc-ssh配置映射到文件系统路径/etc/ssh:</p><p id="8431" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">来源:sftp-etc-ssh <br/>挂载路径:/etc/ssh</p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es mi"><img src="../Images/2f891ae77d0599746ae9ede5e2cf690d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*3vcOh0mXHVNWt2hEmW-atw.png"/></div></figure><p id="d961" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">确保您的pod已重新启动(重新部署或缩小到0，然后再放大到1)。</p><p id="88c7" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">接下来，您应该会看到如下错误消息:</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mj"><img src="../Images/793080a91731de1156606cbb6b2b7b78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J-pLgqFWVqdGE8oe7cXAKw.png"/></div></div></figure><p id="ed93" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">我们需要限制ssh密钥文件的权限。转到部署&gt; sftp &gt;编辑YAML:</p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es mk"><img src="../Images/128b6671ee23ad3454d494a910d28958.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*0LoSZbHcZL7iAZ1TiEVdjg.png"/></div></figure><p id="91cc" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">更改为sftp-stc-ssh的<strong class="jp hi">默认模式:384 </strong>设置:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="bdf3" class="lo iq hh lk b fi lp lq l lr ls">spec:<br/>  template:<br/>    spec:<br/>      volumes:<br/>        - configMap:<br/>          defaultMode: 384<br/>          name: sftp-etc-ssh</span></pre><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es mi"><img src="../Images/65799ac2f726f8c8125e200e697430a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*PM3ctlr3WhKGKrtbJoaNUQ.png"/></div></figure><blockquote class="lt lu lv"><p id="0fdf" class="jn jo lw jp b jq km js jt ju kn jw jx lx ko ka kb ly kp ke kf lz kq ki kj kk ha bi translated">384十进制= 600八进制= user+rw【http://permissions-calculator.org/】(参见<a class="ae kl" href="http://permissions-calculator.org/)" rel="noopener ugc nofollow" target="_blank">)</a></p></blockquote><h1 id="b0ab" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">测试SSH配置映射</h1><p id="64bd" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">确保pod重新启动。新的启动日志现在应该看起来像这样:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="fe15" class="lo iq hh lk b fi lp lq l lr ls">[entrypoint] Parsing user data: “foo:123:1001:100:upload”<br/>Creating mailbox file: No such file or directory<br/>[entrypoint] Creating directory: /home/foo/upload<br/>[entrypoint] Parsing user data: “bar:abc:1002:100:upload”<br/>Creating mailbox file: No such file or directory<br/>[entrypoint] Creating directory: /home/bar/upload<br/>[entrypoint] Parsing user data: “baz:xyz:1003:100:upload”<br/>Creating mailbox file: No such file or directory<br/>[entrypoint] Creating directory: /home/baz/upload<br/>[entrypoint] Executing sshd<br/>Server listening on 0.0.0.0 port 22.<br/>Server listening on :: port 22.</span></pre><h1 id="4bca" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">公开服务端口</h1><p id="abbf" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">为了能够从外部机器访问SFTP服务器，我们需要创建一个节点端口。已经自动创建了一个默认值，但是我们需要做一些更改。前往服务&gt; sftp &gt;编辑YAML:</p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es ml"><img src="../Images/5ca43bac4434bd40b3e2bbbfb567a3f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1210/format:webp/1*-Slxg5vkbOsEItzjwUkt8w.png"/></div></figure><p id="3145" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">做两处修改:</p><ol class=""><li id="d2e5" class="kr ks hh jp b jq km ju kn jy kt kc ku kg kv kk kw kx ky kz bi translated">将类型从集群IP更改为<strong class="jp hi">节点端口</strong>:</li><li id="0914" class="kr ks hh jp b jq la ju lb jy lc kc ld kg le kk kw kx ky kz bi translated">将'<strong class="jp hi">节点端口:30022 </strong>'添加到端口定义部分</li></ol><p id="f7e4" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">您应该会得到这样的结果:</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="f724" class="lo iq hh lk b fi lp lq l lr ls">spec:<br/>  ports:<br/>    - name: 22-tcp<br/>      <strong class="lk hi">nodePort: 30022</strong><br/>      port: 22<br/>      protocol: TCP<br/>      targetPort: 22<br/>  type: <strong class="lk hi">NodePort</strong></span></pre><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mm"><img src="../Images/a9092ebe751c473c4db79d7b7ccd8232.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lwNJ4uFUDU72wm0PJ-yrGA.png"/></div></div></figure><h1 id="02a4" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">测试暴露的端口</h1><p id="ea55" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">现在应该可以通过SFTP访问OpenShift节点服务器的外部地址了。</p><pre class="lf lg lh li fd lj lk ll lm aw ln bi"><span id="eefd" class="lo iq hh lk b fi lp lq l lr ls">sftp -P 30022 bar@myopenshiftserver.com<br/>bar@myopenshiftserver’s password:<br/>Connected to bar@myopenshiftserver.com.<br/>sftp&gt;<br/>sftp&gt; ls<br/>upload<br/>sftp&gt; cd upload<br/>sftp&gt; lls<br/>…</span></pre><h1 id="de95" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">持久卷</h1><p id="a450" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">我们需要创建一个永久卷(PV)来永久存储用户上传的文件。直到现在，所有上传的文件都会在pod重启后消失。</p><p id="c552" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">目前，我只为一个用户创建了一个PV声明(挂载在:/home/bar/upload)。您需要为每个用户重复这个过程。</p><p id="0775" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">转到存储&gt;创建存储:</p><p id="a89d" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">名称:sftp-bar-storage <br/>访问方式:共享访问(RWX) <br/>大小:10 GiB</p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es mn"><img src="../Images/5b40cf924db7e0faf6812f54fc4335ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1044/format:webp/1*WCZUbeZxUx-DglgYrSrPag.png"/></div></figure><p id="21dc" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">点击创建按钮。</p><p id="71b0" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">然后转到部署&gt; sftp &gt;添加存储:</p><p id="6f4c" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">选择:<br/>存储:sftp-bar-storage <br/>挂载路径:/home/bar/upload</p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es mo"><img src="../Images/84973105ef9d57327a7dc18a74f82541.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*GTxlqf3KJeulSfNAC9NTrw.png"/></div></figure><p id="9e26" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">按添加按钮。</p><p id="d940" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">确保pod重启。将文件上传到目录/home/bar/upload，然后再次重启pod。确认文件仍然在那里。</p><h1 id="afa0" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">结论</h1><p id="94e5" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">这是一个复杂的安装，特别是CRLF字符潜入我的配置和脚本文件，给出奇怪的错误信息。希望这篇文档有帮助。</p><h1 id="af16" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated">未来的工作</h1><p id="865a" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">使用机密而不是配置映射。</p><p id="0eac" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">加密用户的密码。</p><p id="9d08" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">所有用户使用一个永久卷(PV)。</p><p id="7fc2" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">启动时取消显示密码。如果使用集中式日志记录系统，这是一个安全问题。</p></div></div>    
</body>
</html>