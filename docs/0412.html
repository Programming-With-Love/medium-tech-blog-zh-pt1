<html>
<head>
<title>How Pandao uses the In-App Updates flexible flow to speed up the app update process on Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pandao如何使用应用内更新灵活流程来加速Android上的应用更新过程</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/how-pandao-uses-the-in-app-updates-flexible-flow-to-speed-up-the-app-update-process-on-android-5c00632680ed?source=collection_archive---------4-----------------------#2019-07-24">https://medium.com/androiddevelopers/how-pandao-uses-the-in-app-updates-flexible-flow-to-speed-up-the-app-update-process-on-android-5c00632680ed?source=collection_archive---------4-----------------------#2019-07-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="270b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">客座作者:Pandao的Android开发人员Sergey Smetanin</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/b8f6437b704b9b3226ea1963a755787f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bqa93N3skTV_BcE4n8nDwg.png"/></div></div></figure><p id="a5b7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在<a class="ae jo" href="https://android-developers.googleblog.com/2019/05/whats-new-in-play.html" rel="noopener ugc nofollow" target="_blank"> Google I/O </a>上宣布的各种新工具和功能中，最令人兴奋的是应用内更新(IAU) API，它允许开发者为活跃用户更快地提供功能、错误修复和性能改进。作为中国商品市场平台<a class="ae jo" href="https://play.google.com/store/apps/details?id=store.panda.client&amp;hl=en" rel="noopener ugc nofollow" target="_blank"> Pandao </a>的开发人员，我和我的团队使用API让更多的用户进行更新。在本文中，我将分享我们团队对IAU API的了解，推荐一些用户流，并让您看看我们的一些代码示例。我还会介绍一下我们是如何将IAU集成到Pandao应用程序中的。</p><p id="28eb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">IAU API允许开发者发起一个新的应用内更新请求流来敦促活跃用户进行更新。应用内更新补充了现有的Google Play自动更新机制，该机制可能并不总是启用或能够完成。IAU请求可以通过两种方式实现，用户体验完全不同:</p><ol class=""><li id="8931" class="jp jq hh ig b ih ii il im ip jr it js ix jt jb ju jv jw jx bi translated"><strong class="ig hi">灵活流程</strong>提示用户在后台下载更新并在方便时安装。这意味着即使新版本已经发布，用户仍然可以使用旧版本的应用程序。</li><li id="8d84" class="jp jq hh ig b ih jy il jz ip ka it kb ix kc jb ju jv jw jx bi translated"><strong class="ig hi">即时流程</strong>要求用户在继续使用应用之前下载并安装更新。这是为了在应用更新之前阻止应用程序的使用对开发人员来说非常重要的情况下使用。</li></ol><p id="ca3a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于后者与Pandao应用程序的相关性较小，我们将重点关注前者。</p><h2 id="4884" class="kd ke hh bd kf kg kh ki kj kk kl km kn ip ko kp kq it kr ks kt ix ku kv kw kx bi translated">IAU灵活流程集成:用例</h2><p id="0ac1" class="pw-post-body-paragraph ie if hh ig b ih ky ij ik il kz in io ip la ir is it lb iv iw ix lc iz ja jb ha bi translated">灵活的IAU流程由以下步骤组成:</p><ol class=""><li id="bc4b" class="jp jq hh ig b ih ii il im ip jr it js ix jt jb ju jv jw jx bi translated">该应用程序请求Google Play使用Play核心库来检查可用的更新。</li><li id="9d0d" class="jp jq hh ig b ih jy il jz ip ka it kb ix kc jb ju jv jw jx bi translated">如果有可用的更新，该应用程序会请求Google Play显示IAU的对话。Google Play向用户显示更新请求对话框。</li><li id="fb90" class="jp jq hh ig b ih jy il jz ip ka it kb ix kc jb ju jv jw jx bi translated">如果用户接受更新请求，Google Play会在后台下载更新。</li><li id="cec7" class="jp jq hh ig b ih jy il jz ip ka it kb ix kc jb ju jv jw jx bi translated">如果下载过程在应用程序处于后台时完成，Google Play会自动完成安装。如果下载在应用程序处于前台时完成，我们必须为更新完成定义自定义逻辑。考虑这些实施的最佳做法:</li></ol><p id="17a6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">a.下载更新后，显示一个对话框或提示，让用户确认他们准备好重新启动和更新应用程序。一旦他们同意更新，Google Play将在重启应用程序之前显示一个显示安装进度的屏幕。<strong class="ig hi">这是我们推荐的流程。</strong></p><p id="1fad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">b.如果应用程序没有提示用户应用更新，Play将在下次应用程序进入后台时尝试更新。一方面，从用户体验的角度来看，这个选项的侵入性较小。但另一方面，它要求开发者实现一个巧妙的功能，以便在应用程序进入后台时进行检测。</p><p id="3a6e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在特殊情况下，更新的完成将自动推迟到Google Play后台任务。不建议明确使用此选项，因为它不能保证何时或是否会安装更新。</p><h2 id="9e49" class="kd ke hh bd kf kg kh ki kj kk kl km kn ip ko kp kq it kr ks kt ix ku kv kw kx bi translated">手动测试的基本要求</h2><p id="cfc8" class="pw-post-body-paragraph ie if hh ig b ih ky ij ik il kz in io ip la ir is it lb iv iw ix lc iz ja jb ha bi translated">为了在测试设备上手动执行完整的更新流程，你应该拥有至少两个版本号不同的应用程序:一个<strong class="ig hi">源</strong>版本和一个<strong class="ig hi">目标</strong>版本。</p><ul class=""><li id="c555" class="jp jq hh ig b ih ii il im ip jr it js ix jt jb ld jv jw jx bi translated">版本号较高的源版本应该发布在Google Play上。这是将被Google Play识别为可用更新的版本。具有较低版本号和集成IAU功能的目标版本应安装在您的设备上。这是将要更新的版本。当应用程序请求Google Play检查可用更新时，它会将已安装应用程序的版本号与Google Play中最新可用版本的版本号进行比较，因此只有当Google Play中的版本号高于设备上应用程序的实际版本时，才会触发IAU功能。</li><li id="c841" class="jp jq hh ig b ih jy il jz ip ka it kb ix kc jb ld jv jw jx bi translated">源版本和目标版本都需要有<strong class="ig hi">相同的包</strong>名称，并且应该签署有<strong class="ig hi">相同的发布证书</strong>。</li><li id="da28" class="jp jq hh ig b ih jy il jz ip ka it kb ix kc jb ld jv jw jx bi translated">你的测试设备需要运行Android API 21+。不支持前棒棒糖设备。</li></ul><h2 id="8a44" class="kd ke hh bd kf kg kh ki kj kk kl km kn ip ko kp kq it kr ks kt ix ku kv kw kx bi translated">示例代码</h2><p id="36ee" class="pw-post-body-paragraph ie if hh ig b ih ky ij ik il kz in io ip la ir is it lb iv iw ix lc iz ja jb ha bi translated">首先，让我们创建一个IAU管理器的实例，并向<em class="le"> AppUpdateInfo </em>任务添加回调。结果包含有关更新可用性的信息、开始更新的意图(如果可用)以及更新下载的当前进度(如果已经开始)。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="77fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要在代码中从Google Play触发更新请求对话，您可以通过调用<em class="le">startUpdateFlowForResult</em>来启动更新流，将之前收到的<em class="le"> AppUpdateInfo </em>对象作为参数传递。该对话框要求用户开始更新。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="e4f0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了监视更新状态，您可以将<em class="le">InstallStateUpdatedListener</em>添加到IAU管理器中。请确保您的<em class="le">installstateupdated listener</em>是生命周期感知的。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="03cd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦下载了更新(下载状态)，应用程序需要重新启动以完成更新。您可以通过调用<em class="le">appupdatemanager . complete update()，</em>来启动重新启动，但是您可能希望显示一个snackbar来允许用户明确地确认他或她已经准备好立即重新启动应用程序。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="lf lg l"/></div></figure><h2 id="37cb" class="kd ke hh bd kf kg kh ki kj kk kl km kn ip ko kp kq it kr ks kt ix ku kv kw kx bi translated">“更新不可用”错误</h2><p id="b078" class="pw-post-body-paragraph ie if hh ig b ih ky ij ik il kz in io ip la ir is it lb iv iw ix lc iz ja jb ha bi translated">如果您看到此错误，请仔细检查“基本实现要求”一节中的要求。如果你已经完成了上面列出的步骤并满足了所有要求，但是<em class="le"> onSuccess </em>回调说更新仍然不可用，最可能的原因是由于内部缓存机制，Google Play还不知道更新。为了确保手动测试时有一个新的缓存，请在Google Play应用程序的“我的应用程序&amp;游戏”屏幕刷新缓存版本。或者，您可以在设置中清除Google Play应用程序的缓存。请注意，这只是一个测试问题，并不影响最终用户，因为缓存每天都会更新。</p><h2 id="4d66" class="kd ke hh bd kf kg kh ki kj kk kl km kn ip ko kp kq it kr ks kt ix ku kv kw kx bi translated">盘岛IAU柔性流</h2><p id="b704" class="pw-post-body-paragraph ie if hh ig b ih ky ij ik il kz in io ip la ir is it lb iv iw ix lc iz ja jb ha bi translated">作为早期访问计划的一部分，Pandao在应用程序中集成了IAU灵活流程(推荐实施)。IAU的对话显示在主屏幕上，因此最大数量的用户能够与之互动。最初，我们决定每天最多播放一次IAU对话，以免打扰我们的用户。</p><p id="e16f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于A/B测试是每个新功能生命周期中的关键步骤，我们决定评估IAU对Pandao应用程序的影响。我们将用户随机分为两个不重叠的组。第一个是没有IAU的对照组，代表“不变”基线，第二个是有IAU对话的试验组。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lh"><img src="../Images/7140e69bd4575afc9e78b87239312094.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7uiPYEGHS10rnVvdy2MDMA.png"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Fig. 1. Confirmation rate at IAU dialogue (flexible flow) in the Pandao app (Source: Pandao)</figcaption></figure><p id="dba5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在过去的几个版本中，我们测量了每个应用版本的活跃用户百分比。我们发现，在拥有最新可用版本的活跃用户中，大多数人属于B组，即看过IAU的用户。从图1中的紫色线条可以看出，在版本1.29.1发布后的最初几天，拥有IAU功能的活跃用户数量超过了没有该功能的用户数量。之前版本的应用程序可以观察到相反的情况——参见1.29.1版本发布后的蓝色和红色线条。根据我们的测试，IAU用户似乎倾向于更快地更新应用程序。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lm"><img src="../Images/547c0a41a231454ae2d1714b959b7bba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2tAZtofZvVhr-FHuE8JDmA.png"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Fig. 2. Confirmation rate at IAU dialogue (flexible flow) in Pandao App (Source: Pandao)</figcaption></figure><p id="a371" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">根据Pandao analytics的数据(见图2)，在IAU对话中点击确认按钮的转换在发布的第一天达到峰值，然后稳步下降，直到下一次应用更新。在单击snackbar中的install按钮的转换中可以观察到相同的模式，这将启动下载的更新的安装。因此，两种情况下的平均转换率似乎与发布频率成正比。对于盘道来说，一个月内点击确认按钮的平均转化率超过35%，点击安装按钮的平均转化率超过7%。</p><p id="8c95" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在查看数据后，我们认为确认率随着时间的推移而下降是一个用户体验问题，因为对新版本的应用程序感兴趣的人会更新得很快，而那些不感兴趣的人会继续忽略它。基于这些信息，我们决定放弃一些对更新不感兴趣的用户，而不是每天都问他们。基于“陈旧性”尝试不同的请求逻辑似乎是一个好的实践，例如，他们的版本有多旧，用户已经被要求更新多少次，等等，而不是冒着打扰我们的用户的风险。</p><p id="322f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作为我们测试的结果，IAU展示了有价值的结果，所以我们向所有用户推出了这个功能。</p><p id="e58b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">应用内更新API现在对所有开发者开放。查看<a class="ae jo" href="https://developer.android.com/guide/app-bundle/in-app-updates" rel="noopener ugc nofollow" target="_blank">文档</a>了解更多信息。</p><h2 id="17f4" class="kd ke hh bd kf kg kh ki kj kk kl km kn ip ko kp kq it kr ks kt ix ku kv kw kx bi translated">感谢</h2><p id="d2a5" class="pw-post-body-paragraph ie if hh ig b ih ky ij ik il kz in io ip la ir is it lb iv iw ix lc iz ja jb ha bi translated">我要感谢我的同事们对本文的贡献。感谢Maryna Pliashkova、Alexander Chernyy、Ilia Nazarov、Gleb Bodyachevskiy、Daniil Polozov、Anastasia Kulik、Vladislav Breus和Vladislav Goldin。</p></div></div>    
</body>
</html>