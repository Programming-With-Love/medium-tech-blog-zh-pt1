<html>
<head>
<title>How to Create Small Docker images</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何创建小型Docker图像</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/how-to-create-small-docker-images-e510b8c3c81e?source=collection_archive---------1-----------------------#2017-11-13">https://medium.com/oracledevs/how-to-create-small-docker-images-e510b8c3c81e?source=collection_archive---------1-----------------------#2017-11-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="4b94" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">说到空间效率，Docker仍然不尽如人意。Docker使用的分层文件系统有时会占用比实际需要更多的空间。随着时间的推移，Docker进行了一些改进，允许构建更节省空间的图像。例如，<code class="du jc jd je jf b"><a class="ae jg" href="https://docs.docker.com/engine/reference/builder/#add" rel="noopener ugc nofollow" target="_blank">ADD</a></code> <a class="ae jg" href="https://docs.docker.com/engine/reference/builder/#add" rel="noopener ugc nofollow" target="_blank">指令</a>足够智能，可以检测(不幸的是，只能检测)本地压缩档案(不幸的是，只能检测<code class="du jc jd je jf b">identity</code>、<code class="du jc jd je jf b">gzip</code>、<code class="du jc jd je jf b">bzip2</code>或<code class="du jc jd je jf b">xz</code>，而<strong class="ig hi">不能检测</strong>、<code class="du jc jd je jf b">zip</code>档案)，并直接将未压缩的内容添加到映像中，这与简单地将文件复制到映像中的<code class="du jc jd je jf b">COPY</code>指令不同。后者的缺点是zip存档本身和存档的提取内容占用空间，而前者不会占用存档的任何空间，因为它不会添加到映像中。</p><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="jn jo di jp bf jq"><div class="er es jh"><img src="../Images/d8711239155a0078d111622c8ea57469.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tdvjY_Kq8s-Dsphtpe4eeA.png"/></div></div></figure><h1 id="8770" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">Docker多阶段构建</h1><p id="0e05" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">在Docker 17.05-ce中，我们得到了<a class="ae jg" href="https://docs.docker.com/engine/userguide/eng-image/multistage-build/" rel="noopener ugc nofollow" target="_blank">多阶段构建</a>，例如，它允许您在中间映像中构建二进制文件，然后将所构建的二进制文件复制到另一个映像，即最终映像。这里的好处是，所有被占用的空间都来自源文件、构建工具等。永远不要把它变成最终图像，而只留在中间图像中。这对于微型容器来说非常好，并且在静态链接的单个二进制文件的Go环境中变得特别流行。然而，当在不同的地方安装软件时，多阶段构建很快就遇到了限制。常见的例子是安装常规的yum包，使其位于文件系统上许多不同的位置，创建用户和组，等等。在这种情况下，可能很快就不得不将整个文件系统，即<code class="du jc jd je jf b">/</code>，复制到最终的容器中。唯一的问题是文件所有权丢失了，也就是说，所有文件最终都归root所有。这将导致最终图像中出现额外的<code class="du jc jd je jf b">RUN</code>指令，从而导致另一层的构建和潜在的空间浪费。在我的一个小实验中可以看到一个简单的例子，在Oracle数据库安装中使用多阶段构建。在这个实验中，我完全按照上面说做了，通过下面的指令复制整个文件系统:</p><pre class="ji jj jk jl fd kw jf kx ky aw kz bi"><span id="fd75" class="la ju hh jf b fi lb lc l ld le">COPY --from=builder / /</span></pre><p id="3e07" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该指令只是将中间图像<em class="lf">生成器</em>的所有内容(<code class="du jc jd je jf b">/</code>)复制到最终图像的<code class="du jc jd je jf b">/</code>。然而，由于复制后的所有文件都归<code class="du jc jd je jf b">root</code>所有，因此需要一个额外的步骤:将<code class="du jc jd je jf b">$ORACLE_BASE</code>的所有权更改为<code class="du jc jd je jf b">oracle</code>用户，这是通过以下指令完成的:</p><pre class="ji jj jk jl fd kw jf kx ky aw kz bi"><span id="9c95" class="la ju hh jf b fi lb lc l ld le">RUN chown -R oracle:dba $ORACLE_BASE</span></pre><p id="def5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">虽然<code class="du jc jd je jf b">COPY</code>指令做了预期的事情，只是复制了成功安装后的最终结果，但不幸的是，额外的<code class="du jc jd je jf b">RUN</code>指令又给生成的映像增加了不必要的大小(见第8行):</p><pre class="ji jj jk jl fd kw jf kx ky aw kz bi"><span id="24bd" class="la ju hh jf b fi lb lc l ld le">[oracle@localhost dockerfiles]$ docker history oracle/database:12.2.0.1-ee<br/>IMAGE           CREATED          CREATED BY                                         SIZE   COMMENT<br/>0328c9d11729    4 minutes ago    /bin/sh -c #(nop) CMD ["/bin/sh" "-c" "ex...         0B<br/>3847d825c5e0    5 minutes ago    /bin/sh -c #(nop) EXPOSE 1521/tcp 5500/tcp           0B<br/>3293438499a2    5 minutes ago    /bin/sh -c #(nop) VOLUME [/opt/oracle/ora...         0B<br/>aa9294c8a9e1    5 minutes ago    /bin/sh -c #(nop) WORKDIR /home/oracle               0B<br/>2b1ce0fb41e2    5 minutes ago    /bin/sh -c #(nop) USER [oracle]                      0B<br/>a4a030e72a3d    5 minutes ago    /bin/sh -c chown -R oracle:dba $ORACLE_BASE      5.97GB<br/>5c36909d4568    6 minutes ago    /bin/sh -c #(nop) COPY dir:bf7a903b4add9a7...    6.14GB<br/>87ba2e289389    9 minutes ago    /bin/sh -c #(nop) ENV PATH=/opt/oracle/pr...         0B<br/>3f1b0c5412bf    9 minutes ago    /bin/sh -c #(nop) ENV ORACLE_BASE=/opt/or...         0B<br/>a6e9e9e5ddc1    12 days ago      /bin/sh -c #(nop) CMD ["/bin/bash"]                  0B<br/>&lt;missing&gt;       12 days ago      /bin/sh -c #(nop) ADD file:7f7d89f7bdf05fd...     118MB<br/>&lt;missing&gt;       4 weeks ago      /bin/sh -c #(nop) MAINTAINER Oracle Linux...         0B</span></pre><p id="4eaa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当然，复制整个文件系统并不一定是您想要做的，但是实验表明，不幸的是，多阶段构建仍然缺乏某些灵活性，这有望很快得到解决。然而，如果你只添加了几个或者一个文件，比如首先从源文件开始构建，多阶段构建是缩小Docker映像大小的好方法。</p><h1 id="086b" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">docker–壁球选项</h1><p id="0077" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">幸运的是，还有另一个特性可以帮助缩小Docker映像的大小:将所有文件系统层压缩成一个层。我发现这个功能仍然不为世人所知，很可能是因为它仍然是一个实验性的功能。Docker 1.13 (API 1.25)引入了<em class="lf">挤压</em>特性，当时Docker仍然遵循不同的版本控制方案。如前所述，直到今天，17.06-ce仍被归类为<em class="lf">实验性</em>，这当然带有警告。虽然我从未遇到过任何关于<code class="du jc jd je jf b">--squash</code>选项的问题，但在早期，偶尔破坏图像是众所周知的。如前所述，我在最近的版本中再也没有遇到过这种情况，但是你知道，请注意，它仍然被归类为<strong class="ig hi"><em class="lf"/></strong>。</p><h1 id="251e" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">启用实验功能</h1><p id="d2b5" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">为了使用Docker中的实验特性，你首先必须<a class="ae jg" href="https://github.com/docker/docker-ce/blob/master/components/cli/experimental/README.md" rel="noopener ugc nofollow" target="_blank">打开那些实验特性</a>，这意味着你必须将<code class="du jc jd je jf b">--experimental</code>标志传递给Docker守护进程。这对于Mac上的Docker来说相当容易，只需进入<em class="lf">偏好设置- &gt;守护进程</em>并勾选<em class="lf">实验特性</em>复选框。<em class="lf">应用&amp;重启</em>完成剩下的技巧。然而在Linux上，你必须自己修改<code class="du jc jd je jf b">/etc/docker/daemon.json</code>并包含<code class="du jc jd je jf b">"experimental": true</code>(重要的是，<code class="du jc jd je jf b">true</code>没有引号！).这样，我的文件如下所示:</p><pre class="ji jj jk jl fd kw jf kx ky aw kz bi"><span id="82e8" class="la ju hh jf b fi lb lc l ld le">[root@localhost ~]$ cat /etc/docker/daemon.json<br/>{<br/>  "experimental": true,<br/>  "storage-driver": "btrfs"<br/>}</span></pre><p id="b95d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">重启Docker守护进程后，当运行<code class="du jc jd je jf b">docker info</code>时，你会发现下面的行<code class="du jc jd je jf b">Experimental: true</code>(见第41行):</p><pre class="ji jj jk jl fd kw jf kx ky aw kz bi"><span id="b666" class="la ju hh jf b fi lb lc l ld le">[root@localhost ~]$ systemctl restart docker<br/>[root@localhost ~]$ docker info<br/>Containers: 2<br/>Running: 0<br/>Paused: 0<br/>Stopped: 2<br/>Images: 3<br/>Server Version: 17.06.2-ol<br/>Storage Driver: btrfs<br/>Build Version: Btrfs v4.9.1<br/>Library Version: 102<br/>Logging Driver: json-file<br/>Cgroup Driver: cgroupfs<br/>Plugins:<br/>Volume: local<br/>Network: bridge host ipvlan macvlan null overlay<br/>Log: awslogs fluentd gcplogs gelf journald json-file logentries splunk syslog<br/>Swarm: inactive<br/>Runtimes: runc<br/>Default Runtime: runc<br/>Init Binary: docker-init<br/>containerd version: 6e23458c129b551d5c9871e5174f6b1b7f6d1170<br/>runc version: 810190ceaa507aa2727d7ae6f4790c76ec150bd2<br/>init version: 949e6fa<br/>Security Options:<br/>seccomp<br/>Profile: default<br/>selinux<br/>Kernel Version: 4.1.12-94.3.8.el7uek.x86_64<br/>Operating System: Oracle Linux Server 7.3<br/>OSType: linux<br/>Architecture: x86_64<br/>CPUs: 2<br/>Total Memory: 7.795GiB<br/>Name: localhost.localdomain<br/>ID: GZ5A:XQWB:F5TE:56JE:GR3J:VCXJ:I7BO:EGMY:K52K:JAS3:A7ZC:BOHQ<br/>Docker Root Dir: /var/lib/docker<br/>Debug Mode (client): false<br/>Debug Mode (server): false<br/>Registry: <a class="ae jg" href="https://index.docker.io/v1/" rel="noopener ugc nofollow" target="_blank">https://index.docker.io/v1/</a><br/>Experimental: true<br/>Insecure Registries:<br/>127.0.0.0/8<br/>Live Restore Enabled: false</span></pre><p id="cc75" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在你可以使用<code class="du jc jd je jf b">--squash</code>选项了。您也可以通过执行<code class="du jc jd je jf b">docker build --squash .</code>来验证这一点。如果实验功能未打开，您将收到:</p><pre class="ji jj jk jl fd kw jf kx ky aw kz bi"><span id="1dd1" class="la ju hh jf b fi lb lc l ld le">[root@localhost ~]$ docker build --squash .<br/>"--squash" is only supported on a Docker daemon with experimental features enabled</span></pre><p id="0168" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">另一方面，如果打开了实验特性，您将克服这个错误，并让Docker抱怨没有Docker文件来启动构建:</p><pre class="ji jj jk jl fd kw jf kx ky aw kz bi"><span id="ac60" class="la ju hh jf b fi lb lc l ld le">[root@localhost ~]$ docker build --squash .<br/>unable to prepare context: unable to evaluate symlinks in Dockerfile path: lstat /root/Dockerfile: no such file or directory</span></pre><h1 id="f62e" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">使用–squash选项构建Oracle数据库Docker映像</h1><p id="25e4" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">如果没有<code class="du jc jd je jf b">--squash</code>选项，现在一个Oracle数据库企业版Docker映像的大小超过13 GB:</p><pre class="ji jj jk jl fd kw jf kx ky aw kz bi"><span id="7e94" class="la ju hh jf b fi lb lc l ld le">[oracle@localhost dockerfiles]$ docker images<br/>REPOSITORY           TAG              IMAGE ID          CREATED               SIZE<br/>oracle/database      12.2.0.1-ee      1b5ed2b790a7      20 seconds ago      13.2GB<br/>oraclelinux          7-slim           a6e9e9e5ddc1      3 weeks ago          118MB</span></pre><p id="244e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">仔细查看该映像时，会发现由于该映像不再需要分层文件系统而浪费了大量空间:</p><pre class="ji jj jk jl fd kw jf kx ky aw kz bi"><span id="43f8" class="la ju hh jf b fi lb lc l ld le">[oracle@localhost dockerfiles]$ docker history 1b5ed2b790a7<br/>IMAGE             CREATED             CREATED BY                                           SIZE      COMMENT<br/>1b5ed2b790a7      31 minutes ago      /bin/sh -c #(nop) CMD ["/bin/sh" "-c" "ex...           0B<br/>3253c4b724eb      31 minutes ago      /bin/sh -c #(nop) EXPOSE 1521/tcp 5500/tcp             0B<br/>3a2ce9bac206      31 minutes ago      /bin/sh -c #(nop) VOLUME [/opt/oracle/ora...           0B<br/>b7576a4a19e1      31 minutes ago      /bin/sh -c #(nop) WORKDIR /home/oracle                 0B<br/>4597cb7d8aea      31 minutes ago      /bin/sh -c #(nop) USER [oracle]                        0B<br/>fbf4e1b3363d      31 minutes ago      |0 /bin/sh -c $ORACLE_BASE/oraInventory/or...      11.2MB<br/>07acc091e808      31 minutes ago      /bin/sh -c #(nop) USER [root]                          0B<br/>f8b524f5a3f2      31 minutes ago      |0 /bin/sh -c $INSTALL_DIR/$INSTALL_DB_BIN...      5.97GB<br/>6bc32fcfcbaf      37 minutes ago      /bin/sh -c #(nop) USER [oracle]                        0B<br/>75de01f58755      37 minutes ago      |0 /bin/sh -c chmod ug+x $INSTALL_DIR/*.sh...      3.62GB<br/>8cbd3c82fbbe      40 minutes ago      /bin/sh -c #(nop) COPY multi:9d11dcad11365...        22kB<br/>2aeeab9ba02d      40 minutes ago      /bin/sh -c #(nop) COPY multi:10a3dd36c140a...      3.45GB<br/>6c4c8a19d3a7      41 minutes ago      /bin/sh -c #(nop) ENV INSTALL_DIR=/opt/or...           0B<br/>1169e05f0f02      41 minutes ago      /bin/sh -c #(nop) ENV ORACLE_BASE=/opt/or...           0B<br/>7f19c2d035db      41 minutes ago      /bin/sh -c #(nop) MAINTAINER Gerald Venzl...           0B<br/>a6e9e9e5ddc1      3 weeks ago         /bin/sh -c #(nop) CMD ["/bin/bash"]                    0B<br/>&lt;missing&gt;         3 weeks ago         /bin/sh -c #(nop) ADD file:7f7d89f7bdf05fd...       118MB<br/>&lt;missing&gt;         5 weeks ago         /bin/sh -c #(nop) MAINTAINER Oracle Linux...           0B</span></pre><p id="8aa4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第12行和第14行中的层是通过将安装程序文件复制到映像中，解压缩它们，然后运行安装程序所占用的空间。第8行中的层也占用了不必要的空间，因为这一步所做的只是对一些文件设置权限。</p><p id="2463" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于支持将文件系统层压缩成一个层，<a class="ae jg" href="https://github.com/oracle/docker-images" rel="noopener ugc nofollow" target="_blank"> Oracle数据库Docker映像</a> <a class="ae jg" href="https://github.com/oracle/docker-images/blob/master/OracleDatabase/dockerfiles/buildDockerImage.sh" rel="noopener ugc nofollow" target="_blank">构建脚本</a>也得到了增强，允许通过<code class="du jc jd je jf b">-o</code>将<code class="du jc jd je jf b">--squash</code>等选项传递给Docker守护进程。为了为Oracle数据库构建一个压缩的Docker映像，只需将<code class="du jc jd je jf b">-o --squash</code>添加到构建脚本中。参见<a class="ae jg" href="https://geraldonit.com/2017/08/21/creating-an-oracle-database-docker-image/" rel="noopener ugc nofollow" target="_blank">创建Oracle数据库Docker映像</a>了解映像构建本身的更多细节！</p><pre class="ji jj jk jl fd kw jf kx ky aw kz bi"><span id="6528" class="la ju hh jf b fi lb lc l ld le">[oracle@localhost dockerfiles]$ ./buildDockerImage.sh -e -o --squash<br/>Checking if required packages are present and valid...<br/>linuxx64_12201_database.zip: OK<br/>==========================<br/>DOCKER info:<br/>Containers: 0<br/> Running: 0<br/> Paused: 0<br/> Stopped: 0<br/>Images: 16<br/>Server Version: 17.06.2-ol<br/>Storage Driver: btrfs<br/> Build Version: Btrfs v4.9.1<br/> Library Version: 102<br/>Logging Driver: json-file<br/>Cgroup Driver: cgroupfs<br/>Plugins:<br/> Volume: local<br/> Network: bridge host ipvlan macvlan null overlay<br/> Log: awslogs fluentd gcplogs gelf journald json-file logentries splunk syslog<br/>Swarm: inactive<br/>Runtimes: runc<br/>Default Runtime: runc<br/>Init Binary: docker-init<br/>containerd version: 6e23458c129b551d5c9871e5174f6b1b7f6d1170<br/>runc version: 810190ceaa507aa2727d7ae6f4790c76ec150bd2<br/>init version: 949e6fa<br/>Security Options:<br/> seccomp<br/>  Profile: default<br/> selinux<br/>Kernel Version: 4.1.12-94.3.8.el7uek.x86_64<br/>Operating System: Oracle Linux Server 7.3<br/>OSType: linux<br/>Architecture: x86_64<br/>CPUs: 2<br/>Total Memory: 7.795GiB<br/>Name: localhost.localdomain<br/>ID: GZ5A:XQWB:F5TE:56JE:GR3J:VCXJ:I7BO:EGMY:K52K:JAS3:A7ZC:BOHQ<br/>Docker Root Dir: /var/lib/docker<br/>Debug Mode (client): false<br/>Debug Mode (server): false<br/>Registry: <a class="ae jg" href="https://index.docker.io/v1/" rel="noopener ugc nofollow" target="_blank">https://index.docker.io/v1/</a><br/>Experimental: true<br/>Insecure Registries:<br/> 127.0.0.0/8<br/>Live Restore Enabled: false<br/> <br/>==========================<br/>Proxy settings were found and will be used during the build.<br/>Building image 'oracle/database:12.2.0.1-ee' ...<br/>Sending build context to Docker daemon  3.454GB<br/>Step 1/16 : FROM oraclelinux:7-slim<br/> ---&gt; a6e9e9e5ddc1<br/>Step 2/16 : MAINTAINER Gerald Venzl &lt;<a class="ae jg" href="mailto:gerald.venzl@oracle.com" rel="noopener ugc nofollow" target="_blank">gerald.venzl@oracle.com</a>&gt;<br/> ---&gt; Running in 731e99b1252f<br/> ---&gt; 3e5ee1e8dcd5<br/>Removing intermediate container 731e99b1252f<br/>Step 3/16 : ENV ORACLE_BASE /opt/oracle ORACLE_HOME /opt/oracle/product/12.2.0.1/dbhome_1 INSTALL_FILE_1 "linuxx64_12201_database.zip" INSTALL_RSP "db_inst.rsp" CONFIG_RSP "dbca.rsp.tmpl" PWD_FILE "setPassword.sh" RUN_FILE "runOracle.sh" START_FILE "startDB.sh" CREATE_DB_FILE "createDB.sh" SETUP_LINUX_FILE "setupLinuxEnv.sh" CHECK_SPACE_FILE "checkSpace.sh" CHECK_DB_FILE "checkDBStatus.sh" USER_SCRIPTS_FILE "runUserScripts.sh" INSTALL_DB_BINARIES_FILE "installDBBinaries.sh"<br/> ---&gt; Running in 55ec8a41dcf5<br/> ---&gt; 89d92f9f8c18<br/>Removing intermediate container 55ec8a41dcf5<br/>Step 4/16 : ENV INSTALL_DIR $ORACLE_BASE/install PATH $ORACLE_HOME/bin:$ORACLE_HOME/OPatch/:/usr/sbin:$PATH LD_LIBRARY_PATH $ORACLE_HOME/lib:/usr/lib CLASSPATH $ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib<br/> ---&gt; Running in ba918281f786<br/> ---&gt; 71abe664d3eb<br/>Removing intermediate container ba918281f786<br/>Step 5/16 : COPY $INSTALL_FILE_1 $INSTALL_RSP $SETUP_LINUX_FILE $CHECK_SPACE_FILE $INSTALL_DB_BINARIES_FILE $INSTALL_DIR/<br/> ---&gt; ee1bfa84da00<br/>Removing intermediate container 8859d54f9f64<br/>Step 6/16 : COPY $RUN_FILE $START_FILE $CREATE_DB_FILE $CONFIG_RSP $PWD_FILE $CHECK_DB_FILE $USER_SCRIPTS_FILE $ORACLE_BASE/<br/> ---&gt; 617a3fef9ab7<br/>Removing intermediate container 7e87f0a3842a<br/>Step 7/16 : RUN chmod ug+x $INSTALL_DIR/*.sh &amp;&amp;     sync &amp;&amp;     $INSTALL_DIR/$CHECK_SPACE_FILE &amp;&amp;     $INSTALL_DIR/$SETUP_LINUX_FILE<br/> ---&gt; Running in dbf12b6b3eb2<br/>...<br/>...<br/>...<br/>...<br/>...<br/>Removing intermediate container 44e7c6d85022<br/>Step 10/16 : USER root<br/> ---&gt; Running in 4de8eb80cf7c<br/> ---&gt; 3024886cc1e9<br/>Removing intermediate container 4de8eb80cf7c<br/>Step 11/16 : RUN $ORACLE_BASE/oraInventory/orainstRoot.sh &amp;&amp;     $ORACLE_HOME/root.sh &amp;&amp;     rm -rf $INSTALL_DIR<br/> ---&gt; Running in 778aa6699b31<br/>Changing permissions of /opt/oracle/oraInventory.<br/>Adding read,write permissions for group.<br/>Removing read,write,execute permissions for world.<br/> <br/>Changing groupname of /opt/oracle/oraInventory to dba.<br/>The execution of the script is complete.<br/>Check /opt/oracle/product/12.2.0.1/dbhome_1/install/root_778aa6699b31_2017-10-24_22-16-14-688141805.log for the output of root script<br/> ---&gt; c957e036f82e<br/>Removing intermediate container 778aa6699b31<br/>Step 12/16 : USER oracle<br/> ---&gt; Running in feca45328a95<br/> ---&gt; 324e1973d1af<br/>Removing intermediate container feca45328a95<br/>Step 13/16 : WORKDIR /home/oracle<br/> ---&gt; a47ca371ba2d<br/>Removing intermediate container 48750bbc31bb<br/>Step 14/16 : VOLUME $ORACLE_BASE/oradata<br/> ---&gt; Running in 14f2be4454fb<br/> ---&gt; 1147c64ecb83<br/>Removing intermediate container 14f2be4454fb<br/>Step 15/16 : EXPOSE 1521 5500<br/> ---&gt; Running in d4936aba18df<br/> ---&gt; 6424494c777a<br/>Removing intermediate container d4936aba18df<br/>Step 16/16 : CMD exec $ORACLE_BASE/$RUN_FILE<br/> ---&gt; Running in 502a55257d11<br/> ---&gt; dee493e2ff89<br/>Removing intermediate container 502a55257d11<br/>Successfully built 758fd037bf24<br/>Successfully tagged oracle/database:12.2.0.1-ee<br/> <br/>  Oracle Database Docker Image for 'ee' version 12.2.0.1 is ready to be extended:<br/> <br/>    --&gt; oracle/database:12.2.0.1-ee<br/> <br/>  Build completed in 780 seconds.</span></pre><p id="97a4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您可能会发现图像构建本身现在需要更长的时间。这是因为<code class="du jc jd je jf b">--squash</code>功能是如何工作的。首先，它构建常规映像，然后Docker创建一个新映像，其中包含所有文件系统层。结果是两个图像，一个被挤压的图像被相应地标记，另一个未标记的图像是原始图像。<strong class="ig hi">请注意，这也意味着为了使用</strong> <code class="du jc jd je jf b"><strong class="ig hi">--squash</strong></code> <strong class="ig hi">特性，您的映像构建系统上必须有额外的可用空间！</strong></p><pre class="ji jj jk jl fd kw jf kx ky aw kz bi"><span id="a74c" class="la ju hh jf b fi lb lc l ld le">[oracle@localhost dockerfiles]$ docker images<br/>REPOSITORY      TAG              IMAGE ID          CREATED               SIZE<br/>oracle/database 12.2.0.1-ee      758fd037bf24      12 minutes ago      6.26GB<br/>&lt;none&gt;          &lt;none&gt;           dee493e2ff89      14 minutes ago      13.2GB<br/>oraclelinux     7-slim           a6e9e9e5ddc1      3 weeks ago          118MB</span></pre><p id="d440" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">未标记的图像与之前的大小完全相同，为13.2 GB，并且它在所有方面都与您之前拥有的原始图像完全相同，所有层和这些层中的空间都被占用。然而，第二个是压缩的图像，大小只有6.26 GB，这是图像中所有文件占用的实际空间。这其实挺神奇的。只需使用<code class="du jc jd je jf b">--squash</code>功能，图像尺寸就变成了原来的一半！当然，每张图片的里程数可能会有所不同，这取决于图片中浪费了多少空间。</p><p id="622a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">查看新的图像历史记录，您会发现与以前有所不同:</p><pre class="ji jj jk jl fd kw jf kx ky aw kz bi"><span id="6938" class="la ju hh jf b fi lb lc l ld le">[oracle@localhost dockerfiles]$ docker history oracle/database:12.2.0.1-ee<br/>IMAGE             CREATED             CREATED BY                                          SIZE      COMMENT<br/>758fd037bf24      14 minutes ago                                                        6.14GB      merge sha256:dee493e2ff89ac1317be5eeed80dfae6f9140be968a1a866c14b0998cbec2d95 to sha256:a6e9e9e5ddc1bdf50d64027c18cd27918c439797925ff16c97feaeee49b22ac2<br/>&lt;missing&gt;         16 minutes ago      /bin/sh -c #(nop) CMD ["/bin/sh" "-c" "ex...          0B<br/>&lt;missing&gt;         16 minutes ago      /bin/sh -c #(nop) EXPOSE 1521/tcp 5500/tcp            0B<br/>&lt;missing&gt;         16 minutes ago      /bin/sh -c #(nop) VOLUME [/opt/oracle/ora...          0B<br/>&lt;missing&gt;         16 minutes ago      /bin/sh -c #(nop) WORKDIR /home/oracle                0B<br/>&lt;missing&gt;         16 minutes ago      /bin/sh -c #(nop) USER [oracle]                       0B<br/>&lt;missing&gt;         16 minutes ago      |0 /bin/sh -c $ORACLE_BASE/oraInventory/or...         0B<br/>&lt;missing&gt;         16 minutes ago      /bin/sh -c #(nop) USER [root]                         0B<br/>&lt;missing&gt;         16 minutes ago      |0 /bin/sh -c $INSTALL_DIR/$INSTALL_DB_BIN...         0B<br/>&lt;missing&gt;         22 minutes ago      /bin/sh -c #(nop) USER [oracle]                       0B<br/>&lt;missing&gt;         22 minutes ago      |0 /bin/sh -c chmod ug+x $INSTALL_DIR/*.sh...         0B<br/>&lt;missing&gt;         25 minutes ago      /bin/sh -c #(nop) COPY multi:9d11dcad11365...         0B<br/>&lt;missing&gt;         25 minutes ago      /bin/sh -c #(nop) COPY multi:10a3dd36c140a...         0B<br/>&lt;missing&gt;         26 minutes ago      /bin/sh -c #(nop) ENV INSTALL_DIR=/opt/or...          0B<br/>&lt;missing&gt;         26 minutes ago      /bin/sh -c #(nop) ENV ORACLE_BASE=/opt/or...          0B<br/>&lt;missing&gt;         26 minutes ago      /bin/sh -c #(nop) MAINTAINER Gerald Venzl...          0B<br/>&lt;missing&gt;         3 weeks ago         /bin/sh -c #(nop) CMD ["/bin/bash"]                   0B<br/>&lt;missing&gt;         3 weeks ago         /bin/sh -c #(nop) ADD file:7f7d89f7bdf05fd...      118MB</span></pre><p id="8acb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">只剩下两层占据空间。第一个(第20行)是大小为118 MB的基本映像(在<code class="du jc jd je jf b">FROM</code>指令中使用的映像)，第二个(第3行)是已安装的6.14 GB的Oracle数据库。注意它旁边的注释说“<em class="lf">合并sha256:… 【T3”)，表明这个层是两个散列之间的所有层的合并层，基本上是第4行和第18行之间的所有层。</em></p><p id="68f4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作为最后一步，您现在可以愉快地删除未标记的图像，因为您不再需要它了:</p><pre class="ji jj jk jl fd kw jf kx ky aw kz bi"><span id="b0a9" class="la ju hh jf b fi lb lc l ld le">[oracle@localhost dockerfiles]$ docker images<br/>REPOSITORY        TAG              IMAGE ID          CREATED            SIZE<br/>oracle/database   12.2.0.1-ee      758fd037bf24      2 hours ago      6.26GB<br/>&lt;none&gt;            &lt;none&gt;           dee493e2ff89      2 hours ago      13.2GB<br/>oraclelinux       7-slim           a6e9e9e5ddc1      3 weeks ago       118MB<br/>[oracle@localhost dockerfiles]$ docker rmi dee493e2ff89<br/>Deleted: sha256:dee493e2ff89ac1317be5eeed80dfae6f9140be968a1a866c14b0998cbec2d95<br/>Deleted: sha256:6424494c777a0b816cebc1255956618398b04d9fb170d23be6cd515832bfdbd9<br/>Deleted: sha256:1147c64ecb83ad9d5ba16c7aec6aad1f967119e7bf64b7efd73bd61d4dd4bca9<br/>Deleted: sha256:a47ca371ba2da6738dec94a7cb9ea5eb06e6d28d86e84ed490bc3a5ad3a047e1<br/>Deleted: sha256:324e1973d1afa1ec595f080c8dfbe5e5744f629a77e04f1bfaf49419a55560de<br/>Deleted: sha256:c957e036f82e969eeed2c10706809263218a571c4a98f42a2173fa9a9da1314c<br/>Deleted: sha256:c0a4621f29f2dd5504648ab6a7d0714bb2c3978931a13dc84bb409653d4a1dfc<br/>Deleted: sha256:3024886cc1e99900e3e98b4f400f5b196a572ddf0c108747cabc21306126917a<br/>Deleted: sha256:25d34b0e9f1f06231d3618a64d71d628814051e3fa6dd6efe50df5cc86c7e561<br/>Deleted: sha256:f96299b83d8e22833550edc5e429d996c77a2955713d0398d499fa470a3d785b<br/>Deleted: sha256:7d882e4cc07ee35d929ef6b674d097dd4781daa19c4492680248e7210bdd84a6<br/>Deleted: sha256:f032bb97ce431a38d6c8e5a9e9e747646f9b17f338a21d2ba3f96bf5ce625e69<br/>Deleted: sha256:58b0605016d39083971e8184dced3aa9a8b0d6399f05fe6a0c8371354f7fc371<br/>Deleted: sha256:617a3fef9ab7df8414317fc60f6fae1bdb396816429431e9e1537cf3979947a7<br/>Deleted: sha256:cc1756dd643713e8d723b4c52ff92ebb6873b94a64d5ae1f84e39f08d7e0284c<br/>Deleted: sha256:ee1bfa84da00e49c8117f3abc5e932003d224c921ae2311126a084188f2934c6<br/>Deleted: sha256:09ac53e179b7c9924d79fd7483570230d18742a1355c44240ab4c08768a2dd2a<br/>Deleted: sha256:71abe664d3eba13768568804098740dfe369346716f5cea90ee60bfdba2ca305<br/>Deleted: sha256:89d92f9f8c18a13ea1b89b5d0856618c200d82ac7cca5002f02c1bd23059a91f<br/>Deleted: sha256:3e5ee1e8dcd592e836ac629ed61bb0bf2dc616bef5d5162f098216539ce00657<br/>[oracle@localhost dockerfiles]$ docker images<br/>REPOSITORY        TAG              IMAGE ID          CREATED            SIZE<br/>oracle/database   12.2.0.1-ee      758fd037bf24      2 hours ago      6.26GB<br/>oraclelinux       7-slim           a6e9e9e5ddc1      3 weeks ago       118MB</span></pre><h1 id="ece3" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">结论</h1><p id="4598" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">有几种不同的方法可以让你缩小Docker图片的尺寸。它们都有优点和缺点。实验性的<code class="du jc jd je jf b">--squash</code>功能通过将所有图层压缩成一个图层，可以轻松地将图像缩小到图像中文件所需的实际大小。但是，请记住，这项功能仍处于<em class="lf">试验</em>状态，将来可能会消失。</p></div><div class="ab cl lg lh go li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ha hb hc hd he"><p id="83e1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lf">原载于2017年11月13日</em><a class="ae jg" href="https://geraldonit.com/2017/11/13/how-to-create-small-docker-images/" rel="noopener ugc nofollow" target="_blank"><em class="lf">geraldonit.com</em></a><em class="lf">。</em></p></div></div>    
</body>
</html>