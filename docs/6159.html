<html>
<head>
<title>Building Pincodes, scannable codes for Pinterest boards &amp; profiles</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为Pinterest板和个人资料构建密码、可扫描代码</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/building-pincodes-scannable-codes-for-pinterest-boards-profiles-fa4f43cf8ff0?source=collection_archive---------3-----------------------#2017-11-14">https://medium.com/pinterest-engineering/building-pincodes-scannable-codes-for-pinterest-boards-profiles-fa4f43cf8ff0?source=collection_archive---------3-----------------------#2017-11-14</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="7c09" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">张佳维| Pinterest工程师，搜索</p><p id="d439" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">今年早些时候，我们<a class="ae jc" href="https://blog.pinterest.com/en/search-outside-box-new-pinterest-visual-discovery-tools" rel="noopener ugc nofollow" target="_blank">推出了相机搜索</a>,以帮助Pinners找到想法，尝试使用他们在现实世界中看到的东西进行搜索——无论是用当季新农产品制作的食谱还是与特定图案匹配的服装。今天，随着<a class="ae jc" href="https://blog.pinterest.com/en/introducing-pincodes-discover-ideas-brands-and-publishers" rel="noopener ugc nofollow" target="_blank"> Pincodes </a>的发布，我们在将真实世界与Pinterest上的想法联系起来方面又迈出了一步。</p><p id="35b0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pincodes是自定义代码，您可以通过扫描来发现品牌和出版商策划的创意和产品。当你看到一个密码时，只需在Pinterest应用程序中点击相机图标，然后指向该代码，就可以直接跳转到一个公告板或个人资料。有了Pincodes，品牌可以使用任何纸板或简介，生成一个独特的代码，在商店、包装、杂志、广告等任何地方分享。</p><p id="a556" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本帖中，我们将分享我们如何与<a class="ae jc" href="https://quikklycodes.com/" rel="noopener ugc nofollow" target="_blank"> Quikkly </a>合作构建和实现Pincodes，Quikkly 以SDK的形式为应用开发者开发定制的可扫描代码解决方案。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/87209b77ddf8bf808f0a11a61fb7a401.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gysZHQShWEmACaStp4QDyQ.jpeg"/></div></div></figure><h2 id="0837" class="jp jq hh bd jr js jt ju jv jw jx jy jz ip ka kb kc it kd ke kf ix kg kh ki kj bi translated">编码密码</h2><p id="0b79" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">在Pinterest，我们使用唯一的对象ID来识别公告板和Pinner个人资料。给定Pinner或board的对象ID和一个英雄图像，Quikkly库生成一个由三种可能大小的50个点组成的密码。这些点大小提供了log₂(3⁵⁰的最大数据容量)—大约79位，其中64位用于对象ID，其余用于数据完整性。这些点被排列成等间距的组，这些组通知扫描仪圆上的50个点属于一个密码。</p><p id="029a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">点的大小和组织是仅用于为密码编码数据的两个视觉属性。圆点的颜色是为了美观(在编码过程中不使用)。事实上，即使是黑白打印，密码也能工作。</p><h2 id="3aa2" class="jp jq hh bd jr js jt ju jv jw jx jy jz ip ka kb kc it kd ke kf ix kg kh ki kj bi translated">扫描密码</h2><p id="b226" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">智能手机相机拍摄的照片通常很大且有噪音，因此需要在解码前进行归一化处理。Quikkly库首先缩小图像，使它们小到足以有效处理，但又大到足以让扫描仪识别最小的点。为了消除噪声，应用了一个过滤器来消除弱光下的颗粒，并消除任何视觉伪像，如相机在屏幕照片中捕捉的条纹。在解决了大小和噪声之后，扫描仪从图像中的高对比度边缘找到点及其位置，并从这些图案构建数据对象。这些包含对象ID的数据对象随后被解码，并用于导航到与对象ID相关联的电路板或引脚。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kp"><img src="../Images/83be3247322e3d48b1c82a82e437ab89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*UBpv2ux4LRQIzc7Gh1-u9g.gif"/></div></div></figure><p id="8e0e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Quikkly在扫描中面临的最大挑战之一是精确测量点。圆点的大小取决于相机的视角、角度和焦点。Quikkly没有使用Reed-Solomon之类的标准纠错算法，而是使用概率解码给每个点一个属于大小桶(小/中/大)的概率<em class="kq">，而不是测量每个点在</em>这些桶之一中的<em class="kq">。有了这个，扫描仪可以考虑它不确定的点的多种潜在尺寸。</em></p><h2 id="1f43" class="jp jq hh bd jr js jt ju jv jw jx jy jz ip ka kb kc it kd ke kf ix kg kh ki kj bi translated">在Android上集成密码扫描</h2><p id="0693" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">在Android客户端中，我们为本机相机设置了一个<code class="du kr ks kt ku b">PreviewCallback</code>，只要预览处于活动状态，它就会在每个预览帧上被调用。在包含摄像机的片段中，我们声明了一个<code class="du kr ks kt ku b">PreviewListener</code>(由Quikkly提供)并将其交给我们的<code class="du kr ks kt ku b">CameraPreview</code>，这个类扩展了引用摄像机的<code class="du kr ks kt ku b">SurfaceView</code>和一个<code class="du kr ks kt ku b">SurfaceHolder</code>。然后我们在<code class="du kr ks kt ku b">PreviewCallback</code>中覆盖<code class="du kr ks kt ku b">onPreviewFrame(byte[] data, Camera camera)</code>方法来调用<code class="du kr ks kt ku b">PreviewListener</code>并通过Quikkly的扫描库向片段传递一个对象ID。一旦我们收到片段中的对象ID，我们就对其进行解码，以决定是否导航到一个概要文件或电路板。</p><h2 id="d34f" class="jp jq hh bd jr js jt ju jv jw jx jy jz ip ka kb kc it kd ke kf ix kg kh ki kj bi translated">解码对象ID并导航:</h2><p id="2636" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">我们使用对象ID(标识插针、电路板等。)对密码进行编码，因为限制存储在每个密码中的数据量允许代码设计中有更大的灵活性。类型(Pinner、board等。)是在对象ID本身中编码的，因此在解码时，客户端只需执行按位操作来检测它是否应该导航到电路板或profile。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="kv kw l"/></div></figure><h2 id="7bab" class="jp jq hh bd jr js jt ju jv jw jx jy jz ip ka kb kc it kd ke kf ix kg kh ki kj bi translated">在iOS和Android上导出大型密码图像</h2><p id="2fec" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">因为密码是要打印的，所以密码的导出图像和我们的行动号召标题必须是高分辨率的。我们使用Pincode中的可缩放矢量图形(SVG ),而不是调整从Pincode生成中收到的位图的大小。这些SVG是XML表示的矢量图像，可以在不损失图像质量的情况下轻松缩放。我们首先将Pincode生成的SVG和我们定制的行动号召SVG缩放成大位图。然后，我们将这两个位图合并成一个位图，可以保存到手机的相机胶卷中或打印出来。</p><h2 id="7de8" class="jp jq hh bd jr js jt ju jv jw jx jy jz ip ka kb kc it kd ke kf ix kg kh ki kj bi translated">在网络上将密码图像和CTA文本生成为PNG文件</h2><p id="3cdd" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">为了能够在网络上生成密码图像，我们添加了一个后端API，集成了<a class="ae jc" href="https://pypi.python.org/pypi/quikkly-python-sdk" rel="noopener ugc nofollow" target="_blank"> Quikkly python SDK </a>。然后，前端从后端API检索SVG字符串，并将其与我们定制的行动号召SVG内联。下载密码后，我们将生成的密码SVG和自定义的行动号召SVG组合成一个大位图(png文件)。以下是详细的步骤:</p><ol class=""><li id="a626" class="kx ky hh ig b ih ii il im ip kz it la ix lb jb lc ld le lf bi translated">克隆两个SVG节点:父节点的<code class="du kr ks kt ku b">innerHTML</code></li><li id="fb12" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated">对于生成的Pincode SVG图像中的英雄图像，通过其URL获取图像的二进制文件，对其进行base64编码，然后将其内联到<a class="ae jc" href="https://en.wikipedia.org/wiki/Data_URI_scheme" rel="noopener ugc nofollow" target="_blank">数据URI </a>中。</li><li id="5da2" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated">使用数据URI中的SVG内容将每个SVG元素转换为图像元素。</li><li id="f0b6" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated">等待直到两个SVG图像都被解析</li><li id="dff8" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated">创建一个具有所需导出大小的画布，并将密码和行动号召图像绘制到画布上</li><li id="3027" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated">将画布数据转换为数据URL(<a class="ae jc" href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement/toDataURL" rel="noopener ugc nofollow" target="_blank">today ataul</a>)</li><li id="9bd5" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated">将数据URL转换为Blob，然后转换为对象/blob URL。这一步是必要的，因为数据URI方案是为小值设计的，不适用于大数据(见<a class="ae jc" href="https://stackoverflow.com/a/41755526/4056191" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/a/41755526/4056191</a>)。</li><li id="d73a" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated">创建一个将src设置为对象URL的锚元素，然后触发一个click事件</li><li id="b225" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated">拆除锚元素和对象URL</li></ol><p id="b4a9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">今天，我们将与Pinners喜爱的合作伙伴一起推出Pincodes，包括Nordstrom、Kia、<em class="kq"> REAL SIMPLE </em>、Home Depot和Kraft Heinz，还将推出更多产品。在这个假日购物季节，请密切注意假冒商品！</p><p id="3534" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kq">鸣谢:</em>特别感谢Pinterest的工程师Kelei Xu、Mustafa Motiwala、Jack Hsu、Steven Ramkumar和Jeffrey Harris以及<a class="ae jc" href="https://quikklycodes.com/" rel="noopener ugc nofollow" target="_blank"> Quikkly </a>。</p><h2 id="3e12" class="jp jq hh bd jr js jt ju jv jw jx jy jz ip ka kb kc it kd ke kf ix kg kh ki kj bi translated">来源</h2><p id="e4d5" class="pw-post-body-paragraph ie if hh ig b ih kk ij ik il kl in io ip km ir is it kn iv iw ix ko iz ja jb ha bi translated">quikkly<br/><a class="ae jc" href="https://developer.android.com/reference/android/hardware/Camera.html" rel="noopener ugc nofollow" target="_blank">https://developer . Android . com/reference/Android/hardware/camera . html</a><br/><a class="ae jc" href="https://github.com/quikkly/" rel="noopener ugc nofollow" target="_blank">https://github.com/quikkly/</a></p></div></div>    
</body>
</html>