<html>
<head>
<title>Hot swapping code in Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android中的热插拔代码</h1>
<blockquote>原文：<a href="https://medium.com/quick-code/hot-swapping-code-in-android-3043ccf6dd9b?source=collection_archive---------3-----------------------#2018-02-04">https://medium.com/quick-code/hot-swapping-code-in-android-3043ccf6dd9b?source=collection_archive---------3-----------------------#2018-02-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="462b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我最近一直在寻找静默更新正在运行的Android应用程序的方法。</p><p id="c11b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我发现的一个选项是使用类加载器在运行时加载字节码。这实际上并不太难，我将与你分享一个简单的方法来做到这一点。</p><p id="a1ac" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你可以在这里找到一个例子:<a class="ae jc" href="https://github.com/davethomas11/AndroidHotSwapCodeExample" rel="noopener ugc nofollow" target="_blank">github.com/davethomas11/AndroidHotSwapCodeExample</a></p><p id="f442" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Android平台上，我们可以利用一个特定的类加载器来加载编译好的Dalvik字节码，<a class="ae jc" href="https://developer.android.com/reference/dalvik/system/DexClassLoader.html" rel="noopener ugc nofollow" target="_blank"> DexClassLoader </a>。</p><p id="3ec5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您可以使用这个类加载编译过的Dalvik字节码。给它一个dex文件的路径，并调用loadClass在运行时检索您的实现。</p><h1 id="f6a0" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">示例代码</h1><p id="3e9b" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们在动态加载代码时会遇到的一个问题是，我们如何在主应用程序的代码中引用它？</p><p id="f14e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我推荐使用通用接口编程。</p><p id="ab31" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这个例子中，我为一个类创建了一个简单的接口，它有一个返回字符串的方法。然后可以在运行时确定该接口的实现。</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="9e88" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我已经在我的项目中创建了一个新的Android应用程序和两个Android库模块。这三个模块的源代码中都包含了这个接口。</p><p id="8a6f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">重要说明，主Android应用程序在其build.gradle中不包含对这两个库的引用，所以这两个模块都没有编译到主应用程序的字节码中。</p><p id="7b15" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在主应用程序中，我创建了一个类来加载该接口的实现。</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="acda" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个ModuleLoader类获取包含dex字节码的dex文件的路径，并加载它的IDynamicModule接口的实现。</p><blockquote class="kn ko kp"><p id="7ef5" class="ie if kq ig b ih ii ij ik il im in io kr iq ir is ks iu iv iw kt iy iz ja jb ha bi translated"><strong class="ig hi">更新:</strong>我注意到我最初的实现可以在新设备上工作，但是在旧设备上由于空指针而崩溃。DexClassLoader文档说不再需要缓存目录，但是如果为缓存目录传递null，它将在旧的SDK上崩溃。</p></blockquote><p id="e9a5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意；这个文件不能是Java字节码，它必须是Dalvik字节码。您可以使用以下dx命令从Java jar轻松创建一个dex文件:</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="1329" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi">—</p><p id="8e9b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">每个库项目都包含IDynamicModule的实现。为了将这些库构建到Dalvik字节码中，我使用了以下工作流程；</p><ul class=""><li id="5e25" class="ku kv hh ig b ih ii il im ip kw it kx ix ky jb kz la lb lc bi translated">我在AndroidStudio的项目选项卡的Android视图中点击了模块，并从文件菜单中选择了构建-&gt;生成模块选项。</li></ul><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es ld"><img src="../Images/f8b9d65e51345f39c309f114179a9cc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*la_n7uy3MGLssEvRrfbePw.png"/></div></div></figure><p id="1443" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这将导致在build/outputs/aar/文件夹中创建一个aar文件</p><p id="386d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">遗憾的是，aar文件不包含Dalvik字节码。其中包含的classes.jar文件是Java字节码。需要进一步的处理来获得您需要的dex文件。</p><p id="513c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">解压缩aar文件，并找到文件classes.jar。对jar文件运行dx命令以获得dx文件。通过<a class="ae jc" href="https://blog.coursesity.com/best-apache-cordova-tutorials/" rel="noopener ugc nofollow" target="_blank">最佳科尔多瓦教程</a>在线学习科尔多瓦，以便在android开发中更高效地工作。</p><blockquote class="kn ko kp"><p id="84d2" class="ie if kq ig b ih ii ij ik il im in io kr iq ir is ks iu iv iw kt iy iz ja jb ha bi translated">注意:dx命令可以在{ ANDROID _ HOME }/build-tools/{您的构建工具版本}/的构建工具文件夹中找到</p></blockquote><p id="7927" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了简化这个过程，我在build.gradle中为每个dynamicmodules添加了构建任务，并将生成的dex文件复制到app模块的asset文件夹中。</p><p id="6683" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">跑步。/grad Lew dynamicmodule:copydex toApp将构建第一个dynamic module并对其进行索引，然后将其复制到app模块的assets文件夹中。</p><p id="b8ff" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在真正的热插拔情况下，您应该从服务器下载dex文件。</p><blockquote class="kn ko kp"><p id="94b0" class="ie if kq ig b ih ii ij ik il im in io kr iq ir is ks iu iv iw kt iy iz ja jb ha bi translated">旁注:</p><p id="1ca0" class="ie if kq ig b ih ii ij ik il im in io kr iq ir is ks iu iv iw kt iy iz ja jb ha bi translated">创建dex的过程可以在<a class="ae jc" href="https://github.com/davethomas11/AndroidHotSwapCodeExample/blob/master/buildSrc/src/main/groovy/ExtractDexTask.groovy" rel="noopener ugc nofollow" target="_blank">https://github . com/davethomas 11/androidhotswapcode example/blob/master/buildSrc/src/main/groovy/extractdextask . groovy</a>中找到</p><p id="c3ac" class="ie if kq ig b ih ii ij ik il im in io kr iq ir is ks iu iv iw kt iy iz ja jb ha bi translated">这是我添加到buildSrc中的一个自定义任务，它使我的项目中的所有build.gradle文件都可以使用它。</p></blockquote><p id="d7d2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在MainActivity示例中，从assets文件夹加载模块是简单的:</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="1178" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">dex文件需要首先从资产复制到应用程序的数据目录中，然后该文件路径可以与ModuleLoader一起使用。</p><p id="ce66" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">看看github.com/davethomas11/AndroidHotSwapCodeExample的<a class="ae jc" href="https://github.com/davethomas11/AndroidHotSwapCodeExample" rel="noopener ugc nofollow" target="_blank">并尝试一下。</a></p><p id="3312" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">重要注意事项:</p><ul class=""><li id="7ddf" class="ku kv hh ig b ih ii il im ip kw it kx ix ky jb kz la lb lc bi translated">安全性:如果您从服务器下载dex文件，请确保您包含校验和，以便任何dex文件都不能加载到您的应用程序中，并且只接受来自可信来源的代码。</li><li id="ca3b" class="ku kv hh ig b ih lk il ll ip lm it ln ix lo jb kz la lb lc bi translated">内存和效率:当您完成一个实现或者升级到一个新版本时，请确保您注意取消所有线程对您的类加载器的引用。当您实例化的DexClassLoader超出范围并且没有对它的引用时，动态加载的类将被垃圾收集。</li><li id="29bb" class="ku kv hh ig b ih lk il ll ip lm it ln ix lo jb kz la lb lc bi translated">架构:用非常简单的单入口点保持包装接口的简单，使实现更加灵活。</li><li id="64ca" class="ku kv hh ig b ih lk il ll ip lm it ln ix lo jb kz la lb lc bi translated">Android资源:因为你正在加载的只是Dalvik字节码，请注意，你不能在你的动态模块中包含任何字符串、布局或类似的资产，并且必须使用替代方法来动态加载这类数据。</li></ul></div></div>    
</body>
</html>