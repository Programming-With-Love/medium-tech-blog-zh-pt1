<html>
<head>
<title>Cost ShowBack For Trino using Machine Learning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用机器学习的Trino成本显示</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/cost-showback-for-trino-using-machine-learning-dfe620109d2c?source=collection_archive---------0-----------------------#2021-07-07">https://medium.com/walmartglobaltech/cost-showback-for-trino-using-machine-learning-dfe620109d2c?source=collection_archive---------0-----------------------#2021-07-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/29eaec6cf252d7a194acb57835d197e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bpr41w-G4nZxkmAt2dfbKQ.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Source : <a class="ae it" href="https://github.com/trinodb/trino.io/blob/master/assets/trino-og.png" rel="noopener ugc nofollow" target="_blank">Trino</a></figcaption></figure><h1 id="9658" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated"><strong class="ak">概述</strong></h1><p id="b49d" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">我们在云平台(如GCP、Azure)上提供Trino作为多租户平台托管服务，并在沃尔玛内部团队内部提供。到目前为止，我们每月针对超过100万个查询处理数Pb的数据。我们的客户将该服务用于各种用例，如报告和仪表板、即席查询、联合查询等等。</p><p id="6860" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">由于我们的托管集群是多租户的，因此向客户展示我们服务的使用成本对我们来说是一个挑战。此外，我们还收到了客户关于服务相关成本的多次询问，以帮助他们规划其使用案例的预算。</p><p id="7f24" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">作为成本显示流程的一部分，我们希望根据使用情况向客户显示与我们的服务相关的成本，因此我们提出了按查询付费的模式，客户只需为他们运行的查询付费。</p><h1 id="a645" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated"><strong class="ak">成本回报方法</strong></h1><p id="b669" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">我们缩小范围，为我们的按查询付费模型选择了两种最佳方法。</p><h2 id="f7a6" class="kv iv hh bd iw kw kx ky ja kz la lb je kd lc ld ji kh le lf jm kl lg lh jq li bi translated"><strong class="ak"> 1。基于查询的资源利用指标计算成本</strong></h2><p id="fba5" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">我们为Trino集群中提交的每个查询收集查询指标。这包括执行时间、CPU时间、内存使用等指标。</p><p id="7297" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated"><strong class="ju hi">限制</strong>:</p><p id="5942" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">假设您在一天中的不同时间间隔运行相同的查询，那么资源利用的指标(CPU、内存等。)在一天中会有所不同，具体取决于群集工作负载、网络速度等。这可能会导致相同查询的不同开销。</p><p id="10d7" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">例如，我们提交了一个在不同时间间隔对相同数据大小进行多次迭代的查询，并观察到CPU时间有一些变化，但累积内存和执行时间有很大变化。CPU time是一个查询的所有任务的累计CPU时间，而累计内存是整个查询处理过程中使用的累计内存。</p><figure class="lk ll lm ln fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lj"><img src="../Images/037ad74cb192236b8d05fe5968f737dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q_fs0k5mdYXeKJYvCGlpLw.png"/></div></div></figure><figure class="lk ll lm ln fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lo"><img src="../Images/1a9ca930eb19b35df54691599cfd6ecd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hVs84QxO_66nAmfY5QvuJg.png"/></div></div></figure><figure class="lk ll lm ln fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lj"><img src="../Images/0da9500298bbcfca9257836d71a0cf83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CRptLhXEYFDnfZvTJlyr2g.png"/></div></div></figure><h2 id="cbd6" class="kv iv hh bd iw kw kx ky ja kz la lb je kd lc ld ji kh le lf jm kl lg lh jq li bi translated">2.<strong class="ak">根据查询处理的总字节数计算成本</strong></h2><p id="8a45" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">由于查询处理的总字节数不受集群工作负载的影响，因此该指标非常适合用于成本显示。此外，与其他指标(如CPU、内存等)相比，客户很容易联想到这一指标。</p><p id="7ae3" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated"><strong class="ju hi">限制</strong>:</p><p id="011e" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">我们不直接考虑CPU、内存等指标，这些指标构成了虚拟机实例的大部分成本。</p><h2 id="5cf5" class="kv iv hh bd iw kw kx ky ja kz la lb je kd lc ld ji kh le lf jm kl lg lh jq li bi translated"><strong class="ak">最终进场</strong></h2><p id="2e1a" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">我们最终确定了第二种方法，并通过使用机器学习模型(多项式回归)克服了这一限制，该模型将查询的累计CPU时间和处理的总字节数视为因变量和自变量。</p><h1 id="c922" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated"><strong class="ak">成本回报回归模型</strong></h1><p id="a6e5" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">由于我们希望确保考虑CPU时间和内存，因此我们开始分析大量的查询统计数据，以找出训练模型的正确属性。</p><h2 id="8fd8" class="kv iv hh bd iw kw kx ky ja kz la lb je kd lc ld ji kh le lf jm kl lg lh jq li bi translated"><strong class="ak">特色工程</strong></h2><p id="1fe9" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">基于我们对查询属性的理解，我们过滤掉了大部分属性，并考虑了累积内存和累积CPU时间。</p><p id="8325" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">然后，我们尝试了属性的相关性，以理解它们与处理的总字节数的关系。</p><figure class="lk ll lm ln fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lp"><img src="../Images/6db01467a50d407b93b5b05ce2fb779c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iTha_3VtMZlQ7Q7nol2qWw.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Correlation Chart</figcaption></figure><p id="3d78" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">根据上面的图表，CPU时间和处理的总字节数之间有很高的相关性(0.8)，但是累积内存没有显示出与总字节数的任何相关性，因此我们在模型中只考虑了CPU时间。这是因为累积内存受集群工作负载的影响很大，就像我们之前看到的那样。</p><p id="c748" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">此外，我们绘制了每GB数据处理的所有不同查询复杂度的平均CPU时间，并观察了CPU时间的总体增长趋势。</p><figure class="lk ll lm ln fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lp"><img src="../Images/dae4c54f6836a55ebf2b3c985ee5f334.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g9BsabakWChnjQzSqURNdA.png"/></div></div></figure><h2 id="cc6a" class="kv iv hh bd iw kw kx ky ja kz la lb je kd lc ld ji kh le lf jm kl lg lh jq li bi translated"><strong class="ak">车型概述</strong></h2><p id="048d" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">我们使用多项式回归来开发我们的模型。我们使用自定义采样技术来训练和测试模型。</p><p id="1569" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">我们为“选择”和“写入”查询创建了单独的模型，因为我们看到了不同的资源利用模式。对于“写”查询模型，除了扫描的数据之外，我们还考虑了由查询写入的数据。</p><p id="c342" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">我们还在模型中添加了一些约束来适应我们的用例。其中一些包括使成本曲线成为递增曲线，因为成本应该随着处理的数据字节的增加而增加。此外，很少调整函数的截距来最小化与查询相关的最小成本。</p><h2 id="b8f2" class="kv iv hh bd iw kw kx ky ja kz la lb je kd lc ld ji kh le lf jm kl lg lh jq li bi translated"><strong class="ak">精度</strong></h2><p id="aa3a" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">每个用例都有自己衡量准确性的方式。对于我们的用例，它是关于考虑对我们集群中的不同数据集执行的不同复杂查询的累积CPU时间。</p><p id="6717" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">我们通过将一天内提交的所有查询的整体CPU利用率与预测的CPU利用率进行比较来衡量准确性。我们能够达到80%以上的准确率。</p><p id="b20b" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">我们始终如一地监控我们在每日级别的准确性，并计划定期更新我们的模型，以包括针对旧/新数据集的新查询。我们在沃尔玛机器学习平台上建立了一个循环工作流，对模型进行定期再训练。</p><h2 id="a1f3" class="kv iv hh bd iw kw kx ky ja kz la lb je kd lc ld ji kh le lf jm kl lg lh jq li bi translated"><strong class="ak">将预测的CPU时间转换为成本</strong></h2><p id="626e" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">由于Trino集群的整体利用率每天都在变化，因此我们在一天结束时根据查询的预计CPU时间的百分比份额，通过将集群的总成本分配给所有查询来计算成本。我们更关注的是根据平台的收费情况，准确地向团队展示和分配成本，而不是保持成本不变。</p><h1 id="308a" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">用户如何估计在我们的服务中运行查询的成本？</h1><p id="b2c6" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">我们开发了一个成本估算应用程序，帮助用户估算在Trino集群中运行查询的成本。</p><p id="60f1" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">该应用程序将从用户的以下输入</p><p id="166b" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">提交到群集的预期查询数。</p><p id="a59c" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">查询预期读取的总字节数和写入的总字节数</p><p id="c828" class="pw-post-body-paragraph js jt hh ju b jv kq jx jy jz kr kb kc kd ks kf kg kh kt kj kk kl ku kn ko kp ha bi translated">由于群集利用率每天都在变化，因此查询的成本也会相应变化，因此我们为最终用户提供了他们输入的估计属性，以帮助他们规划其用例的预算。</p><figure class="lk ll lm ln fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lq"><img src="../Images/c25e49e3950ebfb3a0c2e7c79f2a5efe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oZMJddu2Lc-UqgzS2Osn7A.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Cost Estimation in Dollar</figcaption></figure><h1 id="7277" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">结论</h1><p id="08ad" class="pw-post-body-paragraph js jt hh ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">成本显示模式帮助我们通过按查询付费模式向内部团队显示与托管服务相关的基础架构成本。这也有助于最终用户将我们的服务成本与沃尔玛的其他选择进行比较。</p></div></div>    
</body>
</html>