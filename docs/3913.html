<html>
<head>
<title>How to deploy Azure Key Vaults with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Terraform部署Azure Key Vaults</h1>
<blockquote>原文：<a href="https://medium.com/globant/how-to-deploy-azure-key-vaults-with-terraform-94b04031fa0e?source=collection_archive---------0-----------------------#2022-07-08">https://medium.com/globant/how-to-deploy-azure-key-vaults-with-terraform-94b04031fa0e?source=collection_archive---------0-----------------------#2022-07-08</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="er es ie"><img src="../Images/83997e6fe11a644f98f355b718427342.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*7d3f5IX7n0uGc5YZYzMagA.png"/></div></figure><h1 id="d3cc" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">介绍</h1><p id="2cff" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">当我们开发我们的应用程序时，特别注意我们保护秘密的方式以及我们如何控制对它们的访问是很重要的。从无意的错误到恶意的攻击，我们需要正确管理秘密的原因有很多。</p><p id="5ee4" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">如果你正在使用Azure stack技术，Azure Key Vault是一个很好的云服务，可以保护你的秘密。它允许您存储密码、证书或密钥等秘密，您可以管理谁或哪些服务可以访问您的秘密，并且您可以控制他们将拥有的权限类型。</p><p id="64ba" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">在大型项目中，你可能会使用不同的产品，每个产品都将使用不同的环境，如开发、TST、UAT和生产。因此，如果遵循最佳实践，每个应用程序和每个环境都需要一个密钥库。这将允许你妥善管理你的秘密，也将减少在违反情况下的影响。</p><p id="9716" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">如果你有少量的项目，它们相对容易管理，但是当你有大的项目时会发生什么呢？幸运的是，今天我们有不同的工具和服务可以帮助我们。今天，我将谈论Terraform以及我们如何使用它来管理我们的密钥库。</p><p id="cd67" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">引用Terraform官方网站:“HashiCorp Terraform是一个基础设施代码工具，允许您在可读的配置文件中定义云和本地资源，您可以对这些文件进行版本化、重用和共享。”基本上，它帮助您以更有效的方式将基础设施配置为代码。它在一个状态文件中跟踪您的真实基础设施，该文件充当您的环境的真实来源。然后，创建并配置terraform文件，对实际基础设施进行修改。</p><p id="acaa" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">考虑到上述情况，我将分享我用来维护我们的基础设施的脚本，以创建必要的密钥库，分配权限并生成服务连接，以将其与Azure DevOps集成。</p><p id="1718" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">在本文中，我们将讨论以下几点:</p><p id="ae9b" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">1-需求:测试本文应该运行的软件。</p><p id="aa6a" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">2-地形脚本:所有文件及其脚本。</p><p id="3dda" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">3-结论:本文的成果！</p><p id="8566" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">4-参考资料:如果你想了解更多这方面的信息。</p><h1 id="d427" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">要求</h1><ol class=""><li id="e5ec" class="km kn hh jl b jm jn jq jr ju ko jy kp kc kq kg kr ks kt ku bi translated">Azure的基础知识</li><li id="0b35" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg kr ks kt ku bi translated">您需要具备:</li></ol><ul class=""><li id="6fcd" class="km kn hh jl b jm kh jq ki ju la jy lb kc lc kg ld ks kt ku bi translated">Azure订阅</li><li id="7dae" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg ld ks kt ku bi translated">Azure Devops项目</li><li id="08f0" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg ld ks kt ku bi translated">已经创建了资源组</li><li id="5f2b" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg ld ks kt ku bi translated">只有一个容器的存储帐户</li><li id="0cac" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg ld ks kt ku bi translated">从azure devops生成的个人访问令牌(PAT)</li><li id="5669" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg ld ks kt ku bi translated">客户端ID和客户端机密</li></ul><p id="2c80" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">3.Terraform应该安装并配置在运行脚本的机器上</p><h1 id="485b" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">地形脚本</h1><p id="0ed7" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">这些脚本的主要目标是:</p><ul class=""><li id="daed" class="km kn hh jl b jm kh jq ki ju la jy lb kc lc kg ld ks kt ku bi translated">为每个项目创建一个密钥库，一个用于开发，一个仅用于测试环境。</li><li id="3ae7" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg ld ks kt ku bi translated">创建Azure Devops所需的服务连接。</li><li id="36d8" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg ld ks kt ku bi translated">为将管理密钥保管库的用户分配所有权限。</li></ul><p id="98c1" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">为了以有效的方式工作，我们将有不同的地形文件。</p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es le"><img src="../Images/68ed9911d4ef15e9b81e732580df6ff8.png" data-original-src="https://miro.medium.com/v2/resize:fit:324/format:webp/1*_U-wIBtB3y3DLYnkZxMLkw.png"/></div></figure><h2 id="86ef" class="lj im hh bd in lk ll lm ir ln lo lp iv ju lq lr iz jy ls lt jd kc lu lv jh lw bi translated">变量. tfvars</h2><p id="2e3f" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">答。tfvars文件是一个terraform文件，您可以在其中声明变量。然后在你的脚本文件中，你通过写变量来引用它们。$(变量名称)。</p><p id="a62f" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">因此，在这个文件中，我们将编写所有要使用的变量:</p><p id="d8e0" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">pat= "xxxxxx" →在azure devops创建的个人访问令牌</p><p id="845c" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">sub_id_dev= "xxxxxx" →您在azure中的订阅id</p><p id="0f5c" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">tenant_id= "xxxxxx" →您的租户id</p><p id="95c6" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">client_id= "xxxxxx" →您的客户id</p><p id="578e" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">client_secret= "xxxxxx" →您的客户机密</p><p id="d55b" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">sa_resource_group = "xxxxxx" →存储帐户资源组</p><p id="59be" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">storage_account= "xxxxxxx" →存储帐户名称</p><p id="fe76" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">container_name = "xxxxxx" →容器名称</p><p id="d534" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">key = "xxxxxx" →将要保存在容器中的文件的名称</p><p id="31d9" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">org_service_url = "xxxxxx" →您在azure devops中的组织url</p><h2 id="775c" class="lj im hh bd in lk ll lm ir ln lo lp iv ju lq lr iz jy ls lt jd kc lu lv jh lw bi translated">00-main.tf</h2><p id="6cd7" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">我们配置我们的terraform所需的提供商:</p><pre class="lf lg lh li fd lx ly lz ma aw mb bi"><span id="54ce" class="lj im hh ly b fi mc md l me mf">terraform {<br/>  required_providers {<br/>    azuredevops = {<br/>      source = "microsoft/azuredevops"<br/>      version = "0.1.0"<br/>    }<br/>    <br/>    azurerm = {<br/>      source  = "hashicorp/azurerm"<br/>      version = "=2.46.0"<br/>    }</span><span id="78b1" class="lj im hh ly b fi mg md l me mf">azuread = {<br/>      source  = "hashicorp/azuread"<br/>      version = "=2.11.0"<br/>    }<br/>  }<br/>  backend "azurerm" {<br/>  resource_group_name  = var.sa_resource_group<br/>  storage_account_name = var.storage_account<br/>  container_name       = var.container_name<br/>  key                  = var.key<br/>  subscription_id      = var.sub_id_dev<br/>  tenant_id            = var.tenant_id<br/>  }<br/>}</span><span id="5776" class="lj im hh ly b fi mg md l me mf">provider "azurerm" {<br/>  features {}<br/>}</span></pre><h2 id="f7ab" class="lj im hh bd in lk ll lm ir ln lo lp iv ju lq lr iz jy ls lt jd kc lu lv jh lw bi translated">01-providers.tf</h2><p id="738a" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">azure devops和azurerm提供程序的配置:</p><pre class="lf lg lh li fd lx ly lz ma aw mb bi"><span id="0c34" class="lj im hh ly b fi mc md l me mf">provider "azuredevops" {<br/>  org_service_url = var.org_service_url<br/>  personal_access_token = var.pat<br/>}</span><span id="1e9f" class="lj im hh ly b fi mg md l me mf">provider "azurerm" {<br/>  features {}<br/>  subscription_id =  var.sub_id_dev<br/>  tenant_id = var.tenant_id<br/>  client_id       = var.client_id <br/>  client_secret   = var.client_secret<br/>  alias = "non-prod"<br/>}</span></pre><h2 id="e03c" class="lj im hh bd in lk ll lm ir ln lo lp iv ju lq lr iz jy ls lt jd kc lu lv jh lw bi translated">02-变量. tf</h2><p id="7c43" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">这里我们定义了每个项目的变量。我们可以添加我们需要的项目数量:</p><ul class=""><li id="1c67" class="km kn hh jl b jm kh jq ki ju la jy lb kc lc kg ld ks kt ku bi translated">kv_name =我们将为该特定项目分配的密钥库名称</li><li id="fec0" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg ld ks kt ku bi translated">rg_dev =开发资源组</li><li id="2b41" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg ld ks kt ku bi translated">rg_tst =测试资源组</li><li id="3f8b" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg ld ks kt ku bi translated">proyecto_ado = azure devops项目的名称</li><li id="df7d" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg ld ks kt ku bi translated">devops =有权修改密钥库的用户的电子邮件。</li></ul><p id="7c17" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">这是一个示例，您必须根据您的项目替换所有这些变量:</p><pre class="lf lg lh li fd lx ly lz ma aw mb bi"><span id="48b0" class="lj im hh ly b fi mc md l me mf">variable "p_data" {<br/>    type = list(object({<br/>      kv_name = string,<br/>      rg_dev = string,<br/>      rg_tst = string,<br/>      proyecto_ado = string,<br/>      devops = list(string)<br/>  <br/>  }))<br/>  default = [<br/>     {<br/>      kv_name = "akvname" <br/>      rg_dev = "a-dev-rg"<br/>      rg_tst = "a-tst-rg"<br/>      proyecto_ado = "A_PROJECT"<br/>      devops = ["<a class="ae mh" href="mailto:devops1@gmail.com" rel="noopener ugc nofollow" target="_blank">devops1@gmail.com</a>", "<a class="ae mh" href="mailto:devops2@gmail.com" rel="noopener ugc nofollow" target="_blank">devops2@gmail.com</a>"]<br/>      },<br/>     {<br/>      kv_name = "bkvname" <br/>      rg_dev = "b-dev-rg"<br/>      rg_tst = "b-tst-rg"<br/>      proyecto_ado = "B_PROJECT"<br/>      devops = ["<a class="ae mh" href="mailto:devops1@gmail.com" rel="noopener ugc nofollow" target="_blank">devops11@gmail.com</a>"]<br/>     },<br/>     {<br/>      kv_name = "ckvname" <br/>      rg_dev = "c-dev-rg"<br/>      rg_tst = "c-tst-rg"<br/>      proyecto_ado = "C_PROJECT"<br/>      devops = ["<a class="ae mh" href="mailto:devops3@gmail.com" rel="noopener ugc nofollow" target="_blank">devops3@gmail.com</a>", "<a class="ae mh" href="mailto:devops4@gmail.com" rel="noopener ugc nofollow" target="_blank">devops4@gmail.com</a>", "<a class="ae mh" href="mailto:devops5@gmail.com" rel="noopener ugc nofollow" target="_blank">devops5@gmail.com</a>"]<br/>     }<br/>  ]<br/>}</span><span id="f1d7" class="lj im hh ly b fi mg md l me mf">data "azurerm_subscription" "s_non_prod" {<br/>  subscription_id = var.sub_id_dev<br/>  provider = azurerm.non-prod<br/>}</span></pre><h2 id="81c7" class="lj im hh bd in lk ll lm ir ln lo lp iv ju lq lr iz jy ls lt jd kc lu lv jh lw bi translated">03-servicep.tf</h2><p id="d1c8" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">为了生成密钥库和azure devops项目之间的集成，我们需要为每个密钥库创建一个服务主体。这将允许我们稍后创建服务连接。</p><pre class="lf lg lh li fd lx ly lz ma aw mb bi"><span id="2198" class="lj im hh ly b fi mc md l me mf">data "azuread_client_config" "current" {}</span><span id="7931" class="lj im hh ly b fi mg md l me mf">#Service principal<br/>resource "azuread_application" "app-non-prod" {<br/>  for_each = {for p in var.p_data:  p.kv_name =&gt; p} <br/>  display_name = "KV-${each.value.kv_name}"<br/>  owners       = [data.azuread_client_config.current.object_id]<br/>}</span><span id="9abf" class="lj im hh ly b fi mg md l me mf">resource "azuread_service_principal" "sp-non-prod" {<br/>  for_each = {for p in var.p_data:  p.kv_name =&gt; p}<br/>  application_id               = azuread_application.app-non-prod[each.value.kv_name].application_id<br/>  app_role_assignment_required = false<br/>  owners                       = [data.azuread_client_config.current.object_id]</span><span id="468d" class="lj im hh ly b fi mg md l me mf">feature_tags {<br/>    enterprise = true<br/>    gallery    = true<br/>  }<br/>}</span><span id="75af" class="lj im hh ly b fi mg md l me mf">resource "azuread_service_principal_password" "sp-non-prod-passwd" {<br/>  for_each = {for p in var.p_data:  p.kv_name =&gt; p}<br/>  service_principal_id = azuread_service_principal.sp-non-prod[each.value.kv_name].object_id<br/>}</span></pre><h2 id="f846" class="lj im hh bd in lk ll lm ir ln lo lp iv ju lq lr iz jy ls lt jd kc lu lv jh lw bi translated">04-角色分配. tf</h2><p id="96d1" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">我们必须将角色“Contributor”分配给在每个密钥库中创建的先前的服务主体。</p><pre class="lf lg lh li fd lx ly lz ma aw mb bi"><span id="a3fe" class="lj im hh ly b fi mc md l me mf">#Resource group from each environment</span><span id="f865" class="lj im hh ly b fi mg md l me mf">data "azurerm_resource_group" "dev-rg" {<br/>  for_each = {for p in var.p_data:  p.kv_name =&gt; p}<br/>  name = each.value.rg_dev<br/>  provider = azurerm.non-prod<br/>}</span><span id="d7ce" class="lj im hh ly b fi mg md l me mf">data "azurerm_resource_group" "tst-rg" {<br/>  for_each = {for p in var.p_data:  p.kv_name =&gt; p}<br/>  name = each.value.rg_tst<br/>  provider = azurerm.non-prod<br/>}</span><span id="50fd" class="lj im hh ly b fi mg md l me mf"># Assign Contributor permission to the service principals</span><span id="94bb" class="lj im hh ly b fi mg md l me mf">resource "azurerm_role_assignment" "sp-dev-roleassignment" {<br/>  for_each = {for p in var.p_data:  p.kv_name =&gt; p}<br/>  scope              = data.azurerm_resource_group.dev-rg[each.value.kv_name].id<br/>  role_definition_name = "Contributor"<br/>  principal_id       = azuread_service_principal.sp-non-prod[each.value.kv_name].object_id<br/>  depends_on = [resource.azuread_service_principal.sp-non-prod]<br/>  provider = azurerm.non-prod<br/>}</span><span id="dc6c" class="lj im hh ly b fi mg md l me mf">resource "azurerm_role_assignment" "sp-tst-roleassignment" {<br/>  for_each = {for p in var.p_data:  p.kv_name =&gt; p}<br/>  scope              = data.azurerm_resource_group.tst-rg[each.value.kv_name].id<br/>  role_definition_name = "Contributor"<br/>  principal_id       = azuread_service_principal.sp-non-prod[each.value.kv_name].object_id<br/>  depends_on = [resource.azuread_service_principal.sp-non-prod]<br/>  provider = azurerm.non-prod<br/>}</span></pre><h2 id="1993" class="lj im hh bd in lk ll lm ir ln lo lp iv ju lq lr iz jy ls lt jd kc lu lv jh lw bi translated">05-keyvaults.tf</h2><p id="2f75" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">在此文件中，我们将为每个项目创建密钥库。每个环境一个:dev和tst。</p><pre class="lf lg lh li fd lx ly lz ma aw mb bi"><span id="1b2c" class="lj im hh ly b fi mc md l me mf">data "azurerm_resource_group" "rg_dev" {<br/>  for_each = {for p in var.p_data:  p.kv_name =&gt; p}<br/>  name = each.value.rg_dev<br/>  provider = azurerm.non-prod<br/>}</span><span id="aaba" class="lj im hh ly b fi mg md l me mf">data "azurerm_resource_group" "rg_tst" {<br/>  for_each = {for p in var.p_data:  p.kv_name =&gt; p}<br/>  name = each.value.rg_tst<br/>  provider = azurerm.non-prod</span><span id="6c13" class="lj im hh ly b fi mg md l me mf">}</span><span id="165d" class="lj im hh ly b fi mg md l me mf">resource "azurerm_key_vault" "kv-dev" {<br/>  for_each = {for p in var.p_data:  p.kv_name =&gt; p}  <br/>  name                        = "${each.value.kv_name}-dev"<br/>  location                    = data.azurerm_resource_group.rg_dev[each.value.kv_name].location<br/>  resource_group_name         = data.azurerm_resource_group.rg_dev[each.value.kv_name].name<br/>  enabled_for_disk_encryption = true<br/>  tenant_id                   = data.azurerm_subscription.s_non_prod.tenant_id<br/>  soft_delete_retention_days  = 14<br/>  purge_protection_enabled    = true<br/>  provider = azurerm.non-prod <br/>  sku_name = "standard"<br/>  depends_on = [azuread_service_principal.sp-non-prod]</span><span id="a794" class="lj im hh ly b fi mg md l me mf">}</span><span id="6ec4" class="lj im hh ly b fi mg md l me mf">resource "azurerm_key_vault" "kv-tst" {<br/>  for_each = {for p in var.p_data:  p.kv_name =&gt; p}  <br/>  name                        = "${each.value.kv_name}-tst"<br/>  location                    = data.azurerm_resource_group.rg_tst[each.value.kv_name].location<br/>  resource_group_name         = data.azurerm_resource_group.rg_tst[each.value.kv_name].name<br/>  enabled_for_disk_encryption = true<br/>  tenant_id                   = data.azurerm_subscription.s_non_prod.tenant_id<br/>  soft_delete_retention_days  = 14<br/>  purge_protection_enabled    = true<br/>  provider = azurerm.non-prod<br/>  sku_name = "standard"<br/>  depends_on = [azuread_service_principal.sp-non-prod]</span><span id="81d7" class="lj im hh ly b fi mg md l me mf">}</span></pre><h2 id="8868" class="lj im hh bd in lk ll lm ir ln lo lp iv ju lq lr iz jy ls lt jd kc lu lv jh lw bi translated">06-sc.tf</h2><p id="b04e" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">在每个Azure DevOps项目中创建服务连接。</p><pre class="lf lg lh li fd lx ly lz ma aw mb bi"><span id="faf2" class="lj im hh ly b fi mc md l me mf">resource "azuredevops_serviceendpoint_azurerm" "sc-akv-non-prod" {<br/>  for_each = {for p in var.p_data:  p.kv_name =&gt; p}<br/>  project_id            = each.value.proyecto_ado<br/>  service_endpoint_name     = upper("KV-${each.value.kv_name}-NON-PROD")<br/>  description = "Managed by Terraform" <br/>  azurerm_spn_tenantid      = data.azurerm_subscription.s_non_prod.tenant_id<br/>  azurerm_subscription_id   = data.azurerm_subscription.s_non_prod.subscription_id<br/>  azurerm_subscription_name = data.azurerm_subscription.s_non_prod.display_name<br/>  credentials {<br/>    serviceprincipalid  = azuread_service_principal.sp-non-prod[each.value.kv_name].application_id<br/>    serviceprincipalkey = azuread_service_principal_password.sp-non-prod-passwd[each.value.kv_name].value<br/>  }<br/>}</span></pre><h2 id="031f" class="lj im hh bd in lk ll lm ir ln lo lp iv ju lq lr iz jy ls lt jd kc lu lv jh lw bi translated">07-accesspolicy.tf</h2><p id="a96b" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">访问策略是我们在每个密钥库中授予的创建、获取、删除机密等权限。</p><p id="b0da" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">在这个文件中，我们将访问策略分配给我们在02-variables.tf中定义的所有用户，以及我们需要的权限列表。</p><p id="b255" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我们还将访问策略分配给具有“get”和“list”权限的服务连接的服务主体。</p><pre class="lf lg lh li fd lx ly lz ma aw mb bi"><span id="32bb" class="lj im hh ly b fi mc md l me mf">locals {</span><span id="c440" class="lj im hh ly b fi mg md l me mf">flattened-pdata =  flatten([<br/>    for pos, kv in var.p_data : [<br/>      for pos2, devops in var.p_data[pos].devops : {<br/>        kv_name = kv.kv_name<br/>        devops_name = kv.devops[pos2]<br/>    }]<br/>  ])<br/>}</span><span id="69a7" class="lj im hh ly b fi mg md l me mf">data "azuread_user" "user-ad" {<br/>   for_each = {<br/>    for devops in local.flattened-pdata : "${devops.kv_name}.${devops.devops_name}" =&gt; devops<br/>    }</span><span id="8da6" class="lj im hh ly b fi mg md l me mf">user_principal_name = each.value.devops_name<br/>}</span><span id="1a41" class="lj im hh ly b fi mg md l me mf">#Access policy assign to devops</span><span id="b9be" class="lj im hh ly b fi mg md l me mf">#DEV<br/>resource "azurerm_key_vault_access_policy" "kv-pol-devops-dev" {</span><span id="0982" class="lj im hh ly b fi mg md l me mf">for_each = {<br/>    for devops in local.flattened-pdata : "${devops.kv_name}.${devops.devops_name}" =&gt; devops<br/>    }</span><span id="440f" class="lj im hh ly b fi mg md l me mf">key_vault_id = azurerm_key_vault.kv-dev[each.value.kv_name].id<br/>      tenant_id = data.azurerm_subscription.s_non_prod.tenant_id<br/>      object_id = data.azuread_user.user-ad["${each.value.kv_name}.${each.value.devops_name}"].object_id</span><span id="4869" class="lj im hh ly b fi mg md l me mf">key_permissions = [<br/>      "get","list","update","create","import","delete","recover","backup","restore",<br/>      ]</span><span id="085b" class="lj im hh ly b fi mg md l me mf">secret_permissions = [<br/>      "get","list","set","delete","recover","backup","restore",<br/>      ]</span><span id="0e1a" class="lj im hh ly b fi mg md l me mf">storage_permissions = [<br/>      "get","list",<br/>      ]  <br/>      depends_on = [<br/>        azurerm_key_vault.kv-dev<br/>      ]<br/>      provider = azurerm.non-prod<br/>}</span><span id="14a7" class="lj im hh ly b fi mg md l me mf">#TST<br/>resource "azurerm_key_vault_access_policy" "kv-pol-devops-tst" {</span><span id="ac92" class="lj im hh ly b fi mg md l me mf">for_each = {<br/>    for devops in local.flattened-pdata : "${devops.kv_name}.${devops.devops_name}" =&gt; devops<br/>    }</span><span id="9e3b" class="lj im hh ly b fi mg md l me mf">key_vault_id = azurerm_key_vault.kv-tst[each.value.kv_name].id<br/>      tenant_id = data.azurerm_subscription.s_non_prod.tenant_id<br/>      object_id = data.azuread_user.user-ad["${each.value.kv_name}.${each.value.devops_name}"].object_id</span><span id="4014" class="lj im hh ly b fi mg md l me mf">key_permissions = [<br/>      "get","list","update","create","import","delete","recover","backup","restore",<br/>      ]</span><span id="3d47" class="lj im hh ly b fi mg md l me mf">secret_permissions = [<br/>      "get","list","set","delete","recover","backup","restore",<br/>      ]</span><span id="490b" class="lj im hh ly b fi mg md l me mf">storage_permissions = [<br/>      "get","list",<br/>      ]<br/>    <br/>     depends_on = [<br/>        azurerm_key_vault.kv-tst<br/>      ]<br/>      provider = azurerm.non-prod<br/>}</span><span id="500a" class="lj im hh ly b fi mg md l me mf">#Access policy assign to service connection's service principals.</span><span id="889b" class="lj im hh ly b fi mg md l me mf">#DEV<br/>resource "azurerm_key_vault_access_policy" "kv-pol-sp-dev" {<br/>  for_each = {for p in var.p_data:  p.kv_name =&gt; p}</span><span id="b216" class="lj im hh ly b fi mg md l me mf">key_vault_id = azurerm_key_vault.kv-dev[each.value.kv_name].id<br/>  tenant_id = data.azurerm_subscription.s_non_prod.tenant_id<br/>  object_id = azuread_service_principal.sp-non-prod[each.value.kv_name].object_id</span><span id="f1ff" class="lj im hh ly b fi mg md l me mf">key_permissions = [<br/>      "get","list",<br/>    ]</span><span id="de95" class="lj im hh ly b fi mg md l me mf">secret_permissions = [<br/>      "get","list",<br/>    ]</span><span id="bc5c" class="lj im hh ly b fi mg md l me mf">storage_permissions = [<br/>      "get","list",<br/>    ]</span><span id="f135" class="lj im hh ly b fi mg md l me mf">depends_on = [<br/>        azurerm_key_vault.kv-dev<br/>    ]</span><span id="6712" class="lj im hh ly b fi mg md l me mf">provider = azurerm.non-prod<br/>}<br/>#TST</span><span id="c9ce" class="lj im hh ly b fi mg md l me mf">resource "azurerm_key_vault_access_policy" "kv-pol-sp-tst" {<br/>  for_each = {for p in var.p_data:  p.kv_name =&gt; p}</span><span id="b16f" class="lj im hh ly b fi mg md l me mf">key_vault_id = azurerm_key_vault.kv-tst[each.value.kv_name].id<br/>  tenant_id = data.azurerm_subscription.s_non_prod.tenant_id<br/>  object_id = azuread_service_principal.sp-non-prod[each.value.kv_name].object_id<br/>  <br/>   key_permissions = [<br/>      "get","list",<br/>    ]</span><span id="c4e6" class="lj im hh ly b fi mg md l me mf">secret_permissions = [<br/>      "get","list",<br/>    ]</span><span id="8e60" class="lj im hh ly b fi mg md l me mf">storage_permissions = [<br/>      "get","list",<br/>    ]<br/>  <br/>   depends_on = [<br/>        azurerm_key_vault.kv-tst<br/>    ]<br/>   provider = azurerm.non-prod<br/>}</span></pre><h1 id="72a6" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">脚本执行</h1><p id="52f2" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">要执行这些脚本，您必须在命令行中编写以下步骤:</p><ol class=""><li id="db49" class="km kn hh jl b jm kh jq ki ju la jy lb kc lc kg kr ks kt ku bi translated">terraform init →初始化terraform。</li><li id="e48f" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg kr ks kt ku bi translated">terra form plan-var-file = variables.tfvars→它使用带有变量“variables . TF vars”的文件，在命令行中生成一个关于它将进行的更改的计划。</li><li id="e83b" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg kr ks kt ku bi translated">terra form apply-var-file = variables . TF vars→如果您确认为“是”，它将应用您的更改。参见示例:</li></ol><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es mi"><img src="../Images/ae89609c5b85b36d76127f54fca3ffc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:932/format:webp/1*bKptI5WGN7EFPfRRmlotYg.png"/></div></figure><h1 id="632c" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">结论</h1><p id="c6dc" class="pw-post-body-paragraph jj jk hh jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">Terraform是在我们的基础设施中维护大量服务的强大工具。这只是我们如何使用Terraform来维护密钥库的一个例子，但是我们可以在任何其他服务中应用这个解决方案。这样我们效率高，节省了很多时间，对我们的钥匙金库也有了更多的控制权。</p><h1 id="352d" class="il im hh bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">参考</h1><ol class=""><li id="f82b" class="km kn hh jl b jm jn jq jr ju ko jy kp kc kq kg kr ks kt ku bi translated"><a class="ae mh" href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs" rel="noopener ugc nofollow" target="_blank">https://registry . terraform . io/providers/hashi corp/azure RM/latest/docs</a></li><li id="18e4" class="km kn hh jl b jm kv jq kw ju kx jy ky kc kz kg kr ks kt ku bi translated"><a class="ae mh" href="https://docs.microsoft.com/en-us/azure/key-vault/general/overview" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/azure/key-vault/general/overview</a></li></ol><p id="acd8" class="pw-post-body-paragraph jj jk hh jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">感谢<a class="mj mk ge" href="https://medium.com/u/f7acacf97957?source=post_page-----94b04031fa0e--------------------------------" rel="noopener" target="_blank"> Pablo Rubini </a>在创建该任务时给予的帮助。</p></div></div>    
</body>
</html>