<html>
<head>
<title>A Kotlin Schrödinger Cat</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一只科特林·薛定谔猫</h1>
<blockquote>原文：<a href="https://blog.kotlin-academy.com/a-kotlin-schr%C3%B6dinger-cat-c0aeee5e7443?source=collection_archive---------4-----------------------#2018-02-17">https://blog.kotlin-academy.com/a-kotlin-schr%C3%B6dinger-cat-c0aeee5e7443?source=collection_archive---------4-----------------------#2018-02-17</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="dcc4" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">K语言是如何编译那些让你大吃一惊的东西的。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/673716489aacfc793cd525568004abe5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nh1i7L7rchlyfN5-tfTrtA.png"/></div></div></figure><p id="52a4" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">每个人都知道科特林。我的意思是，如果你在IT界，至少你听过它的名字。</p><p id="e568" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果你听过它的名字，你就会知道它是一种基于JVM的语言，由JetBrains于2011年开发，现在它正在成为J̶a̶v̶a世界使用最多的语言之一。或者至少现在你知道了。</p><p id="5466" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">今天我想写一下Kotlin“在幕后”做的可空性检查，为什么有时我们心爱的语言值得一点点关注以避免错误，以及big-K如何将我们漂亮的代码翻译成JVM字节码。</p><p id="6ffc" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">特别是，当我们在Kotlin上强制使用非空对象时，我们必须给予极大的关注，因为一切都可能——真的！—以NPE结束(也称为空指针异常，也称为“死”)。</p><h1 id="d5d6" class="lk ll in bd lm ln lo lp lq lr ls lt lu jt lv ju lw jw lx jx ly jz lz ka ma mb bi translated">Meowww？🐱</h1><p id="e141" class="pw-post-body-paragraph ko kp in kq b kr mc jo kt ku md jr kw kx me kz la lb mf ld le lf mg lh li lj ig bi translated">我们开始吧。我们有一个装着一只猫的盒子，然后我们杀了那只猫。</p><p id="779f" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">不，我是在开玩笑，但是如果你感兴趣的话，这里有一个解释<a class="ae mh" href="https://en.wikipedia.org/wiki/Schrödinger%27s_cat" rel="noopener ugc nofollow" target="_blank">薛定谔的猫悖论</a>的链接。总之<strong class="kq io">如果你不拍这篇文章，一只可爱的小猫就会死去。</strong>也可能不是。或者两者都有。</p><p id="545a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">首先，我们定义我们的<code class="fe mi mj mk ml b">Cat</code>对象</p><pre class="kd ke kf kg gt mm ml mn mo aw mp bi"><span id="1ea9" class="mq ll in ml b gy mr ms l mt mu">class Cat {<br/>    val meow = "Meowww...? :3"<br/>}</span></pre><p id="d37f" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">从我们的猫的一个无聊的例子开始:</p><pre class="kd ke kf kg gt mm ml mn mo aw mp bi"><span id="07a3" class="mq ll in ml b gy mr ms l mt mu">val aBoringCatInstance: Cat? = Cat()<br/>aBoringCatInstance!!</span></pre><blockquote class="mv mw mx"><p id="7f95" class="ko kp my kq b kr ks jo kt ku kv jr kw mz ky kz la na lc ld le nb lg lh li lj ig bi translated">IntelliJ(Android Studio也是如此)允许我们随时检查生成的JVM字节码，还可以用Java代码反编译它。Svyatoslav Chatchenko 的一篇文章解释了如何做到这一点。</p></blockquote><p id="631a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">查看这段代码，我们可以看到，在第二行中，我们只是强制我们的<code class="fe mi mj mk ml b">Cat</code>实例(定义为可空)为非空。下面是用JVM编译的代码和用Java反编译的代码的结果:</p><pre class="kd ke kf kg gt mm ml mn mo aw mp bi"><span id="ab2d" class="mq ll in ml b gy mr ms l mt mu">new Cat();</span></pre><p id="22bf" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">还有…什么？没什么。我们没有在应用程序的任何其他部分使用<code class="fe mi mj mk ml b">aBoringCatInstance</code>，Kotlin很聪明，知道这一点，所以优化了我们的代码，调用构造函数而没有创建变量，因此没有在堆栈上分配它(注意，对象无论如何都会在堆栈上分配，但它将能够尽快被垃圾收集，因为堆栈上没有指针“指向”该对象)。</p><p id="e901" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在接下来的两行代码中，我们感觉有点自虐:</p><pre class="kd ke kf kg gt mm ml mn mo aw mp bi"><span id="5148" class="mq ll in ml b gy mr ms l mt mu">val sureNullCat: Cat? = null<br/>sureNullCat!!</span></pre><p id="2259" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">可以想象，当我们试图将我们的null cat“强制转换”为非null类型时，代码自然会爆炸。或者至少抛出一个<strong class="kq io">空指针异常！</strong></p><pre class="kd ke kf kg gt mm ml mn mo aw mp bi"><span id="400a" class="mq ll in ml b gy mr ms l mt mu">Cat sureNullCat = null;<br/>Intrinsics.throwNpe();</span></pre><p id="5b9a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这是从我们刚刚看到的Kotlin代码反编译而来的Java。我们可以想象<code class="fe mi mj mk ml b">throwNpe()</code>会做什么，但是有些奇怪:为什么我们不做任何检查就抛出一个空指针异常？因为科特林是smar…好吧我不能再说一遍，但你知道。</p><p id="d582" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我们的badass编译器知道，在这一点上，该变量肯定是空的，因为我们正在强制一个空指针异常，它只是让我们满意我们想要的(和应得的)。所以<strong class="kq io">优化</strong>就是这个词。如果你喜欢的话，可以选择T21或者优化。</p><h1 id="4d91" class="lk ll in bd lm ln lo lp lq lr ls lt lu jt lv ju lw jw lx jx ly jz lz ka ma mb bi translated">让我们打开盒子📦</h1><p id="49e4" class="pw-post-body-paragraph ko kp in kq b kr mc jo kt ku md jr kw kx me kz la lb mf ld le lf mg lh li lj ig bi translated">最后，我们在这里，观察猫走出我们的盒子，死或活。</p><p id="6286" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">让我们定义一个抛硬币的方法——咳咳……函数。根据结果，它将返回一个<code class="fe mi mj mk ml b">Cat</code>实例或一个<code class="fe mi mj mk ml b">null</code>值:</p><pre class="kd ke kf kg gt mm ml mn mo aw mp bi"><span id="23a3" class="mq ll in ml b gy mr ms l mt mu">fun openBox(): Cat? {<br/>    return if (Random().nextInt(2) == 0) Cat() else null<br/>}</span></pre><p id="2a35" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">光靠这个函数什么也做不了，所以我们要<strong class="kq io">打开那个盒子</strong>，做一些我们永远不应该做的事情:</p><pre class="kd ke kf kg gt mm ml mn mo aw mp bi"><span id="c28a" class="mq ll in ml b gy mr ms l mt mu">val maybeACat = <em class="my">openBox</em>()<br/>val meow = maybeACat?.meow!!</span></pre><p id="306d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">让我们分析一下为什么我们在这里做的事情是极其错误的。</p><p id="c9ee" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">最初我们可能认为<code class="fe mi mj mk ml b">meow!!</code>不会触发空指针异常，因为<code class="fe mi mj mk ml b">meow</code>是<code class="fe mi mj mk ml b">Cat</code>的不可空属性。而关于这一点我们是对的，<strong class="kq io">但是</strong>在Kotlin中，一个可空对象的每个子对象都会“继承”那个可空性(可空性并不是真的被继承，但是你明白这个意思)。</p><p id="8dc3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">因此，如果祖先是可空类型，并且在我们的<code class="fe mi mj mk ml b">Cat</code>对象中被定义为<code class="fe mi mj mk ml b">String</code>，那么<code class="fe mi mj mk ml b">meow</code>属性将有效地变成一个<code class="fe mi mj mk ml b">String?</code>。</p><p id="f7f2" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这将使<code class="fe mi mj mk ml b">meow!!</code>成为一个潜在的核弹，因为如果<code class="fe mi mj mk ml b">maybeACat</code>将导致<em class="my">空</em>值，<code class="fe mi mj mk ml b">meow</code>也将是<em class="my">空</em>，并且将它强制为非空值将导致<a class="ae mh" href="https://docs.oracle.com/javase/9/docs/api/java/lang/NullPointerException.html" rel="noopener ugc nofollow" target="_blank">我们非常了解的</a>。</p><p id="1bdc" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">让我们看看可爱的Kotlin编译器将在JVM中生成什么，并将其翻译成Java:</p><pre class="kd ke kf kg gt mm ml mn mo aw mp bi"><span id="9a40" class="mq ll in ml b gy mr ms l mt mu">Cat maybeACat = <em class="my">openBox</em>();<br/>if ((maybeACat != null ? maybeACat.getMeow() : null) == null) {<br/>   Intrinsics.throwNpe();<br/>}</span></pre><p id="6d02" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在这段代码中没有什么特别需要解释的:我们只是创建了一个<code class="fe mi mj mk ml b">maybeACat</code>变量，如果这个变量或者它的getter<code class="fe mi mj mk ml b">getMeow() </code>(kot Lin中我们的<code class="fe mi mj mk ml b">meow</code>属性的对应物)的结果为null，我们将抛出一个NPE。</p><p id="70e3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">下面是完整的代码，仅供参考。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="4911" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我希望能消除对科特林内在行为的一些疑虑。<strong class="kq io">记住按下和不按下👏🏻按钮，如果你喜欢(或不喜欢)这个职位！</strong></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ng"><img src="../Images/91567e4b98538c69027326e5fd514c8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0XVvSkNcETKy34wQ.jpg"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk">Sorry for the long post, here’s a photo of a kitten! :3 (photo by <a class="ae mh" href="https://www.flickr.com/people/85603833@N00" rel="noopener ugc nofollow" target="_blank">Nicolas Suzor</a> from Brisbane, Australia)</figcaption></figure></div><div class="ab cl nl nm hr nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="ig ih ii ij ik"><p id="2ae5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">了解卡帕头最新的重大新闻。学院、<a class="ae mh" href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a" rel="noopener ugc nofollow" target="_blank">订阅时事通讯</a>、<a class="ae mh" href="https://twitter.com/ktdotacademy" rel="noopener ugc nofollow" target="_blank">观察Twitter </a>并在medium上关注我们。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><a href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a"><div class="gh gi ns"><img src="../Images/5ce68714efe3efc036e06786166954ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uDqv_d5NZnPUJA0FeZqhqQ.png"/></div></a></figure></div></div>    
</body>
</html>