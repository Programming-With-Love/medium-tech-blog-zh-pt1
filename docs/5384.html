<html>
<head>
<title>3-Legged OAuth flow to invoke Fusion Apps Rest Endpoints</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">调用融合应用程序Rest端点的三分支OAuth流程</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/3-legged-oauth-flow-to-invoke-fusion-apps-rest-endpoints-5fc6b0b7b059?source=collection_archive---------3-----------------------#2018-01-16">https://medium.com/oracledevs/3-legged-oauth-flow-to-invoke-fusion-apps-rest-endpoints-5fc6b0b7b059?source=collection_archive---------3-----------------------#2018-01-16</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="90ac" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是我撰写的系列博客中的第五篇，旨在解释Oracle融合应用程序与PaaS服务的身份集成，使用身份云服务来实现服务之间的单点登录。这是这个系列的博客列表</p><ol class=""><li id="f375" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><a class="ae jl" rel="noopener" href="/@amit.gokhru/understanding-the-integration-architecture-fusion-application-with-platform-services-9b8297594873">了解集成架构——融合应用与平台服务</a></li><li id="8f20" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated"><a class="ae jl" rel="noopener" href="/@amit.gokhru/enable-federation-with-fusion-apps-as-identity-provider-1ca6d795659c">启用融合应用作为身份提供商的联盟</a></li><li id="f8d6" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated"><a class="ae jl" rel="noopener" href="/@amit.gokhru/enable-federation-with-identity-cloud-service-as-identity-provider-36e80d2bc4ec">启用身份云服务作为身份提供商的联盟</a></li><li id="9d25" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated"><a class="ae jl" rel="noopener" href="/@amit.gokhru/setting-up-users-and-roles-synchronization-between-fusion-apps-and-identity-cloud-service-70dcf2144107">在融合应用和身份云服务之间设置用户和角色同步</a></li><li id="65f7" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated"><a class="ae jl" rel="noopener" href="/@amit.gokhru/3-legged-oauth-flow-to-invoke-fusion-apps-rest-endpoints-5fc6b0b7b059">调用Fusion Apps rest端点的三脚OAuth流。</a></li></ol><p id="1ebf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这篇博客中，我将解释我们如何利用3条腿的OAuth，这是IDCS与融合应用集成的一项新功能。</p><p id="973b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，如#2、#3和#4中所述的联合和同步设置是实现这一点的先决条件。</p><p id="3c0b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">需要这样做的一些重要用例是-</p><ol class=""><li id="203f" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">在用户登录和同意的情况下显示融合数据的自定义应用程序。</li><li id="9825" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">经同意，第三方应用程序获取用户的融合数据。</li></ol><p id="f27f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面是此类应用程序的应用程序架构，它利用了三脚OAuth</p><figure class="js jt ju jv fd jw er es paragraph-image"><div class="er es jr"><img src="../Images/57648e1ba3b3c9fc6243d8ae86fce152.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/1*5G6cFPg2zM90TENbAK_Dvg.png"/></div></figure><p id="c923" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">申请流程如下-</p><ol class=""><li id="d8c3" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">用户访问web应用程序中需要访问其融合应用程序数据的区域。</li><li id="6da4" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">自定义应用程序将用户重定向到IDCS进行身份验证。</li><li id="18cb" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">IDCS显示登录页面，用户使用其凭证登录，并同意应用程序访问其数据。</li><li id="866b" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">IDCS用授权码返回到应用程序</li><li id="ee6a" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">应用程序向IDCS请求访问令牌，提交授权码、客户端id和客户端秘密</li><li id="ade7" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">IDCS返回接入令牌</li><li id="47aa" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">应用程序调用融合应用程序的Rest端点。</li><li id="65d9" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jh ji jj jk bi translated">融合应用验证访问令牌并将用户数据返回给应用。</li></ol><p id="a753" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们看看如何实现上面的流程-</p><ol class=""><li id="e050" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">为Fusion Application Rest端点配置OAuth资源(如果尚不可用)</li></ol><ul class=""><li id="9e6c" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jz ji jj jk bi translated">登录IDCS管理控制台&gt;单击“应用程序”选项卡&gt;“添加”</li><li id="7b89" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jz ji jj jk bi translated">在应用程序向导中，选择“可信应用程序”</li><li id="b746" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jz ji jj jk bi translated">在“应用程序详细信息”页面上，提供应用程序名称和描述，然后单击下一步</li><li id="08c8" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jz ji jj jk bi translated">跳过客户端配置，然后单击“下一步”</li><li id="860e" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jz ji jj jk bi translated">选择单选按钮“立即将应用程序配置为资源服务器”,将融合应用程序API路径配置为OAuth资源</li></ul><p id="febe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">—提供“主要受众”= FA端点的主机</p><p id="6bd4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">—单击“允许范围”上的“添加”,添加主要和次要受众的允许范围</p><figure class="js jt ju jv fd jw er es paragraph-image"><div class="er es ka"><img src="../Images/ad615cfeb88e693921d760f349ba869b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*Bd7IvpWwQ1Q4nMdOxkWKng.png"/></div></figure><ul class=""><li id="615a" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jz ji jj jk bi translated">查看受众和允许的范围，然后单击下一步。您可以添加特定的API作为作用域，然后为那些允许的作用域请求访问令牌。当您添加“/”作为允许的范围时，请确保在请求访问令牌时使用“受众”+“/”作为范围。</li></ul><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kb"><img src="../Images/4a96ad661f6da038aea2a220f38b9833.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eV3tkPvk7pP5BYrZWEFXwQ.png"/></div></div></figure><ul class=""><li id="4a54" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jz ji jj jk bi translated">单击完成</li><li id="9fc3" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jz ji jj jk bi translated">激活应用程序</li></ul><p id="ef58" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2.为您的自定义应用程序配置Oauth客户端</p><ul class=""><li id="7319" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jz ji jj jk bi translated">登录IDCS管理控制台&gt;单击“应用程序”选项卡&gt;“添加”</li><li id="2a3b" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jz ji jj jk bi translated">在应用程序向导中，选择“可信应用程序”</li><li id="aa1e" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jz ji jj jk bi translated">在“应用程序详细信息”页面上，提供应用程序名称和描述，然后单击下一步</li><li id="ce8a" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jz ji jj jk bi translated">选择“立即将应用程序配置为客户端”</li></ul><p id="9095" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">—选择“授权代码”和“刷新令牌”作为允许的授权类型</p><p id="ff54" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">—在“重定向URL”中提供用户登录后要重定向的应用程序URL</p><p id="0abd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">—在“注销URL”中提供您的应用程序注销URL</p><p id="39fe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">—在“注销后重定向URL”中提供您的注销后URL</p><p id="db74" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">—从“允许的范围”中的FA资源添加API</p><figure class="js jt ju jv fd jw er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kg"><img src="../Images/043a2b35c453991f03fdbce7d47e7656.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YtZDWmP8fAUsRV7qE214dA.png"/></div></div></figure><ul class=""><li id="51a4" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jz ji jj jk bi translated">单击完成</li><li id="f063" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jz ji jj jk bi translated">记下客户端id和客户端密码</li><li id="59a6" class="jc jd hh ig b ih jm il jn ip jo it jp ix jq jb jz ji jj jk bi translated">激活应用程序</li></ul><p id="3bd9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">3.应用程序配置—将用户重定向到IDCS端点，他以此身份访问私有内容</p><pre class="js jt ju jv fd kh ki kj kk aw kl bi"><span id="d4d6" class="km kn hh ki b fi ko kp l kq kr"><a class="ae jl" href="https://%3cIDCS" rel="noopener ugc nofollow" target="_blank">https://&lt;IDCS</a> HOST&gt;/oauth2/v1/authorize?client_id=&lt;CLIENT - ID&gt;&amp;response_type=code&amp;redirect_uri=&lt;REDIRECT URL AS CONFIGURED IN CLIENT&gt;&amp;scope=&lt;SCOPE AS CONFIGURED IN CLIENT ALLOWED SCOPE&gt;</span></pre><p id="7545" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">4.成功认证后，IDCS将按照给定的重定向URL重定向回应用程序，请求参数中包含AUTH-CODE。从请求中获取授权码(JAVA代码)</p><pre class="js jt ju jv fd kh ki kj kk aw kl bi"><span id="39ba" class="km kn hh ki b fi ko kp l kq kr">String code = httpReq.getParameter("code");<br/>if (code == null || code.length() == 0) {<br/>  LOGGER.log(Level.SEVERE, "Invalid Code");<br/>}<br/>String authCode;<br/>try {<br/>  authCode= URLEncoder.encode(code, "UTF8");<br/>} catch (Exception e) {<br/>  LOGGER.log("Exception occurred!!")<br/>}</span></pre><p id="da66" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">5.通过在IDCS令牌端点(JAVA代码)上提交授权代码、客户端id和客户端机密，从授权代码获取访问令牌</p><pre class="js jt ju jv fd kh ki kj kk aw kl bi"><span id="fc03" class="km kn hh ki b fi ko kp l kq kr">String IDCSTokenURL = "<a class="ae jl" href="https://%3cIDCS" rel="noopener ugc nofollow" target="_blank">https://&lt;IDCS</a> HOST&gt;/oauth2/v1/token";<br/>String postBody = "grant_type=authorization_code"+"&amp;code="+authCode;</span><span id="caed" class="km kn hh ki b fi ks kp l kq kr">Response httpResponse;</span><span id="f305" class="km kn hh ki b fi ks kp l kq kr">Map&lt;String, String&gt; requestOptions = new HashMap&lt;&gt;();<br/>requestOptions.put("Accept", "*/*");<br/>String authzHdrVal = "&lt;CLIENT-ID&gt;" + ":" + "&lt;CLIENT-SECRET&gt;";<br/>requestOptions.put("Authorization", "Basic "  + DatatypeConverter.printBase64Binary(authzHdrVal.getBytes("UTF-8")));</span><span id="6c3b" class="km kn hh ki b fi ks kp l kq kr">httpResponse = execHttpRequest(IDCSTokenURL , "POST", requestOptions, postBody);</span><span id="29c8" class="km kn hh ki b fi ks kp l kq kr">String result = httpResponse.getResponseBodyAsString("UTF-8");<br/>JSONObject json = new JSONObject(result);<br/>IDCSAccessToken = json.getString("access_token");</span></pre><p id="838a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">6.使用访问令牌(JAVA代码)调用融合应用程序的REST端点</p><pre class="js jt ju jv fd kh ki kj kk aw kl bi"><span id="3478" class="km kn hh ki b fi ko kp l kq kr">Client client = null;<br/>WebResource resource = null;</span><span id="5c30" class="km kn hh ki b fi ks kp l kq kr">ClientConfig cc = new DefaultClientConfig();<br/>client = Client.create(cc);</span><span id="9e5b" class="km kn hh ki b fi ks kp l kq kr">String fusionAPIURL = new String(&lt;FA API URL&gt;);<br/>resource = client.resource(url);</span><span id="1e80" class="km kn hh ki b fi ks kp l kq kr">ClientResponse clientResponse= null;<br/>clientResponse= resource.header("user.tenant.name", "&lt;FA tenant name&gt;").header("Authorization", "Bearer " + accessToken).accept("application/json").get(ClientResponse.class);</span></pre><p id="692b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">7.从Fusion获得数据后，您的应用程序可以根据需要在应用程序UI中显示这些数据。</p><p id="80af" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这就结束了我们的3脚OAuth的实现，它支持运行时用户认证和同意第三方应用程序访问用户的融合数据。</p><p id="7745" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kt">本文表达的观点是我个人的观点，不一定代表甲骨文的观点。</em></p></div></div>    
</body>
</html>