<html>
<head>
<title>Cloud interoperability, part1: building apps in AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">云互操作性，第1部分:在AWS中构建应用程序</h1>
<blockquote>原文：<a href="https://medium.com/globant/cloud-interoperability-part1-building-apps-in-aws-22cf2266011c?source=collection_archive---------2-----------------------#2021-02-04">https://medium.com/globant/cloud-interoperability-part1-building-apps-in-aws-22cf2266011c?source=collection_archive---------2-----------------------#2021-02-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="1e74" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">使用Kubicorn和Jenkins在K8s上部署应用</strong></h1><p id="c456" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">本文是关于使用Kubicorn创建Kubernetes集群和使用Jenkins CI/CD在Kubernetes上部署应用程序。本文档重点介绍AWS中的基础架构创建。然而，相同的设置可以在其他一些众所周知的公共云平台中复制，如Azure、GCP等。</p><p id="306f" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">kubi corn简介</strong></p><p id="4cee" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">Kubicorn是一个Kubernetes基础设施管理工具。它用于以云本地方式管理基于kubernetes的基础设施。这是一个免费的开源项目。该项目由云原生计算基金会(CNCF)支持，并试图为云原生基础架构提供一些独特的东西:</p><p id="3b69" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">它有模块化的组件，是Go中可出售的库，具有灵活性和可伸缩性。它提供了一种可靠的方法来引导和管理您的基础架构软件。使用Kubicorn，用户可以声明式地创建新集群，修改和扩展它们。</p><p id="5b0f" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">先决条件</strong></p><ul class=""><li id="3eac" class="kf kg hh je b jf ka jj kb jn kh jr ki jv kj jz kk kl km kn bi translated">詹金斯</li><li id="3a2a" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kk kl km kn bi translated">Ansible</li><li id="bb14" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kk kl km kn bi translated">库比科恩</li><li id="6ba4" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kk kl km kn bi translated">开源代码库</li></ul><p id="9f48" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">高液位流量描述</strong></p><figure class="ku kv kw kx fd ky er es paragraph-image"><div class="er es kt"><img src="../Images/4dddc4efef975b0e543d79c6bf28dbe9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/0*4TkfeqYUkp_DisuZ"/></div><figcaption class="lb lc et er es ld le bd b be z dx">Diagram: High level flow</figcaption></figure><p id="1ef8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">根据高级流程图，Actor将<strong class="je hi"/>Spring boot应用程序库提交到GitHub。一旦所有的推送都完成了，Jenkins将触发spring boot repository的工作并构建代码。然后通过Go命令安装Kubicorn。K8s主节点和工作节点的配置是通过Kubicorn实现的。最后，在K8s集群上部署spring boot应用程序使用了Jenkins pipeline中的kubectl命令。</p><p id="5922" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">详细流程描述</strong></p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lf"><img src="../Images/e41cd6e3b6c1a071e15e03ac312dde26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XLnN8gBHhsr9-LhX"/></div></div><figcaption class="lb lc et er es ld le bd b be z dx">Diagram: Detailed flow</figcaption></figure><p id="7fc3" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">根据详细的流程图，Actor将代码推入GitHub。所有推送完成后，Jenkins会自动触发构建设置。使用GO命令安装Kubicorn。K8s集群将通过Kubicorn create和apply命令创建。</p><p id="8cab" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">Spring boot应用程序是通过Jenkins构建的。Kubicorn是通过Jenkinsfile安装的。K8s集群是使用Kubicorn创建的，在K8s集群上部署Spring boot应用程序使用的是Jenkins Pipeline。最后，K8s集群通过Jenkins管道自动创建pod、服务和复制控制器。</p><p id="5a95" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">CICD使用Jenkins创建Kubicorn并在Kubernetes集群上部署Spring-boot应用的步骤</strong></p><p id="0194" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">安装步骤</strong></p><ol class=""><li id="5046" class="kf kg hh je b jf ka jj kb jn kh jr ki jv kj jz lk kl km kn bi translated"><strong class="je hi">安装Ansible </strong></li></ol><p id="e41b" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">在AWS中安装t2.medium实例(CPU Core 2，RAM 8GB)以便安装Ansible，因为GO安装至少需要4GB RAM和2个CPU Core。</p><pre class="ku kv kw kx fd ll lm ln lo aw lp bi"><span id="7094" class="lq if hh lm b fi lr ls l lt lu">apt update<br/>apt install openjdk-8-jdk<br/>apt-add-repository ppa:ansible/ansible<br/>apt update<br/>apt install ansible -y<br/>Ansible -- version</span></pre><p id="d251" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">2.<strong class="je hi">安装詹金斯服务器</strong></p><p id="527d" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">通过Ansible playbook安装Jenkins和ssh-key-gen，如下所示:</p><p id="86e5" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">詹金斯安装的可行剧本 :-</p><pre class="ku kv kw kx fd ll lm ln lo aw lp bi"><span id="6da8" class="lq if hh lm b fi lr ls l lt lu">--- <br/>- hosts: localhost<br/>  tasks: <br/>    - name: "ensure the Jenkins apt repository key is installed"<br/>      apt_key: "url=<a class="ae lv" href="https://pkg.Jenkins.io/debian-stable/Jenkins.io.key" rel="noopener ugc nofollow" target="_blank">https://pkg.Jenkins.io/debian-stable/Jenkins.io.key</a> state=present"<br/>      become: true</span><span id="9ae2" class="lq if hh lm b fi lw ls l lt lu">    - name: "ensure the repository is configured"  <br/>      apt_repository: "repo='deb <a class="ae lv" href="https://pkg.Jenkins.io/debian-stable" rel="noopener ugc nofollow" target="_blank">https://pkg.Jenkins.io/debian-stable</a> binary/' state=present"<br/>      become: true</span><span id="a506" class="lq if hh lm b fi lw ls l lt lu">    - name: "ensure Jenkins is installed"<br/>      apt: "name=Jenkins update_cache=yes"<br/>      become: true<br/>    <br/>    - name: "ensure Jenkins is running"<br/>      service: "name=Jenkins state=started"</span></pre><p id="0185" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">以上行动手册用于使用Ansible行动手册安装Jenkins服务器。按照第一项任务，它将检查是否安装了Jenkins apt存储库密钥，配置Jenkins apt密钥，通过apt命令安装Jenkins，然后启动Jenkins服务。</p><p id="2ecb" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">ssh-key-gen的可行剧本</strong></p><pre class="ku kv kw kx fd ll lm ln lo aw lp bi"><span id="662d" class="lq if hh lm b fi lr ls l lt lu">---<br/>- hosts: localhost<br/>  become_user: Jenkins<br/>  become: yes<br/>  - name: Exchange Keys between servers<br/>  tasks:<br/>  - name: SSH KeyGen command<br/>    tags: run<br/>    shell: ssh-keygen -q -b 2048 -t rsa -N "" -C "creating SSH" -f ~/.ssh/id_rsa creates="~/.ssh/id_rsa"</span></pre><p id="d1bf" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">上述剧本用于Jenkins和kubernetes主服务器之间的无密码认证。</p><p id="a8b7" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi"> 3。在AWSCLI的AWS中创建IAM角色，如下图所示</strong></p><pre class="ku kv kw kx fd ll lm ln lo aw lp bi"><span id="9ded" class="lq if hh lm b fi lr ls l lt lu">#######tasks/main.yml <br/>##==================<br/>---<br/> - name: Ensure pip is installed<br/>   apt:<br/>     name: python-pip<br/>     update_cache: yes<br/>     state: latest<br/> - name: pip install awscli<br/>   pip:<br/>     name: awscli<br/>     state: latest<br/> - name: Ensure .aws directory under user home for awscli config<br/>   file:<br/>     path: "/var/lib/{{ item.username }}/.aws"<br/>     state: directory<br/>     owner: "{{ item.username }}"<br/>     group: "{{ item.username }}"<br/>     mode: 0755<br/>     when: item.get('state', 'present') == 'present'<br/>     with_items: "{{ awscli_users }}"<br/> - name: Copy awscli config to remote server<br/>   template:<br/>     src: awscli_config.j2<br/>     dest: "/var/lib/{{ item.username }}/.aws/config"<br/>     owner: "{{ item.username }}"<br/>     group: "{{ item.username }}"<br/>     mode: 0644<br/>     when: item.get('state', 'present') == 'present'<br/>     with_items: "{{ awscli_users }}"</span><span id="c836" class="lq if hh lm b fi lw ls l lt lu">######templates/awscli_config.j2.yml <br/>###===================================<br/>[default]<br/>output = {{ item.awscli.aws_output_format }}<br/>region = {{ item.awscli.aws_region }}<br/>aws_access_key_id = {{ item.awscli.aws_access_key_id }}<br/>aws_secret_access_key = {{ item.awscli.aws_secret_access_key }}</span><span id="4278" class="lq if hh lm b fi lw ls l lt lu">########vars/main.yml <br/>###========<br/>---<br/>awscli_users:<br/>- username: Jenkins<br/>state: present<br/>awscli:<br/>aws_region: us-west-2<br/>aws_output_format: json # format can be 'text','table' and 'json'<br/>aws_access_key_id: 'XXXXXXXXXXXXXX'<br/>aws_secret_access_key: 'XXXXXXXXXXXXXXXXXXXXXXXXXX'</span><span id="7d23" class="lq if hh lm b fi lw ls l lt lu">###site.yml<br/>###============================<br/>--- <br/>- hosts: localhost<br/>  roles: <br/>    - awscli</span></pre><p id="56f8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">上面的剧本是在ubuntu中安装pip。然后通过pip命令安装AWSCLI，确保。awsCLI配置和权限的用户主目录下的AWS目录是755，然后将AWSCLI配置复制到远程服务器(这里我使用的是神牙模板/动态模板，权限应该是644)。在神牙模板中，指定输出格式、区域、aws_access_key_id和密钥id(它用于对aws服务的编程API访问。您可以在AWS管理控制台中管理您的访问键)最后，将角色定义为awscli。</p><p id="9ae4" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">4.<strong class="je hi">通过Jenkins管道安装kubi corn</strong></p><pre class="ku kv kw kx fd ll lm ln lo aw lp bi"><span id="b4b5" class="lq if hh lm b fi lr ls l lt lu">pipeline{<br/>agent any<br/>stages{<br/>stage("Installing Kubicorn Through Go"){<br/>steps {<br/>sh "sudo snap install go --classic"<br/>sh "go version"<br/>sh "go get github.com/Kubicorn/Kubicorn"<br/>}<br/>}<br/>stage("Link File"){<br/>steps {<br/>script {<br/>try{<br/>sh label: '', script: '''sudo rm /usr/local/bin/Kubicorn<br/>sudo ln -s /var/lib/Jenkins/go/bin/Kubicorn /usr/local<br/>/bin/Kubicorn'''<br/>}<br/>catch(Exception e){<br/>sh label: '', script: 'sudo ln -s /var/lib/Jenkins/go<br/>/bin/Kubicorn /usr/local/bin/Kubicorn'<br/>}<br/>sh "Kubicorn version"<br/>}<br/>}<br/>}<br/>stage("Kubicorn Creation"){<br/>steps {<br/>sh "Kubicorn create K8s${env.BUILD_NUMBER} --profile aws"<br/>sh "sed -i 's/\"size\":\"t2.xlarge\"/\"size\":\"t2.medium\"/g' /var/lib/Jenkins<br/>/workspace/ksjob/_state/K8s${env.BUILD_NUMBER}/cluster.yaml"<br/>}<br/>}<br/>stage("Kubicorn Apply"){<br/>steps {<br/>sh "Kubicorn apply K8s${env.BUILD_NUMBER}"<br/>}<br/>}<br/>stage("Find Ip_address and Deploy apps on K8s") {<br/>steps {<br/>script {<br/>def ipaddress = sh(script: "aws ec2 describe-instances --filters 'Name=tag:Name,Values=K8s1.<br/>master' --query 'Reservations[*].Instances[*].PublicIpAddress'<br/>--output=text", returnStdout: true).trim()<br/>sh "ssh -o StrictHostKeyChecking=no -i /var/lib/Jenkins/.ssh/id_rsa ubuntu@${ipaddress} \"<br/>git clone <a class="ae lv" href="https://github.com/gajuk/spring-mongo-app.git\" rel="noopener ugc nofollow" target="_blank">https://github.com/gajuk/spring-mongo-app.git\</a>""<br/>sh "ssh -o StrictHostKeyChecking=no -i /var/lib/Jenkins/.ssh/id_rsa<br/>ubuntu@${ipaddress} \"kubectl apply -f /home/ubuntu/spring-mongo-app/springBootMongo.yml\""<br/>}<br/>}<br/>}<br/>stage("Remove and Add Security Group for Master") {<br/>steps {<br/>script {<br/>def sgid = sh(script: "aws ec2 describe-security-groups --filters 'Name=tag:Name,<br/>Values=K8s1.master*' --query 'SecurityGroups[*].{ID:GroupId}' <br/>--output=text", returnStdout: true).trim()<br/>sh "aws ec2 revoke-security-group-ingress --group-id ${sgid} <br/>--protocol all --cidr 10.X.X.X/24" (this range will vary based on VPC CIDR range selection)<br/>sh "aws ec2 authorize-security-group-ingress --group-id ${sgid} <br/>--protocol all --cidr 0.0.0.0/0"<br/>}<br/>}<br/>}<br/>stage("Remove and Add Security Group for Worker") {<br/>steps {<br/>script {<br/>def sgid = sh(script: "aws ec2 describe-security-groups --filters 'Name=tag:Name,<br/>Values=K8s1.node*' --query 'SecurityGroups[*].{ID:GroupId}' <br/>--output=text", returnStdout: true).trim()<br/>sh "aws ec2 revoke-security-group-ingress --group-id ${sgid} <br/>--protocol all --cidr 10.X.X.X/24" (this range will vary based on VPC CIDR range selection)<br/>sh "aws ec2 authorize-security-group-ingress --group-id ${sgid} <br/>--protocol all --cidr 0.0.0.0/0"<br/>}<br/>}<br/>}<br/>}<br/>}</span></pre><p id="a857" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">完成所有步骤后，上面的Jenkins管道将显示如下部署输出:</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="lg lh di li bf lj"><div class="er es lx"><img src="../Images/5d715a35e382518d1b636ea755236962.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*76K-6FTuxZgMkc4n"/></div></div><figcaption class="lb lc et er es ld le bd b be z dx">Deployment output</figcaption></figure><p id="88bf" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi"> Spring boot代码部署步骤</strong></p><ul class=""><li id="7057" class="kf kg hh je b jf ka jj kb jn kh jr ki jv kj jz kk kl km kn bi translated">通过GO命令安装Kubicorn。</li><li id="0be9" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kk kl km kn bi translated">使用Kubicorn创建K8s集群。</li><li id="178a" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kk kl km kn bi translated">使用Jenkins管道访问K8s主服务器，并使用kubectl命令部署spring boot应用程序。</li></ul><p id="d9c5" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">优点</strong></p><ul class=""><li id="e7a7" class="kf kg hh je b jf ka jj kb jn kh jr ki jv kj jz kk kl km kn bi translated">Kubicorn是声明式的、API驱动的方法</li><li id="4fb9" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kk kl km kn bi translated">它创建和供应虚拟机并设置Kubernetes</li><li id="3208" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kk kl km kn bi translated">它可以扩展和处理集群升级</li><li id="46d5" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kk kl km kn bi translated">它可以与任何云提供商和任何操作系统或映像兼容</li><li id="deac" class="kf kg hh je b jf ko jj kp jn kq jr kr jv ks jz kk kl km kn bi translated">根据云提供商的可用选项，用户可以通过提供引导脚本来定义如何配置实例和集群。</li></ul><h1 id="f9f6" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">结论</strong></h1><p id="a55b" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">本文简要介绍了如何安装Kubicorn、通过Jenkins pipeline部署spring boot应用程序以及通过Ansible playbook安装Jenkins。AWSCLI用于访问K8s主服务器IP地址。kubernetes的安装和配置是通过Kubicorn create and apply命令完成的。Kubicorn为我们创建了K8s集群，并通过Jenkins为spring boot应用程序完成了持续集成和持续部署。</p><p id="cc05" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">参考文献</strong></p><p id="84cb" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><a class="ae lv" href="http://kubicorn.io/" rel="noopener ugc nofollow" target="_blank">http://Kubicorn.io/</a></p><p id="f6e4" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><a class="ae lv" href="http://kubicorn.io/documentation/aws-walkthrough.html" rel="noopener ugc nofollow" target="_blank">http://Kubicorn.io/documentation/aws-walkthrough.html</a></p></div></div>    
</body>
</html>