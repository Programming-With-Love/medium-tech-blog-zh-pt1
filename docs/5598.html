<html>
<head>
<title>Changing Load Balancer shape in Oracle Container Engine (OKE) and updating DNS with ExternalDNS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">更改Oracle容器引擎(OKE)中的负载平衡器形状并使用外部DNS更新DNS</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/changing-load-balancer-shape-in-oracle-container-engine-oke-and-updating-dns-with-external-dns-7064f15cf600?source=collection_archive---------0-----------------------#2019-04-15">https://medium.com/oracledevs/changing-load-balancer-shape-in-oracle-container-engine-oke-and-updating-dns-with-external-dns-7064f15cf600?source=collection_archive---------0-----------------------#2019-04-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="er es ie"><img src="../Images/332b78c88aa834cce0515c5b895d0b0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/1*P_a_S1F_ndDUDzf-4aVetg.png"/></div></figure><p id="a311" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">在<a class="ae jj" rel="noopener" href="/oracledevs/loadbalancer-service-oracle-container-engine-oke-and-oci-dns-d7b1f7b4f9bd">之前的帖子</a>中，我们做了以下工作:</p><ol class=""><li id="7104" class="jk jl hh in b io ip is it iw jm ja jn je jo ji jp jq jr js bi translated">部署应用程序</li><li id="6155" class="jk jl hh in b io jt is ju iw jv ja jw je jx ji jp jq jr js bi translated">部署了一个负载平衡器服务，为您提供一个公共IP地址</li><li id="cfd4" class="jk jl hh in b io jt is ju iw jv ja jw je jx ji jp jq jr js bi translated">使用基于主机的规则创建入口</li></ol><p id="fe78" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">为了使这个服务可以通过DNS公开解析，我们还手动创建了一个DNS区域，以及一个DNS“A”记录，并将其指向负载平衡器的公共IP地址。默认情况下，创建的OCI负载平衡器的形状是“100 Mbps”。</p><h2 id="14ff" class="jy jz hh bd ka kb kc kd ke kf kg kh ki iw kj kk kl ja km kn ko je kp kq kr ks bi translated">打扫</h2><p id="8a76" class="pw-post-body-paragraph il im hh in b io kt iq ir is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ha bi translated">首先对之前的帖子做一点清理:</p><ol class=""><li id="6ccb" class="jk jl hh in b io ip is it iw jm ja jn je jo ji jp jq jr js bi translated">在OCI控制台中，导航到边缘服务、DNS区域管理，然后单击您的DNS区域名称</li><li id="609e" class="jk jl hh in b io jt is ju iw jv ja jw je jx ji jp jq jr js bi translated">通过选中DNS“A”记录旁边的复选框，从中选择该记录，然后选择操作&gt;删除。然后，单击发布更改以使更改生效。</li><li id="5cd4" class="jk jl hh in b io jt is ju iw jv ja jw je jx ji jp jq jr js bi translated">删除负载平衡器服务:</li></ol><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="b464" class="jy jz hh ld b fi lh li l lj lk">kubectl delete svc nginx-ingress-controller</span></pre><h2 id="2f5a" class="jy jz hh bd ka kb kc kd ke kf kg kh ki iw kj kk kl ja km kn ko je kp kq kr ks bi translated">更改负载平衡器的形状</h2><p id="12d0" class="pw-post-body-paragraph il im hh in b io kt iq ir is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ha bi translated">比方说，您的应用程序正在处理增加的负载，您想要更改负载平衡器的形状。</p><p id="e904" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">您可以通过添加注释来做到这一点。你可以在这里查看可用的注释<a class="ae jj" href="https://github.com/oracle/oci-cloud-controller-manager/blob/master/docs/load-balancer-annotations.md" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="aa5c" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">下载hello-ingresscontroller.yaml:</p><p id="a94b" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">curl-o hello-ingress controller . YAML<a class="ae jj" href="https://raw.githubusercontent.com/hyder/okesamples/master/loadbalancer/hello-ingresscontroller.yaml" rel="noopener ugc nofollow" target="_blank">https://raw . githubusercontent . com/Hyder/oke samples/master/load balancer/hello-ingress controller . YAML</a></p><p id="4fbb" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">将以下注释添加到hello-ingresscontroller.yaml中</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="e63f" class="jy jz hh ld b fi lh li l lj lk">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nginx-ingress-controller<br/>  namespace: default<br/>  labels:<br/>    app: nginx-ingress-controller<br/>  <strong class="ld hi">annotations:<br/>    service.beta.kubernetes.io/oci-load-balancer-shape: "400Mbps"</strong><br/>spec:<br/>  type: LoadBalancer<br/>  ports:<br/>  - port: 80<br/>    nodePort: 30021<br/>    name: http<br/>  - port: 443<br/>    nodePort: 30022<br/>    name: https<br/>  selector:<br/>    app: nginx-ingress-controller</span></pre><p id="2089" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">如果您希望指定负载平衡器所需的两个子网，也可以这样做。如果没有，系统会自动为您选择它们。</p><p id="a764" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">应用更改:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="524a" class="jy jz hh ld b fi lh li l lj lk">kubectl apply -f hello-ingresscontroller.yaml</span></pre><p id="5e3d" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">验证负载平衡器的形状现在已更改为400Mbps:</p><figure class="ky kz la lb fd ii er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es ll"><img src="../Images/774293cf72c630cda8cdc220953138b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*POvP2-PiXfrW5jGfqq2tKw.png"/></div></div></figure><p id="9d0d" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">为了让您的FQDN解析到新的IP地址，您需要编辑之前创建的DNS“A”记录并更新IP地址。</p><p id="ec07" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">手动进行所有这些更改和更新可能会很乏味。如果能自动更新这个不是很好吗？向前一步<a class="ae jj" href="https://github.com/kubernetes-incubator/external-dns" rel="noopener ugc nofollow" target="_blank">外部DNS </a>。</p><h2 id="d1c1" class="jy jz hh bd ka kb kc kd ke kf kg kh ki iw kj kk kl ja km kn ko je kp kq kr ks bi translated">外部DNS</h2><p id="172e" class="pw-post-body-paragraph il im hh in b io kt iq ir is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ha bi translated">ExternalDNS通过将DNS记录与预期的入口点同步来为您处理这最后一点，特别是当您使用基于请求主机的Ingresses时。</p><p id="7a57" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">外部DNS使Kubernetes资源(如服务和入口)可以使用公共DNS服务器被发现。它配置公共DNS服务器并更新所需的DNS记录，因此您不必手动完成。</p><figure class="ky kz la lb fd ii er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lq"><img src="../Images/6fe8b628bb1837bfce47d0bc048a5fb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eitN_2eImoDPUd592NLQ7g.png"/></div></div></figure><p id="7277" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">首先，创建以下yaml并将其保存到oci.yaml:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="404c" class="jy jz hh ld b fi lh li l lj lk">auth:<br/>  region: us-phoenix-1<br/>  tenancy: ocid1.tenancy.oc1...<br/>  user: ocid1.user.oc1...<br/>  key: |<br/>    -----BEGIN RSA PRIVATE KEY-----<br/>    -----END RSA PRIVATE KEY-----<br/>  fingerprint: af:81:71:8e...<br/>compartment: ocid1.compartment.oc1...</span></pre><p id="0314" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">该密钥必须与您的api私钥相匹配。如果你已经使用<a class="ae jj" href="https://github.com/oracle-terraform-modules/terraform-oci-oke" rel="noopener ugc nofollow" target="_blank"><strong class="in hi">terra form-OCI-OKE</strong></a>创建了你的OKE集群，你将已经拥有这些。如果没有，按照<a class="ae jj" href="https://github.com/oracle-terraform-modules/terraform-oci-oke/blob/master/docs/instructions.md" rel="noopener ugc nofollow" target="_blank">指令</a>创建密钥并上传到OCI。</p><p id="9804" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">您现在可以创建一个秘密:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="e755" class="jy jz hh ld b fi lh li l lj lk">kubectl create secret generic external-dns-config --from-file=oci.yaml</span></pre><p id="1619" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">接下来，为ExternalDNS创建ServiceAccount、ClusterRoleBinding和部署:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="cede" class="jy jz hh ld b fi lh li l lj lk">kubectl apply -f   <a class="ae jj" href="https://raw.githubusercontent.com/hyder/okesamples/master/loadbalancer/externaldns-rbac.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/hyder/okesamples/master/loadbalancer/externaldns-rbac.yaml</a></span></pre><p id="3489" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">编辑更新负载平衡器的注释:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="9637" class="jy jz hh ld b fi lh li l lj lk">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nginx-ingress-controller<br/>  namespace: default<br/>  labels:<br/>    app: nginx-ingress-controller<br/>  annotations:<br/>    service.beta.kubernetes.io/oci-load-balancer-shape: "400Mbps"<br/>    <strong class="ld hi">external-dns.alpha.kubernetes.io/hostname: www.example.org</strong><br/>spec:<br/>  type: LoadBalancer<br/>  ports:<br/>  - port: 80<br/>    nodePort: 30021<br/>    name: http<br/>  - port: 443<br/>    nodePort: 30022<br/>    name: https<br/>  selector:<br/>    app: nginx-ingress-controller</span></pre><p id="2ec5" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">并再次应用它:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="35a3" class="jy jz hh ld b fi lh li l lj lk">kubectl apply -f hello-ingresscontroller.yaml</span></pre><p id="8af4" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">验证以下内容:</p><ol class=""><li id="a27b" class="jk jl hh in b io ip is it iw jm ja jn je jo ji jp jq jr js bi translated">已经使用负载平衡器的IP地址创建了DNS“A”记录</li><li id="d3db" class="jk jl hh in b io jt is ju iw jv ja jw je jx ji jp jq jr js bi translated">您可以使用nslookup公开解析您的FQDN，或者在此应用程序的情况下，使用您的浏览器，您可能需要等待几分钟才能更新更改。</li></ol><p id="68f6" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">想了解更多关于OCI外部域名的信息，你可以查看GitHub上的<a class="ae jj" href="https://github.com/kubernetes-incubator/external-dns/blob/master/docs/tutorials/oracle.md" rel="noopener ugc nofollow" target="_blank">教程</a>。</p><p id="0c45" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">如果你用的是Oracle Dyn，可以参考<a class="ae jj" href="https://github.com/kubernetes-incubator/external-dns/blob/master/docs/tutorials/dyn.md" rel="noopener ugc nofollow" target="_blank">本教程</a>来代替。</p></div></div>    
</body>
</html>