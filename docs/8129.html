<html>
<head>
<title>Apache Spark Performance Engineering using Sparklens</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Sparklens的Apache Spark性能工程</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/apache-spark-performance-engineering-using-sparklens-62c2da5bfc2?source=collection_archive---------2-----------------------#2022-07-14">https://medium.com/walmartglobaltech/apache-spark-performance-engineering-using-sparklens-62c2da5bfc2?source=collection_archive---------2-----------------------#2022-07-14</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/efd0896f2be24b3cf10112553a069cff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cYU0CJ1mOGik5d_oMQ9cJg.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Image by <a class="ae it" href="https://pixabay.com/users/jestermaroc-1131603/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1610815" rel="noopener ugc nofollow" target="_blank">jestermaroc</a> from <a class="ae it" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1610815" rel="noopener ugc nofollow" target="_blank">Pixabay</a></figcaption></figure><p id="5073" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这篇博客是由西瓦库玛的合著的</p><p id="8ecc" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Apache Spark是用于大规模数据处理和转换的最受欢迎的开源计算引擎之一。有效利用计算资源(驱动程序+执行器)、缓解任务/数据不对称以及解决高垃圾收集问题，对于Spark作业以最佳性能运行以节省时间和成本至关重要。</p><p id="6625" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">有各种数据分析工具可以帮助收集和分析Spark作业指标，并通过为决策和性能调整提供详细分析来增加价值。</p><p id="0612" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">什么是侧写员？</strong> <br/>在软件工程中，概要分析通常被称为“程序概要分析”、“软件概要分析”、“应用概要分析”等。它是动态程序分析的一种形式，例如，测量程序的空间(内存)或时间复杂性、特定指令的使用，或者函数调用的频率和持续时间。</p><p id="c56c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最常见的是，分析信息有助于开发团队识别程序优化、成本节约和有效利用可用资源的机会，更具体地说，是性能工程。</p><p id="8306" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">有哪些不同的火花剖析仪？</strong></p><p id="cd04" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们分享了一些可用的火花分析器。<br/><em class="ju">火花</em>(<a class="ae it" href="https://github.com/qubole/sparklens" rel="noopener ugc nofollow" target="_blank">https://github.com/qubole/sparklens</a>)<br/><em class="ju">火花测量</em>(<a class="ae it" href="https://github.com/LucaCanali/sparkMeasure" rel="noopener ugc nofollow" target="_blank">https://github.com/LucaCanali/sparkMeasure</a>)<br/><em class="ju">火花线</em>(<a class="ae it" href="https://github.com/groupon/sparklint" rel="noopener ugc nofollow" target="_blank">https://github.com/groupon/sparklint</a>)<br/><em class="ju">大象博士</em>(<a class="ae it" href="https://github.com/linkedin/dr-elephant" rel="noopener ugc nofollow" target="_blank">https://github.com/linkedin/dr-elephant</a>)<br/><em class="ju">火花镜</em>(<a class="ae it" href="https://github.com/ibm-research-ireland/sparkoscope" rel="noopener ugc nofollow" target="_blank">https://github.com/ibm-research-ireland/sparkoscope</a></p><p id="b97e" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在这篇博客中，我们将关注Sparklens。</p><p id="adfb" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">什么是火花？</strong></p><p id="e341" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Sparklens是一个开源剖析工具，内置了用Scala编写的Spark调度模拟器。它可以用于“任何”火花应用。它是在Qubole开发和维护的。</p><p id="0247" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Sparklens主要帮助破译Spark作业指标，以了解Spark作业的可扩展性限制，并确定有效调整我们的Spark作业的各种机会。</p><p id="610b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">它还有助于了解给定Spark应用程序使用提供给它的计算资源的效率。也许更多的执行器或者更多的驱动内存会让你的应用运行得更快，但也可能不会。Sparklens可以通过查看应用程序的一次运行来帮助回答这个问题。</p><p id="2685" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">如何使用Sparklens？</strong></p><p id="5030" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">要为您的Spark作业/应用启用Sparklens，我们需要向spark-submit或spark-shell添加以下附加配置参数:</p><blockquote class="jv jw jx"><p id="36d2" class="iu iv ju iw b ix iy iz ja jb jc jd je jy jg jh ji jz jk jl jm ka jo jp jq jr ha bi translated">—packages qu bole:sparklens:0 . 1 . 2-s _ 2.11<br/>—conf spark . extra listeners = com . qu bole . sparklens . qubolejoblistener</p></blockquote><p id="6673" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">默认情况下，使用Sparklens配置提交的每个Spark作业都将启用Sparklens报告。我们可以使用以下方法访问它们。</p><p id="b9d5" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">如何查看/访问Sparklens报告？</strong> <br/>在云环境中，有3种不同的方式访问Sparklens报告。<br/><strong class="iw hi">纱线资源管理器</strong> <br/>导航至资源管理器链接，访问Spark应用程序日志，查看与应用程序日志一起打印的Sparklens报告。</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kb"><img src="../Images/9fcd044d644f49fd83aa280d942f3aa9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AxFLlBqP6Qn9dqEuBjJnPw.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Figure 1: Resource Manager Log with Sparklens report</figcaption></figure><p id="8efa" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi"> PHS服务器日志</strong><br/>PHS(持久历史服务器)日志将Sparklens报告的详细信息存储在应用历史日志中。理想情况下，我们将使用PHS日志来分析Sparklens报告。</p><p id="51e0" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi"> <em class="ju">注:</em> </strong> <em class="ju">持久化历史服务器是一个持久化集群，在GCP数据处理环境中全天候可用。它用于存储您的数据处理环境中触发的所有应用程序/作业的应用程序日志。</em></p><p id="4d92" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi"> GCS存储桶位置</strong> <br/>每个应用程序ID的Sparklens报告作为Json文件存储在为开发/生产配置的GCS存储桶中。它可以被下载和分析。Sparklens数据的GCS桶位置在图1中突出显示。</p><p id="863b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">Sparklens UI</strong><br/>Sparklens报告可上传至Sparklens报告门户网站，以图表形式查看报告。<br/><a class="ae it" href="http://sparklens.qubole.com/" rel="noopener ugc nofollow" target="_blank">http://sparklens.qubole.com/</a></p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kg"><img src="../Images/8fb4b30aa268346a2434ee52b78f3865.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z9z3j-3fsPXVYK3VqjIAqA.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Figure 2:Sparklens Report in UI</figcaption></figure><p id="8fa6" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi"> Sparklens指标:</strong></p><p id="e121" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Sparklens基于Spark应用程序日志生成多个指标。我们现在将浏览Sparklens报告的一些关键指标。</p><p id="c131" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">关键路径:</strong></p><p id="10ff" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">关键路径是我们的应用程序完成所需的最少时间，不考虑添加到我们工作中的执行者的数量/无限数量。</p><p id="655d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">关键路径=在驱动程序中花费的所有时间+每个阶段中最大任务花费的时间。</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kh"><img src="../Images/f92d371a23a1a0d1e0aa06c1122311b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KN_ncgVkdRPuPtZ4l--aCg.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Figure 3: Critical Path Representation . Source: Qubole Blog</figcaption></figure><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ki"><img src="../Images/0ee19b664c85d2f9d81942b31307cb89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yMMeh3wx-1J4VHz5sxj7dw.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Figure 4: Critical Path data from Sparklens Actual Report from a Spark Job</figcaption></figure><p id="feb7" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">从上面的指标中，我们可以注意到，实际Spark作业的总挂钟(执行)时间是16分09秒，但是作业的关键路径是10分46秒。因此，我们有机会调整该作业，以便为该作业节省5分钟以上的时间。</p><p id="ce56" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">理想路径是指如果我们拥有完美的并行性且没有偏斜，那么任务执行所需的时间。在实际场景中，很难满足基于业务和数据场景的理想路径要求。</p><blockquote class="jv jw jx"><p id="97ea" class="iu iv ju iw b ix iy iz ja jb jc jd je jy jg jh ji jz jk jl jm ka jo jp jq jr ha bi translated"><strong class="iw hi">关键路径指标的关键要点:</strong> <br/>在理想的应用中，与执行者挂钟时间相比，驱动器挂钟时间应相对较少，如果驱动器挂钟时间较长，则分析并确定减少驱动器计算任务的选项。<br/>我们无法通过增加执行器数量来提高驱动程序的执行速度。<br/>除非我们通过重新划分数据来改变任务处理的数据，否则我们无法让任何阶段中最慢的任务运行得更快。<br/>·Spark应用程序的运行速度不能超过其关键路径，无论有多少执行器。<br/>通过<br/>减少驱动程序侧的计算<br/>为给定内核提供足够的任务<br/>减轻任务偏差<br/>根据需要减少执行程序的数量。</p></blockquote><p id="67aa" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">模型模拟器指标:</strong></p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kj"><img src="../Images/8a7aa51a695f833d90a4cfce1359837e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xyeu3TrdUoA7eRha4yxVKg.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Figure 5:Model Simulation Metrics</figcaption></figure><p id="5b75" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">模型模拟器估计Spark应用/作业的运行时间，模型误差是模型估计运行时间和实际运行时间之间的偏差。<br/> Model simulator还根据不同的执行器数量和集群利用率来估计作业的运行时间。如果我们计划在减少的执行器数量和基于用例场景的运行时间的少量增加之间进行权衡，我们可以使用这个度量。</p><p id="7ce8" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">例如:在上面图4中的Sparklens报告中，我们可以注意到，随着执行程序容量的减少(80 % : 160个执行程序)，预计的运行时间增加了一点，但是如果它适合我们的用例，那么我们可以用减少的执行程序容量来运行Spark作业。</p><p id="bf90" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">每阶段执行指标:</strong></p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kk"><img src="../Images/ed081aabec846a922bd2ed193ca4cb78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oWROrS_i1BsJhPk7WBmhyA.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Figure 6: Metrics Aggregated for each Stage in Spark Job</figcaption></figure><p id="8e75" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">根据Sparklens的阶段级聚合指标，我们可以注意到，阶段ID: 54占总执行时间的27 %,它的任务数最高，为111110。我们可以评估阶段，寻找任何调整的机会。</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kl"><img src="../Images/43f48481c0e67c889fd8d0b4d7e8691e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JjYDWkiPQ6WVMVQ8OqS5GA.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Figure 7: Skew Metrics &amp; Parallelism Ratio aggregated at Stage level for a Spark Job</figcaption></figure><p id="0d43" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">每个阶段的关键指标定义:</strong></p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es km"><img src="../Images/9e85ee64850e8d01ddb9f48a4312e75d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RW6vQXSi-lo-79OEyo2h_A.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Per Stage Key Metrics Definitions</figcaption></figure><p id="4bd7" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">总结:</strong></p><p id="8f93" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Sparklens为开发团队提供了详细的指标来分析应用程序日志，并确定成本和时间优化的机会。在这篇博客中，我们只强调了关键指标。请浏览参考资料，了解Sparklens报告生成的其他指标的详细信息。</p><p id="a801" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Sparklens没有强调任何需要缓解以获得更好性能的代码问题。相反，它通过总结和强调有效分析的关键指标来帮助开发团队避免他们在优化Spark工作时遵循的多次反复试验的方法。</p><p id="fed0" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Sparklens使用Spark作业的单次执行生成报告，它还有一个可视化的UI界面来分析指标。数据工程领导者和使用Apache Spark处理大规模数据的团队可以计划利用任何数据分析工具，如Sparklens，以实现有效的性能工程。快乐学习！！</p><p id="79a5" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">参考文献:</strong></p><p id="1b06" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><a class="ae it" href="https://www.qubole.com/blog/introducing-quboles-spark-tuning-tool/" rel="noopener ugc nofollow" target="_blank">https://www . qu bole . com/blog/introducing-qu boles-spark-tuning-tool/</a></p><p id="fc8f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">https://www.youtube.com/watch?v=0a2U4_6zsCc<strong class="iw hi">qu bole Spark meet</strong>:<a class="ae it" href="https://www.youtube.com/watch?v=0a2U4_6zsCc" rel="noopener ugc nofollow" target="_blank">T7】</a></p><p id="bf38" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">第五届大象大会</strong> (Qubole Sparklens:了解Spark应用的可伸缩性极限—Rohit Karlupia)<a class="ae it" href="https://www.youtube.com/watch?v=SOFztF-3GGk" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=SOFztF-3GGk</a></p><p id="ea57" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><a class="ae it" href="https://github.com/qubole/sparklens" rel="noopener ugc nofollow" target="_blank">https://github.com/qubole/sparklens</a></p></div></div>    
</body>
</html>