<html>
<head>
<title>Airbnb’s Trip to Linaria</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Airbnb的利纳里亚之旅</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/airbnbs-trip-to-linaria-dc169230bd12?source=collection_archive---------1-----------------------#2022-06-16">https://medium.com/airbnb-engineering/airbnbs-trip-to-linaria-dc169230bd12?source=collection_archive---------1-----------------------#2022-06-16</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="0d0b" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">了解Airbnb最新的网页设计选择Linaria如何改善开发者体验和网页性能</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/25c204b957d75530264b4f830f34009f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-qT4pQIPIsxHBZj22sQtag.jpeg"/></div></div></figure><p id="655f" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">CSS是每个web应用程序的关键组件，许多解决方案都是针对开发人员如何编写样式并交付给访问者而开发的。在本帖中，我们将带您了解Airbnb从Sass到CSS-in-JS的旅程，并向您展示我们为什么会登陆零运行时CSS-in-JS库Linaria，以及它对Airbnb web应用程序的开发人员体验和性能的影响。</p><h1 id="77ce" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">从Sass到CSS-in-JS</h1><p id="e1c6" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">2016年，我们的web前端在一个单片<a class="ae ke" href="https://rubyonrails.org/" rel="noopener ugc nofollow" target="_blank"> Ruby on Rails </a>应用中，使用了<a class="ae ke" href="https://github.com/rails/sprockets" rel="noopener ugc nofollow" target="_blank">链轮</a>、<a class="ae ke" href="https://browserify.org/" rel="noopener ugc nofollow" target="_blank"> Browserify </a>和<a class="ae ke" href="https://sass-lang.com/" rel="noopener ugc nofollow" target="_blank"> Sass </a>的组合。我们有一个受<a class="ae ke" href="https://getbootstrap.com/" rel="noopener ugc nofollow" target="_blank"> Bootstrap </a>启发的内部造型工具包，但是我们没有使用任何类似<a class="ae ke" href="https://github.com/css-modules/css-modules" rel="noopener ugc nofollow" target="_blank"> CSS模块</a>或<a class="ae ke" href="http://getbem.com/" rel="noopener ugc nofollow" target="_blank"> BEM </a>的东西。</p><p id="aafb" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">产品错误通常是由我们的样式造成的——有时一些页面中缺少正确的样式表，有时不同样式表的样式会意外冲突。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="lc ld l"/></div></figure><p id="d300" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">此外，开发人员<a class="ae ke" href="https://css-tricks.com/how-do-you-remove-unused-css-from-a-site/" rel="noopener ugc nofollow" target="_blank">很少删除已经添加的样式，因为很难知道是否还需要它们</a>。随着我们的产品表面积迅速扩大，这些问题变得更加复杂。</p><p id="bbcf" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">当我们开始在React中构建我们的<a class="ae ke" href="https://www.youtube.com/watch?v=fHQ1WSx41CA" rel="noopener ugc nofollow" target="_blank">设计系统</a>时，我们发现CSS-in-JS是一个令人兴奋的新选择。当时，CSS-in-JS仍处于起步阶段——只有几个库存在，而且还没有发明出<a class="ae ke" href="https://styled-components.com/" rel="noopener ugc nofollow" target="_blank">风格的组件</a>。我们选择了<a class="ae ke" href="https://github.com/khan/aphrodite" rel="noopener ugc nofollow" target="_blank">阿芙罗狄蒂</a>，但是不想直接耦合到阿芙罗狄蒂的实现，原因有二:因为CSS-in-JS是一个新生的空间，我们希望以后能够灵活地切换实现，我们还希望有一些东西能够为人们可能不需要阿芙罗狄蒂的开源项目工作。所以我们创建了一个抽象层叫做<a class="ae ke" href="https://github.com/airbnb/react-with-styles" rel="noopener ugc nofollow" target="_blank">与样式反应</a>，这给了我们一个<a class="ae ke" href="https://reactjs.org/docs/higher-order-components.html" rel="noopener ugc nofollow" target="_blank">高阶组件(HOC) </a>来定义可主题化的样式。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="le ld l"/></div></figure><p id="329e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这允许组件在同一个文件中进行样式化，使得回购组织更加方便。更重要的是，<strong class="jk hi">从一个全局感知的样式系统转移到一个基于组件的样式系统给了我们关于如何应用样式以及需要什么文件来正确地在每个页面上呈现每个组件的保证</strong>。这使我们能够依靠<a class="ae ke" href="https://happo.io/" rel="noopener ugc nofollow" target="_blank"> Happo，我们选择的截图测试工具</a>，结果视觉回归直线下降(披露:我是Happo的共同创建者)。</p><p id="2c14" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">尽管react-with-styles多年来为我们提供了很好的服务，但它带来了性能和开发者体验的权衡。样式和运行时库增加了关键路径JS包的大小，并且在渲染时应用样式会带来CPU成本(我们组件挂载时间的10–20%)。虽然我们得到了前面提到的关于样式的保证，但实际上与常规CSS语法相比，用JavaScript对象编写样式感觉很笨拙。这些权衡让我们重新考虑如何设计Airbnb网站的风格。</p><h1 id="30b1" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">考虑我们的选择</h1><p id="7b23" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">为了解决用样式反应的问题，我们成立了一个由来自不同团队的工程师组成的工作组。我们考虑了许多方向，这些方向符合以下高级类别:</p><ul class=""><li id="adfa" class="lf lg hh jk b jl jm jo jp jr lh jv li jz lj kd lk ll lm ln bi translated">在构建时从react-with-styles静态提取CSS</li><li id="761f" class="lf lg hh jk b jl lo jo lp jr lq jv lr jz ls kd lk ll lm ln bi translated">编写我们自己的框架</li><li id="f326" class="lf lg hh jk b jl lo jo lp jr lq jv lr jz ls kd lk ll lm ln bi translated">调查并采用现有框架</li></ul><p id="decd" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们决定在构建时不从react-with-styles中静态提取,因为这需要大量的工作。此外，它将是土生土长的，因此缺乏社区的好处。最后，它没有解决开发人员的人机工程学问题。</p><p id="3a5c" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">类似地，<strong class="jk hi">编写我们自己的框架</strong>会有很高的初始实现、维护和支持成本。此外，对于这个问题，我们希望利用现有的解决方案，并为之做出贡献。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es lt"><img src="../Images/15dd0a559a05ff00ef77bf95ddd7f59f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*7Kwk-MuLZOIUhgnv"/></div><figcaption class="lu lv et er es lw lx bd b be z dx">Comic from <a class="ae ke" href="https://xkcd.com/927/" rel="noopener ugc nofollow" target="_blank">https://xkcd.com/927/</a> by Randall Munroe and is used under a CC-BY-NC 2.5 license.</figcaption></figure><p id="6666" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在根据我们的需求评估了几个<strong class="jk hi">现有框架</strong>之后，我们缩小了构建概念验证的候选范围:</p><ul class=""><li id="0a23" class="lf lg hh jk b jl jm jo jp jr lh jv li jz lj kd lk ll lm ln bi translated">情感:CSS-in-JS，运行时成本低</li><li id="6872" class="lf lg hh jk b jl lo jo lp jr lq jv lr jz ls kd lk ll lm ln bi translated"><a class="ae ke" href="https://github.com/callstack/linaria" rel="noopener ugc nofollow" target="_blank"> Linaria </a>:零运行时CSS-in-JS(静态CSS提取)</li><li id="bb46" class="lf lg hh jk b jl lo jo lp jr lq jv lr jz ls kd lk ll lm ln bi translated"><a class="ae ke" href="https://github.com/seek-oss/treat" rel="noopener ugc nofollow" target="_blank">处理</a>:接近零运行时CSS-in-JS(静态CSS提取)</li></ul><p id="da82" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">概念证明工作是在一个新的repo中完成的，该repo实现了一个服务器渲染的客户端水合的Airbnb登录主页的无样式版本。对于每个框架，这使我们能够:</p><ul class=""><li id="9ee9" class="lf lg hh jk b jl jm jo jp jr lh jv li jz lj kd lk ll lm ln bi translated">理解我们的构建系统需要做什么样的改变</li><li id="f5b7" class="lf lg hh jk b jl lo jo lp jr lq jv lr jz ls kd lk ll lm ln bi translated">试用框架API，感受一下开发人员的人机工程学</li><li id="d4fe" class="lf lg hh jk b jl lo jo lp jr lq jv lr jz ls kd lk ll lm ln bi translated">评估每个框架如何支持我们的web样式需求</li><li id="092a" class="lf lg hh jk b jl lo jo lp jr lq jv lr jz ls kd lk ll lm ln bi translated">收集绩效指标</li><li id="5935" class="lf lg hh jk b jl lo jo lp jr lq jv lr jz ls kd lk ll lm ln bi translated">作为迁移计划的起点</li></ul><p id="f6cd" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">根据以下标准列表对框架进行相互评估:</p><ol class=""><li id="7204" class="lf lg hh jk b jl jm jo jp jr lh jv li jz lj kd ly ll lm ln bi translated"><strong class="jk hi">性能</strong></li><li id="602e" class="lf lg hh jk b jl lo jo lp jr lq jv lr jz ls kd ly ll lm ln bi translated"><strong class="jk hi">社区</strong>(即支持和收养)</li><li id="15c7" class="lf lg hh jk b jl lo jo lp jr lq jv lr jz ls kd ly ll lm ln bi translated"><strong class="jk hi">开发者体验</strong></li></ol><h1 id="8b61" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">技术性能分析</h1><p id="4e2e" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">使用<a class="ae ke" href="https://www.speedcurve.com/" rel="noopener ugc nofollow" target="_blank"> SpeedCurve </a>、本地基准测试和<a class="ae ke" href="https://reactjs.org/docs/profiler.html" rel="noopener ugc nofollow" target="_blank">React&lt;Profiler/&gt;</a>，我们为每个框架运行了性能基准测试。所有结果都是在节流的MacBook Pro上运行200次的中值，在统计上与p值为&lt; = 0.05的对照组有显著差异。</p><p id="d82e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">根据<a class="ae ke" rel="noopener" href="/airbnb-engineering/creating-airbnbs-page-performance-score-5f664be0936"> Airbnb的页面性能得分</a>(类似于<a class="ae ke" href="https://web.dev/performance-scoring/" rel="noopener ugc nofollow" target="_blank"> Lighthouse的性能得分</a>)，我们重点关注以下指标，以让我们了解每个框架的表现以及对用户体验的影响:</p><ul class=""><li id="5d16" class="lf lg hh jk b jl jm jo jp jr lh jv li jz lj kd lk ll lm ln bi translated"><a class="ae ke" href="https://web.dev/tbt/" rel="noopener ugc nofollow" target="_blank">总阻塞时间(TBT) </a></li><li id="2cbf" class="lf lg hh jk b jl lo jo lp jr lq jv lr jz ls kd lk ll lm ln bi translated">捆绑大小</li><li id="1d63" class="lf lg hh jk b jl lo jo lp jr lq jv lr jz ls kd lk ll lm ln bi translated">更新布局树计数和持续时间</li><li id="d74b" class="lf lg hh jk b jl lo jo lp jr lq jv lr jz ls kd lk ll lm ln bi translated">复合层数和持续时间</li></ul><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="le ld l"/></div></figure><p id="cf54" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">很明显框架分为两组:<strong class="jk hi">运行时框架</strong> (react-with-styles，Emotion)和<strong class="jk hi">构建时框架</strong> (Linaria，Treat)。</p><p id="074d" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们主页的服务器端和客户端版本的基准测试显示，Treat和Linaria在<strong class="jk hi">总阻塞时间</strong>上分别比Emotion高出36%和22%。所有框架的性能都明显优于react-with-styles，提高幅度从32–56%不等。<em class="lz">(请注意，这些数字不应用于估计预期的生产改进，因为这是一个非常具体的基准，旨在测试框架之间的差异，而不是预期的生产节约。)</em></p><p id="62ed" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi">捆绑包大小</strong>的差异也属于这两类——Linaria/Treat组节省了大约80 KiB (~12%)。</p><p id="15ba" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">CSS度量(<strong class="jk hi">更新布局树</strong>和<strong class="jk hi">复合层</strong>)显示，平均来说，对于用样式/情感作出反应，大约还有一个布局树更新和层复合事件。这可能是由于使用JavaScript插入和合并样式表，而对于Linaria或Treat这样的CSS提取库来说，这是不必要的。</p><p id="eafb" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这项性能调查表明，无论是Linaria还是Treat都是很有前途的选择，并且所有考虑的框架都比使用Aphrodite的react-with-styles有显著的统计改进。</p><h1 id="41a8" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">我们喜欢里那利亚的什么</h1><p id="0c96" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">上面的<strong class="jk hi">性能</strong>改进很大程度上归功于Linaria在构建时将样式从JS提取到静态CSS文件，因此没有JS捆绑包或运行时CPU开销——这使它比几乎为零的运行时处理略有优势。此外，这带来了缓存的好处，因为这些静态CSS文件可能会以不同于JS文件的节奏变化。由于样式是在构建时提取的，Linaria有机会自动删除未使用的样式——这也为重复删除样式的可能性打开了大门(即<a class="ae ke" href="https://css-tricks.com/lets-define-exactly-atomic-css/" rel="noopener ugc nofollow" target="_blank">原子CSS </a>)。此外，Linaria支持为服务器端渲染注入关键的CSS，这是我们希望从react-with-styles集成中保留的。</p><p id="8fc0" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><a class="ae ke" href="https://snyk.io/advisor/npm-package/linaria" rel="noopener ugc nofollow" target="_blank"> Linaria似乎也是一个健康的项目</a>，它见证了大量的活动、<strong class="jk hi">社区</strong>的参与、文档和采用。它良好的发展轨迹给了我们信心，让我们相信它会继续进步，我们也有能力做出贡献。</p><p id="f5f4" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们发现Linaria的<a class="ae ke" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals#tagged_templates" rel="noopener ugc nofollow" target="_blank">标记模板文字</a> API允许开发人员使用CSS语法，是对我们为react-with-styles构建的JS object HOC API的一个有吸引力的改进。此外，现成的集成可用于stylelint、CSS自动完成和语法突出显示，这丰富了<strong class="jk hi">开发人员的体验</strong>。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es ma"><img src="../Images/05acddcc8e8bf8ef980eee5104d9f43d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hyXFKX-bB-ixvHsE"/></div></div><figcaption class="lu lv et er es lw lx bd b be z dx">Off-the-shelf integrations for stylelint, CSS autocompletion, and syntax highlighting working with Linaria in action.</figcaption></figure><p id="0c17" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们还发现了Linaria与我们现有解决方案的相似之处。样式在组件文件中的共同定位是一个很大的特性，对我们来说，它有利于Linaria而不是Treat，熟悉的API为开发人员平滑了过渡，并让我们相信自动化可以简化迁移工作。</p><h1 id="e110" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">迁移策略</h1><p id="32b2" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">为了推出这一巨大的变化，我们采用了增量迁移策略，这在很大程度上是由我们编写的<a class="ae ke" rel="noopener" href="/airbnb-engineering/turbocharged-javascript-refactoring-with-codemods-b0cae8b326b9">代码模块</a>自动完成的。我们非常依赖我们的<a class="ae ke" href="https://happo.io/" rel="noopener ugc nofollow" target="_blank"> Happo截图测试</a>来确保我们的组件在迁移后看起来是一样的。这允许我们通过运行脚本和任何必要的调整来迁移代码库的部分，类似于我们在采用TypeScript时采用的方法。</p><p id="bb4f" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">迁移的第一阶段由web样式工作组处理，目标是转换一些具有不同性能特征的精选页面上的组件子集。这个阶段是基于A/B测试的，这确保了我们对性能的最初理解符合我们应用程序的具体情况，并向我们保证没有隐藏的问题。</p><p id="d71f" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">一旦我们对Linaria集成的性能和正确性有了信心，我们就允许团队在新代码中开始使用Linaria。我们还鼓励团队使用我们的codemods迁移他们现有的代码。尽管移植进展顺利，但我们计划确保所有代码都脱离了react-with-styles，这样我们最终就可以完全从包中移除运行时依赖。这种一致性将为我们带来额外的性能提升，并降低<a class="ae ke" href="https://en.wikipedia.org/wiki/Decision_fatigue" rel="noopener ugc nofollow" target="_blank">决策疲劳</a>的成本。</p><h1 id="dd3b" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">回馈社会</h1><p id="21d1" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">一旦我们开始使用Linaria，我们发现自动风格重复数据删除(即原子CSS)不仅可以提升性能，还可以修复我们遇到的一些与性能无关的问题。</p><p id="ad78" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">Linaria生成的选择器都具有相同的<a class="ae ke" href="https://developer.mozilla.org/en-US/docs/Web/CSS/Specificity" rel="noopener ugc nofollow" target="_blank">特异性</a>。因为相同特性的CSS选择器依赖于它们的声明顺序，所以捆绑器构建这些文件的顺序变得很重要。当在文件之间共享样式时，这是有问题的，因为当依赖图的形状改变时，我们不能预测或保持样式的顺序。</p><p id="f5c8" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们最初通过为CSS片段创建一个新的<a class="ae ke" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals#tagged_templates" rel="noopener ugc nofollow" target="_blank">标记模板文字</a>来解决这个问题，它允许将样式插入到Linaria的CSS标记模板文字中。这很好地工作，但是它不直观，挫败了期望样式在CSS标记的模板文字中定义的<a class="ae ke" href="https://github.com/prettier/prettier/blob/d13feed42b6478710bebbcd3225ab6f203a914c1/src/language-js/embed.js#L90-L121" rel="noopener ugc nofollow" target="_blank">工具，并且导致样式在CSS包中被多次包含(这对于性能来说是次优的)。</a></p><p id="8f7f" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">Josh Nelson是我们web样式工作组的成员，<a class="ae ke" href="https://github.com/callstack/linaria/pull/867" rel="noopener ugc nofollow" target="_blank">为Linaria贡献了原子CSS支持</a>，Linaria社区也非常支持。这一变化增加了一个新的<a class="ae ke" href="https://npmjs.com/@linaria/atomic" rel="noopener ugc nofollow" target="_blank"> @linaria/atomic </a>包，当导入而不是<a class="ae ke" href="https://www.npmjs.com/package/@linaria/core" rel="noopener ugc nofollow" target="_blank"> @linaria/core </a>时将在构建时生成原子CSS。这意味着如果您像这样编写代码:</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="le ld l"/></div></figure><p id="eae7" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">而不是像这样生成输出(没有原子CSS):</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="le ld l"/></div></figure><p id="2c93" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">生成的输出将如下所示(使用原子CSS):</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="le ld l"/></div></figure><p id="c27e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">出现顺序问题通过构建时分析来解决，构建时分析根据类名传入cx函数的顺序来链接类名，以在必要时增加特异性。</p><h1 id="e264" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">接待</h1><p id="b2a3" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">我们的工程师对Linaria反应积极。以下是一些引述:</p><blockquote class="mb mc md"><p id="1587" class="ji jj lz jk b jl jm ii jn jo jp il jq me js jt ju mf jw jx jy mg ka kb kc kd ha bi translated">“Linaria打开了一个世界，在那里我们可以像1999年一样进行编码，在老式的纯CSS上。它反对坏的模式，但是给了我们建立惊人体验的灵活性。我们不再对抗平台，而是利用它，这种感觉非常强大。”——凯丽·里金斯</p><p id="2dad" class="ji jj lz jk b jl jm ii jn jo jp il jq me js jt ju mf jw jx jy mg ka kb kc kd ha bi translated">“与风格反应相比，我更关心我现在正在创造的东西。Linaria这么好。”伊恩·德玛特伊-塞尔比</p><p id="0900" class="ji jj lz jk b jl jm ii jn jo jp il jq me js jt ju mf jw jx jy mg ka kb kc kd ha bi translated">“我真的很喜欢能够再次编写CSS。它让您可以更好地控制组件中的样式。”—布里·邦吉</p><p id="7a37" class="ji jj lz jk b jl jm ii jn jo jp il jq me js jt ju mf jw jx jy mg ka kb kc kd ha bi translated">“再次编写真正的CSS真是太棒了。”—维克多·林</p></blockquote><p id="ad61" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">由于其熟悉的CSS语法、静态样式表中的样式提取和使用类名的样式应用，Linaria <strong class="jk hi">提高了产品开发速度</strong>和<strong class="jk hi">释放了使用react-with-styles和Aphrodite </strong>不可能实现的新样式功能。</p><h1 id="44a5" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">性能影响</h1><p id="1067" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">尽管我们仍处于迁移的开始阶段，但我们已经运行了一些A/B测试，这些测试让我们看到了切换到Linaria对大量野外访问者的真实性能影响。</p><p id="456a" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在一个实验中，我们将airbnb.com主页上呈现的大约10%的组件从react-with-styles转换为Linaria，并看到主页<a class="ae ke" rel="noopener" href="/airbnb-engineering/creating-airbnbs-page-performance-score-5f664be0936">页面性能得分</a>提高了0.26%。<a class="ae ke" href="https://web.dev/fcp/" rel="noopener ugc nofollow" target="_blank">首次涂色时间(TTFCP) </a>提高了0.54%(平均790毫秒)，而<a class="ae ke" href="https://web.dev/tbt/" rel="noopener ugc nofollow" target="_blank">总阻断时间(TBT) </a>也有1.6%(平均1200毫秒)的显著提高。客观地说，对大多数人来说，用React给主页补水需要大约200毫秒，所以这个数量级的改进是非常重要的。我们认为Linaria的这些性能改进是由于不再在渲染时生成CSS样式，这改善了服务器和客户端的渲染时间。</p><p id="8fcf" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">假设性能改进将线性扩展(这是一个很大的假设)，转换其余90%的组件<em class="lz">可能会</em>导致页面性能分数提高2.6%，首次内容绘制时间(TTFCP)提高5.4%，总阻塞时间(TBT)提高16%。</p><p id="971a" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">请注意，这里与其他行业数字的直接比较有点棘手，因为我们定义页面的方式不同，尤其是在客户端路由方面。</p><h1 id="8fd0" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">这对于用样式反应意味着什么？</h1><p id="449c" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">鉴于我们仍然有许多组件仍然依赖于react-with-styles，并且我们需要一段时间来完成我们的迁移，<strong class="jk hi">我们将把react-with-styles置于维护模式下</strong>，直到我们接近迁移的终点。在那一点上，<strong class="jk hi">我们打算终止对样式的反应</strong>和相关的包。</p><p id="feba" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">通过从市场上删除一个选项，我们希望帮助社区联合起来，形成一个共同的解决方案，并投资于更好的框架。如果你正在寻找一个新的工具，我们认为Linaria是一个很好的选择！</p><h1 id="cea4" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">结论</h1><p id="98ef" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">造型基础设施仍然是一个令人兴奋的领域，充满了机会。在Airbnb，我们发现通过采用一个允许常规CSS语法与React组件代码一起使用的框架，对<strong class="jk hi">开发者体验</strong>进行了重大改进。通过将运行时样式库替换为在构建时编译成静态CSS文件的样式库，我们能够继续朝着更快的<strong class="jk hi">性能</strong>前进。感谢Linaria <strong class="jk hi">社区</strong>和我们的合作，我们期待这个图书馆在未来许多年里继续改进。</p><p id="0d26" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">有兴趣在Airbnb工作吗？查看这些开放的角色:</p><p id="4588" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><a class="ae ke" href="https://grnh.se/ebfa55151us" rel="noopener ugc nofollow" target="_blank">前端基础架构工程师、Web平台</a> <br/> <a class="ae ke" href="https://grnh.se/b5afa9151us" rel="noopener ugc nofollow" target="_blank">员工软件工程师、数据治理</a> <br/> <a class="ae ke" href="https://grnh.se/92c32fed1us" rel="noopener ugc nofollow" target="_blank">员工软件工程师、云基础架构</a> <br/> <a class="ae ke" href="https://grnh.se/bbe55fe81us" rel="noopener ugc nofollow" target="_blank">员工数据库工程师</a> <br/> <a class="ae ke" href="https://grnh.se/21e5c2011us" rel="noopener ugc nofollow" target="_blank">员工软件工程师— ML Ops平台</a> <br/> <a class="ae ke" href="https://grnh.se/ee114dfc1us" rel="noopener ugc nofollow" target="_blank">高级/员工软件工程师、服务能力</a></p><h1 id="3e5b" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">感谢</h1><p id="2e09" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">我们非常感谢<a class="ae ke" href="https://www.callstack.com/" rel="noopener ugc nofollow" target="_blank"> callstack </a>和<a class="ae ke" href="https://github.com/callstack/linaria#contributors" rel="noopener ugc nofollow" target="_blank"> Linaria社区</a>的人们构建了这样一个伟大的工具，并与我们合作使其变得更好。也感谢可汗学院给了我们阿佛洛狄忒，它为我们服务了很多年。这是Airbnb付出的巨大努力，如果没有Airbnb这么多人的努力，这是不可能的，包括Mars Jullian、Josh Nelson、Nora Tarano、、Jimmy Guo、Ian Demattei-Selby、Victor Lin、Nnenna John、Adrianne Soike、Garrett Berg、Andrew Huth、Austin Wood、Chris Sorenson和Miles Johnson。最后，感谢Surashree Kulkarni帮助编辑这篇博文。谢谢大家！</p></div><div class="ab cl mh mi go mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ha hb hc hd he"><p id="d1bc" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="lz">所有产品名称、标识和品牌都是其各自所有者的财产。本网站中使用的所有公司、产品和服务名称仅用于识别目的。使用这些名称、标志和品牌并不意味着认可。</em></p></div></div>    
</body>
</html>