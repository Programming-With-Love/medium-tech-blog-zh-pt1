<html>
<head>
<title>Online Data Migration from HBase to TiDB with Zero Downtime</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从HBase到TiDB的在线数据迁移，零宕机</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/online-data-migration-from-hbase-to-tidb-with-zero-downtime-43f0fb474b84?source=collection_archive---------0-----------------------#2022-08-18">https://medium.com/pinterest-engineering/online-data-migration-from-hbase-to-tidb-with-zero-downtime-43f0fb474b84?source=collection_archive---------0-----------------------#2022-08-18</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="7e4d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Ankita Girish Wagh |存储和缓存高级软件工程师</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/b8f59b52c66ec2ec79b3050b5f6a46c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*J4MPPwdbT2r58ZZ6"/></div></div></figure><h1 id="5681" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">简介和动机</h1><p id="8c21" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">在Pinterest，HBase是最重要的存储后端之一，支持许多在线存储服务，如Zen(图形数据库)、UMS(宽列数据存储)和<a class="ae kr" rel="noopener" href="/pinterest-engineering/building-scalable-near-real-time-indexing-on-hbase-7b5eeb411888"> Ixia </a>(近实时二级索引服务)。HBase生态系统虽然具有各种优势，如高容量请求中行级别的强一致性、灵活的模式、低延迟数据访问、Hadoop集成等。无法满足我们客户未来3-5年的需求。这是因为运营成本高、过于复杂，以及缺少辅助索引、事务支持等功能。</p><p id="af43" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在评估了10多个不同的存储后端，并对入围的三个后端进行了影子流量(将生产流量异步复制到非生产环境)基准测试和深入的性能评估后，我们决定使用<a class="ae kr" href="https://en.pingcap.com/" rel="noopener ugc nofollow" target="_blank"> TiDB </a>作为统一存储服务的最终候选。</p><p id="316d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">采用由TiDB支持的统一存储服务是一项跨越多个季度的重大挑战性项目。它涉及从HBase到TiDB的数据迁移，统一存储服务的设计和实施，从Ixia/Zen/UMS到统一存储服务的API迁移，以及从HBase/Hadoop生态系统到TiSpark生态系统的离线作业迁移，同时保持我们的可用性和延迟SLA。</p><p id="f2e4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这篇博文中，我们将首先了解数据迁移的各种方法及其利弊。然后，我们将深入探讨如何将数据从HBase迁移到TiDB，这是首批用例之一，具有4 TB的表大小，可在零宕机的情况下服务14k读取qp和400写入qp。最后，我们将了解如何进行验证以实现99.999%的数据一致性，以及如何测量两个表之间的数据一致性。</p><h1 id="7c5e" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">数据迁移策略</h1><p id="fa09" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">一般来说，零停机时间数据迁移的简化策略包括以下内容:</p><ol class=""><li id="2cd8" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated">假设您有数据库A，并且您想将数据迁移到数据库B，您将首先开始对数据库A和数据库B进行双重写入。</li><li id="a2ef" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">在数据库B中导入数据库A的转储，同时解决与实时写入的冲突。</li><li id="debc" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">对两个数据集进行验证。</li><li id="38a4" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">停止写入数据库a。</li></ol><p id="4e8f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">每种使用情形都是不同的，可能会带来一系列独特的挑战。</p><p id="50d4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们考虑了进行数据迁移的各种方法，并基于各种权衡最终确定了方法:</p><ol class=""><li id="d187" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated">从服务向两个表(HBase和TiDB)执行双重写入(以同步/异步方式写入2个真实源),并使用<a class="ae kr" href="https://docs.pingcap.com/tidb/dev/tidb-lightning-overview" rel="noopener ugc nofollow" target="_blank"> lightning </a>中的<a class="ae kr" href="https://docs.pingcap.com/tidb/dev/tidb-lightning-backends#tidb-backend" rel="noopener ugc nofollow" target="_blank"> TiDB后端模式</a>进行数据摄取。<br/>这个策略最简单，也最容易实施。然而，TiDB后端模式提供的速度是50GB/小时，因此它只对较小表的数据迁移有用。</li><li id="2940" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">获取HBase表的快照转储，并将实时写入从HBase cdc(更改数据捕获)传输到kafka主题，然后使用lightning工具中的<a class="ae kr" href="https://docs.pingcap.com/tidb/dev/tidb-lightning-backends#local-backend" rel="noopener ugc nofollow" target="_blank">本地模式</a>接收转储的数据。稍后，从服务层启动双重写入，并应用kafka主题的所有更新。<br/>在应用cdc更新时，由于复杂的冲突解决方案，该策略难以实施。此外，我们自己开发的用于捕获HBase cdc的工具只存储密钥。因此也需要一些开发工作。</li><li id="ac2c" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">上述策略的一个替代方案是，我们从cdc读取密钥，并将它们存储在另一个数据存储中。稍后，在开始对两个表进行双重写入后，我们从真实数据源(HBase)读取它们的最新值，并写入TiDB。这种策略已经实现，但是如果通过cdc存储密钥的异步路径存在可用性问题，就有丢失更新的风险。</li></ol><p id="91f3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在评估了所有策略的利弊后，我们决定采用本博客其余部分描述的方法。</p><h1 id="07ff" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">迁移工作流</h1><h2 id="1cf5" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated">术语定义:</h2><p id="3a76" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">客户端:与节俭服务对话的下游服务/库</p><p id="5c6d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">服务:提供在线流量的节俭服务；为了这次迁移的目的，它是Ixia</p><p id="7820" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">MR Job:一个在map reduce框架上运行的应用程序</p><p id="e795" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">异步写入:服务向客户端返回OK响应，而不等待来自数据库的响应</p><p id="98a0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">同步写入:服务只有在收到来自数据库的响应后才会向客户端返回响应</p><p id="2cb2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">双重写入:服务以同步或异步方式写入两个底层表</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/059aa49634bb3b9135603aea613d5344.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gnf3CT1h5P3Gcrd_"/></div></div></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/2d3e49ffa41615c11537cae5fe65d389.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*elqvfwv0BuDwvNfq"/></div></div></figure><h2 id="f6de" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated">实施细节</h2><p id="c546" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">由于HBase是无模式的，而TiDB使用严格的模式，因此在开始迁移之前，需要设计一个包含正确数据类型和索引的模式。对于这个4 TB的表，HBase和TiDB模式之间有1:1的映射。这意味着TiDB模式是通过使用map reduce作业来分析hbase行中的所有列及其最大大小而设计的。然后对查询进行分析，以创建正确的索引。以下是步骤:</p><ol class=""><li id="0b73" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated">我们使用<a class="ae kr" href="https://hbase.apache.org/1.1/apidocs/org/apache/hadoop/hbase/master/snapshot/SnapshotManager.html" rel="noopener ugc nofollow" target="_blank"> hbasesnapshotmanager </a>获取HBase快照，并将其作为csv转储存储在s3中。我们将CSV行存储为Base64编码，以解决特殊字符限制。然后，我们在本地模式下使用TiDB<a class="ae kr" href="https://docs.pingcap.com/tidb/stable/tidb-lightning-backends#local-backend" rel="noopener ugc nofollow" target="_blank">lightning</a>开始接收这个csv转储，同时在TiDB中存储该行之前进行base64解码。一旦接收完成并且TiDB表在线，就开始对TiDB进行异步双重写入。异步双重写入确保TiDB SLA不会影响服务SLA。尽管我们为TiDB设置了一个监控/分页机制，但此时我们将TiDB保持在影子模式下。</li><li id="dad4" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">使用映射缩减作业执行HBase和TiDB表的快照。这些行首先被转换成一个公共对象，并作为序列文件存储在S3。我们使用MR连接器开发了一个定制的TiDB快照管理器，并将hbasesnapshotmanager用于HBase。</li><li id="9213" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">使用map reduce作业读取这些序列文件，该作业将不匹配的行写回s3。</li><li id="3c7b" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">从s3中读取这些不匹配的行，从服务中读取其最新值(由HBase支持)，并将该值写入辅助数据库(TiDB)。</li><li id="a67f" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">启用双同步写入，以便写入HBase和TiDB。运行步骤3、4和5中的协调作业，每天比较TiDB和HBase中的数据奇偶校验，以获得TiDB和HBase之间数据不匹配的统计信息，并协调它们。双同步写入机制没有回滚功能，以防写入1 db失败。因此，协调作业需要定期运行，以确保没有不一致。</li><li id="b7f7" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">保持同步写入TiDB，并启用异步写入HBase。启用从TiDB读取。在这个阶段，服务SLA完全依赖于TiDB的可用性。我们保持对HBase的异步写入，以尽最大努力保持数据一致性，以防我们需要再次回滚。</li><li id="c1bf" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">完全停止写入HBase并弃用HBase表。</li></ol><h1 id="728f" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">处理不一致</h1><ol class=""><li id="135a" class="ks kt hh ig b ih km il kn ip lu it lv ix lw jb kx ky kz la bi translated">后端不可用导致的不一致场景<br/>在Ixia服务层构建的双重写入框架不会在由于任一数据库不可用导致写入部分失败的情况下回滚写入。通过定期运行协调作业来保持两个HBase &amp; TiDB表同步，可以处理这种情况。当修复这种不一致时，主数据库HBase被认为是事实的来源。这实际上意味着，如果在HBase中写入失败，但在TiDB中成功，则在协调过程中，它将从TiDB中删除。</li><li id="3900" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">由于双重写入和协调期间的竞争条件而导致的不一致情况。如果事件按以下顺序发生，则有可能将陈旧数据写入TiDB:(1)协调作业从HBase读取；(2) live write同步写入HBase，异步写入TiDB(3)协调作业将先前读取的值写入TiDB。<br/>这类问题也可以通过多次运行协调作业来解决，因为每次运行后，此类不一致的数量都会显著减少。实际上，对于为400个写QPS提供服务的4 TB表，只需运行一次协调作业，即可实现HBase和TiDB之间99.999%的一致性。这是通过第二次转储HBase和TiDB表并比较其值来验证的。在比较行的过程中，我们看到表有99.999%的一致性。</li></ol><h1 id="cbfd" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">视窗网际网路名称服务</h1><ol class=""><li id="c9de" class="ks kt hh ig b ih km il kn ip lu it lv ix lw jb kx ky kz la bi translated">我们看到p99读取延迟降低了3-5倍。在这个用例中，p99查询延迟从500毫秒降至60毫秒。</li><li id="8eab" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">实现了写后读的一致性，这是我们专门从ixia迁移用例的目标之一。</li><li id="f388" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">迁移完成后，在涉及组件的<a class="ae kr" rel="noopener" href="/pinterest-engineering/building-scalable-near-real-time-indexing-on-hbase-7b5eeb411888">数量方面</a>更简单的架构。这将大大有助于调试生产问题。</li></ol><h1 id="dc05" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">挑战和学习</h1><h2 id="dc86" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated">内部TiDB部署</h2><p id="2687" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">在Pinterest基础设施中部署TiDB对我们来说是一次很好的学习经历，因为我们没有使用TiUP (TiDB的一站式部署工具)。这是因为TiUP的许多职责与内部pinterest系统重叠(例如部署系统、操作工具自动化服务、度量管道、TLS证书管理等。)而弥合两者差距的成本超过了它的收益。</p><p id="b178" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此，我们维护自己的TiDB版本的代码报告，并拥有构建、发布和部署管道。在安全集群管理上有很多细微差别，我们不得不艰难地学习，否则TiUP会处理它。</p><p id="f619" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们现在在Pinterest的AWS基础设施上构建了自己的TiDB平台，可以在不停机的情况下进行版本升级、实例类型升级和集群扩展操作。</p><h2 id="8d8b" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated">数据摄取</h2><p id="761c" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">在进行下面列出的数据接收和协调时，我们遇到了一些问题。请注意，我们的每一步都得到了<a class="ae kr" href="https://en.pingcap.com/" rel="noopener ugc nofollow" target="_blank"> Pingcap </a>的全力支持。我们还为TiDB代码库贡献了一些补丁，这些补丁已经被上游合并。</p><ol class=""><li id="d6f7" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated">TiDB lightning版本5.3.0不支持自动TLS证书刷新，由于缺乏相关日志，这是一个很难调试的问题。Pinterest的内部证书管理服务每12小时刷新一次证书，因此我们不得不经历一些失败的摄取作业，并与pingcap合作来解决这个问题。该特性已经在TiDB 5.4.0版本中发布。</li><li id="b8b9" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">lightning的本地模式会消耗大量资源，并在数据接收阶段影响来自同一集群的单独表上的在线流量。Pingcap与我们合作，提供放置规则的短期和长期补救，以便为在线流量提供服务的副本不会受到本地模式的影响。</li><li id="6557" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><a class="ae kr" href="https://github.com/tidb-incubator/TiBigData/tree/master/mapreduce" rel="noopener ugc nofollow" target="_blank"> TiDB MR Connector </a>需要一些可伸缩性修复，以便能够在合理的时间内拍摄4 TB表的快照。MR连接器也需要一些TLS改进，这些改进已经被贡献和合并。</li></ol><p id="5ae6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">经过调整和修复后，我们能够在大约8小时内接收4 TB的数据，而运行一轮协调和验证需要大约7个小时。</p><h2 id="0878" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated">鸢属科属植物</h2><p id="08ee" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">作为本练习的一部分，我们迁移的表是由ixia提供的。我们遇到了一些关于异步/同步双重写入和查询模式变化的可靠性问题。由于ixia本身复杂的分布式系统架构，节俭服务(ixia)的问题变得更加难以调试。请在我们的另一个<a class="ae kr" rel="noopener" href="/pinterest-engineering/building-scalable-near-real-time-indexing-on-hbase-7b5eeb411888">博客</a>中了解更多。</p><h1 id="08b0" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">承认</h1><p id="816a" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">我们要感谢Pinterest存储和缓存团队所有过去和现在的成员，感谢他们帮助我们在Pinterest的存储堆栈中引入最新的NewSQL技术之一。</p><p id="a6c1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们要感谢Pingcap团队对复杂问题的持续支持、联合调查和RCA。</p><p id="2017" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，我们要感谢我们的客户，在我们进行大规模迁移的过程中，他们表现出了极大的耐心和巨大的支持，一次一张桌子。</p><p id="c3c3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lx">要在Pinterest了解更多工程知识，请查看我们的</em> <a class="ae kr" href="https://medium.com/pinterest-engineering" rel="noopener"> <em class="lx">工程博客</em> </a> <em class="lx">，并访问我们的</em><a class="ae kr" href="https://www.pinterestlabs.com/?utm_source=medium&amp;utm_medium=blog-article-link&amp;utm_campaign=girish-wagh-aug-18-2022" rel="noopener ugc nofollow" target="_blank"><em class="lx">Pinterest Labs</em></a><em class="lx">网站。要探索Pinterest的生活，请访问我们的</em> <a class="ae kr" href="https://www.pinterestcareers.com/?utm_source=medium&amp;utm_medium=blog-article-link&amp;utm_campaign=girish-wagh-aug-18-2022" rel="noopener ugc nofollow" target="_blank"> <em class="lx">职业</em> </a> <em class="lx">页面。</em></p></div></div>    
</body>
</html>