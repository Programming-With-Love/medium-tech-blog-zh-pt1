<html>
<head>
<title>Managing Oracle Cloud Infrastructure Object Storage Classic Containers and Objects using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform管理Oracle云基础架构对象存储经典容器和对象</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/managing-oracle-cloud-infrastructure-object-storage-classic-containers-and-objects-using-terraform-9b1a44fdb8b?source=collection_archive---------1-----------------------#2018-01-18">https://medium.com/oracledevs/managing-oracle-cloud-infrastructure-object-storage-classic-containers-and-objects-using-terraform-9b1a44fdb8b?source=collection_archive---------1-----------------------#2018-01-18</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="ae64" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本文中，我们将快速了解一下<code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/opc/index.html" rel="noopener ugc nofollow" target="_blank">opc</a></code> Terraform provider对使用Oracle云基础架构对象存储经典资源的支持</p><h2 id="e1aa" class="jh ji hh bd jj jk jl jm jn jo jp jq jr ip js jt ju it jv jw jx ix jy jz ka kb bi translated">提供商设置</h2><p id="0fd3" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">在使用存储资源之前，您需要确保提供者配置了适当的<code class="du jc jd je jf b">storage_endpoint</code> URL，这在主<code class="du jc jd je jf b">provider</code>块中声明。如果存储服务ID不同于默认的<code class="du jc jd je jf b">identity_domain</code>，也可以设置可选的<code class="du jc jd je jf b">storage_service_id</code></p><p id="c35e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">完整的storage cloud REST API端点URL可以在Oracle Cloud MyServices仪表板中找到。例如，如果REST端点是</p><pre class="kh ki kj kk fd kl jf km kn aw ko bi"><span id="d288" class="jh ji hh jf b fi kp kq l kr ks"><strong class="jf hi">https://a000001.storage.oraclecloud.com</strong>/v1/Storage-<strong class="jf hi">a000001</strong><br/>\_________________ ___________________/            \__ __/<br/>                  V                                   V<br/>           storage_endpoint             storage_service_id</span></pre><p id="2097" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后在提供者配置中设置值:</p><pre class="kh ki kj kk fd kl jf km kn aw ko bi"><span id="7166" class="jh ji hh jf b fi kp kq l kr ks">provider "opc" {<br/>  ...<br/>  storage_endpoint   = "<a class="ae jg" href="https://usorclptsc53098.storage.oraclecloud.com/v1/Storage-usorclptsc53098" rel="noopener ugc nofollow" target="_blank">https://</a><a class="ae jg" href="https://a480066.storage.oraclecloud.com/v1/Storage-a480066" rel="noopener ugc nofollow" target="_blank">a000001</a><a class="ae jg" href="https://usorclptsc53098.storage.oraclecloud.com/v1/Storage-usorclptsc53098" rel="noopener ugc nofollow" target="_blank">.storage.oraclecloud.com</a>"<br/>  storage_service_id = "<a class="ae jg" href="https://a480066.storage.oraclecloud.com/v1/Storage-a480066" rel="noopener ugc nofollow" target="_blank">a000001</a>"<br/>}</span></pre><h1 id="bdf4" class="kt ji hh bd jj ku kv kw jn kx ky kz jr la lb lc ju ld le lf jx lg lh li ka lj bi translated">存储容器</h1><p id="cbb1" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated"><code class="du jc jd je jf b">opc_storage_container</code>资源可以用来创建一个新容器。最简单的是，存储容器只需要一个名称。</p><pre class="kh ki kj kk fd kl jf km kn aw ko bi"><span id="7810" class="jh ji hh jf b fi kp kq l kr ks">resource "opc_storage_container" "container" {<br/>  name = "my-storage-container"<br/>}</span></pre><h2 id="f8f7" class="jh ji hh bd jj jk jl jm jn jo jp jq jr ip js jt ju it jv jw jx ix jy jz ka kb bi translated">访问控制</h2><p id="50dc" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">可以设置<code class="du jc jd je jf b">read_acls</code>和<code class="du jc jd je jf b">write_acls</code>属性来控制对特定容器的访问。</p><p id="0c86" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用Oracle Cloud My Services控制台中定义的标准或自定义角色，可以根据角色将访问权限限制到特定用户或用户组。</p><figure class="kh ki kj kk fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lk"><img src="../Images/1bf290fca055f1d359ce99cc96f748d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2hq04Bmt_YSJ3hlbSeKVtg.png"/></div></div></figure><p id="8b81" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在ACL配置中，每个角色名称必须以身份域ID为前缀，例如</p><pre class="kh ki kj kk fd kl jf km kn aw ko bi"><span id="32ed" class="jh ji hh jf b fi kp kq l kr ks">resource "opc_storage_container" "container" {<br/>  name       = "my-storage-container"<br/><strong class="jf hi">  read_acls  = [ "${var.domain}.Storage.Storage_ReadOnlyGroup", <br/>                 "${var.domain}.Storage.Storage_ReadWriteGroup" ]<br/>  write_acls = [ "${var.domain}.Storage.Storage_ReadWriteGroup" ]</strong><br/>}</span></pre><p id="e3de" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">还可以根据引用的主机或域来限制读取权限。引用ACL采用格式<code class="du jc jd je jf b">.r:<em class="ls">value</em></code>，其中<em class="ls">值</em>是主机或域。<em class="ls">值</em>前的减号(<code class="du jc jd je jf b">-</code>表示必须拒绝指定的主机或域访问容器。如果指定了<code class="du jc jd je jf b">.r:*</code>，容器中的对象将是公共可读的，无需认证。</p><p id="1b21" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要允许列出容器中的对象，请在ACL中包含<code class="du jc jd je jf b">.rlistings</code>指令。</p><pre class="kh ki kj kk fd kl jf km kn aw ko bi"><span id="8675" class="jh ji hh jf b fi kp kq l kr ks">resource "opc_storage_container" "container" {<br/>  name       = "my-storage-container"<br/><strong class="jf hi">  read_acls  = [ ".r:host1.example.com,host2.example.com",<br/>                 ".rlistings" ]<br/>  write_acls = [ "${var.domain}.Storage.Storage_ReadWriteGroup" ]</strong><br/>}</span></pre><p id="8673" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有关对象存储经典ACL的更多详细信息，请参考<a class="ae jg" href="https://docs.oracle.com/en/cloud/iaas/storage-cloud/cssto/setting-container-metadata.html#GUID-EAFEF8A7-9988-4332-B969-FF3CBE1B8E7C" rel="noopener ugc nofollow" target="_blank">设置容器ACL</a>文档</p><h2 id="7333" class="jh ji hh bd jj jk jl jm jn jo jp jq jr ip js jt ju it jv jw jx ix jy jz ka kb bi translated">克-奥二氏分级量表</h2><p id="9251" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">为了支持<a class="ae jg" href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing" rel="noopener ugc nofollow" target="_blank">容器和对象的跨源资源共享</a>，可以设置属性<code class="du jc jd je jf b">allowed_origins</code>、<code class="du jc jd je jf b">exposed_headers</code>、<code class="du jc jd je jf b">max_age</code>。CORS元数据在容器中设置，但也适用于容器中的所有对象。</p><pre class="kh ki kj kk fd kl jf km kn aw ko bi"><span id="c0a4" class="jh ji hh jf b fi kp kq l kr ks">resource "opc_storage_container" "container" {<br/>  name            = "my-storage-container"<br/><strong class="jf hi">  </strong><strong class="jf hi">allowed_origins = [ "</strong><a class="ae jg" href="https://storageconsole.us2.oraclecloud.com" rel="noopener ugc nofollow" target="_blank"><strong class="jf hi">https://www.example.com</strong></a><strong class="jf hi">" ]<br/>  </strong><strong class="jf hi">exposed_headers = [ "</strong><strong class="jf hi">Content-Length</strong><strong class="jf hi">" ]<br/></strong><strong class="jf hi">  max_age         = 60</strong><br/>}</span></pre><h2 id="1437" class="jh ji hh bd jj jk jl jm jn jo jp jq jr ip js jt ju it jv jw jx ix jy jz ka kb bi translated">临时URL</h2><p id="e9ee" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">管理用于访问容器内内容的临时URL需要设置用于生成临时URL的加密密钥。可以使用<code class="du jc jd je jf b">primary_key</code>属性设置容器特定的键。另外<code class="du jc jd je jf b">secondary_key</code>也可以设置为支持按键旋转。</p><pre class="kh ki kj kk fd kl jf km kn aw ko bi"><span id="ecc1" class="jh ji hh jf b fi kp kq l kr ks">resource "opc_storage_container" "container" {<br/>  name          = "my-storage-container"<br/><strong class="jf hi">  primary_key   = "secret1"<br/>  secondary_key = "secret2"</strong><br/>}</span></pre><p id="501b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Terraform不支持创建实际的临时URL。有关生成临时访问URL的详细信息，请参考<a class="ae jg" href="https://docs.oracle.com/en/cloud/iaas/storage-cloud/cssto/downloading-object-using-temporary-url.html" rel="noopener ugc nofollow" target="_blank">使用临时URL下载对象</a>文档</p><h1 id="14e8" class="kt ji hh bd jj ku kv kw jn kx ky kz jr la lb lc ju ld le lf jx lg lh li ka lj bi translated">存储对象</h1><p id="00c1" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated"><code class="du jc jd je jf b">opc_storage_object</code>资源表示并创建容器中的数据对象。在Terraform配置中包含存储对象对于部署实例初始化所需的共享配置文件和安装程序或上传应用程序的静态内容非常有用。</p><p id="caf0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有三种不同的方式为新的存储对象提供内容，即来自本地文件和来自另一个存储对象的内联内容。对于简单的对象和数据文件，内联提供内容可能很有用。</p><pre class="kh ki kj kk fd kl jf km kn aw ko bi"><span id="b5c7" class="jh ji hh jf b fi kp kq l kr ks">resource "opc_storage_object" "from-content" {<br/>  name      = "my-object-from-content.txt"<br/>  container = "${opc_storage_container.container.name}"<br/>  <strong class="jf hi">content   = "The quick brown fox jumps over the lazy dog"</strong><br/>}</span></pre><p id="bb93" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="ls">然而</em> </strong>，在处理较大的对象/文件时要小心，虽然使用插值函数<code class="du jc jd je jf b">content = "${<strong class="ig hi">file(</strong>"./source_file.txt"<strong class="ig hi">)</strong>}"</code>简单地从文件加载内容可能很诱人，但这将导致文件内容成为地形状态的一部分。</p><p id="c728" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">幸运的是，还有另一个选择，使用<code class="du jc jd je jf b">file</code>属性来创建对象，而不用在Terraform状态下存储内容。当使用<code class="du jc jd je jf b">file</code>属性时，建议也用文件的MD5散列设置<code class="du jc jd je jf b">etag</code>，这将确保如果本地文件改变，对象将被重新创建</p><pre class="kh ki kj kk fd kl jf km kn aw ko bi"><span id="3faf" class="jh ji hh jf b fi kp kq l kr ks">resource “opc_storage_object” “from-file” {<br/> name = “my-object-from-file.txt”<br/> container = “${opc_storage_container.container.name}”<br/> <strong class="jf hi">file = “./source_file.txt”</strong><br/> <strong class="jf hi">etag = “${md5(file(“./source_file.txt”))}”</strong><br/> content_type = “text/plain;charset=utf-8”<br/>}</span></pre><p id="9d73" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第三个选项是使用<code class="du jc jd je jf b">copy_from</code>选项从同一个存储服务中的<em class="ls">现有的</em>对象创建新的存储对象。源对象由要复制的对象的完整<code class="du jc jd je jf b">container/object_name</code> id标识。</p><pre class="kh ki kj kk fd kl jf km kn aw ko bi"><span id="d6e1" class="jh ji hh jf b fi kp kq l kr ks">resource "opc_storage_object" "copy-from-object" {<br/>  name = "my-object-from-object"<br/>  container = "${opc_storage_container.container.name}"<br/>  <strong class="jf hi">copy_from = "my-container/my-existing-object"</strong><br/>}</span></pre><h1 id="9b82" class="kt ji hh bd jj ku kv kw jn kx ky kz jr la lb lc ju ld le lf jx lg lh li ka lj bi translated">元数据头</h1><p id="2d4c" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated"><code class="du jc jd je jf b">opc_storage_container</code>和<code class="du jc jd je jf b">opc_storage_object</code>资源都支持设置额外的定制元数据头，这将导致在相应的容器和对象资源上设置<code class="du jc jd je jf b">X-Container-Meta-{name}</code>和<code class="du jc jd je jf b">X-Object-Meta-{name}</code>头，其中<code class="du jc jd je jf b">{name}</code>是定制元数据名称。</p><p id="2b86" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">额外的头被定义为<code class="du jc jd je jf b">metadata</code>块中的任意键值对，例如</p><pre class="kh ki kj kk fd kl jf km kn aw ko bi"><span id="99e3" class="jh ji hh jf b fi kp kq l kr ks">resource "opc_storage_container" "container" {<br/>  name = "my-storage-container"<br/><strong class="jf hi">  metadata {<br/>    "Foo"    = "Bar"<br/>    "MyTags" = "tag1,tag2,tag3"<br/>  }</strong><br/>}</span></pre></div></div>    
</body>
</html>