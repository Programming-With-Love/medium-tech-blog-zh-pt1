<html>
<head>
<title>Connect to Google Cloud SQL Privately</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">私接谷歌云SQL</h1>
<blockquote>原文：<a href="https://medium.easyread.co/connect-to-google-cloud-sql-privately-96233fa3537a?source=collection_archive---------0-----------------------#2020-05-07">https://medium.easyread.co/connect-to-google-cloud-sql-privately-96233fa3537a?source=collection_archive---------0-----------------------#2020-05-07</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/cbf776f38c59f7855ad76c86c7c18020.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-QMgpxdoxS7AtDlbgMb9vg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk"><a class="ae jz" href="https://www.vecteezy.com/free-vector/database" rel="noopener ugc nofollow" target="_blank">Database Vectors by Vecteezy</a></figcaption></figure><p id="32e4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">大家好！和我一起，一次又一次地，分享一些关于软件工程领域技术相关的经验、想法或观点。在这一节中，我想分享我们如何从本地机器上秘密地访问MySQL数据库。</p><p id="a442" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">本地机器的用途是什么？好吧，也许我们心中有这个问题。让我解释一下，例如，您想要使用云上的数据库来调试一些东西，或者只是使用Sequel Pro、MySQL Workbench等数据库客户端来访问数据。</p><p id="78d2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们在这部分需要什么？我们当然应该准备这个东西:</p><ul class=""><li id="8d90" class="ky kz in kc b kd ke kh ki kl la kp lb kt lc kx ld le lf lg bi translated">谷歌计算引擎</li><li id="e0f1" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">OpenVPN</li><li id="6ec3" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">谷歌云SQL</li><li id="9218" class="ky kz in kc b kd lh kh li kl lj kp lk kt ll kx ld le lf lg bi translated">HAProxy</li></ul><p id="f23a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们将尝试实现这个图表架构。作为用户，我们应该能够通过代理访问应用程序和MySQL。但是对于用户数据库，需要使用VPN。</p><p id="ed16" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们将专注于用户数据库部分。因为我已经在这个链接<a class="ae jz" href="https://medium.com/@bismobaruno/deploying-go-app-with-haproxy-docker-to-google-compute-engine-f7e01693b645" rel="noopener">https://medium.com/@bismobaruno/f7e01693b645</a>中讲述了一个用户应用程序的类似案例，但是没有数据库连接。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div class="gh gi lm"><img src="../Images/1d39b0b6477ce39eea36b4410cf74686.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/format:webp/1*KEMhwEmDzbK_e3vUBHFXxQ.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 1 Diagram Architecture</figcaption></figure><h1 id="c6d1" class="lr ls in bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">1.设置计算引擎</h1><p id="12fb" class="pw-post-body-paragraph ka kb in kc b kd mp kf kg kh mq kj kk kl mr kn ko kp ms kr ks kt mt kv kw kx ig bi translated">前往https://console.cloud.google.com/<a class="ae jz" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">的</a>，在计算引擎菜单下选择虚拟机实例</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mu"><img src="../Images/002e56333ff4e635cc397f8024b9e339.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qtwp1qgHeOFAXcZcYqu1rA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 2 Go to VM Instances Page</figcaption></figure><p id="d59c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">点击<strong class="kc io">创建</strong>按钮创建实例。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mv"><img src="../Images/71af5cc79d89d74e2af247ac46c43fb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9knvpjuhiqoD4E-53Y7jNA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 3 Create VM Instances</figcaption></figure><p id="4431" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们将更改一些数据，如机器类型、引导盘、防火墙，其余的保持默认。点击<strong class="kc io">创建</strong>按钮继续该过程。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mw"><img src="../Images/566b6c367731089685d5d566ae0e4010.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K-vnfQWaEA4njZuhuYNVlA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 4.1 Fill the Instance Specification</figcaption></figure><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mx"><img src="../Images/7b03f2a5ab55edb40e980836259408b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9PCVOO1_wEyAa_CkbfnnHg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 4.2 Fill the Instance Specification</figcaption></figure><p id="f6a7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">请稍等片刻，直到我们的实例准备就绪。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/be11349614620194bb81d27bce1aaf5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YTpNBLEWcH_Jb1NBFrzxxw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 5 VM Instances List</figcaption></figure><h1 id="c03b" class="lr ls in bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">2.设置OpenVPN</h1><p id="9b66" class="pw-post-body-paragraph ka kb in kc b kd mp kf kg kh mq kj kk kl mr kn ko kp ms kr ks kt mt kv kw kx ig bi translated">我们将需要一个VPN访问数据库的私人和安全。OpenVPN是一个选项。OpenVPN是什么？</p><p id="9589" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> OpenVPN </strong>为企业提供灵活的VPN解决方案，以保护所有数据通信和扩展专用网络服务，同时保持安全性。</p><p id="16bc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">以及我们为什么使用它？因为OpenVPN是一种流行的开源VPN，并且易于安装。我们应该连接到实例来进行安装。</p><p id="ac92" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">有几种方法可以从浏览器模式下的SSH开始连接到实例，直到使用gcloud命令或使用另一个SSH客户端。通过单击Connect列上SSH文本旁边的箭头按钮来查看列表。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mz"><img src="../Images/b6e743ff53241934fb44ec0ca6cd873f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LBBzVvBh4pPdFcV2rdDMQw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 6 SSH to Instance Guides</figcaption></figure><p id="fc87" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们将使用gcloud命令轻松连接到Google云服务。关于如何安装gcloud命令的细节，请看这个链接<a class="ae jz" href="https://cloud.google.com/sdk/install" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/sdk/install</a>，因为它依赖于我们的操作系统。</p><p id="f941" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在本例中，我使用的是macOS，步骤如下所示</p><p id="2b31" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用终端下载gcloud SDK:</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="e7d4" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">curl </strong><a class="ae jz" href="https://sdk.cloud.google.com" rel="noopener ugc nofollow" target="_blank"><strong class="nb io">https://sdk.cloud.google.com</strong></a><strong class="nb io"> | bash</strong></span></pre><p id="8843" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">重新启动外壳:</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="89a5" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">exec -l $SHELL</strong></span></pre><p id="b6ad" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">运行gcloud init并完成安装(您会被问到几个关于google帐户、云项目、计算引擎区域的问题):</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="bd86" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">gcloud init</strong></span></pre><p id="214d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">安装完成后，尝试连接到实例:</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="eddd" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">gcloud beta compute ssh --zone "us-central1-a" "instance-1" --project "db-app-276509"</strong></span></pre><p id="824c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">太好了，我们进去了！</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nk"><img src="../Images/77ffd7e24bad5e158ae64f66bdda3773.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BSe_aGd9jvLYWyrpp4uWoA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 7 Remote the Instance</figcaption></figure><p id="d7fa" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">接下来，我们将安装OpenVPN。首先，使用apt作为软件包管理来更新软件包，使用以下命令(-y表示如果出现提示，假设是):</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="4f27" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">sudo apt-get update -y</strong></span></pre><p id="e1cf" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">由<a class="ae jz" href="https://github.com/skiddow/OpenVPN" rel="noopener ugc nofollow" target="_blank">https://github.com/skiddow/OpenVPN</a>使用安装脚本进行安装。Do wget &amp; bash命令:</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="a3b9" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">sudo wget https://skiddow.github.io/OpenVPN/openvpn-install.sh &amp;&amp; sudo bash openvpn-install.sh</strong></span></pre><p id="eee5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们会问几个类似IP地址(私有)的问题:</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nl"><img src="../Images/47e62b125499b0f78882a4e075840c5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UViiwiV_pctoEBhEC9y5tg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 8 OpenVPN Private IP</figcaption></figure><p id="0793" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">公共IP地址/主机名:</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nm"><img src="../Images/2173db6b91996c602861068ba5c2533e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JRUwW6x9T1V9ncuMupn77Q.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 9 OpenVPN Public IP</figcaption></figure><p id="d6c0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">协议(UDP或TCP):</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nn"><img src="../Images/6bf62be6148135f5bddad10cbc297751.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8QlyqTMtwW0ymXShdU4hJg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 10 OpenVPN Protocol</figcaption></figure><p id="1289" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">OpenVPN监听哪个端口:</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi no"><img src="../Images/7b95c44f71a937bf8cea8384842126e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BRKehnjmxBGOj-szdZE7MA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 11 OpenVPN Port</figcaption></figure><p id="3ee7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">VPN的DNS:</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nl"><img src="../Images/2131e6933673f98fabc4dc773a1dfde7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hJwl_8EJEvDPDFS0RU7D5g.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 12 OpenVPN DNS</figcaption></figure><p id="ee01" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">客户端名称:</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi np"><img src="../Images/6519d32a7a6cf6cd48e49ddab1c1fa3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P5Sj1RPUbu4WYG63JoZucQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 13 OpenVPN Client Name</figcaption></figure><p id="3a25" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后，按任意键继续该过程:</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nq"><img src="../Images/32370b144c66d58043a504b52a479011.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oxr4cceW3Vn-RBSCvVfUdA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 14 OpenVPN Ready to Set Up</figcaption></figure><p id="83d8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">安装完成后，我们将在/home/client-vpn.ovpn中找到该文件</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi no"><img src="../Images/db977a790f3fdc2aa6fa558e3db68433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7yvfo1tRNRigQ5ByLEWo6Q.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 15 OpenVPN Successfully Created</figcaption></figure><p id="8fcb" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用SCP将文件从服务器复制到本地，我们将把它放在Users/momo/openvpn/client-VPN . ovpn本地路径中</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="b01e" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">gcloud beta compute scp --zone "us-central1-a" "instance-1:/home/client-vpn.ovpn" --project "db-app-276509" /Users/momo/openvpn/client-vpn.ovpn</strong></span></pre><p id="a1cc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这个文件下载后的样子。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nr"><img src="../Images/6299e9fb145ee06c63c2adbda802101e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D_OprQOHPbxt-X44ix58XA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 16 OpenVPN File</figcaption></figure><p id="0b75" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">接下来，因为我们监听OpenVPN的1194 (UDP)端口，我们应该添加新的防火墙规则。回到GCP控制台，转到VPC网络菜单下的防火墙规则。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/6c415c74d776af13038026ba6356be55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d_KtiAIHBbvecWGO-JgpGQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 17 Go to Firewall Rules</figcaption></figure><p id="2d04" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">点击<strong class="kc io">创建防火墙规则</strong>按钮。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/2698793cc1556c77800454743a5b9edb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i6emTv6_XveAVd0lmCA6Kg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 18 Create Firewall Rule</figcaption></figure><p id="2bcd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">添加防火墙规则的名称</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ns"><img src="../Images/bf649bd4f11e31c94f9a72beaa96ebb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fUhZjSYmSGnZTYBNI6D5vg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 19.1 Config Firewall Rule</figcaption></figure><p id="2ab5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">更改<strong class="kc io">目标</strong>和<strong class="kc io">源IP范围</strong>还指定了协议和端口(UDP-1194)。点击<strong class="kc io">创建</strong>按钮完成该步骤。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/814aeeb711476dcc17163b53a91901cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AewFReHia_283o1cQvry1g.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 19.2 Config Firewall Rule</figcaption></figure><p id="1bae" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">防火墙已成功创建</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mx"><img src="../Images/72ddac80091a87f59e78395ee5d8fc27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zlko5poAvhjVebKKkVTZJw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 20 Firewall Rule List</figcaption></figure><p id="63fa" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">对于macOS，使用Tunnelblick<a class="ae jz" href="https://tunnelblick.net/" rel="noopener ugc nofollow" target="_blank">https://tunnelblick.net/</a>运行ovpn文件可能很容易，只需安装Tunnelblick并双击该文件。将ovpn文件配置到Tunnelblick后，我们就可以连接了，如果连接成功，进度应该是这样的。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/ab8dffb983cd4e013b669bf95de6d6ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*jQ5uBmxBf1s-vrL4c1aPcg.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 21 VPN Connected</figcaption></figure><p id="ec1b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">通过ping我们的实例私有IP来测试连接。嗯，我们得到了服务器的回复。这意味着我们的VPN工作！</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nn"><img src="../Images/0e34328bb2e1a7445c7f14a374b5ec53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o1r97iTWTy3W9EwQMUZDoA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 22 Ping Instance by Private IP</figcaption></figure><h1 id="c564" class="lr ls in bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">3.设置云SQL</h1><p id="54bb" class="pw-post-body-paragraph ka kb in kc b kd mp kf kg kh mq kj kk kl mr kn ko kp ms kr ks kt mt kv kw kx ig bi translated">转到GCP控制台并选择SQL菜单</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nu"><img src="../Images/a766aa599101cbc5543d8f9dc2a4225e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2WT_j9hWM0lX7K1KDa8-2Q.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 23 Go to SQL</figcaption></figure><p id="ffc6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">点击<strong class="kc io">创建实例</strong>按钮创建实例。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/db5dcde5f836b953296d5cb3f7938856.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*slsRFFdeE24A5ryKXAwLaw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 24 Create SQL Instance</figcaption></figure><p id="f645" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">选择MySQL作为数据库引擎。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/3cb276d9929eef51650ebaa1cdebb752.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VGlEoT9eQzV9vrjVSkSauA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 25 Choose MySQL DB Engine</figcaption></figure><p id="60d1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为实例添加一个名称，并生成一个root密码，如果我们想自动这样做的话。将其余部分保留为默认值，并扩展配置选项。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mx"><img src="../Images/9cb4eeee060246b2178e620f16c419cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RPIzyVH5pqjPQUAPJ43FSw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 26.1 MySQL Config</figcaption></figure><p id="5d85" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们将修改连接选项，并启用私有IP。然后单击“分配并连接”继续该过程。不要忘记禁用公共IP连接。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nv"><img src="../Images/f5a34a279d2c89637e5f2e43333efbab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2SqKvbQppRkY6F-My91mkw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 26.2 MySQL Config</figcaption></figure><p id="8285" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">完成关联网络后，点击创建按钮创建MySQL实例。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nw"><img src="../Images/fc44f675c288c54468fd030ae9fe6478.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EjQJIfh_YJiy7LT7bqxKLw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 26.3 MySQL Config</figcaption></figure><p id="6546" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">成功创建MySQL实例后，我们将被重定向到页面列表。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nw"><img src="../Images/352ba501cf390e4777e9ffcaacbf952b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Zj7oMc0yMgRWRd7dsBOlw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 27 SQL Instance List</figcaption></figure><p id="2a7b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">接下来，我们应该添加新的防火墙规则，允许从代理到MySQL的连接。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/6c415c74d776af13038026ba6356be55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d_KtiAIHBbvecWGO-JgpGQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 28 Go to Firewall Rules</figcaption></figure><p id="5062" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">点击<strong class="kc io">创建防火墙规则</strong>按钮。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nx"><img src="../Images/668ce21e0c0b0e25706fc4e8392020a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K_rmyudFG0khY6v6w4uzVw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 29 Create Firewall Rule</figcaption></figure><p id="ca5a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">添加<strong class="kc io">名称</strong>、<strong class="kc io">目标</strong>、<strong class="kc io">源IP范围</strong>(因为我们要限制私有IP的访问)和<strong class="kc io">协议</strong> + <strong class="kc io">端口</strong>。点击<strong class="kc io">创建</strong>按钮完成该步骤。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nx"><img src="../Images/51917f12487c497e3b84dce19b6faf06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mC87SC8wzoql5oxQs6QiMQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 30.1 Config Firewall Rule</figcaption></figure><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mu"><img src="../Images/2631f005123c02ee7fb45b4ddeb94ab0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2M-X7aj0s84JGEyx92MJbQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 30.2 Config Firewall Rule</figcaption></figure><h1 id="77a1" class="lr ls in bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">4.设置MySQL客户端+ HAProxy</h1><p id="ac3b" class="pw-post-body-paragraph ka kb in kc b kd mp kf kg kh mq kj kk kl mr kn ko kp ms kr ks kt mt kv kw kx ig bi translated">现在，是时候使用HAProxy配置代理，并设置MySQL客户端以连接到我们的VM实例中的MySQL数据库。</p><p id="85d3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">回到我们的VM实例，使用ssh进行连接。成功完成ssh后，更新包。</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="df4f" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">sudo apt-get update -y</strong></span></pre><p id="8a28" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后，安装MySQL客户端。</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="8c2f" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">sudo apt-get install mysql-client</strong></span></pre><p id="9e6a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用此命令检查连通性。</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="154a" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">mysql -h 10.28.128.3 -u root -p -e "SHOW DATABASES"</strong></span></pre><p id="505a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们将询问root密码。输入root密码，然后按回车键。数据库列表应该显示在响应中。</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nn"><img src="../Images/35b9806fa4d79b0fd1becd86f92fdfd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z8kHh3rIfM8puciYS5A_5g.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 31 MySQL Databases</figcaption></figure><p id="1b84" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">太好了，我们的连接没有问题。但是，我们需要为HAProxy创建一个用户。HAProxy将使用该用户来检查服务器的状态。</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="260f" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">mysql -h 10.28.128.3 -u root -p -e "INSERT INTO mysql.user (Host,User,ssl_cipher,x509_issuer,x509_subject) values ('10.128.0.2','haproxy_check','','',''); FLUSH PRIVILEGES;"</strong></span></pre><p id="40dd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">很好，我们可以进入下一步，安装HAProxy。</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="08fa" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">sudo apt-get install haproxy</strong></span></pre><p id="9b85" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">通过检查版本来验证安装。</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="cbe3" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">sudo haproxy -version</strong></span></pre><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nm"><img src="../Images/f6d08904a86396750868c6e2fbbe4007.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nir-f8YI0MCZ-utX8NrGxw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 32 HAProxy Version</figcaption></figure><p id="b3cc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使HAProxy能够由init脚本启动。</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="11ec" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">sudo sed -i "s/ENABLED=0/ENABLED=1/" /etc/default/haproxy</strong></span></pre><p id="68d4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">检查HAProxy使用命令。</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="8b15" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">sudo service haproxy</strong></span></pre><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nl"><img src="../Images/0160e44b96b7f07d90156fada87f3c10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UZ7H13nmaN0pNmlRWoGHuw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 33 HAProxy Usage Command</figcaption></figure><p id="f61b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">移动原始文件进行备份</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="0f43" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">sudo mv /etc/haproxy/haproxy.cfg{,.original}</strong></span></pre><p id="5a54" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">创建HAProxy配置文件</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="d225" class="nf ls in nb b gy ng nh l ni nj"><strong class="nb io">sudo nano /etc/haproxy/haproxy.cfg</strong></span></pre><p id="39da" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">粘贴这段代码</p><figure class="ln lo lp lq gt jo"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="ec08" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">启动服务</p><pre class="ln lo lp lq gt na nb nc nd aw ne bi"><span id="efa8" class="nf ls in nb b gy ng nh l ni nj">sudo service haproxy start</span></pre><p id="5b0f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">通过网络浏览器访问公共/私有IP来检查HAProxy的统计数据</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oa"><img src="../Images/281864ec66241d3d97785dfcd9711a1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*phQeBnagZryp6-aptQHroA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 34 HAProxy Stats</figcaption></figure><p id="7e68" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">是啊，如果我们能看到页面统计，似乎HAProxy正在工作</p><h1 id="eed6" class="lr ls in bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">5.测试</h1><p id="f544" class="pw-post-body-paragraph ka kb in kc b kd mp kf kg kh mq kj kk kl mr kn ko kp ms kr ks kt mt kv kw kx ig bi translated">最后一步是测试我们的私有连接。因为我用的是macOS，Sequel Pro是做这个测试的一个选项。不要忘记连接我们创建的VPN</p><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ob"><img src="../Images/3b8ddddaab4dd71c5031f76346d160a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lCSjiQluZ9r7MIvXXX3kwA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 35 Connect Using Sequel Pro</figcaption></figure><figure class="ln lo lp lq gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oc"><img src="../Images/8ee93215cac5e3d0ff396811e0ecf3dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DY_3uG57quo2jkvvxAnYug.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Picture 36 Successfully Connected</figcaption></figure><p id="a41f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">耶！！起作用了！！我们可以通过VPN私下访问我们的数据库！</p><p id="ba2d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">希望你喜欢它，我很高兴如果这篇文章对你有用！私底下开心！</p><p id="306c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">谢谢大家！</p></div></div>    
</body>
</html>