<html>
<head>
<title>Hands on Jetpack Compose VisualTransformation to create a phone number formatter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">亲手用Jetpack编写VisualTransformation来创建电话号码格式化程序</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/hands-on-jetpack-compose-visualtransformation-to-create-a-phone-number-formatter-99b0347fc4f6?source=collection_archive---------0-----------------------#2021-12-21">https://medium.com/google-developer-experts/hands-on-jetpack-compose-visualtransformation-to-create-a-phone-number-formatter-99b0347fc4f6?source=collection_archive---------0-----------------------#2021-12-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/7c970f69eb313d3872ef47514ab89517.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FGDDwuRVny1Y48PX-QGNUw.png"/></div></div></figure><p id="2ac9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在Aircall，我们目前正在用Jetpack Compose重写我们的设计系统，这是Google制作的新UI框架。我们的UI组件之一是一个文本输入，它根据电话号码的来源国家将电话号码格式化为国际格式。有了View UI toolkit，我们可以使用一个<a class="ae jn" href="https://developer.android.com/reference/android/telephony/PhoneNumberFormattingTextWatcher" rel="noopener ugc nofollow" target="_blank"><strong class="ir hi">PhoneNumberFormattingTextWatcher</strong></a>来格式化输入文本，这个工具从API 1开始就可用了。但是到目前为止，Jetpack Compose还没有实现类似的功能。在这篇文章中，我们将讲述我们是如何设法创建一个可靠的选择，用<a class="ae jn" href="https://developer.android.com/reference/kotlin/androidx/compose/ui/text/input/VisualTransformation" rel="noopener ugc nofollow" target="_blank"> <strong class="ir hi">可视化转换</strong> </a>进行组合。</p><h1 id="5226" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">VisualTransformation解释</h1><p id="3ef1" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">首先，让我们看一下<strong class="ir hi"> VisualTransformation </strong>接口，了解它是如何工作的，以及如何使用它来格式化<strong class="ir hi"> TextField </strong>的输入文本。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="5489" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了过滤文本，您需要实现<strong class="ir hi"> <em class="kx"> filter() </em> </strong>函数，该函数把要转换的原始文本作为一个参数，并返回一个<a class="ae jn" href="https://developer.android.com/reference/kotlin/androidx/compose/ui/text/input/TransformedText" rel="noopener ugc nofollow" target="_blank"><strong class="ir hi">transformed text</strong></a>，所有的神奇都发生在这里！<strong class="ir hi"> </strong>如果我们看一下构造函数，它需要一个<strong class="ir hi"> <em class="kx">文本</em> </strong>(将被转换)和一个<a class="ae jn" href="https://developer.android.com/reference/kotlin/androidx/compose/ui/text/input/OffsetMapping" rel="noopener ugc nofollow" target="_blank"><strong class="ir hi">offset mapping</strong></a><strong class="ir hi"/>，这提供了原始文本和新文本之间的双向映射。这意味着我们需要实现从原来的和<strong class="ir hi">到</strong>的转换<strong class="ir hi">。</strong></p><p id="2db0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">让我们来看看框架提供的密码转换，看看OffsetMapping是如何工作的:</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="3c86" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在这里，实现非常简单，因为我们只需要转换输入文本，其中每个字符都将被替换为掩码，因此文本将具有相同的长度。转换后的文本将包含映射文本，而<strong class="ir hi"> <em class="kx">偏移映射</em> </strong>将处理转换。这里，由于我们没有任何额外的字符显示在返回的文本中，这两个函数将返回原始的偏移量。</p><p id="57a7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果我们需要在格式化文本中显示额外的字符，比如信用卡格式，这两种转换可能会变得更复杂。</p><p id="2b1e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果我们想每4位数增加一个破折号，这里是<strong class="ir hi"> OffsetMapping </strong>的实现。当我们转换原始文本时，只要我们到达一个新的4位数，我们就返回原始偏移量+破折号的数量。相反，当我们到达相关的4位数块时，我们将返回转换后的文本的偏移量减去破折号的数量。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="2cfa" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在我们已经很好地了解了用于构建国际电话号码格式化程序的<strong class="ir hi"> VisualTransformation </strong>接口。让我们看看如何通过<a class="ae jn" href="https://github.com/google/libphonenumber" rel="noopener ugc nofollow" target="_blank"> <strong class="ir hi"> libphonenumber </strong> </a>库来实现格式化。</p><h1 id="d650" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">将文本格式化为电话号码</h1><p id="c4c8" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">为了格式化TextField的输入文本，我们使用了以下由Google开发和维护的库。</p><div class="ky kz ez fb la lb"><a href="https://github.com/google/libphonenumber" rel="noopener  ugc nofollow" target="_blank"><div class="lc ab dw"><div class="ld ab le cl cj lf"><h2 class="bd hi fi z dy lg ea eb lh ed ef hg bi translated">GitHub-Google/libphonenumber:Google常用的Java、C++和JavaScript库，用于解析…</h2><div class="li l"><h3 class="bd b fi z dy lg ea eb lh ed ef dx translated">Google的通用Java、C++和JavaScript库，用于解析、格式化和验证国际电话号码…</h3></div><div class="lj l"><p class="bd b fp z dy lg ea eb lh ed ef dx translated">github.com</p></div></div><div class="lk l"><div class="ll l lm ln lo lk lp in lb"/></div></div></a></div><p id="c6d8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果我们看一下<a class="ae jn" href="https://developer.android.com/reference/android/telephony/PhoneNumberFormattingTextWatcher" rel="noopener ugc nofollow" target="_blank"><strong class="ir hi">PhoneNumberFormattingTextWatcher</strong></a>的实现，我们可以看到它使用电话号码库的内部版本来格式化输入文本。这将是对原文进行格式编排的坚实基础。</p><p id="cdac" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了在输入时格式化文本，我们将使用一个来自库的<strong class="ir hi"> PhoneNumberUtil </strong>实例的<a class="ae jn" href="https://github.com/google/libphonenumber/blob/master/java/libphonenumber/src/com/google/i18n/phonenumbers/AsYouTypeFormatter.java" rel="noopener ugc nofollow" target="_blank"><strong class="ir hi">AsYouTypeFormatter</strong></a>。在构建新实例时，不要忘记使用正确的<strong class="ir hi">区域设置</strong>，以便为键入的电话号码设定所需的格式。</p><p id="03f1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">格式将取决于光标位置和最后一个非分隔符(<em class="kx">又名</em>键入数字的最后一位)。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="cfc0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了正确地重新格式化输入，我们查看了来自<a class="ae jn" href="https://android.googlesource.com/platform/frameworks/base/+/master/telephony/java/android/telephony/PhoneNumberFormattingTextWatcher.java#130" rel="noopener ugc nofollow" target="_blank"> Android Sources </a>中<strong class="ir hi">PhoneNumberFormattingTextWatcher</strong>的<strong class="ir hi"> <em class="kx"> reformat() </em> </strong>方法的实现，并对其进行了调整以适应我们的用例:</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="b7fe" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在我们已经根据需要重新格式化了输入文本，我们将计算VisualTransformation所需的偏移量，以便在输入中进行适当的光标管理。</p><p id="5d9c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了计算偏移量，我们将对格式化文本的每个字符进行迭代。首先，我们将检查该字符是否是分隔符，以便将该字符的索引存储在一个专用列表中，一个用于原始到转换后的文本，另一个用于其他方式。</p><p id="18ac" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在处理格式化文本时，我们将记录电话号码中出现的特殊字符的数量。这将帮助我们存储正确的索引，以便在从格式化形式转换到原始形式时保持光标的正确位置。</p><p id="b04c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">换句话说，当你想要编辑一个数字时，你可以点击它，光标就会在正确的位置。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="798c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在我们有了完成电话号码格式化程序所需的一切，让我们看看如何构建这个新的电话号码输入，以及它在设计系统中的外观。</p><h1 id="5787" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">用撰写功能格式化电话号码</h1><p id="ddd9" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">如果我们把所有的部分放在一起，我们的<strong class="ir hi">文本字段</strong>就有了一个全新的电话号码<strong class="ir hi"> VisualTransformation </strong>:</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="d312" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这是它在新的Aircall设计系统中的外观，PhoneNumberTextField由一个图像和一个文本字段组成，前者显示国旗，后者显示格式化的电话号码。</p><p id="8fcc" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">使用Compose，我们可以很容易地访问和设置文本转换参数的值，并对<strong class="ir hi">PhoneNumberVisualTransformation()</strong>进行新的定义，如下所示。</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div></figure><p id="b5a2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然后，我们可以构建一个自定义的Composable，它可以检测国家代码并设置相应的标志，或者直接选择国家标志，以避免在输入文本中键入国际扩展名。多亏了<strong class="ir hi"> VisualTransformation </strong>，文本输入将被实时格式化。</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lq"><img src="../Images/3a9b96f104e4a21bd79e974327d79bbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BQhwEPRmVDSmHHUDDppY9A.png"/></div></div><figcaption class="lr ls et er es lt lu bd b be z dx"><em class="lv">PhoneNumberInput</em></figcaption></figure><figure class="kr ks kt ku fd ii er es paragraph-image"><div class="er es lw"><img src="../Images/1a9ad4e4eb57497d0751a48f7e129750.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*2im29wcfhW7vGtw9qiOMFA.gif"/></div></figure></div><div class="ab cl lx ly go lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ha hb hc hd he"><p id="2ede" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">使用Jetpack Compose创建这个电话号码格式化程序在许多方面都非常有趣:使用<strong class="ir hi"> VisualTransformation </strong>理解框架的新部分，或者探索Android源代码以了解事情如何在幕后工作。Compose允许我们非常容易地构建高度可定制的组件，即使我们必须从Android核心API重新实现一些东西。</p><p id="fbff" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这个格式化程序还不完善，可以改进，就像当你长按键盘上的退格键时，电话号码并没有被完全删除。</p><p id="8914" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">非常感谢Aircall Android团队将这个伟大的组件带入生活！🔥</p><p id="ce33" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你有任何问题，请不要犹豫，在推特上联系我🤓</p></div></div>    
</body>
</html>