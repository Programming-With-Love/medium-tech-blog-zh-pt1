<html>
<head>
<title>Personalize for each user &amp; device: the magic Conversation object</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">针对每个用户和设备的个性化:神奇的对话对象</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/personalize-for-each-user-device-the-magic-conversation-object-def0785582f9?source=collection_archive---------0-----------------------#2019-03-08">https://medium.com/google-developer-experts/personalize-for-each-user-device-the-magic-conversation-object-def0785582f9?source=collection_archive---------0-----------------------#2019-03-08</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/b6b1322c6c345dace4fa2c5217a8d3fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9hPvf4yP92LImF5R"/></div></div></figure><p id="ec8b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi jn translated">一个优秀的代理能够为每个用户提供个性化的体验，适应他们的需求，并为他们当前使用的任何设备提供最佳体验。有了谷歌(AoG)的Actions，定制响应、存储信息和操作显示响应的媒介，都可以通过学习如何利用对话对象来实现。</p><p id="3ff2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="jw">如果你已经熟悉了</em> <code class="du jx jy jz ka b">DialogflowConversation</code> <em class="jw">对象，并且想看一些现实世界例子中的代码，</em> <a class="ae kb" href="#c82d" rel="noopener ugc nofollow"> <em class="jw">跳转到这里</em> </a> <em class="jw">。</em></p><p id="2ad7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你现在开始在Google和DialogFlow上操作，你会多次遇到一个名为<code class="du jx jy jz ka b">conv </code> ( <code class="du jx jy jz ka b">DialogflowConversation</code>)的对象。你还会看到，你在你的项目的webhook上的开始代码，与文档有很大的不同。这两个平台都非常新，并且在不断改进，所以这很自然。</p><p id="efb2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">文档片段:</p><pre class="kc kd ke kf fd kg ka kh ki aw kj bi"><span id="cf6a" class="kk kl hh ka b fi km kn l ko kp">function simpleResponse(conv) {<br/>  conv.data.count = 1;<br/>  conv.ask('Hi there, what can I help you with today?');<br/>}</span></pre><p id="f11d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">起始代码</p><pre class="kc kd ke kf fd kg ka kh ki aw kj bi"><span id="c25c" class="kk kl hh ka b fi km kn l ko kp">// ...</span><span id="10bd" class="kk kl hh ka b fi kq kn l ko kp">const agent = new WebhookClient({ request, response });<br/> <br/>  function welcome(agent) {<br/>    agent.add(`Welcome to my agent!`);<br/>  }</span><span id="aabe" class="kk kl hh ka b fi kq kn l ko kp">let intentMap = new Map();<br/>  intentMap.set('Default Welcome Intent', welcome);<br/>  // ...<br/>  agent.handleRequest(intentMap);<br/>});</span></pre><p id="ff1f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">那么我在哪里找到那个<code class="du jx jy jz ka b">conv</code>物体呢？它其实就藏在你的<code class="du jx jy jz ka b">agent</code>里面。你需要做的就是在初始化<code class="du jx jy jz ka b">agent</code>之后添加这一行:</p><pre class="kc kd ke kf fd kg ka kh ki aw kj bi"><span id="b6e8" class="kk kl hh ka b fi km kn l ko kp">let conv= agent.conv();</span></pre><p id="5632" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">请注意，conversation对象不是一个常量。此外，对话对象仅适用于Google Assistant。如果您试图在DialogFlow中测试它，它总是会返回null。如果你在谷歌平台上尝试这种方法，它会非常有效。背后的原因是因为有两个不同的库:<code class="du jx jy jz ka b"><a class="ae kb" href="https://github.com/dialogflow/dialogflow-fulfillment-nodejs#readme" rel="noopener ugc nofollow" target="_blank">dialogflow-fulfillment</a></code>和<code class="du jx jy jz ka b"><a class="ae kb" href="https://github.com/actions-on-google/actions-on-google-nodejs" rel="noopener ugc nofollow" target="_blank">actions-on-google</a></code>。</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kr"><img src="../Images/5ae49bdc14dbc8baf74d6ec0e236bbf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*MXklrKkuF0_HCG6jbuV8Sg.gif"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">Right: Testing on DialogFlow platform. Left: Testing on Actions on Google platform</figcaption></figure><h1 id="217e" class="kw kl hh bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">储存；储备</h1><p id="eb4b" class="pw-post-body-paragraph ip iq hh ir b is lt iu iv iw lu iy iz ja lv jc jd je lw jg jh ji lx jk jl jm ha bi translated">有一篇由<a class="ae kb" rel="noopener" href="/@gnomeontherun"> Jeremy Wilken </a>撰写的关于存储会话数据和存储会话间数据的精彩文章，所以我不会在这里深入探讨。</p><div class="ly lz ez fb ma mb"><a rel="noopener follow" target="_blank" href="/@gnomeontherun/storing-data-during-a-session-and-between-sessions-with-google-actions-ec23a49a40e"><div class="mc ab dw"><div class="md ab me cl cj mf"><h2 class="bd hi fi z dy mg ea eb mh ed ef hg bi translated">使用Google Actions在会话期间和会话之间存储数据</h2><div class="mi l"><h3 class="bd b fi z dy mg ea eb mh ed ef dx translated">有时，在构建语音机器人时，您需要跟踪对话过程中的信息。有一个…</h3></div><div class="mj l"><p class="bd b fp z dy mg ea eb mh ed ef dx translated">medium.com</p></div></div></div></a></div><p id="ee15" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">简而言之，Google上有两种类型的动作存储:</p><ol class=""><li id="3c97" class="mk ml hh ir b is it iw ix ja mm je mn ji mo jm mp mq mr ms bi translated">存储会话数据；这些数据仅在该会话中可用→ <code class="du jx jy jz ka b">conv.data</code></li><li id="3fb8" class="mk ml hh ir b is mt iw mu ja mv je mw ji mx jm mp mq mr ms bi translated">在会话之间存储数据；这些数据将在多个会话中对特定用户可用→ <code class="du jx jy jz ka b">conv.user.storage</code></li></ol><p id="79a7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">此外，如果你希望从另一个平台访问用户的数据，或者将它们存储在其他地方，你可以使用Firebase( <a class="ae kb" rel="noopener" href="/google-developers/do-you-need-to-share-data-between-your-actions-and-your-mobile-and-web-apps-8cf6464d85fd"> 1 </a> )( <a class="ae kb" rel="noopener" href="/google-developers/update-and-customize-queries-on-your-cloud-firestore-data-for-actions-on-google-7eb1010b417f"> 2 </a>)或者你的后端。</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es my"><img src="../Images/2f6ace2049a00d930f340ebd262e3888.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6XBqPmjvYfd2GY4j.jpg"/></div></div></figure><h1 id="9a49" class="kw kl hh bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi">⚠️🛑</h1><p id="ee7f" class="pw-post-body-paragraph ip iq hh ir b is lt iu iv iw lu iy iz ja lv jc jd je lw jg jh ji lx jk jl jm ha bi translated">在某些国家，如果您想要访问或保存userStorage、Firebase或您的后端中的信息，您必须使用<a class="ae kb" href="https://developers.google.com/actions/assistant/helpers#confirmation" rel="noopener ugc nofollow" target="_blank">确认助手</a>请求用户同意，并在您可以开始存储信息之前获得同意。</p><h1 id="6cc4" class="kw kl hh bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">表面性能</h1><p id="bef5" class="pw-post-body-paragraph ip iq hh ir b is lt iu iv iw lu iy iz ja lv jc jd je lw jg jh ji lx jk jl jm ha bi translated">超过10亿台设备上都有谷歌助手。从扬声器和智能显示器到汽车和冰箱，并不是所有的产品都有相同的输出。重要的是，当你制定行动时，要考虑到这一点，并为每个人提供独特的体验。再一次，<code class="du jx jy jz ka b">DialogflowConversation</code>对象拥有了我们需要的一切。为了检查正在进行的这一特定对话的设备功能，我们将以下内容添加到我们的实现中:</p><pre class="kc kd ke kf fd kg ka kh ki aw kj bi"><span id="6f4a" class="kk kl hh ka b fi km kn l ko kp">const hasScreen =<br/>  conv.surface.capabilities.has('actions.capability.SCREEN_OUTPUT');</span><span id="d700" class="kk kl hh ka b fi kq kn l ko kp">const hasAudio =<br/>  conv.surface.capabilities.has('actions.capability.AUDIO_OUTPUT');</span><span id="f124" class="kk kl hh ka b fi kq kn l ko kp">const hasMediaPlayback = <br/>  conv.surface.capabilities.has('actions.<br/>                                  capability.MEDIA_RESPONSE_AUDIO');<br/>    <br/>const hasWebBrowser =<br/>  conv.surface.capabilities.has('actions.capability.WEB_BROWSER');</span></pre><h1 id="e55f" class="kw kl hh bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated"><strong class="ak">助手</strong></h1><p id="4f4d" class="pw-post-body-paragraph ip iq hh ir b is lt iu iv iw lu iy iz ja lv jc jd je lw jg jh ji lx jk jl jm ha bi translated">有些事情你不能问你的用户而不赌博。例如，如果你想派一辆出租车去接你的用户，口头询问他们当前的地址是不理想的。帮助者是在这种情况下提供帮助的特定意图。</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mz"><img src="../Images/345e0d8519aeec4b0a036263136cb563.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PkhKIortI8hNCDeiid00Nw.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">available helper intents: <a class="ae kb" href="https://developers.google.com/actions/assistant/helpers#tab2" rel="noopener ugc nofollow" target="_blank">https://developers.google.com/actions/assistant/helpers#tab2</a></figcaption></figure></div><div class="ab cl na nb go nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ha hb hc hd he"><h1 id="c82d" class="kw kl hh bd kx ky nh la lb lc ni le lf lg nj li lj lk nk lm ln lo nl lq lr ls bi translated">真实世界的例子</h1><p id="774f" class="pw-post-body-paragraph ip iq hh ir b is lt iu iv iw lu iy iz ja lv jc jd je lw jg jh ji lx jk jl jm ha bi translated">很高兴知道所有这些都存在以及它们是如何工作的，但是有哪些真正的用例呢？</p><h2 id="5759" class="kk kl hh bd kx nm nn no lb np nq nr lf ja ns nt lj je nu nv ln ji nw nx lr ny bi translated">会话数据(conv.data)</h2><p id="3146" class="pw-post-body-paragraph ip iq hh ir b is lt iu iv iw lu iy iz ja lv jc jd je lw jg jh ji lx jk jl jm ha bi translated">会话数据在很多情况下非常有用。如果你想通过一遍又一遍地重复同样的事情来使你的行动不那么令人讨厌，你可以用它来计算你的行动没有完成的次数，并提供更多有用的提示。它可以帮助你记录一场比赛的分数，或者如果是一场智力竞赛的话，给你一些提示！</p><pre class="kc kd ke kf fd kg ka kh ki aw kj bi"><span id="0439" class="kk kl hh ka b fi km kn l ko kp">const LIST_FALLBACK = [<br/>   `Sorry, what was that?`,<br/>   `I didn\'t catch that. Could you tell me which one you prefer?`,<br/>   `I'm having trouble understanding. Which one of those do you prefer?`];<br/><br/>const FINAL_FALLBACK = `I'm sorry I'm having trouble here. Let's talk again later.`;</span><span id="6be0" class="kk kl hh ka b fi kq kn l ko kp">function fallback(agent) {<br/>  conv.data.fallbackCount++;<br/>  if (conv.data.fallbackCount &gt; 2) {<br/>      conv.close(FINAL_FALLBACK);<br/>  } else {<br/>      let response = LIST_FALLBACK[conv.data.fallbackCount];<br/>      conv.ask(response);<br/>  }<br/>    agent.add(conv);<br/>}</span></pre><h2 id="21e7" class="kk kl hh bd kx nm nn no lb np nq nr lf ja ns nt lj je nu nv ln ji nw nx lr ny bi translated">存储数据(转换用户存储)</h2><p id="e81f" class="pw-post-body-paragraph ip iq hh ir b is lt iu iv iw lu iy iz ja lv jc jd je lw jg jh ji lx jk jl jm ha bi translated">这使得每个用户的操作都是个性化的。从问候用户的名字到记住他们宠物的名字</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div class="er es nz"><img src="../Images/50751142de617e2512f9999885d286db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1182/format:webp/1*AzHG36O50xUOhlnwAKizmg.png"/></div><figcaption class="ks kt et er es ku kv bd b be z dx">Greet back your users</figcaption></figure><pre class="kc kd ke kf fd kg ka kh ki aw kj bi"><span id="7ab0" class="kk kl hh ka b fi km kn l ko kp">function welcome(agent) {<br/>    if(conv.user.storage.name === undefined) {<br/>      conv.ask(`Welcome to my agent! What's your name?`);<br/>    } else {<br/>      conv.ask(`Welcome back ${conv.user.storage.name}!`);<br/>    }<br/>    agent.add(conv);<br/>  }<br/>  <br/>  function setName(agent) {<br/>    let user_name = agent.parameters.name;<br/>    conv.user.storage.name = user_name;<br/>    conv.ask(`Nice to meet you ${user_name}`);<br/>    agent.add(conv);<br/>  }</span></pre><h1 id="b39f" class="kw kl hh bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">表面性能</h1><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es oa"><img src="../Images/41fa32ce10dbf83d73227e9962cb77c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Frfnh0i8_5WYc3sjL6hgaw.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">Asking my action to show photos from hotels. If a screen isn’t available, it will prompt me to show the results on my phone. When we open the phone though nothing happens</figcaption></figure><pre class="kc kd ke kf fd kg ka kh ki aw kj bi"><span id="ba55" class="kk kl hh ka b fi km kn l ko kp">const { NewSurface } = require('actions-on-google');</span><span id="7e2b" class="kk kl hh ka b fi kq kn l ko kp">function showHotelPhotos(agent) {<br/>   const context = 'Sure, here are some images';<br/>    const notification = 'Hotel photos';<br/>    const capabilities = ['actions.capability.SCREEN_OUTPUT'];<br/>    if (hasScreen) {<br/>      conv.ask(new NewSurface({context, notification,<br/>        capabilities}));<br/>    } else {<br/>      conv.close("You can ask another time for the photos. Anything<br/>        else I can help with?");<br/>    }<br/>    agent.add(conv);<br/>  }</span></pre><p id="d9a4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了展示我们的照片，我们需要创造一个新的事件意图:</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ob"><img src="../Images/fb66db4f0ecb493e293bb3dbb0be193c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9rmlUpoiS5Xs4k1OkdjJyA.png"/></div></div></figure><p id="dc99" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">事件应该是:</p><p id="fd7a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jx jy jz ka b">actions_intent_NEW_SURFACE</code></p><figure class="kc kd ke kf fd ii er es paragraph-image"><div class="er es oc"><img src="../Images/bfdd29769f53706e84ebd1e305474d66.png" data-original-src="https://miro.medium.com/v2/resize:fit:378/format:webp/1*tgLjFc1xVAWu0YYzXBGCiw.png"/></div></figure><p id="7c77" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然后我们可以像处理任何其他意图一样处理来自我们实现的那个意图。我们添加我们的图像以及任何我们想提供给用户的信息，瞧。</p><h1 id="b5ae" class="kw kl hh bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated"><strong class="ak">助手</strong></h1><figure class="kc kd ke kf fd ii er es paragraph-image"><div class="er es od"><img src="../Images/75efa5fae80e7df0791c30b3d4420c86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*g05_H0AuPu2Rs0DRAS5Qtg.png"/></div></figure><p id="06b6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">使用助手也有两个步骤:请求用户的许可和从助手那里得到结果。请求示例如下所示:</p><pre class="kc kd ke kf fd kg ka kh ki aw kj bi"><span id="4682" class="kk kl hh ka b fi km kn l ko kp">function getZipCode(agent) {</span><span id="6a26" class="kk kl hh ka b fi kq kn l ko kp">... // check if we know it already.<br/>   const options = {<br/>   context: 'That\'s not a problem! To get the zip code from your<br/>         location',<br/>   permissions: ['DEVICE_PRECISE_LOCATION']};<br/>   conv.ask(new Permission(options));<br/>   agent.add(conv);<br/>}</span></pre><p id="001a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了从权限请求中获得结果，我们需要再次创建一个单独的intent，其中事件是<code class="du jx jy jz ka b">actions_intent_PERMISSION</code>。</p><pre class="kc kd ke kf fd kg ka kh ki aw kj bi"><span id="b238" class="kk kl hh ka b fi km kn l ko kp">function findStore(agent) {<br/>   const { latitude, longitude } = conv.device.location.coordinates;</span><span id="e1a5" class="kk kl hh ka b fi kq kn l ko kp">   let zipcode = ... ... // Get from Google's geocoding api<br/>   let nearestStore = ... ... // Get from your database<br/>   conv.ask(`The nearest store is at ${nearestStore}. It's<br/>         ${distance} minutes ${means}`);<br/>   agent.add(conv);<br/>}</span></pre><p id="074b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">更多真实的例子可以在<a class="ae kb" href="https://developers.google.com/actions/design/tips" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="ac7e" class="kw kl hh bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated"><strong class="ak">结论</strong></h1><p id="b95f" class="pw-post-body-paragraph ip iq hh ir b is lt iu iv iw lu iy iz ja lv jc jd je lw jg jh ji lx jk jl jm ha bi translated">这个<code class="du jx jy jz ka b">DialogflowConversation</code>物体是让你的体验变得更好的王牌。起初，这可能有点吓人，因为有时与您目前使用的简单intent ← → webhook关系非常不同。一旦你这样做了几次，你会发现这只是一些你需要注意的棘手的部分，你就万事俱备了。</p><p id="8ec2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">有兴趣找出更多方法让您的代理更上一层楼吗？看看这个<a class="ae kb" href="http://bit.ly/dfOnAir_improved_agent" rel="noopener ugc nofollow" target="_blank">对话</a>。你会发现一些最佳实践和一些从我在<a class="ae kb" href="https://medium.com/pixplicity" rel="noopener"> Pixplicity </a>建立的一些行动中学到的教训。</p></div></div>    
</body>
</html>