<html>
<head>
<title>Open sourcing Querybook, Pinterest’s collaborative big data hub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开源Querybook，Pinterest的协作大数据中心</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/open-sourcing-querybook-pinterests-collaborative-big-data-hub-ba2605558883?source=collection_archive---------0-----------------------#2021-03-30">https://medium.com/pinterest-engineering/open-sourcing-querybook-pinterests-collaborative-big-data-hub-ba2605558883?source=collection_archive---------0-----------------------#2021-03-30</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="1406" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc">为日益远程化的工作环境提供高效的大数据解决方案。</em></p><p id="9ad3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Charlie Gu |分析平台技术主管，Lena Ryoo |分析平台软件工程师，Justin Mejorada-Pier |分析平台工程经理</p><p id="f803" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest拥有超过3000亿个pin，为不断增长的独特数据集提供支持，该数据集映射了兴趣、想法和意图。作为一家数据驱动的公司，Pinterest使用数据洞察和分析来做出产品决策和评估，以改善超过4.5亿月用户的Pinner体验。为了不断地进行这些改进，尤其是在日益远程化的环境中，团队能够编写查询、创建分析并相互协作变得比以往任何时候都更加重要。今天，我们将采用<a class="ae jd" href="http://querybook.org" rel="noopener ugc nofollow" target="_blank"> Querybook </a>，这是我们更高效、更协作的大数据访问解决方案，并为社区开源。</p><p id="a24d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest上任何分析的共同起点是在SparkSQL、Hive、Presto集群或任何Sqlalchemy兼容引擎上执行的即席查询。我们构建了Querybook来为这种分析提供一个响应迅速且简单的web UI，以便数据科学家、产品经理和工程师可以发现正确的数据、编写他们的查询并分享他们的发现。在这篇文章中，我们将讨论构建Querybook的动机、它的特性、架构以及我们为开源这个项目所做的工作。</p><h1 id="10f9" class="je jf hh bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">旅程</h1><p id="882b" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">构建Querybook的提议始于2017年，当时是一个实习生项目。在此期间，我们使用供应商提供的web应用程序作为查询UI。经常有用户抱怨这个工具的用户界面，速度和稳定性，缺乏可视化，以及难以共享。不久，我们意识到有一个很好的机会来构建一个更好的查询界面。</p><p id="18da" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们开始采访数据科学家和工程师，询问他们的工作流程，同时确定技术细节。很快，我们意识到大多数人在官方工具之外组织他们的查询，许多人使用像Evernote这样的应用程序。尽管Jupyter有笔记本用户体验，但它使用Python/R的要求和缺乏表元数据集成让许多用户望而却步。基于这一发现，我们的团队决定Querybook的查询界面将是一个文档，用户可以在一个地方编写查询和编写分析，并具有搭配元数据的功能和笔记应用程序的简单性。</p><p id="611c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2018年3月在内部发布，Querybook成为Pinterest查询大数据的官方解决方案。如今，Querybook平均每天有500个dau和7k次查询运行。它的内部用户评分为8.1/10，是Pinterest评分最高的内部工具之一。</p><h1 id="8186" class="je jf hh bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">特色亮点</h1><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/d1ca7af431bfe46f73323699d0a25a4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*yURLyhEfi7ZWs993NBL0uw.gif"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">Figure 1. Querybook’s Doc UI</figcaption></figure><p id="1ac5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当用户第一次访问时，他们会很快注意到它独特的DataDoc界面。这是用户查询和分析的主要地方。每个DataDoc由一系列单元格组成，这些单元格可以是以下三种类型之一:文本、查询或图表。</p><ul class=""><li id="1106" class="kx ky hh ig b ih ii il im ip kz it la ix lb jb lc ld le lf bi translated">文本单元格带有内置的富文本支持，用户可以记下他们的想法或见解。</li><li id="4d41" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated">查询单元用于编写和执行查询。</li><li id="27e8" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated">图表单元格用于根据执行结果创建可视化效果。与Google Docs类似，当用户被授予访问DataDoc的权限时，他们可以实时地相互协作。</li></ul><p id="e52a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">借助直观的图表用户界面，用户可以轻松地将数据文档转换成说明性的仪表板。您可以从不同的可视化选项中进行选择，如时间序列、饼图、散点图等。然后，您可以将可视化连接到DataDoc上任何查询的结果，并根据需要对它们进行排序和聚合的后处理。要自动更新这些图表，您可以使用计划选项并选择您想要的节奏。调度程序可以通知用户成功或失败。结合由<a class="ae jd" href="https://jinja.palletsprojects.com/en/2.11.x/" rel="noopener ugc nofollow" target="_blank"> Jinja </a>提供的模板选项，创建一个实时更新的DataDoc非常快。</p><p id="7094" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">调度和可视化功能并不打算取代诸如Airflow或Superset之类的工具。相反，这些特性为用户提供了一种简单快捷的方式来试验他们的查询并对其进行迭代。通常，Pinterest工程师在创建生产级工作流和仪表板之前，会将Querybook作为编写查询的第一步。</p><p id="d9e5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后但同样重要的是，Querybook附带了一个自动查询分析系统。对执行的每个查询进行分析，以提取元数据，比如被引用的表和查询运行器。Querybook使用这些信息自动更新其数据模式和搜索排名，并显示表中的常用用户和查询示例。查询越多，表格的文档就越多。</p><h1 id="0c2e" class="je jf hh bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">体系结构</h1><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es ll"><img src="../Images/ef51b04314ca2860773c8a027b6a6cc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZpA0Sqpf5X96zRFt"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">Figure 2. Overview of Querybook’s architecture</figcaption></figure><p id="e96b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了理解Querybook是如何工作的，我们将浏览一下编写和执行查询的过程。</p><ol class=""><li id="eaa9" class="kx ky hh ig b ih ii il im ip kz it la ix lb jb lm ld le lf bi translated">第一步是创建一个DataDoc并将查询写入一个单元格。当用户输入时，用户的查询通过Socket.IO传输到服务器。</li><li id="a564" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lm ld le lf bi translated">然后，服务器将增量推送给所有通过Redis读取该DataDoc的用户。同时，服务器会将更新的DataDoc保存在数据库中，并为工作人员创建一个异步作业来更新ElasticSearch中的DataDoc内容。这允许以后搜索数据文档。</li><li id="cc0a" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lm ld le lf bi translated">一旦编写了查询，用户就可以通过单击run按钮来执行查询。然后，服务器将在数据库中创建一个记录，并将一个查询作业插入Redis任务队列。工作者接收任务并将查询发送到查询引擎(Presto、Hive、SparkSQL或任何Sqlalchemy兼容的引擎)。当查询运行时，工作人员通过Socket.IO将实时更新推送到UI。</li><li id="6982" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lm ld le lf bi translated">当执行完成时，工作者加载查询结果，并将其批量上传到可配置的存储服务(例如S3)。最后，浏览器得到查询完成的通知，并请求服务器加载查询结果并显示给用户。</li></ol><p id="8b0b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了简洁起见，本节只关注Querybook的一个用户流。然而，所有使用的基础设施都包括在内。Querybook允许对其中一些进行定制。例如，您可以选择将执行结果上传到S3、谷歌云存储或本地文件。此外，MySQL还可以与任何兼容Sqlalchemy的数据库(如Postgres)交换。</p><h1 id="bb13" class="je jf hh bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">开源之路</h1><p id="86c8" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">在注意到Querybook在内部取得的成功后，我们决定对它进行开源。我们遇到的一个挑战是如何使它通用，同时保留一些Pinterest特有的集成。为此，我们决定通过一个插件系统有一个两层的组织，并添加一个管理用户界面。</p><p id="8529" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Admin UI允许公司从一个友好的界面配置Querybook的查询引擎、表元数据接收和访问权限。以前，这些配置是在配置文件中完成的，需要进行代码更改和部署才能反映出来。有了这个新的用户界面，管理员可以在不查看代码或配置文件的情况下对Querybook进行实时修改。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es ll"><img src="../Images/df081aeeec5c8898cb112e7c664b528e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*99yZKtlHnnMoGmkO"/></div></div></figure><p id="e47b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">图3。管理用户界面</p><p id="2d65" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">插件系统通过利用Python的importlib将Querybook与Pinterest的内部系统集成在一起。有了插件系统，开发者可以配置auth，定制查询引擎，实现内部站点的导出器。插件系统提供的定制行为允许Querybook针对Pinterest的用户工作流进行优化，同时确保开源对公众是通用的。</p><p id="e09c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你可以在<a class="ae jd" href="http://querybook.org/" rel="noopener ugc nofollow" target="_blank">Querybook.org</a>查看更多Querybook的功能和文档，也可以在<a class="ae jd" href="mailto:querybook@pinterest.com" rel="noopener ugc nofollow" target="_blank">querybook@pinterest.com</a>联系我们。</p><p id="893a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc">鸣谢:我们要感谢以下为Querybook做出贡献的工程师:劳伦·米切尔、兰斯顿·泽科、莫哈克·纳赫塔和弗兰克林·肖(Franklin Shiao)。感谢王春燕、戴夫·伯吉斯和大卫·柴肯的重要建议和支持。</em></p></div></div>    
</body>
</html>