<html>
<head>
<title>Crows Nest, The Sauce Connect Manager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">乌鸦巢，酱连接管理器</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/crows-nest-the-sauce-connect-manager-c8489554748b?source=collection_archive---------3-----------------------#2017-04-13">https://medium.com/walmartglobaltech/crows-nest-the-sauce-connect-manager-c8489554748b?source=collection_archive---------3-----------------------#2017-04-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/0d767127612542e4965751e759ad0e09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GxvOLuq7rK2cMJUVaZc57w.jpeg"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">photo credit: <a class="ae hu" href="https://pixabay.com/en/mast-crow-s-nest-sailing-ship-655257/" rel="noopener ugc nofollow" target="_blank">AJEL</a></figcaption></figure><div class=""/><h1 id="d599" class="iu iv hx bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">越过云</h1><p id="69eb" class="pw-post-body-paragraph js jt hx ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">我们喜欢让我们的测试自动化远程运行(例如在云中)。在某些情况下，本地环境对于庞大的测试自动化环境矩阵来说是不够的。想象一下，您的分析团队要求测试涵盖所有这些内容</p><ul class=""><li id="fbac" class="kq kr hx ju b jv ks jz kt kd ku kh kv kl kw kp kx ky kz la bi translated">最新的两个Chrome版本</li><li id="a5d7" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp kx ky kz la bi translated">最新的两个<strong class="ju hy">火狐</strong>版本</li><li id="e664" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp kx ky kz la bi translated">最新<strong class="ju hy">游猎</strong></li><li id="abae" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp kx ky kz la bi translated">最新<strong class="ju hy">网络浏览器</strong></li><li id="6d75" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp kx ky kz la bi translated">最新<strong class="ju hy">微软Edge </strong></li><li id="4715" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp kx ky kz la bi translated"><strong class="ju hy"> Windows 10 </strong></li><li id="c124" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp kx ky kz la bi translated"><strong class="ju hy"> Windows 8 </strong></li><li id="b5d1" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp kx ky kz la bi translated"><strong class="ju hy">马科斯塞拉</strong></li></ul><p id="60d4" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated">考虑到维护成本，你真的想自己一个人做这些吗？</p><p id="0fc9" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated">自动化测试环境云提供商，比如<a class="ae hu" href="https://saucelabs.com/company" rel="noopener ugc nofollow" target="_blank"> Saucelabs </a>，让你可以访问所有这些环境。通过将我们的测试指向他们的即插即用环境，我们可以抛开这些顾虑，享受咖啡，等待结果。</p><h1 id="e856" class="iu iv hx bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">渗透</h1><p id="f6d1" class="pw-post-body-paragraph js jt hx ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">受到防火墙的保护，内部网络不应该被公司外部看到。但是这是否意味着运行在云上的测试看不到运行在内部网络中的服务器呢？不，一点也不。自动化测试环境云提供商已经想到了。例如，Saucelabs提供了一个名为<a class="ae hu" href="https://wiki.saucelabs.com/display/DOCS/Sauce+Connect+Proxy" rel="noopener ugc nofollow" target="_blank"> <strong class="ju hy"> Sauce Connect </strong> </a>的代理来允许测试穿透防火墙。</p><p id="61b7" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated">拥有对我们内部网络进行远程测试访问的方法是最重要的。这意味着您可以将云视为您的本地。我们在Walmartlabs中的所有Github pull请求验证任务都基于Sauce Connect。当一个开发人员将他的变更公关到git repo中时，Jenkins会</p><ol class=""><li id="7ccf" class="kq kr hx ju b jv ks jz kt kd ku kh kv kl kw kp lj ky kz la bi translated">获取PR，构建本地env并做一些初步检查</li><li id="782e" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp lj ky kz la bi translated">在Jenkins节点上打开Sauce Connect</li><li id="26dd" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp lj ky kz la bi translated">通过Saucelabs云触发测试</li><li id="89d8" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp lj ky kz la bi translated">关闭酱连接</li></ol><p id="7b40" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated">我们所有的PR验证都是模拟和独立的，这意味着测试中的服务器/系统将在内部网络中的Jenkins节点上运行，并且在测试期间不会从Jenkins节点发出外部请求。如果没有像Sauce Connect这样的代理技术，我们将无法在云上运行它们。</p><h1 id="2f0a" class="iu iv hx bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">安全渗透</h1><p id="d4fc" class="pw-post-body-paragraph js jt hx ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">代理非常有用，但另一方面，让第三方完全访问我们的内部网络安全吗？你已经知道答案了。我们必须限制外部接触可控的东西。</p><h2 id="7ff9" class="lk iv hx bd iw ll lm ln ja lo lp lq je kd lr ls ji kh lt lu jm kl lv lw jq lx bi translated">非军事区</h2><p id="0a29" class="pw-post-body-paragraph js jt hx ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">通过与我们的信息安全和网络工程部门合作，我们创建了一个DMZ(非军事区)网络。所有从Saucelabs到我们内部网络的请求都必须通过这个DMZ网络。更严格地说，我们只允许DMZ网络通过给定范围的端口访问内部Jenkins节点。</p><p id="6df1" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated">整个设置意味着我们必须在DMZ网络中设置Sauce Connect。</p><h2 id="345c" class="lk iv hx bd iw ll lm ln ja lo lp lq je kd lr ls ji kh lt lu jm kl lv lw jq lx bi translated">酱连接池</h2><p id="2edb" class="pw-post-body-paragraph js jt hx ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">我们没有在Jenkins测试运行时启动新的Sauce Connect，而是创建了一个Sauce Connect池，当测试开始时，许多Sauce Connect都准备好了。</p><p id="c233" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated">这个游泳池既是好消息也是坏消息。好消息是，Sauce Connect原生支持池模式(称为<a class="ae hu" href="https://wiki.saucelabs.com/display/DOCS/High+Availability+Sauce+Connect+Proxy+Setup" rel="noopener ugc nofollow" target="_blank">高可用模式</a>)。坏消息是，在其高可用性模式中存在一些已知问题，例如</p><ol class=""><li id="6afc" class="kq kr hx ju b jv ks jz kt kd ku kh kv kl kw kp lj ky kz la bi translated">运行的时间越长，Sauce Connect的性能就越低。</li><li id="a209" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp lj ky kz la bi translated">没有办法让一个死了的连接自己复活。当它死了，它就死了。</li></ol><p id="97c3" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated">它的维护也需要繁琐的手动操作(我们不喜欢任何手动操作)。我们希望自动监控这个池<strong class="ju hy"/>，以防池中的一个或多个Sauce连接失效，并且由于性能下降，它还应该定期重启池中的所有Sauce连接。</p><h2 id="51b4" class="lk iv hx bd iw ll lm ln ja lo lp lq je kd lr ls ji kh lt lu jm kl lv lw jq lx bi translated">乌鸦巢</h2><p id="56f0" class="pw-post-body-paragraph js jt hx ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">为了解决所有这些问题，我们创造了<a class="ae hu" href="https://github.com/TestArmada/crows-nest" rel="noopener ugc nofollow" target="_blank">乌鸦巢</a>。Crows-Nest监控所有的Sauce连接池(是的，出于性能原因，我们实际上运行两个池)。乌鸦巢做以下事情</p><ol class=""><li id="6ea1" class="kq kr hx ju b jv ks jz kt kd ku kh kv kl kw kp lj ky kz la bi translated">检查每个Sauce连接的可用性</li><li id="9cfe" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp lj ky kz la bi translated">推出新的酱连接，以取代死亡的</li><li id="5b91" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp lj ky kz la bi translated">定期向statsd报告Sauce连接的运行状况和状态</li></ol><p id="fe8f" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated">设计和实现的细节可以在它的<a class="ae hu" href="https://github.com/TestArmada/crows-nest/blob/master/README.md#design" rel="noopener ugc nofollow" target="_blank">自述文件</a>中找到。为了您的方便，乌鸦巢甚至是码头。</p><p id="df98" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated">建立一个乌鸦巢很容易。它既可以作为独立的进程运行，也可以作为带有<a class="ae hu" href="https://github.com/Unitech/pm2" rel="noopener ugc nofollow" target="_blank"> pm2 </a>的守护进程运行。</p><p id="b3bf" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated">由于Crows-Nest将它的状态发送到<a class="ae hu" href="https://github.com/etsy/statsd" rel="noopener ugc nofollow" target="_blank"> statsd </a>，我们可以可视化我们的稳定性，并更好地了解我们的Sauce连接是如何运行的，可视化报告有助于我们更好地了解我们的Sauce连接如何服务于测试。</p><figure class="lz ma mb mc fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es ly"><img src="../Images/57f85939bf0373a6df5112eeddb9bb71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8nDFbWR3_U6UHqH0XrtyZA.jpeg"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">Sauce Connect status from grafana</figcaption></figure><p id="43ed" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated">当您的网络或Saucelabs出现故障时，Sauce Connect可能无法重新启动。如果需要，乌鸦巢最多允许10次重试。</p><p id="4abd" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated">所以我们典型的乌鸦巢场景是</p><ol class=""><li id="200e" class="kq kr hx ju b jv ks jz kt kd ku kh kv kl kw kp lj ky kz la bi translated">一个鸟巢管理和多个酱连接过程</li><li id="6650" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp lj ky kz la bi translated">乌鸦巢将在太平洋时间凌晨3点重新启动所有酱连接</li><li id="8ff4" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp lj ky kz la bi translated">Crows-Nest将向statsd和Grafana报告Sauce连接状态(开始时间、停止时间、重试次数、当前状态)</li><li id="56c6" class="kq kr hx ju b jv lb jz lc kd ld kh le kl lf kp lj ky kz la bi translated">乌鸦巢将保持监测酱连接状态，并重新启动时，它死了</li></ol><p id="ded2" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated">我们在WalmartLabs内部的DMZ网络中运行Crows-Nest作为监管程序。通过Crows-nest，我们已经成功地将Jenkins上的所有测试迁移到DMZ网络中，并受到安全监控。</p><p id="72f6" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated"><strong class="ju hy">乌鸦巢带来的惊喜:测试性能提升</strong></p><p id="08e1" class="pw-post-body-paragraph js jt hx ju b jv ks jx jy jz kt kb kc kd lg kf kg kh lh kj kk kl li kn ko kp ha bi translated">在我们比较使用单个Sauce连接和使用一个Crows-Nest监控的Sauce连接池的测试性能时，我们发现使用Sauce连接池有一个非常有趣的副作用:<strong class="ju hy">测试运行速度大约快10%到15%</strong>。</p><figure class="lz ma mb mc fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es md"><img src="../Images/b40914f4461b3192e4c630aa67dc468a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kgjxw-SvBauSRHEVH1FVjQ.jpeg"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">DMZ vs Non-DMZ test execution</figcaption></figure><h2 id="499c" class="lk iv hx bd iw ll lm ln ja lo lp lq je kd lr ls ji kh lt lu jm kl lv lw jq lx bi translated">下一步是什么</h2><p id="ad9d" class="pw-post-body-paragraph js jt hx ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">乌鸦巢也可以作为酱连接管理器。我们对乌鸦巢的下一个目标是将其集成到<a class="ae hu" href="https://github.com/TestArmada/magellan" rel="noopener ugc nofollow" target="_blank">麦哲伦</a>中作为酱连接管理器，这样我们的用户就可以像我们的詹金斯一样在类似的设置中调试他们的测试。</p><h1 id="4c24" class="iu iv hx bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">拥抱云</h1><p id="8e4b" class="pw-post-body-paragraph js jt hx ju b jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp ha bi translated">在云上运行内部自动化测试的能力让我们的生活变得更加轻松。更好的实用程序/工具有助于使测试运行更加容易和一致。如果你在你的酱油实验室设置中看到类似的问题，我建议你试试乌鸦巢。</p></div></div>    
</body>
</html>