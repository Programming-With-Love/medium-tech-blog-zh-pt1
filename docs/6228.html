<html>
<head>
<title>Managing Videos on Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Android上管理视频</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/managing-videos-on-android-f59da9601d5f?source=collection_archive---------2-----------------------#2019-09-20">https://medium.com/pinterest-engineering/managing-videos-on-android-f59da9601d5f?source=collection_archive---------2-----------------------#2019-09-20</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="c1ee" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Grey Skold | Android视频产品</p><p id="c320" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">视频于2016年在Pinterest Android应用程序上推出，目标是为应用程序带来无缝的视频体验。这包括支持每个屏幕多个视频的能力，同时通过在视频滚动出屏幕时自动暂停视频来动态控制视频的播放状态，或者控制允许同时播放的视频数量。</p><p id="99e9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们很快发现有许多技术难题需要解决，例如:</p><ul class=""><li id="7b8f" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">管理所有当前可用视频的播放状态</li><li id="fffc" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">了解视频在屏幕上的可见性百分比</li><li id="2f5c" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">为我们的开发人员提供易于使用的视频组件</li></ul><p id="1947" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">随着时间的推移，我们逐渐改造了我们的视频架构来满足这些要求，下面我们将深入探讨我们如何在最新的视频模块中应对这些挑战。</p><h1 id="1845" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">视频管理器</h1><p id="c047" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">在高层次上，我们需要构建一个组件，它能够感知所有视频实例(即<strong class="ig hi">视图</strong> s)以及它们在屏幕上可用的相关表面(即<strong class="ig hi">片段</strong> s)。管理表面对于监控生命周期状态(即<strong class="ig hi"> onStart() </strong>等)至关重要。)将应用于surface的子元素，并避免在消费者层添加过多的代码来将最新的状态更改应用于视图<strong class="ig hi">s。</strong></p><p id="52e6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了跟踪这些关键的生命周期事件，Android框架为我们提供了屏幕上显示的内容的当前状态，以及任何视觉上影响我们应用程序的变化。我们监听的关键生命周期事件是UI附件调用(例如<strong class="ig hi"> onAttachedToWindow() </strong>)以及我们的主机屏幕何时改变其显示状态(例如<strong class="ig hi"> onPause() </strong>等)。).</p><p id="4860" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过这些回调方法，我们尝试注册任何提供了有效视频URL的视频。这将为我们提供当前界面中可用视频的初始列表。</p><p id="9441" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们的视频框架的第一次迭代中，我们依赖于客户端代码调用这些调用本身，但是我们发现这是不可扩展的，因为它在构建视频功能时增加了更多的复杂性。相反，我们通过构建需要传入底层视频组件的方法，抽象出了在<strong class="ig hi"> VideoManager </strong>后面注册视频的回调。从那里，<strong class="ig hi">视频管理器</strong>将在幕后进行适当的计算。这使得消费者不再需要预先了解视频注册流程，因为它现在只是“开箱即用”。</p><p id="1bbf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">在</strong>之前</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="c221" class="lc jr hh ky b fi ld le l lf lg">// FooBarFragment.class for FooBar feature</span><span id="a63e" class="lc jr hh ky b fi lh le l lf lg">override fun onResume() {</span><span id="3501" class="lc jr hh ky b fi lh le l lf lg">     super.onResume()</span><span id="7a19" class="lc jr hh ky b fi lh le l lf lg">     // Required by consumers to implement</span><span id="9317" class="lc jr hh ky b fi lh le l lf lg">     videoView?.<em class="li">apply </em><strong class="ky hi">{</strong></span><span id="c6e4" class="lc jr hh ky b fi lh le l lf lg">          viewability = Viewability.FullyVisible</span><span id="32a7" class="lc jr hh ky b fi lh le l lf lg">          onActivate()</span><span id="5483" class="lc jr hh ky b fi lh le l lf lg">          onViewCompletelyVisible()</span><span id="9d1c" class="lc jr hh ky b fi lh le l lf lg"><strong class="ky hi">     }</strong></span><span id="4d5e" class="lc jr hh ky b fi lh le l lf lg">}</span><span id="d27c" class="lc jr hh ky b fi lh le l lf lg">override fun onPause() {</span><span id="8d05" class="lc jr hh ky b fi lh le l lf lg">     // Required by consumers to implement</span><span id="abda" class="lc jr hh ky b fi lh le l lf lg">     videoView?.<em class="li">apply </em><strong class="ky hi">{</strong></span><span id="e546" class="lc jr hh ky b fi lh le l lf lg">          viewability = Viewability.NotVisible</span><span id="d81c" class="lc jr hh ky b fi lh le l lf lg">          onDeactivate()</span><span id="791a" class="lc jr hh ky b fi lh le l lf lg"><strong class="ky hi">     }</strong></span><span id="42d2" class="lc jr hh ky b fi lh le l lf lg">     super.onPause()</span><span id="5331" class="lc jr hh ky b fi lh le l lf lg">}</span></pre><p id="7966" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">后<strong class="ig hi"/></p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="083f" class="lc jr hh ky b fi ld le l lf lg">// BaseFragment.class implemented by all screens</span><span id="ebb8" class="lc jr hh ky b fi lh le l lf lg">override fun onResume() {</span><span id="2db5" class="lc jr hh ky b fi lh le l lf lg">     super.onResume()</span><span id="3671" class="lc jr hh ky b fi lh le l lf lg">     videoManager.onResume(this)</span><span id="6bbb" class="lc jr hh ky b fi lh le l lf lg">}</span><span id="3500" class="lc jr hh ky b fi lh le l lf lg">override fun onPause() {</span><span id="8744" class="lc jr hh ky b fi lh le l lf lg">     videoManager.onPause(this)</span><span id="53b0" class="lc jr hh ky b fi lh le l lf lg">     super.onPause()</span><span id="4b95" class="lc jr hh ky b fi lh le l lf lg">}</span><span id="2a6e" class="lc jr hh ky b fi lh le l lf lg">// VideoManager.class internally</span><span id="fe6e" class="lc jr hh ky b fi lh le l lf lg">override fun onResume(videoSurface: VideoViewSurface) {</span><span id="546a" class="lc jr hh ky b fi lh le l lf lg">     videoSurface.videoViews.<em class="li">forEach </em><strong class="ky hi">{</strong></span><span id="af59" class="lc jr hh ky b fi lh le l lf lg">          registerVideo(<strong class="ky hi">it</strong>)</span><span id="e0ad" class="lc jr hh ky b fi lh le l lf lg"><strong class="ky hi">     }</strong></span><span id="ffe1" class="lc jr hh ky b fi lh le l lf lg">}</span><span id="30f1" class="lc jr hh ky b fi lh le l lf lg">override fun onPause(videoSurface: VideoViewSurface) {</span><span id="581a" class="lc jr hh ky b fi lh le l lf lg">     videoSurface.videoViews.<em class="li">forEach </em><strong class="ky hi">{</strong></span><span id="f13b" class="lc jr hh ky b fi lh le l lf lg">          unregisterVideo(<strong class="ky hi">it</strong>)</span><span id="2cb3" class="lc jr hh ky b fi lh le l lf lg"><strong class="ky hi">     }</strong></span><span id="b1d1" class="lc jr hh ky b fi lh le l lf lg">}</span></pre><p id="9cd7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">保持这个视频列表让我们能够根据应用程序的当前可见性动态设置播放状态。这也提供了根据视频注册时传入的某些元数据属性动态更改其他功能的灵活性。</p><p id="c4c6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">例如，我们可能希望自动播放所有视频广告，但仅限于在同一表面上自动播放一个有机视频(即创作者生成的内容)。通过检查单个视频上注册的元数据，我们可以将这些限制应用到UI层。</p><p id="9aa8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们还抽象出了所有Pinterest特定的分析代码，以保持视频管理器(管理和播放视频)的清晰焦点，并保持组件与应用程序无关。</p><h1 id="fb3a" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">计算可视性</h1><p id="aaa6" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated"><strong class="ig hi">可见性</strong>被定义为在屏幕上显示的UI组件的可见区域的百分比。这个度量对于我们理解当前显示给用户的是什么至关重要。有了这些信息，我们就能够为我们的合作伙伴收集有关其内容参与度的信息。</p><p id="52f5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在一般情况下，由于<strong class="ig hi">视频管理器</strong>保存了对所有活动视频的引用，我们可以跟踪我们视图的准确坐标(即<strong class="ig hi">getLocationInWindow()</strong>)<em class="li"/>和我们设备的屏幕大小(以像素为单位)(参见<strong class="ig hi"> DisplayMetrics </strong>)来推断它们在屏幕上的<strong class="ig hi">可视性</strong>。</p><p id="d0fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们还通过以下方式处理重叠的用户界面:</p><ul class=""><li id="92a0" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">为消费者提供选项，包括一个“障碍”视图列表<strong class="ig hi">视图</strong>，这些视图可能会覆盖我们的底层视频(例如，工具栏、浮动按钮等)。)</li><li id="9d89" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">正在显示的弹出窗口的回调(即<strong class="ig hi"> onWindowFocusChanged() </strong>)</li><li id="fd3c" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">用于屏幕滚动的组件或脱离屏幕的UI组件(参见<em class="li"> RecyclerView </em> listeners)</li><li id="269e" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">当视频表面显示在屏幕上时的附加回调(即<strong class="ig hi"> onResume() </strong>等)。).</li></ul><h1 id="6094" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">为开发商而建</h1><p id="1b10" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">虽然我们希望减少开发人员面临的视频管理复杂性，但最大的困惑是实现新的视频界面。因此，我们既抽象了视频设置的复杂性，又利用了Google player view提供的UI组件:</p><p id="8803" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">在</strong>之前</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="86cc" class="lc jr hh ky b fi ld le l lf lg">// FooBar video feature, requires custom FooBarVideoView.class of 100+ lines</span><span id="db97" class="lc jr hh ky b fi lh le l lf lg">object : FooBarVideoView(</span><span id="530f" class="lc jr hh ky b fi lh le l lf lg"><em class="li">     context</em>,     // application context</span><span id="ba27" class="lc jr hh ky b fi lh le l lf lg">     analytics,   // Analytics object</span><span id="a1ef" class="lc jr hh ky b fi lh le l lf lg">     url,         // video url</span><span id="9309" class="lc jr hh ky b fi lh le l lf lg">     uid,         // unique ID</span><span id="6d94" class="lc jr hh ky b fi lh le l lf lg">     false        // isAd flag</span><span id="9635" class="lc jr hh ky b fi lh le l lf lg">) {</span><span id="ecbe" class="lc jr hh ky b fi lh le l lf lg">     // configuration flag for custom setup (mute, autoplay, controller, etc.)</span><span id="566c" class="lc jr hh ky b fi lh le l lf lg">     override val videoConfiguration = VideoConfiguration.FOO_BAR</span><span id="f199" class="lc jr hh ky b fi lh le l lf lg">}.<em class="li">apply </em><strong class="ky hi">{</strong></span><span id="0bce" class="lc jr hh ky b fi lh le l lf lg">     shouldLoop = true</span><span id="3a22" class="lc jr hh ky b fi lh le l lf lg">     videoAspectRatio = aspectRatio</span><span id="0187" class="lc jr hh ky b fi lh le l lf lg">     render(videoMetaData) // loads video, videoMetaData contains: url, isAd, uid</span><span id="1228" class="lc jr hh ky b fi lh le l lf lg"><strong class="ky hi">}</strong></span></pre><p id="435e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">在</strong>之后</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="0e3e" class="lc jr hh ky b fi ld le l lf lg">// Foobar video feature, no custom class required just set flags</span><span id="64b5" class="lc jr hh ky b fi lh le l lf lg">PinterestVideoView(context).apply {</span><span id="fc24" class="lc jr hh ky b fi lh le l lf lg">     // Optional params for setup/customization</span><span id="ca55" class="lc jr hh ky b fi lh le l lf lg"><strong class="ky hi">     this</strong>.analytics = pinterestAnalytics</span><span id="0424" class="lc jr hh ky b fi lh le l lf lg"><strong class="ky hi">     this.</strong>mute = false</span><span id="6fdd" class="lc jr hh ky b fi lh le l lf lg"><strong class="ky hi">     this.</strong>autoPlay = true</span><span id="530d" class="lc jr hh ky b fi lh le l lf lg"><strong class="ky hi">     this.</strong>alwaysAutoplay = true</span><span id="9de6" class="lc jr hh ky b fi lh le l lf lg"><strong class="ky hi">     this.</strong>alwaysPlay = true</span><span id="b7e1" class="lc jr hh ky b fi lh le l lf lg"><strong class="ky hi">     this.</strong>showMute = true</span><span id="2139" class="lc jr hh ky b fi lh le l lf lg"><strong class="ky hi">     this.</strong>looping = true</span><span id="8a4f" class="lc jr hh ky b fi lh le l lf lg"><strong class="ky hi">     this.</strong>bufferingRule = <em class="li">SHOW_BUFFERING_ALWAYS</em></span><span id="e34e" class="lc jr hh ky b fi lh le l lf lg">}.apply {</span><span id="7e0a" class="lc jr hh ky b fi lh le l lf lg">     render(videoMetaData) // loads video, videoMetaData contains: url, isAd, uid</span><span id="1be4" class="lc jr hh ky b fi lh le l lf lg">}</span></pre><p id="cbd9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">视频基础设施的另一个复杂性是实际的视频管理器架构本身。在我们的重写中，我们整合了大部分旧组件，只保留了支持正常运行所需的基本组件</p><p id="db87" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">在</strong>之前</p><figure class="kt ku kv kw fd lk er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lj"><img src="../Images/1e99a6012524c50d426063cd695ccd24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bD_qaUMSV7s5vJVl"/></div></div></figure><p id="dbad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">在</strong>之后</p><figure class="kt ku kv kw fd lk er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lj"><img src="../Images/5a158468264c03ea90fbd7bff0578c22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lQNRFfuqCE7zh2me"/></div></div></figure><p id="92cb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们新的<strong class="ig hi"> VideoManager </strong>架构为事件和组件之间的关系提供了清晰的层次结构。这不仅在纸面上看起来不错，而且仅重构一项就删除了大约4500行代码(不到原始实现的1/3)。</p><h1 id="a02a" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">在夕阳下玩耍…</h1><p id="fe70" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">构建适当的“视频管理”是一个漫长而艰巨的过程，但多年来，我们已经建立了一些真正进化的东西，以帮助简化我们的开发过程和Pinner体验。在未来，我们希望开源我们的工作，以便其他开发人员可以为处理动态视频回放的持续努力做出贡献。我们将继续迭代我们的视频客户端架构，应对新的挑战，目标是为Pinners和开发者打造愉快的视频体验。</p><blockquote class="lr"><p id="6927" class="ls lt hh bd lu lv lw lx ly lz ma jb dx translated">我们正在建造世界上第一个视觉发现引擎。全世界有超过2.5亿人使用Pinterest来梦想、计划和准备他们在生活中想做的事情。<a class="ae mb" href="https://careers.pinterest.com/careers" rel="noopener ugc nofollow" target="_blank">来加入我们吧！</a></p></blockquote></div></div>    
</body>
</html>