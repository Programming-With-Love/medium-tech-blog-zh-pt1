<html>
<head>
<title>Understanding Audio Focus (Part 3 / 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解音频焦点(第3 / 3部分)</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/audio-focus-3-cdc09da9c122?source=collection_archive---------1-----------------------#2017-10-05">https://medium.com/androiddevelopers/audio-focus-3-cdc09da9c122?source=collection_archive---------1-----------------------#2017-10-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/0c4ab1766a0f092e461a5dbfaab4b12e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2_mUAwAihjBYMszQCCL0Mw.png"/></div></div></figure><div class=""/><div class=""><h2 id="6257" class="pw-subtitle-paragraph ip hr hs bd b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg dx translated">在应用中实现音频聚焦的3个步骤</h2></div><p id="dacb" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">这一系列文章的目标是让您深入了解什么是音频聚焦，为什么提供一个好的媒体UX很重要，以及如何使用它。这是该系列的最后一部分，包括:</p><ol class=""><li id="5d0f" class="kd ke hs jj b jk jl jn jo jq kf ju kg jy kh kc ki kj kk kl bi translated"><a class="ae km" rel="noopener" href="/@nazmul/audio-focus-1-6b32689e4380">成为优秀媒体公民的重要性和最常见的音频焦点使用案例</a></li><li id="84a6" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc ki kj kk kl bi translated"><a class="ae km" rel="noopener" href="/@nazmul/audio-focus-2-42244043863a">音频聚焦对您的媒体应用的UX很重要的其他使用案例</a></li><li id="fa12" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc ki kj kk kl bi translated">在你的应用中实现音频聚焦的三个步骤(<strong class="jj ht"> <em class="ks">本文</em> </strong>)</li></ol><p id="9fc0" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">如果您没有正确处理音频焦点，下图描述了您的用户在电话上可能遇到的情况。</p><figure class="ku kv kw kx fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es kt"><img src="../Images/db8cafbca8f501aeb150af57cee80626.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*53tFOWaJmR_hrJq8QL0DHg.png"/></div></div></figure><p id="3312" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">现在你知道了你的应用成为一个好的媒体公民对于用户在他们的手机上有一个好的媒体体验的重要性，让我们来看看让你的应用正确处理音频焦点的步骤。</p><p id="a1fe" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">在进入代码之前，下图总结了我们在应用程序中实现音频聚焦的步骤。</p><figure class="ku kv kw kx fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es kt"><img src="../Images/71b915550c5cb6ff7a4bfab7d2f51870.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KdcNZbndhRg5ne18kquBKA.png"/></div></div></figure><h1 id="bf3f" class="ky kz hs bd la lb lc ld le lf lg lh li iy lj iz lk jb ll jc lm je ln jf lo lp bi translated">步骤1:提出焦点请求</h1><p id="2052" class="pw-post-body-paragraph jh ji hs jj b jk lq it jm jn lr iw jp jq ls js jt ju lt jw jx jy lu ka kb kc ha bi translated">获得音频焦点的第一步是请求Android系统获取它。请记住，仅仅因为你提出了请求并不意味着它会被批准。为了请求获取音频焦点，您必须向系统声明您的“意图”。这里有一些例子。</p><ul class=""><li id="8342" class="kd ke hs jj b jk jl jn jo jq kf ju kg jy kh kc lv kj kk kl bi translated">你的应用程序是媒体播放器还是播客播放器，可以无限期地保持音频焦点(只要用户选择播放你的应用程序中的音频)？这是<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioManager.html#AUDIOFOCUS_GAIN" rel="noopener ugc nofollow" target="_blank">AUDIOFOCUS_GAIN</a></code>。</li><li id="74e5" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc lv kj kk kl bi translated">或者，你的应用程序暂时需要音频焦点(带有闪避选项)，因为它需要播放音频通知，或语音提示，或者它需要在短时间内记录用户的音频？这是<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioManager.html#AUDIOFOCUS_GAIN_TRANSIENT_MAY_DUCK" rel="noopener ugc nofollow" target="_blank">AUDIOFOCUS_GAIN_TRANSIENT_MAY_DUCK</a></code>。</li><li id="ab77" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc lv kj kk kl bi translated">当电话接通时，你的应用程序会像电话应用程序一样暂时需要音频聚焦(但持续时间未知，没有躲避选项)吗？这是<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioManager.html#AUDIOFOCUS_GAIN_TRANSIENT" rel="noopener ugc nofollow" target="_blank">AUDIOFOCUS_GAIN_TRANSIENT</a></code>。</li><li id="b14e" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc lv kj kk kl bi translated">你的应用程序是否暂时需要音频聚焦(持续时间未知，在此期间不应产生其他声音)，因为它需要像语音备忘录应用程序一样记录音频？这是<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioManager.html#AUDIOFOCUS_GAIN_TRANSIENT_EXCLUSIVE" rel="noopener ugc nofollow" target="_blank">AUDIOFOCUS_GAIN_TRANSIENT_EXCLUSIVE</a></code>。</li></ul><p id="b6ad" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">在Android O和更高版本上，你必须创建一个<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioFocusRequest.html" rel="noopener ugc nofollow" target="_blank">AudioFocusRequest</a></code>对象(使用一个<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioFocusRequest.Builder.html" rel="noopener ugc nofollow" target="_blank">builder</a></code>)。在这个对象中，你必须指定你的应用程序需要多长时间来获得音频焦点。下面的代码片段声明了从系统永久获取音频焦点的意图。</p><pre class="ku kv kw kx fd ma lz mb mc aw md bi"><span id="636f" class="me kz hs lz b fi mf mg l mh mi">AudioManager mAudioManager = (AudioManager) mContext.getSystemService(Context.AUDIO_SERVICE);</span><span id="f63d" class="me kz hs lz b fi mj mg l mh mi">AudioAttributes mAudioAttributes =<br/>       new AudioAttributes.Builder()<br/>               .setUsage(AudioAttributes.USAGE_MEDIA)<br/>               .setContentType(AudioAttributes.CONTENT_TYPE_MUSIC)<br/>               .build();</span><span id="ec90" class="me kz hs lz b fi mj mg l mh mi">AudioFocusRequest mAudioFocusRequest =<br/>       new AudioFocusRequest.Builder(AudioManager.AUDIOFOCUS_GAIN)<br/>               .setAudioAttributes(mAudioAttributes)<br/>               .setAcceptsDelayedFocusGain(true)<br/>               .setOnAudioFocusChangeListener(...) // Need to implement listener<br/>               .build();</span><span id="4fe4" class="me kz hs lz b fi mj mg l mh mi">int focusRequest = mAudioManager.requestAudioFocus(mAudioFocusRequest);</span><span id="e58f" class="me kz hs lz b fi mj mg l mh mi">switch (focusRequest) {<br/>   case AudioManager.AUDIOFOCUS_REQUEST_FAILED:<br/>       // don’t start playback<br/>   case AudioManager.AUDIOFOCUS_REQUEST_GRANTED:<br/>       // actually start playback<br/>}</span></pre><p id="8e44" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">《守则》说明:</p><ol class=""><li id="e8a5" class="kd ke hs jj b jk jl jn jo jq kf ju kg jy kh kc ki kj kk kl bi translated"><code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioManager.html#AUDIOFOCUS_GAIN" rel="noopener ugc nofollow" target="_blank">AudioManager.AUDIOFOCUS_GAIN</a></code>是向系统请求永久音频焦点。你也可以给它传递其他的int值，比如<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioManager.html#AUDIOFOCUS_GAIN_TRANSIENT" rel="noopener ugc nofollow" target="_blank">AUDIOFOCUS_GAIN_TRANSIENT</a></code>，或者<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioManager.html#AUDIOFOCUS_GAIN_TRANSIENT_MAY_DUCK" rel="noopener ugc nofollow" target="_blank">AUDIOFOCUS_GAIN_TRANSIENT_MAY_DUCK</a></code>，如果你只是想要暂时的音频焦点。</li><li id="3f8a" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc ki kj kk kl bi translated">您必须将一个<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioManager.OnAudioFocusChangeListener.html" rel="noopener ugc nofollow" target="_blank">AudioManager.OnAudioFocusChangeListener</a></code>实现传递给<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioFocusRequest.Builder.html#setOnAudioFocusChangeListener(android.media.AudioManager.OnAudioFocusChangeListener)" rel="noopener ugc nofollow" target="_blank">setOnAudioFocusChangeListener()</a></code>方法。这部分代码将处理音频焦点的变化，这些变化是由系统中发生的事件驱动的。这些可能从其他应用程序中的用户交互开始。例如，你的应用程序可能已经获得了永久的音频焦点，但是用户启动了另一个应用程序，就把它拿走了。这个侦听器是你的应用程序必须处理这种焦点丢失的地方。</li><li id="6a59" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc ki kj kk kl bi translated">一旦你创建了<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioFocusRequest.html" rel="noopener ugc nofollow" target="_blank">AudioFocusRequest</a></code>对象，你现在可以使用它通过调用<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioManager.html#requestAudioFocus(android.media.AudioFocusRequest)" rel="noopener ugc nofollow" target="_blank">requestAudioFocus(…)</a></code>来请求<code class="du lw lx ly lz b">AudioManager</code>获得音频焦点。这将返回一个整数值，表示您的音频焦点请求是否被批准。只有当该值为<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioManager.html#AUDIOFOCUS_REQUEST_GRANTED" rel="noopener ugc nofollow" target="_blank">AUDIOFOCUS_REQUEST_GRANTED</a></code>时，您才应该立即开始回放。如果是<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioManager.html#AUDIOFOCUS_REQUEST_FAILED" rel="noopener ugc nofollow" target="_blank">AUDIOFOCUS_REQUEST_FAILED</a></code>，那么系统已经拒绝你的应用程序在那一刻获得音频焦点。</li></ol><p id="0e0d" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">在Android N和更早的版本中，你可以声明这个意图，而不需要使用如下所示的<code class="du lw lx ly lz b">AudioFocusRequest</code>对象。你还是要实现<code class="du lw lx ly lz b">AudioManager.OnAudioFocusChangeListener</code>。下面是上面代码片段的等效代码。</p><pre class="ku kv kw kx fd ma lz mb mc aw md bi"><span id="47cf" class="me kz hs lz b fi mf mg l mh mi">AudioManager mAudioManager = (AudioManager) mContext.getSystemService(Context.AUDIO_SERVICE);</span><span id="4437" class="me kz hs lz b fi mj mg l mh mi">int focusRequest = mAudioManager.requestAudioFocus(</span><span id="d54c" class="me kz hs lz b fi mj mg l mh mi">..., // Need to implement listener<br/>       AudioManager.STREAM_MUSIC,<br/>       AudioManager.AUDIOFOCUS_GAIN);</span><span id="5577" class="me kz hs lz b fi mj mg l mh mi">switch (focusRequest) {<br/>   case AudioManager.AUDIOFOCUS_REQUEST_FAILED:<br/>       // don't start playback<br/>   case AudioManager.AUDIOFOCUS_REQUEST_GRANTED:<br/>       // actually start playback<br/>}</span></pre><p id="24f4" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">接下来，我们必须实现<code class="du lw lx ly lz b">AudioManager.OnAudioFocusChangeListener</code>，以便应用程序可以对音频焦点增益和损失的变化做出反应。</p><h1 id="0d04" class="ky kz hs bd la lb lc ld le lf lg lh li iy lj iz lk jb ll jc lm je ln jf lo lp bi translated">步骤2:响应音频焦点状态变化</h1><p id="f399" class="pw-post-body-paragraph jh ji hs jj b jk lq it jm jn lr iw jp jq ls js jt ju lt jw jx jy lu ka kb kc ha bi translated">一旦你的应用程序获得音频焦点(无论是暂时的还是永久的)，它可以随时改变。你的应用程序必须对这种变化做出反应。这就是在您的<code class="du lw lx ly lz b">OnAudioFocusChangeListener</code>实现中发生的事情。</p><p id="d568" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">以下代码片段包含播放音频的应用程序的此接口的实现。并且它处理暂时音频焦点丢失的回避。它还处理由于用户暂停播放而导致的音频焦点变化，而另一个应用程序(<a class="ae km" href="https://developer.android.com/guide/topics/media-apps/interacting-with-assistant.html" rel="noopener ugc nofollow" target="_blank">如谷歌助手</a>)会导致短暂的音频焦点丢失。</p><pre class="ku kv kw kx fd ma lz mb mc aw md bi"><span id="a1c6" class="me kz hs lz b fi mf mg l mh mi">private final class AudioFocusHelper<br/>        implements AudioManager.OnAudioFocusChangeListener {</span><span id="af10" class="me kz hs lz b fi mj mg l mh mi">private void abandonAudioFocus() {<br/>        mAudioManager.abandonAudioFocus(this);<br/>    }</span><span id="d310" class="me kz hs lz b fi mj mg l mh mi"><a class="ae km" href="http://twitter.com/Override" rel="noopener ugc nofollow" target="_blank">@Override</a><br/>    public void onAudioFocusChange(int focusChange) {<br/>        switch (focusChange) {<br/>            case AudioManager.AUDIOFOCUS_GAIN:<br/>                if (mPlayOnAudioFocus &amp;&amp; !isPlaying()) {<br/>                    play();<br/>                } else if (isPlaying()) {<br/>                    setVolume(MEDIA_VOLUME_DEFAULT);<br/>                }<br/>                mPlayOnAudioFocus = false;<br/>                break;<br/>            case AudioManager.AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK:<br/>                setVolume(MEDIA_VOLUME_DUCK);<br/>                break;<br/>            case AudioManager.AUDIOFOCUS_LOSS_TRANSIENT:<br/>                if (isPlaying()) {<br/>                    mPlayOnAudioFocus = true;<br/>                    pause();<br/>                }<br/>                break;<br/>            case AudioManager.AUDIOFOCUS_LOSS:<br/>                mAudioManager.abandonAudioFocus(this);<br/>                mPlayOnAudioFocus = false;<br/>                stop();<br/>                break;<br/>        }<br/>    }<br/>}</span></pre><p id="c2f2" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">当用户开始暂停播放时，应用程序的行为应该与另一个应用程序请求瞬时音频焦点并因此暂停播放时不同(而不是只是闪避)。当用户开始暂停播放时，你的应用程序应该放弃音频焦点。但是，如果您的应用程序暂停播放以响应音频焦点的短暂丢失，那么它不应该放弃音频焦点。这里有一些用例来说明这一点。</p><p id="1d7c" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">假设您有一个音频播放应用程序，可以在后台播放音频。</p><ol class=""><li id="dd25" class="kd ke hs jj b jk jl jn jo jq kf ju kg jy kh kc ki kj kk kl bi translated">当用户按下play时，你的应用程序会请求永久的音频焦点。假设它被系统授予了音频焦点。</li><li id="521c" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc ki kj kk kl bi translated">现在，他们长按home键，启动谷歌助手。助手将请求获得瞬时音频焦点。</li><li id="a8cc" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc ki kj kk kl bi translated">一旦系统将此授权给助手，您的<code class="du lw lx ly lz b">OnAudioFocusChangeListener</code>将获得一个<code class="du lw lx ly lz b">AUDIOFOCUS_LOSS_TRANSIENT</code>事件。在这里，您可以暂停回放，因为助手需要录制音频。</li><li id="abc3" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc ki kj kk kl bi translated">一旦助手完成，它将放弃其音频焦点，你的应用程序将在<code class="du lw lx ly lz b">OnAudioFocusChangeListener</code>中被授予<code class="du lw lx ly lz b">AUDIOFOCUS_GAIN</code>。这是你必须决定是否继续播放的地方。这就是上面代码片段中的<code class="du lw lx ly lz b">mPlayOnAudioFocus</code>标志的作用。</li></ol><p id="6971" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">下面的代码片段是用户启动的暂停方法在这个音频播放器应用程序中的样子。</p><pre class="ku kv kw kx fd ma lz mb mc aw md bi"><span id="adac" class="me kz hs lz b fi mf mg l mh mi">public final void pause() {<br/>   if (!mPlayOnAudioFocus) {<br/>       mAudioFocusHelper.abandonAudioFocus();<br/>   }<br/>  onPause();<br/>}</span></pre><p id="c98c" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">正如你所看到的，当用户开始暂停播放时，它会放弃音频焦点，但当其他应用程序导致它发生时(当它们获得<code class="du lw lx ly lz b">AUDIOFOCUS_GAIN_TRANSIENT</code>)不会。</p><h2 id="4c82" class="me kz hs bd la mk ml mm le mn mo mp li jq mq mr lk ju ms mt lm jy mu mv lo mw bi translated">暂时音频焦点丢失时闪避与暂停</h2><p id="9170" class="pw-post-body-paragraph jh ji hs jj b jk lq it jm jn lr iw jp jq ls js jt ju lt jw jx jy lu ka kb kc ha bi translated">您可以在<code class="du lw lx ly lz b">OnAudioFocusChangeListener</code>中选择暂停播放或暂时降低音频播放的音量，这取决于您的应用需要提供什么样的UX。Android O支持自动闪避，系统会自动降低你的应用程序的音量，而你不必编写任何额外的代码。在你的<code class="du lw lx ly lz b">OnAudioFocusChangeListener</code>中，忽略<code class="du lw lx ly lz b">AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK</code>事件即可。</p><p id="8a11" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">在Android N和更早的版本中，你必须自己实现闪避(如上面的代码片段所示)。</p><h2 id="1d8b" class="me kz hs bd la mk ml mm le mn mo mp li jq mq mr lk ju ms mt lm jy mu mv lo mw bi translated">延迟增益</h2><p id="93d8" class="pw-post-body-paragraph jh ji hs jj b jk lq it jm jn lr iw jp jq ls js jt ju lt jw jx jy lu ka kb kc ha bi translated">Android O引入了延迟音频焦点增益的概念。为了实现这一点，当您请求音频焦点时，您可以得到一个<code class="du lw lx ly lz b">AUDIOFOCUS_REQUEST_DELAYED</code>结果，如下所示。</p><pre class="ku kv kw kx fd ma lz mb mc aw md bi"><span id="d348" class="me kz hs lz b fi mf mg l mh mi">public void requestPlayback() {<br/>    int audioFocus = mAudioManager.requestAudioFocus(mAudioFocusRequest);<br/>    switch (audioFocus) {<br/>        case AudioManager.AUDIOFOCUS_REQUEST_FAILED:<br/>            ...<br/>        case AudioManager.AUDIOFOCUS_REQUEST_GRANTED:<br/>            ...<br/>        case AudioManager.AUDIOFOCUS_REQUEST_DELAYED:<br/>            mAudioFocusPlaybackDelayed = true;<br/>    }<br/>}</span></pre><p id="e9b6" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">在您的<code class="du lw lx ly lz b">OnAudioFocusChangeListener</code>实现中，当您响应<code class="du lw lx ly lz b">AUDIOFOCUS_GAIN</code>时，您必须检查<code class="du lw lx ly lz b">mAudioFocusPlaybackDelayed</code>变量，如下所示。</p><pre class="ku kv kw kx fd ma lz mb mc aw md bi"><span id="3633" class="me kz hs lz b fi mf mg l mh mi">private void onAudioFocusChange(int focusChange) {<br/>   switch (focusChange) {<br/>       case AudioManager.AUDIOFOCUS_GAIN:<br/>           logToUI("Audio Focus: Gained");<br/>           if (mAudioFocusPlaybackDelayed || mAudioFocusResumeOnFocusGained) {<br/>               mAudioFocusPlaybackDelayed = false;<br/>               mAudioFocusResumeOnFocusGained = false;<br/>               start();<br/>           }<br/>           break;<br/>       case AudioManager.AUDIOFOCUS_LOSS:<br/>           mAudioFocusResumeOnFocusGained = false;<br/>           mAudioFocusPlaybackDelayed = false;<br/>           stop();<br/>           break;<br/>       case AudioManager.AUDIOFOCUS_LOSS_TRANSIENT:<br/>           mAudioFocusResumeOnFocusGained = true;<br/>           mAudioFocusPlaybackDelayed = false;<br/>           pause();<br/>           break;<br/>       case AudioManager.AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK:<br/>           pause();<br/>           break;<br/>   }<br/>}</span></pre><h1 id="a378" class="ky kz hs bd la lb lc ld le lf lg lh li iy lj iz lk jb ll jc lm je ln jf lo lp bi translated">第三步:记住放弃音频焦点</h1><p id="83f4" class="pw-post-body-paragraph jh ji hs jj b jk lq it jm jn lr iw jp jq ls js jt ju lt jw jx jy lu ka kb kc ha bi translated">当你的应用程序完成播放它的音频时，它应该通过调用<code class="du lw lx ly lz b"><a class="ae km" href="https://developer.android.com/reference/android/media/AudioManager.html#abandonAudioFocus(android.media.AudioManager.OnAudioFocusChangeListener)" rel="noopener ugc nofollow" target="_blank">AudioManager.abandonAudioFocus(…)</a></code>来放弃音频焦点。在上一步中，我们遇到了这样的情况:当用户开始暂停播放时，应用程序放弃了音频焦点，但当它被其他应用程序暂时中断时，应用程序保留了音频焦点。</p><h1 id="f621" class="ky kz hs bd la lb lc ld le lf lg lh li iy lj iz lk jb ll jc lm je ln jf lo lp bi translated">代码示例</h1><h2 id="02e2" class="me kz hs bd la mk ml mm le mn mo mp li jq mq mr lk ju ms mt lm jy mu mv lo mw bi translated">你可以在应用程序中使用的要点</h2><p id="ec9a" class="pw-post-body-paragraph jh ji hs jj b jk lq it jm jn lr iw jp jq ls js jt ju lt jw jx jy lu ka kb kc ha bi translated">你可以在这个<a class="ae km" href="https://gist.github.com/nic0lette/c360dd353c451d727ea017890cbaa521" rel="noopener ugc nofollow" target="_blank"> GitHub gist </a>中找到3个类，它们涵盖了你可以在应用中使用的音频聚焦代码。</p><ul class=""><li id="0fef" class="kd ke hs jj b jk jl jn jo jq kf ju kg jy kh kc lv kj kk kl bi translated"><code class="du lw lx ly lz b"><a class="ae km" href="https://gist.github.com/nic0lette/c360dd353c451d727ea017890cbaa521#file-audiofocusrequestcompat-java" rel="noopener ugc nofollow" target="_blank">AudioFocusRequestCompat</a></code> —使用此类描述您的应用程序需要的音频焦点类型。</li><li id="16bb" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc lv kj kk kl bi translated"><code class="du lw lx ly lz b"><a class="ae km" href="https://gist.github.com/nic0lette/c360dd353c451d727ea017890cbaa521#file-audiofocushelper-java" rel="noopener ugc nofollow" target="_blank">AudioFocusHelper</a></code> —这个类实际上为你处理音频焦点。你可以将它包含在你的应用中，但你必须确保你的音频播放服务使用下面的接口。</li><li id="cced" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc lv kj kk kl bi translated"><code class="du lw lx ly lz b"><a class="ae km" href="https://gist.github.com/nic0lette/c360dd353c451d727ea017890cbaa521#file-audiofocusawareplayer-java" rel="noopener ugc nofollow" target="_blank">AudioFocusAwarePlayer</a></code> —这个接口应该由管理您的媒体播放器的服务(<code class="du lw lx ly lz b">MediaPlayer</code>或<code class="du lw lx ly lz b">ExoPlayer</code>)来实现，它将允许<code class="du lw lx ly lz b">AudioFocusHelper</code>类使其与音频焦点一起工作。</li></ul><h2 id="f5d5" class="me kz hs bd la mk ml mm le mn mo mp li jq mq mr lk ju ms mt lm jy mu mv lo mw bi translated">完整的代码示例</h2><p id="b8dd" class="pw-post-body-paragraph jh ji hs jj b jk lq it jm jn lr iw jp jq ls js jt ju lt jw jx jy lu ka kb kc ha bi translated"><code class="du lw lx ly lz b"><a class="ae km" href="https://github.com/googlesamples/android-MediaBrowserService" rel="noopener ugc nofollow" target="_blank">android-MediaBrowserService</a></code>示例展示了如何在使用<code class="du lw lx ly lz b">MediaPlayer</code>在后台实际播放音频的Android应用程序中处理音频焦点。它也用<code class="du lw lx ly lz b">MediaSession</code>。</p><p id="ecb2" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">该示例有一个展示音频焦点最佳实践的<code class="du lw lx ly lz b"><a class="ae km" href="https://github.com/googlesamples/android-MediaBrowserService/blob/master/app/src/main/java/com/example/android/mediasession/service/PlayerAdapter.java" rel="noopener ugc nofollow" target="_blank">PlayerAdapter</a></code>类。请看看<code class="du lw lx ly lz b">pause()</code>和<code class="du lw lx ly lz b">onAudioFocusChange(int)</code>方法的实现。</p><h1 id="da9a" class="ky kz hs bd la lb lc ld le lf lg lh li iy lj iz lk jb ll jc lm je ln jf lo lp bi translated">测试您的代码</h1><p id="57c4" class="pw-post-body-paragraph jh ji hs jj b jk lq it jm jn lr iw jp jq ls js jt ju lt jw jx jy lu ka kb kc ha bi translated">一旦你在应用中实现了音频聚焦，你就可以使用Android媒体控制器工具来测试你的应用对聚焦增益和损失的反应。你可以在<a class="ae km" href="https://github.com/googlesamples/android-media-controller#audio-focus" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上得到它。</p><figure class="ku kv kw kx fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es mx"><img src="../Images/1f1d41950b83d798cdc6934e53556f82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZiD8Wht_tAyFC4WDwVhcjg.png"/></div></div></figure><h1 id="ed96" class="ky kz hs bd la lb lc ld le lf lg lh li iy lj iz lk jb ll jc lm je ln jf lo lp bi translated">Android媒体资源</h1><ul class=""><li id="f788" class="kd ke hs jj b jk lq jn lr jq my ju mz jy na kc lv kj kk kl bi translated"><a class="ae km" href="https://github.com/googlesamples/android-MediaBrowserService" rel="noopener ugc nofollow" target="_blank">示例代码— MediaBrowserService </a></li><li id="1731" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc lv kj kk kl bi translated"><a class="ae km" href="https://github.com/googlesamples/android-media-controller" rel="noopener ugc nofollow" target="_blank">示例代码—媒体会话控制器测试(支持音频焦点测试)</a></li><li id="f261" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc lv kj kk kl bi translated"><a class="ae km" rel="noopener" href="/google-developers/understanding-mediasession-part-1-3-e4d2725f18e4">了解MediaSession </a></li><li id="1c93" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc lv kj kk kl bi translated"><a class="ae km" href="https://developer.android.com/guide/topics/media-apps/media-apps-overview.html" rel="noopener ugc nofollow" target="_blank">媒体API指南—媒体应用概述</a></li><li id="3fea" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc lv kj kk kl bi translated"><a class="ae km" href="https://developer.android.com/guide/topics/media-apps/working-with-a-media-session.html" rel="noopener ugc nofollow" target="_blank">媒体API指南—使用媒体会话</a></li><li id="9a73" class="kd ke hs jj b jk kn jn ko jq kp ju kq jy kr kc lv kj kk kl bi translated"><a class="ae km" rel="noopener" href="/google-developers/building-a-simple-audio-app-in-android-part-1-3-c14d1a66e0f1">使用MediaPlayer构建简单的音频播放应用</a></li></ul></div></div>    
</body>
</html>