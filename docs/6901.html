<html>
<head>
<title>How to Use JWT for Express + NodeJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将JWT用于Express + NodeJS</h1>
<blockquote>原文：<a href="https://medium.com/quick-code/how-to-use-jwt-for-express-nodejs-628ddf9f7c83?source=collection_archive---------0-----------------------#2020-09-05">https://medium.com/quick-code/how-to-use-jwt-for-express-nodejs-628ddf9f7c83?source=collection_archive---------0-----------------------#2020-09-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/378ed2db82c6aae789e7d18245a33515.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7M2GTVUXSaEHgh48uzBlMQ.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">created by stories at <a class="ae it" href="http://www.freepik.com" rel="noopener ugc nofollow" target="_blank">www.freepik.com</a></figcaption></figure><p id="a735" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在本文中，我们将学习如何使用JSON Web令牌为NodeJS + Express服务器实现身份验证。本文将指导您完成服务器的初始设置，直到一个具有工作身份验证的全功能服务器。</p><p id="8f39" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这篇文章由以下几部分组成。如果你想直接进入代码部分。跳到<strong class="iw hi"> <em class="js">项目设置</em> </strong>:</p><ul class=""><li id="e343" class="jt ju hh iw b ix iy jb jc jf jv jj jw jn jx jr jy jz ka kb bi translated">理解JSON Web令牌</li><li id="150b" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">项目设置</li><li id="f0f6" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">设置数据库</li><li id="dc9b" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">实现授权中间件</li><li id="782a" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">添加路由</li><li id="e2c9" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">签署令牌</li><li id="dc1d" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">将这些点连接起来</li></ul></div><div class="ab cl kh ki go kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="ha hb hc hd he"><h2 id="b9e0" class="ko kp hh bd kq kr ks kt ku kv kw kx ky jf kz la lb jj lc ld le jn lf lg lh li bi translated">理解JSON Web令牌</h2><p id="3ed9" class="pw-post-body-paragraph iu iv hh iw b ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn ln jp jq jr ha bi translated">JSON Web令牌或JWT用于在各方之间以JSON对象的形式安全地传输用户信息。它由<strong class="iw hi">报头</strong>、<strong class="iw hi">有效载荷、</strong>和<strong class="iw hi">签名</strong>组成</p><p id="837e" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">头</strong>定义了令牌的类型和用于验证它的算法</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="8c4e" class="ko kp hh lt b fi lx ly l lz ma">{<br/>   "type" : "JWT",<br/>   "alg" : "HS256"<br/>}</span></pre><p id="627a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">有效载荷</strong>包含我们想要传输的信息。例如</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="475c" class="ko kp hh lt b fi lx ly l lz ma">{<br/>   id : 1<br/>   email : 'test@user.com'<br/>}</span></pre><p id="a8c2" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">签名</strong>对报头和有效载荷中的信息进行编码。它还验证正在发送的消息在发送过程中没有被篡改</p><h2 id="3a1e" class="ko kp hh bd kq kr ks kt ku kv kw kx ky jf kz la lb jj lc ld le jn lf lg lh li bi translated">项目设置</h2><p id="fca6" class="pw-post-body-paragraph iu iv hh iw b ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn ln jp jq jr ha bi translated">让我们从创建一个空的存储库开始，并运行以下命令。这将初始化npm存储库并安装所有必需的依赖项。我们稍后将逐一介绍它们。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="8de6" class="ko kp hh lt b fi lx ly l lz ma">npm init -y<br/>npm install --save bcrypt-nodejs body-parser dotenv express http jsonwebtoken mongoose passport passport-jwt passport-local</span></pre><p id="7559" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我们继续创建文件夹结构</p><figure class="lo lp lq lr fd ii er es paragraph-image"><div class="er es mb"><img src="../Images/d85d99036ddf6ab37286792877653fc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:818/format:webp/1*yOoEjC7L7k4QeDd2GnnIBw.png"/></div></figure><ul class=""><li id="5e21" class="jt ju hh iw b ix iy jb jc jf jv jj jw jn jx jr jy jz ka kb bi translated"><strong class="iw hi"><em class="js">config</em></strong><em class="js"/>将包含数据库URI等配置变量</li><li id="8047" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated"><strong class="iw hi">控制器</strong>包含类似检查JWT的内部逻辑</li><li id="4fa0" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">模型将定义我们的数据库结构</li><li id="b2c3" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated"><strong class="iw hi">路由</strong>将定义我们的API端点</li><li id="8ae1" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated"><strong class="iw hi">服务</strong>实施第三方集成</li></ul><h2 id="5463" class="ko kp hh bd kq kr ks kt ku kv kw kx ky jf kz la lb jj lc ld le jn lf lg lh li bi translated">设置数据库</h2><p id="9ead" class="pw-post-body-paragraph iu iv hh iw b ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn ln jp jq jr ha bi translated">我们的数据库将只包含一个模型，那就是用户。对于这个例子，我们只需要两个字段。但是请记住，这个模型很容易扩展。该模型确保我们在调用API端点时不会暴露用户密码。并且当创建新用户时，该密码被散列和加盐。它还包含一个助手函数来检查密码是否有效</p><figure class="lo lp lq lr fd ii"><div class="bz dy l di"><div class="mc md l"/></div></figure><h2 id="a95c" class="ko kp hh bd kq kr ks kt ku kv kw kx ky jf kz la lb jj lc ld le jn lf lg lh li bi translated">实现授权中间件</h2><p id="833c" class="pw-post-body-paragraph iu iv hh iw b ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn ln jp jq jr ha bi translated">我们正好需要3个中间件或策略。其中一个将创建一个新用户，用于注册。第二个将检查用户是否存在以及密码是否正确。这个将用于登录。第三个是检验JWT是否正确。它还将从令牌中提取用户信息。这个将用来保护我们的路线。</p><figure class="lo lp lq lr fd ii"><div class="bz dy l di"><div class="mc md l"/></div></figure><h2 id="bea9" class="ko kp hh bd kq kr ks kt ku kv kw kx ky jf kz la lb jj lc ld le jn lf lg lh li bi translated">添加路由</h2><p id="7b2c" class="pw-post-body-paragraph iu iv hh iw b ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn ln jp jq jr ha bi translated">我们的认证路线将非常简单。他们只会使用我们在上一步中定义的中间件，并将响应返回给用户。如果需要一些额外的逻辑。它将由管理员来处理</p><figure class="lo lp lq lr fd ii"><div class="bz dy l di"><div class="mc md l"/></div></figure><h2 id="fd77" class="ko kp hh bd kq kr ks kt ku kv kw kx ky jf kz la lb jj lc ld le jn lf lg lh li bi translated">签署令牌</h2><p id="d83e" class="pw-post-body-paragraph iu iv hh iw b ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn ln jp jq jr ha bi translated">当新用户注册或现有用户登录时。我们需要为他/她创建一个令牌。这个令牌将在我们的API请求的响应中返回。你可以在上面的代码片段中看到我们正在调用<code class="du me mf mg lt b">generateToken</code>函数。这个函数只是简单地获取用户对象，并从中创建一个签名的JWT令牌。</p><figure class="lo lp lq lr fd ii"><div class="bz dy l di"><div class="mc md l"/></div></figure><h2 id="b2a8" class="ko kp hh bd kq kr ks kt ku kv kw kx ky jf kz la lb jj lc ld le jn lf lg lh li bi translated">将这些点连接起来</h2><p id="3234" class="pw-post-body-paragraph iu iv hh iw b ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn ln jp jq jr ha bi translated">既然我们所有的部分都准备好了。让我们把它们放在一起，用它们创建一个跑步机器。这是我们服务器的入口点。它执行以下操作:</p><ul class=""><li id="ed1b" class="jt ju hh iw b ix iy jb jc jf jv jj jw jn jx jr jy jz ka kb bi translated">加载环境变量(我们不想暴露敏感数据，如数据库URI)</li><li id="a3be" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">初始化数据库模型并连接到数据库</li><li id="a56a" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">创建快速应用程序</li><li id="9d16" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">向我们的请求添加解析器</li><li id="6196" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">初始化护照和路线</li><li id="af69" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">最后，监听指定端口上的传入请求</li></ul><figure class="lo lp lq lr fd ii"><div class="bz dy l di"><div class="mc md l"/></div></figure><h2 id="4fb6" class="ko kp hh bd kq kr ks kt ku kv kw kx ky jf kz la lb jj lc ld le jn lf lg lh li bi translated">结论</h2><p id="bc48" class="pw-post-body-paragraph iu iv hh iw b ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm jn ln jp jq jr ha bi translated">事实上这就是一切。如果您想看看整个例子的运行情况。<a class="ae it" href="https://github.com/codewithbernard/express-auth" rel="noopener ugc nofollow" target="_blank">点击这里进入GitHub库。</a></p><p id="5dec" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在是做一点总结的时候了。在本文中，我们了解到:</p><ul class=""><li id="9173" class="jt ju hh iw b ix iy jb jc jf jv jj jw jn jx jr jy jz ka kb bi translated">JSON Web令牌如何工作(如果您没有跳过这一部分)</li><li id="847b" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">如何从头开始设置express server</li><li id="3446" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">如何添加授权中间件与JWT一起工作</li><li id="accf" class="jt ju hh iw b ix kc jb kd jf ke jj kf jn kg jr jy jz ka kb bi translated">如何使用JWT检查保护API端点</li></ul><figure class="lo lp lq lr fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mh"><img src="../Images/2d1e9d35c16f53043c0aca12b092efe4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*TzAtRszkEAxZjP0Zxelyhw.jpeg"/></div></div></figure><p id="bd6e" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果你有任何问题、意见或建议，请在下面的评论区告诉我。下次见！</p></div></div>    
</body>
</html>