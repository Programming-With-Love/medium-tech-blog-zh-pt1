# 对 Airbnb 上的列表照片进行分类

> 原文：<https://medium.com/airbnb-engineering/categorizing-listing-photos-at-airbnb-f9483f3ab7e3?source=collection_archive---------1----------------------->

## 大规模深度学习模型正在改变我们对我们平台上房屋图像的思考方式。

**作者:** *姚石静，，菲利普·西克莱特*

![](img/14eca0beb7702df78d4f98cef70540fb.png)

Walking into our new office in San Francisco, meeting rooms evoke the variety of our listing photos in a search!

Airbnb 是一个拥有数百万房屋的市场。世界各地的旅行者在这个平台上搜索，发现适合他们旅行的最佳住所。除了位置和价格，列出照片是客人搜索过程中最关键的决策因素之一。然而直到最近，我们对这些重要的照片知之甚少。当一位客人与房屋照片列表互动时，我们无法帮助客人找到信息最丰富的照片，确保照片中传达的信息准确无误，或者建议主人如何以可扩展的方式提高照片的吸引力。

![](img/1f606a2a58feebaff66ee96fa833412b.png)

由于计算机视觉和深度学习方面的最新进展，我们能够利用技术来大规模解决这些问题。我们开始了一个项目，旨在将我们的列表照片分类到不同的房间类型。首先，分类使得简单的家庭旅行成为可能，在那里相同房间类型的照片可以被分组在一起。另一方面，分类使得验证某些房间的数量和检查基本房间信息是否正确变得更加容易。展望未来，我们相信有很多令人兴奋的机会来进一步增强我们对 Airbnb 上图像内容的了解。我们将在这篇文章的最后展示一些例子。

# 图像分类

为给定的列表照片正确分类房间类型的能力对于优化用户体验非常有用。在客人方面，它有助于根据不同的房间类型重新排列和布局照片，以便人们最感兴趣的照片将首先出现。在主机端，它帮助我们自动审核列表，以确保它们符合我们市场的高标准。准确的照片分类是这些核心功能的基础。

我们试图分类的第一批房间类型包括卧室、浴室、客厅、厨房、游泳池和景观。我们希望根据产品团队的需求增加其他房间类型。

房间类型分类问题很大程度上类似于 ImageNet 分类问题，除了我们的模型结果是定制的房间类型。这使得现成的最先进的深度神经网络(DNN)模型，如 VGG，ResNet 和 Inception 不能直接适用于我们的情况。网上有很多很棒的帖子告诉人们如何应对这个问题。基本上，我们应该 1)修改 DNN 的最后(顶部)几层，以确保输出维度与我们的匹配，2)在一定程度上重新训练 DNN，并获得满意的性能。在对这些模型进行了一些实验之后，我们选择了 [ResNet50](https://arxiv.org/abs/1512.03385) 作为我们的发电站，因为它在模型性能和计算时间之间取得了良好的平衡。为了使它与我们的用例兼容，我们在最后添加了两个额外的完全连接的层和一个 Softmax 激活。我们还试验了一些培训选项，这将在下一节讨论。

# 重新训练修改后的 ResNet50

![](img/df07b4c84896f2bf7b0a5dd4df835938.png)

Architecture of a Modified ResNet50\. Graph of the base model cited from Kaiming He.

重新训练 ResNet50 分三种情况:

1.  保持基本 ResNet50 模型固定，仅使用最少的数据重新训练添加的两个层。这也经常被称为微调。
2.  进行与 1 中相同的微调，但是使用更多的数据。
3.  从头开始重新训练整个改装过的 ResNet50。

大多数在线教程使用第一种方法，因为它很快，通常会产生不错的结果。我们尝试了第一种方法，确实得到了一些合理的初步结果。然而，为了推出高质量的图像产品，我们需要大幅提高模型性能，理想情况下达到 95%以上的精确度和 80%以上的召回率。

为了同时达到高精度和高召回率，我们意识到使用海量数据重新训练 DNN 是不可避免的。然而，有两个主要的挑战:1)即使我们有很多主机上传的列表照片，我们也没有与之相关的准确的房间类型标签，如果有的话。2)重新训练像 ResNet50 这样的 DNN 是非常重要的-有超过 2500 万个参数要训练，这需要大量的 GPU 支持。这两个挑战将在接下来的两节中讨论。

# 图像字幕监督

许多公司利用第三方供应商来获得高质量的图像数据标签。对于我们来说，这显然不是最经济的解决方案，当数百万张照片需要被标记时。为了平衡成本和性能，我们以混合的方式处理这个标签问题。一方面，我们要求供应商标记相对少量的照片，通常是几千或几万张。这些被标记的数据将作为我们评估模型的黄金组合。我们使用随机抽样来获得这个黄金集，并确保数据是无偏的。另一方面，我们利用主机创建的图像标题作为房间类型信息的代理，并从中提取标签。这个想法对我们来说是巨大的，因为它使昂贵的标签任务基本上免费。我们只需要一种明智的方法来确保从图像标题中提取的房间类型标签是准确可靠的。

从图像标题中提取房间类型标签的一个有吸引力的方法如下:如果在图像的标题中发现某个房间类型关键字，则该图像将被标记为该类型。然而，现实世界要比这复杂得多。如果你检查了这条规则的结果，你会非常失望。我们发现很多情况下图片标题与图片的实际内容相去甚远。下面是几个不好的例子。

![](img/52aa14054427e67717c71f460963b2b5.png)

Incorrect Labels Extracted from Image Caption

为了过滤掉像这样的坏例子，我们在从图像标题中提取房间类型标签时添加了额外的规则。经过几轮过滤和检查，标签质量大大提高。下面是我们如何过滤厨房数据以获得相对“干净”的厨房图像的例子。

Filters applied on Kitchen images

由于这些额外的过滤器，我们丢失了相当多的图像数据。这对我们来说没问题，因为即使有如此积极的过滤，我们仍然得到了几百万张照片，每种房间类型有几十万张。此外，这些照片的标签质量现在好多了。这里，我们假设数据分布不随过滤而变化，一旦我们在无偏的黄金数据集上测试了模型，这将得到验证。

话虽如此，我们可能已经能够使用一些 NLP 技术来动态聚类图像标题，而不是使用基于规则的试探法。然而，我们现在决定继续使用启发式方法，并将 NLP 工作推向未来。

# 模型建立、评估和生产

![](img/744359230668ab096b55a3d402df0aa7.png)

Left: GPU performance for 8-core parallel training. Right: Distributed SGD: Graph cited from Quoc V. Le.

使用几百万张图像重新训练像 ResNet50 这样的 DNN 需要大量的计算资源。在我们的实现中，我们使用了一个带有 Nvidia 8 核 K80 GPU 的 AWS P2.8xlarge 实例，并在每个训练步骤中向 8 个 GPU 发送了一批 128 个图像。我们以 [Tensorflow](https://www.tensorflow.org/) 为后端做了并行训练。我们在将模型*并行化之后编译了它，因为否则训练将不起作用。为了进一步加快训练速度，我们使用从[*keras . applications . resnet 50 . resnet 50*](https://keras.io/applications/#resnet50)加载的预训练 *imagenet* 权重来初始化模型权重。在持续约 6 小时的 3 个时期的训练后获得最佳模型。之后，模型开始过度拟合，验证集的性能停止提高。*

一个重要的注意事项是，我们在生产中为不同的房间类型构建了多个二元类模型，而不是构建一个多类模型来涵盖所有房间类型。这并不理想，但是由于我们的模型服务大部分是离线的，由于多个模型调用造成的额外延迟对我们的影响很小。我们将很快过渡到多级生产模式。

我们基于精确度和召回率来评估我们的模型。我们还监控了 F1 得分和准确性等指标。它们的定义重申如下。简而言之，精确度描述了我们对正面预测的准确性有多有信心，而回忆描述了我们的正面预测覆盖了所有实际正面的百分比。精确度和召回率通常是相互矛盾的。在我们的上下文中，我们为精确度设置了一个高标准(95%)，因为当我们声称照片是某个房间类型时，我们应该对该声明有很高的信心。

![](img/49dccd2a4fd4901692c77ff7a168191d.png)

TP: True Positive, TN: True Negative, FP: False Positive, FN: False Negative

混淆矩阵是计算这些指标的关键。我们模型的原始输出是每幅图像从 0 到 1 的概率分数。为了计算一组预测的混淆矩阵，必须首先设置一个特定的阈值来将预测的分数转换为 0 和 1。然后通过从 0 到 1 扫描阈值来生成精确召回(P-R)曲线。原则上，P-R 曲线的 AUC(曲线下面积)越接近 1，模型就越精确。

在评估模型时，我们使用了前面提到的黄金集合，其中地面真相标签是由人类提供的。有趣的是，我们发现不同房间类型的准确性不同。卧室和浴室模型是最准确的，而其他模型不太准确。为简洁起见，这里我们只展示一个卧室和客厅的 P-R 曲线。虚线的交叉点代表给定特定阈值的最终性能。我们在图表上附加了指标的摘要。

![](img/aaed8ec8715657d82f99b19eafa4a364.png)

**P-R Curve of Bedroom**

![](img/b950f79f15ea0ad0149b0bdae1a7a2b2.png)

**P-R Curve of Living Room**

有两个重要的观察结果:

1.  卧室模型的整体性能比 a 客厅好很多。可能有两种解释:1)卧室比客厅更容易分类，因为卧室的布置相对标准，而客厅可以有更多的变化。2)从卧室照片中提取的标签比从客厅照片中提取的标签具有更高的质量，因为客厅照片偶尔也包括餐厅甚至厨房。
2.  在每种房间类型中，完全重新训练的模型(红色曲线)比部分重新训练的模型(蓝色曲线)具有更好的性能，客厅模型之间的差距大于卧室模型之间的差距。这表明重新训练完整的 ResNet50 模型对于困难的房间类型具有不同的影响。

我们出货的 6 款，准确率普遍在 95%以上，召回率普遍在 50%以上。通过设置不同的阈值，人们可以进行权衡。该模型将为 Airbnb 内部多个产品团队的许多不同产品提供支持。

用户将我们的结果与知名的第三方图像识别 API 进行了比较。据报道，内部模型总体上优于第三方通用模型。这意味着通过利用您自己的数据，您有机会在您感兴趣的特定任务中超越甚至行业最先进的模型。

在这一部分的最后，我们将展示几个具体的例子来说明这种模型的威力。

![](img/c2e6d87931eedee1ef2468dcd353d573.png)

The left two photos were correctly predicted as bedrooms; The right two photos were correctly predicted NOT as bedrooms.

![](img/3a94246d7d71dfaf1d917d647be3fbd3.png)

The left two photos were correctly predicted as bathrooms; The right two photos were correctly predicted NOT as bathrooms.

![](img/40b24bfb9b7220fcc6fb4f2b7e5ac7ed.png)

The left two photos were correctly predicted as pools; The right two photos were correctly predicted NOT as pools, because they were aquarium and waterfront.

# 超越分类

在做这个项目的时候，我们也尝试了一些超越房型分类的有趣想法。我们想在这里展示两个例子，让人们了解这些问题有多令人兴奋。

## 无监督场景分类

当我们第一次尝试使用预训练的 ResNet50 模型进行房间类型分类时，我们生成了用于列出封面照片的图像嵌入(2048x1 向量)。为了解释这些嵌入意味着什么，我们使用 PCA 技术将这些长向量投影到 2D 平面上。令我们惊讶的是，投影数据被自然地分成两组。观察这两个组，我们发现左边组几乎完全是室内场景，右边组几乎完全是室外场景。这意味着无需任何重新训练，简单地通过在图像嵌入的第一主成分上设置切割线，我们就能够确定室内和室外场景。这一发现为一些真正有趣的领域打开了大门，在这些领域中，转移学习(嵌入)遇到了无监督学习。

![](img/d53d64e12cf2b27000831dadc4e19a10.png)

Indoor and Outdoor photos are automatically clustered by the first and second principal component.

## 目标检测

我们尝试追求的另一个领域是对象检测。在[开放图像数据集](https://github.com/openimages/dataset)上预先训练的[更快的 R-CNN](https://arxiv.org/abs/1506.01497) 模型已经提供了惊人的结果。正如你在下面的例子中看到的，这个模型能够检测窗户、门、餐桌以及它们的位置。使用 [Tensorflow 对象检测 API](https://github.com/tensorflow/models/tree/master/research/object_detection) ，我们对我们的列表照片做了一些快速评估。使用现成的结果可以检测出许多家居用品。未来，我们计划使用 Airbnb 定制的舒适标签重新培训更快的 R-CNN 模型。由于开源数据中缺少一些标签，我们可能会自己创建标签。通过这些算法检测到的便利设施，我们能够验证来自主机的列表的质量，并使客人更容易找到具有特定便利设施需求的房屋。这将推动 Airbnb 的照片智能前沿更上一层楼。

![](img/5dcf49740d050afaef51ee7136f4ac08.png)

Window, Door and Dining Table are successfully detected.

# 结论

以下是一些可能对其他深度学习从业者有帮助的关键要点:

首先，深度学习只不过是一种特殊的监督学习。人们不能高估高质量标签对数据的重要性。由于深度学习通常需要大量的训练数据来实现最先进的性能，因此找到一种有效的方法来进行标记至关重要。幸运的是，我们找到了一种经济、可扩展且可靠的混合方法。

第二，从零开始训练一个像 ResNet50 这样的 DNN 人是相当复杂的。尝试以简单快速的方式开始—使用小数据集仅训练顶层。如果你有一个大的可训练数据集，从头开始重新训练 DNN 可能会给你最先进的性能。

第三，如果可以的话，将培训平行化。在我们的例子中，通过使用 8 个 GPU，我们获得了大约 6 倍(准线性)的加速。这使得构建复杂的 DNN 模型在计算上可行，并且在超参数和模型结构上迭代容易得多。

*对将深度学习应用于像这样的高影响力问题感兴趣？我们一直在寻找* [*优秀人才加入我们的数据科学和分析团队*](https://www.airbnb.com/careers/departments/data-science-analytics) *！*

*这部作品是与* ***奎师那·普塔斯瓦米*******小寒曾*** *和* ***阿尔弗雷多·卢克*** *。整个公司的人帮助在产品中推出这一功能。我们还要感谢开源库的贡献者，如 Keras、Tensorflow、Open Images Data、ImageNet 和 ResNet 的原始发明者。我们从这个友好的开源社区中受益匪浅。最后，我们感谢* ***杰夫·冯*** *和* ***丽贝卡·罗森菲尔特*** *对校对工作的鼎力相助。**