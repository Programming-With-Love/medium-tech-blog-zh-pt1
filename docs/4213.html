<html>
<head>
<title>Digital Goods Transaction of Actions on Google (Write Code and Test)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌上的数字商品交易行为(编写代码和测试)</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/digital-goods-transaction-of-actions-on-google-write-code-and-test-9cb352e8d3db?source=collection_archive---------1-----------------------#2018-12-15">https://medium.com/google-developer-experts/digital-goods-transaction-of-actions-on-google-write-code-and-test-9cb352e8d3db?source=collection_archive---------1-----------------------#2018-12-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="4cf9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从第1部分到第6部分，我描述了如何准备使用数字商品交易功能。现在，您应该有一个测试该特性的环境。最后，你开始用这个故事中的数字商品交易来实施你的行动。</p><div class="jc jd ez fb je jf"><a href="https://developers.google.com/actions/transactions/digital/dev-guide-digital" rel="noopener  ugc nofollow" target="_blank"><div class="jg ab dw"><div class="jh ab ji cl cj jj"><h2 class="bd hi fi z dy jk ea eb jl ed ef hg bi translated">构建数字交易| Google上的行动| Google开发者</h2><div class="jm l"><h3 class="bd b fi z dy jk ea eb jl ed ef dx translated">要向数字采购API发送请求，您需要下载一个与您的……</h3></div><div class="jn l"><p class="bd b fp z dy jk ea eb jl ed ef dx translated">developers.google.com</p></div></div><div class="jo l"><div class="jp l jq jr js jo jt ju jf"/></div></div></a></div><p id="56aa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们开始吧。</p><h1 id="be1b" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">交易流程</h1><p id="3a81" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">我已经描述了数字商品交易功能的交易流程。我再一次向你介绍这里的流程。</p><ol class=""><li id="1997" class="ky kz hh ig b ih ii il im ip la it lb ix lc jb ld le lf lg bi translated">收集信息</li><li id="9e2d" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb ld le lf lg bi translated">构建订单</li><li id="1aec" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb ld le lf lg bi translated">完成购买</li><li id="68af" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb ld le lf lg bi translated">描述购买状态</li><li id="2590" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb ld le lf lg bi translated">使购买可重复</li></ol><h1 id="a36e" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">先决条件</h1><p id="7698" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">现在，你应该有你的谷歌项目和Dialogflow代理的行动。但是，我没有描述到目前为止的成就。我不会在这里描述如何创造满足感。相反，请阅读以下指南:</p><div class="jc jd ez fb je jf"><a href="https://developers.google.com/actions/dialogflow/fulfillment" rel="noopener  ugc nofollow" target="_blank"><div class="jg ab dw"><div class="jh ab ji cl cj jj"><h2 class="bd hi fi z dy jk ea eb jl ed ef hg bi translated">构建实现| Google上的操作| Google开发者</h2><div class="jm l"><h3 class="bd b fi z dy jk ea eb jl ed ef dx translated">如果为此目的启用了实现，则活动定义要传递给实现的数据。这包括解析的数据…</h3></div><div class="jn l"><p class="bd b fp z dy jk ea eb jl ed ef dx translated">developers.google.com</p></div></div><div class="jo l"><div class="lm l jq jr js jo jt ju jf"/></div></div></a></div><p id="0e16" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我假设您有自己的实现代码，可以将其部署到您拥有的某个服务器或某个云服务上，并且您已经为您的Dialogflow代理配置了实现URL。例如，您的履行URL应设置如下:</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es ln"><img src="../Images/2fdd37d4644df74ce4eb29a5cc3f2a91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gsZQ1YJFKr7q2ZBwtJlaKA.png"/></div></div></figure><p id="e012" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我假设您的履行代码如下:</p><pre class="lo lp lq lr fd ly lz ma mb aw mc bi"><span id="163e" class="md jw hh lz b fi me mf l mg mh">"use strict";</span><span id="9d10" class="md jw hh lz b fi mi mf l mg mh">const functions = require("firebase-functions");<br/>const {<br/>    dialogflow,<br/>    List,<br/>    CompletePurchase<br/>} = require("actions-on-google");<br/>const request = require("request");<br/>const {google} = require("googleapis");</span><span id="72de" class="md jw hh lz b fi mi mf l mg mh">const serviceAccount = require("&lt;YOUR_SERVICE_ACCOUNT_PATH&gt;");<br/>const packageName = "&lt;YOUR_ANDROID_APP_PACKAGE_NAME&gt;";</span><span id="5ede" class="md jw hh lz b fi mi mf l mg mh">const app = dialogflow({<br/>    debug: true<br/>});</span><span id="93b8" class="md jw hh lz b fi mi mf l mg mh">// TODO: Write code here.</span><span id="b165" class="md jw hh lz b fi mi mf l mg mh">exports.digitalGoodsTest = functions.https.onRequest(app);</span></pre><p id="d61b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du mj mk ml lz b">&lt;YOUR_SERVICE_ACCOUNT_PATH</code>是您在第5部分从Google云平台控制台获取的服务帐户JSON文件路径。并且，<code class="du mj mk ml lz b">&lt;YOUR_ANDROID_APP_PACKAGE_NAME&gt;</code>是您在第2部分创建Android应用程序时决定的包名(我当时使用“jp.eisbahn.digitalgoodstest”作为示例)。</p><p id="6b03" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从属库如下:</p><ul class=""><li id="9b60" class="ky kz hh ig b ih ii il im ip la it lb ix lc jb mm le lf lg bi translated">谷歌上的行动</li><li id="9008" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated">消防基地-功能</li><li id="db05" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated">firebase-管理</li><li id="8fc1" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated">请求</li><li id="136a" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated">谷歌API</li></ul><p id="e891" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过<code class="du mj mk ml lz b">npm install</code>或<code class="du mj mk ml lz b">yarn add</code>将这些库添加到您的实现项目中。</p><p id="fe62" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我假设您可以在动作模拟器中调用您的动作，如下所示:</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mn"><img src="../Images/cdc2806a3ec8d319e2eacbe9cc8c655d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7mdR-nyaazW5Ai48z3FkhQ.png"/></div></div></figure><p id="7563" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，您需要使用Dialogflow控制台左侧导航菜单中的“集成”菜单，将您的Dialogflow代理集成到您在Google project上的操作中。</p><h1 id="c39b" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">收集信息</h1><p id="3b95" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">首先，从Google Play收集有关您的数字商品的信息。在这里，您创建一个意向来订购收集可用的数字商品，并将意向处理程序功能实现到您的实现代码中。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mo"><img src="../Images/9a5ccc9f991700768d9a16db4efa0399.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*11wakfC0wx9_65M3PYYQUQ.png"/></div></div></figure><p id="6c43" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">单击Dialogflow控制台左侧导航菜单上“Intents”菜单项旁边的“+”图标。然后，创建新意向的页面打开。如下所示，在每个字段中填入值:</p><ul class=""><li id="ebf1" class="ky kz hh ig b ih ii il im ip la it lb ix lc jb mm le lf lg bi translated"><strong class="ig hi">意图名称</strong>:输入“收集信息”。</li><li id="39a4" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated"><strong class="ig hi">训练短语:</strong>键入“收集信息”。</li><li id="caee" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated"><strong class="ig hi">履行</strong>:开启“为此意图启用webhook调用”。</li></ul><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mn"><img src="../Images/0470a5478ac0796ecac6f1031b4e7c1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q-uAet_dFB3AvfMjFX9xPQ.png"/></div></div></figure><p id="bf0e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">点击页面顶部的“保存”按钮。</p><p id="7d2c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">好了，让我们开始编写预期的处理程序代码。您编写三个助手函数，然后编写处理函数。第一个助手函数是创建JWT客户端对象。</p><pre class="lo lp lq lr fd ly lz ma mb aw mc bi"><span id="6702" class="md jw hh lz b fi me mf l mg mh">const createJwtClient = () =&gt; {<br/>    const scopes = [<br/>        "<a class="ae mp" href="https://www.googleapis.com/auth/actions.purchases.digital" rel="noopener ugc nofollow" target="_blank">https://www.googleapis.com/auth/actions.purchases.digital</a>"<br/>    ];   <br/>    return new google.auth.JWT(<br/>        serviceAccount.client_email,<br/>        null,<br/>        serviceAccount.private_key,<br/>        scopes,<br/>        null<br/>    );<br/>};</span></pre><p id="e303" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第二个助手功能是从Google Play with Actions API获取SKU信息。</p><pre class="lo lp lq lr fd ly lz ma mb aw mc bi"><span id="5692" class="md jw hh lz b fi me mf l mg mh">const getSkus = (tokens, conv) =&gt; {<br/>    return new Promise((resolve, reject) =&gt; {<br/>        const url = `<a class="ae mp" href="https://actions.googleapis.com/v3/packages/${packageName}/skus:batchGet`" rel="noopener ugc nofollow" target="_blank">https://actions.googleapis.com/v3/packages/${packageName}/skus:batchGet`</a>;<br/>        const convId = conv.request.conversation.conversationId;<br/>        const param = {<br/>            conversationId: convId,<br/>            skuType: "SKU_TYPE_IN_APP",<br/>            ids: [<br/>                "premium",<br/>                "coins"<br/>            ]<br/>        };<br/>        request.post(url, {<br/>            auth: {<br/>                bearer: tokens.access_token<br/>            },<br/>            json: true,<br/>            body: param<br/>        }, (err, httpResponse, body) =&gt; {<br/>            if (err) {<br/>                reject(err);<br/>            } else {<br/>                const statusCode = httpResponse.statusCode;<br/>                const statusMessage = httpResponse.statusMessage;<br/>                console.log(`${statusCode}: ${statusMessage}`);<br/>                console.log(JSON.stringify(body));<br/>                resolve(body);<br/>            }<br/>        });<br/>    });<br/>};</span></pre><p id="469f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">上面的代码通过<code class="du mj mk ml lz b">request</code>库访问Actions API。API请求具有以下参数:</p><ul class=""><li id="f6a0" class="ky kz hh ig b ih ii il im ip la it lb ix lc jb mm le lf lg bi translated">conversationId:您可以检索<code class="du mj mk ml lz b">conv</code>参数的对话Id。</li><li id="0d37" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated">skuType:您想要获取产品的SKU类型字符串。如果要访问被管理产品，您指定<code class="du mj mk ml lz b">SKU_TYPE_IN_APP</code>。另一方面，如果你想访问订阅，你需要使用<code class="du mj mk ml lz b">SKU_TYPE_SUBSCRIPTION</code>。</li><li id="b57c" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated">ids:您想要知道的产品id的数组。</li></ul><p id="fc08" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在调用动作API时，需要为请求头<code class="du mj mk ml lz b">Authorization</code>设置一个访问令牌。</p><h1 id="2974" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">构建订单</h1><p id="c0a7" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">其次，您需要基于检索到的SKU信息构建响应，以便用户可以订购您的操作提供的产品。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mq"><img src="../Images/3dbd449e03b64575bab4fec57ddd0b84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jrHg1hbDaijef8FeFYkmRQ.png"/></div></div></figure><p id="5e47" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面的代码是第三个帮助器函数，用于构建和响应收集到的信息。</p><pre class="lo lp lq lr fd ly lz ma mb aw mc bi"><span id="5210" class="md jw hh lz b fi me mf l mg mh">const respondSkus = (conv, body) =&gt; {<br/>    const skus = body.skus || [];<br/>    if (skus.length &gt; 0) {<br/>        const list = {<br/>            title: "Products",<br/>            items: {}<br/>        };<br/>        skus.forEach(sku =&gt; {<br/>            const key = `${sku.skuId.skuType},${sku.skuId.id}`;<br/>            const description = sku.description;<br/>            const price = sku.formattedPrice;<br/>            list.items[key] = {<br/>                title: sku.title,<br/>                description: `${description} | ${price}`<br/>            };<br/>        });<br/>        list.items["cancel"] = {<br/>            title: "Cancel",<br/>            description: "Cancel purchase"<br/>        };<br/>        conv.ask("Which product do you want to order?");<br/>        conv.ask(new List(list));<br/>    } else {<br/>        conv.ask("No products.");<br/>    }<br/>};</span></pre><p id="f733" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在上面的代码中，您用<code class="du mj mk ml lz b">List</code>可视组件构建了一个响应。列表中的每个项目都有一个标识每个产品的键。密钥由两个元素组成:SKU类型和SKU ID。</p><p id="c540" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">带有上述三个辅助函数的意图处理函数如下:</p><pre class="lo lp lq lr fd ly lz ma mb aw mc bi"><span id="4764" class="md jw hh lz b fi me mf l mg mh">app.intent("Gather information", conv =&gt; {<br/>    const SCREEN_OUTPUT = 'actions.capability.SCREEN_OUTPUT';<br/>    if (!conv.surface.capabilities.has(SCREEN_OUTPUT)) {<br/>        conv.ask("Sorry, try this on a screen device or " +<br/>            "select the phone surface in the simulator.");<br/>            return;<br/>    }<br/>    return new Promise((resolve, reject) =&gt; {<br/>        createJwtClient().authorize((err, tokens) =&gt; {<br/>            if (err) {<br/>                reject(`Auth error: ${err}`);<br/>            } else {<br/>                getSkus(tokens, conv).then(body =&gt; {<br/>                    respondSkus(conv, body);<br/>                    resolve();<br/>                }).catch(err =&gt; {<br/>                    reject(`API request error: ${err}`);<br/>                });<br/>            }<br/>        });<br/>    });<br/>});</span></pre><p id="d14d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你要做的第一件事是检查用户的表面。如果用户的设备没有屏幕，您的操作会拒绝购买请求，并回复代表这种情况的消息。</p><p id="bd89" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果用户的设备支持屏幕，您可以继续购买。你应该有上一部分发布的服务账号密钥JSON文件。您不能使用JSON文件直接访问Actions API。相反，您可以从服务帐户密钥JSON文件中发出一个访问令牌。为此，您需要调用<code class="du mj mk ml lz b">createJwtClient</code>函数结果的<code class="du mj mk ml lz b">authorize</code>函数。如果颁发访问令牌成功，您的操作用<code class="du mj mk ml lz b">getSkus</code>函数获取SKU信息，并用<code class="du mj mk ml lz b">respondSkus</code>函数响应它们。</p><h1 id="6e22" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">完成购买</h1><p id="058c" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">第三，当用户点击列表中的产品时，您需要实现处理程序。在handler函数中，您编写一个代码来请求与本节中的<code class="du mj mk ml lz b">CompletePurchase</code>对象的事务。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mr"><img src="../Images/5cef99fa850ea3c008baeb2b62c1966c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YjVZprZAieSPaigty9OmWg.png"/></div></div></figure><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es ms"><img src="../Images/37f97616697c9fc60014246d8b80d82e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bWxFD92n28b2sEaaNnrxOw.png"/></div></div></figure><p id="ed27" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当用户点击列表中的一项时，Google上的操作会向Dialogflow代理发送一个<code class="du mj mk ml lz b">actions_intent_OPTION</code>事件。您添加一个新的意图来处理Dialogflow控制台上的事件。单击Dialogflow控制台左侧导航菜单上“Intents”菜单项旁边的“+”图标。然后，创建新意向的页面打开。如下所示，在每个字段中填入值:</p><ul class=""><li id="4010" class="ky kz hh ig b ih ii il im ip la it lb ix lc jb mm le lf lg bi translated"><strong class="ig hi">意图名称</strong>:输入“actions.intent.OPTION”。</li><li id="3a23" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated"><strong class="ig hi">事件</strong>:输入“动作_意图_选项”。</li><li id="9478" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated"><strong class="ig hi">履行</strong>:打开网页挂钩。</li></ul><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mn"><img src="../Images/57939590a2ac25f357ffbb9bebd2b8b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lguN0t-5pjGkU3ipsUyWRg.png"/></div></div></figure><p id="034f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">单击“保存”按钮以反映填写的值。</p><p id="2cd4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">好了，让我们开始写处理函数。将以下代码添加到您的履行代码中:</p><pre class="lo lp lq lr fd ly lz ma mb aw mc bi"><span id="aa8c" class="md jw hh lz b fi me mf l mg mh">app.intent("actions.intent.OPTION", (conv, params, option) =&gt; {<br/>    if (option !== "cancel") {<br/>        const [skuType, id] = option.split(",")<br/>        conv.ask(new CompletePurchase({<br/>            skuId: {<br/>                skuType: skuType,<br/>                id: id,<br/>                packageName: packageName<br/>            }<br/>        }));<br/>    } else {<br/>        conv.ask("Canceled");<br/>    }<br/>});</span></pre><p id="56ef" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这段代码检查用户是否点击了“取消”项。如果不是，它从意图处理程序的第三个参数中检索SKU类型和SKU ID，然后响应<code class="du mj mk ml lz b">CompletePurchase</code>对象。您需要为该对象指定三个参数:SKU类型、SKU ID和您的Android应用程序的包名。</p><p id="d330" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在响应了<code class="du mj mk ml lz b">CompletePurchase</code>对象后，Google Assistant向用户显示订单信息，包括价格，并询问用户是否真的购买。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div class="er es mt"><img src="../Images/8cb189476439b86e5cdd72a245108123.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*_j_X3zCMR2rHPoGr_hLd-A.jpeg"/></div></figure><h1 id="3b75" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">描述购买状态</h1><p id="6e8d" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">用户决定是否接受和购买订单。之后，Google上的Actions将<code class="du mj mk ml lz b">actions_intent_COMPLETE_PURCHASE</code>事件发送到您的Dialogflow代理，并显示购买状态。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mu"><img src="../Images/3405509e50f10d16e775c188a10e2f16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OyayTj7nU4bcKKkwUfIclw.png"/></div></div></figure><p id="4429" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您的操作需要确认状态，并需要回复用户来描述购买的状态。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mv"><img src="../Images/024bbf3e13a9031498b750ff1634323f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8jBTABDAAXSNoVzl8Kql5g.png"/></div></div></figure><p id="8f20" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要接收<code class="du mj mk ml lz b">actions_intent_COMPLETE_PIRCHASE</code>事件，请在Dialogflow控制台上创建一个新的意图。单击Dialogflow控制台左侧导航菜单上“Intents”菜单项旁边的“+”图标。然后，创建新意向的页面打开。如下所示，在每个字段中填入值:</p><ul class=""><li id="e0b1" class="ky kz hh ig b ih ii il im ip la it lb ix lc jb mm le lf lg bi translated"><strong class="ig hi">意向名称</strong>:输入“actions . Intent . complete _ PURCHASE”。</li><li id="d4e3" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated"><strong class="ig hi">事件</strong>:输入“actions _ intent _ COMPLETE _ PURCHASE”。</li><li id="5bc7" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated"><strong class="ig hi">履行</strong>:打开webhook。</li></ul><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mn"><img src="../Images/bea3378985f3bdbccd45c69edd5eb7e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cuoEVdn2zZpV2mgwepkvog.png"/></div></div></figure><p id="47f8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">并且，添加下面的代码来处理意图。</p><pre class="lo lp lq lr fd ly lz ma mb aw mc bi"><span id="03c3" class="md jw hh lz b fi me mf l mg mh">app.intent("actions.intent.COMPLETE_PURCHASE", conv =&gt; {<br/>    const arg = conv.arguments.get("COMPLETE_PURCHASE_VALUE");<br/>    console.log("User Decision: " + JSON.stringify(arg));<br/>    if (!arg || !arg.purchaseStatus) {<br/>        conv.close("Purchase failed. Please check logs.");<br/>        return;<br/>    }<br/>    if (arg.purchaseStatus === "PURCHASE_STATUS_OK") {<br/>        conv.close("Purchase completed! You are all set!");<br/>    } else if (arg.purchaseStatus === "PURCHASE_STATUS_ALREADY_OWNED") {<br/>        conv.close("Purchase failed. You have already owned the item.");<br/>    } else if (arg.purchaseStatus === "PURCHASE_STATUS_ITEM_UNAVAILABLE") {<br/>        conv.close("Purchase failed. Item is not available.");<br/>    } else if (arg.purchaseStatus === "PURCHASE_STATUS_ITEM_CHANGE_REQUESTED") {<br/>        conv.close("Purchase failed. Item change requested.");<br/>    } else {<br/>        conv.close("Purchase Failed:" + arg.purchaseStatus);<br/>    }<br/>});</span></pre><p id="bf66" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">购买结果可从<code class="du mj mk ml lz b">conv.arguments.get("COMPLETE_PURCHASE_VALUE")</code>检索。并且您可以通过调用<code class="du mj mk ml lz b">arg.purchaseStatus</code>来获得购买状态。每个值代表每个购买状态，如下所示:</p><ul class=""><li id="989a" class="ky kz hh ig b ih ii il im ip la it lb ix lc jb mm le lf lg bi translated"><strong class="ig hi">采购状态确认</strong>:采购可以完成。</li><li id="bf35" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated"><strong class="ig hi">购买_状态_已拥有</strong>:用户已经购买了该产品。</li><li id="7c46" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated"><strong class="ig hi">PURCHASE _ STATUS _ ITEM _ UNAVAILABLE</strong>:用户尝试购买的商品目前没有。</li><li id="0432" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated"><strong class="ig hi">PURCHASE _ STATUS _ ITEM _ CHANGE _ REQUESTED</strong>:用户决定购买其他东西。</li><li id="1015" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated"><strong class="ig hi">购买_状态_用户_取消</strong>:用户取消了购买流程。</li><li id="7c84" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated"><strong class="ig hi"> PURCHASE_STATUS_ERROR </strong>:交易失败，原因不明。</li><li id="e523" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb mm le lf lg bi translated"><strong class="ig hi">PURCHASE _ STATUS _ UNSPECIFIED</strong>:交易失败，原因不明，状态不明。</li></ul><p id="c220" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在此示例中，您的操作在响应根据每个购买状态决定的消息后结束对话。</p><p id="dfc9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">好，写完所有代码后，将其部署到您的服务器/云服务。</p><h1 id="8f29" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">释放你的阿尔法行动</h1><p id="8981" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">在测试你的动作之前，你需要释放你的动作作为Alpha。单击Google控制台操作左侧导航菜单中的“发布”菜单项。展开“ALPHA”部分，然后单击“提交Alpha”按钮。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mn"><img src="../Images/b0b8359a3308c8fa839e3974188f4061.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kz8Me1N5qg4pZRClVzFW8A.png"/></div></div></figure><p id="fb60" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将打开“协议”页面。选中所有复选框，然后单击“提交”按钮。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mn"><img src="../Images/0f3f951afafa809bfcd28a3b9f570685.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WTZyuAQyI8dTfSNNnZIcLA.png"/></div></div></figure><p id="b024" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此外，您需要应用最新的快照(称为“草稿”)作为测试的目标。单击左侧导航菜单中的“模拟器”菜单，然后单击页面顶部的“更改版本”按钮。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mn"><img src="../Images/86058b0a293a81751b67c2f947fc5f3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qfkoM3dNuXOPjq8WhAKERA.png"/></div></div></figure><p id="a959" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在打开的对话框中，选择“版本-草稿”作为目标版本，然后单击“完成”按钮。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="er es mn"><img src="../Images/e9a78609636e919bca2fc9364ab56421.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PQ0CiRSCGEEqtPozgk2R4Q.png"/></div></div></figure><p id="cfaa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">干得好！一切准备就绪，考验你的行动。</p><h1 id="2b60" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">测试您的行动</h1><p id="56e7" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">现在，您可以测试您的操作。谷歌建议使用Android设备测试数字商品交易。在Android上启动谷歌助手，然后对助手说“与<your_action_name>对话”。</your_action_name></p><figure class="lo lp lq lr fd ls er es paragraph-image"><div class="er es mt"><img src="../Images/cb179bedf0aedd681f7661a39b43544e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*ychPVFKB6kl2iA36FNvTRQ.jpeg"/></div></figure><p id="3e03" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对助理说“收集信息”。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div class="er es mt"><img src="../Images/53560073b4ccaa855d40458ab737d7d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*tSLCDr5vAhuOKBelwWBy2w.jpeg"/></div></figure><p id="5c1a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">点击列表中的“高级(数字商品测试)”。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div class="er es mw"><img src="../Images/50ec3a04e89c11394413d6ded310ffcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*-CP_eWX2RuDiUrpoYDfkHQ.jpeg"/></div></figure><figure class="lo lp lq lr fd ls er es paragraph-image"><div class="er es mw"><img src="../Images/891cafcc95883769399fe2f6a52f66cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*KDiCGP4En2V3ilnJUKQSDA.jpeg"/></div></figure><p id="f150" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">点击“立即购买”建议芯片。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div class="er es mt"><img src="../Images/bb9648634e2ecec4861d18ebe8469911.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*koUvqa-K_0IfxzoUZFuEJQ.jpeg"/></div></figure><p id="cc7f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要完成购买，请将手指放在传感器上或输入密码。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div class="er es mt"><img src="../Images/ab30b9495aeec7ca040f84b1c5e686b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*GL9wuASicGHNrEyvQxyF8Q.jpeg"/></div></figure><p id="3034" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">几十秒钟后，</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div class="er es mt"><img src="../Images/085859b3fe7a6dbaf8fd50ac3b4df00f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*Vmaxclmi2miPQuqSrjo1_A.jpeg"/></div></figure><p id="3a2d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你看到了购物的收据。点击“继续”建议芯片。</p><figure class="lo lp lq lr fd ls er es paragraph-image"><div class="er es mt"><img src="../Images/83cd2cc4065c025629db230066817ba7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*ksU7wWqz_o9OGghyB7iS4A.jpeg"/></div></figure><p id="f5a7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">恭喜你！购买已完成，您的操作收到了<code class="du mj mk ml lz b">PURCHASE_STATUS_OK</code>值。</p><h1 id="9e53" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">下一步行动</h1><p id="92a0" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">最后，您可以用数字商品交易来实现您的操作。也就是说，您已经知道如何使用数字商品交易的简单场景来构建您的操作。</p><p id="45e5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在下一个故事中，我打算描述数字商品交易的其他部分。</p></div></div>    
</body>
</html>