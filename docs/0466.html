<html>
<head>
<title>Local development and testing with on-demand modules</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用按需模块进行本地开发和测试</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/local-development-and-testing-with-fakesplitinstallmanager-57083e1840a4?source=collection_archive---------0-----------------------#2020-02-28">https://medium.com/androiddevelopers/local-development-and-testing-with-fakesplitinstallmanager-57083e1840a4?source=collection_archive---------0-----------------------#2020-02-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/42c66688dff04f70825601a33d4d71b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LQleiZgWDNK4_YlW"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">Header graphic by <a class="hu hv ge" href="https://medium.com/u/224e59676537?source=post_page-----57083e1840a4--------------------------------" rel="noopener" target="_blank">Virginia Poltrack</a></figcaption></figure><div class=""/><p id="7103" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">在过去的几个月里，我一直致力于解决我从那些在应用程序中使用<a class="ae jt" href="https://developer.android.com/guide/app-bundle/dynamic-delivery" rel="noopener ugc nofollow" target="_blank">动态功能模块</a>的开发者那里得到的一些反馈。一个常见的主题是缺乏良好的<strong class="ix hz">测试支持</strong>以及他们的<strong class="ix hz">开发速度</strong>受到必须将工件上传到Play Store才能尝试模块下载和安装流程的影响。</p><figure class="ju jv jw jx fd hj"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="65d8" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">去年，在Android Dev Summit上，我和一些从事Play动态交付的同事给<a class="ae jt" href="https://www.youtube.com/watch?v=Nt8zsxNMFNY&amp;vl=en" rel="noopener ugc nofollow" target="_blank">做了一次演讲</a>，在演讲中，我们梳理了Play核心库中一个名为<code class="du ka kb kc kd b">FakeSplitInstallManager</code>的新功能，该功能使得在本地执行一些操作成为可能，比如安装按需模块。</p><p id="7b1c" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">虽然<code class="du ka kb kc kd b">FakeSplitInstallManager</code>类已经推出有一段时间了(从Play Core 1.6.4开始)，但它花了一些时间来让开发者体验正确，并对<code class="du ka kb kc kd b"><a class="ae jt" href="https://developer.android.com/studio/command-line/bundletool" rel="noopener ugc nofollow" target="_blank">bundletool</a></code>进行自动化过程所需的最终更改。</p><p id="51d0" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">今天，您可以在我们的一个新样品中了解它的工作原理:</p><div class="hg hh ez fb hi ke"><a href="https://github.com/android/app-bundle-samples/tree/master/DynamicFeatureNavigation" rel="noopener  ugc nofollow" target="_blank"><div class="kf ab dw"><div class="kg ab kh cl cj ki"><h2 class="bd hz fi z dy kj ea eb kk ed ef hx bi translated">Android/应用捆绑包-示例</h2><div class="kl l"><h3 class="bd b fi z dy kj ea eb kk ed ef dx translated">了解如何使用动态功能模块导航。此示例展示了动态功能的以下用途…</h3></div><div class="km l"><p class="bd b fp z dy kj ea eb kk ed ef dx translated">github.com</p></div></div><div class="kn l"><div class="ko l kp kq kr kn ks ho ke"/></div></div></a></div><p id="981d" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">以前，每当我们发布展示可下载动态功能模块使用的示例时，我们都必须包含开发人员的说明，以便<br/> 1)更改示例应用程序的包名，<br/> 2)在您的Play Console帐户上创建一个应用程序条目，<br/> 3)将包上传到<a class="ae jt" href="https://support.google.com/googleplay/android-developer/answer/9303479?hl=en" rel="noopener ugc nofollow" target="_blank">内部应用程序共享</a>或内部测试轨道…如果您只是想体验使用API，这非常麻烦！</p><p id="cdb9" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated"><strong class="ix hz">如果您只是想快速地使用这个示例，看看它在本地是如何工作的，那么以上所有这些都不再需要了。</strong></p><p id="0113" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">这要归功于<a class="ae jt" href="https://github.com/google/bundletool/releases" rel="noopener ugc nofollow" target="_blank"> bundletool版本0.13.0 </a>中新增的一个<code class="du ka kb kc kd b">--local-testing</code>标志。</p><p id="c5a4" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">当应用于<code class="du ka kb kc kd b">bundletool build-apks</code>命令时，该标志指示<code class="du ka kb kc kd b">bundletool</code>向生成的APK清单添加一小块元数据。然后，您可以通过两个简单的步骤来使用它:</p><ul class=""><li id="c7b9" class="kt ku hy ix b iy iz jc jd jg kv jk kw jo kx js ky kz la lb bi translated">用<code class="du ka kb kc kd b">bundletool install-apks</code>在测试设备(或模拟器)上安装你的应用。这将触发所有剥离apk到设备存储位置的额外推送。</li><li id="6add" class="kt ku hy ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">运行应用程序，使用常用的工厂方法<code class="du ka kb kc kd b"><a class="ae jt" href="https://developer.android.com/reference/com/google/android/play/core/splitinstall/SplitInstallManagerFactory" rel="noopener ugc nofollow" target="_blank">SplitInstallManagerFactory.create(Context)</a></code>创建一个<code class="du ka kb kc kd b"><a class="ae jt" href="https://developer.android.com/reference/com/google/android/play/core/splitinstall/SplitInstallManager" rel="noopener ugc nofollow" target="_blank">SplitInstallManager</a></code>。</li></ul><p id="1782" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">返回的实例现在自动检测本地测试元数据的存在，并在幕后使用<code class="du ka kb kc kd b">FakeSplitInstallManager</code>，从本地文件安装请求的模块，而不是从Play下载。<strong class="ix hz">您必须使用Play Core 1.6.5或更高版本才能自动执行此操作。</strong></p><p id="304a" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">为了使它更简单，我在示例中添加了一个新的Gradle任务，以简化我提到的bundletool命令的运行:</p><pre class="ju jv jw jx fd lh kd li lj aw lk bi"><span id="dbb7" class="ll lm hy kd b fi ln lo l lp lq">./gradlew installApkSplitsForTestDebug</span></pre><p id="424b" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">不幸的是，这一功能仍然无法从Android Studio GUI或直接从Gradle的Android插件中获得。您在这里看到的任务只是一个快速的破解，相当于在您的项目上运行以下命令:</p><pre class="ju jv jw jx fd lh kd li lj aw lk bi"><span id="f70d" class="ll lm hy kd b fi ln lo l lp lq">./gradlew bundleDebug</span><span id="87d9" class="ll lm hy kd b fi lr lo l lp lq">bundletool build-apks --overwrite <strong class="kd hz">--local-testing</strong> --bundle <em class="ls">path/to/bundle.aab</em> --output <em class="ls">path/to/apkset.apks</em></span><span id="7661" class="ll lm hy kd b fi lr lo l lp lq">bundletool install-apks --apks <em class="ls">path/to/apkset.apks</em></span></pre><blockquote class="lt lu lv"><p id="3b72" class="iv iw ls ix b iy iz ja jb jc jd je jf lw jh ji jj lx jl jm jn ly jp jq jr js ha bi translated"><em class="hy">如果你想知道我是如何添加这些任务的，看看</em> <a class="ae jt" href="https://github.com/android/app-bundle-samples/blob/master/DynamicFeatureNavigation/app/build.gradle.kts#L65" rel="noopener ugc nofollow" target="_blank"> <em class="hy">构建脚本源码</em> </a> <em class="hy">。</em> <strong class="ix hz"> <em class="hy">更新:看看</em> </strong> <a class="ae jt" href="https://github.com/android/app-bundle-samples/tree/main/PlayCoreKtx#usage" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hz"> <em class="hy">我们更新的PlayCoreKTX示例</em> </strong> </a> <strong class="ix hz"> <em class="hy">看看它是如何使用新的Android Gradle插件API完成的。</em>T29】</strong></p></blockquote></div><div class="ab cl lz ma go mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ha hb hc hd he"><p id="945d" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated"><strong class="ix hz">请注意</strong>:不是所有的<code class="du ka kb kc kd b">SplitInstallManager</code>功能都在本地测试模式下或者直接调用<code class="du ka kb kc kd b">FakeSplitInstallManager</code>时实现(比如写测试时)。</p><p id="062b" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">您可以:</p><ul class=""><li id="5b9c" class="kt ku hy ix b iy iz jc jd jg kv jk kw jo kx js ky kz la lb bi translated">请求、监控和取消模块/语言安装。</li><li id="9867" class="kt ku hy ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated"><a class="ae jt" href="https://developer.android.com/guide/playcore/testing-fakesplitinstallmanager#FakeSplitInstallManager" rel="noopener ugc nofollow" target="_blank">处理安装错误</a>。</li><li id="53ee" class="kt ku hy ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">使用<a class="ae jt" href="https://developer.android.com/reference/com/google/android/play/core/splitcompat/SplitCompat" rel="noopener ugc nofollow" target="_blank"> SplitCompat </a>立即访问模块。</li><li id="025e" class="kt ku hy ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">使用<a class="ae jt" href="https://developer.android.com/reference/com/google/android/play/core/ktx/package-summary" rel="noopener ugc nofollow" target="_blank"> Play Core KTX </a> (Kotlin扩展)。</li></ul><p id="c1af" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">由于技术限制，不支持什么(例如，我们目前没有计划添加此功能):</p><ul class=""><li id="1b16" class="kt ku hy ix b iy iz jc jd jg kv jk kw jo kx js ky kz la lb bi translated">正在卸载模块。</li><li id="af31" class="kt ku hy ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">请求延期安装/卸载。</li><li id="94f6" class="kt ku hy ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">为大型模块启动确认对话框<a class="ae jt" href="https://developer.android.com/guide/playcore#obtain_confirmation" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="bc22" class="kt ku hy ix b iy lc jc ld jg le jk lf jo lg js ky kz la lb bi translated">多个安装会话正在运行。</li></ul><p id="365b" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">如需进一步阅读，请参考更新的<a class="ae jt" href="https://developer.android.com/guide/playcore/testing-fakesplitinstallmanager" rel="noopener ugc nofollow" target="_blank">文档</a>。</p></div><div class="ab cl lz ma go mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ha hb hc hd he"><p id="9b12" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">顺便说一下，我在本文中链接的<a class="ae jt" href="https://github.com/android/app-bundle-samples/tree/master/DynamicFeatureNavigation" rel="noopener ugc nofollow" target="_blank">示例</a>展示了我与<a class="hu hv ge" href="https://medium.com/u/65fe4f480b1c?source=post_page-----57083e1840a4--------------------------------" rel="noopener" target="_blank"> Ben Weiss </a>一起工作的另一个库，当使用<a class="ae jt" href="https://developer.android.com/guide/navigation" rel="noopener ugc nofollow" target="_blank">导航架构组件</a>时，它可以更容易地将按需模块集成到您的应用程序中。</p><p id="17f4" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">动态特性导航器是基本导航库之上的一个扩展，它允许您定义来自动态特性模块的导航目的地(例如片段、活动)。</p><p id="2fa9" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">如果模块可以按需安装，那么库会使用Play Core API下载并安装它，甚至提供一个默认的进度UI。同时，它可以根据您的需要进行定制。您可以在新的<a class="ae jt" href="https://developer.android.com/guide/navigation/navigation-dynamic" rel="noopener ugc nofollow" target="_blank">文档页面</a>中了解更多信息。</p><p id="dcaa" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js ha bi translated">该库目前处于alpha版本，我们欢迎您的反馈。</p></div></div>    
</body>
</html>