# Bagan:ä½¿ç”¨ Kubernetes å¯¹ Gradle é¡¹ç›®è¿›è¡Œè‡ªåŠ¨åŒ–å®éªŒ

> åŸæ–‡ï¼š<https://medium.com/google-developer-experts/bagan-automate-experimentations-on-gradle-projects-with-kubernetes-a9eec002419c?source=collection_archive---------4----------------------->

![](img/b7049334d187317651244e3c0a4af1e1.png)

Bagan æ˜¯ä¸€ä¸ªå®éªŒæ€§æ¡†æ¶ï¼Œç”¨äºä½¿ç”¨ Kubernetes è‡ªåŠ¨æ‰§è¡Œå’Œæ”¶é›† Gradle é¡¹ç›®çš„æ„å»ºä¿¡æ¯:

[](https://github.com/cdsap/Bagan) [## cdsap/Bagan

### Bagan æ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œæœ‰åŠ©äºè‡ªåŠ¨æ‰§è¡Œï¼ŒæŠ¥å‘Šå’Œæ”¶é›†ä¸åŒç±»å‹çš„æ•°æ®â€¦

github.com](https://github.com/cdsap/Bagan) 

# **ä»€ä¹ˆé—®é¢˜è§£å†³äº†ï¼Ÿ**

å‡ ä¸ªæœˆå‰ï¼Œæˆ‘æƒ³æ¯”è¾ƒä¸€ä¸‹ Android é¡¹ç›®ä¸­ [R8](https://android-developers.googleblog.com/2018/11/r8-new-code-shrinker-from-google-is.html) å’Œ Proguard çš„å½±å“ã€‚æˆ‘å¼€å§‹ä½¿ç”¨ [Gradle Profiler](https://github.com/gradle/gradle-profiler) ï¼Œç„¶åä½¿ç”¨ [Talaiot](https://github.com/cdsap/Talaiot) æ¥æŠ¥å‘Šæ•°æ®ã€‚æˆ‘çš„é—®é¢˜æ˜¯æˆ‘çš„ä¸ªäººç¬”è®°æœ¬ç”µè„‘(8gb)ä¸Šçš„èµ„æºæœ‰é™ï¼Œä»¥åŠæˆ‘å¿…é¡»ç­‰å¾…æ£€æŸ¥ç»“æœçš„æ—¶é—´ã€‚æˆ‘æ¢ç´¢äº†ä¸€äº›å…¸å‹çš„ CI é€‰é¡¹ï¼Œåè°ƒäº†ä¸åŒåˆ†æ”¯ä¸­çš„å˜åŒ–ï¼Œä½†æˆ‘æœ€ç»ˆæå‡ºäº†ä¸€ä¸ªæ›´çµæ´»çš„å®šåˆ¶è§£å†³æ–¹æ¡ˆã€‚

å¦ä¸€ä¸ªéœ€è¦è§£å†³çš„é—®é¢˜æ˜¯ä» StackOverflow/Twitter ä¸Šå¤åˆ¶ç²˜è´´å…¸å‹çš„é­”æ³•å±æ€§æ¥åŠ é€Ÿæˆ‘ä»¬çš„æ„å»ºã€‚æˆ‘ä»¬çš„é…ç½®ä¸­çš„å†³ç­–åº”è¯¥ç”±åº¦é‡/æ•°æ®é©±åŠ¨å’Œæ”¯æŒï¼Œå¹¶ä¸”åº”è¯¥åŒ¹é…ä¸åŒçš„å¼€å‘ç¯å¢ƒã€‚

è¿™å°±æ˜¯ Bagan è¯ç”Ÿçš„åŸå› ï¼Œå®ƒæä¾›:

*   ä¾èµ–äº Kubernetes Engine ç­‰ç¯å¢ƒæä¾›çš„åŸºç¡€è®¾æ–½çš„å¯æ‰©å±•è§£å†³æ–¹æ¡ˆã€‚
*   å®éªŒçš„å¿«é€Ÿåé¦ˆã€‚
*   ä¸éœ€è¦å®¢æˆ·ç«¯åœ¨å­˜å‚¨åº“ä¸­è¿›è¡Œé¢å¤–çš„é…ç½®ã€‚
*   å¯æ‰©å±•åˆ°å…¶ä»–äº‘è§£å†³æ–¹æ¡ˆã€‚
*   æ”¯æŒç§æœ‰å­˜å‚¨åº“ã€‚

![](img/1a127e63b480ef8577b52086ab7a91a6.png)

# **æ‰§è¡Œè’²ç”˜**

ä¸€æ—¦ä¸‹è½½äº†å­˜å‚¨åº“ï¼Œå°±éœ€è¦è®¾ç½®`bagan_conf.json`ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥åŒ…å«ä¸åŒçš„å±æ€§ï¼Œæ¯”å¦‚æ‚¨æƒ³è¦åº”ç”¨çš„å®éªŒç±»å‹ã€ç›®æ ‡å­˜å‚¨åº“æˆ–è€…æ‚¨æƒ³è¦åœ¨ Kubernetes ç¯å¢ƒä¸­ä½¿ç”¨çš„èµ„æºã€‚

Bagan é€šè¿‡éµå¾ªä¸‹ä¸€æ ¼å¼çš„`./bagan`å‘½ä»¤æ‰§è¡Œ:

`./bagan MODE COMMAND`

Bagan åœ¨ Kubernetes ç¯å¢ƒä¸­è¿›è¡Œå®éªŒã€‚å¯¹äºæ¯ä¸ªå®éªŒï¼ŒBagan å°†åˆ›å»ºä¸€ä¸ª Helm ç‰ˆæœ¬ï¼Œå®ƒå°†è¿è¡Œåº”ç”¨å®éªŒçš„ç›®æ ‡å­˜å‚¨åº“çš„æ„å»ºã€‚

ä¸ºäº†æŠ¥å‘Šæ„å»ºçš„ä¿¡æ¯ï¼ŒBagan å°†åœ¨é¡¹ç›®çš„ Gradle é…ç½®ä¸­æ³¨å…¥ [Talaiot](https://github.com/cdsap/Talaiot) å¹¶æ”¶é›†æ•°æ®ï¼Œä½¿ç”¨ InfluxDb ä½œä¸ºæ—¶é—´åºåˆ—æ•°æ®åº“ï¼Œä½¿ç”¨ Grafana ä½œä¸ºä»ªè¡¨æ¿å¯è§†åŒ–å·¥å…·ã€‚Bagan å¯ä»¥éƒ¨ç½²ä¸€ä¸ªæ–°çš„é›†ç¾¤æˆ–è€…ä½¿ç”¨ä¸€ä¸ªç°æœ‰çš„é›†ç¾¤æ¥æ‰§è¡Œåœ¨ä¸» conf æ–‡ä»¶ä¸­å®šä¹‰çš„å®éªŒã€‚

ç¤ºä¾‹`bagan_conf.json`:

```
{
   "bagan": {
      "repository": "[https://github.com/android/plaid](https://github.com/android/plaid)",
      "gradleCommand": "./gradlew clean :assembleDebug",
      "clusterName": "bagan",
      "machine": "n2-standard-2",
      "zone": "asia-southeast1-b",
      "private": false,
      "ssh": "",
      "known_hosts": "",
      "iterations": 20,
      "experiments": {
         "properties": [
            {
               "name": "org.gradle.jvmargs",
               "options": ["-Xmx2g","-Xmx4g","-Xmx6g"]
            }
         ]
      }
   }
}
```

è¯¥é…ç½®å°†åœ¨å·²é…ç½®çš„å­˜å‚¨åº“ä¸­ä¸º Gradle å±æ€§`org.gradle.jvmargs`åˆ›å»ºä¸‰ä¸ªä¸åŒçš„å®éªŒï¼Œå…¶å€¼ä¸ºâ€œ-Xmx2gâ€ã€â€œ-Xmx4gâ€å’Œâ€œ-Xmx6gâ€ã€‚

**æ¨¡å¼**

Bagan ä½¿ç”¨æ¨¡å¼æ¥ç¡®å®š Kubernetes å°†ç”¨æ¥è®¾ç½®é…ç½®å’Œæ‰§è¡Œå®éªŒçš„ç¯å¢ƒã€‚

å½“å‰æ”¯æŒçš„æ¨¡å¼æœ‰:

*   gcloud:å®ƒä½¿ç”¨äº† Google Cloud çš„ Kubernetes å¼•æ“è§£å†³æ–¹æ¡ˆã€‚å®ƒéœ€è¦å®‰è£…`[gcloud](https://cloud.google.com/sdk/)` [sdk](https://cloud.google.com/sdk/) ã€‚`gcloud`å·¥å…·å°†è¯¢é—®è¿è¡Œé›†ç¾¤æ‰€é€‰æ‹©çš„è´¦æˆ·å’Œé¡¹ç›® idã€‚
*   gcloud_docker:å®ƒä½¿ç”¨äº† Kubernetes å¼•æ“è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯`gcloud`çš„æ‰€æœ‰å¿…è¦é…ç½®éƒ½å°è£…åœ¨ä¸€ä¸ªåä¸º`cdsap/bagan-init`çš„ docker æ˜ åƒä¸­ã€‚å¦‚æœæ‚¨ä¸æƒ³å®‰è£…é¢å¤–çš„ sdkï¼Œè¯·ä½¿ç”¨æ­¤é€‰é¡¹ã€‚
*   ç‹¬ç«‹:å¦‚æœæ‚¨å·²ç»ç”¨ä¸€ä¸ªç°æœ‰çš„é›†ç¾¤åœ¨æœ¬åœ°é…ç½®äº†`kubectl`å®¢æˆ·æœºï¼Œé‚£ä¹ˆä½¿ç”¨è¿™ä¸ªæ¨¡å¼ï¼Œç‹¬ç«‹äºç¯å¢ƒã€‚å¦‚æœä½ æƒ³åœ¨æœ¬åœ°æµ‹è¯• Bagan(å¹¶ä¸”ä½ æœ‰è¶³å¤Ÿçš„æœºå™¨èµ„æº)ï¼Œä½ å¯ä»¥ä½¿ç”¨ [Minikube](https://github.com/kubernetes/minikube) ã€‚

**å‘½ä»¤**

ä¸€æ—¦æˆ‘ä»¬é€‰æ‹©äº†æ¨¡å¼ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šæˆ‘ä»¬æƒ³è¦åœ¨ Bagan ä¸­æ‰§è¡Œå“ªä¸ªå‘½ä»¤ã€‚æœ‰ä¸¤ç»„ä¸»è¦çš„å‘½ä»¤:

*   å…ƒå‘½ä»¤:æä¾›å®Œæ•´çš„ Bagan æ‰§è¡Œçš„å‘½ä»¤ã€‚å®ƒå¯èƒ½åŒ…å«å¤šä¸ªå•ä¸€å‘½ä»¤ã€‚
*   å•ä¸ªå‘½ä»¤:ä»£è¡¨è¦åœ¨ Bagan ä¸­æ‰§è¡Œçš„å•ä¸ªåŠ¨ä½œçš„å‘½ä»¤ã€‚

![](img/9a513f7db9edff02a3a7a3ead32f7e67.png)

å…ƒ/å•ä¸ªå‘½ä»¤çš„ç¤ºä¾‹:

*   `./bagan gcloud cluster`:ç”¨ gcloud åˆ›å»ºé›†ç¾¤ï¼Œåœ¨é›†ç¾¤ä¸­åˆ›å»ºåŸºç¡€è®¾æ–½(Grafanaï¼ŒInfluxDbï¼Œservices)å¹¶æ‰§è¡Œå®éªŒã€‚
*   `./bagan gcloud_docker experiment`:ä½¿ç”¨`bagan_conf.json`æä¾›çš„é…ç½®æ‰§è¡Œ gcloud Docker é•œåƒè§¦å‘çš„å®éªŒ
*   `./bagan standalone experiment`:æ‰§è¡Œä¸»æœºé…ç½®çš„`kubectl`ä¸­çš„å®éªŒã€‚
*   `./bagan gcloud_docker remove_experiments`:ä½¿ç”¨ Gcloud Docker åˆ é™¤é›†ç¾¤ä¸­ä»¥å‰çš„å®éªŒ

ç‚¹å‡»æŸ¥çœ‹æ›´å¤šå¯ç”¨å‘½ä»¤çš„ç»†èŠ‚ã€‚

**å®éªŒ**

ä¸€ä¸ªå®éªŒæ˜¯ä¸€ä¸ªä»£è¡¨ç›®æ ‡å­˜å‚¨åº“çš„ç‰¹å®šçŠ¶æ€çš„å®ä½“ã€‚æ­¤çŠ¶æ€ä¸ç”Ÿæˆç³»ç»Ÿæˆ–æ§åˆ¶ç‰ˆæœ¬ç³»ç»Ÿçš„ä¸åŒé…ç½®ç›¸å…³ã€‚

ç›®å‰ï¼ŒBagan æ”¯æŒä¸‰ç§ä¸åŒç±»å‹çš„å®éªŒ:

*   Gradle Properties:ä¸º Gradle å±æ€§æŒ‡å®šä¸åŒçš„å€¼ã€‚
*   Gradle åŒ…è£…ç‰ˆæœ¬:æŒ‡å®šåŒ…è£…çš„ä¸åŒç‰ˆæœ¬ã€‚
*   åˆ†æ”¯:ä¸ºå®éªŒæŒ‡å®šä¸åŒçš„åˆ†æ”¯ã€‚

ä¸ºäº†åŒ…å«å®éªŒï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨`bangan_conf.json`:

```
"experiments": {
        "properties": [
            {
               "name": "org.gradle.jvmargs",
               "options": ["-Xmx3g","-Xmx4g"]
            }
         ],
         "branch": [ "develop","master"]
      }
```

åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒKotlin ç±»`BaganGenerator.kt`å°†è®¡ç®—é…ç½®ä¸­åŒ…å«çš„å®éªŒç±»å‹çš„ä¸åŒç»„åˆã€‚å¯¹äºä¸Šè¿°ç¤ºä¾‹ï¼Œç»„åˆä¸º:

*   `org.gradle.jvmargs="-Xmx3g"`å¹¶æå‘å±•
*   `org.gradle.jvmargs="-Xmx3g"`å’Œåˆ†å±€å±€é•¿
*   `org.gradle.jvmargs="-Xmx4g"`å¹¶æå‘å±•
*   `org.gradle.jvmargs="-Xmx4g"`å’Œåˆ†å…¬å¸ä¸»

ç¨åï¼Œåœ¨â€œ **Pod å®éªŒæ‰§è¡Œâ€**éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»å®éªŒçš„å†…éƒ¨å·¥ä½œæ–¹å¼ã€‚

**ä»ªè¡¨æ¿**

ä¸€æ—¦æ‰§è¡Œå®Œæˆï¼Œæ‚¨å¯ä»¥åœ¨ç”Ÿæˆçš„ Grafana å®ä¾‹ä¸Šæ£€æŸ¥ç»“æœã€‚

å¯¹äºæ¯æ¬¡æ‰§è¡Œï¼ŒBagan éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå¸¦æœ‰é…ç½®å‚æ•°çš„ä»ªè¡¨æ¿:

![](img/2ea3bcb87a07423c1b5430a23499fbee.png)

åœ¨æ‰§è¡Œå®éªŒä¹‹å‰ï¼Œåˆ›å»º Grafana å’Œ InfluxDb çš„éƒ¨ç½²ã€‚Grafana çš„å‘å¸ƒåŒ…æ‹¬ä¸€ä¸ªä¸º InfluxDb æä¾›çš„æ•°æ®æºã€‚ç¨åï¼Œä¼šç”Ÿæˆä¸€ä¸ªç”±`bagan_conf.json`æä¾›é…ç½®çš„ä»ªè¡¨æ¿ã€‚ä»ªè¡¨æ¿åŒ…å«äº”ä¸ªé¢æ¿:

*   å®éªŒå‘½ä»¤ç»„å›¾è¡¨ã€‚
*   æ‰€é…ç½®å‘½ä»¤çš„å®éªŒç™¾åˆ†æ¯”(80%)ã€‚
*   å®éªŒå’Œå‘½ä»¤çš„æœ€å°æ„å»ºæ—¶é—´ã€‚
*   å®éªŒèµ¢å®¶ã€‚
*   å…³äºå®éªŒçš„ä¿¡æ¯ã€‚

è¦è®¿é—®ä»ªè¡¨æ¿ï¼Œæ‚¨å¿…é¡»è®¿é—®:

`[http://IP:3000/d/IS3q0sSWz](http://IP:3000/d/IS3q0sSWz)`

è¦æ£€ç´¢ IPï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Bagan å‘½ä»¤:

`./bagan gcloud grafana_dashboard`

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·å’Œå¯†ç æ˜¯ admin/adminã€‚

æ­¤å¤–ï¼Œæ‚¨å¯ä»¥åœ¨ Grafana ä¸­åˆ›å»ºæ‚¨çš„é¢æ¿ã€‚å®ƒéµå¾ª Talaiot ä¸­ä½¿ç”¨çš„ç›¸åŒæ–¹æ¡ˆï¼Œå³ä¸»è¦ç‚¹`build`å’Œ`task`:

![](img/0ad16a2b3d4aabf69ff8e292ce49b39f.png)

# è’²ç”˜å†…éƒ¨

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨è’²ç”˜çš„ä¸€äº›å†…éƒ¨æ¦‚å¿µã€‚å¦‚æœæ‚¨æƒ³æ›´æ·±å…¥åœ°æ¢ç´¢ï¼ŒGithub å­˜å‚¨åº“åŒ…å«æ›´è¯¦ç»†çš„ä¿¡æ¯ã€‚

**Kubernetes åŸºç¡€è®¾æ–½**

ç‹¬ç«‹äºæ‰€é€‰æ‹©çš„ç¯å¢ƒï¼Œåº“è´å†…ç‰¹æ–¯çš„è’²ç”˜çš„ä¸€èˆ¬åŸºç¡€è®¾æ–½æ˜¯:

![](img/7ba68f66dca1a2fcf247ec5574458d47.png)

ä¸ºäº†åˆ›å»º Grafana å’Œ InfluxDb çš„å®ä¾‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ Kubernetes åŒ…ç®¡ç†å™¨ [Helm](https://github.com/helm/helm) ã€‚Helm ä¹Ÿç”¨äºåœ¨ Kubernetes åˆ›å»ºå®éªŒã€‚

åœ¨æ¨¡å¼`gcloud`å’Œ`gcloud_docker`çš„æƒ…å†µä¸‹ï¼Œåˆ›å»ºé¢å¤–çš„é›†ç¾¤è§’è‰²ç»‘å®šå¯¹è±¡ä¾›èˆµæ‰‹/èˆµä½¿ç”¨ã€‚

å¯¹äº`gcloud`å’Œ`standalone`ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`kubectl`ä½œä¸ºå‘½ä»¤è¡Œç•Œé¢æ¥è¿è¡Œé’ˆå¯¹ Kubernetes é›†ç¾¤çš„å‘½ä»¤:

![](img/a60b0ec50279c8f26d8eb9cdd1279b18.png)

æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è°·æ­Œäº‘æ§åˆ¶å°ï¼Œ[https://console.cloud.google.comï¼Œ](https://console.cloud.google.com/)æˆ‘ä»¬æœ‰ä¸€ä¸ªç”¨æˆ·ç•Œé¢æ¥ç®¡ç†é›†ç¾¤:

![](img/bd31fd93bd883d212747b568ca80ceeb.png)

å…³äºèˆµï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸»æœºä¸­ä½¿ç”¨èˆµå‘½ä»¤:

![](img/e48ba54a7efe348b35ddb6e8b3943bf5.png)

**Pod å®éªŒæ‰§è¡Œ**

ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹åˆ°`BaganGenerator.kt`åˆ›å»ºäº†è¦æ‰§è¡Œçš„å®éªŒã€‚æ¯ä¸ªå®éªŒéƒ½ç”Ÿæˆä¸€ä¸ªå…·æœ‰ä»¥ä¸‹ç»“æ„çš„èˆµé‡Šæ”¾:

![](img/adcdeed8ceaa6784fe29bd9248c77702.png)

`values.yaml`åŒ…å« Bagan conf ä¸­æä¾›çš„ä¸å®éªŒå’Œé…ç½®ç›¸å…³çš„ä¿¡æ¯ã€‚

```
**repository**: https://github.com/android/plaid.git
**branch**: master
**configMaps**: configmapexperiment1
**pod**: experiment1
**session**: sessionId
**name**: experiment1
**image**: cdsap/bagan-pod-injector:0.1.6
**command**: ./gradlew assemble
**iterations**: 10
```

`configmapexperimentN.yaml`åŒ…å«ä¸ºå®éªŒè®¡ç®—çš„æ’åˆ—æ•°æ®:

```
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.configMaps }}
  labels:
    app: bagan
    type: experiment
    session: {{ .Values.session }}
data:
  id: {{ .Values.name }}
  properties: |
               org.gradle.jvmargs=-Xmx6g
               org.gradle.workers.max=1
```

æ„å»ºçš„æ‰§è¡Œå‘ç”Ÿåœ¨ç”±`podexperimentN.yaml`åˆ›å»ºçš„ pod å†…éƒ¨ã€‚pod ä½¿ç”¨çš„ Docker å›¾åƒæ˜¯`cdsap/bagan-pod`ã€‚

è¯¥ pod è´Ÿè´£:

*   è·å–ç‰¹å®šå·ä¸­çš„ç›®æ ‡å­˜å‚¨åº“ã€‚
*   åœ¨é¡¹ç›®ä¸­æ³¨å…¥ Talaiot
*   åº”ç”¨ Gradle å±æ€§å’Œ Gradle åŒ…è£…ç‰ˆæœ¬çš„å®éªŒï¼Œè§£ææ¥è‡ªé…ç½®æ˜ å°„çš„æ•°æ®ã€‚
*   æ‰§è¡Œç»™å®š N æ¬¡è¿­ä»£çš„æ„å»º

æ‰§è¡Œæµç¨‹æ˜¯:

![](img/63dfc92833502b1c7512ccd986727680.png)

å½“ Pod è¿è¡Œæ—¶ï¼Œå®ƒå°†æ‰§è¡Œ`ExperimentController.kt`(ä½¿ç”¨ [kscript](https://github.com/holgerbrandl/kscript) )å¼€å§‹åœ¨ä¸» Gradle é…ç½®æ–‡ä»¶(groovy/kts)ä¸­åº”ç”¨ Talaiot:

```
publishers {
    influxDbPublisher {
        dbName = "tracking"
        url = "http://bagan-influxdb.default:8086"
        taskMetricName = "tasks"
        buildMetricName = "build"
    }
}
```

ç¨åï¼Œ`ExperimentController.kt`å°†è§£æé…ç½®å›¾çš„æ•°æ®ï¼Œå¹¶å°†åº”ç”¨ä¸åŒçš„å®éªŒã€‚è¯·æ³¨æ„ï¼Œåœ¨åˆ†æ”¯å®éªŒçš„æƒ…å†µä¸‹ï¼Œå®éªŒå°†åœ¨ Pod ä¸­åº”ç”¨ï¼Œè€Œä¸æ˜¯åœ¨é…ç½®å›¾ä¸­åº”ç”¨ã€‚

åœ¨å®éªŒçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Google Cloud æ§åˆ¶å°ä¸­ä¸å®éªŒç›¸å…³çš„ Pod æ—¥å¿—ä¸­æ£€æŸ¥æ„å»ºçš„è¾“å‡º:

![](img/cfb333354afb76069635935c107337d6.png)

ä»¥åŠå®éªŒæ‰€ç”¨èµ„æºçš„ç»†èŠ‚:

![](img/28c03015a0f74868561df226fc72181c.png)

**æ¨¡å¼è¦æ±‚**

`gcloud`

*   https://stedolan.github.io/jq/
*   g cloud:[https://cloud.google.com/sdk/](https://cloud.google.com/sdk/)
*   k script:[https://github.com/holgerbrandl/kscript](https://github.com/holgerbrandl/kscript)

`gcloud_docker`

*   jq:[https://stedolan.github.io/jq/](https://stedolan.github.io/jq/)
*   https://www.docker.com/

`standalone`

*   https://stedolan.github.io/jq/
*   `kubectl`ç”¨ç°æœ‰é›†ç¾¤é…ç½®

**è’²ç”˜çš„æˆæœ¬**

å¦‚æœæ‚¨ä½¿ç”¨ Google Cloud ä½œä¸º Kubernetes ç¯å¢ƒï¼Œæ‚¨åº”è¯¥è€ƒè™‘è¯•éªŒæˆæœ¬çš„å½±å“ã€‚Android é¡¹ç›®åœ¨å†…å­˜æ¶ˆè€—æ–¹é¢éå¸¸æ˜‚è´µï¼Œå¹¶ä¸”åœ¨æ²¡æœ‰è¶³å¤Ÿå¼ºå¤§çš„æœºå™¨èµ„æºçš„æƒ…å†µä¸‹åˆ›å»ºå¤šä¸ªç»„åˆå°†å¯¼è‡´å®éªŒå¤±è´¥:

![](img/284d67c3cd727de1de5d1b1bd11f0a1c.png)

å¢åŠ æœºå™¨çš„èµ„æºå°†æœ‰åŠ©äºå®éªŒçš„æˆåŠŸæ‰§è¡Œï¼Œä½†å®ƒå¸¦æ¥äº†æ›´å¤šçš„èµ„æºæ¶ˆè€—ï¼Œä¹Ÿå°±æ˜¯é‡‘é’±ã€‚è¯·è®°ä½ï¼Œä¸åŒå®éªŒçš„æ›´å¤šæ’åˆ—å°†äº§ç”Ÿæ›´å¤šçš„è±†èšã€‚ä¾‹å¦‚ï¼Œè¿™ç§é…ç½®:

```
"experiments": {
   "properties": [
      {
         "name": "org.gradle.jvmargs",
         "options": ["-Xmx3g","-Xmx4g"]
      },
      {
         "name": "org.gradle.caching",
         "options": ["true","false"]
      },
   ],
   "branch": [ "develop","master"],
   "gradleWrapperVersion" : ["5.5", 5.4"]
}
```

å°†äº§ç”Ÿ 16 ä¸ªå®éªŒ:

![](img/fb1b09bf0b942b6c0e51d83d27692e57.png)

å¯¹äºåœ¨è’²ç”˜ä½¿ç”¨çš„æœºå™¨æ²¡æœ‰é™åˆ¶ï¼Œå¯¹äºä¸­å°å‹é¡¹ç›®ï¼Œæˆ‘ä»¬æ¨è n2 ç³»åˆ—(æ¯å°æ—¶æˆæœ¬):

![](img/f49ae7df6c6a96a8f6b5ad00bcb528bc.png)

ä½†æ˜¯ï¼Œä½ æƒ³ç”¨å“ªç§ç±»å‹çš„æœºå™¨æ¥åšå®éªŒå–å†³äºä½ è‡ªå·±ã€‚æ‚¨å¯ä»¥åœ¨æ­¤æŸ¥çœ‹æœºå™¨ç±»å‹çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯:

 [## æœºå™¨ç±»å‹|è®¡ç®—å¼•æ“æ–‡æ¡£|è°·æ­Œäº‘

### æ— è®ºæ‚¨çš„ä¼ä¸šæ˜¯åˆšåˆšè¸ä¸Šæ•°å­—åŒ–è½¬å‹ä¹‹æ—…ï¼Œè¿˜æ˜¯å·²ç»èµ°ä¸Šæ•°å­—åŒ–è½¬å‹ä¹‹è·¯ï¼Œè°·æ­Œäº‘çš„è§£å†³æ–¹æ¡ˆâ€¦

cloud.google.com](https://cloud.google.com/compute/docs/machine-types) 

ä¸‹ä¸€ä»½æŠ¥å‘Šæè¿°äº†åœ¨ 20-30 æ¬¡è¿­ä»£ä¸­ï¼Œä½¿ç”¨ 4-16-24-16 æ¬¡å®éªŒæ’åˆ—çš„`n2-standard-8`æœºå™¨æ‰§è¡Œå…­æ¬¡ Bagan:

![](img/738407b35c8e48bb955c23d082d974d7.png)![](img/1b5556d6539e45e8c98ee83175fcb223.png)

***å¦‚æœæ‚¨ä»…ä½¿ç”¨ Google Cloud ä¸º Bagan åˆ›å»ºé›†ç¾¤ï¼Œæˆ‘ä»¬å»ºè®®åœ¨å®éªŒå’Œç»“æœè¯„ä¼°å®Œæˆååˆ é™¤å®ƒã€‚***

![](img/006ecfde39833a7dc4e74cc8debaca09.png)

# ä¾‹å­

ä¸‹é¢çš„ä¾‹å­åªæ˜¯ç®€å•çš„ç”¨ä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ä½ çš„é¡¹ç›®ä¸­è¿›è¡Œå®éªŒã€‚

**ç”¨ä¾‹ 1**

ä¸€ä¸ªåŒ…å«ä¸‰ä¸ªæ¨¡å—çš„ç§æœ‰å­˜å‚¨åº“çš„ç®€å•ä¾‹å­ã€‚

![](img/45565b1215a95ea81fbf42fe5b7c8c49.png)

å°†ç”Ÿæˆä¸¤ä¸ª Gradle å±æ€§ç±»å‹çš„å®éªŒ:

*   -Xmx3g
*   -Xmx4g

ç»“æœ:

![](img/4c3ed7a98f6e37a93f6712a9cbc4df82.png)

**ç”¨ä¾‹ 2**

å°è¯•è°·æ­Œé¡¹ç›®[æ ¼å­](https://github.com/android/plaid)ï¼Œæ¢ç´¢ kapt å±æ€§ã€‚

![](img/6b19aea91bf2722c0809bd820f43a8d5.png)

å°†äº§ç”Ÿ 16 ä¸ªå®éªŒ:

![](img/efa5855bf977973d7201198d49065a91.png)

ç»“æœ:

![](img/c422bc00c5722b59c857a59b94519387.png)

åœ¨ Plaid é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰æ„è¯†åˆ°ä½¿ç”¨åƒ`kapt.incremental.apt`å’Œ`kapt.use.worker.api`è¿™æ ·çš„å±æ€§çš„æ˜¾è‘—å·®å¼‚ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥æ³¨æ„åˆ°åœ¨ Gradle æ„å»ºä¸­ä½¿ç”¨ç¼“å­˜çš„å¥½å¤„ã€‚

**ç”¨ä¾‹ 3**

Igor Wojda å¯¹ Android Showcase é¡¹ç›®çš„å®éªŒğŸ¤–ï¼Œå…·æœ‰ Gradle å±æ€§å’Œä¸åŒçš„ Gradle åŒ…è£…å™¨ç‰ˆæœ¬ã€‚

![](img/bc4b90a246d5d8fa8dbd9e5c2da1cd5a.png)

ç»“æœ:

![](img/6f278dad4c1ddf8a510885a03fae619f.png)

æœ€å¥½çš„æ—¶æœºæ˜¯ä½¿ç”¨æ ¼é›·å°”`5.6.1`ã€‚JVM args å®éªŒä¸­æ²¡æœ‰æ˜¾è‘—çš„å·®å¼‚ã€‚

# åç»­æ­¥éª¤

å­˜å‚¨åº“ä¸­æœ‰æ›´å¤šçš„è¯¦ç»†ä¿¡æ¯ï¼Œæ¯”å¦‚å¦‚ä½•éƒ¨ç½²å®šåˆ¶æ˜ åƒä»¥åŠ Bagan çš„ç”Ÿå‘½å‘¨æœŸæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

æˆ‘ä»¬å¸Œæœ›å¾ˆå¿«æ‰©å±• Baganï¼Œè¿›è¡Œæ›´å¤šç±»å‹çš„å®éªŒï¼Œå¦‚ä¸åŒçš„ Docker æ˜ åƒ(java ç‰ˆæœ¬æ§åˆ¶)ï¼Œåº”ç”¨ abi æ›´æ”¹ï¼Œè¿œç¨‹ç¼“å­˜å’Œå¯¹å¤šä¸ª Gradle å‘½ä»¤çš„æ”¯æŒã€‚

è¯·ç»§ç»­å…³æ³¨ï¼Œå¦‚æœæ‚¨æ„¿æ„ï¼Œæ‚¨å¯ä»¥æŠ•ç¨¿ï¼Œä»¥ä¸‹æ˜¯èµ„æºåº“:

[](https://github.com/cdsap/Bagan) [## cdsap/Bagan

### Bagan æ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œæœ‰åŠ©äºè‡ªåŠ¨æ‰§è¡Œï¼ŒæŠ¥å‘Šå’Œæ”¶é›†ä¸åŒç±»å‹çš„æ•°æ®â€¦

github.com](https://github.com/cdsap/Bagan) 

éå¸¸æ„Ÿè°¢æ‚¨æŠ½å‡ºæ—¶é—´ã€‚

PS:å½“ç„¶ï¼Œå¦‚æœæœ‰æœºä¼šï¼Œå»å‚è§‚ä¸€ä¸‹[è’²ç”˜](https://en.wikipedia.org/wiki/Bagan)ï¼Œæœ€è¿‘è¢«è”åˆå›½æ•™ç§‘æ–‡ç»„ç»‡åˆ—å…¥ä¸–ç•Œé—äº§ã€‚