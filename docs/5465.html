<html>
<head>
<title>Secure your Kubernetes Services using Cert-Manager, NGINX Ingress and Let’s Encrypt</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Cert-Manager、NGINX Ingress和Let's Encrypt保护您的Kubernetes服务</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/secure-your-kubernetes-services-using-cert-manager-nginx-ingress-and-lets-encrypt-888c8b996260?source=collection_archive---------0-----------------------#2018-06-18">https://medium.com/oracledevs/secure-your-kubernetes-services-using-cert-manager-nginx-ingress-and-lets-encrypt-888c8b996260?source=collection_archive---------0-----------------------#2018-06-18</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/8384489b26a37b6f6c55923d5db3fd57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FiUqmlkxMgxT1wb-wBv9AA.jpeg"/></div></div></figure><h1 id="b135" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated"><strong class="ak">简介</strong></h1><p id="1072" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">不可否认，我们生活在微服务和容器的时代。对于正确的用例，大多数组织正在从整体架构转向微服务架构。微服务通过将大型整体应用程序拆分为松散耦合的相互协调的服务，实现了复杂应用程序的快速开发。容器非常适合部署和运行这些微服务。然而，微服务或容器带来了一系列新的挑战。这些挑战在任何分布式架构中都是固有的——从跨服务边界的服务间通信和事务到测试、部署和监控。进入<a class="ae kl" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>。Kubernetes是一个开源编排工具，可以处理部署在容器中的微服务的操作复杂性。它有助于自动化部署、扩展目标服务和容器的一般管理。</p><p id="fb33" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">这一切都很棒，但是请考虑一下:您开发了一个基于微服务的应用程序，并将其部署在Kubernetes集群上。您还在一个面向公众的IP地址上公开了由您的微服务或REST APIs支持的单页面web应用程序。在上线之前，下一个合乎逻辑的步骤是启用HTTPS，并将您的公共IP绑定到您的注册域名。感谢<a class="ae kl" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">让我们加密</a>，现在获得数字证书(免费)和为您的服务和网站启用HTTPS (SSL/TLS)比以往任何时候都更容易。本文将向您介绍在您的公共Kubernetes服务上自动启用TLS所需的配置步骤。</p><h1 id="827f" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated"><strong class="ak">先决条件</strong></h1><p id="8d55" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">要遵循本文中的步骤，您需要以下内容:</p><ul class=""><li id="504a" class="kr ks hh jp b jq km ju kn jy kt kc ku kg kv kk kw kx ky kz bi translated">kubernetes集群版本1.8+在某个地方运行，比如在您选择的云提供商上运行。</li></ul><blockquote class="la lb lc"><p id="a462" class="jn jo ld jp b jq km js jt ju kn jw jx le ko ka kb lf kp ke kf lg kq ki kj kk ha bi translated">无耻的推广:你可以在<a class="ae kl" href="https://cloud.oracle.com/en_US/containers" rel="noopener ugc nofollow" target="_blank"> Oracle Cloud </a>上注册一个免费账户来运行一个Kubernetes引擎(OKE)。</p></blockquote><ul class=""><li id="a544" class="kr ks hh jp b jq km ju kn jy kt kc ku kg kv kk kw kx ky kz bi translated">安装并配置了kube CTL CLI来与您的Kubernetes集群对话。您可以通过运行以下命令快速检查您的当前上下文:</li></ul><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="4be9" class="lq iq hh lm b fi lr ls l lt lu">kubectl config current-context</span></pre><ul class=""><li id="e6a5" class="kr ks hh jp b jq km ju kn jy kt kc ku kg kv kk kw kx ky kz bi translated">一个集群角色绑定，用于将管理权限授予用于运行kubectl命令的用户主体。如果您没有适当的权限，请运行以下命令(替换user_id令牌):</li></ul><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="866a" class="lq iq hh lm b fi lr ls l lt lu">kubectl create clusterrolebinding cluster-admin-binding \<br/>    --clusterrole cluster-admin \<br/>    --user &lt;user_id&gt;</span></pre><ul class=""><li id="56af" class="kr ks hh jp b jq km ju kn jy kt kc ku kg kv kk kw kx ky kz bi translated">在Kubernetes集群中运行的一个或多个服务，其规范类型设置为“ClusterIP”。作为参考，这里有一个示例yaml文件，用于创建名为“my-webapp”的服务:</li></ul><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="ccc2" class="lq iq hh lm b fi lr ls l lt lu">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: my-webapp<br/>  labels:<br/>    app: my-webapp<br/>    tier: frontend<br/>spec:<br/>  type: ClusterIP<br/>  ports:<br/>  — port: 80<br/>    targetPort: 8080<br/>  selector:<br/>    app: my-webapp<br/>    tier: frontend</span></pre><h1 id="28e8" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated"><strong class="ak">第一步:安装舵</strong></h1><p id="dc56" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated"><a class="ae kl" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>是官方的kubernetes原生包经理。您可以使用helm来安装和升级kubernetes应用程序。Helm使用了一个名为charts的概念——描述安装和运行应用程序所需的kubernetes资源的文件集合。如果您是mac/brew用户，请运行以下命令:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="6610" class="lq iq hh lm b fi lr ls l lt lu">brew install kubernetes-helm</span></pre><p id="33fa" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">要在不同的操作系统上或通过其他方式安装Helm，请遵循Helm <a class="ae kl" href="https://docs.helm.sh/using_helm/#installing-helm" rel="noopener ugc nofollow" target="_blank">文档</a>中概述的说明。</p><h1 id="191c" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated"><strong class="ak">第二步:安装舵杆</strong></h1><p id="38ad" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">Tiller是Helm的服务器端组件，通常运行在Kubernetes集群中。出于本文的目的，我们将在启用了<a class="ae kl" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" rel="noopener ugc nofollow" target="_blank"> RBAC </a>的系统名称空间上安装tiller。</p><p id="fb98" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">首先，创建一个用于运行Tiller的服务帐户。使用以下命令:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="3333" class="lq iq hh lm b fi lr ls l lt lu">kubectl create serviceaccount tiller --namespace kube-system</span></pre><p id="16a7" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">接下来，创建一个名为“tiller-clusterrolebinding.yaml”的yaml文件，并向其中添加以下文本:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="9d1e" class="lq iq hh lm b fi lr ls l lt lu">kind: ClusterRoleBinding<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>metadata:<br/>  name: tiller-clusterrolebinding<br/>subjects:<br/>  — kind: ServiceAccount<br/>    name: tiller<br/>    namespace: kube-system<br/>roleRef:<br/>  kind: ClusterRole<br/>  name: cluster-admin<br/>  apiGroup: ""</span></pre><p id="d665" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">现在运行以下命令创建群集角色绑定，并授予“tiller”服务帐户群集范围的管理权限:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="3fa3" class="lq iq hh lm b fi lr ls l lt lu">kubectl create -f tiller-clusterrolebinding.yaml</span></pre><p id="6c5e" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">最后，通过运行以下命令安装Tiller:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="8ee9" class="lq iq hh lm b fi lr ls l lt lu">helm init --service-account tiller</span></pre><p id="b6d2" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">或者，通过运行以下命令并检查其输出，验证Tiller是否已安装并处于服务状态:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="9e50" class="lq iq hh lm b fi lr ls l lt lu">kubectl get pods --namespace kube-system</span></pre><h1 id="fabf" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated"><strong class="ak">步骤3:安装证书管理器</strong></h1><p id="4e89" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated"><a class="ae kl" href="https://cert-manager.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"> Cert-Manager </a>是一个kubernetes本地证书管理器。Cert-Manager提供的最重要的功能之一是它能够自动提供TLS证书。根据Kubernetes入口资源中的注释，证书管理器将代表您的服务与Let's Encrypt和acquire a certificate对话。</p><p id="7d3e" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">运行以下命令安装Cert-Manager:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="59ef" class="lq iq hh lm b fi lr ls l lt lu">helm install \<br/>  --name cert-manager \<br/>  --namespace kube-system \<br/>  --set ingressShim.defaultIssuerName=letsencrypt-staging \<br/>  --set ingressShim.defaultIssuerKind=ClusterIssuer \<br/>  stable/cert-manager \<br/>  --version v0.3.0</span></pre><p id="37a0" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">现在让我们创建一个ClusterIssuer资源。ClusterIssuer代表一个证书颁发机构，如Let's Encrypt，可以从中获取签名证书。至少应有一个ClusterIssuer资源，证书管理器才能开始颁发证书。</p><p id="ba1b" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">首先创建一个名为“letsencrypt-staging.yaml”的yaml文件，并向其中添加以下文本:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="ce2a" class="lq iq hh lm b fi lr ls l lt lu">apiVersion: certmanager.k8s.io/v1alpha1<br/>kind: ClusterIssuer<br/>metadata:<br/>  name: letsencrypt-staging<br/>spec:<br/>  acme:<br/>    # The ACME server URL<br/>    server: <a class="ae kl" href="https://acme-staging-v02.api.letsencrypt.org/directory" rel="noopener ugc nofollow" target="_blank">https://acme-staging-v02.api.letsencrypt.org/directory</a><br/>    # Email address used for ACME registration<br/>    email: &lt;me@example.com&gt;<br/>    # Name of a secret used to store the ACME account private key<br/>    privateKeySecretRef:<br/>      name: letsencrypt-sec-staging<br/>    # Enable HTTP01 validations<br/>    http01: {}</span></pre><p id="90c6" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">用您用来注册域的电子邮件地址替换电子邮件字段的值。请注意，我们已经为这个集群颁发者配置了一个http质询提供程序。你可以在这里阅读更多关于其他挑战的信息<a class="ae kl" href="http://letsencrypt.readthedocs.io/en/latest/challenges.html" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="718f" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">现在，通过运行以下命令创建ClusterIssuer资源:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="1ebe" class="lq iq hh lm b fi lr ls l lt lu">kubectl create -f letsencrypt-staging.yaml</span></pre><blockquote class="la lb lc"><p id="a937" class="jn jo ld jp b jq km js jt ju kn jw jx le ko ka kb lf kp ke kf lg kq ki kj kk ha bi translated">让我们对加密生产服务施加严格的限制。我建议你使用他们的暂存服务来测试一下。准备就绪后，创建一个新的指向生产的cluster issuer:【https://acme-v02.api.letsencrypt.org/directory】T2</p></blockquote><h1 id="b418" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated"><strong class="ak">第四步:安装NGINX入口</strong></h1><p id="154f" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">在Kubernetes的世界中，Ingress是一个管理集群内服务的外部访问的对象。入口资源提供负载平衡和SSL端接。<a class="ae kl" href="https://kubernetes.github.io/ingress-nginx/" rel="noopener ugc nofollow" target="_blank"> NGINX入口</a>控制器基于入口资源。我们将配置这个控制器作为HTTPS负载平衡器，并将请求转发给Kubernetes集群中的特定服务。</p><p id="00d9" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">运行以下命令，将NGINX入口控制器安装到启用RBAC的系统命名空间中:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="7490" class="lq iq hh lm b fi lr ls l lt lu">helm install stable/nginx-ingress \<br/>  --name uck-nginx \<br/>  --set rbac.create=true \<br/>  --namespace kube-system</span></pre><h1 id="868f" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated"><strong class="ak">步骤5:创建入口</strong></h1><p id="583d" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">让我们创建入口资源，并指定一个规则来将请求转发到服务“my-webapp”。我们需要注释资源定义，以便Cert-Manager可以自动从Let's Encrypt获取所需的TLS证书。</p><p id="ab4b" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">首先创建一个名为“my-ingress.yaml”的yaml文件，并向其中添加以下文本:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="c1ea" class="lq iq hh lm b fi lr ls l lt lu">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: my-ingress<br/>  annotations:<br/>    kubernetes.io/ingress.class: nginx<br/>    certmanager.k8s.io/cluster-issuer: letsencrypt-staging<br/>    kubernetes.io/tls-acme: “true”<br/>spec:<br/>  rules:<br/>  — host: app.example.com<br/>    http:<br/>      paths:<br/>      — path: /<br/>        backend:<br/>          serviceName: my-webapp<br/>          servicePort: 80<br/>  tls:<br/>  — secretName: tls-staging-cert<br/>    hosts:<br/>    — app.example.com</span></pre><p id="8e9b" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">现在，作为压轴戏，通过运行以下命令创建入口资源:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="c34f" class="lq iq hh lm b fi lr ls l lt lu">kubectl create -f my-ingress.yaml</span></pre><p id="e0ca" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">坐下来，放松，等待证书管理器开始工作，并为您的域获取证书。完成后，您可以通过HTTPS从互联网访问您的服务。有了上面的样品入口，那将是<a class="ae kl" href="https://app.example.com" rel="noopener ugc nofollow" target="_blank">https://app.example.com</a>。</p><p id="830d" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">如果你有多个子域，如console.example.com，api.example.com等，你可以得到一个通配符证书来简化事情。例如，在上面的yaml中，只需将“*.example.com”指定为“tls”下“hosts”列表中的单个元素。</p><h1 id="5c7c" class="ip iq hh bd ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm bi translated"><strong class="ak">结论</strong></h1><p id="3e55" class="pw-post-body-paragraph jn jo hh jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ha bi translated">使用Cert-Manager、NGINX Ingress和Let's Encrypt简化了安全公开运行在Kubernetes集群上的微服务的过程。</p><p id="7621" class="pw-post-body-paragraph jn jo hh jp b jq km js jt ju kn jw jx jy ko ka kb kc kp ke kf kg kq ki kj kk ha bi translated">就这些了，伙计们。</p><blockquote class="la lb lc"><p id="604f" class="jn jo ld jp b jq km js jt ju kn jw jx le ko ka kb lf kp ke kf lg kq ki kj kk ha bi translated">本文表达的观点是我个人的，不代表我的雇主的观点。</p></blockquote></div></div>    
</body>
</html>