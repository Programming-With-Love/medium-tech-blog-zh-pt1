<html>
<head>
<title>Automate K8s policy checks using Datree, AWS CodeBuild, and Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Datree、AWS CodeBuild和Terraform自动执行K8s策略检查</h1>
<blockquote>原文：<a href="https://medium.com/globant/automate-k8s-policy-checks-using-datree-aws-codebuild-and-terraform-ea3ae76b7277?source=collection_archive---------0-----------------------#2022-06-02">https://medium.com/globant/automate-k8s-policy-checks-using-datree-aws-codebuild-and-terraform-ea3ae76b7277?source=collection_archive---------0-----------------------#2022-06-02</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="563c" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">简介</strong></h1><p id="1a79" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi ka translated"><span class="l kb kc kd bm ke kf kg kh ki di"> G </span> itops是优化Kubernetes集群中应用生命周期的最佳策略之一。它的基础在于以声明的方式定义Git存储库中应用程序和集群配置的期望状态。采用基于<a class="ae kj" href="https://www.weave.works/technologies/gitops/" rel="noopener ugc nofollow" target="_blank"> GitOps practices </a>的部署工作流将使我们受益，包括版本控制、更简单的安全性、审计和合规性控制自动化、更强的稳定性和一致性、更快的部署以及促进协作贡献，等等。</p><blockquote class="kk"><p id="2f57" class="kl km hh bd kn ko kp kq kr ks kt jz dx translated">"手动配置中发生的事情，将保留在手动配置中."“一切如代码是关键，GitOps实践解决方案。”</p></blockquote><p id="399d" class="pw-post-body-paragraph jc jd hh je b jf ku jh ji jj kv jl jm jn kw jp jq jr kx jt ju jv ky jx jy jz ha bi translated">根据具体情况，存储库中的版本化代码可以是Kubernetes在Kustomize、Helm Charts中定义的应用程序，或者仅仅是YAML文件中的清单，这些文件将是GitOps连续交付工具的理想来源，这些工具专注于自动化部署，以确保所需的声明状态。例如，<a class="ae kj" href="https://argo-cd.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> ArgoCD </a>和<a class="ae kj" href="https://fluxcd.io/" rel="noopener ugc nofollow" target="_blank"> FluxCD </a>支持各种有趣的基于分支、标签、文件夹等的多集群和多环境部署策略。</p><p id="a25c" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">在将变更集成到主分支之前，如何保证高代码质量？高代码质量包括遵守安全策略以及语法和语义验证。</p><p id="ef57" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">嗯，我们可以信任…或者更好，我们可以<strong class="je hi">信任，但以自动方式验证</strong>。🚀</p><p id="cae4" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">让我们通过GitOps实践和使用一些GitOps工具来探索一种无限的方法来自动化这些验证。</p></div><div class="ab cl le lf go lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ha hb hc hd he"><p id="776e" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">本文将回顾以下部分:</p><ul class=""><li id="dcfe" class="ll lm hh je b jf kz jj la jn ln jr lo jv lp jz lq lr ls lt bi translated">架构概述</li><li id="dad6" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">先决条件</li><li id="3df1" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">履行</li><li id="f84e" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">考虑</li><li id="dc1c" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">结论</li></ul><h1 id="5729" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">概观</h1><p id="b17f" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">魔术替代品满足以下要求:</p><ul class=""><li id="60a3" class="ll lm hh je b jf kz jj la jn ln jr lo jv lp jz lq lr ls lt bi translated">主分支中包含版本化K8s清单的Git存储库。</li><li id="70db" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">在将新的变更集成到主分支之前，自动验证它们的方法。</li><li id="06d5" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">如果自动验证失败，新的变更就不能集成到主分支中。</li><li id="20a0" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">另外:一种跨多个K8s存储库轻松复制自动化资源的方法</li></ul><figure class="ma mb mc md fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es lz"><img src="../Images/35e6b81a74fe789084804217befe9eb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RvaPVdP098uvbxA_8fKzhw.png"/></div></div><figcaption class="ml mm et er es mn mo bd b be z dx">Diagram of the magic solution</figcaption></figure><p id="e4d3" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">如图所示，该流程包括以下步骤:</p><ol class=""><li id="8404" class="ll lm hh je b jf kz jj la jn ln jr lo jv lp jz mp lr ls lt bi translated">开发人员或操作人员团队基于主分支在Git存储库中创建特性分支，并对K8s清单做出必要的贡献。主分支是一个受保护的分支，所以他们必须创建一个从特性到主分支的拉请求。</li><li id="be40" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz mp lr ls lt bi translated">当PR被创建到主分支时，一个<strong class="je hi"> AWS CodeBuild </strong>项目被触发，它使用<strong class="je hi"> Datree CLI </strong>分析来自特性分支的代码。</li><li id="c4d6" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz mp lr ls lt bi translated">分析结果的详细信息被发送到<strong class="je hi"> Datree </strong>云后端，并显示在策略检查仪表板中。或者您可以简单地在CodeBuild项目日志中查看它们。</li><li id="d213" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz mp lr ls lt bi translated">如果<strong class="je hi"> Datree </strong>策略检查通过，那么<strong class="je hi"> AWS CodeBuild </strong>将返回对PR的成功检查，否则，将返回失败的检查，并且PR不能被合并。</li><li id="31b7" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz mp lr ls lt bi translated">在<strong class="je hi"> AWS </strong>中作为<strong class="je hi"> CodeBuild </strong>项目提供的所有自动化资源已经被抽象到<strong class="je hi"> Terraform模块</strong>中，这将允许我们为任何K8s存储库重用和复制这些配置。</li></ol><p id="c070" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">记住这一点，让我们澄清一下，一些GitOps使用的工具和服务。</p><h2 id="7c28" class="mq if hh bd ig mr ms mt ik mu mv mw io jn mx my is jr mz na iw jv nb nc ja nd bi translated">曼陀罗</h2><p id="a614" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated"><a class="ae kj" href="https://www.datree.io/" rel="noopener ugc nofollow" target="_blank"> Datree </a>是一款专注于验证K8s清单的工具，结合其CLI，我们可以在K8s管道中自动执行策略检查。<a class="ae kj" href="https://hub.datree.io/welcome/how-datree-works" rel="noopener ugc nofollow" target="_blank">验证过程</a>由三个阶段组成:YAML验证、模式验证和策略检查。此外，<a class="ae kj" href="https://hub.datree.io/setup/centralized-policy" rel="noopener ugc nofollow" target="_blank">集中式策略</a>的Datree概念支持使用内置规则甚至我们自己的自定义规则来验证策略。</p><p id="adfd" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">一些类似的备选方案有<a class="ae kj" href="https://github.com/zegl/kube-score" rel="noopener ugc nofollow" target="_blank"> Kube-score </a>、<a class="ae kj" href="https://kubeval.instrumenta.dev/" rel="noopener ugc nofollow" target="_blank"> Kubeval </a>、<a class="ae kj" href="https://www.conftest.dev/" rel="noopener ugc nofollow" target="_blank"> Conftest </a>和<a class="ae kj" href="https://github.com/aquasecurity/trivy" rel="noopener ugc nofollow" target="_blank"> Trivy </a>。</p><h2 id="6dc5" class="mq if hh bd ig mr ms mt ik mu mv mw io jn mx my is jr mz na iw jv nb nc ja nd bi translated">AWS代码构建</h2><p id="55ac" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated"><a class="ae kj" href="https://aws.amazon.com/codebuild/" rel="noopener ugc nofollow" target="_blank"> AWS CodeBuild </a>是AWS DevOps服务，用于在通过CodeBuild项目和git存储库之间的webhook向主受保护分支创建Pull请求时执行Datree验证。</p><p id="67b2" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">根据构建的结果是成功还是失败，CodeBuild本身支持将检查返回到GitHub中的Pull请求。</p><h2 id="7ef7" class="mq if hh bd ig mr ms mt ik mu mv mw io jn mx my is jr mz na iw jv nb nc ja nd bi translated">将（行星）地球化（以适合人类居住）</h2><p id="0001" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">作为“<em class="ne">一切如代码</em>”概念的一部分，为了支持著名的<a class="ae kj" href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" rel="noopener ugc nofollow" target="_blank"> DRY </a>原则，AWS上提供的所有资源都被抽象成了一个<a class="ae kj" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>模块。因此，我们可以为我们所有的K8s仓库复制代码构建项目。作为一个IaC工具，您现在将获得管道代码。🚀</p><h2 id="ccda" class="mq if hh bd ig mr ms mt ik mu mv mw io jn mx my is jr mz na iw jv nb nc ja nd bi translated">Git储存库</h2><p id="4343" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">到目前为止，只提到了K8s清单存储库。这是一个GitHub库。但是，您可以使用AWS CodeBuild 支持的任何源代码<a class="ae kj" href="https://aws.amazon.com/codebuild/faqs/?nc1=h_ls#:~:text=Q%3A%20Which%20source%20repositories%20does%20CodeBuild%20support%3F%20%3E%3E" rel="noopener ugc nofollow" target="_blank">(比如GitHub、GitHub Enterprise、AWS CodeCommit或BitBucket)</a></p><p id="448f" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">同样重要的是，用于提供AWS资源的Terraform模块(主要是执行Datree策略检查的CodeBuild项目)有自己的GitHub存储库。因此，有两个GitHub库:</p><ul class=""><li id="cc39" class="ll lm hh je b jf kz jj la jn ln jr lo jv lp jz lq lr ls lt bi translated"><a class="ae kj" href="https://github.com/Kirmito/k8s-apps" rel="noopener ugc nofollow" target="_blank"> K8s清单库</a></li><li id="2306" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated"><a class="ae kj" href="https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild" rel="noopener ugc nofollow" target="_blank">AWS code build&amp;Datree terra form模块库</a></li></ul><h1 id="bbe7" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">先决条件</h1><ul class=""><li id="d221" class="ll lm hh je b jf jg jj jk jn nf jr ng jv nh jz lq lr ls lt bi translated">Terraform v1.0版或更早版本</li><li id="7241" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">AWS云帐户</li><li id="7d94" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">带有K8S清单的Git存储库。本案中的GitHub回购协议。</li><li id="7499" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated"><a class="ae kj" href="https://docs.aws.amazon.com/codebuild/latest/userguide/access-tokens.html" rel="noopener ugc nofollow" target="_blank">为AWS代码版本配置GitHub认证</a></li><li id="dfbd" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">Datree账户。看看<a class="ae kj" href="https://hub.datree.io/" rel="noopener ugc nofollow" target="_blank">官方数据入门</a>或者直接创建<a class="ae kj" href="https://app.datree.io/login" rel="noopener ugc nofollow" target="_blank">账号</a>。</li></ul><h1 id="c918" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">开始吧！</h1><p id="2901" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">替代解决方案将包含在以下5个步骤中:</p><ol class=""><li id="a87b" class="ll lm hh je b jf kz jj la jn ln jr lo jv lp jz mp lr ls lt bi translated">创建K8s清单库。</li><li id="156c" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz mp lr ls lt bi translated">Datree预配置。</li><li id="f9d4" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz mp lr ls lt bi translated">Terraform模块结构和供应。</li><li id="5c6e" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz mp lr ls lt bi translated">最终的GitHub配置。</li><li id="0f86" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz mp lr ls lt bi translated">一、二、三…开拍！🎬策略检查的结果。</li></ol><h2 id="2173" class="mq if hh bd ig mr ms mt ik mu mv mw io jn mx my is jr mz na iw jv nb nc ja nd bi translated">步骤1:创建K8s清单存储库</h2><p id="b247" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">正如您在<a class="ae kj" href="https://github.com/Kirmito/k8s-apps/tree/main/apps" rel="noopener ugc nofollow" target="_blank">K8s清单存储库结构</a>中看到的，有两个Kubernetes应用程序，它们的清单被声明为YAML文件。</p><pre class="ma mb mc md fd ni nj nk nl aw nm bi"><span id="db3f" class="mq if hh nj b fi nn no l np nq">apps<br/>├── demo-app<br/>│   ├── base<br/>│   │   ├── deployment.yaml<br/>│   │   ├── ingress.yaml<br/>│   │   ├── kustomization.yaml<br/>│   │   ├── namespace.yaml<br/>│   │   └── service.yaml<br/>│   └── overlays<br/>│       └── develop<br/>│           ├── config.json<br/>│           └── kustomization.yaml<br/>└── lab-app<br/>    ├── base<br/>    │   ├── deployment.yaml<br/>    │   ├── ingress.yaml<br/>    │   ├── kustomization.yaml<br/>    │   ├── namespace.yaml<br/>    │   └── service.yaml<br/>    └── overlays<br/>        └── develop<br/>            ├── config.json<br/>            └── kustomization.yaml</span></pre><p id="43c1" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">因此，当任何开发者或操作者想要通过拉请求做出贡献时，其想法是分析这些现有的和未来的清单。</p><h2 id="f8c5" class="mq if hh bd ig mr ms mt ik mu mv mw io jn mx my is jr mz na iw jv nb nc ja nd bi translated">步骤2: Datree预配置</h2><p id="175c" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">一旦您创建了Datree帐户并完成了<a class="ae kj" href="https://hub.datree.io/" rel="noopener ugc nofollow" target="_blank">先决条件部分中详述的正式Datree入门</a>，一个良好的安全实践是创建一个新的<strong class="je hi"> read </strong>令牌，CodeBuild项目稍后将使用它来访问Datree后端。</p><p id="4322" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">转到<code class="du nr ns nt nj b">the Datree Web Console &gt; Settings &gt; Token Management</code>，然后点击<code class="du nr ns nt nj b">Create Token</code>。确保令牌类型为<strong class="je hi"> Read。</strong></p><figure class="ma mb mc md fd me er es paragraph-image"><div class="er es nu"><img src="../Images/7e7a5bca80481e8f9606071c1d03db2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1138/format:webp/1*stDRDasrTAqZ-lQxJAx8mA.png"/></div><figcaption class="ml mm et er es mn mo bd b be z dx">Create a Read Datree Token</figcaption></figure><p id="984f" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">若要安全地存储此标记并确保CodeBuild项目可以接受它，请将该值作为SecureString加载到SSM参数存储区中。</p><pre class="ma mb mc md fd ni nj nk nl aw nm bi"><span id="200d" class="mq if hh nj b fi nn no l np nq">/k8s-apps-example/datree/APP_TOKEN<!-- --> </span></pre><figure class="ma mb mc md fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es nv"><img src="../Images/184f2e99a6ae5050528316bca9981351.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fEFMfyg2PsAuByyspkXehg.png"/></div></div></figure><p id="5e20" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">为了与Datree的集中式策略控制台进行交互，让我们为此示例创建一个新策略。转到策略选项卡，然后创建一个名为<code class="du nr ns nt nj b">k8s_apps_example</code>的新策略。请注意这个名称，因为它稍后将用于CodeBuild项目。</p><figure class="ma mb mc md fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es nw"><img src="../Images/a2518b1ca37431e9e4e02e1d7399e2e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C50Wz6hFayj9sFXT_Qzi0w.png"/></div></div><figcaption class="ml mm et er es mn mo bd b be z dx">Datree’s Centralized policy console</figcaption></figure><p id="8838" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">现在是时候激活规则了，这些规则将在CodeBuild项目中由策略检查自动验证。如上所示，53个规则中的22个已经被激活，其中一些属于安全、Argo和容器类别。</p><h2 id="2dd1" class="mq if hh bd ig mr ms mt ik mu mv mw io jn mx my is jr mz na iw jv nb nc ja nd bi translated">步骤3: Terraform模块结构和供应</h2><p id="f48c" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">首先，克隆<a class="ae kj" href="https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild" rel="noopener ugc nofollow" target="_blank">terra form模块库</a>并查看将要提供的资源。</p><ul class=""><li id="babe" class="ll lm hh je b jf kz jj la jn ln jr lo jv lp jz lq lr ls lt bi translated"><a class="ae kj" href="https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/codebuild_pr.tf#L1-L59" rel="noopener ugc nofollow" target="_blank">代码构建项目</a></li><li id="6993" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated"><a class="ae kj" href="https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/codebuild_pr.tf#L61-L76" rel="noopener ugc nofollow" target="_blank"> CodeBuild Webhook </a></li><li id="4609" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated"><a class="ae kj" href="https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/ssm.tf" rel="noopener ugc nofollow" target="_blank"> Webhook SSM参数</a>(有效载荷URL和秘密)</li><li id="7847" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated"><a class="ae kj" href="https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/codestar_notifications.tf" rel="noopener ugc nofollow" target="_blank">代号通知</a></li></ul><p id="d170" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">除了模块创建的资源之外，还需要以下资源作为模块调用的输入。</p><ul class=""><li id="847f" class="ll lm hh je b jf kz jj la jn ln jr lo jv lp jz lq lr ls lt bi translated"><a class="ae kj" href="https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/examples/complete/main.tf#L21-L28" rel="noopener ugc nofollow" target="_blank"> KMS密钥加密SSM参数</a></li><li id="90fb" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated"><a class="ae kj" href="https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/examples/complete/main.tf#L81-L91" rel="noopener ugc nofollow" target="_blank">代码构建项目将承担的IAM角色和IAM策略</a></li></ul><p id="949a" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">在<a class="ae kj" href="https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/tree/main/examples/complete" rel="noopener ugc nofollow" target="_blank">完整的</a>示例的<a class="ae kj" href="https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/examples/complete/main.tf" rel="noopener ugc nofollow" target="_blank"> main.tf </a>文件中，声明了所需的资源和Terraform模块的调用。</p><p id="6d67" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">该模块支持许多<a class="ae kj" href="https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/variables.tf" rel="noopener ugc nofollow" target="_blank">输入变量</a>；但是，最相关的变量是资源名称的前缀、要分析的存储库和分支、Datree策略名称以及先前创建Datree令牌的参数存储路径。</p><figure class="ma mb mc md fd me"><div class="bz dy l di"><div class="nx ny l"/></div></figure><p id="4a27" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">克隆了repo之后，设置AWS凭证，让我们继续到终端，看看Terraform的神奇之处。</p><pre class="ma mb mc md fd ni nj nk nl aw nm bi"><span id="085a" class="mq if hh nj b fi nn no l np nq">cd <!-- -->examples/complete<br/>terraform init<br/>terraform apply </span></pre><p id="75db" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">在<strong class="je hi">地形应用</strong>中输入<strong class="je hi">是</strong>后的预期输出:</p><figure class="ma mb mc md fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es nz"><img src="../Images/ad63c1c275436c479181e90598b5bfe6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nHUAsCf-W_1RZM7g83_Hrg.png"/></div></div></figure><p id="ee19" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">最后，已经提供了AWS CodeBuild项目。🎉</p><figure class="ma mb mc md fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es oa"><img src="../Images/5303b23ea472dc15516baea16142a9f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zilcJ100_47OT34lhRmO2w.png"/></div></div><figcaption class="ml mm et er es mn mo bd b be z dx">CodeBuild project</figcaption></figure><p id="de3f" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">从<a class="ae kj" href="https://www.terraform.io/language/functions/templatefile?_ga=2.106572672.2087542934.1652304655-572813180.1649204332" rel="noopener ugc nofollow" target="_blank">地形模板</a>构建<code class="du nr ns nt nj b">buildspec.yml</code>文件，最终结果如下所示。如您所见，首先所有YAML文件被递归列出，然后执行包含<code class="du nr ns nt nj b">--only-k8s-files</code>标志的<code class="du nr ns nt nj b">datree test</code>命令，从存储库根递归验证所有与K8s清单相关的YAML文件。</p><figure class="ma mb mc md fd me"><div class="bz dy l di"><div class="nx ny l"/></div></figure><p id="760b" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">类似地，CodeBuild webhook也被添加到了K8s清单存储库中。</p><figure class="ma mb mc md fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es ob"><img src="../Images/083aade45200d6f30b8817e348463120.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hT8MqMkOUGovURpb4X-7Zg.png"/></div></div><figcaption class="ml mm et er es mn mo bd b be z dx">CodeBuild Webhook created in Github repository</figcaption></figure><h2 id="60ac" class="mq if hh bd ig mr ms mt ik mu mv mw io jn mx my is jr mz na iw jv nb nc ja nd bi translated">步骤4:最终的GitHub配置</h2><p id="e711" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">为了确保开发人员或运营团队只能通过拉请求对主分支做出贡献，必须在功能分支合并到主分支之前通过代码构建检查。在K8s清单报告中，创建一个与主分支相关联的受保护分支规则，并在状态清单中选择CodeBuild检查。</p><figure class="ma mb mc md fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es oc"><img src="../Images/5abe9e9d188325cc8693e39a7f6910f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YJShJjrPiNOGWVG2JZJW3w.png"/></div></div></figure><h2 id="3bd1" class="mq if hh bd ig mr ms mt ik mu mv mw io jn mx my is jr mz na iw jv nb nc ja nd bi translated">第五步:1，2，3…开始！🎬策略检查的结果</h2><p id="31c4" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">最后，如果我们创建了一个从特性分支到主分支的拉请求，并做了一些修改，那么就会自动触发一个代码构建来分析特性分支的代码。</p><figure class="ma mb mc md fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es od"><img src="../Images/9360abe58cb1fdbb2f643396062b7e70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AFFm2YmADFRWLbR2psJm9A.png"/></div></div></figure><p id="b021" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">根据CodeBuild执行的状态，AWS将向PR返回失败或成功检查的状态。在这种情况下，由于检查失败，因此不允许合并。</p><figure class="ma mb mc md fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es oe"><img src="../Images/dbe580b88ae3cfba50856e16b3be4d94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-JjMmYKT_OQlo9qydyN2jQ.png"/></div></div></figure><p id="ce7c" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">要详细说明构建状态，只需单击<strong class="je hi"> Details </strong>标签，它会将您重定向到AWS上的CodeBuild日志或直接访问CodeBuild项目的运行历史。</p><figure class="ma mb mc md fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es of"><img src="../Images/d6f9c9d01fc6dda50a2327e73a4cafbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FiDV5V3t0GpBCUv3YCIUiQ.png"/></div></div><figcaption class="ml mm et er es mn mo bd b be z dx">CodeBuild logs</figcaption></figure><p id="6aae" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">在代码构建日志中，您可以详细描述以下内容:</p><ul class=""><li id="3179" class="ll lm hh je b jf kz jj la jn ln jr lo jv lp jz lq lr ls lt bi translated">基于先前创建的Datree策略中启用的规则尚未通过的规则。</li><li id="4743" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">三个连续阶段(YAML验证、模式验证和策略检查)的摘要。</li><li id="7414" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">在策略检查阶段评估、跳过、失败和通过的规则的总结果。</li></ul><p id="1b37" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">同样，如果您访问Datree中的“历史记录”选项卡，您可以轻松跟踪所有不同的策略检查执行情况。</p><figure class="ma mb mc md fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es og"><img src="../Images/02cc45427c85302789ecd7ef1ede2d7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p8EG_crdU1qJUUNM6ZFFVA.png"/></div></div><figcaption class="ml mm et er es mn mo bd b be z dx">Datree policy check history</figcaption></figure><h1 id="9985" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">记住</h1><ul class=""><li id="b831" class="ll lm hh je b jf jg jj jk jn nf jr ng jv nh jz lq lr ls lt bi translated">运行Datree CLI不需要创建Datree帐户，但是，要访问集中策略功能，Datree帐户是必需的。</li><li id="6774" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">Datree的免费模式仅支持GitHub和Google SSO用户，因此最好创建一个新的自动化用户或考虑企业模式。</li><li id="4b71" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">如前所述，在这个例子中，存储库中的所有k8s清单都被验证。但是，Datree支持在<a class="ae kj" href="https://github.com/datreeio/helm-datree" rel="noopener ugc nofollow" target="_blank">舵图</a>和<a class="ae kj" href="https://hub.datree.io/integrations/kustomize-support" rel="noopener ugc nofollow" target="_blank"> Kustomize </a>中验证应用。</li><li id="b740" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">terraform模块支持创建CodeStar通知，以向松弛通道发送状态。这需要创建一个聊天机器人通知，并将其添加为一个<a class="ae kj" href="https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/variables.tf#L91-L101" rel="noopener ugc nofollow" target="_blank">输入变量</a>。</li><li id="3254" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated">当它是Github.com存储库时，webhook是由Codebuild通过个人访问令牌自动创建的。但是，当它是GitHub企业存储库时，必须单独创建。因此，webhook的有效负载URL和秘密存储在SSM参数存储中。</li></ul></div><div class="ab cl le lf go lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ha hb hc hd he"><h1 id="9595" class="ie if hh bd ig ih oh ij ik il oi in io ip oj ir is it ok iv iw ix ol iz ja jb bi translated">结论</h1><p id="8cac" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在本文中，我们探索了一种基于GitOps实践的解决方案，在部署之前，自动分析在git存储库中声明的K8s应用程序清单。该实施依赖于一些GitOps工具，如Datree，以通过策略检查来验证K8s的错误配置，AWS Codebuild以自动触发检查，Terraform模块用于抽象和提供与该解决方案相关的基础设施，最后，GitHub中的一些配置以确保基于拉请求的流程。</p><p id="26a6" class="pw-post-body-paragraph jc jd hh je b jf kz jh ji jj la jl jm jn lb jp jq jr lc jt ju jv ld jx jy jz ha bi translated">最后，我想对约尔曼和唐·奥斯卡林的宝贵支持表示最深切的感谢。</p><h1 id="f4f2" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">参考</h1><ul class=""><li id="2427" class="ll lm hh je b jf jg jj jk jn nf jr ng jv nh jz lq lr ls lt bi translated"><a class="ae kj" href="https://www.weave.works/technologies/gitops/" rel="noopener ugc nofollow" target="_blank"> GitOps实践</a></li><li id="eae0" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated"><a class="ae kj" href="https://hub.datree.io/" rel="noopener ugc nofollow" target="_blank"> Datree入门</a></li><li id="1938" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated"><a class="ae kj" href="https://hub.datree.io/setup/cli-output" rel="noopener ugc nofollow" target="_blank"> Datree CLI输出</a></li><li id="cfaf" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated"><a class="ae kj" href="https://docs.aws.amazon.com/codebuild/latest/userguide/access-tokens.html" rel="noopener ugc nofollow" target="_blank"> AWS —配置GitHub个人访问令牌</a></li><li id="cb7c" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated"><a class="ae kj" href="https://docs.aws.amazon.com/codebuild/latest/userguide/sample-github-pull-request.html" rel="noopener ugc nofollow" target="_blank"> AWS —为GitHub拉请求配置代码构建</a></li><li id="80db" class="ll lm hh je b jf lu jj lv jn lw jr lx jv ly jz lq lr ls lt bi translated"><a class="ae kj" href="https://www.terraform.io/language/modules/syntax" rel="noopener ugc nofollow" target="_blank">地形模块</a></li></ul></div></div>    
</body>
</html>