<html>
<head>
<title>Detecting Image Similarity in (Near) Real-time Using Apache Flink</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Apache Flink(近)实时检测图像相似性</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/detecting-image-similarity-in-near-real-time-using-apache-flink-723ce072b7d2?source=collection_archive---------1-----------------------#2021-03-30">https://medium.com/pinterest-engineering/detecting-image-similarity-in-near-real-time-using-apache-flink-723ce072b7d2?source=collection_archive---------1-----------------------#2021-03-30</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="b791" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">沙姬·陈楠·昆努梅尔|软件工程师，内容质量<br/> Iaroslav Tymchenko|软件工程师，内容质量</p><p id="4ff3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest的核心是一个视觉平台，因此理解和处理图像的需求是最重要的。几年前，内容质量团队<a class="ae jc" rel="noopener" href="/pinterest-engineering/detecting-image-similarity-using-spark-lsh-and-tensorflow-618636afc939">设计并实现了</a>我们自己的批处理管道来检测类似的图像。相似性信号在Pinterest上被广泛用于各种用例，从改善基于相似图像的推荐到删除垃圾邮件和滥用内容。然而，为新创建的图像计算信号需要几个小时，这对垃圾邮件发送者和滥用者来说是一个损害平台的长时间窗口。因此，最近，该团队实现了一个流管道，以近实时的方式检测类似的图像。</p><p id="b547" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">鉴于该平台的规模，识别重复图像一直很困难，而实时识别则更具挑战性。这篇博客文章重点介绍了内容质量团队最近利用Apache Flink(近)实时检测重复图像的工作。</p><p id="7e39" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该项目的目标是在不影响准确性和覆盖范围的情况下，将延迟从批处理流水线的数小时延迟减少到几秒钟。</p><p id="cad5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">具体来说，我们希望解决以下两个问题:</p><ul class=""><li id="aedf" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">给定一张图片，查找之前是否在Pinterest上使用过相同的图片(或稍有变化，又名<em class="jm">near up</em></li><li id="411c" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb ji jj jk jl bi translated">给定一张图片，找到Pinterest上使用的所有相似图片的列表</li></ul><p id="2ff0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">出于实际原因，Pinterest上使用的整个图像世界被分解成一组不重叠的簇。注意，相似性关系是不可传递的，因此使用近似关系来分割图像。对于每个集群，一个代表性的成员被挑选(随机)并被用作一个集群ID。更具体地，我们使用图像之间的以下关系来表示不相交的聚类:</p><ul class=""><li id="7d75" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">镜像(又名<em class="jm">集群成员</em>)到规范镜像(又名<em class="jm">集群头</em>)</li><li id="06a9" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb ji jj jk jl bi translated">集群成员列表的规范映像</li></ul><p id="996c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本文的其余部分将重点讨论实时管道的设计和实现。请注意，本文不是关于检测图像相似性，而是关于<em class="jm">如何实时检测。如何使用位置敏感哈希(LSH)搜索和基于张量流的分类器来检测图像相似性的细节在之前名为“<a class="ae jc" rel="noopener" href="/pinterest-engineering/detecting-image-similarity-using-spark-lsh-and-tensorflow-618636afc939">使用火花、LSH和张量流检测图像相似性</a>”的博客文章和这些<a class="ae jc" href="https://dl.acm.org/doi/fullHtml/10.1145/3366423.3380031" rel="noopener ugc nofollow" target="_blank">文章</a>中有详细解释。</em></p><h1 id="80a9" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">挑战</h1><p id="7e73" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">Pinterest上的海量图片在可扩展性和健壮性方面带来了一系列挑战。下面给出的数字让我们看到了我们正在应对的规模:</p><ul class=""><li id="ddcd" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">Pinterest上保存的pin数:<strong class="ig hi"> 300B </strong></li><li id="7c86" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb ji jj jk jl bi translated">每秒图像创建的速率:<strong class="ig hi"> ~100(高峰时200)</strong></li><li id="2ed4" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb ji jj jk jl bi translated">集群成员数量:<strong class="ig hi">平均6个，少数集群成员数量高达110万</strong></li></ul><p id="5006" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">考虑到信号的重要性以及信号延迟/损坏可能带来的影响，我们必须从一开始就将以下方面融入系统:</p><ul class=""><li id="960e" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">易于调试</li><li id="87bf" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb ji jj jk jl bi translated">信号的可解释性</li><li id="e3f4" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb ji jj jk jl bi translated">实时和长期监控信号的健康状况</li><li id="3289" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb ji jj jk jl bi translated">在发生灾难性故障时，能够重新处理图像子集</li><li id="2752" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb ji jj jk jl bi translated">能够尽可能无缝地从批处理管道切换到新管道</li></ul><h1 id="d941" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">设计和实施</h1><p id="3aed" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">对于每个新创建的图像，我们运行以下步骤来检测相似的图像:</p><ul class=""><li id="b689" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">从视觉嵌入中提取<a class="ae jc" href="https://en.wikipedia.org/wiki/Locality-sensitive_hashing" rel="noopener ugc nofollow" target="_blank"> LSH </a>术语</li><li id="bcd8" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb ji jj jk jl bi translated">查询自定义搜索引擎(通过LSH术语索引引导)以确定一组潜在候选项。基于与所讨论的图像匹配的词的数量对候选进行排序。</li><li id="c1d0" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb ji jj jk jl bi translated">使用基于张量流的分类器评估候选集。我们使用经验确定的阈值来过滤掉不匹配的图像</li><li id="76d2" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb ji jj jk jl bi translated">如果检测到相似的映像，则识别群集并更新存储。</li></ul><p id="9227" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">整个系统构建为一个<a class="ae jc" href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/" rel="noopener ugc nofollow" target="_blank"> Apache Flink </a>工作流。在高层次上，一旦嵌入就绪，就触发相似性计算。Pinterest的媒体团队已经通过Kafka发布了通知。</p><h2 id="02ef" class="kv jt hh bd ju kw kx ky jy kz la lb kc ip lc ld kg it le lf kk ix lg lh ko li bi translated">架构图</h2><p id="bf86" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">本节给出的图表抓住了管道架构的本质。</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es lj"><img src="../Images/465ca1bc41497138bd69c44002492201.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Q3DeqAXU24yr6OGC"/></div></div></figure><h2 id="553e" class="kv jt hh bd ju kw kx ky jy kz la lb kc ip lc ld kg it le lf kk ix lg lh ko li bi translated">流-流连接</h2><p id="6e3e" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">相似性计算使用不同的嵌入(部分出于历史目的)用于LSH和机器学习评估。典型地，嵌入在几秒钟内可用，并且管道使用一个<a class="ae jc" href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/operators/joining.html" rel="noopener ugc nofollow" target="_blank">流-流连接</a>来同步多个嵌入的可用性。</p><h2 id="c70e" class="kv jt hh bd ju kw kx ky jy kz la lb kc ip lc ld kg it le lf kk ix lg lh ko li bi translated">Manas:自定义搜索引擎</h2><p id="a150" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">我们使用<a class="ae jc" rel="noopener" href="/pinterest-engineering/manas-a-high-performing-customized-search-system-cf189f6ca40f"> Manas </a> (Pinterest的可配置搜索引擎)通过LSH术语匹配找到潜在候选人。在<a class="ae jc" rel="noopener" href="/pinterest-engineering/detecting-image-similarity-using-spark-lsh-and-tensorflow-618636afc939">之前的博客文章</a>中解释了LSH术语如何用于识别相似图像的细节。</p><p id="b0f3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因为我们需要根据重叠项的数量对候选项进行排序，</p><p id="dab4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">搜索群集已针对延迟的正确性进行了优化。与传统的搜索引擎不同，我们的用例通常需要扫描整个语料库，并且期望返回具有最高术语重叠的结果。大量的文档扫描确实给搜索基础设施带来压力，并且需要严格的速率限制来调节搜索查询的速率。</p><p id="f0d3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦计算出相似性得分，搜索索引也会更新，以使新创建的图像可搜索。</p><h2 id="b279" class="kv jt hh bd ju kw kx ky jy kz la lb kc ip lc ld kg it le lf kk ix lg lh ko li bi translated">张量流模型服务</h2><p id="f1ea" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">我们利用Pinterest名为<a class="ae jc" rel="noopener" href="/pinterest-engineering/building-a-dynamic-and-responsive-pinterest-7d410e99f0a9"> Scorpion </a>的ML服务基础设施来评估选中的候选人。考虑到问题的规模(峰值时，每秒有近500，000个实例被评估)，模型服务使用GPU和微批处理等重要的优化来获得更好的性能。</p><h2 id="abcb" class="kv jt hh bd ju kw kx ky jy kz la lb kc ip lc ld kg it le lf kk ix lg lh ko li bi translated">存储和服务</h2><p id="d00b" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">如果检测到重复的映像，则需要更新底层存储以服务于映射。如上所述，我们在存储中坚持两种关系:</p><ul class=""><li id="44d8" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">图像到簇头映射</li><li id="042d" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb ji jj jk jl bi translated">集群成员列表中的集群头</li></ul><p id="565c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">映像到簇头的映射很简单，并且存储在rocksdb 的一个<a class="ae jc" rel="noopener" href="/pinterest-engineering/open-sourcing-rocksplicator-a-real-time-rocksdb-data-replicator-558cd3847a9d">变种中，这为我们提供了低延迟和线性可伸缩性。</a></p><p id="c4f2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，集群头与成员列表的关系是一个更复杂的关系，因为集群大小严重不对称(平均大小为6，但对于少数集群来说达到100万左右)。在Pinterest自己的名为<a class="ae jc" href="https://www.youtube.com/watch?v=yI0vHfgK6oI" rel="noopener ugc nofollow" target="_blank"> Zen </a>的图形存储系统中，簇头到成员列表的关系被存储为图形(节点是图像，边代表簇头到图像的映射)。使用图形存储的主要原因是利用它对获取边的分页支持(如果没有分页，将会有V大小非常大的K-V对，这将限制它在在线K-V系统中的使用)。</p><p id="3408" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这些关系通过称为Galaxy的通用信号传递系统提供服务，该系统提供低延迟的信号获取。</p><h2 id="1e67" class="kv jt hh bd ju kw kx ky jy kz la lb kc ip lc ld kg it le lf kk ix lg lh ko li bi translated">引导现有关系</h2><p id="bb3d" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">我们利用Flink的<a class="ae jc" href="https://ci.apache.org/projects/flink/flink-docs-stable/dev/datastream_api.html" rel="noopener ugc nofollow" target="_blank">文件监视器</a>特性来引导rocksdb和Zen graph存储。历史数据被转换成Flink工作流能够理解的模式，并保存在AWS S3的一个目录中。工作流中添加了一个文件监视器操作员，以监视S3位置并将数据批量上载到存储系统中。</p><h1 id="a9d6" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">管道的可操作性</h1><p id="22f5" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">管道的设计和实施考虑了可操作性。</p><h2 id="7957" class="kv jt hh bd ju kw kx ky jy kz la lb kc ip lc ld kg it le lf kk ix lg lh ko li bi translated">可调试性</h2><p id="c10e" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">由于管道很复杂，我们通过Flink操作符实现了特殊的调试数据传播。调试细节被推送到Kafka队列，并使用Pinterest自己的名为<a class="ae jc" rel="noopener" href="/pinterest-engineering/scalable-and-reliable-data-ingestion-at-pinterest-b921c2ee8754"> Merced </a>的可扩展Kafka物化基础设施进行持久化。系统还内置了一种功能，可以有选择地将图像id接收到管道中，并实时检查中间结果，以便更好、更轻松地进行调试。</p><h2 id="2e1c" class="kv jt hh bd ju kw kx ky jy kz la lb kc ip lc ld kg it le lf kk ix lg lh ko li bi translated">监控和警报</h2><p id="3853" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">除了使用Flink提供的标准指标，我们还有许多自定义指标来衡量管道的健康状况。也有每小时运行的作业在物化的Kafka日志上测量覆盖率和其他标准度量来检测模型偏差，等等。</p><h2 id="f1d9" class="kv jt hh bd ju kw kx ky jy kz la lb kc ip lc ld kg it le lf kk ix lg lh ko li bi translated">处理失败</h2><p id="77c2" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">我们构建了以下工具来处理故障和错误:</p><ul class=""><li id="8f53" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">用于在管道中的任何主要组件出现故障时回滚到良好状态的工具</li><li id="c66c" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb ji jj jk jl bi translated">通过强制将映像更改为簇头映射来修复误报的工具</li></ul><h1 id="ea1c" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">未来的工作</h1><p id="c47d" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">最初以图像为中心的管道发现了从静态图像到动态大头针(如视频和故事大头针)的应用。此外，它还可以被推广到处理存在近似重复关系的任何类型的数据，这为将来提高效率创造了机会。</p><p id="bf3f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jm">致谢:这篇文章总结了多个团队几个季度的工作。感谢Michael Mi、Andrey、Haibin Xie Saurabh Joshi、Sheng Cheng、Ankit Patel、Qingxian Lai、Karthik Anantha Padmanabhan、、、Nilesh Gohel、Teja Thotapalli、Nick DeChant </em></p></div></div>    
</body>
</html>