<html>
<head>
<title>Creating custom Text Selection actions with ACTION_PROCESS_TEXT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用ACTION_PROCESS_TEXT创建自定义文本选择操作</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/custom-text-selection-actions-with-action-process-text-191f792d2999?source=collection_archive---------1-----------------------#2015-12-30">https://medium.com/androiddevelopers/custom-text-selection-actions-with-action-process-text-191f792d2999?source=collection_archive---------1-----------------------#2015-12-30</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="f783" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Android 6.0 Marshmallow引入了一个新的<a class="ae jc" href="http://www.google.com/design/spec/patterns/selection.html#selection-text-selection" rel="noopener ugc nofollow" target="_blank">浮动文本选择工具栏</a>，它使标准的文本选择操作，如剪切、复制和粘贴，更接近你选择的文本。更好的是新的<a class="ae jc" href="http://developer.android.com/reference/android/content/Intent.html#ACTION_PROCESS_TEXT" rel="noopener ugc nofollow" target="_blank"><em class="jd">ACTION _ PROCESS _ TEXT</em></a>，这使得<strong class="ig hi">任何应用</strong>都可以向文本选择工具栏添加自定义操作。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/ee1cc4351ee887103edca56d25c568d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/1*D4zZzPlBTk5cEN9Qn0-cBA.gif"/></div><figcaption class="jm jn et er es jo jp bd b be z dx">The text selection toolbar in Android 6.0</figcaption></figure><p id="fb51" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">像<a class="ae jc" href="https://play.google.com/store/apps/details?id=org.wikipedia" rel="noopener ugc nofollow" target="_blank">维基百科</a>和<a class="ae jc" href="https://play.google.com/store/apps/details?id=com.google.android.apps.translate" rel="noopener ugc nofollow" target="_blank">谷歌翻译</a>这样的应用已经开始利用它来即时查找或翻译选定的文本。</p><p id="f5dd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你可能已经看过<a class="ae jc" href="http://developer.android.com/about/versions/marshmallow/android-6.0-changes.html#behavior-text-selection" rel="noopener ugc nofollow" target="_blank">文档</a>和一篇关于确保文本选择工具栏和选项出现在你的应用程序中的<a class="ae jc" href="http://android-developers.blogspot.com/2015/10/in-app-translations-in-android.html" rel="noopener ugc nofollow" target="_blank">博文</a>(简而言之:使用标准的<em class="jd">文本视图</em> / <em class="jd">编辑文本</em>，它们可以开箱即用，但是请注意，你的<em class="jd">编辑文本</em>需要有一个<em class="jd"> android:id </em>设置，你需要调用<a class="ae jc" href="http://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html#getDelegate()" rel="noopener ugc nofollow" target="_blank"><em class="jd">get delegate()</em></a><a class="ae jc" href="http://developer.android.com/reference/android/support/v7/app/AppCompatDelegate.html#setHandleNativeActionModesEnabled(boolean)" rel="noopener ugc nofollow" target="_blank"><em class="jd">setHandleNativeActionModesEnabled(false)</em></a>如果您正在使用<a class="ae jc" href="http://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html" rel="noopener ugc nofollow" target="_blank"><em class="jd">appcompactivity</em></a>并且想要使用API 23+设备上的原生浮动文本选择工具栏)。</p><p id="e56b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是找到关于<strong class="ig hi">实现</strong><em class="jd">ACTION _ PROCESS _ TEXT</em>和<strong class="ig hi">添加自己的动作</strong>的信息？这就是这篇文章将要讨论的内容。</p><h1 id="3b49" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">跨应用程序通信-&gt;意图过滤器</h1><p id="680e" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">正如您所料，在构建跨越应用边界的功能时，您的Android清单和附加到每个组件的<a class="ae jc" href="http://developer.android.com/guide/components/intents-filters.html" rel="noopener ugc nofollow" target="_blank">意图过滤器</a>充当其他应用可以查询的公共API。</p><p id="8065" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jd"> ACTION_PROCESS_TEXT </em>也不例外。您将向清单中的活动添加意图过滤器:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="7c1e" class="ky jr hh ku b fi kz la l lb lc">&lt;activity<br/>    android:name=".ProcessTextActivity"<br/>    android:label="@string/process_text_action_name"&gt;<br/>  &lt;intent-filter&gt;<br/>    &lt;action android:name="android.intent.action.PROCESS_TEXT" /&gt;<br/>    &lt;category android:name="android.intent.category.DEFAULT" /&gt;<br/>    &lt;data android:mimeType="text/plain" /&gt;<br/>  &lt;/intent-filter&gt;<br/>&lt;/activity&gt;</span></pre><p id="5a6b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">而且，如果你想要多种行动(你超水平发挥，你！)，你需要为每一个单独的活动。从Android 6.0.1开始，你会希望避免添加<em class="jd">Android:exported = " false "</em>——你的动作仍会出现在其他应用中，但它们会在点击它时立即获得一个<em class="jd"> SecurityException </em>(在<em class="jd"> ACTION_PROCESS_TEXT </em>中实现过滤以匹配系统选择器行为的<a class="ae jc" href="https://code.google.com/p/android/issues/detail?id=199161" rel="noopener ugc nofollow" target="_blank">功能请求</a>已被标记为<em class="jd"> FutureRelease </em>并在内部修复)。</p><p id="aa80" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意<strong class="ig hi">你的活动的<em class="jd"> android:label </em>将在文本选择工具栏</strong>中显示为动作，因此请确保它很短，是一个动作动词，并且可以识别为你的应用程序的图标。例如，Google Translate使用“翻译”，因为这是一个不太常见的操作(有多少人安装了多个翻译应用程序？)，而维基百科使用“搜索维基百科”，因为搜索可能是许多应用程序更常见的操作。</p><h1 id="4491" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">获取选定的文本</h1><p id="04c8" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">一旦您设置了意图过滤器，其他应用程序将能够通过选择文本并从文本选择工具栏中选择您的操作来启动您的活动。但是这并没有增加任何价值，除非你真的看了被选中的文本。</p><p id="c766" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这就是<a class="ae jc" href="http://developer.android.com/reference/android/content/Intent.html#EXTRA_PROCESS_TEXT" rel="noopener ugc nofollow" target="_blank"><em class="jd">EXTRA _ PROCESS _ TEXT</em></a>的用武之地:它是包含在Intent中的一个<a class="ae jc" href="http://developer.android.com/reference/java/lang/CharSequence.html" rel="noopener ugc nofollow" target="_blank"> <em class="jd"> CharSequence </em> </a>表示选择了什么文本。不要被欺骗了——即使你使用的是<em class="jd">文本/普通</em>意图过滤器，你也会得到完整的<em class="jd"> CharSequence </em>以及包含的任何<a class="ae jc" href="http://developer.android.com/reference/android/text/Spannable.html" rel="noopener ugc nofollow" target="_blank"><em class="jd">span able</em></a>，所以如果你在你的应用程序中直接使用<em class="jd"> CharSequence </em>时注意到一些样式，不要惊讶(你总是可以调用<a class="ae jc" href="http://developer.android.com/reference/java/lang/CharSequence.html#toString()" rel="noopener ugc nofollow" target="_blank"> <em class="jd"> toString() </em> </a>来移除所有格式)。</p><p id="6c81" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此，您的<em class="jd"> onCreate() </em>方法可能类似于:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="5687" class="ky jr hh ku b fi kz la l lb lc">@Override<br/>protected void onCreate(Bundle savedInstanceState) {<br/>  super.onCreate(savedInstanceState);<br/>  setContentView(R.layout.process_text_main);<br/>  CharSequence text = getIntent()<br/>      .getCharSequenceExtra(Intent.EXTRA_PROCESS_TEXT);<br/>  // process the text<br/>}</span></pre><p id="b3de" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有一点需要注意的是，如果您使用的是<em class="jd">Android:launch mode = " single top "</em>，那么您还需要处理<a class="ae jc" href="http://developer.android.com/reference/android/app/Activity.html#onNewIntent(android.content.Intent)" rel="noopener ugc nofollow" target="_blank"><em class="jd">【onNewIntent()</em></a>中的文本——一种常见的做法是让<em class="jd"> onCreate() </em>和<em class="jd"> onNewIntent() </em>调用您创建的单个<em class="jd"> handleIntent() </em>方法。</p><p id="74ef" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你使用<em class="jd"> ACTION_PROCESS_TEXT </em>作为进入你的应用程序的入口，这就是你所需要的一切:之后你要做什么取决于你自己。</p><h1 id="6260" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">返回结果</h1><p id="a56b" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">还有一个额外的包含在<em class="jd">ACTION _ PROCESS _ TEXT</em><em class="jd">Intent</em>虽然:<a class="ae jc" href="http://developer.android.com/reference/android/content/Intent.html#EXTRA_PROCESS_TEXT_READONLY" rel="noopener ugc nofollow" target="_blank"><em class="jd">EXTRA _ PROCESS _ TEXT _ READONLY</em></a>。这个<em class="jd">布尔值</em>额外表示您刚刚收到的选定文本是否可以被用户编辑(例如在<em class="jd"> EditText </em>中的情况)。</p><p id="7bce" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您将使用如下代码检索额外的内容</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="a59d" class="ky jr hh ku b fi kz la l lb lc">boolean readonly = getIntent()<br/>  .getBooleanExtra(Intent.EXTRA_PROCESS_TEXT_READONLY, false);</span></pre><p id="42b6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你可以以此为线索，提供将修改过的文本<strong class="ig hi">返回给发送应用的能力，替换选中的文本</strong>。这是因为您的活动实际上是从<a class="ae jc" href="http://developer.android.com/reference/android/app/Activity.html#startActivityForResult(android.content.Intent,%20int)" rel="noopener ugc nofollow" target="_blank"><em class="jd">startActivityForResult()</em></a>开始的—在活动结束之前的任何时候，您都可以通过调用<a class="ae jc" href="http://developer.android.com/reference/android/app/Activity.html#setResult(int,%20android.content.Intent)" rel="noopener ugc nofollow" target="_blank"> <em class="jd"> setResult() </em> </a>来<a class="ae jc" href="http://developer.android.com/training/basics/intents/filters.html#ReturnResult" rel="noopener ugc nofollow" target="_blank">返回结果</a>:</p><pre class="jf jg jh ji fd kt ku kv kw aw kx bi"><span id="235d" class="ky jr hh ku b fi kz la l lb lc">Intent intent = new Intent();<br/>intent.putExtra(Intent.EXTRA_PROCESS_TEXT, replacementText);<br/>setResult(RESULT_OK, intent);</span></pre><p id="3f4b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您可以想象一个“Replace”按钮会调用<em class="jd"> setResult() </em>然后调用<a class="ae jc" href="http://developer.android.com/reference/android/app/Activity.html#finish()" rel="noopener ugc nofollow" target="_blank"> <em class="jd"> finish() </em> </a>返回到调用活动。</p><h1 id="ef12" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">常见问题</h1><p id="6411" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">在你开始写回复之前，这里有一些关于<em class="jd"> ACTION_PROCESS_TEXT: </em>的常见问题</p><h2 id="fd92" class="ky jr hh bd js ld le lf jw lg lh li ka ip lj lk ke it ll lm ki ix ln lo km lp bi translated">问:我可以用<em class="lq"> ACTION_PROCESS_TEXT </em>触发服务吗？</h2><p id="68ef" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">答:不直接—系统仅查找包含正确意图过滤器的活动。这并不意味着您不能让您的活动使用主题<a class="ae jc" href="https://developer.android.com/reference/android/R.style.html#Theme_Translucent_NoTitleBar" rel="noopener ugc nofollow" target="_blank"> <em class="jd">来推出服务。半透明. not title bar</em></a>甚至<a class="ae jc" href="https://developer.android.com/reference/android/R.style.html#Theme_NoDisplay" rel="noopener ugc nofollow" target="_blank"> <em class="jd">主题。不显示</em> </a>(只要你<a class="ae jc" href="https://plus.google.com/105051985738280261832/posts/LjnRzJKWPGW" rel="noopener ugc nofollow" target="_blank">立即完成活动</a>)，但是确保你有一些用户可见的提示，表明他们的动作被接收到了——一个开始通知，一个<a class="ae jc" href="http://developer.android.com/reference/android/widget/Toast.html" rel="noopener ugc nofollow" target="_blank">祝酒词</a>等等。</p><h2 id="8124" class="ky jr hh bd js ld le lf jw lg lh li ka ip lj lk ke it ll lm ki ix ln lo km lp bi translated">问:我可以只对某些类型的文本触发它吗？</h2><p id="87aa" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">答:没有。每当有人选择文本时，您的选项就会出现。当然，用户很可能不会选择“翻译”选项，除非他们想翻译，等等。，但我会小心地编写防御性代码，因为你无法确定你将收到什么类型的文本上下文。</p><h2 id="227c" class="ky jr hh bd js ld le lf jw lg lh li ka ip lj lk ke it ll lm ki ix ln lo km lp bi translated">问:那么是不是每个app都要实现<em class="lq"> ACTION_PROCESS_TEXT </em>？那岂不是疯了？</h2><p id="f9d1" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">答:是的，那太疯狂了，不，不是每个应用都应该实现<em class="jd"> ACTION_PROCESS_TEXT </em>。确保你执行的任何操作<strong class="ig hi">都是通用的，并且对安装了你的应用的用户真正有用</strong>。</p><h1 id="874a" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">了解更多信息</h1><p id="a286" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">除了前面提到的<a class="ae jc" href="https://play.google.com/store/apps/details?id=org.wikipedia" rel="noopener ugc nofollow" target="_blank">维基百科</a>和<a class="ae jc" href="https://play.google.com/store/apps/details?id=com.google.android.apps.translate" rel="noopener ugc nofollow" target="_blank">谷歌翻译</a>已经包含了很好的真实世界的例子，你也可以查看安装在棉花糖模拟器上的ApiDemos应用程序或者<a class="ae jc" href="https://android.googlesource.com/platform/development/+/master/samples/ApiDemos/src/com/example/android/apis/content/ProcessText.java" rel="noopener ugc nofollow" target="_blank">直接查看代码</a>。</p><p id="305f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"># BuildBetterApps</p><p id="a814" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">加入关于<a class="ae jc" href="https://plus.google.com/+AndroidDevelopers/posts/T4dgC9FRMNj" rel="noopener ugc nofollow" target="_blank"> Google+帖子</a>的讨论，关注<a class="ae jc" href="https://plus.google.com/collection/sLR0p" rel="noopener ugc nofollow" target="_blank"> Android开发模式集合</a>了解更多！</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="er es lr"><img src="../Images/d2bfcdbe45b58454fb507a15e5be2ab4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6fEWv1fv16mfHBygS2eu5A.png"/></div></div></figure></div></div>    
</body>
</html>