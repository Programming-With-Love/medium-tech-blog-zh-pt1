<html>
<head>
<title>Recurring charges with PHP and Card on File</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PHP和信用卡的重复收费</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/recurring-charges-with-php-and-card-on-file-60f2bcb9aeac?source=collection_archive---------3-----------------------#2017-07-20">https://medium.com/square-corner-blog/recurring-charges-with-php-and-card-on-file-60f2bcb9aeac?source=collection_archive---------3-----------------------#2017-07-20</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><blockquote class="ie"><p id="3ad6" class="if ig hh bd ih ii ij ik il im in io dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们在https://developer.squareup.com/blog<a class="ae ip" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">的新家</a></p></blockquote><p id="d410" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm io ha bi translated">无论你有订阅服务，还是你想重复收费的固定客户，你都可以使用Square的电子商务API和Card on File。</p><p id="1db7" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">将客户的卡存档几乎等同于用Square的电子商务API向其收费。关键的区别在于，不是向<code class="du js jt ju jv b">charge</code>端点提交卡随机数，而是将它附加到客户，然后提交该客户的附属卡进行收费。</p><figure class="jx jy jz ka fd kb er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es jw"><img src="../Images/42eb7ee1a46f920dae5d20dd8ef257fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*47jDyhjkMZXkMV0Gs2PMDg.png"/></div></div><figcaption class="ki kj et er es kk kl bd b be z dx">High level diagram of storing a card on file vs charging directly.</figcaption></figure><p id="bdb1" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">现在让我们从代码的角度深入了解一下这是什么样子。首先，终端用户需要将他们的卡信息输入到<a class="ae ip" href="https://docs.connect.squareup.com/articles/adding-payment-form" rel="noopener ugc nofollow" target="_blank"> SqPaymentForm </a>中。第一次存储用户的信用卡时，这是必需的；您不能将之前记录的信用卡号(或PAN)发送给我们并将其附加到客户。在很大程度上，我们将从文档站点复制&amp;粘贴示例表单，并添加了一个重要的内容。我们还必须<strong class="is hi">添加一个复选框，通知购买者他们的卡将被保存以备将来购买。如我们的文档中所述，在未获得买家许可的情况下链接卡可能会导致您的应用被禁用。</strong></p><p id="cf00" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">接下来，我们将添加输入来指定我们希望将卡附加到的客户的信息。在生产情况下，您将收取定期付款或订阅费用，您可能希望您的客户登录到您的应用程序或网站，并使用他们登录状态的信息来识别他们是特定的客户。因为这是一个例子，所以我在填写表单时添加了名和姓，并创建一个新客户，以便每次都将卡附在文件上。</p><figure class="jx jy jz ka fd kb er es paragraph-image"><div class="er es km"><img src="../Images/0be6b85a0752e091e02c3a2359b57c76.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/format:webp/1*u8Q5HFDWtlBr_KHZRSn2-g.png"/></div><figcaption class="ki kj et er es kk kl bd b be z dx">Always ask to keep a card on file!</figcaption></figure><p id="c799" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">修改后的卡表单启动并运行后，我们就可以开始编写处理支付的代码了。我们网页上的表单将生成一个card nonce，然后将它和客户信息一起发布到一个不同的php脚本<code class="du js jt ju jv b">process-card.php</code>。该页面将使用<a class="ae ip" href="https://github.com/square/connect-php-sdk" rel="noopener ugc nofollow" target="_blank"> Square的PHP SDK </a>创建一个新客户，使用card nonce将卡附加到客户，用于将来的订阅计费，然后对卡收费。让我们开始吧:</p><h2 id="bd9a" class="kn ko hh bd kp kq kr ks kt ku kv kw kx jb ky kz la jf lb lc ld jj le lf lg lh bi translated">创建客户</h2><p id="dcf4" class="pw-post-body-paragraph iq ir hh is b it li iv iw ix lj iz ja jb lk jd je jf ll jh ji jj lm jl jm io ha bi translated">由于我们使用的是PHP SDK，创建客户的大部分艰苦工作都隐藏在一些有用的函数中。我们需要做的就是将客户的详细信息(在我们的例子中是名和姓)传递给<code class="du js jt ju jv b">createCustomer()</code>方法，瞧，我们已经创建了一个客户。</p><pre class="jx jy jz ka fd ln jv lo lp aw lq bi"><span id="0af5" class="kn ko hh jv b fi lr ls l lt lu">try {<br/> $result = $api_instance-&gt;createCustomer(<br/>  array(<br/>   'given_name'=&gt; $first_name,<br/>   'family_name'=&gt; $last_name<br/>   )<br/>  );<br/> $customer = $result-&gt;getCustomer(); <br/>} catch (Exception $e) {<br/> echo 'Exception when calling CustomersApi-&gt;createCustomer: ', $e-&gt;getMessage(), PHP_EOL;<br/>}</span></pre><p id="0ec2" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">我们的客户就位后，下一步是将卡(由生成的nonce表示)添加到客户。同样，PHP SDK将承担大部分繁重的工作:</p><pre class="jx jy jz ka fd ln jv lo lp aw lq bi"><span id="4de5" class="kn ko hh jv b fi lr ls l lt lu">try {<br/> $result = $api_instance-&gt;createCustomerCard(<br/>  $customer_id,<br/>  array(<br/>   "card_nonce"=&gt;$_POST['nonce'],<br/>   "billing_address"=&gt;array(<br/>    'postalCode' =&gt; $postal_code<br/>    )<br/>   )<br/>  );<br/> $customer_card = $result-&gt;getCard();</span></pre><p id="5f81" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">既然我们已经将卡附在客户身上，我们就可以使用该信息进行收费。这就像直接使用卡随机数进行收费一样，但是我们将为<code class="du js jt ju jv b">charge</code>端点提供我们想要收费的<code class="du js jt ju jv b">customer_id</code>和<code class="du js jt ju jv b">customer_card_id</code>，而不是卡随机数:</p><pre class="jx jy jz ka fd ln jv lo lp aw lq bi"><span id="0516" class="kn ko hh jv b fi lr ls l lt lu">$transaction_api = new SquareConnect\Api\TransactionsApi();</span><span id="eb76" class="kn ko hh jv b fi lv ls l lt lu">try {<br/> $result = $transaction_api-&gt;charge(<br/>  $location_id,<br/>  array(<br/>   'idempotency_key' =&gt; uniqid(),<br/>   'amount_money' =&gt; array(<br/>    'amount' =&gt; 200, 'currency' =&gt; 'USD'<br/>    ),<br/>   'customer_id' =&gt; $customer-&gt;getId(),<br/>   'customer_card_id' =&gt; $customer_card-&gt;getId(),<br/>   'note' =&gt; 'Subscription Billing'<br/>   ));<br/> print_r($result);<br/>} catch (Exception $e) {<br/> echo 'Exception when calling TransactionsApi-&gt;charge: ', $e-&gt;getMessage(), PHP_EOL;<br/>}</span></pre><p id="ba33" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">哒哒！这就是在文件上对卡收费的全部内容。在月初，或者下一次您想要收取重复费用时，您只需要执行最后一步，并向客户收费(因为客户及其卡已经存在)。</p><p id="1c6f" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">如果你想了解更多关于Square定期支付的信息，请查看官方的<a class="ae ip" href="https://docs.connect.squareup.com/articles/processing-recurring-payments-ruby" rel="noopener ugc nofollow" target="_blank">文档</a>，以及相关端点的<a class="ae ip" href="https://docs.connect.squareup.com/api/connect/v2/" rel="noopener ugc nofollow" target="_blank"> API参考</a>。一如既往，关注这篇博客和twitter上的<a class="ae ip" href="https://twitter.com/squaredev" rel="noopener ugc nofollow" target="_blank"> @SquareDev </a>，了解最新的产品发布和更多的技巧&amp;窍门。</p></div></div>    
</body>
</html>