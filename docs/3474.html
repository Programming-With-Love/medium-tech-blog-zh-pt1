<html>
<head>
<title>Automating IaC Integration Tests with Terraform, GitHub Actions and AWS.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动化IaC与Terraform、GitHub Actions和AWS的集成测试。</h1>
<blockquote>原文：<a href="https://medium.com/globant/how-to-automate-integration-testing-with-terraform-github-actions-and-aws-6061aa0b6e5f?source=collection_archive---------2-----------------------#2020-08-28">https://medium.com/globant/how-to-automate-integration-testing-with-terraform-github-actions-and-aws-6061aa0b6e5f?source=collection_archive---------2-----------------------#2020-08-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="f5ad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">辅助编写:<a class="ae jc" href="https://www.linkedin.com/in/brayanbautista/" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi">布雷安·安德烈斯·包蒂斯塔·卡尔德龙</strong> </a>和<a class="ae jc" href="https://www.linkedin.com/in/guevaraernesto/" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi">豪尔赫·恩内斯托·格瓦拉·昆卡</strong> </a>。特别感谢他们的帮助和支持。</p><p id="5be3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">无论何时开发新的应用程序，您都试图将失败的风险降至最低，测试应用程序的功能、安全漏洞或合规性。如果您正在开发一个已经达到一定复杂程度的开发框架，那么测试应该使用CI/CD管道在生产的各个阶段部署和测试应用程序来实现自动化。从应用程序的角度来看，所有这些都非常重要，但是，支持应用程序的基础架构方面又如何呢？。考虑到您可以拥有最强大、最安全和最可靠的应用程序，但如果底层基础架构(服务器、数据库、网络、防火墙等)不稳定，也必须考虑等式的这一面。，)有重要的缺陷，您的应用程序可能会变得一文不值。</p><p id="b7ff" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将您的基础架构作为代码或IaC具有一些优势，包括在部署应用程序之前自动测试您的基础架构的可能性，降低问题进入不同阶段的风险，最重要的是在投入生产之前。</p><p id="02af" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有很多IaC工具，但是在这个例子中，我们将使用<strong class="ig hi"> Terraform </strong>。这个工具是用Golang编写的，它允许我们使用语言测试包、terraform库和其他Go库，如<strong class="ig hi"> Terratest </strong>。对于常见的基础设施测试任务，您可以使用terratest函数和模式集合。</p><h1 id="3ab5" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">基础设施场景</strong></h1><p id="f5a3" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们在AWS Fargate上部署了一个简单的web应用程序，有一个带有ALB的公共子网，接收外部用户请求并将它们路由到私有子网中的Fargate容器。弹性容器注册表存储docker应用程序映像，Fargate使用它来运行web应用程序。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kg"><img src="../Images/8ae2cc32816d2e285dd808dd0d5ab130.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*efaexEx-AAXrdNI_MG64RQ.png"/></div></div></figure><h1 id="3fe3" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak"> GitHub动作</strong></h1><p id="ba57" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">GitHub Actions是一个GitHub集成特性，它为您提供了一个集成到CI/CD工作流每一步的执行环境。我们使用<strong class="ig hi"> GitHub Actions </strong>来自动化CI/CD管道的测试，您可以使用社区开发的各种各样的操作，允许您将您的管道与包括AWS在内的不同云供应商集成。</p><p id="6a67" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> GitHub动作概念:</strong></p><ul class=""><li id="4b5e" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><strong class="ig hi">动作</strong>是单独的任务，您可以将它们组合成创建作业的步骤。您可以创建自己的操作，使用从GitHub社区共享的操作，以及自定义公共操作。要在工作流中使用操作，您必须将其作为一个步骤包括在内。</li><li id="db08" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><strong class="ig hi"> runner </strong>是任何执行GitHub动作的机器，你可以使用GitHub托管的runner或者托管你自己的Runner叫做自托管Runner。一个跑步者等待可用的工作。当一个runner获得一个作业时，它运行该作业的动作，并向GitHub报告进度、日志和最终结果。跑步者一次跑一项任务。GitHub提供每月2000分钟的免费GitHub托管runner执行，允许您利用CI/CD功能，而无需在外部服务上花费。</li><li id="248f" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><strong class="ig hi">事件</strong>是<strong class="ig hi"> </strong>触发工作流运行的特定活动。例如，当有人将提交推送到存储库时，或者当一个问题或拉请求被创建时，活动可以源自GitHub。您还可以使用存储库调度webhook将工作流配置为在外部事件发生时运行。</li><li id="116c" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated"><strong class="ig hi">作业</strong>是在同一个流道上执行的一组步骤。您可以为作业在工作流文件中的运行方式定义相关性规则。根据前一个作业的状态，作业可以同时并行运行，也可以顺序运行。</li></ul><h1 id="eb53" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">管道结构</h1><p id="8192" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">在本节中，我们将描述使用GitHub操作创建的管道，如果成功，每个步骤都标有绿色的勾号，如果失败，则标有红色的x。第一步设置作业是由GitHub Actions自动创建的，接下来将描述以下步骤。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es lg"><img src="../Images/c3a68fb5fcd05ed195f9427740973b56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uW60lR7M8XYfsGDBFJcNuA.png"/></div></div></figure><p id="5ed7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">GitHub Actions使用位于内部的yaml文件。repo中的github/workflows文件夹，指示运行者一个包含以下内容的作业:要使用的操作、环境变量、何时执行管道(事件)、要执行的命令等。，我们的管道将单个作业分为多个步骤，执行静态和集成测试:</p><ul class=""><li id="aae7" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated">运行操作以设置运行测试所需的工具，如terraform和Go。检出动作允许容器复制和检查存储库中的文件。</li></ul><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es lh"><img src="../Images/0fd5b155d0adbd376b8109cc23917fbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/1*x7R4HYJiO47D_5xH24mHGg.png"/></div></figure><ul class=""><li id="2be4" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><strong class="ig hi">Run Terranovax/AWS-ECR-deploy @ v1</strong>是一个社区操作，允许构建docker容器映像并将其推送到AWS ECR服务中。在这里，我们使用预定义的密码，即帐户中具有适当权限的AWS访问密钥，来访问我们需要的AWS服务和功能。构建映像有我们的示例web应用程序，它将允许我们测试基础设施的每个部分。</li></ul><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es li"><img src="../Images/06074b76da822f6eb105ea040d26b2d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:858/format:webp/1*Rt0kfbTnDrO4GULqtjz0xA.png"/></div></figure><ul class=""><li id="4f1a" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><strong class="ig hi">运行Go静态测试</strong>运行基本的terraform lint命令并验证terraform计划的输出。</li></ul><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es lj"><img src="../Images/6954edf6e94f40c412532a50761c21a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*-DaxGvIwBlnFtNVwtaTecg.png"/></div></figure><ul class=""><li id="96b6" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><strong class="ig hi">部署基础设施</strong>以应用前一阶段地形图输出的变更。</li></ul><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es lk"><img src="../Images/8799ca8ac6b2ec6ead88fba842f57870.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/format:webp/1*eols4i8WgMk4dRRABKxGvA.png"/></div></figure><ul class=""><li id="1798" class="ks kt hh ig b ih ii il im ip ku it kv ix kw jb kx ky kz la bi translated"><strong class="ig hi">运行Go集成测试</strong>这里我们使用了terratest库中的Go函数，它允许我们对我们的应用程序负载平衡器进行HTTP GET调用，该测试从URL(例如200)返回一个状态代码，以检查请求是否成功。Go测试的任何其他返回失败。</li></ul><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es ll"><img src="../Images/29b6a2319d173d4d325c2bc80366d2de.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/format:webp/1*6_XNtSRWTVrTEx04VRCkQQ.png"/></div></figure><h1 id="71f9" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">与terratest功能的集成测试</strong></h1><p id="9255" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">用Go编写测试允许我们使用terraform - terratest库和函数。在代码的开头，我们需要导入我们将要使用的库:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es lm"><img src="../Images/74c90796e4e84d0cb18c4eb479857a04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3zRAMySVwfhvTie3Rhob6w.png"/></div></div></figure><p id="99ec" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">导入库之后，我们创建一个主测试函数来准备terraform工作目录，并为ECS Fargate任务设置一个等待预热期，以完成新的构建映像部署。最后，我们将预期的测试属性(HTTP状态代码、网页正文)发送给<strong class="ig hi"> testURL </strong>函数:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es ln"><img src="../Images/485ec27fbeaadcfeaba5e5a6375f422a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dG0ywhJGrhfGnqp2lIFa_Q.png"/></div></div></figure><p id="78e2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> testURL </strong>函数是集成测试中的主要部分之一，它将模拟用户向我们的应用程序URL发出请求，检查网页正文内容并返回HTTP状态代码，这允许管道测试所有底层基础设施部分的端到端功能:</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es lo"><img src="../Images/e3ddb74da1100478ef6c036c23ca42c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iaoeJNLBBLjON4M9mYANuw.png"/></div></div></figure><h1 id="738b" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结果</h1><p id="f53f" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">管道完成后，我们可以在GitHub操作作业日志中查看结果。在这里，我们可以看到测试从web应用程序获得了预期的HTTP状态代码和主体，因此测试结果是成功的:</p><pre class="kh ki kj kk fd lp lq lr ls aw lt bi"><span id="e60e" class="lu je hh lq b fi lv lw l lx ly">TestHttpMicroserviceValidity 2020-07-22T22:58:02Z retry.go:72: Calling http://tectech-insider-ALB-111111111.us-east-1.elb.amazonaws.com/<br/>TestHttpMicroserviceValidity 2020-07-22T22:58:02Z http_helper.go:32: Making an HTTP GET call to URL http://tectech-insider-ALB-111111111.us-east-1.elb.amazonaws.com/<br/>TestHttpMicroserviceValidity 2020-07-22T22:58:02Z <strong class="lq hi">microservice_integration_test.go:49: Got expected status code 200 from URL http://tectech-insider-ALB-111111111.us-east-1.elb.amazonaws.com/</strong><br/><strong class="lq hi">--- PASS: TestHttpMicroserviceValidity (190.34s)<br/>PASS<br/>ok   microservice_test 190.354s</strong></span></pre><p id="4b98" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">收到意外的正文或状态HTTP代码会导致测试失败:</p><pre class="kh ki kj kk fd lp lq lr ls aw lt bi"><span id="fe07" class="lu je hh lq b fi lv lw l lx ly">TestHttpMicroserviceValidity 2020-07-22T14:16:01Z retry.go:72: Calling http://tectech-insider-ALB-111111111.us-east-1.elb.amazonaws.com/<br/>TestHttpMicroserviceValidity 2020-07-22T14:16:01Z http_helper.go:32: Making an HTTP GET call to URL http://tectech-insider-ALB-111111111.us-east-1.elb.amazonaws.com/<br/>TestHttpMicroserviceValidity 2020-07-22T14:16:01Z microservice_integration_test.go:49: Got expected status code 200 from URL http://tectech-insider-ALB-111111111.us-east-1.elb.amazonaws.com/<br/>    microservice_integration_test.go:54: <br/>         Error Trace: microservice_integration_test.go:54<br/>                         microservice_integration_test.go:39<br/>                         test_structure.go:24<br/>                         microservice_integration_test.go:35<br/><strong class="lq hi">         Error:       "Error body page" does not contain "Welcome to tech insiders"<br/>         Test:        TestHttpMicroserviceValidity<br/>         Messages:    Body should contain expected text</strong><br/><strong class="lq hi">--- FAIL: TestHttpMicroserviceValidity (191.29s)<br/>FAIL<br/>exit status 1<br/>FAIL microservice_test 191.303s</strong></span></pre><h1 id="20a7" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">结论</strong></h1><p id="9c5c" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">一个简单的管道允许我们自动化IaC测试，这是对应用程序测试的完美补充，因此所有涉及的部分都具有预期的行为和性能。进行静态测试是检查代码健康性的一个非常基本的起点，但是为您的基础设施添加集成测试可以降低不确定性和风险，尤其是在将应用程序投入生产之前。</p><h1 id="1199" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">参考</h1><ul class=""><li id="184b" class="ks kt hh ig b ih kb il kc ip lz it ma ix mb jb kx ky kz la bi translated">链接到代码:<a class="ae jc" href="https://github.com/braybaut/tech-insiders-tdi" rel="noopener ugc nofollow" target="_blank">https://github.com/braybaut/tech-insiders-tdi</a></li><li id="de5c" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">GitHub动作文档:<a class="ae jc" href="https://docs.github.com/en/actions" rel="noopener ugc nofollow" target="_blank">https://docs.github.com/en/actions</a></li><li id="aa7c" class="ks kt hh ig b ih lb il lc ip ld it le ix lf jb kx ky kz la bi translated">地形测试文件:<a class="ae jc" href="https://terratest.gruntwork.io/docs/" rel="noopener ugc nofollow" target="_blank">https://terratest.gruntwork.io/docs/</a></li></ul></div></div>    
</body>
</html>