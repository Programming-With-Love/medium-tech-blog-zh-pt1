<html>
<head>
<title>Online Payments Form with React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用React的在线支付表单</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/online-payments-form-react-9ecf164880bf?source=collection_archive---------1-----------------------#2018-11-27">https://medium.com/square-corner-blog/online-payments-form-react-9ecf164880bf?source=collection_archive---------1-----------------------#2018-11-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="6626" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">使用React和Square创建自定义支付表单</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/2935e8e3c6a58730b7ef7779489488e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5OURYE92Pyq3pRWhljys4A.png"/></div></div></figure><p id="5fc3" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">接受在线支付的方式有很多。实现一个可以同时接受任意多种支付方式的表单不是很好吗？让我们看看如何使用<a class="ae kf" href="https://squareup.com/developers" rel="noopener ugc nofollow" target="_blank"> Square </a>和<a class="ae kf" href="https://reactjs.org/" rel="noopener ugc nofollow" target="_blank"> React </a>实现一个定制的支付表单。这种形式将使我们能够在网上使用信用卡，<em class="ke">和</em>使我们能够在单一支付形式中支持Apple Pay、Google Pay和Masterpass。</p><h2 id="427f" class="kg kh hh bd ki kj kk kl km kn ko kp kq jr kr ks kt jv ku kv kw jz kx ky kz la bi translated">理解这篇文章需要的东西:</h2><ul class=""><li id="5105" class="lb lc hh jk b jl ld jo le jr lf jv lg jz lh kd li lj lk ll bi translated"><a class="ae kf" href="https://reactjs.org/" rel="noopener ugc nofollow" target="_blank">反应</a> ( <em class="ke">简化为</em> <code class="du lm ln lo lp b"><a class="ae kf" href="https://github.com/facebook/create-react-app" rel="noopener ugc nofollow" target="_blank">create-react-app</a></code>)</li><li id="f1e6" class="lb lc hh jk b jl lq jo lr jr ls jv lt jz lu kd li lj lk ll bi translated"><a class="ae kf" href="https://docs.connect.squareup.com/payments/sqpaymentform/intro" rel="noopener ugc nofollow" target="_blank">广场的付款形式</a></li></ul><h2 id="03ec" class="kg kh hh bd ki kj kk kl km kn ko kp kq jr kr ks kt jv ku kv kw jz kx ky kz la bi translated">我们的最终(付款)表格:</h2><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es lv"><img src="../Images/469b2d58fcadde65496375b630e7c4a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/format:webp/1*OX259-SlAPzFpWyuVlj6Mg.png"/></div></figure><h1 id="2672" class="lw kh hh bd ki lx ly lz km ma mb mc kq in md io kt iq me ir kw it mf iu kz mg bi translated">React和Square的付款形式</h1><p id="7da5" class="pw-post-body-paragraph ji jj hh jk b jl ld ii jn jo le il jq jr mh jt ju jv mi jx jy jz mj kb kc kd ha bi translated">如果你熟悉React，那么你习惯于传递<code class="du lm ln lo lp b">props</code>并通过它的<code class="du lm ln lo lp b">state</code>控制你的组件。让我们来关注如何设置和运行由React组件控制的Square支付表单。我们还将演示如何动态加载<a class="ae kf" href="https://docs.connect.squareup.com/payments/sqpaymentform/setup#step-2-add-script-references-to-your-payment-page-head" rel="noopener ugc nofollow" target="_blank"> Square支付表单脚本</a>，以防您想简单地在页面上插入支付表单组件。动态加载脚本只有在您不希望脚本只加载到结账页面(或任何您想接受付款的地方)时才有意义。</p><p id="f756" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">如果你不熟悉Square的支付形式，请前往<a class="ae kf" href="https://docs.connect.squareup.com/payments/sqpaymentform/intro" rel="noopener ugc nofollow" target="_blank">查看文档</a>并熟悉一下。有一些模板、解释和指南可以帮助你使用基本的HTML、CSS和JavaScript来设置表单。</p><p id="cbff" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在基本层面上，支付表单使用<code class="du lm ln lo lp b">&lt;iframe&gt;</code>直接在Square的服务器上捕获您客户的卡详细信息。支付表单促进了这些<code class="du lm ln lo lp b">&lt;iframe&gt;</code>元素的生成，并提供了一个API来创建一个<a class="ae kf" href="https://docs.connect.squareup.com/payments/sqpaymentform/overview" rel="noopener ugc nofollow" target="_blank"> nonce </a>(一次性令牌)以在以后引用这些细节(所有这些都不需要您知道任何敏感信息！).</p><p id="885b" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">用这些<code class="du lm ln lo lp b">&lt;iframe&gt;</code>元素替换<a class="ae kf" href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model/Introduction" rel="noopener ugc nofollow" target="_blank"> DOM </a>中的其他元素所遇到的主要问题是，React通常喜欢负责管理所有的DOM交互。这需要在我们的组件上做一些额外的设置，以确保我们以正确的顺序正确地呈现所有内容，并正确地处理由Square支付表单脚本生成的不同事件。</p><h1 id="9803" class="lw kh hh bd ki lx ly lz km ma mb mc kq in md io kt iq me ir kw it mf iu kz mg bi translated">动态加载Square付款表单脚本</h1><p id="ef8e" class="pw-post-body-paragraph ji jj hh jk b jl ld ii jn jo le il jq jr mh jt ju jv mi jx jy jz mj kb kc kd ha bi translated">我们的基础组件是我们实际管理将<code class="du lm ln lo lp b"><a class="ae kf" href="https://docs.connect.squareup.com/payments/sqpaymentform/setup#step-2-add-script-references-to-your-payment-page-head" rel="noopener ugc nofollow" target="_blank">&lt;script src=”https://js.squareup.com/v2/paymentform”&gt;&lt;/script&gt;</a></code>动态加载到DOM的<code class="du lm ln lo lp b">&lt;head&gt;</code>中并触发我们的子组件进行渲染的地方。子组件实际上将负责组装、格式化和管理我们的支付表单。这样做是为了确保脚本已经加载，我们可以将<code class="du lm ln lo lp b"><a class="ae kf" href="https://docs.connect.squareup.com/api/paymentform#paymentform-overview" rel="noopener ugc nofollow" target="_blank">SqPaymentForm</a></code>对象传递给我们的子组件。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="d3b8" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">你可以看到，我们只是在生命周期方法<code class="du lm ln lo lp b">componentWillMount()</code>中使用一些普通的JavaScript来创建一个<code class="du lm ln lo lp b">&lt;script&gt;</code>元素并设置一些属性，然后确保一旦脚本实际加载到页面上，我们就将React组件的状态更新为<code class="du lm ln lo lp b">loaded</code>。这将触发React重新渲染，并在我们的<code class="du lm ln lo lp b">render()</code>方法中为<code class="du lm ln lo lp b">this.state.loaded</code>返回<code class="du lm ln lo lp b">true</code>，并允许我们的子组件进行渲染。</p><p id="2cc7" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们代码的另一个值得注意的部分是我们如何通过<code class="du lm ln lo lp b">paymentForm</code>属性传递<code class="du lm ln lo lp b">SqPaymentForm</code>。我们传入附加到窗口的SqPaymentForm对象，因此呈现支付表单和触发提交更容易管理。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="mm ml l"/></div><figcaption class="mn mo et er es mp mq bd b be z dx">Full code example can also be found at <a class="ae kf" href="https://github.com/mootrichard/square-react-online-payments" rel="noopener ugc nofollow" target="_blank">https://github.com/mootrichard/square-react-online-payments</a></figcaption></figure><h1 id="d4f1" class="lw kh hh bd ki lx ly lz km ma mb mc kq in md io kt iq me ir kw it mf iu kz mg bi translated">反应付款表单组件</h1><p id="7337" class="pw-post-body-paragraph ji jj hh jk b jl ld ii jn jo le il jq jr mh jt ju jv mi jx jy jz mj kb kc kd ha bi translated">为了简单起见，我们正在修改在<a class="ae kf" href="https://github.com/square/connect-api-examples/tree/master/templates/web-ui/payment-form/basic-digital-wallet" rel="noopener ugc nofollow" target="_blank"> Square的GitHub </a>上找到的现有模板。有关定制或设置Square支付表单的更多信息，请查看我们的<a class="ae kf" href="https://docs.connect.squareup.com/payments/sqpaymentform/intro" rel="noopener ugc nofollow" target="_blank">指南</a>。我们将更多地关注这些模板和React组件之间的区别。</p><h2 id="bb13" class="kg kh hh bd ki kj kk kl km kn ko kp kq jr kr ks kt jv ku kv kw jz kx ky kz la bi translated">我们的render()方法</h2><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="mk ml l"/></div><figcaption class="mn mo et er es mp mq bd b be z dx">This is the `render()` method of our payment form component.</figcaption></figure><p id="5141" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们拥有的元素中需要注意的关键部分是divs元素，它们的id是:<code class="du lm ln lo lp b">sq-apple-pay</code>、<code class="du lm ln lo lp b">sq-masterpass</code>、<code class="du lm ln lo lp b">sq-google-pay</code>、<code class="du lm ln lo lp b">sq-card-number</code>、<code class="du lm ln lo lp b">sq-cvv</code>、<code class="du lm ln lo lp b">sq-expiration-date</code>和<code class="du lm ln lo lp b">sq-postal-code</code>。我们将示例转换为对所有内容使用div，而不是表单组件，因为这些都是Square的支付表单脚本要替换为<code class="du lm ln lo lp b">&lt;iframe&gt;</code>元素的目标字段。此外，由于我们使用React，我们将拥有自己的函数来控制提交和触发支付表单的nonce请求。</p><h2 id="acea" class="kg kh hh bd ki kj kk kl km kn ko kp kq jr kr ks kt jv ku kv kw jz kx ky kz la bi translated">支持数字钱包支付和方式</h2><p id="14e4" class="pw-post-body-paragraph ji jj hh jk b jl ld ii jn jo le il jq jr mh jt ju jv mi jx jy jz mj kb kc kd ha bi translated">要调整您想要支持的数字钱包选项(<em class="ke">有时称为移动钱包选项</em>)，只需在您的<code class="du lm ln lo lp b">SqPaymentForm</code>配置对象中提供不同的键-值对(<a class="ae kf" href="https://docs.connect.squareup.com/payments/sqpaymentform/digitalwallet/intro" rel="noopener ugc nofollow" target="_blank">参见此处的更多内容</a>)。您应该能够在<code class="du lm ln lo lp b">render()</code>方法中看到，我们正在使用组件的<code class="du lm ln lo lp b">state</code>来控制移动支付选项的显示。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="mk ml l"/></div></figure><p id="7281" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们在Square支付表单提供给我们的<code class="du lm ln lo lp b">methodsSupported()</code>回调中设置状态。由于每个移动钱包选项都特定于客户访问的浏览器，因此您需要有条件地呈现按钮，以匹配基于客户的浏览器或移动设备的可用内容。我们还必须创建这些单独的条件，因为支付表单为您选择支持的每个方法调用一次<code class="du lm ln lo lp b">methodsSupport()</code>函数。我们的示例试图支持Masterpass、Apple Pay和Google Pay，因此将进行三个调用。我们对<code class="du lm ln lo lp b">setState()</code>的调用有点咄咄逼人，但是只有三个调用，所以不用担心——如果您在其他地方调用<code class="du lm ln lo lp b">setState()</code>,请记住这一点，因为每个调用都会触发组件的重新呈现。</p><h2 id="46d2" class="kg kh hh bd ki kj kk kl km kn ko kp kq jr kr ks kt jv ku kv kw jz kx ky kz la bi translated">链接和控制组件</h2><p id="a6da" class="pw-post-body-paragraph ji jj hh jk b jl ld ii jn jo le il jq jr mh jt ju jv mi jx jy jz mj kb kc kd ha bi translated">主要的收获是在提供的回调中使用<code class="du lm ln lo lp b">state</code>。在组件中使用<code class="du lm ln lo lp b">state</code>允许我们对Square的支付表单脚本发出的不同事件做出反应。你可以在文档中了解更多关于这些事件的信息。在我们的例子中，这个连接的一个关键地方是<code class="du lm ln lo lp b">inputEventReceived()</code>回调，因为它在每个输入事件中都被调用。在我们的示例组件中，一旦支付表单识别了卡，我们就更新卡的品牌(在右上角)。</p><h1 id="a4ab" class="lw kh hh bd ki lx ly lz km ma mb mc kq in md io kt iq me ir kw it mf iu kz mg bi translated">想法和结论</h1><p id="fe4c" class="pw-post-body-paragraph ji jj hh jk b jl ld ii jn jo le il jq jr mh jt ju jv mi jx jy jz mj kb kc kd ha bi translated">这只是React中实现Square支付表单的一种方法。最初，尝试将config对象作为道具传入似乎是个好主意，但这对于配置回调函数来说并不太好，除非你愿意在创建<code class="du lm ln lo lp b">paymentForm</code>对象之前覆盖它们(这只是<em class="ke">觉得</em>不对)。</p><p id="b5e9" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我见过开发人员犯错的主要地方通常是不禁用<code class="du lm ln lo lp b"><a class="ae kf" href="https://docs.connect.squareup.com/api/paymentform#paymentform-configurationfields" rel="noopener ugc nofollow" target="_blank">autoBuild</a></code>。<code class="du lm ln lo lp b">paymentform</code>脚本将在构建时立即寻找具有所提供的元素id的元素，但是问题出现了，因为React可能还没有将元素呈现给DOM。最好通过调用<code class="du lm ln lo lp b">.build()</code>来触发构建过程，从而控制构建过程。</p><p id="0506" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">React中表单的实现相当简单(如果你了解React的话)，只需要理解与<code class="du lm ln lo lp b">paymentform</code>生命周期相关的React生命周期。</p><p id="2ce0" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">你可以在:<a class="ae kf" href="https://github.com/mootrichard/square-react-online-payments" rel="noopener ugc nofollow" target="_blank">https://github.com/mootrichard/square-react-online-payments</a>找到这种形式的完整例子。</p><p id="f19e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">如果你喜欢React + Square上的这篇文章，但希望看到使用<a class="ae kf" href="https://reactjs.org/docs/hooks-intro.html" rel="noopener ugc nofollow" target="_blank"> React的Hooks API </a>、<a class="ae kf" href="https://twitter.com/@wootmoot" rel="noopener ugc nofollow" target="_blank"> tweet at me </a>，在Medium上回复，或者在<a class="ae kf" href="https://squ.re/slack" rel="noopener ugc nofollow" target="_blank">我们的Slack社区</a>中给我发bug，我会跟进一篇关于如何使用React Hooks API重构这个例子的文章。</p></div><div class="ab cl mr ms go mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="ha hb hc hd he"><p id="00b7" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="ke">想要更多？</em> <a class="ae kf" href="https://www.workwithsquare.com/developer-newsletter.html?channel=Online%20Social&amp;sqmethod=Blog" rel="noopener ugc nofollow" target="_blank"> <em class="ke">注册</em> </a> <em class="ke">订阅我们的每月开发者简讯或来和我们一起在Square Dev</em><a class="ae kf" href="https://squ.re/slack" rel="noopener ugc nofollow" target="_blank"><em class="ke">Slack channel</em></a><em class="ke">！也可以在Twitter上关注我们，地址:</em><a class="ae kf" href="https://twitter.com/@SquareDev" rel="noopener ugc nofollow" target="_blank"><em class="ke">@ square dev</em></a><em class="ke">。</em></p></div></div>    
</body>
</html>