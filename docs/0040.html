<html>
<head>
<title>Introducing Syslog to AWS Kinesis via Osquery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Osquery将Syslog引入AWS Kinesis</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/introducing-syslog-to-aws-kinesis-via-osquery-da4fc19de5ce?source=collection_archive---------0-----------------------#2016-05-03">https://medium.com/airbnb-engineering/introducing-syslog-to-aws-kinesis-via-osquery-da4fc19de5ce?source=collection_archive---------0-----------------------#2016-05-03</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/a210df8bff7b573a548acc248da170b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8OFAdmU_8MeRyuDP4k17yA.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Logs awaiting collection (<a class="ae it" href="https://commons.wikimedia.org/wiki/File:Logs_in_Yyteri.JPG" rel="noopener ugc nofollow" target="_blank">Logs in Yyteri</a> by kallerna, licensed under Creative Commons)</figcaption></figure><p id="768d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在Airbnb，我们致力于保护我们的社区。这个博客是这一努力的延伸，因为我们将定期更新我们对安全计划和更广泛的社区的投资。</p><p id="4b9a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="js">对于我们开放的安全相关帖子，我们很高兴地宣布我们已经开源了</em> <a class="ae it" href="https://osquery.io/" rel="noopener ugc nofollow" target="_blank"> <em class="js"> osquery </em> </a> <em class="js">表，允许企业收集和查询OS X和Linux主机的系统日志数据！这允许您捕获特权操作(sudo)、横向移动(sshd)、影响系统可用性/可靠性的错误等等。除了这些表格，我们还开源了osquery插件，允许你将查询结果发送到亚马逊的Kinesis Streams和Firehose产品。请阅读以下内容了解更多信息！</em></p><h2 id="3b87" class="jt ju hh bd jv jw jx jy jz ka kb kc kd jf ke kf kg jj kh ki kj jn kk kl km kn bi translated">简化</h2><p id="de7e" class="pw-post-body-paragraph iu iv hh iw b ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn ks jp jq jr ha bi translated">我们想要一个支持OS X和Linux的代理:</p><ul class=""><li id="c120" class="kt ku hh iw b ix iy jb jc jf kv jj kw jn kx jr ky kz la lb bi translated">文件完整性监控(FIM)</li><li id="b489" class="kt ku hh iw b ix lc jb ld jf le jj lf jn lg jr ky kz la lb bi translated">IOC(危害指示器)入侵检测<br/> (IPs、域、端口、文件名/路径/哈希等)</li><li id="2f0f" class="kt ku hh iw b ix lc jb ld jf le jj lf jn lg jr ky kz la lb bi translated">基于状态的入侵检测<br/>(外壳历史、/etc/hosts、NFS共享、防火墙设置……)</li><li id="bbe5" class="kt ku hh iw b ix lc jb ld jf le jj lf jn lg jr ky kz la lb bi translated">系统日志收集</li><li id="236a" class="kt ku hh iw b ix lc jb ld jf le jj lf jn lg jr ky kz la lb bi translated">灵活的远程日志记录</li></ul><p id="ec48" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">osquery是我们考虑的第一个选项。</p><p id="aa45" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">对于那些不熟悉osquery的人来说，它是一个开源工具，将操作系统公开为一个高性能的关系数据库。您可以针对表示系统属性(如用户、进程、设备、网络连接等)的表编写基于SQL的查询。</p><p id="0614" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">开箱即用，osquery支持我们所有的用例，除了一个:<strong class="iw hi">OS X的Syslog收集&amp; Linux。</strong></p><p id="7212" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">因为osquery是一个开源项目，所以我们构建了syslog表并回馈给社区！</p><p id="3727" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在我们进入细节之前，重要的是要注意我们只使用了安全的、受支持的操作系统API。您不会发现任何内核攻击或外壳，就像您在安全供应商产品中常见的那样。你可以自己看代码<a class="ae it" href="https://github.com/facebook/osquery/pull/1915/files" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae it" href="https://github.com/facebook/osquery/pull/1961/files" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><blockquote class="lh"><p id="2198" class="li lj hh bd lk ll lm ln lo lp lq jr dx translated">因为osquery是一个开源项目，所以我们构建了syslog表并回馈给社区</p></blockquote><h2 id="21cc" class="jt ju hh bd jv jw lr jy jz ka ls kc kd jf lt kf kg jj lu ki kj jn lv kl km kn bi translated">苹果系统日志</h2><p id="479f" class="pw-post-body-paragraph iu iv hh iw b ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn ks jp jq jr ha bi translated">我们的第一个贡献是osquery表，它允许您显示、收集和查询OS X ASL系统日志数据，而无需任何额外的配置。</p><p id="c24a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在下面的假设示例中，我们查询在给定主机上执行的特权操作。查询结果显示，攻击者修改了<em class="js"> /etc/hosts </em>，将他们的权限提升到root，并加载了一个键盘记录器:</p><figure class="lx ly lz ma fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lw"><img src="../Images/cb2b26f9903fa62f12d14a64702347b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GfhZ-1DQHvel_60mbDx4WQ.png"/></div></div></figure><p id="861a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">除了与安全相关的查询，您还可以查询ASL以发现影响系统可用性或可靠性的错误:</p><figure class="lx ly lz ma fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mb"><img src="../Images/93fa90e97f861397fdefd21c343060f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9T-iZn8f0PBOBAxkLSTjjQ.png"/></div></div></figure><p id="484f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在我们的例子中，ASL表通知我们，我们的VPN客户端正在用调试信息淹没syslog，这是一个在以后的构建中解决的错误。</p><p id="4ad0" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">ASL表定义为<a class="ae it" href="https://osquery.io/docs/tables/#asl" rel="noopener ugc nofollow" target="_blank">此处为</a>，其他用法和配置详情可在<a class="ae it" href="https://github.com/facebook/osquery/blob/master/docs/wiki/deployment/syslog.md#osx-syslog" rel="noopener ugc nofollow" target="_blank">此处</a>找到。</p><h2 id="cc0b" class="jt ju hh bd jv jw jx jy jz ka kb kc kd jf ke kf kg jj kh ki kj jn kk kl km kn bi translated">Linux系统日志</h2><p id="3a57" class="pw-post-body-paragraph iu iv hh iw b ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn ks jp jq jr ha bi translated">我们的第二个贡献是osquery表，它允许您显示、收集和查询Linux syslog数据。</p><p id="45a1" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">使用osquery的<a class="ae it" href="https://osquery.readthedocs.org/en/stable/development/pubsub-framework/" rel="noopener ugc nofollow" target="_blank">事件框架</a>，我们通过命名管道接收从rsyslog转发的日志，维护数据完整性的适当权限。然后，我们可以通过新表使用这些日志。这与osquery和rsyslog (Ubuntu 12/14，CentOS，RHEL……)支持的任何Linux发行版兼容。</p><p id="953f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，您可以相对轻松地更好地了解您的基础架构:</p><figure class="lx ly lz ma fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mc"><img src="../Images/320957f8d28c2eb1ea91f68a3015dfcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kavOifgGnSAqviRHT_ldBw.png"/></div></div></figure><p id="6c76" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">关于Linux系统日志表的其他用法和配置细节可以在<a class="ae it" href="https://github.com/facebook/osquery/blob/master/docs/wiki/deployment/syslog.md#linux-syslog" rel="noopener ugc nofollow" target="_blank">这里</a>找到。这个特性被合并到osquery的<em class="js"> master </em>分支中，预计将随osquery v1.7.4一起发布。</p><h2 id="7f50" class="jt ju hh bd jv jw jx jy jz ka kb kc kd jf ke kf kg jj kh ki kj jn kk kl km kn bi translated">系统日志挑战</h2><p id="1d68" class="pw-post-body-paragraph iu iv hh iw b ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn ks jp jq jr ha bi translated">默认情况下，OS X不会将其所有日志发送到苹果系统日志(ASL)。例如，下面是两个不发送给ASL的日志，它们捕获关于应用程序和软件包安装的信息:</p><p id="b922" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="js">/var/log/install . log<br/>/var/log/commerce . log</em></p><p id="cc21" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们辛苦了几个小时，试图通过<em class="js"> /etc/asl.conf </em>和<em class="js"> /etc/syslog.conf </em>捕获这些数据。我们用谷歌搜索，我们阅读了页面，什么都没有。由于/System/Library/private frameworks/*中的一些引用，我们几乎得出结论，这些路径是硬编码的。</p><p id="60fd" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当我们仔细重读手册的第<em class="js">页时，我们偶然发现了成功:</em></p><pre class="lx ly lz ma fd md me mf mg aw mh bi"><span id="27c0" class="jt ju hh me b fi mi mj l mk ml">Messages that match the query associated with a '<strong class="me hi">claim'</strong> action are not processed by the main ASL configuration file <em class="js">/etc/asl.conf</em>.</span><span id="958f" class="jt ju hh me b fi mm mj l mk ml">....</span></pre><p id="8587" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">因此，我们可以通过将<em class="js">存储</em>动作添加到以下文件中并重启syslogd来让这些日志流入ASL:</p><pre class="lx ly lz ma fd md me mf mg aw mh bi"><span id="b542" class="jt ju hh me b fi mi mj l mk ml"><strong class="me hi"><em class="js">/etc/asl/com.apple.install:</em></strong><em class="js"><br/>  ? [= Facility install] store</em></span><span id="a8ac" class="jt ju hh me b fi mm mj l mk ml"><strong class="me hi"><em class="js">/etc/asl/com.apple.commerce.asl:</em></strong><em class="js"><br/>  ? [= Facility com.apple.commerce] store</em></span></pre><p id="8496" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">有些不幸的使用案例中，应用程序可能不会(或不能)记录到系统日志。因此，我们将为OS X和Linux开发一个osquery表，它可以使用任何日志文件，并以如下模式呈现它:<em class="js"> {path，line，time，message}。</em></p><h2 id="788c" class="jt ju hh bd jv jw jx jy jz ka kb kc kd jf ke kf kg jj kh ki kj jn kk kl km kn bi translated">亚马逊Kinesis溪流和消防水管</h2><p id="a6fb" class="pw-post-body-paragraph iu iv hh iw b ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn ks jp jq jr ha bi translated">除了系统日志表，<strong class="iw hi">我们还发布了osquery插件，允许将任何查询结果发送到亚马逊kine sis Streams&amp;kine sis fire hose。</strong>这个功能是<a class="ae it" href="https://github.com/facebook/osquery/pull/2045" rel="noopener ugc nofollow" target="_blank">合并</a>到osquery的<em class="js"> master </em>分支，预计会随osquery v1.7.4一起发货，这些插件使用AWS C++ SDK来避免部署Amazon Kinesis代理的需要。</p><p id="5f88" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Kinesis Streams和Kinesis Firehose让我们可以灵活地处理和存储日志。自动扩展功能和与S3(每GB约0.0300美元)等服务的互操作性使其成本效益高，维护成本低。</p><p id="5dce" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在一篇即将发布的博客文章中，Airbnb安全工程师<a class="ae it" href="https://twitter.com/jack_naglieri" rel="noopener ugc nofollow" target="_blank"> Jack Naglieri </a>将详细介绍我们的kine sis Streams&amp;kine sis fire hose用例及基础设施。敬请期待！</p><h2 id="63a5" class="jt ju hh bd jv jw jx jy jz ka kb kc kd jf ke kf kg jj kh ki kj jn kk kl km kn bi translated">总结想法</h2><p id="1e1e" class="pw-post-body-paragraph iu iv hh iw b ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn ks jp jq jr ha bi translated">这项工程工作是扎克·乏色曼爱的结晶。我们要感谢Teddy Reed和Mike Arpaia的代码审查和帮助。</p><p id="08b6" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为这个开源项目做贡献非常有趣，我们鼓励其他人也这样做！一个很棒的回馈方式是通过<a class="ae it" href="https://osquery.io/docs/packs/" rel="noopener ugc nofollow" target="_blank">查询包</a> <a class="ae it" href="https://github.com/facebook/osquery/tree/master/packs" rel="noopener ugc nofollow" target="_blank">贡献</a>将您的syslog相关查询分享给社区。</p><p id="f2c8" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们希望这篇博文和我们的开源贡献能够鼓励其他人和我们一起探索这个日志架构。</p><p id="6e77" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">干杯！<br/><a class="ae it" href="https://twitter.com/mimeframe" rel="noopener ugc nofollow" target="_blank"><em class="js">@ mime frame</em></a><em class="js"><br/>Airbnb安全经理</em></p><figure class="lx ly lz ma fd ii er es paragraph-image"><div class="er es mn"><img src="../Images/3913f6470a7657e02386189e67b4eb30.png" data-original-src="https://miro.medium.com/v2/resize:fit:108/format:webp/1*YsUOrWx3mRxZZljtc9xZyw.png"/></div></figure><h2 id="8e81" class="jt ju hh bd jv jw jx jy jz ka kb kc kd jf ke kf kg jj kh ki kj jn kk kl km kn bi translated">在<a class="ae it" href="http://airbnb.io" rel="noopener ugc nofollow" target="_blank"> airbnb.io </a>查看我们所有的开源项目，并在Twitter上关注我们:<a class="ae it" href="https://twitter.com/AirbnbEng" rel="noopener ugc nofollow" target="_blank">@ Airbnb eng</a>+<a class="ae it" href="https://twitter.com/AirbnbData" rel="noopener ugc nofollow" target="_blank">@ Airbnb data</a></h2></div></div>    
</body>
</html>