<html>
<head>
<title>Using Dekorate to build manifests for Kubernetes and Tekton</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Dekorate为Kubernetes和Tekton建立清单</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/using-dekorate-to-build-manifests-for-kubernetes-and-tekton-ebea854986a1?source=collection_archive---------1-----------------------#2022-03-24">https://medium.com/oracledevs/using-dekorate-to-build-manifests-for-kubernetes-and-tekton-ebea854986a1?source=collection_archive---------1-----------------------#2022-03-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/348f73676b498158b1f23cb3e6b9a0af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z5ms5ZncEEjzLAGwo0u3BQ.jpeg"/></div></div></figure><p id="1c42" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在<a class="ae jn" href="https://lmukadam.medium.com/running-continuous-integration-on-oke-with-tekton-353684c15730" rel="noopener">之前的一篇文章</a>中，我们讨论了如何使用Tekton构建容器映像，以便将它们推送到OCIR。本着同样的精神，本文将研究如何在另一个用例中使用Tekton。</p><p id="c687" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一旦构建了容器映像并将它们保存到容器注册中心，就需要部署它们。这通常是通过简单的yaml清单、添加了一些脚本功能的helm charts、jsonner或类似工具来完成的。</p><p id="5362" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">问题是，如果您正在部署大量的应用程序，那么您将需要编写大量的YAMLs。肯定有更好的方法来做这些繁重的工作，对吗？事实证明，是有的。进入<a class="ae jn" href="https://dekorate.io/" rel="noopener ugc nofollow" target="_blank"> Dekorate </a>，这是一个简洁的项目，提供了“Kubernetes清单的生成器和装饰器的集合”。这将省去我们手写Kubernetes和Tekton货单的麻烦。</p><p id="aadd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="jo">注意:如果您还没有注册，您可以今天就</em> <a class="ae jn" href="https://signup.cloud.oracle.com/?language=en_US&amp;sourceType=:ex:tb:::::RC_WWMK220210P00062:Medium_DekorateManifestKubernetes&amp;SC=:ex:tb:::::RC_WWMK220210P00062:Medium_DekorateManifestKubernetes&amp;pcode=WWMK220210P00062" rel="noopener ugc nofollow" target="_blank"> <em class="jo">注册Oracle云免费层帐户</em> </a> <em class="jo">。</em></p><p id="b916" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">首先，打开pom.xml并添加dekorate依赖项:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="86df" class="jy jz hh ju b fi ka kb l kc kd">&lt;dependency&gt;<br/> &lt;groupId&gt;io.dekorate&lt;/groupId&gt;<br/> &lt;artifactId&gt;kubernetes-spring-starter&lt;/artifactId<br/> &lt;version&gt;2.0.0.beta8&lt;/version&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/> &lt;groupId&gt;io.dekorate&lt;/groupId&gt;<br/> &lt;artifactId&gt;kubernetes-annotations&lt;/artifactId<br/> &lt;version&gt;2.0.0.beta8&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="9758" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">接下来，打开应用程序文件并添加以下导入和注释:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="4a12" class="jy jz hh ju b fi ka kb l kc kd">import io.dekorate.kubernetes.annotation.KubernetesApplication; import io.dekorate.kubernetes.annotation.Label;<br/>import io.dekorate.kubernetes.annotation.Port;<br/>import io.dekorate.kubernetes.annotation.Probe;<br/>import io.dekorate.kubernetes.annotation.ResourceRequirements;<br/><a class="ae jn" href="http://twitter.com/SpringBootApplicatio" rel="noopener ugc nofollow" target="_blank">@SpringBootApplicatio</a>n<br/><a class="ae jn" href="http://twitter.com/KubernetesApplicatio" rel="noopener ugc nofollow" target="_blank">@KubernetesApplicatio</a>n(<br/> name = “helloworld”,<br/> labels = <a class="ae jn" href="http://twitter.com/Label" rel="noopener ugc nofollow" target="_blank">@Label</a>(key = “app”, value = “helloworld”),<br/> ports = <a class="ae jn" href="http://twitter.com/Port" rel="noopener ugc nofollow" target="_blank">@Port</a>(name = “http”, containerPort = 8080),<br/> livenessProbe = <a class="ae jn" href="http://twitter.com/Probe" rel="noopener ugc nofollow" target="_blank">@Probe</a>(httpActionPath = “/health/liveness”, <br/> initialDelaySeconds = 5, timeoutSeconds = 3, failureThreshold = 10),<br/> readinessProbe = <a class="ae jn" href="http://twitter.com/Probe" rel="noopener ugc nofollow" target="_blank">@Probe</a>(httpActionPath = “/health/readiness”,<br/> initialDelaySeconds = 5, timeoutSeconds = 3, failureThreshold = 10),<br/> requestResources=<a class="ae jn" href="http://twitter.com/ResourceRequirements" rel="noopener ugc nofollow" target="_blank">@ResourceRequirements</a>(memory=”64Mi”, cpu=”1m”),<br/> limitResources=<a class="ae jn" href="http://twitter.com/ResourceRequirements" rel="noopener ugc nofollow" target="_blank">@ResourceRequirements</a>(memory=”256Mi”, cpu=”5m”)<br/>)</span></pre><p id="cecb" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您可以添加其他注释，但是现在，我们只对生成Kubernetes的清单感兴趣。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="ca2f" class="jy jz hh ju b fi ka kb l kc kd">mvn clean package -DskipTests</span><span id="5880" class="jy jz hh ju b fi ke kb l kc kd">[INFO] --- maven-compiler-plugin:3.8.1:compile (default-compile) @ helloworld ---                                                                                                             <br/>[INFO] Changes detected - recompiling the module!                                                                                                                                             <br/>[INFO] Compiling 1 source file to D:\dev\java\helloworld\target\classes                                                                                                                       <br/>[INFO] Found @KubernetesApplication on: net.midgard.helloworld.HelloworldApplication                                                                                                          <br/>[INFO] Initializing dekorate session.                                                                                                                                                         <br/>[INFO] Found @SpringBootApplication on: net.midgard.helloworld.HelloworldApplication                                                                                                          <br/>[INFO] Generating manifests.                                                                                                                                                                  <br/>[INFO] Processing kubernetes configuration.                                                                                                                                                   <br/>[INFO] Writing: file:///D:/dev/java/helloworld/target/classes/META-INF/dekorate/kubernetes.json                                                                                               <br/><strong class="ju hi">[INFO] Writing: file:///D:/dev/java/helloworld/target/classes/META-INF/dekorate/kubernetes.yml</strong>                                                                                                <br/>[INFO] Closing dekorate session.</span></pre><p id="07c9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您打开kubernetes.yaml，您将看到kubernetes部署和服务对象已经创建:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="c3f8" class="jy jz hh ju b fi ka kb l kc kd">---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  annotations:<br/>    app.dekorate.io/vcs-url: <a class="ae jn" href="https://github.com/hyder/helloworld.git" rel="noopener ugc nofollow" target="_blank">https://github.com/hyder/helloworld.git</a><br/>    app.dekorate.io/commit-id: 816776b01175d5a8663ee9f74c05029477bd3eda<br/>  labels:<br/>    app: helloworld<br/>    app.kubernetes.io/name: helloworld<br/>    app.kubernetes.io/version: 0.0.1-SNAPSHOT<br/>  name: helloworld<br/>....<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  annotations:<br/>    app.dekorate.io/vcs-url: <a class="ae jn" href="https://github.com/hyder/helloworld.git" rel="noopener ugc nofollow" target="_blank">https://github.com/hyder/helloworld.git</a><br/>    app.dekorate.io/commit-id: 816776b01175d5a8663ee9f74c05029477bd3eda<br/>  labels:<br/>    app.kubernetes.io/version: 0.0.1-SNAPSHOT<br/>    app: helloworld<br/>    app.kubernetes.io/name: helloworld<br/>  name: helloworld<br/>...</span></pre><p id="a3fd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在，您可以将这些文件复制到Kubernetes应用程序infra git repo中，并让ArgoCD之类的CD工具为您自动部署。</p><p id="5ac2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您还可以使用Dekorate为您生成Tekton任务、管道、任务运行和管道运行。只需将以下内容添加到pom.xml:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="febc" class="jy jz hh ju b fi ka kb l kc kd">&lt;dependency&gt;<br/>  &lt;groupId&gt;io.dekorate&lt;/groupId&gt;<br/>  &lt;artifactId&gt;tekton-annotations&lt;/artifactId<br/>  &lt;version&gt;2.0.0.beta8&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="132d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">此时，如果您尝试打包，将会失败，并显示以下错误消息:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="a627" class="jy jz hh ju b fi ka kb l kc kd">[ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.8.1:compile (default-compile) on project helloworld: Fatal error compiling: java.lang.IllegalStateException: Project is not under version control, or unsupported version control system. Aborting generation of tekton resources! -&gt; [Help 1]</span></pre><p id="46d3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">那是因为我们还没有管理这个项目的版本。所以，让我们用git初始化它:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="2794" class="jy jz hh ju b fi ka kb l kc kd">git init<br/>git add .<br/>git commit</span></pre><p id="688c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Spring Initializr已经在下载时在zip中添加了一个. gitignore文件，所以我们现在不需要担心忽略任何东西。让我们再次尝试打包，我们将看到生成了Kubernetes和Tekton清单:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="a157" class="jy jz hh ju b fi ka kb l kc kd">mvn clean package<br/>…<br/>[INFO] Writing: file:///D:/dev/java/helloworld/target/classes/META-INF/dekorate/kubernetes.json <br/>[INFO] <strong class="ju hi">Writing: file:///D:/dev/java/helloworld/target/classes/META-INF/dekorate/kubernetes.yml</strong> <br/>[INFO] Writing: file:///D:/dev/java/helloworld/target/classes/META-INF/dekorate/tekton-task-run.json <br/>[INFO] <strong class="ju hi">Writing: file:///D:/dev/java/helloworld/target/classes/META-INF/dekorate/tekton-task-run.yml</strong> <br/>[INFO] Writing: file:///D:/dev/java/helloworld/target/classes/META-INF/dekorate/tekton-pipeline-run.json <br/>[INFO] <strong class="ju hi">Writing: file:///D:/dev/java/helloworld/target/classes/META-INF/dekorate/tekton-pipeline-run.yml</strong> <br/>[INFO] Writing: file:///D:/dev/java/helloworld/target/classes/META-INF/dekorate/tekton-pipeline.json <br/>[INFO] <strong class="ju hi">Writing: file:///D:/dev/java/helloworld/target/classes/META-INF/dekorate/tekton-pipeline.yml</strong> <br/>[INFO] Writing: file:///D:/dev/java/helloworld/target/classes/META-INF/dekorate/tekton-task.json <br/>[INFO] <strong class="ju hi">Writing: file:///D:/dev/java/helloworld/target/classes/META-INF/dekorate/tekton-task.yml</strong></span></pre><p id="044f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我希望这篇文章对你有用。</p><h1 id="547a" class="kf jz hh bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">加入对话！</h1><p id="0cef" class="pw-post-body-paragraph ip iq hh ir b is lc iu iv iw ld iy iz ja le jc jd je lf jg jh ji lg jk jl jm ha bi translated">如果你对Oracle开发人员在他们的自然环境中发生的事情感到好奇，请加入我们的公共休闲频道！我们不介意成为你的鱼缸🐠</p><p id="3219" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">由<a class="ae jn" href="https://unsplash.com/@vorosbenisop?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">本杰明·沃罗斯</a>在<a class="ae jn" href="https://unsplash.com/s/photos/sky-moon?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></div></div>    
</body>
</html>