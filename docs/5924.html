<html>
<head>
<title>Using SQLAlchemy 2.0 with python-oracledb for Oracle Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将SQLAlchemy 2.0与python-oracledb一起用于Oracle数据库</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/using-the-development-branch-of-sqlalchemy-2-0-with-python-oracledb-d6e89090899c?source=collection_archive---------0-----------------------#2022-06-10">https://medium.com/oracledevs/using-the-development-branch-of-sqlalchemy-2-0-with-python-oracledb-d6e89090899c?source=collection_archive---------0-----------------------#2022-06-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/10fd266ab65e24951cca2ae74c49ea3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F61wyjujc2lFAUF_9LgeTg.png"/></div></div></figure><p id="5ed8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">更新:<strong class="ir hi"> SQLAlchemy 2已经</strong> <a class="ae jn" href="https://www.sqlalchemy.org/blog/2023/01/26/sqlalchemy-2.0.0-released/" rel="noopener ugc nofollow" target="_blank"> <strong class="ir hi">发布</strong> </a> <strong class="ir hi">！</strong>祝贺开发团队。下面的帖子是在最终发布之前写的，但是已经更新了。</p><p id="981e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">早些时候，我在博客<a class="ae jn" href="https://levelup.gitconnected.com/using-python-oracledb-1-0-with-sqlalchemy-pandas-django-and-flask-5d84e910cb19" rel="noopener ugc nofollow" target="_blank">中讲述了如何在SQLAlchemy 1.4中使用python-oracledb 1.0，并展示了几行额外的代码来将新的驱动程序名称映射到我们的旧名称cx_Oracle。</a></p><p id="36c5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">对python-oracledb名称空间的本机支持已经<a class="ae jn" href="https://github.com/sqlalchemy/sqlalchemy/commit/1961e1321440a1e0500ecd13624837ed088eaceb#diff-d58626ed254b6d1d057fdd34e0aa8b56286406bd0be23ca7b534f9c95c4590dbR9-R41" rel="noopener ugc nofollow" target="_blank">合并</a>到SQLAlchemy 2.0。这里有一个小例子，展示了如何以默认的“瘦”模式(不需要Oracle客户端库)或“胖”模式(如果您想要额外的功能<a class="ae jn" href="https://python-oracledb.readthedocs.io/en/latest/user_guide/appendix_a.html#featuresummary" rel="noopener ugc nofollow" target="_blank"/>)进行连接。所有SQLAlchemy功能都以瘦模式传递，因此，如果您希望扩展应用程序(例如，使用Oracle高级队列功能)，或者如果您希望使用Oracle应用程序连续性的可靠性，则只需要胖模式。</p><p id="6ec3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">首先，我将SQLAlchemy升级到最新版本:</p><p id="80f8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">python -m pip install sqlalchemy --upgrade</code></p><p id="9d26" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当然，还安装了python-oracledb:</p><p id="5f8b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">python -m pip install oracledb</code></p><p id="c699" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">接下来，我创建了一个文件<code class="du jo jp jq jr b"><a class="ae jn" href="https://gist.github.com/cjbj/b060bb09adc83f29a1afab1e665d9222" rel="noopener ugc nofollow" target="_blank">sa-pydb.py</a></code>，如下所示。</p><p id="5b2d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最后，我将环境变量<code class="du jo jp jq jr b">PYTHON_USERNAME</code>和<code class="du jo jp jq jr b">PYTHON_PASSWORD</code>设置为我的数据库凭证。我将<code class="du jo jp jq jr b">PYTHON_CONNECTSTRING</code>设置为一个“Easy Connect”字符串“localhost/orclpdb1 ”,它包含主机名和在该主机上运行的数据库服务。</p><p id="c346" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">运行程序:</p><p id="e9bc" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">python sa-pydb.py</code></p><p id="ee1e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">给出查询输出</p><p id="d240" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">python-oracledb thn : 1.0.0</code></p><p id="0a67" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">显示正在使用默认的“瘦”模式。</p><p id="5159" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">取消注释其中一行<code class="du jo jp jq jr b">thick_mode</code>给出:</p><p id="5587" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">python-oracledb thk : 1.0.0</code></p><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="56db" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">注意<code class="du jo jp jq jr b">+oracledb</code>的使用，这是SQLAlchemy 2.0中新增的。additional关键字区分cx_Oracle和python-oracledb的使用。</p><p id="fd67" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">python-oracledb <code class="du jo jp jq jr b"><a class="ae jn" href="https://python-oracledb.readthedocs.io/en/latest/api_manual/module.html#oracledb.connect" rel="noopener ugc nofollow" target="_blank">connect()</a></code>函数可以接受许多参数。这些可以用SQLAlchemy connect_args传递，例如:</p><pre class="js jt ju jv fd jy jr jz ka aw kb bi"><span id="4b62" class="kc kd hh jr b fi ke kf l kg kh">engine = create_engine(<br/>    f'oracle+oracledb://{username}:{password}@',<br/>    thick_mode=thick_mode,<br/>    connect_args={<br/>        "host": cp.host,<br/>        "port": cp.port,<br/>        "service_name": cp.service_name<br/>    })</span></pre><p id="5040" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">或者，对我来说更方便的是:</p><pre class="js jt ju jv fd jy jr jz ka aw kb bi"><span id="b012" class="kc kd hh jr b fi ke kf l kg kh">engine = create_engine(<br/>    f'oracle+oracledb://{username}:{password}@',<br/>    thick_mode=thick_mode,<br/>    connect_args={<br/>        "dsn": os.environ.get("PYTHON_CONNECTSTRING")<br/>    })</span></pre><p id="d6bd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要使用wallet在默认瘦模式下连接到Oracle自治数据库(如果您尚未切换到无wallet单向TLS)，您可以使用类似以下的内容:</p><pre class="js jt ju jv fd jy jr jz ka aw kb bi"><span id="bae1" class="kc kd hh jr b fi ke kf l kg kh">username = os.environ.get("PYTHON_USERNAME")<br/>password = os.environ.get("PYTHON_PASSWORD")</span><span id="209e" class="kc kd hh jr b fi ki kf l kg kh"># directory containing the extracted wallet.zip tnsnames.ora file<br/>config_dir = os.environ.get("PYTHON_CONFIG_DIR")</span><span id="9e91" class="kc kd hh jr b fi ki kf l kg kh"># directory containing the extracted wallet.zip ewallet.pem file<br/>wall_loc = os.environ.get("PYTHON_PEM_DIR")</span><span id="feda" class="kc kd hh jr b fi ki kf l kg kh"># wallet password created when downloading the wallet<br/>wall_pw = os.environ.get("PYTHON_WALLET_PASSWORD")</span><span id="3eac" class="kc kd hh jr b fi ki kf l kg kh"># connect name from the tnsnames.ora file, like 'myclouddb_low'<br/>cs = os.environ.get("PYTHON_CONNECTSTRING")</span><span id="d3f5" class="kc kd hh jr b fi ki kf l kg kh">engine = create_engine(<br/>    f'oracle+oracledb://:@',<br/>    connect_args={<br/>        "user": username,<br/>        "password": password,<br/>        "dsn": cs,<br/>        "config_dir": config_dir,<br/>        "wallet_location": wall_loc,<br/>        "wallet_password": wall_pw,<br/>    })</span></pre><p id="ef8c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了从防火墙内部进行测试，我给<code class="du jo jp jq jr b">connect_args</code>添加了几个额外的参数:</p><pre class="js jt ju jv fd jy jr jz ka aw kb bi"><span id="77b2" class="kc kd hh jr b fi ke kf l kg kh">        "https_proxy": "myproxy.oracle.com",<br/>        "https_proxy_port": 80</span></pre><p id="8c5a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">使用代理对于生产系统来说太慢了，但是对于快速访问来说却很方便。</p><p id="cf81" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">想玩的话这里有更完整的例子:<a class="ae jn" href="https://github.com/cjbj/python-oracledb-demos-2022/blob/main/6_sqlalchemy_example.py" rel="noopener ugc nofollow" target="_blank">https://github . com/cjbj/python-Oracle db-demos-2022/blob/main/6 _ sqlalchemy _ example . py</a></p><p id="fb8e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在<a class="ae jn" href="https://bit.ly/devrel_slack" rel="noopener ugc nofollow" target="_blank"> DevRel public Slack </a>上保持对话！</p></div></div>    
</body>
</html>