<html>
<head>
<title>Terraform and Oracle Cloud Infrastructure Classic Orchestrations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform和Oracle云基础架构经典业务流程</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/terraform-and-oracle-cloud-infrastructure-classic-orchestrations-e0fd39580f1e?source=collection_archive---------0-----------------------#2017-12-21">https://medium.com/oracledevs/terraform-and-oracle-cloud-infrastructure-classic-orchestrations-e0fd39580f1e?source=collection_archive---------0-----------------------#2017-12-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="dee0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">面向Oracle云基础架构Classic和Oracle云客户的<code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/opc/index.html" rel="noopener ugc nofollow" target="_blank">opc</a></code> Terraform provider的<code class="du jc jd je jf b">1.0.1</code>版本引入了对使用Compute Classic本机编排功能的配置实例的初始支持。</p><p id="0502" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本文中，我们将了解如何使用编排作为Terraform配置的一部分来提供实例，并探讨“编排的”实例和Terraform本地创建的实例之间的一些差异。</p><h1 id="2035" class="jh ji hh bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">Oracle计算云经典业务流程</h1><p id="6a69" class="pw-post-body-paragraph ie if hh ig b ih kf ij ik il kg in io ip kh ir is it ki iv iw ix kj iz ja jb ha bi translated"><a class="ae jg" href="https://docs.oracle.com/en/cloud/iaas/compute-iaas-cloud/stcsg/orchestrations-v2.html" rel="noopener ugc nofollow" target="_blank">编排</a>是Oracle Compute Classic本机资源调配和编排功能，在某种程度上，编排可被视为Terraform的替代方案。</p><blockquote class="kk kl km"><p id="eea1" class="ie if kn ig b ih ii ij ik il im in io ko iq ir is kp iu iv iw kq iy iz ja jb ha bi translated">流程编排定义了计算经典中计算、网络和存储资源集合的属性和相互依赖关系。您可以使用流程编排来自动化整个虚拟计算拓扑的配置和生命周期操作。</p></blockquote><p id="97a0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">大多数用户对Oracle计算服务的第一次体验是使用控制台UI启动实例。使用UI时，总是使用编排来创建实例。编排计划也可以直接以JSON格式定义，使用API、CLI提供，或者上传到UI中。</p><p id="4db8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">用于创建实例的本机业务流程模板示例如下所示:</p><figure class="kr ks kt ku fd kv"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="0ebe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个例子假设引用的安全列表、ip预留、ssh密钥等。但是它们也可以被定义为同一个编排计划中的额外的<strong class="ig hi">对象</strong>，就像一个地形配置可以定义多个资源一样。在Oracle Compute Classic中创建流程编排计划时，内部流程编排框架将管理对象(资源)的创建和生命周期。</p><h1 id="6189" class="jh ji hh bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">地形与编排</h1><p id="4e29" class="pw-post-body-paragraph ie if hh ig b ih kf ij ik il kg in io ip kh ir is it ki iv iw ix kj iz ja jb ha bi translated">Terraform也管理基础设施协调和供应，以上面的实例为例，可以在Terraform HCL中定义相同的配置</p><figure class="kr ks kt ku fd kv"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="52a2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">再次引用安全列表、ip预留、ssh密钥等。假设已经被创建，但是它们也可以被定义为相同地形配置中的附加资源。</p><p id="fc9f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当使用Terraform应用此配置时，<code class="du jc jd je jf b">opc</code>提供商使用Oracle Compute Classic <a class="ae jg" href="https://docs.oracle.com/en/cloud/iaas/compute-iaas-cloud/stcsg/creating-instances-using-launch-plans.html" rel="noopener ugc nofollow" target="_blank">启动计划</a>创建<code class="du jc jd je jf b">opc_compute_instance</code>资源。启动计划直接在计算中创建实例，并使用流程编排。</p><p id="8121" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从编排计划创建的实例与使用启动计划创建的实例之间的主要区别之一是，编排对象是主动管理的，因此在实例出现故障时，Compute Classic编排框架会自动检测出错的实例状态，并尝试重新创建实例，从而支持中断恢复，而无需引入外部监控工具。</p><h1 id="c566" class="jh ji hh bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">使用Terraform创建“编排”实例</h1><p id="579c" class="pw-post-body-paragraph ie if hh ig b ih kf ij ik il kg in io ip kh ir is it ki iv iw ix kj iz ja jb ha bi translated">为了支持创建主动管理的实例，<code class="du jc jd je jf b">opc</code> Terraform provider版本<code class="du jc jd je jf b">1.0.1</code>引入了一个<code class="du jc jd je jf b"><strong class="ig hi">opc_compute_orchestrated_instance</strong></code>资源，专门用于在编排计划中创建实例。</p><p id="a83d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Terraform有效地将实际的实例创建和管理委托给了本机编排框架。需要注意以下几点:</p><ul class=""><li id="2b81" class="ky kz hh ig b ih ii il im ip la it lb ix lc jb ld le lf lg bi translated">由<code class="du jc jd je jf b">opc_compute_orchestrated_instance</code>资源创建的编排计划仅包含实例对象定义，所有其他相关资源(如实例块存储卷)继续由Terraform直接管理，因此不是编排定义的一部分。</li><li id="1a56" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb ld le lf lg bi translated">将编排<code class="du jc jd je jf b">desired_state</code>设置为<code class="du jc jd je jf b">inactive</code>(如果没有设置实例<code class="du jc jd je jf b">persistent</code>选项，则设置为<code class="du jc jd je jf b">suspend</code>)将导致实例<strong class="ig hi">被销毁。</strong>当编排设置回<code class="du jc jd je jf b">active</code>时，创建一个具有新实例UUID的新实例</li><li id="97c9" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb ld le lf lg bi translated">如果由于实例故障，某个实例被业务流程自动重新创建，则重新创建的实例的UUID将不同于原始实例的实例ID。Terraform状态文件将与实例细节不同步，直到下一个Terraform <code class="du jc jd je jf b">refresh</code>、<code class="du jc jd je jf b">plan</code>或<code class="du jc jd je jf b">apply</code>更新状态。</li></ul><p id="9dd1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这样一来，让我们看看定义一个<code class="du jc jd je jf b">opc_compute_orchestrated_instance</code>资源的简单例子。</p><pre class="kr ks kt ku fd lm jf ln lo aw lp bi"><span id="980b" class="lq ji hh jf b fi lr ls l lt lu">resource "opc_compute_orchestrated_instance" "my-instance" {<br/>  name = "my-instance-orchestration"<br/>  description = "my-instance-orchestration"<br/>  desired_state = "active"<br/>  <br/>  instance {<br/>    persistent = true<br/>    name       = "my-orchestrated-instance"<br/>    shape      = "oc3"<br/>    image_list = "/oracle/public/OL_7.2_UEKR4_x86_64"<br/>  }<br/>}</span></pre><p id="fc21" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du jc jd je jf b"><strong class="ig hi">name</strong></code>、<code class="du jc jd je jf b"><strong class="ig hi">description</strong></code>和<code class="du jc jd je jf b"><strong class="ig hi">desired_state</strong></code>属性适用于Terraform创建的编排资源。</p><p id="e3c9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">资源定义中的<code class="du jc jd je jf b"><strong class="ig hi">instance</strong></code>块定义了编排定义中的实例编排对象模板。<code class="du jc jd je jf b">instance</code>块与常规的<code class="du jc jd je jf b">opc_compute_instance</code>资源具有相同的一般属性和结构，增加了<code class="du jc jd je jf b">persistent</code>选项来设置如果编排被挂起，实例对象是否应该持续。</p><p id="79e9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">与常规<code class="du jc jd je jf b">opc_compute_instance</code>一样，任何对持久启动存储、网络、安全等的依赖。可在Terraform配置中声明为单独的资源，并使用标准Terraform插值语法进行引用。这些额外的资源继续由Terraform直接管理，不属于编排的一部分。</p><figure class="kr ks kt ku fd kv"><div class="bz dy l di"><div class="kw kx l"/></div></figure><h2 id="9c17" class="lq ji hh bd jj lv lw lx jn ly lz ma jr ip mb mc jv it md me jz ix mf mg kd mh bi translated">当心意想不到的后果</h2><p id="2ee2" class="pw-post-body-paragraph ie if hh ig b ih kf ij ik il kg in io ip kh ir is it ki iv iw ix kj iz ja jb ha bi translated">最后一点需要注意。<code class="du jc jd je jf b">opc_compute_orchestrated_instance</code>资源支持在单个编排中声明多个<code class="du jc jd je jf b">instance</code>块。<strong class="ig hi">但是，作为一个警告点</strong>，请注意，如果在资源内进行了任何配置更改，从而强制重新创建编排对象，则编排声明内的所有实例都将被销毁并重新创建。</p></div></div>    
</body>
</html>