<html>
<head>
<title>Moving to DynamoDB to Increase Application Resiliency</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">转向DynamoDB以提高应用弹性</h1>
<blockquote>原文：<a href="https://medium.com/capital-one-tech/moving-to-dynamodb-to-increase-application-resiliency-106d753d38b1?source=collection_archive---------2-----------------------#2021-03-11">https://medium.com/capital-one-tech/moving-to-dynamodb-to-increase-application-resiliency-106d753d38b1?source=collection_archive---------2-----------------------#2021-03-11</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="8dd7" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">从PostgreSQL迁移到DynamoDB如何让我的开发团队自动化地区故障转移</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/699a64e400100348c70040ed9ea54d15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jkJXoCeRSHeLeoLf"/></div></div></figure><p id="2f74" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">弹性是每个应用程序的目标——没有人希望他们的应用程序失败——但实际实现这个目标是一个挑战。在云中构建提供了增强弹性的能力，但这不会自动发生。必须在堆栈和应用程序的所有级别中规划和构建弹性，其中最具挑战性的一层是数据库。传统的SQL数据库运行在一个主实例上，所有的更新都发生在这个主实例上。单个数据库实例的故障会导致大多数应用程序无法运行。</p><p id="2859" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">今年早些时候，我的团队开始寻找提高应用弹性的方法。我们的堆栈在East和West AWS区域都以主动-主动配置运行，并且我们已经将我们的服务配置为自动故障转移。大部分堆栈的故障转移时间几乎是即时的，但是PostgreSQL关系数据库需要几分钟时间让主实例切换区域。</p><h1 id="4b2f" class="ke kf hh bd kg kh ki kj kk kl km kn ko in kp io kq iq kr ir ks it kt iu ku kv bi translated">评估AWS数据库平台— DynamoDB、Aurora全球数据库和Aurora Multi-Master</h1><p id="4d02" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">我们的配置是多区域SQL数据库故障转移的典型配置；主数据库位于一个区域，而读取副本位于另一个区域。如果发生区域性故障切换，读取副本将提升为主副本，数据库流量将被重新路由到新的主副本。将读取复制副本提升为主副本需要10到15分钟。从历史上看，这对于区域性故障转移来说是可以接受的，但是对现代应用程序的期望是没有停机时间。</p><p id="b757" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们的团队开始寻找当前配置的替代方案。我们希望继续使用AWS中的托管数据库解决方案，以避免自行安装和维护数据库——这样我们就可以将大部分时间用于开发应用程序的新功能，而不是应用最新的数据库更新。这意味着我们没有考虑可能满足我们需求的非托管数据库，如<a class="ae lb" href="https://www.mongodb.com/" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>、<a class="ae lb" href="https://cassandra.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Cassandra </a>，甚至AWS RDS不支持的功能，如<a class="ae lb" href="https://www.mysql.com/products/cluster/faq.html" rel="noopener ugc nofollow" target="_blank"> MySQL Clusters </a>。</p><p id="8cf5" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们开始在RDS中搜索，确定了几种可能性。我们确定了用例的优点和缺点，如下所示:</p><p id="52cb" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi">数据库解决利弊</strong><a class="ae lb" href="https://aws.amazon.com/dynamodb/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hi">DynamoDB</strong></a><strong class="jk hi"/><a class="ae lb" href="https://aws.amazon.com/rds/aurora/global-database/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hi">极光全局数据库</strong></a><strong class="jk hi">&amp;</strong><a class="ae lb" href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-multi-master.html" rel="noopener ugc nofollow" target="_blank"><strong class="jk hi">极光多主</strong> </a></p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lc"><img src="../Images/80f360bcde7b70b46f3ee1501a807e67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*70nOTNI_wAP-kDDjvwbz4A.png"/></div></div></figure><h2 id="e022" class="ld kf hh bd kg le lf lg kk lh li lj ko jr lk ll kq jv lm ln ks jz lo lp ku lq bi translated">极光全球数据库</h2><p id="dfd5" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">我们看到的第一个选项是2018年11月推出的<a class="ae lb" href="https://aws.amazon.com/rds/aurora/global-database/" rel="noopener ugc nofollow" target="_blank">极光全球数据库</a>。此Aurora包含减少跨区域复制延迟的功能，并支持从区域性中断中快速恢复。<a class="ae lb" href="https://aws.amazon.com/rds/aurora/global-database/" rel="noopener ugc nofollow" target="_blank">据AWS it </a>，<em class="lr">“…为您的应用程序提供1秒的有效恢复点目标(RPO)和不到1分钟的恢复时间目标(RTO)，为全球业务连续性计划奠定坚实的基础。”</em></p><p id="3f0c" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">Aurora全球数据库解决了我们的主要问题，<em class="lr">数据库故障转移时间。</em> Aurora全局数据库可以在一分钟或更短时间内在区域之间进行故障转移。这比我们之前处理的故障转移时间快了一个数量级。虽然我们希望采用主动-主动解决方案，但这是团队早期的最爱，我们甚至进行了概念验证来测试故障转移，结果非常好。</p><p id="5a76" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">然而，Aurora Global数据库的缺点是有时只与MySQL兼容，这需要对我们的应用程序进行一些调整，但不需要进行重大的重写。</p><p id="4a3a" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi"> <em class="lr">注—自我们最初调查以来，极光全球数据库已经</em> </strong> <a class="ae lb" href="https://aws.amazon.com/about-aws/whats-new/2020/03/amazon-aurora-with-postgresql-compatibility-supports-amazon-aurora-global-database/" rel="noopener ugc nofollow" target="_blank"> <strong class="jk hi"> <em class="lr">增加了PostgreSQL支持</em> </strong> </a> <strong class="jk hi"> <em class="lr">。</em> </strong></p><h2 id="2c5e" class="ld kf hh bd kg le lf lg kk lh li lj ko jr lk ll kq jv lm ln ks jz lo lp ku lq bi translated">极光多主</h2><p id="2e28" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">当我们看到<a class="ae lb" href="https://aws.amazon.com/about-aws/whats-new/2019/08/amazon-aurora-multimaster-now-generally-available/" rel="noopener ugc nofollow" target="_blank">亚马逊在2019年8月发布了一个多主数据库</a>供通用的消息时，我们的团队非常兴奋，就在我们开始研究增加我们的数据库弹性的时候。几年来，Amazon一直承诺提供主动-主动Aurora数据库解决方案，由于时机的原因，我们能够将Aurora Multi-Master纳入我们对数据库替代方案的研究中。</p><p id="6a76" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><a class="ae lb" href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-multi-master.html" rel="noopener ugc nofollow" target="_blank"> Aurora多主集群</a>为并行运行的多个数据库提供了我们一直在寻找的主动-主动支持，可以更新数据库。这种能力提高了数据库的弹性，防止单个数据库故障导致应用程序无法运行。但是，目前它仅支持单个区域内的主动-主动模式，多区域故障转移是我们的应用程序的一项要求。</p><h2 id="e8f2" class="ld kf hh bd kg le lf lg kk lh li lj ko jr lk ll kq jv lm ln ks jz lo lp ku lq bi translated">DynamoDB</h2><p id="2fcc" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">我们考虑的最后一个选项是DynamoDB。虽然不在RDS中，但它是一个托管数据库解决方案。DynamoDB具有我们一直在寻找的关键特性——主动-主动跨区域支持。然而，我们担心迁移到NoSQL数据库，以及更新应用程序的数据持久层所需的工作量。</p><p id="dbd5" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">DynamoDB的许多特性使它成为一个引人注目的选择。亚马逊最初开发DynamoDB供其零售业务内部使用，当时该公司正以惊人的速度增长，其传统的关系数据库无法随着需求的增长而扩展。</p><p id="9111" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">根据<a class="ae lb" href="https://aws.amazon.com/dynamodb/" rel="noopener ugc nofollow" target="_blank"> AWS主页上的DynamoDB </a>，<em class="lr">“dynamo db每天可以处理超过10万亿个请求，每秒可以支持超过2000万个请求的峰值。”</em> DynamoDB甚至可以扩展到要求最苛刻的应用。出于本文的目的，它有太多的特性需要深入研究，但这里有一些亮点:</p><ul class=""><li id="1332" class="ls lt hh jk b jl jm jo jp jr lu jv lv jz lw kd lx ly lz ma bi translated">完全托管的NoSQL数据库</li><li id="b809" class="ls lt hh jk b jl mb jo mc jr md jv me jz mf kd lx ly lz ma bi translated">无限可扩展(对于无限的合理定义)</li><li id="40f3" class="ls lt hh jk b jl mb jo mc jr md jv me jz mf kd lx ly lz ma bi translated">高可用性和耐用性</li><li id="b16b" class="ls lt hh jk b jl mb jo mc jr md jv me jz mf kd lx ly lz ma bi translated">多区域主动-主动支持</li><li id="f479" class="ls lt hh jk b jl mb jo mc jr md jv me jz mf kd lx ly lz ma bi translated">实时数据处理</li><li id="194e" class="ls lt hh jk b jl mb jo mc jr md jv me jz mf kd lx ly lz ma bi translated">集成缓存</li><li id="9691" class="ls lt hh jk b jl mb jo mc jr md jv me jz mf kd lx ly lz ma bi translated">时间点备份</li><li id="bdb1" class="ls lt hh jk b jl mb jo mc jr md jv me jz mf kd lx ly lz ma bi translated">成本缩放</li></ul><p id="f59b" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi"> <em class="lr">注—</em></strong><a class="ae lb" href="https://aws.amazon.com/dynamodb/features/" rel="noopener ugc nofollow" target="_blank"><strong class="jk hi"><em class="lr">AWS dynamo db特性</em> </strong> </a> <strong class="jk hi"> <em class="lr">页面很好地介绍了平台上可用的许多特性。</em> </strong></p><h1 id="0685" class="ke kf hh bd kg kh ki kj kk kl km kn ko in kp io kq iq kr ir ks it kt iu ku kv bi translated">选择数据库</h1><p id="54ef" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">我们的团队就哪个数据库是最佳解决方案进行了多次讨论，强烈支持Aurora Global Database和DynamoDB。虽然Aurora Multi-Master在某些应用程序中是一个不错的选择，但由于缺乏多区域支持，它不适合我们的应用程序。Aurora Global Database将极大地减少区域故障转移时间，并且在应用程序端进行迁移所需的工作量较低，但DynamoDB是最佳解决方案，因为它是唯一支持多区域主动-主动支持的数据库。</p><h1 id="1b35" class="ke kf hh bd kg kh ki kj kk kl km kn ko in kp io kq iq kr ir ks it kt iu ku kv bi translated">DynamoDB表设计和多区域主动-主动用例</h1><p id="a9e0" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">由于多区域主动-主动支持是推动我们做出决定的关键能力，因此有必要更深入地讨论一下它是如何工作的。支持此功能的特性称为<a class="ae lb" href="https://aws.amazon.com/dynamodb/global-tables/" rel="noopener ugc nofollow" target="_blank">全局表</a>。在AWS控制台中，您可以启用全局表并选择一个区域进行复制，这将在所选区域中创建表的副本。这些表使用DynamoDB的流特性进行同步，自动将更改从一个区域复制到另一个区域。数据最终是一致的，复制信息所需的时间被称为<em class="lr">复制延迟。</em>根据<a class="ae lb" href="https://aws.amazon.com/dynamodb/global-tables/#Benefits" rel="noopener ugc nofollow" target="_blank"> AWS全球表格文档</a>，复制延迟大约为一秒钟。我们发现这个估计在常规操作期间是准确的，但是在重负载下延迟增加了。我们的重点是双区域配置，但是全局表跨多个区域工作，保持所有区域同步。</p><p id="0f1c" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">NoSQL数据建模与许多开发人员熟悉的关系数据库设计非常不同。例如，在NoSQL设计中，一个应用程序通常只有一个表。将数据规范化到多个表中的做法已经过时了。NoSQL设计的目标是将表结构基于访问模式，而不是继承域结构。这并不意味着你可以放弃你的领域模型；您仍然需要理解数据的元素以及它们之间的关系。但是，一个实体的所有数据通常都包含在一个条目中。这打破了关系设计的许多原则，复制数据并在记录中存储多个相关实体。因为您在单个表中存储不同的实体类型，所以实体类型的固定前缀、公共前缀和辅助索引可能包含基于实体类型的不同类型的数据。例如，如果我们在数据库中存储三角形、正方形和多边形，主索引可以使用形状类型和id的前缀，如tri#id、squ#id或poly#id，而辅助索引可以是三角形的类型、正方形的面积和多边形的边数。从访问的角度对数据建模可能需要一段时间才能习惯，但是访问性能比SQL查询更有效。</p><p id="b190" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">尽管DynamoDB有很多好处，但它并不是所有情况下的最佳解决方案。NoSQL数据库适合处理大量事务，但通常不适合用于报表数据库。数据是围绕事务处理构建的，导致报告性能不佳，特别是即席查询。如果您需要高性能的处理和报告，您可能需要将数据移动到传统的关系数据库或数据仓库解决方案中。数据迁移的常见方法是使用流功能将数据实时移动到另一个数据库中，或者在不需要实时报告的情况下按计划进行数据传输。</p><h1 id="5eac" class="ke kf hh bd kg kh ki kj kk kl km kn ko in kp io kq iq kr ir ks it kt iu ku kv bi translated">将DynamoDB应用于我们的应用程序</h1><p id="167c" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">应用程序的数据层替换并不像预测的那样广泛。然而，我们在转型过程中遇到了挑战。我们遇到的第一个问题是DynamoDB不支持nulls或空白值。有两种方法可以处理这个问题，您可以从数据中排除属性，或者使用结构来指示空值。我们采用了空结构方法。我们还有一个日期问题，因为DynamoDB中没有日期或时间数据类型。日期被转换为ISO UTC格式(即2020–09–18t 23:35:46Z)并存储为字符串。这种格式是人类可读的，并且是可排序和可搜索的，这方便了我们的服务所使用的日期范围查询。</p><p id="ae2a" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">即使解决了这些限制，当测试显示我们的原始设计不如预期的有效时，我们也不得不调整我们的表结构几次。在我们的一个表中，我们需要找到在一个时间范围内匹配两个数据字段的所有条目。我们创建了一个复合主键，将两个数据字段结合在一起，并将时间戳作为排序键。由于对平台不熟悉，我们也犯了一些错误，例如，我们对我们的一个服务使用了过滤器，这导致了表扫描，而不是使用查询，这样效率更高。在对我们的查询和表结构进行了几次迭代测试和修改之后，我们最小化了数据库读取，这既提高了性能又降低了成本。DynamoDB的一个很好的特性是，您可以在查询中设置ReturnConsumedCapacity属性，以获取所消耗的读取容量单位的数量。当您在优化查询时，这非常有用。</p><p id="b655" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">为了降低对我们的应用程序架构进行如此重大更改的风险，我们创建了一个使用两个数据库的实现来测试DynamoDB，而无需完全切换。在双数据库模式下，应用程序读写DynamoDB和PostgreSQL，但只将PostgreSQL数据返回给用户。这种配置降低了风险，因为在生产环境中测试新数据库实现时，原始数据库仍然存在。在生产环境中运行了几周后，没有出现任何错误，我们关闭了PostgreSQL，将应用程序完全切换到DynamoDB。</p><h1 id="218f" class="ke kf hh bd kg kh ki kj kk kl km kn ko in kp io kq iq kr ir ks it kt iu ku kv bi translated">结论</h1><p id="2fba" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">AWS中有许多可用的数据库选项。如果您想自己实现数据库，有几乎无限的选择；但是托管解决方案是一个受欢迎的选择，尤其是在需要低维护解决方案的开发团队中。使用托管数据库减少了您必须选择的数据库数量，但AWS仍在不断创新其产品，增加它们提供的托管解决方案的弹性和功能。</p><p id="7b78" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们的团队将我们的选择过程缩小到三个AWS数据库解决方案:DynamoDB、Aurora Global Database和Aurora Multi-Master。Aurora Multi-Master为需要SQL支持且不需要跨区域写入功能的应用程序提供了高度弹性的数据库。Aurora Global Database非常适合需要支持跨区域读取、低延迟更新和区域间快速故障转移能力的应用程序。DynamoDB提供了高性能的跨区域主动-主动功能，但是您失去了基于SQL的数据库所具有的一些数据访问灵活性。</p><p id="63e6" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">迁移到DynamoDB的结果是我们的应用程序故障转移时间减少了99%。消除了数据层上区域性故障转移的流程和脚本。数据库没有故障转移，因为应用程序在它所在的区域写入数据库，数据由AWS复制，保持区域同步。我们保持了相同或更好的查询性能，尽管一些改进是由于原始数据库设计中缺乏优化。尽管在这个过程中出现了一些小问题，但迁移是值得的，因为它提高了速度，降低了故障转移的复杂性。</p></div><div class="ab cl mg mh go mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ha hb hc hd he"><p id="dd73" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="lr">披露声明:2021资本一。观点是作者个人的观点。除非本帖中另有说明，否则Capital One不隶属于所提及的任何公司，也不被这些公司认可。使用或展示的所有商标和其他知识产权是其各自所有者的财产。</em></p></div></div>    
</body>
</html>