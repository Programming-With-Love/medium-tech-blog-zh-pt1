<html>
<head>
<title>Migrating from FingerprintManager to BiometricPrompt</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从FingerprintManager迁移到BiometricPrompt</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/migrating-from-fingerprintmanager-to-biometricprompt-4bc5f570dccd?source=collection_archive---------2-----------------------#2019-11-26">https://medium.com/androiddevelopers/migrating-from-fingerprintmanager-to-biometricprompt-4bc5f570dccd?source=collection_archive---------2-----------------------#2019-11-26</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/b3e889324da1641fb12bc9b821106675.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OQgcKIE1C-hbdhrkrX3xhA.png"/></div></div></figure><div class=""/><p id="f4b4" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="jn"> Android框架</em>和<em class="jn">安全</em>团队最近发布了<a class="ae jo" href="https://developer.android.com/jetpack/androidx/releases/biometric" rel="noopener ugc nofollow" target="_blank"> <em class="jn"> AndroidX生物特征库</em> </a>，这是一个支持库，取代了API之前的所有迭代。该库使得在<em class="jn"> Android 10 </em> (API等级29)中宣布的所有功能可以一直追溯到<em class="jn"> Android 6 </em> (API等级23)。支持库具有以下主要优势:</p><ul class=""><li id="1b8b" class="jp jq hs ir b is it iw ix ja jr je js ji jt jm ju jv jw jx bi translated">开发人员不再需要在他们的代码中预测不同的API级别，因为该库在幕后处理所有的API匹配。例如，支持库无缝地在API级别23到27上使用<code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/android/hardware/fingerprint/FingerprintManager" rel="noopener ugc nofollow" target="_blank">FingerprintManager</a></code>,在API级别28及以上使用<code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/androidx/biometric/BiometricPrompt.html" rel="noopener ugc nofollow" target="_blank">BiometricPrompt</a></code>。</li><li id="59b9" class="jp jq hs ir b is kc iw kd ja ke je kf ji kg jm ju jv jw jx bi translated">开发人员不再需要创建自己的身份验证UI。该库提供了一个标准且熟悉的用户界面，可匹配用户的生物认证形式，如指纹或面部认证。</li><li id="c444" class="jp jq hs ir b is kc iw kd ja ke je kf ji kg jm ju jv jw jx bi translated">开发人员可以通过一个方法调用来检查设备是否支持生物认证。</li></ul><p id="f1d4" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这个库提供了大量的便利，你可以通过<code class="du jy jz ka kb b">BiometricPrompt</code>和<code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/androidx/biometric/BiometricManager.html" rel="noopener ugc nofollow" target="_blank">BiometricManager</a></code>类来访问它们！</p><p id="6151" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你的应用程序仍然没有使用AndroidX生物特征库，这篇文章将告诉你如何迁移。</p><h1 id="ade9" class="kh ki hs bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">提高认证安全性</h1><p id="8556" class="pw-post-body-paragraph ip iq hs ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">根据<em class="jn"> Android兼容性定义文件(Android CDD) </em>，生物识别传感器可以根据传感器的欺骗和冒名顶替接受率等因素分为<a class="ae jo" href="https://source.android.com/compatibility/android-cdd#7_3_10_biometric_sensors" rel="noopener ugc nofollow" target="_blank"> <strong class="ir ht">强</strong>或<strong class="ir ht">弱</strong> </a>。这意味着您的代码不需要确定生物认证有多强OEM实现为您完成了这项工作。</p><p id="f448" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因此，为了提高认证安全性，应用程序在使用生物认证时通常会指定一个<code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/androidx/biometric/BiometricPrompt.CryptoObject.html" rel="noopener ugc nofollow" target="_blank">CryptoObject</a></code>。这是因为<code class="du jy jz ka kb b">CryptoObjects</code>与<code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/java/security/KeyStore" rel="noopener ugc nofollow" target="_blank">KeyStore</a></code>合作提供了额外的安全保障。例如，一个银行应用程序可能需要一个<code class="du jy jz ka kb b">CryptoObject</code>来解密敏感数据。使用<code class="du jy jz ka kb b">CryptoObject</code>将保证使用<em class="jn">强</em>生物特征来验证你的应用。此外，使用<code class="du jy jz ka kb b">CryptoObject</code>还能让您更加放心，因为它与<code class="du jy jz ka kb b">KeyStore</code>集成在一起，后者能够抵御对受损系统(如根设备)的攻击。</p><p id="e30f" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因此，一个应用程序有两种可能的实现:</p><ol class=""><li id="ddb6" class="jp jq hs ir b is it iw ix ja jr je js ji jt jm lk jv jw jx bi translated">使用 a <code class="du jy jz ka kb b">CryptoObject</code>进行生物认证<strong class="ir ht">(推荐)。</strong></li><li id="7057" class="jp jq hs ir b is kc iw kd ja ke je kf ji kg jm lk jv jw jx bi translated">生物认证<strong class="ir ht">没有</strong>有<code class="du jy jz ka kb b">CryptoObject</code>。</li></ol><h1 id="b184" class="kh ki hs bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">使用加密技术迁移到生物计量提示</h1><p id="5230" class="pw-post-body-paragraph ip iq hs ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">通常，应用程序必须创建以下对象来支持<code class="du jy jz ka kb b">FingerprintManager</code>工作流:</p><ul class=""><li id="4764" class="jp jq hs ir b is it iw ix ja jr je js ji jt jm ju jv jw jx bi translated">一个登录<code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/android/widget/Button" rel="noopener ugc nofollow" target="_blank">Button</a></code>，用户点击它启动指纹认证UI。</li><li id="57fd" class="jp jq hs ir b is kc iw kd ja ke je kf ji kg jm ju jv jw jx bi translated">一个<code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/android/app/DialogFragment" rel="noopener ugc nofollow" target="_blank">DialogFragment</a></code>及其相关的布局文件。这代表您的自定义指纹用户界面。</li><li id="9a63" class="jp jq hs ir b is kc iw kd ja ke je kf ji kg jm ju jv jw jx bi translated">允许用户使用账户密码而非<code class="du jy jz ka kb b">FingerprintManager</code>进行验证的可选逻辑。您可能出于不同的原因提供此选项:可能设备不支持指纹验证，可能用户忘记设置指纹验证，或者可能用户只是更喜欢帐户密码验证。</li></ul><p id="696b" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">要从<code class="du jy jz ka kb b">FingerprintManager</code>迁移到<code class="du jy jz ka kb b">BiometricPrompt</code>，完成以下步骤:</p><h2 id="6a4e" class="ll ki hs bd kj lm ln lo kn lp lq lr kr ja ls lt kv je lu lv kz ji lw lx ld ly bi translated">1.删除自定义指纹用户界面</h2><p id="a171" class="pw-post-body-paragraph ip iq hs ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">马上，你可以扔掉你的指纹UI的<code class="du jy jz ka kb b">FragmentDialog</code>和布局文件。你不需要它们。AndroidX生物特征库有一个标准化的用户界面。</p><h2 id="e795" class="ll ki hs bd kj lm ln lo kn lp lq lr kr ja ls lt kv je lu lv kz ji lw lx ld ly bi translated">2.将Gradle依赖项添加到您的应用程序模块中</h2><p id="c652" class="pw-post-body-paragraph ip iq hs ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">在撰写本文时，该库的最新版本是1.0.0。</p><figure class="lz ma mb mc fd hj"><div class="bz dy l di"><div class="md me l"/></div></figure><h2 id="9b2f" class="ll ki hs bd kj lm ln lo kn lp lq lr kr ja ls lt kv je lu lv kz ji lw lx ld ly bi translated">3.创建BiometricPrompt的实例</h2><p id="ac02" class="pw-post-body-paragraph ip iq hs ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">你应该在你的<code class="du jy jz ka kb b">Activity</code> / <code class="du jy jz ka kb b">Fragment</code>生命周期的早期实例化<code class="du jy jz ka kb b">BiometricPrompt</code>，最好是在<code class="du jy jz ka kb b">onCreate()</code>或<code class="du jy jz ka kb b">onCreateView()</code>中。这是<code class="du jy jz ka kb b">FingerprintManager</code>和<code class="du jy jz ka kb b">BiometricPrompt</code>的一个关键区别。在调用<code class="du jy jz ka kb b">authenticate()</code>的时候实例化<code class="du jy jz ka kb b">FingerprintManager</code>是可以的。但是对于向适当的活动发送回调的<code class="du jy jz ka kb b">BiometricPrompt</code>，比方说在配置改变的情况下，您必须在需要调用<code class="du jy jz ka kb b">authenticate()</code>之前对其进行一点实例化。</p><figure class="lz ma mb mc fd hj"><div class="bz dy l di"><div class="md me l"/></div></figure><h2 id="aa6e" class="ll ki hs bd kj lm ln lo kn lp lq lr kr ja ls lt kv je lu lv kz ji lw lx ld ly bi translated">4.生成PromptInfo对象</h2><p id="66ad" class="pw-post-body-paragraph ip iq hs ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated"><code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/androidx/biometric/BiometricPrompt.PromptInfo" rel="noopener ugc nofollow" target="_blank">BiometricPrompt.PromptInfo</a></code>是使用<code class="du jy jz ka kb b">BiometricPrompt</code> API进行认证的必需参数。它为提示提供了重要的说明，例如是否需要显式用户确认(注意:显式确认是默认行为，如果API正用于支付或交易，则应始终应用-对于与应用程序或帐户登录一起使用，显式确认可设置为false以实现更简化的体验)。<code class="du jy jz ka kb b">BiometricPrompt.PromptInfo</code>还允许您的应用程序通过在提示上设置标题、副标题和其他描述性文本来为正在进行的交易提供额外的上下文。</p><p id="664b" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您的<code class="du jy jz ka kb b">BiometricPrompt.PromptInfo</code>可能看起来像这样:</p><figure class="lz ma mb mc fd hj"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="e8b9" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">回想一下<code class="du jy jz ka kb b">createBiometricPrompt()</code>中的这个片段，它向用户展示了<code class="du jy jz ka kb b">loginWithPassword()</code>选项:</p><figure class="lz ma mb mc fd hj"><div class="bz dy l di"><div class="md me l"/></div></figure><h2 id="2fcc" class="ll ki hs bd kj lm ln lo kn lp lq lr kr ja ls lt kv je lu lv kz ji lw lx ld ly bi translated">5.创建一个加密对象</h2><p id="e116" class="pw-post-body-paragraph ip iq hs ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">由于您是从包含一个<code class="du jy jz ka kb b">CryptoObject</code>的<code class="du jy jz ka kb b">FingerprintManager</code>实现中迁移过来的，因此在旧代码的某个时候，您创建了一个<code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/android/hardware/fingerprint/FingerprintManager.CryptoObject.html" rel="noopener ugc nofollow" target="_blank">FingerprintManager.CryptoObject()</a></code>的实例来传递给<code class="du jy jz ka kb b">fingerprintManager.authenticate(crypto, cancel, flags, callback, handler)</code>。当迁移到<code class="du jy jz ka kb b">BiometricPrompt</code>时，你仍然可以使用相同的参数来创建你的<code class="du jy jz ka kb b">CryptoObject</code>，除了你的<code class="du jy jz ka kb b">CryptoObject</code>现在是一个<code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/androidx/biometric/BiometricPrompt.CryptoObject.html" rel="noopener ugc nofollow" target="_blank">BiometricPrompt.CryptoObject</a></code>。</p><h2 id="e202" class="ll ki hs bd kj lm ln lo kn lp lq lr kr ja ls lt kv je lu lv kz ji lw lx ld ly bi translated">6.设置您的视图。OnClickListener</h2><p id="21b5" class="pw-post-body-paragraph ip iq hs ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">既然您已经有了一个<code class="du jy jz ka kb b">BiometricPrompt</code>的实例，并且已经构建了一个<code class="du jy jz ka kb b">PromptInfo</code>对象，那么您就可以要求用户进行身份验证了。通常，当用户点击按钮时，会发生以下两种情况之一:</p><ul class=""><li id="12d2" class="jp jq hs ir b is it iw ix ja jr je js ji jt jm ju jv jw jx bi translated">如果设备支持生物认证，那么用户会看到<em class="jn">生物库</em>的标准用户界面。</li><li id="7481" class="jp jq hs ir b is kc iw kd ja ke je kf ji kg jm ju jv jw jx bi translated">否则，用户将获得自定义的“使用帐户密码登录”用户界面。此外，即使用户获得了标准的<em class="jn">生物特征库</em>用户界面，他们仍然有机会通过点击用户界面中的否定按钮来使用特定于应用程序的帐户密码登录。</li></ul><p id="0b24" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">与使用<code class="du jy jz ka kb b">FingerprintManager</code> API不同，您可以通过一个方法调用来检查设备是否支持生物认证:<code class="du jy jz ka kb b">BiometricManager.from(context).canAuthenticate()</code>。这个单一的方法调用检查设备上是否有可用的生物特征硬件，用户是否注册了模板，或者用户是否启用了生物特征认证。如果这三个都不是真的，则不能显示生物特征提示。</p><figure class="lz ma mb mc fd hj"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="83e8" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这就是加密迁移的全部内容。一旦认证成功，API将调用<code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/androidx/biometric/BiometricPrompt.AuthenticationCallback.html#onAuthenticationSucceeded(androidx.biometric.BiometricPrompt.AuthenticationResult)" rel="noopener ugc nofollow" target="_blank">onAuthenticationSucceeded()</a></code>回调方法，您的应用程序就可以继续显示私有数据了！</p><h1 id="c13b" class="kh ki hs bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">迁移到没有加密的BiometricPrompt</h1><p id="4f9d" class="pw-post-body-paragraph ip iq hs ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">如果您正在从一个不包含<code class="du jy jz ka kb b">CryptoObject</code>的<code class="du jy jz ka kb b">FingerprintManager</code>实现进行迁移，那么您所要做的就是跳过上面我们谈到的创建<code class="du jy jz ka kb b">CryptoObject</code>的<em class="jn">步骤5 </em>。类似于用空的<code class="du jy jz ka kb b">CryptoObject</code>调用<code class="du jy jz ka kb b">fingerprintManager.authenticate()</code>，只需调用没有<code class="du jy jz ka kb b">CryptoObject</code>参数的<code class="du jy jz ka kb b">biometricPrompt.authenticate()</code>。</p><figure class="lz ma mb mc fd hj"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="4a22" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这个例子使用了<code class="du jy jz ka kb b">setNegativeButtonText()</code>，它允许您为一个按钮指定标签，该按钮取消生物认证并在按下时消除提示。当这种情况发生时，<code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/androidx/biometric/BiometricPrompt.AuthenticationCallback.html#onAuthenticationError(int,%20java.lang.CharSequence)" rel="noopener ugc nofollow" target="_blank">onAuthenticationError(errCode, errString)</a></code>收到错误代码<code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/androidx/biometric/BiometricPrompt.html#ERROR_NEGATIVE_BUTTON" rel="noopener ugc nofollow" target="_blank">ERROR_NEGATIVE_BUTTON</a></code>，允许您的应用程序在按钮被按下时提供自定义行为。例如，一种可能的用途是将按钮标记为“使用帐户密码”，并在按下时显示应用程序内的替代登录选项。</p><p id="d051" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">另一种方法是<code class="du jy jz ka kb b">setDeviceCredentialAllowed(true)</code>，用户可以选择使用他们的<strong class="ir ht">设备密码、PIN或模式</strong>进行身份验证，而不是生物特征凭证。如果使用<code class="du jy jz ka kb b">setDeviceCredentialAllowed(true)</code>，生物特征库将处理认证。注意<code class="du jy jz ka kb b">setDeviceCredentialAllowed(true)</code>与<code class="du jy jz ka kb b">CryptoObject</code>不兼容。你也可以调用<code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/androidx/biometric/BiometricPrompt.PromptInfo.Builder.html#setNegativeButtonText(java.lang.CharSequence)" rel="noopener ugc nofollow" target="_blank">setNegativeButtonText()</a></code>或<code class="du jy jz ka kb b"><a class="ae jo" href="https://developer.android.com/reference/androidx/biometric/BiometricPrompt.PromptInfo.Builder.html#setDeviceCredentialAllowed(boolean)" rel="noopener ugc nofollow" target="_blank">setDeviceCredentialAllowed(true)</a></code>，<strong class="ir ht">，但不能同时调用</strong>。</p><p id="ef03" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在<code class="du jy jz ka kb b">onAuthenticationSucceeded()</code>回调方法中，您可以像在旧代码中一样继续操作。因为没有<code class="du jy jz ka kb b">CryptoObject</code>，你可能不需要对<code class="du jy jz ka kb b">AuthenticationResult</code>做任何事情。</p><figure class="lz ma mb mc fd hj"><div class="bz dy l di"><div class="md me l"/></div></figure><h1 id="4a65" class="kh ki hs bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">摘要</h1><p id="8a41" class="pw-post-body-paragraph ip iq hs ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">我们完事了。总之，要从<code class="du jy jz ka kb b">FingerprintManager</code>迁移到<code class="du jy jz ka kb b">BiometricPrompt</code>，您需要做以下工作:</p><ol class=""><li id="f350" class="jp jq hs ir b is it iw ix ja jr je js ji jt jm lk jv jw jx bi translated">扔掉你自定义的指纹认证UI。</li><li id="9a58" class="jp jq hs ir b is kc iw kd ja ke je kf ji kg jm lk jv jw jx bi translated">在你的<code class="du jy jz ka kb b">onCreate()</code>或<code class="du jy jz ka kb b">onCreateView()</code>生命周期方法中实例化<code class="du jy jz ka kb b">BiometricPrompt</code>，同时传递给它一个<code class="du jy jz ka kb b">BiometricPrompt.AuthenticationCallback()</code>的实现</li><li id="ff01" class="jp jq hs ir b is kc iw kd ja ke je kf ji kg jm lk jv jw jx bi translated">构建一个<code class="du jy jz ka kb b">PromptInfo</code>对象。</li><li id="bc77" class="jp jq hs ir b is kc iw kd ja ke je kf ji kg jm lk jv jw jx bi translated">创建一个<code class="du jy jz ka kb b">BiometricPrompt.CryptoObject</code>，如果您想使用推荐的方法将加密技术包含在您的生物认证工作流程中。</li><li id="5cf4" class="jp jq hs ir b is kc iw kd ja ke je kf ji kg jm lk jv jw jx bi translated">调用<code class="du jy jz ka kb b">BiometricPrompt.authenticate()</code>。</li></ol><p id="693a" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如需进一步阅读，请参见<a class="ae jo" href="https://developer.android.com/training/sign-in/biometric-auth" rel="noopener ugc nofollow" target="_blank">开发者指南</a>和<a class="ae jo" href="https://developer.android.com/reference/androidx/biometric/BiometricPrompt" rel="noopener ugc nofollow" target="_blank"> API参考</a>。</p><p id="ad2e" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">编码快乐！</p></div></div>    
</body>
</html>