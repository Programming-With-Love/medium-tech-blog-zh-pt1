<html>
<head>
<title>Secret Management in Microservices with Azure Key Vault</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure Key Vault在微服务中进行秘密管理</h1>
<blockquote>原文：<a href="https://medium.com/globant/secret-management-in-microservices-with-azure-key-vault-e90bc8a117ca?source=collection_archive---------0-----------------------#2021-02-08">https://medium.com/globant/secret-management-in-microservices-with-azure-key-vault-e90bc8a117ca?source=collection_archive---------0-----------------------#2021-02-08</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/9b5831805a353417e1abde4a2d306271.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4Fu8vyl7ArlbPcZx"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo by <a class="ae it" href="https://unsplash.com/@tinaflour?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Kristina Flour</a> on <a class="ae it" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="f260" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">应用程序配置是每个微服务的基本需求，它允许微服务在特定环境(如开发、qa、生产等)中以不同的方式运行和连接。我们如何管理application.properties(或application.yml)作为微服务或集中式配置的一部分，一个重要的事情是我们如何处理<em class="js">秘密</em>。</p><h1 id="8766" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">处理秘密</h1><blockquote class="kr ks kt"><p id="45cb" class="iu iv js iw b ix iy iz ja jb jc jd je ku jg jh ji kv jk jl jm kw jo jp jq jr ha bi translated">在企业微服务中，秘密管理策略至关重要，尤其是在使用公共云时。</p></blockquote><p id="d37d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">以下是这一战略的驱动力</p><ul class=""><li id="3db0" class="kx ky hh iw b ix iy jb jc jf kz jj la jn lb jr lc ld le lf bi translated">商业关键基础设施机密不应该轻易泄露，应该保护它们免受窥探。</li><li id="3fea" class="kx ky hh iw b ix lg jb lh jf li jj lj jn lk jr lc ld le lf bi translated">秘密应该从应用程序中具体化，这样开发人员就不必担心更高级环境的凭证。</li><li id="635e" class="kx ky hh iw b ix lg jb lh jf li jj lj jn lk jr lc ld le lf bi translated">秘密的集中存储</li><li id="1146" class="kx ky hh iw b ix lg jb lh jf li jj lj jn lk jr lc ld le lf bi translated">审计和监控秘密并据此采取行动</li><li id="dc80" class="kx ky hh iw b ix lg jb lh jf li jj lj jn lk jr lc ld le lf bi translated">应允许相关机构在不影响开发团队的情况下管理凭证/机密。</li></ul><p id="f698" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在本文中，我们将讨论一些策略，并详细介绍Azure Key Vault。</p><p id="44ab" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">传统上，环境变量用于将数据库密码或一些敏感值等秘密与应用程序分开</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="d7ac" class="lu ju hh lq b fi lv lw l lx ly">database.password=${dev-database-mysql-password}</span></pre><p id="7ed9" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在启动时，微服务通过服务器上设置的环境变量来解决这个问题。面临的挑战是，机密过去常常会因接触环境而受到损害。</p><p id="f639" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为了解决这些限制，推出了secret vault解决方案，如HashiCorp的vault、作为云不可知第三方实施的Spring Cloud Vault，以及Azure Key Vault和AWS Secret Manager等。作为托管云服务。</p><p id="60b5" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">下图显示了秘密管理解决方案的工作原理。</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lz"><img src="../Images/2f3dd862ffa187e3f38af9045ab662a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ghm3780AHA846ocnH0-_Vw.png"/></div></div></figure><p id="f508" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">vault生命周期中涉及的三个关键实体。</p><h2 id="e4c4" class="lu ju hh bd jv ma mb mc jz md me mf kd jf mg mh kh jj mi mj kl jn mk ml kp mm bi translated"><strong class="ak"> 1。基础设施管理团队</strong></h2><p id="ed27" class="pw-post-body-paragraph iu iv hh iw b ix mn iz ja jb mo jd je jf mp jh ji jj mq jl jm jn mr jp jq jr ha bi translated">该团队负责根据是在自己的基础架构上还是在公共云上创建或订阅保管库。一旦保险库准备就绪，他们就配置并提供对适当秘密机构的访问。</p><h2 id="3271" class="lu ju hh bd jv ma mb mc jz md me mf kd jf mg mh kh jj mi mj kl jn mk ml kp mm bi translated"><strong class="ak"> 2。秘密机关</strong></h2><p id="4797" class="pw-post-body-paragraph iu iv hh iw b ix mn iz ja jb mo jd je jf mp jh ji jj mq jl jm jn mr jp jq jr ha bi translated">秘密机构负责添加和维护保险库中的秘密。秘密机构可以根据环境或所有权而有所不同。例如，生产环境可以由不同的秘密机构管理，或者所有数据库可以由作为秘密管理机构的DBA管理。</p><h2 id="d19f" class="lu ju hh bd jv ma mb mc jz md me mf kd jf mg mh kh jj mi mj kl jn mk ml kp mm bi translated"><strong class="ak"> 3。消费者</strong></h2><p id="a793" class="pw-post-body-paragraph iu iv hh iw b ix mn iz ja jb mo jd je jf mp jh ji jj mq jl jm jn mr jp jq jr ha bi translated">消费者可以是配置了占位符的开发人员或应用程序。下图中，微服务是一个消费者。通常，Vault提供库或API来解析机密。</p><h1 id="c801" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">使用Spring Boot应用程序探索Azure key Vault</h1><ol class=""><li id="3102" class="kx ky hh iw b ix mn jb mo jf ms jj mt jn mu jr mv ld le lf bi translated"><em class="js">订阅Azure vault </em>，出于探索的目的，你可以尝试Azure的免费订阅。<a class="ae it" href="https://azure.microsoft.com/en-us/offers/ms-azr-0044p/" rel="noopener ugc nofollow" target="_blank">这里有一个链接</a>。</li><li id="8c07" class="kx ky hh iw b ix lg jb lh jf li jj lj jn lk jr mv ld le lf bi translated"><em class="js">在Azure中创建一个服务主账户</em>，通过Azure Key Vault的策略配置进行配置。这一步很重要，因为我们将使用这个服务帐户来解决我们在spring boot应用程序中的秘密。<strong class="iw hi"> <em class="js">注意</em> </strong>:服务主体是一种用户身份，它提供对订阅中Azure资源的访问。</li><li id="ecc3" class="kx ky hh iw b ix lg jb lh jf li jj lj jn lk jr mv ld le lf bi translated">登录Azure门户，导航到Azure密钥库，然后<em class="js">创建一个秘密</em>，例如数据库密码。<strong class="iw hi"> <em class="js">注意</em> </strong> : Azure默认以加密模式存储秘密。</li><li id="a43e" class="kx ky hh iw b ix lg jb lh jf li jj lj jn lk jr mv ld le lf bi translated"><em class="js">使用<strong class="iw hi"><em class="js">【Azure Key Vault】</em></strong>创建一个spring boot应用程序</em>作为附加启动器</li></ol><figure class="ll lm ln lo fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mw"><img src="../Images/45c2814a2298e77dac51041d0d988bdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MT-By6Pw07_-UnVo-3nmYw.png"/></div></div></figure><p id="1ae4" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">4.<em class="js">通过属性yaml文件在spring boot应用中配置Azure Key vault </em>。</p><p id="4d58" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">以下代码片段显示了示例application.yml配置</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="b092" class="lu ju hh lq b fi lv lw l lx ly">azure: <br/>  keyvault: <br/>    client-id: {{your client id i.e. service principal object id}}<br/>    client-key: {{your client key i.e. service principal key}}<br/>    enabled: true<br/>    refresh-interval: 1800000<br/>    tenant-id: {{your subscription tenant id}}<br/>    token-acquire-timeout-seconds: 60<br/>    uri: "<a class="ae it" href="https://demo.vault.azure.net/" rel="noopener ugc nofollow" target="_blank">https://demo.vault.azure.net/</a>"<br/>spring: <br/>  datasource: <br/>    driverClassName: com.microsoft.sqlserver.jdbc.SQLServerDriver<br/>    initialization-mode: always<br/>    username: "${database-username}"<br/>    password: "${database-password}"</span></pre><p id="b8ff" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这里需要注意一些重要的事情</p><ul class=""><li id="fb82" class="kx ky hh iw b ix iy jb jc jf kz jj la jn lb jr lc ld le lf bi translated">客户端id和客户端密钥是服务主体的细节</li><li id="e531" class="kx ky hh iw b ix lg jb lh jf li jj lj jn lk jr lc ld le lf bi translated">示例spring数据源中的属性(即＄{ database-password })是Azure key vault中定义的密钥的名称，它将在这里被透明地解析。</li></ul><p id="904a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">5.如果你想在源代码中引用任何Azure vault密钥，你可以使用@Value</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="99d8" class="lu ju hh lq b fi lv lw l lx ly"><a class="ae it" href="http://twitter.com/Value" rel="noopener ugc nofollow" target="_blank">@Value</a>("${database-password}")<br/>private String databasePassword;</span></pre><p id="1349" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">就这样，你就可以在spring boot应用程序中使用Azure key vault。</p></div></div>    
</body>
</html>