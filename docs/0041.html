<html>
<head>
<title>Apple TV Authentication</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apple TV鉴定</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/apple-tv-authentication-a156937ea211?source=collection_archive---------1-----------------------#2016-05-10">https://medium.com/airbnb-engineering/apple-tv-authentication-a156937ea211?source=collection_archive---------1-----------------------#2016-05-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="bd57" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由内森·巴克斯特 &amp; <a class="ae jc" href="https://twitter.com/michaelbachand" rel="noopener ugc nofollow" target="_blank">迈克尔·巴赫德</a></p><p id="a668" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">更新:</strong>2020年3月3日Airbnb日落版Airbnb Apple TV app。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/0e663c10ccdfe1f79f9211f4892f9581.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IsRjHI0MczMJoFtSCa_Dhw.jpeg"/></div></div></figure><p id="f688" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi jp translated">新款苹果电视为开发者和消费者打开了一个充满可能性的世界。但是，当涉及到文本输入时，它仍然有许多不足之处。因此，当我们开始为Apple TV设计Airbnb时，很明显，要求一个人输入他们的电子邮件地址和密码不是我们想要提供的令人愉快的体验。此外，Airbnb允许用户通过脸书和谷歌等第三方服务进行身份认证。因此，尽管在tvOS 9.2中输入用户名和密码比语音输入更容易，但这种策略只能解决我们用户群的一部分。</p><p id="4dc6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当有人已经安装了Airbnb移动应用程序时，有一些聪明的方法可以让我们无需任何输入就可以实现身份验证(参见<a class="ae jc" href="https://github.com/rsattar/Voucher" rel="noopener ugc nofollow" target="_blank">凭证</a>，它有助于在兄弟iOS应用程序存在的情况下进行“无钥匙”身份验证)。然而，由于我们不能指望我们所有的Apple TV用户手边都有Airbnb移动应用程序(更不用说最新版本了)，我们决定首先需要设计一个通用的认证策略，适用于任何Airbnb用户。通过建立这一坚实的基础，我们将能够投资于额外的身份认证策略，为我们特定的用户群子集提供更无缝的体验。</p><h1 id="68c3" class="jy jz hh bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated"><strong class="ak">概述</strong></h1><p id="09f5" class="pw-post-body-paragraph ie if hh ig b ih kw ij ik il kx in io ip ky ir is it kz iv iw ix la iz ja jb ha bi translated">当一个人想要登录Airbnb Apple TV应用程序时，该应用程序会向他们提供一个短代码，他们可以在www.airbnb.com/appletv<a class="ae jc" href="http://www.airbnb.com/appletv" rel="noopener ugc nofollow" target="_blank">的浏览器中输入该代码。一旦输入了代码，Airbnb应用程序就能够从我们的API中检索一个认证令牌，它可以使用该令牌来进行后续的API请求。</a></p><p id="4dde" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这种身份验证策略可以分为三个阶段。首先，Apple TV应用程序初始化一个认证请求，并由服务器提供秘密。接下来，这个人会看到这个简单的秘密，并使用它通过一个经过身份验证的web会话来批准请求。最后，Apple TV应用程序将其秘密交换为可用于未来请求的授权令牌。我将详细介绍每个阶段，包括一个简单的基于Sinatra的实现的代码示例。</p><h1 id="4dbb" class="jy jz hh bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">第一阶段</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lb"><img src="../Images/3ac5f3e1da9ce83053400d3da2491b29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BBI0l4mz1JEpDBH9sJxqrg.png"/></div></div></figure><p id="7558" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的第一阶段负责初始化我们的认证尝试。我们从对客户的零信任开始。该应用程序向我们的身份验证API发出请求，请求新的身份验证代码。它接收回新生成的随机数和短代码。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lc ld l"/></div></figure><p id="16ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现时是这里真正的秘密；它可以被认为是一个密码。为此，使用密码安全的伪随机数发生器(<a class="ae jc" href="https://en.wikipedia.org/wiki/Cryptographically_secure_pseudorandom_number_generator" rel="noopener ugc nofollow" target="_blank"> CSPRNG </a>)至关重要。许多普通的RNG容易受到攻击<a class="ae jc" href="https://media.blackhat.com/bh-us-12/Briefings/Argyros/BH_US_12_Argyros_PRNG_WP.pdf" rel="noopener ugc nofollow" target="_blank">【PDF】</a>，如果RNG受到威胁，整个系统的安全性就会崩溃。为此，我们利用了Ruby标准库中的<strong class="ig hi"> SecureRandom.uuid </strong>。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lc ld l"/></div></figure><p id="7cb3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于短代码，我们优先考虑易用性。我们的字符集是大写字母数字，去掉了任何容易混淆的符号。这给我们留下了总共26个字符。六个字符的短码则有26⁶，或308915776，可能的值。因为这些代码有几秒到几分钟的生命周期，即使被猜到也不会提供任何直接的帐户接管途径，这为我们的目的提供了足够的随机性。同样，我们使用<strong class="ig hi"> SecureRandom </strong>作为我们的数字生成器，以防范可预测的随机数。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lc ld l"/></div></figure><p id="0984" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在服务器端，我们使用一个过期的数据存储(特别是Redis)来存储与身份验证尝试相关的数据。我们的数据由短代码加密，有效载荷只包含一个使用bcrypt生成的nonce散列。避免存储明文机密非常重要，这样，如果数据存储遭到破坏，就不会自动破坏所有帐户。</p><h1 id="2aff" class="jy jz hh bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">第二阶段</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es le"><img src="../Images/37832d1b31fcb087d1fedec7c31fc789.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*mhV5LHx9z54IdO3jsLEsvA.png"/></div></figure><p id="35ea" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的第二阶段身份验证负责将身份验证尝试与活动帐户关联起来。阶段1中生成的短代码显示给用户，并提示他们转到激活URL(<a class="ae jc" href="http://www.airbnb.com/appletv" rel="noopener ugc nofollow" target="_blank">www.airbnb.com/appletv</a>)以完成该过程。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lf"><img src="../Images/5d1d64102103cddebfa3125bf5eb7673.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GS9ra18gkp_BuUq18qZeQQ.png"/></div></div></figure><p id="f0cf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">基于web的激活页面需要经过身份验证的会话，以便将短代码链接到帐户。如果此人未登录，他们将被推至登录或注册流程。他们通过身份验证后，将返回到激活页面。激活页面包含一个提示输入短代码的简单表单。提交后，会显示一条成功消息，用户交互完成。</p><p id="6c05" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这个系统中，短代码相当于用户名。在服务器上，我们在Redis中查找存储的短代码，并更新有效负载以包含用户的ID，从而建立到帐户的链接。只有已经建立可信身份的客户端才能访问该端点，因此我们可以有效地对其应用速率限制，以防止滥用猜测短代码的尝试。</p><h1 id="8a9e" class="jy jz hh bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">第3阶段</h1><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lg"><img src="../Images/ea787c01bf0693063d199abfbb2589fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*gmZmCDHDd9ZIgxGqrGXMZg.png"/></div></figure><p id="8bfb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Apple TV应用程序在阶段1中接收到秘密后，它开始轮询服务器以查看它们是否已被授权。每个轮询请求包括短码和随机数。轮询频率由服务器提供，以便在必要时可以调节负载。每个轮询请求都用于刷新生成的身份验证令牌的生命周期。因为服务器控制轮询间隔和密钥过期时间，所以它可以确保过期时间足够长，以防止在用户仍然参与该过程时超时。</p><p id="67af" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在服务器上，每个请求都会导致在Redis中查找短代码。如果随机数的散列与有效载荷中的值匹配，那么我们检查相关联的ID。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lc ld l"/></div></figure><p id="e994" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果没有ID，则重置到期时间，并且不会发生任何其他事情。如果我们找到一个ID，那么我们从Redis中删除短代码，并为相关用户生成一个会话。此时，此人已经成功登录。Apple TV现在可以像任何其他经过认证的客户端一样与我们的API进行交互。</p><p id="2575" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Airbnb，我们的目标是设计令人惊喜的软件。构建一个不需要输入密码的登录流是我们试图避开的一个小方法，让您可以继续前进。这也是我们可以与面临这一共同挑战的其他人分享的东西。在<a class="ae jc" href="https://github.com/airbnb/apple-tv-auth" rel="noopener ugc nofollow" target="_blank">https://github.com/airbnb/apple-tv-auth</a>查看此工作流的示例实现。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lh"><img src="../Images/3913f6470a7657e02386189e67b4eb30.png" data-original-src="https://miro.medium.com/v2/resize:fit:108/format:webp/1*YsUOrWx3mRxZZljtc9xZyw.png"/></div></figure><h2 id="8e81" class="li jz hh bd ka lj lk ll ke lm ln lo ki ip lp lq km it lr ls kq ix lt lu ku lv bi translated">在<a class="ae jc" href="http://airbnb.io" rel="noopener ugc nofollow" target="_blank"> airbnb.io </a>查看我们所有的开源项目，并在Twitter上关注我们:<a class="ae jc" href="https://twitter.com/AirbnbEng" rel="noopener ugc nofollow" target="_blank">@ Airbnb eng</a>+<a class="ae jc" href="https://twitter.com/AirbnbData" rel="noopener ugc nofollow" target="_blank">@ Airbnb data</a></h2></div></div>    
</body>
</html>