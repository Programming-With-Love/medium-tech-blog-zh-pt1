<html>
<head>
<title>Websocket Connection Handsake Under The Hood</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">引擎盖下的Websocket连接手柄</h1>
<blockquote>原文：<a href="https://medium.easyread.co/websocket-connection-handsake-under-the-hood-560ab1ceaff5?source=collection_archive---------3-----------------------#2020-07-11">https://medium.easyread.co/websocket-connection-handsake-under-the-hood-560ab1ceaff5?source=collection_archive---------3-----------------------#2020-07-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b3e93fef6e1cd1945d009e306906426d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SW_vElW2bjfoMWu7J9nvsg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@claudiasoraya" rel="noopener ugc nofollow" target="_blank">claudiasoraya</a> on <a class="ae kc" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="429c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> WebSocket </strong>是一种计算机<a class="ae kc" href="https://en.wikipedia.org/wiki/Communications_protocol" rel="noopener ugc nofollow" target="_blank">通信协议</a>，通过单一<a class="ae kc" href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol" rel="noopener ugc nofollow" target="_blank"> TCP </a>连接提供<a class="ae kc" href="https://en.wikipedia.org/wiki/Full-duplex" rel="noopener ugc nofollow" target="_blank">全双工</a>通信通道。WebSocket协议在2011年被<a class="ae kc" href="https://en.wikipedia.org/wiki/Internet_Engineering_Task_Force" rel="noopener ugc nofollow" target="_blank"> IETF </a>标准化为<a class="ae kc" href="https://en.wikipedia.org/wiki/Request_for_Comments" rel="noopener ugc nofollow" target="_blank"> RFC </a> 6455，<a class="ae kc" href="https://en.wikipedia.org/wiki/Web_IDL" rel="noopener ugc nofollow" target="_blank"> Web IDL </a>中的WebSocket <a class="ae kc" href="https://en.wikipedia.org/wiki/Application_programming_interface" rel="noopener ugc nofollow" target="_blank"> API </a>正在被<a class="ae kc" href="https://en.wikipedia.org/wiki/World_Wide_Web_Consortium" rel="noopener ugc nofollow" target="_blank"> W3C </a>标准化。WebSocket提供全双工通信。简单地说:在客户机和服务器之间有一个持久的连接，双方可以在任何时候开始发送数据。</p><p id="4b54" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我用WebSocket已经4年了。我知道HTTP是如何工作的，但不知道WebSocket是如何工作的。所以我决定深入调查一下。通过这篇文章，我将帮助您理解持久连接在WebSocket协议中是如何工作的。这很简单，也很容易理解。</p><h1 id="2fe6" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated"><strong class="ak">概述</strong></h1><p id="24bb" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Websocket连接从客户端到服务器的HTTP GET请求开始。该请求带有一个特殊的头，告诉服务器它想要创建一个WebSocket连接。以下是标题规格:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="842e" class="mn lc iq mj b gy mo mp l mq mr">GET <strong class="mj ir">/chat</strong> <strong class="mj ir">HTTP</strong>/1.1<br/>Host: server.example.com<br/>Upgrade: websocket<br/>Connection: Upgrade<br/>Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==<br/>Sec-WebSocket-Version: 13</span></pre><p id="5bf6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">服务器响应:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="4514" class="mn lc iq mj b gy mo mp l mq mr"><strong class="mj ir">HTTP</strong>/1.1 101 <strong class="mj ir">Switching Protocols</strong><br/>Upgrade: websocket<br/>Connection: Upgrade<br/>Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OPpG2HaGWk=</span></pre><p id="3036" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">客户端必须发送一个包含<a class="ae kc" href="https://en.wikipedia.org/wiki/Base64" rel="noopener ugc nofollow" target="_blank"> base64 </a>编码的随机字节的<code class="fe ms mt mu mj b"><strong class="kf ir">Sec-WebSocket-Key</strong></code>头，服务器回复一个<code class="fe ms mt mu mj b"><strong class="kf ir">Sec-WebSocket-Accept</strong></code>头中关键字的<a class="ae kc" href="https://en.wikipedia.org/wiki/Hash_function" rel="noopener ugc nofollow" target="_blank">散列</a>。你感到困惑吗？别急，我会在实现部分多做解释。</p><h2 id="2965" class="mn lc iq bd ld mv mw dn lh mx my dp ll ko mz na lp ks nb nc lt kw nd ne lx nf bi translated">履行</h2><p id="cb1b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">是时候让我们的手变脏了！我将使用golang作为编程语言。因此，请确保您已经在工作站中设置了golang环境。</p><ul class=""><li id="929e" class="ng nh iq kf b kg kh kk kl ko ni ks nj kw nk la nl nm nn no bi translated"><strong class="kf ir"> HTPP服务器</strong></li></ul><p id="443f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将使用net/HTTP库作为HTTP服务器库。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="9895" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">初始化时，将使用我们的主机和端口选项创建一个<code class="fe ms mt mu mj b"><strong class="kf ir">HttpServer</strong></code>对象。</p><ul class=""><li id="33d8" class="ng nh iq kf b kg kh kk kl ko ni ks nj kw nk la nl nm nn no bi translated"><strong class="kf ir">连接升级</strong></li></ul><p id="6467" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你必须处理握手过程。创建初始HTTP/1.1连接后，您需要通过向标准请求添加<code class="fe ms mt mu mj b"><strong class="kf ir">Upgrade</strong></code>和<code class="fe ms mt mu mj b"><a class="ae kc" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Connection" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">Connection</strong></a></code>头来请求升级。将HTTP/1.1会话升级到WebSocket连接时，需要在HTTP/1.1升级响应<strong class="kf ir">中生成<code class="fe ms mt mu mj b"><strong class="kf ir">Sec-WebSocket-Accept</strong></code> <strong class="kf ir"> </strong>值。</strong></p><p id="4770" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它通过获取<code class="fe ms mt mu mj b"><strong class="kf ir">Sec-WebSocket-Key</strong></code>的值并将其与<code class="fe ms mt mu mj b"><strong class="kf ir">"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"</strong></code>(一个在<a class="ae kc" href="https://tools.ietf.org/html/rfc6455#page-60" rel="noopener ugc nofollow" target="_blank">协议规范</a>中定义的“神奇字符串”)连接来实现这一点。它接受这个连接，创建一个SHA1摘要，然后用Base64编码这个摘要。我们可以使用内置的<code class="fe ms mt mu mj b"><strong class="kf ir">crypto/sha1</strong></code>和<code class="fe ms mt mu mj b"><strong class="kf ir">encoding/base64</strong></code>库来做到这一点。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="e0f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们可以使用这个键，并向套接字写入我们期望的响应。这个响应包括状态代码<code class="fe ms mt mu mj b"><strong class="kf ir">"101 Switching Protocols"</strong></code>，表示服务器和客户端现在将通过WebSocket进行通信。这还包括客户端发送给我们的相同的<code class="fe ms mt mu mj b"><strong class="kf ir">Upgrade</strong></code>和<code class="fe ms mt mu mj b"><strong class="kf ir">Connection</strong></code>头，以及适当的<code class="fe ms mt mu mj b"><strong class="kf ir">Sec-WebSocket-Accept</strong></code>键和值。升级连接机制后，我们需要确保连接不会立即关闭。因此我们将创建一个事件循环。所有传入的消息/请求都将在事件循环中被接收。但我会在另一篇文章中解释。</p><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="6670" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好吧！我们来做个客户端测试吧！首先，您需要打开浏览器，然后打开javascript控制台并尝试这段代码。</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="d011" class="mn lc iq mj b gy mo mp l mq mr"><strong class="mj ir">new WebSocket("ws://localhost:8080");</strong></span></pre><p id="1c89" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在浏览器中打开您的网络部分，您会发现一个新的WebSocket连接。</p><p id="5a1b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">万岁，到此为止🤗</p><p id="f765" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我希望你喜欢它。请在下面留下评论。如果你面临任何问题，留下你的评论，我会帮助你😉。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><figure class="me mf mg mh gt jr"><div class="bz fp l di"><div class="ny nq l"/></div></figure></div></div>    
</body>
</html>