<html>
<head>
<title>Connecting to SQL Server from AWS Lambda docker container</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从AWS Lambda docker容器连接到SQL Server</h1>
<blockquote>原文：<a href="https://medium.com/globant/connecting-to-sql-server-from-aws-lambda-docker-container-b474727522eb?source=collection_archive---------0-----------------------#2021-08-27">https://medium.com/globant/connecting-to-sql-server-from-aws-lambda-docker-container-b474727522eb?source=collection_archive---------0-----------------------#2021-08-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="05df" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">介绍</h1><p id="baab" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">近年来，越来越多的公司正在部署多云解决方案。我们的一些客户正在寻找一种经济高效的解决方案，他们希望将一些AWS服务连接到Azure数据库(或安装了Microsoft SQL Server的内部AWS IaaS虚拟机)。</p><p id="6f35" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">无服务器功能服务允许您构建和运行应用程序和服务，而无需考虑服务器。在AWS上，这个服务被称为Lambda函数。你可以查看我们关于<a class="ae kf" rel="noopener" href="/globant/serverless-applications-with-azure-functions-python-and-docker-b594fb90fd4f">使用Azure函数、Python和Docker </a>的无服务器应用的文章。</p><p id="df95" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">在这篇文章中，我想解释如何创建一个Python AWS Lambda docker映像来连接一个兼容的Microsoft SQL Server，而又不费力。</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div class="ab fe cl kl"><img src="../Images/34e7285957377e078db82f975728a094.png" data-original-src="https://miro.medium.com/v2/format:webp/1*YaO0RukOT2nsyO9JNGqbNQ.png"/></div></figure><h1 id="2c6a" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">背景</h1><p id="211c" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">AWS提供了一些基本的Python Lambda函数docker图像。在这个练习中，我们将使用<strong class="je hi">public.ecr.aws/lambda/python:3.9</strong>(检查<a class="ae kf" href="https://hub.docker.com/r/amazon/aws-lambda-python/tags" rel="noopener ugc nofollow" target="_blank">https://hub.docker.com/r/amazon/aws-lambda-python</a>)。这是一个安装了<strong class="je hi"> Python 3.9 </strong>运行时的<strong class="je hi"> Amazon Linux 2 </strong>发行版映像。</p><p id="219c" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">我们想使用PyODBC，它是一个Python模块，使通过ODBC API访问数据库变得简单，但是我们的基本映像没有安装必要的<strong class="je hi"> gcc </strong>库和<strong class="je hi"> SQL Server </strong>驱动程序。</p><h1 id="e40a" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">佐料</h1><p id="2712" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">让我们开始创建Python示例文件。</p><ul class=""><li id="9dff" class="ko kp hh je b jf ka jj kb jn kq jr kr jv ks jz kt ku kv kw bi translated">带有pyodbc模块的readme.txt</li></ul><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kx ky l"/></div></figure><ul class=""><li id="5a7a" class="ko kp hh je b jf ka jj kb jn kq jr kr jv ks jz kt ku kv kw bi translated">app.py</li></ul><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kx ky l"/></div></figure><p id="471a" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">用您的数据库信息替换第5行到第8行。</p><p id="4d48" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">这是档案。</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kx ky l"/></div></figure><p id="6e2f" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">第1行:我们的基本码头工人形象。</p><p id="9726" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">第2–3行:是我们的Python项目示例文件。</p><p id="f047" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">第7–13行:安装Microsoft SQL Server ODBC驱动程序和unixODBC应用程序(因为Amazon Linux 2是基于CentOs的发行版，所以我们使用Red Hat包)。</p><p id="56c7" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">第14行:安装用于编译pyodbc模块的gcc应用程序。</p><p id="864a" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">第15行:清理yum缓存。</p><p id="1d33" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">第16行:更新python <strong class="je hi"> PIP </strong>和<strong class="je hi"> setuptools </strong>模块。</p><p id="f80f" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">第17行:从requirements.txt安装项目python模块</p><p id="96a8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">第19行:设置参数<code class="du kz la lb lc b">CMD</code>来指定Lambda函数处理程序。</p><h1 id="e95a" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">烹饪docker图像</h1><p id="bd2d" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">既然我们有了所有必要的材料，我们就可以打造我们的码头工人形象了。</p><p id="8ec8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">在命令行shell窗口中运行以下命令。</p><pre class="kg kh ki kj fd ld lc le lf aw lg bi"><span id="0128" class="lh if hh lc b fi li lj l lk ll">docker build --pull --rm -f "dockerfile" -t lambdasql:latest "."</span></pre><p id="b0e8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">你可以替换<strong class="je hi"> lambdasql:lastest </strong>作为你想要的标签名。</p><p id="70f2" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">为了测试您的映像，您可以创建一个运行以下命令的容器:</p><pre class="kg kh ki kj fd ld lc le lf aw lg bi"><span id="71a6" class="lh if hh lc b fi li lj l lk ll">docker run -p 9000:8080 lambdasql:latest</span></pre><p id="ba8c" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">记住:用你的标签改变<strong class="je hi"> lambdasql:latest </strong>。</p><p id="b94d" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">您可以使用Postman或您最喜欢的HTTP客户端来调用Lambda函数。URL是<a class="ae kf" href="http://localhost:9000/2015-03-31/functions/function/invocations" rel="noopener ugc nofollow" target="_blank">http://localhost:9000/2015-03-31/functions/function/invocations</a>，您必须在正文中添加一个空的JSON <strong class="je hi"> {} </strong>。</p><figure class="kg kh ki kj fd kk er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lm"><img src="../Images/683091e8e441b4c798a15164e48ca7cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XzGxH1AbJMmDe4KZTVh0Uw.png"/></div></div></figure><p id="7ebe" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">lambda函数必须使用SQL Server版本进行响应，例如:</p><pre class="kg kh ki kj fd ld lc le lf aw lg bi"><span id="9ad7" class="lh if hh lc b fi li lj l lk ll">“Microsoft SQL Azure (RTM) — 12.0.2000.8 \n\tJul 23 2021 13:14:19 \n\tCopyright © 2019 Microsoft Corporation\n”</span></pre><p id="7286" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">请记住，您必须标记您的映像以匹配您的存储库名称，并使用<code class="du kz la lb lc b">docker push</code>命令将映像部署到Amazon ECR。</p><pre class="kg kh ki kj fd ld lc le lf aw lg bi"><span id="b288" class="lh if hh lc b fi li lj l lk ll">docker tag  lambdasql:latest <em class="lr">123456789012</em>.dkr.ecr.<em class="lr">us-east-1</em>.amazonaws.com/lambdasql:latest</span><span id="676c" class="lh if hh lc b fi ls lj l lk ll">docker push <em class="lr">123456789012</em>.dkr.ecr.<em class="lr">us-east-1</em>.amazonaws.com/lambdasql:latest</span></pre><p id="93fa" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">你可以从</strong><a class="ae kf" href="https://github.com/csotomon/python-lambda-sql" rel="noopener ugc nofollow" target="_blank"><strong class="je hi">https://github.com/csotomon/python-lambda-sql</strong></a>查看完整的代码</p><h1 id="8e65" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">结论</h1><p id="05ff" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">所提供的AWS docker映像仅提供了运行Python应用程序的基本实现，但是很容易使用必要的Linux应用程序和驱动程序来构建新的docker映像，以便连接到SQL Server数据库。</p><h1 id="7e2a" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">参考</h1><p id="a6dc" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated"><a class="ae kf" href="https://www.globant.com/stay-relevant/partnerships/aws" rel="noopener ugc nofollow" target="_blank"> Globant AWS </a></p><p id="56d4" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><a class="ae kf" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> Aws Lambda </a></p><p id="3519" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><a class="ae kf" href="https://aws.amazon.com/sql/" rel="noopener ugc nofollow" target="_blank">AWS上的微软SQL Server</a></p><p id="ad1a" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><a class="ae kf" href="https://azure.microsoft.com/en-us/services/sql-database/campaign/" rel="noopener ugc nofollow" target="_blank"> Azure SQL Server </a></p><p id="b7ae" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><a class="ae kf" href="https://docs.microsoft.com/en-us/sql/connect/python/python-driver-for-sql-server?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank"> Python SQL驱动</a></p><h1 id="d562" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">愿原力与你同在。</strong></h1></div></div>    
</body>
</html>