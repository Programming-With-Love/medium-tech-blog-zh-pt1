<html>
<head>
<title>Writing Python scripts to run from the OCI Console Cloud Shell</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编写从OCI控制台云外壳运行的Python脚本</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/writing-python-scripts-to-run-from-the-oci-console-cloud-shell-a0be1091384c?source=collection_archive---------2-----------------------#2020-04-14">https://medium.com/oracledevs/writing-python-scripts-to-run-from-the-oci-console-cloud-shell-a0be1091384c?source=collection_archive---------2-----------------------#2020-04-14</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="cf03" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这篇文章的部分灵感来自Reddit 上的一个<a class="ae jc" href="https://www.reddit.com/r/oraclecloud/comments/fx26qf/q_how_can_i_make_a_list_of_instances_plus_ip/" rel="noopener ugc nofollow" target="_blank">问题，询问如何列出所有<strong class="ig hi"> Oracle云基础设施</strong>实例及其IP地址。</a></p><p id="b137" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一种方法是使用一个简单的Python脚本和<strong class="ig hi">OCI</strong><a class="ae jc" href="https://docs.cloud.oracle.com/en-us/iaas/Content/API/SDKDocs/pythonsdk.htm" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">Python-SDK</strong></a>，但是我也想找到一种方法从OCI控制台直接在<a class="ae jc" href="https://docs.cloud.oracle.com/en-us/iaas/Content/API/Concepts/cloudshellintro.htm" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi">云外壳</strong> </a>中运行它，以最小化运行脚本所需的任何额外设置。</p><p id="d918" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当您从OCI控制台启动<strong class="ig hi">云外壳</strong>时，会为您提供一个终端环境，其中预装了许多常用工具和实用程序，包括OCI CLI和Python SDK。</p><p id="6e2a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当编写在云shell中运行的Python脚本时，我们可以利用shell现有的身份验证，避免在从外部环境执行脚本时通常需要手动配置单独API密钥的步骤。为此，我们在shell中加载现有的实例原则委托令牌，以创建API请求签名者。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="9fd8" class="jm jn hh ji b fi jo jp l jq jr">#!/usr/bin/env python</span><span id="d682" class="jm jn hh ji b fi js jp l jq jr">import oci</span><span id="eadc" class="jm jn hh ji b fi js jp l jq jr"><strong class="ji hi"># get the cloud shell delegated authentication token</strong><br/>delegation_token = open('/etc/oci/delegation_token', 'r').read()</span><span id="d1b8" class="jm jn hh ji b fi js jp l jq jr"><strong class="ji hi"># create the api request signer</strong><br/>signer = oci.auth.signers.InstancePrincipalsDelegationTokenSigner(<br/>   delegation_token=delegation_token<br/>)</span></pre><p id="6802" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后使用<code class="du jt ju jv ji b"><strong class="ig hi">signer</strong></code>创建一个经过验证的客户端，传递一个空字典来代替常规的<code class="du jt ju jv ji b">config</code>设置，例如创建搜索客户端:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="2ad9" class="jm jn hh ji b fi jo jp l jq jr"><strong class="ji hi"># create an authenticated api client <br/></strong>search_client = oci.resource_search.ResourceSearchClient(<br/>   config={}, <br/>   signer=signer<br/>)</span></pre><p id="60d5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用这个搜索客户端，我们现在可以搜索当前区域中的所有实例。</p><p id="3d5f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jw">提示:如果您需要定位默认家庭区域之外的其他区域，您可以设置</em> <code class="du jt ju jv ji b"><em class="jw">config={"region":"ca-toronto-1"}</em></code></p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="f0d9" class="jm jn hh ji b fi jo jp l jq jr"><strong class="ji hi"># search for all instances</strong><br/>resp = search_client.search_resources(<br/>  oci.resource_search.models.StructuredSearchDetails(<br/>    type="Structured",<br/>    query="query instance resources"<br/>  )<br/>)</span></pre><p id="d6d5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了查询关于实例的更多详细信息并获得IP地址，我们需要两个额外的API客户机用于计算和网络资源。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="ea6e" class="jm jn hh ji b fi jo jp l jq jr">compute_client = oci.core.ComputeClient({},signer=signer)<br/>network_client = oci.core.VirtualNetworkClient({},signer=signer)</span></pre><p id="7c99" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，为了获得每个实例的IP地址，我们查询该实例的所有vnic附件，然后对于每个vnic，我们可以输出其公共和私有IP地址。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="6f9c" class="jm jn hh ji b fi jo jp l jq jr">for instance in resp.data.items:<br/><strong class="ji hi">  # for each instance get its vnic attachments<br/></strong>  resp = compute_client.list_vnic_attachments(<br/>    compartment_id=instance.compartment_id,<br/>    instance_id=instance.identifier<br/>  )</span><span id="04ae" class="jm jn hh ji b fi js jp l jq jr">  for vnic_attachment in resp.data:<br/>    <strong class="ji hi"># for each vnic get the vnic details</strong><br/>    vnic = network_client.get_vnic(vnic_attachment.vnic_id).data<br/><strong class="ji hi">    # print tab separated list of instances and ips</strong><br/>    print("\t".join([<br/>      instance.display_name, <br/>      vnic.display_name,<br/>      vnic.private_ip,<br/>      vnic.public_ip<br/>    ]))</span></pre><p id="c2b7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面是完整的脚本，您可以在您的云shell终端窗口中将其复制到一个<code class="du jt ju jv ji b">list-instance-ips.py</code>文件中。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="93bd" class="jm jn hh ji b fi jo jp l jq jr">#!/usr/bin/env python</span><span id="235c" class="jm jn hh ji b fi js jp l jq jr">import oci</span><span id="c66a" class="jm jn hh ji b fi js jp l jq jr">delegation_token = open('/etc/oci/delegation_token', 'r').read()<br/>signer = oci.auth.signers.InstancePrincipalsDelegationTokenSigner(<br/>   delegation_token=delegation_token<br/>)</span><span id="28d0" class="jm jn hh ji b fi js jp l jq jr">search_client = oci.resource_search.ResourceSearchClient({},signer=signer)<br/>compute_client = oci.core.ComputeClient({},signer=signer)<br/>network_client = oci.core.VirtualNetworkClient({},signer=signer)</span><span id="c894" class="jm jn hh ji b fi js jp l jq jr">resp = search_client.search_resources(<br/>  oci.resource_search.models.StructuredSearchDetails(<br/>    type="Structured",<br/>    query="query instance resources"<br/>  )<br/>)</span><span id="82b3" class="jm jn hh ji b fi js jp l jq jr">for instance in resp.data.items:<br/>  resp = compute_client.list_vnic_attachments(<br/>    compartment_id=instance.compartment_id,<br/>    instance_id=instance.identifier<br/>  )</span><span id="6d90" class="jm jn hh ji b fi js jp l jq jr">  for vnic_attachment in resp.data:<br/>    vnic = network_client.get_vnic(vnic_attachment.vnic_id).data<br/>    print("\t".join([<br/>      instance.display_name, <br/>      vnic.display_name,<br/>      vnic.private_ip,<br/>      vnic.public_ip<br/>    ]))</span></pre><p id="d2f3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是运行脚本的一个例子。我目前只有一个实例在我的自由层帐户中运行，所以输出并不特别有趣，但是您已经明白了。</p><figure class="jd je jf jg fd jy er es paragraph-image"><div role="button" tabindex="0" class="jz ka di kb bf kc"><div class="er es jx"><img src="../Images/cb489695e38a7aaf26eacf3be84ceedb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UvRR9vgBZo5BhDzVm4kfpQ.png"/></div></div></figure><h1 id="24e2" class="kf jn hh bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">更多信息</h1><ul class=""><li id="9d67" class="lc ld hh ig b ih le il lf ip lg it lh ix li jb lj lk ll lm bi translated">OCI <a class="ae jc" href="https://docs.cloud.oracle.com/en-us/iaas/Content/API/SDKDocs/pythonsdk.htm" rel="noopener ugc nofollow" target="_blank"> Python-SDK </a></li><li id="4ca7" class="lc ld hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated"><a class="ae jc" href="https://docs.cloud.oracle.com/en-us/iaas/Content/API/Concepts/cloudshellintro.htm" rel="noopener ugc nofollow" target="_blank">云壳</a></li><li id="d559" class="lc ld hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated"><a class="ae jc" href="https://docs.cloud.oracle.com/en-us/iaas/Content/Identity/Tasks/callingservicesfrominstances.htm#ConfiguringtheSDKCLIorTerraform" rel="noopener ugc nofollow" target="_blank">实例原则——从实例中调用服务</a></li></ul><p id="0773" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jw">注意——自由级用户可能会体验到其帐户所含服务的变化。</em></p></div></div>    
</body>
</html>