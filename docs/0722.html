<html>
<head>
<title>Diving Into Compose — Lessons Learned While Building Maps Compose</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">潜入合成-构建地图时学到的经验合成</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/diving-into-compose-lessons-learned-while-building-maps-compose-d20ef5dfe1bb?source=collection_archive---------6-----------------------#2022-06-03">https://medium.com/androiddevelopers/diving-into-compose-lessons-learned-while-building-maps-compose-d20ef5dfe1bb?source=collection_archive---------6-----------------------#2022-06-03</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/68c249ceefe4c5c2eba4a7ecf26efbc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6rFVWLu8FXGXfmASVP3zYQ.jpeg"/></div></div></figure><div class=""/><div class=""><h2 id="1b6c" class="pw-subtitle-paragraph iq hr hs bd b ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh dx translated">构建地图时学到的互操作性和合成API经验</h2></div><p id="33eb" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">今年，我们发布了<a class="ae ke" href="https://github.com/googlemaps/android-maps-compose" rel="noopener ugc nofollow" target="_blank"> Maps Compose </a>库，这是一个Jetpack Compose库，用于将谷歌地图添加到您的应用程序中。其核心是，Maps Compose是一个用于Android的Maps SDK的互操作库，它公开了友好的合成API。因此，要创建Maps Compose的可组合元素，我们需要在Maps SDK的现有API和可用的Compose interop函数的约束下工作。</p><p id="dc5d" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在最终发布初始版本之前，Maps Compose经历了几次设计和实现迭代。在这篇博文中，我想介绍一下Maps Compose的背景，它是如何出现的，以及在使用它时学到的一些经验。这篇文章与想要提供组合支持的SDK开发者特别相关；然而，它也应该与对写作感兴趣的读者相关。如果你落入了其中的一个桶里——继续读下去！</p><h1 id="5350" class="kf kg hs bd kh ki kj kk kl km kn ko kp iz kq ja kr jc ks jd kt jf ku jg kv kw bi translated">背景</h1><p id="f14a" class="pw-post-body-paragraph ji jj hs jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">在Maps Compose可用之前，由于Compose的<a class="ae ke" href="https://developer.android.com/jetpack/compose/interop/interop-apis" rel="noopener ugc nofollow" target="_blank">互用性API</a>，即<a class="ae ke" href="https://developer.android.com/jetpack/compose/interop/interop-apis#views-in-compose" rel="noopener ugc nofollow" target="_blank"> AndroidView </a>可组合，在Compose中使用Maps SDK已经成为可能。简单的用例——比如显示一张只有一个标记的地图——很简单；然而，与大量定制和绘图的适度复杂的集成需要编写大量的互操作代码，使得使用不那么简单。</p><p id="5c78" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">为了衡量一个Compose库对Android开发人员有多有用，我发了以下推文:</p><figure class="lc ld le lf fd hj"><div class="bz dy l di"><div class="lg lh l"/></div><figcaption class="li lj et er es lk ll bd b be z dx">Preview API of Maps Compose.</figcaption></figure><p id="de43" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">令我惊讶的是，许多开发人员的回答是“是的，请吧！”，“爽！”，并且“这将取代几百行代码。”🤯作为当时在Maps SDK工作的开发人员关系工程师之一，优先为Maps SDK发布可组合元素是有意义的。从那里，我内部提出了一个地图合成的设计和实现，并与<a class="ae ke" href="https://twitter.com/adamwp" rel="noopener ugc nofollow" target="_blank"> Adam Powell </a>、<a class="ae ke" href="https://twitter.com/intelligibabble" rel="noopener ugc nofollow" target="_blank"> Leland Richardson </a>和<a class="ae ke" href="https://twitter.com/bentrengrove" rel="noopener ugc nofollow" target="_blank"> Ben Trengrove </a>合作完成。</p><p id="f685" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="lm">提供反馈会产生影响，并转化为真正的产品变化。我们喜欢收到您的来信！</em></p><h1 id="e49a" class="kf kg hs bd kh ki kj kk kl km kn ko kp iz kq ja kr jc ks jd kt jf ku jg kv kw bi translated">经验教训</h1><h2 id="8ddf" class="ln kg hs bd kh lo lp lq kl lr ls lt kp jr lu lv kr jv lw lx kt jz ly lz kv ma bi translated">第1课:重用核心地图SDK中的类</h2><p id="7804" class="pw-post-body-paragraph ji jj hs jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">地图SDK已经存在了10多年，被许多应用程序使用。虽然Compose引入了一种完全不同的构建UI的方式，但一个可组合的地图版本应该仍然让人感到熟悉。如果你知道一点Compose，并且以前使用过Maps SDK，那么composable maps对你来说应该很直观。</p><p id="3369" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">为了让API更直观，我们尽可能重用了底层的Maps SDK类。例如，要在地图合成中执行相机更新，您仍然可以使用从<a class="ae ke" href="https://developers.google.com/android/reference/com/google/android/gms/maps/CameraUpdateFactory" rel="noopener ugc nofollow" target="_blank"> CameraUpdateFactory </a>对象创建的现有<a class="ae ke" href="https://developers.google.com/android/reference/com/google/android/gms/maps/CameraUpdate" rel="noopener ugc nofollow" target="_blank"> CameraUpdate </a>类。</p><p id="8d6a" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">然而，在某些情况下，Maps SDK中的现有类不能按原样使用。例如，<a class="ae ke" href="https://developers.google.com/maps/documentation/android-sdk/reference/com/google/android/libraries/maps/UiSettings" rel="noopener ugc nofollow" target="_blank"> UiSettings </a>类被重用是没有意义的，因为它只能在地图创建后被检索。理想情况下，您应该能够创建该类的一个实例，并能够将其传递给GoogleMap composable。为了解决这个问题，该类被镜像为一个地图合成类型，<a class="ae ke" href="https://googlemaps.github.io/android-maps-compose/maps-compose/com.google.maps.android.compose/-map-ui-settings/index.html" rel="noopener ugc nofollow" target="_blank"> MapUiSettings </a>。这个命名与现有的UiSettings类非常匹配，增加了“Map”前缀，有助于API的可发现性。MapUiSettings与UiSettings具有完全相同的属性和默认值，不同之处在于它可以被创建并传递到GoogleMap composable中，而不是从另一个控制表面获取并改变它:</p><figure class="lc ld le lf fd hj"><div class="bz dy l di"><div class="mb lh l"/></div></figure><p id="0706" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在运行时还可以更改映射的其他属性(例如，<a class="ae ke" href="https://developers.google.com/maps/documentation/android-sdk/reference/com/google/android/libraries/maps/GoogleMap#setBuildingsEnabled(boolean)" rel="noopener ugc nofollow" target="_blank">setBuildingsEnabled(boolean)</a>)。我们的一个考虑是将这些属性作为单独的参数公开在GoogleMap composable上；但是，这将显著增加参数的数量，因为有许多属性可以切换。相反，我们选择创建一个单独的类，<a class="ae ke" href="https://googlemaps.github.io/android-maps-compose/maps-compose/com.google.maps.android.compose/-map-properties/index.html" rel="noopener ugc nofollow" target="_blank"> MapProperties </a>，它包含这些运行时配置的属性:</p><figure class="lc ld le lf fd hj"><div class="bz dy l di"><div class="mb lh l"/></div></figure><p id="be85" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">对于可以在地图上绘制的对象(标记、多段线等)。)，基于视图的强制方法是在GoogleMap对象上调用add*方法，如Google map . add marker(marker options)。为了在Compose中进行转换，GoogleMap composable可以为每个绘图接受一个列表参数，但是，这个API可能很难用于包含大量具有复杂逻辑的绘制对象的集成。相反，我们决定公开一个组合友好的API——一个通用的内容lambda，其中的绘图可以作为单独的组合被调用。</p><p id="0d2c" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">需要在地图上绘制标记、折线或其他支持的绘制对象？调用<a class="ae ke" href="https://googlemaps.github.io/android-maps-compose/maps-compose/com.google.maps.android.compose/-marker.html" rel="noopener ugc nofollow" target="_blank">标记</a>、<a class="ae ke" href="https://googlemaps.github.io/android-maps-compose/maps-compose/com.google.maps.android.compose/-polyline.html" rel="noopener ugc nofollow" target="_blank">折线</a>，或者GoogleMap的内容lambda中的另一个装饰器可组合函数，如下所示:</p><figure class="lc ld le lf fd hj"><div class="bz dy l di"><div class="mb lh l"/></div></figure><h2 id="ecae" class="ln kg hs bd kh lo lp lq kl lr ls lt kp jr lu lv kr jv lw lx kt jz ly lz kv ma bi translated">第二课:利用Kotlin的特性</h2><p id="cb1c" class="pw-post-body-paragraph ji jj hs jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">地图SDK是在Kotlin成为编写Android应用程序的一流语言之前开发的。也就是说，Maps SDK主要是用Java构建的。另一方面，Jetpack Compose完全是用Kotlin编写的，并且大量依赖Kotlin的习惯用法。对于Maps Compose，我们还决定利用Kotlin语言特性，如协同程序，来公开一个Kotlin惯用API。</p><p id="52d0" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">例如，Compose为<a class="ae ke" href="https://developer.android.com/jetpack/compose/animation" rel="noopener ugc nofollow" target="_blank">动画API</a>使用了Kotlin的协同程序挂起函数。因此，在Maps SDK中为底层的基于回调的API提供类似的API是有意义的。例如，可以在协程范围内制作摄像机动画并等待其完成:</p><figure class="lc ld le lf fd hj"><div class="bz dy l di"><div class="mb lh l"/></div></figure><p id="f5f5" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">有关在Compose中广泛使用的其他Kotlin习惯用法的列表，请参见Jetpack Compose的<a class="ae ke" href="https://developer.android.com/jetpack/compose/kotlin" rel="noopener ugc nofollow" target="_blank">kot Lin</a>。</p><h2 id="6d4c" class="ln kg hs bd kh lo lp lq kl lr ls lt kp jr lu lv kr jv lw lx kt jz ly lz kv ma bi translated">第3课:保持与其他Compose toolkit APIs的一致性</h2><p id="03f3" class="pw-post-body-paragraph ji jj hs jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">维护与其他Compose toolkit APIs的一致性可以实现良好的开发人员工效学。这样做可以让函数更容易使用，从而更快地开发，因为它遵循了其他API的熟悉约定。无论您是库还是应用程序开发人员，这种一致性对于提高易用性至关重要。<a class="ae ke" href="https://android.googlesource.com/platform/frameworks/support/+/androidx-main/compose/docs/compose-api-guidelines.md" rel="noopener ugc nofollow" target="_blank"> Compose API guidelines </a>是学习Compose API所遵循的惯例的极好资源。</p><p id="6ca8" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">以下是Maps Compose采用的指南中概述的一些模式:</p><ul class=""><li id="8a2c" class="mc md hs jk b jl jm jo jp jr me jv mf jz mg kd mh mi mj mk bi translated">可组合的<a class="ae ke" href="https://github.com/googlemaps/android-maps-compose/blob/main/maps-compose/src/main/java/com/google/maps/android/compose/GoogleMap.kt#L73" rel="noopener ugc nofollow" target="_blank"> GoogleMap </a>符合<a class="ae ke" href="https://github.com/androidx/androidx/blob/androidx-main/compose/docs/compose-api-guidelines.md#elements-accept-and-respect-a-modifier-parameter" rel="noopener ugc nofollow" target="_blank">元素，接受并尊重一个修改参数</a>。</li><li id="c191" class="mc md hs jk b jl ml jo mm jr mn jv mo jz mp kd mh mi mj mk bi translated"><a class="ae ke" href="https://github.com/googlemaps/android-maps-compose/blob/main/maps-compose/src/main/java/com/google/maps/android/compose/Marker.kt#L229" rel="noopener ugc nofollow" target="_blank">MarkerInfoWindow</a>Composable符合在<a class="ae ke" href="https://github.com/androidx/androidx/blob/androidx-main/compose/docs/compose-api-guidelines.md#elements-accept-and-respect-a-modifier-parameter" rel="noopener ugc nofollow" target="_blank"> Compose UI Layouts </a>下列出的这一点:“布局函数应该将它们的主要或最常见的@Composable function参数[这应该被命名为content]放在最后一个位置，以允许使用Kotlin的尾随lambda语法”。</li></ul><p id="ba30" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">有几个实例表明我最初的设计与这些指导方针不同，我发现参考它们来调整API决策以更好地符合Compose最佳实践是非常有帮助的。</p><h2 id="9229" class="ln kg hs bd kh lo lp lq kl lr ls lt kp jr lu lv kr jv lw lx kt jz ly lz kv ma bi translated"><strong class="ak">第4课:普通类最适合二进制兼容性</strong></h2><p id="7a7c" class="pw-post-body-paragraph ji jj hs jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">Kotlin数据类是保存数据的有效方式。它们提供了一些生成的方法，您不必自己编写，为每个类节省了几行代码。然而，如果你正在写一个库，数据类有一个隐藏的成本，因为未来对数据类的改变会破坏二进制兼容性。添加新属性将改变为copy()生成的方法签名，并且根据新属性添加的位置，它还可能破坏析构函数，从而破坏消费者。为了减轻这种情况，Maps Compose为MapUiSetting和MapProperties使用普通类。杰克·沃顿(Jake Wharton)在Kotlin 的博客文章中指出了这一点。</p><h2 id="379d" class="ln kg hs bd kh lo lp lq kl lr ls lt kp jr lu lv kr jv lw lx kt jz ly lz kv ma bi translated">第5课:使用组合公共类型</h2><p id="c40a" class="pw-post-body-paragraph ji jj hs jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">要在Maps SDK中自定义绘制对象的颜色，需要为其提供一个颜色整数。例如，要定制一个圆的填充颜色，您可以在构造<a class="ae ke" href="https://developers.google.com/maps/documentation/android-sdk/reference/com/google/android/libraries/maps/model/CircleOptions#fillColor(int)" rel="noopener ugc nofollow" target="_blank"> CircleOptions </a>对象时为其提供一个颜色整数。另一方面，贴图合成<a class="ae ke" href="https://googlemaps.github.io/android-maps-compose/maps-compose/com.google.maps.android.compose/-circle.html" rel="noopener ugc nofollow" target="_blank">圆</a>，使用合成提供的<a class="ae ke" href="https://developer.android.com/reference/kotlin/androidx/compose/ui/graphics/Color" rel="noopener ugc nofollow" target="_blank">颜色</a>类代替。</p><figure class="lc ld le lf fd hj"><div class="bz dy l di"><div class="mb lh l"/></div></figure><p id="21a6" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">Compose的一个很棒的特性是它内置了对应用素材主题化的支持。因此，通过使用Compose提供的颜色类，当在MaterialTheme中使用GoogleMap及其子组件时，当系统外观变为亮或暗模式时，颜色会自动适应您的主题的颜色。</p><figure class="lc ld le lf fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es mq"><img src="../Images/2e005f0fac811db7dbb48a8ee08d7e79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*nMFEjp-9rxhn6yrsoVyU3Q.gif"/></div></div></figure><h2 id="0078" class="ln kg hs bd kh lo lp lq kl lr ls lt kp jr lu lv kr jv lw lx kt jz ly lz kv ma bi translated">第六课:子组合很强大</h2><p id="7218" class="pw-post-body-paragraph ji jj hs jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">在开发过程的早期，我们发现随着时间的推移，使用副作用API来添加和删除地图装饰以匹配应用程序的数据模型是乏味且容易出错的。管理元素树的需求实际上与管理可组合UI树的需求是同一个问题，因此更好的解决方案是使用相同的底层工具，在状态随时间变化时直接更新元素。这种方法比使用副作用要简单直观得多。</p><p id="92e9" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">为了实现这一点，我们使用了<a class="ae ke" href="https://developer.android.com/reference/kotlin/androidx/compose/runtime/Applier" rel="noopener ugc nofollow" target="_blank"> Applier </a>类和<a class="ae ke" href="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary#ComposeNode(kotlin.Function0,kotlin.Function1)" rel="noopener ugc nofollow" target="_blank"> ComposeNode </a> composable来支持添加绘制对象(标记、折线、多边形等)的基于子的API (content lambda)。)在地图上。最终的实现创建了一个新的子组合来管理地图的状态，而不是组合UI节点。</p><p id="2171" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">以一个标记为例，通过子组合，我们能够确保地图的状态随着重组的发生而更新。因此，例如，如果一个可组合的标记以前在组合中，后来被删除，我们可以利用适当的节点删除方法来确保底层标记映射SDK对象也被从映射中删除。</p><p id="a050" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">如果你想深入研究代码，可以查看一下<a class="ae ke" href="https://github.com/googlemaps/android-maps-compose/blob/main/maps-compose/src/main/java/com/google/maps/android/compose/MapApplier.kt" rel="noopener ugc nofollow" target="_blank"> MapApplier </a>和<a class="ae ke" href="https://github.com/googlemaps/android-maps-compose/blob/main/maps-compose/src/main/java/com/google/maps/android/compose/Marker.kt" rel="noopener ugc nofollow" target="_blank"> Marker </a>的实现，了解更多关于如何使用这些API的信息。</p><h1 id="c54d" class="kf kg hs bd kh ki kj kk kl km kn ko kp iz kq ja kr jc ks jd kt jf ku jg kv kw bi translated">结论</h1><p id="5a6d" class="pw-post-body-paragraph ji jj hs jk b jl kx iu jn jo ky ix jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">总的来说，我对可用的Compose interop APIs如何在Compose中支持Maps SDK印象深刻。虽然地图SDK的本地实现是可取的，但地图合成为许多使用合成的地图开发人员架起了一座桥梁。</p><p id="daf8" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">希望你觉得这篇文章很有见地，并且学到了一两件关于设计Compose APIs和使用现有视图代码进行Compose工作的事情。</p><p id="08bd" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">如果您不熟悉合成或地图合成，请查看示例应用程序以了解更多信息:</p><ul class=""><li id="9abb" class="mc md hs jk b jl jm jo jp jr me jv mf jz mg kd mh mi mj mk bi translated"><a class="ae ke" href="https://github.com/android/compose-samples" rel="noopener ugc nofollow" target="_blank">撰写样本</a></li><li id="6a47" class="mc md hs jk b jl ml jo mm jr mn jv mo jz mp kd mh mi mj mk bi translated"><a class="ae ke" href="https://github.com/googlemaps/android-maps-compose" rel="noopener ugc nofollow" target="_blank">地图构成样本</a></li></ul><p id="576c" class="pw-post-body-paragraph ji jj hs jk b jl jm iu jn jo jp ix jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">如果接下来你想看什么，请告诉我，并在下面留言！</p></div></div>    
</body>
</html>