<html>
<head>
<title>Open sourcing DoctorKafka: Kafka cluster healing and workload balancing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开源DoctorKafka: Kafka集群修复和工作负载平衡</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/open-sourcing-doctorkafka-kafka-cluster-healing-and-workload-balancing-e51ad25b6b17?source=collection_archive---------3-----------------------#2017-08-25">https://medium.com/pinterest-engineering/open-sourcing-doctorkafka-kafka-cluster-healing-and-workload-balancing-e51ad25b6b17?source=collection_archive---------3-----------------------#2017-08-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="2cfe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">杨宇| Pinterest工程师，数据工程</p><p id="ee51" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Pinterest，我们使用<a class="ae jc" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank"> Kafka </a>作为数据接收、流处理等的中央消息传输器。随着+1.75亿用户群的不断增长，以及+1000亿pin图的不断扩展，我们目前在云中运行&gt; 1，000个Kafka经纪人。</p><p id="e21e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这种规模下，我们每周都会遇到Kafka broker失败，有时一天内会遇到多次失败。当一个代理出现故障时，随叫随到的工程师需要及时替换死去的代理，以最大限度地降低由于其他节点故障而导致数据丢失的风险。我们经常需要在代理之间转移工作负载，以平衡工作负载。替换代理和重新平衡工作负载需要仔细创建和编辑分区重新分配文件，并手动执行Kafka脚本命令。这些操作给团队增加了大量开销。</p><p id="a7ef" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了扩大Kafka服务的规模，我们构建了DoctorKafka，这是一种Kafka集群自动修复和工作负载平衡服务。DoctorKafka可以检测代理故障，并自动将工作负载从故障代理重新分配给健康代理。它还可以根据设置执行工作负载平衡。今天我们在<a class="ae jc" href="https://github.com/pinterest/doctorkafka" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上发布DoctorKafka开源项目。在本帖中，我们将介绍它的架构以及它如何对你有用。</p><h2 id="3da6" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated"><strong class="ak">高层概述</strong></h2><figure class="jz ka kb kc fd kd er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es jy"><img src="../Images/f55aa1952f5466db68c2d954503f92ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EGhD17hX6WNVfJC1."/></div></div><figcaption class="kk kl et er es km kn bd b be z dx">Figure 1. High-level overview of DoctorKafka</figcaption></figure><p id="ce75" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">图1显示了DoctorKafka的高级概述。它由三部分组成:</p><ul class=""><li id="9259" class="ko kp hh ig b ih ii il im ip kq it kr ix ks jb kt ku kv kw bi translated">部署在每个代理上的<strong class="ig hi">指标收集器</strong>。它定期收集Kafka进程和主机指标，并将它们发送到Kafka主题。我们使用Kafka作为代理统计数据存储，以简化DoctorKafka的设置并减少其对其他系统的依赖。</li><li id="2bbb" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated">一个<strong class="ig hi">中央DoctorKafka </strong>服务，管理多个集群，分析代理统计指标以检测代理故障，并执行集群修复或工作负载平衡的操作命令。DoctorKafka在另一个“动作日志”主题中记录执行的命令。</li><li id="627c" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated">用于浏览Kafka集群状态和查看执行历史的web UI<strong class="ig hi">。图2显示了管理两个测试集群的UI。图3是一个集群的详细视图。</strong></li></ul><figure class="jz ka kb kc fd kd er es paragraph-image"><div class="er es lc"><img src="../Images/6e51d1104f7827bba3102e0e7b413e01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/0*N20O_v-0Wk9uSiuV."/></div><figcaption class="kk kl et er es km kn bd b be z dx">Figure 2. DoctorKafka front page</figcaption></figure><p id="748e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意，DoctorKafka只采取自信的行动。如果不确定要采取哪些措施，它会发出警报。</p><figure class="jz ka kb kc fd kd er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es ld"><img src="../Images/c852e16eae5b9f2cbf92072587e8898e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LVGcsAESEEz9uTin."/></div></div><figcaption class="kk kl et er es km kn bd b be z dx">Figure 3. DoctorKafka cluster view</figcaption></figure><h2 id="6fb4" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated"><strong class="ak">行动中的卡夫卡医生</strong></h2><p id="d9b0" class="pw-post-body-paragraph ie if hh ig b ih le ij ik il lf in io ip lg ir is it lh iv iw ix li iz ja jb ha bi translated">指标收集器在每个代理上运行，收集Kafka代理关于入站和出站网络流量的指标以及每个副本的统计信息。图4显示了指标收集器收集的部分代理统计信息。主题分区重新分配通常会导致额外的网络流量并扭曲指标，即使有复制配额设置(在Kafka 0.10.1中可用)。因此，在收集指标时，指标收集器会明确报告主题分区是否参与了重新分配。</p><figure class="jz ka kb kc fd kd er es paragraph-image"><div role="button" tabindex="0" class="ke kf di kg bf kh"><div class="er es lj"><img src="../Images/e32db8a439a5ee2ec5674b48bf585a55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kauj73T09wKdxZcr."/></div></div><figcaption class="kk kl et er es km kn bd b be z dx">Figure 4. Broker stats collected by metrics collector</figcaption></figure><p id="397a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当中央DoctorKafka服务启动时，它首先读取过去24-48小时的代理统计数据。通过这个DoctorKafka可以推断出每个副本工作负载的资源需求。由于Kafka的工作负载主要受网络限制，DoctorKafka只关注副本网络带宽的使用。</p><p id="061d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">启动后，DoctorKafka会定期检查每个集群的状态。当检测到代理故障时，它会将故障代理的工作负载重新分配给具有可用带宽的其他代理。如果集群中没有足够的资源来重新分配工作负载，它将发送警报。类似地，当DoctorKafka进行工作负载平衡时，它会识别网络流量超过设置的代理，将工作负载转移到流量较少的其他代理，或者执行首选领导者选举来转移流量。我们忽略在分区重新分配和网络流量冷却期间收集的代理统计信息，以获得更精确的工作负载信息。</p><p id="5617" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">DoctorKafka已经在Pinterest上制作了几个月，帮助我们管理了1000多个Kafka经纪人。我们很乐意向社区发布它，你可以在<a class="ae jc" href="https://github.com/pinterest/doctorkafka/" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到它的源代码和设计文档。非常欢迎您的反馈和意见！</p><p id="8bcc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">开源是Pinterest工程师的一大要务。像YouTube、<a class="ae jc" href="https://www.appsight.io/sdk/pinremoteimage" rel="noopener ugc nofollow" target="_blank">、谷歌</a>、Tinder、<a class="ae jc" href="https://www.appsight.io/sdk/pin-cache" rel="noopener ugc nofollow" target="_blank"> Snap </a>等公司使用我们的开源技术来支持应用持久化、图像下载等等。对于我们所有的开源项目，请查看我们的<a class="ae jc" href="https://github.com/pinterest/" rel="noopener ugc nofollow" target="_blank"> GitHub </a>。</p><p id="9e7b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您对开源或大规模解决此类基础设施挑战感兴趣，<a class="ae jc" href="https://careers.pinterest.com/" rel="noopener ugc nofollow" target="_blank">加入我们的</a>！</p><p id="c4c4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lk">致谢:感谢Jon Parise在开源过程中对我的帮助。</em></p></div></div>    
</body>
</html>