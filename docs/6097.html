<html>
<head>
<title>Tracker: Ingesting MySQL data at scale — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">追踪器:大规模获取MySQL数据—第1部分</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/tracker-ingesting-mysql-data-at-scale-part-1-424cf43fa7c3?source=collection_archive---------1-----------------------#2016-08-11">https://medium.com/pinterest-engineering/tracker-ingesting-mysql-data-at-scale-part-1-424cf43fa7c3?source=collection_archive---------1-----------------------#2016-08-11</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="e6db" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Henry Cai | Pinterest基础设施工程师</p><p id="b92d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Pinterest，我们正在构建世界上最全面的发现引擎，实现高度个性化、相关和快速服务的一部分是在我们的Hadoop/Spark集群上运行数千个作业。为了给计算提供数据，我们需要从MySQL、Kafka和Redis等在线数据源获取大量原始数据。我们之前<a class="ae jc" href="https://engineering.pinterest.com/blog/introducing-pinterest-secor" rel="noopener ugc nofollow" target="_blank">讨论过</a>我们的测井管道和将Kafka数据转移到S3。在这里，我们将分享从MySQL到S3大规模移动数据的经验教训，以及我们实现Tracker的旅程，这是一个大规模移动内容的数据库接收系统。</p><h2 id="fb92" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">历史</h2><p id="7e1b" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">为了对挑战有一个概念，让我们首先看看我们从哪里来。MySQL是Pinterest中存储最重要对象的主要数据源:图钉、图钉和图板。每天，我们从MySQL数据库收集超过100的数据到S3，以驱动我们的离线计算工作流。为了处理这种规模的数据移动，设计和实现进行了多次迭代。</p><p id="d6cf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最初的数据库接收框架(称为“dbdump”)受到了Apache Sqoop的影响，这是一个将数据从数据库拉入HDFS的开源解决方案。我们基于我们的工作流管理器<a class="ae jc" href="https://engineering.pinterest.com/blog/open-sourcing-pinball" rel="noopener ugc nofollow" target="_blank">弹球</a>和我们的DataJob工作流系统构建了一个集群解决方案，以并行拉动MySQL数据库。每个Hadoop mapper进程产生一个Python流作业和一个mysqldump进程，通过进程管道从MySQL主机中提取数据。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es kd"><img src="../Images/5155dd7b4e6841eefacf3e4175826ae9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nMEQKv_OLQmjuljn.png"/></div></div></figure><p id="4867" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该系统在最初几年表现良好，但随着时间的推移，我们面临着越来越多的性能和操作问题，包括:</p><ul class=""><li id="5c49" class="kp kq hh ig b ih ii il im ip kr it ks ix kt jb ku kv kw kx bi translated">在转储期间，现有的框架不处理故障转移(从主设备转储会影响Pinners)，或者从生产中添加或删除从设备。</li><li id="b148" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">大桌子需要几个小时。例如，我们将花费超过12个小时的时间将pin引入Hadoop领域。</li><li id="3cc1" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">MySQL servers模式的所有知识都被检查到代码中，因此只要有模式变化而没有伴随的代码变化，提取过程就会失败。</li><li id="11b4" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">系统不能很好地处理二进制数据，所以我们通常通过十六进制编码数据来回避各种问题。</li><li id="e40f" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">这里有一个组织上的挑战，不同的团队拥有不同版本的框架，所有权很少清晰。</li><li id="1d50" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">现有的框架只知道如何从单个从设备读取，而多个从设备可以用于并行化工作。</li></ul><h2 id="b71e" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">输入跟踪器</h2><p id="eaf3" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">为了解决限制我们的问题，我们设计并实现了跟踪器。当我们开始构建Tracker时，我们认为需要将摄取管道分成两个阶段:</p><ol class=""><li id="df38" class="kp kq hh ig b ih ii il im ip kr it ks ix kt jb ld kv kw kx bi translated">数据库主机上运行的脚本会将其内容备份到S3。此脚本基于本地实例作为从属实例，并且复制已应用了00:00UTC之前创建的所有事件。如果发生故障转移，脚本将自动停止在新的主服务器上执行，并在新的从服务器上开始执行，无需人工干预。</li><li id="7ab3" class="kp kq hh ig b ih ky il kz ip la it lb ix lc jb ld kv kw kx bi translated">可以使用Hadoop集群启动数据库接收，以读取和转换第一步中生成的S3备份文件(即，将数据文件转换为预先存在的dbdump格式或转换为列格式)。注意，在这一步中，我们是在一个纯Hadoop的世界中，所以我们可以使用多少mappers没有限制。</li></ol><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es le"><img src="../Images/36922c4eed91c7a290fb4e5a80d0f6dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*doGZrKpKXIzE9wNP.png"/></div></div></figure><p id="a76b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Hadoop端，我们启动了更多的映射器，并打开了推测执行，以消除偶尔卡住的S3上传器(之前我们无法进行优化，因为MySQL端有负载)。我们还更改了一些关键作业，直接从数据库备份文件中读取，以缩短周转时间。</p><h2 id="71e4" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">进一步的工作</h2><p id="7607" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">通往当前架构的旅程并不完全顺利。请继续关注第2部分，了解我们学到的经验以及MySQL和Hadoop的实现细节。</p><p id="c057" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lf">鸣谢:感谢罗布·伍尔奇、克里希纳·盖德、瓦姆西·彭内坎蒂、叶茂和厄尼·苏赫拉达对追踪器项目做出的宝贵贡献</em></p><p id="8fda" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lf">获取Pinterest工程新闻和更新，关注我们的工程</em><a class="ae jc" href="https://www.pinterest.com/malorie/pinterest-engineering-news/" rel="noopener ugc nofollow" target="_blank"><em class="lf">Pinterest</em></a><em class="lf"/><a class="ae jc" href="https://www.facebook.com/pinterestengineering" rel="noopener ugc nofollow" target="_blank"><em class="lf">脸书</em> </a> <em class="lf">和</em><a class="ae jc" href="https://twitter.com/PinterestEng" rel="noopener ugc nofollow" target="_blank"><em class="lf">Twitter</em></a><em class="lf">。有兴趣加入团队吗？查看我们的</em> <a class="ae jc" href="https://careers.pinterest.com/careers" rel="noopener ugc nofollow" target="_blank"> <em class="lf">招聘</em> </a> <em class="lf">网站。</em></p></div></div>    
</body>
</html>