<html>
<head>
<title>How we reduced Pinterest’s iOS app size by 30+% / 50MB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们如何将Pinterest的iOS应用大小减少30+% / 50MB</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/how-we-reduced-pinterests-ios-app-size-by-30-50mb-68d7f8425882?source=collection_archive---------1-----------------------#2021-04-16">https://medium.com/pinterest-engineering/how-we-reduced-pinterests-ios-app-size-by-30-50mb-68d7f8425882?source=collection_archive---------1-----------------------#2021-04-16</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="8f23" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">马良|软件工程师，应用基础</p><p id="2ab2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们都知道应用程序大小(下载大小[1]和本地安装大小[2])很重要，应用程序大小和客户参与度之间存在相关性。很多时候，人们根据大小来决定是否使用软件，甚至按兆字节支付带宽费用。更不用说，当应用程序大小增加并导致用户试图释放设备上的磁盘空间时，卸载率可能会上升。</p><p id="fc03" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最近，我们发布了对Pinterest iOS应用程序 v9.1的改进，显著缩小了它的大小:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/ef25f2cc66ccb503ff993c017cc63e62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FCueoMjEcXSA-PN6owkIaQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx"><em class="jt">Table 1: iPhone 11 Pro is our target device.</em></figcaption></figure><p id="c479" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此，自推出以来，我们看到新版本的<em class="ju">应用安装量</em>(用户从应用商店下载应用)增加。</p><h1 id="9666" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">有什么问题</h1><p id="41c7" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">在Pinterest，我们用<a class="ae jc" rel="noopener" href="/pinterest-engineering/developing-fast-reliable-ios-builds-at-pinterest-part-one-cb1810407b92">巴泽尔</a>来构建我们的iOS。如果你不熟悉Bazel，这篇<a class="ae jc" href="https://github.com/pinterest/xchammer/blob/master/Docs/BazelForiOSDevelopers.md" rel="noopener ugc nofollow" target="_blank">文章</a>值得一读。</p><p id="353a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了创建我们的本地化文件，我们有一个CI作业，它自动扫描应用程序中的所有源代码(通过bazel query ),并将它们发送到<a class="ae jc" href="https://github.com/box/mojito" rel="noopener ugc nofollow" target="_blank"> Mojito </a>进行翻译。在我们添加了几个扩展之前，这一直工作得很好。</p><p id="3bf7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">每个<a class="ae jc" href="https://developer.apple.com/app-extensions/" rel="noopener ugc nofollow" target="_blank">扩展</a>都是一个模块，有自己的<a class="ae jc" href="https://docs.bazel.build/versions/master/build-ref.html#BUILD_files" rel="noopener ugc nofollow" target="_blank">构建</a>文件。Bazel构建完成后，它会将本地化的字符串从主应用程序包复制到每个扩展包。但是，这将在每个扩展中复制Localizable.strings文件，从而增加整个应用程序包的大小。</p><p id="4769" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所以我们决定从扩展中消除本地化副本。</p><h1 id="35f4" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">修复</h1><p id="0277" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">首先，我们更新了构建文件，因此扩展不再从主应用捆绑包中复制本地化的字符串。</p><p id="5bf9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是，由于这一更改，NSLocalizedString无法正确加载本地化字符串。经过进一步的调查，我们了解到，这些宏都使用+[NSBundle mainBundle]，但+[NSBundle mainBundle]实际上返回的是包含“当前应用程序可执行文件”的捆绑包，当从扩展内部调用时，它是您的应用程序的子文件夹。比如:是`/path/to/Pinterest . app<strong class="ig hi">/PlugIns/siriextension . appex/</strong>`而不是`/path/to/Pinterest.app/`。我们做了一个更改来设置所需的路径，以便NSLocalizedStringWithDefaultValue可以从<strong class="ig hi">主应用包</strong>中读取本地化的字符串。</p><p id="a236" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所有这些保存的更改— <strong class="ig hi">(所有可本地化字符串的大小</strong>)<strong class="ig hi">*</strong>(<strong class="ig hi">统计有此类本地化重复的扩展的数量</strong>)—大约占整个应用程序大小的<strong class="ig hi"> 30% </strong>。</p><h1 id="f031" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">长期计划</h1><p id="b2a6" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">作为后续措施，我们计划将本地化资源放入各自的SDK/扩展中，而不是依赖于应用捆绑包，这具有以下优势:</p><ul class=""><li id="6b71" class="ky kz hh ig b ih ii il im ip la it lb ix lc jb ld le lf lg bi translated">每个捆绑包都是独立的，因此不需要主应用程序捆绑包就可以运行或测试本地化，并且可以捆绑到单独的应用程序中。</li><li id="7e4f" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb ld le lf lg bi translated">NSLocalizedString和本地化API在扩展的代码中自然工作。</li><li id="750a" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb ld le lf lg bi translated">我们可以让这些包开源。</li></ul><p id="b60d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">还有其他潜在的改进领域，如删除非面向消费者的代码的不必要的本地化，研究更有效的图像格式，以及其他编译器级别的优化。敬请关注更多更新，如果你对这样的机会感兴趣，请访问我们的<a class="ae jc" href="https://www.pinterestcareers.com/" rel="noopener ugc nofollow" target="_blank">职业页面</a>。</p><p id="3549" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ju"> [1]下载大小是从app store下载时传输的实际大小，只有当应用程序超过Apple确定的200 MB限制且用户不在Wi-Fi上时才会显示，除非用户更改默认设置。而且它是压缩的，所以比通常的安装尺寸要小。</em></p><p id="44d7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ju">【2】本地安装大小是手机磁盘上的实际应用大小(设置app- &gt; iPhone存储- &gt; Pinterest- &gt; App大小)。它根据您的手机型号变薄，因此通常比通用尺寸小。</em></p></div></div>    
</body>
</html>