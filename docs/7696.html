<html>
<head>
<title>Migrating Large Enterprise to NodeJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将大型企业迁移到NodeJS</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/migrating-large-enterprise-to-nodejs-6c38523d2b33?source=collection_archive---------0-----------------------#2017-12-08">https://medium.com/walmartglobaltech/migrating-large-enterprise-to-nodejs-6c38523d2b33?source=collection_archive---------0-----------------------#2017-12-08</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/fdb950570f9507f2f9bef783aa3eddc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cnFukahb0AYhrrH5K5hZyA.jpeg"/></div></div></figure><div class=""/><p id="733f" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi jn translated">odeJS席卷了开源社区，并迅速成为最受欢迎的开发平台。随着在企业环境中的良好记录，越来越多的公司正在采用它。在<a class="jw jx ge" href="https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------" rel="noopener" target="_blank"> @WalmartLabs </a>时，我们是NodeJS的前沿用户，早期的采用工作如<a class="ae jy" href="https://hapijs.com/" rel="noopener ugc nofollow" target="_blank"> hapi </a>的开发。这里总是有一个繁荣的NodeJS社区。有了<a class="ae jy" href="http://www.electrode.io/" rel="noopener ugc nofollow" target="_blank">电极</a>，它大大加快了NodeJS在<a class="jw jx ge" href="https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------" rel="noopener" target="_blank"> @WalmartLabs </a>中的使用，现在为我们http://www.walmart.com的大部分电子商务网站<a class="ae jy" href="http://www.walmart.com." rel="noopener ugc nofollow" target="_blank">供电。</a>在这篇博客中，我将回顾一些推动电极被采用的关键因素。</p><p id="72ea" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在你进一步阅读之前，请注意有些观点是固执己见的。这是我们认为采用NodeJS的重要性的高层次概述，但是肯定有其他方法来实现这个目标。</p><h2 id="3143" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">获得管理层支持</h2><p id="f797" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">要开发一个通用平台来改变公司开发社区的一大部分，高管们的支持是必不可少的。获得支持可能并不容易。你只能展示NodeJS的成功和优势来说服你的高管。他们必须首先被说服，并主动提供支持。幸运的是，我们的高管已经普遍对NodeJS持开放态度，部分原因是NodeJS在各个项目中的成功使用。</p><h2 id="d28e" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">提供全面的解决方案</h2><p id="3e58" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">NodeJS的一大优势是开发应用程序非常容易，尤其是有了所有可用的开源资源。一些<a class="jw jx ge" href="https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------" rel="noopener" target="_blank"> @WalmartLabs </a>团队使用NodeJS成功开发了他们的应用，但是他们必须以自己的方式处理一切，包括CI/CD设置、部署、监控以及与现有基础设施的集成。一个解决这些问题的平台将对任何希望在应用程序中使用NodeJS的团队有所帮助。</p><p id="2f34" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我在<a class="jw jx ge" href="https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------" rel="noopener" target="_blank">@ walmartlab</a>的头几周，在我写一行JavaScript代码之前，我花了一些时间学习内部<a class="ae jy" href="http://oneops.com/" rel="noopener ugc nofollow" target="_blank"> OneOps cloud infra </a>和Jenkins build系统。然后我设计了一个通用的可重用的方法,让构建和部署NodeJS应用变得简单无缝。我在我的另一篇博客中写了一些技术细节。</p><p id="4b59" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最终，我们确保任何使用电极平台的团队在其应用开发周期的每一步都有一个解决方案。其中包括:</p><ol class=""><li id="f776" class="la lb hs ir b is it iw ix ja lc je ld ji le jm lf lg lh li bi translated">入门和培训支持</li><li id="0cd6" class="la lb hs ir b is lj iw lk ja ll je lm ji ln jm lf lg lh li bi translated">持续开发和集成设置</li><li id="a059" class="la lb hs ir b is lj iw lk ja ll je lm ji ln jm lf lg lh li bi translated">获取云实例并向其部署应用程序</li><li id="37d2" class="la lb hs ir b is lj iw lk ja ll je lm ji ln jm lf lg lh li bi translated">自动化功能端到端集成和回归测试</li><li id="c882" class="la lb hs ir b is lj iw lk ja ll je lm ji ln jm lf lg lh li bi translated">生产稳定性和性能监控支持</li></ol><figure class="lp lq lr ls fd hj er es paragraph-image"><div class="er es lo"><img src="../Images/6af95578278b0f8e7105f9b7ca9011ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*QAepmEkIvSXnkgL6O5OboQ.jpeg"/></div><figcaption class="lt lu et er es lv lw bd b be z dx">Offering all the pieces is important.</figcaption></figure></div><div class="ab cl lx ly go lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ha hb hc hd he"><h2 id="705e" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">提供可重复的部署</h2><p id="a348" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">重要的是，团队可以构建他们的应用程序的不可变版本，以便他们可以在任何时间部署任何版本。在<a class="jw jx ge" href="https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------" rel="noopener" target="_blank"> @WalmartLabs </a>的一般标准实践是将应用程序及其<code class="du me mf mg mh b">node_modules</code>发布到内部npm注册表。我们不得不开发一种新的方法，因为npm不适合这种用途。</p><p id="ef21" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">将应用程序打包成二进制不可变工件，甚至锁定NodeJS运行时的版本，这一点极其重要。所以我们最终做的是用内置的设置清单创建应用程序的zip工件，并将其推送到我们的内部Nexus存储库。</p><h2 id="7fc7" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">提供入职支持</h2><p id="d358" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">我们的开发人员对JavaScript和NodeJS有不同程度的经验。为了帮助所有团队参与进来，我们投入了大量资源来开发培训材料，并通过slack频道提供实时支持。</p><h2 id="f99d" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">支持生产监控</h2><p id="f53f" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">每个团队都必须对生产环境中运行的应用程序的运行状况进行实时监控，以便对问题做出反应。他们还需要能够随着时间的推移收集指标，以了解趋势。<a class="jw jx ge" href="https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------" rel="noopener" target="_blank">@ WalmartLabs</a>one ops cloud已经为应用健康监控和修复提供了许多内置支持。为了增加额外的支持，我们花费了大量时间来实施与我们各种后端基础架构(如Splunk的内部Kafka实例和服务)集成的工具和APM库。</p><figure class="lp lq lr ls fd hj er es paragraph-image"><div class="er es lo"><img src="../Images/8d543fa24df0d4c3deab08f70a91c041.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*2gIgNC1ZcARf72plFwXfDA.jpeg"/></div><figcaption class="lt lu et er es lv lw bd b be z dx">Offer 24/7 realtime and comprehensive monitoring of app health and performance.</figcaption></figure><h2 id="e795" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">标准化集成</h2><p id="8997" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">要运营一个像http://www.walmart.com T2这样的电子商务网站，幕后有许多非常复杂的系统。<a class="jw jx ge" href="https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------" rel="noopener" target="_blank"> @WalmartLabs </a>有内部<em class="kz"> uService </em>架构。这些服务像http端点一样松散地实现为REST。有了工具跟踪和服务到服务授权之类的支持，在调用这些服务时需要做一些设置工作。现有的节点代码每次都要重新发明轮子。</p><p id="94d0" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们的决定是使用Swagger规范标准化所有服务客户端。由于我们的服务端点中的一些非标准的东西，我们实际上不得不稍微定制实现。结果是每个团队的共同努力，为我们使用的所有服务创建了共享客户端。</p><figure class="lp lq lr ls fd hj er es paragraph-image"><div class="er es lo"><img src="../Images/7fbf65d2e7b610a4cc32783dc1722169.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*j4oYojI0odYl2gVaJYnH2w.jpeg"/></div><figcaption class="lt lu et er es lv lw bd b be z dx">Standardizing allow all teams to come together to build and share modules.</figcaption></figure></div><div class="ab cl lx ly go lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ha hb hc hd he"><h2 id="9bdc" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">制定发布模块的计划</h2><p id="72d1" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">对于NodeJS的任何大规模内部采用，能够发布您的私有模块是必不可少的。您可以运行自己的内部注册表或使用npm的私有模块服务。<a class="jw jx ge" href="https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------" rel="noopener" target="_blank"> @WalmartLabs </a>已经有了一个内部npm企业实例。然而，我们在数据库存储方面有问题，所以另一个团队进来，在现有的Nexus存储库的基础上构建了一个新的数据库。如果您想避免这种情况，那么npm的私有模块服务是一个不错的选择。</p><h2 id="7dd6" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">审核您使用的npm模块</h2><p id="ba68" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">NodeJS的模块生态系统是惊人的。现在npm注册表中有将近50万个模块。你几乎可以找到任何你想做的事情的模块。然而，有些模块可能有严重的错误或恶意黑客的意图。所以使用众所周知和流行的模块通常是一个好主意。如果你想使用一个很少使用的模块，那么就要格外小心，仔细检查它的代码，确保它做你认为它做的事情。</p><h2 id="25b8" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">锁定依赖关系</h2><p id="85bc" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">使用npm的NodeJS中的标准实践是使用<a class="ae jy" href="http://semver.org/" rel="noopener ugc nofollow" target="_blank"> semver </a>来获取依赖关系的新的次要版本或补丁版本。然而，这也打开了你的应用程序，让你在下一次<code class="du me mf mg mh b">npm install</code>中获得你可能没有预料到的变化。npm有收缩包装功能。npm@5和yarn具有锁定功能。利用这些来帮助为你的应用维护一个更加一致的模块安装，并保持对何时更新你的依赖关系的更好的控制。提交每个版本的锁文件。当你更新的时候，调试哪个依赖破坏了你的应用是很重要的。</p></div><div class="ab cl lx ly go lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ha hb hc hd he"><h2 id="6ac0" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">支持灵活的动态配置</h2><p id="57d3" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">要在复杂的企业环境中支持数十种不同的应用，灵活的动态配置非常重要。NodeJS应用程序开发周期通常会在进入生产环境之前首先经过本地、开发和试运行环境。其中每一种都有不同的支持，需要进行不同的配置。虽然hapi有<a class="ae jy" href="https://github.com/hapijs/confidence" rel="noopener ugc nofollow" target="_blank">置信度</a>模块，但我们选择了<a class="ae jy" href="https://github.com/lorenwest/node-config" rel="noopener ugc nofollow" target="_blank">节点配置</a>。</p><p id="2f8a" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然而，仅基于<code class="du me mf mg mh b">NODE_ENV</code>构建配置是不够的，因为当在我们的开发和登台云上运行时，它应该总是<code class="du me mf mg mh b">production</code>。我们的应用程序必须能够选择基于云环境的配置，而不是<code class="du me mf mg mh b">NODE_ENV</code>。此外，我们有需要与应用程序集成的内部动态中央配置管理。</p><p id="a096" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了满足这些需求，实现了一个新的NodeJS应用配置管理模块，类似于名为<a class="ae jy" href="https://github.com/electrode-io/electrode-confippet" rel="noopener ugc nofollow" target="_blank">电极配置</a>的node-config。然后，confippet的可扩展性支持被用来实现另一个模块，该模块构成了特定于我们的云设置的配置。</p><figure class="lp lq lr ls fd hj er es paragraph-image"><div class="er es lo"><img src="../Images/1bf63752323fd1b7081e1279ba84f692.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*Fc8xYQuvxWa8EEOuBqo-7g.jpeg"/></div><figcaption class="lt lu et er es lv lw bd b be z dx">Give your user the flexibility to configure their app.</figcaption></figure><h2 id="6d3c" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">考虑哲学理想</h2><p id="750b" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">NodeJS生态系统的好处之一是所有的资源都是可用的。JavaScript的本质为猴子补丁现象打开了大门。一般来说，猴子补丁是一个坏主意，但你愿意不惜任何代价避开它，包括完全阻止你的项目吗？</p><p id="1962" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我遇到的一个问题是基于Java的用户服务平台代码坚持我们的内部http头都是大写的。NodeJS自动将所有http头转换成小写。Java团队正在开发一个新的版本，他们不想对此进行修改。为了推进项目，NodeJS核心被打了猴子补丁，以保持我们的内部http头全部大写。我在<a class="ae jy" rel="noopener" href="/p/f2a10ea3028e">这个博客</a>中写了这个。</p><p id="08d5" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">猴子补丁是一个极端的例子，但每个人都有自己的看法和理想。有时，为了避开拦截器，您可能必须将某些拦截器放在一边。</p><h2 id="47a7" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">使用承诺</h2><p id="e5a2" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">自早期以来，承诺一直是一个有争议的话题。有一个阵营坚决反对，除了回调什么都不用。事实上，有人称之为NodeJS反模式。</p><p id="03b3" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">不要释放萨尔戈怪物。你可以用承诺来避免。您可以通过一个简单的标准接口将任何异步操作附加到承诺链中。在一个拥有大量业务逻辑的大型应用程序中，Promise使得控制流程和错误处理变得非常容易。在使用回调处理复杂的业务逻辑的无尽迷宫中，我有很多糟糕的经历。</p><p id="3882" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">随着babel等工具的出现和Node 8中async/await的引入，Promise的吸引力越来越大，任何向NodeJS迁移的努力都应该尽可能地使用Promise。能够用async/await编写线性的异步JavaScript代码是一种变革。</p><figure class="lp lq lr ls fd hj er es paragraph-image"><div class="er es lo"><img src="../Images/03f08342c93150debfb919ea7ce33168.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*Jl_K2KIptwiCpeUv0KDXKw.jpeg"/></div><figcaption class="lt lu et er es lv lw bd b be z dx">Like legos, Promise offers a simple way to connect all your async pieces.</figcaption></figure></div><div class="ab cl lx ly go lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ha hb hc hd he"><h2 id="63e7" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">找到一条渐进的入职路径</h2><p id="ad5c" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">在我们说服任何团队致力于新平台之前，我们必须首先证明它的可行性。为了做到这一点，我们选择了一个低风险的商业应用程序，并召集了一个高级开发人员团队，开始开发新的应用程序。这个团队还帮助我们进行beta测试，并为我们解决问题提供有价值的反馈。这款应用的成功给了其他团队信心，让他们开始使用自己的应用。</p><h2 id="0d6a" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">遵循NodeJS最佳实践</h2><p id="55de" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">NodeJS提供了一种在生产环境中运行服务器的不同方法，其他人已经发现了一些帮助平稳运行它的实践。例如，在节点服务器前面运行nginx作为http代理是常见的做法。在代码和部署过程中拥有健壮的错误处理也很重要。一定要搜索<code class="du me mf mg mh b">node js production best practices</code>并阅读它找到的一些文章。</p><h2 id="b6e7" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">采用标准，但拥抱所有者</h2><p id="adfd" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">作为结束语，请注意我们的很多努力都是让NodeJS与现有的专有技术一起工作。例如，当我们开始OneOps时，就有关于集装箱化方法的讨论。最后，我们选择了利用已经存在的东西。然而，当有意义时，采用已建立的标准也很重要。因此，当我们有机会使用Swagger来标准化NodeJS领域的服务消费时，我们选择了它。</p><h2 id="b5a1" class="jz ka hs bd kb kc kd ke kf kg kh ki kj ja kk kl km je kn ko kp ji kq kr ks kt bi translated">结论</h2><p id="4575" class="pw-post-body-paragraph ip iq hs ir b is ku iu iv iw kv iy iz ja kw jc jd je kx jg jh ji ky jk jl jm ha bi translated">这是我们认为将企业迁移到NodeJS的重要技术项目的高度概述。在2016节点峰会上，<a class="jw jx ge" href="https://medium.com/u/54a709eacdb7?source=post_page-----6c38523d2b33--------------------------------" rel="noopener" target="_blank">阿历克斯·格里戈良</a>的演讲中，一些物流项目涵盖得更好。还有很多其他的小事情，每一件都有很多细节。我计划在未来写更多关于他们的内容。</p></div></div>    
</body>
</html>