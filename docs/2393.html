<html>
<head>
<title>Today I Learned: Pull Docker Image dari GCR (Google Container Registry) di Kubernetes non GCP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Today I Learned: Pull Docker Image dari GCR (Google Container Registry) di Kubernetes non GCP</h1>
<blockquote>原文：<a href="https://medium.easyread.co/today-i-learned-pull-docker-image-dari-gcr-google-container-registry-di-kubernetes-non-gcp-c142f530047e?source=collection_archive---------1-----------------------#2019-06-25">https://medium.easyread.co/today-i-learned-pull-docker-image-dari-gcr-google-container-registry-di-kubernetes-non-gcp-c142f530047e?source=collection_archive---------1-----------------------#2019-06-25</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="0f63" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">Issue hari ini ketika pull Docker Image dari GCR (Google Container Registry) pada cluster Kubernetes non GCP</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/93ff3d6a008a53c2ef358d4d4d981e9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7lfGxZFcTntykAf0"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@victoire_jonch?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Victoire Joncheray</a> on <a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="b08e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Semenjak DigitalOcean membuka fitur Kubernetes, saya pun mencoba memindahkan beberapa project saya dari GCP (Google Cloud Platform) ke DigitalOcean. Alasannya, ya sudah pasti, Google menawarkan harga yang sebanding dengan fitur yang diharapkan <strong class="kv io"> a.k.a </strong> <em class="lp"> too expensive for personal projects </em> .</p><p id="9f22" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Tetapi, meskipun demikian, saya hanya memindahkan beberapa service saja. Sebut saja seperti service Kubernetes dan Database. Namun service seperti GCR (Google Container Registry) saya masih menggunakannya, alasannya, karena ini masih terbilang lebih murah jika dibandingkan dengan Docker Registry lainnya.</p><p id="8251" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="lp"> Nah </em> , lalu terjadilah masalah tersebut. Ketika saya memindahkan semua Kubernetes cluster saya ke DO (Digital Ocean), saya pun mendapat error yang mungkin sudah kita pikirkan akan terjadi, yaitu <em class="lp"> failed to pull image </em> .</p><pre class="kd ke kf kg gt lq lr ls lt aw lu bi"><span id="38e9" class="lv lw in lr b gy lx ly l lz ma">$ kubectl get pods<br/>NAME                    READY   STATUS         RESTARTS   AGE<br/>august-f7fc98c5-x4chl   0/1     ErrImagePull   0          88s</span></pre><p id="518b" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Kira-kira seperti itulah wujud statusnya jika kita melakukan command <code class="fe mb mc md lr b">kubectl get pods</code> .</p><p id="1f0c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Hal ini terjadi karena, image saya di GCR bersifat <em class="lp"> private </em> . Dan karena bersifat <em class="lp"> private </em> , maka untuk melakukan proses pull, saya membutuhkan akses token.</p><p id="6fd8" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Jadi, solusinya adalah saya pun menambah <em class="lp"> google credential </em> yang akan saya pakai di <em class="lp"> Kubernetes </em> cluster saya yang ada di Digital Ocean. Berikut langkah-langkah yang saya lakukan.</p><h2 id="8b2f" class="lv lw in bd me mf mg dn mh mi mj dp mk lc ml mm mn lg mo mp mq lk mr ms mt mu bi translated"><strong class="ak"> Steps 1: Create Credentials Untuk GCR </strong></h2><ul class=""><li id="4402" class="mv mw in kv b kw mx kz my lc mz lg na lk nb lo nc nd ne nf bi translated">Masuk ke Google Console, pindah ke menu <strong class="kv io"> “API &amp; Services” &gt; “Credentials” </strong></li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/644a736b2656757e7bf4a5672e1c3903.png" data-original-src="https://miro.medium.com/v2/resize:fit:952/format:webp/1*_YTjL9QX4gj3mnk4gqu-Lw.png"/></div></figure><ul class=""><li id="de47" class="mv mw in kv b kw kx kz la lc nh lg ni lk nj lo nc nd ne nf bi translated">Lalu pilih <strong class="kv io"> “Create credentials” &gt; “Services Account Key” &gt; “Create New Services Account”. </strong></li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/a7a4996a1b0111dadc0336f926739ceb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/1*6PXCV-ky-dYli-kqrgwp7A.png"/></div></figure><ul class=""><li id="94ee" class="mv mw in kv b kw kx kz la lc nh lg ni lk nj lo nc nd ne nf bi translated">Lalu, isi saja untuk nama services account, dan untuk Role, pilih project Role <strong class="kv io"> Viewer </strong> .</li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nl"><img src="../Images/f850528811178b6f298965d8d507d893.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q-i3p8o5KAoOcdbnwn6ftQ.png"/></div></div></figure><ul class=""><li id="bf3d" class="mv mw in kv b kw kx kz la lc nh lg ni lk nj lo nc nd ne nf bi translated">Dan klik <strong class="kv io"> Create </strong> . Setelah di create, nanti akan langsung otomatis terdownload sebuah file JSON, dan akan berbentuk seperti berikut.</li></ul><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="2147" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Dengan begini, kita sudah memiliki credentials yang bisa kita gunakan untuk pull Docker Images dari GCR.</p><h2 id="8faf" class="lv lw in bd me mf mg dn mh mi mj dp mk lc ml mm mn lg mo mp mq lk mr ms mt mu bi translated"><strong class="ak"> Steps 2: Menambahkan Kubernetes Secret di Kubernetes Cluster </strong></h2><ul class=""><li id="d3bb" class="mv mw in kv b kw mx kz my lc mz lg na lk nb lo nc nd ne nf bi translated">Selanjutnya adalah menambahkan docker-secret di Kubernetes cluster saya yang ada di DO.</li></ul><pre class="kd ke kf kg gt lq lr ls lt aw lu bi"><span id="3fdd" class="lv lw in lr b gy lx ly l lz ma">$ kubectl create secret docker-registry gcr-json-key \<br/>  --docker-server=asia.gcr.io \<br/>  --docker-username=_json_key \<br/>  --docker-password="$(cat ~/json-key-file-dari-gcp.json)" \<br/>  --docker-email=any@valid.email</span></pre><ul class=""><li id="ada4" class="mv mw in kv b kw kx kz la lc nh lg ni lk nj lo nc nd ne nf bi translated">Eksekusi command diatas, namun sesuaikan dengan server GCR anda. Saya memakai <code class="fe mb mc md lr b">asia.gcr.io</code> , serta untuk password sesuaikan dengan nama file yang kita dapatkan dari Google tadi.</li><li id="4925" class="mv mw in kv b kw no kz np lc nq lg nr lk ns lo nc nd ne nf bi translated">Jika menemukan error seperti berikut dibawah, ketika menjalankan <em class="lp"> command create </em> , maka coba delete dan ulang lagi, atau ganti nama key yang kita gunakan.</li></ul><pre class="kd ke kf kg gt lq lr ls lt aw lu bi"><span id="0ee8" class="lv lw in lr b gy lx ly l lz ma">$ Error from server (AlreadyExists): secrets "gcr-json-key" already exists</span></pre><ul class=""><li id="7c1f" class="mv mw in kv b kw kx kz la lc nh lg ni lk nj lo nc nd ne nf bi translated">Selanjutnya, pastikan secretnya telah terbuat. Seharusnya jika kita menjalankan command berikut, maka <code class="fe mb mc md lr b">gcr-json-key</code> seharusnya ada.</li></ul><pre class="kd ke kf kg gt lq lr ls lt aw lu bi"><span id="21d6" class="lv lw in lr b gy lx ly l lz ma">$ kubectl get secret<br/>NAME         TYPE                                  DATA   AGE<br/>gcr-json-key kubernetes.io/dockerconfigjson        1      6s</span></pre><h2 id="1dea" class="lv lw in bd me mf mg dn mh mi mj dp mk lc ml mm mn lg mo mp mq lk mr ms mt mu bi translated">Steps 3: Menggunakan Secret untuk Deployment</h2><p id="e2d9" class="pw-post-body-paragraph kt ku in kv b kw mx jo ky kz my jr lb lc nt le lf lg nu li lj lk nv lm ln lo ig bi translated">Untuk menggunakan secret yang telah kita buat, terdapat 2 cara.</p><ul class=""><li id="330d" class="mv mw in kv b kw kx kz la lc nh lg ni lk nj lo nc nd ne nf bi translated">Menambahkan secret tersebut ke <strong class="kv io"> ImagePullSecrets </strong> secara default. Sehingga setiap ada pod baru yang akan kita deploy, akan menggunakan secret tersebut secara default didalam satu namespace, atau</li><li id="2500" class="mv mw in kv b kw no kz np lc nq lg nr lk ns lo nc nd ne nf bi translated">Menambahkan secret tersebut kemasing-masing deployment pods.</li></ul><p id="27af" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io"> Steps 3.a: Menambahkan secret ke “ImagePullSecrets” secara default </strong></p><p id="d263" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="lp"> Nah </em> , jika kita ingin membuat secret-key yang telah kita buat tadi dapat digunakan oleh semua pods deployment, langkahnya cukup mudah. Tinggal copykan saja command berikut diterminal.</p><pre class="kd ke kf kg gt lq lr ls lt aw lu bi"><span id="65df" class="lv lw in lr b gy lx ly l lz ma">$ kubectl patch serviceaccount default \<br/>-p '{"imagePullSecrets": [{"name": "gcr-json-key"}]}'</span></pre><p id="3da7" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Setelahnya, kita tinggal lakukan deployment lagi maka pods kita seharusnya sudah bisa berjalan. Sehingga jika dilihat kedalam pods status akan menghasilkan hasil seperti berikut</p><pre class="kd ke kf kg gt lq lr ls lt aw lu bi"><span id="55bd" class="lv lw in lr b gy lx ly l lz ma">$ kubectl describe pod pod_name<br/>....<br/>Normal  Pulling    16s   kubelet, default-staging-oro2  Pulling image "asia.gcr.io/personal-project/august:latest"</span><span id="d403" class="lv lw in lr b gy nw ly l lz ma">Normal  Pulled     12s   kubelet, default-staging-oro2  Successfully pulled image "asia.gcr.io/personal-project/august:latest"</span></pre><p id="9eee" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io"> Steps 3.b: Menambahkan secret ke setiap pods deployment configuration. </strong></p><p id="0dcd" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Untuk langkah ini, kita hanya tinggal menambahkan secret yang telah kita buat diatas tadi ke setiap konfigurasi deployment kita.</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nm nn l"/></div></figure></div><div class="ab cl nx ny hr nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="ig ih ii ij ik"><p id="f651" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Demikian hal baru yang saya pelajari hari ini. Dan ini mungkin akan serupa dengan provider Container Registry lainnya. Semoga berguna bagi yang membutuhkan.</p><h2 id="4260" class="lv lw in bd me mf mg dn mh mi mj dp mk lc ml mm mn lg mo mp mq lk mr ms mt mu bi translated">References</h2><ul class=""><li id="a9c3" class="mv mw in kv b kw mx kz my lc mz lg na lk nb lo nc nd ne nf bi translated"><a class="ae ks" href="https://container-solutions.com/using-google-container-registry-with-kubernetes/" rel="noopener ugc nofollow" target="_blank"> https://container-solutions.com/using-google-container-registry-with-kubernetes/ </a></li></ul></div></div>    
</body>
</html>