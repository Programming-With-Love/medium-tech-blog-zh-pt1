<html>
<head>
<title>Multi-factor authentication for Mendix</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Mendix的多因素认证</h1>
<blockquote>原文：<a href="https://medium.com/mendix/multifactor-authentication-for-mendix-31ffd721e0?source=collection_archive---------2-----------------------#2021-02-19">https://medium.com/mendix/multifactor-authentication-for-mendix-31ffd721e0?source=collection_archive---------2-----------------------#2021-02-19</a></blockquote><div><div class="ef hi hj hk hl hm"/><div class="hn ho hp hq hr"><figure class="ht hu fm fo hv hw fe ff paragraph-image"><div role="button" tabindex="0" class="hx hy di hz bf ia"><div class="fe ff hs"><img src="../Images/d90fc80ee7f54e692f31669cda7adcf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yvJWKPW9Li-Wln03Zx9kxg.png"/></div></div></figure><div class=""/><h1 id="5394" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">什么是多重身份认证？</h1><p id="22a7" class="pw-post-body-paragraph ka kb if bd b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">多因素认证或<strong class="bd kx"> MFA </strong>(也称为<strong class="bd kx">双因素认证</strong>或<strong class="bd kx"> 2FA </strong>，以及类似的术语)是一种电子认证方法，在该方法中，用户只有在向认证机制成功提交两个或多个证据(或因素)后，才被授予访问网站或应用程序的权限，例如:</p><ul class=""><li id="f2c1" class="ky kz if bd b kc la kg lb kk lc ko ld ks le kw lf lg lh li dt translated"><strong class="bd kx">知识</strong>:只有用户<strong class="bd kx">知道的东西</strong>。</li><li id="a286" class="ky kz if bd b kc lj kg lk kk ll ko lm ks ln kw lf lg lh li dt translated"><strong class="bd kx">拥有</strong>:只有使用者<strong class="bd kx">拥有</strong>的东西。</li><li id="eaab" class="ky kz if bd b kc lj kg lk kk ll ko lm ks ln kw lf lg lh li dt translated"><strong class="bd kx">固有</strong>:用户<strong class="bd kx">是</strong>的东西。</li></ul><p id="eb67" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">MFA保护用户免受试图访问其数据(如个人ID详细信息或金融资产)的未知人员的攻击。</p><p id="4450" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated"><em class="lr">“第三方认证器(TPA)应用支持双因素认证，通常通过显示随机生成并不断刷新的代码来进行认证。”- </em>维基百科</p><h1 id="1202" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">我们解决的问题是什么？</h1><p id="c070" class="pw-post-body-paragraph ka kb if bd b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">市场中可用的多因素实现在登录过程中向Mendix应用程序的最终用户提供从SMS、电子邮件输入的代码，或者在实际登录(以及创建用户会话)之后由验证者(Google)生成的代码。请参见下图:</p><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div class="fe ff ls"><img src="../Images/af85a4a0425c7dad5824880d5d28dfb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*e9ar7gTZFoZI-mcteox9Dw.png"/></div></figure><p id="e3fc" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated"><a class="ae lx" href="https://swimlanes.io/d/zEPQlLV3T" rel="noopener ugc nofollow" target="_blank">https://swimlanes.io/d/zEPQlLV3T</a></p><p id="eda8" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">在成功登录时以及在输入MFA代码之前，用户已经具有有效的用户会话以及对用户的授权页面、微流等的访问。(但是您看不到它们，也不容易访问它们)。这种方法仅在动态角色分配时有效，并且在有效的MFA代码之后完成(在Mendix中默认情况下不这样做)。</p><h1 id="baa0" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">解决方法是什么？</h1><p id="010d" class="pw-post-body-paragraph ka kb if bd b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">我们已经构建了一个扩展Mendix LoginAction的MFA模块，记录在<a class="ae lx" href="https://apidocs.rnd.mendix.com/7/runtime/com/mendix/core/action/user/LoginAction.html" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="ae22" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">首先验证MFA代码，然后模块创建一个用户会话，授权用户访问他们的页面、微流等。</p><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div class="fe ff ls"><img src="../Images/2310b035a85955a3a4e3e8d938ded7b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*EkBODhBtsbCjidjQDp57PQ.png"/></div></figure><p id="0191" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated"><a class="ae lx" href="https://swimlanes.io/u/4o7jaAOjY" rel="noopener ugc nofollow" target="_blank">https://swimlanes.io/u/4o7jaAOjY</a></p><p id="9e8f" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">在第一步登录后的时间点:</p><pre class="lt lu lv lw fq ly lz ma mb aw mc dt"><span id="2048" class="md jd if lz b fv me mf l mg mh">mx.data.get({ xpath:”//System.User”, callback:function(data){console.log(data);} })</span></pre><p id="0deb" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">它仍然返回匿名用户对象，如下所示:</p><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div class="fe ff ls"><img src="../Images/7b22b08c815a913ca464a826e4ad8546.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*RqkfOCG9xhEIgOelw-iDPQ.png"/></div></figure><h1 id="1b43" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">我们如何证明这个模块是安全的？</h1><p id="9241" class="pw-post-body-paragraph ka kb if bd b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">涵盖的场景:</p><p id="3eee" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">o禁用MFA的帐户默认通过login.html登录。</p><p id="88d4" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">o为禁用MFA的帐户通过小组件进行默认登录。</p><p id="4266" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">o web service和REST帐户的默认登录。</p><p id="2ba3" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">o通过启用MFA的自定义login.html登录(仅login-with-mfa.html+登录-mfa.js +验证器应用程序代码。通过SMS或电子邮件发送的不兼容代码)。</p><p id="67ea" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">o默认登录小部件，但扩展了输入MFA代码并启用MFA的能力。</p><h1 id="3887" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">这个模块在你的Mendix应用中的易用性如何？</h1><p id="69d7" class="pw-post-body-paragraph ka kb if bd b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">从Mendix Marketplace <a class="ae lx" href="https://marketplace.mendix.com/link/component/116892" rel="noopener ugc nofollow" target="_blank"> <strong class="bd kx">这里</strong> </a> <strong class="bd kx"> </strong>或者从<a class="ae lx" href="https://github.com/appronto/multifactor-authentication/releases/" rel="noopener ugc nofollow" target="_blank"> Github </a>下载该模块。</p><p id="6ad8" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated"><strong class="bd kx">有几样东西要配置:</strong></p><p id="1013" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">启动后配置:<br/> 1。启动后在您的中添加<em class="lr"> ASU_MFA </em>微流。</p><p id="cdca" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">2.更改SUB _ MFA _ UserDisabledCheck以调用您的逻辑来确定登录用户是否需要进行多因素身份验证。向帐户实体添加新属性HasMFAenabled(布尔值)和LastLogin2FA(日期时间)。</p><p id="1e68" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">3.在<em class="lr">SUB _ validatemafoforuser</em>中添加您的多因子认证方法:</p><p id="6faf" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">提供3种样品:</p><p id="b290" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated"><strong class="bd kx">谷歌认证器连接器</strong></p><p id="c34a" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">o模块下载:<a class="ae lx" href="https://marketplace.mendix.com/link/component/2948" rel="noopener ugc nofollow" target="_blank">https://marketplace.mendix.com/link/component/2948</a></p><p id="481c" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">https://play.google.com/store/apps/details?:谷歌Play商店id = com . Google . Android . apps . authenticator 2&amp;HL = en</p><p id="f7ea" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">o苹果应用商店:<a class="ae lx" href="https://apps.apple.com/us/app/google-authenticator/id388497605" rel="noopener ugc nofollow" target="_blank">https://apps . Apple . com/us/App/Google-authenticator/id 388497605</a></p><p id="e051" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated"><strong class="bd kx">短信</strong></p><p id="dc23" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">o更改<em class="lr">SUB _ InformMFACodeForUser</em>发送短信</p><p id="6042" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">o发送短信息，例如Twilio:</p><p id="0d52" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">o在这里尝试Twilio:<a class="ae lx" href="http://appron.to/try-twilio" rel="noopener ugc nofollow" target="_blank">http://appron.to/try-twilio</a>并在<a class="ae lx" href="https://www.twilio.com/console/project/settings" rel="noopener ugc nofollow" target="_blank">https://www.twilio.com/console/project/settings</a>上创建一个API键</p><p id="fed3" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated"><strong class="bd kx">用代码验证的电子邮件验证</strong></p><p id="c329" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">o更改<em class="lr">SUB _ InformMFACodeForUser</em>以发送电子邮件</p><p id="6f20" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">o使用默认的Emailtemplate模块或Sendgrid API为您的用户撰写此电子邮件。</p><p id="3f4c" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">4.将代码片段<em class="lr"> SN_MFA_LoginPage </em>添加到您的登录页面</p><p id="c725" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">5.如果适用，将login-with-mfa.html和js/login-mfa.js从资源目录移动到您的主题目录，以支持从这些页面使用mfa的登录操作。</p><p id="5db2" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">6.将常量<strong class="bd kx"> EnabledMFA </strong>设置为true即可开始！</p><p id="ebc1" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated"><strong class="bd kx">以后从Appstore升级模块时请记住:</strong></p><blockquote class="mi mj mk"><p id="e529" class="ka kb lr bd b kc la ke kf kg lb ki kj ml lo km kn mm lp kq kr mn lq ku kv kw hn dt translated">这将破坏登录机制，但您会得到通知，因为默认情况下，如果没有用您自己的MFA逻辑(正确地)配置模块，将会引发异常。像这样“处理请求时发生错误:java.lang.Exception:创建代码尚未实现”。</p></blockquote><h1 id="8879" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">我们学到了什么</h1><p id="c726" class="pw-post-body-paragraph ka kb if bd b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">我们更喜欢使用非持久的方法来跟踪匿名用户的登录步骤(首先是登录，其次是MFA代码)。我们发现，当第一次尝试被成功验证时，在传递MFA代码的第二步中，与先前匿名会话的上下文/关系被删除。因此，我们无法将此与第一步联系起来。当我们使用一个持久的MFA实体(并在第一次登录后提交MFA对象)时，它是有效的。</p><p id="0cf7" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated"><strong class="bd kx">高级:java挑战:</strong></p><p id="151e" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">当扩展Login Action类并试图在我们的扩展类中设置这个类的参数时，我们发现这不可能与<strong class="bd kx"> super.execute() </strong>方法结合使用。我们决定使用<strong class="bd kx">创作期</strong>。我们已经在第一步中验证了用户名和密码，匿名用户不能修改/创建MFA对象(并且还要检查两次)。</p><p id="1bd4" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">我们还希望该模块通过login.html变体和定制的login-with-mfa.html兼容。因此，有必要将MFA代码与您的用户名和密码一起发送。我们需要通过头部传递这个MFA代码，因为有效负载被核心的LoginAction功能剥离了。</p><p id="17ed" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">使用-mfa.html登录:</p><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div class="fe ff mo"><img src="../Images/46c5388071823596356a04359361db1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:944/format:webp/1*bRIzSRjpU_otBn0OyI_dPA.png"/></div></figure><p id="90bb" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">登录-mfa.js:</p><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div class="fe ff mp"><img src="../Images/744031a9b4cac0dd4f80a4e8c37932db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*oo2e4gN6J8mMJmGevM67qQ.png"/></div></figure><p id="d193" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">多因子AuthLoginAction.java:</p><figure class="lt lu lv lw fq hw fe ff paragraph-image"><div class="fe ff mq"><img src="../Images/f09ccfc388ba0fe7bde9e2f927a16890.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*TFyXQUkGR9l0Wxok7E71_w.png"/></div></figure><h1 id="fdb0" class="jc jd if bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz dt translated">请报告问题</h1><p id="e53f" class="pw-post-body-paragraph ka kb if bd b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw hn dt translated">您是否在本模块中发现了问题或漏洞？请联系<a class="ae lx" href="mailto:pim@appronto.nl" rel="noopener ugc nofollow" target="_blank"> pim@appronto.nl </a>。我会奖励你一个精美的礼包，并在市场上发布新版本。</p></div><div class="ab cl mr ms hb mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="hn ho hp hq hr"><p id="d773" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated"><em class="lr">来自发布者- </em></p><p id="ceff" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated"><em class="lr">如果你喜欢这篇文章，你可以在我们的</em> <a class="ae lx" href="https://medium.com/mendix" rel="noopener"> <em class="lr">媒体页面</em> </a> <em class="lr">或者我们自己的</em> <a class="ae lx" href="https://developers.mendix.com/community-blog/" rel="noopener ugc nofollow" target="_blank"> <em class="lr">社区博客网站</em> </a> <em class="lr">找到更多喜欢的。</em></p><p id="949f" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated"><em class="lr">希望入门的创客，可以注册一个</em> <a class="ae lx" href="https://signup.mendix.com/link/signup/?source=direct" rel="noopener ugc nofollow" target="_blank"> <em class="lr">免费账号</em> </a> <em class="lr">，通过我们的</em> <a class="ae lx" href="https://academy.mendix.com/link/home" rel="noopener ugc nofollow" target="_blank"> <em class="lr">学苑</em> </a> <em class="lr">获得即时学习权限。</em></p><p id="0546" class="pw-post-body-paragraph ka kb if bd b kc la ke kf kg lb ki kj kk lo km kn ko lp kq kr ks lq ku kv kw hn dt translated">有兴趣更多地参与我们的社区吗？你可以加入我们的 <a class="ae lx" href="https://join.slack.com/t/mendixcommunity/shared_invite/zt-hwhwkcxu-~59ywyjqHlUHXmrw5heqpQ" rel="noopener ugc nofollow" target="_blank"> <em class="lr">闲散社区频道</em> </a> <em class="lr">或者想更多参与的人，看看加入我们的</em> <a class="ae lx" href="https://developers.mendix.com/meetups/#meetupsNearYou" rel="noopener ugc nofollow" target="_blank"> <em class="lr">遇见ups </em> </a> <em class="lr">。</em></p></div></div>    
</body>
</html>