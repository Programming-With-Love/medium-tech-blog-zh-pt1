<html>
<head>
<title>Making Custom Views on Android Accessible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让Android上的自定义视图变得可访问</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/making-custom-views-on-android-accessible-76b8d577be53?source=collection_archive---------0-----------------------#2020-08-14">https://medium.com/google-developer-experts/making-custom-views-on-android-accessible-76b8d577be53?source=collection_archive---------0-----------------------#2020-08-14</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="1dae" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">在本帖中，我们将在MovieRatings自定义视图中添加对Google TalkBack(和其他Android辅助服务)的支持</h2></div><p id="559b" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我一直在业余时间非常缓慢地开发一款Android应用程序。这是Letterboxd(类似Goodreads，但用于电影)的客户端，我目前正在复制网站上的一个功能:你可以看到每部电影的用户评级分布。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div class="er es ju"><img src="../Images/5cb9c9cb532826e5af45ebd977f6dd43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1094/format:webp/1*IFKQW8JF9Bn6XMDRENaZMg.png"/></div><figcaption class="kc kd et er es ke kf bd b be z dx">The rating distribution for Marriage Story (2019) tends towards more favorable reviews // <a class="ae js" href="https://letterboxd.com/film/marriage-story-2019/" rel="noopener ugc nofollow" target="_blank">https://letterboxd.com/film/marriage-story-2019/</a></figcaption></figure><p id="f6cd" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">API提供了我们自己构建它所需的一切，所以我创建了一个快速原型，直接在画布上绘制图表，然后用Google TalkBack测试它，这是一个为盲人和视障用户提供的Android辅助功能服务。</p><p id="3715" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">下面的屏幕截图显示了启用对讲的导航(白色圆圈显示了“移动到下一个元素”手势)。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div class="er es kg"><img src="../Images/f67e34e4cf08f09b0af339539b7ff7b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*NDurBphP9OoUTqDzd3Xuvw.gif"/></div><figcaption class="kc kd et er es ke kf bd b be z dx">Screen capture showing that the text elements are focusable using Google TalkBack, but the ratings distribution view is not.</figcaption></figure><p id="d28e" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">它被忽略了。可访问性服务依赖于通过<code class="du kh ki kj kk b"><a class="ae js" href="https://developer.android.com/reference/android/view/accessibility/AccessibilityNodeInfo" rel="noopener ugc nofollow" target="_blank">AccessibilityNodeInfo</a></code>的实例公开的关于每个视图的信息。因为我们直接在画布上绘制，所以这个视图的元数据是空的；对于对讲用户来说，图表是不存在的。</p><blockquote class="kl km kn"><p id="4e9f" class="iw ix jt iy b iz ja ii jb jc jd il je ko jg jh ji kp jk jl jm kq jo jp jq jr ha bi translated">从一个<code class="du kh ki kj kk b">AccessibilityService</code>的角度来看，一个窗口的内容表现为一个可访问性节点infos的树，这个树<strong class="iy hi">可能或者不可能一对一地映射到视图层次结构。换句话说，自定义视图可以自由地将自己报告为可访问性节点信息树。</strong></p></blockquote><p id="2c0a" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我们创建<em class="jt">虚拟视图层次结构，而不是为每个间隔使用单独的视图来重新创建图表。</em>我们可以保留我们的画布，并使其易于访问。</p><p id="7eba" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">要使这个视图可访问，我们需要做两件事:</p><ol class=""><li id="3f41" class="kr ks hh iy b iz ja jc jd jf kt jj ku jn kv jr kw kx ky kz bi translated">描述每个间隔</li><li id="f9e7" class="kr ks hh iy b iz la jc lb jf lc jj ld jn le jr kw kx ky kz bi translated">指出每个间隔的位置</li></ol><p id="b461" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">幸运的是，我们可以使用<code class="du kh ki kj kk b">ExploreByTouchHelper</code>，一个来自<a class="ae js" href="https://developer.android.com/jetpack/androidx/releases/customview" rel="noopener ugc nofollow" target="_blank"> Jetpack Customview </a>库的类，它为我们做了所有困难的事情。</p><h1 id="af8d" class="lf lg hh bd lh li lj lk ll lm ln lo lp in lq io lr iq ls ir lt it lu iu lv lw bi translated">使用ExploreByTouchHelper</h1><p id="aa54" class="pw-post-body-paragraph iw ix hh iy b iz lx ii jb jc ly il je jf lz jh ji jj ma jl jm jn mb jp jq jr ha bi translated"><code class="du kh ki kj kk b">ExploreByTouchHelper</code>是一个抽象类，扩展了<code class="du kh ki kj kk b">AccessibilityDelegateCompat</code>。</p><p id="8a80" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们将助手创建为自定义视图的内部类，这样我们就可以访问<code class="du kh ki kj kk b">onDraw()</code>函数使用的相同属性，然后我们可以将其设置为<code class="du kh ki kj kk b">init</code>块中的委托。</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="mc md l"/></div></figure><p id="eb0d" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们需要实现四个功能，它们听起来很复杂，但是让我们一个一个来看。</p><ol class=""><li id="7347" class="kr ks hh iy b iz ja jc jd jf kt jj ku jn kv jr kw kx ky kz bi translated"><code class="du kh ki kj kk b">fun getVisibleVirtualViews(virtualViewIds: MutableList&lt;Int&gt;)</code></li></ol><p id="2951" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们需要用所有可见虚拟视图的id(图表中的间隔)填充列表。在我们的例子中，所有间隔总是可见的，所以我们将返回所有id的列表。</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="mc md l"/></div></figure><p id="6e93" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">身份证真的很简单。我们只是用区间的指数。</p><p id="7527" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">2.<code class="du kh ki kj kk b">fun getVirtualViewAt(x: float, y: float): Int</code></p><p id="b487" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">对于这个函数，我们需要返回在<code class="du kh ki kj kk b">x, y</code>位置下的虚拟视图的ID，或者如果在这些坐标上没有项目，返回<code class="du kh ki kj kk b">ExploreByTouchHelper.HOST_ID</code>。</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="mc md l"/></div></figure><p id="9306" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们在这里稍微变通了一下规则，忽略了<code class="du kh ki kj kk b">y</code>值来增加触摸面积。即使用户触摸了工具条上方的空间(但仍在<code class="du kh ki kj kk b">RatingsView</code>内)，我们也报告工具条被触摸了:</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div class="er es me"><img src="../Images/64416167507afaa8dc79ced4918dbc56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1114/format:webp/1*LDdnWkLK32c629y1cQ1-Bg.png"/></div></figure><p id="e1f3" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">3.<code class="du kh ki kj kk b">fun onPopulateNodeForVirtualView(virtualViewId: Int, node: AccessibilityNodeInfoCompat)</code></p><p id="86aa" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这是我们为虚拟视图提供所有元数据的地方。</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="mc md l"/></div></figure><p id="bd58" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们需要设置内容描述(或者文本，如果它是可视化的)并在parent中设置边界。</p><p id="23b4" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">父类中的边界应该与<code class="du kh ki kj kk b">onDraw()</code>函数中的逻辑相匹配。</p><p id="f3c0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">4.<code class="du kh ki kj kk b">fun onPerformActionForVirtualView(virtualViewId: Int, action: Int, arguments: Bundle?): Boolean</code></p><p id="cbc2" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">因为我们在步骤3中没有添加任何辅助功能动作，所以永远不应该调用它。我们可以在这里返回<code class="du kh ki kj kk b">false</code>。</p><p id="cd86" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">就是这样！再次用TalkBack测试它，现在我们可以使用“移动到下一个元素”手势来选择每个间隔，并大声朗读每个间隔的描述。</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div class="er es kg"><img src="../Images/fc9c97b66d2179efe13c23c5b7e2c82e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*-bhnL46sKbT2kouOGP45kg.gif"/></div><figcaption class="kc kd et er es ke kf bd b be z dx">Screen capture showing intervals in the ratings distribution view being focused by Google TalkBack</figcaption></figure><h1 id="8cce" class="lf lg hh bd lh li lj lk ll lm ln lo lp in lq io lr iq ls ir lt it lu iu lv lw bi translated">我的触摸探索呢？</h1><p id="ce18" class="pw-post-body-paragraph iw ix hh iy b iz lx ii jb jc ly il je jf lz jh ji jj ma jl jm jn mb jp jq jr ha bi translated">Google TalkBack用户浏览内容的另一种方式是使用触摸浏览。请注意，当用户触摸文本视图时，它们是如何获得可访问性焦点的，但间隔却没有:</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div class="er es kg"><img src="../Images/508b31f2aed9eeb9d3bd113fb438533b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*1bAEZmma-mTIrBb4c-WsRg.gif"/></div><figcaption class="kc kd et er es ke kf bd b be z dx">Screen capture showing that the intervals (virtual views) are resistant to focus when using Explore-by-Touch</figcaption></figure><p id="7224" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为了解决这个问题，我们需要在自定义视图中覆盖一个函数:</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="mc md l"/></div></figure><p id="4455" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最后，一切都按预期运行:</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mf"><img src="../Images/987eb8334690f76a1d8308d11b81ed43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*TRixCH0T-Sg1DVyGlaRpsw.gif"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx">Screen capture showing that both text views and each interval is accessible to TalkBack and Explore-by-Touch</figcaption></figure><p id="da6a" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">也许应该把内容描述更新成有用的东西。</p><h1 id="efd0" class="lf lg hh bd lh li lj lk ll lm ln lo lp in lq io lr iq ls ir lt it lu iu lv lw bi translated">试试吧！</h1><p id="8d91" class="pw-post-body-paragraph iw ix hh iy b iz lx ii jb jc ly il je jf lz jh ji jj ma jl jm jn mb jp jq jr ha bi translated">我发现官方文档很难找到和使用，但是在<a class="ae js" href="https://cs.android.com/androidx/platform/frameworks/support/+/androidx-master-dev:samples/Support4Demos/src/main/java/com/example/android/supportv4/widget/ExploreByTouchHelperActivity.java;l=68?q=ExploreBy&amp;sq=" rel="noopener ugc nofollow" target="_blank"> Jetpack库</a>和<a class="ae js" href="https://github.com/material-components/material-components-android/blob/5fb796437291ce6b7d43b3beba13a42256db6eac/lib/java/com/google/android/material/slider/BaseSlider.java#L2218" rel="noopener ugc nofollow" target="_blank"> MDC for Android </a>库中有很好的示例。</p><p id="c99c" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">你可以<a class="ae js" href="https://github.com/ataulm/android-skeleton/compare/virtual-views-a11y?expand=1" rel="noopener ugc nofollow" target="_blank">在这里</a>看到这个演示的代码——多亏了这个助手类，它只用了不到50行代码！</p><p id="e471" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">让我知道你是如何在Twitter 上找到这篇文章<a class="ae js" rel="noopener ugc nofollow" target="_blank" href="/google-developer-experts/twitter.com/ataulm/">的，或者在下面留下评论。</a></p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="mk md l"/></div></figure></div></div>    
</body>
</html>