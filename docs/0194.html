<html>
<head>
<title>Measuring Web Performance at Airbnb</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Airbnb测量网络性能</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/measuring-web-performance-at-airbnb-122da8d3ea3f?source=collection_archive---------0-----------------------#2021-12-06">https://medium.com/airbnb-engineering/measuring-web-performance-at-airbnb-122da8d3ea3f?source=collection_archive---------0-----------------------#2021-12-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="70b8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">了解Airbnb跟踪哪些网络性能指标，我们如何衡量它们，以及我们在实践中如何权衡它们。</p><p id="4c17" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">乔希·纳尔逊</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/03a9b444121562e57a68d43809ebd629.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-MyZDBHAWNSTbGXG"/></div></div></figure><p id="b77f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">加载这个网页花了多长时间？这是全行业普遍存在的问题，但这是正确的问题吗？最近，从使用基于单秒的指标，如“页面加载”，到描绘更全面的性能图，从网站用户的角度表现体验的指标，已经发生了转变。在Airbnb，衡量我们的客人和主人实际体验到的网络性能至关重要。之前，我们描述了Airbnb <a class="ae jc" rel="noopener" href="/airbnb-engineering/creating-airbnbs-page-performance-score-5f664be0936">如何创建页面性能分数</a>来将来自真实用户的多个指标组合成一个单一分数。在这篇博文中，我们描述了我们认为对我们的网站很重要的指标，以及它们与行业标准的关系。我们还讨论了一些移动这些指标的案例研究，以及它们如何影响网站访问者的体验。</p><h1 id="abb0" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">Web性能指标</h1><p id="be89" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">我们在网站上衡量五个关键绩效指标。我们选择这些指标是因为它们代表了用户体验时的性能，也因为它们的定义<a class="ae jc" href="https://chromium.googlesource.com/chromium/src/+/lkgr/docs/speed/good_toplevel_metrics.md" rel="noopener ugc nofollow" target="_blank">简单、可解释，并且便于计算</a>。</p><p id="9b1a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们记录对网站的直接请求以及页面之间的客户端转换请求的这些指标(Airbnb使用<a class="ae jc" href="https://developer.mozilla.org/en-US/docs/Glossary/SPA" rel="noopener ugc nofollow" target="_blank">单页面应用</a>架构)。我们将概述这些指标，我们如何衡量它们，以及它们在我们的总体<a class="ae jc" rel="noopener" href="/airbnb-engineering/creating-airbnbs-page-performance-score-5f664be0936">页面性能得分</a>中的相对权重。</p><h2 id="7545" class="ks jq hh bd jr kt ku kv jv kw kx ky jz ip kz la kd it lb lc kh ix ld le kl lf bi translated">第一次满意的绘画时间</h2><p id="0a40" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">首次内容丰富绘画的时间(<a class="ae jc" href="https://web.dev/fcp/" rel="noopener ugc nofollow" target="_blank"> TTFCP </a>)测量导航开始和<strong class="ig hi">任何内容出现在屏幕</strong>之间的时间。这可以是文本，加载微调，或任何视觉确认用户网站已收到他们的请求。对于直接请求，我们使用<a class="ae jc" href="https://web.dev/fcp/#measure-fcp-in-javascript" rel="noopener ugc nofollow" target="_blank">绘制计时API </a>。对于客户端路由的转换，我们编写了自己的工具，在页面转换开始时触发:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lg lh l"/></div><figcaption class="li lj et er es lk ll bd b be z dx"><em class="lm">A simplified version of our FCP polyfill for client transitions</em></figcaption></figure><h2 id="3aaf" class="ks jq hh bd jr kt ku kv jv kw kx ky jz ip kz la kd it lb lc kh ix ld le kl lf bi translated">是时候开始有意义的绘画了</h2><p id="b725" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">首次有意义绘画的时间(TTFMP)测量从导航开始到最有意义的元素出现在屏幕上的点<strong class="ig hi">的时间。这通常是页面最大的图像或最高的标题。这向用户表明有用的信息已经到达，他们可以开始使用页面的内容。</strong></p><p id="a7b6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了检测TTFMP，产品工程师用id标记页面中有意义的元素——我们称之为FMP目标。然后我们递归搜索页面的FMP目标。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lg lh l"/></div><figcaption class="li lj et er es lk ll bd b be z dx"><em class="lm">A simplified version of our TTFMP polyfill</em></figcaption></figure><p id="5c19" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">值得注意的是，这个指标需要我们的产品工程师<em class="ln">手动操作</em>——每一页都必须包括一个“FMP目标”，否则我们将永远不会记录第一个有意义的油漆里程碑。为了确保每个页面都正确地使用TTFMP，我们报告了这个元素在给定页面上出现的频率。如果由于缺少工具或FMP目标的有条件呈现而导致发现率低于80%,我们将触发警报，警告该指标对于该页面无效。这要求开发人员通过页面重新设计、重构和A/B测试来保持TTFMP工具的更新。</p><p id="9749" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">自动检测TTFMP很困难，因为很难系统地知道页面上什么元素最“有意义”。<a class="ae jc" href="https://web.dev/lcp/" rel="noopener ugc nofollow" target="_blank">最大内容绘画</a>通过测量页面上最大的元素来解决这个问题。我们不使用最大内容绘制，因为此指标的<a class="ae jc" href="https://developer.mozilla.org/en-US/docs/Web/API/LargestContentfulPaint" rel="noopener ugc nofollow" target="_blank">浏览器API </a>仅返回初始加载的绘制时间，不可用于我们单页应用中的客户端过渡。如果最大内容绘制可以被重置并用于客户端路由转换，我们将使用最大内容绘制作为缺省值，不需要手动操作。</p><h2 id="b943" class="ks jq hh bd jr kt ku kv jv kw kx ky jz ip kz la kd it lb lc kh ix ld le kl lf bi translated">首次输入延迟</h2><p id="e9cd" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">第一输入延迟(<a class="ae jc" href="https://web.dev/fid/" rel="noopener ugc nofollow" target="_blank"> FID </a>)测量浏览器<strong class="ig hi">开始响应用户交互</strong>所需的时间。低FID向用户发出信号，表明该页面是可用的和有响应的。相反，任何超过50毫秒的时间对于用户来说都是<a class="ae jc" href="https://developer.mozilla.org/en-US/docs/Web/Performance/How_long_is_too_long" rel="noopener ugc nofollow" target="_blank">可察觉的延迟</a>。为了支持客户端转换，我们从web-vitals中分支出<a class="ae jc" href="https://github.com/GoogleChrome/web-vitals" rel="noopener ugc nofollow" target="_blank">首次输入延迟</a>工具来重置输入延迟的观察。</p><h2 id="51bd" class="ks jq hh bd jr kt ku kv jv kw kx ky jz ip kz la kd it lb lc kh ix ld le kl lf bi translated">总阻塞时间</h2><p id="cc50" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">总阻塞时间(<a class="ae jc" href="https://web.dev/tbt/" rel="noopener ugc nofollow" target="_blank"> TBT </a>)测量主线程被“阻塞”<strong class="ig hi">的总时间。当TBT较高时，页面在滚动或交互时可能会冻结或停止响应，动画可能会不太流畅<strong class="ig hi">。</strong>耗时超过50毫秒的任务被视为“<a class="ae jc" href="https://w3c.github.io/longtasks/" rel="noopener ugc nofollow" target="_blank">长任务</a>”，并构成TBT。</strong></p><p id="19e1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用TBT的一个困难是很难将阻塞归因于页面上的特定组件或部分。出于这个原因，我们创建了一个称为<em class="ln">交互跨度的子指标</em>，它捕获了在指定窗口内发生的阻塞时间。</p><p id="9693" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当我们报告<em class="ln">总</em>阻塞时间时，我们知道<em class="ln">并非所有阻塞时间都相等</em>——阻塞用户交互所花费的时间比空闲阻塞时间更长。另一个缺点是阻塞时间在页面过程中无限累积，这使得指标很难综合收集，并且受到会话长度的影响。我们正在研究如何将特定的屏蔽时间归因于用户交互，并将遵循web vitals initiative中的<a class="ae jc" href="https://web.dev/smoothness/" rel="noopener ugc nofollow" target="_blank">动画平滑度指标</a>的方向。</p><p id="ed89" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">TBT<a class="ae jc" href="https://developer.mozilla.org/en-US/docs/Web/API/Long_Tasks_API#performancelongtasktiming" rel="noopener ugc nofollow" target="_blank">目前仅在基于Chromium的浏览器</a>中可用，没有polyfill可用。在这些情况下，我们不报告TBT——但是，我们发现即使浏览器支持有限，TBT也是衡量后加载性能的有用指标。</p><h2 id="bbb5" class="ks jq hh bd jr kt ku kv jv kw kx ky jz ip kz la kd it lb lc kh ix ld le kl lf bi translated">累积布局移位</h2><p id="6d33" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">累积布局偏移(<a class="ae jc" href="https://web.dev/cls/" rel="noopener ugc nofollow" target="_blank"> CLS </a>)衡量页面会话期间出现的布局不稳定性，通过元素偏移的大小和距离进行加权。低CLS向用户表明页面是可预测的T21，并给他们信心继续与它互动。</p><p id="d214" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">CLS也不能在我们支持的所有浏览器中使用。虽然没有可用的polyfill，但我们没有报告这些浏览器中CLS的任何值。与TBT类似，我们发现即使是部分浏览器覆盖也是有用的，因为浏览器A中的转换也可能发生在浏览器b中。</p><h1 id="a0d5" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">网页性能得分</h1><p id="e7dc" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">我们使用页面性能分数(PPS)系统来组合这些分数，在本系列的<a class="ae jc" rel="noopener" href="/airbnb-engineering/creating-airbnbs-page-performance-score-5f664be0936">前一篇文章中有描述。PPS将输入指标组合成一个0-100分的分数，我们用于目标设定和回归检测。</a></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/7f7f14290c59320155fdd7f5bb60af85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3bNL6_zkmtI26zDy"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx"><em class="lm">A diagram of the relative weightings of input metrics to the PPS score for a given page. </em><a class="ae jc" href="https://web.dev/fcp/" rel="noopener ugc nofollow" target="_blank"><em class="lm">TTFCP</em></a><em class="lm">: 35%, </em><a class="ae jc" href="https://web.dev/fid/" rel="noopener ugc nofollow" target="_blank">FID</a><em class="lm">: 30%, TTFMP: 15%, </em><a class="ae jc" href="https://web.dev/tbt/" rel="noopener ugc nofollow" target="_blank"><em class="lm">TBT</em></a><em class="lm">: 15%, </em><a class="ae jc" href="https://web.dev/cls/" rel="noopener ugc nofollow" target="_blank"><em class="lm">CLS</em></a><em class="lm">: 5%</em></figcaption></figure><h1 id="dd3c" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">网络生命和灯塔</h1><p id="20c2" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated"><a class="ae jc" href="https://github.com/GoogleChrome/web-vitals" rel="noopener ugc nofollow" target="_blank"> Web Vitals </a>和<a class="ae jc" href="https://developers.google.com/web/tools/lighthouse" rel="noopener ugc nofollow" target="_blank"> Lighthouse </a>是我们在网络上实施PPS的灵感和研究的主要来源。</p><p id="7b54" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Lighthouse是一款通过运行综合测试、审计和评分来对网页进行评级的工具。然而，Lighthouse综合运行这些测试，而PPS根据真实用户指标对页面进行评分。Lighthouse是一个强大的诊断工具，而PPS让我们可以使用真实的用户指标进行目标设置和回归检测。</p><p id="8db1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Web Vitals是一个衡量真实用户指标的库，类似于PPS。然而，它不包括类似于PPS或Lighthouse的数字评分系统，也没有考虑到单页应用程序中的客户转换。我们确实通过包含和优先排序类似的指标来利用网络重要指标，以确保PPS和网络重要指标的方向保持一致。</p><h1 id="84d3" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">早期冲洗案例研究</h1><p id="6a99" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">当进行更改以提高性能时，我们经常运行A/B测试来收集关于我们的改进有多成功的数据。理想情况下，我们会通过改进前面描述的一个或多个指标来严格地改进性能。然而，我们有时会看到这样的例子:一个指标的提高是以牺牲另一个指标为代价的。PPS系统简化了权衡利弊时的决策过程。</p><p id="3f09" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">例如，在具有动态内容的页面上(比如我们的列表页面)，我们之前CDN缓存了包含加载状态的页面的通用版本，从而实现了快速的TTFCP。然后，我们运行了一个实验，尽早从服务器刷新HTML内容，并跳过这个初始加载状态。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lo"><img src="../Images/9542b45bc75ccb197d7ff2b5e449d307.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bXFjV4d-JKnNmRFa6gK0_Q.png"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx"><em class="lm">Left: Before, CDN cached — shimmering skeleton loading state. Right: After, Early flushed page, including the first meaningful paint image.</em></figcaption></figure><p id="0261" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个实验的结果是没有CDN的更慢的TTFCP，但是更快的TTFMP，因为我们跳过了初始加载状态。虽然我们对TTFCP的权重高于TTFMP，但我们发现TTFMP的改善幅度超过了TTFCP的回归，并带来了变化。当我们有一个网页性能分数来帮助我们一致地评估权衡时，这种类型的决策很容易做出。</p><h1 id="77fb" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">摘要</h1><p id="bc09" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">我们通过实验发现，这些指标与积极的用户体验变化相关。Web PPS为我们提供了一个可以用于目标设定和回归检测的单一分数，同时还捕捉到了用户体验的许多不同方面:绘画时间、交互性和布局稳定性。我们希望Web PPS可以作为在Airbnb之外实现类似系统的参考。</p><p id="70da" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们最深切的感谢是为性能而工作的行业同事——随着行业的发展，Web PPS也会发展。</p><p id="6075" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">感谢<a class="ae jc" href="https://www.linkedin.com/in/lupinglin/" rel="noopener ugc nofollow" target="_blank">陆平·林</a>、维克多·林、<a class="ae jc" href="https://www.linkedin.com/in/gabe-lyons-9a574543/" rel="noopener ugc nofollow" target="_blank">加布·莱昂斯</a>、<a class="ae jc" href="https://www.linkedin.com/in/nickbryanmiller/" rel="noopener ugc nofollow" target="_blank">尼克·米勒</a>、<a class="ae jc" href="https://www.linkedin.com/in/hdezninirola/" rel="noopener ugc nofollow" target="_blank">安东尼奥·尼诺拉</a>、<a class="ae jc" href="https://www.linkedin.com/in/adityapunjani/" rel="noopener ugc nofollow" target="_blank">阿迪蒂亚·彭贾尼</a>、<a class="ae jc" href="https://www.linkedin.com/in/guy-rittger-%E2%93%A5-1355b4/" rel="noopener ugc nofollow" target="_blank">盖伊·里特</a>、<a class="ae jc" href="https://www.linkedin.com/in/scheuermann/" rel="noopener ugc nofollow" target="_blank">安德鲁·舒尔曼</a>、<a class="ae jc" href="https://www.linkedin.com/in/jnvollmer/" rel="noopener ugc nofollow" target="_blank">让-尼古拉斯·沃尔默</a>和<a class="ae jc" href="https://www.linkedin.com/in/xiaokangxin/" rel="noopener ugc nofollow" target="_blank">小康欣</a>对本文和PPS的贡献。</p><p id="f1af" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ln">所有产品名称、标识和品牌均为其各自所有者的财产。本网站中使用的所有公司、产品和服务名称仅用于识别目的。使用这些名称、标志和品牌并不意味着认可。</em></p></div></div>    
</body>
</html>