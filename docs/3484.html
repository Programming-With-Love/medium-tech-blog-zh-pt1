<html>
<head>
<title>Azure SQL Database (PaaS) Migration Between Subscriptions OR Resource Groups</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">订阅或资源组之间的Azure SQL数据库(PaaS)迁移</h1>
<blockquote>原文：<a href="https://medium.com/globant/azure-sql-database-paas-migration-between-subscriptions-or-resource-groups-27fb1da8da4d?source=collection_archive---------0-----------------------#2020-09-07">https://medium.com/globant/azure-sql-database-paas-migration-between-subscriptions-or-resource-groups-27fb1da8da4d?source=collection_archive---------0-----------------------#2020-09-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="54c4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="jc">(针对特定用例的可用选项及其可用性之间的比较)</em> </strong></p><p id="7bb9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">的确，这个话题已经被广泛讨论过，并且有多种方法可以用于数据库迁移。Azure-SQL DB作为一个PaaS组件，使我们能够灵活地选择选项来实现复制，但当涉及到已经有许多企业客户在使用的<strong class="ig hi">实时环境</strong>的迁移时，我们总是试图格外谨慎，并再次开始研究最佳可用选项，以最大限度地减少停机时间，并在没有任何数据丢失的情况下实现迁移。</p><p id="489b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此，我将尝试总结实现这种迁移场景的可用选项，并根据过程中涉及的多个因素得出哪一个最适合的结论，并详细讨论其实施过程。</p><p id="74ca" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">场景</strong>:</p><p id="9437" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我有一个生产环境，运行着大约35个金融领域的客户，要求是将整个项目环境迁移到一个新的订阅。</p><p id="4912" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">假设</strong>:</p><p id="c73d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所有其他组件(如web应用程序、存储和其他相关组件)都已复制到新的订阅/资源组，但环境仍在旧的(源)订阅上运行，因为数据库仍仅在该订阅上。</p><p id="2698" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">计划是在非工作时间内完成停机，并快速拥有数据库，以便只需更改数据库的连接字符串，环境就能在新订阅上运行。</p><h1 id="69f8" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak"> 1。数据库导出/导入</strong> : -</h1><p id="51ab" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">您可以将数据库模式和数据导出到BACPAC文件。BACPAC文件是扩展名为BACPAC的ZIP文件，包含数据库中的元数据和数据。</p><p id="d88f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">BACPAC文件可以存储在Azure Blob存储中，也可以存储在本地位置的本地存储中，稍后再导入到Azure SQL数据库、Azure SQL托管实例或SQL Server实例中。</p><p id="6c9f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[1.a]要使用Azure Portal导出数据库，请导航到特定的数据库资源，然后单击工具栏上的<strong class="ig hi">导出</strong>。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es kg"><img src="../Images/898b23dedd84edee78a6f8e0ed78dbd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/format:webp/1*6G_Bo3olyThcmNICKGhfGw.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx">Export Database from Azure Portal</figcaption></figure><p id="b6e5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[1.b]提供BACPAC文件名，选择要存储BACPAC文件的存储帐户。验证订阅、存储和BACPAC文件名，然后单击<strong class="ig hi">确定</strong>。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es ks"><img src="../Images/28aae3fc78eb5bade43870927863cb10.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/format:webp/1*bDsXY-iCCoqJ5VujrwcJ2A.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx">Store Database BACPAC file to Blob</figcaption></figure><p id="c197" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[1.c]要检查导出进度，导航至导出数据库所在的SQL server，点击设置下的<strong class="ig hi">导入/导出历史</strong>。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es kt"><img src="../Images/7c7693e4c387cac4590e8baf1d1fb85c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*W00OgVRhnWlHne1nC_ri1w.png"/></div></figure><p id="9f8a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[1.d]导出后，您可以将BACPAC文件导入目标SQL-Server。导航到SQL服务器，点击工具栏上的<strong class="ig hi">导入</strong>选项。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es ku"><img src="../Images/f2072a5fddd57539be3f21dcd9673513.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*khj5lQXI_0sjw5naIWHtcA.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx">Import Azure SQL DB Backup o SQL Server</figcaption></figure><p id="ceda" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[1.e]提供所需的数据库配置，如下所示，点击<strong class="ig hi">确定。</strong></p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es kv"><img src="../Images/a57d6c6a22640de59de47f4c889d01f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/format:webp/1*yTzhWDqXWkrqKs2KAb0OJQ.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx">Import Azure SQL DB Backup o SQL Server</figcaption></figure><p id="0de5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">上述操作可以使用Powershell /Azure CLI以及Sql包命令行实用程序来实现。</p><p id="6e40" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">关于进出口方式的考虑:</strong></p><ul class=""><li id="4691" class="kw kx hh ig b ih ii il im ip ky it kz ix la jb lb lc ld le bi translated">请确保在导出期间没有写入活动，以使导出的数据库在事务上保持一致。</li><li id="ed78" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">将BACPAC存储到Azure-Blob有最大200 GB的限制，并且无法使用此方法导出到高级存储层。</li><li id="b1ba" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">对于较大的数据库，导出到本地存储。</li><li id="0bbd" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">导入时间取决于数据库的定价层。</li><li id="a957" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">用户应该在SQL Server上拥有执行所需操作所需的权限(SQL Admin)。</li><li id="803b" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">用户可以将数据验证到新的目标数据库中，并且它应该拥有所有数据，直到复制过程开始时的时间戳。</li><li id="e149" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">为了避免任何数据丢失，请确保主数据库上没有发生新的写操作。</li></ul><h1 id="f212" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak"> 2。数据库复制:</strong></h1><p id="2b3e" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">您可以创建现有数据库的副本，并在相同的SQL server或不同的服务器上创建新的数据库。请注意，在使用Azure Portal创建数据库副本时，您无法选择为目标数据库选择不同的订阅。</p><p id="f9ec" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[2.a]导航到要创建副本的数据库组件。点击工具栏上的<strong class="ig hi">复制</strong>。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es lk"><img src="../Images/9e2765a539d339df55802b79aecf01b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*BGctup_bi4ZQ2KY3YfTY_w.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx">Create Copy of Azure SQL Database</figcaption></figure><p id="6b12" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[2.b]默认情况下，它会将数据库名称作为<sourcedbname> _Copy，但您可以根据自己的选择更改目标数据库的名称，并可以选择目标SQL-Server。</sourcedbname></p><p id="61cb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[2.c]选择数据库所需的配置并点击<strong class="ig hi">查看&amp;创建。</strong></p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es ll"><img src="../Images/788fc9b065a23b48d4c3afd5c7f84d4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/format:webp/1*F2L5TKpii8wFwJU9bXmT8g.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx">Select Destination for SQL- Database Copy</figcaption></figure><p id="c577" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[2.d]如果一切正常，它将创建一个新的副本数据库。</p><p id="cb54" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要创建副本数据库，我们也可以使用Powershell或SQL-Query，如下所示:<br/> <strong class="ig hi"> Powershell: </strong></p><pre class="kh ki kj kk fd lm ln lo lp aw lq bi"><span id="5792" class="lr je hh ln b fi ls lt l lu lv">New-AzSqlDatabaseCopy -ResourceGroupName &lt;MyRGName&gt; `<br/>-ServerName &lt;testsqlsrvr1&gt; `<br/>-DatabaseName &lt;testdb1&gt;`<br/>-CopyResourceGroupName &lt;MyRGName2&gt; `<br/>-CopyServerName &lt;testserver2&gt; `<br/>-CopyDatabaseName &lt;testdb1_copy&gt;</span></pre><p id="3159" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">SQL-Query:<br/></strong><code class="du lw lx ly ln b"><strong class="ig hi">CREATE</strong></code><code class="du lw lx ly ln b"><strong class="ig hi">DATABASE</strong></code><code class="du lw lx ly ln b">dbname <strong class="ig hi">AS</strong></code><code class="du lw lx ly ln b">COPY <strong class="ig hi">OF</strong></code>SQL<code class="du lw lx ly ln b">servername.dbname;</code></p><p id="3c08" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">关于复制方法的考虑:</strong></p><ul class=""><li id="6a44" class="kw kx hh ig b ih ii il im ip ky it kz ix la jb lb lc ld le bi translated">我们无法在不同的Azure订阅中创建副本。</li><li id="91b4" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">我们无法将数据库副本追加到现有服务器。</li><li id="ded9" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">用户应该在SQL Server上拥有执行所需操作所需的权限(SQL Admin)。</li><li id="ad20" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">用户可以将数据验证到新的目标数据库中，并且它应该拥有所有数据，直到触发复制操作时的时间戳。</li><li id="c496" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">为了避免任何数据丢失，请确保在复制操作时主数据库上没有发生新的写操作。</li><li id="8d5c" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">显然，在创建数据库副本后，如果源(原始)数据库中仍有新的写操作发生，那么在复制操作的时间戳之后，原始&amp;副本数据库的数据之间将不会有同步<br/>。</li></ul><p id="da8f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="jc">上面提到的两个选项在数据库数量不多时可以考虑。但是如果数据库数量更多，那么最适合的选项将是选项3，如下所述:</em> </strong></p><h1 id="241d" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak"> 3。故障转移到副本SQL服务器&amp;移动副本服务器:</strong></h1><p id="0e2a" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">(有关此选项的更多详细信息，请访问<a class="ae lz" href="https://docs.microsoft.com/en-us/azure/azure-sql/database/auto-failover-group-overview?tabs=azure-powershell" rel="noopener ugc nofollow" target="_blank">微软文档</a>)</p><p id="dc5b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[3.a]在不同于源的区域中创建SQL-Server 的<strong class="ig hi">读取副本，(因为不能为同一区域中的SQL-Server创建故障转移组)</strong></p><p id="2124" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[3.b]在源SQL-Server中创建一个<strong class="ig hi">故障转移组</strong>，并将源(主)服务器中的所有数据库添加到故障转移组。</p><p id="95d2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[3.c]上述两个步骤都可以在迁移日之前完成，以最大限度地减少停机时间。</p><p id="68f2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[3.d]迁移时<strong class="ig hi"> </strong>执行<strong class="ig hi">故障转移</strong>操作，使副本服务器充当主服务器。</p><p id="9c06" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用<strong class="ig hi">故障转移</strong>而不是<strong class="ig hi">强制故障转移</strong>来防止数据丢失。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="er es ma"><img src="../Images/c93a4e9f79738a2d8bad75ed91b469a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rIxRgF3JCWnwby9j4CHPaA.png"/></div></div><figcaption class="ko kp et er es kq kr bd b be z dx">Azure SQL Database Failover to Secondary SQL Server</figcaption></figure><p id="8f15" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用工具栏中的<strong class="ig hi">移动</strong>选项，将这个新的主服务器移动到目标资源组/订阅。</p><p id="51e0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[3.f]移动操作不需要太多时间，并且考虑到所有先决条件都已满足并且没有依赖性，用户将会有流畅的体验。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div class="er es kt"><img src="../Images/eabdc2c3842961815cf5e5a28a0f339a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*N7hpYGM3Lc4HNHSAK3ponQ.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx">Move Azure SQL Server to new Subscription/Resource Group</figcaption></figure><p id="a02d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">[3.g]确保为移动操作选择所有数据库和相关资源</p><p id="cf75" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">考虑:</strong></p><p id="974c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">用户应该具有执行移动操作所需的最低权限。</p><p id="339c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">微软。源资源组上的resources/subscriptions/resource groups/move resources/action。</p><p id="da84" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">微软。目标资源组上的resources/subscriptions/resource group/write。</p><ul class=""><li id="fe7d" class="kw kx hh ig b ih ii il im ip ky it kz ix la jb lb lc ld le bi translated">主SQL Server和辅助SQL Server上的SQL Server管理员权限。</li><li id="c1d7" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">如果某些依赖关系将被破坏，我们将无法移动服务器，例如，如果我们有:<br/>对数据库指标设置的警报规则<br/>长期保留备份<br/>必须确保辅助服务器包含具有完全相同名称的弹性池。<br/>如果主数据库位于弹性池中，则会在弹性池中自动创建同名的辅助数据库(如果尚不存在)。<br/>您不能使用上述方法移动单个/选择性数据库，您需要移动包含您需要移动的数据库的整个SQL Server。</li></ul><h1 id="dff8" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak">值得注意的优点:</strong></h1><ul class=""><li id="cddb" class="kw kx hh ig b ih kb il kc ip mf it mg ix mh jb lb lc ld le bi translated">SQL数据库将在移动操作期间可用。</li><li id="fb32" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">在SQL Server上启用的所有其他读取副本仍将充当读取副本。</li><li id="bd2c" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">通过创建故障转移组，我们自动获得SQL Server的两个连接字符串:一个用于读/写端点，另一个用于只读用途。</li><li id="b106" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">通过使用这些连接字符串，当当前区域出现故障时，应用程序将自动指向当前的主(读写)服务器。(考虑到选择了自动故障转移)。</li></ul><p id="c0f0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有关故障转移组的更多详细信息，请访问<a class="ae lz" href="https://docs.microsoft.com/en-us/azure/azure-sql/database/auto-failover-group-overview?tabs=azure-powershell" rel="noopener ugc nofollow" target="_blank">微软文档。</a></p><p id="9377" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有关在订阅/资源组之间移动资源的更多详细信息，请访问<a class="ae lz" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/move-resource-group-and-subscription" rel="noopener ugc nofollow" target="_blank">微软文档</a></p><blockquote class="mi mj mk"><p id="7f9a" class="ie if jc ig b ih ii ij ik il im in io ml iq ir is mm iu iv iw mn iy iz ja jb ha bi translated"><strong class="ig hi">在分析了上面讨论的3种方法后，我们可以说用户可以根据使用情况灵活地选择选项，但作为一名开发运维工程师，我个人最喜欢的选项/建议是选项3，即创建副本服务器，故障切换到副本服务器并将其移动到目标订阅/资源组。</strong></p></blockquote></div></div>    
</body>
</html>