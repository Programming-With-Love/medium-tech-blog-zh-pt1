# #SmallerAPK，第 8 部分:本地图书馆，在 APK 开放

> 原文：<https://medium.com/androiddevelopers/smallerapk-part-8-native-libraries-open-from-apk-fc22713861ff?source=collection_archive---------4----------------------->

![](img/16742a27007b85054b45771a39fbd376.png)

即使只添加一个本地库，也会显著增加应用程序的大小。如果您的应用程序使用任何本地库(即有。所以文件在你的 APK)，这篇文章是给你的。

有各种各样的 C/C++编译技术和标志可以使您的。所以文件更小，但我不会在本文中讨论本机构建，因为这是一个广泛且非常高级的主题，每个特定的情况都需要特殊处理。另外，你可能会被编译。所以只有文件，不能访问源代码，你对它们的大小无能为力。相反，我将向您展示一个将磁盘空间使用量减半的奇怪技巧！不，真的…继续读:)

在本系列的第 1 部分中，我[提到过](/@wkalicinski/smallerapk-part-1-anatomy-of-an-apk-da83c25e7003#3e57)拥有原生库最大的空间浪费来自于压缩的事实。所以文件在安装时从 APK 复制到用户的*/数据*分区。原件不会从 APK 中删除(因为我们不能从已签名的 apk 中删除文件，记得吗？).因此，它们占据了设备上两倍的空间。

从 Android 6.0(棉花糖)开始，你可以在你的 *<应用>* 上设置一个新的标志:

## AndroidManifest.xml

```
<application
   android:extractNativeLibs=”false”
   ...
>
```

这将从根本上防止系统创建。所以归档并修复 *System.loadLibrary* 调用，这样它就可以直接从 APK 中找到并打开本地库，不需要您修改代码。

不过，这需要一些重要的先决条件，这也是事情变得更加复杂的地方:

1.  的。因此 APK **中的文件不能被压缩**——它们必须被存储。
2.  的。所以文件**必须使用 *zipalign -p 4* 进行页面对齐**

**从 Android Studio 2.2 Preview 2 和最新的构建工具开始，构建过程将自动在 APK 中存储未压缩和页面对齐的原生库。**

让我们看看保持原生库未压缩对文件和下载大小有什么影响:

## 初始下载大小

应该大致相同。这怎么可能呢？Play Store 在向用户设备发送 APK 文件时实际上使用了自己的压缩技术。根据你的特定库的可压缩性，下载的大小可能**大致相同**或者稍微大一点。

## 更新大小

应该是**比**小。Play Store 使用一种称为“增量更新”的机制向现有用户提供新版本的应用程序。它会计算新 APK 和安装在设备上的 APK 之间的差异，并只发送在设备上重建最终 APK 所需的二进制差异。

让原生库解压缩实际上有助于 Play 使用的算法计算更优(即更小)的增量。这些增量补丁文件将被额外压缩以便交付。

## 设备上的大小

棉花糖在设备上的总尺寸将比大**小。但是，旧的 Android 版本不能识别 android:extractNativeLibs 标志，并且总是复制出。所以文件。由于使用这种技术而浪费的额外空间量是压缩和未压缩之间的差异。所以归档吧。**