<html>
<head>
<title>Storing Terraform remote state to Oracle Cloud Infrastructure Object Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Terraform远程状态存储到Oracle云基础架构对象存储</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/storing-terraform-remote-state-to-oracle-cloud-infrastructure-object-storage-b32fe7402781?source=collection_archive---------0-----------------------#2018-02-03">https://medium.com/oracledevs/storing-terraform-remote-state-to-oracle-cloud-infrastructure-object-storage-b32fe7402781?source=collection_archive---------0-----------------------#2018-02-03</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="4c3c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦您对Terraform的使用超出了简单的个人使用开发和测试环境的使用场景，您就需要考虑如何跨项目或团队保持和共享Terraform状态。</p><p id="c374" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Terraform的<a class="ae jc" href="https://www.terraform.io/docs/state/remote.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi">远程状态</strong> </a> <strong class="ig hi"> </strong>配置支持许多远程存储选项，尽管Terraform目前没有为Oracle云基础架构(OCI)提供特定的远程状态后端，但一些现有的后端选项与Oracle对象存储服务兼容。</p><p id="4ea5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本文中，我们将了解三个与<a class="ae jc" href="https://cloud.oracle.com/en_US/infrastructure/storage/object-storage/features" rel="noopener ugc nofollow" target="_blank"> OCI对象存储</a>和<a class="ae jc" href="https://cloud.oracle.com/en_US/storage-classic/object-storage/features" rel="noopener ugc nofollow" target="_blank"> OCI对象存储经典</a>(以及客户云)服务配合使用的特定选项。</p><ul class=""><li id="80a4" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated"><strong class="ig hi">带有<strong class="ig hi"> HTTP </strong>远程状态后端的OCI对象存储</strong></li><li id="11d4" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi"> OCI对象存储</strong>与<strong class="ig hi"> S3 </strong>兼容的远程状态后端</li><li id="5db8" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi"> OCI对象存储经典</strong>与<strong class="ig hi"> S3 </strong>兼容<strong class="ig hi">远程状态后端</strong></li></ul><p id="134b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jr"> Terraform还支持其他几个远程状态后端存储选项，包括</em><a class="ae jc" href="https://www.terraform.io/docs/backends/types/artifactory.html" rel="noopener ugc nofollow" target="_blank"><em class="jr"/></a><em class="jr"/><a class="ae jc" href="https://www.terraform.io/docs/backends/types/etcd.html" rel="noopener ugc nofollow" target="_blank"><em class="jr">etcd</em></a><em class="jr">，以及</em> <a class="ae jc" href="https://www.terraform.io/docs/backends/types/consul.html" rel="noopener ugc nofollow" target="_blank"> <em class="jr">领事</em> </a> <em class="jr">。这些可能是以后文章的主题… </em></p><p id="8e7d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">远程状态后端配置的选择与所使用的Terraform提供商无关，以下所有配置选项可用于Oracle云基础架构的<code class="du js jt ju jv b">oci</code>提供商、Oracle云基础架构Classic和Oracle云at客户的<code class="du js jt ju jv b">opc</code>提供商或任何其他Terraform提供商。</p><h1 id="d2bc" class="jw jx hh bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated"><strong class="ak">使用HTTP远程状态后端</strong></h1><p id="4cdf" class="pw-post-body-paragraph ie if hh ig b ih ku ij ik il kv in io ip kw ir is it kx iv iw ix ky iz ja jb ha bi translated">该选项与<strong class="ig hi"> OCI对象存储</strong>服务一起工作，只需要创建一个对共享状态文件对象的读/写<a class="ae jc" href="https://docs.us-phoenix-1.oraclecloud.com/Content/Object/Tasks/managingaccess.htm#par" rel="noopener ugc nofollow" target="_blank">预认证请求</a> (PAR)，该共享状态文件对象位于将用于远程状态的存储桶中。在创建PAR之前，状态文件必须存在于bucket中。上传现有状态或初始状态的空文件。</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es kz"><img src="../Images/ddca9dac289cfaedb6da565b03ca10cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*K_HJDMSJ7BrsA32d.png"/></div></div></figure><p id="a571" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后在<code class="du js jt ju jv b"><a class="ae jc" href="https://www.terraform.io/docs/backends/types/http.html" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">http</strong></a></code>后端配置中使用预认证的请求URL。</p><pre class="la lb lc ld fd ll jv lm ln aw lo bi"><span id="0c1f" class="lp jx hh jv b fi lq lr l ls lt">terraform {<br/>  backend "http" {<br/>    update_method = "PUT"<br/>    address       = "<!-- -->https://objectstorage.us-phoenix-1.oraclecloud.com/p/_WqQoGnjzyKmqoW0RysqViW-XCEMlOX_JmYM8-eBOh0/n/example/b/terraform-state/o/terraform.tfstate<!-- -->"<br/>  }<br/>}</span></pre><p id="0e60" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了安全起见，考虑在预认证请求上设置一个适当的到期日期，并定期更新par。可以为支持密钥轮换策略对象创建多个解析器。</p><p id="dc73" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">还可以用<code class="du js jt ju jv b">http</code>后端来配置<code class="du js jt ju jv b"><a class="ae jc" href="https://www.terraform.io/docs/providers/terraform/d/remote_state.html" rel="noopener ugc nofollow" target="_blank">terraform_remote_state</a></code>数据源，以便跨项目共享状态。为了与其他配置共享远程状态，您可以使用相同的PAR URL，或者考虑创建一个单独的只读PAR</p><pre class="la lb lc ld fd ll jv lm ln aw lo bi"><span id="7da8" class="lp jx hh jv b fi lq lr l ls lt">data "terraform_remote_state" "project_a" {<br/>  backend = "http"<br/>  config {<br/>    address = "https://objectstorage.us-phoenix-1.oraclecloud.com/p/T-MwMoeU7Y03qTE30bO1IAMElJdbYmMGvAYblYg3f3c/n/oraclepts/b/terraform-state/o/terraform.tfstate"<br/>  }<br/>}</span></pre><h1 id="6f2d" class="jw jx hh bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">使用S3远程状态后端</h1><p id="467f" class="pw-post-body-paragraph ie if hh ig b ih ku ij ik il kv in io ip kw ir is it kx iv iw ix ky iz ja jb ha bi translated">从<code class="du js jt ju jv b">Terraform v0.11.3</code>开始，<strong class="ig hi"> OCI对象存储</strong>和<strong class="ig hi"> OCI经典对象存储</strong>都提供与<code class="du js jt ju jv b"><a class="ae jc" href="https://www.terraform.io/docs/backends/types/s3.html" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">s3</strong></a></code>后端兼容的S3 API</p><p id="ec89" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用s3后端需要一些额外的设置。首先，必须使用s3身份验证密钥启用对象存储帐户</p><p id="116c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于<strong class="ig hi"> OCI对象存储</strong>S3兼容API密钥是按用户设置的，在OCI控制台生成密钥“标识&gt;用户&gt;用户详情&gt;亚马逊S3兼容API密钥”。详见<a class="ae jc" href="https://docs.us-phoenix-1.oraclecloud.com/Content/Identity/Tasks/managingcredentials.htm#s3" rel="noopener ugc nofollow" target="_blank">管理用户凭证</a></p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lu"><img src="../Images/8782b97d4a746335b0c424d0d3837e89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4REPOT9XDNUalzxYGqUFww.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx">OCI console: Identity &gt; Users &gt; User Details &gt; Amazon S3 Compatibility API Keys</figcaption></figure><p id="2212" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于<strong class="ig hi"> OCI经典对象存储</strong>，S3 API密钥在存储经典控制台“存储经典控制台&gt;帐户”中的帐户级别设置。参见<a class="ae jc" href="http://docs.oracle.com/en/cloud/iaas/storage-cloud/cssto/using-s3-api-compatible-clients-access-storage-classic.html" rel="noopener ugc nofollow" target="_blank">使用兼容S3 API的客户端访问Storage Classic </a></p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es lz"><img src="../Images/d585cc48723a5384072fc0f2cd56b726.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GNONozOc53PD_0PaxhFPVw.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx">Storage Classic console: Account</figcaption></figure><p id="f9bb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">默认情况下，s3后端会在<code class="du js jt ju jv b">~/.aws/credentials</code>中查找存储帐户凭证。可以使用s3后端<code class="du js jt ju jv b"><a class="ae jc" href="https://www.terraform.io/docs/backends/types/s3.html#shared_credentials_file" rel="noopener ugc nofollow" target="_blank">shared_credentials_file</a></code>选项设置凭证文件的替代位置。</p><p id="9cb7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注意:<em class="jr">千万不要</em>直接在Terraform后端配置中设置</strong> <code class="du js jt ju jv b">access_key</code> <strong class="ig hi">和</strong> <code class="du js jt ju jv b">secret_key</code> <strong class="ig hi">属性，这是不好的安全做法。</strong></p><p id="718f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">用适当的对象存储凭证配置凭证文件中的<code class="du js jt ju jv b">[default]</code>条目。凭证文件可以包含多个凭证配置文件，如果使用不同的配置文件名称，请确保在Terraform配置中也设置s3后端<code class="du js jt ju jv b"><a class="ae jc" href="https://www.terraform.io/docs/backends/types/s3.html#profile" rel="noopener ugc nofollow" target="_blank">profile</a></code>选项。</p><p id="cdde" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">例如，对于OCI对象存储:</p><pre class="la lb lc ld fd ll jv lm ln aw lo bi"><span id="c2d8" class="lp jx hh jv b fi lq lr l ls lt">[default]<br/>aws_access_key_id=<strong class="jv hi">ocid1.credential.oc1..aaaaaaaasbmhehdmefolvqwtbdjgwfsojsgxgipdbph7odn2bwgurgsyztca</strong><br/>aws_secret_access_key=<strong class="jv hi">mSTdaWhlbWj3ty4JZClm0NUZV52elImWjayJLJ6OH9A=</strong></span></pre><p id="f584" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">其中<code class="du js jt ju jv b">aws_access_key_id</code>和<code class="du js jt ju jv b">aws_secret_access_key</code>是OCI控制台提供的用户特定值。</p><p id="423c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">例如，对于OCI经典物件存储:</p><pre class="la lb lc ld fd ll jv lm ln aw lo bi"><span id="09cc" class="lp jx hh jv b fi lq lr l ls lt">[default]<br/>aws_access_key_id=<strong class="jv hi">Storage-acme</strong><br/>aws_secret_access_key=<strong class="jv hi">SecretKey1</strong></span></pre><p id="da52" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">其中<code class="du js jt ju jv b">aws_access_key_id</code>可以从我的服务控制台中显示的Storage Classic REST端点获得。将<code class="du js jt ju jv b">aws_secret_access_key</code>设置为存储帐户上配置的s3键。</p><pre class="la lb lc ld fd ll jv lm ln aw lo bi"><span id="f43e" class="lp jx hh jv b fi lq lr l ls lt">REST Endpoint https://<strong class="jv hi">{foo}</strong>.storage.oraclecloud.com/v1/Storage-<strong class="jv hi">{bar}</strong><br/>              \_________________ _________________/    \_____ _____/<br/>                               v                            v<br/>                            endpoint                  access_key_id</span></pre><p id="7265" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Terraform s3后端配置中，以以下格式设置OCI或OCI经典对象存储<code class="du js jt ju jv b">endpoint</code>:</p><p id="7f69" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">OCI对象存储:<br/> <code class="du js jt ju jv b">https://<strong class="ig hi">{namespace}</strong>.compat.objectstorage<strong class="ig hi">.{region}</strong>.oraclecloud.com</code></p><p id="3f6e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">存储经典:<br/> <code class="du js jt ju jv b">https://<strong class="ig hi">{foo}</strong>.storage.oraclecloud.com</code></p><p id="df39" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">示例对象存储S3后端配置</strong></p><pre class="la lb lc ld fd ll jv lm ln aw lo bi"><span id="65ab" class="lp jx hh jv b fi lq lr l ls lt">terraform {<br/>  backend "s3" {<br/>    bucket   = "terraform-state"<br/>    key      = "terraform.tfstate"<br/>    region   = "us-phoenix-1"<br/>    endpoint = "<!-- -->https://acme.compat.objectstorage<strong class="jv hi">.</strong>us-phoenix-1<!-- -->.oraclecloud.com"</span><span id="5fe0" class="lp jx hh jv b fi ma lr l ls lt">    skip_region_validation      = true<br/>    skip_credentials_validation = true<br/>    skip_requesting_account_id  = true<br/>    skip_get_ec2_platforms      = true<br/>    skip_metadata_api_check     = true<br/>    force_path_style            = true<br/>  }<br/>}</span></pre><p id="c004" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">类似于HTTP后端的例子，s3后端配置也可以用于<code class="du js jt ju jv b"><a class="ae jc" href="https://www.terraform.io/docs/providers/terraform/d/remote_state.html" rel="noopener ugc nofollow" target="_blank">terraform_remote_state</a></code>数据源，用于跨Terraform项目共享状态</p><p id="91ce" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">配置完后端后，运行<code class="du js jt ju jv b">terraform init</code>完成设置。如果您有一个现有的<code class="du js jt ju jv b">terraform.tfstate</code>，那么Terraform将提示确认当前状态是否应该上传到远程状态。</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es mb"><img src="../Images/48d3736ca4dac9e5bea861ce38e8d2ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tBJuYgBEj9IF_AYOUrgB2w.png"/></div></div></figure></div></div>    
</body>
</html>