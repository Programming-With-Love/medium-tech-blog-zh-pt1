<html>
<head>
<title>Understanding Transactions API in Actions on Google by reading a sample code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过阅读示例代码了解Google Actions中的事务API</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/understanding-transactions-api-in-actions-on-google-by-reading-a-sample-code-1e2b63d98ac3?source=collection_archive---------3-----------------------#2018-08-05">https://medium.com/google-developer-experts/understanding-transactions-api-in-actions-on-google-by-reading-a-sample-code-1e2b63d98ac3?source=collection_archive---------3-----------------------#2018-08-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="58e6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您可以使用交易API将购买和预订功能与您的Google Assistant应用程序集成在一起。但是，您可能不了解事务API的用法，因为有一些步骤、一些意图、一些事件和一些数据结构。也就是说，它很复杂。</p><p id="c33c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">幸运的是，有一个样例代码集可以更容易地理解事务API。我想在这里描述一下将事务API与您的应用程序集成的示例代码的每个步骤。</p><div class="jc jd ez fb je jf"><a href="https://github.com/actions-on-google/dialogflow-transactions-nodejs" rel="noopener  ugc nofollow" target="_blank"><div class="jg ab dw"><div class="jh ab ji cl cj jj"><h2 class="bd hi fi z dy jk ea eb jl ed ef hg bi translated">google上的操作/对话流事务节点</h2><div class="jm l"><h3 class="bd b fi z dy jk ea eb jl ed ef dx translated">dialog flow-Transactions-nodejs——Google Actions中的事务API示例</h3></div><div class="jn l"><p class="bd b fp z dy jk ea eb jl ed ef dx translated">github.com</p></div></div><div class="jo l"><div class="jp l jq jr js jo jt ju jf"/></div></div></a></div><h1 id="ba0d" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">获取示例代码集</h1><p id="d36c" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">您可以通过键入以下命令来克隆示例代码集:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="a2f7" class="lh jw hh ld b fi li lj l lk ll">git clone https://github.com/actions-on-google/dialogflow-transactions-nodejs</span></pre><p id="3cfa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">基本上，您可以通过<code class="du lm ln lo ld b">README.md</code>文件描述的步骤构建整个环境来尝试所有事务处理。我没有提到如何在这里建立环境。相反，我想描述事务API的行为。</p><h1 id="f6f6" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">工艺流程图</h1><p id="66fe" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">dialogflow-transactions-nodejs示例具有以下流程。</p><figure class="ky kz la lb fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es lp"><img src="../Images/7d80981c6d5a60b9acfbd708bc41bb2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M81CShu2UCNAJJX4oItl4Q.png"/></div></div></figure><p id="6178" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">实际交易由以下步骤组成:</p><ol class=""><li id="d93d" class="lw lx hh ig b ih ii il im ip ly it lz ix ma jb mb mc md me bi translated">检查用户是否可以执行助理应用程序请求的新交易。</li><li id="ab96" class="lw lx hh ig b ih mf il mg ip mh it mi ix mj jb mb mc md me bi translated">如果需要，从用户处获取一个递送地址。</li><li id="d249" class="lw lx hh ig b ih mf il mg ip mh it mi ix mj jb mb mc md me bi translated">决定用户是否真正执行事务。</li></ol><p id="cec0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们开始看看每个行为。</p><h1 id="f5bd" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">欢迎信息</h1><figure class="ky kz la lb fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es mk"><img src="../Images/201dd0f4f95521e4746e786a97277194.png" data-original-src="https://miro.medium.com/v2/resize:fit:434/format:webp/1*er8dPwS71FUKTuEbH5pFqg.png"/></div></div></figure><p id="d523" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当应用程序被调用时，应用程序会显示一条欢迎消息。该欢迎消息被设置到<code class="du lm ln lo ld b">Default Welcome Intent</code>意图中，并且欢迎消息字符串是固定的。此外，此意图不使用履行网钩。</p><figure class="ky kz la lb fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es ml"><img src="../Images/668a436106037ccde9650a890c2e6a15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uGqWTOs0MvYvbDxC1fpLRw.png"/></div></div></figure><p id="bf93" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这很简单。没有任何代码。用户阅读如下消息:</p><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es mm"><img src="../Images/f7d2d71d0e6cc8df24b4080cc3e27877.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*1ZGufMBaY6uHOD6iijrUmw.jpeg"/></div></figure><h1 id="77be" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">当用户说“不付款检查交易”时</h1><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es mn"><img src="../Images/650bb5cd9481774fdfb5daf24c7e0823.png" data-original-src="https://miro.medium.com/v2/resize:fit:1072/format:webp/1*y-6JZ4rTdUPZFu4xUkADMw.png"/></div></figure><p id="b46b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">“transaction_check_nopayment”意图有一个训练短语“检查交易而不付款”。这意味着如果用户说出这个短语，这个意图将被调用。</p><figure class="ky kz la lb fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es ml"><img src="../Images/37d29d00dc5bdaf042aced6be1b813cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lKU--SrnhWausw7Na9F1oA.png"/></div></div></figure><p id="a726" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这一意图称之为履行网钩。处理意图的代码如下:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="0202" class="lh jw hh ld b fi li lj l lk ll">app.intent(‘transaction_check_nopayment’, (conv) =&gt; {<br/> conv.ask(new TransactionRequirements());<br/>});</span></pre><p id="69f0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个处理程序用参数调用<code class="du lm ln lo ld b">DialogflowConversation</code>类的<code class="du lm ln lo ld b"><a class="ae mo" href="https://actions-on-google.github.io/actions-on-google-nodejs/classes/conversation.conversation-1.html#ask" rel="noopener ugc nofollow" target="_blank">ask()</a></code>函数。作为参数传递的<code class="du lm ln lo ld b"><a class="ae mo" href="https://actions-on-google.github.io/actions-on-google-nodejs/classes/conversation_question.transactionrequirements.html" rel="noopener ugc nofollow" target="_blank">TransactionRequirements</a></code>类表示检查用户是否处于可处理状态的请求。也就是说，这个类表示<code class="du lm ln lo ld b">actions.intent.TRANSACTION_REQUIREMENTS_CHECK</code>内置意图。</p><p id="9bc2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Google上的操作在收到包含<code class="du lm ln lo ld b">actions.intent.TRANSACTION_REQUIREMENTS_CHECK</code>意图的响应后检查用户的状态。</p><h1 id="edf8" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">当用户说“用行动支付检查交易”时</h1><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es mp"><img src="../Images/647fa266e4bc467ddf9afc75ba639b6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*7q0KG3mLZJjBhygjIj3Rbw.png"/></div></figure><p id="d31c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个用户短语“用支付动作检查交易”被注册在名为“交易_检查_动作”的意向中。</p><figure class="ky kz la lb fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es ml"><img src="../Images/f419111bc43df404859782fb677732b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*npRAXJ5Ne5seDPeoFFwMJg.png"/></div></div></figure><p id="29f6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">与先前的意图一样，实现被称为。代码如下:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="4994" class="lh jw hh ld b fi li lj l lk ll">app.intent(‘transaction_check_action’, (conv) =&gt; {<br/>  conv.ask(new TransactionRequirements({<br/>    orderOptions: {<br/>      requestDeliveryAddress: false,<br/>    },<br/>    paymentOptions: {<br/>      actionProvidedOptions: {<br/>        displayName: ‘VISA-1234’,<br/>        paymentType: ‘PAYMENT_CARD’,<br/>      },<br/>    },<br/>  }));<br/>});</span></pre><p id="057d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这段代码还请求<code class="du lm ln lo ld b">actions.intent.TRANSACTION_REQUIREMENTS_CHECK</code>与<code class="du lm ln lo ld b">TransactionRequirements</code>类的内置意图。然而，在这个处理程序代码中，一些配置被设置为表明这个应用程序自己的付款。配置选项定义为<code class="du lm ln lo ld b"><a class="ae mo" href="https://actions-on-google.github.io/actions-on-google-nodejs/interfaces/actionssdk_api_v2.googleactionsv2transactionrequirementscheckspec.html" rel="noopener ugc nofollow" target="_blank">GoogleActionsV2TransactionRequirementsCheckSpec</a></code>。例如，有两个属性:</p><ul class=""><li id="a0f1" class="lw lx hh ig b ih ii il im ip ly it lz ix ma jb mq mc md me bi translated"><code class="du lm ln lo ld b">orderOptions</code>所代表的<code class="du lm ln lo ld b"><a class="ae mo" href="https://actions-on-google.github.io/actions-on-google-nodejs/interfaces/actionssdk_api_v2.googleactionsv2ordersorderoptions.html" rel="noopener ugc nofollow" target="_blank">GoogleActionsV2OrdersOrderOptions</a></code>类。开发者可以指定一个客户信息和一个是否请求递送地址的标志。</li><li id="0efd" class="lw lx hh ig b ih mf il mg ip mh it mi ix mj jb mq mc md me bi translated"><code class="du lm ln lo ld b">paymentOptions</code>以<code class="du lm ln lo ld b"><a class="ae mo" href="https://actions-on-google.github.io/actions-on-google-nodejs/interfaces/actionssdk_api_v2.googleactionsv2orderspaymentoptions.html" rel="noopener ugc nofollow" target="_blank">GoogleActionsV2OrdersPaymentOptions</a></code>类为代表。</li></ul><p id="3778" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这种情况下，指定了<code class="du lm ln lo ld b">actionProvidedOptions</code>属性，因为用户选择了一个action payment。开发者需要提供两个值:<code class="du lm ln lo ld b"><a class="ae mo" href="https://actions-on-google.github.io/actions-on-google-nodejs/interfaces/actionssdk_api_v2.googleactionsv2ordersactionprovidedpaymentoptions.html" rel="noopener ugc nofollow" target="_blank">GoogleActionsV2OrdersActionProvidedPaymentOptions</a></code>类定义的<code class="du lm ln lo ld b">displayName</code>和<code class="du lm ln lo ld b">paymentType</code>。</p><p id="3255" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Google上的动作根据响应检查用户的状态。</p><h1 id="02d5" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">当用户说“使用谷歌支付检查交易”时</h1><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es mn"><img src="../Images/2dd69ef38829c5b40ce5ccfc74e47e43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1072/format:webp/1*sAA2cSsvrvX8THwtWl_1iw.png"/></div></figure><p id="b034" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后一个用户阶段是“使用谷歌支付检查交易”。这个短语被定义为“transaction_check_google”意图。</p><figure class="ky kz la lb fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es mr"><img src="../Images/0d0994bc0312dd10ffdbf996f472579b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NAVLf2y9wlEq6_AiNxqK8w.png"/></div></div></figure><p id="ce5a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个意图几乎和上面的其他意图一样。当然，这个意图是通过实践来实现的。所以，履行代码是…</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="6c0f" class="lh jw hh ld b fi li lj l lk ll">app.intent('transaction_check_google', (conv) =&gt; {<br/>  conv.ask(new TransactionRequirements({<br/>    orderOptions: {<br/>      requestDeliveryAddress: false,<br/>    },<br/>    paymentOptions: {<br/>      googleProvidedOptions: {<br/>        prepaidCardDisallowed: false,<br/>        supportedCardNetworks: ['VISA', 'AMEX'],<br/>        // These will be provided by payment processor,<br/>        // like Stripe, Braintree, or Vantiv.<br/>        tokenizationParameters: {},<br/>      },<br/>    },<br/>  }));<br/>});</span></pre><p id="46dd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正如代码中的注释，这个处理程序代码是不完整的。要使用Google提供的支付方式，您需要指定由<code class="du lm ln lo ld b"><a class="ae mo" href="https://actions-on-google.github.io/actions-on-google-nodejs/interfaces/actionssdk_api_v2.googleactionsv2ordersgoogleprovidedpaymentoptions.html" rel="noopener ugc nofollow" target="_blank">GoogleActionsV2OrdersGoogleProvidedPaymentOptions</a></code>类定义的<code class="du lm ln lo ld b">googleProvidedOptions</code>属性。在上面的代码中，<code class="du lm ln lo ld b">tokenizationParameters</code>值为空。实际上，您需要为该属性指定一些值。实际上，文档对该属性的描述如下:</p><blockquote class="ms mt mu"><p id="cd28" class="ie if mv ig b ih ii ij ik il im in io mw iq ir is mx iu iv iw my iy iz ja jb ha bi translated">这些令牌化参数将用于生成交易中使用的支付令牌。该应用程序应该从他们的支付网关获得这些参数。</p></blockquote><p id="a87d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这意味着您需要从Stripe、Braintree或Vantiv等支付网关发出并获取支付令牌。此时，您可以检索两个令牌:生产令牌和测试令牌。如果您尝试在沙箱中完成交易，您需要指定用于测试的支付令牌。</p><p id="58e3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当<code class="du lm ln lo ld b">tokenizationParameters</code>值为空，用户尝试使用谷歌支付时，谷歌助手将返回成功响应。但是，交易将在交易确认时失败。</p><h1 id="98ef" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">在检查用户的状态后</h1><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es mz"><img src="../Images/d0bf50cb4555bb863cdde642381e82cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*vBj5U7nnNjGRACQW4cbv7w.png"/></div></figure><p id="d394" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Google上的操作检查用户是否可以完成交易。检查之后，Google上的Actions向Dialogflow发送一个<code class="du lm ln lo ld b">actions.intent.TRANSACTION_REQUIREMENTS_CHECK</code>事件。在此示例中，此事件由“transaction_check_complete”意图接收。</p><figure class="ky kz la lb fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es na"><img src="../Images/76e3555898b10634cb62530bccbabcbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CQBX6AJ9Hk_xYzHK9xYXFQ.png"/></div></div></figure><p id="f03d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个意图没有任何训练短语。相反，事件名称<code class="du lm ln lo ld b">actions.intent.TRANSACTION_REQUIREMENTS_CHECK</code>被设置。</p><p id="ac1b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在之前的意向调用中，Dialogflow返回包含<code class="du lm ln lo ld b">actions.intent.TRANSACTION_REQUIREMENTS_CHECK</code>的响应。在收到Google上的Actions的响应后，Google上的Actions检查用户的状态，然后将<code class="du lm ln lo ld b">actions.intent.TRANSACTION_REQUIREMENTS_CHECK</code>事件从Google上的Actions发送到Dialogflow。这意味着在流程中没有用户交互。这被称为“沉默的意图”。</p><p id="be88" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在发送事件时，请求具有事务检查的结果。在fulfillment中的处理程序代码中，您可以知道如下结果:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="ea05" class="lh jw hh ld b fi li lj l lk ll">app.intent('transaction_check_complete', (conv) =&gt; {<br/>  const arg = conv.arguments.get('TRANSACTION_REQUIREMENTS_CHECK_RESULT');<br/>  if (arg &amp;&amp; arg.resultType ==='OK') {<br/>    // Normally take the user through cart building flow<br/>    conv.ask(`Looks like you're good to go! ` +<br/>      `Try saying "Get Delivery Address".`);<br/>  } else {<br/>    conv.close('Transaction failed.');<br/>  }<br/>});</span></pre><p id="a7f9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果<code class="du lm ln lo ld b">TRANSACTION_REQUIREMENTS_CHECK_RESULT</code>参数的值为<code class="du lm ln lo ld b">OK</code>，则用户的状态为ok。否则，用户无法完成交易。在上面的例子中，当用户的状态不是ok时，对话用<code class="du lm ln lo ld b">conv.close()</code>关闭。</p><p id="e5e5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">用户将看到来自应用程序的响应消息，如下所示:</p><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es mm"><img src="../Images/0954731b1a4c9abfef6619035913132f.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*fqKwxmwrYDpPO8ojqx5RZg.jpeg"/></div></figure><h1 id="0be6" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">当用户说“获取交货地址”时</h1><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es nb"><img src="../Images/121d54de4c24b7cf28f78a63a1265cdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:552/format:webp/1*8crKXIheloEO198ouPDYsQ.png"/></div></figure><p id="1fb1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在前面的消息中，用户导航到say来确定交易的交货地址。当用户说出这个短语时，名为“delivery_address”的意图被调用。</p><figure class="ky kz la lb fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es na"><img src="../Images/797ab4a3c3f7cf1bc6d13611e8d27796.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eCl1jmLAC82BFEwaBLS4qA.png"/></div></div></figure><p id="b14a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">基本上，这个意图很简单，只要求实现。在这个例子中，实现的处理函数如下:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="31d8" class="lh jw hh ld b fi li lj l lk ll">app.intent('delivery_address', (conv) =&gt; {<br/>  conv.ask(new DeliveryAddress({<br/>    addressOptions: {<br/>      reason: 'To know where to send the order',<br/>    },<br/>  }));<br/>});</span></pre><p id="766c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个处理函数不发送任何响应文本。相反，<code class="du lm ln lo ld b"><a class="ae mo" href="https://actions-on-google.github.io/actions-on-google-nodejs/classes/conversation_question.deliveryaddress.html" rel="noopener ugc nofollow" target="_blank">DeliveryAddress</a></code>类的实例被传递给<code class="du lm ln lo ld b">conv.ask()</code>函数。为了传递实例，Dialogflow返回响应，其中包括对Google上的动作的内置意图<code class="du lm ln lo ld b">actions.intent.DELIVERY_ADDRESS</code>。</p><p id="fae8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">收到<code class="du lm ln lo ld b">actions.intent.DELIVERY_ADDRESS</code>意图后，Google上的Actions会询问用户想要将订单送达的地址。也就是说，用户收到来自Google Assistant的响应消息，如下所示:</p><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es mm"><img src="../Images/0afc9ccecfe1a5fcb73b5c271cf5b6f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*0gd4U3YuOx50anJ_mqH6xw.jpeg"/></div></figure><p id="7380" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Android设备上的谷歌助手中，用户注册的地址显示为富卡消息。用户可以点击想要递送的地址的卡片。</p><h1 id="c32a" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">当用户轻敲卡片时</h1><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es nc"><img src="../Images/fb071383c9fb6ce46283c4dfd2005ee6.png" data-original-src="https://miro.medium.com/v2/resize:fit:708/format:webp/1*pO2il3RGIsUMORqUPr82Zw.png"/></div></figure><p id="1835" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过点击卡片，可以确定送货地址。然后，Google上的Actions将名为<code class="du lm ln lo ld b">actions.intent.DELIVERY_ADDRESS</code>的事件发送到Dialogflow，以便用户确定交付地址。当然，这个示例提供了接收事件的意图。名称为“交货地址完成”。</p><figure class="ky kz la lb fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es na"><img src="../Images/955a5ea3d25e49876260ea2eeeebc97f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vz8vXicsxnCCOvCbmSy5Eg.png"/></div></div></figure><p id="8b8a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个意图的任务只是像其他意图一样召唤实现。此示例的处理函数是:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="dfff" class="lh jw hh ld b fi li lj l lk ll">app.intent('delivery_address_complete', (conv) =&gt; {<br/>  const arg = conv.arguments.get('DELIVERY_ADDRESS_VALUE');<br/>  if (arg.userDecision ==='ACCEPTED') {<br/>    console.log('DELIVERY ADDRESS: ' +<br/>    arg.location.postalAddress.addressLines[0]);<br/>    conv.data.deliveryAddress = arg.location;<br/>    conv.ask('Great, got your address! Now say "confirm transaction".');<br/>  } else {<br/>    conv.close('I failed to get your delivery address.');<br/>  }<br/>});</span></pre><p id="7777" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">事件<code class="du lm ln lo ld b">actions.intent.DELIVERY_ADDRESS</code>的请求具有用户确定的递送地址信息。您可以从<code class="du lm ln lo ld b">DELIVERY_ADDRESS_VALUE</code>参数中获得信息。如果用户不接受将送货地址传递给应用程序，则<code class="du lm ln lo ld b">arg.userDecision</code>的值不是<code class="du lm ln lo ld b">ACCEPTED</code>，并且该应用程序使用本示例中的<code class="du lm ln lo ld b">conv.close()</code>函数结束对话。</p><p id="a3e7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果用户接受，检索到的交货地址将存储在<code class="du lm ln lo ld b">conv.data`</code>中，以便在创建订单时使用。最后，这个应用程序通过响应消息导航到下一步。</p><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es mm"><img src="../Images/b9d5c08349f628afb85593834953bb6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*SuX_jSRzKV1SB8EvyqqZzg.jpeg"/></div></figure><h1 id="3ee2" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">当用户说“确认交易”时</h1><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es nd"><img src="../Images/2c647e53ef3db1e8d320f1fc06ec8e29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/1*42vYEGCLM2u4T5e8zUhdPA.png"/></div></figure><p id="c9d6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">得到用户的送货地址后，当用户说“确认交易”时，名为“transaction_decision”的意向被调用。</p><figure class="ky kz la lb fd lq er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es na"><img src="../Images/9566173bdc946af8340e053ea6e0fcdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SKK6VxrYhOhld3Znhpx1hg.png"/></div></div></figure><p id="f618" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里重要的不是意图，而是实现代码。处理意向的函数有责任向用户显示目标订单的摘要，并要求确认用户是否希望完成交易。为了创建订单信息，代码长度往往会变长。</p><p id="fa47" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们看看履行代码。首先，下面的代码创建订单信息。请注意，它经过编辑，省略了一些部分。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="2019" class="lh jw hh ld b fi li lj l lk ll">app.intent('transaction_decision_action', (conv) =&gt; {<br/>  const order = {<br/>    id: UNIQUE_ORDER_ID,<br/>    cart: {<br/>      merchant: {<br/>        id: 'book_store_1',<br/>        name: 'Book Store',<br/>      },<br/>      lineItems: [<br/>        {<br/>          name: 'My Memoirs',<br/>          id: 'memoirs_1',<br/>          price: {<br/>            amount: {<br/>              currencyCode: 'USD',<br/>              nanos: 990000000,<br/>              units: 3,<br/>            },<br/>            type: 'ACTUAL',<br/>          },<br/>          quantity: 1,<br/>          subLines: [<br/>            {<br/>              note: 'Note from the author',<br/>            },<br/>          ],<br/>          type: 'REGULAR',<br/>        },<br/>        ...<br/>      ],<br/>      notes: 'The Memoir collection',<br/>      otherItems: [<br/>        {<br/>          name: 'Subtotal',<br/>          id: 'subtotal',<br/>          price: {<br/>            amount: {<br/>              currencyCode: 'USD',<br/>              nanos: 220000000,<br/>              units: 32,<br/>            },<br/>            type: 'ESTIMATE',<br/>          },<br/>          type: 'SUBTOTAL',<br/>        },<br/>        {<br/>          name: 'Tax',<br/>          id: 'tax',<br/>          price: {<br/>            amount: {<br/>              currencyCode: 'USD',<br/>              nanos: 780000000,<br/>              units: 2,<br/>            },<br/>            type: 'ESTIMATE',<br/>          },<br/>          type: 'TAX',<br/>        },<br/>      ],<br/>    },<br/>    otherItems: [],<br/>    totalPrice: {<br/>      amount: {<br/>        currencyCode: 'USD',<br/>        nanos: 0,<br/>        units: 35,<br/>      },<br/>      type: 'ESTIMATE',<br/>    },<br/>  };</span></pre><p id="99a9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">订单信息由<code class="du lm ln lo ld b"><a class="ae mo" href="https://actions-on-google.github.io/actions-on-google-nodejs/interfaces/actionssdk_api_v2.googleactionsv2ordersproposedorder.html" rel="noopener ugc nofollow" target="_blank">GoogleActionsV2OrdersProposedOrder</a></code>类表示。这由一些部分组成。例如，该示例中的对象具有如下一些属性:</p><ul class=""><li id="1134" class="lw lx hh ig b ih ii il im ip ly it lz ix ma jb mq mc md me bi translated"><code class="du lm ln lo ld b">id</code>订单的唯一ID。</li><li id="7435" class="lw lx hh ig b ih mf il mg ip mh it mi ix mj jb mq mc md me bi translated"><code class="du lm ln lo ld b">cart</code>用户的物品。</li><li id="768c" class="lw lx hh ig b ih mf il mg ip mh it mi ix mj jb mq mc md me bi translated"><code class="du lm ln lo ld b">totalPrice</code>这份订单的总价。</li></ul><p id="6f0d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此外，由<code class="du lm ln lo ld b"><a class="ae mo" href="https://actions-on-google.github.io/actions-on-google-nodejs/interfaces/actionssdk_api_v2.googleactionsv2orderscart.html" rel="noopener ugc nofollow" target="_blank">GoogleActionsV2OrdersCart</a></code>类表示的<code class="du lm ln lo ld b">cart</code>具有以下属性:</p><ul class=""><li id="ea9c" class="lw lx hh ig b ih ii il im ip ly it lz ix ma jb mq mc md me bi translated"><code class="du lm ln lo ld b">merchant</code>此订单的商家信息。</li><li id="ee58" class="lw lx hh ig b ih mf il mg ip mh it mi ix mj jb mq mc md me bi translated"><code class="du lm ln lo ld b">lineItems</code>用户订购的商品或服务。</li><li id="6a5e" class="lw lx hh ig b ih mf il mg ip mh it mi ix mj jb mq mc md me bi translated"><code class="du lm ln lo ld b">otherItems</code>在此示例中，该属性包含小计和税收信息。</li></ul><p id="43b9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在此示例中，用户可以确定交货地址。然而，用户也可以省略它。相反，用户可以说“确认交易”,而不用说“获取交货地址”。如果用户忽略指定递送地址，则<code class="du lm ln lo ld b">conv.data</code>会话对象没有递送地址信息。另一方面，如果信息存在于<code class="du lm ln lo ld b">conv.data</code>中，您可以将交货地址信息包括到订单信息中。以下代码的任务是:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="d59e" class="lh jw hh ld b fi li lj l lk ll">  if (conv.data.deliveryAddress) {<br/>    order.extension = {<br/>      '<a class="ae mo" href="http://twitter.com/type" rel="noopener ugc nofollow" target="_blank">@type</a>': GENERIC_EXTENSION_TYPE,<br/>      'locations': [<br/>        {<br/>          type: 'DELIVERY',<br/>          location: {<br/>            postalAddress: conv.data.deliveryAddress.postalAddress,<br/>          },<br/>        },<br/>      ],<br/>    };<br/>  }</span></pre><p id="adc8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">好了，您得到了完整的订单信息对象。现在您需要询问用户是否确认订单并完成交易。为此，您可以使用<code class="du lm ln lo ld b"><a class="ae mo" href="https://actions-on-google.github.io/actions-on-google-nodejs/classes/conversation_question.transactiondecision.html" rel="noopener ugc nofollow" target="_blank">TransactionDecision</a></code>类。在此示例中，<code class="du lm ln lo ld b">TransactionDecision</code>实例被传递给<code class="du lm ln lo ld b">conv.ask()</code>函数，如下所示:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="31f3" class="lh jw hh ld b fi li lj l lk ll">  // To test payment w/ sample,<br/>  // uncheck the 'Testing in Sandbox Mode' box in the<br/>  // Actions console simulator<br/>  conv.ask(new TransactionDecision({<br/>    orderOptions: {<br/>      requestDeliveryAddress: true,<br/>    },<br/>    paymentOptions: {<br/>      actionProvidedOptions: {<br/>        paymentType: 'PAYMENT_CARD',<br/>        displayName: 'VISA-1234',<br/>      },<br/>    },<br/>    proposedOrder: order,<br/>  }));</span></pre><p id="eb51" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">上面的代码是动作提供的支付方式。也就是说，指定了<code class="du lm ln lo ld b">actionProvidedOptions</code>值。如果支付是不必要的，可以省略<code class="du lm ln lo ld b">paymentOptions</code>的值。另一方面，如果应用程序使用Google提供的支付方式，您需要在示例代码中启用下面的代码，而不是上面的代码:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="122f" class="lh jw hh ld b fi li lj l lk ll">  // If using Google provided payment instrument instead<br/>  conv.ask(new TransactionDecision({<br/>    orderOptions: {<br/>      requestDeliveryAddress: false,<br/>    },<br/>    paymentOptions: {<br/>      googleProvidedOptions: {<br/>        prepaidCardDisallowed: false,<br/>        supportedCardNetworks: ['VISA', 'AMEX'],<br/>        // These will be provided by payment processor,<br/>        // like Stripe, Braintree, or Vantiv.<br/>        tokenizationParameters: {},<br/>      },<br/>    },<br/>    proposedOrder: order,<br/>  }));</span></pre><p id="90a3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这段代码使用了<code class="du lm ln lo ld b">googleProvidedOptions</code>属性，而不是<code class="du lm ln lo ld b">actionProvidedOptions</code>。当然，您必须为您使用的支付处理器指定<code class="du lm ln lo ld b">tokenizationParameters</code>值。</p><p id="46a5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过传递<code class="du lm ln lo ld b">TransactionDesicion</code>实例，名为<code class="du lm ln lo ld b">actions.intent.TRANSACTION_DECISION</code>的事件被返回给Google上的动作。</p><p id="3775" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当Actions on Google接收到<code class="du lm ln lo ld b">actions.intent.TRANSACTION_DECISION</code>事件时，Google Assistant向用户显示订单摘要作为如下的响应消息:</p><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es mm"><img src="../Images/9c137a45fc9931e43ddf399306a85f66.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*Ws6zMyKgrlLFN3GIyyD9Ag.jpeg"/></div></figure><p id="4521" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">而且，</p><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es mm"><img src="../Images/a02f65e0e84b5604c8b8826a2a44a5a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*0otZfPa7_v8qrxZG60fePQ.jpeg"/></div></figure><p id="ccc0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当用户说“下单”时，Google Assistant显示如下图的支付UI:</p><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es mm"><img src="../Images/d135ab4bf546c5437f05778aedf8cbee.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*nPraGdnlsYcnN7l0S9s4ig.jpeg"/></div></figure><p id="e66b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">用户需要输入密码并点击“批准”按钮来决定交易。此时，订单的状态为<code class="du lm ln lo ld b">PENDING</code>。</p><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es mm"><img src="../Images/45744fdf5e9b241f8f050347796329ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*AekiPlVLje2av7YtbEmE2g.jpeg"/></div></figure><h1 id="d1dc" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">当用户同意支付时</h1><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es ne"><img src="../Images/ea4327933db570109d0cad18060e502e.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/format:webp/1*MbAtiqsN9mVGDP0fppNosQ.png"/></div></figure><p id="df28" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果用户同意付款，Google上的Actions会将<code class="du lm ln lo ld b">actions.intent.TRANSACTION_DECISION</code>发送给Dialogflow。在此示例中，事件由名为“transaction_decision_complete”的意图接收。</p><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es nf"><img src="../Images/ea198211bdddc89b0e4930ac945383fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*ubDourz_NDhzmm9nEHUEeg.png"/></div></figure><p id="ab9c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">处理这种意图的处理程序代码如下。首先，您需要检查用户决策。为此，您可以检查<code class="du lm ln lo ld b">conv.arguments.get('TRANSACTION_DECISION_VALUE’)</code>参数的userDecision值。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="1d16" class="lh jw hh ld b fi li lj l lk ll">app.intent('transaction_decision_complete', (conv) =&gt; {<br/>  console.log('Transaction decision complete');<br/>  const arg = conv.arguments.get('TRANSACTION_DECISION_VALUE');<br/>  if (arg &amp;&amp; arg.userDecision ==='ORDER_ACCEPTED') {<br/>    ...</span></pre><p id="43ba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果用户决策值为<code class="du lm ln lo ld b">ORDER_ACCEPTED</code>，这意味着用户接受支付。此时，您需要将订单的状态更新为<code class="du lm ln lo ld b">CREATED</code>。<code class="du lm ln lo ld b"><a class="ae mo" href="https://actions-on-google.github.io/actions-on-google-nodejs/classes/conversation_response.orderupdate.html" rel="noopener ugc nofollow" target="_blank">OrderUpdate</a></code>类用于更新。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="5c2c" class="lh jw hh ld b fi li lj l lk ll">    ...<br/>    const finalOrderId = arg.order.finalOrder.id;</span><span id="146f" class="lh jw hh ld b fi ng lj l lk ll">    // Confirm order and make any charges in order processing backend<br/>    // If using Google provided payment instrument:<br/>    // const paymentDisplayName = arg.order.paymentInfo.displayName;<br/>    conv.ask(new OrderUpdate({<br/>      actionOrderId: finalOrderId,<br/>      orderState: {<br/>        label: 'Order created',<br/>        state: 'CREATED',<br/>      },<br/>      lineItemUpdates: {},<br/>      updateTime: new Date().toISOString(),<br/>      receipt: {<br/>        confirmedActionOrderId: UNIQUE_ORDER_ID,<br/>      },<br/>      // Replace the URL with your own customer service page<br/>      orderManagementActions: [<br/>        {<br/>          button: {<br/>            openUrlAction: {<br/>              url: '<a class="ae mo" href="http://example.com/customer-service'" rel="noopener ugc nofollow" target="_blank">http://example.com/customer-service'</a>,<br/>            },<br/>            title: 'Customer Service',<br/>          },<br/>          type: 'CUSTOMER_SERVICE',<br/>        },<br/>      ],<br/>      userNotification: {<br/>        text: 'Notification text.',<br/>        title: 'Notification Title',<br/>      },<br/>    }));<br/>    ...</span></pre><p id="3ea3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在此示例的上述代码中，设置了以下属性:</p><ul class=""><li id="d95a" class="lw lx hh ig b ih ii il im ip ly it lz ix ma jb mq mc md me bi translated"><code class="du lm ln lo ld b">orderState</code>指定新的状态<code class="du lm ln lo ld b">CREATED</code>。</li><li id="c4c4" class="lw lx hh ig b ih mf il mg ip mh it mi ix mj jb mq mc md me bi translated"><code class="du lm ln lo ld b">receipt</code>指定订单ID以映射收据。</li><li id="a44a" class="lw lx hh ig b ih mf il mg ip mh it mi ix mj jb mq mc md me bi translated"><code class="du lm ln lo ld b">orderManagementActions</code>指定客户支持信息。</li><li id="128a" class="lw lx hh ig b ih mf il mg ip mh it mi ix mj jb mq mc md me bi translated"><code class="du lm ln lo ld b">userNotification</code>通知的文本和标题。</li></ul><p id="93ef" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，您用<code class="du lm ln lo ld b">conv.ask()</code>函数发送响应消息，让用户完成交易。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="ccb8" class="lh jw hh ld b fi li lj l lk ll">    ...<br/>    conv.ask(`Transaction completed! You're all set!`);<br/>  } else if (arg &amp;&amp; arg.userDecision === 'DELIVERY_ADDRESS_UPDATED') {<br/>    conv.ask(new DeliveryAddress({<br/>      addressOptions: {<br/>        reason: 'To know where to send the order',<br/>      },<br/>    }));<br/>  } else {<br/>    conv.close('Transaction failed.');<br/>  }<br/>});</span></pre><p id="d577" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果<code class="du lm ln lo ld b">userDecision</code>值是<code class="du lm ln lo ld b">DELIVERY_ADDRESS_UPDATED</code>，这意味着用户想要更新送货地址。在这种情况下，您需要导航用户使用<code class="du lm ln lo ld b">DeliveryAddress</code>类来确定交付地址，正如我在上一节中描述的那样。</p><p id="c9de" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">执行上述代码后，Google Assistant向用户发送如下响应消息:</p><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es mm"><img src="../Images/3d3b711133fb4e49b92bf82667ef232a.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*EHgp0hS73mKdWMHe8aZq8g.jpeg"/></div></figure><p id="a40e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在谷歌助手的订单历史页面，用户可以看到最新的状态<code class="du lm ln lo ld b">ORDER_CREATED</code>。</p><figure class="ky kz la lb fd lq er es paragraph-image"><div class="er es mm"><img src="../Images/9bb868c877c5d56eb7141543f554aef8.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*Qn1YBtXDXtg8UOoj7YBZ1w.jpeg"/></div></figure><h1 id="7f0d" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">结论</h1><p id="956c" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip kv ir is it kw iv iw ix kx iz ja jb ha bi translated">在这篇文章中，我描述了Google Transactions API上的行为。如果你能通过阅读这篇文章理解架构、流程步骤和每个代码，那就太好了。</p></div></div>    
</body>
</html>