<html>
<head>
<title>One does not simply deploy Kubernetes to the cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">人们不会简单地将Kubernetes部署到云上</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/provisioning-oracle-container-engine-oke-using-terraform-41542fd15d1c?source=collection_archive---------1-----------------------#2019-04-04">https://medium.com/oracledevs/provisioning-oracle-container-engine-oke-using-terraform-41542fd15d1c?source=collection_archive---------1-----------------------#2019-04-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/bde54329885f8e2a6d814acb2c75e49a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0SXbXpFk4oywlw0-BrrzAQ.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Boromir</figcaption></figure><p id="f1e3" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">手动创建Oracle容器引擎(OKE)集群可能是一项耗时的任务。至少，您需要创建以下内容:</p><ul class=""><li id="d873" class="jr js hh iv b iw ix ja jb je jt ji ju jm jv jq jw jx jy jz bi translated">一个VCN，一个互联网网关，一个NAT网关，如果你想一个私有工作者节点部署</li><li id="44fa" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">具有一组安全规则的工作子网</li><li id="de40" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">负载平衡器子网及其安全规则</li></ul><p id="9a76" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">所有这些都有很好的记录<a class="ae kf" href="https://docs.cloud.oracle.com/iaas/Content/ContEng/Concepts/contengnetworkconfigexample.htm" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="d64c" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">假设您已经正确完成了所有工作，现在您可以创建一个集群和节点池了。</p><p id="d1d2" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">如果您很快需要一个集群，比如说一个实验或演示，您还可以使用OCI控制台中的快速创建选项。但是当你可以实际编码的时候，为什么要手工做呢？</p><h2 id="beb6" class="kg kh hh bd ki kj kk kl km kn ko kp kq je kr ks kt ji ku kv kw jm kx ky kz la bi translated">terraform-oci-oke简介</h2><p id="233b" class="pw-post-body-paragraph it iu hh iv b iw lb iy iz ja lc jc jd je ld jg jh ji le jk jl jm lf jo jp jq ha bi translated">我们最近在github上发布了<a class="ae kf" href="https://github.com/oracle-terraform-modules/terraform-oci-oke" rel="noopener ugc nofollow" target="_blank">terraform-OCI-oke</a>s̶a̶m̶p̶l̶e̶-̶o̶k̶e̶-̶f̶o̶r̶-̶t̶e̶r̶r̶a̶f̶o̶r̶m̶(i̶'̶l̶l̶̶t̶r̶y̶̶t̶o̶̶m̶a̶k̶e̶̶i̶t̶̶l̶e̶s̶s̶̶a̶̶m̶o̶u̶t̶h̶f̶u̶l̶̶i̶n̶̶t̶h̶e̶̶f̶u̶t̶u̶r̶e̶完成)，它使用terra form和Terraform OCI provider来自动化oke部署。</p><p id="1421" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">一些功能包括以下内容:</p><ul class=""><li id="8ada" class="jr js hh iv b iw ix ja jb je jt ji ju jm jv jq jw jx jy jz bi translated">提供所有基本要求，如VCN、网关、子网、安全列表等</li><li id="ae50" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">您的工作子网和负载平衡器子网的可配置网络设置</li><li id="9e52" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">安装并配置了git、oci-cli、kubectl和helm的堡垒的可选配置</li><li id="e279" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">选择在私有或公共模式下运行工作节点</li><li id="dab3" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">可配置的节点池数量、节点池大小、工作节点形状和拓扑</li><li id="5a3a" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">可选插件，如kubernetes仪表板、网络策略calico、helm</li><li id="a20a" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">可选的<a class="ae kf" href="https://docs.cloud.oracle.com/iaas/Content/Identity/Tasks/managingcredentials.htm" rel="noopener ugc nofollow" target="_blank">创建认证令牌</a>，用于创建Kubernetes秘密。然后，您可以使用这个秘密作为imagePullSecrets，这样OKE worker节点就可以从私有的<a class="ae kf" href="https://docs.cloud.oracle.com/iaas/Content/Registry/Concepts/registryoverview.htm" rel="noopener ugc nofollow" target="_blank"> OCIR </a>存储库中提取图像。</li></ul><p id="336a" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">让我们兜一圈。下面是一个你可以用<a class="ae kf" href="https://github.com/oracle-terraform-modules/terraform-oci-oke" rel="noopener ugc nofollow" target="_blank"> terraform-oci-oke </a>脚本创建的例子。</p><figure class="lh li lj lk fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lg"><img src="../Images/6c9f9bcfd512f6cfae42619ebe8c7dc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UuWMqilu6BgndnsECpK6gA.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">OKE Cluster with Bastion</figcaption></figure><p id="645d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">我将假设您(a)已经为terraform配置了您的OCI帐户(b) <a class="ae kf" href="https://docs.cloud.oracle.com/iaas/Content/ContEng/Concepts/contengpolicyconfig.htm" rel="noopener ugc nofollow" target="_blank">创建了用于创建OKE集群的策略</a>。如果没有，先按照这里<a class="ae kf" href="https://github.com/oracle/sample-oke-for-terraform/blob/master/docs/instructions.md" rel="noopener ugc nofollow" target="_blank">的指示</a>。</p><p id="280e" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">首先，克隆回购:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="f96e" class="kg kh hh lm b fi lq lr l ls lt">git clone <a class="ae kf" href="https://github.com/oracle-terraform-modules/terraform-oci-oke.git" rel="noopener ugc nofollow" target="_blank">https://github.com/oracle-terraform-modules/terraform-oci-oke.git</a> tfoke<br/>cd tfoke</span></pre><p id="00c1" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">将terraform.tfvars.example复制到terraform.tfvars并编辑terraform.tfvars:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="bf1b" class="kg kh hh lm b fi lq lr l ls lt">cp terraform.tfvars.example terraform.tfvars</span></pre><p id="64f5" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">输入以下信息:</p><ul class=""><li id="103b" class="jr js hh iv b iw ix ja jb je jt ji ju jm jv jq jw jx jy jz bi translated">api _指纹</li><li id="8888" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">api_private_key_path</li><li id="e971" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">隔离舱名称</li><li id="349f" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">隔离舱_ocid</li><li id="06b6" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">租赁_ocid</li><li id="05c8" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">user_ocid</li><li id="06cd" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">ssh _私有_密钥_路径</li><li id="8799" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">ssh公共密钥路径</li></ul><p id="231f" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">如果您想要创建身份验证令牌和Kubernetes秘密，您还需要提供以下内容:</p><ul class=""><li id="54f4" class="jr js hh iv b iw ix ja jb je jt ji ju jm jv jq jw jx jy jz bi translated">电子邮件地址</li><li id="b238" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">租赁_名称</li><li id="01f1" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">用户名</li></ul><p id="cb2c" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">所有的地形选项都有完整的文档<a class="ae kf" href="https://github.com/oracle/sample-oke-for-terraform/blob/master/docs/terraformoptions.md" rel="noopener ugc nofollow" target="_blank">在这里</a>。</p><p id="3a15" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">您现在可以运行terraform计划并应用:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="ebb6" class="kg kh hh lm b fi lq lr l ls lt">terraform plan<br/>terraform apply -auto-approve</span></pre><p id="6c04" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">默认情况下，将为您创建一个包含3个工作节点的群集，除非您更改了node_pools和node_pool_quantity_per_subnet参数。</p><p id="7fd4" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">完成后，terraform将为您打印以下内容:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="f2fc" class="kg kh hh lm b fi lq lr l ls lt">bastion_public_ips = XXX.XXX.XXX.XXX<br/>kubeconfig = export KUBECONFIG=generated/kubeconfig<br/>ocirtoken = sensitive<br/>ssh_to_bastion = ssh -i ~/.ssh/id_rsa opc@XXX.XXX.XXX</span></pre><p id="6e7c" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">kubeconfig文件也将在生成的目录下创建，这样您就可以设置您的KUBECONFIG环境变量并开始使用kubectl:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="90dc" class="kg kh hh lm b fi lq lr l ls lt">export KUBECONFIG=generated/kubeconfig</span></pre><p id="361d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">并验证您可以与群集交互:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="e55c" class="kg kh hh lm b fi lq lr l ls lt">kubectl get nodes<br/>NAME        STATUS   ROLES   AGE   VERSION                                                                                                                                  <br/>10.0.13.2   Ready    node    20h   v1.12.6                                                                                                                                  <br/>10.0.23.2   Ready    node    20h   v1.12.6                                                                                                                                  <br/>10.0.33.2   Ready    node    20h   v1.12.6</span></pre><p id="9fc5" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">访问仪表板:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="44dc" class="kg kh hh lm b fi lq lr l ls lt">demo/dashboard.sh<br/>Access K8s Dashboard: <a class="ae kf" href="http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/" rel="noopener ugc nofollow" target="_blank">http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</a></span></pre><p id="931d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">打开浏览器并访问仪表板:<a class="ae kf" href="http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/" rel="noopener ugc nofollow" target="_blank">http://localhost:8001/API/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</a>并使用生成的文件夹中的kubeconfig登录。</p><h2 id="ca6f" class="kg kh hh bd ki kj kk kl km kn ko kp kq je kr ks kt ji ku kv kw jm kx ky kz la bi translated">使用堡垒</h2><p id="1eb9" class="pw-post-body-paragraph it iu hh iv b iw lb iy iz ja lc jc jd je ld jg jh ji le jk jl jm lf jo jp jq ha bi translated">bastion安装了oci-cli和helm，并且具有kubectl和helm自动完成功能。只需登录并开始与您的集群交互:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="8bcf" class="kg kh hh lm b fi lq lr l ls lt">ssh -i ~/.ssh/id_rsa opc@XXX.XXX.XXX</span><span id="83f3" class="kg kh hh lm b fi lu lr l ls lt">kubectl get nodes<br/>NAME        STATUS   ROLES   AGE   VERSION                                                                                                                                  <br/>10.0.13.2   Ready    node    20h   v1.12.7                                                                                                                                  <br/>10.0.23.2   Ready    node    20h   v1.12.7                                                                                                                                  <br/>10.0.33.2   Ready    node    20h   v1.12.7</span></pre><p id="43fa" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">你可以随时打开/关闭堡垒。</p><h2 id="dc44" class="kg kh hh bd ki kj kk kl km kn ko kp kq je kr ks kt ji ku kv kw jm kx ky kz la bi translated">重用、插件和社区</h2><p id="0e60" class="pw-post-body-paragraph it iu hh iv b iw lb iy iz ja lc jc jd je ld jg jh ji le jk jl jm lf jo jp jq ha bi translated">该项目还被设计为可重用的，这意味着您可以克隆和添加您自己的私人定制。</p><p id="e40d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在接下来的几个月中，我们还希望为该项目添加一些插件，以自动将其他软件部署到集群中，我们希望通过社区努力来实现这一点。我们正在考虑的一些插件包括:</p><ul class=""><li id="5cc2" class="jr js hh iv b iw ix ja jb je jt ji ju jm jv jq jw jx jy jz bi translated">伊斯迪奥</li><li id="5ff6" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">MySQL运算符</li><li id="85e0" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">API网关，如大使和孔</li><li id="5dcb" class="jr js hh iv b iw ka ja kb je kc ji kd jm ke jq jw jx jy jz bi translated">WebLogic运算符</li></ul><p id="4ea3" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">你可以在这里看到完整的名单<a class="ae kf" href="https://github.com/oracle-terraform-modules/terraform-oci-oke/tree/master/modules/addons" rel="noopener ugc nofollow" target="_blank"/>。当然，如果你有一个插件的想法，我们很乐意听到你的意见。或者更好的方法是，向我们发送拉取请求。</p></div></div>    
</body>
</html>