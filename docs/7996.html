<html>
<head>
<title>A Relook at the TerraLoader Dropper DLL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">重新审视TerraLoader Dropper DLL</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/a-re-look-at-the-terraloader-dropper-dll-e5947ad6e244?source=collection_archive---------0-----------------------#2021-04-09">https://medium.com/walmartglobaltech/a-re-look-at-the-terraloader-dropper-dll-e5947ad6e244?source=collection_archive---------0-----------------------#2021-04-09</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/e82f7f75915ee44f445be5857ebec4e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PDGx51MCBNFVa5Pj7QHDZg.png"/></div></div></figure><p id="46e7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">对TerraLoader负责的恶意软件作者，在参与者和客户之间的分歧发生在地下论坛市场后，被认为是BadBullzVenom[4]，似乎一直在愉快地更新他们的交付系统，再次被称为TerraLoader。Twitter用户@Arkbird_SOLG [1，5]使用@malz_intel发现的样本在网上发布了一份出色的报告。该报告做得很好，所以这主要是我在分析了报告[2]中的上述示例后的逆向工程笔记的附录，其中我主要关注将构建和交付通常称为“more_eggs”的javascript后门的DLL。</p><h1 id="1e74" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">初始概述</h1><p id="8ee2" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">这只是对DLL部分的一个快速概述，正如前面提到的，它已经包含在以前的研究中[1]。</p><p id="e7ce" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Scriptlet:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="a107" class="kz jo hh kv b fi la lb l lc ld">MD5:    f93fdcf5856feb254a26547dc8c2b671<br/>SHA1:   1c038a86b337cf72663da5b6780d34ba0fb1c0c9<br/>SHA256:  000a5e63109b3c653d63d84d03fe474242b987bfadda9aeaa200653fd2155a31</span></pre><p id="c23e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Scriptlet解码出一个doc文件和一个DLL，DOC文件看起来会分散DLL加载的注意力。</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="266c" class="kz jo hh kv b fi la lb l lc ld">Doc: 11e54f594949a4c7f13e85b4ac2cbd555200ac34e6d61b58a71fbcfccc0497cd<br/>DLL: fb55b26b8edee2431b35d0e28df5f223510a15344ede400a2f5c04a0d45e6b77</span></pre><h1 id="315d" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">字符串编码更新</h1><p id="2d56" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">字符串编码现在有点不同，dropper DLL部分总是利用简单的基于XOR的例程来生成自己的字符串编码密钥，同时还利用各种辅助例程来使用找到的密钥(XOR、AES、RC4)。作者已经开始使用RC4来破坏字符串编码键，这使得整个过程需要更长的时间，但也有作为睡眠程序的额外好处。</p><p id="4832" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">该示例获取三段数据:加密数据、起始RC4密钥字符串和将被解密以检查是否找到正确密钥的数据。</p><p id="e68a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">加密数据:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="c57f" class="kz jo hh kv b fi la lb l lc ld">b8e0ce81bcd3023bf5e2b37d3e1c801d99bd3f7f408c87b7923673d7840797a024f78d62552de17aba3d10c4</span></pre><p id="7578" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">启动RC4键:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="260c" class="kz jo hh kv b fi la lb l lc ld">SouXRE</span></pre><p id="cd8c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">解密数据:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="a0d1" class="kz jo hh kv b fi la lb l lc ld">b92fe2de81d94d05b0431c545221cfbc23ad2f47a9279a20498948b9d4b3ffdf4b22669a1eace7a3b14862d2</span></pre><p id="6da0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">粗化例程的工作原理是简单地使用一个从0开始的迭代器，将整数值转换为一个字符串，将其附加到起始密钥，解密加密的数据，并检查输出是否与解密的数据匹配。如果不匹配，迭代器递增，过程重新开始，直到找到匹配。</p><p id="2603" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你了解加密算法是如何工作的，那么从静态逆向工程的角度来看，你可以看到其中的一个缺陷，我们实际上可以恢复足够的密钥流数据来解码板上的大多数字符串，而不需要暴力破解密钥。</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="d7ad" class="kz jo hh kv b fi la lb l lc ld">encoded_data ^ decoded_data = partial RC4 XOR Keystream</span></pre><p id="edf6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">利用这一知识，我们可以恢复RC4异或密钥流的一部分:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="5372" class="kz jo hh kv b fi la lb l lc ld">01cf2c5f3d0a4f3e45a1af296c3d4fa1ba101038e9ab1d97dbbf3b6e50b4687f6fd5ebf84b8106d90b757216</span></pre><p id="d243" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">使用这些数据，我们可以从样本中解码出大部分字符串，这些字符串都与之前列出的字符串一致，恶意软件基本上是为了构建more_eggs后门程序，以便放入磁盘并引爆。</p><p id="99d5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">供参考的部分字符串:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="2cb9" class="kz jo hh kv b fi la lb l lc ld">%APPDATA%<br/>/B /e:jsCript<br/>msxsl.exe<br/>CED1712A510453BEE1F83F8AE7<br/>a2service.exe<br/>schtasks.exe<br/> /Create /TN<br/>UserInitMprLogonScript<br/>PROCESSOR_IDENTIFIER<br/>.ComputerName +<br/>COMPUTERNAME<br/>FLAREVM<br/>USERNAME<br/>Notepad</span></pre><h1 id="a2c8" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">数据编码更新</h1><p id="f87e" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">正如前面提到的博客作者所提到的，这种新的后门实际上是通过在密钥中添加基于计算机的信息进行编码而被丢弃的，这使得恢复后门更加困难，除非您知道它被丢弃的系统的计算机名称和处理器信息。</p><p id="5e91" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们可以在上面显示“PROCESSOR_IDENTIFIER”和“COMPUTERNAME”的部分字符串中看到这一点的证据。“ComputerName +”，后门上的部分包装程序将使用它来解码后门。如果放弃者DLL负责这段代码，那么后门程序一定存在于DLL的某个地方:</p><figure class="kq kr ks kt fd ii er es paragraph-image"><div class="er es le"><img src="../Images/4dc4cfddc4e393f530aac5fe27389cb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/1*xl3fCa8ZesOQ4fjbea-pig.png"/></div></figure><p id="8cf3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在上面的屏幕截图中，我们可以看到一个大的数据块已经计算了大小，分配了内存，复制到新的内存中，然后字符串“CED1712A510453BEE1F83F8AE7”被解密。紧接着，调用RC4例程:</p><figure class="kq kr ks kt fd ii er es paragraph-image"><div class="er es lf"><img src="../Images/ccaca509a995fe2dbd2cadda9c8afc32.png" data-original-src="https://miro.medium.com/v2/resize:fit:754/format:webp/1*HjdtzApq1oPO9jWX3EO78A.png"/></div></figure><p id="3e7b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在调用了RC4(因为这张照片是我在绘制样本时拍摄的，所以被标记为“RC4 _也许”)之后，调用了一个板载DEFLATE例程。让我们看看解码的是什么:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="4cd0" class="kz jo hh kv b fi la lb l lc ld">&gt;&gt;&gt; key = 'CED1712A510453BEE1F83F8AE7'<br/>&gt;&gt;&gt; from Crypto.Cipher import ARC4<br/>&gt;&gt;&gt; rc4 = ARC4.new(key)<br/>&gt;&gt;&gt; t = rc4.decrypt(data)<br/>&gt;&gt;&gt; import zlib<br/>&gt;&gt;&gt; t[:50]<br/>'\xed}kw#7\xae\xe0g\xe7\x9c\xfc\x87\x8a\xee\x9d\xb44\xed\x96\xeb\xa1g\x94\xce\xac^N\xf7\xa6\x1f\xbe\xb6;\x99\x99v\x8fW\x96\xcav\xa5\xa5*\xa5T\xb6\xe5v'<br/>&gt;&gt;&gt; t2 = zlib.decompress(t,-15)<br/>&gt;&gt;&gt; t2[:100]<br/>'var BV = "6.6b";\r\nvar Gate = "https://d27qdop2sa027t.cloudfront.net/spmar/d9264";\r\nvar hit_each = 10'</span></pre><p id="1d14" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在示例的后面，我们还可以恢复MSXSL EXE文件的解码:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="b0fa" class="kz jo hh kv b fi la lb l lc ld">&gt;&gt;&gt; key = 'CED1712A510453BEE1F83F8AE7'<br/>&gt;&gt;&gt; from Crypto.Cipher import ARC4<br/>&gt;&gt;&gt; rc4 = ARC4.new(key)<br/>&gt;&gt;&gt; t = rc4.decrypt(data1)<br/>&gt;&gt;&gt; import zlib<br/>&gt;&gt;&gt; t2 = zlib.decompress(t,-15)<br/>&gt;&gt;&gt; t2[:100]<br/>'MZ\x90\x00\x03\x00\x00\x00\x04\x00\x00\x00\xff\xff\x00\x00\xb8\x00\x00\x00\x00\x00\x00\x00@\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xd8\x00\x00\x00\x0e\x1f\xba\x0e\x00\xb4\t\xcd!\xb8\x01L\xcd!This program cannot be'</span></pre><p id="80c4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">也是用于任务调度的XML的一部分:</p><pre class="kq kr ks kt fd ku kv kw kx aw ky bi"><span id="53aa" class="kz jo hh kv b fi la lb l lc ld">&lt;?xml version="1.0" encoding="UTF-16"?&gt;<br/>&lt;Task version="1.2" ae lg" href="http://schemas.microsoft.com/windows/2004/02/mit/task" rel="noopener ugc nofollow" target="_blank"&gt;http://schemas.microsoft.com/windows/2004/02/mit/task"&gt;<br/>  &lt;RegistrationInfo&gt;<br/>    &lt;Author&gt;SYSTEM&lt;/Author&gt;<br/>  &lt;/RegistrationInfo&gt;<br/>  &lt;Triggers&gt;<br/>    &lt;BootTrigger&gt;<br/>      &lt;Enabled&gt;true&lt;/Enabled&gt;<br/>    &lt;/BootTrigger&gt;<br/>  &lt;/Triggers&gt;<br/>  &lt;Principals&gt;<br/>    &lt;Principal id="Author"&gt;<br/>      &lt;UserId&gt;S-1-5-18&lt;/UserId&gt;<br/>      &lt;RunLevel&gt;HighestAvailable&lt;/RunLevel&gt;<br/>    &lt;/Principal&gt;<br/>  &lt;/Principals&gt;<br/>  &lt;Settings&gt;<br/>    &lt;MultipleInstancesPolicy&gt;IgnoreNew&lt;/MultipleInstancesPolicy&gt;<br/>    &lt;DisallowStartIfOnBatteries&gt;false&lt;/DisallowStartIfOnBatteries&gt;<br/>    &lt;StopIfGoingOnBatteries&gt;false&lt;/StopIfGoingOnBatteries&gt;<br/>    &lt;AllowHardTerminate&gt;true&lt;/AllowHardTerminate&gt;<br/>    &lt;StartWhenAvailable&gt;true&lt;/StartWhenAvailable&gt;<br/>    &lt;RunOnlyIfNetworkAvailable&gt;false&lt;/RunOnlyIfNetworkAvailable&gt;<br/>    &lt;IdleSettings&gt;<br/>      &lt;StopOnIdleEnd&gt;false&lt;/StopOnIdleEnd&gt;<br/>      &lt;RestartOnIdle&gt;false&lt;/RestartOnIdle&gt;<br/>    &lt;/IdleSettings&gt;<br/>    &lt;AllowStartOnDemand&gt;true&lt;/AllowStartOnDemand&gt;<br/>    &lt;Enabled&gt;true&lt;/Enabled&gt;<br/>    &lt;Hidden&gt;false&lt;/Hidden&gt;<br/>    &lt;RunOnlyIfIdle&gt;false&lt;/RunOnlyIfIdle&gt;<br/>    &lt;WakeToRun&gt;true&lt;/WakeToRun&gt;<br/>    &lt;ExecutionTimeLimit&gt;PT0S&lt;/ExecutionTimeLimit&gt;<br/>    &lt;Priority&gt;7&lt;/Priority&gt;<br/>  &lt;/Settings&gt;<br/>  &lt;Actions Context="Author"&gt;<br/>    &lt;Exec&gt;<br/>      &lt;Command&gt;cscripT&lt;/Command&gt;<br/>   &lt;Arguments&gt;</span></pre><p id="8537" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">其中一个字符串也很突出，因为我不记得在“FLAREVM”之前在这些样本中见过它。FlareVM是FireEye发布的一个恶意软件分析创建系统，它允许快速创建一个用于恶意软件分析的虚拟机[3]，并且下载程序似乎正在检查计算机名称是否为FLAREVM:</p><figure class="kq kr ks kt fd ii er es paragraph-image"><div class="er es lh"><img src="../Images/a6a04b05b0fb0e6f8b8b2d4a0ed9decf.png" data-original-src="https://miro.medium.com/v2/resize:fit:820/format:webp/1*wicpWlSIwQPhMZTm0qFaGg.png"/></div></figure><p id="1202" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我还没有验证样本是否会感染失败，因为我仍然在静态映射更新的样本的过程中，但这个检查功能确实会在后门被解码之前发生:</p><figure class="kq kr ks kt fd ii er es paragraph-image"><div class="er es li"><img src="../Images/1ff078c32b37abc0a1fbdd66cde2687e.png" data-original-src="https://miro.medium.com/v2/resize:fit:502/format:webp/1*uQJJmhYL8diQLkblUmGkuw.png"/></div></figure><p id="cc44" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">参考</p><ol class=""><li id="75ba" class="lj lk hh ir b is it iw ix ja ll je lm ji ln jm lo lp lq lr bi translated"><a class="ae lg" href="https://twitter.com/Arkbird_SOLG/status/1375945806474317831" rel="noopener ugc nofollow" target="_blank">https://twitter.com/Arkbird_SOLG/status/1375945806474317831</a></li><li id="d5d2" class="lj lk hh ir b is ls iw lt ja lu je lv ji lw jm lo lp lq lr bi translated"><a class="ae lg" href="https://app.any.run/tasks/b1d3a533-912b-4fe9-86cc-69d4bda40453/" rel="noopener ugc nofollow" target="_blank">https://app . any . run/tasks/b1d3a 533-912 b-4fe 9-86cc-69 D4 BDA 40453/</a></li><li id="881a" class="lj lk hh ir b is ls iw lt ja lu je lv ji lw jm lo lp lq lr bi translated"><a class="ae lg" href="https://www.fireeye.com/blog/threat-research/2017/07/flare-vm-the-windows-malware.html" rel="noopener ugc nofollow" target="_blank">https://www . fire eye . com/blog/threat-research/2017/07/flare-VM-the-windows-malware . html</a></li><li id="8fce" class="lj lk hh ir b is ls iw lt ja lu je lv ji lw jm lo lp lq lr bi translated"><a class="ae lg" href="https://malpedia.caad.fkie.fraunhofer.de/actor/venom_spider" rel="noopener ugc nofollow" target="_blank">https://malpedia.caad.fkie.fraunhofer.de/actor/venom_spider</a></li><li id="f039" class="lj lk hh ir b is ls iw lt ja lu je lv ji lw jm lo lp lq lr bi translated"><a class="ae lg" href="https://github.com/StrangerealIntel/CyberThreatIntel/blob/master/Additional%20Analysis/Terraloader/2021-03-25/Analysis.md" rel="noopener ugc nofollow" target="_blank">https://github . com/strange realintel/CyberThreatIntel/blob/master/Additional % 20 analysis/terra loader/2021-03-25/analysis . MD</a></li></ol></div></div>    
</body>
</html>