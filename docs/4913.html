<html>
<head>
<title>Unit Testing Firebase with Kotlin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kotlin对Firebase进行单元测试</h1>
<blockquote>原文：<a href="https://blog.kotlin-academy.com/unit-testing-firebase-with-kotlin-85ae7205d3ef?source=collection_archive---------0-----------------------#2020-05-28">https://blog.kotlin-academy.com/unit-testing-firebase-with-kotlin-85ae7205d3ef?source=collection_archive---------0-----------------------#2020-05-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/df200881bee02d81c08ec48bc507e9ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zXX8o8hZLmmS_AHYIff3Wg.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@louis993546?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Louis Tsai</a> on <a class="ae kc" href="https://unsplash.com/s/photos/kotlin?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="0c4b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现代移动编程实践，以及更广泛的编程实践，非常强调测试驱动的开发。如果你想用Kotlin开发一个Android应用程序，最好记住TDD，因为它允许你的应用程序被分解成可分离的可测试组件——使得开发测试更容易，发现应用程序中的错误更容易。</p><p id="0f8c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果应用程序要有任何形式的CRUD功能，后端的一个好选择是Firebase。Firebase具有与Android Studio的本机集成，如果您没有后端经验，它非常容易设置，这使它成为初学者和有经验的程序员的绝佳选择。</p><p id="1b8f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">考虑到TDD，您可能想要测试使用Firebase的方法，以确保一切正常工作。</p><p id="840f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Firebase测试的常见解决方案是使用非生产数据库，并对该数据库执行实际的读写操作，以确保一切正常(<a class="ae kc" href="https://firebase.google.com/docs/projects/multiprojects" rel="noopener ugc nofollow" target="_blank"> Firebase文档</a>)。</p><p id="76ba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过这种方法，您可以像平常一样使用Firebase只是在一个不同的数据库上，以确保您不会在生产中搞砸任何事情。</p><p id="41c3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是如果您不想使用非生产数据库呢？要么您是一个不想维护两个数据库的开发人员，要么您大部分时间都无法访问互联网？</p><p id="5a6c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这篇博客中，我将向您展示如何使用<code class="fe lb lc ld le b">Mockito</code>来模拟不同的Firebase函数并执行本地单元测试。</p><h1 id="e627" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">设置</h1><p id="4ebd" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我将使用一个示例场景展示如何模拟Firebase。假设您有一个带有登录功能的CRUD应用程序。围绕Firebase有一个名为<code class="fe lb lc ld le b">LogInModel</code>的包装器类(在以后修改后端时的最佳实践)。</p><p id="6394" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">LogInModel</code>有一个我们想要测试的函数<code class="fe lb lc ld le b">LogIn(email, password)</code>。<code class="fe lb lc ld le b">LogIn</code>只是使用方法<code class="fe lb lc ld le b">signInWithEmailAndPassword</code>调用Firebase类<code class="fe lb lc ld le b">FirebaseAuth</code>。下面是<code class="fe lb lc ld le b">LogInModel</code>中的<code class="fe lb lc ld le b">LogIn</code>方法的基本情况:</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="f3ca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在上面的代码片段中，您可能会注意到<code class="fe lb lc ld le b">observer</code>对象。<code class="fe lb lc ld le b">observer</code>是我将在下面定义的<code class="fe lb lc ld le b">LogInListener</code>类型。</p><p id="ca1a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">LogInListener</code>是一个简单的<code class="fe lb lc ld le b">interface</code>，其他类可以遵循它来知道登录是成功还是失败。<code class="fe lb lc ld le b">LogInListener</code>简单来说就是这样定义的:</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="21a0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我们正在尝试用我们的单元测试来确保<code class="fe lb lc ld le b">logIn</code>做它应该做的事情——用Firebase登录用户。对于这个例子，很明显，它做了它应该做的事情，因为代码很短，但是在大型项目中，测试是必要的。</p><h1 id="8774" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">测试</h1><p id="5722" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">我们准备做一个名为<code class="fe lb lc ld le b">LogInModelTest</code>的单元测试(在Android Studio中称为“<em class="mo">测试</em>”)。我们的测试类将使用<code class="fe lb lc ld le b">Mockito</code>来模拟我们用来测试类功能的firebase对象。</p><p id="957f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将一节一节地分解<code class="fe lb lc ld le b">LogInModelTest</code>,这样我就可以详细了解这个类是如何构造的。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="1fc9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我们测试文件的开始。</p><p id="fd1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在第一行中，您会注意到我们的测试实现了<code class="fe lb lc ld le b">LogInListener</code>——这使得获得我们正在测试的<code class="fe lb lc ld le b">logIn</code>方法的结果变得很容易。因为我们在文件的末尾有那个<code class="fe lb lc ld le b">implements</code>，你会注意到我有来自<code class="fe lb lc ld le b">LogInListener</code>接口的方法。</p><p id="90d0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们有了<code class="fe lb lc ld le b">@Mock private val mAuth: FirebaseAuth</code>，它是我们正在模仿的Firebase对象。</p><p id="5a58" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe lb lc ld le b">LogInModel</code>是我们将要进行单元测试的对象。</p><p id="d760" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您看到的两个<code class="fe lb lc ld le b">Task</code>将覆盖Firebase登录的结果。它允许我们测试失败的登录和成功的登录。</p><p id="5807" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">三个<code class="fe lb lc ld le b">private const val</code>用于更新<code class="fe lb lc ld le b">LogInListener</code>调用的结果。你可以用一个枚举来代替它，这是最好的做法，但是为了弄清楚我要做什么，我把它们作为单独的变量。它们与<code class="fe lb lc ld le b">logInResult</code>一起使用。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="2eb7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是我们的<code class="fe lb lc ld le b">@Before</code>设置方法。</p><p id="617a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">简单地设置我们的模拟对象。</p><p id="1b1e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里我定义了<code class="fe lb lc ld le b">successTask</code>和<code class="fe lb lc ld le b">failureTask</code>。现在<a class="ae kc" href="https://firebase.google.com/docs/reference/android/io/fabric/sdk/android/fabric/services/concurrency/Task" rel="noopener ugc nofollow" target="_blank">任务</a>是一个接口，因此我定义了这么多函数(“…”包含更多函数)。我在这里只强调重要的。</p><p id="ce3d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在方法的最后，我们简单地初始化其余的变量。</p><p id="9d41" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在谈谈测试方法！</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="e45b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们正在测试成功登录。</p><p id="b819" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们首先设置我们的电子邮件/密码组合。</p><p id="22f9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们使用<code class="fe lb lc ld le b">Mockito.when</code>来确保当我们调用我们的<code class="fe lb lc ld le b">FirebaseAuth</code>对象时，我们将返回<code class="fe lb lc ld le b">successTask</code>(一个表示登录成功的任务)并且不会得到一个空指针异常或其他意外行为。</p><p id="ee7f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们在被测试的类上调用<code class="fe lb lc ld le b">logIn</code>，然后断言我们的登录尝试成功了。<code class="fe lb lc ld le b">logInResult</code>是由我之前提到的界面设置的。</p><p id="5e14" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您想测试失败，只需检查调用是否导致了失败，并使用<code class="fe lb lc ld le b">failureTesk</code>和<code class="fe lb lc ld le b">Mockito.when</code>调用。下面是这样做的一个例子:</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="9aa0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我们继续学习类中最后剩下的代码——接口方法！</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="378f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里，如果登录尝试成功，我们简单地设置<code class="fe lb lc ld le b">logInResult = SUCCESS</code>，否则我们将其设置为<code class="fe lb lc ld le b">FAILURE</code>。这使得上面的assert语句可以工作。</p><p id="8cac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样！虽然它肯定比使用一个单独的非生产数据库多一点代码，但它肯定可以在不需要额外数据库的情况下对Firebase进行单元测试。如果你把代码分成更小的块，你会发现没有一个是特别复杂的。祝测试好运！</p><p id="d8f4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了便于参考，下面是一个片段中的整个类:</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="b3d8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你做到了这一步，这里有一个🎁作为我感激的象征！</p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h1 id="8911" class="lf lg iq bd lh li mw lk ll lm mx lo lp lq my ls lt lu mz lw lx ly na ma mb mc bi translated">单击👏说“谢谢！”并帮助他人找到这篇文章。</h1><p id="f5cf" class="pw-post-body-paragraph kd ke iq kf b kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw mh ky kz la ij bi translated">了解卡帕头最新的重大新闻。Academy，<a class="ae kc" href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a" rel="noopener ugc nofollow" target="_blank">订阅时事通讯</a>，<a class="ae kc" href="https://twitter.com/ktdotacademy" rel="noopener ugc nofollow" target="_blank">观察Twitter </a>并在medium上关注我们。</p><p id="4639" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您需要Kotlin工作室，请查看我们如何帮助您:<a class="ae kc" href="https://kt.academy/" rel="noopener ugc nofollow" target="_blank"> kt.academy </a>。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><a href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a"><div class="gh gi nb"><img src="../Images/935962ffca48419fed5580c8073bffe5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vvZJkPaTLffG4PC_GePHqQ.png"/></div></a></figure></div></div>    
</body>
</html>