<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://medium.com/oracledevs/unifiedmap-how-it-works-48af0b80cb37?source=collection_archive---------0-----------------------#2017-11-05">https://medium.com/oracledevs/unifiedmap-how-it-works-48af0b80cb37?source=collection_archive---------0-----------------------#2017-11-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><p id="1521" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">UnifiedMap:它是如何工作的？</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es if"><img src="../Images/11cf3c206473981e91cdaff8d2264749.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bh4KolrG0MLQhpM7c70T4g.jpeg"/></div></div></figure><p id="ec7a" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated"><a class="ae ir" href="https://github.com/eclipse/eclipse-collections" rel="noopener ugc nofollow" target="_blank"> Eclipse集合</a>自带了自己的<a class="ae ir" href="https://www.eclipse.org/collections/javadoc/9.0.0/org/eclipse/collections/impl/list/mutable/FastList.html" rel="noopener ugc nofollow" target="_blank">列表</a>、<a class="ae ir" href="https://www.eclipse.org/collections/javadoc/9.0.0/org/eclipse/collections/impl/set/mutable/UnifiedSet.html" rel="noopener ugc nofollow" target="_blank">集合</a>和<a class="ae ir" href="https://www.eclipse.org/collections/javadoc/9.0.0/org/eclipse/collections/impl/map/mutable/UnifiedMap.html" rel="noopener ugc nofollow" target="_blank">映射</a>的实现。它还有额外的数据结构，如<a class="ae ir" href="https://www.eclipse.org/collections/javadoc/9.0.0/org/eclipse/collections/api/multimap/Multimap.html" rel="noopener ugc nofollow" target="_blank"> Multimap </a>、<a class="ae ir" href="https://www.eclipse.org/collections/javadoc/9.0.0/org/eclipse/collections/api/bag/Bag.html" rel="noopener ugc nofollow" target="_blank"> Bag </a>和一个完整的原始集合层次结构。在这篇博客中，我们将看看UnifiedMap的内幕。</p><p id="85dc" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated"><strong class="hi ie">统一地图</strong></p><p id="62fb" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">UnifiedMap是Eclipse集合的Map实现，它的实现与JDK散列表非常不同。</p><p id="4325" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">java.util.HashMap由一个条目对象表支持。HashMap中的条目实现有<code class="du is it iu iv b">hashcode, key, value, next</code>作为成员，HashMap本质上缓存了键的hashcode。</p><figure class="ig ih ii ij fd ik er es paragraph-image"><div class="er es iw"><img src="../Images/92c58f10823a010d94ce9b191eb63c43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*OBgIWkcpBfhnely56N2VIw.png"/></div><figcaption class="ix iy et er es iz ja bd b be z dx">UnifiedMap schematic</figcaption></figure><p id="6213" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">UnifiedMap由一个数组支持，其中键和值占据数组中的交替槽:<code class="du is it iu iv b">protected transient Object[] table</code>。扁平化的数组结构只存储键和值，通过创建一个更精简的映射实现来减少内存占用。将键和值放在连续的槽中的额外好处是提高了缓存的局部性。</p><p id="c922" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">主数组中的碰撞是通过将一个叫做<code class="du is it iu iv b">CHAINED_KEY</code>的特殊对象放入键槽来处理的。<code class="du is it iu iv b">CHAINED_KEY</code>的值槽(在<code class="du is it iu iv b">CHAINED_KEY</code>槽之后的槽)包含另一个类似于主数组的<code class="du is it iu iv b">Object[]</code>数组，称为<code class="du is it iu iv b">CHAINED_OBJECT</code>，键和值在交替槽中。</p><p id="1739" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">UnifiedMap中的查找使用标准的<a class="ae ir" href="https://github.com/eclipse/eclipse-collections/blob/master/eclipse-collections/src/main/java/org/eclipse/collections/impl/map/mutable/UnifiedMap.java#L316" rel="noopener ugc nofollow" target="_blank"> hashcode索引算法</a>来查找数组中一个键的位置。如果一个键是<em class="jb">而不是</em> a <code class="du is it iu iv b">CHAINED_KEY</code>，那么下一个槽包含该值。如果关键字<em class="jb">是</em> a <code class="du is it iu iv b">CHAINED_KEY</code>，那么<code class="du is it iu iv b">CHAINED_OBJECT</code>被线性评估以找到所需的关键字，并且<code class="du is it iu iv b">CHAINED_OBJECT</code>中的下一个槽包含该值。</p><p id="746e" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">因为UnifiedMap不缓存hashcode，所以对于每次查找，都需要计算hashcode。所以，UnifiedMap的性能直接依赖于键的hashcode实现。</p><p id="3d94" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">下面是JDK 1.8 HashMap和Eclipse Collections 9 . 0 . 0 unified map之间的一些内存和性能比较。</p><p id="0cda" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated"><strong class="hi ie">内存占用(数字越低越好)</strong></p><figure class="ig ih ii ij fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es jc"><img src="../Images/d09026b1ee7614465ded5c98ab75e62e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5DEXbbY78-iRqVRe1cSRgQ.png"/></div></div><figcaption class="ix iy et er es iz ja bd b be z dx">Memory Comparison HashMap&lt;Integer, Integer&gt; vs UnifiedMap&lt;Integer, Integer&gt;</figcaption></figure><figure class="ig ih ii ij fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es jd"><img src="../Images/8759b14850ac0f75a23ca8729fb56975.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kaxziu1rgItiKMXXXScscw.png"/></div></div><figcaption class="ix iy et er es iz ja bd b be z dx">Memory Comparison HashMap&lt;String, String&gt; vs UnifiedMap&lt;String, String&gt;</figcaption></figure><p id="f257" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated"><strong class="hi ie">性能测试(数字越大越好)</strong></p><figure class="ig ih ii ij fd ik er es paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="er es je"><img src="../Images/cf145fa74b5ba4513350a0791f219023.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w8PsAkdSSdG183yzxc2GNg.png"/></div></div></figure><figure class="ig ih ii ij fd ik er es paragraph-image"><div class="er es jf"><img src="../Images/f801190d88143e6c60dba074de78ca64.png" data-original-src="https://miro.medium.com/v2/resize:fit:460/format:webp/1*zueMnXtSqBmGK3p44fdnUA.png"/></div></figure><p id="6051" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated">内存测试和性能测试的源代码可在<a class="ae ir" href="https://github.com/nikhilnanivadekar/MemoryPerformanceTest" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得。</p><p id="88f8" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated"><strong class="hi ie">摘要:</strong>与JDK散列表相比，Eclipse Collections UnifiedMap的内存占用要少50%,但这也带来了较小的性能影响。</p><p id="8c3f" class="pw-post-body-paragraph hf hg hh hi b hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id ha bi translated"><em class="jb">月食收藏为</em> <a class="ae ir" href="https://github.com/eclipse/eclipse-collections/blob/master/CONTRIBUTING.md" rel="noopener ugc nofollow" target="_blank"> <em class="jb">投稿</em> </a> <em class="jb">打开。如果你喜欢，就开始吧。</em></p></div></div>    
</body>
</html>