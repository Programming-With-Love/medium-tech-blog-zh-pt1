<html>
<head>
<title>Three compatibility problems when migrating from Azure SQL to Azure Synapse SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Azure SQL迁移到Azure Synapse SQL时的三个兼容性问题</h1>
<blockquote>原文：<a href="https://medium.com/globant/three-compatibility-problems-when-migrating-from-azure-sql-to-azure-synapse-sql-cd27cd381988?source=collection_archive---------0-----------------------#2021-11-15">https://medium.com/globant/three-compatibility-problems-when-migrating-from-azure-sql-to-azure-synapse-sql-cd27cd381988?source=collection_archive---------0-----------------------#2021-11-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/a154e08ee7316324d47a8561f944d9cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jYbc1IpYRpmsJCkWDNc0Fg.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Making code more compatible.</figcaption></figure><p id="957b" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在本文中，我们将看到从<a class="ae jr" href="https://docs.microsoft.com/en-us/azure/azure-sql/database/sql-database-paas-overview" rel="noopener ugc nofollow" target="_blank"> Azure SQL数据库</a>迁移到<a class="ae jr" href="https://docs.microsoft.com/en-us/azure/synapse-analytics/sql/overview-architecture" rel="noopener ugc nofollow" target="_blank"> Azure Synapse SQL </a>时的一些关键代码差异和最佳可能解决方案，其中包括实际例子和场景。在两个数据库上并行工作，我们可能会面临一些挑战，因为对象可能不被原样支持，或者功能可能略有不同。写这篇文章是考虑到你在Azure SQL和Azure Synapse SQL方面有初级到中级的专业水平，并且你有Azure订阅。</p><p id="3b0a" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">问题陈述</strong></p><p id="8396" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在处理解决方案时，我们经常看到Azure SQL数据库和Azure Synapse SQL的用例最适合作为数据库/数据源。即使迁移的大部分细节没有痛苦，也有一些可能的问题。下一部分涵盖了以下功能的示例，展示了Azure Synapse SQL中支持的一些关键代码差异和最佳解决方案。</p><ol class=""><li id="a731" class="js jt hh iv b iw ix ja jb je ju ji jv jm jw jq jx jy jz ka bi translated">标识列</li><li id="34b5" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq jx jy jz ka bi translated">表格变量</li><li id="4a11" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq jx jy jz ka bi translated">将NULL设置为存储过程中的默认值</li></ol><p id="6082" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">身份列差异</strong></p><p id="5548" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><a class="ae jr" href="https://docs.microsoft.com/en-us/sql/t-sql/functions/identity-function-transact-sql?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">标识列</a>用于唯一标识表中的行。表的标识列是其值自动增加的列。标识列中的值由服务器创建。用户通常不能在标识列中插入值。</p><p id="17ac" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi"> Azure SQL </strong></p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="82a5" class="kp kq hh kl b fi kr ks l kt ku">IF OBJECT_ID(‘tempdb..#Student’) IS NOT NULL DROP TABLE #Student<br/>CREATE TABLE #Student(<br/> StudentID INT IDENTITY(1,1),<br/> StudentName VARCHAR(30),<br/> City VARCHAR(10)<br/> )<br/>INSERT INTO #Student (StudentName, City) VALUES (‘Kunal Patni’, ‘Pune’);<br/>INSERT INTO #Student (StudentName, City) VALUES (‘Pratik Futane’, ‘Pune’);</span><span id="f582" class="kp kq hh kl b fi kv ks l kt ku">SELECT * FROM #Student ORDER BY StudentName ASC</span></pre><figure class="kg kh ki kj fd ii er es paragraph-image"><div class="er es kw"><img src="../Images/a7c78372f16d2595f72bd0167fcfa8b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/0*C0tKWrQyMXcKsxcl"/></div></figure><p id="688d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi"> Azure Synapse SQL </strong></p><p id="4eae" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><a class="ae jr" href="https://docs.microsoft.com/en-us/azure/synapse-analytics/sql-data-warehouse/sql-data-warehouse-tables-identity" rel="noopener ugc nofollow" target="_blank">Azure Synapse Analytics</a>中的IDENTITY列不保证值将按顺序生成，并且由于分布式架构以及用户在“SET IDENTITY_INSERT ON”的情况下显式插入重复值，它将是唯一的。</p><p id="4a93" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">在Azure Synapse SQL中运行类似的代码会产生不同的结果。</p><figure class="kg kh ki kj fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kx"><img src="../Images/16d891add9abbb93c92296c58dce5aae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CnOlcrNURq0tPfRJ"/></div></div></figure><p id="6a7d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">为了解决这个问题，我们可以使用像ROW_NUMBER这样的分析函数为每个值生成行号。这将为我们提供序列中唯一的行号。</p><p id="39c6" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这里有一个例子。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="411c" class="kp kq hh kl b fi kr ks l kt ku">SELECT ROW_NUMBER() OVER(ORDER BY StudentName ASC) AS ID,<br/> StudentName,<br/> City<br/>FROM #Student</span></pre><figure class="kg kh ki kj fd ii er es paragraph-image"><div class="er es ky"><img src="../Images/af941f45c3732c8ddecd2dcfd7f77008.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/0*fhPrMHs9aHk8aiRq"/></div></figure><p id="db1e" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">因此，这解释了Azure SQL和Azure Synapse SQL中的标识列差异。</p><p id="f866" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">表格变量差异</strong></p><h2 id="5bf8" class="kp kq hh bd kz la lb lc ld le lf lg lh je li lj lk ji ll lm ln jm lo lp lq lr bi translated"><strong class="ak"> Azure SQL </strong></h2><p id="e0f4" class="pw-post-body-paragraph it iu hh iv b iw ls iy iz ja lt jc jd je lu jg jh ji lv jk jl jm lw jo jp jq ha bi translated">是一种特殊的数据类型，可用于存储类似于<a class="ae jr" href="https://docs.microsoft.com/en-us/sql/t-sql/statements/create-table-transact-sql?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">临时表</a>的临时数据。table变量的语法类似于使用CREATE TABLE语句定义新表:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="5431" class="kp kq hh kl b fi kr ks l kt ku">DECLARE @Student TABLE(<br/> StudentID INT,<br/> StudentName VARCHAR(30)<br/> );</span><span id="2ce0" class="kp kq hh kl b fi kv ks l kt ku">INSERT INTO @Student VALUES (1001, ‘Kunal Patni’);<br/>INSERT INTO @Student VALUES (1002, ‘Pratik Futane’);</span><span id="b18f" class="kp kq hh kl b fi kv ks l kt ku">SELECT * FROM @Student</span></pre><figure class="kg kh ki kj fd ii er es paragraph-image"><div class="er es lx"><img src="../Images/a247f94ed4551ba041dce042969a4fd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:982/0*9wJiUPoHRmuI3JYN"/></div></figure><p id="e193" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi"> Azure Synapse SQL </strong></p><p id="a09b" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Synapse不支持表格变量。相反，我们可以使用<a class="ae jr" href="https://docs.microsoft.com/en-us/azure/synapse-analytics/sql-data-warehouse/sql-data-warehouse-tables-temporary" rel="noopener ugc nofollow" target="_blank">临时表</a>，这与它在Azure SQL中的工作方式非常相似。</p><p id="883c" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">下面是一个例子:</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="47cb" class="kp kq hh kl b fi kr ks l kt ku">IF OBJECT_ID(‘tempdb..#Student’) IS NOT NULL DROP TABLE #Student<br/>CREATE TABLE #Student(<br/> StudentID INT,<br/> StudentName VARCHAR(30)<br/> )</span><span id="255a" class="kp kq hh kl b fi kv ks l kt ku">INSERT INTO #Student VALUES (1001, ‘Kunal Patni’);<br/>INSERT INTO #Student VALUES (1002, ‘Pratik Futane’);</span><span id="1b93" class="kp kq hh kl b fi kv ks l kt ku">SELECT * FROM #Student</span></pre><figure class="kg kh ki kj fd ii er es paragraph-image"><div class="er es ly"><img src="../Images/3460fe144db3b83bd129b50a71e73f35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/0*QKtKwXO7B6nt40PW"/></div></figure><p id="e475" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">因此，这解释了Azure SQL和Azure Synapse SQL中的表变量差异。</p><p id="87e2" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">将NULL设置为存储过程差异的默认值</strong></p><h2 id="1b12" class="kp kq hh bd kz la lb lc ld le lf lg lh je li lj lk ji ll lm ln jm lo lp lq lr bi translated"><strong class="ak"> Azure SQL </strong></h2><p id="f405" class="pw-post-body-paragraph it iu hh iv b iw ls iy iz ja lt jc jd je lu jg jh ji lv jk jl jm lw jo jp jq ha bi translated">Azure SQL支持在<a class="ae jr" href="https://docs.microsoft.com/en-us/sql/relational-databases/stored-procedures/create-a-stored-procedure?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">存储过程</a> (SP)中将NULL值设置为默认值。有了它，我们可以创建接受可选参数的SP，当调用SP时，我们可以传递也可以不传递默认参数。</p><p id="b0ac" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">下面的例子展示了我们如何设置可选参数。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="3045" class="kp kq hh kl b fi kr ks l kt ku">CREATE PROCEDURE [dbo].[USP_GetStudentList]<br/>(<br/> @City VARCHAR(50),<br/> @Country VARCHAR(50)=NULL<br/>)<br/>AS<br/>BEGIN<br/> SELECT StudentID,<br/> StudentName,<br/> City,<br/> Country<br/> FROM Student<br/> WHERE City=@City AND Country=@Country<br/>END</span></pre><p id="2b9d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">下面两个例子展示了我们如何用可选参数调用SP。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="c056" class="kp kq hh kl b fi kr ks l kt ku">EXEC [dbo].[USP_GetStudentList] @City=’Pune’, @Country=’India’ <br/>EXEC [dbo].[USP_GetStudentList] @City=’Pune’</span></pre><p id="6ad6" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi"> Azure Synapse SQL </strong></p><p id="bb44" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Synapse不支持在<a class="ae jr" href="https://docs.microsoft.com/en-us/azure/synapse-analytics/sql/develop-stored-procedures" rel="noopener ugc nofollow" target="_blank">存储过程</a> (SP)中将NULL设置为默认参数；它抛出以下错误。</p><figure class="kg kh ki kj fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lz"><img src="../Images/72c87f00e45ac94728beb5243e3b560c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jrAtVHQC91bS1i5H"/></div></div></figure><p id="4e81" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">为了解决这个问题，我们可以根据具体情况创建两个不同的服务点。考虑上述示例，我们可以创建两个服务点。</p><p id="4931" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">第一个SP呼叫只有城市参数，如下所示。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="df49" class="kp kq hh kl b fi kr ks l kt ku">CREATE PROCEDURE [dbo].[USP_GetStudentList]<br/>(<br/> @City VARCHAR(50)<br/>)<br/>AS<br/>BEGIN<br/> SELECT StudentID,<br/> StudentName,<br/> City,<br/> Country<br/> FROM Student<br/> WHERE City=@City<br/>END</span><span id="7f5d" class="kp kq hh kl b fi kv ks l kt ku">EXEC [dbo].[USP_GetStudentList] @City=’Pune’</span></pre><p id="9b40" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">第二个SP呼叫仅包含国家参数，如下所示。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="515d" class="kp kq hh kl b fi kr ks l kt ku">CREATE PROCEDURE [dbo].[USP_GetStudentList]<br/>(<br/> @Country VARCHAR(50)<br/>)<br/>AS<br/>BEGIN<br/> SELECT StudentID,<br/> StudentName,<br/> City,<br/> Country<br/> FROM Student<br/> WHERE Country=@Country<br/>END</span><span id="e404" class="kp kq hh kl b fi kv ks l kt ku">EXEC [dbo].[USP_GetStudentList] @Country=’India’</span></pre><p id="325c" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">因此，这解释了在Azure SQL和Azure Synapse SQL的存储过程差异中将NULL设置为默认值。</p><p id="e7be" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">结论</strong></p><p id="83ba" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">总之，在这篇文章中，我们看到了从Azure SQL迁移到Azure Synapse SQL时可能出现的三个具体问题，以及我们如何编写支持这两种数据库的兼容或替代代码。在接下来的文章中，我们将讨论更多的问题来帮助实现无痛迁移。</p></div></div>    
</body>
</html>