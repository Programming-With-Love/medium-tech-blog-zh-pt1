<html>
<head>
<title>Get started with Athena federated queries and DocumentDB.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开始使用Athena联邦查询和DocumentDB。</h1>
<blockquote>原文：<a href="https://medium.com/globant/get-started-with-athena-federated-queries-and-documentdb-3ac66bef4ef?source=collection_archive---------0-----------------------#2021-08-18">https://medium.com/globant/get-started-with-athena-federated-queries-and-documentdb-3ac66bef4ef?source=collection_archive---------0-----------------------#2021-08-18</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="182c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当今架构中的一个主要挑战是从多个数据源获得洞察力。在这些架构中，很容易看到不同数据库的组合:内存数据库、键值数据库、文档数据库、关系数据库、列数据库等等。Athena是一个查询引擎，允许我们交互和分析结构化、半结构化和非结构化数据。有了Athena的联邦查询，我们现在可以查询所有这些数据库，并将结果存储在S3中。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/86990f85d66b90ea99cd2c9c5116a467.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ILMSQCV9LCwATAxfWhwkfQ.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Base Architecture</figcaption></figure><h1 id="7c8c" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">介绍</h1><p id="9244" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">本文将向您展示如何配置联邦Athena查询来与多个DocumentDB集群交互，并集中所有信息以进行更详细的分析。</p><p id="bce2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本文中，我们将讨论以下几点:<br/> 1-如何创建Athena连接器<br/> 2- Lambda连接函数<br/>3-Lambda函数的部署<br/>4-Athena中的查询<br/> 5-吸取的教训</p><h1 id="ec56" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">如何创建Athena连接器</h1><p id="61f5" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">接下来，我向您展示连接器步骤；首先，我们必须去雅典娜控制台。<br/> 1-点击数据源</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es kv"><img src="../Images/ed2a6e0ba7223035346e1b16e4182aa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DAPzjxp6Vt012RdWXJ0gsg.png"/></div></div></figure><p id="6deb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2-您应该选择查询数据源选项，并为您的用例选择源数据库；我的例子是Amazon DocumentDB。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es kw"><img src="../Images/2c448644b8f31a94f15bf20c60a559d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bVxSc-yNzR1KP87lF_i62A.png"/></div></div></figure><p id="dbaf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">3-在这一步，我们配置新的Lambda函数来连接我们的数据库。我们将使用稍后指定的环境变量来配置该函数，以实现连接性。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es kx"><img src="../Images/a54f3159db871273ac8b42b350473f5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eAFhuB0r4d8Q3xYoQ6ATmA.png"/></div></div></figure><h1 id="93ef" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">λ连接函数</h1><p id="364a" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">为了创建我们的lambda函数，我们需要填充指定的字段，我将逐一解释:</p><h2 id="16a6" class="ky jt hh bd ju kz la lb jy lc ld le kc ip lf lg kg it lh li kk ix lj lk ko ll bi translated">配置部分# 1</h2><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lm"><img src="../Images/a9ce8054c564ffba75ddc1a3dcb91da8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Iv3tmAXn7fYp4XL8Dg8zg.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Configuration Part # 1 — Lambda</figcaption></figure><ul class=""><li id="646d" class="ln lo hh ig b ih ii il im ip lp it lq ix lr jb ls lt lu lv bi translated"><strong class="ig hi">应用名称</strong>:在SAM中命名应用，在Lambda &gt;应用中可以看到。</li></ul><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lw"><img src="../Images/024502a43260fb40a1cb077822f8cfed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1258/format:webp/1*GRsBdSyMcyHVDSgGdsQALw.png"/></div></div></figure><ul class=""><li id="60b5" class="ln lo hh ig b ih ii il im ip lp it lq ix lr jb ls lt lu lv bi translated"><strong class="ig hi"> SecretNameOrPrefix </strong>:当数据库的连接字符串在Secrets Manager服务中时，我们可以指定秘密的前缀或名称。</li><li id="f89f" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated"><strong class="ig hi"> spill_bucket </strong>:存储查询结果的桶；这些将保留在CSV中。在下图中，你可以看到一个例子。</li></ul><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mc"><img src="../Images/450ba0ec1c0bd040ec6dee89ddc2a671.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0dMIdEdiXWt3mK8teSLzLQ.png"/></div></div></figure><ul class=""><li id="902b" class="ln lo hh ig b ih ii il im ip lp it lq ix lr jb ls lt lu lv bi translated"><strong class="ig hi"> AthenaCatalogName </strong>:是Athena目录的名称。Lambda函数将具有相同的名称。在下图中，你可以看到一个例子。</li></ul><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es md"><img src="../Images/723eb054a439f4ea64f1a255e834e1d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LNdinplk8Rdt2fe-3dLTqg.png"/></div></div></figure><ul class=""><li id="3361" class="ln lo hh ig b ih ii il im ip lp it lq ix lr jb ls lt lu lv bi translated"><strong class="ig hi">disable _ spill _ encryption</strong>:可以是真，也可以是假；它对存储在S3桶中的数据进行加密；请记住，您想要更好的性能。</li></ul><h2 id="cce4" class="ky jt hh bd ju kz la lb jy lc ld le kc ip lf lg kg it lh li kk ix lj lk ko ll bi translated">配置部分# 2</h2><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es me"><img src="../Images/88478d118277935bcf7280abe786c2b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k7OCx6d85c3xY-z5t4627A.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Configuration Part # 2- Lambda</figcaption></figure><ul class=""><li id="91e4" class="ln lo hh ig b ih ii il im ip lp it lq ix lr jb ls lt lu lv bi translated"><strong class="ig hi"> DocDBConnectionString </strong>:在这个字段中，我们需要指定数据库的连接字符串或者引用连接字符串的秘密。如果你要使用一个秘密，请记住Lambda函数的角色必须有必要的权限来获取和解密它。</li><li id="6435" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated"><strong class="ig hi">lambda Memory</strong>:lambda函数的内存，请记住，对源数据库的许多查询可能很复杂，需要执行时间。为此，有必要回顾一下函数及其消耗，以调整记忆。</li><li id="72a0" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated"><strong class="ig hi"> LambdaTimeout: </strong>为该功能配置的超时。在生产中监控Lambda至关重要。但是，我建议从高值开始。这种情况下，我从900开始。当我们在DocumentDB中查询一个小表时，可以看到下面的日志。</li></ul><pre class="jd je jf jg fd mf mg mh mi aw mj bi"><span id="d48c" class="ky jt hh mg b fi mk ml l mm mn">REPORT RequestId: f94b7b28–12e4–44b9-b0ee-84aca25bbc2c Duration: 417.61 ms <strong class="mg hi">Billed Duration: 418 ms Memory Size: 3008 MB Max Memory Used: 201 MB</strong></span><span id="f004" class="ky jt hh mg b fi mo ml l mm mn">REPORT RequestId: 00a578c2-c043–491e-8acc-cd497bac801d Duration: 9637.66 ms <strong class="mg hi">Billed Duration: 9638 ms Memory Size: 3008 MB Max Memory Used: 195 MB</strong></span><span id="f8d0" class="ky jt hh mg b fi mo ml l mm mn">REPORT RequestId: 6067415d-94dc-45d4-a9ed-dc22cef1a465 Duration: 8174.79 ms <strong class="mg hi">Billed Duration: 8175 ms Memory Size: 3008 MB Max Memory Used: 192 MB</strong></span></pre><ul class=""><li id="974e" class="ln lo hh ig b ih ii il im ip lp it lq ix lr jb ls lt lu lv bi translated"><strong class="ig hi">security group pids</strong>:您必须指定我们将与角色关联的安全组的ID。</li><li id="8764" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated"><strong class="ig hi"> spill_prefix </strong>:它是存储响应的bucket中的子文件夹的名称。</li><li id="e9d9" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated"><strong class="ig hi"> SubnetIds </strong>:您需要指定我们将与角色关联的安全组的ID。</li></ul><h1 id="69fc" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">建立工作关系网</h1><p id="2262" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">Lambda函数必须在VPC中；这很重要，因为我们必须考虑几个组件及其配置:</p><ul class=""><li id="aab8" class="ln lo hh ig b ih ii il im ip lp it lq ix lr jb ls lt lu lv bi translated"><strong class="ig hi">安全组</strong>:在这种情况下，DocumentDB数据库的SG允许Lambda函数的SG的流量通过端口27017是至关重要的。</li><li id="69cf" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated"><strong class="ig hi">路由表</strong>:我们必须决定我们的Lambda函数将如何访问S3桶来存储数据。</li><li id="6f83" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated"><strong class="ig hi">通过互联网将Lambda发送到S3</strong>:要实现这一点，Lambda必须位于专用子网中，并且其路由表必须通过NAT网关将流量发送到互联网。</li><li id="824a" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated"><strong class="ig hi"> Lambda到S3而不上线</strong>:我们需要创建一个VPC端点来访问S3，并通过路由表中的这个端点将流量定向到S3。对于这个场景，Lambda不需要上线。</li></ul><h1 id="b216" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">特征</h1><ul class=""><li id="7f5a" class="ln lo hh ig b ih kq il kr ip mp it mq ix mr jb ls lt lu lv bi translated"><strong class="ig hi">语言</strong> : Java 8。</li><li id="51ba" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated"><strong class="ig hi">部署</strong>:Lambda功能使用SAM部署；一旦我们填写了所有要求的信息，这个过程就是自动的。</li><li id="1a5a" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated"><strong class="ig hi">角色</strong>:Lambda函数的角色必须能够访问S3来存储查询结果。</li><li id="8108" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated"><strong class="ig hi">大小</strong>:lambda包重约25Mb。</li><li id="8342" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated"><strong class="ig hi">代码</strong>:lambda代码自动生成。当我们试图查看代码时，我们无法做到这一点，代码来自SAM模板中帐户之外的一个桶。</li></ul><h1 id="f774" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">我们的Lambda函数的部署</h1><p id="5df2" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">要对Lambda函数进行更改，我们可以使用CodePipeline、CodeBuild和CodeDeploy等AWS工具创建一个CICD。AWS在幕后使用SAM模板创建整个基础架构，如下所示:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ms mt l"/></div></figure><p id="c41e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要为无服务器应用程序创建CICD，您可以查看以下链接。然而，这是控制台中应用程序部署的第一个版本。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mu"><img src="../Images/093b833f95278ad599f625b1bb83ee97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fCINm30akumpfvkvQXvZkQ.png"/></div></div></figure><h1 id="72c4" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">雅典娜中的查询</h1><p id="e417" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">在Athena中完成所有必要的配置后，我们可以在DocumentDB中查询我们的数据库，如下所示:</p><pre class="jd je jf jg fd mf mg mh mi aw mj bi"><span id="223d" class="ky jt hh mg b fi mk ml l mm mn">SELECT * FROM “source_data_name”. “Data_base”. “Table” limit 10;</span></pre><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mv"><img src="../Images/f435066cce769519acdb593835159edb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BsXZhu0-CclYklVvqAO1tg.png"/></div></div></figure><p id="2d40" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Athena中，您还可以从不同的数据库引擎查询多个数据源。有关更多信息，请参见<a class="ae mw" href="https://github.com/awslabs/aws-athena-query-federation" rel="noopener ugc nofollow" target="_blank"> Athena联邦查询文档。</a></p><h1 id="c1c1" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">吸取的教训</h1><ul class=""><li id="3322" class="ln lo hh ig b ih kq il kr ip mp it mq ix mr jb ls lt lu lv bi translated">这是一个突出的特点；但是，您必须为每个到不同DB的连接创建它的连接器；这将根据数据源的数量为您提供几个Lambda函数。</li><li id="665f" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated">您可以将Athena与Quicksight集成，创建包含所需信息的可视化仪表板。</li><li id="b34e" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated">如图所示的体系结构的安全性至关重要；这就是为什么必须保护所有组件，保证静态加密，限制Lambda角色的权限，并始终使用Secrets Manager连接到数据源。</li><li id="2344" class="ln lo hh ig b ih lx il ly ip lz it ma ix mb jb ls lt lu lv bi translated">当第一次配置这个特性时，总是查看Lambda函数的执行日志并基于这些结果调整内存和超时值是至关重要的。</li></ul><p id="4b00" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae mw" href="https://www.linkedin.com/in/carlos-zambrano-aws/" rel="noopener ugc nofollow" target="_blank">——卡洛斯·桑布拉诺</a></p></div></div>    
</body>
</html>