<html>
<head>
<title>Cross-stitching Plaid and AndroidX</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">交叉缝合格子和AndroidX</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/cross-stitching-plaid-and-androidx-7603a192348e?source=collection_archive---------3-----------------------#2018-12-24">https://medium.com/androiddevelopers/cross-stitching-plaid-and-androidx-7603a192348e?source=collection_archive---------3-----------------------#2018-12-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/75fd721034909a7ac6ab43e3d9915085.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XYbnKLfu7L533n8DASGvrQ.png"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">Illustration by <a class="ae hu" href="https://twitter.com/vpoltrack" rel="noopener ugc nofollow" target="_blank">Virginia Poltrack</a></figcaption></figure><div class=""/><div class=""><h2 id="879c" class="pw-subtitle-paragraph iu hw hx bd b iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl dx translated">AndroidX迁移指南</h2></div><p id="c044" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">Plaid是一个有趣的Android应用程序，它展示了材料设计和丰富的交互式UI。最近，该应用程序通过应用现代Android应用程序开发技术进行了更新。要阅读更多关于该应用程序和重新设计愿景的信息，请查看<a class="ae hu" rel="noopener" href="/@crafty/restitching-plaid-9ca5588d3b0a"> Restitching格子图案</a>。</p><div class="hg hh ez fb hi ki"><a rel="noopener follow" target="_blank" href="/@crafty/restitching-plaid-9ca5588d3b0a"><div class="kj ab dw"><div class="kk ab kl cl cj km"><h2 class="bd hy fi z dy kn ea eb ko ed ef hw bi translated">重缝格子</h2><div class="kp l"><h3 class="bd b fi z dy kn ea eb ko ed ef dx translated">将格子更新为现代应用标准</h3></div><div class="kq l"><p class="bd b fp z dy kn ea eb ko ed ef dx translated">medium.com</p></div></div><div class="kr l"><div class="ks l kt ku kv kr kw ho ki"/></div></div></a></div><p id="75d2" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">像大多数Android应用程序一样，Plaid依赖于Android支持库，该库为运行旧版本操作系统的手机提供了新的Android功能的向后兼容性。2018年9月，支持库的最后一个版本(28.0.0)发布。支持库附带的库已迁移到AndroidX(设计库除外，它已迁移到Android的材料组件),这些库的所有新开发都在AndroidX中进行。因此，获得bug修复、新特性和其他库更新的唯一方法是将Plaid迁移到AndroidX。</p><h1 id="2ad6" class="kx ky hx bd kz la lb lc ld le lf lg lh jd li je lj jg lk jh ll jj lm jk ln lo bi translated">AndroidX是什么？</h1><p id="bfc8" class="pw-post-body-paragraph jm jn hx jo b jp lp iy jr js lq jb ju jv lr jx jy jz ls kb kc kd lt kf kg kh ha bi translated">在Google I/O 2018上，Android团队<a class="ae hu" href="https://android-developers.googleblog.com/2018/05/hello-world-androidx.html" rel="noopener ugc nofollow" target="_blank">宣布了AndroidX </a>。它是Android团队用来在<a class="ae hu" href="https://developer.android.com/jetpack/" rel="noopener ugc nofollow" target="_blank"> Jetpack </a>中开发、测试、打包、版本化和发布库的<a class="ae hu" href="https://android.googlesource.com/platform/frameworks/support/+/androidx-master-dev" rel="noopener ugc nofollow" target="_blank">开源</a>项目。像支持库一样，每个<a class="ae hu" href="https://developer.android.com/jetpack/androidx/" rel="noopener ugc nofollow" target="_blank"> AndroidX </a>库都独立于Android操作系统，并提供跨Android版本的向后兼容性。这是对支持库的重大改进和完全替代。</p><p id="877d" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">请继续阅读，了解我们如何为迁移过程准备代码并执行迁移本身。</p><h1 id="e9be" class="kx ky hx bd kz la lb lc ld le lf lg lh jd li je lj jg lk jh ll jj lm jk ln lo bi translated">准备迁移</h1><p id="3d19" class="pw-post-body-paragraph jm jn hx jo b jp lp iy jr js lq jb ju jv lr jx jy jz ls kb kc kd lt kf kg kh ha bi translated">我强烈建议在受版本控制的分支上执行迁移。通过这种方式，您可以逐步解决在分离出每个变更进行分析时可能出现的任何迁移问题。您可以在这个<a class="ae hu" href="https://github.com/nickbutcher/plaid/pull/524" rel="noopener ugc nofollow" target="_blank"> Pull请求</a>中看到我们的转换进度，并通过下面的提交链接进行跟进。此外，Android Studio提供了在开始迁移之前备份项目的选项。</p><p id="9e57" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">与任何大规模代码重构一样，在迁移到AndroidX以避免合并冲突时，最好尽量减少主开发分支的合并。虽然这对于其他应用程序可能不可行，但我们的团队能够暂时暂停对主分支的提交，以帮助迁移。一次性迁移整个应用程序也很重要，因为部分迁移——同时使用AndroidX和支持库——会导致失败。</p><p id="52fc" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">最后，在developer.android.com<a class="ae hu" href="https://developer.android.com/" rel="noopener ugc nofollow" target="_blank">的</a>上阅读关于<a class="ae hu" href="https://developer.android.com/jetpack/androidx/migrate" rel="noopener ugc nofollow" target="_blank">迁移到AndroidX </a>的提示。现在让我们开始吧！</p><h1 id="30dd" class="kx ky hx bd kz la lb lc ld le lf lg lh jd li je lj jg lk jh ll jj lm jk ln lo bi translated">确定依赖关系</h1><p id="7d80" class="pw-post-body-paragraph jm jn hx jo b jp lp iy jr js lq jb ju jv lr jx jy jz ls kb kc kd lt kf kg kh ha bi translated">在开始之前，关于代码准备的最重要的建议是:</p><blockquote class="lu lv lw"><p id="06a8" class="jm jn lx jo b jp jq iy jr js jt jb ju ly jw jx jy lz ka kb kc ma ke kf kg kh ha bi translated">确保您使用的依赖项与AndroidX兼容</p></blockquote><p id="7be9" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">依赖于旧版本支持库的库可能与AndroidX不兼容，导致您的应用程序在AndroidX迁移后可能无法编译。找出应用程序的任何依赖项是否不兼容的一种方法是访问每个依赖项的项目站点。更直接的方法是开始迁移并检查可能出现的错误。</p><p id="70bd" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">对于格子，我们使用的是一个旧版本(4.7.1)的<a class="ae hu" href="https://bumptech.github.io/glide/" rel="noopener ugc nofollow" target="_blank"> Glide </a>图像加载库，它与AndroidX不兼容。这导致了迁移后的代码生成问题，导致应用程序无法构建(这是Glide项目中记录的一个类似的<a class="ae hu" href="https://github.com/bumptech/glide/issues/3126" rel="noopener ugc nofollow" target="_blank">问题</a>)。我们升级到版本4.8.0 ( <a class="ae hu" href="https://github.com/nickbutcher/plaid/pull/524/commits/6b23efa838d4e9f60a3e78ae324c0c4a43ec8de0" rel="noopener ugc nofollow" target="_blank"> commit </a>)，在开始迁移之前增加了对AndroidX注释的支持。</p><p id="8827" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">因此，如果可能的话，请更新到您的依赖项的最新版本。这对支持库来说尤其是一个好主意，因为升级到28.0.0(最终版本)会使迁移更加顺利。</p><h1 id="c161" class="kx ky hx bd kz la lb lc ld le lf lg lh jd li je lj jg lk jh ll jj lm jk ln lo bi translated">用Android Studio重构</h1><p id="52e8" class="pw-post-body-paragraph jm jn hx jo b jp lp iy jr js lq jb ju jv lr jx jy jz ls kb kc kd lt kf kg kh ha bi translated">对于迁移过程，我们使用了Android Studio 3.2.1内置的重构。AndroidX迁移工具位于重构菜单&gt;迁移到AndroidX下。这将迁移您的整个项目，包括所有的模块。</p><figure class="mc md me mf fd hj er es paragraph-image"><div class="er es mb"><img src="../Images/301f5d885b3751e215a9f7cf37ca7b06.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*lztKTBouffsQZyUbkNkYHA.png"/></div><figcaption class="hq hr et er es hs ht bd b be z dx">The refactor preview window after running the AndroidX refactor tool</figcaption></figure><p id="eb22" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">如果您不使用Android Studio或者更喜欢使用其他工具进行迁移，请参考关于<a class="ae hu" href="https://developer.android.com/jetpack/androidx/migrate#artifact_mappings" rel="noopener ugc nofollow" target="_blank">工件</a>和<a class="ae hu" href="https://developer.android.com/jetpack/androidx/migrate#class_mappings" rel="noopener ugc nofollow" target="_blank">类</a>映射的页面。这些也以CSV格式提供。</p><p id="f78b" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">Android Studio中的AndroidX迁移工具是迁移到AndroidX的一个很好的资源。该工具正在不断改进，因此，如果您遇到问题或希望看到某个功能，请<a class="ae hu" href="https://issuetracker.google.com/issues/new?component=460323" rel="noopener ugc nofollow" target="_blank">在谷歌问题跟踪系统上提交一张罚单</a>。</p><h1 id="bb68" class="kx ky hx bd kz la lb lc ld le lf lg lh jd li je lj jg lk jh ll jj lm jk ln lo bi translated">迁移应用程序</h1><blockquote class="lu lv lw"><p id="2cd4" class="jm jn lx jo b jp jq iy jr js jt jb ju ly jw jx jy lz ka kb kc ma ke kf kg kh ha bi translated"><strong class="jo hy"> <em class="hx">更改最低金额代码，以便再次运行应用程序。</em> </strong></p></blockquote><p id="7624" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">运行AndroidX迁移工具后，大量代码发生了变化，但项目并没有构建起来。在这一点上，我们只需要<a class="ae hu" href="https://github.com/nickbutcher/plaid/compare/dd2ebf7f2de74809981e7c904c9ee22d16db5262...d2cefa384448f4d3fb92dec0ade25d9bd87efb63" rel="noopener ugc nofollow" target="_blank">做最少的工作</a>就可以让应用程序再次运行。</p><p id="aa77" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">这种方法有助于将流程分成易于管理的步骤。我们将修复导入顺序、提取依赖变量和减少完整类路径使用等任务留给了以后的清理过程。</p><p id="a560" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">首先出现的错误之一是重复的类——在本例中是<code class="du mg mh mi mj b">PathSegment</code>:</p><pre class="mc md me mf fd mk mj ml mm aw mn bi"><span id="7ca5" class="mo ky hx mj b fi mp mq l mr ms">Execution failed for task ':app:transformDexArchiveWithExternalLibsDexMergerForDebug'.</span><span id="84b0" class="mo ky hx mj b fi mt mq l mr ms">&gt; com.android.builder.dexing.DexArchiveMergerException: Error while merging dex archives:</span><span id="0762" class="mo ky hx mj b fi mt mq l mr ms">Learn how to resolve the issue at <a class="ae hu" href="https://developer.android.com/studio/build/dependencies#duplicate_classes." rel="noopener ugc nofollow" target="_blank">https://developer.android.com/studio/build/dependencies#duplicate_classes.</a></span><span id="6a0b" class="mo ky hx mj b fi mt mq l mr ms">Program type already present: androidx.core.graphics.PathSegment</span></pre><p id="9b18" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">这是迁移工具中的一个错误，它生成了一个不正确的依赖项(<code class="du mg mh mi mj b">androidx.core:core-ktx:0.3</code>)。我们手动更新(<a class="ae hu" href="https://github.com/nickbutcher/plaid/pull/524/commits/8e60a351625b934a650b571dd67f4d206f96ac91" rel="noopener ugc nofollow" target="_blank">提交</a>)为正确的(<code class="du mg mh mi mj b">androidx.core:core-ktx:1.0.0</code>)。这个<a class="ae hu" href="https://issuetracker.google.com/issues/111260482" rel="noopener ugc nofollow" target="_blank"> bug </a>已经被修复，可以在Android Studio 3.3 Canary 9以及更高版本中获得。我们希望指出这一点，因为您在迁移过程中可能会遇到类似的问题。</p><p id="606d" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">接下来，<code class="du mg mh mi mj b">Palette</code> API发生了变化，现在可以为null。为了暂时避开这一点(<a class="ae hu" href="https://github.com/nickbutcher/plaid/pull/524/commits/75b8ffd621693ac52a0ce243599cfcfd25242d5f" rel="noopener ugc nofollow" target="_blank">提交</a>，我们添加了<code class="du mg mh mi mj b">!!</code>(<a class="ae hu" href="https://kotlinlang.org/docs/reference/null-safety.html#the--operator" rel="noopener ugc nofollow" target="_blank">非空断言操作符</a>)。</p><p id="59c1" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">然后我们遇到了一个错误，其中<code class="du mg mh mi mj b">plusAssign</code>丢失了。此重载在1.0.0中被删除。<code class="du mg mh mi mj b">plusAssign</code>用法被暂时注释掉(<a class="ae hu" href="https://github.com/nickbutcher/plaid/pull/524/commits/d2cefa384448f4d3fb92dec0ade25d9bd87efb63" rel="noopener ugc nofollow" target="_blank">提交</a>)。在本文的后面，我们将探索<code class="du mg mh mi mj b">Palette</code>和<code class="du mg mh mi mj b">plusAssign</code>的永久解决方案。</p><p id="e76d" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">该应用程序现在运行！接下来，是时候清理代码了。</p><h1 id="27e8" class="kx ky hx bd kz la lb lc ld le lf lg lh jd li je lj jg lk jh ll jj lm jk ln lo bi translated">清理代码</h1><p id="c813" class="pw-post-body-paragraph jm jn hx jo b jp lp iy jr js lq jb ju jv lr jx jy jz ls kb kc kd lt kf kg kh ha bi translated">应用正在运行，但是我们的持续集成报告了提交错误:</p><pre class="mc md me mf fd mk mj ml mm aw mn bi"><span id="2eed" class="mo ky hx mj b fi mp mq l mr ms">Execution failed for task ':designernews:checkDebugAndroidTestClasspath'.</span><span id="b772" class="mo ky hx mj b fi mt mq l mr ms">&gt; Conflict with dependency 'androidx.arch.core:core-runtime' in project ':designernews'. </span><span id="5e9f" class="mo ky hx mj b fi mt mq l mr ms">Resolved versions for runtime classpath (2.0.0) and compile classpath (2.0.1-alpha01) differ. This can lead to runtime crashes. </span><span id="0dd9" class="mo ky hx mj b fi mt mq l mr ms">To resolve this issue follow advice at <a class="ae hu" href="https://developer.android.com/studio/build/gradle-tips#configure-project-wide-properties." rel="noopener ugc nofollow" target="_blank">https://developer.android.com/studio/build/gradle-tips#configure-project-wide-properties.</a></span><span id="3bdd" class="mo ky hx mj b fi mt mq l mr ms">Alternatively, you can try to fix the problem by adding this snippet to /.../plaid/designernews/build.gradle:</span><span id="35ce" class="mo ky hx mj b fi mt mq l mr ms">  dependencies {<br/>    implementation("androidx.arch.core:core-runtime:2.0.1-alpha01")<br/>  }</span></pre><p id="5dd9" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">我们遵循了测试日志中的建议，并添加了缺失的依赖块(<a class="ae hu" href="https://github.com/nickbutcher/plaid/pull/524/commits/aba91a9cd5a7a92dc5b9863a6b8c9f980597726b" rel="noopener ugc nofollow" target="_blank">提交</a>)。</p><p id="192e" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">我们还借此机会更新了我们的Gradle、Gradle wrapper和Kotlin版本(<a class="ae hu" href="https://github.com/nickbutcher/plaid/pull/524/commits/b38f2cf74520693699fbcedcb0119778396ba0ec" rel="noopener ugc nofollow" target="_blank"> commit </a>)。Android Studio提示我们安装28.0.3版本的构建工具，我们遵从了。我们遇到了Gradle 3.3.0-alpha13的问题，通过降级回3.3.0-alpha08解决了这个问题。</p><p id="6f67" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">迁移工具的一个缺点是，如果您在依赖版本中使用变量，它会为您内联它们。我们从build.gradle文件中重新提取了版本(<a class="ae hu" href="https://github.com/nickbutcher/plaid/pull/524/commits/0c5a3d62a83ecf400de376f4b4e6e7c3a6bf3c2a" rel="noopener ugc nofollow" target="_blank">提交</a>)。</p><p id="6b41" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">我们上面提到过，在运行AndroidX迁移工具后，我们为<code class="du mg mh mi mj b">plusAssign</code>和<code class="du mg mh mi mj b">Palette</code>提供了临时解决方案。现在，我们重新添加了<code class="du mg mh mi mj b">plusAssign</code>函数和相关的测试(<a class="ae hu" href="https://github.com/nickbutcher/plaid/pull/524/commits/0a5a5a3d50ece0f671201e1183b971fb4a3e158a" rel="noopener ugc nofollow" target="_blank"> commit </a>)，方法是从AndroidX库的以前版本移植它，并取消上面代码的注释。此外，我们将<code class="du mg mh mi mj b">Palette</code>参数更新为可空的(<a class="ae hu" href="https://github.com/nickbutcher/plaid/pull/524/commits/7aad3005ea8ab222443f1a2ea34252e25328d677" rel="noopener ugc nofollow" target="_blank">提交</a>)，这样就不需要使用<code class="du mg mh mi mj b">!!</code>。</p><p id="fa47" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">此外，自动转换可能会将一些类更改为使用它们的完整类路径。做一些小的手工修改是个好主意。作为清理的一部分，我们删除了完整的类路径，并根据需要重新添加了相关的导入。</p><p id="74ce" class="pw-post-body-paragraph jm jn hx jo b jp jq iy jr js jt jb ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">最后，添加了一些小的测试修改，以解决测试(<a class="ae hu" href="https://github.com/nickbutcher/plaid/pull/524/commits/9715e2f8fdabc21b6d73e2f11f31982e90292461" rel="noopener ugc nofollow" target="_blank">提交</a>)和房间测试(<a class="ae hu" href="https://github.com/nickbutcher/plaid/pull/524/commits/a997200ec98b8466c427d5ac16eae94bae816da9" rel="noopener ugc nofollow" target="_blank">提交</a>)期间的依赖冲突。在这一点上，我们的项目被完全转换，我们所有的测试都通过了。</p><h1 id="7282" class="kx ky hx bd kz la lb lc ld le lf lg lh jd li je lj jg lk jh ll jj lm jk ln lo bi translated">结束线程</h1><p id="3cd6" class="pw-post-body-paragraph jm jn hx jo b jp lp iy jr js lq jb ju jv lr jx jy jz ls kb kc kd lt kf kg kh ha bi translated">尽管遇到了一些障碍，AndroidX的移植还是很顺利。这些问题主要涉及不正确转换的依赖项或类，以及新库中的API更改。幸运的是，这些都相对容易解决。格子现在又可以穿了！</p></div></div>    
</body>
</html>