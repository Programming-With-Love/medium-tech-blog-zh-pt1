<html>
<head>
<title>Custom Canvas Animations in Jetpack Compose ✨</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jetpack中的自定义画布动画合成✨</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/custom-canvas-animations-in-jetpack-compose-e7767e349339?source=collection_archive---------0-----------------------#2022-05-17">https://medium.com/androiddevelopers/custom-canvas-animations-in-jetpack-compose-e7767e349339?source=collection_archive---------0-----------------------#2022-05-17</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/4ad197f6f8a520f6fd4df0b534e047ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*16bn5V--jLMAJLCWspst2Q.png"/></div></div></figure><div class=""/><div class=""><h2 id="a864" class="pw-subtitle-paragraph ip hr hs bd b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg dx translated"><em class="jh">使用Animatable实现自定义画布动画</em></h2></div><p id="6901" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">想象一下你所见过的最流畅的应用程序体验…一切都以丝般平滑的过渡和对你的交互的明智反应进行着…你流口水了吗？🤤你不再需要梦想，因为用Compose添加动画会让这个梦想成为现实。不相信我？请继续阅读。</p><p id="ac1a" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">Compose有一系列的<a class="ae ke" href="https://developer.android.com/jetpack/compose/animation" rel="noopener ugc nofollow" target="_blank">动画API</a>，涵盖了许多不同的用例。最简单的动画API就是<code class="du kf kg kh ki b"><a class="ae ke" href="https://developer.android.com/reference/kotlin/androidx/compose/animation/package-summary#AnimatedVisibility(kotlin.Boolean,androidx.compose.ui.Modifier,androidx.compose.animation.EnterTransition,androidx.compose.animation.ExitTransition,kotlin.String,kotlin.Function1)" rel="noopener ugc nofollow" target="_blank">AnimatedVisibility</a></code>。我们可以通过将它包装在一个<code class="du kf kg kh ki b">AnimatedVisibility</code>可组合对象中，并提供一个切换可见性的布尔值，来使用它来激活任何可组合对象的可见性:</p><figure class="kj kk kl km fd hj"><div class="bz dy l di"><div class="kn ko l"/></div></figure><figure class="kj kk kl km fd hj er es paragraph-image"><div class="er es kp"><img src="../Images/e14c82bc15c3a376c00f2d384a5b94b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*AfD-3ksTfOCSHZJpcznyPQ.gif"/></div><figcaption class="kq kr et er es ks kt bd b be z dx">AnimatedVisibility in action</figcaption></figure><p id="16dd" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这是在您的撰写应用程序中获得流畅用户交互的快速方法。但是，如果我们想做一些更复杂的事情，比如动画我们的自定义绘图的旋转或颜色呢？</p><figure class="kj kk kl km fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es ku"><img src="../Images/533217700a76f01ff73738724db6236f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*BVdo2BXlnQDmE22hf-SOLw.gif"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx">Custom drawing animating rotation and color change over time</figcaption></figure><p id="b96e" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><a class="ae ke" href="https://developer.android.com/jetpack/compose/animation" rel="noopener ugc nofollow" target="_blank">动画文档</a>涵盖了不同的API，使你能够实现这些种类的动画，我们将深入其中一个选项:<a class="ae ke" href="https://developer.android.com/jetpack/compose/animation#animatable" rel="noopener ugc nofollow" target="_blank">可动画化</a>。</p><p id="276e" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">但是在我们开始讨论如何使用Compose实现这一点之前，让我们提醒自己如何在标准视图系统中实现自定义动画:</p><h1 id="8f76" class="kv kw hs bd kx ky kz la lb lc ld le lf iy lg iz lh jb li jc lj je lk jf ll lm bi translated">重温标准视图方法😶‍🌫️</h1><p id="06aa" class="pw-post-body-paragraph ji jj hs jk b jl ln it jn jo lo iw jq jr lp jt ju jv lq jx jy jz lr kb kc kd ha bi translated">如果没有Compose，您需要使用类似于<code class="du kf kg kh ki b">ValueAnimator</code>或<code class="du kf kg kh ki b">ObjectAnimator</code>的东西来激活您的自定义视图的属性。我在之前的一次演讲中提到过这个例子。</p><p id="bd83" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">下面是一个示例，展示了如何为绘制圆角矩形的自定义视图的两个属性制作动画，即旋转<code class="du kf kg kh ki b">angle</code>和<code class="du kf kg kh ki b">color</code> Int。我们使用<code class="du kf kg kh ki b">ValueAnimator.ofPropertyValuesHolder</code>同时激活多个属性，在视图上调用<code class="du kf kg kh ki b">invalidate()</code>。这会触发重绘，因此动画会随着属性的更新而运行。</p><figure class="kj kk kl km fd hj"><div class="bz dy l di"><div class="kn ko l"/></div></figure><h1 id="6182" class="kv kw hs bd kx ky kz la lb lc ld le lf iy lg iz lh jb li jc lj je lk jf ll lm bi translated">使用合成制作自定义绘图动画🎨</h1><p id="83fc" class="pw-post-body-paragraph ji jj hs jk b jl ln it jn jo lo iw jq jr lp jt ju jv lq jx jy jz lr kb kc kd ha bi translated">为了在Compose中实现这个动画，我们创建了两个记忆的<code class="du kf kg kh ki b">Animatable</code>状态——一个用于角度，一个用于颜色。角度将从0–360度变化，颜色将从<code class="du kf kg kh ki b">Color.Green</code>变化到<code class="du kf kg kh ki b">Color.Blue</code>，然后我们将使用这两个值在画布上绘制元素。</p><figure class="kj kk kl km fd hj"><div class="bz dy l di"><div class="kn ko l"/></div></figure><p id="481d" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">所有的动画逻辑和绘图逻辑都是可组合的。利用Composables中使用的相同的类和函数——比如协程和Compose的<code class="du kf kg kh ki b">State</code>类来存储动画进度。</p><p id="696b" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">你会注意到颜色动画看起来有点不同:我们定义了一个<code class="du kf kg kh ki b"><a class="ae ke" href="https://developer.android.com/reference/kotlin/androidx/compose/animation/core/TwoWayConverter" rel="noopener ugc nofollow" target="_blank">TwoWayConverter</a></code>来将颜色转换成一个<code class="du kf kg kh ki b">AnimationVector</code>。<code class="du kf kg kh ki b">Color.VectorConverter</code>在<code class="du kf kg kh ki b">Color</code>和4部分<code class="du kf kg kh ki b">AnimationVector</code>之间转换，存储颜色的红、绿、蓝和阿尔法分量。在前面的视图示例中，我们需要添加<code class="du kf kg kh ki b">ArgbEvaluator</code>来实现相同的效果。</p><p id="3500" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">为了在将可组合组件添加到组合中时立即开始动画，我们使用了<code class="du kf kg kh ki b"><a class="ae ke" href="https://developer.android.com/jetpack/compose/side-effects#launchedeffect" rel="noopener ugc nofollow" target="_blank">LaunchedEffect</a></code>类。只有当提供的密钥改变时，才会再次运行。然后我们在之前定义的<code class="du kf kg kh ki b">Animatable</code>上使用<code class="du kf kg kh ki b">animateTo</code>函数，这是一个<strong class="jk ht"> suspend </strong>函数，需要从协程上下文中调用。</p><p id="4df6" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">为了在<strong class="jk ht">并行</strong>中运行动画，我们调用launch两次，在一个新的协程中调用每个<code class="du kf kg kh ki b">animateTo</code>。如果我们想按顺序运行动画<strong class="jk ht"/>，我们可以改变上面的<code class="du kf kg kh ki b">LaunchedEffect</code>块来使用相同的协程:</p><figure class="kj kk kl km fd hj"><div class="bz dy l di"><div class="kn ko l"/></div></figure><p id="2880" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在同一个协程中运行动画将暂停线程，直到<code class="du kf kg kh ki b">angle.animateTo()</code>完成运行，然后<code class="du kf kg kh ki b">color.animateTo()</code>将运行。关于使用协同程序制作动画的更多细节——请看这个<a class="ae ke" href="https://youtu.be/Z_T1bVjhMLk?t=552" rel="noopener ugc nofollow" target="_blank">视频</a>。</p><p id="52d5" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">最后剩下的就是用这两个属性画点东西了！画布✏️<code class="du kf kg kh ki b">onDraw</code>函数使用动画值— <code class="du kf kg kh ki b">angle.value</code>和<code class="du kf kg kh ki b">color.value</code>来旋转和设置圆角矩形的颜色。当这些值改变时，自动组合<strong class="jk ht">重新绘制</strong>。我们不需要叫<code class="du kf kg kh ki b">invalidate</code>。</p><figure class="kj kk kl km fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es ku"><img src="../Images/3d85d1a3ca80d45d8c295417b301a5dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*tyPb6VTAXQKZSzMNBpX2Gw.gif"/></div></div></figure><p id="6e85" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">就是这样！使用<code class="du kf kg kh ki b">Animatable</code>，我们可以像以前使用<code class="du kf kg kh ki b">ValueAnimator</code>一样实现自定义动画。与<code class="du kf kg kh ki b">ValueAnimator</code>方法相比，我们使用Compose版本实现了可读性更好的版本和更少的代码行。</p><p id="2077" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">如果更少的代码还不能说服你…使用<code class="du kf kg kh ki b"><a class="ae ke" href="https://developer.android.com/reference/kotlin/androidx/compose/animation/core/KeyframesSpec" rel="noopener ugc nofollow" target="_blank">keyframes</a></code>可能是真正的抽卡。Compose中的关键帧使您能够以特定的时间间隔更改动画的关键部分(帧)。</p><p id="028b" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">例如，如果我们想在动画的某些点设置特定的动画颜色，我们可以执行以下操作:</p><figure class="kj kk kl km fd hj"><div class="bz dy l di"><div class="kn ko l"/></div></figure><p id="afb9" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">上面的例子创建了一个<code class="du kf kg kh ki b">keyframes</code> <code class="du kf kg kh ki b">AnimationSpec</code>对象，并为其提供了不同的颜色，这些颜色应该以特定的时间间隔和特定的缓动曲线来动画化。</p><figure class="kj kk kl km fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es ku"><img src="../Images/3a2736144127bc8056f5d0ece3a48bf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*qqhs0Rl5EzqCTfvD6JaD6Q.gif"/></div></div></figure><p id="58e1" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">值得注意的是<code class="du kf kg kh ki b">Animatable</code>是由Compose提供的低级动画API，许多更高级的便利API都是基于<code class="du kf kg kh ki b">Animatable</code>之上的。例如，<code class="du kf kg kh ki b">animateColorAsState()</code>使用<code class="du kf kg kh ki b">TwoWayConverter</code>将上面的颜色转换逻辑包装起来。<code class="du kf kg kh ki b">animateFloatAsState()</code>也可用于制作角度动画。<code class="du kf kg kh ki b">animate*AsState</code>API允许你根据状态变化独立制作动画，而<code class="du kf kg kh ki b">Animatable</code>提供了更多的灵活性和对动画的控制:允许协调动画、由手势触发的不确定动画等。</p><p id="15ff" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">更真实的例子，请看<a class="ae ke" href="https://github.com/android/compose-samples/tree/main/Crane" rel="noopener ugc nofollow" target="_blank"> Crane示例</a>中的自定义日期选择药丸动画。</p><figure class="kj kk kl km fd hj er es paragraph-image"><div class="er es kp"><img src="../Images/79ced4c84ba4c191f1f0cd6744d60edf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*1tM6HBdXMmmohY2YQCEklA.gif"/></div></figure><p id="f171" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">有关Compose中不同种类动画的更多信息，请查看Github上的<a class="ae ke" href="https://developer.android.com/jetpack/compose/animation" rel="noopener ugc nofollow" target="_blank">动画文档</a>、<a class="ae ke" href="https://developer.android.com/codelabs/jetpack-compose-animation#0" rel="noopener ugc nofollow" target="_blank">动画代码实验室</a>或<a class="ae ke" href="https://github.com/android/animation-samples/tree/main/MotionCompose" rel="noopener ugc nofollow" target="_blank">运动合成示例</a>以获取更多示例。</p><p id="c588" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在Twitter <a class="ae ke" href="https://twitter.com/riggaroo" rel="noopener ugc nofollow" target="_blank"> @riggaroo </a>上与我分享你值得流口水的动画。</p><p id="8e09" class="pw-post-body-paragraph ji jj hs jk b jl jm it jn jo jp iw jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">再见了。👋</p></div></div>    
</body>
</html>