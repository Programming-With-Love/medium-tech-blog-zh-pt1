<html>
<head>
<title>Handling Permissions with DialogFlow and Actions On Google</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google上的DialogFlow和Actions处理权限</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/handling-permissions-with-dialogflow-and-actions-on-google-b08c8f228c00?source=collection_archive---------0-----------------------#2017-10-22">https://medium.com/google-developer-experts/handling-permissions-with-dialogflow-and-actions-on-google-b08c8f228c00?source=collection_archive---------0-----------------------#2017-10-22</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/1637a79475efafae5c368e76f98f610c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uK2MjOjd-HUvJUvbAheNcA.png"/></div></div></figure><div class=""/><blockquote class="ip iq ir"><p id="0376" class="is it iu iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv ht">更新2019:本博客中使用的代码示例显示了已被弃用的SDK v1。SDK v2迁移流程请参考</strong> <a class="ae jr" href="https://developers.google.com/actions/reference/nodejs/lib-v1-migration" rel="noopener ugc nofollow" target="_blank"> <strong class="iv ht">此链接</strong> </a> <strong class="iv ht">。如有疑问，请在</strong> <a class="ae jr" href="https://stackoverflow.com/questions/tagged/actions-on-google" rel="noopener ugc nofollow" target="_blank"> <strong class="iv ht">栈溢出</strong> </a> <strong class="iv ht">或</strong> <a class="ae jr" href="https://g.co/actionsdev" rel="noopener ugc nofollow" target="_blank"> <strong class="iv ht"> Google+社区</strong> </a> <strong class="iv ht">上发帖。</strong></p></blockquote><p id="851b" class="pw-post-body-paragraph is it hs iv b iw ix iy iz ja jb jc jd js jf jg jh jt jj jk jl ju jn jo jp jq ha bi translated">在为Google Assistant构建操作时，为了提供丰富的用户体验，您可能需要获取用户的姓名或位置。因为我经常被问到这个问题，所以我认为向您介绍处理这个用例的必要步骤会很有趣。让我们开始吧。</p><p id="14e6" class="pw-post-body-paragraph is it hs iv b iw ix iy iz ja jb jc jd js jf jg jh jt jj jk jl ju jn jo jp jq ha bi translated">要获取她保存在谷歌账户上的用户名或位置，你需要请求她授予你访问权限；为此，你需要和她交谈，问她你需要获取什么样的信息。</p><p id="02d0" class="pw-post-body-paragraph is it hs iv b iw ix iy iz ja jb jc jd js jf jg jh jt jj jk jl ju jn jo jp jq ha bi translated">让我们先写下用户“莉莉娅”和行动“R2D2”之间的对话“快乐之路”:</p><ul class=""><li id="b706" class="jv jw hs iv b iw ix ja jb js jx jt jy ju jz jq ka kb kc kd bi translated">莉莉娅:让R2D2找到我</li><li id="0fde" class="jv jw hs iv b iw ke ja kf js kg jt kh ju ki jq ka kb kc kd bi translated">R2D2:要找到你，我只需要从谷歌上得到你的街道地址。可以吗？</li><li id="09a5" class="jv jw hs iv b iw ke ja kf js kg jt kh ju ki jq ka kb kc kd bi translated">莉莉娅:当然</li><li id="054d" class="jv jw hs iv b iw ke ja kf js kg jt kh ju ki jq ka kb kc kd bi translated">R2D2:你现在位于美国加利福尼亚州山景城谷歌总部。</li></ul><p id="3b61" class="pw-post-body-paragraph is it hs iv b iw ix iy iz ja jb jc jd js jf jg jh jt jj jk jl ju jn jo jp jq ha bi translated">现在，让我们打开<a class="ae jr" href="https://dialogflow.com" rel="noopener ugc nofollow" target="_blank">对话流</a>来设计这个对话。</p><h1 id="d41b" class="kj kk hs bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">TL；dr；</h1><p id="7e95" class="pw-post-body-paragraph is it hs iv b iw lh iy iz ja li jc jd js lj jg jh jt lk jk jl ju ll jo jp jq ha bi translated">你着急吗？以下是处理权限工作流要遵循的步骤:</p><ol class=""><li id="2622" class="jv jw hs iv b iw ix ja jb js jx jt jy ju jz jq lm kb kc kd bi translated">创建一个将由DialogFlow触发的意图，其角色是向您的应用程序发送一个操作。</li><li id="88bb" class="jv jw hs iv b iw ke ja kf js kg jt kh ju ki jq lm kb kc kd bi translated">在您的应用程序中，使用<a class="ae jr" href="https://developers.google.com/actions/reference/nodejs/AssistantApp#askForPermission" rel="noopener ugc nofollow" target="_blank"> askForPermission </a>()助手让Google上的操作询问用户允许或拒绝您的应用程序访问她的私人信息。</li><li id="5f65" class="jv jw hs iv b iw ke ja kf js kg jt kh ju ki jq lm kb kc kd bi translated">创建将由“<strong class="iv ht">actions _ intent _ PERMISSION</strong>”特殊事件触发的第二个意图，其作用是向您的应用程序发送一个操作。</li><li id="8fc4" class="jv jw hs iv b iw ke ja kf js kg jt kh ju ki jq lm kb kc kd bi translated">在您的应用程序中，使用<a class="ae jr" href="https://developers.google.com/actions/reference/nodejs/AssistantApp#isPermissionGranted" rel="noopener ugc nofollow" target="_blank"> isPermissionGranted </a>()助手来检查用户的响应。使用正确的助手访问用户的信息。</li></ol></div><div class="ab cl ln lo go lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ha hb hc hd he"><h1 id="7514" class="kj kk hs bd kl km lu ko kp kq lv ks kt ku lw kw kx ky lx la lb lc ly le lf lg bi translated">在DialogFlow中设计对话</h1><p id="5cac" class="pw-post-body-paragraph is it hs iv b iw lh iy iz ja li jc jd js lj jg jh jt lk jk jl ju ll jo jp jq ha bi translated">为了询问并访问用户的位置，我们需要创建两个意图:</p><ol class=""><li id="cbb3" class="jv jw hs iv b iw ix ja jb js jx jt jy ju jz jq lm kb kc kd bi translated"><strong class="iv ht"> request_permission </strong>:当用户询问位置时，会触发这个意图。</li><li id="c8e1" class="jv jw hs iv b iw ke ja kf js kg jt kh ju ki jq lm kb kc kd bi translated"><strong class="iv ht"> user_info </strong>:这一意图将由谷歌上的Actions(阅读下文)的一个特殊事件触发。</li></ol><figure class="ma mb mc md fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es lz"><img src="../Images/30c4e5e460eb0256385f798b6a86855d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ICx04n2-gUAHZvnkTiLIpg.png"/></div></div></figure><p id="3f1f" class="pw-post-body-paragraph is it hs iv b iw ix iy iz ja jb jc jd js jf jg jh jt jj jk jl ju jn jo jp jq ha bi translated">下面是这个演示应用程序的服务器端代码(使用Firebase 的<a class="ae jr" href="https://firebase.google.com/docs/functions/" rel="noopener ugc nofollow" target="_blank">云函数):</a></p><figure class="ma mb mc md fd hj"><div class="bz dy l di"><div class="me mf l"/></div></figure></div><div class="ab cl ln lo go lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ha hb hc hd he"><h2 id="707e" class="mg kk hs bd kl mh mi mj kp mk ml mm kt js mn mo kx jt mp mq lb ju mr ms lf mt bi translated">“请求许可”意图</h2><p id="3e94" class="pw-post-body-paragraph is it hs iv b iw lh iy iz ja li jc jd js lj jg jh jt lk jk jl ju ll jo jp jq ha bi translated">在这个意图中，我们将提供一组示例话语，DialogFlow将使用这些示例话语来匹配和触发这个意图，即:“找到我的位置”或“定位我”。</p><p id="4955" class="pw-post-body-paragraph is it hs iv b iw ix iy iz ja jb jc jd js jf jg jh jt jj jk jl ju jn jo jp jq ha bi translated">一旦这个意图被触发，我们将向我们的应用程序发送一个名为"<strong class="iv ht"> request_permission </strong>"的动作。您可以随意命名此操作；但是要确保在DialogFlow和代码中使用相同的名称。</p><figure class="ma mb mc md fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es lz"><img src="../Images/e34324d5aee412aeaf2db8fdb975da7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JXsY_A1vGpA5gH11MriQdA.png"/></div></div></figure><p id="f706" class="pw-post-body-paragraph is it hs iv b iw ix iy iz ja jb jc jd js jf jg jh jt jj jk jl ju jn jo jp jq ha bi translated">在应用程序端，我们将注册由DialogFlow发送的"<strong class="iv ht"> request_permission </strong>"操作。我们将使用这个动作来调用<a class="ae jr" href="https://developers.google.com/actions/reference/nodejs/AssistantApp#askForPermission" rel="noopener ugc nofollow" target="_blank">askForPermission</a>helper方法，提供我们想要访问权限的原因，即:“<strong class="iv ht">来定位您</strong>”，以及<a class="ae jr" href="https://developers.google.com/actions/reference/nodejs/AssistantApp#SupportedPermissions" rel="noopener ugc nofollow" target="_blank">DEVICE _ PRECISE _ LOCATION</a>权限。请参见下面代码中的第8–10行:</p><figure class="ma mb mc md fd hj"><div class="bz dy l di"><div class="me mf l"/></div></figure><blockquote class="ip iq ir"><p id="9de7" class="is it iu iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">调用这个方法将发送一个<strong class="iv ht">PLACEHOLDER _ FOR _ PERMISSION</strong>响应到Google上的动作，这将触发"<strong class="iv ht">来定位你，我只需要从Google上获得你的街道地址。可以吗？</strong>消息。</p></blockquote></div><div class="ab cl ln lo go lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ha hb hc hd he"><h2 id="0ae4" class="mg kk hs bd kl mh mi mj kp mk ml mm kt js mn mo kx jt mp mq lb ju mr ms lf mt bi translated">“用户信息”的意图</h2><p id="d2e3" class="pw-post-body-paragraph is it hs iv b iw lh iy iz ja li jc jd js lj jg jh jt lk jk jl ju ll jo jp jq ha bi translated">当用户回答问题:“<strong class="iv ht">要找到你，我只需要从谷歌得到你的街道地址就可以了。可以吗？</strong>”。</p><p id="d673" class="pw-post-body-paragraph is it hs iv b iw ix iy iz ja jb jc jd js jf jg jh jt jj jk jl ju jn jo jp jq ha bi translated">事实上，当Actions On Google问这个问题，用户回答“是”或“否”(同意或拒绝)；Google上的Actions将向DialogFlow发送一个名为“<strong class="iv ht">actions _ intent _ PERMISSION</strong>”的事件。我们将利用这一事件来触发这一特定意图。一旦意图被触发，我们将确保向我们的应用程序发送“<strong class="iv ht"> user_info </strong>”动作。</p><figure class="ma mb mc md fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es lz"><img src="../Images/372dfa5705f81a012271e5269278ed0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aAAbTLgGRWodLrr4xk4Xaw.png"/></div></div></figure><p id="5d21" class="pw-post-body-paragraph is it hs iv b iw ix iy iz ja jb jc jd js jf jg jh jt jj jk jl ju jn jo jp jq ha bi translated">在应用程序中，我们将注册“user_info”操作，并确保检查用户是授予还是拒绝权限。为此，我们调用<a class="ae jr" href="https://developers.google.com/actions/reference/nodejs/AssistantApp#isPermissionGranted" rel="noopener ugc nofollow" target="_blank"> isPermissionGranted </a>助手方法。我们还使用<a class="ae jr" href="https://developers.google.com/actions/reference/nodejs/AssistantApp#getDeviceLocation" rel="noopener ugc nofollow" target="_blank"> getDeviceLocation </a>方法从Google访问用户的位置。请参见下面代码中的第12–27行:</p><figure class="ma mb mc md fd hj"><div class="bz dy l di"><div class="me mf l"/></div></figure><h1 id="3c9a" class="kj kk hs bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">好了</h1><p id="c24a" class="pw-post-body-paragraph is it hs iv b iw lh iy iz ja li jc jd js lj jg jh jt lk jk jl ju ll jo jp jq ha bi translated">您可以在动作模拟中测试您的动作:</p><figure class="ma mb mc md fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es lz"><img src="../Images/72d109a35f51139388662cc70184b9bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DPgbM3Xfow26Z2OjKmu-7g.png"/></div></div></figure><h1 id="fffa" class="kj kk hs bd kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg bi translated">奖金</h1><p id="8be4" class="pw-post-body-paragraph is it hs iv b iw lh iy iz ja li jc jd js lj jg jh jt lk jk jl ju ll jo jp jq ha bi translated">你知道吗？您可以通过Firebase的云功能在DialogFlow中直接构建和管理实现。因此，只需在内联编辑器中使用上面提供的代码，然后点击deploy。现在，您已经准备好为Google Assistant测试您的操作。</p><figure class="ma mb mc md fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es lz"><img src="../Images/2ce44cfd8e82880b6607e1493442831b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A3a1trBNmNzN17aJQxgvkA.png"/></div></div></figure></div><div class="ab cl ln lo go lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ha hb hc hd he"><p id="7e65" class="pw-post-body-paragraph is it hs iv b iw ix iy iz ja jb jc jd js jf jg jh jt jj jk jl ju jn jo jp jq ha bi translated"><em class="iu">在Twitter上关注我</em><a class="ae jr" href="https://twitter.com/manekinekko" rel="noopener ugc nofollow" target="_blank"><em class="iu">@ manekinekko</em></a><em class="iu">了解更多关于助手和web平台的信息。</em></p></div></div>    
</body>
</html>