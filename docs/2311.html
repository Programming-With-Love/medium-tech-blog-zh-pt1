<html>
<head>
<title>Today I Learned: Storing Emoji to Mysql with Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">今天我学习了:用Golang将表情符号存储到Mysql</h1>
<blockquote>原文：<a href="https://medium.easyread.co/today-i-learned-storing-emoji-to-mysql-with-golang-204a093454b7?source=collection_archive---------0-----------------------#2018-06-04">https://medium.easyread.co/today-i-learned-storing-emoji-to-mysql-with-golang-204a093454b7?source=collection_archive---------0-----------------------#2018-06-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="894e" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">一个简单而愚蠢的故事，关于我们今天的小虫子。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/3258b936062038a115aad0b16b8ac460.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ELZJStuoVnqb-Y3duIrH0Q.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">monocle emoji from google image search</figcaption></figure><p id="5728" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">今天，我和我的团队在<a class="ae lo" href="http://kurio.co/article-feed" rel="noopener ugc nofollow" target="_blank"> Kurio </a>，有一点有趣的时刻，但也有一些愚蠢的事情。当我们试图通过我们新的简单的CRUD API服务将表情符号存储到Mysql中时，就会发生这种情况。</p><p id="d395" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">我们正在制作一个供我们的内容团队使用的内部服务，只是一个简单的CRUD。栈只是:Angular + Golang + Mysql。</p><p id="73fa" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">这些服务已经部署到产品中，并且已经被我们的内容团队使用。一切正常，因为从staging到发布都已经测试过了。直到，当我们的一个内容团队开始存储一个项目到这个服务，有效载荷有一些表情符号。这时我们意识到这个愚蠢的错误。</p><p id="3a72" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">有效载荷看起来更像这样:</p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="47e4" class="lu lv in lq b gy lw lx l ly lz">{<br/>        "type": "text",<br/>        "text": "😈🤠 Lorem Ipsum Dolor sit Amet 😱",<br/>        "color": "#FFFFFF"<br/>}</span></pre><p id="0323" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">并返回关于要存储的值不正确的错误。</p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="5e1b" class="lu lv in lq b gy lw lx l ly lz">"Number": 1366<br/>"Message": "Incorrect string value: '\\xF0\\x9F\\x98\\x88 \\xF0...' for column 'text' at row 1"</span></pre><p id="29d0" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">幸运的是，这个服务是供我们的内容团队内部使用的，用户负载不是很大，所以还是可以忍受的😈。我无法想象如果我们把这个发布给真正的用户会发生什么。</p><h1 id="d097" class="ma lv in bd mb mc md me mf mg mh mi mj jt mk ju ml jw mm jx mn jz mo ka mp mq bi translated">解决问题</h1><p id="b8d4" class="pw-post-body-paragraph ks kt in ku b kv mr jo kx ky ms jr la lb mt ld le lf mu lh li lj mv ll lm ln ig bi translated">为了解决这个问题，我们做了几件与这个问题相关的事情。</p><ul class=""><li id="fa0f" class="mw mx in ku b kv kw ky kz lb my lf mz lj na ln nb nc nd ne bi translated">更改数据库的字符集编码和排序规则</li><li id="eae4" class="mw mx in ku b kv nf ky ng lb nh lf ni lj nj ln nb nc nd ne bi translated">将连接驱动程序的字符集编码和排序从我们的应用程序(Golang)更改为Mysql服务器</li></ul><h2 id="0dad" class="lu lv in bd mb nk nl dn mf nm nn dp mj lb no np ml lf nq nr mn lj ns nt mp nu bi translated">更改数据库编码字符集和排序规则</h2><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/c4b92449546269ee77e43bc9b509d2d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:570/format:webp/1*SUVbutxte_c_IcwzOc2HUQ.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">our default charset before changed</figcaption></figure><p id="dbe9" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">我们使用Mysql 5.7并使用<code class="fe nw nx ny lq b">utf-8</code>作为我们的字符集。在我们修复此问题后，不推荐使用此选项。</p><p id="37b4" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">所以解决方案是，我们将我们的字符集和排序规则改为<code class="fe nw nx ny lq b">utf8mb4</code>，因为Mysql中的<code class="fe nw nx ny lq b">utf-8</code>通常不完全支持所有的<code class="fe nw nx ny lq b">utf-8</code>编码。如果我们想要一个完全支持所有<code class="fe nw nx ny lq b">utf-8</code>的通用，我们必须使用<code class="fe nw nx ny lq b">utf8mb4</code>。</p><p id="178b" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">要更改整个数据库的字符集和排序规则:</p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="4c18" class="lu lv in lq b gy lw lx l ly lz">ALTER DATABASE<br/>    database_name<br/>    CHARACTER SET = utf8mb4<br/>    COLLATE = utf8mb4_unicode_ci;</span></pre><p id="326b" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">要更改整个特定表的字符集和排序规则</p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="8d32" class="lu lv in lq b gy lw lx l ly lz">ALTER TABLE<br/>    table_name<br/>    CONVERT TO CHARACTER SET utf8mb4<br/>    COLLATE utf8mb4_unicode_ci;</span></pre><p id="d93d" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">所以在做了这个之后，我们认为我们已经解决了我们的问题。但是，在我们再次测试之后，我们仍然没有修复它。它仍然返回同样的错误。</p><h2 id="0aea" class="lu lv in bd mb nk nl dn mf nm nn dp mj lb no np ml lf nq nr mn lj ns nt mp nu bi translated">更改Mysql驱动程序中的连接字符集</h2><p id="3647" class="pw-post-body-paragraph ks kt in ku b kv mr jo kx ky ms jr la lb mt ld le lf mu lh li lj mv ll lm ln ig bi translated">看了更多的文章和stackoverflow等论坛的一些问答。不仅仅是数据库，我们还需要改变连接的驱动字符集和排序规则。因为我们开发的这个服务是基于Golang (1.10)构建的，并且我们使用包<code class="fe nw nx ny lq b">github.com/go-sql-driver/mysql</code>作为我们的驱动程序，所以我们只需要对我们的dsn做一些修改。</p><p id="42a0" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated"><strong class="ku io">之前:</strong></p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="1667" class="lu lv in lq b gy lw lx l ly lz">dsn := `root:root@tcp(127.0.0.1 :3306)/DB_NAME?parseTime=1&amp;loc=Asia%2FJakarta`</span><span id="cbc3" class="lu lv in lq b gy nz lx l ly lz">dbConn, _:= sql.Open(`mysql`, dsn)</span></pre><p id="8964" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated"><strong class="ku io">之后:</strong></p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="af51" class="lu lv in lq b gy lw lx l ly lz">dsn :=`root:root@tcp(127.0.0.1 :3306)/DB_NAME?parseTime=1&amp;loc=Asia%2FJakarta<strong class="lq io">&amp;charset=utf8mb4&amp;collation=utf8mb4_unicode_ci`</strong></span><span id="4506" class="lu lv in lq b gy nz lx l ly lz">dbConn, _:= sql.Open(`mysql`, dsn)</span></pre><p id="973d" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">嗯，这样做了之后，现在我们的服务运行良好，可以接受任何表情符号字符。</p><h2 id="2b7e" class="lu lv in bd mb nk nl dn mf nm nn dp mj lb no np ml lf nq nr mn lj ns nt mp nu bi translated">结论</h2><p id="bf5e" class="pw-post-body-paragraph ks kt in ku b kv mr jo kx ky ms jr la lb mt ld le lf mu lh li lj mv ll lm ln ig bi translated">这个bug不算太大，说实话，是个傻傻的搞笑bug。但是看起来每个人都掉进过这个陷阱😥。但是今天我学到了一些东西，我们在创建数据库时应该小心，不管它是什么类型(RDBMS，NoSQL)</p><p id="91a0" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated"><strong class="ku io">参考文献:</strong></p><ol class=""><li id="eeab" class="mw mx in ku b kv kw ky kz lb my lf mz lj na ln oa nc nd ne bi translated">stackoverflow.com塞尔瓦曼尼P的回答【https://stackoverflow.com/a/39465494 T2】</li><li id="03a3" class="mw mx in ku b kv nf ky ng lb nh lf ni lj nj ln oa nc nd ne bi translated">dba.stackexchange.com的Mathias Bynens的回答<br/>https://dba.stackexchange.com/a/21684的T5</li></ol></div><div class="ab cl ob oc hr od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ig ih ii ij ik"><p id="2758" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">如果你觉得这篇文章有用，或者读起来有趣，请分享到你的网络圈子，或者你可以鼓掌帮助其他人达到这个目的。如果你有任何问题，请在下面回复。</p></div></div>    
</body>
</html>