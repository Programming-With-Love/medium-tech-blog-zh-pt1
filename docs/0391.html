<html>
<head>
<title>Improving build speed in Android Studio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">提高Android Studio的构建速度</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/improving-build-speed-in-android-studio-3e1425274837?source=collection_archive---------2-----------------------#2019-03-21">https://medium.com/androiddevelopers/improving-build-speed-in-android-studio-3e1425274837?source=collection_archive---------2-----------------------#2019-03-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="3094" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated"><em class="jd">由Android Studio产品经理Leo Sei发布</em></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/995fc97e2bc5a6e7e5e72cdd36ff0c10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_aiGAO6qGx71h8VOZpo2ww.png"/></div></div></figure><h1 id="16ae" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">提高构建速度</h1><p id="4c7c" class="pw-post-body-paragraph if ig hh ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc ha bi translated">在Android studio中，我们希望让您成为最高效的开发人员。从与开发人员的各种讨论和调查中，我们知道等待缓慢的构建速度会降低生产率。</p><p id="d8c1" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">在本文中，我们将分享一些新的分析方法，以更好地找出真正影响构建速度的因素，并分享更多关于我们对此所做的工作，以及您现在可以做些什么来帮助防止您的构建速度变慢。</p><p id="372c" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated"><em class="jd"> *这是可能的，这要感谢许多开发者选择在“首选项&gt;数据共享”</em>中与我们共享他们的使用统计数据</p><h1 id="f12a" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">以不同方式测量速度</h1><p id="2b7e" class="pw-post-body-paragraph if ig hh ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc ha bi translated">我们做的第一件事是使用开源项目(<a class="ae kt" href="https://github.com/signalapp/Signal-Android/archive/v4.19.1.zip" rel="noopener ugc nofollow" target="_blank"> SignalAndroid </a>、<a class="ae kt" href="https://github.com/inorichi/tachiyomi/archive/014bb2f42634765ae2fec487cf3b8dc779f23f7b.zip" rel="noopener ugc nofollow" target="_blank"> Tachiyomi </a>、<a class="ae kt" href="https://github.com/google/santa-tracker-android" rel="noopener ugc nofollow" target="_blank"> SantaTracker </a>、<a class="ae kt" href="https://github.com/kageiit/android-studio-gradle-test.git" rel="noopener ugc nofollow" target="_blank">优步</a>的&amp;框架)创建内部基准*来衡量项目的各种变更(代码、资源、清单等)对构建速度的影响。</p><p id="0368" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">例如，这是一个查看代码更改对构建速度影响的基准测试，显示出随着时间的推移有了很大的改进。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ku"><img src="../Images/733360b04a969c3f16f0482c5e2eed85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HgKjMF_Usu73_ihR"/></div></div></figure><p id="7333" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">我们还查看了“真实世界”的数据，重点关注了Android Gradle插件升级前后的几个调试版本的构建速度。我们用它来代表新版本的实际改进。</p><p id="42cd" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">这显示了新版本的显著改进**，<strong class="ih hi">自2.3版本以来，帮助减少了近50%的构建时间。</strong></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kv"><img src="../Images/97747c53fdf4023ea78adf434019ca60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*l55G21vNHzBc-D7D"/></div></div></figure><p id="b2a1" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">最后，我们看了构建时间随时间的演变，不管版本如何。我们用它来代表你的实际构建速度。可悲的是，这表明构建速度正在随着时间的推移而变慢。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kw"><img src="../Images/f844da1354a5a70faf4c608ccaf2703e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6_PsXttatVBSBJdd"/></div></div></figure><p id="d1ac" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">如果构建确实随着每个版本变得越来越快，并且我们可以在我们的数据中看到，为什么随着时间的推移它们仍然变得越来越慢？</p><p id="28fe" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">我们挖得更深一点，意识到在我们的生态系统中发生的事情正在导致建设速度慢于我们可以改善的速度。</p><p id="34a5" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">虽然我们知道随着时间的推移，项目的增长——更多的代码、更多的资源使用、更多的语言特性——使构建变得更慢，但我们也发现有许多其他因素超出了我们的直接控制:</p><ol class=""><li id="628e" class="kx ky hh ih b ii ij im in iq kz iu la iy lb jc lc ld le lf bi translated"><a class="ae kt" href="https://meltdownattack.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hi"> Spectre和Meltdown</strong></a><strong class="ih hi">2017年末的补丁</strong>对新进程和I/O产生了一些影响，将清理构建速度减慢了50%到140%之间。</li><li id="567e" class="kx ky hh ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated"><strong class="ih hi">第三方&amp;定制Gradle插件</strong> : 96%的Android Studio开发者使用一些额外的Gradle插件(其中一些可能没有使用<a class="ae kt" href="https://developer.android.com/studio/build/optimize-your-build" rel="noopener ugc nofollow" target="_blank">最新的最佳实践</a>)。</li><li id="725c" class="kx ky hh ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated">大多数使用的<strong class="ih hi">注释处理器是非增量的</strong>，导致每次编辑时都要重新编译代码。</li><li id="799e" class="kx ky hh ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated"><strong class="ih hi">使用Java 8 </strong>语言特性会导致去糖，这会影响构建时间。然而，我们已经减轻了D8的脱糖影响。</li><li id="a04c" class="kx ky hh ih b ii lg im lh iq li iu lj iy lk jc lc ld le lf bi translated"><strong class="ih hi">使用Kotlin </strong>，尤其是Kotlin (KAPT)中的注释处理，也会影响构建性能。我们正在继续与JetBrains合作，以尽量减少对这里的影响。</li></ol><p id="0312" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">与现实世界的项目不同，这些项目不会随着时间的推移而增长。基准测试模拟变化，然后撤销它们，只是为了测量我们的插件随时间的影响。</p><p id="1bd3" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated"><em class="jd"> ** 3.3专注于未来改进的基础工作(例如，命名空间资源、增量注释处理器支持、分级工人)，因此实现了0%的改进。</em></p><h1 id="2f1d" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">我们在做什么？</h1><h2 id="68b1" class="ll jr hh bd js lm ln lo jw lp lq lr ka iq ls lt ke iu lu lv ki iy lw lx km ly bi translated"><em class="ie">修正内部流程&amp;持续绩效改进</em></h2><p id="d40c" class="pw-post-body-paragraph if ig hh ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc ha bi translated">我们也承认，许多问题来自谷歌拥有/推广的功能，我们已经改变了内部流程，以更好地在发布流程的早期发现构建回归。</p><p id="01f2" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">我们也在努力使<a class="ae kt" href="https://developer.android.com/studio/build/optimize-your-build#annotation_processors" rel="noopener ugc nofollow" target="_blank">注释处理器增加</a>。在这篇文章中，Glide，Dagger和Auto Service是增量服务，我们正在开发其他服务。</p><p id="c496" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">我们还在最近的版本中包含了R light类生成、lazy task和worker API，并继续与Gradle inc .和JetBrains合作，以继续提高整体构建性能。</p><h2 id="0bfa" class="ll jr hh bd js lm ln lo jw lp lq lr ka iq ls lt ke iu lu lv ki iy lw lx km ly bi translated"><em class="ie">归因工具</em></h2><p id="4bcd" class="pw-post-body-paragraph if ig hh ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc ha bi translated">最近的一项调查显示，大约60%的开发人员不分析构建影响，或者不知道如何分析。因此，我们希望改进Android studio中的工具，以提高社区中关于构建时间影响的意识和透明度。</p><p id="f4d9" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">我们正在探索如何更好地在Android Studio中直接提供关于插件和任务对构建时间的影响的信息。</p><h1 id="b3b7" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">你今天能做什么</h1><p id="8a49" class="pw-post-body-paragraph if ig hh ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc ha bi translated">虽然配置时间可能因变体、模块和其他因素的数量而异，但我们希望分享来自“真实世界”数据的与<strong class="ih hi"> Android Gradle插件</strong>相关的配置时间，作为参考点</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kw"><img src="../Images/e3b90b88939a91710498c9dbc8f26f20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-ArOM3hHce2x6Xsl"/></div></div></figure><p id="c388" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">如果你发现你的配置时间很慢，你可能有自定义构建逻辑(或第三方Gradle插件)影响你的配置时间。</p><h2 id="eae0" class="ll jr hh bd js lm ln lo jw lp lq lr ka iq ls lt ke iu lu lv ki iy lw lx km ly bi translated"><em class="ie">使用的工具</em></h2><p id="4944" class="pw-post-body-paragraph if ig hh ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc ha bi translated">Gradle提供了一套<strong class="ih hi">免费的</strong> <a class="ae kt" href="https://guides.gradle.org/performance/" rel="noopener ugc nofollow" target="_blank">工具</a>来帮助分析你的构建中正在发生的事情。</p><p id="bf93" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">我们建议您使用<a class="ae kt" href="https://guides.gradle.org/performance/#build_scans" rel="noopener ugc nofollow" target="_blank"> Gradle scan </a>，它提供了关于您的构建的最多信息。如果将一些构建信息上传到Gradle服务器是一个问题，你可以使用<a class="ae kt" href="https://guides.gradle.org/performance/#profile_report" rel="noopener ugc nofollow" target="_blank"> Gradle profiler </a>，它提供的信息比scan少，但是把所有东西都保存在本地。</p><p id="d06b" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated"><em class="jd">注意:构建扫描对调查配置延迟没有帮助。对于那些你可能想使用传统的JVM分析器</em></p><h2 id="bc46" class="ll jr hh bd js lm ln lo jw lp lq lr ka iq ls lt ke iu lu lv ki iy lw lx km ly bi translated">优化您的构建配置和任务</h2><p id="1022" class="pw-post-body-paragraph if ig hh ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc ha bi translated">当您研究构建速度时，这里有一些需要注意的最佳实践。您也可以随时查看我们的<a class="ae kt" href="https://developer.android.com/studio/build/optimize-your-build" rel="noopener ugc nofollow" target="_blank">最新最佳实践</a>。</p><p id="3ed3" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">配置</p><ul class=""><li id="dc43" class="kx ky hh ih b ii ij im in iq kz iu la iy lb jc lz ld le lf bi translated">只使用配置来设置任务(用lazy API)，避免做任何I/O或任何其他工作。(配置不适合查询git、读取文件、搜索连接的设备、进行计算等)</li><li id="10d8" class="kx ky hh ih b ii lg im lh iq li iu lj iy lk jc lz ld le lf bi translated">在配置中设置所有任务。配置不知道实际构建了什么。</li></ul><p id="fc26" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">优化任务</p><ul class=""><li id="1d80" class="kx ky hh ih b ii ij im in iq kz iu la iy lb jc lz ld le lf bi translated">确保每个任务都声明了输入/输出(即使是非文件)，并且是增量的和可缓存的。</li><li id="1cd1" class="kx ky hh ih b ii lg im lh iq li iu lj iy lk jc lz ld le lf bi translated">将复杂的步骤分解成多个任务，以提高增量和可缓存性。<br/>(一些任务可以是最新的，而其他任务可以并行执行或运行)。</li><li id="0236" class="kx ky hh ih b ii lg im lh iq li iu lj iy lk jc lz ld le lf bi translated">确保任务不会写入或删除其他任务输出</li><li id="b31b" class="kx ky hh ih b ii lg im lh iq li iu lj iy lk jc lz ld le lf bi translated">在plugin/buildSrc中用Java/Kotlin编写任务，而不是直接在build.gradle中用groovy编写。</li></ul><p id="695d" class="pw-post-body-paragraph if ig hh ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc ha bi translated">我们关心您作为开发人员的生产力。随着我们继续努力使构建更快，希望这里的提示和指南将帮助您缩短构建时间，以便您可以更专注于开发令人惊叹的应用程序。</p></div></div>    
</body>
</html>