<html>
<head>
<title>Best Practices for Using AWS DMS for SQL Server Replication</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将AWS DMS用于SQL Server复制的最佳实践</h1>
<blockquote>原文：<a href="https://medium.com/capital-one-tech/best-practices-for-using-aws-dms-for-sql-server-replication-570d72a45832?source=collection_archive---------3-----------------------#2021-09-14">https://medium.com/capital-one-tech/best-practices-for-using-aws-dms-for-sql-server-replication-570d72a45832?source=collection_archive---------3-----------------------#2021-09-14</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="3f93" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">如何设置Amazon RDS SQL server持续复制</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/8446eb5bed160feb26c082520f0a5fd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*V4a8d76J1kZEeUqb"/></div></div></figure><p id="986d" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">几年来，Capital One一直在经历云转型，这一旅程<a class="ae ke" href="https://aws.amazon.com/solutions/case-studies/capital-one/" rel="noopener ugc nofollow" target="_blank">在去年我们的数据中心退出</a>时达到高潮。2018年，我在Capital One的团队开始了我们自己的云之旅，将我们的应用程序分解为基于云原生解决方案的多个服务。当时，我们的产品之旅已经到了一个阶段，将我们的数据库从运行在EC2实例上迁移到Amazon RDS是有意义的。</p><p id="c3c3" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">对于高可用性和灾难恢复，我们需要一个读取副本和跨区域复制，但Amazon RDS不支持MS SQL Server 2012中的相同区域读取副本和跨区域复制，我们当时使用的是这两种复制。缺少现成的复制解决方案增加了设计的复杂性。为了找到解决方案，我们集思广益，选择了<a class="ae ke" href="https://aws.amazon.com/dms/" rel="noopener ugc nofollow" target="_blank"> AWS数据库迁移服务</a>(亚马逊DMS)。</p><p id="7687" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi"> <em class="kf">为什么现在讲这个故事？</em> </strong>并不是每个人都在同一个地方与自己云游。许多公司仍在从较老的技术和遗留平台迁移，包括这种服务器类型。我们在三年前解决了这个问题，但认为在迁移曲线的早期阶段与公司分享这个问题可能会有所帮助。在本文中，我将讨论我和我的团队为SQL server跨区域复制开发的Amazon数据库迁移服务的一些最佳实践，这些实践可能对您自己的组织有用。</p><h1 id="aa43" class="kg kh hh bd ki kj kk kl km kn ko kp kq in kr io ks iq kt ir ku it kv iu kw kx bi translated">Amazon数据库迁移服务入门的基本概念</h1><p id="af61" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated"><a class="ae ke" href="https://aws.amazon.com/dms/" rel="noopener ugc nofollow" target="_blank"> AWS数据库迁移服务</a>是一种web服务，旨在将数据从一个数据存储迁移到另一个数据存储。Amazon DMS可用于在同构(例如Oracle到Oracle)和异构(例如Oracle到SQL Server)端点之间移动数据。Amazon DMS也支持多种数据源，并不局限于数据库。基本上，DMS由以下组件组成:</p><ol class=""><li id="409f" class="ld le hh jk b jl jm jo jp jr lf jv lg jz lh kd li lj lk ll bi translated">复制实例</li><li id="4130" class="ld le hh jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll bi translated">端点</li><li id="090b" class="ld le hh jk b jl lm jo ln jr lo jv lp jz lq kd li lj lk ll bi translated">工作</li></ol><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/58d38adfc7cd62faaf6ed2e1b9d31253.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-XATk5v0ctd9V5Dl"/></div></div></figure><p id="e824" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">让我们一个一个地检查这些组件。</p><h2 id="9f65" class="lr kh hh bd ki ls lt lu km lv lw lx kq jr ly lz ks jv ma mb ku jz mc md kw me bi translated">AWS DMS复制实例</h2><p id="66f7" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated">复制实例是一个托管的Amazon弹性计算云，复制任务在其上运行。多个复制任务可以在单个实例上运行。实例类型的选择基于迁移中的表数量以及计划在单个实例上运行的并发复制任务的数量。</p><h2 id="f3a1" class="lr kh hh bd ki ls lt lu km lv lw lx kq jr ly lz ks jv ma mb ku jz mc md kw me bi translated">AWS DMS端点</h2><p id="3aa0" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated">如上图所示，我们有一个源和目标<a class="ae ke" href="https://docs.aws.amazon.com/dms/latest/userguide/CHAP_Endpoints.html" rel="noopener ugc nofollow" target="_blank">端点</a>。端点在数据存储和复制实例之间建立连接。连接信息通常包括端点类型、DB引擎、服务器名称、加密和凭证等。</p><h2 id="f54c" class="lr kh hh bd ki ls lt lu km lv lw lx kq jr ly lz ks jv ma mb ku jz mc md kw me bi translated">亚马逊DMS任务</h2><p id="8d9d" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated"><a class="ae ke" href="https://docs.aws.amazon.com/dms/latest/userguide/CHAP_Tasks.html" rel="noopener ugc nofollow" target="_blank">复制任务</a>设置定义了实际的迁移过程。迁移类型选项包括完全加载、完全加载+变更数据捕获和仅变更数据捕获。</p><h1 id="58bf" class="kg kh hh bd ki kj kk kl km kn ko kp kq in kr io ks iq kt ir ku it kv iu kw kx bi translated">针对Amazon RDS SQL服务器的持续复制解决方案</h1><p id="e42c" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated">对于我们的2018年用例，我们创建了四个运行在SQL Server 2012上的Amazon RDS实例，平均分布在两个地区。Amazon DMS复制任务设置为从一个区域的主实例复制到另一个区域的实例，以实现跨区域复制/读取复制。我们开始使用DMS，一切都很好。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/f4f4d439fe497598f4e39132cea90682.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8W_u4M_b0eAP1wCu"/></div></div></figure><p id="b4f8" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="kf">从此以后，每个人都幸福地生活着，尽管也许不完全诚实。—</em><a class="ae ke" href="https://www.goodreads.com/quotes/1331581-and-everyone-lived-happily-thought-maybe-not-completely-honestly-ever" rel="noopener ugc nofollow" target="_blank"><em class="kf"/></a></p><h1 id="b754" class="kg kh hh bd ki kj kk kl km kn ko kp kq in kr io ks iq kt ir ku it kv iu kw kx bi translated">结束了</h1><p id="5e47" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated">不完全是。:)</p><p id="dad2" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">除了童话，没有什么值得去实现的事情是如此容易。一旦我们的基础设施启动并运行，我们开始观察到同一区域中的实例被100%复制(表和行)。然而，在跨区域实例中，我们观察到行数不匹配。我们的日志和事务数据库差了大约100K行。当我们试图解决这个延迟问题时，我们学到了一些东西。下面是我们在这个过程中学到的一些最佳实践，我想与大家分享一下。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/204959c9314ed8040ffac9e332bd7254.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ifqa1A0oEnikePmM"/></div></div></figure><h1 id="7b97" class="kg kh hh bd ki kj kk kl km kn ko kp kq in kr io ks iq kt ir ku it kv iu kw kx bi translated">最佳实践# 1——测试你的飞行地点</h1><p id="dc10" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated">构建一个测试环境来完善您的迁移策略。在决定最终方法之前，我们的测试环境对于模拟类似生产的负载、测试服务器配置和迁移策略非常有价值。高容量、大型数据库需要在生产部署前进行全面的性能和延迟测试。</p><h1 id="5bcf" class="kg kh hh bd ki kj kk kl km kn ko kp kq in kr io ks iq kt ir ku it kv iu kw kx bi translated">最佳实践#2 —正确使用您的服务器</h1><p id="467d" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated">选择合适的基础架构有助于避免迁移任务中的性能瓶颈。具有正确计算和内存选项的复制服务器至关重要。数据库/表的大小在决定单台复制服务器上运行的并行任务的数量方面起着关键作用。将大型数据库复制任务隔离到运行在多AZ配置上的服务器。</p><h1 id="28b6" class="kg kh hh bd ki kj kk kl km kn ko kp kq in kr io ks iq kt ir ku it kv iu kw kx bi translated">最佳实践#3 —为迁移准备源和目标数据库</h1><p id="248b" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated">Amazon DMS使用<a class="ae ke" href="https://docs.microsoft.com/en-us/sql/relational-databases/track-changes/about-change-data-capture-sql-server?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">变更数据捕获</a>在Microsoft SQL Server中进行持续复制。在完全负载迁移期间，任务会对源数据库执行完全扫描。减少源数据库的负载可以提高性能。将源数据库设置为自动缩放，并设置一个大得多的最大大小限制，有助于避免数据库空间问题。删除在目标数据库上争用写空间的进程。在对目标数据库进行完全加载之前，关闭备份，更改数据捕获、触发器和外键约束。对于正在进行的复制，它们可以在以后打开。</p><h1 id="bf2c" class="kg kh hh bd ki kj kk kl km kn ko kp kq in kr io ks iq kt ir ku it kv iu kw kx bi translated">最佳实践#4 —监控迁移任务</h1><p id="fb5a" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated">主机、复制服务器和表的指标可用。<a class="ae ke" href="https://aws.amazon.com/premiumsupport/knowledge-center/table-statistics-aws-dms-task/" rel="noopener ugc nofollow" target="_blank">表统计数据</a>提供了关于装载的行数的信息。结合Amazon CloudWatch指标来验证源和目标之间的行的查询有助于完善迁移策略。</p><h1 id="e26f" class="kg kh hh bd ki kj kk kl km kn ko kp kq in kr io ks iq kt ir ku it kv iu kw kx bi translated">最佳实践#5 —调整LOB模式设置</h1><p id="d6f5" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated"><a class="ae ke" href="https://docs.aws.amazon.com/dms/latest/userguide/CHAP_Tasks.LOBSupport.html" rel="noopener ugc nofollow" target="_blank"> LOB </a>代表大型双星。我们的数据库储存了大量的图像。管理LOB设置帮助我们提高了性能。受限LOB模式有用户指定的限制。完全LOB模式没有特定的限制，但可能会导致相当大的性能问题。一个合适的解决方案是选择结合了两者优点的内联LOB。这方面的一个例子可以在这里看到<a class="ae ke" href="https://urldefense.com/v3/__https://aws.amazon.com/blogs/database/introducing-aws-dms-replication-engine-version-3-1-2/__;!!EFVe01R3CjU!IYtEmrnITtyvZ9MzM3WQ9eu31LxoJMilCZhYB-MjLwsue_dJXMkMb_Yx025b7uxJnfs$" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="498b" class="kg kh hh bd ki kj kk kl km kn ko kp kq in kr io ks iq kt ir ku it kv iu kw kx bi translated">结论</h1><p id="7f00" class="pw-post-body-paragraph ji jj hh jk b jl ky ii jn jo kz il jq jr la jt ju jv lb jx jy jz lc kb kc kd ha bi translated">如果您正在将Microsoft SQL Server(早于2016年)迁移到Amazon RDS，AWS数据库迁移服务是一个值得考虑的跨节点复制解决方案。我希望这五个使用AWS DMS for SQL Server复制的最佳实践能够帮助您完成服务器迁移之旅！</p></div></div>    
</body>
</html>