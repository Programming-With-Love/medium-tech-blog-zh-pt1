<html>
<head>
<title>The Airflow Smart Sensor Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">气流智能传感器服务</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/the-airflow-smart-sensor-service-221f96227bcb?source=collection_archive---------5-----------------------#2021-09-28">https://medium.com/airbnb-engineering/the-airflow-smart-sensor-service-221f96227bcb?source=collection_archive---------5-----------------------#2021-09-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="f1f1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">整合长时间运行的轻量级任务，以提高资源利用率</p><p id="544e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">作者:</strong> <a class="ae jc" href="https://www.linkedin.com/in/yingbo-wang-86aa3027/" rel="noopener ugc nofollow" target="_blank">王英博</a>，<a class="ae jc" href="https://www.linkedin.com/in/ruiqinyang/" rel="noopener ugc nofollow" target="_blank">杨凯文</a></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/6666613f5260ff3b7b585a3d3dde1dae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3r30u7rnBhR7BJSc"/></div></div></figure><h1 id="2190" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">介绍</h1><p id="8f32" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">Airflow是一个以编程方式创作、调度和监控数据管道的平台。一个典型的Airflow集群支持数千个工作流，称为Dag(有向无环图)，在高峰时段可能会有数万个并发运行的任务。回到2018年，Airbnb的Airflow集群有几千个Dag和超过3万个任务同时运行。这种工作量通常会导致Airflow的数据库过载。这也使得集群非常昂贵，因为它需要大量资源来支持这些并发任务。</p><p id="4b48" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了使系统更加稳定，并降低集群的成本，我们希望优化气流系统。我们很快发现，长时间运行的轻量级(LRLW)任务浪费了大量资源，因此我们提出了一种智能传感器来整合它们并解决浪费问题。</p><h1 id="012d" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">长时间运行的轻量级任务</h1><p id="3b2d" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">当我们研究气流性能问题时，我们发现有几种任务共享相同的LRLW模式。它们是传感器任务、子标记和SparkSubmitOperator。</p><p id="143e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">传感器</strong>或传感器任务是一种特殊的操作程序，它会一直运行，直到满足某个标准。该标准可以是在HDFS或S3登陆的文件、出现在Hive中的分区、其他外部任务是否成功，或者甚至是一天中的特定时间。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ks"><img src="../Images/993f259c2e513963ef00c7e964573cb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HPMY9cRlDg7_Y7zj"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx"><strong class="bd jr">Figure 1. The lifespan of a sensor task</strong></figcaption></figure><p id="0bc4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当传感器任务运行时，它会调用其“poke”函数来定期检查标准，通常是每3分钟一次，如果传感器任务的“poke”函数返回true，则标记为“成功”,如果传感器超时，则标记为“失败”。一次“戳”的执行速度非常快，大多不到100ms，所以大部分时间传感器都是空闲的，等待下一次“戳”的时间到来。传感器任务的生命周期是从检查时间到满足条件的时间，可以从几分钟到几天不等。</p><p id="f761" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">子标记</strong>是长时间运行的轻量级任务的另一个例子。它们用于将一组任务封装在DAG中，并使复杂的DAG结构更加清晰，可读性更强。在pre_execute函数中为子DAG创建DAG运行，然后子DAG任务在execute函数中“戳”DAG运行状态。</p><p id="fcb2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> SparkSubmitOperator </strong>也是一个长时间运行的轻量级任务的例子。Airflow中的Spark客户机提交作业并轮询，直到完成。在一些初始化工作之后，所有这些任务都变成了轻量级的，有时是长时间运行的状态。</p><p id="fbbc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从前面的例子中，我们可以看到这些任务都属于相同的“长期运行、轻量级”模式，其特征如下:</p><ul class=""><li id="7b27" class="kx ky hh ig b ih ii il im ip kz it la ix lb jb lc ld le lf bi translated"><strong class="ig hi">资源利用率很低。</strong>这些任务的工作进程99%的时间都处于空闲状态。</li><li id="7fc9" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated"><strong class="ig hi">在大规模集群中，这些任务通常占并发运行任务的很大一部分。</strong>在Airbnb，70%以上的运行任务都是传感器。在高峰时段，他们占用了20多个工作岗位。</li><li id="11fe" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb lc ld le lf bi translated"><strong class="ig hi">有很多重复的传感器任务。</strong>超过40%的传感器作业是重复的，因为许多下游Dag通常等待来自少数重要上游Dag的相同分区。</li></ul><h1 id="387a" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">智能传感器</h1><p id="c592" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">我们提出了智能传感器来整合这些LRLW任务。虽然最初创建它是为了合并长时间运行的传感器任务，但后来扩展到合并所有LRLW任务。我们为这项服务保留了智能传感器的名称。</p><h1 id="7265" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">它是如何工作的</h1><p id="5d4a" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">智能传感器服务的主要思想是使用集中式进程来批量执行长时间运行的任务，而不是对每个任务使用一个进程。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/fe0f3a0a4fb6d615b75ff51f490d65bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*H6QTUtYBpgbn2ijm"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx"><strong class="bd jr">Figure 2. Sensors before and after enabling smart sensor</strong></figcaption></figure><p id="5648" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用智能传感器服务，传感器任务分两步执行:</p><ol class=""><li id="ead2" class="kx ky hh ig b ih ii il im ip kz it la ix lb jb ll ld le lf bi translated">首先，每个任务解析DAG，获取任务对象，运行pre_execute函数，然后向智能传感器服务注册自己。在注册中，它将轮询外部资源所需的信息保存到Airflow metaDB。注册成功后，任务退出并释放工作线程。</li><li id="d406" class="kx ky hh ig b ih lg il lh ip li it lj ix lk jb ll ld le lf bi translated">然后，一些集中式进程(来自内置DAG的智能传感器任务)不断检查数据库中所有已注册任务的最新记录，并批量执行这些任务的“戳”功能。通常，一个智能传感器任务能够轻松处理数百个传感器任务。智能传感器还可以将重复的传感器任务合并到一个实例中，以节省更多资源。</li></ol><p id="1105" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">智能传感器通过定义传感器任务碎片来删除重复任务并平衡工作负载。</strong>并发运行的传感器数量可能会很大，并且会有多个智能传感器任务在短时间内执行所有这些任务。在设计该系统时，如何将传感器任务分配给智能传感器是我们的主要挑战之一。我们试图平衡所有智能传感器任务的工作负载。同时,“重复的”传感器任务必须分配给同一个智能传感器，这样我们可以避免对同一个目标的多次攻击。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/f63d976cf6c151dd9ce6932b3e7f2d3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fM_bvm_cykKVz7qd"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx"><strong class="bd jr">Figure 3. Deduplicating tasks by shardcode</strong></figcaption></figure><p id="98df" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在智能传感器服务中,“poke _ context”是传感器作业的签名。这是一个执行传感器的puk功能所需的参数字典。具有相同操作员类别和相同“poke _ context”的两个传感器运行相同的“puk”功能，并被视为重复任务。通过使用“poke _ context”的hashcode进行分割，并使每个智能传感器任务负责hashcode在特定范围内的任务，它应该能够将“重复的”传感器分配给同一个智能传感器。由于hashcode很长，我们使用hashcode的mod进行优化，可以在数据库中对其进行索引。我们称这个键为“shardcode”。</p><p id="a25c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">图3显示了分片如何在智能传感器服务中工作。Sensor1和sensor2具有相同的“poke _ context ”,因此它们具有相同的“hashcode”和“shardcode”。在运行时，它们将被同一智能传感器拾取，例如“智能传感器1”。所有重复的传感器在一个戳环中只会被戳一次。</p><p id="6720" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">智能传感器是所有传感器类别的通用服务。</strong>集中式智能传感器任务是一个总体框架。它旨在支持各种类。只要类有一个puk函数，并且这个puk函数的参数可以被序列化，智能传感器任务就可以支持它们。</p><p id="cdb4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">日志的处理类似于未整合的流程。</strong>虽然任务执行被整合到更少的进程中，但是智能传感器服务支持从气流UI读取或下载日志的相同能力。用户可以从原始传感器任务的URL读取日志。</p><p id="a192" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">智能传感器可轻松应用于气流集群。</strong>启用和禁用智能传感器服务很简单，我们只需要在气流中的“smart_sensor”会话上进行系统级配置更改。cfg。该更改对单个用户是透明的，无需更改现有的Dag。此外，旋转集中式智能传感器任务不会导致任何用户的传感器任务失败。</p><h1 id="4cbd" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">效率的提高</h1><p id="9911" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">在部署第一个版本的智能传感器后，Airbnb能够将高峰时间并发运行的任务数量减少60%以上。我们还将正在运行的传感器任务减少了80%。传感器所需的处理槽从20，000个减少到80个。由于运行的任务少得多，数据库负载也大大降低。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/f67eadb787054a4e05bd66b09170bb31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lkiBWjq8_ezvYC-e"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx"><strong class="bd jr">Figure 4. Number of running tasks after Smart Sensor deployed</strong></figcaption></figure><p id="4100" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在智能传感器中，重复数据消除机制减少了对Hive metastore约40%的请求，从而减少了绝对传感器流量和底层数据仓库的负载。</p><h1 id="62b9" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">结论</h1><p id="d8ad" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">智能传感器是一种将小型、轻量级任务流量整合为大型集中式任务的服务。它可以降低气流的基础设施成本，并提高集群的稳定性。对于具有大量传感器任务的大型集群来说尤其如此。对于Airbnb的巨大气流集群，智能传感器降低了大量成本，并大大提高了整体集群的稳定性。</p><p id="7bee" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">智能传感器服务是作为<a class="ae jc" href="https://airflow.apache.org/docs/apache-airflow/stable/concepts/smart-sensors.html" rel="noopener ugc nofollow" target="_blank"> Apache Airflow 2.0 </a>中的主要新功能之一发布的，自那以来，它一直用于提高更多Airflow用户的资源利用率。因为智能传感器服务引入了将任务生命周期分成多个进程的想法，并解锁了任务执行的“异步”模式，开源社区已经开始投资于“异步”解决方案的更通用用例，其中<a class="ae jc" href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=177050929" rel="noopener ugc nofollow" target="_blank">可延迟(“异步”)操作符</a>是一个旨在将异步模式扩展到更多任务的操作符。</p><h1 id="b5e0" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi">****************</h1><p id="2a64" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated"><em class="lm">所有产品名称、标识和品牌均为其各自所有者的财产。本网站中使用的所有公司、产品和服务名称仅用于识别目的。使用这些名称、标志和品牌并不意味着认可。</em></p></div></div>    
</body>
</html>