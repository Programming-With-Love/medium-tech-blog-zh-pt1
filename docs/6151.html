<html>
<head>
<title>The little engine that could: Linchpin DSL for Pinterest ranking</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">可能的小引擎:Pinterest排名的关键DSL</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/the-little-engine-that-could-linchpin-dsl-for-pinterest-ranking-17699add8e56?source=collection_archive---------5-----------------------#2017-08-25">https://medium.com/pinterest-engineering/the-little-engine-that-could-linchpin-dsl-for-pinterest-ranking-17699add8e56?source=collection_archive---------5-----------------------#2017-08-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="644d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Angela Sheu | Pinterest工程师，Home feed基础设施</p><p id="a27e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Pinterest，我们正在建立一个视觉发现引擎，拥有1000多亿个想法的不断增长的数据集。我们的工程师的任务是在正确的时间向正确的用户展示正确的想法，包括home feed、搜索、相关pin等。工程师使用共享Pin特征和用户属性，每天做出超过10B条推荐。因为多个团队使用相同的数据管道和框架，所以在开发环境和生产环境中一致地使用模型是很重要的。</p><p id="646c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">之前，团队为开发机器学习(ML)模型创建了单独的流程。随着这些模型变得越来越复杂，团队对模型开发工作流的需求也越来越相似，我们需要一种通用语言来表达、评估和跨多个团队部署模型。我们的答案是关键的DSL，我们将在本帖中展示原因。</p><h2 id="f517" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated"><strong class="ak">为什么是DSL的关键？</strong></h2><p id="4658" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">机器学习系统中只有极小一部分代码真正进行“机器学习”其余的通常是胶水代码，它执行一些版本的:(1)将数据注入评分系统，(2)将数据转换成数字特征列表，以及(3)解释模型以将特征组合成分数。</p><p id="b6f6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有了领域特定语言(DSL)，开发人员可以更专注于功能开发和实际的机器学习，因为不再需要编写粘合代码。</p><h2 id="66ba" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated"><strong class="ak">创建模型规格</strong></h2><p id="dfc4" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">使用关键DSL语法编写的模型规范是以下形式的有序语句列表:</p><figure class="kc kd ke kf fd kg"><div class="bz dy l di"><div class="kh ki l"/></div></figure><p id="5c67" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Linchpin有一个小型的可用计算节点库(即“转换”)，这些节点旨在充当原始操作。有时还有更复杂的转换，例如用于我们的梯度推进决策树(GBDT)模型的决策树转换和用于我们的神经网络模型的多线性转换。如果现有的库不能表达所需的特性，开发人员只需编写一个新的关键转换。</p><p id="a15b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果我们为一个用户的主页feed排列一个Pin，一个示例模型规格可能如下所示:</p><figure class="kc kd ke kf fd kg"><div class="bz dy l di"><div class="kh ki l"/></div><figcaption class="kj kk et er es kl km bd b be z dx"><em class="kn">Note: This is an extremely simplified model for illustration.</em></figcaption></figure><h2 id="7a55" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated"><strong class="ak">引擎盖下的一瞥</strong></h2><p id="9767" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">关键有两个主要部分:(1)将模型规范解析成计算图，以及(2)评估创建的图。前者特定于关键的DSL，而后者是一个计算系统——独立于DSL格式。</p><p id="79ac" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="ko">阶段1: </em> </strong>关键点将模型规范解析为模型DAG，并构建模型节点图。这些节点可以是源节点、内部节点(变换/计算节点)或接收器节点。在这个阶段，每个节点都已经确定了其输出的大小和值类型，允许我们执行初步的验证检查。</p><p id="bd21" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="ko">阶段2: </em> </strong>调用者为关键点提供数据进行评分，并将给定的数据注入源节点。然后，林奇平评估所有后续的内部节点，并从接收器节点提取输出返回给调用者。</p><p id="d1ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将所有内容放在一起，我们可能会在阶段1中创建以下DAG:</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es kp"><img src="../Images/297496198c115955d003c6eb77e47cec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GMwasJQOCAGUASXh."/></div></div></figure><p id="2998" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们在计算过程中维护一个值数组，可能如下所示:</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="er es kw"><img src="../Images/907d45957cafc6dc9cb98507fb2c84ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_3bcKkN2e4E4A5uy."/></div></div></figure><h2 id="c8f3" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated"><strong class="ak">我们如何使用关键点</strong></h2><p id="84aa" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">2014年，home feed团队用Java设计并实现了这个DSL来对个性化内容进行排名。在接下来的两年里，家庭饲料发生了显著的变化。随着Pinterest的快速增长，用户数量增加了2倍，排名的pin数量从每天大约50个增加到700个。我们曾经离线对内容进行预排名，现在我们的系统可以实时对内容进行排名。因此，延迟和性能变得至关重要。2015年，出于性能优化的目的，我们在C++中实现了一个<a class="ae kx" rel="noopener" href="/@Pinterest_Engineering/pinnability-machine-learning-in-the-home-feed-64be2074bf60">可定位性</a> DSL V2，DSL被重命名为“关键点”(Pinnability是我们的机器学习模型的统称，这些模型在Pinterest上提供推荐。)</p><p id="075c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在home feed中，我们看到了采用关键技术的以下好处:</p><ul class=""><li id="bb8b" class="ky kz hh ig b ih ii il im ip la it lb ix lc jb ld le lf lg bi translated"><em class="ko">输入与计算解耦。</em>因为关键使我们能够从计算中分离输入，我们在不同的环境和上下文中应用相同的计算。这保证了离线训练和在线评分之间的一致性，以及用于生成训练数据的Hadoop计算将与来自<a class="ae kx" rel="noopener" href="/@Pinterest_Engineering/open-sourcing-rocksplicator-a-real-time-rocksdb-data-replicator-558cd3847a9d"> RealPin </a>的发球得分结果保持一致。</li><li id="df34" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb ld le lf lg bi translated"><em class="ko">易于实验。</em>在任何给定的一周内，Pinnability工程师可能会执行20项新的实验，同时还会决定是否关闭或交付现有的实验模型。通过使用关键的DSL，我们能够将模型视为数据，并可以在单个模型规格中运行多个具有所有特性变化的实验。我们只是通过改变评分时使用的模型规范来发布模型，并且可以回滚一个坏的模型或者运行旧的、退役的模型。</li><li id="27c2" class="ky kz hh ig b ih lh il li ip lj it lk ix ll jb ld le lf lg bi translated"><em class="ko">从基础设施变更中分离出建模变更。</em>关键的DSL还使我们能够将功能开发与基础设施代码分开。2017年初，home feed infrastructure团队将Pinnability的数据源从Thrift迁移到FlatBuffers格式，而Pinnability团队将他们的模型从使用GBDT改为并行的神经网络。</li></ul><p id="de23" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">除了home feed团队之外，相关的Pins、搜索和广告团队也已经开始使用关键。这意味着首页提要针，搜索结果和相关针都使用关键排名。</p><h2 id="2b5a" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated">关键的未来</h2><p id="08cb" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">随着模型变得越来越复杂，使用关键的DSL语法来指定模型的方法可能会变得不实用，并且经常容易出错。我们已经开始努力使用python接口建立和调试模型的机制，类似于在TensorFlow中建立模型的方式。</p><p id="9e0f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在那之前，关键已经大大加快了ML工程师的开发速度，并为Pinterest的众多团队提供了开发和评估模型的方法。它作为我们推动Pinterest排名系统的关键引擎之一，继续稳步前进。</p><figure class="kc kd ke kf fd kg er es paragraph-image"><div class="er es lm"><img src="../Images/c2e708437034ef3a06c845ca00e483ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:290/format:webp/1*VS-SIyipZqIIfQYxAvva3A.png"/></div></figure></div><div class="ab cl ln lo go lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ha hb hc hd he"><p id="48c0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ko">致谢:开发和采用关键是跨职能部门的努力；感谢主页feed Infra、主页feed排名、服务系统、相关pin、搜索和广告团队。</em></p><p id="6514" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ko">特别鸣谢、Angela Sheu、Xiaofang Chen、Derek Cheng、Jaison George、Guo、Utku Irmak、、、Mukund Narasimhan、、、刘中达、Raymond Shiau、Tim Koh、Zheng Liu、Zhao Zheng、Zack Drach、Mihai Roman和Sloane Sturzenegger。</em></p></div></div>    
</body>
</html>