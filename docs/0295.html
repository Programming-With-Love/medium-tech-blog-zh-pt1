<html>
<head>
<title>Testing Room migrations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试室迁移</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/testing-room-migrations-be93cdb0d975?source=collection_archive---------4-----------------------#2017-07-24">https://medium.com/androiddevelopers/testing-room-migrations-be93cdb0d975?source=collection_archive---------4-----------------------#2017-07-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/ea23a0c4fa4a9a78b9db0112e65f963b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v4NIKhmuE5uX0ssv6HlxCQ.png"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">Is everything where it’s supposed to be? Test migrations. (Photo by <a class="ae hu" href="http://unsplash.com/photos/dzCBKa8rIAM?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Dmitri Popov</a> on <a class="ae hu" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a>)</figcaption></figure><div class=""/><p id="0d11" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在之前的一篇文章中，我解释了带房间的数据库迁移是如何工作的。我们看到，不正确的迁移实施会导致您的应用崩溃或用户数据丢失。</p><div class="hg hh ez fb hi js"><a rel="noopener follow" target="_blank" href="/google-developers/understanding-migrations-with-room-f01e04b07929"><div class="jt ab dw"><div class="ju ab jv cl cj jw"><h2 class="bd hy fi z dy jx ea eb jy ed ef hw bi translated">了解迁移与空间</h2><div class="jz l"><h3 class="bd b fi z dy jx ea eb jy ed ef dx translated">用SQLite API执行数据库迁移总是让我感觉像是在拆除一颗炸弹——好像我就是一颗…</h3></div><div class="ka l"><p class="bd b fp z dy jx ea eb jy ed ef dx translated">medium.com</p></div></div><div class="kb l"><div class="kc l kd ke kf kb kg ho js"/></div></div></a></div><p id="c147" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最重要的是，您在<code class="du kh ki kj kk b">Migration.migrate</code>方法中执行的SQL语句在编译时没有被检查，这为更多的问题打开了大门。了解了所有这些，测试迁移就成了一项基本任务。Room提供了<code class="du kh ki kj kk b">MigrationTestHelper</code>测试规则，允许您:</p><ul class=""><li id="fbf8" class="kl km hx iw b ix iy jb jc jf kn jj ko jn kp jr kq kr ks kt bi translated">创建给定版本的数据库</li><li id="c560" class="kl km hx iw b ix ku jb kv jf kw jj kx jn ky jr kq kr ks kt bi translated">在数据库上运行一组给定的迁移</li><li id="e2b0" class="kl km hx iw b ix ku jb kv jf kw jj kx jn ky jr kq kr ks kt bi translated">验证数据库模式</li></ul><p id="8790" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="kz">注意，Room不会验证数据库中的数据。这是你需要自己去实现的事情。</em></p><p id="5b0d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">下面是测试房间迁移需要了解的内容。</p><h1 id="7255" class="la lb hx bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">在后台</h1><p id="63c1" class="pw-post-body-paragraph iu iv hx iw b ix ly iz ja jb lz jd je jf ma jh ji jj mb jl jm jn mc jp jq jr ha bi translated">为了测试迁移，Room需要知道关于您当前数据库版本的一些事情:版本号、实体、身份散列以及创建和更新<code class="du kh ki kj kk b">room_master_table</code>的查询。所有这些都是由Room在编译时自动生成的，并存储在一个schema JSON文件中。</p><p id="7257" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在您的<code class="du kh ki kj kk b">build.gradle</code>文件中，您指定一个文件夹来放置这些生成的模式JSON文件。当您更新模式时，您将得到几个JSON文件，每个版本一个。确保将每个生成的文件都提交给源代码管理。下次您再次增加您的版本号时，Room将能够使用JSON文件进行测试。</p><h1 id="6872" class="la lb hx bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">先决条件</h1><p id="5608" class="pw-post-body-paragraph iu iv hx iw b ix ly iz ja jb lz jd je jf ma jh ji jj mb jl jm jn mc jp jq jr ha bi translated">为了能够生成JSON文件，用下面的代码更新您的<code class="du kh ki kj kk b">build.gradle</code>文件:</p><ol class=""><li id="b535" class="kl km hx iw b ix iy jb jc jf kn jj ko jn kp jr md kr ks kt bi translated">定义模式位置</li></ol><pre class="me mf mg mh fd mi kk mj mk aw ml bi"><span id="a6e3" class="mm lb hx kk b fi mn mo l mp mq">defaultConfig {<br/>  javaCompileOptions {<br/>            annotationProcessorOptions {<br/>                arguments += ["room.schemaLocation": <br/>                                "$projectDir/schemas".toString()]<br/>            }<br/>        }<br/>}</span></pre><p id="c412" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">2.将模式位置添加到源集中</p><pre class="me mf mg mh fd mi kk mj mk aw ml bi"><span id="64dd" class="mm lb hx kk b fi mn mo l mp mq">android {<br/>    <br/>    sourceSets {<br/>        androidTest.assets.srcDirs +=  <br/>                           files("$projectDir/schemas".toString())<br/>    }</span></pre><p id="8d7a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">3.将room testing库添加到依赖项列表中</p><pre class="me mf mg mh fd mi kk mj mk aw ml bi"><span id="0253" class="mm lb hx kk b fi mn mo l mp mq">dependencies {</span><span id="04ea" class="mm lb hx kk b fi mr mo l mp mq">androidTestImplementation    <br/>                “android.arch.persistence.room:testing:1.0.0-alpha5”</span><span id="576f" class="mm lb hx kk b fi mr mo l mp mq">}</span></pre><h1 id="919b" class="la lb hx bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">迁移测试规则</h1><p id="5944" class="pw-post-body-paragraph iu iv hx iw b ix ly iz ja jb lz jd je jf ma jh ji jj mb jl jm jn mc jp jq jr ha bi translated">创建数据库、模式、打开和关闭数据库、运行迁移——几乎每个测试都需要编写大量样板代码。为了避免写所有这些，在您的迁移测试类中使用<code class="du kh ki kj kk b">MigrationTestHelper</code>测试规则。</p><pre class="me mf mg mh fd mi kk mj mk aw ml bi"><span id="81ae" class="mm lb hx kk b fi mn mo l mp mq">@Rule<br/>public MigrationTestHelper testHelper =<br/>        new MigrationTestHelper(<br/>                InstrumentationRegistry.<em class="kz">getInstrumentation</em>(),<br/>                <em class="kz">&lt;your_database_class&gt;</em>.class.getCanonicalName(),<br/>                new FrameworkSQLiteOpenHelperFactory());</span></pre><p id="2ae2" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><code class="du kh ki kj kk b">MigrationTestHelper</code>非常依赖生成的JSON文件，既用于创建数据库，也用于验证迁移。</p><p id="b7e8" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您能够<strong class="iw hy">在特定版本</strong>中创建您的数据库:</p><pre class="me mf mg mh fd mi kk mj mk aw ml bi"><span id="9fc2" class="mm lb hx kk b fi mn mo l mp mq">// Create the database with version 2<br/>SupportSQLiteDatabase db = <br/>                         testHelper.createDatabase(TEST_DB_NAME, 2);</span></pre><p id="56da" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您可以<strong class="iw hy">运行一组迁移，并自动验证</strong>模式是否被正确更新:</p><pre class="me mf mg mh fd mi kk mj mk aw ml bi"><span id="c44d" class="mm lb hx kk b fi mn mo l mp mq">db = testHelper.<strong class="kk hy">runMigrationsAndValidate</strong>(TEST_DB_NAME, 4, validateDroppedTables, MIGRATION_1_2, MIGRATION_2_3, MIGRATION_3_4);</span></pre><h1 id="f317" class="la lb hx bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">实施测试</h1><p id="f4e4" class="pw-post-body-paragraph iu iv hx iw b ix ly iz ja jb lz jd je jf ma jh ji jj mb jl jm jn mc jp jq jr ha bi translated">测试策略很简单:</p><ol class=""><li id="63cd" class="kl km hx iw b ix iy jb jc jf kn jj ko jn kp jr md kr ks kt bi translated">在特定版本中打开数据库</li><li id="4482" class="kl km hx iw b ix ku jb kv jf kw jj kx jn ky jr md kr ks kt bi translated">插入一些数据</li><li id="a959" class="kl km hx iw b ix ku jb kv jf kw jj kx jn ky jr md kr ks kt bi translated">运行迁移并验证模式</li><li id="1ff3" class="kl km hx iw b ix ku jb kv jf kw jj kx jn ky jr md kr ks kt bi translated">检查数据库中的数据是否正确。</li></ol><p id="1cb6" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">例如，数据库的版本3增加了一个新列:<code class="du kh ki kj kk b">date</code>。因此，当测试从版本2到版本3的迁移时，我们检查版本2中插入的数据的有效性，以及新列的默认值。下面是我们的<code class="du kh ki kj kk b">AndroidJUnitTest</code>的样子:</p><pre class="me mf mg mh fd mi kk mj mk aw ml bi"><span id="4ac6" class="mm lb hx kk b fi mn mo l mp mq">@Test<br/>public void migrationFrom2To3_containsCorrectData() throws <br/>                                                       IOException {<br/>    // Create the database in version 2<br/>    SupportSQLiteDatabase db = <br/>                         <strong class="kk hy">testHelper.createDatabase</strong>(<em class="kz">TEST_DB_NAME</em>, 2);<br/>    // Insert some data<br/>    insertUser(<em class="kz">USER</em>.getId(), <em class="kz">USER</em>.getUserName(), db);<br/>    //Prepare for the next version<br/>    db.close();<br/><br/>    // Re-open the database with version 3 and provide MIGRATION_1_2  <br/>    // and MIGRATION_2_3 as the migration process.<br/>    <strong class="kk hy">testHelper.runMigrationsAndValidate</strong>(<em class="kz">TEST_DB_NAME</em>, 3,   <br/>              validateDroppedTables, <em class="kz">MIGRATION_1_2</em>, <em class="kz">MIGRATION_2_3</em>);<br/><br/>    // MigrationTestHelper automatically verifies the schema  <br/>    //changes, but not the data validity<br/>    // Validate that the data was migrated properly.<br/>    User dbUser = getMigratedRoomDatabase().userDao().getUser();<br/>    <em class="kz">assertEquals</em>(dbUser.getId(), <em class="kz">USER</em>.getId());<br/>    <em class="kz">assertEquals</em>(dbUser.getUserName(), <em class="kz">USER</em>.getUserName());<br/>    // The date was missing in version 2, so it should be null in <br/>    //version 3<br/>    <em class="kz">assertEquals</em>(dbUser.getDate(), null);<br/>}</span></pre><h1 id="3013" class="la lb hx bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">测试从SQLiteDatabase实现到Room的迁移</h1><p id="c9cc" class="pw-post-body-paragraph iu iv hx iw b ix ly iz ja jb lz jd je jf ma jh ji jj mb jl jm jn mc jp jq jr ha bi translated">我之前谈到了从标准的<code class="du kh ki kj kk b">SQLiteDatabase</code>实现到Room需要采取的步骤，但是我没有详细介绍如何测试迁移实现。</p><div class="hg hh ez fb hi js"><a rel="noopener follow" target="_blank" href="/google-developers/7-steps-to-room-27a5fe5f99b2"><div class="jt ab dw"><div class="ju ab jv cl cj jw"><h2 class="bd hy fi z dy jx ea eb jy ed ef hw bi translated">7步到房间</h2><div class="jz l"><h3 class="bd b fi z dy jx ea eb jy ed ef dx translated">如何将您的应用程序迁移到Room的分步指南</h3></div><div class="ka l"><p class="bd b fp z dy jx ea eb jy ed ef dx translated">medium.com</p></div></div><div class="kb l"><div class="ms l kd ke kf kb kg ho js"/></div></div></a></div><p id="00a5" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">由于最初的数据库版本不是使用Room实现的，我们没有相应的JSON文件，因此我们不能使用<code class="du kh ki kj kk b">MigrationTestHelper</code>来创建数据库。</p><p id="e4a3" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们需要做的是:</p><ol class=""><li id="628d" class="kl km hx iw b ix iy jb jc jf kn jj ko jn kp jr md kr ks kt bi translated">扩展<code class="du kh ki kj kk b">SQLiteOpenHelper</code>类，在<code class="du kh ki kj kk b">onCreate</code>中，执行创建数据库表的SQL查询。</li><li id="fcd4" class="kl km hx iw b ix ku jb kv jf kw jj kx jn ky jr md kr ks kt bi translated">在测试的<code class="du kh ki kj kk b">@Before</code>方法中，创建数据库。</li><li id="a6e9" class="kl km hx iw b ix ku jb kv jf kw jj kx jn ky jr md kr ks kt bi translated">在测试的<code class="du kh ki kj kk b">@After</code>方法中，清空数据库。</li><li id="5c1f" class="kl km hx iw b ix ku jb kv jf kw jj kx jn ky jr md kr ks kt bi translated">使用您的<code class="du kh ki kj kk b">SQLiteOpenHelper</code>实现来插入测试所需的数据，检查从您的<code class="du kh ki kj kk b">SQLiteDatabase</code>版本到使用Room的其他版本的迁移。</li><li id="8fab" class="kl km hx iw b ix ku jb kv jf kw jj kx jn ky jr md kr ks kt bi translated">使用<code class="du kh ki kj kk b">MigrationTestHelper</code>运行迁移并验证模式。</li><li id="9f3c" class="kl km hx iw b ix ku jb kv jf kw jj kx jn ky jr md kr ks kt bi translated">检查数据库数据的有效性。</li></ol><p id="04fa" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">数据库版本1是使用<code class="du kh ki kj kk b">SQLiteDatabase</code> API实现的，然后在版本2中我们迁移到了Room，在版本3中我们添加了一个新列。检查从版本1到版本3的迁移的测试如下所示:</p><pre class="me mf mg mh fd mi kk mj mk aw ml bi"><span id="3cef" class="mm lb hx kk b fi mn mo l mp mq">@Test<br/>public void migrationFrom1To3_containsCorrectData() throws IOException {<br/>    // Create the database with the initial version 1 schema and    <br/>    //insert a user<br/>    <strong class="kk hy">SqliteDatabaseTestHelper</strong>.<em class="kz">insertUser</em>(1, <em class="kz">USER</em>.getUserName(), sqliteTestDbHelper);<br/><br/>    // Re-open the database with version 3 and provide MIGRATION_1_2 <br/>    // and MIGRATION_2_3 as the migration process.<br/>    <strong class="kk hy">testHelper.runMigrationsAndValidate</strong>(<em class="kz">TEST_DB_NAME</em>, 3, true,<br/>            <em class="kz">MIGRATION_1_2</em>, <em class="kz">MIGRATION_2_3</em>);<br/><br/>    // Get the latest, migrated, version of the database<br/>    // Check that the correct data is in the database<br/>    User dbUser = getMigratedRoomDatabase().userDao().getUser();<br/>    <em class="kz">assertEquals</em>(dbUser.getId(), 1);<br/>    <em class="kz">assertEquals</em>(dbUser.getUserName(), <em class="kz">USER</em>.getUserName());<br/>    // The date was missing in version 2, so it should be null in   <br/>    //version 3<br/>    <em class="kz">assertEquals</em>(dbUser.getDate(), null);<br/>}</span></pre><h1 id="2dd7" class="la lb hx bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">给我看看代码</h1><p id="1268" class="pw-post-body-paragraph iu iv hx iw b ix ly iz ja jb lz jd je jf ma jh ji jj mb jl jm jn mc jp jq jr ha bi translated">您可以在这个示例应用程序中查看<a class="ae hu" href="https://github.com/googlesamples/android-architecture-components/tree/master/PersistenceMigrationsSample" rel="noopener ugc nofollow" target="_blank">的实现。为了便于比较，每个数据库版本都以自己的方式实现:</a></p><ol class=""><li id="fe89" class="kl km hx iw b ix iy jb jc jf kn jj ko jn kp jr md kr ks kt bi translated"><a class="ae hu" href="https://github.com/googlesamples/android-architecture-components/tree/master/PersistenceMigrationsSample/app/src/sqlite/java/com/example/android/persistence/migrations" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hy"> sqlite </strong> </a> —使用<code class="du kh ki kj kk b">SQLiteOpenHelper</code>和传统的sqlite接口。</li><li id="157a" class="kl km hx iw b ix ku jb kv jf kw jj kx jn ky jr md kr ks kt bi translated"><a class="ae hu" href="https://github.com/googlesamples/android-architecture-components/tree/master/PersistenceMigrationsSample/app/src/room/java/com/example/android/persistence/migrations" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hy">房间</strong> </a> —用房间替换实施并提供到版本2的迁移</li><li id="ce58" class="kl km hx iw b ix ku jb kv jf kw jj kx jn ky jr md kr ks kt bi translated"><a class="ae hu" href="https://github.com/googlesamples/android-architecture-components/tree/master/PersistenceMigrationsSample/app/src/room2/java/com/example/android/persistence/migrations" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hy"> room2 </strong> </a> —将数据库更新为新模式版本3</li><li id="b0c4" class="kl km hx iw b ix ku jb kv jf kw jj kx jn ky jr md kr ks kt bi translated"><a class="ae hu" href="https://github.com/googlesamples/android-architecture-components/tree/master/PersistenceMigrationsSample/app/src/room3/java/com/example/android/persistence/migrations" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hy"> room3 </strong> </a> —将数据库更新到新的版本4。提供从版本2到版本3、版本3到版本4以及版本1到版本4的迁移路径。</li></ol><h1 id="99aa" class="la lb hx bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">结论</h1><p id="96b0" class="pw-post-body-paragraph iu iv hx iw b ix ly iz ja jb lz jd je jf ma jh ji jj mb jl jm jn mc jp jq jr ha bi translated">有了空间，实现和测试迁移就变得容易了。<code class="du kh ki kj kk b">MigrationTestHelper</code>测试规则允许您在任何版本下打开数据库，只需几行代码就可以运行迁移和验证模式。</p><p id="b0e8" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您是否已经开始使用空间并实施迁移？如果是这样，请在下面的评论中告诉我们进展如何。</p></div></div>    
</body>
</html>