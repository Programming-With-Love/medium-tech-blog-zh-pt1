<html>
<head>
<title>Evasive VBA — Advanced Maldoc Techniques</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">规避VBA——先进的Maldoc技术</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/evasive-vba-advanced-maldoc-techniques-1365e9373f80?source=collection_archive---------1-----------------------#2018-10-05">https://medium.com/walmartglobaltech/evasive-vba-advanced-maldoc-techniques-1365e9373f80?source=collection_archive---------1-----------------------#2018-10-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="8ca7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作者:柯克·塞尔(<a class="ae jc" href="https://twitter.com/bigmacjpg" rel="noopener ugc nofollow" target="_blank"> @bigmacjpg </a>)、哈罗德·奥格登(<a class="ae jc" href="https://twitter.com/haroldogden" rel="noopener ugc nofollow" target="_blank">@哈罗德·奥格登</a>)和卡莉·罗伯特(<a class="ae jc" href="https://twitter.com/OrOneEqualsOne" rel="noopener ugc nofollow" target="_blank">@奥伦内夸尔松</a>)</p><p id="0a04" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">执行</strong></p><p id="fca0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在VBA创建流程的不同方法各有利弊。<strong class="ig hi"> Shell$ </strong>、<strong class="ig hi"> Shell </strong>或<strong class="ig hi"> CreateObject("WScript。壳”)。运行</strong>将导致office应用程序被列为已创建进程的父进程。这在目标环境中可能不常见，可能会引起怀疑。</p><p id="9134" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">创建WMI进程具有由wmiprvse.exe创建的进程(WMI服务进程)的好处，除非WMI活动被监视，否则将进程创建与maldoc解除关联。</p><p id="a018" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">壳牌$ </strong></p><p id="d46b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">业务流程通常使用<strong class="ig hi"> Shell$ </strong>、<strong class="ig hi"> Shell </strong>或<strong class="ig hi"> CreateObject("WScript。壳”)。运行</strong>来运行reg.exe、ping.exe、cmd.exe和其他实用程序，从stdout中读取信息或进行更改以使进程能够运行。这可能会给维护者造成歧义，因为他们不能自动将office产品的流程创建视为恶意或完全阻止它。</p><p id="3af4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">不管您从上面的过程创建方法中选择什么，创建powershell.exe过程的办公室过程是维护者正在寻找的一个关键指标。即使只有一层的分离也会减少行为被标记的机会。一种方法是直接调用<strong class="ig hi">cmd.exe/c powershell.exe</strong>而不是<strong class="ig hi">powershell.exe</strong>。</p><p id="950f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> WMI </strong></p><p id="dede" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">壳牌依靠合法性的不确定性，而WMI却没有这样的好处。WMI流程创建在业务流程中并不常见，这给了辩护者进一步调查的强烈信号。WMI进程创建带来了三个不可变VBA元素的缺点，这三个元素可用于嵌入式OLE文件的签名:<strong class="ig hi"> GetObject() </strong>，<strong class="ig hi"> Get() </strong>和<strong class="ig hi">。创建</strong>。</p><p id="978e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">以帝国为基线</strong></p><p id="52f5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面是默认的PowerShell Empire VBA生成器中用于WMI进程创建的VBA。帝国是一个后利用框架，包括恶意VBA宏生成器，以及各种其他功能。帝国代码中的变量名和字符串都将出现在文档的嵌入式OLE ( <a class="ae jc" href="https://msdn.microsoft.com/en-us/library/19z074ky.aspx" rel="noopener ugc nofollow" target="_blank">对象链接和嵌入</a>)文件的P-Code(编译的伪代码)部分，并再次出现在压缩的VBA源代码中。用于以Office 2007+文件格式存储VBA宏的默认嵌入式OLE文件是vbaProject.bin。其中许多文件在不同版本之间是静态的，从而减少了签名创建和检测的工作量。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/27ef8ffdb31e58071bd58b90b3c2f589.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mZ2jjRCTQdoutVs8hbUCcw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx"><em class="jt">Detection rate of document with default Empire builder VBA.</em></figcaption></figure><p id="a398" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ju">EC 4159 c 93 ECE 699 a4e 381505321880 CD 329492 CD 1792 ed 8 aaeeb 6d 23 bfbe 5 DAA</em></p><p id="5b7d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">虽然创建帝国WMI进程的冗长有其缺点，但这种方法的优点是创建的WMI进程对目标是隐藏的(通过<strong class="ig hi"> objConfig实现)。ShowWindow = 0 </strong>)。如果没有设置这个属性，目标可能会注意到创建的进程在任务栏上的短暂出现。</p><p id="2cc2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在VBA中选择更少的代码，同时冒着目标可能会注意到进程短暂地出现在他们的任务栏上的风险，WMI进程的创建可以在一行中完成，如下所示。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jv"><img src="../Images/7cdf1b2b7b51ee49f69f2fe94a719ae2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*4MXez2F-8PvJdhaYwFbSkQ.png"/></div></figure><p id="536b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本例中，以相同的方式创建了两个流程。在第二个进程创建时，VBA的每一个可能的部分都被剔除和混淆了。<strong class="ig hi"> StrReverse() </strong>用于演示字符串不需要以<strong class="ig hi"> GetObject() </strong>要求的形式存储在VBA的任何地方。注意<strong class="ig hi"> GetObject() </strong>，<strong class="ig hi">。Get() </strong>和<strong class="ig hi">。Create </strong>仍然存在，并且仍然是签名的可能目标。</p><p id="5c8a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这种情况下，未定义的变量可以作为Null，减少了所提供的关于正在运行哪种方法的提示数量。</p><p id="ccc5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">即使是这种简单的混淆的结果也是减少了4个AV检测，然后当我们颠倒字符串时减少到7个:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jw"><img src="../Images/939826e2b552804e1a6109b78a36d438.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j1Jv_Tj2QrghNYXDt3TLrQ.png"/></div></div></figure><p id="ba6a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ju">e 3987 c7a 322 c 52 ba 095 bdad 9 feced 318 e 9098 b 380717 df 8595 cc 046034 c 3922 b</em></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jx"><img src="../Images/cc072352980c930ae4622061342ac657.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ygChV0e2Qyw5jAGonvhAKg.png"/></div></div></figure><p id="c7b7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ju">e 9d 02 B2 ed 484 CD 1c 1944 DC 553 a 342 e 3166 ce 080205 beb 19d 8132352 bee de 8524 c</em></p><p id="ab1f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">有效载荷混淆和重组</strong></p><p id="87d7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">StrReverse() 是一个很好的例子，但它是一种众所周知的混淆技术，可以关闭以进行检测。一些混淆技术会引起更多的怀疑，而其他的则不会。你需要混淆和重组你的负载的程度很大程度上取决于它的大小。</p><p id="3fc4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">目标是引入尽可能少的代码，并防止有效负载的任何表示以可以在签名中被切断的格式出现。</p><p id="e4aa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">有效载荷大小至关重要</strong></p><p id="a33f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">较小的有效载荷不需要重新组装。VBA在一个变量定义中的最大字符串长度是1024，所以如果你的混淆有效载荷比这个长，你很可能会用字符串连接来重组。</p><p id="bda7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">字符串串联可以提高反病毒检测率，因为它是Emotet等大型maldoc活动中常见的技术。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jy"><img src="../Images/7b77523ebb2a5488629d4d51789eda11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u5AVeKw5FOEa9mar6REYUw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx"><em class="jt">Emotet reassembling the payload prior to process creation</em></figcaption></figure><p id="79b4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">用建造者支持更大的有效载荷的好处是能够带来更坚固的第二级。</p><p id="9d6e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">无论有效载荷大小如何，通过将有效载荷混淆为非标准编码或加密，并使用最少数量的字符串操作函数，可以降低静态检测的可能性和AV检测率。</p><p id="2ff2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要避免大量使用的函数有<strong class="ig hi"> Left() </strong>，<strong class="ig hi"> Right() </strong>，<strong class="ig hi"> Mid() </strong>，<strong class="ig hi"> Chr() </strong>，<strong class="ig hi"> ChrW() </strong>等等——任何与字符串操作或字符解码有关的函数。由于在各种maldoc活动中使用了这种技术，可以很容易地为简单的去混淆编写签名，如'<strong class="ig hi">Chr(115)+Chr(116)+Chr(117)</strong>'。</p><p id="8433" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里，我们使用了一个足够小的有效载荷，可以放在一条线上，不需要重新组装。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jv"><img src="../Images/e20a07e66e3dda5a612559dce821b6d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*FHXRIjFk6TjDD5xMA9x9eQ.png"/></div></figure><p id="2ae2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">每个ASCII码的解码都是通过一组函数来完成的，我们用一年中的月份和一周中的日子来命名这些函数，这样就很难对它们进行指纹识别。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jz"><img src="../Images/a2ba0e95770f29edcf6a9ec4cf043b66.png" data-original-src="https://miro.medium.com/v2/resize:fit:884/format:webp/1*aeqGteGvTNL96NDQnAAtQQ.png"/></div></figure><p id="d727" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了检查存储的有效载荷并对其进行解码，我们使用了利用上述函数的函数June。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jv"><img src="../Images/a58c49e56e0ffb3d6b4fa62a73ea8c3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*VuonJERreuDcnDRqQ--kJg.png"/></div></figure><p id="a9b1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们拥有的所有字符串都被编码，尽可能隐藏我们的意图，June用来解码它们。未初始化的变量用于空值和0值，这些值通常会被传递以创建进程，因此查找WMI进程创建参数的签名会不太有效。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ka"><img src="../Images/a82fae39e0d4ac3f4fd000c22d4daa1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*EHKCVHIxtPlfO6522VyWkw.png"/></div></figure><p id="dd32" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最初上传时，结果仍然是7次检测，但现在更有弹性——此时可以添加任意数量的有效载荷，而增加检测率的风险很小。</p><p id="3d23" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这个例子中，字符串是用Rot9混淆的。这只需要对VBA进行名义上的扩建。我们的字符串现在是任意的，没有仿真或沙箱，特定的有效载荷字符串不能再用签名来查找。VBA的结构仍然可以用于签名，但我们使用的大部分内容存在于真实世界的业务流程VBA中，这使得该构建更具弹性。</p><p id="369f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Rot9进入VBA的ASCII代码，在本例中使用一个简短的PowerShell脚本。ASCII码总是被填充为3位数，以使解码更容易，并允许我们不将有效载荷存储在数组中，这可能会触发在VBA中寻找大数组的签名。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kb"><img src="../Images/aa2c344453f29aa66250e6016de09c14.png" data-original-src="https://miro.medium.com/v2/resize:fit:926/format:webp/1*ZwthN_B1WndEx3Jh9Mw47w.png"/></div></figure><p id="86eb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">反沙盒(离线)和反FakeNet </strong></p><p id="d6d9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在沙盒中检测和避免执行可以在VBA中完成，而不会显著增加被反病毒检测到的机会。</p><p id="268b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">https://github.com/joesecurity/pafishmacro是灵感的伟大源泉，但我不建议照原样实现这些。由于我们使用WMI来避免行为被绑定到我们的WINWORD.EXE进程，这里有一个使用WMI方法Win32_PingStatus的沙箱和fakenet旁路的示例。这将导致wmiprvse.exe成为与DNS和ICMP流量相关联的进程，而不是在WINWORD.EXE生成流量的情况下可能引起怀疑。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ka"><img src="../Images/1d1b1053d75733d44045cb656c159f7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*vl243wTxwQE4HJXGvzNASg.png"/></div></figure><p id="0fe3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第一个考验是location.microsoft.com问题能否得到解决。如果它可以被解决，或者我们可以ping主机，我们知道我们在一个假的网络中——location.microsoft.com是一个不存在的域。</p><p id="1e9b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第二项检查是userdomain和computername环境变量是否相同。如果是，则系统未加入域。</p><p id="af13" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">只有当两者都返回<strong class="ig hi"> True </strong>时，我们才会继续运行我们的有效载荷。这种绕过已经被证明可以绕过自动化沙盒系统，并且在使用沙盒解决方案来提供行为报告时将ICMP和DNS流量与样本分离。</p><p id="8627" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用我们上一节的方法来混淆字符串，检测率下降到3。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kc"><img src="../Images/345be30918fd128c820200d5ded73ef0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YiqgU1lGOIclotDVTPWw1w.png"/></div></div></figure><p id="6f72" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ju">bad BF 30 a 710 a 65 e 12 bb 0 dad 3 b 92 d6a 1938466 cc 6 ECA 6110d 63 e 909 f 305 a 824 f 1</em></p><p id="2e6a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">总之，如果您希望您的VBA不被检测到:</p><p id="6aca" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">避免使用直接来自攻击模拟框架的代码(安全公司喜欢为这些代码编写签名)</p><p id="40b6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对静态分析期间可见的有效负载使用非标准加密或编码</p><p id="9b44" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">剔除那些你需要但又不想让人觉得可疑的函数(<strong class="ig hi"> Chr() </strong>等等。)</p><p id="b760" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">制作高质量的VBA固然重要，但我们还可以做得更多。在下一个标题为<strong class="ig hi"> VBA跺脚</strong>的章节中，我们将介绍额外的混淆技术以及支持这些技术的Office内部机制，从而最大限度地降低反病毒产品的检测率。</p></div></div>    
</body>
</html>