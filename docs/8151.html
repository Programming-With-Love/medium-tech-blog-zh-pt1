<html>
<head>
<title>Exchange Data between tasks in Airflow(XCOM)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Airflow(XCOM)中的任务之间交换数据</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/exchange-data-between-tasks-in-airflow-xcom-d32a02da21a3?source=collection_archive---------0-----------------------#2022-10-03">https://medium.com/walmartglobaltech/exchange-data-between-tasks-in-airflow-xcom-d32a02da21a3?source=collection_archive---------0-----------------------#2022-10-03</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="er es ie"><img src="../Images/e31d806308323480a0d24eff8b6ab917.png" data-original-src="https://miro.medium.com/v2/resize:fit:562/format:webp/1*rpppL8KoYii7ivlz-xNxxQ.jpeg"/></div><figcaption class="il im et er es in io bd b be z dx">Source: <a class="ae ip" href="https://afiahealth.com/challenges-sharing-data-separate-ehrs/" rel="noopener ugc nofollow" target="_blank">https://afiahealth.com/challenges-sharing-data-separate-ehrs/</a></figcaption></figure><h2 id="8231" class="iq ir hh bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">介绍</h2><p id="645a" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki ha bi translated">Airflow是一个调度工具，就像Control-M、Oozie和Automic一样。在Automic中，我们设置了参数来更新数据库中的变量，我们可以在工作流中的下一个即将到来的任务中使用该变量。在气流中实现相同的场景，如1。)列出给定路径2中的文件名的第一个任务。)第二个任务下载列出的文件。</p><p id="c966" class="pw-post-body-paragraph jo jp hh jq b jr kj jt ju jv kk jx jy jb kl ka kb jf km kd ke jj kn kg kh ki ha bi translated">为了实现这个场景，我们有两种方法在气流中实现</p><h2 id="81fb" class="iq ir hh bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">不同的方法备选方案1/备选方案2:</h2><p id="dd1f" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki ha bi translated">1.)使用数据库等外部工具从第一个任务推送数据，并在第二个任务中从数据库中提取这些数据。在这里，我们必须设置到外部工具的连接，并且外部工具应该可用，以便在任务之间共享数据。</p><p id="f77c" class="pw-post-body-paragraph jo jp hh jq b jr kj jt ju jv kk jx jy jb kl ka kb jf km kd ke jj kn kg kh ki ha bi translated">2.)在没有任何外部工具的情况下，我们可以在称为XCOM的两个任务之间共享数据。XCOM(交叉通信)允许在Airflow中的任务之间交换少量数据。XCOM将这些中间数据存储在Airflow的元数据中，我们将在下面讨论这个选项。</p><p id="6198" class="pw-post-body-paragraph jo jp hh jq b jr kj jt ju jv kk jx jy jb kl ka kb jf km kd ke jj kn kg kh ki ha bi translated"><strong class="jq hi">气流中的XCOM:</strong></p><p id="c0fa" class="pw-post-body-paragraph jo jp hh jq b jr kj jt ju jv kk jx jy jb kl ka kb jf km kd ke jj kn kg kh ki ha bi translated">在dag文件夹路径中添加XCOM_PUSH_PULL.py代码后，它将出现在UI中，如下所示。</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es ko"><img src="../Images/edfd980121d84f58b991866ac6b8079c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zu4ZRdvcmon9X6dZylZOjg.png"/></div></div><figcaption class="il im et er es in io bd b be z dx">Figure 1: Shows the DAG view in UI</figcaption></figure><p id="a5cc" class="pw-post-body-paragraph jo jp hh jq b jr kj jt ju jv kk jx jy jb kl ka kb jf km kd ke jj kn kg kh ki ha bi translated">在处理任务时，item_price_a、Item_price_b和Item_price_c将使用XCOM_PUSH，并使用以下代码设置这些变量的值。</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es kx"><img src="../Images/ab0f6e460c29580a7ab01cfa52335821.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KvayweYcKvXCs6yRy8hmiw.png"/></div></div><figcaption class="il im et er es in io bd b be z dx">Figure 2: Shows the code to push data to database</figcaption></figure><p id="231b" class="pw-post-body-paragraph jo jp hh jq b jr kj jt ju jv kk jx jy jb kl ka kb jf km kd ke jj kn kg kh ki ha bi translated">上述作业中的Task4将使用XCOM_PULL从数据库中提取数据，并使用以下代码打印数据。</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es ky"><img src="../Images/2d11e9d1775a251f63afb7106b05fbf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*toQUP_lFWZvKHltMB1DTEA.png"/></div></div><figcaption class="il im et er es in io bd b be z dx">Figure 3: Shows the code to pull data from database</figcaption></figure><h1 id="7fb9" class="kz ir hh bd is la lb lc iw ld le lf ja lg lh li je lj lk ll ji lm ln lo jm lp bi translated">【XCOM _ PUSH如何在气流中工作:</h1><p id="0047" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki ha bi translated"><strong class="jq hi">XCOM _ PUSH所需的输入:</strong>它需要键和值，这些值必须被推送到气流元数据库，如下所示。</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es lq"><img src="../Images/e6abb80b5416a70ff9e53e4b92d0075a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fl8u1Atpd6fojbVESANDSw.png"/></div></div><figcaption class="il im et er es in io bd b be z dx">Figure 4: Shows the input required by xcom push</figcaption></figure><p id="0595" class="pw-post-body-paragraph jo jp hh jq b jr kj jt ju jv kk jx jy jb kl ka kb jf km kd ke jj kn kg kh ki ha bi translated">使用上面的代码，如果我们触发DAG，记录将被插入到气流元使用关键字为“项目价格”和价值为“50”。它将在“管理-&gt; XCOMS”选项卡下的气流UI中可见，如下所示。</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es ko"><img src="../Images/f18885ffa20b252adc3c7385eddad848.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yhq_n9iFAN8vqE78CHo_zA.png"/></div></div><figcaption class="il im et er es in io bd b be z dx">Figure 5: Shows the inserted value in UI</figcaption></figure><h1 id="5eae" class="kz ir hh bd is la lb lc iw ld le lf ja lg lh li je lj lk ll ji lm ln lo jm lp bi translated">XCOM_PULL在气流中的工作原理:</h1><p id="f725" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki ha bi translated">将数据推送到气流元之后，我们必须使用任务实例方法XCOM_PULL来拉取相同的数据。与XCOM_PUSH相同，XCOM_PULL需要两个输入参数:</p><ol class=""><li id="3695" class="lr ls hh jq b jr kj jv kk jb lt jf lu jj lv ki lw lx ly lz bi translated">)task_id →只从匹配id的任务中提取XComs</li><li id="11e6" class="lr ls hh jq b jr ma jv mb jb mc jf md jj me ki lw lx ly lz bi translated">)键→仅返回具有匹配键的XComs</li></ol><p id="1f84" class="pw-post-body-paragraph jo jp hh jq b jr kj jt ju jv kk jx jy jb kl ka kb jf km kd ke jj kn kg kh ki ha bi translated">我们必须像下面这样传递这个变量</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es mf"><img src="../Images/d11a406e815cbdcaa5ede914153c1884.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UOhtcM67iumXZKZMfBYezA.png"/></div></div><figcaption class="il im et er es in io bd b be z dx">Figure 6: Shows the input required by xcom pull</figcaption></figure><p id="6632" class="pw-post-body-paragraph jo jp hh jq b jr kj jt ju jv kk jx jy jb kl ka kb jf km kd ke jj kn kg kh ki ha bi translated">我们可以指定多个任务id，因此我们可以一次从多个任务中提取xcom，并且我们必须给出一个键来提取正确的xcom。</p><p id="b0a0" class="pw-post-body-paragraph jo jp hh jq b jr kj jt ju jv kk jx jy jb kl ka kb jf km kd ke jj kn kg kh ki ha bi translated">我们使用从任务item_price_a创建的关键字<em class="mg"> item_price </em>提取XComs。触发DAG后，我们可以在日志中看到如下值</p><figure class="kp kq kr ks fd ii er es paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="er es mh"><img src="../Images/6a3066363bd8b2c8dd8de528e2aadcaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ScZwkVPCImDZXhoQ3HRRmQ.png"/></div></div><figcaption class="il im et er es in io bd b be z dx">Figure 7: Shows the log with inserted data</figcaption></figure><h1 id="e55e" class="kz ir hh bd is la lb lc iw ld le lf ja lg lh li je lj lk ll ji lm ln lo jm lp bi translated">XCom的局限性:</h1><p id="0888" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki ha bi translated">Airflow不是一个数据处理框架，所以避免在任务之间发送巨大的数据帧。</p><p id="5931" class="pw-post-body-paragraph jo jp hh jq b jr kj jt ju jv kk jx jy jb kl ka kb jf km kd ke jj kn kg kh ki ha bi translated">如果我们试图在任务之间传输更多数据，我们可能会以内存问题告终，因为Airflow不是一个处理框架，而是一个编排器。XCom在气流中的限制大小基于我们用于气流元数据的数据库。</p><p id="aad6" class="pw-post-body-paragraph jo jp hh jq b jr kj jt ju jv kk jx jy jb kl ka kb jf km kd ke jj kn kg kh ki ha bi translated">对于SQLite → 2GB、Postgres →1GB和MySQL → 64KB</p><h1 id="836b" class="kz ir hh bd is la lb lc iw ld le lf ja lg lh li je lj lk ll ji lm ln lo jm lp bi translated"><strong class="ak"> <em class="mi">参考文献:</em> </strong></h1><p id="bd8d" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki ha bi translated"><a class="ae ip" href="https://airflow.apache.org/docs/apache-airflow/stable/concepts/xcoms.html" rel="noopener ugc nofollow" target="_blank">https://air flow . Apache . org/docs/Apache-air flow/stable/concepts/xcoms . html</a></p><h1 id="dee9" class="kz ir hh bd is la lb lc iw ld le lf ja lg lh li je lj lk ll ji lm ln lo jm lp bi translated">结论:</h1><p id="7deb" class="pw-post-body-paragraph jo jp hh jq b jr js jt ju jv jw jx jy jb jz ka kb jf kc kd ke jj kf kg kh ki ha bi translated">今天，您已经学习了如何使用Airflow中的XCOM在Airflow中的任务之间共享数据。现在，您已经拥有了在Dag中的任务之间进行有效通信所需的一切。请记住，Airflow不是一个数据处理框架，而是一个数据编排器。不要使用XComs来交换庞大的数据集，这样就可以了。</p></div></div>    
</body>
</html>