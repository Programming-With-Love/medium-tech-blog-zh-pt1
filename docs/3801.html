<html>
<head>
<title>Introduction to Google Cloud Armor - Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Cloud Armor介绍-第2部分</h1>
<blockquote>原文：<a href="https://medium.com/globant/introduction-to-google-cloud-armor-part-2-c3ff50739aa9?source=collection_archive---------3-----------------------#2021-12-23">https://medium.com/globant/introduction-to-google-cloud-armor-part-2-c3ff50739aa9?source=collection_archive---------3-----------------------#2021-12-23</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="cae0" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">云甲和GKE一起过滤日志</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/917e9a2c5696d5ab7a2c78626255d91c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h4TLlisFk7XvtREAsS7C7Q.jpeg"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Photo by <a class="ae jm" href="https://unsplash.com/@cgower?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Christopher Gower</a> on <a class="ae jm" href="https://unsplash.com/collections/i1PHWGMk-uE/data-security?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="a974" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">在<a class="ae jm" rel="noopener" href="/globant/introduction-to-google-cloud-armor-part-1-ddd76c7b9085">的第一篇文章</a>中，我们探讨了什么是云装甲，如何建立政策和不同种类的规则。在这一篇中，我们将把这些策略分配给目标，并详细介绍Kubernetes资源。最后，我们将看到如何通过监控和过滤生成的日志来处理第二天的操作。</p><h1 id="ccab" class="kj kk hh bd kl km kn ko kp kq kr ks kt in ku io kv iq kw ir kx it ky iu kz la bi translated">目标</h1><p id="7a2d" class="pw-post-body-paragraph jn jo hh jp b jq lb ii js jt lc il jv jw ld jy jz ka le kc kd ke lf kg kh ki ha bi translated">目标是负载平衡器，或者更正式的说法是:“非CDN HTTP(S)负载平衡器后端服务”。基本上后端服务处理负载平衡器中大多数重要的事情，你可以在这里阅读更多关于它们的<a class="ae jm" href="https://cloud.google.com/load-balancing/docs/backend-service" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="28d7" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">将策略分配给目标的最简单方法是通过web界面，转到<em class="lg"> Cloud Armor </em>，选择<em class="lg">策略</em>(我们在上一篇文章中创建的)，单击<em class="lg">目标</em>和<em class="lg">将策略应用到新目标。</em></p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lh"><img src="../Images/05ebf21e5966ff59d2ab43e2e8234125.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8f_7CAfmlsGz2kagbDEwaw.png"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Assigning the policy to a new target</figcaption></figure><p id="e018" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">在这里，您将获得一个列表，其中列出了您可以选择的所有可用且有效的负载平衡器。如果它不在列表中，则说明有问题(检查它的类型以及是否启用了CDN)。添加它们后，您就差不多完成了，策略将处于活动状态，并且基于预览标志，它将根据您在规则中指定的情况采取操作，或者只记录它将执行的操作。</p><h1 id="329c" class="kj kk hh bd kl km kn ko kp kq kr ks kt in ku io kv iq kw ir kx it ky iu kz la bi translated">GKE</h1><p id="a8fb" class="pw-post-body-paragraph jn jo hh jp b jq lb ii js jt lc il jv jw ld jy jz ka le kc kd ke lf kg kh ki ha bi translated">如果您的应用程序运行在Kubernetes集群中(在Google Kubernetes引擎上)，那么您可以以编程的方式分配策略，而不需要点击UI。</p><p id="6bda" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">如果您在Kubernetes中使用负载平衡器类型的入口或服务，那么将在GCP创建一个负载平衡器资源，通过它传入的请求将到达您的集群。您可以通过BackendConfig操作负载平衡器的特性，backend config是Kubernetes中的一个CRD。</p><h2 id="b699" class="li kk hh bd kl lj lk ll kp lm ln lo kt jw lp lq kv ka lr ls kx ke lt lu kz lv bi translated">BackendConfig</h2><p id="1839" class="pw-post-body-paragraph jn jo hh jp b jq lb ii js jt lc il jv jw ld jy jz ka le kc kd ke lf kg kh ki ha bi translated">有很多关于这个资源的<a class="ae jm" href="https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-features#configuring_ingress_features" rel="noopener ugc nofollow" target="_blank">文档</a>，但是足以说明你可以用它来配置健康检查、云装甲安全策略、超时、CDN、日志记录等等。我们将看到前两者的一个例子。</p><p id="4809" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">该资源如下所示:</p><pre class="ix iy iz ja fd lw lx ly lz aw ma bi"><span id="2a66" class="li kk hh lx b fi mb mc l md me">apiVersion: cloud.google.com/v1<br/>kind: BackendConfig<br/>metadata:<br/>  name: my-backend-config<br/>spec:<br/>  healthCheck:<br/>    checkIntervalSec: 15<br/>    port: 80<br/>    type: HTTP<br/>    requestPath: /health <br/>  securityPolicy:<br/>    name: "my-security-policy"</span></pre><p id="5357" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">在spec部分中，您定义了您想要操作的负载平衡器的元素。如您所见，我们创建了一个运行状况检查，它每15秒运行一次，并尝试访问端口80上的<code class="du mf mg mh lx b">/health</code>路径。此外，我们指定使用名为<code class="du mf mg mh lx b">my-security-policy</code>的安全策略，它应该已经存在。</p><p id="886e" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">BackendConfig应用于<strong class="jp hi">服务</strong>和<strong class="jp hi">而不是入口。</strong></p><p id="92a2" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">这是通过注释完成的，因此将以下内容添加到服务中:</p><pre class="ix iy iz ja fd lw lx ly lz aw ma bi"><span id="0401" class="li kk hh lx b fi mb mc l md me">annotations:<br/>  cloud.google.com/backend-config: '{"ports": {"80":"my-backend-config"}}'</span></pre><p id="5cb4" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">上述示例适用于服务使用端口80的情况。如果它有多个端口，并且您想要<a class="ae jm" href="https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-features#same_backendconfig_for_all_service_ports" rel="noopener ugc nofollow" target="_blank">将BackendConfig应用到所有的端口</a>，您可以使用<code class="du mf mg mh lx b">default</code>而不是<code class="du mf mg mh lx b">80</code>。</p><p id="4bb0" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">很好，到目前为止，我们创建了自己的安全策略，为它定义了规则，并将其应用于负载平衡器，甚至通过Kubernetes的定义。接下来，我们想看看Cloud Armor发现了什么，所以如果需要的话可以调整规则——我们不想让它在生产中搞得一团糟，阻止合法用户。</p><h1 id="a054" class="kj kk hh bd kl km kn ko kp kq kr ks kt in ku io kv iq kw ir kx it ky iu kz la bi translated">记录</h1><p id="494e" class="pw-post-body-paragraph jn jo hh jp b jq lb ii js jt lc il jv jw ld jy jz ka le kc kd ke lf kg kh ki ha bi translated">你可以在日志部分访问Cloud Armor采取的所有行动。只需转到策略并点击<em class="lg">日志</em>(在<em class="lg">目标</em>旁边)。这将带您进入<em class="lg">操作</em>中心的<em class="lg">日志</em>部分，其中有一个预定义的查询，如下所示:</p><pre class="ix iy iz ja fd lw lx ly lz aw ma bi"><span id="ff37" class="li kk hh lx b fi mb mc l md me">resource.type:(http_load_balancer) AND jsonPayload.enforcedSecurityPolicy.name:(my-security-policy)</span></pre><p id="dec8" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">很基本的东西。这将在右上角显示在过去~指定时间内发生的所有请求，通常是1小时。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es mi"><img src="../Images/a2e36f0312d3640ce64ab1bea4d3f955.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*I-PeM2xZAqogzcu-3sSUog.png"/></div><figcaption class="ji jj et er es jk jl bd b be z dx">27 million logs in the last 7 days</figcaption></figure><p id="ad74" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">这很容易变成一个巨大的数字，所以你需要一种方法来过滤它们。首先，您可以只检查警告消息，因为合法的请求并不那么有趣。点击其中一个日志，并使用<em class="lg">扩展嵌套字段</em>按钮查看与其相关的所有详细信息。</p><p id="e890" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">这里最重要的是<em class="lg"> remoteIp </em>(用户的Ip地址)、<em class="lg"> userAgent、status、enforcedSecurityPolicy </em>和<em class="lg"> previewSecurityPolicy。</em></p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mj"><img src="../Images/a850a8f3d250f406d12e760b7ad63b07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_3frp8gRoqzpJheMR6ptnA.png"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Example log entry — with some fields removed</figcaption></figure><p id="ab64" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated"><em class="lg"> enforcedSecurityPolicy </em>给你云装甲采取的实际行动，在这种情况下，它被允许通过。<em class="lg"> previewSecurityPolicy </em>显示了如果预览模式未启用时的操作。例如，动作可以是<em class="lg">拒绝或</em>基于费率的禁止。</p><p id="2708" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">因此，要获取所有可能被阻止的日志，可以使用以下查询:</p><pre class="ix iy iz ja fd lw lx ly lz aw ma bi"><span id="91bb" class="li kk hh lx b fi mb mc l md me">resource.type:(http_load_balancer) AND jsonPayload.enforcedSecurityPolicy.name:(my-security-policy) AND jsonPayload.previewSecurityPolicy.configuredAction!=Accept AND severity=WARNING</span></pre><p id="78dc" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">AND运算符不是必需的，因为这是默认行为。严重性不一定是警告类型，正常请求也可以被抑制。</p><p id="037a" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">这种方法有助于了解系统中发生了什么。但是如果有大量的日志(数千或数百万)，您不能一个一个地查看它们，但是您仍然想知道哪些类型的请求被阻塞了，尤其是在使用WAF功能时。<br/>为此，您可以创建一个脚本来自动解析日志条目。</p><h2 id="c153" class="li kk hh bd kl lj lk ll kp lm ln lo kt jw lp lq kv ka lr ls kx ke lt lu kz lv bi translated">被阻止漏洞的脚本</h2><p id="baac" class="pw-post-body-paragraph jn jo hh jp b jq lb ii js jt lc il jv jw ld jy jz ka le kc kd ke lf kg kh ki ha bi translated">您需要安装<em class="lg"> gcloud </em>实用程序，以及用于解析JSON的<em class="lg"> jq </em>。</p><p id="edd1" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">示例脚本如下所示，当然需要根据您的具体需求进行微调:</p><pre class="ix iy iz ja fd lw lx ly lz aw ma bi"><span id="e25f" class="li kk hh lx b fi mb mc l md me">gcloud logging read 'resource.type:(http_load_balancer) AND severity=WARNING AND jsonPayload.previewSecurityPolicy.configuredAction="DENY"' --format json --limit 1000 --freshness='7d' --project=$myproject &gt; cloud-armor-logs.json</span><span id="9169" class="li kk hh lx b fi mk mc l md me">jq -r ".[] | .jsonPayload.previewSecurityPolicy.preconfiguredExprIds" cloud-armor-logs.json &gt; vulnerabilities</span><span id="0b8a" class="li kk hh lx b fi mk mc l md me">sed -i '' -e 's/[][]//g' vulnerabilities<br/>sort log-result | uniq &gt; unique_vulnerabilities</span><span id="e0b1" class="li kk hh lx b fi mk mc l md me">rm vulnerabilities<br/>rm cloud-armor-logs.json</span></pre><p id="4c85" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">这将获得过去7天中所有被拒绝的请求(从预览中)，最多1000个日志，并将它们保存到一个JSON文件中。然后我们解析这个文件，只从中提取漏洞，然后进行排序。从结果来看，我们只保留了独特的漏洞类型，可能如下所示:</p><pre class="ix iy iz ja fd lw lx ly lz aw ma bi"><span id="12e6" class="li kk hh lx b fi mb mc l md me">  "owasp-crs-v030001-id913101-scannerdetection"<br/>  "owasp-crs-v030001-id941130-xss"<br/>  "owasp-crs-v030001-id942200-sqli"<br/>  "owasp-crs-v030001-id942260-sqli"<br/>  "owasp-crs-v030001-id942410-sqli"<br/>  "owasp-crs-v030001-id942430-sqli"</span></pre><p id="8105" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">由此，我们可以看到，多个SQL注入尝试将被阻止，以及一些XSS和scannerdetection。基于这些，我们可以对我们的规则做出一些适当的决定。</p><p id="d72e" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">这个脚本当然可以改进，比如添加请求的数量、来源国、提供过滤选项作为参数等。我会留给好奇的读者，但是如果你创造了一些好的东西，你可以在评论中与我们分享。</p><h1 id="7066" class="kj kk hh bd kl km kn ko kp kq kr ks kt in ku io kv iq kw ir kx it ky iu kz la bi translated">摘要</h1><p id="3dd6" class="pw-post-body-paragraph jn jo hh jp b jq lb ii js jt lc il jv jw ld jy jz ka le kc kd ke lf kg kh ki ha bi translated">感谢您坚持通过这两篇文章来了解更多关于云甲的知识。现在，您可以开始自己探索，为您的应用程序创建策略和规则，将其分配给目标，并通过日志监控发生的事情。</p></div><div class="ab cl ml mm go mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ha hb hc hd he"><p id="f4f7" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">这些是我的第一篇媒体文章，所以如果你喜欢它们，你可以给我一个掌声，并在评论中留下一些建设性的批评。</p><p id="0d7c" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">下次见！</p></div></div>    
</body>
</html>