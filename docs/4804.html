<html>
<head>
<title>Images sharing in Gradle multiprojects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">梯度多项目中的图像共享</h1>
<blockquote>原文：<a href="https://blog.kotlin-academy.com/images-sharing-in-gradle-multiprojects-aba5e6bc8b1a?source=collection_archive---------0-----------------------#2017-12-18">https://blog.kotlin-academy.com/images-sharing-in-gradle-multiprojects-aba5e6bc8b1a?source=collection_archive---------0-----------------------#2017-12-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="9c34" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Gradle多项目非常棒！我们可以用机器人，后端，前端，以及我们需要的任何其他单个项目。<a class="ae ki" rel="noopener ugc nofollow" target="_blank" href="/architecture-for-multiplatform-development-in-kotlin-cc770f4abdfd">在上一篇文章</a>中，我展示了如何在Gradle上进行大规模多平台多项目，以及如何使用Kotlin公共模块实现大量代码共享。虽然很多元素不能这样共享。有些是图像。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi kj"><img src="../Images/a968242cd96f227f544abbd8b987f6c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/0*AV2_gxDQc1dm8zpt.jpg"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Image from <a class="ae ki" href="https://media.licdn.com/mpr/mpr/AAEAAQAAAAAAAALKAAAAJGEzNDNlNWZmLTcwMTMtNDhlZi04ZjY0LWYxNTgxZTJjOWYwNw.jpg" rel="noopener ugc nofollow" target="_blank">licdn.com</a></figcaption></figure><p id="0ddb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当我们有多平台项目，我们将总是需要在不同的客户端相同的图像。图像的问题是，在不同的模块中，我们需要不同密度的不同图像。更复杂的是，一些客户端，如Android或iOS，需要不同尺寸设备的不同版本的图像。这使得实现图像共享机制变得更加困难。但这是可能的，而且绝对是值得的！以下是一些利润:</p><ul class=""><li id="85fa" class="kv kw in jm b jn jo jr js jv kx jz ky kd kz kh la lb lc ld bi translated">机制会将资源复制到所有需要它的客户端。</li><li id="1551" class="kv kw in jm b jn le jr lf jv lg jz lh kd li kh la lb lc ld bi translated">机制将为我们处理不同的图像变体创建。比如创建mdpi，hdpi，xhdpi等等。对于Android和1x，2x等。对于iOS。</li><li id="7edc" class="kv kw in jm b jn le jr lf jv lg jz lh kd li kh la lb lc ld bi translated">当我们改变图像时，我们只需要在一个单独的文件夹中改变它，而不是通过搜索客户端来找到它在其他地方被使用。</li></ul><p id="0e29" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">请注意，您并不真的需要多个模块来从这种机制中获益。即使你有一个模块，里面有不同版本的图片，这也是很有帮助的。</p><p id="f617" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我希望这是令人信服的。让我们直接看代码。</p><h1 id="9f68" class="lj lk in bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">履行</h1><p id="44d8" class="pw-post-body-paragraph jk jl in jm b jn mh jp jq jr mi jt ju jv mj jx jy jz mk kb kc kd ml kf kg kh ig bi translated">在这个Kotlin多平台项目中可以找到完全实现的机制。具体实现放在<code class="fe mm mn mo mp b">imagesShare.gradle</code>文件中。为了将它包含到项目中，我们必须使用<code class="fe mm mn mo mp b">build.gradle</code>中的<code class="fe mm mn mo mp b">apply</code>函数:</p><pre class="kk kl km kn gt mq mp mr ms aw mt bi"><span id="0ff1" class="mu lk in mp b gy mv mw l mx my">apply <strong class="mp io">from</strong>: <strong class="mp io">'imagesShare.gradle'</strong></span></pre><p id="4388" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">为了实现该机制，我们需要一种方法来实现调整图像大小的任务。有很多不同的库可以用于此，但我决定使用<a class="ae ki" href="https://github.com/eowise/gradle-imagemagick" rel="noopener ugc nofollow" target="_blank"> gradle-imagemagick </a>。为了包含它，我们需要添加以下声明:(您还需要安装<a class="ae ki" href="https://github.com/ImageMagick/ImageMagick" rel="noopener ugc nofollow" target="_blank"> ImageMagick </a>，但是大多数Linux都默认安装了它，并且很容易安装到其他系统中)</p><pre class="kk kl km kn gt mq mp mr ms aw mt bi"><span id="22f0" class="mu lk in mp b gy mv mw l mx my">buildscript {<br/>    repositories {<br/>        jcenter()<br/>    }<br/><br/>    dependencies {<br/>        classpath <strong class="mp io">'com.eowise:gradle-imagemagick:0.4.0'<br/>    </strong>}<br/>}</span></pre><p id="edf3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">接下来，我们需要定义我们想要放置调整过大小的图像的位置。定义这些信息的简单方法是使用Gradle集合文字。怎么可能呢？记住Groovy脚本是用Gradle编写的，所以我们可以使用它的所有语法。我们可以把它们定义为常数:</p><pre class="kk kl km kn gt mq mp mr ms aw mt bi"><span id="3f78" class="mu lk in mp b gy mv mw l mx my"><strong class="mp io">def </strong>androidMobileResDir = <strong class="mp io">"android/mobile/src/main/res"<br/>def </strong>androidWearResDir = <strong class="mp io">"android/wear/src/main/res/drawable"<br/>def </strong>webImgDir = <strong class="mp io">"web/src/main/web/img"<br/>def </strong>desktopImgDir = <strong class="mp io">"desktop/src/main/resources/images"</strong></span></pre><p id="7e2a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下面是我们如何定义我们想要在不同的项目类型中包含什么样的图像:(这是一个从字符串到字符串列表的映射)</p><pre class="kk kl km kn gt mq mp mr ms aw mt bi"><span id="528f" class="mu lk in mp b gy mv mw l mx my"><strong class="mp io">def </strong>imagesInclude = [<br/>        <strong class="mp io">"Android"</strong>: [<strong class="mp io">"banner.jpg"</strong>,<br/>                    <strong class="mp io">"icon_notification.png"</strong>,<br/>                    <strong class="mp io">"talk_icon.png"</strong>,<br/>                    <strong class="mp io">"launcher_icon.png"</strong>,<br/>                    <strong class="mp io">"launcher_circle_icon.png"</strong>,<br/>                    <strong class="mp io">"share_icon.png"</strong>],<br/>        <strong class="mp io">"Web"    </strong>: [<strong class="mp io">"banner.jpg"</strong>,<br/>                    <strong class="mp io">"error.png"</strong>,<br/>                    <strong class="mp io">"facebook_icon.png"</strong>,<br/>                    <strong class="mp io">"logo.png"</strong>,<br/>                    <strong class="mp io">"spinner.gif"</strong>,<br/>                    <strong class="mp io">"talk_icon.png"</strong>,<br/>                    <strong class="mp io">"thank_you.jpg"</strong>,<br/>                    <strong class="mp io">"twitter_icon.png"</strong>],<br/>        <strong class="mp io">"Desktop"</strong>: [<strong class="mp io">"banner.jpg"</strong>],<br/>]</span></pre><p id="a83e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最后，我们应该明确任务。<code class="fe mm mn mo mp b">resizeTasksConfig</code>说明什么是目的地，它们是什么类型，以及每个任务的预期密度是多少。它还指定了<code class="fe mm mn mo mp b">taskName</code>,以防我们只需要运行一个任务。</p><pre class="kk kl km kn gt mq mp mr ms aw mt bi"><span id="bcb8" class="mu lk in mp b gy mv mw l mx my"><strong class="mp io">def </strong>resizeTasksConfig = [<br/>        [<strong class="mp io">type</strong>: <strong class="mp io">"Android"</strong>, <strong class="mp io">taskName</strong>: <strong class="mp io">'PrepareImagesAndroidMobileMdpi'</strong>, <strong class="mp io">to</strong>: <strong class="mp io">"</strong>$androidMobileResDir<strong class="mp io">/drawable-mdpi"</strong>, <strong class="mp io">density</strong>: <strong class="mp io">'160'</strong>],<br/>        [<strong class="mp io">type</strong>: <strong class="mp io">"Android"</strong>, <strong class="mp io">taskName</strong>: <strong class="mp io">'PrepareImagesAndroidMobileHdpi'</strong>, <strong class="mp io">to</strong>: <strong class="mp io">"</strong>$androidMobileResDir<strong class="mp io">/drawable-hdpi"</strong>, <strong class="mp io">density</strong>: <strong class="mp io">'240'</strong>],<br/>        [<strong class="mp io">type</strong>: <strong class="mp io">"Android"</strong>, <strong class="mp io">taskName</strong>: <strong class="mp io">'PrepareImagesAndroidMobileXhdpi'</strong>, <strong class="mp io">to</strong>: <strong class="mp io">"</strong>$androidMobileResDir<strong class="mp io">/drawable-xhdpi"</strong>, <strong class="mp io">density</strong>: <strong class="mp io">'320'</strong>],<br/>        [<strong class="mp io">type</strong>: <strong class="mp io">"Android"</strong>, <strong class="mp io">taskName</strong>: <strong class="mp io">'PrepareImagesAndroidMobileXxdpi'</strong>, <strong class="mp io">to</strong>: <strong class="mp io">"</strong>$androidMobileResDir<strong class="mp io">/drawable-xxhdpi"</strong>, <strong class="mp io">density</strong>: <strong class="mp io">'480'</strong>],<br/>        [<strong class="mp io">type</strong>: <strong class="mp io">"Android"</strong>, <strong class="mp io">taskName</strong>: <strong class="mp io">'PrepareImagesAndroidMobileXxxdpi'</strong>, <strong class="mp io">to</strong>: <strong class="mp io">"</strong>$androidMobileResDir<strong class="mp io">/drawable-xxxhdpi"</strong>, <strong class="mp io">density</strong>: <strong class="mp io">'640'</strong>],<br/>        [<strong class="mp io">type</strong>: <strong class="mp io">"Android"</strong>, <strong class="mp io">taskName</strong>: <strong class="mp io">'PrepareImagesAndroidWear'</strong>, <strong class="mp io">to</strong>: androidWearResDir, <strong class="mp io">density</strong>: <strong class="mp io">'240'</strong>],<br/>        [<strong class="mp io">type</strong>: <strong class="mp io">"Web"</strong>, <strong class="mp io">taskName</strong>: <strong class="mp io">'PrepareImagesWeb'</strong>, <strong class="mp io">to</strong>: webImgDir, <strong class="mp io">density</strong>: <strong class="mp io">'800'</strong>],<br/>        [<strong class="mp io">type</strong>: <strong class="mp io">"Desktop"</strong>, <strong class="mp io">taskName</strong>: <strong class="mp io">'PrepareImagesDesktop'</strong>, <strong class="mp io">to</strong>: desktopImgDir, <strong class="mp io">density</strong>: <strong class="mp io">'500'</strong>]<br/>]</span></pre><p id="79cb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于<code class="fe mm mn mo mp b">resizeTasksConfig</code>的每个元素，我们需要创建一个任务来处理调整到新目的地的大小。如果我们记住任务创建只是调用<code class="fe mm mn mo mp b">task</code>函数，那么实现起来就很简单。因此，我们可以通过迭代<code class="fe mm mn mo mp b">resizeTasksConfig</code>列表来定义所有这些任务:</p><pre class="kk kl km kn gt mq mp mr ms aw mt bi"><span id="21f6" class="mu lk in mp b gy mv mw l mx my">resizeTasksConfig.each { item -&gt;<br/>    task(item.<strong class="mp io">taskName</strong>, <strong class="mp io">type</strong>: com.eowise.imagemagick.tasks.Magick) {<br/>        convert <strong class="mp io">'commonImages'</strong>, { include imagesInclude[item.<strong class="mp io">type</strong>] }<br/>        into item.<strong class="mp io">to<br/>        </strong>actions {<br/>            -background(<strong class="mp io">'none'</strong>)<br/>            inputFile()<br/>            -density(item.<strong class="mp io">density</strong>)<br/>            outputFile()<br/>        }<br/>    }<br/>}</span></pre><p id="30b2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所有这些任务都是<code class="fe mm mn mo mp b">Magic</code>类型的——由于这一点，我们可以用具体的行动来转换。我们指定从<code class="fe mm mn mo mp b">commonImages</code>文件夹中获取图像，但只包括由<code class="fe mm mn mo mp b">imagesInclude</code>为项目<code class="fe mm mn mo mp b">type</code>指定的文件。然后我们指定转换后的文件应该放在哪里，应该调用什么覆盖动作。对于动作，我们指定我们期望的密度。</p><p id="7faf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在任务已经创建，我们可以调用其中的每一个任务:</p><pre class="kk kl km kn gt mq mp mr ms aw mt bi"><span id="3a1d" class="mu lk in mp b gy mv mw l mx my">./gradlew PrepareImagesAndroidMobileXxdpi</span></pre><p id="50d9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">尽管一个接一个地手动调用它们并不明智。相反，我们希望用单个任务来调用它们。我们可以这样定义它:</p><pre class="kk kl km kn gt mq mp mr ms aw mt bi"><span id="838c" class="mu lk in mp b gy mv mw l mx my">task shareImages {<br/>    dependsOn resizeTasksConfig.collect { it.<strong class="mp io">taskName </strong>}<br/>}</span></pre><p id="e1ae" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe mm mn mo mp b">resizeTasksConfig</code>是一个列表，<code class="fe mm mn mo mp b">collect</code>是Java、Kotlin或Scala <code class="fe mm mn mo mp b">map</code>的Groovy等价物——它将列表中的每个元素映射到其他元素。这里是映射到字符串列表的映射列表，由<code class="fe mm mn mo mp b">dependsOn</code>函数接受。这就是为什么<code class="fe mm mn mo mp b">shareImages</code>总是依赖于<code class="fe mm mn mo mp b">resizeTasksConfig</code>中指定的所有任务。</p><p id="e401" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这是不够的，因为如果我们需要删除一些图像怎么办？我们不仅要创建不同的图像，还要清理所有创建的文件夹。这就是我们如何实施任务，从我们的图像共享任务的所有目的地清除所有内容:</p><pre class="kk kl km kn gt mq mp mr ms aw mt bi"><span id="a9cf" class="mu lk in mp b gy mv mw l mx my">task cleanImages &lt;&lt; {<br/>    resizeTasksConfig.each { delete it.<strong class="mp io">to </strong>}<br/>}</span></pre></div><div class="ab cl mz na hr nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ig ih ii ij ik"><p id="6938" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下一篇文章:</p><div class="ng nh gp gr ni nj"><a rel="noopener  ugc nofollow" target="_blank" href="/extracting-multiplatform-common-modules-in-android-4a564cc03e0a"><div class="nk ab fo"><div class="nl ab nm cl cj nn"><h2 class="bd io gy z fp no fr fs np fu fw im bi translated">Android中多平台通用模块的提取</h2><div class="nq l"><h3 class="bd b gy z fp no fr fs np fu fw dk translated">你知道如何制作Android项目，但现在你想让它们多平台化。你听说了新的可能性…</h3></div><div class="nr l"><p class="bd b dl z fp no fr fs np fu fw dk translated">blog.kotlin-academy.com</p></div></div><div class="ns l"><div class="nt l nu nv nw ns nx kp nj"/></div></div></a></div></div><div class="ab cl mz na hr nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ig ih ii ij ik"><p id="2c21" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">希望这篇文章有帮助。我决定把这篇文章的推广工作留给那些觉得自己学到了新东西的读者。因此，如果你认为你从这篇文章中受益，如果你能在你最喜欢的<a class="ae ki" href="https://www.facebook.com/" rel="noopener ugc nofollow" target="_blank">脸书</a>和<a class="ae ki" href="https://www.reddit.com/" rel="noopener ugc nofollow" target="_blank"> Reddit </a>群组或<a class="ae ki" href="https://twitter.com/" rel="noopener ugc nofollow" target="_blank"> Twitter </a>中分享它，那会很好。同样<strong class="jm io">鼓掌</strong>会帮助其他人在medium上找到这篇文章。</p><p id="3381" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">科特林学院包含了更多有用的提示和想法，所以如果你想了解最新信息，就关注这个媒体吧。我也在Twitter 上发布有用的东西<a class="ae ki" href="https://twitter.com/marcinmoskala" rel="noopener ugc nofollow" target="_blank">，所以如果你使用它，你可能想</a><a class="ae ki" href="https://twitter.com/marcinmoskala" rel="noopener ugc nofollow" target="_blank">关注我</a>。为了提用<a class="ae ki" href="https://twitter.com/marcinmoskala" rel="noopener ugc nofollow" target="_blank"> @MarcinMoskala </a>。</p><p id="a306" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你需要格雷迪的帮助，请记住，我愿意接受咨询。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><a href="http://eepurl.com/diMmGv"><div class="gh gi ny"><img src="../Images/5ce68714efe3efc036e06786166954ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uDqv_d5NZnPUJA0FeZqhqQ.png"/></div></a></figure></div><div class="ab cl mz na hr nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ig ih ii ij ik"><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="oa ob di oc bf od"><div class="gh gi nz"><img src="../Images/f36a792ac0eb95fc577e6f4125dba956.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*zo_H5DsF3fI8ucapgZHWWw.gif"/></div></div></figure></div></div>    
</body>
</html>