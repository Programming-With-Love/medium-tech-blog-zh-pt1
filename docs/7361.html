<html>
<head>
<title>Operating Vitess</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">操作Vitess</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/operating-vitess-d90eb01e5b4d?source=collection_archive---------2-----------------------#2018-12-18">https://medium.com/square-corner-blog/operating-vitess-d90eb01e5b4d?source=collection_archive---------2-----------------------#2018-12-18</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="0551" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">把维特思拆开，再把它拼起来。</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/4a7fc667ba7fba337e53e7e70e3c6f7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F7DZvGfvFGewhE5WfettYg.png"/></div></div></figure><blockquote class="ji jj jk"><p id="05d7" class="jl jm jn jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae ki" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><p id="6603" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">随着时间的推移，在我们现有的MySQL数据库上上线Vitess，然后对其进行分片和更大规模的操作，这是一个相当大的挑战。个人喜欢使用Cash应用程序，虽然这是一件好事，但对高峰负载毫无准备会给新用户和现有用户带来糟糕的体验。当我们开始分片时，每当我了解到我们的增量增长时，一句<a class="ae ki" href="https://www.youtube.com/watch?v=l1dnqKGuezo" rel="noopener ugc nofollow" target="_blank">标志性的台词</a><em class="jn">【The Wire】</em>参议员Clay Davis就会浮现在我的脑海中。我们已经优化了公共代码路径，并尽可能消除了所有低效的代码。我们运行在昂贵的硬件和借来的时间上。我们迫切需要一个可扩展的解决方案。</p><p id="4110" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">有两个Vitess组件，VtTablet和VtGate，几乎每个Vitess持久性请求都涉及到它们。VtTablet是一个运行在每个MySQL前面的代理，它允许Vitess以多种方式共享连接和保护数据库，比如规定最大查询时间和大小。VtTablet意味着与MySQL数据库是1:1的关系。它是管理的，通常与MySQL托管在同一个主机上。它使用本地或TCP套接字连接到MySQL数据库。VtGate是查询路由器。它监视Vitess集群的当前状态，计算出哪些查询应该发送到哪些数据库，根据需要重写查询和聚合数据。VtGate是该应用程序进入Vitess的入口。通常情况下，您的应用程序使用MySQL协议或Vitess驱动程序连接到任何一个VtGates车队。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es km"><img src="../Images/4679c561cd1f2c5fc0c8d5e711d59dd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/1*Ru1HUjqBYClGn5-8BiIMig.gif"/></div></figure><p id="a4d4" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">当我们第一次开始使用Vitess时，我们非常关心VtTablet可能会使用哪些资源。VtTablet可能会耗尽MySQL进程所需的资源。增加额外的负载可能会占用数据库的资源，这似乎是非常不明智的。我们试图通过分片来减少负载。我们需要将这些问题/组件分开，因此我们将VtTablet放在了单独的主机上。这非常有效，让我们度过了最初的几次分裂，我们在快速获得更小的碎片和小心翼翼地运用这种新的(对我们来说)碎片分裂技术之间取得了平衡。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es km"><img src="../Images/ba9178dc0c561c6b110fd3e9991dcbbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*HM8sgphRKHBamrxhMQZ7aw.jpeg"/></div><figcaption class="kn ko et er es kp kq bd b be z dx">Everything on its own</figcaption></figure><p id="0f38" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">有一些缺点:VtTablet主机使用大量网络容量，因为它位于额外的一跳之后。此外，我们被迫对VtTablet和MySQL之间的数据进行加密，这增加了整体CPU使用率。另一个缺点是管理VtTablet对MySQL的1:1特性。我们最终使用我们的Vitess lockserver的一部分来锁定哪个VtTablet在哪个MySQL前面运行。当您有4个集群时，管理和跟踪什么去了哪里是相当容易的。然而，随着每一次分裂，这个数字都会翻倍，因此一切都变得越来越难以追踪。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es kr"><img src="../Images/d1ff294617b34489a462aacb5a80b1dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*p99lH3S8KXlOmLUOGJr6KQ.png"/></div><figcaption class="kn ko et er es kp kq bd b be z dx">Generated using <a class="ae ki" href="https://fontmeme.com/keep-calm/" rel="noopener ugc nofollow" target="_blank">fontmeme.com</a></figcaption></figure><p id="e85c" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">快进几个月，我们一直在分裂。最后，我们的数据库缩减到了一个更合理的大小，而且数量也更多了。app、VtGate、VtTablet、MySQL进程都在自己的主机上。Vitess进程的运行只占主机容量的一小部分，因此它们可以在其他应用程序旁边运行。我们不断要求我们的硬件团队提供更多的主机。被问得越来越频繁的问题是，我们如何节省CPU和/或更充分地利用硬件。我们甚至达到了运行VtGate主机多于应用主机的地步。</p><p id="5806" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">既然我们已经看到了那些Vitess进程是如何在我们的负载下运行的，我们开始重新考虑将所有这些事情分开的决定。分析证实，大部分请求时间都花在了数据的移动上，要么是处理TLS，要么是编组/解组数据包。我们遇到的另一个问题是，当VtGate不可访问时，例如在VtGate部署期间，我们的驱动程序有一些适应问题。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es ks"><img src="../Images/d559289a725dfa78383d8b8673b838b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ap37UXuElFePrfdmIjxh-A.jpeg"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx">“<a class="ae ki" href="https://www.flickr.com/photos/23291498@N04/5539212408/" rel="noopener ugc nofollow" target="_blank">Sidecar</a>” by <a class="ae ki" href="https://www.flickr.com/photos/23291498@N04/" rel="noopener ugc nofollow" target="_blank">cireremarc</a> is licensed under <a class="ae ki" href="https://creativecommons.org/licenses/by/2.0/" rel="noopener ugc nofollow" target="_blank">CC BY 2.0</a></figcaption></figure><p id="0e39" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">鉴于这些问题和硬件限制，我们开始将这些组件重新组合在一起。我们开始在一台sidecar进程配置的机器上将这些组件作为单独的进程运行。我们通过不再花费CPU加密来节省TLS。通过使用本地套接字或文件描述符进行通信，我们节省了CPU数据包处理。我们首先关心的是所有那些VtGates。VtGates比实际的应用程序机器还多，这似乎很荒谬。通过在应用和VtGate之间使用一个仅用于主机的本地端口传输流量，这一点很快就实现了，因此不再需要TLS。</p><p id="8f71" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">是时候重访孤立的VtTablet了。如果我们要在MySQL的同一台机器上托管VtTablet，我们将需要更多的MySQL主机，但是，我们可以返回当前作为单独的vt table t运行的所有主机。此迁移正在进行中。随着虚拟平板电脑的列表越来越长，我们遇到了几个挑战，如何保持虚拟平板电脑与MySQLs的一对一映射。将VtTablet和MySQL一起运行的一个很大的副作用是，对于VtTablet来说，它与哪个MySQL配对是显而易见的。所有的锁服务器代码都被扔进垃圾桶了，好哇！所以最终有了这个解决方案真是太棒了。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es km"><img src="../Images/0e0587cada85f6d41c6041e29e12fe8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*zQlknuT372JM7dJlhochLw.jpeg"/></div><figcaption class="kn ko et er es kp kq bd b be z dx">Friends forever</figcaption></figure><p id="f961" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">回想起来，整个练习似乎有点绕圈。然而，在首次部署和使用Vitess时，将Vitess分开有助于我们降低风险。推行sidecar使Vitess更易于管理，并降低了我们的硬件成本。这可能会冒犯我干燥的(不要重复你自己)有原则的大脑，但通过在前进之前后退一步，我们已经能够随着时间的推移继续向更多的客户提供体验。软件的一个伟大之处在于，如果你把某个东西拆开了，以后再把它拼起来通常并不困难。</p><p id="2ed0" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">这篇文章是Square<a class="ae ki" rel="noopener" href="/square-corner-blog/sharding-cash-10280fa3ef3b">Vitess系列</a>的一部分。</p></div><div class="ab cl kt ku go kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="ha hb hc hd he"><p id="42f5" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated"><em class="jn">这是因为在开始时，获得几个宿主的部分比获得一小组完整的宿主更容易。</em></p></div></div>    
</body>
</html>