<html>
<head>
<title>Working with Google Play Billing — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Play计费—第2部分</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/working-with-google-play-billing-part-2-b859b55426d2?source=collection_archive---------1-----------------------#2020-09-29">https://medium.com/androiddevelopers/working-with-google-play-billing-part-2-b859b55426d2?source=collection_archive---------1-----------------------#2020-09-29</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/bcb92c100338b84f037f344ed6eda02a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bY8dAIXaEAmIHm37IPJw3A.jpeg"/></div></div></figure><div class=""/><p id="af04" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这是关注将Google Play的计费系统集成到您的Android应用程序的系列文章中的第二篇。如果您想从头开始，请查看关于如何设置您的Android应用程序以开始使用Google Play计费库的第一篇博客文章。</p><p id="a804" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在本帖中，我们将进一步了解一次性购买的生命周期，即销售和授权用户在你的应用中购买的数字产品的过程。为了简单起见，我们现在将集中于一次性购买。在下一篇文章中，我们将详细研究订阅购买的更复杂的生命周期。</p><p id="c736" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一次性产品既可以是<em class="jo">耗材</em>也可以是<em class="jo">非耗材</em>。可消耗的产品意味着用户可以再次购买。例如，如果您的应用程序是一个允许用户购买硬币的游戏，您可以将硬币变成一个可消费的产品，以便用户可以多次购买。非消耗品意味着用户只能购买一次。非消耗性产品的一个很好的例子是包括额外应用内功能的高级升级。</p><p id="8166" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在Google Play控制台中配置好应用内产品后，销售产品的流程如下:</p><figure class="jq jr js jt fd hj er es paragraph-image"><div class="er es jp"><img src="../Images/54c330d7d8f8e02d5a9e982b3f5d20d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*VO90h6uSgomdhZTDmYG_PQ.png"/></div></figure><p id="26df" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">让我们来分解这个过程的每一步。</p><p id="2c74" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">1.<strong class="ir ht">设置计费客户端</strong>—<code class="du ju jv jw jx b">BillingClient</code>类允许你的应用与播放计费库通信。你的应用需要做的第一件事是通过调用<code class="du ju jv jw jx b"><a class="ae jn" href="https://developer.android.com/reference/com/android/billingclient/api/BillingClient#startconnection" rel="noopener ugc nofollow" target="_blank">startConnection()</a></code>建立与Google Play的连接。</p><p id="fd36" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">连接不能保证保持活跃，所以你的应用程序还必须通过覆盖<code class="du ju jv jw jx b"><a class="ae jn" href="https://developer.android.com/reference/com/android/billingclient/api/BillingClientStateListener#onBillingServiceDisconnected()" rel="noopener ugc nofollow" target="_blank">onBillingServiceDisconnected()</a></code> <a class="ae jn" href="https://developer.android.com/reference/com/android/billingclient/api/BillingClientStateListener#onBillingServiceDisconnected()" rel="noopener ugc nofollow" target="_blank"> </a>回调来处理重新连接，以确保应用程序在发出任何进一步请求之前连接到Google Play。</p><figure class="jq jr js jt fd hj"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="1bbb" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">2.<strong class="ir ht">获取用户已购买的商品</strong> —一旦<code class="du ju jv jw jx b">BillingClient</code>成功设置，您的应用程序现在可以通过调用<code class="du ju jv jw jx b"><a class="ae jn" href="https://developer.android.com/reference/com/android/billingclient/api/BillingClient#querypurchases" rel="noopener ugc nofollow" target="_blank">queryPurchases()</a></code>来查询用户之前购买的商品。</p><figure class="jq jr js jt fd hj"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="5173" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">3.<strong class="ir ht">展示待售产品</strong> —在<a class="ae jn" rel="noopener" href="/googleplaydev/working-with-google-play-billing-part-1-387677bd632b">之前的帖子</a>中，我们讨论了如何在Google Play控制台中设置产品，并在您的应用程序中查询这些产品。一旦您调用<code class="du ju jv jw jx b"><a class="ae jn" href="https://developer.android.com/reference/com/android/billingclient/api/BillingClient#queryskudetailsasync" rel="noopener ugc nofollow" target="_blank">querySkuDetailsAsync()</a></code>来获得每个产品的<code class="du ju jv jw jx b"><a class="ae jn" href="https://developer.android.com/reference/com/android/billingclient/api/SkuDetails" rel="noopener ugc nofollow" target="_blank">SkuDetails</a></code>，您就可以使用这些信息来相应地设置您的UI。</p><figure class="jq jr js jt fd hj"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="4e90" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">4.<strong class="ir ht">启动购买流程— </strong>当用户点击某个产品进行购买时，您的应用程序应该通过使用该产品的<code class="du ju jv jw jx b"><a class="ae jn" href="https://developer.android.com/reference/com/android/billingclient/api/SkuDetails" rel="noopener ugc nofollow" target="_blank">SkuDetails</a></code>调用<code class="du ju jv jw jx b"><a class="ae jn" href="https://developer.android.com/reference/com/android/billingclient/api/BillingClient#launchbillingflow" rel="noopener ugc nofollow" target="_blank">launchBillingFlow()</a></code>，向用户呈现Google Play购买屏幕。<strong class="ir ht"> </strong>这将弹出一个类似如下的屏幕:</p><figure class="jq jr js jt fd hj er es paragraph-image"><div class="er es ka"><img src="../Images/a44015611ca19ec839fd801f2cc9d0e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:500/format:webp/1*sK5Z61NKxa7xtq9mYwAqeA.png"/></div></figure><figure class="jq jr js jt fd hj"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="ebee" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">5.<strong class="ir ht">处理购买结果— </strong>当用户退出Google Play购买屏幕时(点击“购买”按钮完成购买，或点击“返回”按钮取消购买)，<code class="du ju jv jw jx b"><a class="ae jn" href="https://developer.android.com/reference/com/android/billingclient/api/PurchasesUpdatedListener#onPurchasesUpdated(com.android.billingclient.api.BillingResult,%20java.util.List%3Ccom.android.billingclient.api.Purchase%3E)" rel="noopener ugc nofollow" target="_blank">onPurchaseUpdated()</a></code>回调将购买流程的结果发送回您的应用程序。根据<code class="du ju jv jw jx b"><a class="ae jn" href="https://developer.android.com/reference/com/android/billingclient/api/BillingClient.BillingResponseCode" rel="noopener ugc nofollow" target="_blank">BillingResult.responseCode</a></code>，您可以确定用户是否成功购买了产品。如果<code class="du ju jv jw jx b">responseCode == OK</code>，那就意味着购买成功完成。</p><p id="9a36" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du ju jv jw jx b">onPurchaseUpdated()</code>传回一个<a class="ae jn" href="https://developer.android.com/reference/com/android/billingclient/api/Purchase" rel="noopener ugc nofollow" target="_blank">购买</a>对象的列表，其中包含用户通过应用程序购买的所有商品。在许多其他字段中，每个购买对象都包含<code class="du ju jv jw jx b">sku</code>、<code class="du ju jv jw jx b">purchaseToken</code>和<code class="du ju jv jw jx b">isAcknowledged</code>属性。使用这些字段，对于每个采购对象，您可以确定它是需要处理的新采购还是不需要进一步处理的现有采购。</p><figure class="jq jr js jt fd hj"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="03f4" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">6.<strong class="ir ht">验证并确认购买</strong> —使用Play Billing Library 3.0时，您的应用程序需要确认成功的购买，以完成购买流程。<strong class="ir ht">如果你的应用程序在72小时内没有确认购买，用户将被退款，并将无法再访问他们最初购买的产品。</strong></p><p id="ee0d" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您的应用程序有验证服务器组件，您应该只在成功验证后确认购买。验证购买不是必需的，但在销售应用内产品时被视为最佳实践。关于如何打击欺诈性购买的更多信息，请查看本指南。</p><p id="f5db" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">验证购买后，您的应用程序需要确认购买。</p><ul class=""><li id="67a2" class="kb kc hs ir b is it iw ix ja kd je ke ji kf jm kg kh ki kj bi translated">非消耗品必须通过呼叫<code class="du ju jv jw jx b"><a class="ae jn" href="https://developer.android.com/reference/com/android/billingclient/api/BillingClient#acknowledgepurchase" rel="noopener ugc nofollow" target="_blank">acknowledgePurchase()</a></code>来确认</li><li id="7b13" class="kb kc hs ir b is kk iw kl ja km je kn ji ko jm kg kh ki kj bi translated">消耗性产品必须标记为“已消耗”,以便用户可以选择再次购买。这是通过<code class="du ju jv jw jx b"><a class="ae jn" href="https://developer.android.com/reference/com/android/billingclient/api/BillingClient#consumeasync" rel="noopener ugc nofollow" target="_blank">consumeAsync()</a></code>功能完成的。调用<code class="du ju jv jw jx b">consumeAsync()</code>也会将采购设置为已确认，因此只要调用<code class="du ju jv jw jx b">consumeAsync()</code>就不需要调用消耗性产品的<code class="du ju jv jw jx b">acknowledgePurchase()</code>。</li></ul><figure class="jq jr js jt fd hj"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="4135" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">7.<strong class="ir ht">授予用户产品— </strong>完成上述步骤后，您的应用现在可以授予用户他们购买的应用内产品了！</p><p id="8d50" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你想查看Google Play计费库的资源，你可以在这里访问官方文档<a class="ae jn" href="https://developer.android.com/google/play/billing/billing_overview" rel="noopener ugc nofollow" target="_blank"/>。在这里，我们还收集了一些示例，展示了实施计费库<a class="ae jn" href="https://github.com/android/play-billing-samples" rel="noopener ugc nofollow" target="_blank">的最佳实践。这篇博文的代码示例可以在Github </a>上找到。</p><p id="8966" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您的应用程序当前未使用Play Billing Library 3，请务必查看我们的<a class="ae jn" href="https://developer.android.com/google/play/billing/migrate" rel="noopener ugc nofollow" target="_blank">迁移指南</a>，迁移您的应用程序以使用最新的Play Billing Library。</p></div></div>    
</body>
</html>