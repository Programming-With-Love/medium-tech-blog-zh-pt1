<html>
<head>
<title>Taming the Two way SSL Authentication</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">驯服双向SSL认证</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/taming-the-two-way-ssl-authentication-38b619a1c32a?source=collection_archive---------1-----------------------#2016-12-14">https://medium.com/walmartglobaltech/taming-the-two-way-ssl-authentication-38b619a1c32a?source=collection_archive---------1-----------------------#2016-12-14</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/52c93b5c711a562fc83db9cac3ac9b0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GD4FaYJWg9NShiUC2GbBzg.jpeg"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">PeteLinforth, Public Domain (<a class="ae hu" href="https://pixabay.com/en/background-vault-render-3d-steel-1242666/" rel="noopener ugc nofollow" target="_blank">https://pixabay.com/en/background-vault-render-3d-steel-1242666/</a>)</figcaption></figure><div class=""/><p id="6240" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在沃尔玛基于SOA的架构中，使用单向SSL的服务到服务交互(其中客户端验证服务器是安全的)相当常见，并且是RESTful通信中的规范。在涉及PCI或HIPAA数据的情况下，存在双向SSL认证，其中服务器现在验证客户端是否已知。这种情况并不常见，第一次设置时会很有挑战性。我下面提供的大部分信息都可以在网上找到，但是要把它们拼凑起来需要一些时间。因此，我提供了一个要点，以及如果你使用一个<strong class="iw hy"> Java </strong> <strong class="iw hy"> Spring </strong>和<strong class="iw hy"> JaxRS </strong>(基于REST服务的Apache框架)设置需要做什么。</p><p id="2ea0" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hy">双向SSL握手快速入门</strong></p><ol class=""><li id="1b40" class="js jt hx iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">初始连接建立</li><li id="5eb6" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">接下来是与客户端协商密码套件，客户端提供一个受支持的密码套件列表供服务器选择。</li><li id="80c6" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">服务器选择一个密码组并发送带有公钥的服务器证书，在双向SSL中，它请求一个由它信任的CA列表中的任何一个签名的证书。</li><li id="9474" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">客户端根据其信任存储验证服务器证书，并发送其自己的证书，该证书已由可信机构之一签名。</li><li id="e0e7" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">服务器验证证书并确认。</li><li id="a1ba" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">客户端发送一个秘密会话密钥，用于进一步对称加密数据。</li></ol><p id="3f1c" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hy">建立信任库和密钥库</strong></p><ol class=""><li id="2137" class="js jt hx iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">确保您拥有带有私钥的客户端证书。有各种文件格式和在它们之间转换的方法——但是Java理解JKS &amp; PKCS12。<strong class="iw hy"> <em class="kg">双向SSL认证</em> </strong>需要此私钥存储配置。一种方法是SSL auth只查看您的信任存储。</li><li id="793e" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">确保将服务器的证书或其中间或根CA添加到您的信任库中。信任库是您所连接和信任的服务器的所有证书的存储库。</li><li id="77ef" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">一旦完成以上工作，它就可以集成到您的应用程序<br/>中了，如果您使用的是Spring和Apache-JaxRS，可以在pom.xml中添加以下依赖项，并将管道配置添加到Spring beans配置中。这里的关键是使用一个<strong class="iw hy"> JaxRS HTTP管道</strong>——它本质上定义了套接字连接。</li></ol><blockquote class="kh ki kj"><p id="fd43" class="iu iv kg iw b ix iy iz ja jb jc jd je kk jg jh ji kl jk jl jm km jo jp jq jr ha bi translated">提示:您可以通过使用浏览器的高级设置将您的客户端证书导入浏览器来检查您的浏览器SSL连接是否正常。在输入安全服务器URL时，如果握手成功，您将获得一个有效的HTTP成功或错误代码。但是，如果您的客户端证书有问题，浏览器发出的SSL握手将失败，您将得到一个浏览器错误。</p></blockquote><p id="c3da" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hy"> Maven依赖关系</strong></p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="424a" class="kw kx hx ks b fi ky kz l la lb">&lt;dependency&gt;<br/> &lt;groupId&gt;org.apache.cxf&lt;/groupId&gt;<br/> &lt;artifactId&gt;cxf-common-schemas&lt;/artifactId&gt;<br/> &lt;version&gt;2.3.11&lt;/version&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>  &lt;groupId&gt;org.apache.cxf&lt;/groupId&gt;<br/>  &lt;artifactId&gt;cxf-rt-transports-http&lt;/artifactId&gt;      &lt;version&gt;2.7.7&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="2398" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">【JaxRS连接的弹簧配置</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="cb11" class="kw kx hx ks b fi ky kz l la lb">//Bean initialization<br/>//Schema Declaration <br/>&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;<br/>&lt;beans ae hu" href="http://www.springframework.org/schema/beans" rel="noopener ugc nofollow" target="_blank"&gt;http://www.springframework.org/schema/beans"<br/>xmlns:http="<a class="ae hu" href="http://cxf.apache.org/transports/http/configuration" rel="noopener ugc nofollow" target="_blank">http://cxf.apache.org/transports/http/configuration</a>"<br/>xmlns:sec="<a class="ae hu" href="http://cxf.apache.org/configuration/security" rel="noopener ugc nofollow" target="_blank">http://cxf.apache.org/configuration/security</a>"<br/>xsi:schemaLocation="<a class="ae hu" href="http://cxf.apache.org/configuration/security" rel="noopener ugc nofollow" target="_blank">http://cxf.apache.org/configuration/security</a> <a class="ae hu" href="http://cxf.apache.org/schemas/configuration/security.xsd" rel="noopener ugc nofollow" target="_blank">http://cxf.apache.org/schemas/configuration/security.xsd</a>"&gt;<br/>//Conduit wiring<br/>&lt;http:conduit name="${serviceURL}.*"&gt;<br/>&lt;http:tlsClientParameters secureSocketProtocol="TLS" &gt;<strong class="ks hy">&lt;sec:certAlias&gt;myalias&lt;/sec:certAlias&gt;</strong><br/>&lt;sec:keyManagers keyPassword="password" &gt;    <br/>&lt;sec:keyStore type="JKS" password="Keystore_password" file="${file_path_to_keystore}"/&gt;<br/>&lt;/sec:keyManagers&gt;<br/>&lt;sec:trustManagers&gt;<br/>&lt;sec:keyStore type="JKS" password="trust_store_password" file="${file_path_truststore}"/&gt;<br/>&lt;/sec:trustManagers&gt;<br/>&lt;sec:cipherSuitesFilter&gt;<br/><strong class="ks hy">&lt;sec:exclude&gt;.*_EXPORT_.*&lt;/sec:exclude&gt;<br/>&lt;sec:exclude&gt;.*_EXPORT1024_.*&lt;/sec:exclude&gt;</strong>&lt;sec:include&gt;.*_WITH_DES_.*&lt;/sec:include&gt;<br/>&lt;sec:include&gt;.*_WITH_AES_.*&lt;/sec:include&gt;<strong class="ks hy">&lt;sec:exclude&gt;.*_WITH_NULL_.*&lt;/sec:exclude&gt;<br/>&lt;sec:exclude&gt;.*_DH_anon_.*&lt;/sec:exclude&gt;</strong><br/>&lt;/sec:cipherSuitesFilter&gt;<br/>&lt;/http:tlsClientParameters&gt;<br/>&lt;http:client AutoRedirect="true" Connection="Keep-Alive" CacheControl="no-cache"/&gt;<br/>&lt;/http:conduit&gt;</span></pre><p id="072d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hy">要注意的事情</strong></p><ol class=""><li id="8e01" class="js jt hx iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">JaxRS为每个连接创建一个管道，默认情况下，如果您将javax.net.ssl.keyStore属性指定为系统属性，它不会查看该属性。</li><li id="fcdb" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">如果没有从类路径中选择管道配置，那么在使用JaxRS创建Web客户机时，可以将该位置作为文件路径配置参数传递。</li><li id="8f88" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">确保别名条目正确，并且在密钥库中指定。</li><li id="fd6a" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated"><a class="ae hu" href="https://blog.cryptographyengineering.com/2015/03/03/attack-of-week-freak-or-factoring-nsa/" rel="noopener ugc nofollow" target="_blank"> <em class="kg">导出密码容易受到SSL怪胎攻击</em> </a>，应该排除。</li><li id="60bf" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">AES和DES的实现很弱，因此最好使用此<a class="ae hu" href="https://www.ssllabs.com/ssltest/" rel="noopener ugc nofollow" target="_blank"> <em class="kg">网站</em> </a>进行审查。</li><li id="b464" class="js jt hx iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">建议使用强密码和密码加密服务。</li></ol><p id="3e20" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">希望这篇文章能帮助你节省时间，如果你正试图建立双向SSL通信的话！</p></div></div>    
</body>
</html>