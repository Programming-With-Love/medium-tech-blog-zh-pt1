<html>
<head>
<title>CameraX: Learn how to use CameraController</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CameraX:学习如何使用CameraController</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/camerax-learn-how-to-use-cameracontroller-e3ed10fffecf?source=collection_archive---------1-----------------------#2020-12-15">https://medium.com/androiddevelopers/camerax-learn-how-to-use-cameracontroller-e3ed10fffecf?source=collection_archive---------1-----------------------#2020-12-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/5c650cd00838eca804a7925d3a50700d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4_DLa7iofqrBd4nQqBn6fw.png"/></div></div></figure><p id="b598" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><a class="ae jn" href="https://developer.android.com/training/camerax" rel="noopener ugc nofollow" target="_blank"> CameraX </a>目前提供了<code class="du jo jp jq jr b">CameraView</code>，一个<code class="du jo jp jq jr b">View</code>显示相机的预览，同时还提供了拍照、控制相机、查询相机信息的方法。<code class="du jo jp jq jr b">CameraView</code>显然承担了比<code class="du jo jp jq jr b">View</code>更多的责任，因为它参与了<code class="du jo jp jq jr b">View</code>层级并显示内容，同时还拥有存在于<code class="du jo jp jq jr b">View</code>层级范围和生命周期之外的摄像机资源。</p><p id="b6e0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">CameraView</code>违反了关注点分离原则，使得在所有的极限情况下都难以保证其健壮性。因此，在CameraX的视图工件达到测试版之前，它将被标记为不推荐使用并被删除。它被分成两部分，你应该使用:<code class="du jo jp jq jr b"><a class="ae jn" href="https://developer.android.com/reference/androidx/camera/view/PreviewView" rel="noopener ugc nofollow" target="_blank">PreviewView</a></code>处理与视图相关的任务，而<code class="du jo jp jq jr b"><a class="ae jn" href="https://developer.android.com/reference/androidx/camera/view/CameraController" rel="noopener ugc nofollow" target="_blank">CameraController</a></code>处理相机操作。</p><p id="0271" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">PreviewView</code>在CameraX的查看神器里已经有一段时间了。然而，<code class="du jo jp jq jr b">CameraController</code>是最近在alpha19版本中引入的。它是一个高级的一体化API，提供了一种轻松访问和操作核心相机功能的方法，包括显示相机预览、拍照和分析相机帧。在这样做的同时，它会将其用例的输出与取景器的预览相匹配，从而提供“所见即所得”(WYSIWYG)的体验，这是开发人员高度要求的功能，使CameraX的使用非常直观。它还负责初始化相机并使其输出适应设备旋转。</p><p id="5ca3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了减轻启动、停止和关闭相机的负担，CameraX还引入了<code class="du jo jp jq jr b"><a class="ae jn" href="https://developer.android.com/reference/androidx/camera/view/LifecycleCameraController" rel="noopener ugc nofollow" target="_blank">LifecycleCameraController</a></code>，它提供了<code class="du jo jp jq jr b">CameraController</code>的所有便利，还增加了将相机的生命周期绑定到<code class="du jo jp jq jr b"><a class="ae jn" href="https://developer.android.com/reference/androidx/lifecycle/LifecycleOwner" rel="noopener ugc nofollow" target="_blank">LifecycleOwner</a></code>的好处，通常是<code class="du jo jp jq jr b">Fragment</code>或<code class="du jo jp jq jr b">Activity</code>的生命周期。这允许生命周期的状态控制相机打开、停止和关闭的时间。</p><p id="bec9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">使用<code class="du jo jp jq jr b">PreviewView</code>和<code class="du jo jp jq jr b">CameraController</code>相当简单，可以按如下方式完成:</p><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="c99d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">以下部分列出了从<code class="du jo jp jq jr b">CameraView</code>到<code class="du jo jp jq jr b">CameraController</code>的映射。您可以使用它们从<code class="du jo jp jq jr b">CameraView</code>迁移到<code class="du jo jp jq jr b">PreviewView</code>和<code class="du jo jp jq jr b">CameraController</code>。</p><h1 id="07cd" class="jy jz hh bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">摄像机初始化</h1><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="5ba1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">与<code class="du jo jp jq jr b">CameraView</code>不同，<code class="du jo jp jq jr b">CameraController</code>提供了一个<code class="du jo jp jq jr b"><a class="ae jn" href="https://guava.dev/releases/23.0/api/docs/com/google/common/util/concurrent/ListenableFuture.html" rel="noopener ugc nofollow" target="_blank">ListenableFuture</a></code>来监控其初始化。这是一个异步操作，在此期间<code class="du jo jp jq jr b">CameraController</code>初始化CameraX并绑定它的用例。使用这个<code class="du jo jp jq jr b">ListenableFuture</code>的好处是双重的:</p><ul class=""><li id="430e" class="kw kx hh ir b is it iw ix ja ky je kz ji la jm lb lc ld le bi translated">一旦成功完成，你可以让你的用户开始与相机互动，例如拍照和放大缩小取景器。</li><li id="f457" class="kw kx hh ir b is lf iw lg ja lh je li ji lj jm lb lc ld le bi translated">万一失败，您可以优雅地处理错误，并将其传达给您的用户。</li></ul><p id="164a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您不熟悉<code class="du jo jp jq jr b">ListenableFuture</code>:它包装了一个异步操作，并允许您附加一个在完成时调用的监听器。如果操作已经完成，future会立即返回。</p><h1 id="2266" class="jy jz hh bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">相机生命周期</h1><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="5ad3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">与<code class="du jo jp jq jr b">CameraView</code>类似，<code class="du jo jp jq jr b">LifecycleCameraController</code>将摄像机的控制与生命周期联系起来。您必须将有效的<code class="du jo jp jq jr b">LifecycleOwner</code>绑定到控制器，控制器才能运行。</p><p id="ff19" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">LifecycleCameraController</code>提供了一个额外的<code class="du jo jp jq jr b">unbind()</code>方法，允许你在相机的生命周期结束前提前关闭相机。这在相机不是屏幕的一部分并且在整个生命周期中不需要的情况下很有用。或者，您可以定义您的自定义<code class="du jo jp jq jr b">LifecycleOwner</code>来控制何时关闭相机，但在某些情况下<code class="du jo jp jq jr b">unbind()</code>可能更方便。</p><h1 id="97d2" class="jy jz hh bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">摄像机控制</h1><h2 id="99c8" class="lk jz hh bd ka ll lm ln ke lo lp lq ki ja lr ls km je lt lu kq ji lv lw ku lx bi translated"><strong class="ak"> -变焦</strong></h2><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="bfb8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">CameraController</code>允许你通过<code class="du jo jp jq jr b"><a class="ae jn" href="https://developer.android.com/topic/libraries/architecture/livedata" rel="noopener ugc nofollow" target="_blank">LiveData</a></code>实例观察相机的变焦状态。一旦相机打开，此状态就变为可用，并保存静态信息，如最大和最小缩放比率，以及动态信息，如当前缩放比率。您可以使用最大缩放比率验证缩放是否受支持，如下所示:</p><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="b23c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">CameraController</code>另外提供获取和设置线性缩放的方法，线性缩放可以在0(最小缩放)和1(最大缩放)之间变化。</p><p id="f262" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最后，和<code class="du jo jp jq jr b">CameraView</code>一样，<code class="du jo jp jq jr b">CameraController</code>允许你启用或禁用缩放。启用时，<code class="du jo jp jq jr b">CameraController</code>处理与其相连的<code class="du jo jp jq jr b">PreviewView</code>上的捏手势，以放大和缩小相机。</p><h2 id="c63e" class="lk jz hh bd ka ll lm ln ke lo lp lq ki ja lr ls km je lt lu kq ji lv lw ku lx bi translated">-闪光灯/手电筒</h2><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="543b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">CameraController</code>提供了与<code class="du jo jp jq jr b">CameraView</code>类似的方法来设置和查询图像捕捉的闪光模式，但与<code class="du jo jp jq jr b">CameraView</code>不同，它允许通过一个<code class="du jo jp jq jr b">LiveData</code>实例来观察相机手电筒状态的变化，该实例发出<code class="du jo jp jq jr b">TorchState.OFF</code>和<code class="du jo jp jq jr b">TorchState.ON</code>。</p><h2 id="fff4" class="lk jz hh bd ka ll lm ln ke lo lp lq ki ja lr ls km je lt lu kq ji lv lw ku lx bi translated">-对焦/测光</h2><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="6c96" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当<code class="du jo jp jq jr b">CameraView</code>自动获取取景器中被点击的任何区域的焦点时，<code class="du jo jp jq jr b">CameraController</code>允许您启用或禁用点击对焦功能，从而提供更大的灵活性。启用后，<code class="du jo jp jq jr b">CameraController</code>通过将摄像机聚焦在点击区域来处理其附属<code class="du jo jp jq jr b">PreviewView</code>上的触摸事件。</p><h1 id="37d7" class="jy jz hh bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">相机选择</h1><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="c1d4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">CameraController</code>通过允许您指定一个<code class="du jo jp jq jr b">CameraSelector</code>来选择所使用的摄像机，为您提供对使用哪个摄像机的更多控制。这允许你在切换相机时在不同的相机之间旋转，而不仅仅是默认的前置和后置相机，这是<code class="du jo jp jq jr b">CameraView.toggleCamera()</code>的一个限制。不过，您仍然可以很容易地实现这一点，使用如下的<code class="du jo jp jq jr b">CameraController</code>。</p><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><h1 id="7393" class="jy jz hh bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">相机使用案例</h1><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="35b6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">CameraController</code>支持CameraX的所有<a class="ae jn" href="https://developer.android.com/training/camerax/architecture#structure" rel="noopener ugc nofollow" target="_blank">用例</a> : <code class="du jo jp jq jr b">Preview</code>、<code class="du jo jp jq jr b">ImageAnalysis</code>和<code class="du jo jp jq jr b">ImageCapture</code>，因此与<code class="du jo jp jq jr b">CameraView</code>相比，它是一个更健壮的相机解决方案。它还将<code class="du jo jp jq jr b">ImageAnalysis</code>和<code class="du jo jp jq jr b">ImageCapture</code>的输出与预览的显示相匹配，从而提供所见即所得的体验。</p><p id="8012" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">CameraController</code>的默认状态启用预览、图像分析和图像捕捉。<code class="du jo jp jq jr b">Preview</code>用例<strong class="ir hi">始终</strong>启用，因此您可以根据您的相机使用需求选择启用或禁用其余用例。</p><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><h2 id="b526" class="lk jz hh bd ka ll lm ln ke lo lp lq ki ja lr ls km je lt lu kq ji lv lw ku lx bi translated">-预览</h2><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="4550" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">不像<code class="du jo jp jq jr b">CameraView</code>包装(从而隐藏)一个<code class="du jo jp jq jr b">PreviewView</code>实例并将方法调用转发给它，<code class="du jo jp jq jr b">CameraController</code>与<code class="du jo jp jq jr b">PreviewView</code>分离。这意味着你对取景器有更多的控制，可以直接访问和操作它。</p><h2 id="f41f" class="lk jz hh bd ka ll lm ln ke lo lp lq ki ja lr ls km je lt lu kq ji lv lw ku lx bi translated">-图像分析</h2><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="f24c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">与<code class="du jo jp jq jr b">CameraView</code>不同，<code class="du jo jp jq jr b">CameraController</code>支持<code class="du jo jp jq jr b">ImageAnalysis</code>用例。您可以设置和清除其<code class="du jo jp jq jr b">Analyzer</code>，同时还可以配置其图像处理管道。</p><h2 id="1189" class="lk jz hh bd ka ll lm ln ke lo lp lq ki ja lr ls km je lt lu kq ji lv lw ku lx bi translated">-图像捕捉</h2><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="jw jx l"/></div></figure><p id="c7de" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">CameraController</code>提供与<code class="du jo jp jq jr b">CameraView</code>相同的方法来拍照，指定图像保存目的地，并提供图像捕获回调。</p><p id="2f1f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="ly">需要注意的一点是</em> <code class="du jo jp jq jr b"><em class="ly">CameraController</em></code> <em class="ly">镜像前置摄像头拍摄的图像，除非您通过调用</em> <code class="du jo jp jq jr b"><a class="ae jn" href="https://developer.android.com/reference/androidx/camera/core/ImageCapture.Metadata#setReversedHorizontal(boolean)" rel="noopener ugc nofollow" target="_blank"><em class="ly">Metadata.setReversedHorizontal(false)</em></a></code>在 <code class="du jo jp jq jr b"><em class="ly">OutputFileOptions</em></code> <em class="ly">的元数据中禁用此功能。</em></p><h1 id="03cc" class="jy jz hh bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="8253" class="pw-post-body-paragraph ip iq hh ir b is lz iu iv iw ma iy iz ja mb jc jd je mc jg jh ji md jk jl jm ha bi translated">总而言之:</p><ul class=""><li id="90ef" class="kw kx hh ir b is it iw ix ja ky je kz ji la jm lb lc ld le bi translated">因为<code class="du jo jp jq jr b">CameraView</code>在MVC的意义上同时处理视图和控制器的职责，CameraX放弃了它，把它分成了<code class="du jo jp jq jr b">PreviewView</code>和新引入的<code class="du jo jp jq jr b">CameraController</code>。</li><li id="d9cc" class="kw kx hh ir b is lf iw lg ja lh je li ji lj jm lb lc ld le bi translated"><code class="du jo jp jq jr b">CameraController</code>处理摄像机初始化，以及其用例的创建和配置。</li><li id="f5fc" class="kw kx hh ir b is lf iw lg ja lh je li ji lj jm lb lc ld le bi translated"><code class="du jo jp jq jr b">CameraController</code>通过将其用例的输出与<code class="du jo jp jq jr b">PreviewView</code>的显示相匹配来提供所见即所得的体验。</li><li id="90f9" class="kw kx hh ir b is lf iw lg ja lh je li ji lj jm lb lc ld le bi translated"><code class="du jo jp jq jr b">CameraController</code>监听设备的运动传感器，以正确旋转其用例的输出。</li><li id="a0d7" class="kw kx hh ir b is lf iw lg ja lh je li ji lj jm lb lc ld le bi translated"><code class="du jo jp jq jr b">CameraController</code>增加了对<code class="du jo jp jq jr b">ImageAnalysis</code>用例的支持，使其成为更强大的相机解决方案，可以轻松访问CameraX的所有用例。</li><li id="57b4" class="kw kx hh ir b is lf iw lg ja lh je li ji lj jm lb lc ld le bi translated"><code class="du jo jp jq jr b">CameraController</code>支持<code class="du jo jp jq jr b">CameraView</code>的所有功能以及更多功能，例如启用和禁用轻触对焦、获取和设置线性变焦，以及观察动态相机信息，如变焦和手电筒状态。</li><li id="b4f6" class="kw kx hh ir b is lf iw lg ja lh je li ji lj jm lb lc ld le bi translated"><code class="du jo jp jq jr b">LifecycleCameraController</code>是一个<code class="du jo jp jq jr b">CameraController</code>，它将相机的生命周期与<code class="du jo jp jq jr b">LifecycleOwner</code>绑定在一起，通常是UI的生命周期。</li></ul><p id="3732" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">想要更多相机的好处？检查:</p><ul class=""><li id="eda5" class="kw kx hh ir b is it iw ix ja ky je kz ji la jm lb lc ld le bi translated"><a class="ae jn" href="https://developer.android.com/training/camerax" rel="noopener ugc nofollow" target="_blank">官方CameraX文档</a></li><li id="77f4" class="kw kx hh ir b is lf iw lg ja lh je li ji lj jm lb lc ld le bi translated"><a class="ae jn" href="https://codelabs.developers.google.com/codelabs/camerax-getting-started" rel="noopener ugc nofollow" target="_blank"> Guided CameraX简介codelab </a></li><li id="8a50" class="kw kx hh ir b is lf iw lg ja lh je li ji lj jm lb lc ld le bi translated"><a class="ae jn" href="https://groups.google.com/a/android.com/g/camerax-developers" rel="noopener ugc nofollow" target="_blank"> CameraX开发者社区</a></li><li id="987f" class="kw kx hh ir b is lf iw lg ja lh je li ji lj jm lb lc ld le bi translated"><a class="ae jn" href="https://github.com/android/camera-samples/tree/master/CameraXBasic" rel="noopener ugc nofollow" target="_blank"> CameraX官方样片app </a></li></ul></div></div>    
</body>
</html>