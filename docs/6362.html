<html>
<head>
<title>Improving the Player on Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">改进Android上的播放器</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/improving-the-player-on-android-8b7faf9009cf?source=collection_archive---------0-----------------------#2022-12-02">https://medium.com/pinterest-engineering/improving-the-player-on-android-8b7faf9009cf?source=collection_archive---------0-----------------------#2022-12-02</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="1116" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Grey Skold |(前安卓视频工程师)；王麟|安卓性能工程师；刘胜|安卓性能工程师</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/3b9a9f2651dc68ab6522401bc66ed42a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kqBNUFfi2WKxcOetzgVBHw.jpeg"/></div></div></figure><p id="b582" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest Android应用程序在两列网格上混合了图像和视频，提供了一种罕见的体验。为了在Android设备上保持高性能的视频体验，我们专注于:</p><ul class=""><li id="40d9" class="jo jp hh ig b ih ii il im ip jq it jr ix js jb jt ju jv jw bi translated">预热</li><li id="31a6" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated">配置</li><li id="0cb1" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated">汇集球员</li></ul><h1 id="6093" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">预热</h1><p id="6a61" class="pw-post-body-paragraph ie if hh ig b ih la ij ik il lb in io ip lc ir is it ld iv iw ix le iz ja jb ha bi translated">为了减少启动延迟，我们通过在应用程序启动早期发送一个虚拟HTTP HEAD请求来建立一个视频网络连接。同样的连接可以用来播放未来的视频。这甚至在我们的服务器返回任何视频URL之前就已经完成了。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lf"><img src="../Images/9f726a706c3c2b80a34f87faafe93082.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FUYJkq-rVTs9A0Yz0johRA.png"/></div></div></figure><p id="f14c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">同样的策略也适用于UI渲染。我们发现<a class="ae lg" href="https://github.com/google/ExoPlayer" rel="noopener ugc nofollow" target="_blank"> Exoplayer </a>倾向于在解析来自视频url的信息后做大量的工作。它:</p><ul class=""><li id="0157" class="jo jp hh ig b ih ii il im ip jq it jr ix js jb jt ju jv jw bi translated">计算纵横比</li><li id="501e" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated">调用<a class="ae lg" href="https://exoplayer.dev/doc/reference/com/google/android/exoplayer2/ui/StyledPlayerView.html#onContentAspectRatioChanged(com.google.android.exoplayer2.ui.AspectRatioFrameLayout,float)" rel="noopener ugc nofollow" target="_blank">上的oncontentasperationchanged()</a></li><li id="8c98" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated">通知<a class="ae lg" href="https://exoplayer.dev/doc/reference/com/google/android/exoplayer2/ui/AspectRatioFrameLayout.html" rel="noopener ugc nofollow" target="_blank"> AspectRatioFrameLayout </a>宽高比</li></ul><p id="4cff" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于我们大多数视频的长宽比是预先确定的，我们可以通过以下方式防止上述工作:</p><ul class=""><li id="f4d0" class="jo jp hh ig b ih ii il im ip jq it jr ix js jb jt ju jv jw bi translated">通过<a class="ae lg" href="https://exoplayer.dev/doc/reference/com/google/android/exoplayer2/ui/AspectRatioFrameLayout.html#setAspectRatio(float)" rel="noopener ugc nofollow" target="_blank">aspectatiformalelayout . setaspectatio()</a>设置视频宽高比</li><li id="dc3f" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated">用空体覆盖<a class="ae lg" href="https://exoplayer.dev/doc/reference/com/google/android/exoplayer2/ui/PlayerView.html#onContentAspectRatioChanged(com.google.android.exoplayer2.ui.AspectRatioFrameLayout,float)" rel="noopener ugc nofollow" target="_blank">player view . oncontentasperationchanged()</a>方法</li></ul><p id="f916" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">后者防止玩家试图重新计算长宽比。</p><h1 id="543b" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">配置</h1><h2 id="5beb" class="lh kd hh bd ke li lj lk ki ll lm ln km ip lo lp kq it lq lr ku ix ls lt ky lu bi translated"><a class="ae lg" href="https://exoplayer.dev/doc/reference/com/google/android/exoplayer2/DefaultLoadControl.html" rel="noopener ugc nofollow" target="_blank">默认加载控制</a></h2><p id="622e" class="pw-post-body-paragraph ie if hh ig b ih la ij ik il lb in io ip lc ir is it ld iv iw ix le iz ja jb ha bi translated">ExoPlayer为我们提供了<a class="ae lg" href="https://exoplayer.dev/doc/reference/com/google/android/exoplayer2/DefaultLoadControl.Builder.html#setBufferDurationsMs(int,int,int,int)" rel="noopener ugc nofollow" target="_blank"> setBufferDurationsMs() </a>来定制各种缓冲持续时间，用于延迟播放，直到我们有足够的数据。由于Pinterest的大部分媒体内容都是短格式的，我们可以使用更短的缓冲时间，从而减少等待数据加载的时间。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lv"><img src="../Images/b25e89248f601d91dafefce5f611adf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qpAiNC_a8Wy9FrHU6nkEpQ.png"/></div></div></figure><p id="5e42" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过这样做，我们看到了视频启动延迟的显著减少。虽然再缓冲速率增加了一点，但整体视频UX仍有所改善。</p><h2 id="e88a" class="lh kd hh bd ke li lj lk ki ll lm ln km ip lo lp kq it lq lr ku ix ls lt ky lu bi translated"><a class="ae lg" href="https://exoplayer.dev/doc/reference/com/google/android/exoplayer2/trackselection/DefaultTrackSelector.html" rel="noopener ugc nofollow" target="_blank">默认跟踪选择器</a></h2><p id="329f" class="pw-post-body-paragraph ie if hh ig b ih la ij ik il lb in io ip lc ir is it ld iv iw ix le iz ja jb ha bi translated">使用以下两个参数，我们可以有效地确保在feed中加载的视频受到其视口大小的限制(即，避免在小的360像素视口中加载大的1080p视频)。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lf"><img src="../Images/b98968588550eafc732f46f649de5430.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NgWqk2dr7caA5HFbLqssQw.png"/></div></div></figure><p id="543c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest应用程序同时在网格中播放多个静音视频。使用以下参数，我们可以禁用音频渲染以节省下载音频的网络带宽和处理音频的内存消耗。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lw"><img src="../Images/5d98ed317772d2f1a8171265127e8796.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U7nzvGeOh79ADUpBHEDz-Q.png"/></div></div></figure><h2 id="8024" class="lh kd hh bd ke li lj lk ki ll lm ln km ip lo lp kq it lq lr ku ix ls lt ky lu bi translated"><a class="ae lg" href="https://exoplayer.dev/doc/reference/com/google/android/exoplayer2/upstream/cache/SimpleCache.html" rel="noopener ugc nofollow" target="_blank">简单缓存</a></h2><p id="0cbb" class="pw-post-body-paragraph ie if hh ig b ih la ij ik il lb in io ip lc ir is it ld iv iw ix le iz ja jb ha bi translated">Exoplayer提供了一个缓存接口，将下载的媒体数据保存在磁盘上。然而，在我们遇到由后端错误引起的致命错误的情况下，坏的内容也会滞留在缓存中。这可能导致应用程序继续遇到相同的回放错误，即使后端已经修复。</p><p id="e857" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当从<a class="ae lg" href="https://exoplayer.dev/doc/reference/com/google/android/exoplayer2/Player.Listener.html#onPlayerError(com.google.android.exoplayer2.PlaybackException)" rel="noopener ugc nofollow" target="_blank">播放器返回以下致命IO错误时，我们使用<a class="ae lg" href="https://exoplayer.dev/doc/reference/com/google/android/exoplayer2/upstream/cache/SimpleCache.html#removeResource(java.lang.String)" rel="noopener ugc nofollow" target="_blank">simple cache . remove resource()</a>来清除脏缓存。Listener.onPlayerError() </a>:</p><ul class=""><li id="29e4" class="jo jp hh ig b ih ii il im ip jq it jr ix js jb jt ju jv jw bi translated">错误代码IO未指定2000</li><li id="a5e3" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated">错误代码IO无效HTTP内容类型2003</li><li id="53ec" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated">错误代码IO错误HTTP状态2004</li><li id="74e1" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated">错误代码IO文件未找到2005</li><li id="75c3" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated">错误代码IO读取位置超出范围2008</li></ul><h1 id="6e29" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">汇集球员</h1><p id="a9f0" class="pw-post-body-paragraph ie if hh ig b ih la ij ik il lb in io ip lc ir is it ld iv iw ix le iz ja jb ha bi translated">最后，我们建立了自己的缓存，在需要的时候将玩家集中起来。从历史上看，我们在运行中实例化新的播放器实例，这导致了内存和带宽的巨大开销。以下是一些高层次的学习:</p><h2 id="e031" class="lh kd hh bd ke li lj lk ki ll lm ln km ip lo lp kq it lq lr ku ix ls lt ky lu bi translated">通过编码分离</h2><p id="2362" class="pw-post-body-paragraph ie if hh ig b ih la ij ik il lb in io ip lc ir is it ld iv iw ix le iz ja jb ha bi translated">播放器实例基于最后呈现的媒体的编码类型有效地保持对底层解码器的引用。玩家在不同的解码器之间切换上下文需要做大量的工作。因此，我们根据最初的解码格式汇集我们的球员。通过确保回收的播放器具有匹配媒体编码的解码器，我们消除了切换编码格式时引起的任何延迟开销。</p><h2 id="3b25" class="lh kd hh bd ke li lj lk ki ll lm ln km ip lo lp kq it lq lr ku ix ls lt ky lu bi translated">智能调整大小</h2><p id="700f" class="pw-post-body-paragraph ie if hh ig b ih la ij ik il lb in io ip lc ir is it ld iv iw ix le iz ja jb ha bi translated">池大小本身经历了多次迭代，以找到容纳多个视频播放所需的理想空间，同时避免内存不足(OOM)和<a class="ae lg" href="https://developer.android.com/topic/performance/vitals/anr" rel="noopener ugc nofollow" target="_blank"> ANR </a>。以下两个API用于防止系统过载:</p><p id="a9a1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae lg" href="https://developer.android.com/reference/android/content/ComponentCallbacks2.html#onTrimMemory(int)" rel="noopener ugc nofollow" target="_blank">ontrimremory(int)</a></p><p id="7dcd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是我们的关键回调用来通知我们，我们应该清除我们的球员缓存池，因为我们开始危险地接近发送OOMs。</p><p id="d42b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae lg" href="https://exoplayer.dev/doc/reference/com/google/android/exoplayer2/ExoPlayer.html#setForegroundMode(boolean)" rel="noopener ugc nofollow" target="_blank"> setForegroundMode(true) </a></p><p id="0020" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">设置该标志将允许Exoplayer保留对视频解码器的直接引用，并且即使在空闲状态下也将其保存在内存中。然而，它对内存和设备的稳定性有很大的影响。我们必须根据当前的应用程序生命周期和设备上的当前可用内存，构建逻辑来保守地使用这种方法。</p><h1 id="01b8" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">游戏时间永远不会结束</h1><p id="433c" class="pw-post-body-paragraph ie if hh ig b ih la ij ik il lb in io ip lc ir is it ld iv iw ix le iz ja jb ha bi translated">提高视频播放的性能是对ExoPlayer库内部工作方式以及我们自己产品独特用例的永无止境的调查，但最具挑战性的是建立一个架构，为home feed的独特Pinterest体验服务。我们的长期目标是将这项工作分享给其他希望以最少的设置构建无缝视频UX的开发人员。与此同时，我们希望每个人都建立一个更高性能的视频体验。</p><p id="478a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ly">要在Pinterest了解更多工程知识，请查看我们的</em> <a class="ae lg" href="https://medium.com/pinterest-engineering" rel="noopener"> <em class="ly">工程博客</em> </a> <em class="ly">，并访问我们的</em><a class="ae lg" href="https://www.pinterestlabs.com/" rel="noopener ugc nofollow" target="_blank"><em class="ly">Pinterest Labs</em></a><em class="ly">网站。要探索Pinterest的生活，请访问我们的</em> <a class="ae lg" href="https://www.pinterestcareers.com/" rel="noopener ugc nofollow" target="_blank"> <em class="ly">职业</em> </a> <em class="ly">页面。</em></p></div></div>    
</body>
</html>