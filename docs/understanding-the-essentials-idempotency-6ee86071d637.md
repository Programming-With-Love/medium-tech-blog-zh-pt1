# 理解要点:幂等性

> 原文：<https://medium.com/square-corner-blog/understanding-the-essentials-idempotency-6ee86071d637?source=collection_archive---------2----------------------->

## 等幂是你可能不会每天都看到的东西，但它是一个重要的概念，尤其是当你在付款的时候。

![](img/a43a89cc492c77297a20d451d0f2e382.png)

> 注意，我们已经行动了！如果您想继续了解 Square 的最新技术内容，请访问我们的新家[https://developer.squareup.com/blog](https://developer.squareup.com/blog)

作为一名开发人员，您总是希望事情进展顺利，但是在 REST APIs 的世界中，情况并非总是如此。客户端故障、网络错误或者只是糟糕的代码都可能给 API 调用(以及您的最终用户体验)带来麻烦。幸运的是，幂等函数可以帮助您！一开始可能会有点混乱，但是一旦你掌握了它，你会发现它是设计和使用关键任务系统的一个重要方面。

## idempo-什么？

> **幂等性**是数学和计算机科学中某些运算的属性，由此它们可以被多次应用而不改变最初应用之后的结果。— [维基百科](https://en.wikipedia.org/wiki/Idempotence)

在开发人员使用 REST APIs 的情况下，您的应用程序通过互联网上的其他服务发送请求并获得响应。当 API 是等幂时，保证当您发送相同请求时，您将总是得到相同的响应。我说的相同是什么意思？头、主体、授权，一切都需要完全相同。

并不是所有的 REST APIs 都使用幂等性，大多数时候只有影响某个事物状态的请求才需要，或者你真的不想意外运行两次。对于许多 API 来说，这仅限于 POST 或 PUT 请求，而大多数“状态中立”请求不会增加接口的复杂性。在大多数情况下，使用 Square 的 API，您会在交易环境中看到这种情况，在这种情况下，您希望保持银行账户的状态有序，并防止意外的资金流动。

## 支付 API 的幂等性

对于我们的幂等 API，有一个名为`idempotency_key`的专用主体参数来帮助您跟踪您的请求。这是包含在请求正文中的字符串。当我们看到您使用该特定键发出的请求时，我们可以确保我们将只成功处理一次所请求的操作。当您发送带有相同`idempotency_key`的请求时，我们将发送回当前成功的响应。如果你熟悉`Etag`头，它是另一种帮助防止意外状态改变的方法，但是有不同的机制。

重要的是要注意，在幂等的上下文中获得“成功”的响应并不一定意味着获得了`200 OK`。即使您返回一个`401`或`500`或其他指示您所请求的操作不工作的东西，您也能设法得到一个指示发送的任何东西都不成功的响应。这里的目的是处理含糊不清的时刻，即尝试了一个操作，但不清楚结果是什么，所以您用相同的`idempotency_key`重试它。您可以安全地重试请求，而不用担心重复做相同的操作，只需使用相同的`idempotency_key`重试。

您可能会想，有很多很好的用例，在这些用例中，您希望发出很多类似的请求；两次调用同一个 API 与发出一个因网络中断而重复的请求有何不同？您只需要确保对于您想要进行的每笔交易，您都有一个唯一的请求`idempotency_key`。

## "我在哪里可以找到幂等键？"

您应该从哪里获得每个请求的唯一值呢？嗯，它不像您的访问令牌那样可以在您的开发人员仪表板中查找。您需要决定用您的应用程序架构设置`idempotency_key`的最佳方式。常见的例子是为`idempotency_key`使用当前时间戳或 UUID，虽然这些通常是唯一的，但它们有一些缺点。考虑一个电子商务网站，它只有一个页面前端，将卡数据(在本例中是一个卡随机数)异步发送到后端进行收费。如果你的用户点击两次收费按钮，向你的后台发送两个请求，会发生什么？如果您在每次后端代码运行时都动态地创建幂等键，那么您可能会意外地向您的客户收取两次费用(实际上，您不能对相同的 nonce 收取两次费用，但这是题外话)。

设置您的`idempotency_key`的一个更好的策略可能是使用会话 id、用户名&日期的散列、您在另一个系统中使用的事务 id，或者甚至是在用户启动会话时而不是在请求时分配的 uuid。这样，您可以保证您创建的每个唯一的幂等键都是唯一购买的，但是当您可能意外地重复收费时，您也将拥有在请求之前发现问题的信息。没有一个值适用于所有人，但是在构建系统之前，花些时间想想应用程序将如何发出幂等请求。

在许多情况下，第一次使用支付可能是你对幂等的第一次介绍，但这并不意味着它应该是一个不好的介绍。幂等性是一个强大的工具，可以帮助你的应用和服务更好地适应不可预料和不可控的情况。如果你想了解更多，你可能想看看 [Square 文档](https://docs.connect.squareup.com/basics/api101/idempotency)或者[这个关于奶牛的视频](https://www.restapitutorial.com/lessons/idempotency.html)(关于这个主题的首要工作)。

如果你想及时了解我们的其他内容，一定要关注这个[博客](https://medium.com/square-corner-blog) &我们的[推特](https://twitter.com/SquareDev)账号，并注册我们的[开发者简讯](https://www.workwithsquare.com/developer-newsletter.html?channel=Online%20Social&sqmethod=Blog)！我们还有一个 [Slack](https://squ.re/slack) 社区，用于与实现 Square APIs 的其他开发人员联系和交流。