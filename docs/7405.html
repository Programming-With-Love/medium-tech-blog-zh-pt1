<html>
<head>
<title>My Top Tips for Effective, Maintainable and Safe Terraform 0.12 Projects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我对有效、可维护和安全的Terraform 0.12项目的最高提示</h1>
<blockquote>原文：<a href="https://medium.com/version-1/my-top-tips-for-effective-maintainable-and-safe-terraform-0-12-projects-eaa52846d353?source=collection_archive---------0-----------------------#2020-03-04">https://medium.com/version-1/my-top-tips-for-effective-maintainable-and-safe-terraform-0-12-projects-eaa52846d353?source=collection_archive---------0-----------------------#2020-03-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="9589" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从Terraform开始很容易，安全有效地使用它很难。从在战壕中工作开始，这些是我让生活变得更轻松和避免灾难的建议。好吧，有点戏剧性，但你明白了。😂</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/373b92c3aa91a231a5375e774a6d5463.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sgYr56kTvZ42ord7nVMdZg.jpeg"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Photo by <a class="ae js" href="https://unsplash.com/@stpxn?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Stephan Mahlke</a> on <a class="ae js" href="https://unsplash.com/s/photos/avalanche?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="a7ed" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">固执己见的模块是好的，但是不要过分</h1><p id="e4bb" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">Terraform最直接的好处是通过自动化提高了生产率。然而，在这之后，其他的商业利益开始出现，例如，开始通过使用模块将期望的架构模式强加给开发人员。</p><p id="acb9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Terraform允许你创建任何大小和复杂度的模块，它们可以是“非个性化的”——不超过一个包装器，与此相反，有个性化的模块将提供一个非常严格的架构模型。这方面没有严格的规则，但是当设计自以为是的模块时，需要仔细考虑它们的设计，以确保它们不会限制未来的用例，并提供尽可能简单的接口。根据我的经验，堆栈越低(即VPC /网络层)，就越需要小心——这是有道理的，这是您架构的基础，这里的一个失误将波及您的整个解决方案。</p><blockquote class="kw kx ky"><p id="e113" class="ie if kz ig b ih ii ij ik il im in io la iq ir is lb iu iv iw lc iy iz ja jb ha bi translated">固执己见的模块有助于加强架构模式和可重复性，但要避免设计太不灵活的模块，否则可能会被忽略或创建一个不利于开发的环境。</p></blockquote><h1 id="d2bb" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">潜在危险信号</h1><p id="9b6d" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated"><em class="kz">子网魔法</em> —警惕模块在哪里接受单个CIDR并自动分配范围。子网大小将因您的解决方案而异，并且不同的子网可能需要非常专业的路由，您将会覆盖/重复太多，以至于任何好处都可能被抵消。如果强制执行NACLs或路由表是必须的，考虑将检查作为管道的一部分，例如，如果您是Terraform Enterprise客户，可以使用<a class="ae js" href="https://www.openpolicyagent.org/docs/latest/terraform/" rel="noopener ugc nofollow" target="_blank"> OPA </a>或Sentinel。</p><p id="d738" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kz">输入变量膨胀</em>——超过几十个输入变量，这里有一股代码味。你是否一遍又一遍地提供相同的信息——如果是，为什么模块不使用确定性信息(如标签值)自己查找呢？</p><h1 id="8279" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">好例子</h1><p id="8e2e" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">我是AWS Terraform注册模块的忠实粉丝，尤其是VPC——它有很好的封装平衡，但没有越界。</p><h1 id="02c2" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">为可维护性设计您的地形项目</h1><p id="d225" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">尤其是在多团队环境中工作时，您的terraform项目的结构以及它们如何相互链接至关重要。</p><h1 id="c3cd" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">分层</h1><p id="4536" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">当第一次学习terraform时，很容易建立一个垂直范围的项目。这可能包括VPC、IAM角色，一直到EC2和Lambdas。创建这种风格的项目很容易，但是使得团队协作明显更加困难，并且在将来可能导致代码重复和不灵活。相反，考虑将你的地形“景观”分成几层；</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ld"><img src="../Images/c240611a87f6c9486cdc679b687cfb4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PB0SATHqT_NVpMcy.png"/></div></div></figure><p id="5590" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">较低层对变化的容忍度较低(一个变化可能波及整个堆栈)，但是如果它们被分开，与上面的层相比，它们可能会看到非常小的变化。打破这些层将为您的环境创建一个更安全的环境，并减少terraform项目中的相互依赖性。理论上应该是这个意思；</p><ul class=""><li id="322a" class="le lf hh ig b ih ii il im ip lg it lh ix li jb lj lk ll lm bi translated">更容易限制不同的操作关注点——例如，应用程序开发人员应该不需要更改或部署与他们下面的层相关的存储库，</li><li id="cd7e" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">将基本的、低流失的项目(如VPC和转接网关)分开，将保护它们免受栈中更高层的意外中断性更改的影响，</li><li id="23f5" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">高保证环境将需要职责分离，创建这样的层会创建自然的边界以满足法规遵从性要求。</li></ul><h1 id="6c5a" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">保持干燥</h1><p id="044b" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">不要重复你自己，你会在任何开发圈子里听到很多(回忆时间——我第一次听到它是在很多年前学习Ruby on Rails的时候😅).在terraform的世界里，没有定义一个好的项目结构的“轨道”(因此有了这篇文章)，所以如何避免重复在很大程度上取决于你自己。不过，我会留意一些反模式…</p><p id="bc18" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">跨项目复制前端</strong></p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ls"><img src="../Images/e9f634b69b28c5f2138f21ba1462ef0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Rx9hZqSYEQO8g-PC.jpg"/></div></div></figure><p id="ba35" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">起初，这看起来像是一个结构良好的项目，然而，再看远一点，无论<code class="du lt lu lv lw b">app.tf</code>和<code class="du lt lu lv lw b">database.tf</code>的内容是什么，这都可能导致大量的重复。在最好的情况下，这些是前端<code class="du lt lu lv lw b">module</code>对公共模块的调用，在最坏的情况下，它们不是。如果您需要更改一个环境中的资源，那么每个环境都需要依次更新——既慢又容易出错。而是考虑；</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lx"><img src="../Images/8536ccb2984a775141d556fdab220ed6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*71r-wiC7rlqvQM7y.jpg"/></div></div></figure><p id="8da1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">创建一个公共的terraform目录和单独的<code class="du lt lu lv lw b">tfvars</code>大大减少了重复。通过根据需要从分支部署到您的开发/ QA /生产环境中，可以实现最前沿的分离。需要在生产中禁用开发服务吗？在模块中创建特性标志来控制它们的行为。</p><p id="250b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你不能在一个模块上使用<code class="du lt lu lv lw b">count</code>，我听到你哭了——看看<a class="ae js" href="https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/2.21.0" rel="noopener ugc nofollow" target="_blank"> Terraform VPC注册模块</a>中<code class="du lt lu lv lw b">create_vpc</code>功能切换的代码，它能工作，而且感觉比count还要干净。</p><p id="6918" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一些有助于保持定制模块干燥的技巧；</p><ul class=""><li id="dc48" class="le lf hh ig b ih ii il im ip lg it lh ix li jb lj lk ll lm bi translated">减少你的开发伙伴的精神负担，保持所需的变量清晰、最小和相关，</li><li id="9659" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">尽可能使用模块中变量的默认值，以减少模块的“接口”大小，</li><li id="a697" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">使用输入和有用的变量描述来减少输入错误，</li><li id="6930" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">减少跨tfvars的重复，跨环境一致的值应该在一个<code class="du lt lu lv lw b">auto.tfvars</code>文件中声明，特定于环境的tfvars作为<code class="du lt lu lv lw b">-var-file=&lt;file&gt;</code>参数的一部分被引用到<code class="du lt lu lv lw b">terraform</code>。</li></ul><h1 id="06be" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">伟大的阅读</h1><p id="89fa" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated"><a class="ae js" rel="noopener" href="/capital-one-tech/terraform-poka-yokes-writing-effective-scalable-dynamic-and-error-resistant-terraform-dcbd6a0ada6a">Terraform Poka-Yokes</a>——一个写“安全”terra form的好方法，允许不同层次的消费。这允许在提供灵活性的同时加强架构模式。</p><p id="0edf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae js" href="https://apparently.me.uk/terraform-environment-application-pattern/overview.html" rel="noopener ugc nofollow" target="_blank"> Terraform环境+应用模式</a> —这是一个很好的深度探索，探索了创建Terraform应用的分层方法，但是，我的个人偏好不同意一些实现选择(即跨层共享状态信息的咨询)。我还会考虑，与通过tfvars或使用类似于<a class="ae js" href="https://github.com/gruntwork-io/terragrunt" rel="noopener ugc nofollow" target="_blank"> terragrunt </a>的工具进行特性标记相比，使用特定于环境的前端模块的方法有多枯燥。</p><h1 id="5a17" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">Hashicorp对如何使用他们的工具有自己的看法，请遵循他们的看法</h1><p id="5a59" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">在GitHub上阅读Terraform的问题跟踪器，许多语言“特性请求”都得到了坚定但深思熟虑的满足。他们清楚地知道他们的语言应该允许你做什么，不应该做什么。</p><p id="0615" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我不会在这里赢得很多粉丝，但我相信这是一件好事。人们最关心的是创建具有更多动态开/关功能的模块——如果您遇到了语言障碍，请考虑您的项目/模块结构是否有问题？我知道震惊！</p><p id="3b05" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你的代码似乎在循环，考虑把它分开。一个庞大的项目来部署所有的东西会给你带来比任何街头技术更大的痛苦。</p><h1 id="9f1f" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">好的读物</h1><p id="2772" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated"><a class="ae js" href="https://www.terraform.io/docs/modules/composition.html#conditional-creation-of-objects" rel="noopener ugc nofollow" target="_blank">模块组成</a>是一个很棒的资源，应该阅读和消化。</p><p id="4a4d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">阅读terraform的GitHub问题库中的评论，例如<a class="ae js" href="https://github.com/hashicorp/terraform/issues/11782" rel="noopener ugc nofollow" target="_blank"/>，也可以是一座金矿。</p><h1 id="c933" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">设计失败，计划失败(没有双关语)</h1><p id="65ea" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">启动Terraform可能有点太简单了(T2)。你可以马上开始，在相当长的一段时间内，一切都会🌈和🦄。</p><p id="7a9d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，如果没有考虑清楚你将使用terraform做什么，谁可能会使用它，这很可能会让你在未来陷入困境。在破土动工之前，试着理解你的基础设施<strong class="ig hi">和开发过程</strong>的一些基本原理。想想；</p><ul class=""><li id="429f" class="le lf hh ig b ih ii il im ip lg it lh ix li jb lj lk ll lm bi translated">在AWS的情况下，你将有一个多帐户设置，或平面结构？(这将影响您如何配置您的状态桶和提供者配置)，</li><li id="7872" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">您是否有独立的开发运维团队负责基础架构的不同部分？(即使没有，分层仍然是一个非常明智的想法)</li><li id="a0c1" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">您将如何划分您的应用程序和不同的环境？(虚拟专用计算机、子网、帐户)</li><li id="4463" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">你将如何为那些需要通过terraform做出改变的人创建一组可靠而安全的角色？(可能—只读控制台，部署权限仅提供给Terraform runner，即Atlantis、Jenkins、Terraform Enterprise)</li><li id="ad64" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">您将如何连接您的VPCs？(考虑到中转网关连接和VPC端点，专用子网可以做到这一点)</li><li id="e08b" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">您有通用的标记策略吗？(您可能希望将它推送到一个公共模块)</li><li id="b16d" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">您将如何执行您的terraform项目？(从CI系统或共享主机内部)</li></ul><h1 id="f547" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">保持一致</h1><p id="4839" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">一旦你对如何使用terraform和谁将使用terraform有了一个很好的概述，开发一个terra form风格和使用指南，作为保持事情一致性的基础。你可能想掩盖；</p><ul class=""><li id="3c52" class="le lf hh ig b ih ii il im ip lg it lh ix li jb lj lk ll lm bi translated">项目将如何分解，</li><li id="2578" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">命名约定，</li><li id="62e0" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">vars.tf排序(例如局部变量、变量、带有默认值的变量)，</li><li id="4ba7" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">使用哪些平台注册模块，内部创建哪些公共模块，</li><li id="3d73" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">分支和部署策略，</li><li id="5d74" class="le lf hh ig b ih ln il lo ip lp it lq ix lr jb lj lk ll lm bi translated">陈述铲斗位置和配置。</li></ul><p id="4356" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里的主题是尽早对terraform的使用达成共识，避免技术债务。重构terraform是可能的，尤其是在使用<code class="du lt lu lv lw b">terraform import</code>的情况下，但是可能会很快变得危险！</p><p id="eadf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你的地球战争故事是什么？分享以下内容供大家学习——目前，我就说到这里！</p><p id="8a77" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">关于作者</strong></p><p id="8fe7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kz"> Tom Werner是Version 1的DevOps顾问，致力于为英国的企业客户进行现代、创新和有效的云部署。请继续收听第一版《Medium 》,了解更多来自Tom的DevOps作品。</em></p></div><div class="ab cl ly lz go ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ha hb hc hd he"><p id="fe64" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kz">原载于2020年3月4日</em><a class="ae js" href="https://fluffycloudsandlines.blog/terraform-top-tips/" rel="noopener ugc nofollow" target="_blank"><em class="kz">https://fluffycloudsandlines . blog</em></a><em class="kz">。</em></p></div></div>    
</body>
</html>