<html>
<head>
<title>Performance Impact and Troubleshooting IIS Worker (W3PWP.EXE) Process.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">IIS工作进程(W3PWP.EXE)的性能影响和故障排除。</h1>
<blockquote>原文：<a href="https://medium.com/version-1/performance-impact-and-troubleshooting-iis-worker-w3pwp-exe-process-cce911d8cbea?source=collection_archive---------4-----------------------#2022-07-16">https://medium.com/version-1/performance-impact-and-troubleshooting-iis-worker-w3pwp-exe-process-cce911d8cbea?source=collection_archive---------4-----------------------#2022-07-16</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/b8514d5634697fa410a57841d8410977.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TlYMFiLXEivoCSXL0yLA0w.png"/></div></div></figure><p id="b987" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">IIS中托管的web应用程序的性能可能会受到工作进程达到或最大限度地利用CPU资源的影响，并显示100%,这导致后续请求因缺乏资源而堆积。我写这篇文章是因为我在生产机器上的一个项目中遇到了类似的问题，这些问题阻碍了用户，并且我们听到了很多关于应用程序运行缓慢的抱怨。</p><p id="26e4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">利用CPU资源的IIS工作进程可能是由各种原因造成的。在这篇博客中，我们将调查一些最大的可能性以及如何解决它们。</p><p id="3605" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">可能导致IIS工作进程(w3pwp.exe)使用最大CPU资源w3pwp.exe的一些常见原因有:</strong></p><ol class=""><li id="966e" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated">请求在ASP.NET管道中受阻或受阻</li><li id="11ca" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">web应用程序中的高错误率</li><li id="25ca" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">高网络流量</li><li id="f984" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">碎片帐集</li><li id="3451" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">效率低下。网络代码</li><li id="c944" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">应用程序依赖关系过时或有问题</li></ol><p id="cb65" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我将只讨论上述场景中的某些要点，并深入探讨第1点，以识别和分析它。</p><p id="82e4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">请求在ASP.NET管道受阻或被卡</strong></p><p id="9788" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这里要做的第一件事是查看当前正在运行的请求，并调查它们是否被阻塞或挂起。这可能会给出哪些请求花费了很长时间或被阻塞的简要指示。可能存在排队的请求，这些请求并不直接是问题的一部分，也不是警报的原因。</p><h2 id="d822" class="kb kc hh bd kd ke kf kg kh ki kj kk kl ja km kn ko je kp kq kr ji ks kt ku kv bi translated">识别</h2><p id="bee9" class="pw-post-body-paragraph ip iq hh ir b is kw iu iv iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm ha bi translated">ASP.NET请求的生命周期中有许多步骤。基本步骤包括认证、授权、评估http请求和完成请求。如果面临任何性能问题，首先要识别特定的http模块。</p><figure class="lc ld le lf fd ii er es paragraph-image"><div class="er es lb"><img src="../Images/ec3df4d120b6de51e19bd50c81456d69.png" data-original-src="https://miro.medium.com/v2/resize:fit:956/format:webp/1*2QqSYaBt8fhGxXAjpLZkng.png"/></div></figure><p id="cab9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">打开IIS管理控制台，您可以查看正在运行的工作进程，选择导致高CPU的有问题的IIS应用程序池，并查看当前正在运行的请求。</p><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lg"><img src="../Images/950595ccb71e7dfdd97e46169e276f1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dvh4RTF-o9Gp_GTpSNxBLg.png"/></div></div></figure><p id="4a18" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">从IIS中选择工作进程，可以看到当前正在运行的IIS工作进程。</strong></p><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lg"><img src="../Images/776b9c25c08863badbf888b1fe0d91ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k2anmM2WpDYycFY7S5vZoA.png"/></div></div></figure><p id="342c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">双击应用程序池名称，它将让您查看所有当前正在执行的请求。您可以看到每个请求位于ASP.NET管道的不同部分，并且当前正在执行不同的HTTP模块。</p><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lg"><img src="../Images/b5305cfbb8ff37b7e2a8f1178c86fdee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-wG2ynWX3r9nqNgtbq5CxQ.png"/></div></div></figure><p id="3615" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">上面的快照为您提供了当前正在执行的请求的信息。</p><ul class=""><li id="5217" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm lh jt ju jv bi translated">URL:正在执行的完整URL</li><li id="2c00" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm lh jt ju jv bi translated">time:web请求执行的总时间，以毫秒为单位</li><li id="b2c1" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm lh jt ju jv bi translated">客户端:发起请求的用户的IP地址</li><li id="d1c4" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm lh jt ju jv bi translated">状态:请求当前正在其中运行的IIS管道的阶段</li><li id="cd48" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm lh jt ju jv bi translated">模块:当前正在执行的ASP.Net模块。</li></ul><h2 id="fc81" class="kb kc hh bd kd ke kf kg kh ki kj kk kl ja km kn ko je kp kq kr ji ks kt ku kv bi translated"><strong class="ak">分析</strong></h2><p id="9341" class="pw-post-body-paragraph ip iq hh ir b is kw iu iv iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm ha bi translated">要更深入地了解实际问题的原因，您可以从w3wp.exe进程中获取类似于下面的内存转储:</p><figure class="lc ld le lf fd ii er es paragraph-image"><div class="er es li"><img src="../Images/f4f0c7002e3fd0de9a188908682dc111.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/format:webp/1*zDsKjqOpztFLvP3VTMvo5g.png"/></div></figure><p id="7494" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然后使用微软或visual studio的<a class="ae lj" href="https://www.microsoft.com/en-us/download/details.aspx?id=58210#:~:text=The%20Debug%20Diagnostic%20Tool%20(DebugDiag,in%20any%20user%2Dmode%20process." rel="noopener ugc nofollow" target="_blank"> debugdiag </a>之类的工具来分析内存转储，缩小导致请求阻塞的线程范围。让我们看看如何才能理解相同。</p><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lg"><img src="../Images/c7b8ea7ac9e62f68d540cb91fc18162e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*--rga1p-avLmnAGaIDw-mQ.png"/></div></div></figure><p id="b620" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">点击Start Analysis，它将生成一个类似下面示例的报告，其中包含CPU时间排名靠前的线程，以及线程中是否发生了导致线程阻塞的任何错误的详细信息。</p><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lk"><img src="../Images/cb44add3037631fd7537cfa68b646316.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KUwq8mPeYhi9krDEPkg4BA.png"/></div></div></figure><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lg"><img src="../Images/5a89174a844cef235be6ba67f18470e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AZkl2jWBhoQtaBUg9RwhcA.png"/></div></div></figure><p id="47a2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在visual studio中打开与下面相同的文件，对线程运行分析将为您提供更多的信息，以便您进行识别和操作。</p><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lg"><img src="../Images/5869aa1e3336fa21b67b2c1344b33b67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rQI-sBNiQkLI3vCxasCG-Q.png"/></div></div></figure><p id="c587" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">点击上图右上方的“运行诊断分析”,获取详细信息，进一步确定根本原因。</p><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lg"><img src="../Images/f7cdb66e587d0314ad4ed59b5799e3b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qwJIIybnoPx5Ds3ixclHMw.png"/></div></div></figure><h2 id="96bb" class="kb kc hh bd kd ke kf kg kh ki kj kk kl ja km kn ko je kp kq kr ji ks kt ku kv bi translated"><strong class="ak">可能的解决方案</strong></h2><p id="47ca" class="pw-post-body-paragraph ip iq hh ir b is kw iu iv iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm ha bi translated">线程上的异常将清楚地指出是哪部分代码导致线程中断和请求阻塞。我遇到的一些提示。</p><ol class=""><li id="2572" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated">在上面的案例中，我们有一个场景，<a class="ae lj" href="https://aloiskraus.wordpress.com/2021/08/11/concurrent-dictionary-modification-pitfalls/" rel="noopener ugc nofollow" target="_blank">并发字典修改陷阱</a></li><li id="165b" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">检查并设置应用程序的应用程序池，以及时清除重置。</li><li id="5dee" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">另一种可能的情况是增加<a class="ae lj" href="https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/retargeting/4.6.2-4.7" rel="noopener ugc nofollow" target="_blank">RequestQueueLimitPerSession</a>。</li></ol><h2 id="ce07" class="kb kc hh bd kd ke kf kg kh ki kj kk kl ja km kn ko je kp kq kr ji ks kt ku kv bi translated"><strong class="ak">网络应用中的高错误率</strong></h2><p id="c1dd" class="pw-post-body-paragraph ip iq hh ir b is kw iu iv iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm ha bi translated">工作进程高CPU使用率的另一个可能原因是您可能不知道的大量应用程序错误，其中一些错误可能被用户收到的一般消息或普通消息所掩盖。我们可以确保使用错误监控或应用程序性能管理工具来识别错误。其他地方或更常见的地方是生成的IIS日志，其中包含请求的详细信息、响应、请求的任何问题、网络相关故障等。这应该是你开始调查的理想地点。</p><p id="a906" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">此外，您可以在windows中查看性能监视器，并使用如下计数器对其进行分析:</p><ul class=""><li id="d1a3" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm lh jt ju jv bi translated">NET CLR Exceptions--&gt;/秒抛出的异常数:检查此项以查看您的应用程序是否抛出了大量异常。您的应用程序可能会有许多隐藏的错误，从而导致严重的性能问题。任何例外都是不好的，但有些是不可避免的。</li><li id="70d9" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm lh jt ju jv bi translated">W3SVC _ W3WP--&gt; % 500已发送HTTP响应:任何带有500状态代码的请求都是内部服务器错误。确保这个百分比非常低。应该是0–1%。</li></ul><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lg"><img src="../Images/273bc36092d60a4a54fb355dd38041c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ntsxK5AzU27VDFHlk_OafA.png"/></div></div></figure><h2 id="4204" class="kb kc hh bd kd ke kf kg kh ki kj kk kl ja km kn ko je kp kq kr ji ks kt ku kv bi translated"><strong class="ak">网络流量高</strong></h2><p id="1904" class="pw-post-body-paragraph ip iq hh ir b is kw iu iv iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm ha bi translated">有时，工作进程高CPU使用率的一个简单解释可能是web流量的增加。</p><p id="8e31" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您可以使用IIS日志文件来查看特定日期的请求池数量，您可以使用像<a class="ae lj" href="https://www.finalanalytics.com/products/httplogbrowser" rel="noopener ugc nofollow" target="_blank"> IIS日志浏览器</a>这样的工具来分析请求，这可以提供时间戳、URL、状态、失败原因、客户端IP等主要细节。也给你的报告工作，以确定最命中网址，最失败的网址等。</p><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lg"><img src="../Images/71d186da99937b88321d03186a7c9ad5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k5P4EMDAUThof-sY3XyCfw.png"/></div></div></figure><h2 id="2a3d" class="kb kc hh bd kd ke kf kg kh ki kj kk kl ja km kn ko je kp kq kr ji ks kt ku kv bi translated"><strong class="ak">垃圾收集</strong></h2><p id="b876" class="pw-post-body-paragraph ip iq hh ir b is kw iu iv iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm ha bi translated">微软。NET利用<a class="ae lj" href="https://docs.microsoft.com/en-us/dotnet/standard/garbage-collection/?redirectedfrom=MSDN" rel="noopener ugc nofollow" target="_blank">垃圾收集</a>来管理内存的分配和释放。</p><p id="6a75" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">根据您的应用程序所做的事情，应用程序内存的分配和清理可能会导致大量的垃圾收集活动。例如，在大型对象堆上使用大量大型字符串变量会导致垃圾收集问题。</p><p id="bcb0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">若要衡量垃圾收集是否会给应用程序带来问题，请检查以下Windows性能计数器:</p><p id="4770" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">。NET CLR Memory - &gt; %如果这个数字大大超过5–10 %,您需要进一步调查内存使用情况。</strong></p><p id="0a02" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">垃圾收集也有两种模式。您可能需要启用<a class="ae lj" href="https://msdn.microsoft.com/en-us/library/cc165011(v=office.11).aspx" rel="noopener ugc nofollow" target="_blank">服务器模式</a>，这不是默认模式。</p><h2 id="ef84" class="kb kc hh bd kd ke kf kg kh ki kj kk kl ja km kn ko je kp kq kr ji ks kt ku kv bi translated"><strong class="ak">效率低下。网络代码</strong></h2><p id="b379" class="pw-post-body-paragraph ip iq hh ir b is kw iu iv iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm ha bi translated">效率低下。如果没有其他结果，就需要研究一下. NET代码。可以使用<a class="ae lj" href="https://docs.microsoft.com/en-us/dotnet/framework/unmanaged-api/profiling/profiling-overview" rel="noopener ugc nofollow" target="_blank">之类的剖析器。NET Profiler </a>或<a class="ae lj" href="https://www.red-gate.com/products/dotnet-development/ants-performance-profiler/" rel="noopener ugc nofollow" target="_blank">ANTS performance Profiler</a>捕获被调用的函数并进一步分析它们。profiler提供了CPU使用的开销情况，因此如果您已经使用了85%以上，那么运行profiler将会很困难，这可能会导致它达到100%并使应用程序不可用。</p><h2 id="c29d" class="kb kc hh bd kd ke kf kg kh ki kj kk kl ja km kn ko je kp kq kr ji ks kt ku kv bi translated"><strong class="ak">应用依赖关系过时或有问题</strong></h2><p id="7bb1" class="pw-post-body-paragraph ip iq hh ir b is kw iu iv iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm ha bi translated">拥有第三方依赖关系会导致使用旧的、易受攻击的版本，识别应用程序上的依赖关系，并定期更新它们，以更新安全、漏洞、内存泄漏或任何其他由于这些依赖关系而可能发生的问题，这些依赖关系没有清楚地记录。</p><h2 id="59e4" class="kb kc hh bd kd ke kf kg kh ki kj kk kl ja km kn ko je kp kq kr ji ks kt ku kv bi translated"><strong class="ak">结论</strong></h2><p id="09f8" class="pw-post-body-paragraph ip iq hh ir b is kw iu iv iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm ha bi translated">希望在阅读完这篇文章后，您将有一个起点来分析您的性能问题，改进它，而不是在一个关键阶段，您的应用程序将因为100%的CPU使用率而被折腾。我希望这篇简短的文章给你一个视角，并指导你采取必要的步骤来解决这个问题。</p><figure class="lc ld le lf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ll"><img src="../Images/432824a2877c83b42683cf5ed533cf52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fylFeXINVDmnLOBJVl6C_A.jpeg"/></div></div></figure><p id="5e0d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">关于作者:<br/> </strong>达尔山·拉维普拉卡什(Darshan Raviprakash)是一名大四学生。Net开发人员在这里的版本1。</p></div></div>    
</body>
</html>