<html>
<head>
<title>Understanding AWS IAM policies best practices from zero</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从零开始了解AWS IAM策略和最佳实践</h1>
<blockquote>原文：<a href="https://medium.com/globant/understanding-aws-iam-policies-best-practices-from-zero-b51ff57dcbc8?source=collection_archive---------0-----------------------#2022-06-04">https://medium.com/globant/understanding-aws-iam-policies-best-practices-from-zero-b51ff57dcbc8?source=collection_archive---------0-----------------------#2022-06-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="a8eb" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">简介</strong></h1><p id="5529" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">我使用AWS已经很长时间了，其中最关键的，有时也是最难理解的方面是IAM策略的正确管理。</p><p id="5f81" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">我知道许多公司有许多限制来强制创建适当的IAM策略，但情况并非总是如此。</p><p id="589a" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">此外，我不会说谎，我对IAM策略的创建轻描淡写了很多次，原因有很多，环境并不重要，这只是一个概念验证，我会立即删除资源，AWS是完全安全的，还有很多原因，你可以说出他们的名字。然而，当你养成了轻写IAM策略的习惯，你就习惯了(一个巨大的错误)。</p><p id="2159" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">为什么会这样呢？我说的是我自己，但我以前也见过很多人这样做，所以我可能不是唯一一个利用这种不良做法的人。</p><p id="ff5a" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">通常，编写IAM策略的原因之一是因为您没有足够的时间(谁有足够的时间？)而且你并不完全了解它们是如何工作的。我将尝试简单而深入地解释IAM策略是如何工作的，这样下次编写策略时，就可以避免使用通配符。</p><p id="f831" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">本文将回顾以下部分:</p><p id="3c56" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">IAM策略的基础</p><p id="f19f" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">政策评价</p><p id="6ffb" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">最小特权原则</p><p id="2148" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">结论</p><h1 id="88f2" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">IAM政策基础</strong></h1><p id="5e51" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">让我们从基础开始，IAM策略允许对访问特定AWS资源所需的权限进行粒度级访问定义。策略附加到IAM身份(用户、用户组或角色)或AWS资源。当IAM主体(用户或角色)发出请求时，AWS会评估这些策略。</p><p id="2d62" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">IAM策略被定义为JSON文档，由一些元素组成，这里我们只详细讨论其中的4个:<strong class="je hi">语句</strong>、<strong class="je hi">效果</strong>、<strong class="je hi">动作</strong>和<strong class="je hi">资源</strong>，其中前3个是语句元素的一部分。这是IAM策略的典型示例:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="716f" class="ko if hh kk b fi kp kq l kr ks">{</span><span id="0e8b" class="ko if hh kk b fi kt kq l kr ks">    “Statement”: {</span><span id="a7bd" class="ko if hh kk b fi kt kq l kr ks">        “Effect”: “Allow”,</span><span id="7623" class="ko if hh kk b fi kt kq l kr ks">        “Action”: “ec2:DescribeInstances”,</span><span id="8eb0" class="ko if hh kk b fi kt kq l kr ks">        “Resource”: “*”</span><span id="0217" class="ko if hh kk b fi kt kq l kr ks">    }</span><span id="1427" class="ko if hh kk b fi kt kq l kr ks">}</span></pre><p id="3059" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">声明</strong>:这是IAM政策的主要元素，也是必需的。Statement元素可以包含多个单独的语句，其中单独的语句包含在{}块中。</p><p id="180c" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">效果</strong>:指定该语句是被允许还是被明确拒绝。只有两个可能的值:允许或拒绝。</p><p id="1131" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">动作</strong>:定义允许或拒绝的动作列表。每个AWS服务都有自己的一组操作，例如:</p><p id="465b" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><em class="ku"> ec2:描述实例</em></p><p id="de17" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><em class="ku">rds:created instance</em></p><p id="9ce6" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">s3:列表对象</p><p id="81b0" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><em class="ku"> sqs:SendMessage </em></p><p id="346b" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">资源</strong>:定义语句覆盖的对象。它被定义为可以唯一标识AWS资源的亚马逊资源名(ARN)。</p><h1 id="a0cf" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">政策评估</strong></h1><p id="48d5" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">现在已经定义了IAM策略的基本结构，我们可以更进一步，讨论如何评估IAM策略。</p><figure class="kf kg kh ki fd kw er es paragraph-image"><div class="er es kv"><img src="../Images/9974f9cbcf4d555c97e8a26dc04cc989.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/0*K7l_0mMgT_FW1m_6"/></div></figure><ol class=""><li id="8fa4" class="kz la hh je b jf ka jj kb jn lb jr lc jv ld jz le lf lg lh bi translated">评估总是以隐式拒绝开始，这是因为AWS中的所有内容在默认情况下都会被拒绝。</li><li id="2eca" class="kz la hh je b jf li jj lj jn lk jr ll jv lm jz le lf lg lh bi translated">评估效果元素。</li><li id="73b6" class="kz la hh je b jf li jj lj jn lk jr ll jv lm jz le lf lg lh bi translated">如果Effect的值是Deny，则评估将是拒绝请求。</li><li id="29c7" class="kz la hh je b jf li jj lj jn lk jr ll jv lm jz le lf lg lh bi translated">如果Effect的值为Allow，则评估将允许该请求。</li><li id="88b3" class="kz la hh je b jf li jj lj jn lk jr ll jv lm jz le lf lg lh bi translated">如果没有找到Allow，评估将是拒绝请求。</li></ol><p id="6299" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">正如你所注意到的，评估过程非常简单，一点也不复杂。当您需要为涉及多个操作的操作创建策略时，事情就变得复杂了(并且您没有指定哪些操作是那些操作)。</p><p id="a052" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">最小特权原则</strong></p><p id="a9d6" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">在AWS上定义策略是基于最小特权的原则，这意味着您给予身份完成其职责所需的最少的访问和责任。一个好的做法是始终从最小的权限集开始，并在必要时授予额外的权限。</p><p id="3fad" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">一个常见的例子是为RDS数据库创建备份和管理快照。这个操作实际上涉及到许多您需要授权来执行整个操作的操作。<br/>如果您很匆忙，您可能会尝试创建一个带有通配符的策略，允许RDS中的所有操作，如下所示:</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="f364" class="ko if hh kk b fi kp kq l kr ks">{</span><span id="fe9f" class="ko if hh kk b fi kt kq l kr ks">    “Statement”: {</span><span id="f271" class="ko if hh kk b fi kt kq l kr ks">        “Effect”: “Allow”,</span><span id="be49" class="ko if hh kk b fi kt kq l kr ks">        “Action”: “rds:*”,</span><span id="f3ec" class="ko if hh kk b fi kt kq l kr ks">        “Resource”: “*”</span><span id="f834" class="ko if hh kk b fi kt kq l kr ks">    }</span><span id="54f3" class="ko if hh kk b fi kt kq l kr ks">}</span></pre><p id="e4f1" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">该策略将授予主体对RDS上所有操作的访问权限，但是所有操作都包括危险的操作，如删除所有数据库，所以这确实不是一个好的做法。</p><p id="2599" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">这个用例的理想策略将列出每个需要的操作，然后将资源部分的范围缩小到那些需要的arn。</p><pre class="kf kg kh ki fd kj kk kl km aw kn bi"><span id="efda" class="ko if hh kk b fi kp kq l kr ks">{</span><span id="61ef" class="ko if hh kk b fi kt kq l kr ks">    “Statement”: [</span><span id="7417" class="ko if hh kk b fi kt kq l kr ks">    {</span><span id="7fa5" class="ko if hh kk b fi kt kq l kr ks">        “Effect”: “Allow”,</span><span id="fd21" class="ko if hh kk b fi kt kq l kr ks">        “Action”: [</span><span id="2428" class="ko if hh kk b fi kt kq l kr ks">            “rds:AddTagsToResource”,</span><span id="8492" class="ko if hh kk b fi kt kq l kr ks">            “rds:DeleteDBSnapshot”</span><span id="a1b1" class="ko if hh kk b fi kt kq l kr ks">        ],</span><span id="bdc6" class="ko if hh kk b fi kt kq l kr ks">        “Resource”: “arn:aws:rds:us-east-1::snapshot:db-snapshot”</span><span id="2e15" class="ko if hh kk b fi kt kq l kr ks">    },</span><span id="78fd" class="ko if hh kk b fi kt kq l kr ks">    {</span><span id="ab2a" class="ko if hh kk b fi kt kq l kr ks">        “Effect”: “Allow”,</span><span id="65a9" class="ko if hh kk b fi kt kq l kr ks">        “Action”: [</span><span id="f30b" class="ko if hh kk b fi kt kq l kr ks">            “rds:ListTagsForResource”,</span><span id="d65a" class="ko if hh kk b fi kt kq l kr ks">            “rds:CreateDBSnapshot”</span><span id="e0ef" class="ko if hh kk b fi kt kq l kr ks">        ],</span><span id="10ce" class="ko if hh kk b fi kt kq l kr ks">        “Resource”: “arn:aws:rds:us-east-1:*”</span><span id="33c4" class="ko if hh kk b fi kt kq l kr ks">    },</span><span id="334d" class="ko if hh kk b fi kt kq l kr ks">    {</span><span id="27c5" class="ko if hh kk b fi kt kq l kr ks">        “Effect”: “Allow”,</span><span id="1b9e" class="ko if hh kk b fi kt kq l kr ks">        “Action”: [</span><span id="943f" class="ko if hh kk b fi kt kq l kr ks">            “rds:DescribeDBSnapshots”</span><span id="1316" class="ko if hh kk b fi kt kq l kr ks">        ],</span><span id="d17f" class="ko if hh kk b fi kt kq l kr ks">        “Resource”: “*”</span><span id="073a" class="ko if hh kk b fi kt kq l kr ks">    }</span><span id="b283" class="ko if hh kk b fi kt kq l kr ks">    ]</span><span id="bf33" class="ko if hh kk b fi kt kq l kr ks">}</span></pre><p id="a887" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">这演示了如何缩小策略的操作和资源部分；但是，您可能会注意到在策略的末尾有一个通配符，我们一直在讨论使用通配符作为一种通用的良好做法？</p><p id="ed39" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">通常不建议使用通配符，但有时需要使用通配符，因此，如果您的某个策略(例如，上面的策略)需要使用通配符，也不必惊慌，因为您可能有多个快照，并且不可能在一个列表中逐个引用它们。</p><p id="c759" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">结论</strong></p><p id="5495" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">最后，创建IAM策略至关重要，但并不困难或不可能。以下列表总结了创建IAM策略时的最佳实践:</p><ul class=""><li id="a7f2" class="kz la hh je b jf ka jj kb jn lb jr lc jv ld jz ln lf lg lh bi translated">授予最小特权。仅授予执行任务所需的权限。</li><li id="f9e6" class="kz la hh je b jf li jj lj jn lk jr ll jv lm jz ln lf lg lh bi translated">验证策略。可以使用IAM Access Analyzer之类的工具，当语句被认为权限过大时，它会生成安全警告。</li><li id="4665" class="kz la hh je b jf li jj lj jn lk jr ll jv lm jz ln lf lg lh bi translated">基于访问活动生成策略。IAM Access Analyzer可以检查AWS CloudTrail日志，并使用实体已使用的权限生成策略模板。</li><li id="6d82" class="kz la hh je b jf li jj lj jn lk jr ll jv lm jz ln lf lg lh bi translated">使用AWS CloudTrail查看事件。您可以使用AWS CloudTrail来跟踪identity使用的权限，并在需要时删除不必要的权限。</li></ul></div></div>    
</body>
</html>