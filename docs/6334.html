<html>
<head>
<title>Experiment without the wait: Speeding up the iteration cycle with Offline Replay Experimentation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无需等待的实验:通过离线重放实验加速迭代周期</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/experiment-without-the-wait-speeding-up-the-iteration-cycle-with-offline-replay-experimentation-7a4a95fa674b?source=collection_archive---------0-----------------------#2022-01-18">https://medium.com/pinterest-engineering/experiment-without-the-wait-speeding-up-the-iteration-cycle-with-offline-replay-experimentation-7a4a95fa674b?source=collection_archive---------0-----------------------#2022-01-18</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="2fb1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Maxine Qian |数据科学家，实验和计量科学</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/2e6e9cd108cac4a44c0081aaf67a0e45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zr42qkdnePkZVjf_foGBOg.png"/></div></div></figure><p id="d52e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">创意推动创新。创新推动我们的产品朝着我们的使命前进，为每个人带来创造他们热爱的生活的灵感。创新的速度取决于我们能多快获得一个想法的信号或反馈，这样我们就能知道是追求还是转向。在线实验经常被用来评估产品创意，但它既昂贵又耗时。我们能在不进行实验的情况下预测实验结果吗？能在几小时而不是几周内完成吗？我们能迅速挑选出最好的想法来进行在线实验吗？这篇文章将描述Pinterest如何使用离线重放实验来提前预测实验结果。</p><h1 id="c041" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">在线实验的局限性</strong></h1><p id="90ec" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">数据支持的决策塑造了我们Pinterest产品的发展。所有产品团队都有权通过在线实验(A/B测试)来测试他们的产品变化，这是一个衡量对Pinterest用户(又名Pinners)影响的过程。然而，在线实验有几个局限性:</p><ul class=""><li id="58be" class="kr ks hh ig b ih ii il im ip kt it ku ix kv jb kw kx ky kz bi translated"><strong class="ig hi">缓慢的数据收集</strong>:至少需要7天甚至更长时间来提供充足的电力并捕捉任何周模式。</li><li id="96e2" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated"><strong class="ig hi">有限同步臂</strong>:只能有有限数量的变化同时运行，以便为每个变化提供足够的样本量。</li><li id="c77f" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated">规避风险的处理方法:为了最小化潜在的负面影响，有一种激励去部署更安全、更保守的想法，而不是风险更高但潜在影响更大的想法。</li><li id="9c70" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated"><strong class="ig hi">高工程成本</strong>:工程师需要编写生产质量的代码，因为它将在线部署给用户。</li></ul><p id="86ed" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于这些限制，在进行昂贵的在线实验之前对想法进行分类是至关重要的。</p><h1 id="cae4" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">离线回放实验</strong></h1><p id="88dc" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">我们如何解决在线实验的这些局限性？通过离线评估评估指标，例如<a class="ae lf" href="https://en.wikipedia.org/wiki/Evaluation_measures_(information_retrieval)#Mean_average_precision" rel="noopener ugc nofollow" target="_blank">平均精度</a>或<a class="ae lf" href="https://en.wikipedia.org/wiki/Receiver_operating_characteristic#Area_under_the_curve" rel="noopener ugc nofollow" target="_blank"> AUC </a>，可以获得概念的初步方向性分析。不幸的是，根据我们的经验观察，这些往往是在线实验表现的糟糕预测。</p><p id="6955" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们创建了一个叫做离线重放实验的框架，在这个框架中，新想法的表现可以基于历史数据完全离线模拟。在这个框架中，正在讨论的新想法可以是影响所提供内容顺序的任何东西，比如对排名或混合功能的更改。</p><p id="dd61" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">虽然模拟方法不如在线实验精确，但它通过消除数据收集的等待时间、允许大量同步arm、避免负面用户影响和节省工程成本来补充在线实验。</p><p id="5624" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">离线重放实验可以用来缩小想法漏斗，从一大组可能的候选人到几个值得通过在线实验追求的人。这个框架允许产品团队在几个小时内评估和迭代想法，而不是几周，极大地加快了迭代周期。它由两部分组成:</p><ul class=""><li id="0617" class="kr ks hh ig b ih ii il im ip kt it ku ix kv jb kw kx ky kz bi translated"><strong class="ig hi">反事实服务模拟</strong>:它模拟了如果我们在过去部署了变更，我们会为用户提供什么内容。</li><li id="fb18" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated"><strong class="ig hi">报酬估算</strong>:估算我们想要比较的每个实验变量的反事实服务结果的报酬(不同类型参与度的价值，如点击)。然后比较两个变量的估计值(例如，对照与处理)来计算升力。</li></ul><p id="4706" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">已经有一些关于如何生成反事实服务结果的博客和论文(例如，网飞的<a class="ae lf" href="https://netflixtechblog.com/distributed-time-travel-for-feature-generation-389cccdd3907#:~:text=We%20want%20to%20make%20it,past%20posts%20and%20other%20publications." rel="noopener ugc nofollow" target="_blank">分布式时间旅行用于特征生成</a>和<a class="ae lf" href="https://dl.acm.org/doi/10.1145/2740908.2742562" rel="noopener ugc nofollow" target="_blank">搜索引擎点击度量的反事实估计和优化:案例研究</a>)。在这里，我们将重点放在我们的奖励估计方法。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lg"><img src="../Images/983bdb57eed37449006d256a63d8116b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*r6O-rjRkcDJXXsM2"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx"><strong class="bd jq">Figure 1: </strong>Two components of offline replay experiment framework</figcaption></figure><h1 id="f971" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">奖励评估方法</strong></h1><p id="7009" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">我们将使用图2中的一个玩具数据集来说明奖励估计是如何工作的。表1显示了反事实的服务日志，即给定一个新的排名或混合函数，我们会为用户提供的项目。表2举例说明了生产日志、我们提供给用户的项目及其抽样概率，以及用户操作。每条记录代表一个在页面上排列的Pin，包含以下信息:</p><ul class=""><li id="4998" class="kr ks hh ig b ih ii il im ip kt it ku ix kv jb kw kx ky kz bi translated"><strong class="ig hi">请求</strong>是在请求的结果页面上对所有插入的项目(即，pin)进行分组的关键。</li><li id="2925" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated"><strong class="ig hi">位置</strong>是请求项目的显示位置。</li><li id="d976" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated"><strong class="ig hi">奖励</strong>是目标变量，通常对应点击、点赞等用户动作。</li><li id="b8cd" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated"><strong class="ig hi">采样概率</strong>是一个项目出现在请求位置的概率。</li></ul><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lg"><img src="../Images/34014e7ae0379743d7100746f7afa02e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Cq8QaQZy5wmT3YZR"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx"><strong class="bd jq">Figure 2:</strong> Toy dataset as an illustrative example</figcaption></figure><p id="fe07" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了估计回报，我们在两个数据集之间找到共享相同请求、位置和项目的匹配记录，并将匹配记录的回报相加作为总回报。为了消除选择偏差，我们对每个奖励应用一个权重，它是抽样概率的倒数。直觉上，具有较高采样概率的记录是过度表示的，因此我们希望对其奖励值应用较小的权重。</p><p id="ee05" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如图3所示，对于反事实服务和生产日志，我们能找到的唯一两个匹配记录是{request=r1，position=1，item=a}和{request=r2，position=3，item=f}，因此估计的回报是1/0.4 + 0/0.5 = 2.5。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lg"><img src="../Images/b8804d806212fffda5540ace85559c55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eDHhEMdizB_iLhbk"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx"><strong class="bd jq">Figure 3: </strong>Illustrative example of how Top K Match estimator works</figcaption></figure><p id="e5b9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们称这种奖励估计量为<strong class="ig hi">顶K匹配</strong>。k表示估算中包含的槽的深度。在我们的玩具例子中，K等于3。报酬估计量有多种变体，在偏差和方差之间进行权衡:</p><ul class=""><li id="7fc4" class="kr ks hh ig b ih ii il im ip kt it ku ix kv jb kw kx ky kz bi translated"><strong class="ig hi"> Top K无偏匹配</strong> : Top K假设一个物品的奖励与其周围的物品无关。我们可以通过为每个请求匹配整个排序的top-K列表来获得无偏的top-K重放估计器。如果根据新模型的排名前K列表与生产数据集中的请求的前K列表相同，则仅计算奖励。在图2中，两个日志都没有匹配的记录，因此估计的回报是0。</li><li id="6de6" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated"><strong class="ig hi">前K个未排序匹配</strong>:前K个匹配和前K个无偏匹配的匹配率可能较低，导致方差较大。我们可以通过放宽匹配标准来解决这个问题，只要求request_id和item_id匹配。如果根据新模型的前K个列表中的任何item_id与生产数据集中请求的任何位置中的item_id相同，则它计算奖励。如图4中的玩具示例所示，我们可以为两个日志找到的匹配记录是{request=r1，item=a}、{request=r2，item=d}和{request=r2，item=f}，因此估计的奖励是1/0.4 + 1/0.4 + 0/0.5= 5。</li></ul><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lg"><img src="../Images/34ad11b2169056154ef2e1754f82b0c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IUFnNICBCvqZxsa4"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx"><strong class="bd jq">Figure 4: </strong>Illustrative example of how Top K Unsorted Match estimator works</figcaption></figure><p id="0e34" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">值得一提的是，在实现过程中，采样概率通常是不可用的，并且需要对系统进行相当大的更改才能对其进行检测。为了简化问题，我们设置了一个小的总流量集的随机桶，其中我们随机化前N个结果的顺序，然后p等于1/N。</p><h1 id="de62" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">真实例子</strong></h1><p id="044a" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">我们在<a class="ae lf" href="https://help.pinterest.com/en/guide/all-about-pinterest" rel="noopener ugc nofollow" target="_blank"> Home feed </a>排名和混合模型上应用了离线重放实验，观察到了令人信服的结果。</p><p id="4713" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们首先计算了三个报酬估计量的<a class="ae lf" href="https://en.wikipedia.org/wiki/Power_of_a_test" rel="noopener ugc nofollow" target="_blank">统计功效</a>，发现前K个匹配和前K个未排序匹配可以有足够的功效来检测我们期望的<a class="ae lf" href="https://en.wikipedia.org/wiki/Effect_size" rel="noopener ugc nofollow" target="_blank">效应大小</a>，而前K个无偏匹配的功效则大大不足。然后，我们使用这两个足够强大的估计器运行离线重放实验，并在26个实验比较变量对上运行在线实验。</p><p id="3020" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以指标<em class="ll">点击</em>为例，我们发现在线和离线提升之间有很强的相关性，如图5所示。一般来说，离线提升与较小的在线提升相关，但是基于它们的变体的等级顺序是相似的。</p><p id="c2f4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">比较在线和离线决策结果也发现了类似的强相关性(即，显著正面、不显著、显著负面)。这些结果表明前K个未排序的匹配(K=8)表现最好(即在线结果和离线重放之间具有最高的相关性)。如果我们运行离线重放实验，它将允许我们识别超过90%的在在线实验中显示出统计上显著和积极提升的候选者，同时过滤掉超过75%的在在线实验中显示出不显著或消极提升的候选者。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lg"><img src="../Images/8003f5fd3c9c78a26316152963e3c59b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PCX19jwbNZiXTcKN"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx"><strong class="bd jq">Figure 5:</strong> Online experiment Lift vs. Offline Experiment Lift</figcaption></figure><p id="bee6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们还将离线重放结果与平均精度(MAP)进行了比较，MAP先前用于选择图6中的在线实验的候选者。离线回放实验明显优于MAP。事实上，使用MAP，我们只能识别出25%的想法，这些想法最终会在在线实验中显示出统计上显著的积极提升。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lm"><img src="../Images/195a37d861220a0404b17177d57ea11a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cM7cml3ucCkylduH"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx"><strong class="bd jq">Figure 6: </strong>Online experiment lift vs. Predicted lift based on MAP (left) and Online experiment lift vs. Predicted lift based on Offline replay experiment (right)</figcaption></figure><p id="e349" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了了解离线重放实验如何帮助缩小我们想要测试的候选变量集，我们研究了离线重放实验与在线重放实验相比如何对变量进行排序。在验证数据中，有五个实验使用了一个以上的治疗方案。图7显示了一个示例实验的数据。我们分别计算了基于离线重放实验提升和在线实验提升的变量排序。使用来自在线实验的排序作为基础事实，我们发现离线重放实验可以识别样本中所有实验中提升最高的变体。它表明，我们可以从离线回放中获得有价值的早期见解，并且只挑选最佳想法在在线实验中进行验证。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ln"><img src="../Images/02098fa97e641291025d7ef1d69b4a50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8GeggSSX5virwHMao5pm_g.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx"><strong class="bd jq">Figure 7: </strong>Data of one example experiment</figcaption></figure><p id="aa65" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">离线回放实验是对我们想法评估工具箱的一个有价值的补充，并在许多方面补充了在线实验。结合线下和线上实验，我们可以在准确性和速度之间取得平衡，更快更有效地推动产品创新。</p><h1 id="a8f1" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">致谢</strong></h1><p id="990c" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">感谢陈必忠、、、江、的贡献。特别感谢艾丹·克鲁克、奥拉维尔·古德蒙德松、亚龙·格雷夫和刘铮的反馈和支持。</p><p id="9cac" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ll">要在Pinterest了解更多关于工程的知识，请查看我们的</em> <a class="ae lf" href="https://medium.com/pinterest-engineering" rel="noopener"> <em class="ll">工程博客</em> </a> <em class="ll">，并访问我们的</em><a class="ae lf" href="https://www.pinterestlabs.com/?utm_source=medium&amp;utm_medium=blog-article-link&amp;utm_campaign=qian-january-18-2022" rel="noopener ugc nofollow" target="_blank"><em class="ll">Pinterest Labs</em></a><em class="ll">网站。要查看和申请空缺职位，请访问我们的</em> <a class="ae lf" href="https://www.pinterestcareers.com/?utm_source=medium&amp;utm_medium=blog-article-link&amp;utm_campaign=qian-january-18-2022" rel="noopener ugc nofollow" target="_blank"> <em class="ll">职业</em> </a> <em class="ll">页面。</em></p></div></div>    
</body>
</html>