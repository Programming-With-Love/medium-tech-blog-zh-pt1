<html>
<head>
<title>Auditing Airflow Job Runs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">审核气流作业运行</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/auditing-airflow-batch-jobs-73b45100045?source=collection_archive---------1-----------------------#2018-12-27">https://medium.com/walmartglobaltech/auditing-airflow-batch-jobs-73b45100045?source=collection_archive---------1-----------------------#2018-12-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><blockquote class="ie if ig"><p id="252c" class="ih ii ij ik b il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf ha bi translated">动机</p><p id="36a3" class="ih ii ij ik b il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf ha bi translated">我们建立了一个系统来预测沃尔玛商店的需求，该系统由数据工程和ML管道组成。确保管道中的批处理作业按照计划运行对业务至关重要。作业运行的延迟或错过一次运行会产生数百万美元的影响。这篇博客文章解释了我们在调度器检测作业运行缺失和延迟的能力之外所做的事情。</p><p id="a6c4" class="ih ii ij ik b il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf ha bi translated">先决条件</p><p id="2de9" class="ih ii ij ik b il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf ha bi translated">我们使用Apache Airflow(开源)来编写和调度数据管道。这篇博文要求对Apache气流和数据管道有一个基本的概念。重点不在于Airflow的特性，而在于我们如何在它的基础上构建审计系统。</p></blockquote><figure class="jh ji jj jk fd jl er es paragraph-image"><div role="button" tabindex="0" class="jm jn di jo bf jp"><div class="er es jg"><img src="../Images/7ad7cf77269e83069c9358b384578d5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-9jXe-Lto8l2bDADWejrow.png"/></div></div><figcaption class="js jt et er es ju jv bd b be z dx">Airflow UI (courtesy — airflow.apache.org)</figcaption></figure><p id="e855" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jw iu iv iw jx iy iz ja jy jc jd je jf ha bi translated">我们已经考虑了气流的以下方面，以确保调度程序24/7可用并且作业被触发-</p><ol class=""><li id="55c9" class="jz ka hh ik b il im ip iq jw kb jx kc jy kd jf ke kf kg kh bi translated">气流红外线监控(调度程序守护程序、芹菜工人、RabbitMQ、Metastore)</li><li id="7795" class="jz ka hh ik b il ki ip kj jw kk jx kl jy km jf ke kf kg kh bi translated">气流HA(将在单独的博客文章中详细介绍)</li><li id="f8ae" class="jz ka hh ik b il ki ip kj jw kk jx kl jy km jf ke kf kg kh bi translated">气流SLA功能</li></ol><figure class="jh ji jj jk fd jl er es paragraph-image"><div class="er es kn"><img src="../Images/f351acbe03d68aab44620e34849337d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1378/format:webp/1*npF266471vfSvmp6nWgU8w.png"/></div><figcaption class="js jt et er es ju jv bd b be z dx">Airflow Architecture(courtesy — clairvoyantsoft.com)</figcaption></figure><p id="a0bf" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jw iu iv iw jx iy iz ja jy jc jd je jf ha bi translated">我们遇到过这样的情况，AF没有触发我们的ETL任务(在我们的例子中是spark任务),但是它的Web UI错误地显示相应的任务处于“运行”状态。除非随叫随到的工程师手动验证，否则没有办法知道这一点——Airflow的SLA特性在这里没有帮助，因为air flow本身的行为是错误的。这可能是由于Infra(不太可能)的气流配置不良或气流的运动部件不稳定或气流本身有缺陷。<strong class="ik hi"> <em class="ij">不管根本原因是什么，我们都必须知道工作何时被延迟，以便待命工程师立即采取手动纠正措施</em> </strong>。我们实现了一个独立于AF运行的审计器，当管道中的任何Spark作业没有按时开始时，它会发出警报。</p><h1 id="19d5" class="ko kp hh bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">审计方法</h1><p id="36f2" class="pw-post-body-paragraph ih ii hh ik b il lm in io ip ln ir is jw lo iv iw jx lp iz ja jy lq jd je jf ha bi lr translated"><span class="l ls lt lu bm lv lw lx ly lz di"> E </span>使用来自Airflow后端的运行历史估计ETL任务的开始时间。每个Spark批处理作业(我们的ETL执行单元，又名Airflow任务)都用惟一的id将自己注册到一个数据库表中。这向审计系统表明该作业需要被审计。该作业还会在运行时发送其心跳。如果没有按照估计按时收到任务心跳，则发出警报。我们假设气流历史是正常的，即大多数以前的运行是按照通常的时间表进行的。有人可能想知道，当您可以直接使用DAG的调度信息时，为什么要从历史中进行估计，但这是不够的，因为schedule将整个DAG作为一个单元给出了预期的开始时间，而不是其中各个任务的开始时间。</p><h1 id="d38c" class="ko kp hh bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">积极着手进行</h1><p id="fbf8" class="pw-post-body-paragraph ih ii hh ik b il lm in io ip ln ir is jw lo iv iw jx lp iz ja jy lq jd je jf ha bi translated">我们用两张桌子</p><ol class=""><li id="2a4a" class="jz ka hh ik b il im ip iq jw kb jx kc jy kd jf ke kf kg kh bi translated">task_instance —由气流维护</li><li id="3edf" class="jz ka hh ik b il ki ip kj jw kk jx kl jy km jf ke kf kg kh bi translated">audit_registration —由每次运行的每个spark作业更新。</li></ol><pre class="jh ji jj jk fd ma mb mc md aw me bi"><span id="4f65" class="mf kp hh mb b fi mg mh l mi mj">audit_registration: task_id, is_registered, last_updated</span><span id="7a1b" class="mf kp hh mb b fi mk mh l mi mj">task_instance: task_id, start_date, dag_id and so on.</span></pre><h2 id="c601" class="mf kp hh bd kq ml mm mn ku mo mp mq ky jw mr ms lc jx mt mu lg jy mv mw lk mx bi translated">审计员组件</h2><p id="e88a" class="pw-post-body-paragraph ih ii hh ik b il lm in io ip ln ir is jw lo iv iw jx lp iz ja jy lq jd je jf ha bi translated">Auditor是作为一个独立的java程序实现的，它有以下组件</p><ol class=""><li id="aac4" class="jz ka hh ik b il im ip iq jw kb jx kc jy kd jf ke kf kg kh bi translated">审计守护线程:它始终保持活动状态，主要是每X(可配置)小时触发另一个线程运行2 &amp; 3次。</li><li id="7bd7" class="jz ka hh ik b il ki ip kj jw kk jx kl jy km jf ke kf kg kh bi translated">Interval Estimator:它查看task_instance，并为每个<em class="ij"> concat(dag_id，task_id)，</em>计算间隔估计值，这是连续start_times之间间隔的数学模型。如果重复至少两个间隔仍不能达到众数，则使用中位数。</li><li id="40c9" class="jz ka hh ik b il ki ip kj jw kk jx kl jy km jf ke kf kg kh bi translated">当前运行检查器:对于audit_registration中的每个task_id，如果last_update不在当前时间和当前时间减去估计时间间隔之间，它将发送预警。</li></ol><p id="fe9e" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jw iu iv iw jx iy iz ja jy jc jd je jf ha bi translated">Auditor以快速失败模式运行，即auditor的java进程一旦发现错误就会失败，例如，它无法在X小时内完成线程执行(步骤2和3)，它无法到达Airflow后端，警报服务无法到达。这将通过我们的流程监控向Ops发出警报。</p><h2 id="b4fe" class="mf kp hh bd kq ml mm mn ku mo mp mq ky jw mr ms lc jx mt mu lg jy mv mw lk mx bi translated">更精细的细节和进一步的改进</h2><ol class=""><li id="2d27" class="jz ka hh ik b il lm ip ln jw my jx mz jy na jf ke kf kg kh bi translated">间隔四舍五入到最接近的半小时。</li><li id="5636" class="jz ka hh ik b il ki ip kj jw kk jx kl jy km jf ke kf kg kh bi translated">关于同一作业延迟的警报被限制为每天1个。</li><li id="5d7a" class="jz ka hh ik b il ki ip kj jw kk jx kl jy km jf ke kf kg kh bi translated">这可以进一步细化，以考虑诸如季节性(例如，由于繁忙的源系统，星期一的每日数据提取需要更长时间)和异常值(例如，偶尔的缓慢提取)等模式。不在一周的某一天运行的作业会导致错误警报，可以改进算法以从历史中学习相同的内容。</li><li id="c48a" class="jz ka hh ik b il ki ip kj jw kk jx kl jy km jf ke kf kg kh bi translated">Spark作业还可以根据完全限定的dag_id+task_id注册heartbeat，而不仅仅是task_id，并在运行时与Airflow合作来获取dag_id。这是因为给定的spark作业可以在多个Dag中重用。</li><li id="d335" class="jz ka hh ik b il ki ip kj jw kk jx kl jy km jf ke kf kg kh bi translated">新工作没有足够的历史来估计开始时间。我们只是发送一个警告通知不充分的历史。</li><li id="ea98" class="jz ka hh ik b il ki ip kj jw kk jx kl jy km jf ke kf kg kh bi translated">由于陈旧的历史记录，重新计划的Dag在接下来的N次运行中将会出现误报/漏报。留出足够的时间积累正确的历史。</li></ol><p id="7a7a" class="pw-post-body-paragraph ih ii hh ik b il im in io ip iq ir is jw iu iv iw jx iy iz ja jy jc jd je jf ha bi translated">这使我们多次避免错过SLA，并且对我们今天的ETL管道至关重要。这反过来允许我们安全地依赖相对较新但功能丰富的Apache气流，因为它会继续成熟。通过适应后端数据模型，这也可以用于任何其他调度程序。</p></div></div>    
</body>
</html>