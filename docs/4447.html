<html>
<head>
<title>Hidden gems of BigQuery — Part 2 — Change tracking</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery的隐藏瑰宝——第2部分——变更跟踪</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/hidden-gems-of-bigquery-part-2-change-tracking-263a6fd26b6d?source=collection_archive---------2-----------------------#2022-11-14">https://medium.com/google-developer-experts/hidden-gems-of-bigquery-part-2-change-tracking-263a6fd26b6d?source=collection_archive---------2-----------------------#2022-11-14</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="9360" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">前段时间，我在<a class="ae jc" href="https://cloud.google.com/blog/topics/developers-practitioners/hidden-gems-google-bigquery" rel="noopener ugc nofollow" target="_blank">谷歌云博客</a>上发布了“BigQuery的隐藏宝石”。自从这篇文章发表以来，发生了一些变化，尤其是在变更跟踪方面。所以，是时候更新了…</p><p id="fa00" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们开始之前，这里有一个关于<a class="ae jc" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/transactions" rel="noopener ugc nofollow" target="_blank">多语句事务</a>和<a class="ae jc" href="https://cloud.google.com/bigquery/docs/search-index" rel="noopener ugc nofollow" target="_blank">搜索索引</a>的快速更新——这两个特性现已正式发布，并准备在生产环境中使用！</p><p id="e19e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在到了主要部分…</p><p id="923d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我的第一篇文章中，我讨论了检测哪些数据已经被处理以及之后添加了哪些数据的方法。处理它的一种方法是使用我最喜欢的“隐藏宝石”——自动<a class="ae jc" href="https://issuetracker.google.com/issues/72080883" rel="noopener ugc nofollow" target="_blank"/>:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/b5d524ebb2cb79e3f2b9b5fa213fc077.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LczTpE2kEqf69odGp-aUyA.png"/></div></div></figure><p id="05a2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，AUTO的一个主要限制是它仅受流式API支持，并且流式API现在被标记为遗留API(并且应该使用<a class="ae jc" href="https://cloud.google.com/bigquery/docs/write-api" rel="noopener ugc nofollow" target="_blank">存储写API </a>)。我咨询了BigQuery团队，他们确认了AUTO不被Storage Write API支持。</p><p id="1668" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，现在有两种新的甚至更好的方法来做到这一点！</p><h1 id="a517" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">默认值</h1><p id="f3eb" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">有一个名为<a class="ae jc" href="https://cloud.google.com/bigquery/docs/default-values" rel="noopener ugc nofollow" target="_blank"> DEFAULT </a> values的新特性(目前仍在预览中),它的工作方式与您预期的完全一样——您可以为一个列设置默认值(当定义一个表或稍后使用ALTER语句时),当添加(或更新)一条新记录时，如果没有提供该列的值，它将用指定的默认值填充。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/f4e316b59d0933b72125158c7703e4ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E4TpyUk5LhYOyeq6cyifYQ.png"/></div></div></figure><p id="bf76" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">默认特性支持文字和一组函数，包括非常重要的更改跟踪函数，如CURRENT_DATETIME和CURRENT_TIMESTAMP(完整列表可在此处找到<a class="ae jc" href="https://cloud.google.com/bigquery/docs/default-values#default_value_expression" rel="noopener ugc nofollow" target="_blank"/>)。</p><p id="8877" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这意味着该特性可以替代AUTO来检测何时向BigQuery表中添加新数据(但与AUTO相反，所有向BigQuery中插入数据的方式都支持默认值)。</p><p id="b395" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果未提供列数据或提供了值“default ”,则列数据将填充默认值。“DEFAULT”甚至可以用在UPDATE语句中。</p><p id="5652" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个特性有一些限制，但没有一个真正限制了它的可用性(其中一些可能会在特性正式发布时被删除)。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/a2b966b2939c39433f53b27abb037261.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jxtnln7lADF4jEoEWsYkWw.png"/></div></div></figure><p id="b005" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ks">关于缺省值还有更多，但是在这里重复这个特性的全部文档是没有意义的，可以在</em> <a class="ae jc" href="https://cloud.google.com/bigquery/docs/default-values" rel="noopener ugc nofollow" target="_blank"> <em class="ks">这里</em> </a> <em class="ks">找到。</em></p><h1 id="0f7d" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">改变历史</h1><p id="fa16" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">另一个惊人的新功能(目前仍在预览中)是<a class="ae jc" href="https://cloud.google.com/bigquery/docs/change-history" rel="noopener ugc nofollow" target="_blank">更改历史</a>。</p><p id="91bb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">没有比官方文件更好的描述了:</p><p id="fc02" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ks"> BigQuery更改历史允许您跟踪BigQuery表的更改历史。表的更改历史作为SQL </em> <a class="ae jc" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/table-functions" rel="noopener ugc nofollow" target="_blank"> <em class="ks">表值函数(TVF) </em> </a> <em class="ks">公开，向您显示在指定时间范围内所做的特定类型的更改。此功能允许您处理对表所做的增量更改。</em></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/d7439cd26300cfcd0dd6225d176a4e5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r8gPOz1gSL1tZjNtK9OGSg.png"/></div></div></figure><p id="f925" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">APPENDS函数返回包含原始表中所有列的表，外加两个附加列— _CHANGE_TIMESTAMP(可用于跟踪数据的添加时间)和_CHANGE_TYPE(现在有点没用了，因为它只能有一个值— INSERT)。</p><p id="a4c7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">与默认特性相反，更改历史有一个明显的限制—目前，它仅适用于追加数据(不适用于修改数据)。但是目前只支持一个值插入的_CHANGE_TYPE列的存在表明这种限制是暂时的，功能将在以后扩展。</p><p id="30d3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">另一个限制——它在一个时间旅行窗口内工作(默认情况下是7天),并且还有另一个<a class="ae jc" href="https://cloud.google.com/bigquery/docs/time-travel#configure_the_time_travel_window" rel="noopener ugc nofollow" target="_blank">预览功能</a>允许您更改它。</p><p id="b340" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ks">还有更多关于变更历史的内容，但是在这里重复这个特性的全部文档是没有意义的，可以在</em> <a class="ae jc" href="https://cloud.google.com/bigquery/docs/change-history" rel="noopener ugc nofollow" target="_blank"> <em class="ks">这里</em> </a> <em class="ks">找到。</em></p><h1 id="5e69" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">实验</h1><p id="1d2c" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">我很想知道以下问题的答案:</p><ul class=""><li id="7e48" class="kt ku hh ig b ih ii il im ip kv it kw ix kx jb ky kz la lb bi translated">如果一个表有两列，并且它们都有设置为CURRENT_TIMESTAMP()的默认值，那么这两列中的值会不会相同？</li><li id="5d76" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb ky kz la lb bi translated">默认设置为CURRENT_TIMESTAMP()的列的值是否等于APPENDS函数中的_CHANGE_TIMESTAMP值？</li></ul><p id="f311" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们做一个简单的测试:</p><pre class="je jf jg jh fd lh li lj bn lk ll bi"><span id="dcd7" class="lm jq hh li b be ln lo l lp lq">CREATE TABLE dataset.NewTable<br/>(<br/>  InsertTimestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),<br/>  InsertTimestamp2 TIMESTAMP DEFAULT CURRENT_TIMESTAMP(),<br/>);<br/><br/>INSERT INTO dataset.NewTable (InsertTimestamp, InsertTimestamp2) <br/>VALUES (DEFAULT, DEFAULT); <br/><br/>SELECT<br/>_CHANGE_TYPE AS change_type,<br/>_CHANGE_TIMESTAMP AS change_time,  <br/>* FROM <br/>APPENDS(TABLE dataset.NewTable, NULL, NULL);</span></pre><p id="65eb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个简单的实验表明:</p><ul class=""><li id="9ad6" class="kt ku hh ig b ih ii il im ip kv it kw ix kx jb ky kz la lb bi translated">如果一个表有两列，并且这两列的默认值都设置为CURRENT_TIMESTAMP() — <strong class="ig hi">值将是相同的</strong>。</li><li id="c5f2" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb ky kz la lb bi translated">默认设置为CURRENT_TIMESTAMP()创建的值比_CHANGE_TIMESTAMP返回的值<strong class="ig hi">小</strong>(差异可能很大——在我的测试中，大约是1.5秒)。</li></ul><h1 id="0164" class="jp jq hh bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">摘要</h1><p id="ee0a" class="pw-post-body-paragraph ie if hh ig b ih kn ij ik il ko in io ip kp ir is it kq iv iw ix kr iz ja jb ha bi translated">BigQuery太神奇了！感谢团队的努力，感谢谷歌员工，在我第一次发帖后，他们给我指出了那些新功能！</p><p id="f70c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">关于提到的功能的文档链接:</p><ul class=""><li id="2344" class="kt ku hh ig b ih ii il im ip kv it kw ix kx jb ky kz la lb bi translated"><a class="ae jc" href="https://issuetracker.google.com/issues/72080883" rel="noopener ugc nofollow" target="_blank">汽车</a></li><li id="7324" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb ky kz la lb bi translated"><a class="ae jc" href="https://cloud.google.com/bigquery/docs/default-values" rel="noopener ugc nofollow" target="_blank">默认</a>值</li><li id="1da1" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb ky kz la lb bi translated"><a class="ae jc" href="https://cloud.google.com/bigquery/docs/change-history" rel="noopener ugc nofollow" target="_blank">改变历史</a></li><li id="b143" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb ky kz la lb bi translated"><a class="ae jc" href="https://cloud.google.com/bigquery/docs/time-travel#configure_the_time_travel_window" rel="noopener ugc nofollow" target="_blank">改变时间旅行窗</a></li></ul></div></div>    
</body>
</html>