<html>
<head>
<title>Using Kafka Streams API for predictive budgeting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kafka Streams API进行预测预算</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/using-kafka-streams-api-for-predictive-budgeting-9f58d206c996?source=collection_archive---------1-----------------------#2017-10-06">https://medium.com/pinterest-engineering/using-kafka-streams-api-for-predictive-budgeting-9f58d206c996?source=collection_archive---------1-----------------------#2017-10-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="1e74" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">陈博阳| Pinterest工程师，Ads基础设施</p><p id="2aaa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Pinterest，我们使用Kafka Streams API在几秒钟内为数千个广告服务器提供机上消费数据。我们的广告工程团队努力确保我们为广告合作伙伴提供最佳体验。作为其中的一部分，我们必须建立系统来防止广告过度投放。在本帖中，我们将解释超额交付，并分享我们如何使用<a class="ae jc" href="https://kafka.apache.org/documentation/streams" rel="noopener ugc nofollow" target="_blank"> Kafka Streams </a>构建预测系统，以减少我们的广告系统中的超额交付，并提供关于机上消费的近即时信息。</p><h1 id="110f" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">超额交货</h1><p id="15bd" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">当免费广告展示给超出预算的广告客户时，就会出现超额投放。这减少了有可用预算的广告商让他们的产品和服务被潜在客户发现的机会。</p><p id="6d91" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">过量交货是一个难以解决问题，原因有二:</p><ol class=""><li id="2e92" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">实时花费数据:关于广告投放的信息需要在几秒钟内反馈到系统中，以便关闭超出预算的活动。</li><li id="017f" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">预测性支出:快速的历史支出数据是不够的。该系统需要能够预测未来可能发生的支出，并减缓接近达到预算的活动。这是因为插入的广告仍然可以被用户使用。这使得花费信息很难在短时间内准确测量。这样的自然延迟是不可避免的，我们唯一能确定的就是广告插入事件。</li></ol><p id="8bd3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里有一个如何工作的例子。想象一下，广告客户X以每天100美元的总预算向一家基于互联网的公司支付每<strong class="ig hi">印象0.10美元。这最多产生1000个每日印象。</strong></p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/e16c850a79a880ac88b39dbec7815b9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0HJKIQhNKCwrzkxOQKs_bQ.png"/></div></div></figure><p id="5b3c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该公司很快为广告商实施了一个简单的系统:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lg"><img src="../Images/dd4ec76127130ed5fca07e9132b447ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*06LzkZ5KU_0RwNK_."/></div></div></figure><p id="f239" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当一个新的广告位(即展示广告的机会)出现在公司网站上时，前端向广告库存发送广告请求。广告清单然后基于广告客户X的剩余预算来决定是否显示他们的广告。如果预算仍然可用，广告库存将向前端插入广告(即嵌入用户应用程序的广告条目)。在用户查看广告之后，印象事件被发送到消费系统。</p><p id="6cbb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，当该公司检查他们的收入时，这并没有发生。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/8893656c6f450a7aee121b5f6fea7a74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e0NLz49lNQiJ9YNJVFG1MA.png"/></div></div></figure><p id="dc5d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在一天之内，广告商X的广告被显示了1100次，每次显示0.09美元。额外的100次展示是免费的，可以被其他广告商使用。这个例子说明了过度交付的常见行业挑战。</p><p id="a969" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">那么过度交付是如何发生的呢？在这个例子中，假设支出系统反应太慢。事实上，假设在它解释一个用户印象之前有五分钟的延迟。所以这个例子中的互联网公司做了一些优化改进系统，结果多了9美元！这是因为该公司为其他预算盈余的广告商展示了90次展示，而超额投放率仅为10/1000 = 1%。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lh"><img src="../Images/660e0f3e9b42776b18c7b93483154a2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MAyWuDcxw0EoMcNaRsxbyw.png"/></div></div></figure><p id="bb20" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">后来，另一个广告客户Y联系了同一家互联网公司，希望每天花费100美元，以每次<strong class="ig hi">点击</strong>(即用户点击广告链接并到达广告客户Y的网站)2.0美元的价格展示他们的广告，每天最多50次点击。互联网公司将广告客户Y添加到流量中，并将他们的点击事件跟踪添加到系统中。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es li"><img src="../Images/0fd573147d8cd3f89beb3729de6082f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SVk1OGwIGgoomxKb."/></div></div></figure><p id="a140" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一天结束时，这家互联网公司的系统又一次超额交付了。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lj"><img src="../Images/9f64fe378c7f41157fa1c4c8867fb4a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nbc19oEcaoNVqVEHKDVnsw.png"/></div></div></figure><p id="376b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">广告商Y最终获得了10次免费点击！互联网公司需要找出为什么系统不能预见插入的广告是否会被点击，无论系统有多快。如果没有未来支出的信息，他们总是会超额交货。</p><p id="7580" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了完成这个例子，该公司最终找到了一个绝妙的解决方案:计算每个广告客户的<strong class="ig hi">飞行花费</strong>。飞行花费是尚未收费的广告插入费用。<strong class="ig hi">如果实际花费+飞行中花费&gt;每日预算，则不显示该广告商的广告。</strong></p><h1 id="041a" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">建立预测系统</h1><h2 id="84ff" class="lk je hh bd jf ll lm ln jj lo lp lq jn ip lr ls jr it lt lu jv ix lv lw jz lx bi translated">动机</h2><p id="b88d" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">每天，我们都帮助Pinners在我们的应用中发现个性化的想法，从推荐到搜索到推广的pin。我们需要一种可靠且可扩展的方式来为Pinners提供广告，并确保我们尊重广告合作伙伴的预算。</p><h2 id="89f3" class="lk je hh bd jf ll lm ln jj lo lp lq jn ip lr ls jr it lt lu jv ix lv lw jz lx bi translated">要求</h2><p id="940a" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们开始设计一个开支预测系统，目标如下:</p><ul class=""><li id="d15d" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb ly km kn ko bi translated">能够为不同的广告类型工作(例如，印象，点击)。</li><li id="42c4" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb ly km kn ko bi translated">必须能够每秒处理数万个事件。</li><li id="1f60" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb ly km kn ko bi translated">能够将更新分散到1，000多台消费类计算机。</li><li id="7d96" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb ly km kn ko bi translated">端到端延迟应小于10秒；</li><li id="4791" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb ly km kn ko bi translated">确保100%正常运行时间。</li><li id="4895" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb ly km kn ko bi translated">重量轻，易于工程师维护。</li></ul><h2 id="4d09" class="lk je hh bd jf ll lm ln jj lo lp lq jn ip lr ls jr it lt lu jv ix lv lw jz lx bi translated">卡夫卡为什么流</h2><p id="03fe" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们评估了各种流媒体服务，包括<a class="ae jc" href="https://spark.apache.org/streaming/" rel="noopener ugc nofollow" target="_blank"> Spark </a>和<a class="ae jc" href="https://flink.apache.org/" rel="noopener ugc nofollow" target="_blank"> Flink </a>。这些技术符合我们的规模要求，但在我们的案例中，Kafka Streams提供了额外的优势:</p><ul class=""><li id="70a8" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb ly km kn ko bi translated">毫秒级延迟:Kafka streams有毫秒级延迟保证，打败了Spark和Flink。</li><li id="ad4f" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb ly km kn ko bi translated">轻量级:Kafka Streams是一个Java应用程序，没有像专用集群那样的严重外部依赖性，从而最大限度地降低了维护成本。</li></ul><h1 id="7a83" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">具体的计划</h1><p id="cdad" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">从较高层面来看，下图展示了我们的机上消费系统:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lz"><img src="../Images/617ae2022680e991fb97019a7412249f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ILEHZap3CuXcCbCU."/></div></div></figure><p id="9790" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">-广告服务:向用户分发广告，记录广告插入，并从“机上消费”服务中获得预测消费。</p><p id="0f1a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">花费系统:聚集广告事件并使广告服务系统了解每个广告客户的当前花费。</p><p id="6cd5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">-机上消费:</p><ul class=""><li id="3c9a" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb ly km kn ko bi translated">广告插入输入:每次新的插入发生时，广告服务系统与输入主题通信。该消息看起来像是:</li></ul><p id="ff3a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">{key: adgroupId，value: inflight_spend}，其中</p><ul class=""><li id="047f" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb ly km kn ko bi translated">adgroupId =在相同预算约束下的广告组的Id。</li><li id="82e1" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb ly km kn ko bi translated">飞行中花费=价格*印象率*行动率</li></ul><p id="af5b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">-支出聚合器:Tails输入主题，并使用Kafka流基于广告组聚合支出。我们为每个广告组维护了一个10秒钟的<a class="ae jc" href="http://docs.confluent.io/current/streams/developer-guide.html#windowing" rel="noopener ugc nofollow" target="_blank">窗口存储</a>。输出主题将由广告服务系统消费。当收到新的预测花费时，ads服务器将更新飞行中的花费。</p><p id="dd5f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ma">*价格:这个广告的价值。</em></p><p id="803a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ma"> *Impression_rate:一次插入到印象的历史转化率。请注意，插入并不保证转换为印象。</em></p><p id="abf6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ma"> *Action_rate:对于按点击付费的广告客户，这是用户点击该广告插入的概率；对于按印象付费的广告客户，这是1。</em></p><h1 id="0986" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">预测支出</h1><p id="9328" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">实际上，我们的支出预测非常准确。应用预测预算系统后，我们显著减少了超额交付。下面是实际支出与预测支出的测试示例。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mb"><img src="../Images/178e9ad845dfa40a998ed8622e37b2cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S1iNuzCo6RjnJlpq."/></div></div></figure><p id="93b7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ma">例:</em>横轴是三个3分钟宽的时间间隔；纵轴是按时间间隔的实际花费。蓝线代表飞行中的花费，绿线代表实际花费。</p><h1 id="ced4" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">主要学习内容</h1><ol class=""><li id="11de" class="kg kh hh ig b ih kb il kc ip mc it md ix me jb kl km kn ko bi translated">糟糕的窗口存储设计会严重影响性能。通过使用<a class="ae jc" href="https://docs.confluent.io/current/streams/developer-guide.html#tumbling-time-windows" rel="noopener ugc nofollow" target="_blank">滚动窗口</a>而不是<a class="ae jc" href="https://docs.confluent.io/current/streams/developer-guide.html#windowing-hopping" rel="noopener ugc nofollow" target="_blank">跳跃窗口</a>，我们看到了18倍的性能提升。我们最初的实现使用跳跃窗口来计算前三分钟的预期花费。例如，时间范围可以是三分钟长，间隔10秒钟。在这种情况下，将有180秒/ 10秒= 18个打开的窗口。Kafka Streams处理的每个事件可能会更新所有18个窗口，从而导致冗余计算。为了解决这个问题，我们从跳跃窗口切换到翻滚窗口。与跳跃窗口不同，滚动窗口不会彼此重叠，这意味着每个事件一次只会更新一个窗口。通过将更新次数从18次减少到1次，切换到滚动窗口使总吞吐量增加了18倍。</li><li id="8972" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">消息压缩策略。为了最小化对消费者的高扇出效应，我们对广告组id使用了<a class="ae jc" href="https://en.wikipedia.org/wiki/Delta_encoding" rel="noopener ugc nofollow" target="_blank">增量编码</a>，对消费数据使用了<a class="ae jc" href="https://en.wikipedia.org/wiki/Lookup_table" rel="noopener ugc nofollow" target="_blank">查找表编码</a>。这种压缩策略将邮件大小减少了4倍。</li></ol><h1 id="53b7" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="370b" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">使用Apache Kafka Streams的API来构建预测性支出管道是我们ads基础设施的一项新举措，事实证明它快速、稳定、容错且可扩展。我们计划继续探索<a class="ae jc" href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=71764913" rel="noopener ugc nofollow" target="_blank"> Kafka 1.0 </a>和<a class="ae jc" href="https://www.confluent.io/product/ksql/" rel="noopener ugc nofollow" target="_blank"> KSQL </a>带来的未来系统设计！</p></div><div class="ab cl mf mg go mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ha hb hc hd he"><p id="255d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">鸣谢:非常感谢来自Pinterest的Tim Tang、Liquan Pei、Zack Drach和Jerry Liu提供的整体设计、数据分析、性能调整和编码逻辑，以及来自Confluent的提供的Kafka Streams使用说明和故障排除。</p></div></div>    
</body>
</html>