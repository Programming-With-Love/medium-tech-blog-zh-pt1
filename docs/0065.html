<html>
<head>
<title>Messaging Sync — Scaling Mobile Messaging at Airbnb</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">信息同步——在Airbnb扩展移动信息</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/messaging-sync-scaling-mobile-messaging-at-airbnb-659142036f06?source=collection_archive---------0-----------------------#2017-04-30">https://medium.com/airbnb-engineering/messaging-sync-scaling-mobile-messaging-at-airbnb-659142036f06?source=collection_archive---------0-----------------------#2017-04-30</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="76a0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由<a class="jc jd ge" href="https://medium.com/u/8e2cd429e3bb?source=post_page-----659142036f06--------------------------------" rel="noopener" target="_blank">王志耀</a>、<a class="jc jd ge" href="https://medium.com/u/c011f676a10c?source=post_page-----659142036f06--------------------------------" rel="noopener" target="_blank">米歇尔·莱昂</a>、<a class="jc jd ge" href="https://medium.com/u/1f36b16d073e?source=post_page-----659142036f06--------------------------------" rel="noopener" target="_blank">杰森·古德曼</a>、<a class="jc jd ge" href="https://medium.com/u/ff1003fda70b?source=post_page-----659142036f06--------------------------------" rel="noopener" target="_blank">尼克·雷诺兹</a>、<a class="jc jd ge" href="https://medium.com/u/cbe8bf79ca00?source=post_page-----659142036f06--------------------------------" rel="noopener" target="_blank">朱丽亚·傅</a>、<a class="ae je" href="http://www.jeffhodnett.com/" rel="noopener ugc nofollow" target="_blank">杰夫·霍德内特</a>、<a class="jc jd ge" href="https://medium.com/u/fe785ba6ac78?source=post_page-----659142036f06--------------------------------" rel="noopener" target="_blank">曼努埃尔·德尚</a>、<a class="jc jd ge" href="https://medium.com/u/de6bbe853874?source=post_page-----659142036f06--------------------------------" rel="noopener" target="_blank">约翰·波特鲍姆</a>、查理·江</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/16e09ee2107923b86d7fbf95dc42e585.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*fZpQ95jk81Ae7tqpkXNIwA.gif"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx">Old Inbox vs New Inbox with slow network</figcaption></figure><p id="0753" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">每小时在手机上发送超过10万条消息，消息是Airbnb应用程序上最受关注的功能。然而，在移动设备上使用旧的收件箱获取方法，收件箱加载缓慢，数据不一致，并且需要网络连接来读取邮件。所有这些导致主人和客人使用移动收件箱的体验很差。为了让收件箱更快、更可靠、更一致，Airbnb的Hosts and Homes团队建立了Messaging Sync。</p><p id="d158" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">旧的收件箱获取的实现类似于世纪之交的网络邮件客户端，在每次用户点击时从网络获取满屏的信息。有了消息同步，新消息和线程更新只有在数据改变时才被提取，这大大减少了网络请求的数量。这意味着收件箱和消息线程屏幕之间的导航要快得多，大部分时间都在本地移动存储上，而不是在每次屏幕改变时发出网络请求。消息传递同步还减少了每次网络获取的响应大小，从而使API延迟提高了2倍。在网速较慢的地区，这些用户体验的提升会被放大。</p><p id="96dc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下是消息同步的工作原理，分为三种情况:</p><p id="9c02" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">场景1:完整增量更新</strong></p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jv"><img src="../Images/cac877443ee205e86b1672d7be71ee9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RqXfpzXiZ2nudOrEPA7Dvg.png"/></div></div></figure><p id="d926" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是最常见的情况:</p><ol class=""><li id="6a4c" class="jw jx hh ig b ih ii il im ip jy it jz ix ka jb kb kc kd ke bi translated">移动客户端使用本地存储的sequence_id(例如1490000000)调用同步API，sequence _ id表示客户端与服务器的最后一次同步。</li><li id="46db" class="jw jx hh ig b ih kf il kg ip kh it ki ix kj jb kb kc kd ke bi translated">API服务器仅返回该sequence_id之后的所有修改的线程对象和新消息，以及新的sequence_id(例如1491111111)。</li><li id="9be4" class="jw jx hh ig b ih kf il kg ip kh it ki ix kj jb kb kc kd ke bi translated">移动客户端将这些更新的线程和消息与其本地数据存储合并。</li><li id="d398" class="jw jx hh ig b ih kf il kg ip kh it ki ix kj jb kb kc kd ke bi translated">移动客户端还存储新的sequenced_id以供下次使用。</li></ol><p id="6471" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">场景2:初始同步</strong></p><p id="c3e1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是因为有太多的线程和/或消息更新需要返回。例如，当用户第一次下载应用程序时，服务器需要发送10个线程对象和30条消息来进行完整的增量同步。完整的增量同步响应负载将非常大，这将导致更长的加载时间和较差的用户体验。相反，我们只返回满屏的线程。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es kk"><img src="../Images/08f7190f4afd003f37d23ce3cc6cf98b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0NQo4EQtq4A6ZcD0I-FGCQ.png"/></div></div></figure><ol class=""><li id="e1a0" class="jw jx hh ig b ih ii il im ip jy it jz ix ka jb kb kc kd ke bi translated">移动客户端使用本地存储的sequence_id调用同步API</li><li id="4ddb" class="jw jx hh ig b ih kf il kg ip kh it ki ix kj jb kb kc kd ke bi translated">API服务器估计完整增量同步的响应大小，并认为它太大。</li><li id="f5a8" class="jw jx hh ig b ih kf il kg ip kh it ki ix kj jb kb kc kd ke bi translated">API服务器仅发送N个最近的线程对象，而不发送任何消息，以使客户端在收件箱视图中至少全屏呈现线程。</li><li id="9e3b" class="jw jx hh ig b ih kf il kg ip kh it ki ix kj jb kb kc kd ke bi translated">客户端清除其本地数据存储。</li><li id="5855" class="jw jx hh ig b ih kf il kg ip kh it ki ix kj jb kb kc kd ke bi translated">客户端存储最新的线程对象和sequence_id。</li><li id="3e2f" class="jw jx hh ig b ih kf il kg ip kh it ki ix kj jb kb kc kd ke bi translated">当用户打开一个线程时，客户端向服务器请求该线程中的所有消息。</li><li id="717d" class="jw jx hh ig b ih kf il kg ip kh it ki ix kj jb kb kc kd ke bi translated">当用户在收件箱中滚动历史记录时，客户端发送分页请求来获取线程。</li></ol><p id="bf7d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">场景3:线程移除</strong></p><p id="e988" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">线程有时需要从移动应用中移除。例如，当共同主机不再管理主机的列表时，服务器移除共同主机和访客之间的线程。在这种情况下，API发送上次同步后删除的线程id数组。</p><h1 id="d774" class="kl km hh bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">捕捉回归</h1><p id="ff74" class="pw-post-body-paragraph ie if hh ig b ih lj ij ik il lk in io ip ll ir is it lm iv iw ix ln iz ja jb ha bi translated">在迁移到新的消息传递同步API时，有几个注意事项:</p><ol class=""><li id="22dd" class="jw jx hh ig b ih ii il im ip jy it jz ix ka jb kb kc kd ke bi translated">Airbnb的消息系统与其核心预订流程和其他产品逻辑紧密结合。服务器需要监听影响收件箱屏幕上显示的数据的所有更改。例如，在一次旅行结束后，应用程序需要在线程中呈现一个“离开查看”按钮。对此有两种解决方案。一种是在读取时检查review对象，看它是否被修改过。另一种解决方案是订阅查看对象更改，并更新相应线程对象上次被修改的时间。我们选择了第二种解决方案，因为它在读取时间上要便宜得多。然而，挑战在于捕捉所有对象的相关变化，这些变化会影响UI上呈现的内容。</li><li id="46fe" class="jw jx hh ig b ih kf il kg ip kh it ki ix kj jb kb kc kd ke bi translated">更新的线程可能与本地存储的线程顺序不同。我们需要确保在合并数据后，UI被正确刷新。</li></ol><p id="fd73" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了捕捉旧的消息传递API和消息传递同步API返回的数据之间的任何差异，一小部分移动应用程序同时运行旧的和新的API进行抽查。它记录所有属性值和从两个API返回的线程顺序。这允许我们用新的API捕捉回归并快速迭代。每当捕获到bug时，服务器会将相应的线程对象标记为已修改，以便在下一次同步时纠正差异。</p><h1 id="c998" class="kl km hh bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">结论</h1><ol class=""><li id="42b6" class="jw jx hh ig b ih lj il lk ip lo it lp ix lq jb kb kc kd ke bi translated">消息同步API将API请求延迟降低了2倍。它还导致了比旧的消息传递API更稳定的请求持续时间(下面的蓝色尖线)。</li></ol><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es lr"><img src="../Images/704d29b5410200141fe839a27f514263.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SbTsdzUkh9miVCbZScBKCQ.png"/></div></div></figure><p id="8e25" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2.信息同步使用户可以在飞行模式和恶劣的网络条件下阅读信息。</p><p id="81b2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在推出消息同步和其他消息改进后，我们看到更多的消息是从移动设备发送的(Android和iOS分别增加3.8%和5.3%)，从网络发送的消息减少了(-4.6%和-4.2%)。收件箱的日访问量大幅上升(+200%和+96%)，因为它现在是托管模式的主屏幕。此次发布是我们的主机社区的一大胜利，因为消息是Airbnb上主机使用最多的功能。</p><p id="ee6b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ls">最后但并非最不重要的一点是，如果你有兴趣创建一个充满热情的东道主社区，在世界各地提供令人惊叹的款待，东道主和家园工程团队总是在寻找有才华的人加入</em><a class="ae je" href="https://www.airbnb.com/careers/departments/engineering" rel="noopener ugc nofollow" target="_blank"><em class="ls"/></a><em class="ls">！</em></p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es lt"><img src="../Images/738231d1fd899135737d54f584d7ecc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XMOMFask2IOSeOQznGLe7Q.png"/></div></div></figure></div></div>    
</body>
</html>