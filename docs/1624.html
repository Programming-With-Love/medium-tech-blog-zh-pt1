<html>
<head>
<title>A Serverless and Go Journey</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器的旅行</h1>
<blockquote>原文：<a href="https://medium.com/capital-one-tech/a-serverless-and-go-journey-credit-offers-api-74ef1f9fde7f?source=collection_archive---------0-----------------------#2018-11-21">https://medium.com/capital-one-tech/a-serverless-and-go-journey-credit-offers-api-74ef1f9fde7f?source=collection_archive---------0-----------------------#2018-11-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="8a9c" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">Capital One Credit提供的API的演变</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/f2700ec18aef1dd966b7a664ce862b5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dv0lR1DTXh-cqQ5p"/></div></div></figure><p id="f729" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">作为一家技术驱动的金融公司，我们在Capital One的最大目标之一是利用技术轻松、快速、直接地与客户互动。潜在Capital One客户与我们合作的一个重要方式是通过我们的附属渠道。像<a class="ae ke" href="https://developer.capitalone.com/case-studies/CreditOffersAPI-CreditSesame/" rel="noopener ugc nofollow" target="_blank"> Credit Sesame </a>、<a class="ae ke" href="https://developer.capitalone.com/case-studies/CreditOffersAPI-CreditCards/" rel="noopener ugc nofollow" target="_blank">CreditCards.com</a>和<a class="ae ke" href="https://developer.capitalone.com/case-studies/Bankrate-Case-Study/" rel="noopener ugc nofollow" target="_blank"> Bankrate </a>这样的附属合作伙伴与Capital One有着特殊的合作关系，他们在那里展示可用的信用卡选项，并引导潜在客户使用适合他们的信用卡。对于我们的附属合作伙伴，这是通过<a class="ae ke" href="https://developer.capitalone.com/products/credit-offers/homepage/" rel="noopener ugc nofollow" target="_blank">信用优惠API </a>完成的。我们认为这有助于人们做出更明智的信用卡选择。我们也喜欢认为这展示了我们对技术的尖端应用。</p><h1 id="2b28" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">什么是信贷优惠API？</h1><p id="b11f" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">它是如何工作的？Credit Offers API公开了Capital One信用卡优惠的完整列表，我们的附属合作伙伴可以向他们的客户显示这些信息，以及奖励信息和产品评论等详细信息。它有一个资格预审功能，可以个性化卡产品，为客户匹配合适的卡(不影响他们的信用评分！).它还有一个很好的预填功能，提供完整的预填申请，使申请Capital One信用卡成为一种流畅的体验。</p><p id="3617" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">2015年构建1.0版本时，Credit Offers是用Java构建的。API的当前版本3.0已经过重新构建，因此它是完全无服务器的，并且是用Go编写的。这是两项非常酷的技术，结合起来是展示我们信用卡产品的快速而有力的方式。</p><h1 id="af8b" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">为什么要去？</h1><p id="00ab" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">在2016年中期，我们在API中添加了一个额外的端点，该端点将确认已向客户显示了报价。Go在Capital One开始获得巨大的、令人印象深刻的发展势头，根据我的团队进行的概念验证，我们看到了相对于Java的巨大性能提升。这些结果很清楚，所以我们决定将其用于这个新的终点。</p><p id="9d95" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">当时，没有一个团队成员知道Go，但是不到一个月，每个人都在编写Go，我们也在构建端点。它的灵活性、易用性以及Go背后真正酷的概念(Go如何处理本机并发、垃圾收集，当然还有安全+速度。)帮助我们在构建过程中参与进来。还有，谁能打败那个可爱的吉祥物！</p><p id="30b6" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在Go中重写Credit Offers API的整个过程比预期的要简单得多。作为技术负责人，我是最后一个批准一段代码何时合并并准备发布的人。所以我不得不更深入地研究Go，不仅要理解代码，还要理解业务逻辑。更令人满意的一个惊喜是，将业务逻辑与Go这样的简单语言混合在一起意味着很容易进入这个角色，并且不会成为发布的瓶颈。</p><p id="03c9" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们想探索的下一项技术是无服务器技术。根据定义，Go既快又简单，这也是你定义lambda的方式。事实上，我们不想没有go就没有服务器。这就把我们带到了…</p><h1 id="7e00" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">为什么没有服务器？</h1><p id="ddc1" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">在另一轮分析中，我们意识到我们的用例非常适合无服务器方法。我去年参加了AWS re:Invent，主要关注无服务器会话，并对Credit Offers API如何与无服务器协同工作有了一些想法。2018年1月初<a class="ae ke" href="https://aws.amazon.com/blogs/compute/announcing-go-support-for-aws-lambda/" rel="noopener ugc nofollow" target="_blank">lambda对Go的支持一发布</a>，我们就开始进行迁移，开始分析工具，开始将代码封装在lambda中，并添加额外的警报，这样我们就可以完全不用服务器了。我们在今年10月初完成了这次迁移。</p><p id="0758" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们被无服务器吸引是因为它的四个主要支柱的结合:</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lc"><img src="../Images/792632583ff5e656e32f39b7cdc32e4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DnQNU52EGcnZnCpx"/></div></div></figure><p id="9676" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">由于代销商渠道和信用提供API的方式会影响我们的合作伙伴和潜在客户，因此能够在不中断服务的情况下无缝扩展我们的API非常重要。无服务器化不仅让我们摆脱了服务器，还让我们变得更快、更有弹性。最大的“胜利”之一是，我们的开发人员不需要停下来担心基础设施，可以将更多的时间用于创建和交付与业务相关的功能。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/1f7f4f0d1dd81af3bb3b661a66440614.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*V2lV3EsaoL48PDLa"/></div></div></figure><p id="122d" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在这张图片中，你可以看到建筑是多么简单。我们如何与<a class="ae ke" href="https://aws.amazon.com/cloudwatch/" rel="noopener ugc nofollow" target="_blank">亚马逊CloudWatch </a>集成来监控系统的健康状况。我们选择DynamoDB是因为它的转义能力和灵活的模式；对于长期储存，我们使用S3桶。我们还使用亚马逊的社交网络在出现问题时发出警报。你还可以看到我们如何整合外部监控系统— <a class="ae ke" href="https://newrelic.com/" rel="noopener ugc nofollow" target="_blank">新遗迹</a>。</p><p id="c0db" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">同样，lambda听起来很简单，但我们确实有一些复杂的过程，包括调用外部API，这是资格预审流程的一部分。Go goroutines和lambda是天作之合。</p><p id="0258" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们无服务器解决方案的另一个关键部分是我们如何进行部署。canary部署允许我们部署任何lambda更新(版本控制)的5%,设置特定的Canary部署警报，并且如果某些东西失败了，在没有任何干预的情况下自动回滚。在第一个5%发布成功后，我们计算出我们想要测试多长时间，并从那里开始增量发布lambda的新版本。金丝雀的部署对我们来说非常强大。正如我提到的，我们依赖于我们的分支机构，随着我们的规模和增长，我们的新版本不能下降。通过对金丝雀部署使用可靠的管道，他们不会。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/6167dd8784a8db613e06135df1545118.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RtcNUIdSf50sWCiY"/></div></div></figure><h1 id="bd9e" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">从我们的无服务器和移动之旅中吸取的经验教训</h1><p id="77b0" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">那么，我们从这场无服务器的旅行中学到了什么呢？</p><h2 id="9f9a" class="ld kg hh bd kh le lf lg kl lh li lj kp jr lk ll kr jv lm ln kt jz lo lp kv lq bi translated"><strong class="ak"> #1无服务器并不意味着你失去控制。</strong></h2><p id="218c" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">恰恰相反，你有更多的控制权。是的，扩展是无缝的，性能更好，但有限制，你必须检查它们。你不能只是抛出数十亿个请求，而没有意识到如果你计划不当，它可能会对你的服务造成破坏。为了弥补这一点，您可以扩展到不同的区域、不同的可用性区域，并计划扩展您的应用程序。</p><h2 id="bc44" class="ld kg hh bd kh le lf lg kl lh li lj kp jr lk ll kr jv lm ln kt jz lo lp kv lq bi translated"><strong class="ak"> #2测试是根本。</strong></h2><p id="5a3b" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">社区最关心的问题之一是如何测试lambda，因为lambda依赖于一个事件？嗯，我们实际上探索了SAM local——它是进行本地测试的无服务器应用程序模型。在开发人员的笔记本电脑上，他们可以模拟事件并全面测试lambda。</p><h2 id="5d42" class="ld kg hh bd kh le lf lg kl lh li lj kp jr lk ll kr jv lm ln kt jz lo lp kv lq bi translated"><strong class="ak"> #3关注您的数据和数据库。</strong></h2><p id="ac41" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">根据您的使用情况、您需要保留什么数据、您需要保留多长时间等等，无服务器数据库有几种选择。在我们的例子中，直接的选择是选择一个数据库，这个数据库为我们提供了这个API所需的灵活性和功能。</p><h2 id="6194" class="ld kg hh bd kh le lf lg kl lh li lj kp jr lk ll kr jv lm ln kt jz lo lp kv lq bi translated"><strong class="ak"> #4保持简单。</strong></h2><p id="1fdd" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">Lambdas不应该是一大段代码。正确确定你的功能——保持简单的是/否。</p><h2 id="0e19" class="ld kg hh bd kh le lf lg kl lh li lj kp jr lk ll kr jv lm ln kt jz lo lp kv lq bi translated"><strong class="ak"> #5启用分布式跟踪。</strong></h2><p id="69a3" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">我们用的是AWS X射线。对于AWS环境来说，这是一个很自然的选择，它可以让您全面了解系统的性能。不仅仅是lambdas，还有数据库、53号公路、网关等等。您可以通过X射线获得应用程序的每个接触点，包括其他微服务。</p><h2 id="3a42" class="ld kg hh bd kh le lf lg kl lh li lj kp jr lk ll kr jv lm ln kt jz lo lp kv lq bi translated"><strong class="ak"> #6在设计无服务器管道时，要考虑金丝雀部署。</strong></h2><p id="2ac1" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">经过良好测试的增量部署使我们的API更具弹性。通过使用canary部署，我们可以24x7全天候发布，不会对我们的分支机构造成服务中断。</p><h2 id="8194" class="ld kg hh bd kh le lf lg kl lh li lj kp jr lk ll kr jv lm ln kt jz lo lp kv lq bi translated"><strong class="ak"> #7微服务思维模式。</strong></h2><p id="30aa" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">在设计您的解决方案时，尽量使其简单，确定内外的依赖关系，并且不要离开白板，直到您可以在您的生态系统中创建一个平滑的耦合。最后，完全控制你的事件源。</p><h1 id="e829" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">结果</h1><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/1b8790d28dd14a99a55883298ed22518.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lunfmnPr3miB37zf"/></div></div></figure><p id="10c7" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们看到了无服务器在性能提升、成本节约和团队速度方面取得的巨大成果。从lambda收到请求到它回复的时间，70%的性能提升是相当可观的。更令人印象深刻的是我们在成本方面的巨大成就——通过消除EC2、ELB和RDS节省了90%。作为技术负责人，我们没有花时间修补、修复和维护服务器，团队速度提高了30%,现在我们可以花时间创新、创造和扩展业务需求。</p><p id="e0fa" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">既然API是100%无服务器的，我们就有了一个坚实的路线图来说明我们还想用这项技术做什么。我们希望整合<a class="ae ke" href="https://aws.amazon.com/codebuild/" rel="noopener ugc nofollow" target="_blank"> AWS CodeBuild </a>来为多个构建流程创建一个简单的管道，我们希望使用<a class="ae ke" href="https://aws.amazon.com/step-functions/" rel="noopener ugc nofollow" target="_blank"> AWS Step Functions </a>来添加更好的重试机制，我们希望将<a class="ae ke" href="https://www.elastic.co/elk-stack" rel="noopener ugc nofollow" target="_blank"> ELK </a>整合到我们的日志记录中，这样我们就可以为我们的解决方案添加一些业务仪表盘。但是我们将在另一篇文章中讨论这个问题。</p><h1 id="fcc3" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">相关:</h1><ul class=""><li id="706d" class="lr ls hh jk b jl kx jo ky jr lt jv lu jz lv kd lw lx ly lz bi translated"><a class="ae ke" rel="noopener" href="/capital-one-tech/the-intersection-of-fintech-and-credit-offers-1c1d935d1ef4">金融科技和信贷服务的交集</a></li><li id="2cf1" class="lr ls hh jk b jl ma jo mb jr mc jv md jz me kd lw lx ly lz bi translated"><a class="ae ke" rel="noopener" href="/capital-one-tech/credit-offers-api-open-source-wordpress-plugin-761665ca7f2">信用优惠WordPress插件</a></li><li id="dddd" class="lr ls hh jk b jl ma jo mb jr mc jv md jz me kd lw lx ly lz bi translated"><a class="ae ke" href="https://golang.org/doc/faq" rel="noopener ugc nofollow" target="_blank">Go编程语言常见问题解答</a></li><li id="2631" class="lr ls hh jk b jl ma jo mb jr mc jv md jz me kd lw lx ly lz bi translated"><a class="ae ke" href="https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html" rel="noopener ugc nofollow" target="_blank">使用Lambda函数时的最佳实践</a></li><li id="fdf4" class="lr ls hh jk b jl ma jo mb jr mc jv md jz me kd lw lx ly lz bi translated"><a class="ae ke" rel="noopener" href="/capital-one-tech/doing-well-by-doing-bad-writing-bad-code-with-go-part-1-2dbb96ce079a">通过做不好来做好:用Go第1部分写不好的代码</a></li></ul><figure class="ix iy iz ja fd jb er es paragraph-image"><a href="https://medium.com/capital-one-tech/api/home"><div class="er es mf"><img src="../Images/c6c5bb1f3967049ba012aebf5757e08d.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*x8RfN3y_bm7aDVs1vHMfkg.jpeg"/></div></a></figure><p id="34a7" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="mg">披露声明:这些观点仅代表作者个人观点。除非本帖中另有说明，否则Capital One不属于所提及的任何公司，也不被其认可。使用或展示的所有商标和其他知识产权都是其各自所有者的所有权。本文为2018首都一。</em></p></div></div>    
</body>
</html>