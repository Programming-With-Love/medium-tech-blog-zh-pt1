<html>
<head>
<title>Understanding Dagger 2 Multibindings + ViewModel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解Dagger 2多绑定+视图模型</h1>
<blockquote>原文：<a href="https://blog.kotlin-academy.com/understanding-dagger-2-multibindings-viewmodel-8418eb372848?source=collection_archive---------0-----------------------#2017-09-17">https://blog.kotlin-academy.com/understanding-dagger-2-multibindings-viewmodel-8418eb372848?source=collection_archive---------0-----------------------#2017-09-17</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/1647a4f8d813d4b2fbb3810eac9330ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YPd3RxTJClwmX01oyJmlNA.png"/></div></div></figure><div class=""/><div class=""><h2 id="ec5f" class="pw-subtitle-paragraph jv ix iy bd b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dk translated">还有:GithubViewModelFactory用Kotlin解释并改写。</h2></div><p id="4203" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">嗨，伙计们，<br/>今天我们将解释如何在新的<strong class="kp iz">架构组件</strong> ' <code class="fe lj lk ll lm b">ViewModel</code>类中使用精彩的Dagger 2 <strong class="kp iz">多绑定</strong>。</p></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><p id="5ef2" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">我们中的许多人，在开始学习如何使用新的<code class="fe lj lk ll lm b">ViewModel</code>类时，都看过GitHub上的<a class="ae lu" href="https://github.com/googlesamples/android-architecture-components/tree/master/GithubBrowserSample" rel="noopener ugc nofollow" target="_blank"><em class="lv">GithubBrowserSample</em></a>示例(这是一个GitHub-ception！).</p><p id="7e81" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">也许，我们在那堆有用的代码中寻找的第一个类，就是所谓的<code class="fe lj lk ll lm b">GithubViewModelFactory</code>类(<a class="ae lu" href="https://github.com/googlesamples/android-architecture-components/blob/e33782ba54ebe87f7e21e03542230695bc893818/GithubBrowserSample/app/src/main/java/com/android/example/github/viewmodel/GithubViewModelFactory.java" rel="noopener ugc nofollow" target="_blank">这里有一个指向存储库中文件的链接</a>)。<br/>这个职业是一个完美的例子，当<a class="ae lu" href="https://google.github.io/dagger/multibindings" rel="noopener ugc nofollow" target="_blank"> <strong class="kp iz">匕首2多刺</strong> </a>可以成为真正的救星。</p><p id="01a2" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">在深入研究代码之前，我应该做一个小前提。<br/>为了构建带有参数传递构造函数的定制<code class="fe lj lk ll lm b">ViewModel</code>类(例如传递定制数据或<code class="fe lj lk ll lm b">@Inject</code>注释构造函数)，我们必须提供一个扩展<code class="fe lj lk ll lm b">ViewModelProvider.Factory</code>的类，将定制<em class="lv">视图模型</em>的实例返回到<code class="fe lj lk ll lm b">create()</code>方法中。</p><p id="ac7f" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">所以，我们能注意到的第一件事是类的构造函数，它带着不太漂亮的<code class="fe lj lk ll lm b">Map&lt;Class&lt;? extends ViewModel&gt;, Provider&lt;ViewModel&gt;&gt;</code>参数。这是什么怪物？</p><p id="e578" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">让我们更仔细地阅读这个庞大的参数类型:它是一个映射，有一个扩展了<code class="fe lj lk ll lm b">ViewModel</code>的<code class="fe lj lk ll lm b">Class</code>作为键，还有一个<code class="fe lj lk ll lm b">ViewModel</code>的<code class="fe lj lk ll lm b">Provider</code>(一个Dagger 2特定的类，让我们提供——并实例化——一个依赖注入类)作为值。</p><p id="147b" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">好吧，好吧，但是我能用这个物体做什么呢？<br/>好了，我们刚刚说了我们的自定义<code class="fe lj lk ll lm b">ViewModelProvider.Factory</code>的<code class="fe lj lk ll lm b">create</code>方法期望ViewModel的一个实例作为返回值。该方法将从<code class="fe lj lk ll lm b">Activity</code>或<code class="fe lj lk ll lm b">Fragment</code>请求的视图模型的类型作为参数。将这种类型(我们的<code class="fe lj lk ll lm b">Class</code>对象)与创建相同类型的视图模型的对象配对，我们当然可以实例化该类并将其返回给系统。</p><p id="822d" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">能给我们确定型<code class="fe lj lk ll lm b">ViewModel</code>的那个“东西”是什么？答案就是匕首2注入我们的地图中的<code class="fe lj lk ll lm b">Provider</code>值。</p><h2 id="2374" class="lw lx iy bd ly lz ma dn mb mc md dp me kw mf mg mh la mi mj mk le ml mm mn mo bi translated">让我们来谈谈多重绑定</h2><figure class="mq mr ms mt gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi mp"><img src="../Images/f9677059540ca48c2ce3efd8eb6268bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LakgBLF9TqfG22SiciSyGQ.png"/></div></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk">The big, big title on the <a class="ae lu" href="https://google.github.io/dagger/multibindings" rel="noopener ugc nofollow" target="_blank">official Multibindings documentation</a></figcaption></figure><p id="23c6" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">Dagger 2可以将一个依赖项<code class="fe lj lk ll lm b">Provider</code>关联到一个给定的键，并将其注入到一个Map中。</p><p id="9c3a" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">这是通过在一个方法上使用<code class="fe lj lk ll lm b">@IntoMap</code>注释来实现的，该方法产生我们想要与给定键关联的值。<br/>另一方面，键是使用一个自定义注释来指定的，该注释本身用<code class="fe lj lk ll lm b">@MapKey</code>来注释。这里是用于创建一个Map的注释，它的键类型是一个<code class="fe lj lk ll lm b">Class&lt;? extends ViewModel&gt;</code>对象。</p><pre class="mq mr ms mt gt my lm mz na aw nb bi"><span id="3ce3" class="lw lx iy lm b gy nc nd l ne nf">@Retention(RetentionPolicy.<em class="lv">RUNTIME</em>)<br/>@MapKey<br/>@interface ViewModelKey {<br/>    Class&lt;? extends ViewModel&gt; value();<br/>}</span></pre><p id="ec47" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">我们的<em class="lv">值</em>参数类型将是我们的映射键的类型。</p><p id="8790" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">所以这个<code class="fe lj lk ll lm b">Module</code>方法:</p><pre class="mq mr ms mt gt my lm mz na aw nb bi"><span id="c755" class="lw lx iy lm b gy nc nd l ne nf">    @Binds<br/>    @IntoMap<br/>    @ViewModelKey(UserViewModel.class)<br/>    abstract ViewModel bindUserViewModel(UserViewModel userViewModel);</span></pre><p id="ee19" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">大致说:“将这个对象注入一个使用<code class="fe lj lk ll lm b">UserViewModel.class</code>作为键的<code class="fe lj lk ll lm b">Map</code> ( <code class="fe lj lk ll lm b">@IntoMap</code>注释)和一个将构建一个<code class="fe lj lk ll lm b">UserViewModel</code>对象的<code class="fe lj lk ll lm b">Provider</code>(<code class="fe lj lk ll lm b">@Binds</code>注释的参数)作为值”。<br/>这样，我们就可以向Dagger 2中注入一个托管对象，一个map类型的……猜到了:我们著名的<code class="fe lj lk ll lm b">Map&lt;Class&lt;? extends ViewModel&gt;, Provider&lt;ViewModel&gt;&gt;</code>。</p><p id="fc1a" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">现在我们知道，我们可以使用<code class="fe lj lk ll lm b">Class</code> <em class="lv"> </em>对象作为<code class="fe lj lk ll lm b">ViewModelProvider.Factory.create()</code>方法中的参数来检索该视图模型的提供者。这正是谷歌人用那种方法做的。让我们一段一段地检查代码。</p><p id="055b" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">给定视图模型的可能提供者从地图中获得:</p><pre class="mq mr ms mt gt my lm mz na aw nb bi"><span id="305a" class="lw lx iy lm b gy nc nd l ne nf">Provider&lt;? extends ViewModel&gt; creator = creators.get(modelClass);</span></pre><p id="d7ba" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">如果我们的<code class="fe lj lk ll lm b">Provider</code>的地图没有那个特定的键，我们将检查是否有一个我们必须实例化的<code class="fe lj lk ll lm b">ViewModel</code>的子类:</p><pre class="mq mr ms mt gt my lm mz na aw nb bi"><span id="e7e6" class="lw lx iy lm b gy nc nd l ne nf">if (creator == null) {<br/>    for (Map.Entry&lt;Class&lt;? extends ViewModel&gt;, Provider&lt;ViewModel&gt;&gt; entry : creators.entrySet()) {<br/>        if (modelClass.isAssignableFrom(entry.getKey())) {<br/>                creator = entry.getValue();<br/>                break;<br/>        }<br/>    }<br/>}</span></pre><p id="954f" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">如果之前从映射中获取有效提供者的所有尝试都失败，我们将抛出一个异常:</p><pre class="mq mr ms mt gt my lm mz na aw nb bi"><span id="0c1c" class="lw lx iy lm b gy nc nd l ne nf">if (creator == null) {<br/>    throw new IllegalArgumentException("unknown model class " + modelClass);<br/>}</span></pre><p id="d642" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">最后，如前所述，我们可以通过调用<code class="fe lj lk ll lm b">Provider</code>对象上的<code class="fe lj lk ll lm b">get()</code>方法，让<em class="lv">匕首</em>创建我们的<code class="fe lj lk ll lm b">ViewModel</code>，并将其转换为我们的最终类型:</p><pre class="mq mr ms mt gt my lm mz na aw nb bi"><span id="aab9" class="lw lx iy lm b gy nc nd l ne nf">try {<br/>    return (T) creator.get();<br/>} catch (Exception e) {<br/>    throw new RuntimeException(e);<br/>}</span></pre><p id="328b" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">我们已经用Dagger 2成功地注入了一个视图模型！</p><h2 id="e1a5" class="lw lx iy bd ly lz ma dn mb mc md dp me kw mf mg mh la mi mj mk le ml mm mn mo bi translated">科特林翻译和…一点额外的！</h2><p id="af62" class="pw-post-body-paragraph kn ko iy kp b kq ng jz ks kt nh kc kv kw ni ky kz la nj lc ld le nk lg lh li ig bi translated">如果你使用Dagger 2和ViewModel，这个类和它的相关类是必不可少的，但是我个人喜欢Kotlin，所以让我们把它转换成这种漂亮简洁的语言:</p><figure class="mq mr ms mt gt ip"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="6af4" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">因此，如果你在你的Android应用程序中使用Kotlin(如果没有，你真的应该🙄)您可以将此代码复制并粘贴到您的项目中，或者…</p><p id="2c63" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">…或者您可以使用🔥🔥<strong class="kp iz">新的和燃烧的</strong>🔥🔥<strong class="kp iz"> </strong>我创建的库！你可以在<a class="ae lu" href="https://github.com/alexfacciorusso/DaggerViewModel" rel="noopener ugc nofollow" target="_blank">这个GitHub链接</a>找到它，以及安装和使用它的说明(参见自述文件)。</p></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><p id="22e8" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">感谢您阅读本文！如果你喜欢它，你可以让我知道按下<strong class="kp iz">*拍手* </strong>按钮(并向GitHub repo对我说“谢谢”)😌。评论里见！😁</p><p id="2ae5" class="pw-post-body-paragraph kn ko iy kp b kq kr jz ks kt ku kc kv kw kx ky kz la lb lc ld le lf lg lh li ig bi translated">了解卡帕头最新的重大新闻。学院，<a class="ae lu" href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a" rel="noopener ugc nofollow" target="_blank">订阅时事通讯</a>，<a class="ae lu" href="https://twitter.com/ktdotacademy" rel="noopener ugc nofollow" target="_blank">观察Twitter </a>并在medium上关注我们。</p><figure class="mq mr ms mt gt ip gh gi paragraph-image"><a href="http://eepurl.com/diMmGv"><div class="gh gi nn"><img src="../Images/5ce68714efe3efc036e06786166954ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uDqv_d5NZnPUJA0FeZqhqQ.png"/></div></a></figure></div></div>    
</body>
</html>