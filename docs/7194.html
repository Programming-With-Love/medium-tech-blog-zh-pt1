<html>
<head>
<title>Ok Google, Charge $2 for Coffee</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">好吧，谷歌，咖啡收费2美元</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/ok-google-charge-2-dollars-for-coffee-4d7fdbacd6ef?source=collection_archive---------2-----------------------#2017-03-10">https://medium.com/square-corner-blog/ok-google-charge-2-dollars-for-coffee-4d7fdbacd6ef?source=collection_archive---------2-----------------------#2017-03-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><blockquote class="ie"><p id="d80d" class="if ig hh bd ih ii ij ik il im in io dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae ip" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><p id="b3eb" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm io ha bi translated">当我收到我的Google Home时，我立刻感到想用它做点什么的冲动。睡了一夜好觉后，我有了一个想法:咖啡师和企业主通常会在柜台后忙得不可开交。如果他们不用在销售点点击按钮就能完成交易会怎么样？如果一个商家可以<strong class="is hi">只使用他们的声音</strong>接受Apple Pay交易会怎么样？</p><figure class="jn jo jp jq fd jr"><div class="bz dy l di"><div class="js jt l"/></div></figure><p id="840a" class="pw-post-body-paragraph iq ir hh is b it ju iv iw ix jv iz ja jb jw jd je jf jx jh ji jj jy jl jm io ha bi translated">在视频中，我们使用<a class="ae ip" href="https://madeby.google.com/home" rel="noopener ugc nofollow" target="_blank"> Google Home </a>激活<a class="ae ip" href="https://squareup.com/contactless-chip-reader" rel="noopener ugc nofollow" target="_blank"> Square非接触式读卡器</a>并进行一次由<a class="ae ip" href="https://techcrunch.com/2016/09/09/square-cash-users-can-now-spend-their-balance-with-a-virtual-debit-card/" rel="noopener ugc nofollow" target="_blank"> Square现金虚拟卡</a>支持的真实Apple Pay交易。</p><p id="4843" class="pw-post-body-paragraph iq ir hh is b it ju iv iw ix jv iz ja jb jw jd je jf jx jh ji jj jy jl jm io ha bi translated">这是只用公共API在几个小时内完成的。让我们来看看它是如何工作的！</p><h1 id="cb98" class="jz ka hh bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">把声音变成咖啡</h1><p id="b188" class="pw-post-body-paragraph iq ir hh is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm io ha bi translated">这似乎是正在发生的事情:</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="er es lc"><img src="../Images/13d8fd94ff887b588a7139a9cd1a8553.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h6pO-1M75N-qoxktjjZcYA.png"/></div></div></figure><p id="9bc5" class="pw-post-body-paragraph iq ir hh is b it ju iv iw ix jv iz ja jb jw jd je jf jx jh ji jj jy jl jm io ha bi translated">虽然咖啡师让它看起来很简单，但制作浓缩咖啡实际上取决于许多活动部件。同样，上面的图表确实是一个很大的过度简化。在实现这个看似简单的交易的过程中，涉及了更多的组件。</p><h1 id="f50f" class="jz ka hh bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">烘焙爪哇咖啡豆</h1><p id="b888" class="pw-post-body-paragraph iq ir hh is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm io ha bi translated">我们先来看一下Square非接触式读卡器的连接。Square目前不提供直接连接它的API。然而，我们的<a class="ae ip" href="https://squareup.com/app" rel="noopener ugc nofollow" target="_blank">销售点</a>应用程序公开了一个<a class="ae ip" href="https://docs.connect.squareup.com/articles/register-api-overview/" rel="noopener ugc nofollow" target="_blank"> API </a>，让其他应用程序将销售点应用程序移动到前台来处理当面支付。</p><p id="1eb4" class="pw-post-body-paragraph iq ir hh is b it ju iv iw ix jv iz ja jb jw jd je jf jx jh ji jj jy jl jm io ha bi translated">这意味着我们可以构建一个调用销售点API的定制商户应用程序。一旦进入前台，销售点应用程序就会通过蓝牙激活读卡器中的NFC芯片:</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="er es lj"><img src="../Images/c01fad5de06aeca4b89e58dcde770d55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nMGIFp0wPVp9INqFhf_aZg.jpeg"/></div></div></figure><p id="3582" class="pw-post-body-paragraph iq ir hh is b it ju iv iw ix jv iz ja jb jw jd je jf jx jh ji jj jy jl jm io ha bi translated">让我们创建一个新的Android应用程序，<em class="lk"> Home Charge </em>，它会触发销售点API！根据<a class="ae ip" href="https://docs.connect.squareup.com/articles/register-api-android/" rel="noopener ugc nofollow" target="_blank">文档</a>，我们只需要注册我们的新应用，然后添加一个依赖项和几行代码:</p><pre class="jn jo jp jq fd ll lm ln lo aw lp bi"><span id="0b98" class="lq ka hh lm b fi lr ls l lt lu">public class ChargeActivity extends Activity {<br/>  // ...</span><span id="dc35" class="lq ka hh lm b fi lv ls l lt lu">  public void <strong class="lm hi">startTransaction(int dollarAmount, String note)</strong> {<br/>    ChargeRequest request =<br/>      new ChargeRequest.Builder(<strong class="lm hi">dollarAmount</strong> * 1_00, USD)<br/>        .note(<strong class="lm hi">note</strong>)<br/>        .autoReturn(3_200, MILLISECONDS)<br/>        .restrictTendersTo(CARD)<br/>        .build();<br/>    Intent intent = posClient.createChargeIntent(request);<br/>    startActivityForResult(intent, CHARGE_REQUEST_CODE);<br/>  }<br/>}</span></pre><h2 id="41b6" class="lq ka hh bd kb lw lx ly kf lz ma mb kj jb mc md kn jf me mf kr jj mg mh kv mi bi translated">向下推动夯锤</h2><p id="89a5" class="pw-post-body-paragraph iq ir hh is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm io ha bi translated">在<em class="lk">家庭充电</em>中调用<code class="du mj mk ml lm b">startTransaction()</code>将销售点应用程序移动到前台并激活非接触式读卡器。我们想在没有任何用户触摸输入的情况下触发它。这意味着我们需要一个服务器向我们的应用程序发送消息，然后应用程序将调用<code class="du mj mk ml lm b">startTransaction()</code>。</p><p id="36cd" class="pw-post-body-paragraph iq ir hh is b it ju iv iw ix jv iz ja jb jw jd je jf jx jh ji jj jy jl jm io ha bi translated">让我们使用<a class="ae ip" href="https://firebase.google.com/docs/cloud-messaging/" rel="noopener ugc nofollow" target="_blank"> Firebase Cloud Messaging </a>将服务器消息推送到我们的应用程序。设置很简单，我们只需要添加几行定制代码:</p><pre class="jn jo jp jq fd ll lm ln lo aw lp bi"><span id="83f3" class="lq ka hh lm b fi lr ls l lt lu">public class ChargeService extends FirebaseMessagingService {<br/><br/>  final Handler handler = new Handler(Looper.<em class="lk">getMainLooper</em>());<br/><br/>  @Override public void onMessageReceived(RemoteMessage msg) {<br/>    Map&lt;String, String&gt; data = remoteMessage.getData();<br/>    final int <strong class="lm hi">dollarAmount</strong> = Integer.<em class="lk">parseInt</em>(data.get("<strong class="lm hi">amount</strong>"));<br/>    final String <strong class="lm hi">note</strong> = data.get("<strong class="lm hi">note</strong>");<br/><br/>    handler.post(new Runnable() {<br/>      @Override public void run() {<br/>        startTransaction(dollarAmount, note);<br/>      }<br/>    });<br/>  }<br/><br/>  private void startTransaction(int dollarAmount, String note) {<br/>    App app = (App) getApplicationContext();<br/>    ChargeActivity chargeActivity = app.getResumedChargeActivity();<br/>    if (chargeActivity != null) {<br/>      chargeActivity.<strong class="lm hi">startTransaction(dollarAmount, note)</strong>;<br/>    }<br/>  }<br/>}</span></pre><p id="743f" class="pw-post-body-paragraph iq ir hh is b it ju iv iw ix jv iz ja jb jw jd je jf jx jh ji jj jy jl jm io ha bi translated">我们可以用<code class="du mj mk ml lm b">FirebaseInstanceId.<em class="lk">getInstance</em>().getToken()</code>检索<em class="lk">注册令牌</em>，用<code class="du mj mk ml lm b">curl</code>手动测试app工作情况:</p><pre class="jn jo jp jq fd ll lm ln lo aw lp bi"><span id="709d" class="lq ka hh lm b fi lr ls l lt lu">curl \<br/>--header "Authorization: key=API_KEY" \<br/>--header Content-Type:"application/json" \<br/><a class="ae ip" href="https://fcm.googleapis.com/fcm/send" rel="noopener ugc nofollow" target="_blank">https://fcm.googleapis.com/fcm/send</a> \<br/>-d \<br/>"<br/>{<br/>  \"data\": {<br/>    \"amount\": \"2\",<br/>    \"note\":\"coffee\"<br/>  },<br/>  \"to\":\"REGISTRATION_TOKEN\"<br/>}"</span></pre><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es mm"><img src="../Images/05ddb1e3ea3499ec88b4132b61fa5796.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/1*tI6vVYc6D0c34OxuoBdjeA.gif"/></div></figure><p id="9f94" class="pw-post-body-paragraph iq ir hh is b it ju iv iw ix jv iz ja jb jw jd je jf jx jh ji jj jy jl jm io ha bi translated">有用！</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es mn"><img src="../Images/92a27cbe012b306ef3d92789c237ca2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*vg5HU17uJN_yas1aYWMhOw.png"/></div><figcaption class="mo mp et er es mq mr bd b be z dx">Receipt printing works as well!</figcaption></figure><p id="f09c" class="pw-post-body-paragraph iq ir hh is b it ju iv iw ix jv iz ja jb jw jd je jf jx jh ji jj jy jl jm io ha bi translated">现在我们来关注一下Google Home。</p><h1 id="5ddb" class="jz ka hh bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">如果累了，那么三倍(拍摄)</h1><p id="bd20" class="pw-post-body-paragraph iq ir hh is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm io ha bi translated">Google Home提供了<a class="ae ip" href="https://developers.google.com/actions/develop/conversation" rel="noopener ugc nofollow" target="_blank">API</a>与用户进行双向对话。还有一个简单得多的解决方案:<a class="ae ip" href="http://ifttt.com" rel="noopener ugc nofollow" target="_blank"> IFTTT </a>(如果<em class="lk">这个</em>，那么<em class="lk">那个</em>)支持Google Assistant触发器。它可以匹配任何带有数字和文本参数的文本模式。这对我们来说是完美的，因为我们想要解析一个简单的句子:<code class="du mj mk ml lm b">“Charge {amount} dollars for {note}”</code>。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="er es ms"><img src="../Images/eb678a50b6aa02377fb4b7283a5e5208.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DOGNCfkCxDIKbCsqelbXbg.png"/></div></div></figure><p id="75f2" class="pw-post-body-paragraph iq ir hh is b it ju iv iw ix jv iz ja jb jw jd je jf jx jh ji jj jy jl jm io ha bi translated">我们还需要定义一个动作来响应这个触发器。IFTTT有一个提供Web请求动作的<a class="ae ip" href="https://ifttt.com/maker" rel="noopener ugc nofollow" target="_blank"> Maker </a>通道。不幸的是，我们不能用它来直接调用Firebase云消息服务器，因为它不支持授权头。</p><h1 id="4496" class="jz ka hh bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">引导咖啡流</h1><p id="b549" class="pw-post-body-paragraph iq ir hh is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm io ha bi translated">让我们创建一个端点，它将接收IFTTT HTTP请求，并将这些请求代理给Firebase云消息传递。一个快速的方法是建立一个<a class="ae ip" href="https://cloud.google.com/appengine/" rel="noopener ugc nofollow" target="_blank">应用引擎</a>项目并编写一个优秀的Java servlet:</p><pre class="jn jo jp jq fd ll lm ln lo aw lp bi"><span id="41a9" class="lq ka hh lm b fi lr ls l lt lu">public class MessageServlet extends HttpServlet {</span><span id="6673" class="lq ka hh lm b fi lv ls l lt lu">  @Override public void doGet(<br/>      HttpServletRequest request,<br/>      HttpServletResponse response) throws IOException {</span><span id="1177" class="lq ka hh lm b fi lv ls l lt lu">Map&lt;String, String&gt; queryParams = parseQueryParams(request);<br/>    String <strong class="lm hi">amount</strong> = queryParams.get("amount");<br/>    String <strong class="lm hi">note</strong> = queryParams.get("note");<br/>    String <strong class="lm hi">apiKey</strong> = queryParams.get("api-key");<br/>    String <strong class="lm hi">token</strong> = queryParams.get("registration-token");</span><span id="f953" class="lq ka hh lm b fi lv ls l lt lu">    String json = String.format(<br/>      "{\"data\":{\"amount\":\"%s\",\"note\":\"%s\"},"<br/>        + "\"to\":\"%s\"}", <br/>      <strong class="lm hi">amount</strong>,<br/>      <strong class="lm hi">note</strong>,<br/>      <strong class="lm hi">token</strong>);</span><span id="54ad" class="lq ka hh lm b fi lv ls l lt lu">    URL url = new URL("<strong class="lm hi">https://fcm.googleapis.com/fcm/send</strong>");<br/>    HttpURLConnection conn =<br/>      (HttpURLConnection) url.openConnection();<br/>    conn.setDoOutput(true);<br/>    conn.setRequestMethod("POST");<br/>    conn.setRequestProperty("Content-Type", "application/json");<br/>    conn.setRequestProperty("Authorization", "key=" + <strong class="lm hi">apiKey</strong>);</span><span id="fcb2" class="lq ka hh lm b fi lv ls l lt lu">    OutputStreamWriter writer =<br/>      new OutputStreamWriter(conn.getOutputStream());<br/>    writer.write(json);<br/>    writer.close();<br/>  <br/>    response.setStatus(conn.getResponseCode());<br/>    response.setContentType("text/plain");<br/>    response.getWriter().println("Over Extracted?");<br/>  }<br/>}</span></pre><p id="5f5b" class="pw-post-body-paragraph iq ir hh is b it ju iv iw ix jv iz ja jb jw jd je jf jx jh ji jj jy jl jm io ha bi translated">然后我们只需要定义相应的IFTTT Web请求动作:</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div class="er es mt"><img src="../Images/7dfee9febac7e2b68ae90e551dc2e4a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:994/format:webp/1*7XBv4s287b_3FOSraiItQQ.png"/></div></figure><h1 id="02d5" class="jz ka hh bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">完整的画面</h1><p id="6269" class="pw-post-body-paragraph iq ir hh is b it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj lb jl jm io ha bi translated">现在我们知道了将语音转换成咖啡所需的步骤，我们可以更新我们的初始序列图，以包括所有发生的交互:</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="er es mu"><img src="../Images/6685b88e1acf646e8e1cea4136b5cc44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fgG27XbDWYo2sIZy4yO52A.png"/></div></div></figure><p id="1da0" class="pw-post-body-paragraph iq ir hh is b it ju iv iw ix jv iz ja jb jw jd je jf jx jh ji jj jy jl jm io ha bi translated">我希望你喜欢这篇博文！GitHub 上的<a class="ae ip" href="https://github.com/square/register-android-sdk#home-charge" rel="noopener ugc nofollow" target="_blank">提供了该项目的源代码。你打算在我们的公共API基础上开发哪些很酷的东西？</a></p></div></div>    
</body>
</html>