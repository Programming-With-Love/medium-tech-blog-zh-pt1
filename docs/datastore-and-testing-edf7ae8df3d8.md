# æ•°æ®å­˜å‚¨å’Œæµ‹è¯•

> åŸæ–‡ï¼š<https://medium.com/androiddevelopers/datastore-and-testing-edf7ae8df3d8?source=collection_archive---------2----------------------->

![](img/1fea125b5da043ce725eedc85b702dab.png)

åœ¨æˆ‘ä»¬çš„ [**Jetpack æ•°æ®å­˜å‚¨ç³»åˆ—**](/androiddevelopers/introduction-to-jetpack-datastore-3dc8d74139e7) çš„æœ€åä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è®²è¿°å¦‚ä½•**æˆåŠŸæµ‹è¯•æ‚¨çš„æ•°æ®å­˜å‚¨ã€‚**

# æµ‹è¯•æ•°æ®å­˜å‚¨

æ¯ä¸€ä¸ªå¥½æ•…äº‹éƒ½éœ€è¦å¥½çš„æ£€éªŒï¼ä¸ºäº†æ€»ç»“æˆ‘ä»¬çš„ç³»åˆ—ï¼Œæˆ‘ä»¬å°†å›é¡¾å¦‚ä½•ä½¿ç”¨**æµ‹è¯•æ‚¨çš„æ•°æ®å­˜å‚¨åº“**ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å°†å‚è€ƒ [**é¦–é€‰é¡¹ codelab**](https://developer.android.com/codelabs/android-preferences-datastore#0) ä½œä¸ºèµ·ç‚¹ã€‚ä½†æ˜¯ï¼Œè¯·è®°ä½ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ­¤ææ–™æ¥è®¾ç½®[**Proto DataStore**](https://developer.android.com/codelabs/android-proto-datastore#0)æµ‹è¯•ï¼Œå› ä¸ºå®ƒä¸ Preferences éå¸¸ç›¸ä¼¼ã€‚

è¦å…¨é¢æµ‹è¯•æ•°æ®å­˜å‚¨ï¼Œé¦–å…ˆéœ€è¦å®Œæˆ [**ä»ªå™¨æµ‹è¯•**](https://developer.android.com/training/testing/unit-testing/instrumented-unit-tests) çš„è®¾ç½®ã€‚è¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤ŸéªŒè¯**å®é™…æ›´æ–°**æ­£åœ¨æ ¹æ®æˆ‘ä»¬çš„é¢„æœŸå¯¹æˆ‘ä»¬çš„å­˜å‚¨è¿›è¡Œï¼Œå› ä¸ºæˆ‘ä»¬å°†ä»**å®é™…æ–‡ä»¶**ä¸­å†™å…¥å’Œè¯»å–ã€‚

ä¹Ÿæœ‰å¯èƒ½åœ¨å•å…ƒæµ‹è¯•æ—¶ä»…ä»…**æ¨¡ä»¿ä½ çš„æ•°æ®å­˜å‚¨å®ä¾‹**å¹¶å°†å…¶ä½œä¸ºä¾èµ–æ³¨å…¥åˆ°å¦ä¸€ä¸ªç±»ï¼Œä½†æ˜¯ä½ ä¸èƒ½åœ¨æ•°æ®å­˜å‚¨æœ¬èº«ä¸Šè¿è¡Œ**ä»»ä½•çœŸæ­£çš„éªŒè¯æ£€æŸ¥**ã€‚

## é¦–é€‰é¡¹æ•°æ®å­˜å‚¨æµ‹è¯•

åœ¨æˆ‘ä»¬çš„ codelab ä¸­ï¼Œè´Ÿè´£å‘æˆ‘ä»¬çš„æ•°æ®å­˜å‚¨åº“è¯»å†™æ•°æ®çš„ç±»æ˜¯`UserPreferencesRepository`ï¼Œæ‰€ä»¥æˆ‘ä»¬æƒ³è¦éªŒè¯è¿™ä¸ªç±»ï¼Œä»¥åŠå®ƒä¸æ•°æ®å­˜å‚¨åº“äº¤äº’çš„**å‡½æ•°ï¼Œæ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œã€‚**

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª`UserPreferencesRepositoryTest`ç±»:

ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†æµ‹è¯•çš„æ¡†æ¶ï¼Œè®©æˆ‘ä»¬å¼€å§‹åˆ›å»ºæˆ‘ä»¬çš„æµ‹è¯•ä¸»é¢˜ï¼Œ`UserPreferencesRepository`ï¼Œå¹¶ä»¥æˆ‘ä»¬çš„æ–¹å¼å‘åå·¥ä½œï¼

ä¸ºäº†è·å¾—`UserPreferencesRepository`çš„å®ä¾‹ï¼Œæˆ‘ä»¬éœ€è¦ä¼ é€’ä¸€ä¸ªæ•°æ®å­˜å‚¨å®ä¾‹:

æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªå¿«é€Ÿçš„`testDataStore`å®ä¾‹ï¼Œå®ƒå°†åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æµ‹è¯•æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ä½¿ç”¨å®ƒæ¥è®¾ç½®å’ŒéªŒè¯è™šæ‹Ÿæ•°æ®:

æˆ‘ä»¬ä½¿ç”¨`PreferenceDataStoreFactory`åˆ›å»ºä¸€ä¸ªé¦–é€‰é¡¹æ•°æ®å­˜å‚¨å®ä¾‹ï¼Œå¹¶ä¼ é€’:

*   `testCoroutineScope` â€”æˆ‘ä»¬çš„æµ‹è¯•æ“ä½œå°†åœ¨å…¶ä¸­æ‰§è¡Œçš„åç¨‹ä½œç”¨åŸŸ
*   `produceFile` â€”ä½¿ç”¨æ¥è‡ª`ApplicationProvider`çš„`testContext`ï¼Œæ„å»ºä¸€ä¸ªæˆ‘ä»¬å°†ç”¨äºå†™å…¥å’Œè¯»å–æµ‹è¯•æ•°æ®çš„æµ‹è¯•æ–‡ä»¶:

ç”±äºæ•°æ®å­˜å‚¨åŸºäº Kotlin åç¨‹ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿æˆ‘ä»¬çš„æµ‹è¯•æœ‰æ­£ç¡®çš„åç¨‹è®¾ç½®ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ :

è¿™æ˜¯ä¸€ä¸ªæ‰§è¡Œåç¨‹çš„`CoroutineDispatcher`ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯ç«‹å³æ‰§è¡Œçš„ã€‚è¿™æ„å‘³ç€ä»»ä½•è®¡åˆ’è¿è¡Œçš„ä»»åŠ¡éƒ½ä¼šç«‹å³æ‰§è¡Œã€‚

è¿™æ˜¯ä¸€ä¸ªä¸ºæµ‹è¯•æä¾›å¯¹åç¨‹æ‰§è¡Œçš„è¯¦ç»†æ§åˆ¶çš„èŒƒå›´ã€‚æ·»åŠ çš„`Job`å…è®¸æˆ‘ä»¬åœ¨æ¯æ¬¡æµ‹è¯•åï¼Œä½œä¸ºå¸¸è§„æ¸…ç†çš„ä¸€éƒ¨åˆ†ï¼Œè½»æ¾åœ°å–æ¶ˆåç¨‹ã€‚

è®¾ç½®å®Œæˆåï¼Œæˆ‘ä»¬çš„æµ‹è¯•ç±»åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæµ‹è¯•å°†åªæ˜¯åœ¨åˆ›å»º`testDataStore`æ—¶éªŒè¯æˆ‘ä»¬æ•°æ®çš„çŠ¶æ€ã€‚æˆ‘ä»¬å°†åœ¨æ²¡æœ‰ **è®¢é˜…æµ**çš„æƒ…å†µä¸‹è·å–æ•°æ®**çš„å¿«ç…§ï¼Œå¹¶æ ¹æ®æˆ‘ä»¬çš„é¢„æœŸç»“æœè¿›è¡Œå¿«é€Ÿæ£€æŸ¥ã€‚åœ¨æˆ‘ä»¬çš„`UserPreferencesRepository`ä¸­ï¼Œè¿™æ˜¯æˆ‘ä»¬æƒ³è¦æµ‹è¯•çš„ç¬¬ä¸€ä¸ªå‡½æ•°:**

å½“ç¬¬ä¸€æ¬¡åˆ›å»ºå­˜å‚¨åº“æ—¶ï¼Œå®ƒæ£€æŸ¥æ•°æ®å­˜å‚¨æ˜¯å¦ä¸ºç©ºï¼Œå¹¶åœ¨è¿™ç§æƒ…å†µä¸‹è®¾ç½®æˆ‘ä»¬çš„æ•°æ®çš„é»˜è®¤å®ä¾‹:

å¦‚æœæˆ‘ä»¬è€ƒè™‘è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹çš„å¿…è¦æ­¥éª¤ï¼Œæˆ‘ä»¬éœ€è¦:

1.  åˆ›å»ºä¸€ä¸ªä¿å­˜äº†é»˜è®¤å€¼çš„`testDataStore`â€”â€”å®Œæˆâœ…
2.  åˆ›å»ºæµ‹è¯•ä¸»é¢˜`UserPreferencesRepository` â€”å®Œæˆâœ…
3.  è®¾ç½®ä»£è¡¨æˆ‘ä»¬æœŸæœ›åœ¨`testDataStore`ä¸­å‘ç°ä»€ä¹ˆçš„`expectedUserPreferences`â€”â€”è¿˜æ²¡æœ‰å®Œæˆï¼
4.  å‘¼å«`repository.fetchInitialPreferences()` â€”è¿˜æ²¡å®Œæˆï¼
5.  éªŒè¯è¿”å›å€¼æ˜¯å¦ä¸æˆ‘ä»¬é¢„æœŸçš„ç»“æœç›¸åŒ¹é…â€”â€”è¿˜æ²¡æœ‰å®Œæˆï¼

æŒ‰ç…§è¿™äº›æ­¥éª¤ï¼Œæˆ‘ä»¬çš„æµ‹è¯•åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

> *ğŸ’¡ä½ å¯èƒ½ä¼šæ³¨æ„åˆ° Android Studio æŠ±æ€¨â€œ*æŒ‚èµ·å‡½æ•°â€˜fetchInitialPreferencesâ€™åº”è¯¥åªèƒ½ä»åç¨‹æˆ–å¦ä¸€ä¸ªæŒ‚èµ·å‡½æ•°*ä¸­è°ƒç”¨â€ã€‚*
> 
> *äº‹å®ä¸Šï¼Œæˆ‘ä»¬çš„* `*fetchInitialPreferences()*` *æ˜¯ä¸€ä¸ªæš‚åœå‡½æ•°ï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯ä»æµ‹è¯•ä¸­è°ƒç”¨å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¡®ä¿é¿å…ä»»ä½•å®æ—¶å»¶è¿Ÿã€‚* `*kotlinx.coroutines.test*` *ç”¨ä¸€ä¸ªéå¸¸ç®€å•çš„æµ‹è¯•è§£å†³æ–¹æ¡ˆå†æ¬¡æŒ½æ•‘äº†å±€é¢â€”â€”ç”¨* `*testCoroutineScope.runBlockingTest{}*` *å°†å®ƒåŒ…å›´èµ·æ¥(æ³¨æ„ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Kotlin 1.6ï¼Œä½ å¯ä»¥ç”¨* `[*runTest{}*](https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-test/kotlinx.coroutines.test/run-test.html)` *)*

ä¸€ä¸ªæå®šäº†ï¼Œè¿˜æœ‰ä¸€ä¸ªã€‚æˆ‘ä»¬çš„ä¸‹ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹é€šè¿‡å¯ç”¨æˆ–ç¦ç”¨å­˜å‚¨çš„`SortOrder`å€¼æ¥éªŒè¯æˆ‘ä»¬çš„å­˜å‚¨åº“æ˜¯å¦å¯¹æ•°æ®å­˜å‚¨åº“è¿›è¡Œäº†æ­£ç¡®çš„æ›´æ”¹:

æˆ‘ä»¬éµå¾ªç±»ä¼¼çš„æ¨¡å¼:

1.  åˆ›å»ºä¸€ä¸ªä¿å­˜é»˜è®¤å€¼çš„`testDataStore`â€”å®Œæˆâœ…
2.  åˆ›å»ºæµ‹è¯•ä¸»é¢˜`UserPreferencesRepository` â€”å®Œæˆâœ…
3.  ç”¨æ–°å€¼è°ƒç”¨`repository.enableSortByDeadline()`â€”â€”è¿˜æ²¡å®Œæˆï¼
4.  éªŒè¯æ¥è‡ª`repository.userPreferencesFlow`çš„`testDataStore`å€¼ä¸æˆ‘ä»¬çš„é¢„æœŸç»“æœç›¸åŒ¹é…â€”â€”å°šæœªå®Œæˆï¼

æ·»åŠ æœ€åä¸¤ä¸ªæµ‹è¯•æ­¥éª¤å°†å¦‚ä¸‹æ‰€ç¤º:

è¿™æ¶µç›–äº†æˆ‘ä»¬çš„åŸºæœ¬æµ‹è¯•ç”¨ä¾‹ã€‚æ‚¨å¯ä»¥éµå¾ªç›¸åŒçš„æ­¥éª¤æ¥å¢åŠ è¿™ä¸ªå­˜å‚¨åº“ç±»çš„æµ‹è¯•è¦†ç›–ç‡ã€‚

ç°åœ¨å‰©ä¸‹è¦åšçš„å°±æ˜¯ç»´æŠ¤å’Œæ¸…ç†ä¸€ä¸ªå¥åº·çš„æµ‹è¯•ç¯å¢ƒã€‚æœ€åï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ç°åœ¨å·²ç»å®Œæˆçš„æ•´ä¸ªæµ‹è¯•ç±»:

# å°±è¿™æ ·ç»“æŸäº†ï¼ğŸ¬

åœ¨æˆ‘ä»¬å…³äº[**Jetpack DataStore**](/androiddevelopers/introduction-to-jetpack-datastore-3dc8d74139e7)çš„æ•´ä¸ªç³»åˆ—ä¸­ï¼Œæˆ‘ä»¬æ¶µç›–äº†è®¸å¤šä¸åŒçš„ä¸»é¢˜ï¼Œæ‰€æœ‰è¿™äº›ä¸»é¢˜å¯¹äºæ·±å…¥ç†è§£ DataStore å¹¶åœ¨**ç”Ÿäº§ç¯å¢ƒ**ä¸­æ­£ç¡®ä½¿ç”¨å®ƒéƒ½æ˜¯è‡³å…³é‡è¦çš„**ã€‚**

æˆ‘ä»¬å·²ç»äº†è§£äº†[æ•°æ®å­˜å‚¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œ](/androiddevelopers/introduction-to-jetpack-datastore-3dc8d74139e7)å®ƒç»™`SharedPreferences`å¸¦æ¥äº†ä»€ä¹ˆå¥½å¤„ï¼Œä»¥åŠå®ƒçš„[åå¥½](/androiddevelopers/all-about-preferences-datastore-cc7995679334)å’Œ[åŸå‹](/androiddevelopers/all-about-proto-datastore-1b1af6cd2879)å®ç°ã€‚æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†ä½¿ç”¨å“ªç§[åºåˆ—åŒ–æ–¹æ³•ï¼Œ](/androiddevelopers/datastore-and-kotlin-serialization-8b25bf0be66c)å¦‚ä½•ç”¨åˆ€æŸ„æ³¨å…¥[ä»¥åŠæœ€åå¦‚ä½•æµ‹è¯•ã€‚ç°åœ¨å°±çœ‹ä½ è‡ªå·±å»å°è¯•äº†ï¼æ‚¨è¿˜å¯ä»¥ä»æˆ‘ä»¬çš„](/androiddevelopers/datastore-and-dependency-injection-ea32b95704e3) [**MAD Skills è§†é¢‘ç³»åˆ—**](https://www.youtube.com/playlist?list=PLWz5rJ2EKKc8to3Ere-ePuco69yBUmQ9C) ä¸­äº†è§£æ•°æ®å­˜å‚¨ï¼Œå¹¶å‚åŠ æˆ‘ä»¬å³å°†ä¸¾è¡Œçš„ç°åœº Q & Aï¼Œæˆ‘ä»¬å°†å›ç­”æ‚¨å¯èƒ½æœ‰çš„æ‰€æœ‰é—®é¢˜ã€‚

æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°æˆ‘ä»¬çš„ Jetpack æ•°æ®å­˜å‚¨ç³»åˆ—çš„æ‰€æœ‰å¸–å­:
[Jetpack æ•°æ®å­˜å‚¨ç®€ä»‹](/androiddevelopers/introduction-to-jetpack-datastore-3dc8d74139e7)
[æ‰€æœ‰å…³äºé¦–é€‰é¡¹æ•°æ®å­˜å‚¨](/androiddevelopers/all-about-preferences-datastore-cc7995679334)
[æ‰€æœ‰å…³äºåŸå‹æ•°æ®å­˜å‚¨](/androiddevelopers/all-about-proto-datastore-1b1af6cd2879)
[æ•°æ®å­˜å‚¨å’Œä¾èµ–æ³¨å…¥](/androiddevelopers/datastore-and-dependency-injection-ea32b95704e3)
[æ•°æ®å­˜å‚¨å’Œ Kotlin åºåˆ—åŒ–](/androiddevelopers/datastore-and-kotlin-serialization-8b25bf0be66c)
[æ•°æ®å­˜å‚¨å’ŒåŒæ­¥å·¥ä½œ](/androiddevelopers/datastore-and-synchronous-work-576f3869ec4c)
[æ•°æ®å­˜å‚¨å’Œæ•°æ®è¿ç§»](/androiddevelopers/datastore-and-data-migration-fdca806eb1aa)
[æ•°æ®å­˜å‚¨å’Œæµ‹è¯•](/androiddevelopers/datastore-and-testing-edf7ae8df3d8)