<html>
<head>
<title>Geo-blocking media content on Pinterest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Pinterest上的地理屏蔽媒体内容</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/geo-blocking-media-content-at-pinterest-ea11c8f8c2b7?source=collection_archive---------3-----------------------#2018-02-02">https://medium.com/pinterest-engineering/geo-blocking-media-content-at-pinterest-ea11c8f8c2b7?source=collection_archive---------3-----------------------#2018-02-02</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="ecd0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">nick de chant &amp; Kynan la lone | Pinterest工程师，视频和图像平台及流量</p><p id="56f5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest工程师的任务是向Pinners展示与其兴趣相关的最佳创意，包括考虑位置等信号。作为这些努力的一部分，我们建立了一个<a class="ae jc" rel="noopener" href="/@Pinterest_Engineering/building-pinterests-video-platform-2338dd1d213">视频和图像平台</a>，以支持围绕Pinterest上的媒体内容的强大基础设施、新功能和工具。在本帖中，我们将重点介绍我们构建的最新工具之一——新的地理封锁API。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/2b4e2dd9d58484ae1a8aa6586f24656e.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/0*jTCRiq5LQyn6Ir6f."/></div></figure><p id="b719" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">地理封锁是一种行业标准做法，它在出于各种原因的特定位置向用户显示特定内容，同时允许无缝体验并遵守当地法律和保护。在设计这些API时，我们将其创建为类似于乐高积木——易于我们所有团队使用，因此他们可以快速移动并将产品交付给品商，而不是花费时间学习新工具。我们的目标是使API尽可能简单明了，并记录过程，使跟踪哪个动作在哪个介质上执行变得简单。我们还利用AWS S3 API和我们的CDN提供商的快速清除API来设计它们。</p><p id="601f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在API端，当视频和图像平台收到地理封锁或解除封锁请求时，最初会发生一些事情:</p><ol class=""><li id="9680" class="jl jm hh ig b ih ii il im ip jn it jo ix jp jb jq jr js jt bi translated">验证成功后，我们会记录该媒体在Kafka中的指定国家/地区“进行中”。</li><li id="b828" class="jl jm hh ig b ih ju il jv ip jw it jx ix jy jb jq jr js jt bi translated">然后，我们创建一个特定于地理封锁或地理解除封锁的作业(两者遵循相似的流程)。这允许作业使用视频和图像平台的定位API来定位存储在S3的媒体的所有变体。</li><li id="e7af" class="jl jm hh ig b ih ju il jv ip jw it jx ix jy jb jq jr js jt bi translated">接下来，我们获取S3 ObjectMetadata，并添加或删除自定义的UserMetadata，以指示不应提供媒体服务的国家。</li><li id="1c0f" class="jl jm hh ig b ih ju il jv ip jw it jx ix jy jb jq jr js jt bi translated">该作业调用平台的CDN清除API来清除我们的CDN提供商上的媒体，以便他们使用更新的元数据再次获取媒体对象。</li><li id="b3c0" class="jl jm hh ig b ih ju il jv ip jw it jx ix jy jb jq jr js jt bi translated">然后，在指定的国家/地区，媒体在Kafka中被记录为“成功”。</li></ol><p id="2aae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的流量团队管理从客户端到源的请求路径，我们的CDN平台允许我们在边缘安装逻辑。当客户端从CDN请求图像时，边缘节点首先尝试从CDN缓存中获取对象。因为清除API已经使对象键无效，所以CDN必须进行原点提取。现在，我们在HTTP响应头中有了S3元数据，可以缓存该对象以供将来的客户端请求使用。最后，对客户端的连接IP地址执行地理查找，并与缓存对象的响应标头中以逗号分隔的响应ISO 3166-1 alpha-2国家/地区代码列表进行比较。如果找到匹配，客户端将获得一个HTTP 451状态代码。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es jz"><img src="../Images/1d1f2b9604c848f7ff0b94e5ad70dc66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KebO6XqCOgF6PJpy."/></div></div></figure><p id="3b0c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果特定的URL在某些国家被阻止，我们希望保持透明，因此Pinners会看到一个简短的解释，说明他们为什么不能访问这些内容，其中可能包括从版权到许可问题的所有内容(这比含糊不清的404响应更有用)。</p><p id="78d7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">展望未来，我们将迎接新的技术挑战，改进我们的视频和图像基础设施，专注于将Pinners放在第一位，让他们无缝体验发现和做自己喜欢的事情。敬请关注我们分享的进展！</p></div></div>    
</body>
</html>