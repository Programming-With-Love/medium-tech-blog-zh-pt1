<html>
<head>
<title>Building Pin stats</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建Pin统计</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/building-pin-stats-25ec8460e924?source=collection_archive---------2-----------------------#2018-05-08">https://medium.com/pinterest-engineering/building-pin-stats-25ec8460e924?source=collection_archive---------2-----------------------#2018-05-08</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="fb08" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Mohak Nahta | Pinterest产品工程工程师</p><p id="cd81" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">几个月前，我们开始为企业建立一种方式，在他们的个人资料上创建和展示他们最新和最喜爱的内容。我们还想让企业更容易了解他们的引脚性能如何。如果一家企业能够迅速获得关于其内容的有用见解，他们就能更好地理解Pinners正在寻找的想法。这就是为什么我们建立了Pin stats——对企业创建的Pin进行近实时分析。在本帖中，我们将介绍我们如何开发Pin stats，以及如何近乎实时地记录、处理和聚合数十亿个事件。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/006769fe13d3b18567850fd8ebe3f076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gt2eAr-c_dz_g1OUmMT2nA.png"/></div></div></figure><h1 id="849b" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">挑战</h1><p id="eaee" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">我们想用Pin stats解决两个主要问题。</p><ol class=""><li id="dfd5" class="kr ks hh ig b ih ii il im ip kt it ku ix kv jb kw kx ky kz bi translated"><strong class="ig hi">近乎实时的洞察力</strong>:企业告诉我们，他们希望看到他们的pin在发布后的几个小时内表现如何。构建Pin统计的最大挑战之一是处理数百亿个事件，使我们能够将分析交付时间减少到两个小时，减少了18倍。</li><li id="e476" class="kr ks hh ig b ih la il lb ip lc it ld ix le jb kw kx ky kz bi translated"><strong class="ig hi">规范化</strong>:每次有人将Pin保存到Pinterest，我们都会将其作为一个单独的实例记录下来。以前，我们只为企业提供该Pin实例的分析。这意味着企业永远无法全面了解其内容的表现。有了Pin stats，现在Pin的所有不同实例都聚合到一个规范的stat中，因此企业可以在Pinterest上看到其内容的全部影响。</li></ol><h1 id="85a6" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">履行</h1><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es lf"><img src="../Images/2eb21ff322989af7ef3d56b5ff22676f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NDKtdYyClUelIbFH."/></div></div></figure><h2 id="5bf7" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated"><em class="lu">伐木</em></h2><p id="0732" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">项目的第一部分包括实时记录最初由企业拥有的pin上的所有事件，并将它们发送到<a class="ae lv" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank">Apache Kafka</a>——Pinterest使用的日志传输层。这很有挑战性，因为我们每秒钟都会收到数十万个各种各样的事件。</p><p id="fd4f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们的例子中，我们只想记录与企业相关的事件(即，只记录最初由企业创建的Pin上的印象)。由于我们严格要求在两个小时内显示Pin stats <em class="lw"> </em>，我们不仅要实时记录事件，还要在记录前对其进行过滤。我们负担不起过滤离线事件的费用，因为筛选所有事件并只提取与业务相关的事件需要几个小时。</p><p id="46ce" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">同时，在线过滤的成本非常高，因为它会涉及各种网络调用，并增加前端日志记录端点的延迟。我们实现了各种优化和试探法来最小化必要的网络调用数量。这确保了我们只有在相当肯定事件属于最初由企业创建的Pin之后才进行网络呼叫。这通过几个因素减轻了我们前端日志记录端点的负担。</p><h2 id="6d83" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated">处理</h2><p id="70a9" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">大量的事件意味着我们也需要以极其有效的方式处理它们。这就是为什么我们按照三个不同的时间范围聚合来划分新的Pin统计数据——每小时(滑动24小时窗口)、过去七天和过去30天。</p><p id="aed4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于每小时的<em class="lw"> </em>部分，我们需要单独处理数据，以便尽快向企业展示。我们通过从我们的卡夫卡主题中引出两条不同的管道来实现这一点，一条处理小时数据，另一条处理每日数据。同时，我们通过各种规则确保两条管道的可靠性和一致性，以避免数据不一致。前者是数据摄取管道，每小时创建过去一小时内记录事件的<em class="lw"> </em>表(大约每小时四十亿个事件)，然后我们使用高效的MapReduce作业对其进行处理和聚合。这意味着我们能够每小时将数据保存到存储中，并拥有按小时运行的数据工作流，以在非常精细的时间级别上聚合分析。后一个管道会生成一个每日表(约1000亿个事件/天)，由于SLA更长，该表会得到更彻底的处理和验证。</p><h2 id="ee61" class="lg jp hh bd jq lh li lj ju lk ll lm jy ip ln lo kc it lp lq kg ix lr ls kk lt bi translated">储存；储备</h2><p id="25bd" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">在短时间内记录、处理、验证和聚合了数百亿个事件之后，我们需要一种能够处理极其庞大的数据集的低延迟存储解决方案。我们决定使用<a class="ae lv" rel="noopener" href="/@Pinterest_Engineering/open-sourcing-terrapin-a-serving-system-for-batch-generated-data-7aa2f38c4472">terra pin</a>——我们内部的低延迟服务系统来处理大型数据集。它满足了我们对弹性、容错和能够直接从亚马逊S3接收数据的要求。</p><h1 id="f530" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">课程</h1><p id="a39b" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">在这个过程中，我们学到了许多宝贵的经验。其中一个主要挑战是构建一个数据管道，该管道可以支持每秒钟数十万个事件的实时流，并且随着Pinterest的增长，该管道是可靠且可扩展的。特别是，很难让我们的分歧管道的工作方式，他们都与数据一致和可靠。</p><p id="7f99" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">另一个巨大的挑战是过滤每秒钟大量的事件，这样我们就不会用我们永远不会处理的数据填充我们的管道。这很复杂，因为任何类型的过滤通常都需要网络呼叫，这最终会降低日志记录的速度。为了解决这个问题，我们预先使用各种信号来确保网络呼叫是必要的。</p><p id="2118" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，我们在选择方法时学到了很多东西——无论是花几个月时间构建真正的实时管道，还是创建一个可以在不到两小时内提供数据的系统。我们设计了一个实时分析服务的原型，看看在当前的基础设施下是否可行，并最终决定采用一个接近实时的系统，以便更快地提供体验。</p><h1 id="8ba9" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">后续步骤</h1><p id="6883" class="pw-post-body-paragraph ie if hh ig b ih km ij ik il kn in io ip ko ir is it kp iv iw ix kq iz ja jb ha bi translated">我们的下一步将是建立一个真正实时的系统，在上传Pin的几秒钟内显示Pin stats <em class="lw"> </em>。我们还希望提供额外的指标，以便企业可以创建更好、更可行的pin。</p><p id="ed7a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lw">鸣谢:没有Pinterest </em>不同团队的工程师们的帮助和支持，这个项目是不可能完成的。<em class="lw">我要特别感谢Ryan Shih、Andrew Chun、Derek Tia、、Daniel、David Temple、Gordon Chen、、Jon Parise、Rajesh Bhatia、Sam Meder、Shawn Nguyen、Shirley Gaw、Tamara Louie、李瑱、Tiffany Black、魏冉刘和王艺凝。</em></p></div></div>    
</body>
</html>