<html>
<head>
<title>Deploying Cinder with Multiple Ceph Cluster Backends</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用多个Ceph集群后端部署Cinder</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/deploying-cinder-with-multiple-ceph-cluster-backends-2cd90d64b10?source=collection_archive---------4-----------------------#2016-10-12">https://medium.com/walmartglobaltech/deploying-cinder-with-multiple-ceph-cluster-backends-2cd90d64b10?source=collection_archive---------4-----------------------#2016-10-12</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/e88905dcf093469de26d277fc5d707cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*693-63_7F7NLr1utKkWNWg.png"/></div></div></figure><p id="cbdc" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">本文是关于利用多个Ceph集群作为cinder后端的。此用途的目的是允许实例从一个或两个Ceph集群附加块卷。</p><h2 id="d027" class="jn jo hh bd jp jq jr js jt ju jv jw jx ja jy jz ka je kb kc kd ji ke kf kg kh bi translated">背景</h2><p id="b345" class="pw-post-body-paragraph ip iq hh ir b is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji km jk jl jm ha bi translated">Cinder的任务是创建块卷，并向nova提供这些卷的连接参数。nova-compute服务调用Cinder的api来保留和请求特定的卷，Cinder提供一个包含以下信息的响应:driver_volume_type、secret_type、secret_uuid、hosts、name、volume_id、auth_enabled、auth_username和ports。不同的卷类型可能会有不同的信息，但是您可以在下面看到一个Ceph卷的响应示例:</p><figure class="ko kp kq kr fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kn"><img src="../Images/08fc688e0125a0813af8a9bd9c80e2c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tHEfsgi-VyiSatrWrsV2Uw.png"/></div></div></figure><p id="0927" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Nova通过将这些设置转换成适当的xml标记和参数来提供给libvirt。</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="2c3a" class="jn jo hh kt b fi kx ky l kz la">&lt;disk type='network' device='disk'&gt;<br/>  &lt;driver name='qemu' type='raw' cache='none'/&gt;<br/>  &lt;auth username='cinder'&gt;<br/>    &lt;secret type='ceph' uuid='secret-uuid'/&gt;<br/>  &lt;/auth&gt;<br/>  &lt;source protocol='rbd' name='cinder_volumes/volume-uuid'&gt;<br/>    &lt;host name='mon_host_ip' port='mon_host_port'/&gt;<br/>  &lt;/source&gt;<br/>  &lt;target dev='vdb' bus='virtio'/&gt;<br/>  &lt;serial&gt;volume-uuid&lt;/serial&gt;<br/>  &lt;alias name='virtio-disk1'/&gt;<br/>  &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x0e' function='0x0'/&gt;<br/>&lt;/disk&gt;</span></pre><h2 id="4804" class="jn jo hh bd jp jq jr js jt ju jv jw jx ja jy jz ka je kb kc kd ji ke kf kg kh bi translated">设置</h2><p id="3324" class="pw-post-body-paragraph ip iq hh ir b is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji km jk jl jm ha bi translated">在新的Ceph集群上创建适当的cinder用户。<strong class="ir hi">用户名必须与现有的Ceph集群cinder用户名</strong>不同(本例中我使用的是“cinder2”)。</p><p id="3d75" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">将以下部分添加到<strong class="ir hi"> cinder.conf </strong></p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="cef8" class="jn jo hh kt b fi kx ky l kz la">[volumes-new]<br/>restore_discard_excess_bytes=True<br/>rbd_secret_uuid=&lt;secret uuid&gt;<br/>rados_connect_timeout=-1<br/>volume_backend_name=new-1<br/>volume_driver=cinder.volume.drivers.rbd.RBDDriver<br/>rbd_store_chunk_size=4<br/>glance_api_version=2<br/>rbd_ceph_conf=/etc/ceph/ceph-new.conf<br/>rbd_pool=cinder_volumes<br/>rbd_flatten_volume_from_snapshot=False<br/>rbd_max_clone_depth=5<br/>rbd_user=cinder2</span></pre><p id="9033" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">用一个<strong class="ir hi">新uuid </strong>替换<strong class="ir hi"> &lt;秘密uuid &gt; </strong>。此uuid必须不同于cinder/libvirt使用的任何现有uuid。</p><p id="abf5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">从新集群的一个mon主机上获取ceph.conf文件，将其作为<strong class="ir hi"> /etc/ceph-new.conf </strong>保存到cinder主机上，并添加以下部分:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="0ef2" class="jn jo hh kt b fi kx ky l kz la">[client.cinder2]<br/>keyring = /etc/ceph/ceph-new.client.cinder2.keyring</span></pre><p id="2843" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">从新的Ceph集群中抓取<strong class="ir hi"> cinder2 </strong>用户的密钥，并保存到<strong class="ir hi">/etc/Ceph/Ceph-new . client . cinder 2 . key ring</strong></p><p id="f503" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在文件中只存储用户的密钥:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="7194" class="jn jo hh kt b fi kx ky l kz la">printf 'key here' &gt; cinder2.key</span></pre><p id="ad7c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">注意:使用<strong class="ir hi"> printf </strong>，因为<strong class="ir hi"> echo </strong>会将一个\n插入到您的文件中，而您不希望这样。</p><p id="50a3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">创建一个新的<strong class="ir hi"> nova-secret.xml </strong>文件，内容如下:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="8144" class="jn jo hh kt b fi kx ky l kz la">&lt;secret ephemeral="no" private="no"&gt;<br/>&lt;uuid&gt;secret uuid here&lt;/uuid&gt;<br/>&lt;usage type="ceph"&gt;<br/>&lt;name&gt;client.cinder2 secret&lt;/name&gt;<br/>&lt;/usage&gt;<br/>&lt;/secret&gt;</span></pre><p id="c676" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">再次插入您在上面创建的<strong class="ir hi"> uuid </strong>。</p><p id="b277" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">接下来，我们需要使用virsh在libvirt中创建秘密并设置密钥:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="f647" class="jn jo hh kt b fi kx ky l kz la">virsh secret-define --file nova-secret.xml<br/>virsh secret-set-value --secret &lt;secret uuid&gt; --base64 $(cat cinder2.key)</span></pre><p id="2065" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">重启cinder-volumes，你就可以开始工作了。您可能希望清理您创建的cinder2.key文件和nova-secret.xml文件。</p><h2 id="9955" class="jn jo hh bd jp jq jr js jt ju jv jw jx ja jy jz ka je kb kc kd ji ke kf kg kh bi translated">就是这样！</h2><p id="0299" class="pw-post-body-paragraph ip iq hh ir b is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji km jk jl jm ha bi translated">你完了！当然，您将需要创建利用新后端的新的cinder卷类型，但这在其他地方已经充分讨论过了。</p><p id="113d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当然，如果你使用的是OpenStack-Ansible，这些步骤在Newton版本中已经自动完成。更多信息，请参考<a class="ae lb" href="http://docs.openstack.org/developer/openstack-ansible-ceph_client/configure-ceph.html#extra-client-configuration-files" rel="noopener ugc nofollow" target="_blank"> Ceph客户角色文件</a>。</p></div></div>    
</body>
</html>