<html>
<head>
<title>Automating Instance Initialization with Terraform on Oracle's Compute Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">借助Oracle计算云上的Terraform实现实例初始化自动化</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/automating-oracle-compute-cloud-instance-initialization-with-terraform-6e66968fe30a?source=collection_archive---------0-----------------------#2017-08-02">https://medium.com/oracledevs/automating-oracle-compute-cloud-instance-initialization-with-terraform-6e66968fe30a?source=collection_archive---------0-----------------------#2017-08-02</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="3e8c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本文概述了可用于自动化实例初始化的不同方法，作为使用Terraform的初始Oracle云基础架构<strong class="ig hi"> Compute Classic </strong>实例资源调配的一部分。</p><p id="3167" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">具体来说，我们将在初始实例资源创建的基础上介绍两个不同的实例初始化和供应选项</p><ul class=""><li id="049f" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">在实例创建期间使用操作系统特定的<strong class="ig hi"> opc-init </strong>或<strong class="ig hi">云-init </strong>配置</li><li id="fc54" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">使用<strong class="ig hi"> Terraform供应器</strong>作为资源供应的一部分</li></ul><p id="5792" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">选择使用哪种方法将取决于特定的资源调配要求。每种方法都有其优点和缺点，两种方法之间的主要区别在于，opc-init/cloud-init方法在创建和启动期间通过云基础设施控制平面将初始化配置直接传递给实例，使实例能够自主处理初始化，而Terraform Provisioner必须连接到正在运行的实例，以在初始实例创建后执行额外的配置任务。这两种方法可以结合起来作为整个供应过程的一部分。</p><h1 id="9a1b" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">使用opc-init进行实例初始化</h1><p id="338b" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated"><a class="ae kt" href="http://docs.oracle.com/en/cloud/iaas/compute-iaas-cloud/stcsg/automating-instance-initialization-using-opc-init.html" rel="noopener ugc nofollow" target="_blank"> opc-init </a>支持默认包含在Oracle为Oracle计算云提供的Oracle Linux和Microsoft Windows机器映像中，并且可以<a class="ae kt" href="http://docs.oracle.com/en/cloud/iaas/compute-iaas-cloud/stcsg/automating-instance-initialization-using-opc-init.html#GUID-A0A107D6-3B38-47F4-8FC8-96D50D99379B" rel="noopener ugc nofollow" target="_blank">整合到自定义映像中</a>。opc-init脚本在启动过程中向元数据服务查询用户数据，然后用于执行所需的预引导任务，包括:</p><ul class=""><li id="4b61" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated"><strong class="ig hi"> Linux </strong> —设置http和https代理，执行预引导脚本，安装yum包，执行Chef供应任务</li><li id="a53d" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated"><strong class="ig hi"> Windows </strong> —配置管理员帐户，创建用户，执行预引导脚本，启用远程管理，启用远程桌面</li></ul><p id="18db" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有关受支持的opc-init实例初始化功能的详细信息，请参见文档<a class="ae kt" href="http://docs.oracle.com/en/cloud/iaas/compute-iaas-cloud/stcsg/automating-instance-initialization-using-opc-init.html#GUID-C63680F1-1D97-4984-AB02-285B17278CC5" rel="noopener ugc nofollow" target="_blank">使用opc-init自动初始化实例</a></p><h1 id="ff02" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">示例:带有opc-init预引导的Oracle Linux实例</h1><p id="5076" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated"><code class="du ku kv kw kx b">opc_compute_instance</code> <code class="du ku kv kw kx b"><a class="ae kt" href="https://www.terraform.io/docs/providers/opc/r/opc_compute_instance.html#attributes" rel="noopener ugc nofollow" target="_blank">instance_attributes</a></code>是一个JSON有效负载，直接传递给Terraform用来创建实例的OPC云启动计划。<a class="ae kt" href="https://en.wikipedia.org/wiki/Here_document" rel="noopener ugc nofollow" target="_blank"> Heredoc </a>符号用于将JSON内容嵌入Terraform HCL配置中。</p><p id="17cf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个例子演示了一个简单的<code class="du ku kv kw kx b">pre-bootstrap</code>供应脚本，它附加到实例<code class="du ku kv kw kx b">motd</code>(每日消息)中。</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><h1 id="76f0" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">示例:带有opc-init预引导的Windows服务器实例</h1><p id="5562" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">此示例使用映像选项配置<code class="du ku kv kw kx b">userdata</code>,以设置初始管理员密码、启用远程桌面并执行从远程URL动态获取的预引导脚本。</p><p id="f16f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这个例子中，我们没有直接在实例资源中创建JSON有效负载字符串，而是使用一个<code class="du ku kv kw kx b"><a class="ae kt" href="https://www.terraform.io/docs/providers/template/d/file.html" rel="noopener ugc nofollow" target="_blank">template_file</a></code>数据源来演示如何传递变量来动态构造定制的有效负载。</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><h1 id="053a" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">使用cloud-init进行实例初始化</h1><p id="0b38" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">Oracle Cloud Marketplace中的几个第三方提供的基本操作系统和应用程序映像提供了cloud-init支持。类似于上面的opc-init示例，在<code class="du ku kv kw kx b">instance_attributes</code>中定义了额外的初始化配置，当创建实例资源时，这些配置被传递给启动计划。cloud-init <code class="du ku kv kw kx b">cloud-config</code>数据是YAML格式的，在<code class="du ku kv kw kx b">userdata</code>属性中传递。</p><p id="7895" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有关支持的<code class="du ku kv kw kx b">cloud-config</code>选项的完整详细信息，请参考映像供应商文档和通用cloud-init规范。</p><p id="7c30" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注意</strong>由于<code class="du ku kv kw kx b">instance_attributes</code>期望一个包含JSON的字符串，所以确保cloud-init <code class="du ku kv kw kx b">cloud-config</code> YAML被正确编码/转义以作为JSON字符串在<code class="du ku kv kw kx b">userdata</code>字段中传递是很重要的。</p><h1 id="bf9f" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">示例:带有cloud-init的Ubuntu实例</h1><p id="ff59" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">我们将再次使用一个简单的示例来更新系统<code class="du ku kv kw kx b">motd</code>。</p><p id="ee09" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本例中，<code class="du ku kv kw kx b">userdata</code>和<code class="du ku kv kw kx b">cloud-config</code>被分成两个独立的模板，以提高可读性。</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><h1 id="fdbf" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">使用Terraform供应器初始化实例</h1><p id="6674" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">Terraform支持几个<a class="ae kt" href="https://www.terraform.io/docs/provisioners/index.html" rel="noopener ugc nofollow" target="_blank">供应器</a>，这些供应器能够在初始实例资源创建后协调其他供应步骤。</p><h1 id="4606" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">示例:带有<code class="du ku kv kw kx b">remote-exec</code>置备程序的Oracle Linux实例</h1><p id="ad2f" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">以上面的同一个例子为例，这次我们使用Terraform Provisioner来执行一个远程命令，更新当天的<code class="du ku kv kw kx b">motd</code>消息。</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="24ee" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意，<code class="du ku kv kw kx b">connection</code>块定义了Terraform如何连接到新创建的实例。为了简单起见，上面的例子使用了一个公开分配的IP地址预留，因此主机是可访问的，并且假设已经定义了<code class="du ku kv kw kx b">For-SSH-access</code>安全列表来允许SSH访问实例。</p><p id="1c78" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于创建的没有公共IP地址的实例，Terraform也支持<a class="ae kt" href="https://www.terraform.io/docs/provisioners/connection.html#connecting-through-a-bastion-host-with-ssh" rel="noopener ugc nofollow" target="_blank">使用SSH通过Bastion主机连接</a>。如果Terraform在同一个计算域中运行，或者可以通过VPN访问该域的共享专用网络，则可以使用实例<code class="du ku kv kw kx b">self.private_ip</code>，或者如果实例是通过专用IP网络上的接口启动的，则可以使用分配给<code class="du ku kv kw kx b">vnic</code>的专用IP。</p><h1 id="a6b0" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">示例:带有<code class="du ku kv kw kx b">remote-exec</code>置备程序的Windows服务器实例</h1><p id="ed04" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">Terraform支持<code class="du ku kv kw kx b">winrm</code>连接来提供基于Windows的实例。请注意，对于Oracle提供的用于Oracle计算云的Microsoft Windows映像，我们需要结合使用<strong class="ig hi"> opc-init </strong>配置，以便设置初始管理员密码和配置<code class="du ku kv kw kx b">winrm</code></p><p id="2d42" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">与上面的“示例:带有opc-init预引导的Windows Server实例”相似，本示例演示了如何运行引导脚本。该示例没有让实例通过远程URL下载引导脚本，而是将脚本从本地环境上传到新实例，然后执行它。</p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="a00c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">必须定义<code class="du ku kv kw kx b">For-WinRM-access</code>安全列表以启用远程管理。用于WS-Management和PowerShell remoting的默认端口分别是用于HTTP和HTTPS连接的<code class="du ku kv kw kx b">5985</code>和<code class="du ku kv kw kx b">5986</code></p><figure class="ky kz la lb fd lc"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="64c9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">继续阅读第二部分</p><div class="lf lg ez fb lh li"><a rel="noopener follow" target="_blank" href="/oracledevs/automating-instance-initialization-with-terraform-on-oracle-cloud-infrastructure-part-2-e1aa1a8710d"><div class="lj ab dw"><div class="lk ab ll cl cj lm"><h2 class="bd hi fi z dy ln ea eb lo ed ef hg bi translated">在Oracle云基础设施上使用Terraform自动化实例初始化:第2部分</h2><div class="lp l"><h3 class="bd b fi z dy ln ea eb lo ed ef dx translated">作为上一篇关于在Oracle计算云上使用Terraform自动化实例初始化的文章的后续…</h3></div><div class="lq l"><p class="bd b fp z dy ln ea eb lo ed ef dx translated">medium.com</p></div></div></div></a></div></div></div>    
</body>
</html>