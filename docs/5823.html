<html>
<head>
<title>OCI Bastion Service : An Alternate way of connecting to your private resources using OCI-CLI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">OCI堡垒服务:使用OCI命令行界面连接到您的私有资源的另一种方式</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/oci-bastion-service-an-alternate-way-of-connecting-to-your-private-resources-using-oci-cli-d9c829685c77?source=collection_archive---------0-----------------------#2021-10-08">https://medium.com/oracledevs/oci-bastion-service-an-alternate-way-of-connecting-to-your-private-resources-using-oci-cli-d9c829685c77?source=collection_archive---------0-----------------------#2021-10-08</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="add6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">OCI堡垒服务是基于Oracle云基础设施(OCI)的完全托管的无服务器产品，可连接到您的Oracle虚拟云网络(VCN)的私有子网中的资源。尽管Bastion服务的功能令人惊叹，但为了确保您有一个会话，您必须在OCI控制台中点击许多菜单选项来创建一个会话，然后才能开始使用您的私有资源。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/b096ba4415f565e5cdfbf6689d4823d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_IVOgi9HyHWKPXT28KLr3A.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">OCI Bastion Service</figcaption></figure><p id="3e9f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有一种替代方法可以做到这一点，即使用OCI命令行实用程序来做同样的事情，而不需要在GUI中跳过这么多选项。</p><p id="5984" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们继续之前，请确保您已经安装了<a class="ae js" href="https://docs.oracle.com/en-us/iaas/Content/API/SDKDocs/cliinstall.htm" rel="noopener ugc nofollow" target="_blank">OCI-CLI</a>，并且<a class="ae js" href="https://docs.oracle.com/en-us/iaas/Content/API/Concepts/apisigningkey.htm#two" rel="noopener ugc nofollow" target="_blank">已经创建了API密匙</a>来以编程方式访问您的OCI帐户。一旦安装了oci-cli并创建了密钥。<a class="ae js" href="https://docs.public.oneportal.content.oci.oraclecloud.com/en-us/iaas/Content/Bastion/Tasks/managingbastions.htm#To_create_a_bastion" rel="noopener ugc nofollow" target="_blank">为您的资源所在的目标子网创建一个堡垒主机服务</a>。我们现在将使用OCI命令行实用程序在堡垒主机上创建一个会话</p></div><div class="ab cl jt ju go jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="ha hb hc hd he"><ol class=""><li id="229f" class="ka kb hh ig b ih ii il im ip kc it kd ix ke jb kf kg kh ki bi translated"><strong class="ig hi">编辑$HOME/。oci/config文件，添加API键并创建您的堡垒主机服务</strong></li></ol><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="2e2d" class="ko kp hh kk b fi kq kr l ks kt">$ cat $HOME/.oci/config </span><span id="4286" class="ko kp hh kk b fi ku kr l ks kt">[DEMO]<br/>user=ocid1.user.oc1..aaaaaaaacvk*******7q<br/>fingerprint=de:50*******:d6<br/>tenancy=ocid1.tenancy.oc1..aaa******l3fq<br/>region=ap-sydney-1<br/>key_file=/Users/shadab/.oci/oci_api_key.pem</span><span id="5cee" class="ko kp hh kk b fi ku kr l ks kt">-- Create the Bastion Host -- </span><span id="a538" class="ko kp hh kk b fi ku kr l ks kt">oci bastion bastion create --bastion-type Standard --compartment-id ocid1.compartment.oc1..aaaaaaaa5o****6cq --target-subnet-id ocid1.subnet.oc1.ap-sydney-1.aaaaaaaao4*****q --client-cidr-list '["0.0.0.0/0"]' --profile DEMO</span><span id="8186" class="ko kp hh kk b fi ku kr l ks kt">-- List the Bastion Service --</span><span id="b9fc" class="ko kp hh kk b fi ku kr l ks kt">oci bastion bastion list --compartment-id ocid1.compartment.oc1..aaaaaa*******q --profile DEMO  --all</span></pre><p id="381b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 2。创建一个样本JSON响应文件来创建一个堡垒会话</strong></p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="3ebf" class="ko kp hh kk b fi kq kr l ks kt">oci bastion session create-port-forwarding --generate-full-command-json-input</span></pre><p id="bbe2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 3。定制在步骤2中生成的JSON文件。用你输入的参数并保存到一个文件bastion_input.json </strong></p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="92a7" class="ko kp hh kk b fi kq kr l ks kt">{<br/>"bastionId": "ocid1.bastion.oc1.ap-sydney-1.amaaaaaaeetb******4q",<br/>"definedTags": {<br/>"tagNamespace1": {<br/>"tagKey1": "tagValue1",<br/>"tagKey2": "tagValue2"<br/>},<br/>"tagNamespace2": {<br/>"tagKey1": "tagValue1",<br/>"tagKey2": "tagValue2"<br/>}<br/>},<br/>"displayName": "Shadab-SSH-Session-Bastion",<br/>"freeformTags": {<br/>"tagKey1": "tagValue1",<br/>"tagKey2": "tagValue2"<br/>},<br/>"keyType": "PUB",<br/>"maxWaitSeconds": 0,<br/>"sessionTtl": "10800",<br/>"sshPublicKeyFile": "/Users/shadab/Downloads/Keys/publickey.pub",<br/>"targetPort": "22",<br/>"targetPrivateIp": "10.43.0.34",<br/>"targetResourceId": "ocid1.instance.oc1.ap-sydney-1.anzxsl******tlq",<br/>"waitForState": [<br/>"SUCCEEDED"<br/>],<br/>"waitIntervalSeconds": 20<br/>}</span></pre><p id="3175" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 4。从oci-cli创建端口转发会话</strong></p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="6642" class="ko kp hh kk b fi kq kr l ks kt">oci bastion session create-port-forwarding --from-json file://bastion_input.json --profile DEMO</span></pre><p id="3fb3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这现在提供了一个会话来连接到远程主机上的端口22。</p><p id="d09f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">另一个常用的例子是为OCI上的私有Windows主机创建端口转发会话。</p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="0e23" class="ko kp hh kk b fi kq kr l ks kt">{<br/>"bastionId": "ocid1.bastion.oc1.ap-sydney-1.amaaaaaaeetb5t****p4q",<br/>"definedTags": {<br/>"tagNamespace1": {<br/>"tagKey1": "tagValue1",<br/>"tagKey2": "tagValue2"<br/>},<br/>"tagNamespace2": {<br/>"tagKey1": "tagValue1",<br/>"tagKey2": "tagValue2"<br/>}<br/>},<br/>"displayName": "Shadab-Windows-Session-Bastion",<br/>"freeformTags": {<br/>"tagKey1": "tagValue1",<br/>"tagKey2": "tagValue2"<br/>},<br/>"keyType": "PUB",<br/>"maxWaitSeconds": 0,<br/>"sessionTtl": "10800",<br/>"sshPublicKeyFile": "/Users/shadab/Downloads/Keys/publickey.pub",<br/>"targetPort": "3389",<br/>"targetPrivateIp": "10.43.0.39",<br/>"targetResourceId": "ocid1.instance.oc1.ap-sydney-1.anzxsljreetb5*****yz2q",<br/>"waitForState": [<br/>"SUCCEEDED"<br/>],<br/>"waitIntervalSeconds": 20<br/>}</span></pre><p id="cdb1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在启动端口3389 (Windows RDP端口)的第二个会话</p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="20e3" class="ko kp hh kk b fi kq kr l ks kt">oci bastion session create-port-forwarding --from-json file://bastion_windows.json --profile DEMO</span></pre><p id="5568" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 5。现在会话已经创建，让我们获取会话ID等会话详细信息，并查看我们需要在本地机器上运行的会话SSH命令，以创建端口转发</strong></p><p id="2c1c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要列出以编程方式创建的最新会话的会话ID，请运行</p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="a062" class="ko kp hh kk b fi kq kr l ks kt">oci bastion session list --bastion-id ocid1.bastion.oc1.ap-sydney-1.amaaaaaaee*******p4q --session-lifecycle-state ACTIVE --sort-order asc --profile DEMO --all</span></pre><p id="dc53" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在JSON输出中，特定会话的会话id将是“ID”标记</p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="2960" class="ko kp hh kk b fi kq kr l ks kt">“id”: “ocid1.bastionsession.oc1.ap-sydney-1.amaaaaaaee***********2gda”</span></pre><p id="55c9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 6。使用通过运行之前的命令获得的会话id，输入会话ID并输出会话详细信息</strong></p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="bf40" class="ko kp hh kk b fi kq kr l ks kt">oci bastion session get --session-id ocid1.bastionsession.oc1.ap-sydney-1.amaaaaaaeetb*********pa --profile DEMO</span></pre><p id="c6fc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">上述命令的输出将列出SSH命令，您将使用该命令创建端口转发</p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="26d1" class="ko kp hh kk b fi kq kr l ks kt">“ssh-metadata”: {<br/> “command”: “ssh -i &lt;privateKey&gt; -N -L &lt;localPort&gt;:10.43.0.39:3389 -p 22 ocid1.bastionsession.oc1.ap-sydney-1.amaaaaaa***********gda@host.bastion.ap-sydney-1.oci.oraclecloud.com”<br/> }</span></pre><p id="f461" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 7。最后，在您的客户机上运行本地端口转发来连接您的私有实例</strong></p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="43ff" class="ko kp hh kk b fi kq kr l ks kt">-- Linux SSH port forwarding --<br/>ssh -i privatekeyfile.key -N -L 2222:10.43.0.34:22 -p 22 ocid1.bastionsession.oc1.ap-sydney-1.amaaaaaa***********gda@host.bastion.ap-sydney-1.oci.oraclecloud.com</span><span id="0bf1" class="ko kp hh kk b fi ku kr l ks kt">-- Windows RDP Port Forwarding --<br/>ssh -i privatekeyfile.key -N -L 8933:10.43.0.39:3389 -p 22 ocid1.bastionsession.oc1.ap-sydney-1.amaaaaaa***********gda@host.bastion.ap-sydney-1.oci.oraclecloud.com</span></pre></div><div class="ab cl jt ju go jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="ha hb hc hd he"><h2 id="80a9" class="ko kp hh bd kv kw kx ky kz la lb lc ld ip le lf lg it lh li lj ix lk ll lm ln bi translated">最后，所有命令都可以放在几个简单的shell脚本中，以生成可重用的代码来为您的私有资源生成端口转发会话</h2><p id="1a8f" class="pw-post-body-paragraph ie if hh ig b ih lo ij ik il lp in io ip lq ir is it lr iv iw ix ls iz ja jb ha bi translated"><strong class="ig hi"> A .创建堡垒主机:</strong><em class="lt">ocibastioncreatebastion . sh</em></p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="a814" class="ko kp hh kk b fi kq kr l ks kt">#!/bin/bash<br/>export bastion_type=Standard<br/>export compartment_id=ocid1.compartment.oc1..aaaaaaaa******bpi6cq<br/>export target_subnet_id=ocid1.subnet.oc1.ap-sydney-1.aaaaaaaao*******nbnnq<br/>export profile=DEMO<br/>export cidr_allow='["0.0.0.0/0"]'<br/>oci bastion bastion create --bastion-type $bastion_type --compartment-id $compartment_id --target-subnet-id $target_subnet_id --client-cidr-list $cidr_allow --profile $profile</span></pre><p id="cf90" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">输出</strong></p><p id="18fc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">。/OciBastionCreateBastion.sh</p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="ed73" class="ko kp hh kk b fi kq kr l ks kt">{<br/>  "data": {<br/>    "bastion-type": "STANDARD",<br/>    "client-cidr-block-allow-list": [<br/>      "0.0.0.0/0"<br/>    ],<br/>    "compartment-id": "ocid1.compartment.oc1..aaaaaaaa*****q",<br/>    "defined-tags": {<br/>      "Oracle-Tags": {<br/>        "CreatedBy": "email<a class="ae js" href="mailto:shadab.mohammad@oracle.com" rel="noopener ugc nofollow" target="_blank">@acme.com</a>",<br/>        "CreatedOn": "2021-10-10T08:17:13.489Z"<br/>      }<br/>    },<br/>    "freeform-tags": {},<br/>    "id": "ocid1.bastion.oc1.ap-sydney-1.amaaaaaa*******42q",<br/>    "lifecycle-details": null,<br/>    "lifecycle-state": "CREATING",<br/>    "max-session-ttl-in-seconds": 10800,<br/>    "max-sessions-allowed": 20,<br/>    "name": "bastion20211010081715",<br/>    "phone-book-entry": null,<br/>    "private-endpoint-ip-address": null,<br/>    "static-jump-host-ip-addresses": null,<br/>    "system-tags": {},<br/>    "target-subnet-id": "ocid1.subnet.oc1.ap-sydney-1.aaaaaaaao*********bnnq",<br/>    "target-vcn-id": "ocid1.vcn.oc1.ap-sydney-1.amaaaa*********vq",<br/>    "time-created": "2021-10-10T08:17:16.177000+00:00",<br/>    "time-updated": "2021-10-10T08:17:16.177000+00:00"<br/>  },<br/>  "opc-work-request-id": "ocid1.bastionworkrequest.oc1.ap-sydney-1.amaaaaaa******a"<br/>}</span></pre><p id="85f0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> B .创建会话:</strong><em class="lt">ocibastioncreatesession . sh</em></p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="51fb" class="ko kp hh kk b fi kq kr l ks kt">#!/bin/bash<br/>export bastion_id=ocid1.bastion.oc1.ap-sydney-1.amaaaaaa*****4q<br/>export profile=DEMO<br/>export path=file://bastion_input.json<br/>export path2=file://bastion_windows.json<br/>oci bastion session create-port-forwarding --from-json $path --profile $profile<br/>oci bastion session create-port-forwarding --from-json $path2 --profile $profile</span></pre><p id="7d27" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> C .列表会话:</strong><em class="lt">ocibastionlistsession . sh</em></p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="a39e" class="ko kp hh kk b fi kq kr l ks kt">#!/bin/bash<br/>export bastion_id=ocid1.bastion.oc1.ap-sydney-1.amaaaaaa*********qp4q<br/>export profile=DEMO<br/>oci bastion session list --bastion-id $bastion_id --session-lifecycle-state ACTIVE --sort-order asc --profile $profile --all</span></pre><p id="d32f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> D .获取会话详细信息:</strong><em class="lt">ocibastiongetsession . sh</em></p><pre class="jd je jf jg fd kj kk kl km aw kn bi"><span id="d6bf" class="ko kp hh kk b fi kq kr l ks kt">#!/bin/zsh<br/>export session_id=$1<br/>export profile=demo</span><span id="270b" class="ko kp hh kk b fi ku kr l ks kt">oci bastion session get --session-id $session_id --profile $profile | grep -i command | grep -o 'ssh -i.*' | sed -e 's|&lt;privateKey&gt;|/Users/shadab/.oci/ZDM5/mydemo_vcn.priv|g;s|\\||g;s/\"$//' &gt; output<br/>chmod +x output<br/>zsh output</span></pre></div><div class="ab cl jt ju go jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="ha hb hc hd he"><p id="0a1e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">进一步阅读</strong> <br/> OCI堡垒服务<a class="ae js" href="https://docs.public.oneportal.content.oci.oraclecloud.com/en-us/iaas/Content/Bastion/Concepts/bastionoverview.htm" rel="noopener ugc nofollow" target="_blank">https://docs . public . oneportal . Content . OCI . Oracle cloud . com/en-us/iaas/Content/Bastion/Concepts/Bastion overview . htm</a></p></div></div>    
</body>
</html>