<html>
<head>
<title>Running Chaos-Engineering experiments against a Kubernetes clusters</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">对Kubernetes星团进行混沌工程实验</h1>
<blockquote>原文：<a href="https://medium.com/globant/running-chaos-engineering-experiments-against-a-kubernetes-clusters-b7909035d069?source=collection_archive---------0-----------------------#2020-10-03">https://medium.com/globant/running-chaos-engineering-experiments-against-a-kubernetes-clusters-b7909035d069?source=collection_archive---------0-----------------------#2020-10-03</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="91b9" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">并通过pdf提供冷输出</h2></div><p id="dd00" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">对于那些不熟悉混沌工程实践的人来说，混沌是一门在生产中对软件系统进行实验的学科，目的是建立对系统承受动荡和意外条件的能力的信心。</p><p id="54bc" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这些实践已经被许多公司证明和采用，以便了解你的系统如何工作，测试可靠性，模拟DoS，引入网络故障等。</p><h2 id="c2fc" class="js jt hh bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">可用工具</h2><p id="63f1" class="pw-post-body-paragraph iw ix hh iy b iz kn ii jb jc ko il je jf kp jh ji jj kq jl jm jn kr jp jq jr ha bi translated">为了执行混沌工程，你可以开发你自己的脚本或软件来执行你的实验。但是让我与您分享一些有趣的工具来执行它:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es ks"><img src="../Images/0f23d6a52fbeba3a18e0030c272a4e57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*klahbfsl76zT27CsH6g4ZQ.png"/></div></div></figure><blockquote class="le lf lg"><p id="89a8" class="iw ix lh iy b iz ja ii jb jc jd il je li jg jh ji lj jk jl jm lk jo jp jq jr ha bi translated">Pumba，Grembling，混沌猴，强力封印，kube-monkey，石蕊，Gloo射击，混沌工具包</p></blockquote><p id="35a3" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在这篇文章中，我们将使用混沌工具包，因为它是开源和多平台的。</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es ll"><img src="../Images/b34cc57e09b398241e27459dff1bd440.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*itAaPf6dmh1loQRv6QBrYg.png"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx">Chaos Toolkit under the hood</figcaption></figure><h2 id="1ea5" class="js jt hh bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">混沌工程过程</h2><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lq"><img src="../Images/f8527b61b370a6eeb8dc7cc3b1482e03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yHcXR2zKQiSoJ0yu.png"/></div></div></figure><p id="2bf9" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当我们谈论混沌实验时，记住整个生态系统的“可观察性”是非常重要的。通过这样做，你将能够理解你正在做的实验(原因/结果),并允许你从实验中“学习”。</p><p id="c27f" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在开始做实验之前，准备好监控混沌实验的合适工具是关键条件。</p><h2 id="2801" class="js jt hh bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">设置环境</h2><pre class="kt ku kv kw fd lr ls lt lu aw lv bi"><span id="64e9" class="js jt hh ls b fi lw lx l ly lz">$ python3 -m venv ~/.venvs/chaostk</span></pre><p id="ec93" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">进入环境:</p><pre class="kt ku kv kw fd lr ls lt lu aw lv bi"><span id="1e39" class="js jt hh ls b fi lw lx l ly lz">$ source ~/.venvs/chaostk/bin/activate<!-- --> </span></pre><p id="2fd0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">安装混沌工具包+混沌工具包Kubernetes插件:</p><pre class="kt ku kv kw fd lr ls lt lu aw lv bi"><span id="579a" class="js jt hh ls b fi lw lx l ly lz">$ pip install -U chaostoolkit</span><span id="4f20" class="js jt hh ls b fi ma lx l ly lz">$ pip install -U chaostoolkit-kubernetes</span></pre><p id="9990" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">安装完chaostoolkit-kubernetes插件后，它将为您提供许多可以用来创建实验的功能。<br/>在我的例子中，我将使用:<strong class="iy hi">all _ micro services _ healthy</strong>来验证假设，使用<strong class="iy hi"> terminate_pods </strong>和一个参数<strong class="iy hi"> rand: true </strong>来终止名称空间中的任何pod，在我的例子中是<strong class="iy hi"> ns: go-demo-8。</strong></p><p id="a787" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">下面你会看到我的实验是什么样子的</p><p id="e3c9" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">注意:在<a class="ae mb" href="https://docs.chaostoolkit.org/" rel="noopener ugc nofollow" target="_blank">https://docs.chaostoolkit.org/</a>下，你可以找到很多其他的功能</p><h2 id="7936" class="js jt hh bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">实验</h2><p id="9fb5" class="pw-post-body-paragraph iw ix hh iy b iz kn ii jb jc ko il je jf kp jh ji jj kq jl jm jn kr jp jq jr ha bi translated">关键阶段:</p><p id="0228" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi">1-版本、标题、标签(用于识别实验的描述性部分)<em class="lh"> <br/> 2-假设(您定义一个探针来验证您的稳定状态)<br/> 3-实验(在方法下，您将描述您想要测试的内容，在我的情况下，杀死一个随机pod) <br/> 4-回滚(如果有，在我的情况下，由于集群的自我修复，我还没有定义任何内容)</em> </strong></p><pre class="kt ku kv kw fd lr ls lt lu aw lv bi"><span id="45d8" class="js jt hh ls b fi lw lx l ly lz">version: 1.0.0<br/>title: What happens if we terminate an instance of the application?<br/>description: If an instance of the application is terminated, a new instance should be created<br/>tags:<br/>- k8s<br/>- pod<br/>- deployment<br/>steady-state-hypothesis:<br/>  title: The app is healthy<br/>  probes:<br/>  - name: all-apps-are-healthy<br/>    type: probe<br/>    tolerance: true<br/>    provider:<br/>      type: python<br/>      func: all_microservices_healthy<br/>      module: chaosk8s.probes<br/>      arguments:<br/>        ns: go-demo-8<br/>method:<br/>- type: action<br/>  name: terminate-app-pod<br/>  provider:<br/>    type: python<br/>    module: chaosk8s.pod.actions<br/>    func: terminate_pods<br/>    arguments:<br/>      # label_selector: app=go-demo-8<br/>      rand: true<br/>      ns: go-demo-8<br/>  pauses:<br/>    after: 10</span></pre><p id="5dc2" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">本实验旨在:</p><p id="16c0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">1-在K8s集群上运行<br/> 2-将使用函数“all_microservices_healthy”来验证我们的假设<br/> 3-杀死命名空间下的随机Pod:go-demo-8</p><h2 id="2370" class="js jt hh bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">如何运行您的实验？</h2><pre class="kt ku kv kw fd lr ls lt lu aw lv bi"><span id="2d8b" class="js jt hh ls b fi lw lx l ly lz">$ chaos run terminate-pod-rand.yaml</span></pre><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mc"><img src="../Images/283dd4ff92e8b1a48c26a830216ede14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y7nxA8r2Pb8YLAUwXRTfGg.png"/></div></div></figure><h2 id="a68c" class="js jt hh bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">我们应该在哪里进行实验？</h2><p id="1801" class="pw-post-body-paragraph iw ix hh iy b iz kn ii jb jc ko il je jf kp jh ji jj kq jl jm jn kr jp jq jr ha bi translated"><strong class="iy hi"> <em class="lh">应用层<br/> </em> </strong>你的代码有特性，有行为，有流程。试试看。</p><p id="2e94" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi"> <em class="lh">缓存层<br/> </em> </strong>现代应用越来越依赖缓存。如果缓存不可用怎么办？如果事务/操作因缓存层问题而受到影响，会发生什么情况？</p><p id="a8fe" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi"> <em class="lh">数据库层<br/> </em> </strong>关闭数据库，放松一下，看看会发生什么。</p><p id="6bc0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iy hi"> <em class="lh">云层<br/></em></strong>2020年，许多数字平台依赖云提供商，因此您可能会受到许多问题的影响:EC2s不稳定、AZs降级、网络延迟等。因此，在我们的实验中观察整个平台的行为是很有趣的。</p><h2 id="6c68" class="js jt hh bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">做完实验后，我们应该做什么？</h2><p id="3be8" class="pw-post-body-paragraph iw ix hh iy b iz kn ii jb jc ko il je jf kp jh ji jj kq jl jm jn kr jp jq jr ha bi translated">基本上有些答案是“生成报告”或“自动化纠正措施”，但如何做到这一点呢？</p><p id="96d8" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">混沌工具包有它的答案，答案是:你必须生成一个“日志”。</p><pre class="kt ku kv kw fd lr ls lt lu aw lv bi"><span id="d36b" class="js jt hh ls b fi lw lx l ly lz">$ <!-- -->chaos run terminate-pod.yaml — journal-path test.json</span></pre><p id="6e9c" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">因此test.json应该是实验的输出，看起来应该是这样的:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mc"><img src="../Images/46701937f55fb2eceeb100611612ca3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x5VgPNMa0H-IWFH6wQUoPg.png"/></div></div></figure><p id="bc57" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">正如您可能看到的JSON，它有一个人可读的输出，但它不是一个友好的输出。</p><p id="5532" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果你试图使用一台机器来采取行动，这是可以的。但是，如果你需要向你的经理提交一份很好的报告，以便让另一个团队开始解决你在做混沌实验时可能发现的问题，那该怎么办呢？</p><h2 id="7584" class="js jt hh bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">在PDF上生成混沌工程报告</h2><p id="3817" class="pw-post-body-paragraph iw ix hh iy b iz kn ii jb jc ko il je jf kp jh ji jj kq jl jm jn kr jp jq jr ha bi translated">通过使用chaos toolkit报告工具，您可以创建一个非常漂亮的PDF报告。该工具采用docker格式，因此如果您熟悉它，可以使用:</p><pre class="kt ku kv kw fd lr ls lt lu aw lv bi"><span id="d84c" class="js jt hh ls b fi lw lx l ly lz">$ <!-- -->docker container run \<br/>    --user $(id -u) \ <br/>    --volume $PWD:/tmp/result \<br/>    -it \<br/>    chaostoolkit/reporting \<br/>     -- report \<br/>     --export-format=pdf \<br/>    Test.json \<br/>    report.pdf</span></pre><p id="1ca4" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在docker接收到您的日志(test.json)后，它将生成report.pdf，并输出您的实验，如下所示:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es md"><img src="../Images/21896ab13110c4bd6e5937009c6bee52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WnUNQf6nu1wvBxlmsK2nzg.png"/></div></div></figure><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es me"><img src="../Images/3a07f514e4d56ae36a99241eaa9b13bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*atCL4xpk_oh4sE3gN10ADA.png"/></div></div></figure><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mf"><img src="../Images/24a06e1910a59600fce0bbcffe5280a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W7_lFGE2Sq8YnimmVaQpdA.png"/></div></div></figure><p id="e0ba" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在这里，您可以看到运行实验的实际环境，通过kubectl实验和chaos toolkit CLI输出进行监控</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mg"><img src="../Images/dfb2c71cbf00d9ee819fdfd23f23b374.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uQwb8sahRVLmbecd2muEqg.png"/></div></div></figure><p id="2b2e" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">请记住，混沌的最后一个想法是在生产中进行实验以提高可靠性，了解我们的应用程序以生成剧本、运行手册并开发所需的IT适应性，例如处理网络星期一、黑色星期五或在我们的平台上面临未知的干扰问题。</p><p id="323e" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果你正在寻找更多混乱的例子，如测试istio，增加集群的网络延迟或类似的，给我留言，我会单独发给你</p><p id="5e65" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">希望这有助于开始改进您的应用程序。</p><p id="e2e8" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">帕布罗！</p><h2 id="477a" class="js jt hh bd ju jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km bi translated">链接</h2><div class="mh mi ez fb mj mk"><a href="https://chaostoolkit.org/" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab dw"><div class="mm ab mn cl cj mo"><h2 class="bd hi fi z dy mp ea eb mq ed ef hg bi translated">混沌工具包</h2><div class="mr l"><h3 class="bd b fi z dy mp ea eb mq ed ef dx translated">探索建立你自己的混沌工程实验的最简单和最容易的方法。</h3></div><div class="ms l"><p class="bd b fp z dy mp ea eb mq ed ef dx translated">chaostoolkit.org</p></div></div></div></a></div><div class="mh mi ez fb mj mk"><a href="https://github.com/chaostoolkit" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab dw"><div class="mm ab mn cl cj mo"><h2 class="bd hi fi z dy mp ea eb mq ed ef hg bi translated">混沌工具包</h2><div class="mr l"><h3 class="bd b fi z dy mp ea eb mq ed ef dx translated">解散GitHub是超过5000万开发者一起工作的家。加入他们，发展您自己的开发团队…</h3></div><div class="ms l"><p class="bd b fp z dy mp ea eb mq ed ef dx translated">github.com</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my lc mk"/></div></div></a></div></div></div>    
</body>
</html>