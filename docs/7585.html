<html>
<head>
<title>The ‘A’ in DBA should stand for Automation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DBA中的“A”应该代表自动化</h1>
<blockquote>原文：<a href="https://medium.com/version-1/the-a-in-dba-should-stand-for-automation-dc247b107680?source=collection_archive---------0-----------------------#2022-08-19">https://medium.com/version-1/the-a-in-dba-should-stand-for-automation-dc247b107680?source=collection_archive---------0-----------------------#2022-08-19</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/b9c80fd7b642a61e83907d68441a48ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3P6G-repij30cEryb3YuJw.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">One of the functions I created, which fully automates SQL Server installation</figcaption></figure><p id="cb2e" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">我已经做了6年多的数据库管理员(DBA)，都是用<a class="ae jr" href="https://medium.com/version-1" rel="noopener">版本1 </a>做的——我热爱我的工作。但是有些任务可能不如其他任务有趣。主要“罪魁祸首”是；</p><ul class=""><li id="44ba" class="js jt hh iv b iw ix ja jb je ju ji jv jm jw jq jx jy jz ka bi translated">数据库修补</li><li id="2936" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq jx jy jz ka bi translated">数据库安装和配置</li></ul><p id="8d57" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这些是我们作为DBA最常见的一些任务，当您不得不做很多这些任务时，就会变得非常重复。在过去两年左右的时间里，我开发了PowerShell脚本来为Oracle和SQL Server自动执行这些任务。在这篇博文中，我将会介绍:</p><ol class=""><li id="6efe" class="js jt hh iv b iw ix ja jb je ju ji jv jm jw jq kg jy jz ka bi translated">手动操作需要多长时间</li><li id="e5ab" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">通过自动化节省的时间</li><li id="d52e" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">每个脚本的功能摘要。</li></ol><h1 id="0a3a" class="kh ki hh bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">有问题的流程</h1><p id="f8d9" class="pw-post-body-paragraph it iu hh iv b iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm lj jo jp jq ha bi translated">为了让非DBA了解这些过程通常需要多长时间，下面是对每个过程的粗略估计；</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div class="er es lk"><img src="../Images/cef7cbb89b645cbec6b928610c28ad62.png" data-original-src="https://miro.medium.com/v2/resize:fit:638/format:webp/1*l5fmHlm20BbipvKW35Ok8g.png"/></div></figure><p id="5609" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">多久安装一次？</strong></p><p id="0331" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">安装频率因客户而异，但对于我目前工作的客户，我们平均每个月安装3到4次SQL Server，大约每个月安装1到2次Oracle。粗略估计一下这需要多少时间；</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div class="er es lp"><img src="../Images/9cb0557c81b0a105f308bf68a87ae37e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*SKmPlGC1OFwCP_3zS6gyGw.png"/></div></figure><p id="25d3" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这相当于平均每年在安装上总共花费60天。</p><p id="ab02" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">与我合作的客户在2021年也有一个Oracle升级项目，他们拥有的127个Oracle实例中的大部分都迁移到了Oracle 19c，每个实例都需要在新的服务器上进行新的安装。在升级项目期间，Oracle安装脚本为我们节省了100多天的手动工作。</p><p id="f51d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">多久打一次补丁？</strong></p><p id="a0e8" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">同样，这将因客户而异。对于我工作的客户，我们每半年应用一次Oracle补丁，每季度应用一次SQL Server补丁。该客户有127个Oracle数据库和355个SQL Server实例。如果这些是手动修补的，花费的时间将是；</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div class="er es lq"><img src="../Images/4141392fdd67bce4dbe719e474b5caf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/1*o6XNUTjnBqOmBkg2kbOdlw.png"/></div></figure><p id="4f39" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这相当于每年总共964个小时，或者说是惊人的128个工作日——仅仅花在修补房屋上。这个时间不包括发送电子邮件，与用户一起组织停机时间，或测试以确保应用程序在修补后仍能正常工作。</p><h1 id="c09f" class="kh ki hh bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">解决方案:自动化</h1><p id="56ce" class="pw-post-body-paragraph it iu hh iv b iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm lj jo jp jq ha bi translated">任何开发人员都会告诉你，当你有一个重复的和/或耗时的任务时，你应该尝试自动化它。这就是我对上述每一项任务所做的。我使用PowerShell开发脚本，因为我们客户的资产几乎完全托管在Windows上，包括Oracle数据库。PowerShell非常适合在Windows上实现自动化，从Windows Server 2008 R2 SP1 开始，它默认安装在每个版本的Windows <a class="ae jr" href="https://docs.microsoft.com/en-us/powershell/scripting/windows-powershell/install/installing-windows-powershell?view=powershell-7.1#:~:text=Windows%20PowerShell%20comes%20installed%20by,Installing%20PowerShell%20Core%20on%20Windows" rel="noopener ugc nofollow" target="_blank">上</a></p><p id="7fbc" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">上述任务的自动化大大减少了我们在这些任务上花费的时间。下表显示了与手动操作相比，每项操作所用的新时间；</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lr"><img src="../Images/4e557e5486bc5d635f19c6f4b5977039.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5JA5zNOXsJje0YUjdUhGdg.png"/></div></div></figure><p id="17d8" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">如您所见，自动化这些流程为我们节省了大量时间。当然，这些都是粗略的估计，但这只是为了让您了解我们通过自动化节省了多少时间。这里有一个条形图来进一步展示节省的时间SQL修补时间很少出现在这个范围内；</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ls"><img src="../Images/824f6a423730a9a0d1ced4e5be4597b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JtLcxFuJdhZ0sg7nU9IbSA.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Bar chart for days spent on each task per year.</figcaption></figure><p id="a0d0" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">下面是每个脚本的简要总结。每个脚本都有广泛的日志记录和错误检查，在执行过程中向用户显示，并保存到日志文件中，以便以后查看。</p><h1 id="033d" class="kh ki hh bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">SQL Server修补</h1><p id="5c09" class="pw-post-body-paragraph it iu hh iv b iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm lj jo jp jq ha bi translated">这个脚本是最节省我们时间的一个。向该函数传递一个服务器列表，它将在遍历列表时并发处理X个(缺省值为5个)服务器。对于每个服务器，该脚本将:</p><ol class=""><li id="2a03" class="js jt hh iv b iw ix ja jb je ju ji jv jm jw jq kg jy jz ka bi translated">自动获取要修补的实例的SQL Server版本</li><li id="40c9" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">从给定的文件共享中获取适用于该版本的最新补丁</li><li id="15c6" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">上传并应用补丁</li><li id="7c7d" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">必要时重新启动服务器</li><li id="7029" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">为每台服务器创建大量日志，并在所有修补完成后，将摘要报告和日志一起发送到指定的电子邮件。</li></ol><p id="7451" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">示例用法；</p><pre class="ll lm ln lo fd lt lu lv lw aw lx bi"><span id="3c83" class="ly ki hh lu b fi lz ma l mb mc">Install-SPMultipleSqlPatches -Servers “Server1”, “Server2”, “Server3” -PatchFileDirectory “C:\SQLPatchDir\”</span></pre><p id="4685" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">其中“修补文件目录”是存储所有SQL Server修补程序的位置。该命令将同时修补所有三台给定的服务器。</p><p id="c50e" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">该功能可以通过任务调度器作业进行调度，因此不需要DBA干预。例如，您可以将其计划为每月运行一次—如果在给定的共享中找到更新的适用修补程序，脚本将仅对列表中的服务器执行某些操作—因此DBA只需向共享中添加更新的修补程序，当脚本再次运行时，它将应用任何新的修补程序。它与SQL Server 2008及更高版本兼容。</p><h1 id="688f" class="kh ki hh bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">Oracle补丁</h1><p id="d117" class="pw-post-body-paragraph it iu hh iv b iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm lj jo jp jq ha bi translated">该脚本完全自动化了Windows上Oracle的修补过程。您可以向该函数传递服务器名和要修补的Oracle主目录的路径，脚本会完成剩下的工作。步骤是:</p><ol class=""><li id="b0b3" class="js jt hh iv b iw ix ja jb je ju ji jv jm jw jq kg jy jz ka bi translated">检测主目录的Oracle版本</li><li id="e2bf" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">从我们的共享中获取该版本的最新适用补丁</li><li id="7106" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">在服务器上更新OPatch</li><li id="4348" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">停止从该主目录运行的所有数据库、服务和进程</li><li id="3022" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">修补房屋</li><li id="2397" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">在升级模式下打开数据库并运行datapatch</li><li id="9edf" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">在打开模式下重新启动数据库</li><li id="9e5c" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">确认补丁程序已经应用到主目录和主目录中的每个数据库。</li></ol><p id="bc6f" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">该脚本适用于Oracle 11g及更高版本。由于Oracle修补程序偶尔会有独特的步骤，并且不像SQL Server修补程序那样可预测，因此该脚本通常不会被安排在后台自动运行。DBA通常会在通读补丁自述文件并确保它不包含任何额外步骤后开始。用户为它提供主机名和要修补的主目录，并可以在脚本执行这些步骤时监视它。</p><p id="f405" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">示例用法；</p><pre class="ll lm ln lo fd lt lu lv lw aw lx bi"><span id="af49" class="ly ki hh lu b fi lz ma l mb mc">Install-v1OraclePatch -TargetServer “ORAHOST01” -OracleHome “D:\Oracle\ora19\dbhome_1”</span></pre><h1 id="8da2" class="kh ki hh bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">SQL Server安装</h1><p id="86a4" class="pw-post-body-paragraph it iu hh iv b iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm lj jo jp jq ha bi translated">此脚本完全自动在Windows上安装SQL Server。现在，安装只需15分钟，而且完全自动化，而手动安装需要一整天，因此该脚本为每个实例节省了大约1天的工作时间。该脚本还改进了数据库标准，因为它确保所有新实例都是相同的，在设置过程中不会遗漏任何东西，并且所有参数都是按照最佳实践设置的。该脚本在被调用时执行以下任务；</p><ol class=""><li id="2391" class="js jt hh iv b iw ix ja jb je ju ji jv jm jw jq kg jy jz ka bi translated">在服务器上执行先决条件检查，以确保安装可以继续进行</li><li id="dbb0" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">上传并在服务器上安装SSMS和SQL Server。SQL Server版本通过参数传递，可以是SQL Server 2016及更高版本的任何版本。如果环境是生产环境，则安装企业版；如果是非生产环境，则安装开发人员版。</li><li id="5631" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">根据最佳实践设置几个SQL Server参数</li><li id="4e45" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">根据最佳实践配置临时数据库</li><li id="c67e" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">设置SQL Server维护作业，如数据库备份、索引优化、完整性检查、更新数据库统计信息等。</li><li id="74c0" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">设置一个监视数据库和作业，它将监视和记录实例上所有数据库的活动会话，这对将来的调查非常有用</li><li id="2d81" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">对实例应用最新的适用补丁程序。</li><li id="d9d8" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">生成新实例的报告，并将其与详细的日志一起发送到团队的电子邮件地址以供审查。</li></ol><p id="a762" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">示例用法；</p><pre class="ll lm ln lo fd lt lu lv lw aw lx bi"><span id="990d" class="ly ki hh lu b fi lz ma l mb mc">Install-v1SqlServer -TargetComputer “SQLHOST01” -InstanceName “SQLPRD01” -Environment “Production” -SqlVersion 2019</span></pre><p id="dd18" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">这将在SQLHOST01上上传并安装SQL Server 2019企业版，实例名为SQLPRD01。它将执行上述所有步骤。</p><h1 id="c41e" class="kh ki hh bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">Oracle安装</h1><p id="75a3" class="pw-post-body-paragraph it iu hh iv b iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm lj jo jp jq ha bi translated">该脚本完全自动化了Oracle在Windows上的安装。安装大约需要60分钟，而手动安装需要一整天。与SQL Server脚本一样，这也提高了我们的标准，因为它使每个新的安装都完全相同，并且符合我们的标准。该脚本在被调用时执行以下任务；</p><ol class=""><li id="a72c" class="js jt hh iv b iw ix ja jb je ju ji jv jm jw jq kg jy jz ka bi translated">在服务器上执行先决条件检查，以确保安装可以继续进行</li><li id="8dfd" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">上传并安装指定的Oracle软件(适用于18c+)</li><li id="572e" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">除非在调用脚本时另行指定，否则使用默认设置配置Oracle侦听器。</li><li id="09ac" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">给家里安装最新的补丁</li><li id="c903" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">如果在调用脚本时指定了CDBName，那么使用符合我们标准的dbca模板，创建一个具有指定名称的容器数据库</li><li id="64c1" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">如果在调用脚本时指定了PDBName，则在容器数据库中创建一个具有指定名称的可插拔数据库</li><li id="8288" class="js jt hh iv b iw kb ja kc je kd ji ke jm kf jq kg jy jz ka bi translated">为新数据库配置导出和RMAN备份</li></ol><p id="dc3c" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">示例用法；</p><pre class="ll lm ln lo fd lt lu lv lw aw lx bi"><span id="b740" class="ly ki hh lu b fi lz ma l mb mc">Install-v1Oracle -TargetServer “ ORAHOST01” -OracleInstallVersion 19 -CDBName TESTCDB1 -PDBName TESTPDB1</span></pre><p id="1447" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">该示例将执行上述所有任务，并使用CDB TESTCDB1创建一个新的19c安装，在容器中使用PDB TESTPDB1。</p><h1 id="4982" class="kh ki hh bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">结束语</h1><p id="9537" class="pw-post-body-paragraph it iu hh iv b iw lf iy iz ja lg jc jd je lh jg jh ji li jk jl jm lj jo jp jq ha bi translated">自动化是我热爱的事情，我很幸运能为一个积极鼓励自动化的客户工作。正如你在这篇文章中看到的粗略数字，它可以为你、你的团队和客户节省大量的时间。自动化脚本的最初创建是耗时的，但是回报可能是惊人的。自动化一个任务不仅提高了你的自动化和脚本技能——而且当你自动化一个过程时，你会非常了解这个过程，所以你也是这样学习的。这也意味着你可以花更多的时间在有趣的任务上，花更少的时间做重复性的工作。</p><p id="c9fc" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">如果您对这些脚本的代码感兴趣，请通过电子邮件或下面的评论告诉我，我很乐意分享它们并提供更多细节。你可以打patrick.cull@version1.com的电话找到我。</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es md"><img src="../Images/709809a010e4a5ab84357211e8a458d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*30DKbxr-yIrKztnJ"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo by <a class="ae jr" href="https://unsplash.com/@ikukevk?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Kevin Ku</a> on <a class="ae jr" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="6d27" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">关于作者:</strong> <br/> <em class="me"> Patrick Cull是这里版本1的高级数据库管理员。关注我们的媒体出版物，了解更多数据博客，或访问</em><a class="ae jr" href="http://www.version1.com/" rel="noopener ugc nofollow" target="_blank"><em class="me">www.version1.com</em></a><em class="me">了解更多关于我们服务的信息。</em></p></div></div>    
</body>
</html>