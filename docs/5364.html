<html>
<head>
<title>Working with Oracle Cloud Infrastructure Classic Security Rules in Terraform: Part 2 — IP Networks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Terraform中使用Oracle云基础架构经典安全规则:第2部分— IP网络</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/working-with-oracle-cloud-infrastructure-classic-security-rules-in-terraform-part-2-ip-networks-b36c48d87330?source=collection_archive---------1-----------------------#2017-12-15">https://medium.com/oracledevs/working-with-oracle-cloud-infrastructure-classic-security-rules-in-terraform-part-2-ip-networks-b36c48d87330?source=collection_archive---------1-----------------------#2017-12-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="ef97" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本文提供了使用<code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/index.html" rel="noopener ugc nofollow" target="_blank">opc</a></code> Terraform提供者处理安全定义的概述。</p><p id="9e48" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae jg" href="https://cloud.oracle.com/classic" rel="noopener ugc nofollow" target="_blank">Oracle Cloud infra structure Classic</a>(以及Oracle Cloud at Customer)服务提供了两种网络选项— <strong class="ig hi">共享网络</strong>和<strong class="ig hi"> IP网络</strong>。在本文的第2部分，我们将关注IP网络安全资源。</p><blockquote class="jh ji jj"><p id="0ebe" class="ie if jk ig b ih ii ij ik il im in io jl iq ir is jm iu iv iw jn iy iz ja jb ha bi translated">另请参见<a class="ae jg" rel="noopener" href="/oracledevs/working-with-oracle-cloud-infrastructure-classic-security-rules-in-terraform-part-1-shared-155675ada6b5">在Terraform中使用Oracle云基础设施经典安全规则:第1部分—共享网络</a></p></blockquote><p id="a41d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">建议熟悉<a class="ae jg" href="https://docs.oracle.com/en/cloud/iaas/compute-iaas-cloud/stcsg/ip-networks.html#GUID-7299731F-7AEB-41F2-9938-2066CE7648F2" rel="noopener ugc nofollow" target="_blank"> IP网络</a>和<a class="ae jg" href="https://docs.oracle.com/en/cloud/iaas/compute-iaas-cloud/stcsg/access-control-interfaces-ip-networks.html" rel="noopener ugc nofollow" target="_blank">访问控制概念</a>。Terraform中支持的IP网络安全相关资源有:</p><ul class=""><li id="f105" class="jo jp hh ig b ih ii il im ip jq it jr ix js jb jt ju jv jw bi translated"><code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/opc/r/opc_compute_acl.html" rel="noopener ugc nofollow" target="_blank">opc_compute_acl</a></code></li><li id="e691" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated"><code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/opc/r/opc_compute_ip_address_prefix_set.html" rel="noopener ugc nofollow" target="_blank">opc_compute_ip_address_prefix_set</a></code></li><li id="0cb2" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated"><code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/opc/r/opc_compute_security_protocol.html" rel="noopener ugc nofollow" target="_blank">opc_compute_security_protocol</a></code></li><li id="4a3b" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated"><code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/opc/r/opc_compute_security_rule.html" rel="noopener ugc nofollow" target="_blank">opc_compute_security_rule</a></code></li><li id="85f4" class="jo jp hh ig b ih jx il jy ip jz it ka ix kb jb jt ju jv jw bi translated"><code class="du jc jd je jf b"><a class="ae jg" href="https://www.terraform.io/docs/providers/opc/r/opc_compute_vnic_set.html" rel="noopener ugc nofollow" target="_blank">opc_compute_vnic_set</a></code></li></ul><p id="5740" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了理解它们是如何协同工作的，让我们来看看它们之间的一般关系。</p><figure class="kd ke kf kg fd kh er es paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="er es kc"><img src="../Images/e57f119d65f92e8abc70311e55156ac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b8RfIKSa_EIhNVuSTps7nw.png"/></div></div></figure><p id="233c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一个<strong class="ig hi">计算实例</strong>可以有多个IP网络接口，或<strong class="ig hi">VNIC</strong>，每个VNIC可以在一个<strong class="ig hi"> VNIC集中</strong>。<strong class="ig hi">ACL</strong>将<strong class="ig hi">安全规则</strong>关联到<strong class="ig hi"> VNIC集。安全规则</strong>定义了由<strong class="ig hi">安全协议</strong>识别的流量在<strong class="ig hi"> IP地址前缀集</strong>和<strong class="ig hi"> VNIC集</strong>之间或VNIC集之间的进出流量行为。</p><h1 id="6aae" class="ko kp hh bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated"><strong class="ak">定义一个ACL </strong></h1><p id="5e61" class="pw-post-body-paragraph ie if hh ig b ih lm ij ik il ln in io ip lo ir is it lp iv iw ix lq iz ja jb ha bi translated">ACL是用于将一个接口(或一组接口)与安全规则相关联的主要资源。ACL资源定义本身非常简单，但是它是将多个安全规则关联到。</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="1b63" class="lv kp hh jf b fi lw lx l ly lz">resource "opc_compute_acl" "my-acl" {<br/>  name = "my-acl"<br/>}</span></pre><h1 id="d842" class="ko kp hh bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated"><strong class="ak">定义安全规则</strong></h1><p id="df3b" class="pw-post-body-paragraph ie if hh ig b ih lm ij ik il ln in io ip lo ir is it lp iv iw ix lq iz ja jb ha bi translated">安全规则定义流量处理，以允许或拒绝来自指定源或发往指定目的地的流量。一个常见的安全规则是允许特定端口的入站流量。在本例中，我们定义了一条规则，允许来自指定范围或IP地址的SSH进入。</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="4f8f" class="lv kp hh jf b fi lw lx l ly lz">resource "opc_compute_security_rule" "ssh" {<br/>  name                    = "Allow-ssh-ingress"<br/>  flow_direction          = "ingress"<br/>  acl                     = "${opc_compute_acl.my-acl.name}"<br/>  src_ip_address_prefixes = ["${opc_compute_ip_address_prefix_set.prefixset1.name}"]<br/>  security_protocols      = ["${opc_compute_security_protocol.ssh.name}"]                       }</span><span id="85f2" class="lv kp hh jf b fi ma lx l ly lz">resource "opc_compute_ip_address_prefix_set" "prefixset1" {<br/>  name     = "my-ip-prefix-set"<br/>  <!-- -->prefixes = ["172.16.0.0/24", "192.168.0.1/31", "192.168.10.1/31"]<br/>}</span><span id="194c" class="lv kp hh jf b fi ma lx l ly lz">resource "opc_compute_security_protocol" "ssh" {<br/>  name        = "ssh"<br/>  dst_ports   = ["22"] <br/>  ip_protocol = "tcp"<br/>}</span></pre><p id="f2f9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du jc jd je jf b"><strong class="ig hi">flow_direction</strong></code>表示该规则适用于入站流量还是出站流量(从实例/接口的角度)。</p><p id="9fcb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du jc jd je jf b"><strong class="ig hi">acl</strong></code>是与此规则关联的ACL。</p><p id="f3ba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du jc jd je jf b"><strong class="ig hi">src_ip_address_prefixes</strong></code>是一个或多个IP地址前缀集的列表，用于对入站流量的来源进行分类。可以省略此属性以允许所有IP地址。可选的<code class="du jc jd je jf b">src_vnic_set</code>属性也可以用于识别另一个VNIC集的源流量。等效<code class="du jc jd je jf b">dst_ip_address_prefixes</code> <code class="du jc jd je jf b">dst_vnic_set</code>启用基于流量目的地的分类。</p><p id="5388" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du jc jd je jf b"><strong class="ig hi">security_protocols</strong></code>是用于根据IP流量类型<code class="du jc jd je jf b">ICMP</code>、<code class="du jc jd je jf b">TCP</code>或<code class="du jc jd je jf b">UDP</code>和端口对流量进行分类的安全协议资源列表。</p><p id="7a25" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于第二个示例，让我们定义一个安全规则，以允许<strong class="ig hi">从一个接口到任何IP地址的所有</strong>出口流量。</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="2896" class="lv kp hh jf b fi lw lx l ly lz">resource "opc_compute_security_rule" "egress" {<br/>  name               = "Allow-all-egress"<br/>  flow_direction     = "egress"<br/>  acl                = "${opc_compute_acl.my-acl.name}"<br/>  security_protocols = ["${opc_compute_security_protocol.all.name}"]                       }</span><span id="cff2" class="lv kp hh jf b fi ma lx l ly lz">resource "opc_compute_security_protocol" "all" {<br/>  name        = "all"<br/>  ip_protocol = "all"<br/>}</span></pre><h1 id="55e4" class="ko kp hh bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">将ACL关联到实例</h1><p id="a86b" class="pw-post-body-paragraph ie if hh ig b ih lm ij ik il ln in io ip lo ir is it lp iv iw ix lq iz ja jb ha bi translated">现在我们有了一个用两个安全规则定义的ACL，让我们将它与一个实例相关联。创建一个虚拟网卡集，其中包含ACL应该应用到的所有虚拟网卡。要向VNIC集添加实例接口，最好在实例<code class="du jc jd je jf b">network_info</code>配置中设置<code class="du jc jd je jf b">vnic_sets</code>属性，以便在实例创建时应用ACL。</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="a1f3" class="lv kp hh jf b fi lw lx l ly lz">resource "opc_compute_vnic_set" "my-vnic-set" {<br/>  name         = "my-vnic-set"<br/><strong class="jf hi">  applied_acls = ["${opc_compute_acl.my-acl.name}"]</strong><br/>}</span><span id="7dd5" class="lv kp hh jf b fi ma lx l ly lz">resource "opc_compute_instance" "my-instance" {<br/>  name       = "my-instance"<br/>  shape      = "oc3"<br/>  image_list = "/oracle/public/OL_7.2_UEKR4_x86_64"<br/>  ssh_keys = ["${opc_compute_ssh_key.my-ssh-key.name}"]</span><span id="02fd" class="lv kp hh jf b fi ma lx l ly lz">  networking_info {<br/>    index      = 1<br/>    ip_network = "${opc_compute_ip_network.my-ip-network.name}"<br/><strong class="jf hi">    vnic_sets  = ["${opc_compute_vnic_set.my-vnic-set.name}"]</strong><br/>  }<br/>}</span></pre><p id="19e2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">与共享网络接口上的安全列表关联一样，实例中的<code class="du jc jd je jf b">vnic_sets</code>定义的一个缺点是，向/从接口添加或删除VNIC集将强制重新创建实例。</p><p id="5b5e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要将ACL与已经运行的实例相关联，可以将VNIC添加到VNIC集资源中。如果VNIC使用默认命名。</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="e6a9" class="lv kp hh jf b fi lw lx l ly lz">resource "opc_compute_vnic_set" "my-vnic-set" {<br/>  name         = "my-vnic-set"<br/><strong class="jf hi">  </strong>applied_acls = ["${opc_compute_acl.my-acl.name}"]<strong class="jf hi"><br/>  virtual_nics = ["${opc_compute_instance.my-instance.name}/${opc_compute_instance.my-instance.id}/eth1"]</strong><br/>}</span></pre><p id="2dfb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">或者，如果在实例<code class="du jc jd je jf b">networking_info</code>配置中已经明确设置了<code class="du jc jd je jf b">vnic</code>名称属性，则在VNIC集中使用相同的名称。</p><pre class="kd ke kf kg fd lr jf ls lt aw lu bi"><span id="3de0" class="lv kp hh jf b fi lw lx l ly lz">resource "opc_compute_vnic_set" "my-vnic-set" {<br/>  name         = "my-vnic-set"<br/><strong class="jf hi">  </strong>applied_acls = ["${opc_compute_acl.my-acl.name}"]<strong class="jf hi"><br/>  virtual_nics = ["the_vnic_name"]</strong><br/>}</span></pre><h2 id="c835" class="lv kp hh bd kq mb mc md ku me mf mg ky ip mh mi lc it mj mk lg ix ml mm lk mn bi translated">小心<code class="du jc jd je jf b">the "default" VNIC Set</code></h2><p id="a5df" class="pw-post-body-paragraph ie if hh ig b ih lm ij ik il ln in io ip lo ir is it lp iv iw ix lq iz ja jb ha bi translated">同样，类似于第1部分中讨论的共享网络接口的<code class="du jc jd je jf b">sec_lists</code>属性的行为。当使用IP网络接口定义计算实例资源时，如果<code class="du jc jd je jf b">vnic_sets</code>属性是<em class="jk">而不是</em>定义的，则计算实例将自动与<code class="du jc jd je jf b">default</code> VNIC集相关联。</p><p id="05b3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于<code class="du jc jd je jf b">default</code> VNIC集在Terraform配置之外，这通常不是我们想要的行为。因此，通常建议在实例定义中设置<code class="du jc jd je jf b">vnic_sets</code>。</p><p id="1cca" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jk">注意——免费层用户可能会体验到其帐户所含服务的变化。</em></p></div></div>    
</body>
</html>