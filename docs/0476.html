<html>
<head>
<title>The suspend modifier â€” under the hood</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">â€œæš‚åœâ€ä¿®æ”¹å™¨â€”åœ¨å¼•æ“ç›–ä¸‹</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://medium.com/androiddevelopers/the-suspend-modifier-under-the-hood-b7ce46af624f?source=collection_archive---------0-----------------------#2020-03-24">https://medium.com/androiddevelopers/the-suspend-modifier-under-the-hood-b7ce46af624f?source=collection_archive---------0-----------------------#2020-03-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/7dbdff2f6243de6e06b0425e311eb83b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5QpP21pn8EmDouGf0jAK_Q.png"/></div></div></figure><div class=""/><div class=""><h2 id="0cad" class="pw-subtitle-paragraph ip hr hs bd b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg dx translated">ç§‘ç‰¹æ—è¯æ±‡:åç¨‹</h2></div><p id="069d" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">ç§‘ç‰¹æ—ååŒç¨‹åºåœ¨æˆ‘ä»¬ä½œä¸ºAndroidå¼€å‘è€…çš„æ—¥å¸¸ç”Ÿæ´»ä¸­å¼•å…¥äº†<strong class="jj ht"> <em class="kd">æš‚åœä¿®é¥°ç¬¦</em> </strong>ã€‚ä½ æƒ³çŸ¥é“å¼•æ“ç›–ä¸‹å‘ç”Ÿäº†ä»€ä¹ˆå—ï¼Ÿç¼–è¯‘å™¨å¦‚ä½•è½¬æ¢ä»£ç ä»¥èƒ½å¤Ÿæš‚åœå’Œæ¢å¤åç¨‹çš„æ‰§è¡Œï¼Ÿ</p><p id="f25b" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">äº†è§£è¿™ä¸€ç‚¹å°†æœ‰åŠ©äºæ‚¨æ›´å¥½åœ°ç†è§£ä¸ºä»€ä¹ˆæŒ‚èµ·å‡½æ•°åœ¨å®ƒå¯åŠ¨çš„æ‰€æœ‰å·¥ä½œå®Œæˆä¹‹å‰ä¸ä¼šè¿”å›ï¼Œä»¥åŠä»£ç å¦‚ä½•åœ¨ä¸é˜»å¡çº¿ç¨‹çš„æƒ…å†µä¸‹æŒ‚èµ·ã€‚</p><blockquote class="ke kf kg"><p id="58c1" class="jh ji kd jj b jk jl it jm jn jo iw jp kh jr js jt ki jv jw jx kj jz ka kb kc ha bi translated"><strong class="jj ht">TLï¼›DRï¼›Kotlinç¼–è¯‘å™¨å°†ä¸ºæ¯ä¸ªæŒ‚èµ·å‡½æ•°åˆ›å»ºä¸€ä¸ªçŠ¶æ€æœºï¼Œä¸ºæˆ‘ä»¬ç®¡ç†åç¨‹çš„æ‰§è¡Œï¼</strong></p></blockquote><p id="334a" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">ğŸ“šä¸ç†Ÿæ‚‰Androidä¸Šçš„åç¨‹ï¼ŸæŸ¥çœ‹è¿™äº›ååŒç¨‹åºä»£ç å®éªŒå®¤:</p><ul class=""><li id="e443" class="kk kl hs jj b jk jl jn jo jq km ju kn jy ko kc kp kq kr ks bi translated"><a class="ae kt" href="https://codelabs.developers.google.com/codelabs/kotlin-coroutines/#0" rel="noopener ugc nofollow" target="_blank">åœ¨ä½ çš„Androidåº”ç”¨ä¸­ä½¿ç”¨åç¨‹</a></li><li id="9c82" class="kk kl hs jj b jk ku jn kv jq kw ju kx jy ky kc kp kq kr ks bi translated"><a class="ae kt" href="https://codelabs.developers.google.com/codelabs/advanced-kotlin-coroutines/#0" rel="noopener ugc nofollow" target="_blank">å…·æœ‰Kotlinæµå’Œå®æ—¶æ•°æ®çš„é«˜çº§ååŒç¨‹åº</a></li></ul><p id="37c5" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">å¦‚æœä½ å–œæ¬¢çœ‹å…³äºè¿™ä¸ªçš„è§†é¢‘ï¼Œçœ‹çœ‹è¿™ä¸ª:</p><figure class="kz la lb lc fd hj"><div class="bz dy l di"><div class="ld le l"/></div></figure><h1 id="96c0" class="lf lg hs bd lh li lj lk ll lm ln lo lp iy lq iz lr jb ls jc lt je lu jf lv lw bi translated">åç¨‹101</h1><p id="41a4" class="pw-post-body-paragraph jh ji hs jj b jk lx it jm jn ly iw jp jq lz js jt ju ma jw jx jy mb ka kb kc ha bi translated">åç¨‹ç®€åŒ–äº†Androidä¸Šçš„å¼‚æ­¥æ“ä½œã€‚æ­£å¦‚åœ¨<a class="ae kt" href="https://developer.android.com/kotlin/coroutines" rel="noopener ugc nofollow" target="_blank">æ–‡æ¡£</a>ä¸­æ‰€è§£é‡Šçš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥ç®¡ç†å¼‚æ­¥ä»»åŠ¡ï¼Œå¦åˆ™è¿™äº›ä»»åŠ¡å¯èƒ½ä¼šé˜»å¡ä¸»çº¿ç¨‹å¹¶å¯¼è‡´åº”ç”¨ç¨‹åºå†»ç»“ã€‚</p><p id="f542" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">åç¨‹ä¹Ÿæœ‰åŠ©äºç”¨å‘½ä»¤å¼ä»£ç æ›¿æ¢åŸºäºå›è°ƒçš„APIã€‚ä¾‹å¦‚ï¼Œçœ‹çœ‹è¿™ä¸ªä½¿ç”¨å›è°ƒçš„å¼‚æ­¥ä»£ç :</p><pre class="kz la lb lc fd mc md me mf aw mg bi"><span id="0b5b" class="mh lg hs md b fi mi mj l mk ml">// Simplified code that only considers the happy path<br/>fun loginUser(userId: String, password: String, userResult: Callback&lt;User&gt;) {<br/>  // Async callbacks<br/>  userRemoteDataSource.logUserIn { user -&gt;<br/>    // Successful network request<br/>    userLocalDataSource.logUserIn(user) { userDb -&gt;<br/>      // Result saved in DB<br/>      userResult.success(userDb)<br/>    }<br/>  }<br/>}</span></pre><p id="0ecc" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">å¯ä»¥ä½¿ç”¨åç¨‹å°†è¿™äº›å›è°ƒè½¬æ¢ä¸ºé¡ºåºå‡½æ•°è°ƒç”¨:</p><pre class="kz la lb lc fd mc md me mf aw mg bi"><span id="7921" class="mh lg hs md b fi mi mj l mk ml"><strong class="md ht">suspend</strong> fun loginUser(userId: String, password: String): User {<br/>  val user = userRemoteDataSource.logUserIn(userId, password)<br/>  val userDb = userLocalDataSource.logUserIn(user)<br/>  return userDb<br/>}</span></pre><p id="4ee1" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">åœ¨åç¨‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬å‘å‡½æ•°æ·»åŠ äº†<strong class="jj ht"> suspend </strong>ä¿®é¥°ç¬¦ã€‚è¿™å‘Šè¯‰ç¼–è¯‘å™¨è¿™ä¸ªå‡½æ•°éœ€è¦åœ¨åç¨‹ä¸­æ‰§è¡Œã€‚ä½œä¸ºä¸€åå¼€å‘äººå‘˜ï¼Œæ‚¨å¯ä»¥å°†æŒ‚èµ·å‡½æ•°è§†ä¸ºä¸€ä¸ªå¸¸è§„å‡½æ•°ï¼Œå®ƒçš„æ‰§è¡Œå¯èƒ½ä¼šè¢«æŒ‚èµ·ï¼Œå¹¶åœ¨æŸä¸ªæ—¶å€™æ¢å¤ã€‚</p><p id="f52e" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">ä¸å›è°ƒä¸åŒï¼Œåç¨‹æä¾›äº†ä¸€ç§åœ¨çº¿ç¨‹é—´äº¤æ¢å’Œå¤„ç†å¼‚å¸¸çš„ç®€å•æ–¹æ³•ã€‚</p><p id="2d21" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬å°†å‡½æ•°æ ‡è®°ä¸º<em class="kd">æš‚åœ</em>æ—¶ï¼Œç¼–è¯‘å™¨å®é™…ä¸Šåœ¨åšä»€ä¹ˆå‘¢ï¼Ÿ</p><h1 id="21c1" class="lf lg hs bd lh li lj lk ll lm ln lo lp iy lq iz lr jb ls jc lt je lu jf lv lw bi translated">æ‚¬æŒ‚åœ¨å¼•æ“ç›–ä¸‹</h1><p id="758d" class="pw-post-body-paragraph jh ji hs jj b jk lx it jm jn ly iw jp jq lz js jt ju ma jw jx jy mb ka kb kc ha bi translated">å›åˆ°<code class="du mm mn mo md b">loginUser</code>æš‚åœå‡½æ•°ï¼Œæ³¨æ„å®ƒè°ƒç”¨çš„å…¶ä»–å‡½æ•°ä¹Ÿæ˜¯æš‚åœå‡½æ•°:</p><pre class="kz la lb lc fd mc md me mf aw mg bi"><span id="f844" class="mh lg hs md b fi mi mj l mk ml"><strong class="md ht">suspend</strong> fun loginUser(userId: String, password: String): User {<br/>  val user = userRemoteDataSource.logUserIn(userId, password)<br/>  val userDb = userLocalDataSource.logUserIn(user)<br/>  return userDb<br/>}</span><span id="9a58" class="mh lg hs md b fi mp mj l mk ml">// UserRemoteDataSource.kt<br/><strong class="md ht">suspend</strong> fun logUserIn(userId: String, password: String): User</span><span id="9bd3" class="mh lg hs md b fi mp mj l mk ml">// UserLocalDataSource.kt<br/><strong class="md ht">suspend</strong> fun logUserIn(userId: String): UserDb</span></pre><p id="46d7" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">ç®€è€Œè¨€ä¹‹ï¼ŒKotlinç¼–è¯‘å™¨ä¼šä½¿ç”¨ä¸€ä¸ª<a class="ae kt" href="https://en.wikipedia.org/wiki/Finite-state_machine" rel="noopener ugc nofollow" target="_blank"> <strong class="jj ht">æœ‰é™çŠ¶æ€æœº</strong> </a>(æˆ‘ä»¬å°†åœ¨åé¢ä»‹ç»)å°†æŒ‚èµ·å‡½æ•°è½¬æ¢æˆå›è°ƒçš„ä¼˜åŒ–ç‰ˆæœ¬ã€‚</p><p id="da04" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">ä½ ç­”å¯¹äº†ï¼Œ<strong class="jj ht">ç¼–è¯‘å™¨ä¼šä¸ºä½ å†™é‚£äº›å›è°ƒå‡½æ•°</strong>ï¼</p><h2 id="210f" class="mh lg hs bd lh mq mr ms ll mt mu mv lp jq mw mx lr ju my mz lt jy na nb lv nc bi translated">å»¶ç»­æ¥å£</h2><p id="2dbd" class="pw-post-body-paragraph jh ji hs jj b jk lx it jm jn ly iw jp jq lz js jt ju ma jw jx jy mb ka kb kc ha bi translated">æŒ‚èµ·å‡½æ•°ç›¸äº’é€šä¿¡çš„æ–¹å¼æ˜¯é€šè¿‡<code class="du mm mn mo md b"><a class="ae kt" href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/-continuation/index.html" rel="noopener ugc nofollow" target="_blank">Continuation</a></code>å¯¹è±¡ã€‚ä¸€ä¸ª<code class="du mm mn mo md b"><a class="ae kt" href="https://github.com/JetBrains/kotlin/blob/master/libraries/stdlib/src/kotlin/coroutines/Continuation.kt" rel="noopener ugc nofollow" target="_blank">Continuation</a></code>åªæ˜¯ä¸€ä¸ªå¸¦æœ‰ä¸€äº›é¢å¤–ä¿¡æ¯çš„é€šç”¨å›è°ƒæ¥å£ã€‚æ­£å¦‚æˆ‘ä»¬å°†åœ¨åé¢çœ‹åˆ°çš„ï¼Œå®ƒå°†ä»£è¡¨ä¸€ä¸ªæŒ‚èµ·å‡½æ•°çš„ç”ŸæˆçŠ¶æ€æœºã€‚</p><p id="a3a8" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">è®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å®šä¹‰:</p><pre class="kz la lb lc fd mc md me mf aw mg bi"><span id="69c7" class="mh lg hs md b fi mi mj l mk ml">interface Continuation&lt;in T&gt; {<br/>  public val context: CoroutineContext<br/>  public fun resumeWith(value: Result&lt;T&gt;)<br/>}</span></pre><ul class=""><li id="437d" class="kk kl hs jj b jk jl jn jo jq km ju kn jy ko kc kp kq kr ks bi translated"><code class="du mm mn mo md b">context</code>å°†æ˜¯åœ¨è¯¥å»¶ç»­ä¸­ä½¿ç”¨çš„<code class="du mm mn mo md b">CoroutineContext</code>ã€‚</li><li id="a98f" class="kk kl hs jj b jk ku jn kv jq kw ju kx jy ky kc kp kq kr ks bi translated"><code class="du mm mn mo md b">resumeWith</code>ç”¨<code class="du mm mn mo md b"><a class="ae kt" href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/stdlib-stubs/src/Result.kt" rel="noopener ugc nofollow" target="_blank">Result</a></code>æ¢å¤åç¨‹çš„æ‰§è¡Œï¼Œå®ƒå¯ä»¥åŒ…å«ä¸€ä¸ªå¯¼è‡´æŒ‚èµ·çš„è®¡ç®—ç»“æœå€¼ï¼Œä¹Ÿå¯ä»¥åŒ…å«ä¸€ä¸ªå¼‚å¸¸ã€‚</li></ul><p id="fa26" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">æ³¨æ„:ä»Kotlin 1.3å¼€å§‹ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ‰©å±•å‡½æ•°<code class="du mm mn mo md b"><a class="ae kt" href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/resume.html" rel="noopener ugc nofollow" target="_blank">resume</a>(value: T)</code>å’Œ<code class="du mm mn mo md b"><a class="ae kt" href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/resume-with-exception.html" rel="noopener ugc nofollow" target="_blank">resumeWithException</a>(exception: Throwable)</code>ï¼Œå®ƒä»¬æ˜¯<code class="du mm mn mo md b">resumeWith</code>è°ƒç”¨çš„ç‰¹æ®Šç‰ˆæœ¬ã€‚</p><p id="ddfc" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">ç¼–è¯‘å™¨å°†åœ¨å‡½æ•°ç­¾åä¸­ç”¨é¢å¤–çš„å‚æ•°<code class="du mm mn mo md b">completion</code>(ç±»å‹<code class="du mm mn mo md b">Continuation</code>)æ›¿æ¢suspendä¿®é¥°ç¬¦ï¼Œè¯¥å‡½æ•°ç­¾åå°†ç”¨äºå°†æŒ‚èµ·å‡½æ•°çš„ç»“æœä¼ é€’ç»™è°ƒç”¨å®ƒçš„åç¨‹:</p><pre class="kz la lb lc fd mc md me mf aw mg bi"><span id="eff2" class="mh lg hs md b fi mi mj l mk ml">fun loginUser(userId: String, password: String, <strong class="md ht">completion: Continuation&lt;Any?&gt;</strong>) {<br/>  val user = userRemoteDataSource.logUserIn(userId, password)<br/>  val userDb = userLocalDataSource.logUserIn(user)<br/>  <strong class="md ht">completion.resume(userDb)</strong><br/>}</span></pre><p id="c8c5" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬çš„ä¾‹å­å°†è¿”å›<code class="du mm mn mo md b">Unit</code>è€Œä¸æ˜¯<code class="du mm mn mo md b">User</code>ã€‚<code class="du mm mn mo md b">User</code>å¯¹è±¡å°†è¢«â€œè¿”å›â€åˆ°æ·»åŠ çš„<code class="du mm mn mo md b">Continuation</code>å‚æ•°ä¸­ã€‚</p><p id="c82c" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">æŒ‚èµ·å‡½æ•°çš„å­—èŠ‚ç å®é™…ä¸Šè¿”å›äº†<code class="du mm mn mo md b">Any?</code>ï¼Œå› ä¸ºå®ƒæ˜¯<code class="du mm mn mo md b">T | COROUTINE_SUSPENDED</code>çš„è”åˆç±»å‹ã€‚è¿™å…è®¸å‡½æ•°åœ¨å¯èƒ½çš„æ—¶å€™åŒæ­¥è¿”å›ã€‚</p><blockquote class="ke kf kg"><p id="286b" class="jh ji kd jj b jk jl it jm jn jo iw jp kh jr js jt ki jv jw jx kj jz ka kb kc ha bi translated"><strong class="jj ht">æ³¨æ„</strong>:å¦‚æœä½ ç”¨suspendä¿®é¥°ç¬¦æ ‡è®°ä¸€ä¸ªä¸è°ƒç”¨å…¶ä»–suspendå‡½æ•°çš„å‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šæ·»åŠ é¢å¤–çš„Continuationå‚æ•°ï¼Œä½†ä¸ä¼šå¯¹å®ƒåšä»»ä½•äº‹æƒ…ï¼Œå‡½æ•°ä½“çš„å­—èŠ‚ç çœ‹èµ·æ¥å°±åƒä¸€ä¸ªå¸¸è§„å‡½æ•°ã€‚</p></blockquote><p id="dda2" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">åœ¨å…¶ä»–åœ°æ–¹ä¹Ÿå¯ä»¥çœ‹åˆ°<code class="du mm mn mo md b">Continuation</code>ç•Œé¢:</p><ul class=""><li id="bcb3" class="kk kl hs jj b jk jl jn jo jq km ju kn jy ko kc kp kq kr ks bi translated">å½“ä½¿ç”¨<code class="du mm mn mo md b"><a class="ae kt" href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/suspend-coroutine.html" rel="noopener ugc nofollow" target="_blank">suspendCoroutine</a></code>æˆ–<code class="du mm mn mo md b"><a class="ae kt" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/suspend-cancellable-coroutine.html" rel="noopener ugc nofollow" target="_blank">suspendCancellableCoroutine</a></code>å°†åŸºäºå›è°ƒçš„APIè½¬æ¢ä¸ºååŒç¨‹åºæ—¶(æ‚¨åº”è¯¥æ€»æ˜¯æ›´å–œæ¬¢ä½¿ç”¨è¿™ä¸¤ç§æ–¹æ³•)ï¼Œæ‚¨å¯ä»¥ç›´æ¥ä¸<code class="du mm mn mo md b">Continuation</code>å¯¹è±¡äº¤äº’ï¼Œä»¥æ¢å¤åœ¨è¿è¡Œä½œä¸ºå‚æ•°ä¼ é€’çš„ä»£ç å—åè¢«æŒ‚èµ·çš„ååŒç¨‹åºã€‚</li><li id="08c0" class="kk kl hs jj b jk ku jn kv jq kw ju kx jy ky kc kp kq kr ks bi translated">æ‚¨å¯ä»¥åœ¨æŒ‚èµ·å‡½æ•°ä¸Šä½¿ç”¨<code class="du mm mn mo md b"><a class="ae kt" href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/start-coroutine.html" rel="noopener ugc nofollow" target="_blank">startCoroutine</a></code>æ‰©å±•å‡½æ•°æ¥å¯åŠ¨åç¨‹ã€‚å®ƒå°†ä¸€ä¸ª<code class="du mm mn mo md b">Continuation</code>å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå½“æ–°çš„åç¨‹ä»¥ç»“æœæˆ–å¼‚å¸¸ç»“æŸæ—¶ï¼Œè¯¥å¯¹è±¡å°†è¢«è°ƒç”¨ã€‚</li></ul><h2 id="f006" class="mh lg hs bd lh mq mr ms ll mt mu mv lp jq mw mx lr ju my mz lt jy na nb lv nc bi translated">ä½¿ç”¨ä¸åŒçš„è°ƒåº¦ç¨‹åº</h2><p id="38da" class="pw-post-body-paragraph jh ji hs jj b jk lx it jm jn ly iw jp jq lz js jt ju ma jw jx jy mb ka kb kc ha bi translated">æ‚¨å¯ä»¥åœ¨ä¸åŒçš„è°ƒåº¦ç¨‹åºä¹‹é—´åˆ‡æ¢ï¼Œä»¥ä¾¿åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šæ‰§è¡Œè®¡ç®—ã€‚Kotlinå¦‚ä½•çŸ¥é“åœ¨å“ªé‡Œæ¢å¤æŒ‚èµ·çš„è®¡ç®—ï¼Ÿ</p><p id="297a" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">æœ‰ä¸€ä¸ªåä¸º<code class="du mm mn mo md b"><a class="ae kt" href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/kotlinx-coroutines-core/common/src/internal/DispatchedContinuation.kt" rel="noopener ugc nofollow" target="_blank">DispatchedContinuation</a></code>çš„<code class="du mm mn mo md b">Continuation</code>å­ç±»å‹ï¼Œå®ƒçš„resumeå‡½æ•°è°ƒç”¨<code class="du mm mn mo md b">CoroutineContext</code>ä¸­å¯ç”¨çš„<code class="du mm mn mo md b">Dispatcher</code>ã€‚é™¤äº†<code class="du mm mn mo md b">Dispatchers.Unconfined</code>ä¹‹å¤–ï¼Œæ‰€æœ‰è°ƒåº¦ç¨‹åºéƒ½å°†è°ƒç”¨dispatchï¼Œå…¶<code class="du mm mn mo md b">isDispatchNeeded</code>å‡½æ•°è¦†ç›–(åœ¨<code class="du mm mn mo md b">dispatch</code>ä¹‹å‰è°ƒç”¨)æ€»æ˜¯è¿”å›<code class="du mm mn mo md b">false</code>ã€‚</p><h1 id="1359" class="lf lg hs bd lh li lj lk ll lm ln lo lp iy lq iz lr jb ls jc lt je lu jf lv lw bi translated">ç”Ÿæˆçš„çŠ¶æ€æœº</h1><blockquote class="ke kf kg"><p id="12d2" class="jh ji kd jj b jk jl it jm jn jo iw jp kh jr js jt ki jv jw jx kj jz ka kb kc ha bi translated"><strong class="jj ht">å…è´£å£°æ˜</strong>:æœ¬æ–‡å‰©ä½™éƒ¨åˆ†æ˜¾ç¤ºçš„ä»£ç ä¸ä¼šä¸ç¼–è¯‘å™¨ç”Ÿæˆçš„å­—èŠ‚ç å®Œå…¨åŒ¹é…ã€‚å®ƒå°†æ˜¯è¶³å¤Ÿç²¾ç¡®çš„Kotlinä»£ç ï¼Œä½¿æ‚¨èƒ½å¤Ÿç†è§£å†…éƒ¨çœŸæ­£å‘ç”Ÿäº†ä»€ä¹ˆã€‚è¿™ç§è¡¨ç¤ºæ˜¯ç”±Coroutines 1 . 3 . 3ç‰ˆç”Ÿæˆçš„ï¼Œå¯èƒ½ä¼šåœ¨åº“çš„æœªæ¥ç‰ˆæœ¬ä¸­å‘ç”Ÿå˜åŒ–ã€‚</p></blockquote><p id="2414" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">Kotlinç¼–è¯‘å™¨å°†è¯†åˆ«å‡½æ•°ä½•æ—¶å¯ä»¥å†…éƒ¨æŒ‚èµ·ã€‚æ¯ä¸ªæ‚¬æŒ‚ç‚¹å°†è¢«è¡¨ç¤ºä¸ºæœ‰é™çŠ¶æ€æœºä¸­çš„ä¸€ä¸ªçŠ¶æ€ã€‚è¿™äº›çŠ¶æ€ç”±ç¼–è¯‘å™¨ç”¨æ ‡ç­¾è¡¨ç¤º:</p><pre class="kz la lb lc fd mc md me mf aw mg bi"><span id="3df7" class="mh lg hs md b fi mi mj l mk ml">fun loginUser(userId: String, password: String, completion: Continuation&lt;Any?&gt;) {<br/>  // <strong class="md ht">Label 0</strong> -&gt; first execution<br/>  val user = userRemoteDataSource.logUserIn(userId, password)</span><span id="b5f4" class="mh lg hs md b fi mp mj l mk ml">  // <strong class="md ht">Label 1</strong> -&gt; resumes from userRemoteDataSource<br/>  val userDb = userLocalDataSource.logUserIn(user)</span><span id="7a51" class="mh lg hs md b fi mp mj l mk ml">  // <strong class="md ht">Label 2</strong> -&gt; resumes from userLocalDataSource<br/>  completion.resume(userDb)<br/>}</span></pre><p id="10b2" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">ä¸ºäº†æ›´å¥½åœ°è¡¨ç¤ºçŠ¶æ€æœºï¼Œç¼–è¯‘å™¨å°†ä½¿ç”¨ä¸€ä¸ª<code class="du mm mn mo md b">when</code>è¯­å¥æ¥å®ç°ä¸åŒçš„çŠ¶æ€:</p><pre class="kz la lb lc fd mc md me mf aw mg bi"><span id="c2ac" class="mh lg hs md b fi mi mj l mk ml">fun loginUser(userId: String, password: String, completion: Continuation&lt;Any?&gt;) {<br/>  when(label) {<br/>    <strong class="md ht">0 -&gt; { // Label 0 -&gt; first execution</strong><br/>        userRemoteDataSource.logUserIn(userId, password)<br/>    }<br/><strong class="md ht">    1 -&gt; { // Label 1 -&gt; resumes from userRemoteDataSource</strong><br/>        userLocalDataSource.logUserIn(user)<br/>    }<br/><strong class="md ht">    2 -&gt; { // Label 2 -&gt; resumes from userLocalDataSource</strong><br/>        completion.resume(userDb)<br/>    }<br/>    else -&gt; throw IllegalStateException(...)<br/>  }<br/>}</span></pre><p id="f74e" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">è¿™ä¸ªä»£ç æ˜¯ä¸å®Œæ•´çš„ï¼Œå› ä¸ºä¸åŒçš„å·æ²¡æœ‰åŠæ³•å…±äº«ä¿¡æ¯ã€‚ç¼–è¯‘å™¨å°†åœ¨å‡½æ•°ä¸­ä½¿ç”¨ç›¸åŒçš„<code class="du mm mn mo md b">Continuation</code>å¯¹è±¡æ¥å®ç°ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ<code class="du mm mn mo md b">Continuation</code>çš„æ³›å‹æ˜¯<code class="du mm mn mo md b">Any?</code>è€Œä¸æ˜¯åŸå‡½æ•°çš„è¿”å›ç±»å‹(å³<code class="du mm mn mo md b">User</code>)ã€‚</p><p id="81a5" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">æ­¤å¤–ï¼Œç¼–è¯‘å™¨å°†åˆ›å»ºä¸€ä¸ªç§æœ‰ç±»ï¼Œ1)ä¿å­˜æ‰€éœ€çš„æ•°æ®ï¼Œ2)é€’å½’è°ƒç”¨<code class="du mm mn mo md b">loginUser</code>å‡½æ•°ä»¥æ¢å¤æ‰§è¡Œã€‚æ‚¨å¯ä»¥æŸ¥çœ‹ä¸‹é¢ç”Ÿæˆçš„ç±»çš„è¿‘ä¼¼å€¼ã€‚</p><blockquote class="ke kf kg"><p id="cb51" class="jh ji kd jj b jk jl it jm jn jo iw jp kh jr js jt ki jv jw jx kj jz ka kb kc ha bi translated"><strong class="jj ht">å…è´£å£°æ˜</strong>:æ³¨é‡Šä¸æ˜¯ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ã€‚æˆ‘æ·»åŠ å®ƒä»¬æ˜¯ä¸ºäº†è§£é‡Šå®ƒä»¬åšä»€ä¹ˆï¼Œå¹¶ä½¿éµå¾ªä»£ç æ›´å®¹æ˜“ã€‚</p></blockquote><pre class="kz la lb lc fd mc md me mf aw mg bi"><span id="cf21" class="mh lg hs md b fi mi mj l mk ml">fun loginUser(<strong class="md ht">userId: String?, password: String?, completion: Continuation&lt;Any?&gt;</strong>) {</span><span id="51d1" class="mh lg hs md b fi mp mj l mk ml">  class <strong class="md ht">LoginUserStateMachine</strong>(<br/>    // completion parameter is the callback to the function <br/>    // that called loginUser<br/>    completion: Continuation&lt;Any?&gt;<br/>  ): <strong class="md ht">CoroutineImpl(completion)</strong> {</span><span id="c091" class="mh lg hs md b fi mp mj l mk ml">    // Local variables of the suspend function<br/>    var user: User? = null<br/>    var userDb: UserDb? = null</span><span id="1448" class="mh lg hs md b fi mp mj l mk ml">    // Common objects for all CoroutineImpls<br/>    var result: Any? = null<br/>    var label: Int = 0</span><span id="f77b" class="mh lg hs md b fi mp mj l mk ml">    // this function calls the loginUser again to trigger the<br/>    // state machine (label will be already in the next state) and<br/>    // result will be the result of the previous state's computation<br/>    override fun invokeSuspend(result: Any?) {<br/>      this.result = result<br/>      <strong class="md ht">loginUser(null, null, this)</strong><br/>    }<br/>  }<br/>  ...<br/>}</span></pre><p id="b9db" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">ç”±äº<code class="du mm mn mo md b">invokeSuspend</code>å°†ä»…ä½¿ç”¨<code class="du mm mn mo md b">Continuation</code>å¯¹è±¡çš„ä¿¡æ¯å†æ¬¡è°ƒç”¨<code class="du mm mn mo md b">loginUser</code>ï¼Œæ‰€ä»¥<code class="du mm mn mo md b">loginUser</code>å‡½æ•°ç­¾åä¸­çš„å…¶ä½™å‚æ•°å˜å¾—å¯ç©ºã€‚æ­¤æ—¶ï¼Œç¼–è¯‘å™¨åªéœ€è¦æ·»åŠ å¦‚ä½•åœ¨çŠ¶æ€ä¹‹é—´ç§»åŠ¨çš„ä¿¡æ¯ã€‚</p><p id="ace8" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">å®ƒéœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯çŸ¥é“1)è¿™æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥å‡½æ•°ï¼Œè¿˜æ˜¯2)è¯¥å‡½æ•°å·²ç»ä»å…ˆå‰çš„çŠ¶æ€æ¢å¤ã€‚å®ƒé€šè¿‡æ£€æŸ¥ä¼ å…¥çš„å»¶ç»­æ˜¯å¦å±äºç±»å‹<code class="du mm mn mo md b">LoginUserStateMachine</code>æ¥å®ç°:</p><pre class="kz la lb lc fd mc md me mf aw mg bi"><span id="1064" class="mh lg hs md b fi mi mj l mk ml">fun loginUser(userId: String?, password: String?, completion: Continuation&lt;Any?&gt;) {<br/>  ...</span><span id="bcbe" class="mh lg hs md b fi mp mj l mk ml">  val <strong class="md ht">continuation</strong> = completion as? LoginUserStateMachine ?: LoginUserStateMachine(completion)</span><span id="9a86" class="mh lg hs md b fi mp mj l mk ml">  ...<br/>}</span></pre><p id="05e5" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ï¼Œå®ƒå°†åˆ›å»ºä¸€ä¸ªæ–°çš„<code class="du mm mn mo md b">LoginUserStateMachine</code>å®ä¾‹ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„<code class="du mm mn mo md b">completion</code>å®ä¾‹å­˜å‚¨ä¸ºä¸€ä¸ªå‚æ•°ï¼Œä»¥ä¾¿å®ƒè®°ä½å¦‚ä½•æ¢å¤è°ƒç”¨è¿™ä¸ªå®ä¾‹çš„å‡½æ•°ã€‚å¦‚æœä¸æ˜¯ï¼Œå®ƒå°†ç»§ç»­æ‰§è¡ŒçŠ¶æ€æœº(æŒ‚èµ·åŠŸèƒ½)ã€‚</p><p id="98d9" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ç¼–è¯‘å™¨ä¸ºåœ¨çŠ¶æ€ä¹‹é—´ç§»åŠ¨å’Œå…±äº«ä¿¡æ¯è€Œç”Ÿæˆçš„ä»£ç ã€‚</p><figure class="kz la lb lc fd hj"><div class="bz dy l di"><div class="nd le l"/></div></figure><p id="a436" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">èŠ±äº›æ—¶é—´æµè§ˆä¸Šé¢çš„ä»£ç ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½å‘ç°ä¸å‰é¢ä»£ç ç‰‡æ®µçš„ä¸åŒä¹‹å¤„ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ç¼–è¯‘å™¨ç”Ÿæˆäº†ä»€ä¹ˆ:</p><ul class=""><li id="b3dc" class="kk kl hs jj b jk jl jn jo jq km ju kn jy ko kc kp kq kr ks bi translated"><code class="du mm mn mo md b">when</code>è¯­å¥çš„å‚æ•°æ˜¯æ¥è‡ª<code class="du mm mn mo md b">LoginUserStateMachine</code>å®ä¾‹å†…éƒ¨çš„<code class="du mm mn mo md b">label</code>ã€‚</li><li id="f1e7" class="kk kl hs jj b jk ku jn kv jq kw ju kx jy ky kc kp kq kr ks bi translated">æ¯æ¬¡å¤„ç†ä¸€ä¸ªæ–°çŠ¶æ€æ—¶ï¼Œéƒ½ä¼šè¿›è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œä»¥é˜²è¿™ä¸ªå‡½æ•°è¢«æŒ‚èµ·æ—¶å‡ºç°æ•…éšœã€‚</li><li id="fc29" class="kk kl hs jj b jk ku jn kv jq kw ju kx jy ky kc kp kq kr ks bi translated">åœ¨è°ƒç”¨ä¸‹ä¸€ä¸ªæŒ‚èµ·å‡½æ•°(å³<code class="du mm mn mo md b">logUserIn</code>)ä¹‹å‰ï¼Œ<code class="du mm mn mo md b">LoginUserStateMachine</code>å®ä¾‹çš„<code class="du mm mn mo md b">label</code>æ›´æ–°åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚</li><li id="406c" class="kk kl hs jj b jk ku jn kv jq kw ju kx jy ky kc kp kq kr ks bi translated">å½“è¿™ä¸ªçŠ¶æ€æœºå†…éƒ¨è°ƒç”¨å¦ä¸€ä¸ªæŒ‚èµ·å‡½æ•°æ—¶ï¼Œ<code class="du mm mn mo md b">continuation</code>(ç±»å‹ä¸º<code class="du mm mn mo md b">LoginUserStateMachine</code>)çš„å®ä¾‹ä½œä¸ºå‚æ•°ä¼ é€’ã€‚è¦è°ƒç”¨çš„suspendå‡½æ•°ä¹Ÿå·²ç»è¢«ç¼–è¯‘å™¨è½¬æ¢äº†ï¼Œå®ƒæ˜¯å¦ä¸€ä¸ªåƒè¿™æ ·çš„çŠ¶æ€æœºï¼Œå®ƒæ¥å—ä¸€ä¸ªcontinuationå¯¹è±¡ä½œä¸ºå‚æ•°ï¼å½“è¯¥æŒ‚èµ·åŠŸèƒ½çš„çŠ¶æ€æœºå®Œæˆæ—¶ï¼Œå®ƒå°†æ¢å¤è¯¥çŠ¶æ€æœºçš„æ‰§è¡Œã€‚</li></ul><p id="36c9" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">æœ€åä¸€ä¸ªçŠ¶æ€æ˜¯ä¸åŒçš„ï¼Œå› ä¸ºå®ƒå¿…é¡»ç»§ç»­æ‰§è¡Œè°ƒç”¨è¿™ä¸ªçŠ¶æ€çš„å‡½æ•°ï¼Œæ­£å¦‚æ‚¨åœ¨ä»£ç ä¸­çœ‹åˆ°çš„ï¼Œå®ƒè°ƒç”¨å­˜å‚¨åœ¨<code class="du mm mn mo md b">LoginUserStateMachine</code>ä¸­çš„<code class="du mm mn mo md b">cont</code>å˜é‡ä¸Šçš„resume(åœ¨æ„é€ æ—¶):</p><figure class="kz la lb lc fd hj"><div class="bz dy l di"><div class="nd le l"/></div></figure><p id="ebf6" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">å¦‚æ‚¨æ‰€è§ï¼ŒKotlinç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬åšäº†å¾ˆå¤šäº‹æƒ…ï¼ä»è¿™ä¸ªæš‚åœåŠŸèƒ½:</p><pre class="kz la lb lc fd mc md me mf aw mg bi"><span id="7fe9" class="mh lg hs md b fi mi mj l mk ml">suspend fun loginUser(userId: String, password: String): User {<br/>  val user = userRemoteDataSource.logUserIn(userId, password)<br/>  val userDb = userLocalDataSource.logUserIn(user)<br/>  return userDb<br/>}</span></pre><p id="2813" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">ç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†è¿™ä¸€åˆ‡:</p><figure class="kz la lb lc fd hj"><div class="bz dy l di"><div class="nd le l"/></div></figure></div><div class="ab cl ne nf go ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ha hb hc hd he"><p id="fbd8" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">Kotlinç¼–è¯‘å™¨å°†æ¯ä¸ªæŒ‚èµ·å‡½æ•°è½¬æ¢ä¸ºçŠ¶æ€æœºï¼Œæ¯æ¬¡å‡½æ•°éœ€è¦æŒ‚èµ·æ—¶ä½¿ç”¨å›è°ƒè¿›è¡Œä¼˜åŒ–ã€‚</p><p id="8cd7" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">ç°åœ¨çŸ¥é“äº†ç¼–è¯‘å™¨åœ¨å¹•ååšä»€ä¹ˆï¼Œä½ å°±èƒ½æ›´å¥½åœ°ç†è§£ä¸ºä»€ä¹ˆä¸€ä¸ªæŒ‚èµ·å‡½æ•°åœ¨å®ƒå¯åŠ¨çš„æ‰€æœ‰å·¥ä½œå®Œæˆä¹‹å‰ä¸ä¼šè¿”å›ã€‚è¿˜æœ‰ï¼Œä»£ç å¦‚ä½•åœ¨ä¸é˜»å¡çº¿ç¨‹çš„æƒ…å†µä¸‹æŒ‚èµ·:å‡½æ•°æ¢å¤æ—¶éœ€è¦æ‰§è¡Œä»€ä¹ˆçš„ä¿¡æ¯å­˜å‚¨åœ¨<code class="du mm mn mo md b">Continuation</code>å¯¹è±¡ä¸­ï¼</p></div></div>    
</body>
</html>