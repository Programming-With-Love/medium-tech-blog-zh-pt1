<html>
<head>
<title>JavaScript Manipulation on iOS Using WebKit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用WebKit在iOS上操纵JavaScript</h1>
<blockquote>原文：<a href="https://medium.com/capital-one-tech/javascript-manipulation-on-ios-using-webkit-2b1115e7e405?source=collection_archive---------0-----------------------#2018-04-12">https://medium.com/capital-one-tech/javascript-manipulation-on-ios-using-webkit-2b1115e7e405?source=collection_archive---------0-----------------------#2018-04-12</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/9680b0f2efeefcc3a86a1977384f597c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5xfDLydkDpaJ4QiGSubMOg.jpeg"/></div></div></figure><p id="7130" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">作为iOS开发者，有时我们希望在我们的iOS应用中包含网络内容。我们可能希望从与本地应用程序版本配对的网站加载内容，或者我们可能希望让用户打开链接而不必打开另一个浏览器。在iOS 8之前，我们不得不使用笨重、内存泄露、难以调试的<a class="ae jn" href="https://developer.apple.com/documentation/uikit/uiwebview" rel="noopener ugc nofollow" target="_blank"> UIWebView </a>。然而，在iOS 8之后，苹果弃用了UIWebView作为<a class="ae jn" href="https://developer.apple.com/documentation/webkit/wkwebview" rel="noopener ugc nofollow" target="_blank"> WKWebView </a>，并引入了现代<a class="ae jn" href="https://developer.apple.com/documentation/webkit" rel="noopener ugc nofollow" target="_blank"> WebKit API </a>。新框架极大地提高了向iOS应用程序添加网页内容的性能和灵活性，给了开发者更多的控制权和权力。它还极大地改善了与JavaScript的本地通信。</p><p id="e5d5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在这篇文章中，我将向您展示如何将脚本注入到您的网页中，并接收数据来做一些事情，如改变网页的背景或直接从JavaScript调用本机函数。</p><h1 id="3ee5" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">WKWebView</h1><p id="88b6" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">WKWebView于2014年<a class="ae jn" href="https://developer.apple.com/videos/play/wwdc2014/206/" rel="noopener ugc nofollow" target="_blank"> WWDC大会</a>首次发布，它改变了在iOS应用中呈现网络内容的游戏规则。它利用核心动画和硬件加速，使网页能够以60fps的速度滚动。苹果的开发人员去掉了旧的JavaScript引擎，用Nitro取而代之——与Safari的引擎相同。它还包括与Safari相同的内置缩放和前后导航手势。也超级容易创作！让我们从一个简单的例子开始，看看WKWebView开箱后是什么样子。</p><p id="a324" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您需要做的只是创建一个WKWebView对象，添加约束，并传入一个URLRequest来加载网页:</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div><figcaption class="kx ky et er es kz la bd b be z dx">Initializing a basic WKWebView object</figcaption></figure><p id="9171" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您在模拟器中运行这个程序，您应该会看到类似这样的内容:</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div class="er es lb"><img src="../Images/826061eb3828d54ad1f93f9fb6cd6a5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1050/format:webp/1*1aKQPRiLDReTL8NU-6tEIg.png"/></div></figure><p id="65e4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">请注意，您只能加载默认安全的URL(即，仅HTTPS连接)。您可以将“应用传输安全设置”密钥添加到您的Info.plist中，以出于开发目的覆盖此密钥。然后，在应用传输安全设置下，添加密钥“允许任意加载”，并将其值设置为“是”:</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div class="er es lc"><img src="../Images/597c1f2f2b6bf170f3fac31b2f11a841.png" data-original-src="https://miro.medium.com/v2/resize:fit:890/format:webp/1*NhFromyV-nH30f71ERLUhQ.png"/></div></figure><p id="9d1b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这将绕过HTTPS要求，因此您可以使用本地主机或HTTP连接进行测试。但是，请记住，这仅意味着用于开发，而不是用于生产。你应该始终遵守苹果的安全标准，通过行业标准协议安全地加载网页内容。</p><h1 id="7f81" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">WKUserContentController</h1><p id="828a" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">因此，我们只用了几行代码就在应用程序中加载了网络内容。如果我们想修改应用程序中的网页，该怎么办？我们可以像以前一样实例化一个WKWebView对象，但是这次传入一个类型为<a class="ae jn" href="https://developer.apple.com/documentation/webkit/wkwebviewconfiguration" rel="noopener ugc nofollow" target="_blank"> WKWebViewConfiguration </a>的新配置对象:</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div><figcaption class="kx ky et er es kz la bd b be z dx">Initialize WKWebView with Configuration</figcaption></figure><p id="0818" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在这里，当web视图被初始化时，有一大堆属性可以修改。例如，您可以控制页面是否以增量方式呈现，播放前哪些媒体类型需要触摸手势，HTML5视频是否可以画中画显示，或者如何与加载的脚本进行通信。WKWebViewConfiguration有一个名为userContentController的属性，它允许您传入一个<a class="ae jn" href="https://developer.apple.com/documentation/webkit/wkusercontentcontroller" rel="noopener ugc nofollow" target="_blank"> WKUserContentController </a>对象。该对象使用<a class="ae jn" href="https://developer.apple.com/documentation/webkit/wkusercontentcontroller/1537448-adduserscript" rel="noopener ugc nofollow" target="_blank"> addUserScript(_:) </a>注入JavaScript，并通过<a class="ae jn" href="https://developer.apple.com/documentation/webkit/wkusercontentcontroller/1537172-add" rel="noopener ugc nofollow" target="_blank"> add(_:name:) </a>监听消息处理程序。如果你是一名网络开发人员，这类似于浏览器插件如<a class="ae jn" href="https://developer.chrome.com/extensions/getstarted" rel="noopener ugc nofollow" target="_blank"> Chrome extensions </a>对加载的网络内容所做的事情。</p><h1 id="3340" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">用户脚本</h1><p id="4cdf" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">当添加到userContentController时，<a class="ae jn" href="https://developer.apple.com/documentation/webkit/wkuserscript" rel="noopener ugc nofollow" target="_blank"> WKUserScript </a>对象允许开发人员将JavaScript注入到网页中。下面是一个简单的例子，添加一个脚本来改变上面的Google网页的背景颜色:</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div><figcaption class="kx ky et er es kz la bd b be z dx">Creating a User Script to Change Background Color</figcaption></figure><p id="9f53" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">init方法接受三个参数:</p><ol class=""><li id="6f19" class="ld le hh ir b is it iw ix ja lf je lg ji lh jm li lj lk ll bi translated"><em class="lm"> source </em>:传入JavaScript的字符串表示作为源代码。</li><li id="aece" class="ld le hh ir b is ln iw lo ja lp je lq ji lr jm li lj lk ll bi translated"><em class="lm"> injectionTime </em>:指定JavaScript是在文档开始加载还是在文档结束加载。如果您传入<a class="ae jn" href="https://developer.apple.com/documentation/webkit/wkuserscriptinjectiontime/1537575-atdocumentstart" rel="noopener ugc nofollow" target="_blank">wkuserinjectiontime . atdocumentstart</a>，您的脚本将在文档元素创建之后、任何文档解析之前运行。如果您传入<a class="ae jn" href="https://developer.apple.com/documentation/webkit/wkuserscriptinjectiontime/1537798-atdocumentend" rel="noopener ugc nofollow" target="_blank">wkuserinjectiontime . atdocumentend</a>，那么您的脚本将在文档解析完成之后、任何子资源(例如，图像)加载之前运行。这对应于触发DOMContentLoaded事件的时间。</li><li id="1b7f" class="ld le hh ir b is ln iw lo ja lp je lq ji lr jm li lj lk ll bi translated"><em class="lm"> forMainFrameOnly </em>:指定你的脚本是在所有框架中运行还是只在主框架中运行。</li></ol><p id="6f1d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">对于您的源代码，您可以简单地传入一个字符串，或者，如果脚本更复杂，从Xcode中的本地文件加载它。为此，将您的JavaScript文件添加到Xcode，获取文件的路径，并用文件的内容初始化一个字符串:</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div><figcaption class="kx ky et er es kz la bd b be z dx">Load JavaScript from a local file</figcaption></figure><p id="499f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这是一个在初始化时向web视图添加基本用户脚本的简要概述。你还可以写一个用户脚本来做什么？它可以做网页上普通脚本能做的任何事情——修改文档结构、监听onload等事件、加载外部资源(例如，图像、XMLHTTP请求)。它还可以使用脚本消息通过<a class="ae jn" href="https://developer.apple.com/documentation/webkit/wkscriptmessagehandler" rel="noopener ugc nofollow" target="_blank"> WKScriptMessageHandler </a>协议与您的应用程序进行通信。</p><h1 id="69be" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">编写消息脚本</h1><p id="22fa" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">虽然用户脚本可以让您将JavaScript代码注入到网页中，但脚本消息可以让您从JavaScript调用本机代码。为此，在iOS端有几个步骤:</p><ol class=""><li id="28f9" class="ld le hh ir b is it iw ix ja lf je lg ji lh jm li lj lk ll bi translated">对于每个要添加的处理程序，调用WKUserContentController对象上的<a class="ae jn" href="https://developer.apple.com/documentation/webkit/wkusercontentcontroller/1537172-add" rel="noopener ugc nofollow" target="_blank"> add(_:name:) </a>。name参数在后面会很重要。</li><li id="5bd7" class="ld le hh ir b is ln iw lo ja lp je lq ji lr jm li lj lk ll bi translated">让您的视图控制器符合WKScriptMessageHandler协议。</li><li id="993f" class="ld le hh ir b is ln iw lo ja lp je lq ji lr jm li lj lk ll bi translated">实现所需的功能<a class="ae jn" href="https://developer.apple.com/documentation/webkit/wkscriptmessagehandler/1396222-usercontentcontroller" rel="noopener ugc nofollow" target="_blank">userContentController(_:did receive:)</a>。</li></ol><p id="3fcb" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">消息处理程序是一个侦听器，一旦某个JavaScript事件完成，它将触发并返回数据。例如，您可以使用一个处理程序来解析从URL获取的JSON数据。通过将这些消息处理程序包含到您的WKUserContentController对象中，您的web视图将定义一个新的函数window . WebKit . message handlers .<em class="lm">name</em>。可以在所有框架中调用的postMessage( <em class="lm"> messageBody </em>)。下面是一个添加名为“test”的消息处理程序的简单示例，当在脚本标记中调用该处理程序时，它将输出“Hello，world！”：</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div><figcaption class="kx ky et er es kz la bd b be z dx">Add a simple message handler to print Hello, world!</figcaption></figure><p id="3570" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然后，您的JavaScript应该在某处包含以下调用:</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div><figcaption class="kx ky et er es kz la bd b be z dx">Add postMessage() call inside JavaScript code</figcaption></figure><p id="fc46" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">对于消息体，你可以发布任何你喜欢的JSON对象，你的iOS应用程序会将其捕获为一个<a class="ae jn" href="https://developer.apple.com/documentation/webkit/wkscriptmessage" rel="noopener ugc nofollow" target="_blank"> WKScriptMessage </a>对象，然后<em class="lm">会自动将JSON对象转换为原生Swift类型</em>。例如，如果您传递如下所示的JSON</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div><figcaption class="kx ky et er es kz la bd b be z dx">Example JSON for WKScriptMessage Object</figcaption></figure><p id="c180" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">…您可以通过如下类型转换获得年龄:</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div><figcaption class="kx ky et er es kz la bd b be z dx">Parsing an example JSON object from postMessage() call</figcaption></figure><p id="3564" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">超级爽！</p><p id="22bf" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">虽然这在大多数情况下都可以完美地工作，但是Apple可能会将您的JSON对象转换成您可能不会想到的本机类型。根据<a class="ae jn" href="https://developer.apple.com/documentation/webkit/wkscriptmessage/1417901-body" rel="noopener ugc nofollow" target="_blank">苹果的文档</a>，<em class="lm">允许的类型有</em><a class="ae jn" href="https://developer.apple.com/documentation/foundation/nsnumber" rel="noopener ugc nofollow" target="_blank"><em class="lm">ns number</em></a><em class="lm">，</em><a class="ae jn" href="https://developer.apple.com/documentation/foundation/nsstring" rel="noopener ugc nofollow" target="_blank"><em class="lm">ns string</em></a><em class="lm">，</em><a class="ae jn" href="https://developer.apple.com/documentation/foundation/nsdate" rel="noopener ugc nofollow" target="_blank"><em class="lm">ns date</em></a><em class="lm">，</em><a class="ae jn" href="https://developer.apple.com/documentation/foundation/nsarray" rel="noopener ugc nofollow" target="_blank"><em class="lm">ns array</em><em class="lm">，</em> </a><a class="ae jn" href="https://developer.apple.com/documentation/foundation/nsdictionary" rel="noopener ugc nofollow" target="_blank"> <em class="lm"> NSDictionary</em>这意味着，例如，布尔类型将被转换为0表示假，1表示真。</a></p><h1 id="8bc9" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">高级JavaScript用法</h1><p id="71dd" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">将window.webkit.messageHandler函数添加到JavaScript代码中是非常巧妙的，对吗？我们可以做得更好。</p><p id="0d5a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">假设您想同时创建一个iOS和Android应用程序，这两个应用程序加载相同的网页和相同的JavaScript代码。如果包含这些消息处理函数的JavaScript被加载到除了WKWebView对象之外的任何地方，它都不会编译(你可以尝试在Chrome浏览器中加载它，你会得到一个错误)。这意味着你需要为iOS和Android分别编写特定的JavaScript代码。不是很干，是吗？相反，如果我们将消息处理函数直接注入到init上的网页中会怎么样呢？这样，我们可以重复使用相同的网页，而不会重复，并将客户端与服务器分离。下面是从上面注入相同消息处理程序的示例，但这次是通过用户脚本注入的:</p><figure class="kr ks kt ku fd ii"><div class="bz dy l di"><div class="kv kw l"/></div><figcaption class="kx ky et er es kz la bd b be z dx">Inject example postMessage() call</figcaption></figure><p id="f64d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果一切顺利，您应该会看到Xcode的控制台打印“Hello，world！”你可以在这里看到这个<a class="ae jn" href="https://github.com/rckim77/WKWebViewDemoApp" rel="noopener ugc nofollow" target="_blank">的工作演示。</a></p><p id="ab91" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这仅仅触及了用户脚本和消息处理程序的皮毛。我甚至用这种方法从JavaScript库中创建了自己的本地回调，方法是将消息处理程序注入回调函数，并将数据转发给我的应用程序。天空是无限的！</p><h1 id="60f4" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">结论</h1><p id="a404" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">WebKit为iOS开发人员提供了一套强大的工具，可以在本地应用程序的webview中直接操作JavaScript，而无需关注样板代码。您可以使用用户脚本在一行代码中直接在网页中注入JavaScript。您还可以通过遵循WKScriptMessageHandler协议、添加消息处理程序的名称并实现userContentController(_:did receive:)，从JavaScript向您的应用程序发送数据。</p><p id="c2ce" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在你的iOS应用中，你可以用JavaScript做很多事情，甚至不仅仅是加载网页内容。如果你想继续探索，我建议阅读苹果的<a class="ae jn" href="https://developer.apple.com/documentation/javascriptcore" rel="noopener ugc nofollow" target="_blank"> JavaScriptCore </a>框架，用于在你的应用程序中直接运行JavaScript(参考消息，这在一定程度上是React Native等框架的动力所在),以及最近添加的<a class="ae jn" href="https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller" rel="noopener ugc nofollow" target="_blank"> SFSafariViewController </a>，用于模仿Safari的用户体验，具有自动填充、欺诈网站检测等功能。</p><p id="74f3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我希望你对WebKit有所了解——感谢阅读！</p><p id="13ca" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="lm">声明:这些观点仅代表作者个人观点。除非本帖中另有说明，否则Capital One不属于所提及的任何公司，也不被其认可。使用或展示的所有商标和其他知识产权都是其各自所有者的所有权。本文为2018首都一。</em></p></div></div>    
</body>
</html>