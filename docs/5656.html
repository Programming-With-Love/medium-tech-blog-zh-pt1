<html>
<head>
<title>Long Running Actions for MicroProfile on Helidon… Data Integrity for Microservices.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Helidon上微轮廓的长期运行动作…微服务的数据完整性。</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/long-running-actions-for-microprofile-on-helidon-data-integrity-for-microservices-2bd4d14fe955?source=collection_archive---------0-----------------------#2019-09-14">https://medium.com/oracledevs/long-running-actions-for-microprofile-on-helidon-data-integrity-for-microservices-2bd4d14fe955?source=collection_archive---------0-----------------------#2019-09-14</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/590e50eb1a3854a4c44f7a57c21bbafb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0WwrtzAopa7kEpeXbu-1Qg.png"/></div></div></figure><p id="6107" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">微服务对数据的一致性和完整性提出了挑战，这就需要改变它们所使用的事务处理和数据模式。</p><p id="415d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">传统系统依赖于<strong class="ir hi">两阶段提交和XA </strong>协议，这些协议使用同步通信、资源锁定和通过回滚(或提交，视情况而定)进行恢复。虽然这提供了很强的一致性和隔离，但由于持有锁的延迟，它在微服务环境中不能很好地扩展，因此只适合于这种用例的一小部分(通常是吞吐量要求较低的用例)</p><p id="c539" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi"> saga模式</strong>仅使用异步通信和本地资源(无分布式锁)并通过补偿动作进行恢复。这种方法伸缩性很好，因此非常适合微服务环境中的长时间运行的事务。然而，额外的应用设计考虑是必要的，因为读取隔离和补偿逻辑以及调试可能是困难的。</p><p id="2b33" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">微概要文件LRA，如在<a class="ae jn" href="https://github.com/eclipse/microprofile-lra" rel="noopener ugc nofollow" target="_blank">https://github.com/eclipse/microprofile-lra</a>所述，“[…]为服务引入API来协调活动。<br/>该提案的主旨是为松散耦合的服务引入一个API，以协调长期运行的活动，从而保证全球一致的结果，而无需锁定数据。”</p><p id="95e6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在许多方面，长时间运行活动(LRA)API对于微服务之间的关系就像Java事务API (JTA)对于两阶段提交和XA对于传统应用程序的关系一样(或者对于单个微服务内的封闭使用)。</p><p id="4012" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">关于这个话题已经写了很多了，所以这里的重点是在Helidon运行LRA。Helidon使用LRA规范的Narayana实现。</p><h1 id="fd93" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">在Helidon MP使用LRA</h1><p id="b840" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">涉及两个主要部分:</p><ul class=""><li id="6ea6" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">参与者:这些是将参与LRA的JAX-RS微服务，并标注了规范中下表所列的标准<code class="du la lb lc ld b">org.eclipse.microprofile.lra.annotation.ws.rs.LRA</code>值…</li></ul><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es le"><img src="../Images/204d892249a2364e1c13026051d9e971.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jEW-N94M9zXaNmgizqNxpQ.png"/></div></div></figure><ul class=""><li id="35f1" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">LRA协调者:这是一个参与者隐式注册的专用服务(由于他们的LRA注释),负责驱动LRA完成、补偿等..</li></ul><h1 id="e4e1" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">更新您的LRA参与者<code class="du la lb lc ld b">pom.xml (s)</code></h1><p id="38ca" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">添加LRA注释和运行时的依赖关系。</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="b478" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">虽然运行时不需要，但是可以使用构建时LRA注释检查器。</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><h1 id="e1ad" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">在应用程序中添加LRA功能</h1><p id="ce61" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">您的MP javax.ws.rs.core.Application可能已经有了类似的代码。只需添加包含动态特性<code class="du la lb lc ld b">io.narayana.lra.filter.FilterRegistration</code>的代码行:</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><h1 id="3ad6" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">注释端点</h1><p id="bd03" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">向您的微服务端点添加LRA注释。<br/>在本例中，LRA涉及两项服务，即订单服务和库存服务。</p><p id="d86a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">订单服务:</p><ul class=""><li id="fdf8" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">由于<code class="du la lb lc ld b">@LRA(value = LRA.Type.RequiresNew)</code>注释，客户端对<code class="du la lb lc ld b">placeOrder</code>的调用开始LRA，并向LRA协调器注册服务</li><li id="aca7" class="kr ks hh ir b is ll iw lm ja ln je lo ji lp jm kw kx ky kz bi translated">调用库存服务检查库存/传播具有LRA id的<code class="du la lb lc ld b">LRA_HTTP_CONTEXT_HEADER</code>(通过注册客户端LRA过滤器实现)。</li><li id="09ff" class="kr ks hh ir b is ll iw lm ja ln je lo ji lp jm kw kx ky kz bi translated">如果库存存在(默认)，成功返回给订单服务，这隐式地完成了LRA，协调器调用<code class="du la lb lc ld b">@Complete</code>带注释的方法<code class="du la lb lc ld b">completeOrder</code></li><li id="79a4" class="kr ks hh ir b is ll iw lm ja ln je lo ji lp jm kw kx ky kz bi translated">如果库存不存在(通过调用库存服务上的removeInventory端点实现),将失败返回给订单服务，订单服务取消LRA，协调器调用<code class="du la lb lc ld b">@Compensate</code>带注释的方法<code class="du la lb lc ld b">cancelOrder</code></li></ul><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="841a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">库存服务:</p><ul class=""><li id="37c4" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">订单服务对<code class="du la lb lc ld b">reserveInventoryForOrder</code>的调用在LRA内执行，由订单服务根据<code class="du la lb lc ld b">@LRA(value = LRA.Type.Mandatary)</code>注释启动和传播，并向LRA协调器注册服务</li><li id="83bd" class="kr ks hh ir b is ll iw lm ja ln je lo ji lp jm kw kx ky kz bi translated">检查库存并将结果(成功或失败)返回给订单服务</li></ul><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><h1 id="fd3e" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">建立和部署上帝抵抗军协调员</h1><p id="d147" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">添加依赖项来构建和运行LRA协调器服务jar。</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><h1 id="624d" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">构建并启动LRA应用程序</h1><p id="6d4f" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">运行示例<code class="du la lb lc ld b">./build.sh</code>脚本来构建和打包订单和库存参与者服务以及协调器。</p><p id="9dd0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">启动服务。</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><h1 id="9898" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">为成功案例运行LRA应用程序</h1><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="d361" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">请注意订单服务的输出:</p><pre class="lf lg lh li fd lq ld lr ls aw lt bi"><span id="6aa1" class="lu jp hh ld b fi lv lw l lx ly">OrderResource.placeOrder in LRA due to LRA.Type.REQUIRES_NEW lraId:[...]<br/>OrderResource.placeOrder response from inventory:inventorysuccess<br/>OrderResource.completeOrder</span></pre><p id="384d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">请注意库存服务的输出:</p><pre class="lf lg lh li fd lq ld lr ls aw lt bi"><span id="132e" class="lu jp hh ld b fi lv lw l lx ly">InventoryResource.addInventory<br/>InventoryResource.placeOrder in LRA due to LRA.Type.MANDATORY lraID:[...]<br/>InventoryResource.completeOrder prepare item for shipping lraId:[...]</span></pre><h1 id="d15e" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">为补偿情况运行LRA应用程序</h1><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="590d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">请注意订单服务的输出:</p><pre class="lf lg lh li fd lq ld lr ls aw lt bi"><span id="2868" class="lu jp hh ld b fi lv lw l lx ly">OrderResource.placeOrder in LRA due to LRA.Type.REQUIRES_NEW lraId:[...]<br/>OrderResource.placeOrder response from inventory:inventoryfailure<br/>OrderResource.cancelOrder</span></pre><p id="77fc" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">请注意库存服务的输出:</p><pre class="lf lg lh li fd lq ld lr ls aw lt bi"><span id="ab9f" class="lu jp hh ld b fi lv lw l lx ly">InventoryResource.removeInventory<br/>InventoryResource.placeOrder in LRA due to LRA.Type.MANDATORY lraID:[...]<br/>InventoryResource.cancelOrder put inventory back lraId:[...]</span></pre><h1 id="42aa" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">接下来呢？</h1><p id="45e1" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">LRA规范目前完成了88%,预计将包含在下一个MicroProfile版本中。这里可以关注进展:<a class="ae jn" href="https://github.com/eclipse/microprofile-lra/milestone/1" rel="noopener ugc nofollow" target="_blank">https://github.com/eclipse/microprofile-lra/milestone/1</a></p><p id="05b7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在此基础上，Helidon将继续促进微服务数据模式的这一领域和其他领域，提供。</p><ul class=""><li id="0c13" class="kr ks hh ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">等效螺旋支撑</li><li id="ee0b" class="kr ks hh ir b is ll iw lm ja ln je lo ji lp jm kw kx ky kz bi translated">消息传递(和事件源)功能</li><li id="2183" class="kr ks hh ir b is ll iw lm ja ln je lo ji lp jm kw kx ky kz bi translated">高可用性配置</li><li id="a583" class="kr ks hh ir b is ll iw lm ja ln je lo ji lp jm kw kx ky kz bi translated">数据库集成特性</li></ul><p id="f1c6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">例子可以在这里找到:<a class="ae jn" href="https://github.com/paulparkinson/helidon-examples-lra" rel="noopener ugc nofollow" target="_blank">https://github.com/paulparkinson/helidon-examples-lra</a></p></div></div>    
</body>
</html>