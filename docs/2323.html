<html>
<head>
<title>Today I Learned: Mengenal Context pada Golang(2) â€” WithTimeout</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Today I Learned: Mengenal Context pada Golang(2) â€” WithTimeout</h1>
<blockquote>åŽŸæ–‡ï¼š<a href="https://medium.easyread.co/today-i-learned-mengenal-context-pada-golang-2-withtimeout-15a3b3bf009b?source=collection_archive---------5-----------------------#2018-08-01">https://medium.easyread.co/today-i-learned-mengenal-context-pada-golang-2-withtimeout-15a3b3bf009b?source=collection_archive---------5-----------------------#2018-08-01</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="9c6c" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">Penggunaan context menurut yang sering saya gunakan</h2></div><p id="4e3b" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Lanjutan dari tulisan sebelumnya,</p><div class="ky kz gp gr la lb"><a href="https://medium.com/easyread/today-i-learned-mengenal-context-pada-golang-withvalue-907618ceae3" rel="noopener follow" target="_blank"><div class="lc ab fo"><div class="ld ab le cl cj lf"><h2 class="bd io gy z fp lg fr fs lh fu fw im bi translated">Today I Learned: Mengenal Context pada Golang â€” WithValue</h2><div class="li l"><h3 class="bd b gy z fp lg fr fs lh fu fw dk translated">Penggunaan context menurut yang sering saya gunakan</h3></div><div class="lj l"><p class="bd b dl z fp lg fr fs lh fu fw dk translated">medium.com</p></div></div><div class="lk l"><div class="ll l lm ln lo lk lp lq lb"/></div></div></a></div><p id="ecab" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Selain sebagai <em class="lr"> passing value </em> , <em class="lr"> context </em> juga sering digunakan untuk mengontrol proses <em class="lr"> cancellation </em> (pembatalan). Salah satu contoh misalnya ketika kita melakukan <em class="lr"> API call </em> ke <em class="lr"> service </em> lain atau melakukan <em class="lr"> query </em> ke <em class="lr"> database </em> dan <em class="lr"> task </em> - <em class="lr"> task </em> lainnya yang mungkin membutuhkan waktu lama.</p><p id="5e34" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Tujuan <em class="lr"> context </em> sebagai <em class="lr"> cancellation </em> adalah agar aplikasi kita lebih terkontrol dan tidak membuat user menunggu lama ketika sedang melakukan <em class="lr"> request </em> . Sehingga jika suatu saat terjadi keanehan seperti proses <em class="lr"> query </em> ke <em class="lr"> database </em> yang membutuhkan waktu lebih dari 10 detik, kita dapat membatasinya dan membatalkan proses tersebut dengan tenggang waktu tertentu, misalnya 2 detik. Jadi, jika proses sudah berjalan 2 detik dan <em class="lr"> query </em> masih belum kelar maka kita dapat langsung mengembalikan <em class="lr"> error </em> ke <em class="lr"> client </em> ( <em class="lr"> return error </em> ) bahwa server kita sedang bermasalah.</p><p id="7c72" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Selain hal tersebut, <em class="lr"> cancellation </em> juga bisa digunakan untuk mengontrol <em class="lr"> goroutine </em> agar tidak selalu berjalan di <em class="lr"> background </em> . Jadi kita juga bisa membatalkan <em class="lr"> goroutine </em> yang berjalan di <em class="lr"> background </em> dalam tenggat waktu tertentu. Berdasarkan pengalaman saya, konsep <em class="lr"> cancellation </em> dengan <em class="lr"> context </em> ini sering saya lakukan saat menggunakan <em class="lr"> goroutine </em> dan saat melakukan API <em class="lr"> call </em> ke <em class="lr"> service </em> lain.</p><h2 id="611a" class="ls lt in bd lu lv lw dn lx ly lz dp ma kl mb mc md kp me mf mg kt mh mi mj mk bi translated">Gorutine Call dengan context.WithTimeout()</h2><p id="4b14" class="pw-post-body-paragraph kc kd in ke b kf ml jo kh ki mm jr kk kl mn kn ko kp mo kr ks kt mp kv kw kx ig bi translated">Untuk mempermudah memahaminya, saya akan membuat satu contoh kasus sederhana. <em class="lr"> Letâ€™s say </em> kita memiliki satu buah <em class="lr"> service </em> yang akan melakukan API <em class="lr"> call </em> dan <em class="lr"> query </em> ke <em class="lr"> database </em> . Masing-masing proses membutuhkan waktu sekitar beberapa detik agar selesai.</p><p id="b50b" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Misal: <br/> - Untuk API <em class="lr"> call </em> membutuhkan waktu sekitar 1 detik agar selesai. <br/> - Untuk <em class="lr"> query </em> membutuhkan waktu sekitar 10 detik agar selesai</p><p id="71f1" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Di kasus nyata, biasanya kita memiliki <em class="lr"> timeout </em> yang menandakan sebagai batas akhir waktu dari <em class="lr"> request </em> setiap user. Jika melewati <em class="lr"> timeout </em> yang kita sepakati, user akan diberikan <em class="lr"> error </em> agar user tidak menunggu lama.</p><p id="893b" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Contoh <em class="lr"> code </em> :</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="91c9" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Sederhananya, untuk menangani proses ini, kita akan menggunakan <em class="lr"> timeout </em> dengan menggunakan <code class="fe mx my mz na b">time.After</code></p><pre class="mq mr ms mt gt nb na nc nd aw ne bi"><span id="e863" class="ls lt in na b gy nf ng l nh ni">func main() {<br/> <strong class="na io">fbreceiver</strong> := make(chan string)<br/> <strong class="na io">dbreceiver</strong> := make(chan string)<br/> go <strong class="na io"><em class="lr">GetDataFromFacebook</em></strong>(<strong class="na io">fbreceiver</strong>)<br/> go <strong class="na io"><em class="lr">GetDataFromDatabase</em></strong>(<strong class="na io">dbreceiver</strong>)<br/> for i := 0; i &lt; 2; i++ {<br/>  select {<br/>  case fb := <strong class="na io">&lt;-fbreceiver</strong>:<br/>   fmt.Println("&gt;&gt;&gt;&gt;&gt;&gt; Data Received From: ", fb)<br/>  case db := <strong class="na io">&lt;-dbreceiver</strong>:<br/>   fmt.Println("&gt;&gt;&gt;&gt;&gt;&gt; Data Received From: ", db)<br/>  case &lt;-<strong class="na io">time.After</strong>(time.Second * 2): // Membuat batas timeout 2s<br/>   fmt.Println("&gt;&gt;&gt;&gt;&gt; Timeout to process")<br/>  }<br/> }<br/>}</span></pre><p id="4d94" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Kekurangan dari <em class="lr"> pattern </em> ini adalah saat kita menggunakan <em class="lr"> channel </em> kita tidak bisa mengatasi aliran data pada <em class="lr"> channel </em> tersebut. Kita hanya dapat memberitahu kalau fungsi tersebut memiliki waktu sebatas sekian detik.</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi nj"><img src="../Images/92380640a04cedc2ac0f3becfc69b234.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2A8YfXl490VP_-u7Uhk-dA.png"/></div></div><figcaption class="np nq gj gh gi nr ns bd b be z dk">flow channel in Golang without context caused panic</figcaption></figure><p id="7025" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Akibatnya adalah sistem kita akan boros memori atau bahkan menyebabkan <em class="lr"> crash </em> ( <em class="lr"> ini berdasarkan pengalaman pribadi hehehhe </em> ðŸ˜…)</p><p id="be95" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Solusinya adalah ketika menggunakan <em class="lr"> pattern </em> ini, saya akhirnya memilih menggunakan <em class="lr"> context </em> sebagai manajemen <em class="lr"> channel </em> dengan menggunakan <code class="fe mx my mz na b"><strong class="ke io">context.Withtimeout()</strong></code> . Penggunaanya cukup sederhana. Hal yang perlu kita lakukan adalah membuat <code class="fe mx my mz na b"><strong class="ke io">contextnya</strong></code> <em class="lr"> </em> terlebih dahulu lalu melewatkan atau <code class="fe mx my mz na b"><strong class="ke io">pass context</strong></code> tersebut ke semua <em class="lr"> goroutine </em> dan <em class="lr"> handle </em> di dalamnya.</p><pre class="mq mr ms mt gt nb na nc nd aw ne bi"><span id="2c69" class="ls lt in na b gy nf ng l nh ni">ctx, cancel := context.WithTimeout(c, time.Second * 2)// timeout 2s<br/>defer cancel() // semua child function yang menggunakan ctx akan di cancel saat function di return.</span></pre><p id="77ac" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Sehingga proses yang terjadi menjadi seperti bagan di bawah:</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi nt"><img src="../Images/4a23c39072d832086e9c69bee107dae8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yst2rNRSDWN26sZv1bqGyw.png"/></div></div><figcaption class="np nq gj gh gi nr ns bd b be z dk">flow channel and goroutine in Go with context to avoid Panic</figcaption></figure><p id="fbee" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Nah disini, saya membuat <code class="fe mx my mz na b">ctx</code> sebagai indikator agar tidak lagi mengirim ke <em class="lr"> channel </em> yang sudah <em class="lr"> close </em> . Sesaat sebelum mengirim data ke <em class="lr"> channel </em> , saya akan mengecek di <code class="fe mx my mz na b">ctx.Err()</code> apakah terdapat <em class="lr"> error </em> atau tidak, jika tidak ada maka saya mengirim data tersebut ke dalam <em class="lr"> channel </em> . Jika <code class="fe mx my mz na b">ctx.Err()</code> berisi <em class="lr"> error </em> , maka hal tersebut menandakan bahwa <code class="fe mx my mz na b">ctx</code> tersebut sudah <em class="lr"> timeout </em> atau akan dibatalkan oleh <em class="lr"> function </em> <em class="lr"> parent </em> . Sehingga kita tidak perlu lagi mengisi data ke channel.</p><p id="7a1a" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Untuk penerapannya di kodingan dapat dilihat dibawah ini.</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="a7df" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Dengan <em class="lr"> pattern </em> seperti ini, saya bisa mengontrol <em class="lr"> data-flow </em> di dalam <em class="lr"> gorutine </em> dan <em class="lr"> channel </em> , sehingga kita bisa secara eksplisit tidak mengirim data yang diproses di dalam <em class="lr"> goroutine </em> tidak lagi di kirim ke <em class="lr"> channel </em> yang sudah <em class="lr"> close </em> .</p><h2 id="a9c3" class="ls lt in bd lu lv lw dn lx ly lz dp ma kl mb mc md kp me mf mg kt mh mi mj mk bi translated">API Call dengan Context</h2><p id="f8ca" class="pw-post-body-paragraph kc kd in ke b kf ml jo kh ki mm jr kk kl mn kn ko kp mo kr ks kt mp kv kw kx ig bi translated">Tentu saja selain penggunaan pada <em class="lr"> goroutine </em> , kita juga dapat menggunakan <em class="lr"> context </em> pada saat API <em class="lr"> call </em> , hal ini <em class="lr"> disupport </em> pada golang setelah versi 1.7. Jadi ketika membuat <em class="lr"> request </em> , kita dapat menambahkan <em class="lr"> context </em> pada <em class="lr"> request </em> kita yang nantinya akan berguna untuk proses <em class="lr"> cancellation </em> .</p><pre class="mq mr ms mt gt nb na nc nd aw ne bi"><span id="3e33" class="ls lt in na b gy nf ng l nh ni">req, err := http.NewRequest(http.MethodGet, "https://bxcodec.io", nil)</span><span id="6e12" class="ls lt in na b gy nu ng l nh ni">if err != nil {<br/>  return err<br/>}</span><span id="c06c" class="ls lt in na b gy nu ng l nh ni">req = req.WithContext(ctx) // request dengan ctx</span></pre><p id="3877" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Jadi dengan begini setiap <em class="lr"> request </em> kita akan memiliki <em class="lr"> context </em> dan kita memiliki akses penuh terhadap <em class="lr"> request </em> yang akan kita lakukan.</p><h1 id="548f" class="nv lt in bd lu nw nx ny lx nz oa ob ma jt oc ju md jw od jx mg jz oe ka mj of bi translated">Context Lainnya</h1><p id="489a" class="pw-post-body-paragraph kc kd in ke b kf ml jo kh ki mm jr kk kl mn kn ko kp mo kr ks kt mp kv kw kx ig bi translated">Selain sebagai <em class="lr"> cancelation </em> dan <em class="lr"> share data </em> , <em class="lr"> context </em> juga memiliki jenis lainnya, seperti <code class="fe mx my mz na b">context.TODO()</code> , <code class="fe mx my mz na b">context.Background()</code> , dan <code class="fe mx my mz na b">context.WithDeadline()</code> .</p><h2 id="6a04" class="ls lt in bd lu lv lw dn lx ly lz dp ma kl mb mc md kp me mf mg kt mh mi mj mk bi translated">context.TODO()</h2><p id="347b" class="pw-post-body-paragraph kc kd in ke b kf ml jo kh ki mm jr kk kl mn kn ko kp mo kr ks kt mp kv kw kx ig bi translated"><code class="fe mx my mz na b"><strong class="ke io">context.TODO()</strong></code> adalah <em class="lr"> object </em> kosong dari <em class="lr"> context </em> yang tidak memiliki nilai, namun tidak nil. Karena jika nil, akan berdampak <em class="lr"> crash </em> jika digunakan oleh <em class="lr"> child function </em> . Saya biasanya menggunakan ini untuk hal-hal bersifat <em class="lr"> development </em> , khususnya saat membuat <em class="lr"> unit test </em> . Atau kadang jika saya masih ragu, untuk memakai <em class="lr"> context </em> atau tidak ketika menggunakan <em class="lr"> library </em> orang lain yang memiliki parameter <em class="lr"> context </em> . <strong class="ke io"> Jangan pernah memasukkan nil pada parameter yang menerima context!! </strong> Khususnya ketika menggunakan <em class="lr"> library </em> <em class="lr"> open source </em> , karena kita tidak mengetahui apakah <em class="lr"> library </em> tersebut menangani <em class="lr"> nil value </em> dari sebuah <em class="lr"> context </em> . Jika tidak ditangani, maka sistem kita akan <em class="lr"> crash </em> saat menggunakan <em class="lr"> library </em> tersebut. Maka akan lebih baik menggunakan <code class="fe mx my mz na b">context.TODO()</code> sehingga terhindar dari kesalahan kecil ( <em class="lr"> panic </em> ).</p><h2 id="511e" class="ls lt in bd lu lv lw dn lx ly lz dp ma kl mb mc md kp me mf mg kt mh mi mj mk bi translated">context.Background()</h2><p id="089b" class="pw-post-body-paragraph kc kd in ke b kf ml jo kh ki mm jr kk kl mn kn ko kp mo kr ks kt mp kv kw kx ig bi translated"><code class="fe mx my mz na b"><strong class="ke io">context.Background()</strong></code> juga sebuah <em class="lr"> object </em> kosong <em class="lr"> context </em> dan tidak akan pernah <em class="lr"> dicancel </em> . Biasanya ini digunakan pada <em class="lr"> function </em> paling atas. Jika di API REST, kita bisa melihat ini digunakan pada level <em class="lr"> request </em> . Jika kamu melihat <em class="lr"> struct </em> <code class="fe mx my mz na b">http.Request</code> maka kamu akan melihat di dalamnya terdapat <em class="lr"> context </em> . Setiap <em class="lr"> request </em> yang datang akan diset otomatis menjadi <code class="fe mx my mz na b">ctx.Background()</code> .</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div class="gh gi og"><img src="../Images/c89cac2bb610e93c88bc39505d31629d.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*0xzdaeNwmHJS-To0BVyAEg.png"/></div><figcaption class="np nq gj gh gi nr ns bd b be z dk">http.Request struct</figcaption></figure><p id="2332" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="lr"> Source code </em> dapat dilihat langsung di repositorinya <a class="ae oh" href="https://golang.org/src/net/http/request.go?s=2888:11106#L88" rel="noopener ugc nofollow" target="_blank"> Golang </a> .</p><h2 id="700c" class="ls lt in bd lu lv lw dn lx ly lz dp ma kl mb mc md kp me mf mg kt mh mi mj mk bi translated"><code class="fe mx my mz na b">context.WithDeadline()</code></h2><p id="f6ec" class="pw-post-body-paragraph kc kd in ke b kf ml jo kh ki mm jr kk kl mn kn ko kp mo kr ks kt mp kv kw kx ig bi translated"><code class="fe mx my mz na b"><strong class="ke io">context.WithDeadline()</strong></code> cara kerjanya mirip dengan <code class="fe mx my mz na b">context.WithTimeout()</code> , bedanya jika <code class="fe mx my mz na b">context.WithDeadline()</code> kita mengatur <em class="lr"> deadline context </em> tersebut secara eksplisit dengan <em class="lr"> struct </em> <code class="fe mx my mz na b">time.Time</code> , sedangkan <code class="fe mx my mz na b">context.WithTimeout()</code> kita mengatur dengan hitungan satuan waktu tertentu. Dan jika kamu melihat kedalam <code class="fe mx my mz na b">context.WithtTimeout()</code> , kamu akan melihat yang dilakukan adalah memanggil <code class="fe mx my mz na b">context.WithDeadline()</code> juga. Jadi secara umum cara kerjanya mirip.</p><p id="884d" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="ke io"> Referensi </strong> :</p><ul class=""><li id="0b86" class="oi oj in ke b kf kg ki kj kl ok kp ol kt om kx on oo op oq bi translated"><a class="ae oh" href="https://golang.org/pkg/context/" rel="noopener ugc nofollow" target="_blank"> https://golang.org/pkg/context/ </a></li><li id="dfa8" class="oi oj in ke b kf or ki os kl ot kp ou kt ov kx on oo op oq bi translated"><a class="ae oh" href="https://blog.golang.org/context" rel="noopener ugc nofollow" target="_blank"> https://blog.golang.org/context </a></li></ul></div><div class="ab cl ow ox hr oy" role="separator"><span class="oz bw bk pa pb pc"/><span class="oz bw bk pa pb pc"/><span class="oz bw bk pa pb"/></div><div class="ig ih ii ij ik"><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="pd mw l"/></div></figure></div></div>    
</body>
</html>