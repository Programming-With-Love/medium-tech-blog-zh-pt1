<html>
<head>
<title>Understanding Nginx As A Reverse Proxy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Nginx理解为反向代理</h1>
<blockquote>原文：<a href="https://medium.com/globant/understanding-nginx-as-a-reverse-proxy-564f76e856b2?source=collection_archive---------0-----------------------#2021-01-12">https://medium.com/globant/understanding-nginx-as-a-reverse-proxy-564f76e856b2?source=collection_archive---------0-----------------------#2021-01-12</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/3a314e4e3cdcac7b0de655e00a34a9bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oj5meOHdGLnvElIrN4AJKg@2x.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">(Image courtesy from NGINX)</figcaption></figure><p id="4aaa" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi jr translated">ginx 是一个开源的web服务器，它提供了诸如反向代理、缓存、负载平衡、媒体流等功能。它最初是一个为获得最佳性能和稳定性而设计的web服务器。除了HTTP服务器功能，NGINX还可以充当电子邮件(IMAP、POP3和SMTP)的代理服务器，以及HTTP/2、TCP和UDP协议的反向代理和负载平衡器。</p><h1 id="2cdb" class="ka kb hh bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">高请求处理架构</h1><p id="ddda" class="pw-post-body-paragraph it iu hh iv b iw ky iy iz ja kz jc jd je la jg jh ji lb jk jl jm lc jo jp jq ha bi translated">Nginx利用事件驱动的架构，异步处理请求。它被设计成使用非阻塞事件驱动的连接处理算法。因此，它的进程可以在一个处理线程内处理数千个连接(请求)。这种连接处理模块允许Nginx在资源有限的情况下快速、广泛地工作。此外，您可以使用Nginx来处理10，000多个并发连接，在请求负载较重的情况下，资源(CPU和内存)很少。</p><h1 id="be4f" class="ka kb hh bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">Nginx反向代理概述</h1><p id="e533" class="pw-post-body-paragraph it iu hh iv b iw ky iy iz ja kz jc jd je la jg jh ji lb jk jl jm lc jo jp jq ha bi translated">Nginx反向代理充当中间服务器，它拦截客户端请求，并将它们转发到适当的上游后端服务器，然后将服务器的响应转发回客户端。反向代理作为上游服务器之上的抽象层提供了各种好处。</p><h1 id="1604" class="ka kb hh bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">Nginx作为反向代理的重要优势</h1><p id="69fe" class="pw-post-body-paragraph it iu hh iv b iw ky iy iz ja kz jc jd je la jg jh ji lb jk jl jm lc jo jp jq ha bi translated"><strong class="iv hi">负载均衡</strong> : Nginx将客户端请求负载均衡到多个上游服务器，这提高了性能，并在服务器出现故障时提供冗余。这有助于保持应用程序始终运行，以服务于客户端请求，并为应用程序提供更好的SLA。</p><p id="dd7b" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">安全性</strong> : Nginx服务器通过隐藏身份为私有网络中的后端服务器提供安全性。发出请求的客户端不知道后端服务器。它还提供了对多个后端服务器的单点访问，而不管后端网络拓扑如何。</p><p id="26c1" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">缓存</strong> : Nginx可以直接提供图像、视频等静态内容，提供更好的性能。它通过直接提供静态内容而不是将其转发到后端服务器进行处理来减少后端服务器的负载。</p><p id="ee97" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">日志</strong> : Nginx为通过它的后台服务器请求和响应提供了集中的日志，并为故障排除问题提供了一个单一的审计和日志位置。</p><p id="95ba" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi"> TLS/SSL支持</strong> : Nginx允许客户端和服务器之间使用TLS/SSL连接进行安全通信。用户数据保持安全&amp;加密，同时通过HTTPS连接进行传输。</p><p id="f8f7" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">协议支持</strong> : Nginx支持HTTP、HTTPS、HTTP/1.1、HTTP/2、gRPC -超文本传输协议以及IP4 &amp; IP6互联网协议。</p><h1 id="8e7f" class="ka kb hh bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">在Ubuntu上设置Nginx反向代理</h1><h2 id="fa07" class="ld kb hh bd kc le lf lg kg lh li lj kk je lk ll ko ji lm ln ks jm lo lp kw lq bi translated"><strong class="ak">先决条件</strong></h2><p id="b583" class="pw-post-body-paragraph it iu hh iv b iw ky iy iz ja kz jc jd je la jg jh ji lb jk jl jm lc jo jp jq ha bi translated">我们假设。net core web应用程序运行在Ubuntu上的一个轻量级Kestrel web服务器上，在端口5001上为请求提供服务，但不能从互联网访问。我们喜欢将这个应用程序隐藏在Nginx反向代理服务器后面，为来自互联网的请求提供服务。反向代理将请求转发给ASP.NET核心应用程序</p><blockquote class="lr ls lt"><p id="50e3" class="it iu lu iv b iw ix iy iz ja jb jc jd lv jf jg jh lw jj jk jl lx jn jo jp jq ha bi translated"><strong class="iv hi"> Kestrel </strong>对于提供ASP.NET核心的动态内容非常重要。然而，web服务功能并不像服务器那样功能丰富，例如<strong class="iv hi"> IIS </strong>、<strong class="iv hi"> Apache </strong>或<strong class="iv hi"> Nginx </strong>。反向代理服务器可以提供额外的功能，例如从HTTP服务器提供静态内容、缓存请求、压缩请求和SSL终止。</p></blockquote><figure class="lz ma mb mc fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ly"><img src="../Images/2f0f85ce30e7ed046bfb202b2d319a33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gm_q3hi9cBRFeGA1NoxowQ.png"/></div></div></figure><h2 id="24a8" class="ld kb hh bd kc le lf lg kg lh li lj kk je lk ll ko ji lm ln ks jm lo lp kw lq bi translated">配置步骤</h2><ol class=""><li id="02fa" class="md me hh iv b iw ky ja kz je mf ji mg jm mh jq mi mj mk ml bi translated">更新apt包并安装Nginx webserver</li></ol><pre class="lz ma mb mc fd mm mn mo mp aw mq bi"><span id="477e" class="ld kb hh mn b fi mr ms l mt mu">sudo apt update<br/>sudo apt install nginx</span></pre><p id="d83a" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">2.禁用默认预配置的虚拟主机</p><pre class="lz ma mb mc fd mm mn mo mp aw mq bi"><span id="9657" class="ld kb hh mn b fi mr ms l mt mu">sudo unlink /etc/nginx/sites-enabled/default<br/></span></pre><p id="06d3" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">3.导航到目录<code class="du mv mw mx mn b">/etc/nginx/sites-available</code>并创建一个<code class="du mv mw mx mn b">reverse proxy</code>配置文件。</p><pre class="lz ma mb mc fd mm mn mo mp aw mq bi"><span id="e81c" class="ld kb hh mn b fi mr ms l mt mu">cd /etc/nginx/sites-available<br/>nano reverse-proxy.conf</span></pre><p id="fcad" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">4.添加反向代理配置，如下所述</p><pre class="lz ma mb mc fd mm mn mo mp aw mq bi"><span id="2262" class="ld kb hh mn b fi mr ms l mt mu">server {<br/>        listen 80;<br/>        <!-- -->server_name   example.com *.example.com;<br/><br/>        access_log /var/log/nginx/reverse-access.log;<br/>        error_log /var/log/nginx/reverse-error.log;<br/><br/>        location / {<br/>                    proxy_pass http://127.0.0.1:5001;<br/>  }<br/>}</span></pre><p id="2537" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">使用<a class="ae my" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#server_name" rel="noopener ugc nofollow" target="_blank"> <strong class="iv hi"> server_name </strong> </a>指令定义服务器名称，并确定哪个服务器块将处理给定的用户请求。服务器名称是DNS hosts - Nginx将监听的内容，以及您的端口设置。假设你有一个域名，你把你的域名系统A记录，比如example.com，指向你的服务器IP。</p><p id="04ab" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">代理服务器将所有流量所有传入流量重定向到端口5001。运行在Kestrel服务器上的net core web应用程序。<code class="du mv mw mx mn b"> <strong class="iv hi">proxy_pass</strong> defines backend server address.</code></p><p id="a060" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">5.创建一个符号链接。将配置从<code class="du mv mw mx mn b">/etc/nginx/sites-available</code>复制到<code class="du mv mw mx mn b">/etc/nginx/sites-enabled</code></p><pre class="lz ma mb mc fd mm mn mo mp aw mq bi"><span id="5ec0" class="ld kb hh mn b fi mr ms l mt mu">sudo ln -s /etc/nginx/sites-available/reverse-proxy.conf /etc/nginx/sites-enabled/reverse-proxy.conf</span></pre><p id="60e5" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><strong class="iv hi">测试并重启Nginx </strong></p><p id="4311" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">要测试Nginx:</p><pre class="lz ma mb mc fd mm mn mo mp aw mq bi"><span id="4e14" class="ld kb hh mn b fi mr ms l mt mu">sudo service nginx configtest</span></pre><p id="3d1d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">要重新启动Nginx:</p><pre class="lz ma mb mc fd mm mn mo mp aw mq bi"><span id="978d" class="ld kb hh mn b fi mr ms l mt mu">sudo service nginx restart</span></pre><h1 id="0e9b" class="ka kb hh bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">附加Nginx反向代理选项</h1><p id="3f5f" class="pw-post-body-paragraph it iu hh iv b iw ky iy iz ja kz jc jd je la jg jh ji lb jk jl jm lc jo jp jq ha bi translated">在本节中，我们将看到一个推荐的Nginx代理属性和设置的例子。</p><pre class="lz ma mb mc fd mm mn mo mp aw mq bi"><span id="02e9" class="ld kb hh mn b fi mr ms l mt mu"><strong class="mn hi">location/</strong> {<br/>    <strong class="mn hi">proxy_pass</strong> http://127.0.0.1:5001;<br/>    <strong class="mn hi">proxy_http_version</strong>  1.1;<br/>    <strong class="mn hi">proxy_cache_bypass</strong>  $http_upgrade;<br/><br/>    <strong class="mn hi">proxy_set_header</strong> Upgrade           $http_upgrade;<br/>    <strong class="mn hi">proxy_set_header</strong> Connection        "upgrade";<br/>    <strong class="mn hi">proxy_set_header</strong> Host              $host;<br/>    <strong class="mn hi">proxy_set_header</strong> X-Real-IP         $remote_addr;<br/>    <strong class="mn hi">proxy_set_header</strong> X-Forwarded-For   $proxy_add_x_forwarded_for;<br/>    <strong class="mn hi">proxy_set_header</strong> X-Forwarded-Proto $scheme;<br/>    <strong class="mn hi">proxy_set_header</strong> X-Forwarded-Host  $host;<br/>    <strong class="mn hi">proxy_set_header</strong> X-Forwarded-Port  $server_port;<br/>  }</span></pre><ul class=""><li id="851d" class="md me hh iv b iw ix ja jb je mz ji na jm nb jq nc mj mk ml bi translated"><code class="du mv mw mx mn b">proxy_http_version 1.1</code> -定义代理的HTTP协议版本，默认设置为1.0。</li><li id="ebff" class="md me hh iv b iw nd ja ne je nf ji ng jm nh jq nc mj mk ml bi translated"><code class="du mv mw mx mn b">proxy_cache_bypass $http_upgrade</code> -设置条件以避免缓存响应。</li><li id="2875" class="md me hh iv b iw nd ja ne je nf ji ng jm nh jq nc mj mk ml bi translated"><code class="du mv mw mx mn b">Upgrade $http_upgrade</code>和<code class="du mv mw mx mn b">Connection "upgrade"</code>——如果您的应用程序使用Websockets，这些头字段是必需的。</li><li id="7ddb" class="md me hh iv b iw nd ja ne je nf ji ng jm nh jq nc mj mk ml bi translated"><code class="du mv mw mx mn b">X-Real-IP $remote_addr</code> -将真实的客户端远程IP地址转发给代理服务器。</li><li id="a8f4" class="md me hh iv b iw nd ja ne je nf ji ng jm nh jq nc mj mk ml bi translated"><code class="du mv mw mx mn b">X-Forwarded-For $proxy_add_x_forwarded_for</code> -包含客户端代理的每个服务器的IP地址的列表。</li><li id="1c2d" class="md me hh iv b iw nd ja ne je nf ji ng jm nh jq nc mj mk ml bi translated"><code class="du mv mw mx mn b">X-Forwarded-Proto $scheme</code> -对于HTTPS服务器块，来自代理服务器的每个HTTP响应都被重写到HTTPS。</li><li id="c993" class="md me hh iv b iw nd ja ne je nf ji ng jm nh jq nc mj mk ml bi translated"><code class="du mv mw mx mn b">X-Forwarded-Host $host</code> -定义客户端请求的原始主机。</li><li id="b24d" class="md me hh iv b iw nd ja ne je nf ji ng jm nh jq nc mj mk ml bi translated"><code class="du mv mw mx mn b">X-Forwarded-Port $server_port</code> -定义客户端请求的原始端口。</li></ul><h1 id="721c" class="ka kb hh bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated"><strong class="ak">结论</strong></h1><p id="0ea1" class="pw-post-body-paragraph it iu hh iv b iw ky iy iz ja kz jc jd je la jg jh ji lb jk jl jm lc jo jp jq ha bi translated">Nginx是一个功能丰富的web服务器，可以充当高级反向代理，这很简单&amp;易于配置和管理。</p></div></div>    
</body>
</html>