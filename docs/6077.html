<html>
<head>
<title>Building security into our deployment service system</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将安全性融入我们的部署服务系统</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/building-security-into-our-deployment-service-system-3d6992cb2584?source=collection_archive---------2-----------------------#2015-12-04">https://medium.com/pinterest-engineering/building-security-into-our-deployment-service-system-3d6992cb2584?source=collection_archive---------2-----------------------#2015-12-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="23ed" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Nick DeChant | Pinterest基础设施工程师</p><p id="12fc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们使用自己构建的名为<a class="ae jc" href="https://engineering.pinterest.com/blog/under-hood-teletraan-deploy-system" rel="noopener ugc nofollow" target="_blank"> Teletraan </a>的内部部署服务系统向全球的Pinners推送新代码。我们对Teletraan的目标是尽可能可靠和直接，为工程师消除任何与部署相关的问题。为了实现这一点，我们付出了巨大的努力来保持我们的部署过程和系统的安全。</p><p id="1e34" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以前，Teletraan在执行操作时没有本机身份验证和授权检查，因此我们的产品和内部工具面临跨团队意外部署相关变更的风险。随着我们作为一个组织继续快速发展，拥有一个强大的权限控制机制以防止Pinners和我们作为工程师的生产力可能出现的不良体验是非常重要的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/21044970da99b7924321b732a80f076c.png" data-original-src="https://miro.medium.com/v2/resize:fit:902/format:webp/0*RmjtEm0QMg94Unb5.png"/></div></figure><h2 id="3758" class="jl jm hh bd jn jo jp jq jr js jt ju jv ip jw jx jy it jz ka kb ix kc kd ke kf bi translated">基于角色的权限和访问控制列表</h2><p id="1a27" class="pw-post-body-paragraph ie if hh ig b ih kg ij ik il kh in io ip ki ir is it kj iv iw ix kk iz ja jb ha bi translated">在Pinterest，部署安全权限是基于个人团队所有权的想法。很重要的一点是，任何种类的权限系统都会对每个团队的部署过程产生最小的影响，而且还会保护他们的服务环境免受意外的更改。</p><p id="f5fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的部署系统是一个传统的三层系统:前端web UI，MySQL后端和中间的RESTful服务(也称为Teletraan服务器)。Teletraan服务器基于三种不同的令牌对来自web UI和命令行的请求进行身份验证:短期OAuth令牌、个人长期OAuth令牌和Teletraan托管脚本令牌。授权是通过对照用户角色或团队角色请求的资源要求来执行的。</p><p id="a179" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Teletraan在这方面的配置非常灵活。打开或关闭任何身份验证和授权的组合就像在配置文件中删除或添加行一样简单。</p><h2 id="bbaa" class="jl jm hh bd jn jo jp jq jr js jt ju jv ip jw jx jy it jz ka kb ix kc kd ke kf bi translated">基于令牌的认证</h2><p id="4b78" class="pw-post-body-paragraph ie if hh ig b ih kg ij ik il kh in io ip ki ir is it kj iv iw ix kk iz ja jb ha bi translated">当用户通过web UI访问Teletraan时，前端客户端将与我们内部的OAuth 2.0服务器一起工作，通过OAuth v2工作流并获得一个短期令牌。然后，web用户界面将在HTTP头中使用此令牌，用于对Teletraan服务器的任何后续调用。例如，下面描述了使用特定令牌创建部署的命令行请求:</p><pre class="je jf jg jh fd kl km kn ko aw kp bi"><span id="7131" class="jl jm hh km b fi kq kr l ks kt">curl -H "Authorization: token &lt;token&gt;" -H "Content-Type: application/json" -X POST https://&lt;yourSite&gt;.com/v1/envs/&lt;environmentName&gt;/&lt;stageName&gt;/deploys/?build_id=12345&amp;description=foo</span></pre><p id="1dd1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此外，用户可以从OAuth服务器手动获取长期令牌，并使用它们通过RESTful API调用访问Teletraan服务器。短期令牌和长期令牌都是OAuth令牌。Teletraan服务器将直接向OAuth服务器验证这些令牌。</p><p id="14f3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Teletraan服务器还发布和维护脚本令牌，供脚本使用。脚本标记不是OAuth标记。Teletraan中只有管理员级别的用户可以为他们各自的环境创建脚本令牌。</p><p id="3430" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们计划在不久的将来开源Teletraan，考虑到这一点，我们让我们的部署安全模型支持OpenID Connect。使用您的Google、Amazon或任何其他OpenID Connect支持的登录服务进行身份验证很容易配置，其工作方式与查询我们的内部OAuth服务器相同。只需在配置文件中更改几个端点URL。</p><h2 id="9263" class="jl jm hh bd jn jo jp jq jr js jt ju jv ip jw jx jy it jz ka kb ix kc kd ke kf bi translated">批准</h2><p id="06e5" class="pw-post-body-paragraph ie if hh ig b ih kg ij ik il kh in io ip ki ir is it kj iv iw ix kk iz ja jb ha bi translated">一旦通过身份验证，就会对MySQL数据库角色表进行授权检查。在命令行中，使用相同的方法对请求需求进行授权。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es ku"><img src="../Images/8aa2f84ec37c4a50f81a72eebdcfd81f.png" data-original-src="https://miro.medium.com/v2/resize:fit:904/format:webp/0*uvjgURNZkeR3jVc2.png"/></div></div></figure><h2 id="1bcd" class="jl jm hh bd jn jo jp jq jr js jt ju jv ip jw jx jy it jz ka kb ix kc kd ke kf bi translated">授权级别</h2><p id="33fe" class="pw-post-body-paragraph ie if hh ig b ih kg ij ik il kh in io ip ki ir is it kj iv iw ix kk iz ja jb ha bi translated">我们创建了具有明确角色的分层级别，并让它们在未来随着新角色的出现而变化和发展。除了角色，我们还设计了一个称为资源的抽象层，其中包含ID和类型等信息。这使我们能够将我们的权限设计应用于具有不同分解组件的其他应用程序，例如主机或组，以及我们当前的Teletraan服务环境用例。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kz"><img src="../Images/2f8022b73402cd47991a5750e561ebd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1378/format:webp/0*W6Yolj-OrSCwDzPA.png"/></div></figure><p id="dd19" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这种设计提供了一种有效的方法来保护我们的服务环境并确保部署安全。随着我们继续构建我们的云平台，我们打算在我们所有的云服务中使用这种模式。</p><p id="10bb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们很高兴在明年年初开源Teletraan，它将支持访问控制列表模型。你可以在之前的<a class="ae jc" href="https://engineering.pinterest.com/blog/under-hood-teletraan-deploy-system" rel="noopener ugc nofollow" target="_blank">博客文章</a>中了解更多关于Teletraan作为部署服务系统的信息。</p><p id="8f2e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="la">鸣谢:Teletraan由云工程团队的Jinru He、Linda Lo、gang Song和Nick DeChant构建。我们还要感谢云工程团队的Devin Lundberg在安全设计方面给予的帮助。</em></p></div></div>    
</body>
</html>