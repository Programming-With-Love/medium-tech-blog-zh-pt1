<html>
<head>
<title>Kotlin/JS configuration made simple</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kotlin/JS配置变得简单</h1>
<blockquote>原文：<a href="https://blog.kotlin-academy.com/kotlin-js-configuration-made-simple-ef0e361fcd4?source=collection_archive---------3-----------------------#2018-02-19">https://blog.kotlin-academy.com/kotlin-js-configuration-made-simple-ef0e361fcd4?source=collection_archive---------3-----------------------#2018-02-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="3352" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你以前用Gradle做过Kotlin/JS，配置可能相当复杂。Webpack和Gradle互相调用，多个Webpack配置文件……真是一塌糊涂。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/70a90889cf654d476e522bc9cc385bc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*cPQONHYVCsZVvAQ9.jpg"/></div></figure><p id="bc19" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">幸运的是，现在它已经改变了，你可以<a class="ae kq" href="https://github.com/MarcinMoskala/KotlinAcademyApp/commit/a8d6b26ad8effa285b64d59cede7af0360f953d2" rel="noopener ugc nofollow" target="_blank">使用新的可能性来使你的配置清晰简单</a>。我很乐意解释如何使用<code class="fe kr ks kt ku b"><a class="ae kq" href="https://github.com/Kotlin/kotlin-frontend-plugin" rel="noopener ugc nofollow" target="_blank">kotlin-frontend-plugin</a></code>进行前端梯度配置。请注意，这是一个官方的Kotlin插件，所以它将继续存在，并将与Kotlin生态系统的其他部分一起开发。</p><h2 id="cbce" class="kv kw in bd kx ky kz dn la lb lc dp ld jv le lf lg jz lh li lj kd lk ll lm ln bi translated">基本配置</h2><p id="e708" class="pw-post-body-paragraph jk jl in jm b jn lo jp jq jr lp jt ju jv lq jx jy jz lr kb kc kd ls kf kg kh ig bi translated">在最小版本中，您在Gradle配置中需要的是:</p><pre class="kj kk kl km gt lt ku lu lv aw lw bi"><span id="445c" class="kv kw in ku b gy lx ly l lz ma">apply plugin: 'org.jetbrains.kotlin.frontend'<br/>apply plugin: 'kotlin2js'</span><span id="f51e" class="kv kw in ku b gy mb ly l lz ma">// kotlin2js configuration<br/>compileKotlin2Js {<br/>  kotlinOptions <br/>    metaInfo = true<br/>    outputFile = "$project.buildDir.path/js/${project.name}.js"<br/>    sourceMap = true<br/>    moduleKind = 'commonjs'<br/>    main = "call"<br/>  }<br/>}</span><span id="8b56" class="kv kw in ku b gy mb ly l lz ma">dependencies {<br/>  compile "org.jetbrains.kotlin:kotlin-stdlib-js:$kotlin_version"<br/>  // Your other dependencies<br/>}</span></pre><p id="4567" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用这种配置，您可以构建一个功能完整的项目。如果您分析它，您可以找到依赖项和说明Kotlin文件应该如何编译的<code class="fe kr ks kt ku b">kotlin2js</code>配置。没有<code class="fe kr ks kt ku b"><a class="ae kq" href="https://github.com/Kotlin/kotlin-frontend-plugin" rel="noopener ugc nofollow" target="_blank">kotlin-frontend-plugin</a></code> ( <code class="fe kr ks kt ku b">org.jetbrains.kotlin.frontend</code>)配置。这是因为该插件可以与默认的一个。虽然我们可以指定一个，使用<code class="fe kr ks kt ku b">kotlinFrontend</code>块。在里面我们可以指定一些重要的东西，比如:</p><ul class=""><li id="4409" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mh mi mj mk bi translated">我们想要使用的Node.js版本</li><li id="5f33" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">npm依赖项</li><li id="b3df" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">webpack的配置</li></ul><p id="39c6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们看看我们如何能做它。</p><blockquote class="mq mr ms"><p id="957d" class="jk jl mt jm b jn jo jp jq jr js jt ju mu jw jx jy mv ka kb kc mw ke kf kg kh ig bi translated">Webpack当前要求将<code class="fe kr ks kt ku b">moduleKind</code>设置为以下之一:<code class="fe kr ks kt ku b">'commonjs'</code>、<code class="fe kr ks kt ku b">'amd'</code>或<code class="fe kr ks kt ku b">'umd'</code>。<code class="fe kr ks kt ku b">'plain'</code>，即默认，不适合。这就是为什么如果我们想使用插件，需要在<code class="fe kr ks kt ku b">compileKotlin2Js</code>块中指定<code class="fe kr ks kt ku b">moduleKind</code>。</p></blockquote><h2 id="7f9e" class="kv kw in bd kx ky kz dn la lb lc dp ld jv le lf lg jz lh li lj kd lk ll lm ln bi translated">Kotlin前端插件配置</h2><p id="b038" class="pw-post-body-paragraph jk jl in jm b jn lo jp jq jr lp jt ju jv lq jx jy jz lr kb kc kd ls kf kg kh ig bi translated">从<a class="ae kq" href="https://github.com/MarcinMoskala/KotlinAcademyApp" rel="noopener ugc nofollow" target="_blank"> Kot来分析配置吧。学院申请</a>为例:</p><pre class="kj kk kl km gt lt ku lu lv aw lw bi"><span id="1058" class="kv kw in ku b gy lx ly l lz ma">kotlinFrontend {<br/>    downloadNodeJsVersion = <strong class="ku io">'latest'</strong> // 1</span><span id="1287" class="kv kw in ku b gy mb ly l lz ma"><strong class="ku io">    </strong>npm { // 2<br/>        dependency(<strong class="ku io">"firebase"</strong>, <strong class="ku io">"^4.6.2"</strong>)<br/>        dependency(<strong class="ku io">"react"</strong>, <strong class="ku io">"15.6.1"</strong>)<br/>        dependency(<strong class="ku io">"react-dom"</strong>, <strong class="ku io">"15.6.1"</strong>)<br/>        dependency(<strong class="ku io">"react-router-dom"</strong>, <strong class="ku io">"4.2.2"</strong>)<br/>    }</span><span id="67cb" class="kv kw in ku b gy mb ly l lz ma">    sourceMaps = <strong class="ku io">true</strong> // 3</span><span id="d386" class="kv kw in ku b gy mb ly l lz ma"><strong class="ku io">    </strong>webpackBundle { // 4<br/>        bundleName = <strong class="ku io">"main"</strong> // 5<strong class="ku io"><br/>        </strong>contentPath = file(<strong class="ku io">'src/main/web'</strong>) // 6<br/>        proxyUrl = <strong class="ku io">"http://localhost:8080"</strong> // 7<strong class="ku io"><br/>    </strong>}<br/>}</span></pre><ol class=""><li id="ea33" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mx mi mj mk bi translated">这就是我们总是希望使用最新Node.js版本的原因。</li><li id="3ba0" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mx mi mj mk bi translated">我们指定npm依赖关系。我们可以使用<code class="fe kr ks kt ku b">dependency</code>要求正常的依赖关系，或者使用<code class="fe kr ks kt ku b">devDependency</code>要求开发依赖关系(这些依赖关系不会随您的应用程序一起分发)。</li><li id="462d" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mx mi mj mk bi translated">我们启用源地图。当我们需要调试应用程序时，源代码图可以帮助我们——它们允许我们对Kotlin代码进行操作，而不是对由<code class="fe kr ks kt ku b">kotlin2js</code>插件创建的模糊的JavaScript结果进行操作。</li><li id="c7b4" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mx mi mj mk bi translated">我们配置webpack捆绑包。Bundle是从我们所有的Kotlin源代码和依赖项中创建的单一JavaScript文件。</li><li id="4306" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mx mi mj mk bi translated">我们可以指定包名。当我们将其设置为“XXX”时，生成的包将被命名为“XXX.bundle.js”。默认名称是模块的名称，因此在本例中，它应该是“web.bundle.js”。一旦我们将name设置为“main”，生成的包就是“main.bundle.js”。重要信息:这个命名将这个插件与以前的配置区分开来。一旦转移到<code class="fe kr ks kt ku b"><a class="ae kq" href="https://github.com/Kotlin/kotlin-frontend-plugin" rel="noopener ugc nofollow" target="_blank">kotlin-frontend-plugin</a></code>，记得在<code class="fe kr ks kt ku b">index.html</code>中更改包名。</li><li id="3fc9" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mx mi mj mk bi translated">我们指定静态文件的位置。它们包括<code class="fe kr ks kt ku b">index.html</code>，图像，css文件等。</li><li id="5d9f" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mx mi mj mk bi translated">在这里，我们指定后端网络服务器的位置。所有外部电话都将被转接到那里。</li></ol><blockquote class="my"><p id="359a" class="mz na in bd nb nc nd ne nf ng nh kh dk translated">给出的配置指定了Gradle和Webpack的依赖关系，它们都是在我们构建项目时下载的。这个插件让我们可以一起使用两个构建系统，并在一个构建过程中发挥它们的最大优势。</p></blockquote><p id="ee38" class="pw-post-body-paragraph jk jl in jm b jn ni jp jq jr nj jt ju jv nk jx jy jz nl kb kc kd nm kf kg kh ig bi translated">就是这样——对于一个全功能的项目！Gradle和Webpack在一个文件中配置如此容易。太简单了，:D</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi nn"><img src="../Images/52e44ad366ea18edcce098bd698ec6d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5Ta7WecnyBzWFvOI.jpg"/></div></div></figure><p id="27da" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您需要更多，还有其他一些webpack配置:</p><pre class="kj kk kl km gt lt ku lu lv aw lw bi"><span id="669d" class="kv kw in ku b gy lx ly l lz ma">kotlinFrontend {<br/>    webpackBundle {<br/>        bundleName = "main"<br/>        sourceMapEnabled = true|false // enable/disable source maps <br/>        contentPath = file(...) // a file that represents a directory to be served by dev server)<br/>        publicPath = "/"  // web prefix<br/>        host = "localhost" // dev server host<br/>        port = 8088   // dev server port<br/>        proxyUrl = "" | "http://...."  // URL to be proxied, useful to proxy backend webserver<br/>        stats = "errors-only"  // log level<br/>    }<br/>}</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="https://www.kt.academy/#workshops-offer"><div class="gh gi ns"><img src="../Images/018370a2476e1ce49e6d3299428b4f2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K-f1laplrjQQAMlYKfLgHw.png"/></div></a></figure><h2 id="d318" class="kv kw in bd kx ky kz dn la lb lc dp ld jv le lf lg jz lh li lj kd lk ll lm ln bi translated">构建和运行</h2><p id="31dd" class="pw-post-body-paragraph jk jl in jm b jn lo jp jq jr lp jt ju jv lq jx jy jz lr kb kc kd ls kf kg kh ig bi translated">我们可以使用<code class="fe kr ks kt ku b">run</code>任务在本地运行前端:(在所有这些命令中，我们假设前端模块被命名为<code class="fe kr ks kt ku b">web</code></p><pre class="kj kk kl km gt lt ku lu lv aw lw bi"><span id="bbb1" class="kv kw in ku b gy lx ly l lz ma">./gradlew :web:run</span></pre><p id="0747" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这将启动服务于网站的后台守护程序。</p><p id="01cd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦启动网站将在后台运行。我们可以使用<code class="fe kr ks kt ku b">stop</code>任务来停止它:</p><pre class="kj kk kl km gt lt ku lu lv aw lw bi"><span id="7fee" class="kv kw in ku b gy lx ly l lz ma">./gradlew :web:stop</span></pre><p id="c6cd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以使用<code class="fe kr ks kt ku b">build</code>任务构建一个模块:</p><pre class="kj kk kl km gt lt ku lu lv aw lw bi"><span id="2dc9" class="kv kw in ku b gy lx ly l lz ma">./gradlew :web:build</span></pre><p id="e2d2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果我们只需要捆绑生成，我们可以使用捆绑任务:</p><pre class="kj kk kl km gt lt ku lu lv aw lw bi"><span id="752d" class="kv kw in ku b gy lx ly l lz ma">./gradlew :web:bundle</span></pre><p id="7898" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">请注意，如果我们需要将应用程序分发到某个外部服务器，我们需要构建bundle，并将其与静态服务的静态文件信息后端文件夹一起复制。您可以使用复制任务来完成。<a class="ae kq" href="https://github.com/MarcinMoskala/KotlinAcademyApp" rel="noopener ugc nofollow" target="_blank">这里</a>我们定义了<code class="fe kr ks kt ku b">serverPrepare</code>任务，用于准备准备好服务后端和前端的jar。</p><h2 id="fcff" class="kv kw in bd kx ky kz dn la lb lc dp ld jv le lf lg jz lh li lj kd lk ll lm ln bi translated">热更换</h2><p id="58f5" class="pw-post-body-paragraph jk jl in jm b jn lo jp jq jr lp jt ju jv lq jx jy jz lr kb kc kd ls kf kg kh ig bi translated">该插件支持热替换。在最简单的情况下，您所需要的就是运行一个带有<code class="fe kr ks kt ku b">-t</code>标志的模块:</p><pre class="kj kk kl km gt lt ku lu lv aw lw bi"><span id="aac4" class="kv kw in ku b gy lx ly l lz ma">./gradlew -t :web:run<!-- --> </span></pre><p id="176a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果我们需要在热替换过程中保留一些数据，那么我们需要将它们保留在状态中，并在重装后恢复它们。这是可以做到的:</p><pre class="kj kk kl km gt lt ku lu lv aw lw bi"><span id="6651" class="kv kw in ku b gy lx ly l lz ma">module.hot?.let { hot -&gt;<br/>    hot.accept() // accept hot reload<br/>    hot.dispose { data -&gt;<br/>        data.my-fields = myGetStateFunction(data)<br/>    }<br/>}</span><span id="d029" class="kv kw in ku b gy mb ly l lz ma">module.hot?.data?.let { data -&gt; <br/>    myRestoreFunction(data)<br/>}</span></pre><h2 id="7783" class="kv kw in bd kx ky kz dn la lb lc dp ld jv le lf lg jz lh li lj kd lk ll lm ln bi translated">测试</h2><p id="ba59" class="pw-post-body-paragraph jk jl in jm b jn lo jp jq jr lp jt ju jv lq jx jy jz lr kb kc kd ls kf kg kh ig bi translated">该插件支持使用Karma框架进行测试，但它需要额外的配置。这里有一个例子:</p><pre class="kj kk kl km gt lt ku lu lv aw lw bi"><span id="782b" class="kv kw in ku b gy lx ly l lz ma">kotlinFrontend {<br/>    karma {<br/>        port = 9876<br/>        runnerPort = 9100<br/>        reporters = listOf("progress") <br/>        frameworks = listOf("qunit") // 1<br/>        preprocessors = listOf("...")<br/>    }<br/>}</span></pre><ol class=""><li id="f5df" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mx mi mj mk bi translated">目前仅支持Qunit。</li></ol><p id="d066" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">相反，我们也可以使用经典的Karma配置:</p><pre class="kj kk kl km gt lt ku lu lv aw lw bi"><span id="8373" class="kv kw in ku b gy lx ly l lz ma">kotlinFrontend {<br/>    karma {<br/>        customConfigFile = "myKarma.conf.js"<br/>    }<br/>}</span></pre><p id="ee46" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们可以使用<code class="fe kr ks kt ku b">test</code>任务运行测试:</p><pre class="kj kk kl km gt lt ku lu lv aw lw bi"><span id="b934" class="kv kw in ku b gy lx ly l lz ma">./gradlew :web:test</span></pre><h2 id="2a53" class="kv kw in bd kx ky kz dn la lb lc dp ld jv le lf lg jz lh li lj kd lk ll lm ln bi translated">摘要</h2><p id="dd54" class="pw-post-body-paragraph jk jl in jm b jn lo jp jq jr lp jt ju jv lq jx jy jz lr kb kc kd ls kf kg kh ig bi translated">带<code class="fe kr ks kt ku b"><a class="ae kq" href="https://github.com/Kotlin/kotlin-frontend-plugin" rel="noopener ugc nofollow" target="_blank">kotlin-frontend-plugin</a></code>的Kotlin/JS功能齐全，随时可以使用。它简单而直观。这个插件非常重要，尤其是在多平台项目中，我们需要使用Gradle来构建前端模块。<a class="ae kq" href="https://github.com/MarcinMoskala/KotlinAcademyApp/commit/a8d6b26ad8effa285b64d59cede7af0360f953d2" rel="noopener ugc nofollow" target="_blank">迁徙于康泰。Academy应用程序</a>很简单，主要包括删除过时的配置文件。此外，这个插件是由Kotlin团队开发的，使用起来很安全。这看起来像最终的Kotlin前端配置。我认为这是Kotlin迈出的一大步，作为一个多平台解决方案。</p></div><div class="ab cl nt nu hr nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ig ih ii ij ik"><h2 id="c60c" class="kv kw in bd kx ky kz dn la lb lc dp ld jv le lf lg jz lh li lj kd lk ll lm ln bi translated">学到了什么？单击👏说“谢谢！”并帮助他人找到这篇文章。</h2><p id="2eda" class="pw-post-body-paragraph jk jl in jm b jn lo jp jq jr lp jt ju jv lq jx jy jz lr kb kc kd ls kf kg kh ig bi translated">如果你认为这很重要，与他人分享。</p><p id="6d0a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你需要Kotlin工作室吗？访问<a class="ae kq" href="https://www.kt.academy/" rel="noopener ugc nofollow" target="_blank">我们的网站</a>，看看我们能为您做些什么。</p><p id="effd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">了解卡帕头最新的重大新闻。学院，<a class="ae kq" href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a" rel="noopener ugc nofollow" target="_blank">订阅时事通讯</a>，<a class="ae kq" href="https://twitter.com/ktdotacademy" rel="noopener ugc nofollow" target="_blank">观察Twitter </a>并在medium上关注我们。</p><p id="f6e3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我要感谢<a class="ae kq" href="https://twitter.com/edvinsyse" rel="noopener ugc nofollow" target="_blank"> Edvin Syse </a>对范例项目的重要贡献。也感谢Ilya Gorbunov对本文的重要更正。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><a href="http://eepurl.com/diMmGv"><div class="gh gi oa"><img src="../Images/5ce68714efe3efc036e06786166954ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uDqv_d5NZnPUJA0FeZqhqQ.png"/></div></a></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="gh gi ob"><img src="../Images/77f73b2843c7321d074810231e681255.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*oKagsKgwb58Hot8vtthl3g.gif"/></div></div></figure></div></div>    
</body>
</html>