<html>
<head>
<title>How to create custom migrations in Django</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在姜戈创建自定义迁移</h1>
<blockquote>原文：<a href="https://medium.com/quick-code/how-to-create-custom-migrations-in-django-610718f49ae2?source=collection_archive---------0-----------------------#2019-08-31">https://medium.com/quick-code/how-to-create-custom-migrations-in-django-610718f49ae2?source=collection_archive---------0-----------------------#2019-08-31</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/7e5767bdcc23965f2cf46c642a7c78ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iV2iiYeSaiNxzIsG7_CI9A.jpeg"/></div></div></figure><p id="d51a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最近，我陷入了一个与数据库模式相关的问题。有什么问题吗？让我们先理解这个问题。</p><p id="54ee" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">有一个表格包含用户的银行账户详细信息和用户个人详细信息。在由其他人开发之后，我必须为一个用户添加多个银行账户。</p><p id="f796" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">让我们看看桌子。</p><p id="f3ef" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jn jo jp jq b">users</code>银行账户明细表。</p><figure class="js jt ju jv fd ii er es paragraph-image"><div class="er es jr"><img src="../Images/fcdcaed55672ef15dcd1770cff9d5776.png" data-original-src="https://miro.medium.com/v2/resize:fit:1370/format:webp/1*fC1WuULa8dmuX7UMbzODoQ.jpeg"/></div><figcaption class="jw jx et er es jy jz bd b be z dx">Previous users table with a bank account details</figcaption></figure><p id="90f3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当时我想到了两个解决方案。</p><ol class=""><li id="4453" class="ka kb hh ir b is it iw ix ja kc je kd ji ke jm kf kg kh ki bi translated">如果用户添加了1个以上的银行账户，则创建另一个包含银行账户的表<code class="du jn jo jp jq b">bank_accounts</code>。在这种情况下，1个银行账户在<code class="du jn jo jp jq b">users</code>表中，其他账户在该表中。这种方法不包含任何数据迁移。</li><li id="299a" class="ka kb hh ir b is kj iw kk ja kl je km ji kn jm kf kg kh ki bi translated">为用户的所有银行账户创建单独的表格。在这种情况下，我们必须将银行账户明细从表中移到一个新表中。这种方法包含数据迁移。</li></ol><p id="6eb4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">由于以下几点，我选择了第二个解决方案。</p><ol class=""><li id="7a0e" class="ka kb hh ir b is it iw ix ja kc je kd ji ke jm kf kg kh ki bi translated">银行账户是一个不同的实体，必须在一个单独的表中管理。</li></ol><p id="c20f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">2.银行账户的CRUD操作很简单，因为我们只需要在<code class="du jn jo jp jq b">bank_accounts</code>表中执行这些操作。在第一种方法中，我们必须检查<code class="du jn jo jp jq b">users</code>和<code class="du jn jo jp jq b">bank_accounts</code>表。</p><p id="a529" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">#2方法中的<code class="du jn jo jp jq b">users</code>和<code class="du jn jo jp jq b">bank_accounts</code>表。</p><figure class="js jt ju jv fd ii er es paragraph-image"><div class="er es ko"><img src="../Images/05bef42d6529e00b86d569ed9216b328.png" data-original-src="https://miro.medium.com/v2/resize:fit:404/format:webp/1*cy_RZteIvjWW2toTbmlv9Q.jpeg"/></div><figcaption class="jw jx et er es jy jz bd b be z dx">Updated user table</figcaption></figure><figure class="js jt ju jv fd ii er es paragraph-image"><div class="er es kp"><img src="../Images/5faf66f34e6bb8b32f7edc7d0fe9c2b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*ZITd1EVgyg2rqOpqs4CkZA.jpeg"/></div><figcaption class="jw jx et er es jy jz bd b be z dx">New bank_accounts table</figcaption></figure><p id="fda5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在这种方法中，我需要一个python脚本来将银行账户数据从<code class="du jn jo jp jq b">users</code>表传输到<code class="du jn jo jp jq b">bank_accounts</code>表。我在迁移文件中创建了一个函数来传输这些数据。该函数将在迁移时执行，我们不需要在部署时运行单独的脚本来传输数据和从<code class="du jn jo jp jq b">users</code>表中手动删除列。</p></div><div class="ab cl kq kr go ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="ha hb hc hd he"><h2 id="6125" class="kx ky hh bd kz la lb lc ld le lf lg lh ja li lj lk je ll lm ln ji lo lp lq lr bi translated">旧型号</h2><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="ls lt l"/></div><figcaption class="jw jx et er es jy jz bd b be z dx">Old models.py</figcaption></figure><h2 id="0feb" class="kx ky hh bd kz la lb lc ld le lf lg lh ja li lj lk je ll lm ln ji lo lp lq lr bi translated">新型号</h2><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="ls lt l"/></div><figcaption class="jw jx et er es jy jz bd b be z dx">New Models.py</figcaption></figure><h2 id="f903" class="kx ky hh bd kz la lb lc ld le lf lg lh ja li lj lk je ll lm ln ji lo lp lq lr bi translated">迁移文件</h2><p id="9384" class="pw-post-body-paragraph ip iq hh ir b is lu iu iv iw lv iy iz ja lw jc jd je lx jg jh ji ly jk jl jm ha bi translated">运行<strong class="ir hi">python manage . py make migration</strong>创建迁移文件。</p><p id="59b3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这是一个使用上述命令自动生成的迁移文件。</p><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="ls lt l"/></div><figcaption class="jw jx et er es jy jz bd b be z dx">Auto-generated migration file</figcaption></figure><p id="c0c1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在我们将增加从<code class="du jn jo jp jq b">users</code>表到<code class="du jn jo jp jq b">bank_accounts</code>表传输数据的功能。</p><p id="b342" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们将使用原始查询来获取现有用户，因为我们已经从<strong class="ir hi">模型中的<code class="du jn jo jp jq b">users</code>表中删除了银行账户相关字段，但是该字段存在于数据库中。</strong></p><h2 id="5b65" class="kx ky hh bd kz la lb lc ld le lf lg lh ja li lj lk je ll lm ln ji lo lp lq lr bi translated">传递数据的功能</h2><p id="95d4" class="pw-post-body-paragraph ip iq hh ir b is lu iu iv iw lv iy iz ja lw jc jd je lx jg jh ji ly jk jl jm ha bi translated">这是带有函数的更新的迁移文件。</p><figure class="js jt ju jv fd ii"><div class="bz dy l di"><div class="ls lt l"/></div><figcaption class="jw jx et er es jy jz bd b be z dx">Modified migration file</figcaption></figure><p id="a688" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在<code class="du jn jo jp jq b">bank_accounts</code>表创建后，从<code class="du jn jo jp jq b">users</code>表中删除银行账户相关字段前，运行该功能。</p><p id="fded" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">运行<strong class="ir hi"> python manage.py migrate </strong>并验证来自shell的结果。</p><pre class="js jt ju jv fd lz jq ma mb aw mc bi"><span id="0432" class="kx ky hh jq b fi md me l mf mg">&gt;&gt;&gt; Users.objects.values()<br/>&lt;QuerySet [{'id': 1, 'name': 'name1'}, {'id': 2, 'name': 'name2'}, {'id': 3, 'name': 'name3'}]&gt;</span><span id="8ce5" class="kx ky hh jq b fi mh me l mf mg">&gt;&gt;&gt; BankAccounts.objects.values()<br/>&lt;QuerySet [{'id': 1, 'bank_name': 'bank1', 'branch_name': 'branch1', 'ifsc_code': 'ABCD1122334', 'account_number': '1234567890', 'user_id': 1}, {'id': 2, 'bank_name': 'bank2', 'branch_name'<br/>: 'branch2', 'ifsc_code': 'ABDD1122334', 'account_number': '123456789', 'user_id': 2}, {'id': 3, 'bank_name': 'bank3', 'branch_name': 'branch3', 'ifsc_code': 'ABDDD1122334', 'account_number<br/>': '1234567892', 'user_id': 3}]&gt;</span></pre><p id="78e5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">WOWWW。运行迁移后，一切都正常。</p><p id="ad3c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">感谢您阅读本文。如果你喜欢，点击👏将其评为50个</strong> <strong class="ir hi">之一，并与您的朋友分享。这对我很重要。</strong></p><p id="b34b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi"> <em class="mi">你想看看我的其他文章吗？</em> </strong></p><div class="mj mk ez fb ml mm"><a rel="noopener follow" target="_blank" href="/better-programming/using-python-pandas-with-excel-d5082102ca27"><div class="mn ab dw"><div class="mo ab mp cl cj mq"><h2 class="bd hi fi z dy mr ea eb ms ed ef hg bi translated">在Excel中使用Python熊猫</h2><div class="mt l"><h3 class="bd b fi z dy mr ea eb ms ed ef dx translated">使用Python库执行基本的Excel操作</h3></div><div class="mu l"><p class="bd b fp z dy mr ea eb ms ed ef dx translated">medium.com</p></div></div><div class="mv l"><div class="mw l mx my mz mv na in mm"/></div></div></a></div><div class="mj mk ez fb ml mm"><a rel="noopener follow" target="_blank" href="/aubergine-solutions/working-with-excel-sheets-in-python-using-openpyxl-4f9fd32de87f"><div class="mn ab dw"><div class="mo ab mp cl cj mq"><h2 class="bd hi fi z dy mr ea eb ms ed ef hg bi translated">使用openpyxl在Python中处理Excel工作表</h2><div class="mt l"><h3 class="bd b fi z dy mr ea eb ms ed ef dx translated">在本教程中，我们将看到如何使用openpyxl在python中使用Excel工作表的演示。</h3></div><div class="mu l"><p class="bd b fp z dy mr ea eb ms ed ef dx translated">medium.com</p></div></div><div class="mv l"><div class="nb l mx my mz mv na in mm"/></div></div></a></div><div class="mj mk ez fb ml mm"><a rel="noopener follow" target="_blank" href="/aubergine-solutions/partial-string-search-in-apache-solr-4b9200e8e6bb"><div class="mn ab dw"><div class="mo ab mp cl cj mq"><h2 class="bd hi fi z dy mr ea eb ms ed ef hg bi translated">Apache Solr中的部分字符串搜索</h2><div class="mt l"><h3 class="bd b fi z dy mr ea eb ms ed ef dx translated">在本教程中，我们将看到如何为部分字符串搜索配置Apache Solr的演示。</h3></div><div class="mu l"><p class="bd b fp z dy mr ea eb ms ed ef dx translated">medium.com</p></div></div><div class="mv l"><div class="nc l mx my mz mv na in mm"/></div></div></a></div><div class="mj mk ez fb ml mm"><a rel="noopener follow" target="_blank" href="/aubergine-solutions/django-jenkins-integration-for-django-project-3fe3251cd6f4"><div class="mn ab dw"><div class="mo ab mp cl cj mq"><h2 class="bd hi fi z dy mr ea eb ms ed ef hg bi translated">Django-Jenkins Django项目整合</h2><div class="mt l"><h3 class="bd b fi z dy mr ea eb ms ed ef dx translated">在本教程中，我们将看到如何为一个django项目集成django-jenkins的演示。</h3></div><div class="mu l"><p class="bd b fp z dy mr ea eb ms ed ef dx translated">medium.com</p></div></div><div class="mv l"><div class="nd l mx my mz mv na in mm"/></div></div></a></div></div></div>    
</body>
</html>