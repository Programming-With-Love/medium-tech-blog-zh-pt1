<html>
<head>
<title>Micro-Batching a Streaming Input Source using Google Cloud Dataflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Google Cloud数据流对流式输入源进行微批处理</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/micro-batching-a-streaming-input-source-using-google-cloud-dataflow-ccd30d2aabf2?source=collection_archive---------3-----------------------#2019-09-04">https://medium.com/google-developer-experts/micro-batching-a-streaming-input-source-using-google-cloud-dataflow-ccd30d2aabf2?source=collection_archive---------3-----------------------#2019-09-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/af87c659bace17eef9e34b5cfd7fb0f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*afZUCqsL-nk4Nshxdbps4w.png"/></div></div></figure><p id="558b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">通常，在构建数据处理管道时，您的数据可以是有界的(大小已定义)或无界的(大小未定义)。</p><p id="4460" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一个<strong class="ir hi">有界的</strong>数据源的例子可以是包含牛津词典中所有单词的文本文件，而包含特定#hashtag的所有Tweets的twitter流是一个<strong class="ir hi">无界的</strong>数据源的例子。</p><p id="3349" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Google Cloud Dataflow允许您处理这两种类型的数据源，为您提供了创建流或批处理管道的选项，分别处理无界和有界数据源。</p><p id="8eed" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在我们的用例中，我们必须处理来自无界数据源的数据，但是我们不想立即处理这些事件；相反，我们希望每两分钟对收集的事件进行一次操作。</p><p id="20f1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们尝试使用批处理管道来完成这项工作，但是在批处理模式下，数据流无法读取未绑定的源。这是由设计决定的，因为批处理管道期望读取有限数量的数据，并在处理完数据后终止。</p><p id="0532" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当我们切换到流管道时，数据流希望我们一进入管道就对事件进行操作；这是我们不想做的事情。</p><blockquote class="jn jo jp"><p id="2aba" class="ip iq jq ir b is it iu iv iw ix iy iz jr jb jc jd js jf jg jh jt jj jk jl jm ha bi translated">感谢阅读这篇博客，如果你在一家高增长的公司工作，并且正在寻找一个大规模的实时数据收集平台；看看https://roobits.com/的<a class="ae ju" href="https://roobits.com/" rel="noopener ugc nofollow" target="_blank">T5T7】。<br/>我们可能就是您要找的人！</a></p></blockquote><h1 id="d58b" class="jv jw hh bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">我们是如何解决这个问题的？</h1><p id="8d93" class="pw-post-body-paragraph ip iq hh ir b is kt iu iv iw ku iy iz ja kv jc jd je kw jg jh ji kx jk jl jm ha bi translated">输入<a class="ae ju" href="https://beam.apache.org/releases/javadoc/2.0.0/org/apache/beam/sdk/io/WriteFiles.html#withNumShards-int-" rel="noopener ugc nofollow" target="_blank">分片</a>！<br/> Dataflow允许开发人员将所有进入管道的输入事件写入一个文件，以便在以后的某个时间点进行处理。</p><p id="8141" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">数据流中出现的几乎每个IO转换都支持分片；例如，我已经将它与BigQueryIO和TextIO一起使用，但它也可以与KafkaIO、AvroIO等一起使用。</p><p id="d3fc" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">分割传入事件需要两件事:</p><ol class=""><li id="431c" class="ky kz hh ir b is it iw ix ja la je lb ji lc jm ld le lf lg bi translated"><strong class="ir hi">要创建的碎片数量</strong></li><li id="b8d5" class="ky kz hh ir b is lh iw li ja lj je lk ji ll jm ld le lf lg bi translated"><strong class="ir hi">触发频率</strong></li></ol><p id="7d1a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">碎片的数量实质上是数据流应该创建的用于写入传入事件的文件的数量。<br/>因此，如果您将碎片数量设置为10，dataflow将创建10个文件，并在这10个文件中写入您的传入事件。<br/>拥有大量碎片可以确保如果其中一个文件被破坏，其他未被破坏的文件中的其余事件仍然安全，从而降低单点故障的风险。</p><p id="8933" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">触发频率本质上就是你要读取上述文件的时间之后。它可以是你想要的任何东西，但是请记住，更长的时间意味着创建更大的文件！</p><p id="4028" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">就这样！</strong></p><p id="3090" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">对于我们的用例，我们希望每2分钟处理一次事件并将其加载到BigQuery中，因此我们将数据流管道修改为:</p><pre class="lm ln lo lp fd lq lr ls lt aw lu bi"><span id="2882" class="lv jw hh lr b fi lw lx l ly lz">.apply("Write to Custom BigQuery",<br/>	BigQueryIO.writeTableRows()<br/>	<strong class="lr hi">.withNumFileShards(30)<br/>	.withTriggeringFrequency(Duration.standardSeconds(90))<br/></strong>	.withMethod(BigQueryIO.Write.Method.FILE_LOADS)<br/>	.withSchema(tableSchema)<br/>	.to(table);</span></pre><p id="e2a5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">出发地:</p><pre class="lm ln lo lp fd lq lr ls lt aw lu bi"><span id="4ad4" class="lv jw hh lr b fi lw lx l ly lz">.apply("Write to Custom BigQuery",<br/>	BigQueryIO.writeTableRows()<br/>	.withSchema(tableSchema)<br/>	.to(table);</span></pre><p id="3189" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">只需要两行代码就可以将我们的流式管道转换成在指定时间对传入事件进行微批处理的流式管道。</p><blockquote class="jn jo jp"><p id="0278" class="ip iq jq ir b is it iu iv iw ix iy iz jr jb jc jd js jf jg jh jt jj jk jl jm ha bi translated"><strong class="ir hi">注意</strong>:默认情况下，数据流将文件存储在谷歌云存储桶中，因此使用这个可能会产生GCS收取的存储成本。</p></blockquote><p id="986d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="jq">感谢阅读！如果你喜欢这个故事，请</em> <strong class="ir hi"> <em class="jq">点击</em> </strong>👏<strong class="ir hi"> <em class="jq">按钮</em> </strong> <em class="jq"> </em> <strong class="ir hi"> <em class="jq">并分享</em> </strong> <em class="jq">帮助别人找到它！欢迎发表评论</em>💬<em class="jq">下图。</em></p><p id="469f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="jq">有反馈吗？下面我们来连线推特上的</em><a class="ae ju" href="https://twitter.com/harshithdwivedi" rel="noopener ugc nofollow" target="_blank"><em class="jq"/></a><em class="jq">。</em></p></div></div>    
</body>
</html>