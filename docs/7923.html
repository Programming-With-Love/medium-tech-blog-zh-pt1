<html>
<head>
<title>Modularization using Python and Docker for Data Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python和Docker实现数据管道的模块化</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/modularization-using-python-and-docker-for-data-pipeline-1193bba7c207?source=collection_archive---------0-----------------------#2020-10-26">https://medium.com/walmartglobaltech/modularization-using-python-and-docker-for-data-pipeline-1193bba7c207?source=collection_archive---------0-----------------------#2020-10-26</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="e55c" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">数据管道微服务设计小指南</h2></div><p id="1a2f" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><a class="js jt ge" href="https://medium.com/u/630a6397128e?source=post_page-----1193bba7c207--------------------------------" rel="noopener" target="_blank">朱</a>撰写</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ju"><img src="../Images/648b13faf901be839934dc045c6bbf00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D2eFiW54rwuZnqggg4O_TA.jpeg"/></div></div><figcaption class="kg kh et er es ki kj bd b be z dx">Photo credit: Pixabay</figcaption></figure></div><div class="ab cl kk kl go km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="ha hb hc hd he"><p id="2f54" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在数据工程领域，ETL和数据管道是关键点。特别是在像沃尔玛这样的大公司，我们有大量的管道需要开发、测试、部署和支持。我将展示我面临的一些挑战，并在下面提出一个解决方案。</p><h1 id="5c2f" class="kr ks hh bd kt ku kv kw kx ky kz la lb in lc io ld iq le ir lf it lg iu lh li bi translated">挑战</h1><ul class=""><li id="5c8c" class="lj lk hh iy b iz ll jc lm jf ln jj lo jn lp jr lq lr ls lt bi translated">我们如何将整体管道分成几个小的微服务管道？</li><li id="c36c" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">我们如何在团队和组织中重用我们的代码或微服务？</li><li id="b66b" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">如何才能分别优化管道？</li><li id="6987" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">我们如何更有效地测试我们的管道？</li><li id="984e" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">我们如何能够无痛地部署我们的管道？</li></ul><h1 id="e917" class="kr ks hh bd kt ku kv kw kx ky kz la lb in lc io ld iq le ir lf it lg iu lh li bi translated">解决办法</h1><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es lz"><img src="../Images/ac167e0b1a9790d591cd135d44f3db9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*udG7eQh1JhL-xTxPkrnLAw.png"/></div></div></figure><p id="9da5" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">基于解决方案的架构，我使用了函数式编程、有向无环图、python项目包、docker和crontab来处理所有的批处理和流数据处理。</p><ul class=""><li id="d836" class="lj lk hh iy b iz ja jc jd jf ma jj mb jn mc jr lq lr ls lt bi translated">我们有几个使用函数式编程的节点函数。</li><li id="b783" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">我们使用DAG作为容器来链接节点。</li><li id="9eee" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">Python项目包是我们的项目库，可以作为可重用模型发布到Python包索引中。</li><li id="315b" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">Docker是我们处理每个特殊数据管道的外部容器，它可以发布到Docker Hub进行部署或可重用容器。</li></ul><p id="fafe" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">下面就让我们一个一个来看看吧:</p><h2 id="82f2" class="md ks hh bd kt me mf mg kx mh mi mj lb jf mk ml ld jj mm mn lf jn mo mp lh mq bi translated">1.函数式编程</h2><blockquote class="mr ms mt"><p id="5d05" class="iw ix mu iy b iz ja ii jb jc jd il je mv jg jh ji mw jk jl jm mx jo jp jq jr ha bi translated"><strong class="iy hi">函数式编程</strong>(常缩写为FP)是通过组合<strong class="iy hi">纯函数</strong>，避免<strong class="iy hi">共享状态、</strong> <strong class="iy hi">可变数据、</strong><strong class="iy hi">副作用</strong>来构建软件的过程。(参考文献1)</p></blockquote><ul class=""><li id="dbb3" class="lj lk hh iy b iz ja jc jd jf ma jj mb jn mc jr lq lr ls lt bi translated">对于函数式编程，因为我们不使用共享状态，只有输入参数和输出返回，所以更容易做<strong class="iy hi"> <em class="mu">单元测试</em> </strong>。</li><li id="2606" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">将一个整体程序分割成几个小函数<strong class="iy hi"><em class="mu"/></strong>变得更加容易。</li></ul><h2 id="02ef" class="md ks hh bd kt me mf mg kx mh mi mj lb jf mk ml ld jj mm mn lf jn mo mp lh mq bi translated">2.有向无环图</h2><blockquote class="mr ms mt"><p id="7bfb" class="iw ix mu iy b iz ja ii jb jc jd il je mv jg jh ji mw jk jl jm mx jo jp jq jr ha bi translated">一个<strong class="iy hi"> DAG </strong>显示关于变量之间关系的假设(在图的上下文中通常称为节点)。我们所做的假设采用从一个节点到另一个节点的线(或边)的形式。这些边是<em class="hh">指向</em>的，这意味着它们有一个指示其效果的箭头。(参考文献2)</p></blockquote><ul class=""><li id="8546" class="lj lk hh iy b iz ja jc jd jf ma jj mb jn mc jr lq lr ls lt bi translated">我们将拥有基于DAG的<strong class="iy hi"> <em class="mu">清晰的数据谱系</em> </strong>。</li><li id="be2d" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">将一个单片数据管线分割成几个<strong class="iy hi"> <em class="mu">小数据管线</em> </strong>变得更容易。</li></ul><h2 id="70d7" class="md ks hh bd kt me mf mg kx mh mi mj lb jf mk ml ld jj mm mn lf jn mo mp lh mq bi translated">3.Python项目包</h2><p id="3e06" class="pw-post-body-paragraph iw ix hh iy b iz ll ii jb jc lm il je jf my jh ji jj mz jl jm jn na jp jq jr ha bi translated">我们可以编码、测试、打包和发布我们的可重用模块。</p><ul class=""><li id="2339" class="lj lk hh iy b iz ja jc jd jf ma jj mb jn mc jr lq lr ls lt bi translated">更容易将<strong class="iy hi"> <em class="mu">可复用模块</em> </strong>分享给整个社区。</li><li id="0647" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">我们的模块中有<strong class="iy hi"> <em class="mu">一个入口点</em> </strong>。</li></ul><h2 id="e0d2" class="md ks hh bd kt me mf mg kx mh mi mj lb jf mk ml ld jj mm mn lf jn mo mp lh mq bi translated">4.码头工人</h2><blockquote class="mr ms mt"><p id="3668" class="iw ix mu iy b iz ja ii jb jc jd il je mv jg jh ji mw jk jl jm mx jo jp jq jr ha bi translated">Docker是一组平台即服务产品，使用操作系统级虚拟化来交付称为容器的软件包中的软件。容器是相互隔离的，捆绑了它们自己的软件、库和配置文件；他们可以通过明确定义的渠道相互交流。(参考文献3)</p></blockquote><ul class=""><li id="2fb6" class="lj lk hh iy b iz ja jc jd jf ma jj mb jn mc jr lq lr ls lt bi translated">我们可以在一个<strong class="iy hi"> <em class="mu">分离环境</em> </strong>中优化每一条数据流水线。</li><li id="a33d" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">更容易<strong class="iy hi"> <em class="mu">部署</em> </strong>，无痛监控各个<strong class="iy hi"> <em class="mu">数据流水线</em> </strong>。</li></ul><h2 id="3d05" class="md ks hh bd kt me mf mg kx mh mi mj lb jf mk ml ld jj mm mn lf jn mo mp lh mq bi translated">5.雅克龙</h2><blockquote class="mr ms mt"><p id="a930" class="iw ix mu iy b iz ja ii jb jc jd il je mv jg jh ji mw jk jl jm mx jo jp jq jr ha bi translated">Docker友好的现代Cron替代品</p></blockquote><ul class=""><li id="ee6a" class="lj lk hh iy b iz ja jc jd jf ma jj mb jn mc jr lq lr ls lt bi translated">在docker中安排批处理更容易。</li></ul><h1 id="c7e2" class="kr ks hh bd kt ku kv kw kx ky kz la lb in lc io ld iq le ir lf it lg iu lh li bi translated">例子</h1><p id="7d4a" class="pw-post-body-paragraph iw ix hh iy b iz ll ii jb jc lm il je jf my jh ji jj mz jl jm jn na jp jq jr ha bi translated">在这个例子中，我将展示一个从读取csv、清理数据到生成指标的ETL过程。</p><h2 id="0c74" class="md ks hh bd kt me mf mg kx mh mi mj lb jf mk ml ld jj mm mn lf jn mo mp lh mq bi translated">1.函数式编程</h2><p id="2285" class="pw-post-body-paragraph iw ix hh iy b iz ll ii jb jc lm il je jf my jh ji jj mz jl jm jn na jp jq jr ha bi translated">在我们的utils.py文件中，一切都是函数和可重用的代码。例如，对于get_data函数，它有path参数并返回一个dataframe数据。对于duplicate_data函数，它具有原始数据帧参数，并返回一个干净的数据帧数据。</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="nb nc l"/></div><figcaption class="kg kh et er es ki kj bd b be z dx">gitutils.py</figcaption></figure><p id="8082" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在下面的测试示例中，我们测试了原始数据帧和干净数据帧，安装pytest后，我们可以很容易地得到测试结果(通过或失败)。</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="nb nc l"/></div><figcaption class="kg kh et er es ki kj bd b be z dx">test_utils.py</figcaption></figure><h2 id="a16f" class="md ks hh bd kt me mf mg kx mh mi mj lb jf mk ml ld jj mm mn lf jn mo mp lh mq bi translated">2.有向无环图</h2><p id="6df1" class="pw-post-body-paragraph iw ix hh iy b iz ll ii jb jc lm il je jf my jh ji jj mz jl jm jn na jp jq jr ha bi translated">下面的管道类是DAG的容器。</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="nb nc l"/></div><figcaption class="kg kh et er es ki kj bd b be z dx">DAG_pipeline.py</figcaption></figure><p id="04ac" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在初始化Pipeline类之后，我们可以使用decoration将我们的任务链相互连接起来。例如，函数get_raw_data是第一个任务，clean_data将在get_raw_data任务完成后触发。</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="nb nc l"/></div><figcaption class="kg kh et er es ki kj bd b be z dx">DAG_node.py</figcaption></figure><h2 id="8e14" class="md ks hh bd kt me mf mg kx mh mi mj lb jf mk ml ld jj mm mn lf jn mo mp lh mq bi translated">3.Python项目包</h2><p id="9ad7" class="pw-post-body-paragraph iw ix hh iy b iz ll ii jb jc lm il je jf my jh ji jj mz jl jm jn na jp jq jr ha bi translated">我们将整个项目的入口点设置为demo/workflow文件夹下的demo_workflow。</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="nb nc l"/></div><figcaption class="kg kh et er es ki kj bd b be z dx">setup.py</figcaption></figure><h2 id="0119" class="md ks hh bd kt me mf mg kx mh mi mj lb jf mk ml ld jj mm mn lf jn mo mp lh mq bi translated">4.码头工人</h2><p id="c0bd" class="pw-post-body-paragraph iw ix hh iy b iz ll ii jb jc lm il je jf my jh ji jj mz jl jm jn na jp jq jr ha bi translated">Dockerfile文件中有5个步骤</p><ul class=""><li id="0ffa" class="lj lk hh iy b iz ja jc jd jf ma jj mb jn mc jr lq lr ls lt bi translated">获取官方python图片:python:3.7-slim</li><li id="358c" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">安装gcc和cron</li><li id="549f" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">根据requirements.txt安装所有python包</li><li id="e05d" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">设置目录并安装演示包</li><li id="7fe9" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">将crontab.yaml文件复制到docker中需要的位置</li><li id="5988" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr lq lr ls lt bi translated">运行yacron命令进行批处理，或者只运行流/一次性的演示</li></ul><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="nb nc l"/></div><figcaption class="kg kh et er es ki kj bd b be z dx">Dockerfile</figcaption></figure><h2 id="b878" class="md ks hh bd kt me mf mg kx mh mi mj lb jf mk ml ld jj mm mn lf jn mo mp lh mq bi translated">5.雅克龙</h2><p id="d4db" class="pw-post-body-paragraph iw ix hh iy b iz ll ii jb jc lm il je jf my jh ji jj mz jl jm jn na jp jq jr ha bi translated">这个crontab yaml文件包含<a class="ae nd" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank"> cron调度表达式</a> (0 * * * *)，它将在docker中每小时运行一次脚本。</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="nb nc l"/></div><figcaption class="kg kh et er es ki kj bd b be z dx">crontab.yaml</figcaption></figure><h1 id="abd8" class="kr ks hh bd kt ku kv kw kx ky kz la lb in lc io ld iq le ir lf it lg iu lh li bi translated">如何运行示例？</h1><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="nb nc l"/></div></figure></div><div class="ab cl kk kl go km" role="separator"><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp kq"/><span class="kn bw bk ko kp"/></div><div class="ha hb hc hd he"><h1 id="8418" class="kr ks hh bd kt ku ne kw kx ky nf la lb in ng io ld iq nh ir lf it ni iu lh li bi translated">结论</h1><p id="53c1" class="pw-post-body-paragraph iw ix hh iy b iz ll ii jb jc lm il je jf my jh ji jj mz jl jm jn na jp jq jr ha bi translated">对于批处理和流数据管道区域的微服务设计，这是一个很好的解决方案。</p><h1 id="a989" class="kr ks hh bd kt ku kv kw kx ky kz la lb in lc io ld iq le ir lf it lg iu lh li bi translated">密码</h1><p id="63c3" class="pw-post-body-paragraph iw ix hh iy b iz ll ii jb jc lm il je jf my jh ji jj mz jl jm jn na jp jq jr ha bi translated">我们可以在这里找到所有可用的代码:<a class="ae nd" href="https://github.com/jason-jz-zhu/Modularization_Python_Docker_Demo" rel="noopener ugc nofollow" target="_blank">https://github . com/Jason-JZ-Zhu/modulation _ Python _ Docker _ Demo</a></p><h1 id="bfed" class="kr ks hh bd kt ku kv kw kx ky kz la lb in lc io ld iq le ir lf it lg iu lh li bi translated">参考</h1><ol class=""><li id="ffd1" class="lj lk hh iy b iz ll jc lm jf ln jj lo jn lp jr nj lr ls lt bi translated"><a class="ae nd" rel="noopener" href="/javascript-scene/master-the-javascript-interview-what-is-functional-programming-7f218c68b3a0">https://medium . com/JavaScript-scene/master-the-JavaScript-interview-what-is-functional-programming-7f 218 c 68 B3 a 0 #</a></li><li id="4201" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr nj lr ls lt bi translated"><a class="ae nd" href="https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-dags.html" rel="noopener ugc nofollow" target="_blank">https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-dags.html </a></li><li id="9ad0" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr nj lr ls lt bi translated"><a class="ae nd" href="https://en.wikipedia.org/wiki/Docker_(software)" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Docker(软件) </a></li><li id="d223" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr nj lr ls lt bi translated"><a class="ae nd" href="https://github.com/gjcarneiro/yacron" rel="noopener ugc nofollow" target="_blank">https://github.com/gjcarneiro/yacron </a></li><li id="f38a" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr nj lr ls lt bi translated"><a class="ae nd" href="https://www.toptal.com/developers/gitignore" rel="noopener ugc nofollow" target="_blank">https://www.toptal.com/developers/gitignore </a></li><li id="bfda" class="lj lk hh iy b iz lu jc lv jf lw jj lx jn ly jr nj lr ls lt bi translated"><a class="ae nd" href="https://choosealicense.com/" rel="noopener ugc nofollow" target="_blank">https://choosealicense.com/</a></li></ol></div></div>    
</body>
</html>