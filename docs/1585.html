<html>
<head>
<title>Database Migrations with Flyway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Flyway进行数据库迁移</h1>
<blockquote>原文：<a href="https://medium.com/capital-one-tech/database-migrations-with-flyway-16b6478e55a6?source=collection_archive---------2-----------------------#2018-07-26">https://medium.com/capital-one-tech/database-migrations-with-flyway-16b6478e55a6?source=collection_archive---------2-----------------------#2018-07-26</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/d49e1eff5aa397d3b0a4710dd890399f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AKMJ80OrF42m4OtyeB839Q.jpeg"/></div></div></figure><p id="5f21" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">作为Capital One的软件工程师，我为我们的商业银行开发新的应用程序。我和我的团队最近为我们银行的关系经理和分析师开发了一个web应用形式的数据管理工具。该团队包括两名软件工程师、四名数据分析师和科学家，以及一名产品经理。在原型开发的前五个月，我们相互协作，定义了一个能够满足用户分析需求的数据库模式。</p><p id="0fa7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在此期间，我和我的技术主管决定开发模式迁移工具，以便在设计数据库时简化开发。我们选定的数据库是Flyway。Flyway 是一个开源数据库迁移工具，支持开发人员将版本控制实践应用到他们的数据库中。当我们查看其他几种模式迁移工具时，这种工具似乎最适合我们的特定用例。</p><p id="b8a5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为什么我们需要模式迁移工具？</p><h1 id="05ec" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">模式迁移和工具的好处</h1><p id="1321" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">随着敏捷方法的进步和在21世纪初被广泛采用，对模式迁移工具的需求变得越来越大。允许数据库设计随着应用程序的发展而发展的技术允许工程师更有效地迭代软件。</p><p id="cf74" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在此期间，数据库迁移工具越来越受欢迎。模式迁移为数据库增加了版本控制功能。迁移是增量管理的，并且是可逆的。Flyway之类的工具可以在处理多个环境(如开发、测试和生产)或切换分支时防止数据库模式不匹配。它们允许开发人员从头开始重新创建数据库，这在创建新环境时很有价值。迁移工具增加了应用程序将在数据库的当前状态下运行的保证。例如，这可以防止开发人员遇到<em class="kr">列未找到</em>的错误。</p><h1 id="db28" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">飞行路线概述</h1><p id="0569" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">Flyway对数据库所做的更改被称为<strong class="ir hi">迁移</strong>。在Flyway中，迁移有两种类型；它们可以是<strong class="ir hi">版本化的</strong>或<strong class="ir hi">可重复的</strong>，版本化是最常见的。</p><p id="e05b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">版本化迁移有一个<strong class="ir hi">版本</strong>、<strong class="ir hi">描述</strong>和<strong class="ir hi">校验和</strong>，并且按顺序应用一次。可重复迁移有一个描述和一个校验和，每次校验和改变时都会重新应用。当需要更改数据库的模式时，开发人员会添加一个SQL脚本，通常在<strong class="ir hi"> db/migrations </strong>目录中。</p><p id="2dd7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在将Flyway指向数据库后，它开始扫描应用程序的文件系统以进行迁移。第一次运行第一次迁移时，它创建一个名为s <strong class="ir hi"> chema_version </strong>的表，该表有几列，包括<strong class="ir hi">版本</strong>、<strong class="ir hi">描述</strong>、<strong class="ir hi">脚本</strong>和<strong class="ir hi">校验和</strong>。该表用于跟踪数据库的状态。迁移根据版本号进行排序，并按顺序执行。</p><p id="c19f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在每次应用迁移之后，<strong class="ir hi"> schema_version </strong>表会相应地更新。每次Flyway扫描应用程序的文件系统以进行迁移时，它都会查询<strong class="ir hi"> schema_version </strong>表以查看数据库的版本，并相应地升级数据库。</p><p id="50f8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">可用但未应用的迁移称为待定迁移。</p><h1 id="c1d2" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">我们使用案例的优势</h1><p id="81bd" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">使用迁移工具的最大优点是，它确保软件版本总是与数据库的匹配状态一起交付。这对我们的产品尤其重要，因为我们正在快速迭代，需要快速自信地部署功能，以便收集用户反馈。</p><p id="7915" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">将Flyway集成到现有项目中很简单，因为设置时几乎不需要配置。该过程中最少的步骤包括通过在配置文件<strong class="ir hi"> conf/flyway.conf </strong>中指定url、用户名和密码来将工具指向数据库。</p><p id="9ac1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Flyway严格的迁移规则加强了纪律，从而形成了最佳实践。这类似于在git中禁用强制推送。Flyway执行的严格规则与在部署到环境后保持SQL文件不变的实践相一致。由于我们的团队努力遵循最佳软件工程实践，Flyway对我们的产品来说是合适的。</p><p id="790c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">作为一个几乎没有数据库迁移工具经验的人，Flyway很容易学习和使用。所有模式迁移都是增量捕获的。该API公开了六个基本方法——迁移、清理、信息、验证、基线和修复。(您可以在这里了解关于这些命令<a class="ae jn" href="https://flywaydb.org/documentation/commandline/" rel="noopener ugc nofollow" target="_blank">的更多信息)。这些方法使我们的团队能够将Flyway集成到CircleCI部署命令中。</a></p><p id="19ed" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最后，Flyway既灵活又强大——它能够修改列名，并且只需几个简单的命令就可以将数据从一列转移到另一列。</p><h1 id="114f" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">我们用例的缺点</h1><p id="789a" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">如前所述，Flyway在迁移文件更改方面非常严格。签入迁移后，很难对其进行更改。更改文件的内容或名称可能会导致每台装有该文件早期版本的计算机上的迁移失败。</p><p id="7582" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">即使需要进行简单的更改——比如调整字段名——通常也需要一个新的迁移脚本。当我和我的技术主管快速迭代时，我们发现自己每周都在添加Flyway脚本。这导致我们的迁移文件夹中有多余的文件。在原型开发的前五个月，我们的应用程序只部署在一个开发环境中，几乎不需要在应用程序中保留微小的模式变化。</p><blockquote class="ks kt ku"><p id="41de" class="ip iq kr ir b is it iu iv iw ix iy iz kv jb jc jd kw jf jg jh kx jj jk jl jm ha bi translated"><em class="hh">值得一提的是，可以编辑先前执行的迁移，但只有高级用户才能这样做，因为它需要更新</em> <strong class="ir hi"> <em class="hh">模式_版本</em> </strong> <em class="hh">表中的一行，以调整校验和值。</em></p></blockquote><p id="e7e2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当团队成员在不同的分支上并行工作时，版本号可能会冲突。有一些流程可以解决这个问题，比如为版本号使用时间戳而不是整数，并设置选项<strong class="ir hi">out of forder = true</strong>。</p><p id="5d44" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">逆向迁移，比如删除在之前的迁移中添加的列，可能很棘手，通常需要开发人员创建数据备份。</p><h1 id="3cbf" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">我们应用程序的最终结果</h1><p id="3f10" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">事后看来，如果我们后来在应用程序和数据库设计成熟时集成了Flyway，我的团队可以更好地利用它。为了在原型开发的第一阶段实现快速迭代，我认为我们的两人工程团队拥有一个定义初始模式的SQL文件、一个模拟数据文件和一个用模拟数据集加载表的脚本就足够了。</p><p id="adb5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">使用这种方法，我们可以通过修改git分支中的初始模式和模拟数据文件来修改模式。每次合并到主数据库或部署到环境后，通过CircleCI启动的步骤，数据库将使用模式和模拟数据集进行转储、拆卸、重新创建和重新加载。我认为Flyway最适合应用于存在多种环境的应用程序中，并且围绕数据库更改的决策不太稳定。</p><p id="878b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Flyway是一个有价值的工具，它的许多优点超过了缺点。在我们产品的开发过程中，它确保了我们的应用程序总是以数据库的匹配状态运行。当从我们的主分支提取变更时，遇到数据库不匹配错误的风险几乎为零。我们的迁移文件夹也是历史的记录；我们的团队能够跟踪我们的数据库设计随时间的变化。</p><p id="44b9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">由于我和我的技术主管与我们团队的数据科学家进行了交叉协作，提供数据库状态的透明度是关键。在我们CICD平台的帮助下，每次迁移的部署对我们来说几乎没有停机时间。</p><p id="ef3b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Flyway是我第一次使用迁移工具，它被证明在管理数据库状态方面是有效的。如果在正确的阶段集成到应用程序中，它有可能变得更加健壮。</p><h1 id="170b" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">承认</h1><p id="8de4" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">感谢<a class="ae jn" rel="noopener" href="/@bruceharris"> Bruce Harris </a>在审核过程中提供的有益建议。</p></div><div class="ab cl ky kz go la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ha hb hc hd he"><p id="8645" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="kr">声明:这些观点仅代表作者个人观点。除非本帖中另有说明，否则Capital One不属于所提及的任何公司，也不被其认可。使用或展示的所有商标和其他知识产权都是其各自所有者的所有权。本文为Capital One 2018。</em></p></div></div>    
</body>
</html>