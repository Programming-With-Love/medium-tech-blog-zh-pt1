# 二法则和微服务架构

> 原文：<https://medium.com/capital-one-tech/rule-of-twos-and-microservice-architecture-3f57db7f6896?source=collection_archive---------4----------------------->

## 避免依赖锁定的经验教训

![](img/46a8e42f23eebdbd3b7c3765249de4d7.png)

微服务架构从根本上来说就是避免复杂系统中各种协调的需要。[可以证明](http://www.freshblurbs.com/blog/2016/09/27/microservices-coordination-removal.html)所有其他经常被引用的微服务原则本质上都是这个基本目标的衍生物。一个重要的原则是*避免共享库和二进制耦合*。如果你还没有看过，你应该看看本·克里斯滕森关于这个话题的精彩演讲。Ben 很好地解释了共享库给微服务架构带来的挑战。

当您最终需要升级或替换产品或组织的一部分中的那些工件时，共享二进制库、框架或平台的决定可能会导致巨大的挑战。由于跨多个团队协调工作的复杂性，一个最多需要一天或一个短 scrum 周期的任务经常会变成一个数月(有时是数年)长的项目。事实上，当利益相关者意识到影响的严重性时，这些努力往往会被完全取消。

这种逻辑很容易被理解和接受。然而，要接受它的负面破坏性影响可能要困难得多。如果跨微服务共享库确实有风险，我们还能把“代码重用”作为所有软件工程中最期望的实践之一吗？利用开源库怎么样？随着我们越来越深入兔子洞，这种对既定信念的质疑会变得相当令人沮丧。微服务架构会动摇多少根根深蒂固的工程原则？如果这种建筑风格要对抗和反抗每一个。单身。原则。我们软件工程师已经开始欣赏的东西？

我当然有些夸张，但在我们全盘拒绝微服务或抛弃我们在微服务之前所相信的一切之前，让我们暂停一下。事实是，微服务架构本身并不反对共享库。它实际上反对的是制造死亡之握依赖，这会损害我们实践避免协调原则的能力。

虽然库的共享通常会带来重大挑战，但也不尽然。共享库也不是避免协作的唯一途径。通过为所有 API 选择单一的媒体类型(例如 [JSON-LD](http://json-ld.org/) 、 [HAL](http://stateless.co/hal_specification.html) 、 [Siren](https://github.com/kevinswiber/siren) 或 [UBER](http://uberhypermedia.org/) )，你可以轻松地创建代价高昂的锁定。或者，您可以选择一种实现容错的方法，这种方法会导致相同的结果。例子很多。

幸运的是，我们可以使用一个相当简单的实践来帮助您在实施微服务架构时避免各种依赖锁定。这个原则是从与我亲爱的朋友和著名的分布式系统专家 Mike Amundsen 的多次交谈中得到启发的。从那以后，我已经能够在以前的雇主的多个项目中使用这个原则，并取得了巨大的成功。我亲切地称这个原则为“二法则”,并且非常欣赏它。

# **二进制法则**

基本思想是，如果你不断锻炼自己支持多种选择的能力，你的选择就不会把你束缚住:

> **对于系统中的任何关键组件，确保在生产中同时使用至少两种替代品。即使你只需要一个。此外，确保您拥有支持这两种选择的基础设施，就像支持单一选择一样容易。**

实际上，这一原则让我在如何处理微服务架构方面实施了一些额外的一般准则，例如:

1.  确保一些关键的 API 是用 Go 或者 Scala 写的，即使大部分是用 Node 写的。单一解决方案的标准化可能是高效的，但是我们需要在效率和健壮性之间取得平衡。
2.  确保一些微服务使用文档/NoSQL 数据库，即使大多数微服务使用传统的关系数据库。在实现这一点的过程中，你将发展对你来说长期无价的能力。
3.  确保一些关键的 API 使用不同于其他地方使用的媒体类型进行通信。例如，如果你在 HAL 上标准化，使用 UBER 做一些其他重要的 API。在实现这种多消息格式支持的过程中，您可能最终会实现一个强大的设计模式，比如我发现使您的 API 持久、可发展和可适应的[表示器](https://github.com/apiacademy/representor)。

我不会用更多的例子来烦你。我知道你可以在自己的环境中找到很多。我想传达的主要观点是——共享库或标准化其他组织选择并不总是有害的。危险之处在于没有灵活的基础设施来容纳任何非标准的替代方案。

最重要的是——除非你每天都练习你对选择的开放态度，否则你将无法支持这样的选择。如果你需要健壮性，你需要实践它，而不仅仅是理论上的设计。

我发现了一个很好的方法来避免这种情况，那就是在我的工作中执行二法则。即使你现在不需要替代品，你也应该实现它们的例子*。这样，明天，当你真的需要它的时候，你就可以自由选择了。从第一天起，始终将关键决策作为两种选择来实施，并铺设基础设施来无缝支持它们——这是“二法则”的精髓，也是我避免依赖锁定的个人指南。*

****声明:以上观点仅代表作者个人观点。除非本帖中另有说明，否则 Capital One 不属于所提及的任何公司，也不被其认可。使用或展示的所有商标和其他知识产权都是其各自所有者的所有权。本文为 2017 首都一。****

## *相关链接:*

*   *[微服务——何时应对，何时协调](https://developer.capitalone.com/blog-post/microservices-when-to-react-vs-orchestrate/)*
*   *[事件驱动微服务的性能测试](https://developer.capitalone.com/blog-post/performance-testing-of-event-driven-microservices/)*

*[![](img/a9f346eff65776bdedf685617e2c446d.png)](https://medium.com/capital-one-tech/microservices/home)*