<html>
<head>
<title>Secure Oracle Database Connection using Hashicorp Vault and Consul</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Hashicorp Vault和Consul保护Oracle数据库连接</h1>
<blockquote>原文：<a href="https://medium.com/version-1/secure-oracle-database-connection-using-hashicorp-vault-and-consul-67039887803e?source=collection_archive---------1-----------------------#2021-10-29">https://medium.com/version-1/secure-oracle-database-connection-using-hashicorp-vault-and-consul-67039887803e?source=collection_archive---------1-----------------------#2021-10-29</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/b50ce375fa555b504062dd14163019c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nZVhfig3CrHiQSj8"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo by <a class="ae it" href="https://unsplash.com/@theshubhamdhage?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Shubham Dhage</a> on <a class="ae it" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><figure class="iv iw ix iy fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es iu"><img src="../Images/9299fa06c4951893cae1e5b6d3ee49d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u5d13zpqGsEPoJgj5xwn9g.png"/></div></div></figure><p id="ef94" class="pw-post-body-paragraph iz ja hh jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">这是如何使用Hashicorp Vault PKI引擎和Oracle数据库安全监听器来保护Oracle数据库连接的概述。这种模式可以用于开发/测试环境，在这种环境中，您希望使用自己的证书来节省购买第三方证书的成本。此外，这将帮助您自动执行证书轮换，而无需向您的组织CA请求签名证书。这种模式基于以下假设:</p><ol class=""><li id="3b74" class="jx jy hh jb b jc jd jg jh jk jz jo ka js kb jw kc kd ke kf bi translated">AWS是云提供商</li><li id="e06f" class="jx jy hh jb b jc kg jg kh jk ki jo kj js kk jw kc kd ke kf bi translated">Oracle数据库安装在EC2上</li><li id="fc11" class="jx jy hh jb b jc kg jg kh jk ki jo kj js kk jw kc kd ke kf bi translated">IAM角色附加到EC2实例</li><li id="bca3" class="jx jy hh jb b jc kg jg kh jk ki jo kj js kk jw kc kd ke kf bi translated">哈希公司的保险库已经设置好了</li><li id="ea3a" class="jx jy hh jb b jc kg jg kh jk ki jo kj js kk jw kc kd ke kf bi translated">安装在EC2实例上的Ansible</li><li id="8795" class="jx jy hh jb b jc kg jg kh jk ki jo kj js kk jw kc kd ke kf bi translated">用于部署保险库和基础设施的地形</li></ol><p id="8a84" class="pw-post-body-paragraph iz ja hh jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">我没有亲自编写所有的详细步骤，而是将所有的参考链接放在一页上，以便您以最简单的方式遵循和理解该过程。所以，开始了。</p><p id="59e8" class="pw-post-body-paragraph iz ja hh jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">概括地说，下面的过程由一些高级步骤组成:</p><ol class=""><li id="d78c" class="jx jy hh jb b jc jd jg jh jk jz jo ka js kb jw kc kd ke kf bi translated">启用Hashicorp Vault PKI引擎</li><li id="fb26" class="jx jy hh jb b jc kg jg kh jk ki jo kj js kk jw kc kd ke kf bi translated">创建Vault角色以授予PKI引擎访问权限，并将其映射到EC2 IAM角色</li><li id="9ad4" class="jx jy hh jb b jc kg jg kh jk ki jo kj js kk jw kc kd ke kf bi translated">部署consul模板以从PKI引擎获取更新的证书</li><li id="7f85" class="jx jy hh jb b jc kg jg kh jk ki jo kj js kk jw kc kd ke kf bi translated">使用从PKI引擎获取的证书创建钱包</li><li id="2ad7" class="jx jy hh jb b jc kg jg kh jk ki jo kj js kk jw kc kd ke kf bi translated">使用上面创建的钱包注册安全监听程序</li></ol><h1 id="2a27" class="kl km hh bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">启用Hashicorp Vault PKI引擎</h1><p id="5a7a" class="pw-post-body-paragraph iz ja hh jb b jc lj je jf jg lk ji jj jk ll jm jn jo lm jq jr js ln ju jv jw ha bi translated">以下是如何为Vault命名空间设置根CA和中间CA证书的示例:</p><figure class="iv iw ix iy fd ii"><div class="bz dy l di"><div class="lo lp l"/></div></figure><h1 id="24af" class="kl km hh bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">创建Vault角色以授予PKI引擎访问权限，并将其映射到EC2 IAM角色</h1><p id="63e6" class="pw-post-body-paragraph iz ja hh jb b jc lj je jf jg lk ji jj jk ll jm jn jo lm jq jr js ln ju jv jw ha bi translated">下面是如何创建一个vault角色来授予对PKI的访问权限，并使用terraform将该角色映射到IAM角色的一个片段。(确保将IAM角色添加到EC2实例配置文件中，以便它承担)</p><pre class="iv iw ix iy fd lq lr ls lt aw lu bi"><span id="d555" class="lv km hh lr b fi lw lx l ly lz"># Vault policy document<br/>data "vault_policy_document" "role_vault_cert_policy_document" {<br/>rule {<br/>path = "pki*"<br/>capabilities = ["create", "read", "update", "delete", "list", "sudo"]<br/>}<br/>}</span><span id="a9fe" class="lv km hh lr b fi ma lx l ly lz"># Vault policy<br/>resource "vault_policy" "role_vault_cert_policy" {<br/>name = "${var.service}_cert_policy"<br/>policy = data.vault_policy_document.role_vault_cert_policy_document.hcl<br/>}</span><span id="c6bc" class="lv km hh lr b fi ma lx l ly lz"># Vault AWS Auth backend role with attached above policy<br/>resource "vault_aws_auth_backend_role" "role" {<br/>auth_type = "iam"<br/>bound_iam_principal_arns = [&lt;EC2 IAM Role ARN&gt;]<br/>role = &lt;EC2 IAM Role Name&gt;<br/>token_max_ttl = 2764800<br/>token_policies = ["default", vault_policy.role_vault_cert_policy.name]<br/>}</span></pre><h1 id="f909" class="kl km hh bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">部署consul模板以从PKI引擎获取更新的证书</h1><p id="a530" class="pw-post-body-paragraph iz ja hh jb b jc lj je jf jg lk ji jj jk ll jm jn jo lm jq jr js ln ju jv jw ha bi translated">感谢<a class="mb mc ge" href="https://medium.com/u/1c5af378fb8f?source=post_page-----67039887803e--------------------------------" rel="noopener" target="_blank"> Ned Shawa </a>，这里有一个很好的概述，介绍了如何部署consul template虚拟机以将其与Vault集成:</p><p id="5654" class="pw-post-body-paragraph iz ja hh jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated"><a class="ae it" href="https://github.com/hashicorp/consul-template" rel="noopener ugc nofollow" target="_blank">GitHub—hashi corp/Consul-Template:@ hashi corp Consul和Vault数据的模板渲染、通知程序和监管程序。</a></p><p id="e58f" class="pw-post-body-paragraph iz ja hh jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">一旦您将consul模板配置为在VM上的某个位置生成证书，您就完成了70%的工作。现在，让我们从DevOps转移到DBA位。</p><h1 id="3ff0" class="kl km hh bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">使用从PKI引擎获取的证书创建钱包</h1><p id="454b" class="pw-post-body-paragraph iz ja hh jb b jc lj je jf jg lk ji jj jk ll jm jn jo lm jq jr js ln ju jv jw ha bi translated">您可以使用以下命令，使用consul模板从Vault PKI引擎获取的PEM证书文件创建一个wallet。</p><pre class="iv iw ix iy fd lq lr ls lt aw lu bi"><span id="4ad0" class="lv km hh lr b fi lw lx l ly lz"># Convert PEM to PKCS12<br/>openssl pkcs12 -export -in &lt;Consul Template Target Location&gt;/certificate.crt -inkey &lt;Consul Template Target Location&gt;/private_key.rsa -certfile &lt;Consul Template Target Location&gt;/ca_chain.crt -out ${ORACLE_HOME}/wallet/ewallet.p12 -password pass:&lt;WALLET PASSWORD&gt;</span><span id="71d4" class="lv km hh lr b fi ma lx l ly lz"># Convert PKCS12 to JKS<br/>${ORACLE_HOME}/bin/orapki wallet pkcs12_to_jks -wallet ${ORACLE_HOME}/wallet/ewallet.p12 -jksKeyStoreLoc ${ORACLE_HOME}/wallet/ewallet.jks -jksKeyStorepwd &lt;JKS KEY PASSWORD&gt; -pwd &lt;WALLET PASSWORD&gt;</span><span id="5805" class="lv km hh lr b fi ma lx l ly lz"># Create wallet<br/>${ORACLE_HOME}/bin/orapki wallet create -wallet ${ORACLE_HOME}/ssl_wallet -auto_login -pwd &lt;WALLET PASSWORD&gt;</span><span id="cfb4" class="lv km hh lr b fi ma lx l ly lz"># Add JKS Cert to wallet<br/>${ORACLE_HOME}/bin/orapki wallet jks_to_pkcs12 -wallet ${ORACLE_HOME}/ssl_wallet -pwd &lt;WALLET PASSWORD&gt; -keystore ${ORACLE_HOME}/wallet/ewallet.jks -jkspwd &lt;JKS KEY PASSWORD&gt;</span><span id="ea3e" class="lv km hh lr b fi ma lx l ly lz"># Show certificate details from wallet<br/>${ORACLE_HOME}/bin/orapki wallet display -wallet "${ORACLE_HOME}/ssl_wallet" -pwd &lt;WALLET PASSWORD&gt;</span></pre><h1 id="839c" class="kl km hh bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">使用wallet注册安全监听程序</h1><p id="f896" class="pw-post-body-paragraph iz ja hh jb b jc lj je jf jg lk ji jj jk ll jm jn jo lm jq jr js ln ju jv jw ha bi translated">您可以通过以下链接在SQLNet.ora和TNSNames.ora中配置安全监听器</p><p id="1ea2" class="pw-post-body-paragraph iz ja hh jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated"><a class="ae it" href="https://oracle-base.com/articles/misc/configure-tcpip-with-ssl-and-tls-for-database-connections#server-network-configuration" rel="noopener ugc nofollow" target="_blank"> ORACLE-BASE —使用SSL和TLS为数据库连接配置TCP/IP</a></p><h1 id="6669" class="kl km hh bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">结论</h1><p id="232a" class="pw-post-body-paragraph iz ja hh jb b jc lj je jf jg lk ji jj jk ll jm jn jo lm jq jr js ln ju jv jw ha bi translated">当您的组织希望使用Hashicorp Vault PKI引擎来生成证书，并希望内部应用程序使用安全监听器进行连接时，上述过程非常有用。Consul模板对于自动生成证书和从Vault PKI引擎获取证书非常方便。在我的一个客户机上，我们使用了这个过程来自动刷新安全侦听器钱包中的证书，计划在每隔一个星期天作为开发/测试数据库上的cron作业进行刷新。请记住，您可以在consul配置文件中设置证书的到期时间，因此您可以控制cron作业的频率。这有助于我们在开发/测试数据库上维护短期证书，并自动刷新，因此我们再也不用考虑记住每个环境的证书到期时间。如果你有和上面类似的用例，希望这也能帮助你。</p><figure class="iv iw ix iy fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es md"><img src="../Images/1e61ae1c710a26b0ad16fb818431a034.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pOyzJ7yr3TAVc-vbB-4L6w.jpeg"/></div></div></figure><p id="b3c3" class="pw-post-body-paragraph iz ja hh jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated"><strong class="jb hi">关于作者<br/> </strong> Sourish Banerjee是devos&amp;1版本的高级云顾问。</p></div></div>    
</body>
</html>