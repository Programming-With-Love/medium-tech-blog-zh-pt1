<html>
<head>
<title>How We Partitioned Airbnb’s Main Database in Two Weeks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们如何在两周内对Airbnb的主数据库进行分区</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/how-we-partitioned-airbnb-s-main-database-in-two-weeks-55f7e006ff21?source=collection_archive---------0-----------------------#2015-10-06">https://medium.com/airbnb-engineering/how-we-partitioned-airbnb-s-main-database-in-two-weeks-55f7e006ff21?source=collection_archive---------0-----------------------#2015-10-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="96eb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由<a class="jc jd ge" href="https://medium.com/u/3f589e8091c9?source=post_page-----55f7e006ff21--------------------------------" rel="noopener" target="_blank">威利·姚</a></p></div><div class="ab cl je jf go jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="ha hb hc hd he"><blockquote class="jl"><p id="fcb2" class="jm jn hh bd jo jp jq jr js jt ju jb dx translated">“缩放=在以100英里/小时的速度行驶时更换汽车的所有部件”——Mike Krieger，Instagram联合创始人@ <a class="ae jv" href="https://www.youtube.com/watch?v=oNA2C1vC8FQ" rel="noopener ugc nofollow" target="_blank"> Airbnb OpenAir 2015 </a></p></blockquote></div><div class="ab cl je jf go jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="ha hb hc hd he"><figure class="jx jy jz ka fd kb er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es jw"><img src="../Images/91a9076803dfd68180cf17c3b931dcea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gdXhUZ1BqRy6RkKp.png"/></div></div><figcaption class="ki kj et er es kk kl bd b be z dx"><em class="km">Airbnb peak traffic grows at a rate of 3.5x per year, with a seasonal summer peak.</em></figcaption></figure><p id="16ca" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">随着2015年夏季旅行季节的到来，Airbnb的基础设施团队正在努力扩展我们的数据库，以处理预计的创纪录的夏季流量。一个特别有影响力的项目旨在按应用程序功能将某些表划分到它们自己的数据库中，这通常需要在应用层更改、数据迁移和可靠测试方面进行大量的工程投资，以保证数据一致性和最小的停机时间。为了节省数周的工程时间，我们的一位<a class="ae jv" href="https://github.com/schleyfox" rel="noopener ugc nofollow" target="_blank">杰出工程师</a>提出了一个有趣的想法，利用MySQL复制来完成保证数据一致性的困难部分。(这个想法被单独列为亚马逊RDS的“读取副本提升”功能的<a class="ae jv" href="http://aws.amazon.com/about-aws/whats-new/2012/10/11/amazon-rds-mysql-rr-promotion/" rel="noopener ugc nofollow" target="_blank">明确用例</a>。)通过容忍数据库升级期间短暂且有限的停机时间，我们能够在不编写任何簿记或迁移代码的情况下执行此操作。在这篇博文中，我们将分享一些我们的工作和我们在这个过程中学到的东西。</p><figure class="jx jy jz ka fd kb er es paragraph-image"><div class="er es kn"><img src="../Images/da51eca272f85ea82fd99e8d41b7ee1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/0*Fwx8svUbm7I4G618.png"/></div></figure><h1 id="7ec3" class="ko kp hh bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">首先，一些背景</h1><p id="b334" class="pw-post-body-paragraph ie if hh ig b ih lm ij ik il ln in io ip lo ir is it lp iv iw ix lq iz ja jb ha bi translated">我们倾向于同意我们在<a class="ae jv" href="https://eng.asana.com/2015/04/sharding-is-bitter-medicine/" rel="noopener ugc nofollow" target="_blank"> Asana </a>和<a class="ae jv" href="https://www.percona.com/blog/2009/08/06/why-you-dont-want-to-shard/" rel="noopener ugc nofollow" target="_blank"> Percona </a>的朋友的观点，即水平分割是一剂苦药，因此我们更喜欢通过应用程序功能进行垂直分区，以分散负载和隔离故障。例如，我们有专用的数据库，每个都运行在自己专用的RDS实例上，一对一地映射到我们独立的Java和Rails服务。然而，由于历史原因，我们的许多核心应用程序数据仍然保存在Airbnb还是一个单一的Rails应用程序时的原始数据库中。</p><p id="a63a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用我们内部构建的客户端查询分析器(由于RDS的限制，它是客户端)来分析我们的数据库访问模式，我们发现Airbnb的消息收件箱功能(允许客人和主人进行通信)占了我们主数据库中近1/3的写入。此外，这种写模式随着流量线性增长，因此对它进行分区对于我们主数据库的稳定性来说是一个特别大的优势。由于它是一个独立的应用程序功能，我们也相信所有跨表连接和事务都可以消除，所以我们开始优先考虑这个项目。</p><p id="9fcf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在检查我们对这个项目的选择时，两个现实影响了我们的决策。首先，我们上一次对数据库进行分区是在三年前的2012年，因此以我们目前的规模进行这项操作对我们来说是一个新的挑战，我们愿意以计划内停机为代价最大限度地降低工程复杂性。其次，当我们带着大约130名软件工程师进入2015年时，我们的团队分布在一个很大的产品表面区域——从个性化搜索、客户服务工具、信任和安全、全球支付，到假设连接有限的可靠移动应用——只留下一小部分工程专用于基础设施。考虑到这些因素，我们选择利用MySQL复制来最小化工程复杂性和所需的投资。</p><h1 id="ad16" class="ko kp hh bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">我们的计划</h1><p id="08cb" class="pw-post-body-paragraph ie if hh ig b ih lm ij ik il ln in io ip lo ir is it lp iv iw ix lq iz ja jb ha bi translated">决定使用MySQL的内置复制来为我们迁移数据意味着我们不再需要自己构建最具挑战性的部分来保证数据一致性，因为复制是一个经过验证的量。我们在Amazon RDS上运行MySQL，因此创建新的读取副本和将副本升级为独立的主服务器很容易。我们的设置如下所示:</p><figure class="jx jy jz ka fd kb er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es jw"><img src="../Images/5ec796d6f3ebb09cacdd31e38eebc90c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4gGWSLSVDmwk-y31.png"/></div></div></figure><p id="662a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们从我们的主数据库创建了一个新的副本(message-master ),它将在升级后作为新的独立主数据库。然后，我们附加了一个第二层副本(消息副本),作为消息主服务器的副本。问题是<a class="ae jv" href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_ReadRepl.html#USER_ReadRepl.Promote" rel="noopener ugc nofollow" target="_blank">提升过程可能需要几分钟</a>或更长时间才能完成，在此期间，我们必须故意不对相关表进行写操作，以保持数据一致性。考虑到由于不堪重负的数据库造成的站点范围的停机时间比本地化和受控的邮件收件箱停机时间要昂贵得多，该团队愿意做出这种折衷，以减少数周的开发时间。值得一提的是，对于那些运行自己的数据库的人来说，<a class="ae jv" href="https://dev.mysql.com/doc/refman/5.7/en/change-replication-filter.html" rel="noopener ugc nofollow" target="_blank">复制过滤器</a>可以用来避免复制不相关的表，并可能减少升级周期。</p><h1 id="2e6a" class="ko kp hh bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">第一阶段:预先规划</h1><p id="0958" class="pw-post-body-paragraph ie if hh ig b ih lm ij ik il ln in io ip lo ir is it lp iv iw ix lq iz ja jb ha bi translated">迁移后，将邮件收件箱表移动到新的数据库可能会导致现有的跨表连接查询无效。因为数据库升级无法恢复，所以此操作的成功取决于我们识别所有此类情况并弃用它们或用应用内连接替换它们的能力。幸运的是，我们的内部查询分析器允许我们轻松地识别大多数主要服务的此类查询，并且我们能够撤销对剩余服务的相关数据库权限授予，以获得完全覆盖。我们在Airbnb努力实现的架构原则之一是，服务应该拥有自己的数据，这将大大简化这里的工作。虽然技术上很简单，但这是项目中最耗时的阶段，因为它需要跨团队的良好沟通。</p><p id="00f4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，我们有一个非常广泛的数据管道，支持离线数据分析和下游生产服务。因此，预规划的下一步是移动所有相关管道来使用消息副本的数据导出，以确保我们在升级后使用最新的数据。我们的迁移计划的一个副作用是新数据库将与我们现有的数据库同名(不要与我们的RDS实例的名称混淆，例如message-master和message-replica ),即使数据在升级后会有差异。然而，这实际上允许我们在数据管道中保持命名约定的一致性，所以我们选择不进行数据库重命名。</p><p id="0901" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，因为我们的主要Airbnb Rails应用程序拥有对这些表的独占写访问权限，所以我们能够将所有相关的服务流量交换到新的消息数据库副本，以降低主要操作的复杂性。</p><h1 id="1315" class="ko kp hh bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">第二阶段:行动</h1><figure class="jx jy jz ka fd kb er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es lr"><img src="../Images/1ad9d910203360af0d7a84861c3f32ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KRfOrG-jDc9MxyhC.jpg"/></div></div><figcaption class="ki kj et er es kk kl bd b be z dx"><em class="km">Members of the Production Infrastructure team on the big day.</em></figcaption></figure><p id="a15b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦所有的预先计划工作完成，实际操作如下:</p><ol class=""><li id="6d2f" class="ls lt hh ig b ih ii il im ip lu it lv ix lw jb lx ly lz ma bi translated">与我们的客户服务团队沟通计划中的10分钟以下收件箱停机时间。我们非常敏感地认识到，任何停机时间都可能让客人在尝试入住Airbnb时滞留在国外，因此，保持所有相关功能处于循环中并在每周客流量最低时执行操作非常重要。</li><li id="b4d8" class="ls lt hh ig b ih mb il mc ip md it me ix mf jb lx ly lz ma bi translated">部署对邮件收件箱查询的更改，以使用新的邮件数据库用户授权和数据库连接。在这个阶段，我们仍然将写操作指向主要主机，而读操作则指向消息副本，因此这应该不会对外部产生影响。然而，我们将这一步延迟到op开始，因为它将主主机的连接增加了一倍，所以我们希望这一阶段尽可能短。在下一步中交换数据库主机不需要部署，因为我们有配置工具来更新Zookeeper中的数据库主机条目，在这里它们可以被<a class="ae jv" href="http://nerds.airbnb.com/smartstack-service-discovery-cloud/" rel="noopener ugc nofollow" target="_blank"> SmartStack </a>发现。</li><li id="6ede" class="ls lt hh ig b ih mb il mc ip md it me ix mf jb lx ly lz ma bi translated">将所有消息收件箱写入流量交换给消息主机。因为它尚未升级，所以在新主节点上的所有写入都会失败，我们开始计算停机时间。虽然reads查询会成功，但实际上，在此阶段几乎所有的消息传递都会停止，因为将消息标记为read需要db write。</li><li id="4925" class="ls lt hh ig b ih mb il mc ip md it me ix mf jb lx ly lz ma bi translated">使用步骤2中介绍的消息database user终止主服务器上的所有数据库连接。通过直接终止连接，而不是执行部署或群集重启，我们最大限度地减少了将所有写入移动到将充当新主服务器的副本服务器的时间，这是复制跟上的先决条件。</li><li id="0ffd" class="ls lt hh ig b ih mb il mc ip md it me ix mf jb lx ly lz ma bi translated">通过检查以下内容来验证复制是否已跟上:a)邮件主服务器和邮件副本服务器上所有邮件收件箱表中的最新条目。b)主主机上的所有消息连接都消失了。c)在报文主机上建立新的连接</li><li id="7769" class="ls lt hh ig b ih mb il mc ip md it me ix mf jb lx ly lz ma bi translated">提升消息主。根据我们的经验，在RDS上进行升级期间，数据库会完全关闭大约30秒，在此期间，主服务器上的读取会失败。但是，写入将失败近4分钟，因为在启动升级后，大约需要3.5分钟才能生效。</li><li id="0187" class="ls lt hh ig b ih mb il mc ip md it me ix mf jb lx ly lz ma bi translated">在下一个RDS自动备份窗口之前，在新提升的消息主机上启用<a class="ae jv" href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.MultiAZ.html" rel="noopener ugc nofollow" target="_blank">多AZ部署</a>。除了改进的故障转移支持，Multi-AZ还最大限度地减少了RDS快照和备份期间的延迟峰值。</li><li id="7e09" class="ls lt hh ig b ih mb il mc ip md it me ix mf jb lx ly lz ma bi translated">一旦所有的指标看起来都不错，数据库也稳定了，就在各自的数据库中删除不相关的表。这一总结步骤对于确保没有服务消耗陈旧数据非常重要。</li></ol><p id="aa4e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果操作失败了，我们将会恢复Zookeeper中的数据库主机条目，并且消息收件箱功能几乎会立即恢复。然而，我们将会丢失任何写入现在独立的消息数据库的内容。从理论上讲，回填来恢复丢失的消息是可能的，但是对于我们的用户来说，这将是一个不小的努力和困惑。因此，在执行op之前，我们对上述每个步骤进行了稳健的测试。</p><h1 id="d294" class="ko kp hh bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">结果呢</h1><figure class="jx jy jz ka fd kb er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es jw"><img src="../Images/8e1893464e3813e19fbb2b41f398be25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MGIx9sh0Ga-LgL4w.png"/></div></div><figcaption class="ki kj et er es kk kl bd b be z dx"><em class="km">Clear drop in main database master writes.</em></figcaption></figure><p id="1142" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从端到端来看，这个项目花了大约两周时间完成，邮件收件箱停机时间不到7 . 5分钟，主数据库的大小减少了20%。最重要的是，这个项目通过将主数据库上的写查询减少33%,为我们带来了显著的数据库稳定性收益。这些卸载的查询预计将在未来几个月内再增长50%，这肯定会使我们的主数据库不堪重负，因此该项目为我们赢得了宝贵的时间来进行更长期的数据库稳定性和可伸缩性投资。</p><h1 id="472a" class="ko kp hh bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">令人惊讶的是:RDS快照会显著增加延迟</h1><p id="73c1" class="pw-post-body-paragraph ie if hh ig b ih lm ij ik il ln in io ip lo ir is it lp iv iw ix lq iz ja jb ha bi translated">根据<a class="ae jv" href="http://aws.amazon.com/rds/details/multi-az/" rel="noopener ugc nofollow" target="_blank"> RDS文档</a>:</p><blockquote class="mg mh mi"><p id="76f9" class="ie if mj ig b ih ii ij ik il im in io mk iq ir is ml iu iv iw mm iy iz ja jb ha bi translated"><em class="hh">与单AZ部署不同，在MySQL、Oracle和PostgreSQL引擎的多AZ部署的备份过程中，主服务器上的I/O活动不会暂停，因为备份是从备用服务器进行的。但是，请注意，在多AZ部署的备份过程中，您仍可能会经历几分钟的延迟。</em></p></blockquote><p id="2cbe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们通常在RDS的所有主实例上启用多AZ部署，以充分利用RDS的高可用性和故障转移支持。在这个项目中，我们观察到，如果数据库负载足够重，即使部署了多AZ，在RDS快照过程中经历的延迟也会非常大，足以造成查询积压并使数据库停机。我们一直都知道快照会导致延迟增加，但在此项目之前，我们没有意识到相对于数据库负载的延迟非线性增加可能会导致完全停机。</p><p id="5fa4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">鉴于RDS快照是我们日常自动备份所依赖的核心RDS功能，这一点非常重要。之前我们不知道的是，随着主数据库负载的增加，RDS快照导致站点不稳定的可能性也在增加。因此，在进行这个项目的过程中，我们意识到它比我们最初预期的更为紧迫。</p><figure class="jx jy jz ka fd kb er es paragraph-image"><div class="er es mn"><img src="../Images/ea20fa069163f01a80fb1de081632750.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/0*n9Tw2IrTV3tvMEDO.gif"/></div><figcaption class="ki kj et er es kk kl bd b be z dx"><em class="km">Xinyao, lead engineer on the project, celebrates after the op.</em></figcaption></figure><p id="5bd8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">致谢:</strong>胡新耀领导了这个项目，我在本休斯和索尼克王的指导下编写了最初的计划。Brian Morearty和Eric Levine帮助重构代码以消除跨表连接。生产基础设施团队度过了一个愉快的下午。</p><p id="3f8f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">查看来自<a class="ae jv" href="https://www.airbnb.com/careers/departments/position/9572" rel="noopener ugc nofollow" target="_blank">生产基础设施</a>团队的更多过去的项目:</p><ul class=""><li id="0686" class="ls lt hh ig b ih ii il im ip lu it lv ix lw jb mo ly lz ma bi translated"><a class="ae jv" href="https://www.youtube.com/watch?v=F-QNTyAek6c" rel="noopener ugc nofollow" target="_blank">【说话】缩放不缩放的东西</a></li><li id="4f40" class="ls lt hh ig b ih mb il mc ip md it me ix mf jb mo ly lz ma bi translated"><a class="ae jv" href="http://nerds.airbnb.com/hammerspace-persistent-concurrent-off-heap-storage/" rel="noopener ugc nofollow" target="_blank">【开源】Hammerspace:持久、并发、堆外存储</a></li><li id="1a19" class="ls lt hh ig b ih mb il mc ip md it me ix mf jb mo ly lz ma bi translated"><a class="ae jv" href="http://nerds.airbnb.com/smartstack-service-discovery-cloud/" rel="noopener ugc nofollow" target="_blank">【开源】SmartStack:云中的服务发现</a></li><li id="30f0" class="ls lt hh ig b ih mb il mc ip md it me ix mf jb mo ly lz ma bi translated"><a class="ae jv" href="http://nerds.airbnb.com/postmortems-airbnb/" rel="noopener ugc nofollow" target="_blank">Airbnb的尸检</a></li></ul></div><div class="ab cl je jf go jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="ha hb hc hd he"><h2 id="bfb7" class="mp kp hh bd kq mq mr ms ku mt mu mv ky ip mw mx lc it my mz lg ix na nb lk nc bi translated">在<a class="ae jv" href="http://airbnb.io" rel="noopener ugc nofollow" target="_blank"> airbnb.io </a>查看我们所有的开源项目，并在Twitter上关注我们:<a class="ae jv" href="https://twitter.com/AirbnbEng" rel="noopener ugc nofollow" target="_blank">@ Airbnb eng</a>+<a class="ae jv" href="https://twitter.com/AirbnbData" rel="noopener ugc nofollow" target="_blank">@ Airbnb data</a></h2></div><div class="ab cl je jf go jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="ha hb hc hd he"><p id="d745" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="mj">原载于2015年10月6日</em><a class="ae jv" href="http://nerds.airbnb.com/how-we-partitioned-airbnbs-main-db/" rel="noopener ugc nofollow" target="_blank"><em class="mj">nerds.airbnb.com</em></a><em class="mj">。</em></p></div></div>    
</body>
</html>