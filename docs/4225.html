<html>
<head>
<title>Hey Google, set my desk to standing mode!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">嘿谷歌，把我的桌子设置成站立模式！</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/hey-google-set-my-desk-to-standing-mode-b21dcc40d4b5?source=collection_archive---------2-----------------------#2019-01-29">https://medium.com/google-developer-experts/hey-google-set-my-desk-to-standing-mode-b21dcc40d4b5?source=collection_archive---------2-----------------------#2019-01-29</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="0146" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">或者如何黑掉任何电器设备，连接到谷歌助手！</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/202c78adee571c81e19bb511594b4cda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-LgROW6iWc-lOxoN6Jmz7g.jpeg"/></div></div></figure><p id="87a5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你好，如果你一直在关注我最近的推文，你就会知道我有多喜欢我的新立式办公桌:<a class="ae jo" href="https://amzn.to/2UmHpyI" rel="noopener ugc nofollow" target="_blank">flexi spot的E2B</a>！因此，在一个深夜，我有了<em class="jp">过剩的创造力</em>，我想出了一个有趣的主意:如果我可以使用谷歌助手来控制我的桌面设置会怎么样？</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="jq jr l"/></div></figure><p id="bb65" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所以我决定建立一个概念证明，5个小时后…</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="jq jr l"/></div></figure><p id="d8d6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我向您介绍一下这个过程…</p><h1 id="7c7b" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">放弃</h1><p id="0d68" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">开始之前，有几件事需要注意:</p><ol class=""><li id="729a" class="kv kw hh ig b ih ii il im ip kx it ky ix kz jb la lb lc ld bi translated"><em class="jp">此处提供的所有信息都是基于“原样”和“可用”的基础上提供的，您同意使用这些信息的风险完全由您自己承担。在任何情况下，我都不会以任何方式对您使用此处提供的信息和材料所导致的任何损害、损失、费用、成本或债务负责。</em></li><li id="3928" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated"><em class="jp">我不是专业的电子工程师，但我确实有一些知识——来自大学——足以提供这个概念证明。然而，如果你知道一个更好的替代电路，请告诉我。我将非常乐意升级我的设置！</em></li></ol><h1 id="e071" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">高级计划</h1><p id="e0b5" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">我们对该项目的计划如下:</p><ol class=""><li id="ad2d" class="kv kw hh ig b ih ii il im ip kx it ky ix kz jb la lb lc ld bi translated">逆向工程桌面控制器，了解系统如何工作。</li><li id="b114" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated">想办法不使用桌面控制器手动<strong class="ig hi">触发</strong>控制信号。</li><li id="8847" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated">想办法让<strong class="ig hi">程序化地</strong>触发控制信号。</li><li id="2ebc" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated">将谷歌助手接入系统。</li></ol></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><h1 id="d294" class="js jt hh bd ju jv lq jx jy jz lr kb kc kd ls kf kg kh lt kj kk kl lu kn ko kp bi translated">#1了解桌面控制器的工作原理</h1><p id="635b" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">显然，如果你需要了解一个设备是如何工作的，首先要做的就是打开它(<strong class="ig hi">这将使保修失效</strong>)。此外，确保你有一个备用设备(或零件)以防事情出错(它为我做了，阅读下一部分了解更多细节！).因此，谢天谢地，我已经预料到了这种情况，并买了一个备用控制器。我要感谢FlexiSpot的人们，他们很好地给了我一个折扣代码！</p><blockquote class="lv lw lx"><p id="1bdc" class="ie if jp ig b ih ii ij ik il im in io ly iq ir is lz iu iv iw ma iy iz ja jb ha bi translated">顺便说一下，如果您想购买E2立式办公桌，您可以使用代码“rffr1”获得20€的折扣(仅在<a class="ae jo" href="https://flexispot.com/" rel="noopener ugc nofollow" target="_blank"> Fexispot网站</a>上有效，直到2019年2月底)！</p></blockquote><p id="c65f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们看看桌面控制器的外部，它看起来像这样:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/1f00ff4e01c523fef139c98de33f1af9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eP1GH15WTStywhVwcQsENg.jpeg"/></div></div></figure><p id="120e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦打开，内部<a class="ae jo" href="https://en.wikipedia.org/wiki/Printed_circuit_board" rel="noopener ugc nofollow" target="_blank"> PCB </a>板显示如下设计:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mb"><img src="../Images/cb0e4bd01b603f57a3e8ea996bd6389c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FoG6DYhIVKT1YQNKZnrx8Q.png"/></div></div></figure><p id="d27e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下是该PCB中所示每个元件的基本说明:</p><ol class=""><li id="9d95" class="kv kw hh ig b ih ii il im ip kx it ky ix kz jb la lb lc ld bi translated">上下按钮可让您将书桌从70厘米升至120厘米(42.1英寸至63英寸)；</li><li id="9b69" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated">设置模式按钮允许记忆某个高度，并将其存储到M1、M2或M3插槽中(三个可编程预设)；</li><li id="1fb0" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated">自动跟踪按钮用于设置坐/站计时系统，并在该站的时候提醒您；</li><li id="b271" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated">TM1650是一个LED微控制器，负责左侧的8段显示(<a class="ae jo" href="https://os.mbed.com/components/TM1637-LED-controller-32-LEDs-max-Keyboa/" rel="noopener ugc nofollow" target="_blank">参见完整规格</a>)；</li><li id="60f8" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated">STM8S (STM8S103F2)是主微控制器，是整个系统的大脑(<a class="ae jo" href="https://www.st.com/resource/en/datasheet/stm8s103f2.pdf" rel="noopener ugc nofollow" target="_blank">见这里的数据表</a>)。</li></ol><p id="fef2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们需要弄清楚使用哪些命令来手动控制桌子，而不是真正使用(可以吗？)书桌控制器！</p><p id="fe4d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让乐趣开始吧！</p></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><h2 id="97f0" class="mc jt hh bd ju md me mf jy mg mh mi kc ip mj mk kg it ml mm kk ix mn mo ko mp bi translated">尝试#1:逆向工程STM8S微控制器(TL；大卫:不要——不要——不要——不要！！)</h2><p id="aa1e" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">我的第一个尝试是尝试对STM8S微控制器进行逆向工程，以便获得指示电机改变位置的所需信号，然后我会建模并向电机发送这些确切的信号，就好像它们来自STM8S本身一样。嗯，那是我的计划！</p><p id="c6a3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，当我尝试这个过程时，我设法损坏了微控制器的引脚14(我没有使用正确的烙铁！)其作用是降低桌子(向下按钮)。诚然，即使我设法从微控制器获得所有信号，我也不能再降低桌子了——除非更换STM8S微控制器单元，如果我有一个备用的，我会这样做的！</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es mq"><img src="../Images/86b4910228e60f6038f0740254731d7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NDOpgDsKZef528YJbbHEnA.png"/></div></div></figure><p id="d534" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所以，我不得不另想办法。实际上，有一种更简单的方法来做我正在寻找的事情。</p></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><h2 id="0811" class="mc jt hh bd ju md me mf jy mg mh mi kc ip mj mk kg it ml mm kk ix mn mo ko mp bi translated">尝试2:黑掉M1、M2和M3的按钮……？咄！</h2><p id="dbc8" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">原来有一种更简单的方法可以让我在不接触(或燃烧)的情况下向马达发送信号！)的STM8S微控制器。我只需要黑进M1，M2和M3的按钮！这些模式作为预设工作，存储桌子的特定高度，当被触发时，它们指示桌子从任何位置移动到该精确高度。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/c6f15cdd00e8a0729d02735ecfcf0dbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PJrv_mbUfesdfWwuOyC2lA.png"/></div></div></figure><blockquote class="mr"><p id="5b7a" class="ms mt hh bd mu mv mw mx my mz na jb dx translated"><strong class="ak">这种黑客方法变得更加通用，可以应用于任何有按钮输入的电子设备。</strong></p></blockquote><p id="5b78" class="pw-post-body-paragraph ie if hh ig b ih nb ij ik il nc in io ip nd ir is it ne iv iw ix nf iz ja jb ha bi translated">现在，我为下一步做好了准备:找出一种模拟按钮的方法，让微控制器认为M1、M2或M3按钮中的一个被按下了。</p><p id="387b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为此，我必须建立一个电子开关电路。</p></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><h1 id="8335" class="js jt hh bd ju jv lq jx jy jz lr kb kc kd ls kf kg kh lt kj kk kl lu kn ko kp bi translated">#2.手动触发控制信号</h1><p id="42db" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">在我们自动化所有的事情之前，让我们首先尝试并手动测试我们的方法。为此，我建立了一个简单的电路，这是一个“NPN晶体管开关电路”。这种基于晶体管的开关电路是低压DC设备的理想选择，这正是我们正在努力做的:记住，我们正在尝试模拟一个需要几毫安才能触发的按钮！</p><blockquote class="lv lw lx"><p id="76c2" class="ie if jp ig b ih ii ij ik il im in io ly iq ir is lz iu iv iw ma iy iz ja jb ha bi translated">[更新]一些读者问为什么不跳过开关电路，直接将桌面控制器连接到Onion Omega2+ SoC引脚。虽然这可行，但我希望有一个外部电路，通过允许我方便地在fututre中添加更多组件，例如外部传感器、按钮等，为我提供更多灵活性</p></blockquote><h2 id="10f5" class="mc jt hh bd ju md me mf jy mg mh mi kc ip mj mk kg it ml mm kk ix mn mo ko mp bi translated">NPN晶体管作为开关电路— 101</h2><p id="f5fe" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">简单来说，晶体管开关的工作区域被称为<strong class="ig hi">饱和区</strong>和<strong class="ig hi">截止区</strong>。这意味着我们将通过在晶体管的“完全截止”(截止)和“完全导通”(饱和)区域之间来回驱动晶体管来将它用作开关。这里是一个典型双极晶体管工作区域的<strong class="ig hi">非常简化的</strong>图示:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ng"><img src="../Images/3127785f8f0347ab0c6af86f8cdd6979.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xtXUHAQUUU3oxKDB9AVEag.png"/></div></div></figure><p id="8401" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">说到这里，我们现在来看看一个典型的“NPN晶体管开关”电路:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es nh"><img src="../Images/3245ea72bd46d313125a53bf817537b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NR81F0_hjbqFXe2VVydwwg.png"/></div></div></figure><p id="6c6e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本电路中，我们使用LED作为负载来演示开关过程。这是这样一个电路的“实现”:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ni"><img src="../Images/4184fb430b991431d386a4387fea7a8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1IESOpAhGkiGzbYquQGrnQ.png"/></div></div></figure><p id="fa4e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">很简单吧？我们的电路似乎像预期的那样工作。</p><p id="17db" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在让我们继续，将桌面控制器连接到这个电路中:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es nj"><img src="../Images/6d7218d42ed8fb29cbb5b3850f25a919.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LvnQTvGfJ7lFMPhl8P_byw.png"/></div></div></figure><p id="881f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在上图中，J1、J2和3是跳线，分别连接到我们焊接到桌面控制器的电线，即模式1、模式2和模式3。J0是地，它也将连接到桌面控制器。</p><p id="68ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是试验板上的实际电路:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/58756fddd80fabb70ea14f50c61cc9c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MDJa5mP4KmhCms0NyruPgQ.png"/></div></div></figure><p id="d68a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意，V1、V2和V3(以及不在此图中的GND)线暂时保持松弛。</p></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><h1 id="0ddb" class="js jt hh bd ju jv lq jx jy jz lr kb kc kd ls kf kg kh lt kj kk kl lu kn ko kp bi translated">#3.自动触发推送信号</h1><p id="06a6" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">为了自动触发欺骗STM8S微控制器的“按钮”信号，我们需要一个可编程的微控制器。为此，你可以使用你拥有的任何主板(Arduino，Nanode，Teensy等…)，甚至是树莓PI；任何带GPIOs的东西。</p><p id="1d9c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我最初使用Arduino MEGA 2560板来试验代码，但后来我意识到我没有Wifi屏蔽(这是该项目的下一部分所需要的)。作为参考，以下是Arduino代码:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="nk jr l"/></div></figure><p id="684c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所以我最终使用了我的一个洋葱Omega2+ wifi功能的SoC ( <em class="jp">剧透:它可以运行JavaScript！！！</em>)。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es nl"><img src="../Images/239598f722d082f18b8743aa233f1293.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1SyJhYobfzWfsbeY.png"/></div></div></figure><p id="c319" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是最终的电路。请注意，V1、V2和V3线现在连接到洋葱ω2+SoC的引脚1、2和3:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es nm"><img src="../Images/5d9122d24a8cd0589aa6e14207ed1c28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ye_2JHnk_yXC-HaVCbyLgA.png"/></div></div></figure><p id="dfb2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是试验板实现:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es nn"><img src="../Images/eacb7e61d3c06020e5cad7d20a0c3c23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p-vhgNk37bXNRu9O0WraUQ.png"/></div></div></figure><p id="bdef" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在一切就绪，我们需要做的就是编写一个简单的程序来切换GPIO引脚1、2和3:这将发送高达3.3V的高压和低至0.4V的低压。</p><p id="dbbe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">基本上，当我们将引脚1上的输出设为高电平时，这将通过基于晶体管的开关电路提供3.3V电压，进而使晶体管饱和，使其闭合开关，这将充当一个按钮。然后，STM8S将接收来自M1按钮的按下信号，然后相应地指示桌面电机。就是这样！</p><p id="6757" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面是说明这一点的实际Node.js代码:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="nk jr l"/></div></figure><blockquote class="lv lw lx"><p id="ac1d" class="ie if jp ig b ih ii ij ik il im in io ly iq ir is lz iu iv iw ma iy iz ja jb ha bi translated">我应该提到，Onion Omega2+有一个内置的shell命令，允许控制GPIO引脚。例如，如果我们需要将引脚1设置为高电压输出模式，我们可以运行下面的命令:<code class="du no np nq nr b">gpioctl dirout-high 1</code>但是我很高兴发现<a class="ae jo" href="https://www.npmjs.com/package/omega2-gpio" rel="noopener ugc nofollow" target="_blank">是一个抽象这些操作的NPM模块</a>。</p></blockquote><p id="5211" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，我们的代码正在按预期工作，我们将公开一个简单的REST API，我们将使用它来触发相同的命令，但这次是通过HTTP(这是Google Assistant集成所必需的):</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="nk jr l"/></div></figure><p id="6f10" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，我们可以轻松地向<code class="du no np nq nr b"><a class="ae jo" href="http://192.168.80.84:1337/mode/1" rel="noopener ugc nofollow" target="_blank">http://192.168.80.84:1337/mode/1</a> </code>发送GET请求，这将在800毫秒内将引脚1设置为高电平，然后将其设置回低电平。同样的事情也适用于<code class="du no np nq nr b">mode/2</code>和<code class="du no np nq nr b">mode/3</code>。</p><p id="5f87" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后要做的一件事是安排这个脚本在引导过程中自动运行。我们通过编辑<code class="du no np nq nr b">/etc/rc.local</code>脚本文件(如文档中所述的<a class="ae jo" href="https://docs.onion.io/omega2-docs/running-a-command-on-boot.html" rel="noopener ugc nofollow" target="_blank">)来做到这一点:</a></p><pre class="jd je jf jg fd ns nr nt nu aw nv bi"><span id="cd95" class="mc jt hh nr b fi nw nx l ny nz">node /root/desk-controller-assistant-server.js &amp;<br/><br/>exit 0</span></pre><blockquote class="lv lw lx"><p id="a647" class="ie if jp ig b ih ii ij ik il im in io ly iq ir is lz iu iv iw ma iy iz ja jb ha bi translated">请注意，由于我们正在执行一个节点服务器，因此该命令会持续运行。为了让引导序列成功完成(并到达出口0)，我们需要通过在命令末尾添加一个&amp;符号来分叉这个过程。</p></blockquote><p id="80db" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在进入下一部分之前，我强烈建议你给你的设备分配一个静态IP地址，这将有助于谷歌助手的集成！</p></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><p id="f23a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面是最终的硬件设置:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es oa"><img src="../Images/56b401461437605cb9365ab49c36eaa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1MUcKFhRzNymwPukDiPgRA.jpeg"/></div></div></figure></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><h1 id="60c8" class="js jt hh bd ju jv lq jx jy jz lr kb kc kd ls kf kg kh lt kj kk kl lu kn ko kp bi translated">#4连接谷歌助手</h1><h2 id="8dc5" class="mc jt hh bd ju md me mf jy mg mh mi kc ip mj mk kg it ml mm kk ix mn mo ko mp bi translated">先决条件</h2><p id="8bff" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">确定您的Arduino或Onion Omega2+可以从互联网访问。为了验证这个概念，我简单地使用了<a class="ae jo" href="https://dashboard.ngrok.com/get-started" rel="noopener ugc nofollow" target="_blank"> ngrok </a>，它允许我将一个web hook——从我的本地网络中的一个本地设备——暴露给外部世界——它确实是这个实验的完美工具！</p><p id="2364" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">不过有一点需要注意:我使用的Onion Omega2+只有32MB的内部存储空间，所以我无法在设备上安装ngrok，而是在我的Pixelbook上安装了ngrok。</strong></p><blockquote class="lv lw lx"><p id="2dbc" class="ie if jp ig b ih ii ij ik il im in io ly iq ir is lz iu iv iw ma iy iz ja jb ha bi translated">Omega2+有一个SD卡插槽来扩展内部存储，我只是不想为此而烦恼！</p></blockquote><p id="1145" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用ngrok，我在http://198.168.80.84:1337的<a class="ae jo" href="http://198.168.80.84:1337" rel="noopener ugc nofollow" target="_blank"/>(omega 2+的IP)上打开了一个HTTP隧道:</p><pre class="jd je jf jg fd ns nr nt nu aw nv bi"><span id="607a" class="mc jt hh nr b fi nw nx l ny nz">ngrok http -subdomain=wassimchegham 192.168.86.84:1337</span></pre><p id="58ad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦ngrok启动并运行，我终于得到了一个公开的URL:</p><pre class="jd je jf jg fd ns nr nt nu aw nv bi"><span id="3aad" class="mc jt hh nr b fi nw nx l ny nz">https://wassimchegham.ngrok.io/</span></pre><p id="fc97" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，我可以向我的设备发送HTTP请求来设置所需的模式:</p><pre class="jd je jf jg fd ns nr nt nu aw nv bi"><span id="7757" class="mc jt hh nr b fi nw nx l ny nz">https://wassimchegham.ngrok.io/mode/1</span></pre><blockquote class="lv lw lx"><p id="c4b8" class="ie if jp ig b ih ii ij ik il im in io ly iq ir is lz iu iv iw ma iy iz ja jb ha bi translated"><strong class="ig hi"> ⚠️警告</strong> : ngrok会把你的本地机器暴露在互联网上。如果你不用的话，请务必关机。</p></blockquote><h2 id="5732" class="mc jt hh bd ju md me mf jy mg mh mi kc ip mj mk kg it ml mm kk ix mn mo ko mp bi translated">设置谷歌助手——最快的方法:IFTTT</h2><p id="4b4c" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">这就是臭名昭著的IFTTT T7的用武之地。这是我用过的配方:</p><p id="e833" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果…</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ob"><img src="../Images/7941b737c3470e407dd4f737fd5db132.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QMVRMx5qSotbMqNQcP6myw.png"/></div></div></figure><p id="ef70" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后…</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es oc"><img src="../Images/c081a8c0349d0e934e26a2ec29b82c96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BH560JfuwnlNipL8HmrpBg.png"/></div></div></figure><p id="25d6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">搞定了。</p><blockquote class="lv lw lx"><p id="66ed" class="ie if jp ig b ih ii ij ik il im in io ly iq ir is lz iu iv iw ma iy iz ja jb ha bi translated">我强烈建议阅读下一部分关于将物联网设备与谷歌助手集成的推荐方法。</p></blockquote></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><h2 id="17cc" class="mc jt hh bd ju md me mf jy mg mh mi kc ip mj mk kg it ml mm kk ix mn mo ko mp bi translated">设置谷歌助手——推荐方式:智能家居应用编程接口</h2><p id="c363" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">如果你正在建立一个与谷歌助手的<em class="jp">严肃的</em>设备集成，你将不得不建立一个智能家居行动:</p><blockquote class="mr"><p id="4234" class="ms mt hh bd mu mv od oe of og oh jb dx translated">智能家居行动依赖于Home Graph，这是一个存储和提供关于家庭及其设备的上下文数据的数据库。例如，Home Graph可以存储客厅的概念，其中包含来自不同制造商的多种类型的设备(灯、电视和扬声器)。这些信息被传递给Google Assistant，以便根据适当的上下文执行用户请求。<a class="ae jo" href="https://developers.google.com/actions/smarthome/" rel="noopener ugc nofollow" target="_blank">阅读更多</a>。</p></blockquote><p id="b59d" class="pw-post-body-paragraph ie if hh ig b ih nb ij ik il nc in io ip nd ir is it ne iv iw ix nf iz ja jb ha bi translated">创建智能家居操作需要您执行以下命令:</p><ul class=""><li id="14ee" class="kv kw hh ig b ih ii il im ip kx it ky ix kz jb oi lb lc ld bi translated"><strong class="ig hi"> action.devices.SYNC </strong>:请求用户已经连接并可供使用的设备列表。</li><li id="78f2" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb oi lb lc ld bi translated"><strong class="ig hi"> action.devices.QUERY </strong>:查询设备的当前状态。</li><li id="050d" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb oi lb lc ld bi translated"><strong class="ig hi">action . devices . execute:</strong>请求在智能家居设备上执行命令。如果可用，应在响应中提供新状态。一个执行意图可以用多个命令针对多个设备。</li><li id="7807" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb oi lb lc ld bi translated"><strong class="ig hi">action . devices . disconnect</strong>:当用户从Google Assistant取消应用账户的链接时，通知你的应用。收到断开连接意向后，您不应报告此用户设备的状态。</li></ul><p id="8895" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我不打算解释每种方法的所有实现细节。但是，我应该提到，虽然大部分代码是改编自<a class="ae jo" href="https://codelabs.developers.google.com/codelabs/smarthome-washer/#0" rel="noopener ugc nofollow" target="_blank">的智能洗衣机代码实验室</a>。因此，我强烈建议您务必遵循codelab，了解如何部署智能设备并将其与Google Assistant同步的更多详细信息。</p><blockquote class="lv lw lx"><p id="0cfe" class="ie if jp ig b ih ii ij ik il im in io ly iq ir is lz iu iv iw ma iy iz ja jb ha bi translated">向<a class="oj ok ge" href="https://medium.com/u/baa42a5b27c5?source=post_page-----b21dcc40d4b5--------------------------------" rel="noopener" target="_blank"> Nick Felker </a>和他的团队致敬，是他们构建了这个代码实验室，为我节省了很多时间👏🏼</p></blockquote><p id="1919" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">即使每个智能家居的操作逻辑都不同，但99%的智能家居都共享相同的样板代码(假设他们使用Node.js和Firebase):</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="nk jr l"/></div></figure><blockquote class="lv lw lx"><p id="42ba" class="ie if jp ig b ih ii ij ik il im in io ly iq ir is lz iu iv iw ma iy iz ja jb ha bi translated">要了解更多关于每种方法的作用，请前往官方文档。</p></blockquote><p id="6a4e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">关于<a class="ae jo" href="https://developers.google.com/actions/smarthome/traits/" rel="noopener ugc nofollow" target="_blank">设备特性</a> API有一点需要注意:当注册一个新设备(即一个智能家居动作)与谷歌助手(即。主页图)，您的设备必须是受支持的设备之一(<a class="ae jo" href="https://developers.google.com/actions/smarthome/guides/" rel="noopener ugc nofollow" target="_blank">参见完整列表</a>)，并且必须具有受支持的特征之一(<a class="ae jo" href="https://developers.google.com/actions/smarthome/traits/" rel="noopener ugc nofollow" target="_blank">参见完整列表</a>)。此外，每个特征属性如模式属性(<a class="ae jo" href="https://developers.google.com/actions/reference/smarthome/traits/modes" rel="noopener ugc nofollow" target="_blank">见完整列表</a>)和切换属性(<a class="ae jo" href="https://developers.google.com/actions/reference/smarthome/traits/toggles" rel="noopener ugc nofollow" target="_blank">见完整列表</a>)也必须是支持的属性之一。因此，很明显，立式办公桌不属于上述任何一类。然后，我不得不制作主页图，认为立式办公桌是一个…开关(类型:<code class="du no np nq nr b">action.devices.types.SWITCH</code>)，具有开/关功能(特征:<code class="du no np nq nr b">actions.devices.traits.OnOff</code>)。这意味着我的桌子只能有两种状态:</p><ul class=""><li id="08d0" class="kv kw hh ig b ih ii il im ip kx it ky ix kz jb oi lb lc ld bi translated">打开:将升高桌子(模式3)。</li><li id="7fdc" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb oi lb lc ld bi translated">关闭:将降低桌子(模式1)。</li></ul><p id="cf52" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">嗯！对于这个概念验证来说，这应该没问题。但是，如果您正在构建自己的设备集成，您可以将大量其他特性结合在一起，与您的设备功能完美匹配。</p><p id="8cec" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">说到我们的具体代码实现，下面是完整的实现:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="nk jr l"/></div></figure><p id="656f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里是完整的项目源代码，如果你想改善设置</p><div class="ol om ez fb on oo"><a href="https://github.com/manekinekko/standing-desk-assistant" rel="noopener  ugc nofollow" target="_blank"><div class="op ab dw"><div class="oq ab or cl cj os"><h2 class="bd hi fi z dy ot ea eb ou ed ef hg bi translated">manekinekko/站立式办公桌助理</h2><div class="ov l"><h3 class="bd b fi z dy ot ea eb ou ed ef dx translated">在GitHub上创建一个帐户，为manekinekko/站立式办公桌助理的开发做出贡献。</h3></div><div class="ow l"><p class="bd b fp z dy ot ea eb ou ed ef dx translated">github.com</p></div></div><div class="ox l"><div class="oy l oz pa pb ox pc jm oo"/></div></div></a></div><p id="0488" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">基本上，代码做的是:当我们向智能家居动作发送命令时，我们将每个状态存储在Firebase实时数据库中。然后，对于每个状态变化，我们只需通过ngrok将HTTP请求发送到我们的本地设备。这是该架构的概要图，不言自明:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es pd"><img src="../Images/f82ce5783416a9c9c03e7fbd5762758f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YauIyXGlP2k-wV4Z0HnQdQ.jpeg"/></div></div></figure><blockquote class="lv lw lx"><p id="0916" class="ie if jp ig b ih ii ij ik il im in io ly iq ir is lz iu iv iw ma iy iz ja jb ha bi translated">关于智能家居API如何工作的更详细解释，请参考<a class="ae jo" href="https://developers.google.com/actions/smarthome/" rel="noopener ugc nofollow" target="_blank">官方文档</a>。</p></blockquote><p id="a977" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，让我们连接并使用我们的<strong class="ig hi">【测试】立式工作台</strong>设备(即。切换)到我们的谷歌助手:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es pe"><img src="../Images/38277c26840a57d489273e2539f98f90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Odh_9uoYFTZPFDk8AVxoWA.png"/></div></div></figure><blockquote class="lv lw lx"><p id="ea87" class="ie if jp ig b ih ii ij ik il im in io ly iq ir is lz iu iv iw ma iy iz ja jb ha bi translated">记得从<a class="ae jo" href="https://console.actions.google.com/u/0/" rel="noopener ugc nofollow" target="_blank">动作控制台</a>部署智能家居动作的测试版本，以便在可用设备列表下找到。</p></blockquote><p id="491c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了与动作进行更自然的交互，我创建了两个例程，允许我升高和降低我的桌子，而不是打开和关闭我的桌子:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es pf"><img src="../Images/3dafefaf0cb931574102b359094bb544.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fom2SZY3P-67pkpjEcweLQ.png"/></div></div></figure></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><h1 id="a163" class="js jt hh bd ju jv lq jx jy jz lr kb kc kd ls kf kg kh lt kj kk kl lu kn ko kp bi translated">谢谢大家！</h1><p id="6a8c" class="pw-post-body-paragraph ie if hh ig b ih kq ij ik il kr in io ip ks ir is it kt iv iw ix ku iz ja jb ha bi translated">就是这样！我希望你喜欢读这篇文章，就像我喜欢写这篇文章和构建这个有趣的项目一样。</p><p id="77d6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下次再见，保重❤️</p></div><div class="ab cl lj lk go ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ha hb hc hd he"><p id="56b9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jp">关注我</em><a class="ae jo" href="https://twitter.com/manekinekko" rel="noopener ugc nofollow" target="_blank"><em class="jp">@ manekinekko</em></a><em class="jp">更多好玩的项目。</em></p></div></div>    
</body>
</html>