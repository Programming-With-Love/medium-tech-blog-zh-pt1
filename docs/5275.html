<html>
<head>
<title>Validating JSON in Oracle Mobile Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Oracle移动云中验证JSON</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/validating-json-in-mcs-bc98ccaeec0d?source=collection_archive---------0-----------------------#2017-08-08">https://medium.com/oracledevs/validating-json-in-mcs-bc98ccaeec0d?source=collection_archive---------0-----------------------#2017-08-08</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="04be" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有一天，我和一个客户一起工作，解决一个API的问题，当它被一个MAX应用程序访问时，似乎不工作了。当他在MCS (Oracle移动云服务)中测试API时，一切都很好。当他从MAX访问API调用时，列表控件为空，显示消息“没有找到数据”。</p><p id="aba0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">幸运的是，这位客户注意到API返回的JSON和模式指定的JSON格式之间有一点差异。API返回的JSON值的模式不同于实际的返回值，这就是问题的根源。</p><h1 id="e9c5" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">MCS不会验证您的数据</h1><p id="a398" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">默认情况下，MCS不会验证您通过它传递的任何数据。开发人员通常认为，既然MCS允许您指定模式，或者参数的限制、模式或范围，那么MCS就是在验证这些值。事实并非如此。您可以通过测试HelloValidation API来了解这一点，该API在简单的问候请求中指定了一个4位数。请使用2位数，MCS将很乐意为您提供示例数据。缺乏自动验证有两个主要原因:<br/> 1)验证需要时间，会降低服务响应时间。<br/> 2)如果您创建一个REST服务，它可以接受多种请求类型并提供多种响应类型(<em class="kf"> application/json </em>、<em class="kf">application/x-www-form-urlencoded</em>或<em class="kf"> multipart/form-data </em>)，那么自动验证有效负载几乎是不可能的。</p><p id="9300" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，作为开发人员，我们知道在创建新服务时，较慢的响应时间是值得的。在开发阶段，我们需要了解服务是如何运行的，而不是执行速度。幸运的是，MCS和Node.js确实允许验证，并且您可以在您的自定义代码中打开或关闭它。</p><h1 id="2794" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">向MCS代码添加验证</h1><p id="016e" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">向代码中添加验证需要几个步骤。你首先需要的是你的API。我已经为我的示例API创建了一个RAML文件，您可以使用它来创建与我在这个博客条目中使用的服务相同的服务。我将该API命名为HelloValidation。</p><blockquote class="kg kh ki"><p id="4886" class="ie if kf ig b ih ii ij ik il im in io kj iq ir is kk iu iv iw kl iy iz ja jb ha bi translated">#%RAML 0.8 <br/>标题:HelloValidation <br/>版本:1.0<br/>base uri:/mobile/custom/hello validation<br/>协议:【HTTPS】<br/>schemas:<br/>—Simple Greeting:|<br/>{<br/>" $ schema ":<a class="ae km" href="http://json-schema.org/draft-04/schema#" rel="noopener ugc nofollow" target="_blank">http://json-schema.org/draft-04/schema#</a>"，<br/> "definitions": {}，<br/>" id ":"<a class="ae km" href="http://oracle.com/simplegreeting" rel="noopener ugc nofollow" target="_blank"/>"，<br/>" properties ":{<br/>" Simple Greeting 已验证的问候语<br/> <br/>协议:[HTTPS] <br/>查询参数:<br/> id: <br/>显示名称:用户ID <br/>描述:| <br/>用户的唯一ID<br/><br/>类型:编号<br/>最小值:1000 <br/>最大值:9999 <br/>示例:| <br/> 1234 <br/> <br/>必需:true <br/>响应:<br/> 200: <br/></p></blockquote><p id="d50a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在您需要一个JSON验证器包。有好几个，但是我选择了npm的“jsonschema”包，因为它看起来很容易使用。请注意，我并没有对所有可用的JSON验证器进行详尽(甚至粗略)的检查，所以我对jsonschema的使用并不是一种认可，只是一个方便的例子。请随意用您选择的验证器进行替换。</p><p id="2026" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从MCS下载HelloValidation服务的javascript框架，并将其解压缩到本地硬盘上进行编辑。</p><p id="8769" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">打开一个命令窗口，导航到包含HelloValidation服务的目录。</p><p id="7105" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">键入以下命令:<br/><em class="kf">NPM install jsonschemma</em></p><p id="fc9d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">安装完成后，您将看到node_modules目录。我们现在需要让您的代码知道这个包的存在。打开package.json文件和package-lock.json文件并比较它们。更新package.json文件，使其看起来像下面这样(假设jsonschema的版本号在我写这篇文章之后没有改变)。</p><blockquote class="kg kh ki"><p id="8e0a" class="ie if kf ig b ih ii ij ik il im in io kj iq ir is kk iu iv iw kl iy iz ja jb ha bi translated">{ <br/> "name": "hellovalidation "，<br/> "version": "1.0 "，<br/> "description ":"向调用方提供经过验证的问候语"，<br/> "main": "hellovalidation.js "，<br/>" Oracle mobile ":{<br/>" dependencies ":{<br/>" API ":{ }，<br/>" connectors ":{ }<br/>}<br/>}，<br/> "dependencies "</p></blockquote><p id="ccb4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，您需要修改每个GET方法的代码，以提供经过验证的响应。我们还将使用此代码来发送无效的请求和响应。打开<em class="kf"> hellovalidation.js </em>文件。我们要做的第一件事是为<em class="kf"> simplevalidation </em>的GET方法的<em class="kf"> {id} </em>查询参数添加一些验证。这是完成的函数，我将仔细阅读更有趣的代码行来解释到底发生了什么。</p><blockquote class="kg kh ki"><p id="d736" class="ie if kf ig b ih ii ij ik il im in io kj iq ir is kk iu iv iw kl iy iz ja jb ha bi translated">module . exports = function(service){<br/>var validation active = true；</p><p id="7175" class="ie if kf ig b ih ii ij ik il im in io kj iq ir is kk iu iv iw kl iy iz ja jb ha bi translated">/** <br/> *打包该文件的归档中的samples.txt文件包含一些示例代码。<br/> */</p><p id="3718" class="ie if kf ig b ih ii ij ik il im in io kj iq ir is kk iu iv iw kl iy iz ja jb ha bi translated">service . Get('/mobile/custom/hello validation/simple greeting '，function(req，res) { <br/> //以数字形式获取“id”查询参数。默认为字符串<br/>var id = parse int(req . query . id)；</p><p id="2378" class="ie if kf ig b ih ii ij ik il im in io kj iq ir is kk iu iv iw kl iy iz ja jb ha bi translated">if(validationActive) { <br/> //初始化我们的验证器对象<br/>var Validator = require(' JSON schema ')。验证器；<br/>var v = new Validator()；</p><p id="38c8" class="ie if kf ig b ih ii ij ik il im in io kj iq ir is kk iu iv iw kl iy iz ja jb ha bi translated">//为1000到9999之间的数值创建一个模式<br/>var id schema = { " type ":" number "，" minimum": 1000，" maximum ":9999 }；</p><p id="74d3" class="ie if kf ig b ih ii ij ik il im in io kj iq ir is kk iu iv iw kl iy iz ja jb ha bi translated">console.info("用值:"+ id "验证id)；<br/> //验证查询参数<br/> var vRes = v.validate(id，id schema)；<br/>if(vres . errors . length&gt;0){<br/>//ID出错。处理它<br/>console . info(" bad ID:"+ID)；<br/> } else { <br/> //验证通过。<br/> console.info("好ID:"+ID)；<br/>}<br/>console . info(vRes)；//将验证结果写入日志。<br/> }</p><p id="eaf0" class="ie if kf ig b ih ii ij ik il im in io kj iq ir is kk iu iv iw kl iy iz ja jb ha bi translated">//创建我们的结果对象<br/>var result = { " simple greeting ":" Hello John " }；</p><p id="db97" class="ie if kf ig b ih ii ij ik il im in io kj iq ir is kk iu iv iw kl iy iz ja jb ha bi translated">if(validationActive) { <br/> //现在创建我们的结果模式<br/>var result schema = {<br/>" $ schema ":<a class="ae km" href="http://json-schema.org/draft-04/schema#" rel="noopener ugc nofollow" target="_blank">http://json-schema.org/draft-04/schema#</a>"，<br/>"定义":{}，<br/>" id ":"<a class="ae km" href="http://oracle.com/simplegreeting" rel="noopener ugc nofollow" target="_blank">http://oracle.com/simplegreeting</a>"，<br/>" properties ":{<br/>" simple greeting ":{<br/>" id ":"/properties/simple greeting "，<br/> "type": "string" <br/> }。<br/> }</p><p id="ef93" class="ie if kf ig b ih ii ij ik il im in io kj iq ir is kk iu iv iw kl iy iz ja jb ha bi translated">var statusCode = 200//成功<br/> res.status(statusCode)。发送(结果)；<br/>})；<br/>}；</p></blockquote><p id="96b4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意靠近代码顶部的一行:<br/><em class="kf">var validation active = true；</em> <br/>这是我们打开和关闭验证的开关。当您将代码转移到产品中时，这允许您快速而轻松地关闭验证。当然，您可能希望在生产中保持验证打开，尤其是当您的服务被合作伙伴或公众调用时。它们完全有可能无意或故意发送错误的查询参数或有效负载。</p><p id="0f2a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">很自然，在生产代码中，您会希望将错误发送回调用者，无论是在响应的头部还是主体中。这个例子并不是为了展示编码的最佳实践，只是为了展示将JSON验证添加到您的项目中是多么容易</p></div></div>    
</body>
</html>