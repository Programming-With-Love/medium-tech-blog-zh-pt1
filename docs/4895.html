<html>
<head>
<title>Download files with Ktor client, Koin and Coroutines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Ktor客户端、Koin和协同程序下载文件</h1>
<blockquote>原文：<a href="https://blog.kotlin-academy.com/download-files-with-ktor-and-coroutines-e96b1cc8b657?source=collection_archive---------4-----------------------#2019-10-13">https://blog.kotlin-academy.com/download-files-with-ktor-and-coroutines-e96b1cc8b657?source=collection_archive---------4-----------------------#2019-10-13</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/e4988ce702658b8e0317af23637850ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fzt4uyV3NQdDu063jilxVg.jpeg"/></div></div></figure><div class=""/><div class=""><h2 id="8fdc" class="pw-subtitle-paragraph jv ix iy bd b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dk translated">使用Ktor和Koin在RecyclerView中下载文件的简单指南</h2></div><h2 id="d096" class="kn ko iy bd kp kq kr dn ks kt ku dp kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">给我看看代码:Koin</h2><p id="6681" class="pw-post-body-paragraph lj lk iy ll b lm ln jz lo lp lq kc lr kw ls lt lu la lv lw lx le ly lz ma mb ig bi translated">Koin 是一个实用的轻量级依赖注入框架，面向Kotlin开发者(我们❤ Kotlin！)</p><p id="8ed1" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">因此，让我们从在项目build.gradle中插入依赖项开始:</p><figure class="mi mj mk ml gt ip"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="9a78" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">那么我们应该在我们的应用程序类中初始化它:</p><figure class="mi mj mk ml gt ip"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="fe15" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">就是这样！这样，我们可以在应用程序中拥有一个安全的静态上下文。因此创建一个类<code class="fe mo mp mq mr b">Extensions.kt</code>并插入这个扩展val:</p><figure class="mi mj mk ml gt ip"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="4ccf" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">当你需要一个上下文(例如，访问一个数据类中的资源)而你又不能拥有它的时候,<code class="fe mo mp mq mr b">glocalContext</code>是有用的。一般来说，当Android使<strong class="ll iz">可用</strong>时，你不需要<strong class="ll iz">也不应该</strong>使用它(例如，活动、片段等)。Koin帮助我们避免任何<strong class="ll iz">内存泄漏</strong>,因为上下文对象除了存储在Koin本身之外不存储在任何地方，但是它可以通过这个扩展在几乎任何地方被访问</p><h1 id="6557" class="ms ko iy bd kp mt mu mv ks mw mx my kv ke mz kf kz kh na ki ld kk nb kl lh nc bi translated">ktor-客户端</h1><p id="40bb" class="pw-post-body-paragraph lj lk iy ll b lm ln jz lo lp lq kc lr kw ls lt lu la lv lw lx le ly lz ma mb ig bi translated"><a class="ae mc" href="https://ktor.io/" rel="noopener ugc nofollow" target="_blank"> Ktor </a>是一个用来实现服务器端应用的框架。此外，它还包括Ktor-client，这是一个多平台HTTP客户端，可以在手机或浏览器等前端应用程序上使用。所以Ktor-client和Kotlin协同程序一起提供了很棒的工具，以简单直接的方式处理<strong class="ll iz">异步网络请求</strong></p><p id="60df" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">要使用Ktor-client，我们首先需要在我们的项目build.gradle中添加这些依赖项</p><figure class="mi mj mk ml gt ip"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="54d4" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">也不要忘记添加这个:(否则，项目不会编译)</p><figure class="mi mj mk ml gt ip"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="3950" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">创建Ktor的一个<strong class="ll iz">实例</strong>就像一个星期天的早晨一样简单…</p><figure class="mi mj mk ml gt ip"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="fdaf" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">…让它出现在我们的代码中也一样简单。将它作为<strong class="ll iz">单模块</strong>添加到<strong class="ll iz"> Koin初始化方法</strong>中即可:</p><figure class="mi mj mk ml gt ip"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="f363" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">现在我们可以用<code class="fe mo mp mq mr b">by inject&lt;HttpClient&gt;()</code>注入实例</p><h2 id="2bf1" class="kn ko iy bd kp kq kr dn ks kt ku dp kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">主要活动和适配器</h2><p id="4c43" class="pw-post-body-paragraph lj lk iy ll b lm ln jz lo lp lq kc lr kw ls lt lu la lv lw lx le ly lz ma mb ig bi translated">最后，我们有了开始的一切，所以我们可以创建一个带有<code class="fe mo mp mq mr b">RecyclerView</code>和一个列表<code class="fe mo mp mq mr b">DummyData</code>的<code class="fe mo mp mq mr b">Activity</code>。</p><p id="01d1" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">您可以看到，在<code class="fe mo mp mq mr b">manageClickAdapte</code>中，我们使用一个协程来启动下载，并使用我们的适配器的自定义方法来设置<code class="fe mo mp mq mr b">isDownloading</code>属性的状态。</p><p id="dc20" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">这个方法的核心是<code class="fe mo mp mq mr b">downloadFile</code>扩展函数。它是一个挂起函数，接收<strong class="ll iz">文件</strong>，其中写入从<strong class="ll iz"> URL </strong>下载的字节，并带有操作结果的回调:</p><figure class="mi mj mk ml gt ip"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="6043" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">这是我的“AttachementAdapter”实现，用于显示列表中的所有元素。它膨胀item_list布局，决定每个元素的外观，然后用数据填充每个元素。构造函数接收一个回调函数来管理对项目的点击</p><figure class="mi mj mk ml gt ip"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="2144" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">这是用于呈现单个项目的布局:</p><figure class="mi mj mk ml gt ip"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="a6cb" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">如果一切顺利，我们应该看到一个非常简单的项目列表，我们可以下载文件或显示下载的内容。现在你可以下载任何有phew行代码的文件了！</p><figure class="mi mj mk ml gt ip gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/9ba22ba16acfe3274161f6aac64617ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*zPL0ZOo_D7DQIEzymW7dTg.gif"/></div></figure><p id="457c" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">这里是Github项目的例子</p><div class="im in gp gr io ne"><a href="https://github.com/francescogatto/Ktor-Koin-Files-Downlaod" rel="noopener  ugc nofollow" target="_blank"><div class="nf ab fo"><div class="ng ab nh cl cj ni"><h2 class="bd iz gy z fp nj fr fs nk fu fw ix bi translated">弗朗切斯科加托/Ktor-Koin-文件-下载</h2><div class="nl l"><h3 class="bd b gy z fp nj fr fs nk fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nm l"><p class="bd b dl z fp nj fr fs nk fu fw dk translated">github.com</p></div></div><div class="nn l"><div class="no l np nq nr nn ns iu ne"/></div></div></a></div><p id="5025" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">如果你喜欢这个故事，不要忘记鼓掌:)在下一部分，我们将看到如何下载文件与工作管理器和Ktor显示一个确定的进度条！<strong class="ll iz">敬请期待！</strong></p></div><div class="ab cl nt nu hr nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ig ih ii ij ik"><h1 id="bb64" class="ms ko iy bd kp mt oa mv ks mw ob my kv ke oc kf kz kh od ki ld kk oe kl lh nc bi translated">单击👏说“谢谢！”并帮助他人找到这篇文章。</h1><p id="fa2e" class="pw-post-body-paragraph lj lk iy ll b lm ln jz lo lp lq kc lr kw ls lt lu la lv lw lx le ly lz ma mb ig bi translated">了解卡帕头最新的重大新闻。学院、<a class="ae mc" href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a" rel="noopener ugc nofollow" target="_blank">订阅时事通讯</a>、<a class="ae mc" href="https://twitter.com/ktdotacademy" rel="noopener ugc nofollow" target="_blank">观察Twitter </a>并在medium上关注我们。</p><p id="c8fe" class="pw-post-body-paragraph lj lk iy ll b lm md jz lo lp me kc lr kw mf lt lu la mg lw lx le mh lz ma mb ig bi translated">如果您需要Kotlin工作室，请查看我们如何帮助您:<a class="ae mc" href="https://www.kt.academy/" rel="noopener ugc nofollow" target="_blank"> kt.academy </a>。</p><figure class="mi mj mk ml gt ip gh gi paragraph-image"><a href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a"><div class="gh gi of"><img src="../Images/3146970f03e44cb07afe660b0d43e045.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*54OqlYA4etu7wfpmMP5TKQ.png"/></div></a></figure></div></div>    
</body>
</html>