<html>
<head>
<title>Solving the Mystery of Export to Excel in NodeJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在NodeJS中解开导出Excel之谜</h1>
<blockquote>原文：<a href="https://medium.com/globant/the-mystery-behind-export-to-excel-in-nodejs-dd2563285e66?source=collection_archive---------0-----------------------#2021-01-07">https://medium.com/globant/the-mystery-behind-export-to-excel-in-nodejs-dd2563285e66?source=collection_archive---------0-----------------------#2021-01-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="ce32" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">如何使用NodeJS和Express创建到excel服务的导出</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/86580ec00743a5e05b67a57d208084fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jg0xvHKBtFZ23J3wROdm4w.jpeg"/></div></div></figure><h1 id="3313" class="ji jj hh bd jk jl jm jn jo jp jq jr js in jt io ju iq jv ir jw it jx iu jy jz bi translated">先决条件</h1><p id="646d" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">读者应该对NodeJS和ExpressJS有基本的了解，因为这篇文章更多的是针对一个特定的用例，而不是对Node和Express的概述:)</p><h1 id="1a1c" class="ji jj hh bd jk jl jm jn jo jp jq jr js in jt io ju iq jv ir jw it jx iu jy jz bi translated">用例</h1><p id="6473" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated">几个月前，我被分配了一项令人难以置信的任务，为银行领域的一个应用程序创建导出到excel服务。我们花了大量的研究、努力和毅力来实现这个目标，因此我们想到与开源社区共享这个库。</p><p id="e913" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated">让我们制定导出到excel服务的基本要求。</p><ul class=""><li id="b5f6" class="lb lc hh kc b kd kw kg kx kj ld kn le kr lf kv lg lh li lj bi translated">导出的excel文件应包含当前银行余额大于等于查询参数中指定金额的客户列表。</li><li id="6476" class="lb lc hh kc b kd lk kg ll kj lm kn ln kr lo kv lg lh li lj bi translated">工作表应受密码保护，以便修改，密码为提出导出文件请求的用户的用户名。用户名将出现在请求标题中。</li><li id="1fa8" class="lb lc hh kc b kd lk kg ll kj lm kn ln kr lo kv lg lh li lj bi translated">默认情况下，包含客户列表的工作表应该应用筛选器。</li><li id="479c" class="lb lc hh kc b kd lk kg ll kj lm kn ln kr lo kv lg lh li lj bi translated">当用户滚动客户列表时，第一行应该冻结。</li><li id="13a1" class="lb lc hh kc b kd lk kg ll kj lm kn ln kr lo kv lg lh li lj bi translated">总计行应该显示在最后，以显示所有客户的总余额。</li></ul></div><div class="ab cl lp lq go lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ha hb hc hd he"><p id="590f" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated">既然意识到了问题陈述，那就一步步来解开这个谜团吧。策略是用Express应用程序创建一个NodeJS，它使用一个库将JSON文档从MongoDB导出到一个excel文件。与往常一样，在npm世界中，考虑到有大量的库可用，为定义的用例选择最佳的库需要大量的试错。对于我们的使用案例和功能请求，我们必须从以下可用选项中进行选择:</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lw"><img src="../Images/87c1bbd51c936625b7410c3c68780b89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SvWKmn86Kr_kdQJ7mKJpzg.png"/></div></div><figcaption class="lx ly et er es lz ma bd b be z dx">NPM export to excel libraries mapped to its supported feature set</figcaption></figure><p id="b40d" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated">基于上面提到的技术和特性集分析，我们决定使用<a class="ae mb" href="https://www.npmjs.com/package/exceljs" rel="noopener ugc nofollow" target="_blank"> exceljs </a>作为我们的用例。ExcelJS支持开箱即用的密码保护，这将使我们能够使用用户名作为密码来保护生成的文件。除此之外，它还支持一些特性，比如末尾的合计行和行冻结，以及冻结包含网格标题的第一行。</p></div><div class="ab cl lp lq go lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ha hb hc hd he"><p id="a241" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated">考虑到这一点，我们已经准备好动手直接研究代码了。我们还在等什么？让我们开始吧。</p><h1 id="b321" class="ji jj hh bd jk jl jm jn jo jp jq jr js in jt io ju iq jv ir jw it jx iu jy jz bi translated">应用程序设置</h1><p id="32ce" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated"><strong class="kc hi">步骤1: </strong>让我们使用以下命令创建一个npm包。</p><p id="a689" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><code class="du mc md me mf b">npm init</code></p><p id="3a43" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated">它会问你几个问题，回答如下:</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es mg"><img src="../Images/6c61ee8bad39f31bfd8a2a2c5e037f99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/1*YtLohqmdI-7d9ZHAfo0o0A.png"/></div><figcaption class="lx ly et er es lz ma bd b be z dx">Answering the questions asked while npm init</figcaption></figure><p id="f475" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><strong class="kc hi">第二步:</strong>使用以下命令安装<a class="ae mb" href="https://www.npmjs.com/package/express" rel="noopener ugc nofollow" target="_blank"> express </a>、<a class="ae mb" href="https://www.npmjs.com/package/http-status-code" rel="noopener ugc nofollow" target="_blank"> http-status-code </a>、<a class="ae mb" href="https://www.npmjs.com/package/mongoose" rel="noopener ugc nofollow" target="_blank">mongose</a>、<a class="ae mb" href="https://www.npmjs.com/package/nodemon" rel="noopener ugc nofollow" target="_blank"> nodemon </a>和<a class="ae mb" href="https://www.npmjs.com/package/dotenv" rel="noopener ugc nofollow" target="_blank"> dotenv </a>。</p><p id="0130" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><code class="du mc md me mf b">npm install express http-status-codes mongoose exceljs --save</code></p><p id="33aa" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><code class="du mc md me mf b">npm install nodemon dotenv --save-dev</code></p><p id="0155" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><strong class="kc hi">步骤3: </strong>在你的工作目录下创建以下文件和文件夹。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es mh"><img src="../Images/465d24c305a163229301f647742b5a5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:418/format:webp/1*4owSOzYErg3Q0fQ5jmqPjQ.png"/></div><figcaption class="lx ly et er es lz ma bd b be z dx">Folder structure to begin the development of export to excel service</figcaption></figure><p id="acb7" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><strong class="kc hi">步骤4: </strong>接下来，我们将设置数据库。我们将使用MongoDB <a class="ae mb" href="https://docs.atlas.mongodb.com/getting-started" rel="noopener ugc nofollow" target="_blank"> Atlas cloud数据库</a>，但是你也可以自由地在本地安装<a class="ae mb" href="https://mongoosejs.com/docs/connections.html" rel="noopener ugc nofollow" target="_blank"> MongoDB。</a></p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mi"><img src="../Images/0c7521d16396b9c4b93dfa671819fe3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JsU-cFWZ-TSQX4ouum5tcQ.png"/></div></div><figcaption class="lx ly et er es lz ma bd b be z dx">MongoDB Atlas with customer database and customers collection</figcaption></figure><p id="64fc" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><strong class="kc hi">步骤5: </strong>现在，让我们将样本数据插入到客户集合中，以便它可以用于生成报告。我们已经使用了<a class="ae mb" href="https://www.json-generator.com/" rel="noopener ugc nofollow" target="_blank"> json-generator </a>工具，使用下面提到的模式来生成样本记录。复制该模式，您应该能够生成大约33条用于测试的记录。</p><pre class="ix iy iz ja fd mj mf mk ml aw mm bi"><span id="fdf6" class="mn jj hh mf b fi mo mp l mq mr">[<br/>  '{{repeat(5, 100)}}',<br/>  {<br/>    _id: '{{objectId()}}',<br/>    name: '{{firstName()}} {{surname()}}',<br/>    balance: '{{floating(1000, 40000, 2)}}',<br/>    gender: '{{gender()}}',<br/>    email: '{{email()}}',<br/>    age: '{{integer(18, 90)}}'<br/>  }<br/>]</span></pre><p id="f36e" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><strong class="kc hi">第六步:</strong>从json生成器工具下载json文件，<a class="ae mb" href="https://docs.mongodb.com/compass/current/import-export" rel="noopener ugc nofollow" target="_blank">使用<a class="ae mb" href="https://www.mongodb.com/try/download/compass" rel="noopener ugc nofollow" target="_blank"> MongoDB指南针工具</a>将其导入到MongoDB </a>中。这是备份数据库的最后一步。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es ms"><img src="../Images/4abe069238b6ebb1b047a80d0994ee98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BwMsfxH4A9QucfAoqiWCAA.png"/></div></div><figcaption class="lx ly et er es lz ma bd b be z dx">Customer data imported into MongoDB Compass</figcaption></figure><p id="f9ae" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><strong class="kc hi">第七步:</strong>将以下内容添加到<em class="mt">中。我们在步骤3中创建的env </em>文件。该文件将包含与应用程序相关的所有配置。</p><pre class="ix iy iz ja fd mj mf mk ml aw mm bi"><span id="41bd" class="mn jj hh mf b fi mo mp l mq mr">APPLICATION_ENV=development</span><span id="7b02" class="mn jj hh mf b fi mu mp l mq mr">APPLICATION_PORT=3000</span><span id="0fd3" class="mn jj hh mf b fi mu mp l mq mr">CUSTOMER_DB_URL=&lt;Your db connection string&gt;</span></pre><p id="d3db" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><strong class="kc hi">第8步:</strong>在<em class="mt"> config/config.js </em>文件中添加以下内容。该文件中的代码负责读取NodeJS加载的环境变量，并提供单一访问点。</p><pre class="ix iy iz ja fd mj mf mk ml aw mm bi"><span id="a042" class="mn jj hh mf b fi mo mp l mq mr">"use strict";</span><span id="aff7" class="mn jj hh mf b fi mu mp l mq mr">const APP = Object.freeze({</span><span id="208f" class="mn jj hh mf b fi mu mp l mq mr">PORT: process.env.APPLICATION_PORT,</span><span id="481f" class="mn jj hh mf b fi mu mp l mq mr">ENVIRONMENT: process.env.APPLICATION_ENV,</span><span id="d4ea" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="fc56" class="mn jj hh mf b fi mu mp l mq mr">const MONGODB = Object.freeze({</span><span id="e975" class="mn jj hh mf b fi mu mp l mq mr">CUSTOMER_DB_URL: process.env.CUSTOMER_DB_URL,</span><span id="523b" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="36ea" class="mn jj hh mf b fi mu mp l mq mr">module.exports = {</span><span id="f83f" class="mn jj hh mf b fi mu mp l mq mr">APP,</span><span id="7962" class="mn jj hh mf b fi mu mp l mq mr">MONGODB,</span><span id="5ff6" class="mn jj hh mf b fi mu mp l mq mr">};</span></pre><p id="74df" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><strong class="kc hi">第九步:</strong>在<em class="mt"> common/db.js </em>中添加如下与建立数据库连接相关的代码。</p><pre class="ix iy iz ja fd mj mf mk ml aw mm bi"><span id="3bf9" class="mn jj hh mf b fi mo mp l mq mr">"use strict";</span><span id="14c2" class="mn jj hh mf b fi mu mp l mq mr">const { MONGODB } = require("../config/config");</span><span id="8cf6" class="mn jj hh mf b fi mu mp l mq mr">const mongoose = require("mongoose");</span><span id="c36e" class="mn jj hh mf b fi mu mp l mq mr">module.exports = () =&gt; {</span><span id="033a" class="mn jj hh mf b fi mu mp l mq mr">const DB_OPTIONS = {</span><span id="6a60" class="mn jj hh mf b fi mu mp l mq mr">useNewUrlParser: true,</span><span id="d159" class="mn jj hh mf b fi mu mp l mq mr">useUnifiedTopology: true,</span><span id="bb64" class="mn jj hh mf b fi mu mp l mq mr">};</span><span id="a7cd" class="mn jj hh mf b fi mu mp l mq mr">mongoose.connect(MONGODB.CUSTOMER_DB_URL, DB_OPTIONS);</span><span id="8a18" class="mn jj hh mf b fi mu mp l mq mr">const db = mongoose.connection;</span><span id="1bb6" class="mn jj hh mf b fi mu mp l mq mr">db.on("error", (error) =&gt; {</span><span id="e89f" class="mn jj hh mf b fi mu mp l mq mr">console.log(`Connection to DB failed due to ${error}`);</span><span id="9ac8" class="mn jj hh mf b fi mu mp l mq mr">mongoose.disconnect();</span><span id="801e" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="65b5" class="mn jj hh mf b fi mu mp l mq mr">db.once("connected", () =&gt; {</span><span id="2f9a" class="mn jj hh mf b fi mu mp l mq mr">console.log(`DB was connected`);</span><span id="9d6b" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="6a35" class="mn jj hh mf b fi mu mp l mq mr">db.once("open", () =&gt; {</span><span id="b4f2" class="mn jj hh mf b fi mu mp l mq mr">console.log(`Connection to DB was opened`);</span><span id="3607" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="b243" class="mn jj hh mf b fi mu mp l mq mr">db.on("disconnected", () =&gt; {</span><span id="e8fb" class="mn jj hh mf b fi mu mp l mq mr">console.log(`Database was disconnected`);</span><span id="838c" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="36c3" class="mn jj hh mf b fi mu mp l mq mr">process.on("SIGINT", () =&gt; {</span><span id="91da" class="mn jj hh mf b fi mu mp l mq mr">db.close(() =&gt; {</span><span id="66c7" class="mn jj hh mf b fi mu mp l mq mr">console.log(`Connection was closed successfully`);</span><span id="5482" class="mn jj hh mf b fi mu mp l mq mr">process.exit();</span><span id="8e6f" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="0942" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="7faa" class="mn jj hh mf b fi mu mp l mq mr">};</span></pre><p id="71b2" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><strong class="kc hi">步骤10: </strong>在根级可用的<em class="mt"> server.js </em>文件中，添加以下内容来测试到数据库的连接，并在端口3000上运行express应用程序</p><pre class="ix iy iz ja fd mj mf mk ml aw mm bi"><span id="ad5c" class="mn jj hh mf b fi mo mp l mq mr">require("dotenv").config();</span><span id="fb0f" class="mn jj hh mf b fi mu mp l mq mr">const app = require("express")();</span><span id="f9aa" class="mn jj hh mf b fi mu mp l mq mr">const { APP } = require("./config/config");</span><span id="f591" class="mn jj hh mf b fi mu mp l mq mr">const connectDb = require("./common/db");</span><span id="18b5" class="mn jj hh mf b fi mu mp l mq mr">const customers = require("./routes/customer");</span><span id="fa48" class="mn jj hh mf b fi mu mp l mq mr">connectDb();</span><span id="bbc9" class="mn jj hh mf b fi mu mp l mq mr">app.use("/api", customers);</span><span id="393d" class="mn jj hh mf b fi mu mp l mq mr">app.listen(APP.PORT, () =&gt; {</span><span id="a753" class="mn jj hh mf b fi mu mp l mq mr">console.log(`The export to excel service is listening on port ${APP.PORT}`);</span><span id="3c36" class="mn jj hh mf b fi mu mp l mq mr">});</span></pre><p id="57dc" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><strong class="kc hi">步骤11: </strong>在根文件夹下的<em class="mt"> package.json </em>文件中添加启动命令。这里我们设置了<em class="mt"> nodemon </em>，以确保每当我们保存对js文件的更改时，应用程序都会被重新加载。您的package.json应该是这样的。</p><pre class="ix iy iz ja fd mj mf mk ml aw mm bi"><span id="3ce9" class="mn jj hh mf b fi mo mp l mq mr">{</span><span id="2f6d" class="mn jj hh mf b fi mu mp l mq mr">"name": "export-to-excel",</span><span id="99e9" class="mn jj hh mf b fi mu mp l mq mr">"version": "0.0.1",</span><span id="c759" class="mn jj hh mf b fi mu mp l mq mr">"description": "A service for exporting JSON to excel",</span><span id="a387" class="mn jj hh mf b fi mu mp l mq mr">"main": "server.js",</span><span id="528d" class="mn jj hh mf b fi mu mp l mq mr">"scripts": {</span><span id="c736" class="mn jj hh mf b fi mu mp l mq mr">"start": "nodemon server.js",</span><span id="527b" class="mn jj hh mf b fi mu mp l mq mr">"test": "echo \"Error: no test specified\" &amp;&amp; exit 1"</span><span id="ba97" class="mn jj hh mf b fi mu mp l mq mr">},</span><span id="7ed6" class="mn jj hh mf b fi mu mp l mq mr">"author": "Faizal Vasyaa",</span><span id="6b18" class="mn jj hh mf b fi mu mp l mq mr">"license": "ISC",</span><span id="7870" class="mn jj hh mf b fi mu mp l mq mr">"dependencies": {</span><span id="56e9" class="mn jj hh mf b fi mu mp l mq mr">"exceljs": "^4.2.0",</span><span id="f2ac" class="mn jj hh mf b fi mu mp l mq mr">"express": "^4.17.1",</span><span id="5b1d" class="mn jj hh mf b fi mu mp l mq mr">"http-status-codes": "^2.1.4",</span><span id="0d8b" class="mn jj hh mf b fi mu mp l mq mr">"mongoose": "^5.11.8"</span><span id="f232" class="mn jj hh mf b fi mu mp l mq mr">},</span><span id="9493" class="mn jj hh mf b fi mu mp l mq mr">"devDependencies": {</span><span id="06d9" class="mn jj hh mf b fi mu mp l mq mr">"dotenv": "^8.2.0",</span><span id="21a1" class="mn jj hh mf b fi mu mp l mq mr">"nodemon": "^2.0.6"</span><span id="b97d" class="mn jj hh mf b fi mu mp l mq mr">}</span><span id="9e23" class="mn jj hh mf b fi mu mp l mq mr">}</span></pre><h1 id="56b7" class="ji jj hh bd jk jl jm jn jo jp jq jr js in jt io ju iq jv ir jw it jx iu jy jz bi translated">路线和验证</h1><p id="4d59" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated"><strong class="kc hi">步骤1: </strong>让我们创建一个路由，用户将调用它来生成一个excel文件。在<em class="mt"> routes/customer.js </em>文件中添加以下内容。这里，我们添加了几个验证器来检查在查询参数中收到的余额和标题中用户名的可用性(记住，需要生成的报告需要查询参数和标题中的用户名来设置密码)</p><pre class="ix iy iz ja fd mj mf mk ml aw mm bi"><span id="1a39" class="mn jj hh mf b fi mo mp l mq mr">const customerRouter = require("express").Router();</span><span id="9eb9" class="mn jj hh mf b fi mu mp l mq mr">const customerController = require("../controllers/customer");</span><span id="72d3" class="mn jj hh mf b fi mu mp l mq mr">const {</span><span id="9d10" class="mn jj hh mf b fi mu mp l mq mr">balanceValidator,</span><span id="8b7a" class="mn jj hh mf b fi mu mp l mq mr">usernameValidator,</span><span id="ee2e" class="mn jj hh mf b fi mu mp l mq mr">} = require("../validators/customer");</span><span id="6d8c" class="mn jj hh mf b fi mu mp l mq mr">customerRouter.get(</span><span id="66ef" class="mn jj hh mf b fi mu mp l mq mr">"/customer/extractData",</span><span id="cac5" class="mn jj hh mf b fi mu mp l mq mr">balanceValidator,</span><span id="584e" class="mn jj hh mf b fi mu mp l mq mr">usernameValidator,</span><span id="24b0" class="mn jj hh mf b fi mu mp l mq mr">customerController.extractData</span><span id="eb6c" class="mn jj hh mf b fi mu mp l mq mr">);</span><span id="f29b" class="mn jj hh mf b fi mu mp l mq mr">module.exports = customerRouter;</span></pre><p id="ceaa" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><strong class="kc hi">步骤2: </strong>下一步是在<em class="mt"> validators/customer.js </em>文件中创建验证器。添加以下代码行来创建余额验证器和用户名验证器。</p><pre class="ix iy iz ja fd mj mf mk ml aw mm bi"><span id="4246" class="mn jj hh mf b fi mo mp l mq mr">"use strict";</span><span id="a7e3" class="mn jj hh mf b fi mu mp l mq mr">const { StatusCodes } = require("http-status-codes");</span><span id="d8a1" class="mn jj hh mf b fi mu mp l mq mr">const balanceValidator = (request, response, next) =&gt; {</span><span id="77c6" class="mn jj hh mf b fi mu mp l mq mr">if (!request.query.minBalance) {</span><span id="9317" class="mn jj hh mf b fi mu mp l mq mr">return response.status(StatusCodes.UNPROCESSABLE_ENTITY).json({</span><span id="3c29" class="mn jj hh mf b fi mu mp l mq mr">message: "Minimum balance is required to extract customer data",</span><span id="5957" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="a48b" class="mn jj hh mf b fi mu mp l mq mr">} else if (isNaN(request.query.minBalance)) {</span><span id="c078" class="mn jj hh mf b fi mu mp l mq mr">return response.status(StatusCodes.UNPROCESSABLE_ENTITY).json({</span><span id="03cb" class="mn jj hh mf b fi mu mp l mq mr">message:</span><span id="9cc5" class="mn jj hh mf b fi mu mp l mq mr">"Minimum balance must be a valid integer or floating point number to extract customer data",</span><span id="8205" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="ada5" class="mn jj hh mf b fi mu mp l mq mr">} else if (</span><span id="9db6" class="mn jj hh mf b fi mu mp l mq mr">parseFloat(request.query.minBalance) &gt;=</span><span id="57dd" class="mn jj hh mf b fi mu mp l mq mr">Number.MAX_SAFE_INTEGER - 1</span><span id="e2ff" class="mn jj hh mf b fi mu mp l mq mr">) {</span><span id="50ac" class="mn jj hh mf b fi mu mp l mq mr">return response.status(StatusCodes.UNPROCESSABLE_ENTITY).json({</span><span id="4ae3" class="mn jj hh mf b fi mu mp l mq mr">message: "Unsupported number to extract customer data",</span><span id="9ab8" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="8e6e" class="mn jj hh mf b fi mu mp l mq mr">}</span><span id="2d40" class="mn jj hh mf b fi mu mp l mq mr">next();</span><span id="7397" class="mn jj hh mf b fi mu mp l mq mr">};</span><span id="783b" class="mn jj hh mf b fi mu mp l mq mr">const usernameValidator = (request, response, next) =&gt; {</span><span id="0997" class="mn jj hh mf b fi mu mp l mq mr">const username = request.get("X-username");</span><span id="8d7e" class="mn jj hh mf b fi mu mp l mq mr">if (!username) {</span><span id="0ca6" class="mn jj hh mf b fi mu mp l mq mr">return response.status(StatusCodes.UNPROCESSABLE_ENTITY).json({</span><span id="3eb3" class="mn jj hh mf b fi mu mp l mq mr">message: "Username is required to extract customer data",</span><span id="7cae" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="0578" class="mn jj hh mf b fi mu mp l mq mr">}</span><span id="8f93" class="mn jj hh mf b fi mu mp l mq mr">next();</span><span id="c12e" class="mn jj hh mf b fi mu mp l mq mr">};</span><span id="862b" class="mn jj hh mf b fi mu mp l mq mr">module.exports = {</span><span id="0fd0" class="mn jj hh mf b fi mu mp l mq mr">balanceValidator,</span><span id="eec4" class="mn jj hh mf b fi mu mp l mq mr">usernameValidator,</span><span id="cbcc" class="mn jj hh mf b fi mu mp l mq mr">};</span></pre><p id="4ee3" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><strong class="kc hi">步骤3: </strong>现在我们已经验证了我们的请求，让我们创建控制器，该控制器将把minBalance和username移交给服务进行进一步处理。在<em class="mt">控制器/customer.js </em>文件中增加以下内容。</p><pre class="ix iy iz ja fd mj mf mk ml aw mm bi"><span id="a552" class="mn jj hh mf b fi mo mp l mq mr">"use strict";</span><span id="22b7" class="mn jj hh mf b fi mu mp l mq mr">const customerService = require("../services/customer");</span><span id="cd5c" class="mn jj hh mf b fi mu mp l mq mr">const extractData = async (request, response, next) =&gt; {</span><span id="d500" class="mn jj hh mf b fi mu mp l mq mr">try {</span><span id="c9da" class="mn jj hh mf b fi mu mp l mq mr">const username = request.get("X-username");</span><span id="75ac" class="mn jj hh mf b fi mu mp l mq mr">const workbook = await customerService.exportToExcel(</span><span id="874b" class="mn jj hh mf b fi mu mp l mq mr">parseFloat(request.query.minBalance),</span><span id="29ab" class="mn jj hh mf b fi mu mp l mq mr">request.get("X-username")</span><span id="8bde" class="mn jj hh mf b fi mu mp l mq mr">);</span><span id="9401" class="mn jj hh mf b fi mu mp l mq mr">response.set({</span><span id="37cf" class="mn jj hh mf b fi mu mp l mq mr">"Content-disposition": `attachment; filename=${username}.xlsx`,</span><span id="bc45" class="mn jj hh mf b fi mu mp l mq mr">"Content-Type":</span><span id="8d21" class="mn jj hh mf b fi mu mp l mq mr">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",</span><span id="bfdb" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="b424" class="mn jj hh mf b fi mu mp l mq mr">return workbook.xlsx.write(response).then(() =&gt; {</span><span id="d053" class="mn jj hh mf b fi mu mp l mq mr">response.status(200).end();</span><span id="f03d" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="147f" class="mn jj hh mf b fi mu mp l mq mr">} catch (err) {</span><span id="c502" class="mn jj hh mf b fi mu mp l mq mr">return response.status(500).json({</span><span id="7674" class="mn jj hh mf b fi mu mp l mq mr">message: `Internal server error: ${err.toString()}`,</span><span id="09e6" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="d16f" class="mn jj hh mf b fi mu mp l mq mr">}</span><span id="8ac5" class="mn jj hh mf b fi mu mp l mq mr">};</span><span id="b91d" class="mn jj hh mf b fi mu mp l mq mr">module.exports = { extractData };</span></pre><h1 id="898d" class="ji jj hh bd jk jl jm jn jo jp jq jr js in jt io ju iq jv ir jw it jx iu jy jz bi translated">准备好嚼肉了吗？</h1><p id="7eb2" class="pw-post-body-paragraph ka kb hh kc b kd ke ii kf kg kh il ki kj kk kl km kn ko kp kq kr ks kt ku kv ha bi translated"><strong class="kc hi">步骤1: </strong>这里是导出到excel服务，其职责是从控制器获取最小余额和用户名，查询数据库以获取余额大于最小余额的客户，创建此类客户的excel并将其发送回控制器。<strong class="kc hi"> </strong>首先在<em class="mt"> models/customer.js </em>中添加以下代码。</p><pre class="ix iy iz ja fd mj mf mk ml aw mm bi"><span id="1ec1" class="mn jj hh mf b fi mo mp l mq mr">"use strict";</span><span id="101a" class="mn jj hh mf b fi mu mp l mq mr">const mongoose = require("mongoose");</span><span id="be61" class="mn jj hh mf b fi mu mp l mq mr">const customerSchema = new mongoose.Schema(</span><span id="14d1" class="mn jj hh mf b fi mu mp l mq mr">{</span><span id="d2d2" class="mn jj hh mf b fi mu mp l mq mr">name: {</span><span id="8276" class="mn jj hh mf b fi mu mp l mq mr">type: String,</span><span id="6781" class="mn jj hh mf b fi mu mp l mq mr">},</span><span id="36c1" class="mn jj hh mf b fi mu mp l mq mr">balance: {</span><span id="895e" class="mn jj hh mf b fi mu mp l mq mr">type: Number,</span><span id="9680" class="mn jj hh mf b fi mu mp l mq mr">},</span><span id="2b86" class="mn jj hh mf b fi mu mp l mq mr">gender: {</span><span id="5843" class="mn jj hh mf b fi mu mp l mq mr">type: String,</span><span id="8db1" class="mn jj hh mf b fi mu mp l mq mr">enum: ["male", "female"],</span><span id="b6f5" class="mn jj hh mf b fi mu mp l mq mr">},</span><span id="d317" class="mn jj hh mf b fi mu mp l mq mr">email: {</span><span id="812d" class="mn jj hh mf b fi mu mp l mq mr">type: String,</span><span id="aa48" class="mn jj hh mf b fi mu mp l mq mr">},</span><span id="cd94" class="mn jj hh mf b fi mu mp l mq mr">age: {</span><span id="c504" class="mn jj hh mf b fi mu mp l mq mr">type: Number,</span><span id="bf44" class="mn jj hh mf b fi mu mp l mq mr">},</span><span id="b8f0" class="mn jj hh mf b fi mu mp l mq mr">},</span><span id="ef68" class="mn jj hh mf b fi mu mp l mq mr">{</span><span id="4aaa" class="mn jj hh mf b fi mu mp l mq mr">collection: "customers",</span><span id="59fc" class="mn jj hh mf b fi mu mp l mq mr">}</span><span id="8c94" class="mn jj hh mf b fi mu mp l mq mr">);</span><span id="79df" class="mn jj hh mf b fi mu mp l mq mr">module.exports = mongoose.model("Customer", customerSchema);</span></pre><p id="2265" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><strong class="kc hi">步骤2: </strong>接下来，我们将创建一个简单的服务，它将获取余额高于最小余额的客户数据，并将其返回给控制器。在<em class="mt"> services/customer.js </em>中添加以下代码</p><pre class="ix iy iz ja fd mj mf mk ml aw mm bi"><span id="df5e" class="mn jj hh mf b fi mo mp l mq mr">"use strict";</span><span id="8a44" class="mn jj hh mf b fi mu mp l mq mr">const Customer = require("../models/customer");</span><span id="f652" class="mn jj hh mf b fi mu mp l mq mr">const exportToExcelUtility = require("../common/export-to-excel");</span><span id="d209" class="mn jj hh mf b fi mu mp l mq mr">const customerProjection = {</span><span id="df55" class="mn jj hh mf b fi mu mp l mq mr">_id: 0,</span><span id="ec42" class="mn jj hh mf b fi mu mp l mq mr">__v: 0,</span><span id="2c7c" class="mn jj hh mf b fi mu mp l mq mr">};</span><span id="bb78" class="mn jj hh mf b fi mu mp l mq mr">const exportToExcel = async (minBalance, username) =&gt; {</span><span id="1a4c" class="mn jj hh mf b fi mu mp l mq mr">try {</span><span id="194f" class="mn jj hh mf b fi mu mp l mq mr">const customers = await Customer.find({</span><span id="0582" class="mn jj hh mf b fi mu mp l mq mr">balance: { $gte: minBalance },</span><span id="304e" class="mn jj hh mf b fi mu mp l mq mr">}).select(customerProjection);</span><span id="dba3" class="mn jj hh mf b fi mu mp l mq mr">const rows = transformRows(customers);</span><span id="c5b2" class="mn jj hh mf b fi mu mp l mq mr">const columns = [</span><span id="c601" class="mn jj hh mf b fi mu mp l mq mr">{ name: "Name", totalsRowLabel: "Total:", filterButton: true },</span><span id="5a92" class="mn jj hh mf b fi mu mp l mq mr">{ name: "Gender", filterButton: true },</span><span id="569c" class="mn jj hh mf b fi mu mp l mq mr">{ name: "Age", filterButton: true },</span><span id="0079" class="mn jj hh mf b fi mu mp l mq mr">{ name: "Email", filterButton: false },</span><span id="f1b4" class="mn jj hh mf b fi mu mp l mq mr">{</span><span id="3957" class="mn jj hh mf b fi mu mp l mq mr">name: "Balance",</span><span id="c8f4" class="mn jj hh mf b fi mu mp l mq mr">totalsRowFunction: "custom",</span><span id="05a5" class="mn jj hh mf b fi mu mp l mq mr">totalsRowFormula: `SUBTOTAL(109,E2:E${rows.length + 1})`,</span><span id="6d3f" class="mn jj hh mf b fi mu mp l mq mr">filterButton: false,</span><span id="617f" class="mn jj hh mf b fi mu mp l mq mr">},</span><span id="9e78" class="mn jj hh mf b fi mu mp l mq mr">];</span><span id="c9d8" class="mn jj hh mf b fi mu mp l mq mr">return exportToExcelUtility(rows, username, "Customer", columns);</span><span id="2b3f" class="mn jj hh mf b fi mu mp l mq mr">} catch (err) {</span><span id="33d9" class="mn jj hh mf b fi mu mp l mq mr">throw err;</span><span id="02ac" class="mn jj hh mf b fi mu mp l mq mr">}</span><span id="a4a3" class="mn jj hh mf b fi mu mp l mq mr">};</span><span id="e8bd" class="mn jj hh mf b fi mu mp l mq mr">const transformRows = (customers) =&gt; {</span><span id="0607" class="mn jj hh mf b fi mu mp l mq mr">const transformedRows = customers.map((row) =&gt; {</span><span id="f992" class="mn jj hh mf b fi mu mp l mq mr">let transformedRow = [];</span><span id="13bb" class="mn jj hh mf b fi mu mp l mq mr">transformedRow.push(row._doc["name"]);</span><span id="f6bf" class="mn jj hh mf b fi mu mp l mq mr">transformedRow.push(row._doc["gender"]);</span><span id="37fe" class="mn jj hh mf b fi mu mp l mq mr">transformedRow.push(row._doc["age"]);</span><span id="2fbd" class="mn jj hh mf b fi mu mp l mq mr">transformedRow.push(row._doc["email"]);</span><span id="adf4" class="mn jj hh mf b fi mu mp l mq mr">transformedRow.push(row._doc["balance"]);</span><span id="fb0e" class="mn jj hh mf b fi mu mp l mq mr">return transformedRow;</span><span id="f7a9" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="50b0" class="mn jj hh mf b fi mu mp l mq mr">return transformedRows;</span><span id="53ac" class="mn jj hh mf b fi mu mp l mq mr">};</span><span id="c651" class="mn jj hh mf b fi mu mp l mq mr">module.exports = { exportToExcel };</span></pre><p id="2e9b" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated"><strong class="kc hi">第三步:<em class="mt">常用/导出到excel.js </em>中的</strong>并添加以下内容。</p><pre class="ix iy iz ja fd mj mf mk ml aw mm bi"><span id="8a34" class="mn jj hh mf b fi mo mp l mq mr">"use strict";</span><span id="b026" class="mn jj hh mf b fi mu mp l mq mr">const excel = require("exceljs");</span><span id="d168" class="mn jj hh mf b fi mu mp l mq mr">const exportToExcelUtility = async (rows, username, sheetName, columns) =&gt; {</span><span id="52b2" class="mn jj hh mf b fi mu mp l mq mr">// Creating a workbook</span><span id="affa" class="mn jj hh mf b fi mu mp l mq mr">let workbook = new excel.Workbook();</span><span id="4e31" class="mn jj hh mf b fi mu mp l mq mr">workbook.creator = username;</span><span id="eb3a" class="mn jj hh mf b fi mu mp l mq mr">workbook.lastModifiedBy = username;</span><span id="aaf4" class="mn jj hh mf b fi mu mp l mq mr">workbook.created = new Date();</span><span id="b21c" class="mn jj hh mf b fi mu mp l mq mr">workbook.modified = new Date();</span><span id="d594" class="mn jj hh mf b fi mu mp l mq mr">// Adding worksheet to workbook</span><span id="9b30" class="mn jj hh mf b fi mu mp l mq mr">let worksheet = workbook.addWorksheet(sheetName, {</span><span id="5e00" class="mn jj hh mf b fi mu mp l mq mr">views: [{ state: "frozen", xSplit: 0, ySplit: 1 }],</span><span id="6095" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="203c" class="mn jj hh mf b fi mu mp l mq mr">worksheet.state = "visible";</span><span id="da0f" class="mn jj hh mf b fi mu mp l mq mr">worksheet.properties.defaultColWidth = 30;</span><span id="ae31" class="mn jj hh mf b fi mu mp l mq mr">// Adding table to worksheet</span><span id="1ae3" class="mn jj hh mf b fi mu mp l mq mr">worksheet.addTable({</span><span id="2c35" class="mn jj hh mf b fi mu mp l mq mr">name: sheetName,</span><span id="99c5" class="mn jj hh mf b fi mu mp l mq mr">ref: "A1",</span><span id="c2a7" class="mn jj hh mf b fi mu mp l mq mr">headerRow: true,</span><span id="a938" class="mn jj hh mf b fi mu mp l mq mr">totalsRow: true,</span><span id="1f8a" class="mn jj hh mf b fi mu mp l mq mr">style: {</span><span id="86a5" class="mn jj hh mf b fi mu mp l mq mr">theme: "TableStyleLight1",</span><span id="86f5" class="mn jj hh mf b fi mu mp l mq mr">showFirstColumn: true,</span><span id="df77" class="mn jj hh mf b fi mu mp l mq mr">showRowStripes: true,</span><span id="28cd" class="mn jj hh mf b fi mu mp l mq mr">},</span><span id="ccb9" class="mn jj hh mf b fi mu mp l mq mr">columns: columns,</span><span id="38b8" class="mn jj hh mf b fi mu mp l mq mr">rows: [...rows],</span><span id="0c06" class="mn jj hh mf b fi mu mp l mq mr">});</span><span id="3a26" class="mn jj hh mf b fi mu mp l mq mr">// Adding password to worksheet to protect it from editing</span><span id="6014" class="mn jj hh mf b fi mu mp l mq mr">await worksheet.protect(username);</span><span id="9784" class="mn jj hh mf b fi mu mp l mq mr">return workbook;</span><span id="a4e2" class="mn jj hh mf b fi mu mp l mq mr">};</span><span id="a2b0" class="mn jj hh mf b fi mu mp l mq mr">module.exports = exportToExcelUtility;</span></pre><p id="cb57" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated">一旦我们完成了所有这些步骤，运行<code class="du mc md me mf b">npm start</code>应该会在下面的命令提示符下显示输出</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mv"><img src="../Images/fbcbdbe667e83eca784fd7fd598afd44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f8n4_NRFEB2jyF9AchE_Rw.png"/></div></div></figure><h2 id="f521" class="mn jj hh bd jk mw mx my jo mz na nb js kj nc nd ju kn ne nf jw kr ng nh jy ni bi translated">如何测试</h2><ul class=""><li id="9204" class="lb lc hh kc b kd ke kg kh kj nj kn nk kr nl kv lg lh li lj bi translated">打开postman，输入网址<a class="ae mb" href="http://localhost:3000/api/customer/extractData?minBalance=1000" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/API/customer/extract data？minBalance=1000 </a> 0，点击发送和下载按钮，如下所示。</li></ul><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es nm"><img src="../Images/cd1a808d5cf871d0e5dfddd6e4838878.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xyY0GLneF4EZKrcXrp1ZGg.png"/></div></div></figure><ul class=""><li id="4237" class="lb lc hh kc b kd kw kg kx kj ld kn le kr lf kv lg lh li lj bi translated">应该会出现一个提示，要求您将文件保存在给定的位置。</li><li id="b8bd" class="lb lc hh kc b kd lk kg ll kj lm kn ln kr lo kv lg lh li lj bi translated">一次，用MS Excel打开保存。</li></ul><h2 id="1da3" class="mn jj hh bd jk mw mx my jo mz na nb js kj nc nd ju kn ne nf jw kr ng nh jy ni bi translated">已知问题:</h2><ul class=""><li id="4040" class="lb lc hh kc b kd ke kg kh kj nj kn nk kr nl kv lg lh li lj bi translated">如果你需要支持Libre office，这个库不适合你。此库生成的文件在MS Excel和Libre office中没有相同的行为。</li><li id="c8d6" class="lb lc hh kc b kd lk kg ll kj lm kn ln kr lo kv lg lh li lj bi translated">在某些版本的MS Excel中，打开文件时可能会收到警告。你可以忽略它们，继续前进。</li></ul><p id="020d" class="pw-post-body-paragraph ka kb hh kc b kd kw ii kf kg kx il ki kj ky kl km kn kz kp kq kr la kt ku kv ha bi translated">希望这对你来说是个有趣的实验。如果您在运行上述演示时遇到问题，请随时通过评论或<a class="ae mb" href="https://www.linkedin.com/in/faizalvasaya/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系我们:)</p></div></div>    
</body>
</html>