<html>
<head>
<title>Oracle dNFS with Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Docker的Oracle dNFS</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/oracle-dnfs-with-docker-8a3e35c0b558?source=collection_archive---------0-----------------------#2018-11-26">https://medium.com/oracledevs/oracle-dnfs-with-docker-8a3e35c0b558?source=collection_archive---------0-----------------------#2018-11-26</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="9532" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">众所周知，Docker容器拥有短暂的存储空间，这意味着，一旦你删除了容器，文件系统上的任何更改都将被丢弃。从<em class="jc"> RDBMS </em>的角度来看，这意味着存储在您的表中的任何数据都将丢失，为了使用Docker上的Oracle数据库，您的<em class="jc">数据文件</em>所在的文件系统必须连接到外部存储。</p><p id="6bdf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当使用Docker Swarm时，这种外部存储通常放置在<em class="jc"> NFS </em>服务器上。Oracle提供了一个与您的<em class="jc"> NFS </em>存储对话的本机客户端，主要提供对数据的直接路径访问，这里有两篇在<a class="ae jd" href="https://ronekins.wordpress.com/" rel="noopener ugc nofollow" target="_blank"> Ron的博客</a>上的精彩帖子，介绍了以下信息:</p><ul class=""><li id="8002" class="je jf hh ig b ih ii il im ip jg it jh ix ji jb jj jk jl jm bi translated"><a class="ae jd" href="https://ronekins.wordpress.com/2018/01/02/using-oracle-dnfs-multi-path/" rel="noopener ugc nofollow" target="_blank">使用Oracle dNFS多路径</a></li><li id="fff8" class="je jf hh ig b ih jn il jo ip jp it jq ix jr jb jj jk jl jm bi translated"><a class="ae jd" href="https://ronekins.wordpress.com/2018/01/03/oracle-dnfs-throughput-testing/" rel="noopener ugc nofollow" target="_blank"> Oracle dNFS吞吐量测试</a></li></ul><p id="21ad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用<strong class="ig hi"> <em class="jc"> dNFS </em> </strong>的主要好处是对您的<em class="jc">数据文件的多路径访问</em>提供了更多的吞吐量和容错访问，下面的图片来自Ron的博客，展示了这种架构:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/808d88288826318169934f67f8ae7c0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ODQy9LzhfecNuVzZ"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx">Multi-path access using dNFS Oracle driver</figcaption></figure><p id="4862" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这篇文章展示了如何通过扩展<a class="ae jd" href="https://github.com/oracle/docker-images/tree/master/OracleDatabase/SingleInstance" rel="noopener ugc nofollow" target="_blank"> 18.3.0 EE映像</a>或<a class="ae jd" href="https://github.com/oracle/docker-images/pull/1020" rel="noopener ugc nofollow" target="_blank">待定</a> <a class="ae jd" href="https://github.com/marcelo-ochoa/docker-images/tree/master/OracleDatabase/SingleInstance/dockerfiles/18.4.0" rel="noopener ugc nofollow" target="_blank"> 18.4.0 XE映像</a>来使用带有<strong class="ig hi"> <em class="jc"> dNFS </em> </strong>的Oracle Docker映像。首先我们简单的<strong class="ig hi"><em class="jc">Docker file . NFS</em></strong>用于启用官方Oracle Docker镜像的<strong class="ig hi"> <em class="jc"> dNFS </em> </strong>驱动程序，18.3.0 EE:</p><pre class="jt ju jv jw fd ki kj kk kl aw km bi"><span id="8508" class="kn ko hh kj b fi kp kq l kr ks"># Pull base image<br/># ---------------<br/>FROM oracle/database:<strong class="kj hi">18.3.0-ee</strong></span><span id="2094" class="kn ko hh kj b fi kt kq l kr ks"># Maintainer<br/># ----------<br/>MAINTAINER Marcelo ochoa &lt;<a class="ae jd" href="mailto:marcelo.ochoa@gmail.com" rel="noopener ugc nofollow" target="_blank">marcelo.ochoa@gmail.com</a>&gt;</span><span id="39c9" class="kn ko hh kj b fi kt kq l kr ks">RUN cd $ORACLE_HOME/rdbms/lib &amp;&amp; make -f ins_rdbms.mk dnfs_on</span></pre><p id="10ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">或18.4.0 XE:</p><pre class="jt ju jv jw fd ki kj kk kl aw km bi"><span id="6ac6" class="kn ko hh kj b fi kp kq l kr ks"># Pull base image<br/># ---------------<br/>FROM oracle/database:<strong class="kj hi">18.4.0-xe</strong></span><span id="adf6" class="kn ko hh kj b fi kt kq l kr ks"># Maintainer<br/># ----------<br/>MAINTAINER Marcelo ochoa &lt;<a class="ae jd" href="mailto:marcelo.ochoa@gmail.com" rel="noopener ugc nofollow" target="_blank">marcelo.ochoa@gmail.com</a>&gt;</span><span id="f9f6" class="kn ko hh kj b fi kt kq l kr ks">RUN cd $ORACLE_HOME/rdbms/lib &amp;&amp; make -f ins_rdbms.mk dnfs_on</span></pre><p id="4c7e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要构建我们新的<strong class="ig hi"> <em class="jc"> dNFS </em> </strong>启用映像，只需运行EE版本:</p><pre class="jt ju jv jw fd ki kj kk kl aw km bi"><span id="020d" class="kn ko hh kj b fi kp kq l kr ks">$ docker build -t "oracle/database:18.3.0-ee-nfs" -f <strong class="kj hi">Dockerfile.nfs</strong> .</span></pre><p id="c0a3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">XE版本:</p><pre class="jt ju jv jw fd ki kj kk kl aw km bi"><span id="85b9" class="kn ko hh kj b fi kp kq l kr ks">$ docker build -t "oracle/database:18.4.0-xe-nfs" -f <strong class="kj hi">Dockerfile.nfs</strong> .</span></pre><p id="c22f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦你准备好了你的<em class="jc"> RDBMS </em> Docker镜像，一个如下的Docker Swarm栈样本可以用来启动Oracle使用<strong class="ig hi"> <em class="jc"> dNFS </em> </strong>本地驱动:</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="ku kv l"/></div></figure><p id="76d2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">关于上述docker-compose堆栈定义的一些注释:</p><ul class=""><li id="bb92" class="je jf hh ig b ih ii il im ip jg it jh ix ji jb jj jk jl jm bi translated">db_data卷被定义为外部<em class="jc"> NFS </em>支持的存储(我的一个<em class="jc"> NAS </em> IP是10.1.253.110，带有Oracle推荐的<em class="jc"> NFS </em>挂载选项)</li><li id="408f" class="je jf hh ig b ih jn il jo ip jp it jq ix jr jb jj jk jl jm bi translated">test_oranfstab_xe是一个外部配置，包括到我的NAS的多路径定义，下面是如何使用命令行创建此配置的示例:</li></ul><pre class="jt ju jv jw fd ki kj kk kl aw km bi"><span id="4fc1" class="kn ko hh kj b fi kp kq l kr ks">$ echo "server: NAS-DTICs<br/>&gt; path: <strong class="kj hi">10.1.253.110</strong><br/>&gt; path: <strong class="kj hi">10.1.1.241<br/></strong>&gt; nfs_version: nfsv4<br/>&gt; export: <strong class="kj hi">/dbdata/xe-18c</strong>  mount: <strong class="kj hi">/opt/oracle/oradata</strong><br/>&gt; " | docker config create <strong class="kj hi">test_oranfstab_xe</strong> -<br/>fbpuy0pjjx2t6ssan6almtjn5<br/>$ docker config ls<br/>ID                          NAME                CREATED             UPDATED<br/>fbpuy0pjjx2t6ssan6almtjn5   <strong class="kj hi">test_oranfstab_xe</strong>   17 seconds ago      17 seconds ago</span></pre><p id="0c82" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，在上面的配置定义中，我们向NAS存储(10.1.253.110和10.1.1.241)添加了多路径访问，导出和装载参数必须等于<em class="jc"> docker-compose.yml </em>定义。部署我们的堆栈，包括:</p><pre class="jt ju jv jw fd ki kj kk kl aw km bi"><span id="c276" class="kn ko hh kj b fi kp kq l kr ks">$ docker stack deploy -c docker-compose.yml test</span></pre><p id="3648" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将导致<em class="jc"> RDBMS </em> XE在几分钟后启动并运行(等待您的<em class="jc"> RDBMS </em>创建它们的<em class="jc">数据文件</em>)，如果您的<em class="jc"> NAS </em>不够快并且Docker <em class="jc"> healthcheck </em>文件杀死了您的堆栈，请添加此<em class="jc"> healthcheck </em>定义以避免<a class="ae jd" href="https://github.com/oracle/docker-images/issues/1060" rel="noopener ugc nofollow" target="_blank">问题</a>:</p><pre class="jt ju jv jw fd ki kj kk kl aw km bi"><span id="ced3" class="kn ko hh kj b fi kp kq l kr ks">    healthcheck:<br/>      test: exit 0<br/>      interval: 60s<br/>      timeout: 3s</span></pre><p id="257e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，为了查看运行中的<strong class="ig hi"> <em class="jc"> dNFS </em> </strong>多路径，让我们尝试通过连接到根<em class="jc"> CDB </em>并以<em class="jc"> sysdba </em>身份运行<em class="jc"> SQLPlus </em>来运行IO校准测试:</p><pre class="jt ju jv jw fd ki kj kk kl aw km bi"><span id="c292" class="kn ko hh kj b fi kp kq l kr ks">set long 10000 lines 140 pages 50 timing on echo on<br/>set serveroutput on size 1000000</span><span id="d3f2" class="kn ko hh kj b fi kt kq l kr ks">declare<br/>     l_latency   integer;<br/>     l_iops      integer;<br/>     l_mbps      integer;<br/> begin<br/>    dbms_resource_manager.calibrate_io (<br/>         1, /* # of disks */<br/>         20, /* max latency */<br/>         l_iops, /* I/O Ops/sec */<br/>         l_mbps, /* MBytes/sec */<br/>         l_latency /* actual latency */<br/>     );<br/>     dbms_output.put_line ('I/O Ops/sec = '  || l_iops);<br/>     dbms_output.put_line ('Actual Latency = '  || l_latency);<br/>     dbms_output.put_line('MB/sec = '  || l_mbps);<br/>end;<br/>/</span></pre><p id="2732" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在IO校准过程中，我们看到NAS资源监控类似于:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es kw"><img src="../Images/1dfad45ee6264cdeef495ce88de28028.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lnfu_IHvo6dZYL4S"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx">NAS resource monitoring with multi-path dNFS enabled</figcaption></figure><p id="a8f0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这意味着使用了两个网络接口，我们获得了大约86mb的吞吐量(请注意，我们有一个1gb的互连交换机)。此外，通过查询<em class="jc">v＄iostat _ file</em>系统视图，我们看到<em class="jc">数据文件</em>具有:</p><blockquote class="kx ky kz"><p id="8d49" class="ie if jc ig b ih ii ij ik il im in io la iq ir is lb iu iv iw lc iy iz ja jb ha bi translated">ASYNC _ IO:ASYNC _ ON<br/>访问方法:DNFS_LIB</p></blockquote><p id="d83c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果不使用<strong class="ig hi"><em class="jc">Oracle/database:18 . 4 . 0-xe-NFS</em></strong>Docker映像，我们将<em class="jc"> docker-compose.yml </em>更改为<strong class="ig hi"><em class="jc">Oracle/database:18 . 4 . 0-xe</em></strong>映像，则IO校准测试期间的网络利用率为:</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es ld"><img src="../Images/eb2640f00f1f3f11feb7984f1492c7ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KV2zYlVgrYDZhFF2"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx">NAS resource monitoring without multi-path dNFS enabled</figcaption></figure><p id="7500" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">仅使用一个接口来访问我们的数据，导致IO能力较慢且没有异步IO:</p><blockquote class="kx ky kz"><p id="0f53" class="ie if jc ig b ih ii ij ik il im in io la iq ir is lb iu iv iw lc iy iz ja jb ha bi translated">ASYNC _ IO:ASYNC _ OFF<br/>访问方法:OS_LIB</p></blockquote></div></div>    
</body>
</html>