<html>
<head>
<title>Centralised Logs and Alarms from Multiple AWS Accounts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">来自多个AWS帐户的集中日志和警报</h1>
<blockquote>原文：<a href="https://medium.com/version-1/centralised-logs-and-alarms-from-multiple-aws-accounts-e8ef02750340?source=collection_archive---------2-----------------------#2022-07-11">https://medium.com/version-1/centralised-logs-and-alarms-from-multiple-aws-accounts-e8ef02750340?source=collection_archive---------2-----------------------#2022-07-11</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="fedc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您有多个AWS帐户，并且它们都由同一个团队管理，集中日志和警报可以提高操作效率。它还可以通过减少需要访问工作负载帐户的人数来提高安全性。</p><p id="310a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通常情况下，有不同的方法来解决这个问题。AWS提供了一个<a class="ae jc" href="https://aws.amazon.com/solutions/implementations/centralized-logging/" rel="noopener ugc nofollow" target="_blank">中央日志参考架构</a>。如果这符合你的要求，这是最好的起点；它是经过深思熟虑的，附带了实现指南、成本估算和源代码。它将来自源帐户的日志流式传输到Amazon OpenSearch，在那里可以使用Kibana浏览这些日志。</p><p id="4527" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这篇文章描述了一种不同的方法，它也允许集中报警。在复杂的环境中，很容易失去对分布在许多帐户中的警报的跟踪。警报的扩散会导致:</p><ul class=""><li id="9d7d" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">浪费时间处理假阳性警报，</li><li id="c336" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">在噪音中丢失的真实事件的延迟解决，以及</li><li id="bda5" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">跨源帐户的不一致警报。</li></ul><h1 id="cfac" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">解决方案概述</strong></h1><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es kp"><img src="../Images/9eb35e41e3151718619704b43248adad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UexOhMC2wKziDSsLkDn5_Q.png"/></div></div></figure><p id="e257" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该解决方案使来自多个源帐户的日志、事件和指标可供单个中心帐户使用。然后这些可以用来触发警报或通过SNS或EventBridge与第三方系统集成。</p><ul class=""><li id="de63" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">日志通过Kinesis数据流传输，被接收到CloudWatch中，并且可以成为中央帐户中指标过滤器的主题</li><li id="e6fc" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">使用跨账户交付来推送事件(<a class="ae jc" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/CloudWatchEvents-CrossAccountEventDelivery.html" rel="noopener ugc nofollow" target="_blank">在AWS账户之间发送和接收事件——亚马逊云观察事件</a>)</li><li id="97a4" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">指标保留在源账户中，但使用跨账户跨区域指标(跨账户跨区域CloudWatch控制台-Amazon cloud watch)对中央账户可见。然后，它们可以内置到仪表板中，并触发中央帐户中的警报。</li></ul><h1 id="6091" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">日志</strong></h1><p id="896d" class="pw-post-body-paragraph ie if hh ig b ih lb ij ik il lc in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">在每个源帐户中，为每个日志组配置一个订阅筛选器。这些选项允许您指定日志的目标，以及控制将哪些日志发送到中心帐户的过滤模式。参见:<a class="ae jc" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Cross-Account-Log_Subscription-New.html" rel="noopener ugc nofollow" target="_blank">建立新的跨账户订阅—亚马逊云观察日志</a>。可以选择过滤掉较低的日志级别以降低成本，例如，跟踪、调试和可能的信息，这取决于如何使用中央存储库。</p><p id="148f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注意:每个日志组最多有两个订阅过滤器。</strong></p><p id="34e5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">日志被发送到Kinesis数据流，并向前发送到Lambda函数。Lambda上下文包含源日志组和日志流名称，这可以派生出所需的目标流和日志组。如果目标流和组不存在，可以创建它们，并且写入其中的消息和时间戳保持不变。</p><p id="c99f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了不丢失对日志来自哪个源帐户的跟踪，我们可以用源帐户ID预先确定目标日志组的名称，允许在中心帐户中轻松识别日志的来源。</p><p id="e285" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果中央日志仅用于警报，可以在中央帐户中设置一个较短的保留期，以避免重复数据和产生不必要的成本。</p><p id="84f2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过构建度量过滤器，可以从日志中间接触发警报。</p><h2 id="0035" class="lg js hh bd jt lh li lj jx lk ll lm kb ip ln lo kf it lp lq kj ix lr ls kn lt bi translated"><strong class="ak">日志成本</strong></h2><p id="d403" class="pw-post-body-paragraph ie if hh ig b ih lb ij ik il lc in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">在此解决方案中集中日志的主要成本来自CloudWatch，其数据接收费用为每GB 0.57美元，每天存储费用为每GB 0.03美元。对于较大的用例，这可能会很快增加，并且可能会超过其他成本的总和。订阅过滤器不收费。数据流按每分片小时0.02美元和每百万PUT单位0.02美元计费。Lambda按毫秒计费，总成本可能与数据流在同一数量级。</p><p id="fdc1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">可以通过在订阅过滤器中选择性地过滤日志来降低成本，例如删除不应该触发警报的信息日志。</p><p id="2509" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">【2022年6月欧盟-西方-1的成本。</p><h1 id="0185" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">指标</strong></h1><p id="6fd8" class="pw-post-body-paragraph ie if hh ig b ih lb ij ik il lc in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">指标不会从源帐户移动，而是从中心帐户提供访问。见<a class="ae jc" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Cross-Account-Cross-Region.html" rel="noopener ugc nofollow" target="_blank">跨账号跨地域CloudWatch控制台——亚马逊CloudWatch </a>。</p><p id="98d6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后，可以根据源帐户的指标触发中央警报。</p><p id="588e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您使用CloudFormation部署警报，请注意CloudFormation的<a class="ae jc" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudwatch-alarm-metric.html" rel="noopener ugc nofollow" target="_blank">指标</a>属性不包括帐户信息，但是<a class="ae jc" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudwatch-alarm-metricdataquery.html" rel="noopener ugc nofollow" target="_blank">指标数据查询</a>允许AccountId参数。交叉账户指标相对较新，因此更新指标属性有望出现在AWS路线图中。</p><p id="8b31" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因为没有移动任何东西，所以没有额外的费用。</p><h1 id="a053" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><strong class="ak">事件</strong></h1><p id="5ca4" class="pw-post-body-paragraph ie if hh ig b ih lb ij ik il lc in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">可以在账户的事件总线之间发送事件，参见:<a class="ae jc" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/CloudWatchEvents-CrossAccountEventDelivery.html" rel="noopener ugc nofollow" target="_blank">AWS账户之间发送和接收事件—亚马逊CloudWatch事件</a>。它们不直接触发警报，但如果需要，可以使用EventBridge或SNS来触发通知或其他操作。</p><h2 id="8a85" class="lg js hh bd jt lh li lj jx lk ll lm kb ip ln lo kf it lp lq kj ix lr ls kn lt bi translated">活动成本</h2><p id="df55" class="pw-post-body-paragraph ie if hh ig b ih lb ij ik il lc in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated"><a class="ae jc" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/CloudWatchEvents-CrossAccountEventDelivery.html" rel="noopener ugc nofollow" target="_blank"> AWS用户指南</a>说:</p><blockquote class="lv lw lx"><p id="9a89" class="ie if lu ig b ih ii ij ik il im in io ly iq ir is lz iu iv iw ma iy iz ja jb ha bi translated">从一个帐户发送到另一个帐户的事件作为自定义事件记入发送帐户。收款账户不收费。更多信息请见<a class="ae jc" href="https://aws.amazon.com/cloudwatch/pricing/" rel="noopener ugc nofollow" target="_blank">亚马逊云手表定价</a>。</p></blockquote><p id="3a20" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">定制活动的费用为每百万场活动1.00美元。</p><figure class="kq kr ks kt fd ku er es paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="er es mb"><img src="../Images/d37e253e160526de4c46092126091032.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YjrWrx4ANrIbfeza_meupQ.jpeg"/></div></div></figure><p id="0dc2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">关于作者:<br/> </strong> Ed Eastwood是这里版本1的AWS架构师。</p></div></div>    
</body>
</html>