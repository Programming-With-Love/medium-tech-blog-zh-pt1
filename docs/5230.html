<html>
<head>
<title>Improved Listagg on Overflooooow: 12 Things Developers Will Love About Oracle Database 12c Release 2 Part 4</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">改进的Listagg on Overflooooow:开发人员会喜欢的关于Oracle Database 12c第2版第4部分的12件事</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/improved-listagg-on-overflooooow-12-things-developers-will-love-about-oracle-database-12c-release-f15823474bea?source=collection_archive---------3-----------------------#2016-11-10">https://medium.com/oracledevs/improved-listagg-on-overflooooow-12-things-developers-will-love-about-oracle-database-12c-release-f15823474bea?source=collection_archive---------3-----------------------#2016-11-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="a242" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们已经看到了<a class="ae jc" rel="noopener" href="/oracledevs/loooooooooooooooong-names-12-things-developers-will-love-about-oracle-database-12c-release-2-part-b5f6e79698">更长的对象名</a>如何导致<a class="ae jc" rel="noopener" href="/oracledevs/pl-sql-constants-for-data-type-lengths-12-things-developers-will-love-about-oracle-database-12c-cb5f4d7c2d06">变量声明</a>的问题。但这也可能带来更微妙的问题。例如，下面的查询为模式中的每个表返回一个逗号分隔的索引列表:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="f851" class="jm jn hh ji b fi jo jp l jq jr">select table_name, <br/>       listagg( index_name, ',' ) <br/>         within group ( order by index_name ) inds <br/>from   user_indexes <br/>group  by table_name;</span></pre><p id="69de" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这一切都很好。但是这有一个潜在的问题。<a class="ae jc" href="http://docs.oracle.com/database/121/SQLRF/functions101.htm" rel="noopener ugc nofollow" target="_blank"> Listagg </a>()返回一个varchar2。这被限制为4000字节(如果您使用的是<a class="ae jc" href="https://oracle-base.com/articles/12c/extended-data-types-12cR1" rel="noopener ugc nofollow" target="_blank">扩展数据类型</a>，则为32767字节)。</p><p id="cc63" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所以在12.1和11.2中，在遇到问题之前，一个表上需要130个或更多的索引。如果在一个表上有那么多索引，那么比达到这个限制更大的问题就来了！</p><figure class="jd je jf jg fd jt er es paragraph-image"><div class="er es js"><img src="../Images/50460e273e9eb3c4fb7458b673d75b66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*OfEYjosCbnVRzsQ3.jpg"/></div></figure><p id="3cc7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但这在12.2中有所改变。对于较长的名称，一个表上的索引可能会超过30个。尽管这个数字仍然很大，但这似乎是合理的。特别是在报告数据库和数据仓库方面。您可以肯定，某个地方的某个人将开始创建“自我记录”的索引，如:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="083e" class="jm jn hh ji b fi jo jp l jq jr">create index <br/>  reducing_the_monthly_invoice_run_     <br/>  from_four_hours_to_three_minutes_ <br/>  PROJ12345_make_everything_faster_ <br/>  csaxon_thanks_everyone_yeah_baby on ...</span></pre><p id="2b93" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">创建太多这种类型，您的listagg查询将抛出令人沮丧的ORA-01489错误。</p><p id="0f57" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要绕过这一点是很棘手的。所以在12.2中我们增加了一个溢出子句。要使用它，请在分隔符后放置“溢出时截断”:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="dea2" class="jm jn hh ji b fi jo jp l jq jr">select table_name, <br/>       listagg( index_name, ',' on overflow truncate ) <br/>         within group ( order by index_name ) inds <br/>from   user_indexes <br/>group  by table_name;</span></pre><p id="1e65" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有了这些，您的输出将看起来像这样，而不是一个异常:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="6d9d" class="jm jn hh ji b fi jo jp l jq jr">...lots_and_lots_and_lots,of_indexes,...(42)</span></pre><p id="53df" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">末尾的“…”表示输出大于Oracle可以返回的值。括号中的数字表示Oracle从结果中删除的字符数。因此，你不仅可以看到有更多的数据，你还可以得到有多少数据的指示。</p><p id="24d4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">完整的语法是:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="a249" class="jm jn hh ji b fi jo jp l jq jr">listagg ( <br/>  things, ',' [ on overflow (truncate|error) ] <br/>  [ text ] [ (with|without) count ] <br/>) within group (order by cols)</span></pre><p id="75d9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，您可以明确地说出您想要错误还是截断语义。很有可能您已经编写了代码来处理ORA-1489错误。因此，为了保持代码的行为不变，缺省值仍然是error。</p><p id="623b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">text和count子句控制出现在字符串末尾的内容。如果您想用“更多”、“额外”或“点击更多”超链接替换“…”，只需提供您的新字符串！</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="0a6b" class="jm jn hh ji b fi jo jp l jq jr">select table_name, <br/>       listagg( index_name, ',' on overflow truncate <br/>         '&lt;a href="http://www.showfulldetails.com"&gt;click here&lt;/a&gt;' <br/>       ) within group ( order by index_name ) inds <br/>from   user_indexes <br/>group  by table_name;</span></pre><p id="e114" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您也可以通过指定“不计数”来删除修剪的字符数。</p></div><div class="ab cl jw jx go jy" role="separator"><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb kc"/><span class="jz bw bk ka kb"/></div><div class="ha hb hc hd he"><p id="5e3a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kd">全文原载于2016年11月10日</em><a class="ae jc" href="https://blogs.oracle.com/sql/12-things-developers-will-love-about-oracle-database-12c-release-2" rel="noopener ugc nofollow" target="_blank"><em class="kd">【blogs.oracle.com】</em></a><em class="kd">。</em></p></div></div>    
</body>
</html>