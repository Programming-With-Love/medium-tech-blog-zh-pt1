<html>
<head>
<title>Geo Location Data Processing using Locator on Oracle Database with Graph and Spatial Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Oracle数据库上的定位器和图形及空间数据处理地理位置数据</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/oracle-database-standard-geo-location-support-using-locator-included-in-every-edition-1b4288922803?source=collection_archive---------2-----------------------#2017-05-17">https://medium.com/oracledevs/oracle-database-standard-geo-location-support-using-locator-included-in-every-edition-1b4288922803?source=collection_archive---------2-----------------------#2017-05-17</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="er es ie"><img src="../Images/67a99c373396af334fcd53857fe3ff34.png" data-original-src="https://miro.medium.com/v2/resize:fit:488/0*ZmVmSpCSExDN1r6x."/></div></figure><p id="cad8" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">许多数据库都支持地理数据中的位置，以及确定距离和最近位置(在一定范围内)。Oracle数据库具有[图形和]空间选项—支持甚至最高级和最奇特的位置相关数据查询形式(包括多维形状和可能的相对论效应)；该选项是在企业版的基础上提供的，需要额外的费用。可能不太为人所知的是定位器功能，它是每个版本的Oracle数据库的一部分，包括XE和se，(不需要任何额外的费用)，并具有大多数数据库都有的地理支持。在这篇文章中，我将非常简要地介绍这个定位器功能的用途。</p><p id="637a" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">有关定位器的详细文档，请参见:<a class="ae jj" href="https://docs.oracle.com/database/121/SPATL/sdo_locator.htm#SPATL340" rel="noopener ugc nofollow" target="_blank"> Oracle Database 12c文档—定位器</a>(以及针对Oracle Database 11g的<a class="ae jj" href="http://docs.oracle.com/cd/E11882_01/appdev.112/e11830/sdo_locator.htm#SPATL340" rel="noopener ugc nofollow" target="_blank">http://docs . Oracle . com/CD/e 11882 _ 01/app dev . 112/e 11830/SDO _ Locator . htm # spatl 340</a>)。</p><p id="b44c" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">我将假设DEPT和EMP的遗留数据模型(下载用于创建SCOTT的数据库模式对象的DDL脚本:<a class="ae jj" href="https://github.com/lucasjellema/sig-nosql-mongodb/blob/master/hr-queries/scott_build.sql" rel="noopener ugc nofollow" target="_blank"> scott_build.sql </a>)。</p><h1 id="c752" class="jk jl hh bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">1.为地理空间数据准备表格</h1><p id="8460" class="pw-post-body-paragraph il im hh in b io ki iq ir is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji ha bi translated">—添加部门的地理空间数据(经度、纬度)</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="d779" class="kw jl hh ks b fi kx ky l kz la">alter table dept add (geo_location SDO_GEOMETRY)</span></pre><p id="ff0c" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">SDO_GEOMETRY是一种对象类型，它描述并支持任何类型的几何。SDO_GTYPE值的示例包括二维点的2001。SRID值8307与广泛使用的WGS84经度/纬度坐标系相关联。</p><h1 id="3187" class="jk jl hh bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">2.向表中的记录添加地理信息</h1><p id="20b4" class="pw-post-body-paragraph il im hh in b io ki iq ir is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji ha bi translated">现在已经添加了一个列来保存SDO_GEOMETRY对象，我们可以开始将位置数据加载到表中。</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="a478" class="kw jl hh ks b fi kx ky l kz la">update dept <br/>set geo_location = SDO_GEOMETRY(2001, 8307,SDO_POINT_TYPE (-96.8005, 32.7801,NULL), NULL, NULL) <br/>where loc = 'DALLAS' </span><span id="917f" class="kw jl hh ks b fi lb ky l kz la">update dept set geo_location = SDO_GEOMETRY(2001, 8307,SDO_POINT_TYPE (-73.935242, 40.730610,NULL), NULL, NULL) <br/>where loc = 'NEW YORK' </span><span id="00ce" class="kw jl hh ks b fi lb ky l kz la">update dept set geo_location = SDO_GEOMETRY(2001, 8307,SDO_POINT_TYPE ( -71.0598, 42.3584,NULL), NULL, NULL) <br/>where loc = 'BOSTON' </span><span id="7f74" class="kw jl hh ks b fi lb ky l kz la">update dept set geo_location = SDO_GEOMETRY(2001, 8307,SDO_POINT_TYPE (-87.6298, 41.8781,NULL), NULL, NULL) <br/>where loc = 'CHICAGO'</span></pre><h1 id="a403" class="jk jl hh bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">3.在用户_ SDO _ GEOM _元数据中准备元数据</h1><p id="79e9" class="pw-post-body-paragraph il im hh in b io ki iq ir is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji ha bi translated">对于每个空间列(SDO_GEOMETRY类型)，必须在USER _ SDO _ GEOM _元数据视图中插入适当的行，以反映数据所在区域的维度信息。您必须在创建空间索引之前完成此操作</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="24aa" class="kw jl hh ks b fi kx ky l kz la">-- The USER_SDO_GEOM_METADATA view has the following definition:<br/>-- ( TABLE_NAME VARCHAR2(32), <br/>-- COLUMN_NAME VARCHAR2(32), <br/>-- DIMINFO SDO_DIM_ARRAY, <br/>-- SRID NUMBER --); </span><span id="6e60" class="kw jl hh ks b fi lb ky l kz la">-- insert dimensional information for the spatial column <br/>-- the dimensional range is the entire Earth, and the coordinate system is the widely used WGS84 (longitude/latitude) system (spatial reference ID = 8307 </span><span id="ba1f" class="kw jl hh ks b fi lb ky l kz la">INSERT INTO USER_SDO_GEOM_METADATA <br/>(TABLE_NAME, COLUMN_NAME, DIMINFO, SRID) <br/>VALUES ('DEPT', 'GEO_LOCATION', SDO_DIM_ARRAY (SDO_DIM_ELEMENT('LONG', -180.0, 180.0, 0.5), SDO_DIM_ELEMENT('LAT', -90.0, 90.0, 0.5)), 8307);</span></pre><h1 id="25a8" class="jk jl hh bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">4.创建地理空间索引</h1><p id="09bf" class="pw-post-body-paragraph il im hh in b io ki iq ir is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji ha bi translated">在保存SO_GEOMETRY对象的列geo_location上创建索引:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="f55b" class="kw jl hh ks b fi kx ky l kz la">CREATE INDEX dept_spatial_idx <br/>ON dept(geo_location) INDEXTYPE IS mdsys.spatial_index;</span></pre><figure class="kn ko kp kq fd ii er es paragraph-image"><div class="er es lc"><img src="../Images/7ef9a28761f54af9aa7a3ee61e728b85.png" data-original-src="https://miro.medium.com/v2/resize:fit:820/0*Si0zNBb_bNO7wRSP."/></div></figure><h1 id="0640" class="jk jl hh bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">5.从基于位置的条件开始查询</h1><p id="90ef" class="pw-post-body-paragraph il im hh in b io ki iq ir is kj iu iv iw kk iy iz ja kl jc jd je km jg jh ji ha bi translated">列出所有部门，按离华盛顿DC的距离排序</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="2cb6" class="kw jl hh ks b fi kx ky l kz la">SELECT d.loc <br/>, SDO_GEOM.SDO_DISTANCE ( SDO_GEOMETRY(2001, 8307,SDO_POINT_TYPE ( -77.0364, 38.8951,NULL), NULL, NULL) /* Washington DC */ , d.geo_location , 0.005 , 'unit=KM' ) "distance from Washington" <br/>from dept d <br/>order by 2</span></pre><figure class="kn ko kp kq fd ii er es paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="er es ld"><img src="../Images/ddf73a258a420bfdbcceac33a1be347e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hiB1SgrQBZ9590l3."/></div></div></figure><p id="da23" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">我们查找距离华盛顿500公里以内的所有部门，并以公里为单位获取每个部门的距离:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="5dc6" class="kw jl hh ks b fi kx ky l kz la">with d as <br/>( SELECT d.loc <br/>, SDO_GEOM.SDO_DISTANCE ( SDO_GEOMETRY(2001, 8307,SDO_POINT_TYPE ( -77.0364, 38.8951,NULL), NULL, NULL) , d.geo_location , 0.005 , 'unit=KM' ) distance <br/>from dept d <br/>order by 2 <br/>) <br/>select d.* <br/>from   d <br/>where  d.distance &lt; 500</span></pre><figure class="kn ko kp kq fd ii er es paragraph-image"><div class="er es ie"><img src="../Images/e95d3961fab975b465b3ec08d24806a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:488/0*Qqh8jkGFzxv1bZxr."/></div></figure><p id="d2a1" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">找出两个离纽约最近的邻近部门:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="3804" class="kw jl hh ks b fi kx ky l kz la">SELECT /*+ LEADING(d) INDEX(dn dept_spatial_idx) */ d.deptno<br/>, d.loc<br/>, dn.deptno neighbour_deptno<br/>, dn.loc neighbour_loc<br/>, sdo_nn_distance (1) distance <br/>FROM   dept d <br/>       cross join <br/>       dept dn <br/>WHERE d.deptno = 10 /* NEW YORK */ <br/>and   dn.deptno != 10 <br/>AND   sdo_nn /* is dn in set of 3 closest neighbours to d */ (dn.geo_location, d.geo_location, 'sdo_num_res=3', 1) = 'TRUE' <br/>ORDER BY distance;</span></pre><p id="568e" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">(注意:第一行中的提示在Oracle Database 12c上是不需要的，但在11g上是需要的—参见<a class="ae jj" href="https://community.oracle.com/thread/3696687" rel="noopener ugc nofollow" target="_blank">论坛线程</a>)下面是使用<a class="ae jj" href="https://docs.oracle.com/database/121/SPATL/sdo_nn-examples.htm#SPATL1282" rel="noopener ugc nofollow" target="_blank"> SDO_NN操作符</a>的例子。</p><figure class="kn ko kp kq fd ii er es paragraph-image"><div class="er es li"><img src="../Images/99a16a354f748d6480fa4df037ab43fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/0*LX3tra42P9tQc0_Y."/></div></figure><figure class="kn ko kp kq fd ii er es paragraph-image"><div class="er es ie"><img src="../Images/09295d53f89530ce6cd76c052da72904.png" data-original-src="https://miro.medium.com/v2/resize:fit:488/0*24SA64MAMdkpif3K."/></div></figure><p id="053c" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">距离矩阵，使用枢轴:</p><pre class="kn ko kp kq fd kr ks kt ku aw kv bi"><span id="64e2" class="kw jl hh ks b fi kx ky l kz la">with distances as <br/>( SELECT /*+ LEADING(d) INDEX(dn dept_spatial_idx) */ d.deptno<br/>, d.loc<br/>, dn.deptno neighbour_deptno<br/>, dn.loc neighbour_loc<br/>, trunc(sdo_nn_distance (1)) distance <br/>FROM dept d <br/>     cross join <br/>     dept dn <br/>WHERE sdo_nn /* is dn in set of 3 closest neighbours to d */ (dn.geo_location, d.geo_location, 'sdo_num_res=3 unit=km', 1) = 'TRUE' <br/>) <br/>SELECT * <br/>FROM   (SELECT loc, neighbour_loc, distance distance FROM distances)    <br/>       PIVOT ( max(distance) AS distance <br/>               FOR (neighbour_loc) IN <br/>               ( 'NEW YORK' AS NEWYORK, 'BOSTON' AS BOSTON<br/>               , 'CHICAGO' AS CHICAGO, 'DALLAS' as DALLAS)<br/>              );</span></pre><figure class="kn ko kp kq fd ii er es paragraph-image"><div class="er es lj"><img src="../Images/f5c78c21f937f3b018ddf85466b4ce3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/0*5N0niW8CbUiOYd5s."/></div></figure><p id="0486" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><a class="ae jj" href="https://technology.amis.nl/tag/distance/" rel="noopener ugc nofollow" target="_blank">距离</a> <a class="ae jj" href="https://technology.amis.nl/tag/geodata/" rel="noopener ugc nofollow" target="_blank">地理数据</a> <a class="ae jj" href="https://technology.amis.nl/tag/gps/" rel="noopener ugc nofollow" target="_blank"> gps </a> <a class="ae jj" href="https://technology.amis.nl/tag/locator/" rel="noopener ugc nofollow" target="_blank">定位器</a> <a class="ae jj" href="https://technology.amis.nl/tag/oracle-database/" rel="noopener ugc nofollow" target="_blank"> oracle数据库</a> <a class="ae jj" href="https://technology.amis.nl/tag/pivot/" rel="noopener ugc nofollow" target="_blank">枢轴</a> <a class="ae jj" href="https://technology.amis.nl/tag/spatial/" rel="noopener ugc nofollow" target="_blank">空间</a> <a class="ae jj" href="https://technology.amis.nl/tag/sql/" rel="noopener ugc nofollow" target="_blank"> sql </a></p></div><div class="ab cl lk ll go lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ha hb hc hd he"><p id="b002" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><em class="lr">原载于2017年5月17日</em><a class="ae jj" href="https://technology.amis.nl/2017/05/17/oracle-database-standard-geo-location-support-using-locator-included-in-every-edition/" rel="noopener ugc nofollow" target="_blank"><em class="lr">technology . amis . nl</em></a><em class="lr">。</em></p></div></div>    
</body>
</html>