<html>
<head>
<title>Analyzing distributed trace data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">分析分布式跟踪数据</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/analyzing-distributed-trace-data-6aae58919949?source=collection_archive---------2-----------------------#2017-09-29">https://medium.com/pinterest-engineering/analyzing-distributed-trace-data-6aae58919949?source=collection_archive---------2-----------------------#2017-09-29</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="f68f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Brittany Herr | Pinterest工程实习生<br/> Naoman Abbas | Pinterest可见性工程师</p><p id="3ba7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">今年早些时候，我们开源了分布式追踪管道<a class="ae jc" rel="noopener" href="/@Pinterest_Engineering/distributed-tracing-at-pinterest-with-new-open-source-tools-a4f8a5562f6b"> Pintrace </a>。当请求通过后端时，跟踪会跟踪请求，跟踪它在哪里以及如何花费时间。跟踪由跨度组成，每个跨度代表一个操作。在Pinterest，每个trace有几十个服务和几百个网络调用。来自分布式跟踪的信息提供了对我们后端发生的事情的深入了解，并有助于识别瓶颈。</p><p id="e5de" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是，一个跟踪并不能代表每分钟记录的数千个跟踪(更不用说每分钟从数百万个请求中抽取这些跟踪了)。此外，任何单个跟踪都可能是异常值或记录不正确。当评估Pinterest后端的整体性能时，我们需要使用跟踪数据，以便让我们看到一个更大的画面。这就是我们构建Pintrace跟踪分析器的原因，它执行跟踪的聚合分析。在更长的一段时间内查看来自数千条跟踪的统计数据，不仅可以剔除异常值/有问题的跟踪，还可以提供性能的整体视图。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/bbd632119c36008ff3a0270c4ad2b2b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E1dNgwllZsUSFnat."/></div></div><figcaption class="jp jq et er es jr js bd b be z dx"><em class="jt">Waterfall diagram depicting a single trace. Each row is a span: in each span, the light blue block represents the time taken for that span, and the dark blue label has the service name.</em></figcaption></figure><h2 id="67bd" class="ju jv hh bd jw jx jy jz ka kb kc kd ke ip kf kg kh it ki kj kk ix kl km kn ko bi translated"><strong class="ak"> Pintrace痕迹分析器</strong></h2><p id="eb21" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">这个工具的强大之处在于它能够比较两批跟踪——显示两批跟踪中每一批的统计数据，并突出显示变化。指标的意外和重大变化可能表明部署中出现了问题。我们关注Pintrace Trace Analyzer的两个指标:</p><ol class=""><li id="9816" class="ku kv hh ig b ih ii il im ip kw it kx ix ky jb kz la lb lc bi translated">每个服务的延迟:一个服务执行它的操作需要多长时间。</li><li id="a0eb" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">网络调用次数:服务被调用的次数。</li></ol><p id="fee1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">其中任何一个显著的(意外的)变化都可能意味着代码中的错误，这可能导致生产问题，导致Pinners的等待时间增加。从成千上万的跟踪信息中看到延迟模式的变化或网络调用中的峰值，可以揭示产品代码中需要关注的区域。</p><h2 id="a902" class="ju jv hh bd jw jx jy jz ka kb kc kd ke ip kf kg kh it ki kj kk ix kl km kn ko bi translated"><strong class="ak">工作原理</strong></h2><p id="eb8f" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">有了这个工具，工程师可以根据用户的要求，通过比较两组不同的轨迹来找出问题所在。这里的“不同”可以指:</p><ul class=""><li id="182b" class="ku kv hh ig b ih ii il im ip kw it kx ix ky jb li la lb lc bi translated">不同的时间段，即部署或事件之前和之后。</li><li id="3363" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb li la lb lc bi translated">跨不同设备，例如web和iOS。</li><li id="62f7" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb li la lb lc bi translated">来自不同的国家。</li><li id="88fd" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb li la lb lc bi translated">请求类型，例如v3_home_feed和v3_get_pin</li></ul><p id="a0b9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">跟踪分析器由两个主要部分组成——一个<a class="ae jc" href="https://spark.apache.org/" rel="noopener ugc nofollow" target="_blank"> Spark </a>作业(用于高容量数据处理)和一个<a class="ae jc" href="http://jupyter.org/" rel="noopener ugc nofollow" target="_blank"> Jupyter </a>笔记本UI。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lj"><img src="../Images/82109b9cada0d1a2905ce908ce2f4b9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/0*lkJEUYSf_RhaiJII."/></div><figcaption class="jp jq et er es jr js bd b be z dx"><em class="jt">Workflow of Trace Analyzer. Blue components were built in this project and grey components already existed as part of Pintrace.</em></figcaption></figure><ol class=""><li id="fb01" class="ku kv hh ig b ih ii il im ip kw it kx ix ky jb kz la lb lc bi translated">用户在Jupyter界面中输入两组跟踪规格。</li><li id="1cd7" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">Python脚本使用用户参数将Spark作业发送到<a class="ae jc" href="https://mesos.github.io/chronos/" rel="noopener ugc nofollow" target="_blank"> Chronos </a>。</li><li id="6482" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">Spark作业从<a class="ae jc" href="https://www.elastic.co/products/elasticsearch" rel="noopener ugc nofollow" target="_blank"> Elasticsearch </a>获取跨度数据。</li><li id="98b3" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">该作业运行分析并将结果推送到Elasticsearch。</li><li id="51a0" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb kz la lb lc bi translated">Jupyter从Elasticsearch获取结果，并向用户显示可视化报告。</li></ol><p id="5256" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下是由报告生成的几个示例图:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lk"><img src="../Images/37b513e3409570139d3f113b2c816a8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JkCaJ3z0jEALQS2R."/></div></div><figcaption class="jp jq et er es jr js bd b be z dx"><em class="jt">Overview table comparing two batches of traces.</em></figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ll"><img src="../Images/2053dd501cc2ef8c820722fd6058fe2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yGcolJu0c--_R0oV."/></div></div><figcaption class="jp jq et er es jr js bd b be z dx"><em class="jt">Histogram showing overall latency for traces in each batch.</em></figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lm"><img src="../Images/6edf9857ca581438bc96eef88aa09027.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qZoQnGVg7bmd7L17."/></div></div><figcaption class="jp jq et er es jr js bd b be z dx"><em class="jt">Sample traces (trace ID and value) for various percentiles that link to the traces in Pintrace.</em></figcaption></figure><h2 id="c583" class="ju jv hh bd jw jx jy jz ka kb kc kd ke ip kf kg kh it ki kj kk ix kl km kn ko bi translated"><strong class="ak">这对我们意味着什么</strong></h2><p id="3846" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">该工具可以更高效地锁定问题源，并减少延迟事件。我们运行了一个特定日期(性能差)的跟踪数据与正常性能的比较报告。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ln"><img src="../Images/892e2780c45d965be8eeab801b75df5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/0*rZrWbZdoRoRN-5JS."/></div><figcaption class="jp jq et er es jr js bd b be z dx"><em class="jt">Overview table that shows a huge latency increase.</em></figcaption></figure><p id="79cf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下表对每个服务的RPC数量进行了细分，我们发现对服务“pinandboardservice”的调用数量出现峰值</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lo"><img src="../Images/2a47d91128153f9348c4e2380209fcb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jO2UofOhPMjpVoup."/></div></div></figure><p id="3536" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这表明对API的不必要调用降低了请求速度。有了这样的信息，我们可以快速检测问题的根源并修复任何错误。</p><h2 id="9a6d" class="ju jv hh bd jw jx jy jz ka kb kc kd ke ip kf kg kh it ki kj kk ix kl km kn ko bi translated"><strong class="ak">未来步骤</strong></h2><p id="7a09" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">我们在事故发生后使用这个工具来识别错误发生的位置并诊断发生了什么。我们渴望继续探索未来Pintrace的扩展，因为这只是分布式跟踪的冰山一角。其他一些可能的使用案例包括:</p><ul class=""><li id="fd89" class="ku kv hh ig b ih ii il im ip kw it kx ix ky jb li la lb lc bi translated">将其与我们的部署流程集成，以检测新版本的应用程序是否会导致性能问题。这将允许我们使用该工具作为预防措施，而不是被动地作为调试工具。</li><li id="a8b0" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb li la lb lc bi translated">自动生成报告，以便工程师可以轻松检查每天的部署状态。</li><li id="ea72" class="ku kv hh ig b ih ld il le ip lf it lg ix lh jb li la lb lc bi translated">当RPC延迟或数量达到特定阈值时设置警报。</li></ul><p id="2233" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">随着我们跟踪工具的扩展，这个工具的用例将会扩展。例如，我们计划向每个跟踪添加版本控制或实验信息，这样我们就可以跨这些不同点比较统计数据。</p><p id="6793" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">到目前为止，我们实现的内容为聚合跟踪分析奠定了基础。通过向该项目添加扩展，我们将能够进一步利用跟踪数据，最终为Pinners提供更快的体验。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lp"><img src="../Images/254075b2b7acb21eb7f2e2eed735caf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:72/format:webp/1*qyJBXP1N7G1uBMgx93slhg.png"/></div></figure></div><div class="ab cl lq lr go ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ha hb hc hd he"><p id="efc7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">鸣谢:为本项目做出贡献的是Rob Claire和Xiaoqiao Meng。</p></div></div>    
</body>
</html>