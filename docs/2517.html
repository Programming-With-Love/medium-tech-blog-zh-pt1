<html>
<head>
<title>Building Terraform Platform for Your Team Using AWS, Atlantis, and GitHub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS、Atlantis和GitHub为您的团队构建Terraform平台</h1>
<blockquote>原文：<a href="https://medium.easyread.co/building-terraform-platform-for-your-team-using-aws-atlantis-and-github-5412a1cd2370?source=collection_archive---------0-----------------------#2020-06-17">https://medium.easyread.co/building-terraform-platform-for-your-team-using-aws-atlantis-and-github-5412a1cd2370?source=collection_archive---------0-----------------------#2020-06-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a5ff022ae2a2faba13b47867e2de9cb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VNGwoAtXaoSaIGML"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@estherrj?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Esther Jiao</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="b481" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> Terraform </strong> </a>是管理云基础设施的多功能工具。它是开源的，已经上市5年多了。它是将基础设施实现为代码(IaC)的最流行的工具。使用代码管理云基础设施为自动化铺平了道路。与使用点击方法(如web UI)相比，代码可以在团队之间实现更好协作。</p><p id="47c9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇文章帮助你为使用<a class="ae kc" href="https://aws.amazon.com/id/ec2/instance-types/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> EC2实例</strong> </a> <strong class="kf ir"> </strong>托管亚特兰蒂斯的团队建立一个平台。<a class="ae kc" href="https://www.runatlantis.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> Atlantis </strong> </a>是运行Terraform的拉式请求自动化。你可以把它想象成一个执行者，当变化发生时，它监控并运行Terraform。一个EC2实例就足够了，因为Atlantis通常只由内部团队使用。Atlantis需要在应用之前将执行计划临时保存到磁盘。与在多个实例上运行EC2以获得高可用性相比，在EC2不可访问的情况下更快地恢复更重要，也更划算。在多个EC2实例中运行Atlantis意味着所有实例都需要访问一个共享目录，这使得设置更加复杂和难以维护。</p><p id="c3a5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本例中，您使用GitHub作为存储Terraform平台的Terraform项目的地方。Atlantis将在每次创建新的PR时运行。Atlantis可以检测PR是否包含Terraform项目并执行它。当新的提交被推送到现有的PR时，它也运行。</p><p id="90ae" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将Atlantis与GitHub集成意味着你需要将Atlantis暴露在互联网上。这是必要的，这样Atlantis将能够从GitHub接收webhooks。Atlantis有一个网络界面，但它没有任何认证机制。您将使用GitHub OpenID Connect提供程序来保护Atlantis web界面。</p><h1 id="18aa" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">为Terraform平台调配AWS资源</h1><p id="d7b4" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Terraform平台的一个组件是EC2实例，Atlantis将安装在该实例中。您将使用这个Terraform模块<a class="ae kc" href="https://registry.terraform.io/modules/ringanta/ec2-atlantis/aws/" rel="noopener ugc nofollow" target="_blank">https://registry . terra form . io/modules/ringanta/ec2-Atlantis/AWS/</a>来启动EC2实例。这个模块需要一个SSH公共密钥。它处理使用弹性IP、安全组启动EC2，并从默认VPC中选择一个子网。</p><p id="3a5d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Terraform平台的其他组件包括S3铲斗和DynamoDB工作台。S3存储桶用于存储其他Terraform项目的远程状态。您可以将一个铲斗用于多个Terraform项目。每个项目都有自己的键。当使用S3作为Terraform后端时，DynamoDB是一种锁定机制。一个DynamoDB表支持多个Terraform项目。</p><p id="481a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们使用<code class="fe me mf mg mh b"><strong class="kf ir">mkdir atlantis-server</strong></code>为Atlantis平台创建一个目录。然后使用<code class="fe me mf mg mh b"><strong class="kf ir">cd atlantis-server</strong></code>将工作目录更改为新创建的目录。在运行Terraform项目之前，您需要为EC2生成一个SSH密钥对。使用<code class="fe me mf mg mh b"><strong class="kf ir">ssh-keygen -t rsa -b 2048 -f ~/.ssh/atlantis-server_rsa</strong></code>命令。SSH公钥存储在<code class="fe me mf mg mh b"><strong class="kf ir">~/.ssh/atlantis-server_rsa.pub</strong></code>上。您将需要SSH公钥的内容作为<code class="fe me mf mg mh b"><strong class="kf ir">main.tf</strong></code>文件中的一个参数。让我们用下面的内容创建一个文件<code class="fe me mf mg mh b"><strong class="kf ir">main.tf</strong></code>。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Terraform main.tf</figcaption></figure><p id="4c7a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用上面生成的SSH公钥的内容替换<strong class="kf ir"> SSH_PUBLIC_KEY </strong>。S3存储桶名称由所有AWS用户共享，因此您可能需要根据自己的需要找到一个更独特的名称。<code class="fe me mf mg mh b"><strong class="kf ir">attach_admin_policy = true</strong></code>参数将使用EC2实例角色将<strong class="kf ir"> AdministratorAccess </strong>角色附加到EC2。AdministratorAccess是授予AWS帐户完全访问权限的AWS内置角色。</p><p id="4074" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们创建<code class="fe me mf mg mh b"><strong class="kf ir">providers.tf</strong></code>文件，并在那里声明Terraform AWS provider和其他Terraform配置。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Terraform providers.tf</figcaption></figure><p id="9a4a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们用下面的内容创建<code class="fe me mf mg mh b"><strong class="kf ir">outputs.tf</strong></code>文件。该文件打印安装Atlantis所需的信息。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Terraform outputs.tf</figcaption></figure><p id="a7c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一切就绪，您就可以为Terraform平台提供AWS资源了。在运行下面的terraforms命令之前，需要在执行命令的本地计算机上配置具有适当权限的AWS凭据。</p><ol class=""><li id="a3f3" class="mo mp iq kf b kg kh kk kl ko mq ks mr kw ms la mt mu mv mw bi translated">设置将提供资源的AWS区域。例如，如果您想在新加坡提供资源，您需要导出下面的变量，<code class="fe me mf mg mh b"><strong class="kf ir">export AWS_REGION=ap-southeast-1</strong></code>。有关所有可用的aws地区，请咨询<a class="ae kc" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html#concepts-available-regions" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/AWS C2/latest/user guide/using-regions-avail ability-zones . html # concepts-available-regions</a>。</li><li id="8fdc" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la mt mu mv mw bi translated">运行<code class="fe me mf mg mh b"><strong class="kf ir">terraform init</strong></code>初始化Terraform项目。</li><li id="783f" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la mt mu mv mw bi translated">运行<code class="fe me mf mg mh b"><strong class="kf ir">terraform plan -out=tfplan.out</strong></code>生成执行计划并检查执行计划。</li><li id="ef47" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la mt mu mv mw bi translated">通过执行<code class="fe me mf mg mh b"><strong class="kf ir">terraform apply tfplan.out</strong></code>应用更改。</li></ol><p id="9bea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">上面的Terraform命令为Atlantis创建了一个EC2实例，为Terraform远程状态创建了一个S3桶，为远程状态锁定创建了一个DynamoDB表。所有这些资源都是在AWS_REGION变量定义的区域中创建的。在提供了所有资源之后，让我们使用以下命令将所有Terraform文件保存到Git存储库中。</p><pre class="mi mj mk ml gt nc mh nd ne aw nf bi"><span id="9dcd" class="ng lc iq mh b gy nh ni l nj nk">git init<br/>echo -e ".terraform\ntfplan.out" &gt;&gt; .gitignore<br/>git add .<br/>git commit -m 'Initial commit'<br/>git remote add origin &lt;GITHUB_REPO_URL&gt;<br/>git push -u origin master</span></pre><p id="8d82" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">大多数情况下，您不需要将Terraform状态文件提交到git存储库中。我们将为这个Terraform项目破例，因为这个项目不会改变太多。该项目使用本地状态文件。Git是一种与其他团队成员共享terraform文件和状态文件的机制。建议将这个本地git存储库发布到其他团队成员可以访问的中央存储库。</p><h1 id="59dd" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">为亚特兰蒂斯准备GitHub凭证</h1><p id="d72d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Atlantis建议创建一个专门的GitHub用户，其名称应易于识别为Atlantis。这很重要，因为Atlantis会以这个用户的身份写评论。Atlantis需要一个具有存储库范围的GitHub个人访问令牌(PAT)才能运行。按照<a class="ae kc" href="https://www.runatlantis.io/docs/access-credentials.html#generating-an-access-token" rel="noopener ugc nofollow" target="_blank">https://www . run atlantis . io/docs/access-credentials . html # generating-an-access-token</a>为Atlantis生成GitHub PAT。</p><p id="1f87" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Atlantis web UI由OAuth2代理保护，GitHub作为OpenID Connect身份提供者。OAuth2代理需要来自GitHub OAuth应用程序的OAuth客户端id和密码。GitHub在<a class="ae kc" href="https://developer.github.com/apps/building-oauth-apps/creating-an-oauth-app/" rel="noopener ugc nofollow" target="_blank">https://developer . GitHub . com/apps/building-OAuth-apps/creating-an-OAuth-app/</a>上提供了创建新OAuth应用的指南。GitHub OAuth创建需要以下信息:</p><ul class=""><li id="1051" class="mo mp iq kf b kg kh kk kl ko mq ks mr kw ms la nl mu mv mw bi translated">应用程序名称是OAuth应用程序的名称</li><li id="5986" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la nl mu mv mw bi translated">主页URL是主页或OAuth应用程序。值的格式为<code class="fe me mf mg mh b"><strong class="kf ir">https://&lt;ATLANTIS_DOMAIN&gt;</strong></code>。<strong class="kf ir"> ATLANTIS_DOMAIN </strong>必须替换为<code class="fe me mf mg mh b"><strong class="kf ir">terraform output atlantis_xip_domain</strong></code>的输出。</li><li id="43a3" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la nl mu mv mw bi translated">授权回调URL是OAuth2代理回调URL。该字段的值为<code class="fe me mf mg mh b"><strong class="kf ir">https://&lt;ATLANTIS_DOMAIN&gt;/oauth2/callback</strong></code>。</li></ul><p id="05b2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">成功创建OAuth应用程序后，记录OAuth客户端id和客户端密码。稍后配置Atlantis时需要这些信息。</p><h1 id="ba4e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">设置和配置Atlantis</h1><p id="e2b4" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">Atlantis将被安装在上面用Terraform创建的EC2上。Ansible galaxy上有一个Ansible角色可以在Linux虚拟机上安装和配置Atlantis。这个角色可以在https://galaxy.ansible.com/ringanta/atlantis<a class="ae kc" href="https://galaxy.ansible.com/ringanta/atlantis" rel="noopener ugc nofollow" target="_blank">找到。该角色还安装和配置保护Atlantis安装所需的其他软件包。</a></p><ul class=""><li id="d0eb" class="mo mp iq kf b kg kh kk kl ko mq ks mr kw ms la nl mu mv mw bi translated">确保安装了Ansible 2.9。您可以使用pip安装Ansible，如下所示<code class="fe me mf mg mh b"><strong class="kf ir">pip install --upgrade ansible</strong></code>。</li><li id="c526" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la nl mu mv mw bi translated">确保工作目录在<code class="fe me mf mg mh b"><strong class="kf ir">atlantis-server</strong></code>目录中。</li><li id="cd1f" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la nl mu mv mw bi translated">创建一个可行的库存文件，并将文件命名为<code class="fe me mf mg mh b"><strong class="kf ir">hosts</strong></code>。将上面创建的EC2实例添加到库存文件中。文件内容应该如下所示。</li></ul><pre class="mi mj mk ml gt nc mh nd ne aw nf bi"><span id="c1e1" class="ng lc iq mh b gy nh ni l nj nk">; filename: hosts<br/>[atlantis]<br/>&lt;ATLANTIS_IP&gt; ansible_user=ubuntu</span></pre><p id="c2b9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用来自<code class="fe me mf mg mh b"><strong class="kf ir">terraform output atlantis_ip</strong></code>命令的值替换<strong class="kf ir"> ATLANTIS_IP </strong>。</p><ul class=""><li id="5a1b" class="mo mp iq kf b kg kh kk kl ko mq ks mr kw ms la nl mu mv mw bi translated">创建一个vault密码文件来加密和解密Ansible变量值，<code class="fe me mf mg mh b"><strong class="kf ir">openssl rand -base64 18 &gt; vault-pass-file</strong></code></li><li id="d731" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la nl mu mv mw bi translated">用以下内容创建一个脚本文件(如<code class="fe me mf mg mh b"><strong class="kf ir">playbook.yml</strong></code>)。</li></ul><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Atlantis Playbook</figcaption></figure><p id="84de" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用适当的值替换下列占位符:</p><ul class=""><li id="f9ec" class="mo mp iq kf b kg kh kk kl ko mq ks mr kw ms la nl mu mv mw bi translated"><strong class="kf ir"> ATLANTIS_DOMAIN </strong>值可以使用<code class="fe me mf mg mh b"><strong class="kf ir">terraform output atlantis_xip_domain</strong></code>命令获取。</li><li id="f009" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la nl mu mv mw bi translated"><strong class="kf ir"> GH_USER </strong>和<strong class="kf ir"> GH_TOKEN </strong>是来自<a class="ae kc" href="http://localhost:1313/posts/build-terraform-automation-platform-for-your-team-using-ec2-atlantis-and-github/#prepare-github-credential-for-atlantis" rel="noopener ugc nofollow" target="_blank">为Atlantis </a>准备Github凭证部分的Github用户名和PAT。使用Ansible Vault加密<strong class="kf ir"> GH_TOKEN </strong>值，以便安全提交，<code class="fe me mf mg mh b"><strong class="kf ir">ansible-vault encrypt_string --vault-password-file vault-pass-file '&lt;GH_TOKEN&gt;'</strong></code></li><li id="dc42" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la nl mu mv mw bi translated"><strong class="kf ir"> GH_WEBHOOK_SECRET </strong>是一个随机值，也需要在Github webhook配置上设置。使用以下命令生成并加密值<code class="fe me mf mg mh b"><strong class="kf ir">ansible-vault encrypt_string --vault-password-file vault-pass-file $(openssl -rand -base64 18)</strong></code>。</li><li id="1ac5" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la nl mu mv mw bi translated"><strong class="kf ir"> GH_REPO_LIST </strong>表示哪些存储库被允许运行Atlantis。为了方便起见，允许某些Github组织下的所有存储库。例如，使用<code class="fe me mf mg mh b"><strong class="kf ir">github.com/ringanta-demo-atlantis/*</strong></code>来允许<code class="fe me mf mg mh b"><strong class="kf ir">ringanta-demo-atlantis</strong></code> Github组织下的所有存储库。</li><li id="472f" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la nl mu mv mw bi translated">OAUTH2_COOKIE_SECRET 是一个随机值，可以使用<code class="fe me mf mg mh b"><strong class="kf ir">ansible-vault encrypt_string --vault-password-file vault-pass-file $(openssl -rand -base64 18)</strong></code>命令生成并加密。</li><li id="b991" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la nl mu mv mw bi translated"><strong class="kf ir"> OAUTH2_CLIENT_ID </strong>和<strong class="kf ir"> OAUTH2_CLIENT_SECRET </strong>是来自<a class="ae kc" href="http://localhost:1313/posts/build-terraform-automation-platform-for-your-team-using-ec2-atlantis-and-github/#prepare-github-credential-for-atlantis" rel="noopener ugc nofollow" target="_blank">为Atlantis准备Github凭证</a>部分的Github OAuth客户端ID和SECRET。使用<code class="fe me mf mg mh b"><strong class="kf ir">ansible-vault encrypt_string --vault-password-file vault-pass-file '&lt;OAUTH2_CLIENT_SECRET&gt;'</strong></code>命令对<strong class="kf ir"> OAUTH2_CLIENT_SECRET </strong>进行加密。</li><li id="ff13" class="mo mp iq kf b kg mx kk my ko mz ks na kw nb la nl mu mv mw bi translated"><strong class="kf ir"> OAUTH2_GH_ORG </strong>是一个Github组织，其成员被允许访问Atlantis web UI。例如，使用<code class="fe me mf mg mh b"><strong class="kf ir">ringanta-demo-atlantis</strong></code>允许<code class="fe me mf mg mh b"><strong class="kf ir">ringanta-demo-atlantis</strong></code> Github组织的成员访问Atlantis web UI。</li></ul><p id="a313" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下一步是使用<code class="fe me mf mg mh b"><strong class="kf ir">ansible-galaxy role install -p roles ringanta.atlantis</strong></code>从Ansible Galaxy下载亚特兰蒂斯角色。之后运行<code class="fe me mf mg mh b"><strong class="kf ir">playbook.yml</strong></code>剧本。本行动手册将安装和配置Atlantis以及保护它所必需的其他包。</p><p id="bb64" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b"><strong class="kf ir">ansible-playbook -i hosts --vault-password-file vault-pass-file --private-key ~/.ssh/atlantis-server_rsa playbook.yml -v</strong></code></p><p id="688a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦Atlantis启动并运行，创建一个新的Github webhook。关于如何为atlantis创建webhook，请咨询<a class="ae kc" href="https://www.runatlantis.io/docs/configuring-webhooks.html#github-github-enterprise" rel="noopener ugc nofollow" target="_blank">https://www . run Atlantis . io/docs/configuring-web hooks . html # github-github-enterprise</a>。确保使用与<code class="fe me mf mg mh b"><strong class="kf ir">playbook.yml</strong></code>剧本文件中相同的webhook密码值。最后一步是验证Atlantis是否设置正确。使用浏览器访问<code class="fe me mf mg mh b"><strong class="kf ir">https://&lt;ATLANTIS_DOMAIN&gt;</strong></code>上的亚特兰蒂斯。您将看到使用Github 按钮进行<strong class="kf ir">登录。点击按钮，您将被重定向到GitHub授权页面。授权应用程序访问您的GitHub帐户。你将被重定向到亚特兰蒂斯登陆页面。</strong></p><p id="3a82" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Atlantis已经安装并配置好了。让我们将Ansible相关文件提交给git存储库。</p><pre class="mi mj mk ml gt nc mh nd ne aw nf bi"><span id="8a72" class="ng lc iq mh b gy nh ni l nj nk">echo vault-pass-file &gt;&gt; .gitignore<br/>git add .<br/>git commit -m 'Install and configure Atlantis'<br/>git push</span></pre><h1 id="68a8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">试用Terraform平台</h1><p id="6b76" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">您可以通过在上面运行Terraform项目来尝试新创建的Terraform平台。该项目必须托管在Atlantis存储库允许列表中的一个存储库中。让我们创建一个简单的Terraform项目，利用现有的S3桶和DynamoDB表。用以下内容创建<code class="fe me mf mg mh b"><strong class="kf ir">providers.tf</strong></code>文件。</p><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Terraform providers.tf</figcaption></figure><p id="447b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将Terraform项目文件添加到git存储库中，并将其发布到GitHub。确保GitHub库是Atlantis允许列表的一部分。</p><p id="0a8b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，您将使用terraform创建一个虚拟铲斗。提交Terraform变更作为PR，并通过Atlantis执行变更。为此，请在本地创建一个新分支。将当前分支更改为新分支后，创建包含以下内容的<code class="fe me mf mg mh b"><strong class="kf ir">main.tf</strong></code>文件。</p><pre class="mi mj mk ml gt nc mh nd ne aw nf bi"><span id="83e0" class="ng lc iq mh b gy nh ni l nj nk">resource "aws_s3_bucket" "bucket" {<br/>    bucket = "dummy-bucket-for-testing-123abc"<br/>}</span></pre><p id="0939" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将变更提交到本地git存储库，将其推送到Github，并创建一个新的PR。Atlantis将选择变更并报告执行计划。下面是Atlantis运行<code class="fe me mf mg mh b">terraform plan</code>后的报告示例。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/8dd75f1f65148bf4bd426f57b8f4637c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HXP7cOcMxC2nFB-leyoq5w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Terraform Platform Atlantis Plan</figcaption></figure><p id="b9f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在验证Terraform执行计划正确后，通过在GitHub PR页面上发布<code class="fe me mf mg mh b"><strong class="kf ir">atlantis apply</strong></code>评论来应用更改。Atlantis将运行更改并报告结果。以下是成功应用执行计划后的Atlantis结果示例。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/a8235dddaa5ad609bc89705d79e18467.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oeJtx3pgJ01ZX7QSMg5d0w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Terraform Platform Atlantis Run</figcaption></figure><p id="a180" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Atlantis UI显示Terraform项目的活动锁定。一旦PR被合并，该锁将被删除。我们还可以从web用户界面中删除锁。这是Atlantis web UI上一个活动锁的例子。</p><figure class="mi mj mk ml gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/cc81f757a535025266df611772549261.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wEJPncFTwuP11UIe3_SDVg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Terraform Platform Atlantis Web UI</figcaption></figure><h1 id="47cc" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="73b6" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在本文中，我将向您展示如何使用EC2、GitHub和Atlantis为您的团队建立一个Terraform平台。该平台使用S3作为远程状态后端，使用DynamoDB表作为S3后端的锁定机制。Terraform和Ansible用于为平台提供和配置基础设施。所有配置都在Git存储库中进行版本控制，并推送到GitHub。还演示了如何使用Terraform平台运行Terraform项目。Atlantis检测到一个PR并向PR页面报告执行计划。用户需要审查执行计划并发布<code class="fe me mf mg mh b"><strong class="kf ir">atlantis</strong> <strong class="kf ir">apply</strong></code>以应用执行计划。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><figure class="mi mj mk ml gt jr"><div class="bz fp l di"><div class="nw mn l"/></div></figure></div></div>    
</body>
</html>