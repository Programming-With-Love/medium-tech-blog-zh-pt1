<html>
<head>
<title>Provision Oracle Cloud Infrastructure Home Region IAM resources in a multi-region Terraform configuration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在多区域平台配置中调配Oracle云基础架构主区域IAM资源</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/provision-oracle-cloud-infrastructure-home-region-iam-resources-in-a-multi-region-terraform-f997a00ae7ed?source=collection_archive---------1-----------------------#2019-11-27">https://medium.com/oracledevs/provision-oracle-cloud-infrastructure-home-region-iam-resources-in-a-multi-region-terraform-f997a00ae7ed?source=collection_archive---------1-----------------------#2019-11-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="faf3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">本文涵盖了一个我一直想发布的常见配置模式。在Oracle Cloud Infrastructure (OCI)中调配<a class="ae jc" href="https://www.oracle.com/cloud/what-is-iaas/" rel="noopener ugc nofollow" target="_blank"> IaaS </a>资源时，一些资源，具体来说是<strong class="ig hi"> IAM </strong>资源，只能在<a class="ae jc" href="https://docs.cloud.oracle.com/iaas/Content/Identity/Tasks/managingregions.htm#home" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi">主区域</strong> </a>中创建。</p><p id="3d7f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果配置需要创建IAM资源，如新的隔离专区或部署特定策略，则Terraform配置需要以多个地区为目标。Terraform允许通过声明额外的提供者并分配一个<a class="ae jc" href="https://www.terraform.io/docs/configuration/providers.html#alias-multiple-provider-instances" rel="noopener ugc nofollow" target="_blank">提供别名</a>来提供给多个地区，因此举一个简单的例子</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="c011" class="jm jn hh ji b fi jo jp l jq jr"><strong class="ji hi"># default provider for the configuration</strong><br/>provider "oci" {<br/>  region = var.region<br/>}</span><span id="1cd8" class="jm jn hh ji b fi js jp l jq jr"><strong class="ji hi"># provider for home region for IAM resource provisioning</strong><br/>provider "oci" {<br/>  <strong class="ji hi">alias  = "home"</strong><br/>  region = "us-ashburn-1"<br/>}</span><span id="d4c2" class="jm jn hh ji b fi js jp l jq jr"><strong class="ji hi"># create the compartment in the Home region</strong><br/>resource oci_identity_compartment compartment {<br/><strong class="ji hi">  provider       = oci.home<br/>  </strong>compartment_id = var.tenancy_id<br/>  name           = "My_Compartment"<br/>  description    = "My Compartment"<br/>}</span></pre><p id="e061" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这将在主区域<code class="du jt ju jv ji b">us-ashburn-1</code>中创建区间，配置中的任何其他资源都将在<code class="du jt ju jv ji b">var.region</code>中创建。但是并不是每个租户的家都在阿什本，所以让我们看看如何使它更具可移植性，而不需要向配置变量添加一个单独的<code class="du jt ju jv ji b">home_region</code>输入参数。</p><p id="129f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><code class="du jt ju jv ji b">oci_identity_tenancy</code>数据源可用于查找租赁的家庭区域。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="07c3" class="jm jn hh ji b fi jo jp l jq jr">data oci_identity_tenancy tenancy {<br/>  tenancy_id = var.tenancy_ocid<br/>}</span><span id="d681" class="jm jn hh ji b fi js jp l jq jr">output home_region {<br/>  value = oci_identity_tenancy.tenancy.home_region_key<br/>}</span><span id="4c0d" class="jm jn hh ji b fi js jp l jq jr"><strong class="ji hi">home_region = IAD</strong></span></pre><p id="dc81" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是这给了我们一个三个字母的地区代码，例如<code class="du jt ju jv ji b">IAD</code>。为了将它转换成provider <code class="du jt ju jv ji b">region</code>属性所期望的格式，我们需要一个home region键到region ids的映射。使用<code class="du jt ju jv ji b">oci_identity_regions</code>数据源，我们得到一个完整的区域列表，从中我们可以创建一个查找映射，并使用home region键查找值。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="1ccd" class="jm jn hh ji b fi jo jp l jq jr">data oci_identity_regions regions {<br/>}</span><span id="db73" class="jm jn hh ji b fi js jp l jq jr">locals {<br/>  region_map = {<br/>    for r in data.oci_identity_regions.regions.regions :<br/>    r.key =&gt; r.name<br/>  }</span><span id="251b" class="jm jn hh ji b fi js jp l jq jr">  home_region = lookup(<br/>    local.region_map, <br/>    data.oci_identity_tenancy.tenancy.home_region_key<br/>  )<br/>}</span><span id="3baa" class="jm jn hh ji b fi js jp l jq jr">output home_region {<br/>  value = local.home_region<br/>}</span><span id="aee6" class="jm jn hh ji b fi js jp l jq jr"><strong class="ji hi">home_region = us-ashburn-1</strong></span></pre><p id="2ca6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们可以在提供者定义中使用<code class="du jt ju jv ji b">local.home_region</code>:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="efba" class="jm jn hh ji b fi jo jp l jq jr"><strong class="ji hi"># provider for home region for IAM resource provisioning</strong><br/>provider "oci" {<br/>  alias  = "home"<br/>  region = <strong class="ji hi">local.home_region<br/></strong>}</span></pre><h2 id="3ed0" class="jm jn hh bd jw jx jy jz ka kb kc kd ke ip kf kg kh it ki kj kk ix kl km kn ko bi translated">等待IAM资源跨区域传播</h2><p id="d911" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">调配IAM资源时的一个重要注意事项是，在主区域中创建、更新或删除的资源需要一段时间才能传播到租赁的所有其他区域。如果在目标(非主)区域中供应的资源依赖于新的IAM资源，例如，在新的隔离专区中供应，或者依赖于新创建的策略，如果新资源没有及时传播，供应可能(将)失败。</p><p id="a685" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">等待新资源传播的一种方法是为在主区域中创建的同一资源添加一个数据源。依赖于IAM资源的资源将引用数据源，而不是直接引用IAM资源。在上述示例的基础上，我们添加了隔离专区数据源和要在隔离专区中创建的VCN:</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="9b1b" class="jm jn hh ji b fi jo jp l jq jr"><strong class="ji hi"># create the compartment in the Home region</strong><br/>resource oci_identity_compartment compartment {<br/><strong class="ji hi">  provider = oci.home<br/></strong>  compartment_id = var.tenancy_id<br/>  name           = "My_Compartment"<br/>  description    = "My Compartment"<br/>}</span><span id="ceb1" class="jm jn hh ji b fi js jp l jq jr"><strong class="ji hi"># data source for compartment</strong><br/>data oci_identity_compartment mycompartment {<br/>  id = oci_identity_compartment.mycompartment.id<br/>}</span><span id="70b8" class="jm jn hh ji b fi js jp l jq jr"><strong class="ji hi"># vcn in new compartment</strong><br/>resource oci_core_vcn myvcn {<br/>  compartment_id = <strong class="ji hi">data</strong>.oci_identity_compartment.mycompartment<br/>  display_name   = "My VCN"<br/>  cidr_block     = "10.0.0.0/16"<br/>}</span></pre><p id="74cb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当我们进行配置时，我们看到隔离专区数据源等待隔离专区在目标区域中可用，然后再继续进行VCN配置。</p><pre class="jd je jf jg fd jh ji jj jk aw jl bi"><span id="37fe" class="jm jn hh ji b fi jo jp l jq jr">oci_identity_compartment.mycompartment: Creating...<br/>oci_identity_compartment.mycompartment: Still creating... [10s elapsed]<br/>oci_identity_compartment.mycompartment: Creation complete after 10s [id=ocid1.compartment.oc1..aaaaaaaap7xfr4byri4phkykeazgyoexxdii2xtxx2o6ric4ok267lcm66aq]<br/><strong class="ji hi">data.oci_identity_compartment.mycompartment: Refreshing state...</strong><br/><strong class="ji hi">oci_core_vcn.myvcn: Creating...</strong><br/>oci_core_vcn.myvcn: Creation complete after 1s [id=ocid1.vcn.oc1.ca-toronto-1.aaaaaaaav4fospzcnk3nqfcdb7ehd4nidk7ulfjhuroucy5dqwtj5i47ug3q]<br/><br/><strong class="ji hi">Apply complete! Resources: 2 added, 0 changed, 0 destroyed.</strong></span></pre></div></div>    
</body>
</html>