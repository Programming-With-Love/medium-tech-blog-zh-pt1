<html>
<head>
<title>Identity Crisis: How Modern Applications Generate Unique Ids</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">身份危机:现代应用程序如何生成唯一的id</h1>
<blockquote>原文：<a href="https://medium.com/javascript-scene/identity-crisis-how-modern-applications-generate-unique-ids-39562736f557?source=collection_archive---------1-----------------------#2022-12-31">https://medium.com/javascript-scene/identity-crisis-how-modern-applications-generate-unique-ids-39562736f557?source=collection_archive---------1-----------------------#2022-12-31</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/2f815aa03c886c99130046b9c6710398.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d71PW94a1HkpqwNNXTWg-g.png"/></div></div></figure><p id="cdb3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="jn">TL；DR:使用</em> <a class="ae jo" href="https://github.com/paralleldrive/cuid2" rel="noopener ugc nofollow" target="_blank"> <em class="jn"> Cuid2 </em> </a> <em class="jn">所以你不需要担心所有这些标识符的复杂性。</em></p><p id="f2f7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在是早上7:15，客户支持忙得不可开交。我们刚刚上了《早安美国》的专题节目，一大群第一次来的顾客遇到了问题。一个顾客会在购物车里装满商品，结账，付款，然后收到一张订单收据，上面全是错误的商品！</p><p id="bc5b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">发生了什么事？我们使用GUIDs，我们相信它们不会冲突。毕竟，它们被称为“全球唯一标识符”，所以它们必须是唯一的，对吗？在<code class="du jp jq jr js b">5.316912e+36</code>中，GUIDs冲突的几率应该是1。那是一个巨大的熵空间。熵是系统中总信息量的一种度量。在唯一id的上下文中，更高的熵将导致更少的冲突，也使得攻击者更难猜出有效的id。如果您仍然使用UUID/GUID或数据库标识符作为主记录键，那么是时候重新评估了。</p><p id="ab3c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这一事件促使我创建了Cuid规范，该规范被移植到不同的语言超过20次，并用于数千种应用程序，其中一些应用程序拥有数亿用户。但是在过去十年的使用中，我意识到我做了错误的优化。不过，在我们深入探讨之前，我们需要一点背景知识。</p><p id="1bda" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">应用程序存储需要唯一标识的数据，以便可以引用和查找。为此，我们为数据创建唯一的标识符。</p><p id="88a9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一种解决方案是使用数据库自动增量id，但是当您的数据增长到无法存储在单个数据库主机上时，这种解决方案就失败了。不同的主机将生成已经在其他主机上使用的id。成功的现代应用程序会扩展到数亿或数十亿用户，每个用户都会生成数百条记录，每条记录都需要一个唯一的标识符。这些应用程序需要大量的服务器来处理需求。</p><p id="6191" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了解决这个问题，Instagram使用了一个分布式数据库系统来生成唯一的id。这允许水平可伸缩性，但也有一些缺点:</p><ul class=""><li id="72e7" class="jt ju hh ir b is it iw ix ja jv je jw ji jx jm jy jz ka kb bi translated">设置和维护是复杂的。</li><li id="b6e6" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">它很慢——当客户机需要创建一个新记录时，首先它需要从分布式id生成器请求一个新的id，这为每个记录的创建增加了一次额外的往返行程。</li><li id="877e" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">线下根本不行。为了创建任何包含id的新记录，客户端必须连接到互联网。</li></ul><p id="7469" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">另一种解决方案是使用UUIDs或GUIDs。但是UUIDs和GUIDs有它们自己的问题。它们很大，在破折号上浪费空间，它们不能在许多语言中用作标识符(使它们在许多数据结构中作为键不兼容)，最重要的是，尽管它们的名字听起来很响亮，理论上发生冲突的可能性很小，但它们经常生成重复的id。由于糟糕的伪随机算法，V4 UUID的一些旧实现无法在不产生冲突的情况下生成超过10k的ID。</p><p id="6d56" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Twitter Snowflake通过使用64位整数id解决了这些问题，该id由时间戳、工作id和序列号组成。Snowflake假设生成id的主机整齐地排列在唯一标识的workers中，但是如果您想在没有往返的客户机中生成id，情况就不是这样了。</p><h1 id="de1e" class="kh ki hh bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">解决方法</h1><p id="8d28" class="pw-post-body-paragraph ip iq hh ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">我们的理想解决方案必须是:</p><ul class=""><li id="016f" class="jt ju hh ir b is it iw ix ja jv je jw ji jx jm jy jz ka kb bi translated">安全的</li><li id="58a2" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">抗碰撞</li><li id="b813" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">水平可伸缩</li><li id="7971" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">脱机兼容</li><li id="9bd2" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">标识符兼容</li><li id="aae0" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">快速方便— Id生成不需要网络请求或异步熵</li></ul><h1 id="3bf6" class="kh ki hh bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">Ids必须安全</h1><p id="c86b" class="pw-post-body-paragraph ip iq hh ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">标识符安全性比以往任何时候都更重要，而Cuid做得还不够。</p><ul class=""><li id="261d" class="jt ju hh ir b is it iw ix ja jv je jw ji jx jm jy jz ka kb bi translated">Ids不应该泄露任何关于它所识别的信息的信息</li><li id="6e38" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">Ids不应该泄露生成该id的主机的任何信息</li><li id="9104" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">Ids不应该泄露记录数据的时间</li><li id="2ea6" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">给定其他有效id的样本，猜测另一个有效id应该是不可行的</li></ul><p id="493c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您在web上搜索不同的标识符标准，您可能会发现令人印象深刻的性能图表，这些图表讨论了顺序id对数据库性能的好处。10年前，我认为这比泄露时间戳、主机指纹或生成序列更重要。我错了。</p><p id="1cec" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">今天的应用程序更有可能保护有价值的数字资产、金钱、电子商务帐户的访问、私人数据等等。我们正在进入价值互联网时代，这意味着我们需要加强安全性。如果查找你的私人数据的人是黑客，那么60毫秒的服务器往返可能是30毫秒，这无关紧要。</p><h1 id="41e2" class="kh ki hh bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">Ids必须是抗碰撞的</h1><figure class="ll lm ln lo fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lk"><img src="../Images/90a113be1fdc5fc13edd271fa3a56b4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IpDhkwjN7n66PYp0.gif"/></div></div></figure><p id="7464" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Id冲突是有问题的，因为它们会导致应用程序:</p><ul class=""><li id="b271" class="jt ju hh ir b is it iw ix ja jv je jw ji jx jm jy jz ka kb bi translated">将他人的隐私数据泄露给错误的用户</li><li id="6b51" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">覆盖或丢失重要数据</li><li id="77f3" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">通过展示不正确的信息来迷惑或误导用户</li><li id="bd75" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">允许攻击者通过利用冲突统计猜测有效的标识符</li><li id="06da" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">如果系统必须不断地检查和处理冲突，性能会很差</li></ul><p id="2eae" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">避免冲突的一个好策略是包含各种熵源。这是因为当用于生成唯一标识符的所有熵源都相关或具有低熵(很少可能的值)时，更有可能发生冲突。熵的一些好来源包括:</p><ul class=""><li id="6c46" class="jt ju hh ir b is it iw ix ja jv je jw ji jx jm jy jz ka kb bi translated">当前系统时间</li><li id="17ab" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">伪随机值</li><li id="a0a6" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">会话计数器</li><li id="7c21" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">宿主指纹</li></ul><p id="ae01" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">每一个都是脆弱的。在流行的应用程序中，在同一毫秒内生成多个id是可能的。由于糟糕的随机数分布，伪随机值因<a class="ae jo" href="https://hackaday.com/2015/12/28/v8-javascript-fixes-horrible-random-number-generator/" rel="noopener ugc nofollow" target="_blank">产生碰撞</a>而<a class="ae jo" href="https://bugs.php.net/bug.php?id=70014" rel="noopener ugc nofollow" target="_blank">臭名昭著</a>。这不在某人自制的<code class="du jp jq jr js b">random()</code>函数中。</p><p id="7b45" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这些错误在PHP和JavaScript中存在了很多年。如果你觉得自己喜欢的编程语言更好，<a class="ae jo" href="https://codeforces.com/blog/entry/61587" rel="noopener ugc nofollow" target="_blank">再想想</a><a class="ae jo" href="https://github.com/dotnet/runtime/issues/23198" rel="noopener ugc nofollow" target="_blank"/>。类似地，我在几乎所有流行的编程语言的主随机函数中都发现了错误。现在很多错误都被修复了，但是冒险并不是一个好主意。如果你能增加比一个纯粹的伪随机发生器给你更多的熵，你绝对应该。</p><p id="1d86" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">许多id解决方案只是用当前系统时间作为随机值的前缀，但这实际上并没有改善熵，因为大多数伪随机发生器使用系统时间作为种子。你需要更多的非相关熵。每次生成新的id时，会话计数器都会增加一个计数器，这有助于保证在单个主机上生成的每个id都会产生一些熵变化。我将它添加到原始Cuid中，以防止在同一主机上的同一毫秒内生成多个id时发生冲突。</p><p id="3734" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">还有两个熵问题:单个会话计数器不能提供太多的熵，如果这就是一个id与下一个id之间的所有变化，那么很容易预测后续的id。最后一个问题是，如果您在许多不同的主机上生成许多id，您仍然可能会遇到冲突，因为不同主机上的会话计数器可能会相互重叠。换句话说，当许多不同的用户同时在许多不同的设备上使用该应用程序时，两个用户仍然可以同时生成相同的id——除非我们添加指纹来区分一个用户的设备和另一个用户的设备。那是宿主的指纹。</p><p id="b096" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Cuid2对指纹的JavaScript实现特别强大。它使用一个很长的全局变量名串，散列它们，用一个随机的盐和每个其他熵源混合它们的熵，使用一个不可能逆转的过程。想象一下，把一堆不同的水果块扔进搅拌机，然后混合在一起。一旦完成，就不可能只提取香蕉了。Cuid2从所有熵源制作熵思慕雪。</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lp"><img src="../Images/94573a967019c2d900aa36d99bf5b697.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cdtCr9WPCAl5nMsb.png"/></div></div></figure><p id="7e17" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一个好的id生成器应该产生随机均匀分布的id。换句话说，当您在图表上绘制输出时，它应该看起来像随机的静态噪声。应该不会太顺利。它不应该展示模式或结构。它应该看起来像随机分布的静态噪声。这是Cuid2的随机图:</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/e021613fb0b56a9e26c9b9e07b85ffe9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kGN_IkZMogCHb9RlGWnu8g.png"/></div></div></figure><p id="00e4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">均匀随机分布的另一个测试是直方图。要生成一个，将生成的id转换成数字，将总熵范围分成大小相等的桶，然后生成许多id，并根据数字的值将它们分类到桶中。结果应该是相当均匀的，但顶部有点颠簸。直方图中不应有任何明显的大峰值或缺口。这是Cuid2的直方图:</p><figure class="ll lm ln lo fd ii er es paragraph-image"><div class="er es lq"><img src="../Images/403bda598ef685c1e14eedd774121d6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*DT5eOGlX62_k9445HKQgVw.png"/></div></figure><h1 id="c925" class="kh ki hh bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">关键要点</h1><p id="e231" class="pw-post-body-paragraph ip iq hh ir b is lf iu iv iw lg iy iz ja lh jc jd je li jg jh ji lj jk jl jm ha bi translated">现代应用程序需要唯一的id，能够无冲突地扩展到大型用户群，处理多台服务器，并且可以离线使用。它们必须是安全的。</p><ul class=""><li id="f915" class="jt ju hh ir b is it iw ix ja jv je jw ji jx jm jy jz ka kb bi translated">UUIDs和GUIDs在大小、格式、语言兼容性和不良随机化方面存在问题，从而导致冲突和安全问题。</li><li id="c0d6" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">服务器管理的ids导致往返缓慢，并使离线操作变得复杂。</li><li id="28dc" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">最初的Cuid规范解决了许多这样的问题，但是它在安全性方面做得不够好。</li><li id="6f10" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">后续的Cuid2通过使用一个微小但分布良好的单向哈希函数来组合许多熵源，从而解决了这些问题。散列步骤防止ids泄漏可能被黑客用来攻击系统或用户私人数据的信息。</li><li id="af52" class="jt ju hh ir b is kc iw kd ja ke je kf ji kg jm jy jz ka kb bi translated">Cuid2是一个安全、抗冲突、可水平扩展、脱机兼容的解决方案，用于生成唯一的id。</li></ul><p id="dcf3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">就像原来的Cuid一样，它很小。包括哈希函数在内，Cuid2的重量不到5k，gzipped。</p></div><div class="ab cl lr ls go lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ha hb hc hd he"><p id="753f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi"> <em class="jn">埃里克·艾略特</em> </strong> <em class="jn">是一位科技产品和平台顾问，《T5】 <a class="ae jo" href="https://leanpub.com/composingsoftware" rel="noopener ugc nofollow" target="_blank"> <em class="jn">【作曲软件】</em></a><em class="jn"/><a class="ae jo" href="https://ericelliottjs.com/" rel="noopener ugc nofollow" target="_blank"><em class="jn">【EricElliottJS.com】</em></a><em class="jn"/><a class="ae jo" href="https://devanywhere.io/" rel="noopener ugc nofollow" target="_blank"><em class="jn">devanywhere . io</em></a><em class="jn">的联合创始人，以及dev团队导师。他曾为Adobe Systems、</em> <strong class="ir hi"> <em class="jn">、Zumba Fitness、</em> </strong> <em class="jn"> </em> <strong class="ir hi"> <em class="jn">【华尔街日报、</em></strong><em class="jn"/><strong class="ir hi"><em class="jn">【ESPN、</em></strong><em class="jn"/><strong class="ir hi"><em class="jn">【BBC】</em></strong><em class="jn">等顶级录音艺人和包括</em> <strong class="ir hi"> <em class="jn"> Usher、【Metallica】</em></strong></em></p><p id="83f6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">他和世界上最美丽的女人享受着与世隔绝的生活方式。</p></div></div>    
</body>
</html>