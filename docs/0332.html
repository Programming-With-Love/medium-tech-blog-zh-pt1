<html>
<head>
<title>Building a video player app in Android (Part 2 / 5)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Android中构建视频播放器应用程序(第2 / 5部分)</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/building-a-video-player-app-in-android-part-2-5-e5a5392879fa?source=collection_archive---------4-----------------------#2018-03-09">https://medium.com/androiddevelopers/building-a-video-player-app-in-android-part-2-5-e5a5392879fa?source=collection_archive---------4-----------------------#2018-03-09</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="1c97" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">使用ExoPlayer、播放列表、媒体会话、音频聚焦、画中画</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/2eed2a5c9bda533975efea4a4131b83e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UJISwRlkYE8nJzVJdudikw.png"/></div></div></figure><p id="8ff9" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">本系列文章的目标是让您开始使用ExoPlayer构建一个简单但功能丰富的视频播放器应用程序(支持播放列表、媒体会话、音频焦点和画中画)。</p><p id="2164" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这是5部分系列的第二部分，包括:</p><ul class=""><li id="db2f" class="ke kf hh jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/@nazmul/building-a-video-player-app-in-android-part-1-5-d95770ef762d"> ExoPlayer简介</a></li><li id="cfa1" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated">ExoPlayer播放列表、UI定制和事件(<strong class="jk hi">本文</strong>)</li><li id="ef2e" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/@nazmul/building-a-video-player-app-in-android-part-3-5-19543ea9d416">exo player的MediaSession连接器扩展</a></li><li id="c2a6" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/@nazmul/building-a-video-player-app-in-android-part-4-5-c69f12b49143">支持音频聚焦</a></li><li id="f7ef" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/@nazmul/building-a-video-player-app-in-android-part-5-5-725c1ec2557a">支持PIP </a></li></ul><p id="ce0e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">本系列的第一篇文章介绍了创建ExoPlayer实例并将其附加到应用程序的UI以允许视频播放所需的步骤。它还介绍了如何将ExoPlayer与您的生命周期联系起来。本文将详细介绍如何通过连接<code class="du kt ku kv kw b">MediaSource</code>来创建播放列表，并向您展示如何定制ExoPlayer的播放控制UI。</p><h1 id="e70d" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">创建播放列表</h1><p id="2095" class="pw-post-body-paragraph ji jj hh jk b jl lp ii jn jo lq il jq jr lr jt ju jv ls jx jy jz lt kb kc kd ha bi translated">不用给玩家提供一个<code class="du kt ku kv kw b">ExtractorMediaSource</code>(如上面的<code class="du kt ku kv kw b">buildMediaSource(Uri)</code>方法所示)，你可以简单地创建一个<code class="du kt ku kv kw b">DynamicConcatenatingMediaSource</code>，其中可以包含任意数量的<code class="du kt ku kv kw b">MediaSource</code>对象。这里有一个例子。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="lu lv l"/></div></figure><p id="cfa4" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><code class="du kt ku kv kw b">DynamicConcatenatingMediaSource</code>创建动态播放列表。如果你想要一个静态播放列表，那么你可以使用<code class="du kt ku kv kw b">ContactenatingMediaSource</code>。它们都将无缝地组合媒体源，并处理整个播放列表的缓冲。要了解更多关于<code class="du kt ku kv kw b">MediaSource</code>构图的细节，请阅读这篇<a class="ae kn" rel="noopener" href="/google-exoplayer/dynamic-playlists-with-exoplayer-6f53e54a56c0">中的文章</a>。</p><h1 id="e92b" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">自定义用户界面</h1><p id="1d36" class="pw-post-body-paragraph ji jj hh jk b jl lp ii jn jo lq il jq jr lr jt ju jv ls jx jy jz lt kb kc kd ha bi translated">为了查看您的应用程序使用ExoPlayer加载的视频内容，您必须向创建ExoPlayer实例和加载媒体的活动添加一个<code class="du kt ku kv kw b">PlayerView</code>。通过将您的ExoPlayer实例分配给<code class="du kt ku kv kw b">PlayerView</code>的Player属性，您可以将该视图附加到ExoPlayer实例。</p><p id="156d" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">下面是一个显示<code class="du kt ku kv kw b">PlayerView</code>的活动的布局XML示例。带有“<code class="du kt ku kv kw b">app:</code>”名称空间的属性允许您将配置参数传递给视图，以便您可以根据自己的喜好定制它的行为。您可以控制视频快进或快退的增量(以毫秒为单位),以及许多其他事情。您可以在<a class="ae kn" href="http://google.github.io/ExoPlayer/doc/reference/index.html?com/google/android/exoplayer2/ui/SimpleExoPlayerView.html" rel="noopener ugc nofollow" target="_blank"> ExoPlayer javadocs </a>中找到所有这些属性及其作用的列表。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="lu lv l"/></div></figure><p id="8041" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">除非用<code class="du kt ku kv kw b">app:use_controller=”false”</code>禁用控制器，<code class="du kt ku kv kw b">PlayerView</code>会自动显示一个媒体控制器UI，允许用户播放、暂停、跳到下一个等等。通过在<code class="du kt ku kv kw b">show_timeout</code>属性中设置超时值，您可以定制控制器在自动隐藏之前显示的时间。</p><p id="843b" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">为了定制控制器UI本身，有一个属性“<code class="du kt ku kv kw b">controller_layout_id</code>”，它允许我们选择一个布局文件，其中包含对控制器UI本身的任何定制。这里有一个例子。</p><figure class="ix iy iz ja fd jb"><div class="bz dy l di"><div class="lu lv l"/></div></figure><p id="0317" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这将产生一个类似下图的媒体控制器用户界面。UI控制器覆盖在<code class="du kt ku kv kw b">PlayerView</code>本身的前面。您可以添加或删除播放、暂停、倒带、跳过等按钮。ExoPlayer之所以知道你想使用你的组件而不是默认组件，是因为你使用了ExoPlayer本身提供的id，比如播放按钮、暂停按钮、跳到下一个按钮等等。为了了解更多关于定制<code class="du kt ku kv kw b">PlayerView</code>和UI控制器的信息，请阅读这篇<a class="ae kn" rel="noopener" href="/google-exoplayer/customizing-exoplayers-ui-components-728cf55ee07a">中型文章</a>。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lw"><img src="../Images/6c855d44e0776b0260cde0334ffeb828.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fPF7rX2fVJC0hsdn."/></div></div></figure><h1 id="2299" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">收听UX的玩家事件</h1><p id="9b7b" class="pw-post-body-paragraph ji jj hh jk b jl lp ii jn jo lq il jq jr lr jt ju jv ls jx jy jz lt kb kc kd ha bi translated">ExoPlayer通过<code class="du kt ku kv kw b">ExoPlayer.EventListener</code>接口提供了大量关于其内部状态的有价值的信息。您可以在代码中实现这个接口或子类<code class="du kt ku kv kw b">Player.DefaultEventListener</code>，以便在玩家状态改变时得到通知。此外，您可以实现<code class="du kt ku kv kw b">VideoRendererEventListener</code>和<code class="du kt ku kv kw b">AudioRendererEventListener</code>来获得关于音频和视频渲染的更多细节。综合使用这些信号，你可以了解应用程序的用户体验质量(QoE)受到了怎样的影响。</p><p id="2c88" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">以下是几个例子:</p><ul class=""><li id="0597" class="ke kf hh jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated">当不在播放开始期间用<code class="du kt ku kv kw b">STATE_BUFFERING</code>调用<code class="du kt ku kv kw b">ExoPlayer.EventListener.OnPlaybackStateChanged()</code>时，或者当用户请求寻找一个尚不可用的位置时，这被认为对QoE有害。</li><li id="3da7" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated">执行<code class="du kt ku kv kw b">ExoPlayer.VideListener.onFirstFrameRendered</code>所需的时间(相对于用户在应用程序中启动回放的时间)是回放初始延迟的信号。对于良好的QoE，这应该尽可能低。</li><li id="df00" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><code class="du kt ku kv kw b">VideoRendererEventListener.onDroppedFrames</code>提供关于丢帧的信息。太多这样的事情会对QoE产生负面影响。</li></ul><p id="f2b9" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这些文章不会详细讨论ExoPlayer中的事件监听。要更深入地了解ExoPlayer的事件监听器以及QoE信号，请务必阅读<a class="ae kn" href="https://codelabs.developers.google.com/codelabs/exoplayer-intro/#5" rel="noopener ugc nofollow" target="_blank"> ExoPlayer codelab </a>的测量QoE部分。要深入了解如何检测播放器何时缓冲、暂停或实际播放媒体，请参考这篇<a class="ae kn" href="https://stackoverflow.com/questions/47731779/detect-pause-resume-in-exoplayer/48067205#48067205" rel="noopener ugc nofollow" target="_blank"> stackoverflow帖子</a>。</p><h1 id="d28b" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">自适应流</h1><p id="e124" class="pw-post-body-paragraph ji jj hh jk b jl lp ii jn jo lq il jq jr lr jt ju jv ls jx jy jz lt kb kc kd ha bi translated">ExoPlayer不仅支持从APK和网络加载媒体文件，还广泛支持自适应流媒体。自适应流将视频和音频文件切割成给定持续时间的小块。然后ExoPlayer将它们缝合在一起进行播放。这些块中的每一个都可以有不同的质量(大小或比特率)。播放器可以根据设备能力和可用的网络带宽来选择每个块的质量。播放器以较低质量的块开始，然后如果更多带宽变得可用，则切换到较好的块(例如，从慢速移动网络切换到快速WiFi网络)。</p><p id="5f74" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在这篇<a class="ae kn" href="https://developer.mozilla.org/en-US/Apps/Fundamentals/Audio_and_video_delivery/Setting_up_adaptive_streaming_media_sources" rel="noopener ugc nofollow" target="_blank"> MDN文章</a>中，您可以了解有关HLS (HTTP直播流)、MPEG-DASH(基于HTTP的动态自适应流)和SmoothStreaming的更多信息。要了解更多关于DASH和HLS的区别，请查看ExoPlayer博客上的这篇<a class="ae kn" rel="noopener" href="/google-exoplayer/test-8b62d50362ef">文章。这些文章不会深入探讨如何使用ExoPlayer进行自适应流式传输，但是如果你想更深入地了解这一点，请浏览</a><a class="ae kn" href="https://codelabs.developers.google.com/codelabs/exoplayer-intro/#4" rel="noopener ugc nofollow" target="_blank"> ExoPlayer codelab </a>的自适应流式传输部分。</p><h1 id="acf4" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">GitHub上的源代码</h1><p id="33e2" class="pw-post-body-paragraph ji jj hh jk b jl lp ii jn jo lq il jq jr lr jt ju jv ls jx jy jz lt kb kc kd ha bi translated">通过遵循这5篇文章，你应该能够创建一个视频播放器应用程序，类似于我们已经创建的这个示例(你也可以从Android Studio获得)。</p><div class="lx ly ez fb lz ma"><a href="https://github.com/googlesamples/android-VideoPlayer" rel="noopener  ugc nofollow" target="_blank"><div class="mb ab dw"><div class="mc ab md cl cj me"><h2 class="bd hi fi z dy mf ea eb mg ed ef hg bi translated">谷歌样品/安卓视频播放器</h2><div class="mh l"><h3 class="bd b fi z dy mf ea eb mg ed ef dx translated">在GitHub上创建一个帐户，为android视频播放器的开发做出贡献。</h3></div><div class="mi l"><p class="bd b fp z dy mf ea eb mg ed ef dx translated">github.com</p></div></div><div class="mj l"><div class="mk l ml mm mn mj mo jg ma"/></div></div></a></div><h1 id="115b" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">进一步学习的资源</h1><p id="d56c" class="pw-post-body-paragraph ji jj hh jk b jl lp ii jn jo lq il jq jr lr jt ju jv ls jx jy jz lt kb kc kd ha bi translated"><strong class="jk hi"> ExoPlayer </strong></p><ul class=""><li id="7671" class="ke kf hh jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated"><a class="ae kn" href="https://codelabs.developers.google.com/codelabs/exoplayer-intro/#0" rel="noopener ugc nofollow" target="_blank"> IO17 ExoPlayer codelab </a></li><li id="4498" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" href="https://www.youtube.com/watch?v=6VjF638VObA" rel="noopener ugc nofollow" target="_blank"> IO14 ExoPlayer介绍视频</a></li><li id="5905" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" href="https://www.youtube.com/watch?v=jAZn-J1I8Eg" rel="noopener ugc nofollow" target="_blank"> IO17 ExoPlayer会话视频</a></li><li id="fdb2" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/google-exoplayer/exoplayer-2-x-why-what-and-when-74fd9cb139">为什么选择ExoPlayer？</a></li><li id="e16a" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/google-exoplayer/exoplayer-2-6-1-whats-new-a9e54bffffc5">exo player v 2 . 6 . 1的最新变化</a></li></ul><p id="9c14" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi">媒体会话，音频焦点</strong></p><ul class=""><li id="0871" class="ke kf hh jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/google-exoplayer/the-mediasession-extension-for-exoplayer-82b9619deb2d">exo player的MediaSession扩展</a></li><li id="af13" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/google-developers/understanding-mediasession-part-1-3-e4d2725f18e4">什么是媒体会话</a></li><li id="f69c" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/google-developers/audio-focus-1-6b32689e4380">什么是音频焦点</a></li></ul><p id="8671" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">破折号，HLS </p><ul class=""><li id="ebe0" class="ke kf hh jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated"><a class="ae kn" href="https://goo.gl/r9fXXf" rel="noopener ugc nofollow" target="_blank">破折号，HLS </a></li><li id="8321" class="ke kf hh jk b jl ko jo kp jr kq jv kr jz ks kd kj kk kl km bi translated"><a class="ae kn" href="https://goo.gl/SNvMgQ" rel="noopener ugc nofollow" target="_blank"> Dash优于HLS等</a></li></ul><p id="2650" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi">画中画</strong></p><ul class=""><li id="7098" class="ke kf hh jk b jl jm jo jp jr kg jv kh jz ki kd kj kk kl km bi translated"><a class="ae kn" rel="noopener" href="/google-developers/making-magic-moments-with-picture-in-picture-e02964bf75ae">奥利奥中的画中画模式</a></li></ul></div></div>    
</body>
</html>