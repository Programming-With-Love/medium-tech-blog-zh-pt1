# MySQL 性能优化:工作量增加 50%，延迟差异减少 60%

> 原文：<https://medium.com/pinterest-engineering/mysql-performance-optimization-50-more-work-with-60-less-latency-variance-d9c4328549c6?source=collection_archive---------0----------------------->

Ernie Souhrada | Pinterest 工程师

当我加入 Pinterest 时，我的前三周是在大本营度过的，在那里，最新的工程人员处理整个软件栈的实际生产问题。在大本营，我们通过构建 Pinterest 来了解它是如何构建的，在短短几天内编写代码并做出有意义的贡献并不少见。在 Pinterest，新雇佣的工程师可以灵活地选择他们将加入哪个团队，作为大本营体验的一部分，在代码的不同部分工作可以帮助做出这个决定。基本露营者通常从事各种各样的任务，但是我的项目是一个 MySQL 性能优化项目的深入研究。

## Pinterest，MySQL 和 AWS，天啊！

我们使用完全运行在亚马逊网络服务(AWS)内部的 MySQL。尽管使用了相当高性能的实例类型和 RAID-0 固态硬盘以及相当简单的工作负载(通过 PK 或简单范围选择多个点),峰值约为 2，000 QPS，但我们始终无法实现预期的 IO 性能水平。超过大约 800 个写 IOPS 将导致不可接受的延迟和复制延迟增加，并且这种复制延迟或从属服务器上不充分的读取性能将降低 ETL 和批处理作业的速度，这将对依赖这些作业的任何其他团队产生下游影响。唯一可用的选择是要么使用更大的实例规模，从而使我们的成本翻倍并降低我们的效率，要么找到使现有系统性能更好的方法。

我从我的同事 Rob Wultsch 那里接管了这个项目，他已经有了重大发现，当在 AWS 内部的 SSD 上运行时，Linux 内核版本似乎非常重要。Ubuntu 12.04 附带的默认 3.2 内核并没有削减它，AWS 推荐作为最低版本的 3.8 内核也没有削减它(尽管它仍然比 3.2 快两倍多)。在内核为 3.2 的 i2.2xlarge(固态硬盘的双磁盘 RAID-0)实例上运行 sysbench 只能达到 100 MB/秒的 16K 随机写入。在相同的测试中，将内核升级到 3.8 让我们达到了 350 MB/秒，但这仍然比预期的要低得多。从这样一个简单的变化中看到这种改进，引出了许多新的问题和关于其他低效和糟糕配置选项的假设:我们能从一个更新的内核中获得更好的性能吗？我们应该在操作系统级别更改其他设置吗？my.cnf 中有优化吗？怎样才能让 MySQL 走得更快？

为了寻找答案，我用不同的内核、文件系统、挂载选项和 RAID 块大小设置了近 60 种不同的 sysbench fileIO 测试配置。从这些实验中选择了最合适的配置后，我又用其他系统组合运行了大约 20 次 sysbench OLTP。基本的测试方法在所有试验中都是相同的:运行测试一个小时，以一秒的间隔收集指标，然后去掉前 600 秒以考虑缓存预热时间，并处理剩余的时间。在确定了最佳配置后，我们重建了最大、最关键的服务器，并将这些更改部署到生产中。

## 从 5000 QPS 到 26000 QPS:无需扩展硬件即可扩展 MySQL 性能

让我们通过 p99 响应时间和几种不同配置的 16 线程和 32 线程的吞吐量指标，来看看这些变化对一些基本 sysbench OLTP 测试的影响。

以下是每个数字所代表的含义:

*   当前:3.2 内核和标准 MySQL 配置
*   股票:标准 MySQL 配置的 3.18 内核
*   内核:3.18 内核，对 IO/内存 sysctl 做了一些调整
*   MySQL: 3.18 内核，优化了 MySQL 配置
*   KERN + MySQL: 3.18 内核，对#3 和#4 进行了调整
*   KERN + JE: 3.18 内核，有来自#3 和 jemalloc 的调整
*   MySQL + JE: 3.18 内核，带有来自#4 和 jemalloc 的 MySQL 配置
*   ALL: 3.18 内核，带#3、#4 和 jemalloc

当我们启用所有优化时，我们发现我们可以在 16 和 32 线程上实现大约 500%的读写吞吐量，同时在两个方向上将 p99 延迟减少超过 500 毫秒。在读取方面，我们从大约 4100–4600 QPS 到略高于 22000–25000，具体取决于并发性。在写入端，我们从大约 1000 QPS 到 5100–6000 QPS。只需几处简单的改动，就能获得巨大的扩展空间和性能提升。

当然，如果没有转化为真实世界的结果，世界上所有的合成基准都没有多大意义。下图从客户端和服务器的角度显示了从升级前几天到所有主服务器升级后几天的主集群延迟。这一过程仅用了一周时间就完成了。

红线代表客户端感知的延迟，绿线代表服务器测量的延迟。从客户端的角度来看，p99 延迟从异常值超过 100 毫秒的高度可变的 15-35 毫秒下降到异常值为 80 毫秒或更少的相当平稳的 15 毫秒。服务器测量的延迟也从波动的 5-15 毫秒下降到基本持平的 5 毫秒，由于系统维护，每天有 18 毫秒的峰值。此外，自今年年初以来，我们在这些集群上的峰值吞吐量增加了约 50%，因此我们不仅处理了更多的负载(仍远低于我们的估计容量)，而且吞吐量更好、更可预测。此外，对于每个喜欢一觉睡到天亮的人来说，这只能被称为好消息，与系统性能或一般服务器过载具体相关的可分页事件的数量从 3 月份的 300 多起下降到 4 月和 5 月合计的不到 10 起。

有关更多信息，包括我们的 MySQL 和操作系统配置的前后细节，请查看来自“[您的所有 IOPS 都属于我们](http://www.slideshare.net/denshikarasu/all-your-iops-are-belong-to-us-a-pinteresting-case-study-in-mysql-performance-optimization)”的幻灯片，这是我在 2015 Percona Live MySQL 会议/博览会上的演讲，请继续关注我们如何充分利用 MySQL、Redis 和其他存储技术的更多见解。

*Ernie Souhrada 是云工程团队 SRE 团队的一名数据库工程师。*

*获取 Pinterest 工程新闻和更新，关注我们的工程*[*Pinterest*](https://www.pinterest.com/malorie/pinterest-engineering-news/)*，* [*脸书*](https://www.facebook.com/pinterestengineering) *和* [*推特*](https://twitter.com/PinterestEng) *。有兴趣加入团队吗？查看我们的* [*招聘网站*](https://about.pinterest.com/en/careers/engineering-product) *。*