<html>
<head>
<title>Today I Learned: Text Search on MongoDB using Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">今天我学习了:使用Golang在MongoDB上进行文本搜索</h1>
<blockquote>原文：<a href="https://medium.easyread.co/today-i-learn-text-search-on-mongodb-6b87cd8497c9?source=collection_archive---------2-----------------------#2018-10-19">https://medium.easyread.co/today-i-learn-text-search-on-mongodb-6b87cd8497c9?source=collection_archive---------2-----------------------#2018-10-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/bf5fb825e87f4236ad99a9b18c763be2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9hDoIhwQXmAELyl3"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">“person holding folders” by <a class="ae jz" href="https://unsplash.com/@annietheby?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Annie Theby</a> on <a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="1e53" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi ky translated">当搜索一组<strong class="kc io">文章</strong>时，我们通常会使用许多过滤器，如标题、日期、类别等。但是这些是找到它的最基本最简单的方法。</p><p id="d5a9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如何找到一篇带有<em class="lh">关键词</em>过滤器的文章，该过滤器基于文章<strong class="kc io">的标题、内容和其他成分加入</strong>？</p><p id="c8fd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">是的，上面有一个关于我们想做什么的方法，叫做<strong class="kc io">文本搜索</strong>。</p><p id="d00a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">和大多数人一样，当我第一次遇到这个问题时，我开始通过在谷歌上搜索来寻找解决问题的方法。</p><figure class="lj lk ll lm gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi li"><img src="../Images/ec9d83734281a8d37e7c2d4c5cc0f36f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d4hiUapabGyUcC5K2IEyuw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">what is text search, google?</figcaption></figure><p id="c3bd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">到目前为止，有2个著名的应用程序解决了我的问题。分别是<a class="ae jz" href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank"><strong class="kc io">elastic search</strong></a>和<a class="ae jz" href="https://www.mongodb.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="kc io"> MongoDB </strong> </a>。在谷歌了一遍之后，我发现Elasticsearch在文本搜索方面比MongoDB更好，因为它是一个搜索引擎，你可以有很多配置来优化你的文本搜索。Elasticsearch非常强大，它非常适合我的问题。但是对于我目前的项目，我认为使用Elasticsearch比技术更难。所以我决定先使用MongoDB，直到我需要改进我的搜索功能。</p><p id="346d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们去代码区吧！</p><figure class="lj lk ll lm gt jo gh gi paragraph-image"><div class="gh gi ln"><img src="../Images/52363793c2f1b1e9c3704a95ed4d93bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/1*byd_7mPRMt2_I_B6V22FQw.gif"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Gopher from Google</figcaption></figure><p id="b08c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">对于代码部分，我使用Golang作为编程语言。如果你不熟悉它，我建议你试试这种神奇的编程语言。我使用Go版本1.10.3和<a class="ae jz" href="https://github.com/golang/dep" rel="noopener ugc nofollow" target="_blank"> Dep </a>作为依赖管理器，使用<a class="ae jz" href="https://github.com/globalsign/mgo" rel="noopener ugc nofollow" target="_blank">https://github.com/globalsign/mgo</a>作为Golang上的MongoDB客户端。你可能会问我为什么不使用Golang的官方MongoDB客户端。我选择使用这个包，因为这个包是mgo 的一个分支(遗憾的是已经没有维护过了)，mgo被证明是可靠的MongoDB客户端。除此之外，官方的MongoDB驱动程序仍然处于alpha状态。</p><p id="08e2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">要在MongoDB上启用文本搜索特性，您必须创建一个文本索引并使用$text操作符。在MongoDB上创建文本索引非常简单，您可以在Mongo CLI上这样做。</p><pre class="lj lk ll lm gt lo lp lq lr aw ls bi"><span id="b09e" class="lt lu in lp b gy lv lw l lx ly">db.article.createIndex( { title: “text” } )</span></pre><p id="6c4e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在这段代码中，您创建了一个索引，它将<code class="fe lz ma mb lp b">title</code>字段标记为文本索引。您还可以将多个字段定义为文本索引，如下所示。</p><pre class="lj lk ll lm gt lo lp lq lr aw ls bi"><span id="0d11" class="lt lu in lp b gy lv lw l lx ly">db.article.createIndex(<br/>   {<br/>     title: "text",<br/>     content: "text"<br/>   }<br/> )</span></pre><p id="5f20" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在每个领域已经变得可搜索，你可以根据这些领域的一些关键字搜索一些文章，但如果你要优先考虑一个领域，你可以应用权重。当应用过滤器时，该权重对评分过程很重要。要定义每个字段的权重，可以这样写。</p><pre class="lj lk ll lm gt lo lp lq lr aw ls bi"><span id="6661" class="lt lu in lp b gy lv lw l lx ly">db.article.createIndex(<br/>   {<br/>     title: "text",<br/>     content: "text"<br/>   },<br/>   {<br/>     weights: {<br/>       title: 9,<br/>       content: 3<br/>     }<br/>   }<br/>)</span></pre><p id="c904" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">就这一点而言，在得分方面，<code class="fe lz ma mb lp b">title</code>比<code class="fe lz ma mb lp b">content</code>重要3倍。示例中有两篇文章，第一篇是这样的:</p><pre class="lj lk ll lm gt lo lp lq lr aw ls bi"><span id="20b8" class="lt lu in lp b gy lv lw l lx ly">Title: Kurio is Moving to New Office</span><span id="2bed" class="lt lu in lp b gy mc lw l lx ly">Content: Kurio, one of the best news aggregator application in Indonesia is having a new office. Now they have their own playground to make their app even better!</span></pre><p id="a148" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">第二个:</p><pre class="lj lk ll lm gt lo lp lq lr aw ls bi"><span id="ed23" class="lt lu in lp b gy lv lw l lx ly">Title: A Big News Startup is Moving to New Office</span><span id="ca06" class="lt lu in lp b gy mc lw l lx ly">Content: Kurio, one of the best news aggregator application in Indonesia is having a new office. Now they have their own playground to make their app even better!</span></pre><p id="aba2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果您应用这些权重选项，第一篇文章将比第二篇文章得分高。如果你进行查询，你会得到第一篇文章的结果，然后是第二篇文章。</p><p id="2cec" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">MongoDB将自动命名您的索引，但是自己命名也不错，对吧？</p><pre class="lj lk ll lm gt lo lp lq lr aw ls bi"><span id="426e" class="lt lu in lp b gy lv lw l lx ly">db.article.createIndex(<br/>   {<br/>     title: "text",<br/>     content: "text"<br/>   },<br/>   {<br/>     weights: {<br/>       title: 9,<br/>       content: 3<br/>     },<br/>     name: "textIndex"<br/>   }<br/>)</span></pre><p id="476f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">对于Golang实现，可以这样写:</p><pre class="lj lk ll lm gt lo lp lq lr aw ls bi"><span id="c67f" class="lt lu in lp b gy lv lw l lx ly">c := session.DB("article_database").C("article")</span><span id="4abc" class="lt lu in lp b gy mc lw l lx ly">index := mgo.Index{<br/>    Key: []string{"$text:title", "$text:content"},<br/>    Weights: map[string]int{<br/>          "title":   9,<br/>          "content": 3,<br/>    },<br/>    Name: "textIndex",<br/>}</span><span id="b6f5" class="lt lu in lp b gy mc lw l lx ly">c.EnsureIndex(index)</span></pre><p id="5947" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">创建文本索引后，可以使用$text操作符在集合中直接搜索或应用过滤器。在MongoDB CLI中，您可以这样写:</p><pre class="lj lk ll lm gt lo lp lq lr aw ls bi"><span id="d5cb" class="lt lu in lp b gy lv lw l lx ly">db.article.find( { $text: { $search: "Pemilu Indonesia 2019" } } )</span></pre><p id="fc53" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这是Go的实现:</p><pre class="lj lk ll lm gt lo lp lq lr aw ls bi"><span id="4e4e" class="lt lu in lp b gy lv lw l lx ly">articles := []Article{}</span><span id="8ee4" class="lt lu in lp b gy mc lw l lx ly">query := bson.M{<br/>    "$text": bson.M{<br/>    "$search": "Pemilu Indonesia 2019",<br/>   },<br/>}</span><span id="6899" class="lt lu in lp b gy mc lw l lx ly">err := sess.DB("article_database").C("article").Find(query).All(&amp;articles)</span><span id="e6c9" class="lt lu in lp b gy mc lw l lx ly">if err != nil {<br/>   return err<br/>}</span></pre><p id="8357" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">默认情况下，MongoDB不会对查询结果进行排序。但是文本搜索查询已经基于数据与那些查询的匹配程度来计算相关性分数。所以，我应用了基于分数的排序。下面是如何在MongoDB CLI上实现这一点:</p><pre class="lj lk ll lm gt lo lp lq lr aw ls bi"><span id="690c" class="lt lu in lp b gy lv lw l lx ly">db.article.find(<br/>   { $text: { $search: "Pemilu Indonesia 2019" } },<br/>   { score: { $meta: "textScore" } }<br/>).sort( { score: { $meta: "textScore" } } )</span></pre><p id="d7f8" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Go实现也不复杂:</p><pre class="lj lk ll lm gt lo lp lq lr aw ls bi"><span id="4b4b" class="lt lu in lp b gy lv lw l lx ly">articles := []Article{}</span><span id="f45b" class="lt lu in lp b gy mc lw l lx ly">query := bson.M{<br/>    "$text": bson.M{<br/>    "$search": "Pemilu Indonesia 2019",<br/>   },<br/>}</span><span id="1a29" class="lt lu in lp b gy mc lw l lx ly">err := sess.DB("article_database").C("article").Find(query).Sort(bson.M{<br/>  "score": bson.M{<br/>     "$meta": "textScore",<br/>  },<br/>}).All(&amp;articles)</span><span id="faa9" class="lt lu in lp b gy mc lw l lx ly">if err != nil {<br/>   return err<br/>}</span></pre><p id="14c9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">就是这样！现在你有了一个简单而有效的<strong class="kc io">文本搜索</strong>用于你的应用。</p></div><div class="ab cl md me hr mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ig ih ii ij ik"><figure class="lj lk ll lm gt jo"><div class="bz fp l di"><div class="mk ml l"/></div></figure></div></div>    
</body>
</html>