<html>
<head>
<title>Oracle Container Engine for Kubernetes (OKE) Supports Custom Worker Node Start Up Scripts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Oracle Container Engine for Kubernetes(OKE)支持自定义工作节点启动脚本</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/oci-container-engine-for-kubernetes-oke-supports-custom-worker-node-start-up-scripts-78e717ffe0f8?source=collection_archive---------1-----------------------#2022-01-25">https://medium.com/oracledevs/oci-container-engine-for-kubernetes-oke-supports-custom-worker-node-start-up-scripts-78e717ffe0f8?source=collection_archive---------1-----------------------#2022-01-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/ae00341a31548169e76d7e19c1086b7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MTUwTqLY7qSulrdJVSAFZA.jpeg"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">Use start up scripts to tailor-make worker nodes that match your workloads</figcaption></figure><div class=""/><h1 id="dcd0" class="it iu hw bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">介绍</h1><p id="b564" class="pw-post-body-paragraph jr js hw jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated"><a class="ae kp" href="https://docs.oracle.com/en-us/iaas/Content/ContEng/home.htm#top" rel="noopener ugc nofollow" target="_blank">用于Kubernetes的Oracle容器引擎(OKE) </a>现在支持使用启动脚本定制<a class="ae kp" href="https://kubernetes.io/docs/concepts/architecture/nodes/" rel="noopener ugc nofollow" target="_blank"> Kubernetes工作节点</a>。该功能使用户能够更好地控制运行Kubernetes工作负载的worker节点主机的配置。</p><h1 id="67bf" class="it iu hw bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">背景</h1><p id="08aa" class="pw-post-body-paragraph jr js hw jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">Cloud-init是初始化和配置云实例的行业标准方法。它受到所有主要公共云提供商、私有云基础架构的配置系统和裸机安装的支持。有关云初始化的更多信息，请参见<a class="ae kp" href="https://cloudinit.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">云初始化文档</a>。</p><p id="3838" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">OKE在每个<a class="ae kp" href="https://docs.oracle.com/en-us/iaas/Content/Compute/home.htm" rel="noopener ugc nofollow" target="_blank"> Oracle云基础设施(OCI)计算实例</a>上安装一个默认的cloud-init启动脚本，用于将该实例配置为Kubernetes工作节点。当实例第一次启动时，cloud-init脚本运行。默认启动脚本包含以下逻辑:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="024b" class="le iu hw la b fi lf lg l lh li">#!/bin/bash<br/>curl --fail -H "Authorization: Bearer Oracle" -L0 <a class="ae kp" href="http://169.254.169.254/" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/</a><br/>opc/v2/instance/metadata/oke_init_script | base64 --decode &gt;/var/run/oke-<br/>init.sh<br/>bash /var/run/oke-init.sh</span></pre><p id="9bb4" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">OKE设置的默认主机配置不一定匹配每个用户的用例，这可能导致用户需要对工作节点进行自己的定制。以前，用户可以通过SSH连接到工作节点，进行更改，然后将这些更改保存为自定义映像，用作未来工作节点的模板，从而一次自定义一个工作节点或按比例自定义工作节点。然而，这种方法的运营成本很高:每当发布新的映像时，用户都需要创建新的自定义映像。相比之下，支持自定义cloud-init使用户能够编写一次自定义脚本，并将其应用于节点池中创建的所有未来工作节点。</p><h1 id="7db9" class="it iu hw bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">用例</h1><p id="4a4c" class="pw-post-body-paragraph jr js hw jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">用户可以在OKE逻辑运行之前或之后，通过向脚本添加自己的逻辑来自定义默认的启动脚本。这为用户提供了执行某些需要在运行OKE脚本之前运行的动作的灵活性。例如，这可以用于配置内部yum存储库或设置公司代理。</p><p id="d8a0" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">定制默认启动脚本支持大量用例。以下是一些例子:</p><ul class=""><li id="6c22" class="lj lk hw jt b ju kq jy kr kc ll kg lm kk ln ko lo lp lq lr bi translated">使用<a class="ae kp" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/" rel="noopener ugc nofollow" target="_blank"> kubelet-extra-args </a>来配置<a class="ae kp" href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/" rel="noopener ugc nofollow" target="_blank"> kubelet污点</a>以控制pods被调度到哪些节点上。</li><li id="22ed" class="lj lk hw jt b ju ls jy lt kc lu kg lv kk lw ko lo lp lq lr bi translated">出于安全性和合规性的目的，在所有工作节点主机上配置一个<a class="ae kp" href="https://selinuxproject.org/page/Main_Page" rel="noopener ugc nofollow" target="_blank"> SELinux </a>策略。</li><li id="014c" class="lj lk hw jt b ju ls jy lt kc lu kg lv kk lw ko lo lp lq lr bi translated">在启动时取消分配实例的临时公共IP，而是为实例重新分配保留的公共IP。</li><li id="05a3" class="lj lk hw jt b ju ls jy lt kc lu kg lv kk lw ko lo lp lq lr bi translated">配置公司代理。</li><li id="3716" class="lj lk hw jt b ju ls jy lt kc lu kg lv kk lw ko lo lp lq lr bi translated">配置自定义yum代理。</li><li id="586d" class="lj lk hw jt b ju ls jy lt kc lu kg lv kk lw ko lo lp lq lr bi translated">安装强制性防病毒软件和其他安全工具</li></ul><p id="6791" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">用户可以在创建新群集、创建新节点池和修改现有节点池时自定义默认启动脚本。这可以在OKE控制台和<a class="ae kp" href="https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengusingcustomcloudinitscripts.htm#contengusingcustomcloudinitscripts_topic_Using_the_CLI" rel="noopener ugc nofollow" target="_blank">中使用CLI、SDK、API和其他界面</a>完成<a class="ae kp" href="https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengusingcustomcloudinitscripts.htm#contengusingcustomcloudinitscripts_topic_Using_the_Console" rel="noopener ugc nofollow" target="_blank">。自定义启动脚本在托管工作节点的实例启动时运行。在定制了默认的启动脚本之后，最好运行Node Doctor脚本来确认新启动的实例上的工作节点是否按预期工作。更多信息，请参考使用节点诊断脚本</a>的<a class="ae kp" href="https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengtroubleshooting_topic-node_troubleshooting.htm" rel="noopener ugc nofollow" target="_blank">节点故障排除。</a></p><h1 id="ad47" class="it iu hw bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">使用定制的Cloud-init脚本来设置kubelet-extra-args</h1><p id="e33f" class="pw-post-body-paragraph jr js hw jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">您可以使用一个定制的cloud-init脚本在工作节点上的kubelet(主节点代理)上配置许多额外的选项。这些额外的选项有时被称为kubelet-extra-args。一个这样的kubelet- extra-args选项是配置调试级别日志详细程度的选项。</p><p id="7bfc" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">要配置调试级别日志详细程度，请使用以下云初始化脚本:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="5176" class="le iu hw la b fi lf lg l lh li">#!/bin/bash<br/>curl --fail -H "Authorization: Bearer Oracle" -L0 <a class="ae kp" href="http://169.254.169.254/" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/</a><br/>opc/v2/instance/metadata/oke_init_script | base64 --decode &gt;/var/run/oke-<br/>init.sh<br/>bash /var/run/oke-init.sh --kubelet-extra-args "--v=4"</span></pre><p id="a9ee" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">要确认调试级别日志详细程度的设置，请连接到一个worker节点并使用sudo systemctl status -l kubelet命令。当上面的cloud-init脚本在worker节点上运行时，sudo systemctl status -l kubelet命令将详细级别返回为4。kubelet日志还包含更多细节。</p><h1 id="7b21" class="it iu hw bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">使用定制的云初始化脚本来配置SELinux(安全性增强的Linux)</h1><p id="2e6e" class="pw-post-body-paragraph jr js hw jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">SELinux是对Linux的安全增强，使管理员能够根据策略中的规则限制哪些用户和应用程序可以访问哪些资源。SELinux还为访问控制增加了更精细的粒度。用户可以使用定制的cloud-init脚本在worker节点上配置SELinux。</p><p id="ade1" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">SELinux可以处于两种状态之一，启用或禁用。启用后，SELinux可以以两种模式之一运行，强制模式或许可模式。默认情况下，SELinux在OKE工作节点上是启用的，并设置为在许可模式下运行。在许可模式下运行时，SELinux不强制执行访问规则，只执行日志记录。</p><p id="d1c9" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">要实施访问规则，请将SELinux设置为在实施模式下运行。在强制模式下运行时，SELinux会阻止违反策略的操作，并在审计日志中记录相应的事件。</p><p id="6b69" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">要将SELinux设置为在强制模式下运行，请使用以下cloud-init脚本:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="6687" class="le iu hw la b fi lf lg l lh li">#!/bin/bash<br/>curl --fail -H "Authorization: Bearer Oracle" -L0 <a class="ae kp" href="http://169.254.169.254/" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/</a><br/>opc/v2/instance/metadata/oke_init_script | base64 --decode &gt;/var/run/oke-<br/>init.sh<br/>bash /var/run/oke-init.sh<br/>setenforce 1<br/>sed -i 's/^SELINUX=.*/SELINUX=enforcing/' /etc/selinux/config</span></pre><p id="b8e8" class="pw-post-body-paragraph jr js hw jt b ju kq jw jx jy kr ka kb kc ks ke kf kg kt ki kj kk ku km kn ko ha bi translated">要确认工作节点上运行的SELinux的状态和模式，请连接到工作节点并使用<code class="du lx ly lz la b">getenforce</code>命令。当上面的cloud-init脚本已经在worker节点上运行时，<code class="du lx ly lz la b">getenforce</code>命令返回<code class="du lx ly lz la b">Enforcing</code>。</p><h1 id="6c28" class="it iu hw bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">结论</h1><p id="3a5e" class="pw-post-body-paragraph jr js hw jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">使用启动脚本定制工作节点使高级用户能够定制符合其用例的工作节点。用户不再需要决定是使用默认节点配置还是接受手动管理自定义映像的额外管理开销。现在，用户可以在OKE脚本运行之前或之后简单地添加一个定制脚本，以便在他们认为合适的时候修改他们的worker节点。</p><h1 id="c562" class="it iu hw bd iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq bi translated">想了解更多？</h1><p id="1ac7" class="pw-post-body-paragraph jr js hw jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ha bi translated">要了解更多信息或亲自动手，请使用以下资源:</p><ul class=""><li id="be77" class="lj lk hw jt b ju kq jy kr kc ll kg lm kk ln ko lo lp lq lr bi translated">访问<a class="ae kp" href="https://www.oracle.com/cloud-native/container-engine-kubernetes/" rel="noopener ugc nofollow" target="_blank"> OKE资源中心</a>了解产品详情和客户评价。</li><li id="f726" class="lj lk hw jt b ju ls jy lt kc lu kg lv kk lw ko lo lp lq lr bi translated">从我们的<a class="ae kp" href="https://docs.oracle.com/en-us/iaas/Content/ContEng/Concepts/contengoverview.htm" rel="noopener ugc nofollow" target="_blank">文档</a>中了解更多关于OKE的信息。</li><li id="c5ff" class="lj lk hw jt b ju ls jy lt kc lu kg lv kk lw ko lo lp lq lr bi translated">自己使用定制的worker节点启动脚本来尝试<a class="ae kp" href="https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengusingcustomcloudinitscripts.htm" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="8899" class="lj lk hw jt b ju ls jy lt kc lu kg lv kk lw ko lo lp lq lr bi translated">从我们的<a class="ae kp" href="https://www.oracle.com/cloud/free/" rel="noopener ugc nofollow" target="_blank"> Oracle云免费层</a>开始使用Oracle云基础架构。</li></ul></div></div>    
</body>
</html>