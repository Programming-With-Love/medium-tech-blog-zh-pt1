<html>
<head>
<title>Effectively Managing Kubernetes Access from the Terminal</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从终端有效管理Kubernetes访问</h1>
<blockquote>原文：<a href="https://medium.com/capital-one-tech/managing-kubernetes-contexts-for-multiple-clusters-eed174288efe?source=collection_archive---------1-----------------------#2019-07-16">https://medium.com/capital-one-tech/managing-kubernetes-contexts-for-multiple-clusters-eed174288efe?source=collection_archive---------1-----------------------#2019-07-16</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="79be" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">使用Kubectx和Kube-ps1定制您的终端</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/6681654ff4bb2e723bc6b7a9aeb81f34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fcRDzx2wIY-L7kQuKfsteg.jpeg"/></div></div></figure><p id="6ef5" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">有很多方法可以管理对Kubernetes集群的访问。这些都不难，但是如果您必须在一个集群上管理多个用户和上下文，该怎么办呢？这变得有点挑战性。除此之外，我确信我们中的许多人都在管理多个集群，并且我们中的一些人可能在多个集群上管理多个用户和上下文。管理所有这些会变得非常麻烦，而且会占用我们的时间。</p><p id="208e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我将讲述我个人是如何决定给自己一个更好的管理Kubernetes集群的体验的。我会根据我的个人喜好，涵盖高点、低点以及中间的一切。</p><h2 id="8445" class="ke kf hh bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky bi translated"><strong class="ak">研究、中断、修复、重复</strong></h2><p id="13c1" class="pw-post-body-paragraph ji jj hh jk b jl kz ii jn jo la il jq jr lb jt ju jv lc jx jy jz ld kb kc kd ha bi translated">在我在Capital One的工作中，我每天与大约三个集群进行交互，每个集群可能有三个用户和上下文。最终，改变环境变量和运行冗长的命令耗尽了我的耐心。很自然，作为一名系统管理员，我开始编写一些简单的bash函数放入我的<code class="du le lf lg lh b"><em class="li">.</em>bashrc</code>中。这在一段时间内有效，但并不完美。我不得不运行多个命令来更改kubeconfigs和上下文/用户。这满足了我一点点，但我想要一个更好的解决方案，因为每次它不像预期的那样工作时，它仍然会触动神经。</p><p id="9914" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">最终，我告诉自己，我要花一个下午(最终更像是一天+)来为我的需求找到一个好的解决方案。我的意思是，如果我花了谁知道多长时间编写可行的行动手册来管理我所有的点文件和软件包安装，这应该很容易吧？</p><p id="d2a7" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="li">剧透……不是的。</em></p><p id="04f9" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在研究了管理Kubernetes访问的工具之后，我决定使用kubectx它似乎符合我的需要。它管理名称空间切换，可由<code class="du le lf lg lh b">brew</code>安装，并拥有4k+ GitHub stars。当我浏览<code class="du le lf lg lh b">README</code>时，就像其他项目的好用户一样，我注意到了对另一个工具的引用，我很快决定也实现这个工具:<a class="ae lj" href="https://github.com/jonmosco/kube-ps1" rel="noopener ugc nofollow" target="_blank"> kube-ps1 </a>。这是一个漂亮的小应用程序，允许您将Kubernetes集群和名称空间信息添加到您的<code class="du le lf lg lh b">PS1</code>行(您的终端命令提示符)中。这有明显更少的星星，但我是一个摆弄我的终端吸盘，快乐的一天。</p><p id="81ec" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">现在我需要弄清楚如何解决我的实际访问问题。我有三个集群，每个集群有三个用户，有两种不同的身份验证方法。其中两个用户在集群之间没有被唯一命名，但是集群被唯一命名。将凭证映射到用户应该很简单。</p><p id="ab68" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="li">剧透……不是的。</em></p><p id="9447" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我首先开始正式查看用于管理多个集群的Kubernetes文档。这让我大概完成了80%,但是对于集群中的同名用户，它没有答案。我不断破坏我的kubeconfig，因为上下文不知道在哪里寻找用户认证。</p><p id="64e4" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">挫败感随之而来。愤怒的谷歌搜索随之而来。失败开始了。</p><p id="33f4" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">当我开始到达我的线的末端并与船一起下沉，即将称我的尝试失败并让自己失望时，我拿出了最后的努力，并在MagicCityTech <code class="du le lf lg lh b">#kubernetes</code> Slack频道(我的伯明翰朋友)中询问是否有人已经发现了这一点。我得到了一个回复，就是回答Kubernetes所有问题的那个人，它是一个<a class="ae lj" href="http://docs.shippable.com/deploy/tutorial/create-kubeconfig-for-self-hosted-kubernetes-cluster/" rel="noopener ugc nofollow" target="_blank">链接</a>，为我解决了所有问题。</p><h2 id="84ef" class="ke kf hh bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky bi translated">让一切运转起来</h2><p id="5b35" class="pw-post-body-paragraph ji jj hh jk b jl kz ii jn jo la il jq jr lb jt ju jv lc jx jy jz ld kb kc kd ha bi translated">我做的第一件事是从我的<code class="du le lf lg lh b">gopass</code>存储库中检索我所有的kubeconfigs和服务帐户令牌；如果你没有gopass，你会错过很多。从那里，我开始构建我的“主”kubeconfig，我将在以后的所有访问中使用它。它最终看起来有点像这样:</p><pre class="ix iy iz ja fd lk lh ll lm aw ln bi"><span id="3ead" class="ke kf hh lh b fi lo lp l lq lr">apiVersion: v1<br/>clusters:<br/>- cluster:<br/>    certificate-authority-data: &lt;data&gt;<br/>    server: &lt;server&gt;<br/>  name: dev-ue1<br/>- cluster:<br/>    certificate-authority-data: &lt;data&gt;<br/>    server: &lt;server&gt;<br/>  name: qa-ue1<br/>- cluster:<br/>    certificate-authority-data: &lt;data&gt;<br/>    server: &lt;server&gt;<br/>  name: qa-uw2<br/>contexts:<br/>- context:<br/>    cluster: dev-ue1<br/>    namespace: kube-system<br/>    user: dev-ue1-admin<br/>  name: dev-ue1-admin<br/>- context:<br/>    cluster: dev-ue1<br/>    namespace: admin-services<br/>    user: dev-ue1-admin-services<br/>  name: dev-ue1-admin-services<br/>- context:<br/>    cluster: dev-ue1<br/>    namespace: user<br/>    user: dev-ue1-user<br/>  name: dev-ue1-user<br/>- context:<br/>    cluster: qa-ue1<br/>    namespace: kube-system<br/>    user: qa-ue1-admin<br/>  name: qa-ue1-admin<br/>- context:<br/>    cluster: qa-ue1<br/>    namespace: admin-services<br/>    user: qa-ue1-admin-services<br/>  name: qa-ue1-admin-services<br/>- context:<br/>    cluster: qa-uw2<br/>    namespace: kube-system<br/>    user: qa-uw2-admin<br/>  name: qa-uw2-admin<br/>- context:<br/>    cluster: qa-uw2<br/>    namespace: admin-services<br/>    user: qa-uw2-admin-services<br/>  name: qa-uw2-admin-services<br/>kind: Config<br/>preferences: {}<br/>users:<br/>- name: dev-ue1-admin<br/>  user:<br/>    client-certificate-data: &lt;client certificate&gt;<br/>    client-key-data: &lt;client key&gt;<br/>- name: dev-ue1-admin-services<br/>  user:<br/>    token: &lt;token&gt;<br/>- name: dev-ue1-user<br/>  user:<br/>    token: &lt;token&gt;<br/>- name: qa-ue1-admin<br/>  user:<br/>    client-certificate-data: &lt;client certificate&gt;<br/>    client-key-data: &lt;client key&gt;<br/>- name: qa-ue1-admin-services<br/>  user:<br/>    token: &lt;token&gt;<br/>- name: qa-uw2-admin<br/>  user:<br/>    client-certificate-data: &lt;client certificate&gt;<br/>    client-key-data: &lt;client key&gt;<br/>- name: qa-uw2-admin-services<br/>  user:<br/>    token: &lt;token&gt;</span></pre><p id="f1f5" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这个kubeconfig允许我通过一个配置文件在所有集群中使用所有的上下文和用户。这也允许我使用非唯一命名的服务帐户admin-services来访问每个集群。我可以这样做，因为在kubeconfig中，我在我的上下文中唯一地命名了我的所有用户。然后，我可以查找每个用户的特定访问令牌，并使用特定集群的certificate-authority-data进行身份验证。如果集群块中没有证书-授权-数据，这将不起作用。现在困难和复杂的部分已经完成，并且安全地保存在<code class="du le lf lg lh b">gopass</code>中，我可以继续让它变得可用了。</p><p id="16ce" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我做的第一件事是在我的<code class="du le lf lg lh b">.bashrc</code>中添加一行，将<code class="du le lf lg lh b">KUBECONFIG</code>环境变量导出到我新创建的kubeconfig中。然后<code class="du le lf lg lh b">brew</code>安装了<code class="du le lf lg lh b">kubectx</code>和<code class="du le lf lg lh b">kube-ps1</code> <em class="li">、</em>并开始调整我的<code class="du le lf lg lh b">PS1</code>线和显示方式。自然，股票<code class="du le lf lg lh b">kube-ps1</code>输出不是我想要的，所以是时候开始修改了。我应该注意到，如果你已经在使用一个工具来管理你的<code class="du le lf lg lh b">PS1</code>线，你可能需要做一些稍微不同的事情来让它工作。</p><p id="93a1" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我的队伍已经很长了；我有git状态和分支的助手，以及Terraform工作区。所以当我看到<code class="du le lf lg lh b">kube-ps1</code>显示了我的整个上下文和名称空间时，它就不工作了。幸运的是，我是一个<code class="du le lf lg lh b">tmux</code>用户(再次感谢MagicCityTech让我搭上了<code class="du le lf lg lh b">tmux</code>列车),可以在我的终端底部访问一个漂亮的小状态行。我决定在我的tmux状态行中显示集群和用户，并且在我的<code class="du le lf lg lh b">PS1</code>行中只显示名称空间。</p><p id="ebc4" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="li">定制配置随即开始。</em></p><p id="addf" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">首先，我关闭了愚蠢的Kubernetes符号<code class="du le lf lg lh b">kube-ps1</code>的使用，删除了前缀和后缀，并删除了名称空间文本颜色配置(我有自己的颜色偏好)。这很容易通过通读<code class="du le lf lg lh b">README</code>并在我的<code class="du le lf lg lh b">.bashrc</code>中设置一些环境变量来完成。</p><pre class="ix iy iz ja fd lk lh ll lm aw ln bi"><span id="a351" class="ke kf hh lh b fi lo lp l lq lr">KUBE_PS1_SYMBOL_ENABLE=false<br/>KUBE_PS1_PREFIX=""<br/>KUBE_PS1_SUFFIX=""<br/>KUBE_PS1_NS_COLOR=""</span><span id="7b3b" class="ke kf hh lh b fi ls lp l lq lr">export \<br/>  KUBE_PS1_SYMBOL_ENABLE \<br/>  KUBE_PS1_PREFIX \<br/>  KUBE_PS1_SUFFIX \<br/>  KUBE_PS1_NS_COLOR</span></pre><p id="fe20" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">接下来，我需要编写一个自定义函数，只获取我想要的信息并设置我的颜色。在我的<code class="du le lf lg lh b">.bashrc</code>中，我写了一个简单的函数，并将其作为我的<code class="du le lf lg lh b">PS1</code>行的一部分来执行。</p><pre class="ix iy iz ja fd lk lh ll lm aw ln bi"><span id="1dbe" class="ke kf hh lh b fi lo lp l lq lr">kube_ns() {<br/>  purple='\033[0;35m'<br/>  nocolor='\033[0m'<br/>  kube_ps1=$(kube_ps1)<br/>  namespace=$(echo ${kube_ps1} | cut -d ':' -f 2)<br/>  echo -e "${nocolor}(${purple}${namespace}${nocolor})"<br/>}</span><span id="f7f8" class="ke kf hh lh b fi ls lp l lq lr">PS1="\$(kube_ps1) \[\033[32m\]\u\[\033[0m\] \[\033[36m\]\w\[\033[0m\]\$(git_prompt_info '\[\033[34m\]%b\[\033[0m\]') \$(terraform_workspace_info '\[\033[95m\]%b\[\033[0m\]')\n❯ "</span></pre><p id="ee8a" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">现在我已经有了一个视觉上吸引人的终端，我试着使用<code class="du le lf lg lh b">kubectx.</code></p><p id="8aa6" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">剧透…成功了。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es lt"><img src="../Images/703483e88d80e02624391f9ebdd4e88e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/0*bXCVTeS_nyS8wsl0"/></div><figcaption class="lu lv et er es lw lx bd b be z dx">kubectx changing contexts and clusters</figcaption></figure><p id="76bc" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">您可以看到<code class="du le lf lg lh b">kube-ps1</code>正在填充我的命令提示符的<code class="du le lf lg lh b">(namespace)</code>部分，这正是我想要的。您还可以看到，只需一个命令，切换上下文和集群是多么容易。</p><p id="6057" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><code class="du le lf lg lh b">kubectx</code>还允许您使用<code class="du le lf lg lh b">kubens</code>更改名称空间。该命令将列出所有名称空间，然后更改为您指定的名称空间。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es ly"><img src="../Images/2f5f4e155f33531c5ec63dac0d7e760a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1040/0*8QwTp1W2b3u_g0Rv"/></div><figcaption class="lu lv et er es lw lx bd b be z dx">kubens changing namespaces within a context</figcaption></figure><p id="7731" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">请注意，当我更改名称空间时，我的命令提示符会更新，但我的上下文保持不变。</p><p id="6d88" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">还记得我说过我是<code class="du le lf lg lh b">tmux</code>用户吗？这是更简单的附加配置。在我的<code class="du le lf lg lh b">.tmux.conf</code>文件中，我必须配置我的tmux环境，以了解我的<code class="du le lf lg lh b">KUBECONFIG</code>环境变量和我的<code class="du le lf lg lh b">status-left-length</code>和<code class="du le lf lg lh b">status-left</code>；我用右边来显示日期。我将所有配置保存在<code class="du le lf lg lh b">${HOME}/.config</code>中。</p><pre class="ix iy iz ja fd lk lh ll lm aw ln bi"><span id="7c5e" class="ke kf hh lh b fi lo lp l lq lr">set-environment -g KUBECONFIG ${HOME}/.config/kube-master.config</span><span id="dd67" class="ke kf hh lh b fi ls lp l lq lr">set-option -g status-left-length 100<br/>set-option -g status-left "#[fg=red]#(kubectl config current-context | cut -d '-' -f 1–2)#[fg=white]#(echo :)#[fg=blue]#(kubectl config current-context | cut -d '-' -f 3–4)"</span></pre><p id="9d48" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="li">根据上下文命名约定，根据需要调整剪切命令。</em></p><p id="b9df" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这三行文字在终端的左下角给了我想要的确切信息。正如您所期望的，当您使用<code class="du le lf lg lh b">kubectx</code> <em class="li">，</em>更改集群/上下文/用户时，它也会更新。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es lz"><img src="../Images/22d5ff4f308d947b1cfb10aa881a7a03.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/0*DU8U2hywENBRJTqT"/></div><figcaption class="lu lv et er es lw lx bd b be z dx">tmux status line showing cluster and user information</figcaption></figure><h2 id="06d8" class="ke kf hh bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky bi translated">值得吗</h2><p id="365a" class="pw-post-body-paragraph ji jj hh jk b jl kz ii jn jo la il jq jr lb jt ju jv lc jx jy jz ld kb kc kd ha bi translated">至于你是否应该这样做，答案取决于你，取决于你想在你的当地环境中投资多少。这并不是做好我的工作所必需的，但它确实让我更有效率。我在本地配置上投入了很多，因为我喜欢拥有一个能够满足我所有需求的微调开发环境。如果你也是这样，那么这可能也适合你。</p><h2 id="03a0" class="ke kf hh bd kg kh ki kj kk kl km kn ko jr kp kq kr jv ks kt ku jz kv kw kx ky bi translated">相关:</h2><ul class=""><li id="4ce3" class="ma mb hh jk b jl kz jo la jr mc jv md jz me kd mf mg mh mi bi translated"><a class="ae lj" rel="noopener" href="/capital-one-tech/building-feature-toggles-into-terraform-d75806217647">建筑特征切换成地形</a></li><li id="387e" class="ma mb hh jk b jl mj jo mk jr ml jv mm jz mn kd mf mg mh mi bi translated"><a class="ae lj" rel="noopener" href="/capital-one-tech/deploying-multiple-environments-with-terraform-kubernetes-7b7f389e622">使用Terraform部署多个环境</a></li><li id="a5dd" class="ma mb hh jk b jl mj jo mk jr ml jv mm jz mn kd mf mg mh mi bi translated"><a class="ae lj" rel="noopener" href="/capital-one-tech/multi-region-deployments-with-terraform-kubernetes-a1f51bb96974">采用地形的多区域部署</a></li></ul></div><div class="ab cl mo mp go mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ha hb hc hd he"><p id="e783" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">披露声明:2019首创一。观点是作者个人的观点。除非本帖中另有说明，否则Capital One不隶属于所提及的任何公司，也不被这些公司认可。使用或展示的所有商标和其他知识产权是其各自所有者的财产。</p></div></div>    
</body>
</html>