<html>
<head>
<title>#SmallerAPK, Part 1: Anatomy of an APK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">#SmallerAPK，第1部分:APK剖析</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/smallerapk-part-1-anatomy-of-an-apk-da83c25e7003?source=collection_archive---------0-----------------------#2016-02-19">https://medium.com/androiddevelopers/smallerapk-part-1-anatomy-of-an-apk-da83c25e7003?source=collection_archive---------0-----------------------#2016-02-19</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/16742a27007b85054b45771a39fbd376.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6OvLVi-G5Ldze7Novm7M0w.jpeg"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">Has your app let itself go? Time to get that APK on a diet!</figcaption></figure><figure class="hu hv hw hx fd hj"><div class="bz dy l di"><div class="hy hz l"/></div><figcaption class="hq hr et er es hs ht bd b be z dx">All articles in a talk at Google I/O</figcaption></figure><div class=""/><p id="5808" class="pw-post-body-paragraph iz ja ic jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated"><a class="ae jx" href="#1646" rel="noopener ugc nofollow"> <strong class="jb id">更新1 </strong> </a>:我们不再推荐使用Zopfli来压缩你的APK</p><p id="9baf" class="pw-post-body-paragraph iz ja ic jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">如果我问一群开发人员他们的应用程序有多大，我敢肯定大多数人会查看Android Studio生成的APK文件，并告诉我它在他们的计算机上占用了多少磁盘空间。这是最直截了当的答案，从技术上来说<em class="jy">是正确的，但也许我应该问更好的问题。以这些为例:</em></p><ul class=""><li id="f624" class="jz ka ic jb b jc jd jg jh jk kb jo kc js kd jw ke kf kg kh bi translated">你的应用安装在用户设备上时会占用多少空间<em class="jy">？</em></li><li id="ba70" class="jz ka ic jb b jc ki jg kj jk kk jo kl js km jw ke kf kg kh bi translated">用户下载安装你的app需要支付<em class="jy"> </em>多少<em class="jy">网络数据</em>？</li><li id="55d0" class="jz ka ic jb b jc ki jg kj jk kk jo kl js km jw ke kf kg kh bi translated">现有用户的应用程序更新下载量有多大？</li><li id="fabc" class="jz ka ic jb b jc ki jg kj jk kk jo kl js km jw ke kf kg kh bi translated">运行您的应用程序会占用多少内存(就使用的RAM而言)？</li></ul><p id="fd7c" class="pw-post-body-paragraph iz ja ic jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">如果你是一名开发人员，拥有一部高端手机，使用“吃到饱”的数据套餐，你可能想知道是否值得花时间为APK尺寸进行优化…记住，并非所有设备都有相同的存储、内存或网络连接。</p><p id="08b7" class="pw-post-body-paragraph iz ja ic jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">在世界上有些地方，用户必须为下载的每兆数据付费，而且并非每个角落都有Wi-Fi热点。</p><p id="b357" class="pw-post-body-paragraph iz ja ic jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">一些设备没有内部存储容量(磁盘空间)来让用户安装他们需要的所有应用程序，这意味着他们在安装或更新任何软件之前必须三思而行。谁知道呢，这些可能是你下一个成千上万的用户，所以让我们试着把APK变小吧！这对每个人都有好处。</p><p id="7179" class="pw-post-body-paragraph iz ja ic jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">当然，考虑到我们都必须处理的各种需求和约束，很难选择一个通用的解决方案。有时，牺牲初始下载大小会加快后续更新。在其他情况下，与直觉相反，在APK中保持文件未压缩可以减少设备上占用的最终磁盘空间。我将努力强调这些权衡，并在适用的地方提供解释，但最终还是取决于您，即开发人员，来选择对您的应用程序和用户有意义的技术组合。</p><p id="a920" class="pw-post-body-paragraph iz ja ic jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">运行时内存占用超出了本系列文章的范围。提出的优化可能对内存使用和性能有一些小的副作用，既有正面的也有负面的。我会尽量在适用的时候提到任何明显的缺点，但这是留给读者衡量你的应用程序的性能特征并做出最终决定的。记住，#perfmatters！</p><h1 id="d06c" class="kn ko ic bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">APK里有什么</h1><p id="e4ef" class="pw-post-body-paragraph iz ja ic jb b jc ll je jf jg lm ji jj jk ln jm jn jo lo jq jr js lp ju jv jw ha bi translated">在我开始谈论如何精简一个应用程序之前，让我们先来看看文件格式本身。APK实际上只是一个ZIP存档，包含组成应用程序的文件。通常在APK你会发现这样的条目:</p><h2 id="a06d" class="lq ko ic bd kp lr ls lt kt lu lv lw kx jk lx ly lb jo lz ma lf js mb mc lj md bi translated">classes.dex</h2><p id="3304" class="pw-post-body-paragraph iz ja ic jb b jc ll je jf jg lm ji jj jk ln jm jn jo lo jq jr js lp ju jv jw ha bi translated">包含编译的应用程序代码，转换成Dex字节码。如果你使用<em class="jy"> multidex </em>来克服<a class="ae jx" href="http://developer.android.com/tools/building/multidex.html#about" rel="noopener ugc nofollow" target="_blank">65536方法限制</a>，你可能会在你的APK中看到不止一个DEX文件。从引入ART运行时的Android 5.0开始，这些文件在安装时由提前编译器编译成OAT文件，并放在设备的数据分区上。你可以在<a class="ae jx" rel="noopener" href="/@wkalicinski/smallerapk-part-2-minifying-code-554560d2ed40">第二部分:缩小代码</a>中学习如何缩小你的dex代码</p><h2 id="6ca4" class="lq ko ic bd kp lr ls lt kt lu lv lw kx jk lx ly lb jo lz ma lf js mb mc lj md bi translated">res/</h2><p id="42e5" class="pw-post-body-paragraph iz ja ic jb b jc ll je jf jg lm ji jj jk ln jm jn jo lo jq jr js lp ju jv jw ha bi translated">该文件夹包含大多数XML资源(如布局)和drawables(如PNG、JPEG ),文件夹中有各种限定符，如-mdpi和-hdpi表示密度，-sw600dp或-large表示屏幕尺寸，-en，-de，-pl表示语言。请注意，res/中的任何XML文件在编译时都被转换为更紧凑的二进制表示形式，因此您无法在APK中用文本编辑器打开它们。</p><p id="b049" class="pw-post-body-paragraph iz ja ic jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated"><a class="ae jx" rel="noopener" href="/@wkalicinski/smallerapk-part-3-removing-unused-resources-1511f9e3f761">第3部分:删除未使用的资源</a>展示了如何确保项目中没有陈旧的资源而浪费空间。在<a class="ae jx" rel="noopener" href="/@wkalicinski/smallerapk-part-4-multi-apk-through-abi-and-density-splits-477083989006">第4部分:多APK、ABI和密度分割</a>和<a class="ae jx" rel="noopener" href="/@wkalicinski/smallerapk-part-5-multi-apk-through-product-flavors-e069759f19cd">第5部分:通过产品风格的多APK</a>中，我们讨论了如何在多个APK上划分资产，这些apk基于硬件特性针对特定的设备组。<a class="ae jx" rel="noopener" href="/@wkalicinski/smallerapk-part-6-image-optimization-zopfli-webp-4c462955647d">第6部分:图像优化，Zopfli &amp; WebP </a>和<a class="ae jx" rel="noopener" href="/@wkalicinski/smallerapk-part-7-image-optimization-shape-and-vectordrawables-ed6be3dca3f">第7部分:图像优化，Shape和VectorDrawables </a>处理使图像变小的各种优化技术。</p><h2 id="396e" class="lq ko ic bd kp lr ls lt kt lu lv lw kx jk lx ly lb jo lz ma lf js mb mc lj md bi translated">resources.arsc</h2><p id="51c4" class="pw-post-body-paragraph iz ja ic jb b jc ll je jf jg lm ji jj jk ln jm jn jo lo jq jr js lp ju jv jw ha bi translated">一些资源和标识符被编译并平铺到这个文件中。它通常存储在没有压缩的APK中，以便在运行时更快地访问。手动压缩这个文件看起来似乎轻而易举，但实际上并不是一个好主意，至少有两个原因。首先，Play Store会压缩任何传输数据；其次，在APK中压缩文件会浪费系统资源(RAM)和性能(尤其是应用程序启动时间)。</p><p id="4782" class="pw-post-body-paragraph iz ja ic jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">第3部分将展示两种方法,通过只包含对你的应用有意义的语言字符串，使这个文件变得更精简。</p><h2 id="c159" class="lq ko ic bd kp lr ls lt kt lu lv lw kx jk lx ly lb jo lz ma lf js mb mc lj md bi translated">AndroidManifest.xml</h2><p id="0f86" class="pw-post-body-paragraph iz ja ic jb b jc ll je jf jg lm ji jj jk ln jm jn jo lo jq jr js lp ju jv jw ha bi translated">与其他XML资源类似，您的应用程序清单在编译期间被转换为二进制格式。Play Store使用AndroidManifest中包含的某些信息来决定是否可以在设备上安装APK，检查允许的密度或屏幕大小以及可用的硬件和功能(如触摸屏)。如果您想在编译后检查这些清单条目，可以使用Android SDK中的aapt工具:</p><pre class="hu hv hw hx fd me mf mg mh aw mi bi"><span id="c954" class="lq ko ic mf b fi mj mk l ml mm">$ aapt dump badging your_app.apk</span></pre><h2 id="3e57" class="lq ko ic bd kp lr ls lt kt lu lv lw kx jk lx ly lb jo lz ma lf js mb mc lj md bi translated">libs/</h2><p id="1ade" class="pw-post-body-paragraph iz ja ic jb b jc ll je jf jg lm ji jj jk ln jm jn jo lo jq jr js lp ju jv jw ha bi translated">任何本地库(*。所以文件)会放在以ABI命名的子文件夹中(CPU架构，例如<em class="jy"> x86 </em>、<em class="jy"> x86_64 </em>、<em class="jy"> armeabi-v7a </em>)，它们的目标在<em class="jy"> libs/ </em>文件夹下。通常，它们在安装时从APK复制到您的<em class="jy"> /data </em>分区。然而，由于APK本身在用户设备上时从不改变，这实质上是任何本地库所需空间的两倍。<a class="ae jx" rel="noopener" href="/@wkalicinski/smallerapk-part-8-native-libraries-open-from-apk-fc22713861ff">本文的第8部分(本地库，在APK开放)</a>为Android 6.0+上的这个问题提供了一个解决方案，在旧设备上也可以节省网络带宽。</p><h2 id="708a" class="lq ko ic bd kp lr ls lt kt lu lv lw kx jk lx ly lb jo lz ma lf js mb mc lj md bi translated">资产/</h2><p id="2ab5" class="pw-post-body-paragraph iz ja ic jb b jc ll je jf jg lm ji jj jk ln jm jn jo lo jq jr js lp ju jv jw ha bi translated">此文件夹用于任何不会用作Android类型资源的文件资产。最常见的是字体文件或游戏数据，如关卡和纹理，以及任何其他你想直接作为文件流打开的应用程序数据。</p><h2 id="1c53" class="lq ko ic bd kp lr ls lt kt lu lv lw kx jk lx ly lb jo lz ma lf js mb mc lj md bi translated">元信息/</h2><p id="009c" class="pw-post-body-paragraph iz ja ic jb b jc ll je jf jg lm ji jj jk ln jm jn jo lo jq jr js lp ju jv jw ha bi translated">此文件夹存在于已签名的APK中，包含APK中所有文件及其签名的列表。Android中的签名目前的工作方式是，它根据存档中的<em class="jy">未压缩的</em>文件内容逐一验证签名。</p><p id="e006" class="pw-post-body-paragraph iz ja ic jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">这产生了一些有趣的结果。因为ZIP文件中的每个条目都是单独存储的，这意味着您可以更改单个文件的压缩级别，而无需重新签名。但是，如果在签名后从存档中删除任何文件，签名验证将会失败。</p><p id="09ef" class="pw-post-body-paragraph iz ja ic jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">关于如何创建签名的APK，还有一点需要注意，即<em class="jy"> zipalign </em>工具被用作构建的最后阶段。如果你手动修改了存档的内容，通常你需要重新签名，<em class="jy"> </em>然后<em class="jy"> zipalign </em>才能将APK上传到游戏商店。</p><h1 id="9d51" class="kn ko ic bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">使用Zopfli重新压缩APK(不要这样做)</h1><p id="59dd" class="pw-post-body-paragraph iz ja ic jb b jc ll je jf jg lm ji jj jk ln jm jn jo lo jq jr js lp ju jv jw ha bi translated"><strong class="jb id">更新:</strong>之前，这篇文章包含了一个关于使用更强的压缩算法Zopfli在你的APK中再压缩文件的章节。<strong class="jb id">从Android Studio 2.2开始，这项功能将从我们的构建工具中移除，不再推荐使用，</strong>因为它可能会干扰未来使Play Store增量更新更小的计划。</p><p id="25b5" class="pw-post-body-paragraph iz ja ic jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">如果你仍然不相信在你的APK上停止使用Zopfli，<strong class="jb id">读者提醒我，某些Android 5.0.1设备可能会在读取Zopfli压缩的apk时出现问题，甚至会使你的应用崩溃。</strong></p><p id="815d" class="pw-post-body-paragraph iz ja ic jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">无论如何，本指南的<a class="ae jx" rel="noopener" href="/@wkalicinski/smallerapk-part-2-minifying-code-554560d2ed40">接下来的</a>章节应该是你的主要关注点，它比使用Zopfli实现APK节省了10倍。</p></div><div class="ab cl mn mo go mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ha hb hc hd he"><p id="8f2a" class="pw-post-body-paragraph iz ja ic jb b jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw ha bi translated">接下来，<a class="ae jx" rel="noopener" href="/@wkalicinski/smallerapk-part-2-minifying-code-554560d2ed40">第二部分:缩小代码</a>！</p></div></div>    
</body>
</html>