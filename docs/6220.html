<html>
<head>
<title>Building a Kubernetes platform at Pinterest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Pinterest建立一个Kubernetes平台</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/building-a-kubernetes-platform-at-pinterest-fb3d9571c948?source=collection_archive---------0-----------------------#2019-08-07">https://medium.com/pinterest-engineering/building-a-kubernetes-platform-at-pinterest-fb3d9571c948?source=collection_archive---------0-----------------------#2019-08-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="eb7a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Lida Li，June Liu，Rodrigo Menezes，Suli Xu，，Roberto Rodriguez Alcala | Pinterest软件工程师，云管理平台</p><h1 id="e968" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">为什么是Kubernetes？</h1><p id="c86d" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">多年来，3亿Pinners在Pinterest上保存了超过40亿个董事会的超过2000亿个pin。为了服务于这一庞大的用户群和内容池，我们开发了数千种服务，从少数CPU的微服务到占据整个虚拟机机群的大型整体服务。还有来自各种不同框架的各种批处理作业，它们可能是CPU、内存或I/O密集型的。</p><p id="1980" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了支持这些多样化的工作负载，Pinterest的基础设施团队面临着多重挑战:</p><ul class=""><li id="330e" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb kk kl km kn bi translated">工程师在启动工作负载时没有统一的体验。无状态服务、有状态服务和批处理作业是由完全不同的技术栈部署和管理的。这为我们的工程师创造了一个陡峭的学习曲线，也为基础设施团队带来了巨大的维护和客户支持负担。</li><li id="0cf6" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb kk kl km kn bi translated">管理自己的虚拟机群的工程师给基础架构团队带来了巨大的维护负担。操作系统或AMI升级之类的简单操作可能需要数周到数月时间。在这些流程中，生产工作负载也会受到干扰，而这些流程本应对他们透明。</li><li id="8edb" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb kk kl km kn bi translated">很难在分离的管理系统之上构建基础设施治理工具。对于我们来说，确定谁拥有哪些机器以及它们是否可以安全回收更是难上加难。</li></ul><p id="08c0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">容器编排系统提供了一种统一工作负载管理的方法。它们还为更快的开发速度和更简单的基础设施治理铺平了道路，因为所有运行的资源都由一个集中的系统管理。</p><p id="a39d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">图1:基础设施优先级(服务可靠性、开发人员生产力和基础设施效率)</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es kt"><img src="../Images/996e413ff7b560900d2815ba2081d8e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Fdv1SVrb7FKgar-B"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">Figure 1: Infrastructure priorities (Service Reliability, Developer Productivity and Infra Efficiency)</figcaption></figure><p id="9e51" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest的云管理平台团队早在2017年就开始了他们在Kubernetes上的旅程。到2017年上半年，我们将大部分生产工作负载进行了分类，包括核心API和Web机群。然后，通过构建prod集群并在其上运行实际工作负载，对不同的容器编排系统进行了广泛的评估。到2017年底，我们决定走Kubernetes的道路，因为它的灵活性和广泛的社区支持。</p><p id="db2a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">到目前为止，我们已经基于Kops构建了自己的集群引导工具，并将现有的基础设施组件集成到我们的Kubernetes集群中，如网络、安全性、指标、日志记录、身份管理和流量。我们引入了特定于Pinterest的定制资源来建模我们独特的工作负载，同时向开发人员隐藏运行时的复杂性。我们现在专注于集群稳定性、可扩展性和客户加入。</p><h1 id="9155" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">Kubernetes，Pinterest方式</h1><p id="6804" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">运行Kubernetes以支持Pinterest规模的工作负载，同时使其成为一个受我们工程师喜爱的平台，这面临着许多挑战。</p><p id="0a32" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作为一家大型组织，我们在基础设施工具方面投入了大量资金，例如处理证书和密钥分发的安全工具、支持服务注册和发现的流量组件，以及提供日志和指标的可见性组件。这些都是建立在艰难的经验教训之上的组件，所以我们希望将它们集成到Kubernetes中，而不是重新发明轮子。这也使得迁移更加容易，因为我们的内部应用程序已经有了所需的支持。</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div class="ab fe cl lj"><img src="../Images/31573030d1a65a61fbd5e375cc6c1f55.png" data-original-src="https://miro.medium.com/v2/format:webp/1*b31hiO4ynbDLRrXWEFF4aQ.png"/></div><figcaption class="lf lg et er es lh li bd b be z dx">Figure 2: Runtime support for applications. To run the application in the middle, there are many other support components that need to be co-located with it.</figcaption></figure><p id="2be8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">另一方面，Kubernetes的本地工作负载模型，如部署、作业和daemonsets，不足以模拟我们自己的工作负载。可用性问题是采用Kubernetes的巨大障碍。例如，我们已经听到服务开发者抱怨丢失或错误配置的入口搞乱了他们的端点。我们也看到过批量作业用户使用模板工具生成相同作业规范的数百个副本，并以调试噩梦告终。</p><p id="2814" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对工作负载的运行时支持也在发展，所以在同一个Kubernetes集群上支持不同的版本是非常困难的。想象一下，如果我们需要面对许多版本的运行时，客户支持的复杂性，以及为它们升级或打补丁的困难。</p><h2 id="e6bf" class="lk jd hh bd je ll lm ln ji lo lp lq jm ip lr ls jq it lt lu ju ix lv lw jy lx bi translated">Pinterest自定义资源和控制器</h2><p id="95a4" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">为了给我们的工程师采用Kubernetes铺平一条更容易的道路，并使infra开发更快更顺利，我们设计了自己的定制资源定义(CRDs)。</p><p id="04fd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">CRDs提供以下功能:</p><ol class=""><li id="3762" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb ly kl km kn bi translated">将各种本地Kubernetes资源捆绑在一起，使它们作为单个工作负载工作。例如，PinterestService资源将一个部署、一个服务、一个入口和一个配置映射放在一起，因此服务开发人员无需担心为他们的服务设置DNS。</li><li id="fde1" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb ly kl km kn bi translated">为应用程序注入必要的运行时支持。用户只需要关注他们自己的业务逻辑的容器规范，而CRD控制器将必要的侧柜、初始化容器、环境变量和卷注入到他们的pod规范中。这为应用工程师提供了开箱即用的体验。</li><li id="2e1e" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb ly kl km kn bi translated">CRD控制器还对本机资源进行生命周期管理，并处理可见性和可调试性。这包括但不限于协调期望规格和实际规格、CRD状态更新和事件记录。如果没有CRDs，应用工程师必须管理更多的资源，这个过程很容易出错。</li></ol><p id="56cd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面是PinterestService和我们的控制器翻译的本地资源的一个例子:</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es kt"><img src="../Images/2ef61ac176866b5cd86e5c1f9154dc13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*G2yFB3enXGspGQ9w"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">Figure 3: CRD to native resources. The left is the Pinterest CR written by user, and the right is the native resource definition generated by the controller.</figcaption></figure><p id="13da" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如图所示，为了支持用户的容器，我们需要插入一个init容器和几个sidecars，以保证安全性、可见性和网络流量。此外，我们引入了批处理作业的配置映射模板和PVC模板支持，以及许多用于跟踪身份、资源利用和垃圾收集的环境变量。</p><p id="9686" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">很难想象没有CRD的支持，工程师会愿意手写这些配置文件，更不用说维护和调试配置了。</p><h2 id="5852" class="lk jd hh bd je ll lm ln ji lo lp lq jm ip lr ls jq it lt lu ju ix lv lw jy lx bi translated">应用程序部署工作流</h2><figure class="ku kv kw kx fd ky er es paragraph-image"><div class="er es lz"><img src="../Images/822bad8cc93ead3d474868e3af11b7f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/format:webp/1*Wf-Dt4Ji-H_GDZkYiMDS_A.png"/></div><figcaption class="lf lg et er es lh li bd b be z dx">Figure 4: Pinterest CRD Overview</figcaption></figure><p id="205a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">图4展示了如何将Pinterest定制资源部署到Kubernetes集群:</p><ol class=""><li id="c84c" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb ly kl km kn bi translated">开发人员通过CLI和UI与我们的Kubernetes集群进行交互。</li><li id="e8d8" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb ly kl km kn bi translated">CLI/UI工具从Artifactory中检索工作流配置YAML文件和其他构建属性(如版本ID ),并将它们发送到作业提交服务。这确保了只有经过审查和登陆的工作负载才会被提交到Kubernetes集群。</li><li id="f497" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb ly kl km kn bi translated">作业提交服务是各种计算平台的门户，包括Kubernetes。用户身份验证、配额实施和部分Pinterest CRD配置验证都在这里进行。</li><li id="20a0" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb ly kl km kn bi translated">一旦CRD通过作业提交服务验证，它就会被发送到Kubernetes API。</li><li id="12c9" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb ly kl km kn bi translated">我们的CRD控制器监视所有定制资源上的事件。它将CR转换为Kubernetes本地资源，将必要的边盘添加到用户定义的pod中，设置适当的环境变量，并执行其他必要的日常工作，以确保用户的应用程序容器有足够的基础设施支持。</li><li id="536c" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb ly kl km kn bi translated">然后，CRD控制器将生成的本地资源写回Kubernetes API，这样调度程序就可以获取这些资源并开始运行。</li></ol><p id="7fdc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意:这是新的基于Kubernetes的计算平台的早期采用者使用的预发布部署工作流。我们正在改进这一体验，以便与我们新的CI/CD平台完全集成，从而避免暴露大量Kubernetes特有的细节。我们期待在即将发布的博客文章“为Pinterest构建CI/CD平台”中分享动机、进展和后续影响</p><h2 id="72cc" class="lk jd hh bd je ll lm ln ji lo lp lq jm ip lr ls jq it lt lu ju ix lv lw jy lx bi translated">自定义资源类型</h2><p id="9f4b" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">基于Pinterest的特定需求，我们设计了以下适合不同工作流程的CRD:</p><ul class=""><li id="a73c" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb kk kl km kn bi translated">PinterestService是一个长期运行的无状态服务。许多核心系统都基于一组这样的服务。</li><li id="8f65" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb kk kl km kn bi translated"><strong class="ig hi"> PinterestJobSet </strong>对运行完成的批处理作业进行建模。Pinterest中一个非常常见的模式是，多个作业并行运行相同的容器，每个作业只占工作负载的一小部分，彼此不依赖。</li><li id="1721" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb kk kl km kn bi translated"><strong class="ig hi">pinterestcronbjob</strong>被轻量级周期性工作负载的团队广泛采用。PinterestCronJob是原生cron作业的包装器，具有Pinterest特有的支持，如安全性、流量、日志和指标。</li><li id="209f" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb kk kl km kn bi translated">PinterestDaemon 仅限于与基础设施相关的守护进程。随着我们在集群上增加更多支持，PinterestDaemon家族仍在不断壮大。</li><li id="3963" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb kk kl km kn bi translated">PinterestTrainingJob 包装Tensorflow和Pytorch作业，提供与所有其他CRD相同级别的运行时支持。由于Pinterest是Tensorflow和其他机器学习框架的大量用户，围绕它们建立一个专用的CRD是有意义的。</li></ul><p id="8987" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们还有正在建设的<strong class="ig hi"> PinterestStatefulSet </strong>，它将很快被用于存储和其他有状态系统。</p><h2 id="255d" class="lk jd hh bd je ll lm ln ji lo lp lq jm ip lr ls jq it lt lu ju ix lv lw jy lx bi translated">运行时支持</h2><p id="7065" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">当一个应用程序pod在Kubernetes上启动时，它会自动获得一个证书来标识自己。该证书用于通过mTLS访问机密存储或与其他服务对话。同时，配置管理初始化容器和守护进程将确保在应用程序容器启动之前下载所有必需的依赖项。当应用程序容器准备就绪时，流量边车和守护程序会将pod IP注册到我们的Zookeeper，以便让客户端可以发现它。在pod启动之前，网络守护程序已经为pod设置了网络。</p><p id="07c6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以上是服务工作负载的典型运行时支持示例。其他工作负载类型可能需要稍微不同的支持，但它们都是以pod级侧柜、节点级守护进程或虚拟机级守护进程的形式出现的。我们确保所有这些都由基础架构团队部署，因此它们在所有应用程序之间保持一致，这大大减轻了我们的维护和客户支持负担。</p><h2 id="b774" class="lk jd hh bd je ll lm ln ji lo lp lq jm ip lr ls jq it lt lu ju ix lv lw jy lx bi translated">测试和质量保证</h2><p id="b5a0" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">我们在本地的<a class="ae ma" href="https://github.com/kubernetes/test-infra" rel="noopener ugc nofollow" target="_blank"> Kubernetes测试基础上</a>构建了一个端到端的测试管道。这些测试部署到所有集群。在到达生产集群之前，这个管道已经捕获了许多回归。</p><p id="3ca9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">除了测试基础架构之外，还有监控和警报系统，可以持续监控系统组件的运行状况、资源利用率和其他关键指标，并在需要人工干预时通知我们。</p><h2 id="e5ff" class="lk jd hh bd je ll lm ln ji lo lp lq jm ip lr ls jq it lt lu ju ix lv lw jy lx bi translated">可供选择的事物</h2><p id="6e7c" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">我们考虑了一些定制资源的替代方案，比如变异接纳控制器和模板系统。然而，所有的选择都伴随着重大的问题，所以我们选择了CRDs。</p><ul class=""><li id="eade" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb kk kl km kn bi translated">变异准入控制器已被用来注入边车，环境变量和其他运行时支持。然而，它很难将资源捆绑在一起并管理它们的生命周期，而CRD提供了协调、状态更新和生命周期管理。</li><li id="4d07" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb kk kl km kn bi translated">Helm charts等模板系统也广泛用于启动具有类似配置的应用程序。然而，我们的工作负载太多种多样，无法通过模板来管理。我们还需要支持连续部署，这对于模板来说是非常容易出错的。</li></ul><h1 id="5306" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">未来的工作</h1><p id="a01b" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">目前，我们在所有的Kubernetes集群上运行混合工作负载。为了支持不同规模和类型的工作负载，我们致力于以下几个方面:</p><ul class=""><li id="1972" class="kf kg hh ig b ih ii il im ip kh it ki ix kj jb kk kl km kn bi translated">集群联合将大型应用程序分布在不同的集群上，以实现可伸缩性和稳定性。</li><li id="a43f" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb kk kl km kn bi translated">群集稳定性、可扩展性和可见性，确保应用程序达到其SLA。</li><li id="f128" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb kk kl km kn bi translated">资源和配额管理，以确保应用程序互不干扰，并且群集规模在控制之下。</li><li id="5646" class="kf kg hh ig b ih ko il kp ip kq it kr ix ks jb kk kl km kn bi translated">新的CI/CD平台支持Kubernetes上的应用程序部署</li></ul><h1 id="657e" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">承认</h1><p id="ff7b" class="pw-post-body-paragraph ie if hh ig b ih ka ij ik il kb in io ip kc ir is it kd iv iw ix ke iz ja jb ha bi translated">Pinterest的许多工程师从头开始帮助构建这个平台。负责工程生产力工作的Micheal Benedict和Yongwen Xu从一开始就共同努力设定计算平台的方向，讨论设计并帮助确定功能优先级。Jasmine Qin和Kaynan Lalone在Jenkins和Artifactory集成支持方面提供了帮助。Fuyuan Bie、Brain Overstreet、朱未、Ambud Sharma、杨宇、Jeremy Karch、Jayme Cox和许多其他人帮助构建了配置管理、指标、日志记录、安全性、网络和其他基础架构支持。朱成金和吴仲强帮助建立了提交服务。最后，我们的早期采用者Prasun Ghosh、Michael Permana、Jinfeng Zhuang和Ashish Singh提供了许多有用的反馈和功能需求。</p></div></div>    
</body>
</html>