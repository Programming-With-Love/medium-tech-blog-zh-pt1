<html>
<head>
<title>Writing fast, deterministic and accurate Android Integration tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编写快速、确定和准确的Android集成测试</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/writing-fast-deterministic-and-accurate-android-integration-tests-c56811bd14e2?source=collection_archive---------1-----------------------#2017-06-21">https://medium.com/airbnb-engineering/writing-fast-deterministic-and-accurate-android-integration-tests-c56811bd14e2?source=collection_archive---------1-----------------------#2017-06-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="5f0e" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">OkReplay简介——在测试中记录和重放OkHttp网络交互。</h2></div><p id="2099" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在Airbnb，运送高质量的产品至关重要。为了实现这个目标，我们使用自动化测试在错误到达用户之前捕捉它们。在这篇文章中，我们将描述我们如何使用一种特定类型的自动化测试，UI测试，来确保我们的Android应用程序的质量，并将宣布开源发布<a class="ae js" href="https://github.com/airbnb/okreplay" rel="noopener ugc nofollow" target="_blank"> OkReplay </a>。</p></div><div class="ab cl jt ju go jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="ha hb hc hd he"><p id="fc2a" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们对Android UI测试的选择是<a class="ae js" href="https://google.github.io/android-testing-support-library/docs/espresso/" rel="noopener ugc nofollow" target="_blank"> Espresso </a>，它可以说是最好的、最受欢迎的和推荐的用于编写集成测试的库。然而，可靠的测试套件所提供的额外信心可能会很快受到奇怪测试的影响，破坏每个人对它们的信任。事实上，<a class="ae js" href="https://youtu.be/_5Sr4EYH7M8?t=9m34s" rel="noopener ugc nofollow" target="_blank">片石试验是毒药！</a></p><p id="cb1f" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">集成测试在<a class="ae js" href="https://martinfowler.com/bliki/TestPyramid.html" rel="noopener ugc nofollow" target="_blank">测试金字塔</a>的最顶端，但这并不意味着它们必须写得慢、脆弱或昂贵。它们应该由更大范围的服务和单元级测试来补充。</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div class="er es ka"><img src="../Images/c7f056915e871e2d9e30d70f982b10de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*R6jDeERbTN4Bgh9x07FG9w.png"/></div><figcaption class="ki kj et er es kk kl bd b be z dx"><a class="ae js" href="https://martinfowler.com/bliki/TestPyramid.html" rel="noopener ugc nofollow" target="_blank">Martin Fowler’s Test Pyramid</a></figcaption></figure><p id="cc89" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">作为服务层测试的一个例子，我们可以构建一组API来提供测试夹具，这些夹具可以构建在测试执行期间使用的假域模型(例如:Ruby的<a class="ae js" href="https://github.com/thoughtbot/factory_girl" rel="noopener ugc nofollow" target="_blank"> FactoryGirl </a>和<a class="ae js" href="https://github.com/sevenwire/forgery" rel="noopener ugc nofollow" target="_blank"> Forgery </a>)。</p><p id="45f4" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">回到UI测试，严重依赖网络的流程(例如:通常执行许多API请求)在测试执行期间经常受到网络不稳定性的影响。这是通过高翻转率观察到的，也就是说，在调用之间，测试从失败切换到成功的速率，反之亦然。暴露这种缺陷的方法之一是安排测试每小时运行一次，例如，有或没有代码变化，以测量它们的稳定性。基于我们的发现，我们开始研究如何从这个等式中去除网络变量。我们中的一些人熟悉令人敬畏的VCR库，它在Ruby/Rails中很流行，但是在Android中似乎没有类似的东西。于是OkReplay诞生了。</p><p id="5fa3" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">因为所有的Airbnb网络流量都通过OkHttp，所以创建一个<a class="ae js" href="https://github.com/square/okhttp/wiki/Interceptors" rel="noopener ugc nofollow" target="_blank">拦截器</a>来进行网络记录和回放似乎是最简单的方法。拦截器非常强大，可以根据需要修改网络调用，这正是我们所需要的。在寻找类似的解决方案时，我们还发现了令人敬畏的<a class="ae js" href="https://github.com/betamaxteam/betamax" rel="noopener ugc nofollow" target="_blank"> Betamax </a>项目，该项目旨在解决一个非常类似的问题，但在设计时并没有考虑Android或OkHttp。不管怎样，由于那个项目的大部分目标与我们的需求相似，我们决定从它的代码库着手，并根据需要进行修改，以确保它对Android和OkHttp友好。其中一些目标是:</p><ol class=""><li id="46df" class="km kn hh iy b iz ja jc jd jf ko jj kp jn kq jr kr ks kt ku bi translated">与现有测试无缝集成</li><li id="d426" class="km kn hh iy b iz kv jc kw jf kx jj ky jn kz jr kr ks kt ku bi translated">对生产没有影响，也不会改变应用行为。它应该在测试过程中明确启用</li><li id="dc04" class="km kn hh iy b iz kv jc kw jf kx jj ky jn kz jr kr ks kt ku bi translated">很少或没有对第三方库的依赖</li><li id="3da8" class="km kn hh iy b iz kv jc kw jf kx jj ky jn kz jr kr ks kt ku bi translated">适用于OkHttp、JUnit和Espresso</li><li id="ee21" class="km kn hh iy b iz kv jc kw jf kx jj ky jn kz jr kr ks kt ku bi translated">记录的交互应该易于阅读、修改并提交给源代码控制</li><li id="d5c9" class="km kn hh iy b iz kv jc kw jf kx jj ky jn kz jr kr ks kt ku bi translated">不需要运行外部服务或代理就可以工作</li></ol><p id="c765" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Betamax检查了几乎所有的箱子，除了4号和6号。另一个选项是<a class="ae js" href="http://wiremock.org/docs/record-playback/" rel="noopener ugc nofollow" target="_blank"> Wiremock </a>，但是它不满足第6项。幸运的是，扩展Betamax非常简单，因为它有令人敬畏的模块化架构和测试覆盖面。此外，有了明确定义的约束，特别是对OkHttp的硬依赖，允许我们构建一个更简单的解决方案，因为我们不需要为每个Http客户端解决它！</p><h2 id="ef09" class="la lb hh bd lc ld le lf lg lh li lj lk jf ll lm ln jj lo lp lq jn lr ls lt lu bi translated">在后台</h2><p id="0e57" class="pw-post-body-paragraph iw ix hh iy b iz lv ii jb jc lw il je jf lx jh ji jj ly jl jm jn lz jp jq jr ha bi translated">简而言之，OkReplay归结为一个简单的OkHttp拦截器，当打开时，它会查看每个传出的请求，或者将它们与一组预先记录的“网络交互”进行匹配并重放它们，或者在网络响应一下来就捕获网络响应并保存它们。这些录音被称为“磁带”。这个术语是从VCR继承来的，在VCR中，磁带是以<a class="ae js" href="http://yaml.org/" rel="noopener ugc nofollow" target="_blank"> YAML格式</a>存储网络交互的简单文件。您可以将这些文件视为简单的测试装置。</p><p id="3e1e" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">对于Android Espresso测试，磁带默认存储在<code class="du ma mb mc md b">src/androidTest/assets/tapes</code>中，并在测试执行期间使用Android的<code class="du ma mb mc md b">AssetManager</code>作为常规资产加载(读取)。对于记录(写入)，它们存储在设备的外部存储目录中，并在测试执行后使用OkReplay自带的简单Gradle插件自动从设备中取出。发生这种区别是因为测试APK不能在运行时覆盖它自己的包内容来修改YAML资产文件，所以我们唯一的选择是把它写到外部存储器，并使用Gradle插件覆盖文件。磁带应易于阅读，并可根据需要进行修改。</p><figure class="kb kc kd ke fd kf"><div class="bz dy l di"><div class="me mf l"/></div><figcaption class="ki kj et er es kk kl bd b be z dx">Sample OkReplay tape</figcaption></figure><p id="6e48" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">OkReplay还有一些其他的关键因素。首先是<code class="du ma mb mc md b">Recorder</code>，它由一个JUnit <code class="du ma mb mc md b">TestRule</code>组成，负责加载适当的测试磁带，启动和停止拦截器，并在测试完成后写入磁带文件。第二，<code class="du ma mb mc md b">TapeLoader</code>，顾名思义，加载和写入(YAML)磁带文件。最后是<code class="du ma mb mc md b">MatchRules</code>，它定义了基于一组预定义的内置规则或基于每个应用程序特定需求的定制逻辑来匹配请求的方法。</p><h2 id="40ec" class="la lb hh bd lc ld le lf lg lh li lj lk jf ll lm ln jj lo lp lq jn lr ls lt lu bi translated">使用确定重放</h2><p id="872b" class="pw-post-body-paragraph iw ix hh iy b iz lv ii jb jc lw il je jf lx jh ji jj ly jl jm jn lz jp jq jr ha bi translated">使用OkReplay就像用<code class="du ma mb mc md b">@OkReplay</code>注释测试方法一样简单，例如:</p><figure class="kb kc kd ke fd kf"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="2d7c" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">注释允许您选择性地指定一些配置选项，如磁带名、<code class="du ma mb mc md b">TapeMode</code>和<code class="du ma mb mc md b">MatchRules</code>。</p><p id="bfb0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在使用之前，您需要将<code class="du ma mb mc md b">OkReplayInterceptor</code>添加到您的<code class="du ma mb mc md b">OkHttpClient</code>实例中，并注册OkReplay JUnit <code class="du ma mb mc md b">TestRule</code>:</p><figure class="kb kc kd ke fd kf"><div class="bz dy l di"><div class="me mf l"/></div><figcaption class="ki kj et er es kk kl bd b be z dx">Setting up the TestRule</figcaption></figure><p id="14d8" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">就是这样！使用OkHttp运行<code class="du ma mb mc md b">testFoo()</code>时发出的任何网络请求将立即自动通过OkReplay。默认情况下，<code class="du ma mb mc md b">TestMode</code>是<code class="du ma mb mc md b">READ_ONLY</code>，这意味着它会拒绝任何请求，直到您为它们录制了磁带。在这种情况下，在查看设备的Logcat输出时，您会看到如下所示的错误消息:</p><figure class="kb kc kd ke fd kf"><div class="bz dy l di"><div class="me mf l"/></div><figcaption class="ki kj et er es kk kl bd b be z dx">Error message on Logcat</figcaption></figure><p id="82fd" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">运行时，默认情况下，OkReplay不允许任何网络请求访问网络，除非<code class="du ma mb mc md b">TapeMode</code>是“可写的”(无论是<code class="du ma mb mc md b">READ_WRITE</code>还是<code class="du ma mb mc md b">WRITE_ONLY</code>)。这是为了确保测试的可重复性和确定性。</p><p id="4856" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">一旦您记录了所有的交互，您甚至可以在设备处于飞行模式时运行您的测试，并且仍然可以看到它们正常工作，假设您没有任何其他对网络的硬依赖。</p><p id="d924" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最后，由于OkReplay是一个只在测试时使用的库，您可以使用它的<code class="du ma mb mc md b">no-op</code>变体作为<code class="du ma mb mc md b">releaseCompile</code>依赖项，以确保您的发布应用程序附带了OkReplayInterceptor的存根版本。</p><h2 id="3c6a" class="la lb hh bd lc ld le lf lg lh li lj lk jf ll lm ln jj lo lp lq jn lr ls lt lu bi translated">结论</h2><p id="1bbc" class="pw-post-body-paragraph iw ix hh iy b iz lv ii jb jc lw il je jf lx jh ji jj ly jl jm jn lz jp jq jr ha bi translated">通过开源这个库并与更广泛的Android社区共享，我们希望激励开发人员编写更多的测试并更自信地发布高质量的应用程序！</p></div><div class="ab cl jt ju go jv" role="separator"><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy jz"/><span class="jw bw bk jx jy"/></div><div class="ha hb hc hd he"><p id="101e" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">一如既往，随时<a class="ae js" href="https://github.com/airbnb/okreplay" rel="noopener ugc nofollow" target="_blank">叉它</a>，给我们发送反馈，错误报告和拉请求。如果你想加入我们，为像这样有趣的挑战寻找更多创造性的解决方案，<a class="ae js" href="https://www.airbnb.com/careers/departments/position/2281" rel="noopener ugc nofollow" target="_blank">我们正在招聘</a>！😃</p></div></div>    
</body>
</html>