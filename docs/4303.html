<html>
<head>
<title>Selfie2Anime with TFLite — Part 3: Android App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带TFLite的Selfie2Anime第3部分:Android应用程序</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/selfie2anime-with-tflite-part-3-android-app-e47f8a2c92b2?source=collection_archive---------4-----------------------#2020-07-15">https://medium.com/google-developer-experts/selfie2anime-with-tflite-part-3-android-app-e47f8a2c92b2?source=collection_archive---------4-----------------------#2020-07-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="ffc1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由ML GDEs <a class="ae jc" href="https://twitter.com/margaretmz" rel="noopener ugc nofollow" target="_blank">撰写Margaret Maynard-Reid </a> |由<a class="ae jc" href="https://twitter.com/RisingSayak" rel="noopener ugc nofollow" target="_blank"> Sayak Paul </a>、<a class="ae jc" href="https://twitter.com/khanhlvg" rel="noopener ugc nofollow" target="_blank"> Khanh LeViet </a>和<a class="ae jc" href="https://twitter.com/hoitab" rel="noopener ugc nofollow" target="_blank"> Hoi Lam </a>审阅</p><p id="59da" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是一个端到端教程的第3部分，介绍如何将TF 1.x模型转换为TensorFlow Lite (TFLite ),然后将其部署到Android上，以便将自拍图像转换为可信的动画。(<a class="ae jc" rel="noopener" href="/@margaretmz/selfie2anime-with-tflite-part-1-overview-f97500800ffe">Part 1</a>|<a class="ae jc" rel="noopener" href="/@margaretmz/selfie2anime-with-tflite-part-2-tflite-model-84002cf521dc">Part 2</a>|<a class="ae jc" rel="noopener" href="/@margaretmz/selfie2anime-with-tflite-part-3-android-app-e47f8a2c92b2">Part 3</a>)本教程是<a class="ae jc" href="https://github.com/margaretmz/awesome-tflite" rel="noopener ugc nofollow" target="_blank"> awesome-tflite </a>系列E2E TFLite教程的第一篇。</p><p id="f104" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在第2部分中，我们得到了一个TFLite模型，现在我们准备将selfie2anime.tflite模型部署到Android上！Android代码在GitHub <a class="ae jc" href="https://github.com/margaretmz/selfie2anime-with-tflite/tree/master/android/" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="5b0e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下是Android应用的主要特性:</p><ul class=""><li id="7444" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated"><strong class="ig hi">用于UI导航的Jetpack导航组件</strong></li><li id="8b56" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><code class="du jr js jt ju b"><strong class="ig hi">CameraX</strong></code>用于图像捕捉</li><li id="fe20" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi"> ML模型绑定</strong>用于导入tflite模型</li><li id="87e9" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated"><strong class="ig hi"> Kotlin协程</strong>用于模型推理的异步处理</li></ul><p id="f99e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下面是TFLite模型在Android上的逐步实现:</p><p id="5dfe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">0.下载Android Studio 4.1预览版</p><p id="c8b4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">1.创建一个新的Android项目并设置UI导航</p><p id="2d70" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2.为图像捕获设置<code class="du jr js jt ju b">CameraX</code> API</p><p id="6608" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">3.用ML模型绑定导入selfie2anime.tflite模型。</p><p id="e45d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">4.将所有东西放在一起:</p><ul class=""><li id="d119" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">模型输入:用相机拍摄自拍图像</li><li id="3353" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">在自拍图像上运行推理并创建一个动画</li><li id="0005" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">在UI中显示自拍图像和动画图像</li><li id="8b7c" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">使用Kotlin协程防止模型推理阻塞UI主线程</li></ul><p id="0889" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 0。下载Android Studio 4.1预览版</strong></p><p id="231b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们将安装Android Studio Preview (4.1 Beta 1)，以便使用新的<strong class="ig hi"> ML模型绑定</strong>功能来导入. tflite模型和自动代码生成。您可以直观地探索tfllite模型，也可以在您的Android项目中直接使用生成的类。</p><p id="01b4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这里下载Android Studio预览<a class="ae jc" href="https://developer.android.com/studio/preview" rel="noopener ugc nofollow" target="_blank">。您应该能够同时运行预览版和稳定版。确保将您的Gradle插件更新到至少4.1.0-alpha10，否则ML绑定菜单可能无法访问。</a></p><p id="d8be" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 1。创建一个新的Android项目</strong></p><p id="ee49" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先，让我们创建一个新的Android项目，该项目包含一个名为MainActivity的空活动，该活动包含一个伴生对象，该对象定义了存储图像(用CameraX捕获)的输出目录。</p><p id="ebb4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用Jetpack导航组件在应用程序中导航。请参考我的教程<a class="ae jc" rel="noopener" href="/@margaretmz/android-ui-with-jetpack-nav-component-5ef46d9e0cfc">这里</a>了解更多关于这个支持库的细节。</p><p id="6178" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这个示例应用程序中有3个屏幕:</p><ul class=""><li id="ebce" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">PermissionsFragment —处理相机权限的检查</li><li id="e3cd" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">相机片段—处理相机设置和图像捕捉</li><li id="e941" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">自拍2动画片段—处理用户界面中自拍和动画图像的显示</li></ul><p id="a2c8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">nav_graph.xml中的导航图将定义三个屏幕的导航以及CameraFragment和Selfie2animeFragment之间的数据传递。</p><p id="2ba7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 2。为图像拍摄设置CameraX</strong></p><p id="6388" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">CameraX是一个Jetpack支持库，它使得相机应用程序的开发更加容易。</p><p id="ecc0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Camera1 API使用简单，但缺少很多功能。Camera 2 API提供了比Camera 1更好的控制，但是它非常复杂——在一个非常基本的例子中有将近1000行代码。</p><p id="ca50" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">另一方面，CameraX更容易设置，只需十分之一的代码。此外，它具有生命周期意识，因此您不需要编写额外的代码来处理生命周期。</p><p id="8dc8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">以下是为该示例应用程序设置CameraX的步骤:</p><ul class=""><li id="a70a" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">更新<code class="du jr js jt ju b">build.gradle</code>依赖关系</li><li id="f2b7" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">使用<code class="du jr js jt ju b">CameraFragment.kt</code>保存CameraX代码</li><li id="b099" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">请求相机许可</li><li id="c397" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">更新<code class="du jr js jt ju b">AndroidManifest.ml</code></li><li id="b875" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">在<code class="du jr js jt ju b">MainActivity.kt</code>中检查权限</li><li id="7569" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">用<code class="du jr js jt ju b">CameraX</code>实现一个取景器<code class="du jr js jt ju b">Preview</code>类</li><li id="30db" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">实现图像捕捉</li><li id="a511" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">捕捉图像并将其转换为<code class="du jr js jt ju b">Bitmap</code></li></ul><p id="e62e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦我们捕获了一个图像，我们将把它转换成一个<code class="du jr js jt ju b">Bitmap</code>，我们可以把它传递给TFLite模型进行推理。导航到一个新的屏幕<code class="du jr js jt ju b">Selfie2animeFragment.kt</code>，显示原始自拍和动画图像。</p><p id="ebff" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 3。导入TensorFlow Lite模型</strong></p><p id="67b5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">既然UI代码已经完成。是时候导入TensorFlow Lite模型进行推理了。ML模型绑定很容易解决这个问题。在Android Studio中，进入<strong class="ig hi">文件&gt;新建&gt;其他&gt; TensorFlow Lite模型。</strong></p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es jv"><img src="../Images/a8a664ec005de77e6fe14e779eab1ccc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*o1OlnG5e5JAAvKvt"/></div></div></figure><ul class=""><li id="b8de" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">指定selfie2anime.tflite文件位置。</li><li id="8093" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">默认情况下，“自动将构建功能和所需的依赖项添加到gradle”处于选中状态。</li><li id="0e04" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">请确保同时选中“自动将TensorFlow Lite gpu依赖项添加到gradle ”,因为selfie2anime模型非常慢，我们需要启用GPU delegate。</li></ul><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es kh"><img src="../Images/82c41c8b6c32ccbe1026dd7832b361f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_a2T5WKHEURBf0Nz"/></div></div></figure><p id="0ef6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个导入做了两件事:</p><ul class=""><li id="0704" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">自动创建一个<em class="ki"> ml </em>文件夹，并将模型文件selfie2anime.tflite文件放在该文件夹下。</li><li id="ddaa" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">在文件夹下自动生成一个名为<code class="du jr js jt ju b">Selfie2anime.java</code>的Java类:app/build/generated/ml _ source _ out/debug/com/TF lite/selfie 2 anime/ml，该类将处理模型加载、图像预处理和后处理等所有任务，并运行模型推理将自拍图像转换为动漫图像。</li></ul><p id="53e7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">导入完成后，我们会看到selfie2anime.tflite显示了模型元数据信息以及Kotlin和Java代码片段，我可以复制并粘贴这些代码片段来使用模型:</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div role="button" tabindex="0" class="kb kc di kd bf ke"><div class="er es kj"><img src="../Images/76016ad167f7942dc05a3aceb5fb5c6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O_9yVTyPOBkXiJoWtteH6w.png"/></div></div></figure><p id="0e6b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> 4。将所有东西放在一起</strong></p><p id="2695" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们已经设置了UI导航，配置了CameraX进行图像捕捉，并且导入了selfie2anime.tflite模型，下面让我们将所有的部分放在一起！首先我们在<em class="ki">image capture下的CameraFragment.kt中用CameraX捕捉一张自拍图像。。takePicture() </em>，那么在<em class="ki"> onCaptureSuccess() </em>中有一个返回的ImageProxy。我们将ImageProxy转换成位图，然后保存到前面MainActivity中定义的输出目录中。</p><p id="1a0b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用JetPack nav组件，我们可以轻松地导航到Selfie2animeFragment，并将图像目录位置作为字符串参数传递。</p><p id="a0d2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后在<em class="ki">self ie 2 animefragment . kt</em>中，检索存储自拍的文件目录字符串，创建一个图像文件，然后将其转换为位图，可以作为tflite模型的输入。</p><p id="4860" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在自拍图像上运行模型推理，并创建一个动画。我们在UI中显示自拍图像和动画图像。</p><p id="c9fe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意:推理需要相当长的时间，所以我们使用Kotlin协程来防止模型推理阻塞UI主线程。显示进度条，直到模型推理完成。</p><p id="71da" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是我们将所有的碎片拼在一起后得到的结果:</p><figure class="jw jx jy jz fd ka er es paragraph-image"><div class="er es kk"><img src="../Images/033fac6b9eea307f663ea0e5bb01bbe9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*HgOkKc4LVg2RUI2CgRFyTw.png"/></div></figure></div><div class="ab cl kl km go kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ha hb hc hd he"><p id="dbbd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这就把我们带到了教程的结尾。我们希望您喜欢阅读它，并将您学到的知识应用到TensorFlow Lite的实际应用中。如果你用你在这里学到的创造了任何酷的样品，请记得把它添加到<a class="ae jc" href="https://github.com/margaretmz/awesome-tflite" rel="noopener ugc nofollow" target="_blank"> awesome-tflite </a>！</p></div></div>    
</body>
</html>