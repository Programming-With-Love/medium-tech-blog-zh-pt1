<html>
<head>
<title>An Introduction to Geospatial Processing with Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spark地理空间处理简介</h1>
<blockquote>原文：<a href="https://medium.com/version-1/an-introduction-geospatial-processing-with-spark-d78dffd0ff1e?source=collection_archive---------1-----------------------#2021-01-26">https://medium.com/version-1/an-introduction-geospatial-processing-with-spark-d78dffd0ff1e?source=collection_archive---------1-----------------------#2021-01-26</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="fa5c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这个新的信息时代，地理空间数据在数据工程和数据分析工作中变得越来越重要…但是当我们谈论地理空间数据时，我们指的是什么？</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/68360e058dbe020a0584db7c7e7cb304.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kHdSYl9kqjSxO4Em"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Photo by <a class="ae js" href="https://unsplash.com/@hharritt?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Hunter Harritt</a> on <a class="ae js" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="d8fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这篇文章中，我想介绍一些关于使用Spark进行地理空间处理的基本概念，Spark是2020年最流行的数据处理框架之一。</p><p id="080a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">先说基础，什么是地理空间数据？</p><pre class="jd je jf jg fd jt ju jv jw aw jx bi"><span id="de07" class="jy jz hh ju b fi ka kb l kc kd"><strong class="ju hi">Geospatial data </strong>is about objects, events or phenomena that have a location on the surface of the Earth (let’s not worry about other planets yet… Sorry, Mars Rover)</span></pre><p id="c100" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这在数据上意味着什么？嗯……我们可以只用一个字符串来表示地理空间数据，这样做的两种最流行的格式是:</p><ul class=""><li id="73e0" class="ke kf hh ig b ih ii il im ip kg it kh ix ki jb kj kk kl km bi translated"><strong class="ig hi">geo JSON</strong>:{ " geometry ":{ " type ":" Polygon "，" coordinates ":[[100.0，0.0]，[101.0，0.0]，[101.0，1.0]，[100.0，1.0]，[100.0，0.0]]} }</li><li id="c6bb" class="ke kf hh ig b ih kn il ko ip kp it kq ix kr jb kj kk kl km bi translated"><strong class="ig hi">众所周知的文字(WKT) </strong>:多边形((100.0 0.0，101.0 0.0，101.0 1.0，100.0 1.0，100.0 0.0))</li></ul><p id="0332" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">上面的例子代表了这个多边形:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es ks"><img src="../Images/42c7ebf380e43b79d28cf6b8ffe5722e.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/format:webp/1*u3hMI8o-Pb1GHQTqQO6uug.png"/></div><figcaption class="jo jp et er es jq jr bd b be z dx">Polygon representation</figcaption></figure><p id="d879" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是作为一个<strong class="ig hi">字符串</strong>的数据不是很有用，因为我们想对它们使用一些空间操作符，而用一个字符串来做这些真的很难…因此我们使用了一种叫做<strong class="ig hi">几何类型</strong>的东西。这种数据类型并非在每个系统中都可用，它允许使用空间操作符，如<strong class="ig hi">contains</strong>、<strong class="ig hi">insect、</strong>等等:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es kt"><img src="../Images/b1fc045acc0a84f478242b1abdbebece.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*CUJA9bXNC2A1lJI4UxJf9Q.png"/></div><figcaption class="jo jp et er es jq jr bd b be z dx">Examples of Geospatial operators</figcaption></figure><p id="1853" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当然，我们可以在没有任何几何类型的情况下做到这一点，但是做(多边形A和多边形B)的<strong class="ig hi">交集、</strong>比编写该操作背后的所有数学代码要容易得多。</p></div><div class="ab cl ku kv go kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ha hb hc hd he"><h1 id="84bd" class="lb jz hh bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">那么…我如何在Spark中完成所有这些呢？</h1><p id="ee91" class="pw-post-body-paragraph ie if hh ig b ih ly ij ik il lz in io ip ma ir is it mb iv iw ix mc iz ja jb ha bi translated">Spark没有嵌入<strong class="ig hi">几何类型</strong>，但幸运的是，有些人已经并继续为我们工作(感谢开源社区！)…因此，如何做到这一点有几个选择:</p><p id="5ff6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">- <strong class="ig hi">使用第三方库</strong>:有几个选项可用，比如<strong class="ig hi"> GeoSpark </strong>、<strong class="ig hi">GeoMesa</strong>……如果你能在那里找到你需要的转换，这是合适的……所以不要重新发明轮子，使用其他人已经开发和测试的。</p><p id="613d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">- <strong class="ig hi">包装现有的核心库</strong>:如果可用的Spark库不符合您的要求，您可以更进一步，在Spark中包装一个现有的地理空间实现。通常情况下，JTS是你能找到的最低级的库。所有其他人都以此为起点。它只提供几何图形之间的数据类型和一些基本操作。这是一个java库，所以如果你想在Spark中使用它，你需要自己修改它。</p><p id="3f57" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">- <strong class="ig hi">从头开始实现一切</strong>:这可能需要多年的工作…</p><h1 id="cbc1" class="lb jz hh bd lc ld md lf lg lh me lj lk ll mf ln lo lp mg lr ls lt mh lv lw lx bi translated">在这篇介绍中，我将展示GeoSpark的基础知识</h1><h2 id="cc15" class="jy jz hh bd lc mi mj mk lg ml mm mn lk ip mo mp lo it mq mr ls ix ms mt lw mu bi translated">…我们可能会在下一篇文章中更深入地探讨:)</h2><p id="3f12" class="pw-post-body-paragraph ie if hh ig b ih ly ij ik il lz in io ip ma ir is it mb iv iw ix mc iz ja jb ha bi translated">假设您在Databricks环境中工作，使用GeoSpark非常简单。您只需要向集群添加两个Maven库，就这样:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es mv"><img src="../Images/2766549640a15df3c1ad6ed07b1b8940.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*P7F8_Q6WX_sRHMf2HK4CTQ.png"/></div><figcaption class="jo jp et er es jq jr bd b be z dx">GeoSpark libraries in Databricks Cluster</figcaption></figure><p id="e981" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦安装了这些库，您就可以打开笔记本，开始使用这些地理空间功能！就这么简单。</p><p id="d4c9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们首先定义一个包含一些地理空间数据的表:(我将在这里复制单元格的代码，并添加结果的截图)</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="mw mx l"/></div></figure><p id="0592" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这些行代表一些多边形:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es my"><img src="../Images/ca1187f3af0de39638b195fa33aba8cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:642/format:webp/1*NCSwR9VCvypKRupYRIZQJw.png"/></div></figure><p id="95ef" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了使用GeoSpark提供的UDF，我们可以运行以下命令:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="mw mx l"/></div></figure><p id="ba10" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们需要将字符串转换为正确的几何类型，为此我们需要执行以下操作:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="mw mx l"/></div></figure><p id="d60e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所以现在我们的几何列是几何类型<strong class="ig hi">几何类型</strong>:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es mz"><img src="../Images/75a3f407913f89fdeba21cab1456436f.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/format:webp/1*lGIqwjTYOOF88zYfxSsoAg.png"/></div></figure><p id="e446" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们已经准备好运行一些空间操作…但为了使这更容易，让我们创建一个临时表，以便我们可以运行SQL查询。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="mw mx l"/></div></figure><p id="270f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们得到每个多边形的面积:</p><pre class="jd je jf jg fd jt ju jv jw aw jx bi"><span id="a110" class="jy jz hh ju b fi ka kb l kc kd">SELECT *, ST_Area(geometry) AS area FROM GeoTable</span></pre><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es na"><img src="../Images/e076a5a3762e9b231268484bbe8fc002.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*rQ1ygaDDOx53TzUy3pN55A.png"/></div></figure><p id="72f6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们得到每个多边形的质心:</p><pre class="jd je jf jg fd jt ju jv jw aw jx bi"><span id="2427" class="jy jz hh ju b fi ka kb l kc kd">SELECT *, ST_Centroid (geometry) AS centroid FROM GeoTable</span></pre><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es nb"><img src="../Images/075bfd09d1e264b13755c2cf52f07646.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*HtOJfAUJ-POHe3xKUslxiA.png"/></div></figure><p id="23ca" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">那些函数，那些你直接应用到几何列的函数，叫做just函数。</p><p id="8e25" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">还有其他类型，如谓词，允许您检查不同多边形之间的条件。</p><p id="0a3a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要使用它们，您需要至少有两个几何图形，因此让我们通过创建一个新表来实现这种情况:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="mw mx l"/></div></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es nc"><img src="../Images/ea734df884ea9ce18604650658ba5682.png" data-original-src="https://miro.medium.com/v2/resize:fit:990/format:webp/1*XRni8nfy_uFkYWIVFir3lA.png"/></div></figure><p id="c645" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有了这个新的数据框架，我们可以运行一些空间查询来检查某些条件，例如:</p><ul class=""><li id="70a2" class="ke kf hh ig b ih ii il im ip kg it kh ix ki jb kj kk kl km bi translated">检查两个几何图形是否相交。</li><li id="ea1e" class="ke kf hh ig b ih kn il ko ip kp it kq ix kr jb kj kk kl km bi translated">检查几何图形是否在其他内。</li></ul><pre class="jd je jf jg fd jt ju jv jw aw jx bi"><span id="af93" class="jy jz hh ju b fi ka kb l kc kd">SELECT ID1, <br/>       ID2, <br/>       ST_Intersects(geometry1, geometry2)AS Intersects,<br/>       ST_Within(geometry1, geometry2)AS Within<br/>FROM GeoTable2</span></pre><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es nd"><img src="../Images/bf6b419ee6a05352a3451aea8a1d4b99.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/1*AyB8g7ezNRgdE9SLZKiAOg.png"/></div></div></figure><p id="2622" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你可以看到，使用<strong class="ig hi"> Geospark </strong>真的很容易，这要感谢它的<strong class="ig hi"> SQL API </strong>。</p><p id="50b1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在以后的文章中，我将更深入地研究更多的地理空间处理。</p><p id="3dc6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">感谢阅读！</p><p id="ff33" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">关于作者</strong></p><p id="c0cc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae js" rel="noopener" href="/@dangp"><em class="ne">Daniel gonzález pérez</em></a><em class="ne">是版本1的大数据开发人员，目前从事版本1的数据分析实践。</em></p></div></div>    
</body>
</html>