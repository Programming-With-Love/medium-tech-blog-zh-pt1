<html>
<head>
<title>Kotlin static code analysis using Detekt</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Detekt的Kotlin静态代码分析</h1>
<blockquote>原文：<a href="https://medium.com/globant/kotlin-static-code-analysis-using-detekt-713457745a20?source=collection_archive---------1-----------------------#2021-04-09">https://medium.com/globant/kotlin-static-code-analysis-using-detekt-713457745a20?source=collection_archive---------1-----------------------#2021-04-09</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/72316232876cc45256443d29e801d2be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E8TeKtziFzRBbmZA09DH8g.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Designed by <a class="ae it" href="https://www.freepik.com/" rel="noopener ugc nofollow" target="_blank">freepik</a></figcaption></figure><h1 id="4836" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">介绍</h1><blockquote class="js jt ju"><p id="5d43" class="jv jw jx jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ha bi translated">静态代码分析是对软件的分析，它是在不实际执行程序的情况下进行的。</p></blockquote><p id="4575" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">它解决了源代码中的弱点，这可以通过手工代码审查来实现；然而，使用自动化工具更有效，也是更好的方式。</p><p id="ad39" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">例如，在下面的代码片段中，<em class="jx"> sampleMethod() </em>有将近10个参数，如果参数的数量持续增加，那么维护起来会非常困难。这些类型的问题很难人工识别，这种自动化工具在这里扮演着重要的角色。</p><figure class="kx ky kz la fd ii"><div class="bz dy l di"><div class="lb lc l"/></div></figure><p id="7cca" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">在本文中，我们将探讨静态代码检查工具之一的<a class="ae it" href="https://detekt.github.io/detekt/" rel="noopener ugc nofollow" target="_blank"> <strong class="jy hi"> Detekt </strong> </a>。</p><p id="a977" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">Detekt试图通过实施一组规则来改进代码库，这些规则包括复杂性、命名等。它可以与CI集成，在我们试图将代码与一些代码气味合并的情况下，它将充当安全网。</p><h2 id="a583" class="ld iv hh bd iw le lf lg ja lh li lj je ku lk ll ji kv lm ln jm kw lo lp jq lq bi translated">特征</h2><ul class=""><li id="0c92" class="lr ls hh jy b jz lt kd lu ku lv kv lw kw lx kt ly lz ma mb bi translated">Kotlin项目的代码味道分析</li><li id="188f" class="lr ls hh jy b jz mc kd md ku me kv mf kw mg kt ly lz ma mb bi translated">高度可配置</li><li id="5872" class="lr ls hh jy b jz mc kd md ku me kv mf kw mg kt ly lz ma mb bi translated">用Kotlin的<code class="du mh mi mj mk b">@Suppress</code>和Java的<code class="du mh mi mj mk b">@SuppressWarnings</code>注释隐藏结果</li><li id="c168" class="lr ls hh jy b jz mc kd md ku me kv mf kw mg kt ly lz ma mb bi translated">遗留项目的代码气味基线和忽略列表</li><li id="c24d" class="lr ls hh jy b jz mc kd md ku me kv mf kw mg kt ly lz ma mb bi translated">指定代码气味阈值以中断您的构建或打印警告</li><li id="e7ea" class="lr ls hh jy b jz mc kd md ku me kv mf kw mg kt ly lz ma mb bi translated">SonarQube集成</li></ul><p id="c026" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">已经说过，Detekt有广泛的可用规则，让我们看看其中的一些:</p><h2 id="a058" class="ld iv hh bd iw le lf lg ja lh li lj je ku lk ll ji kv lm ln jm kw lo lp jq lq bi translated">规则集</h2><ul class=""><li id="d9ba" class="lr ls hh jy b jz lt kd lu ku lv kv lw kw lx kt ly lz ma mb bi translated"><strong class="jy hi">注释</strong>:基于函数和属性等公共事物应该总是有文档的原则的规则。</li><li id="bdd2" class="lr ls hh jy b jz mc kd md ku me kv mf kw mg kt ly lz ma mb bi translated"><strong class="jy hi">复杂性</strong>:定义类/方法的最大大小、类中方法的最大数量以及嵌套块数量的规则。</li><li id="6042" class="lr ls hh jy b jz mc kd md ku me kv mf kw mg kt ly lz ma mb bi translated"><strong class="jy hi">空块</strong>:让你的代码易于阅读和识别任何空块的规则。</li><li id="12b7" class="lr ls hh jy b jz mc kd md ku me kv mf kw mg kt ly lz ma mb bi translated"><strong class="jy hi">异常</strong>:关于如何抛出和处理异常的规则。</li><li id="8dbf" class="lr ls hh jy b jz mc kd md ku me kv mf kw mg kt ly lz ma mb bi translated"><strong class="jy hi">格式化</strong>:格式化问题的规则。</li><li id="d27b" class="lr ls hh jy b jz mc kd md ku me kv mf kw mg kt ly lz ma mb bi translated"><strong class="jy hi">命名</strong>:与代码库中的名称相关的规则，如类、函数、包等。</li><li id="085e" class="lr ls hh jy b jz mc kd md ku me kv mf kw mg kt ly lz ma mb bi translated"><strong class="jy hi">性能</strong>:不必要变量的规则和区间上的forEach。</li><li id="21db" class="lr ls hh jy b jz mc kd md ku me kv mf kw mg kt ly lz ma mb bi translated"><strong class="jy hi">潜在bug</strong>:弃用规则，冗余else，未检查强制转换。</li><li id="da5d" class="lr ls hh jy b jz mc kd md ku me kv mf kw mg kt ly lz ma mb bi translated"><strong class="jy hi">样式</strong>:代码样式的规则，如折叠if语句、幻数和可选括号。</li></ul><p id="7d35" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">现在，让我们看看如何配置Detekt:</p><ol class=""><li id="a607" class="lr ls hh jy b jz ka kd ke ku ml kv mm kw mn kt mo lz ma mb bi translated"><strong class="jy hi">将detekt插件添加到build.gradle中</strong></li></ol><p id="810a" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">我们需要将它添加到<em class="jx"> allprojects </em>部分下的<em class="jx">顶级build.gradle </em>中，这样它就可以应用到我们所有的模块&amp;中。我们还在plugins部分下添加了Detekt插件，如下面的代码片段所示。</p><figure class="kx ky kz la fd ii"><div class="bz dy l di"><div class="lb lc l"/></div></figure><p id="d727" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated"><strong class="jy hi"> 2。设置一个配置</strong></p><p id="eab6" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">Detekt是高度可配置的，以满足您的要求。要生成包含各种规则的配置文件，我们需要运行以下命令:</p><blockquote class="js jt ju"><p id="5581" class="jv jw jx jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ha bi translated">。/grad Lew detekgenerateconfig</p></blockquote><p id="1033" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">在<strong class="jy hi"> &lt;项目-root&gt;/config/detekt/detekt . yml</strong>中打开新生成的文件，开始播放各种配置选项。该文件包含各种选项，我们可以根据需要启用或禁用它们。</p><p id="e529" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">规则示例:</p><figure class="kx ky kz la fd ii"><div class="bz dy l di"><div class="lb lc l"/></div></figure><p id="bcb4" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">这里的<strong class="jy hi">长参数列表</strong>是规则，可以使用<strong class="jy hi">激活</strong>选项启用或禁用。<strong class="jy hi"> Threshold </strong>定义允许违反该规则的次数，当计数达到阈值时，给定的规则将失败。</p><p id="abb2" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated"><strong class="jy hi"> 3。运行检测</strong></p><p id="fb13" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">现在有趣的部分是运行detekt命令来检查我们代码库的健康状况。</p><blockquote class="js jt ju"><p id="192a" class="jv jw jx jy b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ha bi translated">。/gradlew detekt</p></blockquote><p id="c913" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">这个命令将应用所有活动的规则，并给出结果，无论它是否成功。如果失败，那么将显示失败规则和代码位置的所有细节，我们可以对它们采取纠正措施。</p><p id="632c" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">例如，如果我们在上面的<em class="jx"> DetektSample </em>类上运行detekt，我们将得到下面的错误，构建将失败。错误是不言自明的，LongParameterList的阈值被定义为6，但在实现中，我们有10个参数，这违反了规则。</p><figure class="kx ky kz la fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es mp"><img src="../Images/042ee7a71c5db021deaf94cdb6611433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-V1TpEEm7kS471AFpQh-7A.png"/></div></div></figure><p id="7708" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">虽然有时候我们真的不能修改代码来适应失败的规则。别担心，我们有办法成功构建…</p><p id="f461" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">我们可以使用<strong class="jy hi"> @Suppress() </strong>注释来隐藏任何规则。要隐藏问题，必须将问题的id写入注释的值字段中。例如@Suppress("LongMethod ")</p><p id="71bb" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">注意:我们应该只在最坏的情况下使用上面的选项。</p><h1 id="7546" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">将Detekt集成到正在进行的项目中</h1><p id="08a6" class="pw-post-body-paragraph jv jw hh jy b jz lt kb kc kd lu kf kg ku mq kj kk kv mr kn ko kw ms kr ks kt ha bi translated">当我们在项目的开始集成这样的静态分析工具时，它工作得非常好，但是在一个正在进行的项目中添加它们怎么样呢？相信我，将detekt添加到一个正在进行的项目中会导致许多错误，因为有多个规则集可用，然而，我们可以决定我们需要哪些规则集，并在开始时只启用那些规则集，其余的可以随着我们的进展而包含进来。</p><h1 id="fece" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">将检测集成到配置项</h1><p id="c487" class="pw-post-body-paragraph jv jw hh jy b jz lt kb kc kd lu kf kg ku mq kj kk kv mr kn ko kw ms kr ks kt ha bi translated">到目前为止，我们所了解的是，每当任何开发人员完成任务时，开发人员都需要运行detekt命令来检查它是否有任何代码气味。但是由于这个过程是手工的，开发人员可能会忘记这一步。最棒的是，使用detekt gradle脚本，我们可以轻松地将其自动化，以便在持续集成(CI)流程中运行。</p><p id="c75c" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">我们只需要在适当的步骤将Gradle脚本添加到我们的管道中。它们是轻量级的任务，一点也不耗时，但是有很多好处。</p><h1 id="60d5" class="iu iv hh bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">结论</h1><p id="cdf7" class="pw-post-body-paragraph jv jw hh jy b jz lt kb kc kd lu kf kg ku mq kj kk kv mr kn ko kw ms kr ks kt ha bi translated">这就是这篇文章，我们已经在这样简单步骤中建立了真正有效的工具。配置这样的工具肯定有助于保持我们代码的良好健康。我们有许多这样的工具可用，但在我看来，Detekt是一个真正有效的工具，可以在整个开发过程中自动发现和修复小问题，因为有大量的规则集可用，并且可以根据项目需求进行定制。</p><p id="c545" class="pw-post-body-paragraph jv jw hh jy b jz ka kb kc kd ke kf kg ku ki kj kk kv km kn ko kw kq kr ks kt ha bi translated">快乐编码…:)</p></div></div>    
</body>
</html>