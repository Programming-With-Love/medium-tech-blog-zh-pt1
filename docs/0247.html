<html>
<head>
<title>#SmallerAPK, Part 3: Removing unused resources</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">#SmallerAPK，第3部分:删除未使用的资源</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/smallerapk-part-3-removing-unused-resources-1511f9e3f761?source=collection_archive---------1-----------------------#2016-02-19">https://medium.com/androiddevelopers/smallerapk-part-3-removing-unused-resources-1511f9e3f761?source=collection_archive---------1-----------------------#2016-02-19</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/16742a27007b85054b45771a39fbd376.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6OvLVi-G5Ldze7Novm7M0w.jpeg"/></div></div></figure><div class=""/><p id="8c17" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><a class="ae jn" href="#0b72" rel="noopener ugc nofollow"> <strong class="ir ht">更新1 </strong> </a> <strong class="ir ht"> : </strong>资源中的稀疏配置. arsc</p><p id="87dd" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">有两种方法可以移除应用程序未使用的资源，但由于这些资源位于项目文件夹或依赖项中，因此会打包到APK中。一种方法依赖于我们在<a class="ae jn" rel="noopener" href="/@wkalicinski/smallerapk-part-2-minifying-code-554560d2ed40">前一章</a>中讨论的缩小器/收缩器。除了删除未使用的代码，它还可以分析哪些资源实际上正在使用，并剥离那些从来没有包括在你的布局，绘图，代码等。要启用资源收缩，请将这一行添加到您的发布版本类型:</p><h2 id="3fe7" class="jo jp hs bd jq jr js jt ju jv jw jx jy ja jz ka kb je kc kd ke ji kf kg kh ki bi translated">build.gradle</h2><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="8e39" class="jo jp hs ko b fi ks kt l ku kv">android {<br/>    ...<br/>    buildTypes {<br/>        release {<br/>            minifyEnabled true<br/>            <strong class="ko ht">shrinkResources true<br/>            </strong>proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'<br/>        }<br/>    }<br/>}</span></pre><p id="2e76" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">就像删除代码一样，自动化工具有时可能会对实际使用了哪些资源做出错误的判断。您可以使用特殊的<em class="kw">工具:keep </em>属性告诉构建系统您想要保留的资源，类似于ProGuard配置文件如何列出要保留的类和方法。您可以将它添加到项目中已经存在的任何<em class="kw"> &lt;资源&gt; </em>标签上，或者为收缩器规则创建一个单独的文件:</p><h2 id="3fb4" class="jo jp hs bd jq jr js jt ju jv jw jx jy ja jz ka kb je kc kd ke ji kf kg kh ki bi translated">res/raw/keep.xml</h2><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="f913" class="jo jp hs ko b fi ks kt l ku kv">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;resources xmlns:tools="http://schemas.android.com/tools"<br/>   tools:keep="@layout/l_used*_c,@layout/l_used_a,@layout/l_used_b*"<br/>/&gt;</span></pre><p id="cf69" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您还可以指定<em class="kw">工具:丢弃</em>来故意删除被保留的资源；</p><h2 id="3e8c" class="jo jp hs bd jq jr js jt ju jv jw jx jy ja jz ka kb je kc kd ke ji kf kg kh ki bi translated">res/raw/keep.xml</h2><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="995a" class="jo jp hs ko b fi ks kt l ku kv">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;resources xmlns:tools="http://schemas.android.com/tools"<br/>    tools:shrinkMode="safe"<br/>    tools:discard="@layout/unused2"<br/>/&gt;</span></pre><p id="72d3" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">通过查看日志文件以及在<a class="ae jn" href="http://tools.android.com/tech-docs/new-build-system/resource-shrinking" rel="noopener ugc nofollow" target="_blank">工具站点</a>上在<em class="kw">安全</em>和<em class="kw">严格</em>模式之间切换意味着什么，你可以阅读更多关于调试资源收缩器的内容。</p><p id="e8b4" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当然，保持项目文件夹整洁有序是一个好习惯，所以如果你知道有任何旧的资源不再使用，你应该删除这些文件。</p><h1 id="2b91" class="kx jp hs bd jq ky kz la ju lb lc ld jy le lf lg kb lh li lj ke lk ll lm kh ln bi translated">使用ResConfigs删除未使用的配置</h1><p id="bb1c" class="pw-post-body-paragraph ip iq hs ir b is lo iu iv iw lp iy iz ja lq jc jd je lr jg jh ji ls jk jl jm ha bi translated">许多库都有翻译成多种语言的字符串资源。例如，支持库和Google Play服务就是这种情况。你甚至可能已经开始为你的应用程序进行翻译，但是你还没有准备好向市场发布这些语言。您可以使用<em class="kw"> resConfigs </em>选项来限制将包含在最终APK中的配置</p><h2 id="bd67" class="jo jp hs bd jq jr js jt ju jv jw jx jy ja jz ka kb je kc kd ke ji kf kg kh ki bi translated">build.gradle</h2><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="1b79" class="jo jp hs ko b fi ks kt l ku kv">android {<br/>    defaultConfig {<br/>        ...<br/>        resConfigs "en", "fr"<br/>    }<br/>}</span></pre><p id="d400" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这将删除不适合这两种语言配置的任何资源。</p><p id="0ccb" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">请注意，resConfigs在与屏幕密度一起使用时略有其他语义(您只能使用一种密度)，最好使用<a class="ae jn" rel="noopener" href="/@wkalicinski/smallerapk-part-4-multi-apk-through-abi-and-density-splits-477083989006"> splits </a>来代替。在<a class="ae jn" rel="noopener" href="/@wkalicinski/smallerapk-part-5-multi-apk-through-product-flavors-e069759f19cd">第五部分:多APK产品风味</a>中也有一个密度<em class="kw">重组</em>用法的例子</p><h1 id="0b72" class="kx jp hs bd jq ky kz la ju lb lc ld jy le lf lg kb lh li lj ke lk ll lm kh ln bi translated">资源中的稀疏配置</h1><p id="269d" class="pw-post-body-paragraph ip iq hs ir b is lo iu iv iw lp iy iz ja lq jc jd je lr jg jh ji ls jk jl jm ha bi translated">我在这一节将要描述的问题通常只发生在非常大的应用程序中，有成百上千的资源字符串、样式或其他标识符进入<em class="kw"> resources.arsc </em>文件。</p><p id="bb74" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您注意到该文件在您的APK中占据了异常大的空间，这可能表明您有太多的<em class="kw">稀疏配置</em>。让我解释一个简单的例子。</p><p id="488b" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">假设您有5个在默认配置文件夹中定义的基本字符串(<em class="kw"> values/strings.xml </em>)。字符串本身将在字符串池中定义，而资源文件的另一个区域将包含一个由指向这些字符串的指针组成的资源配置。为了便于解释，下面是一个简化的<em class="kw"> resources.arsc </em>文件的样子:</p><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="0814" class="jo jp hs ko b fi ks kt l ku kv">String pool: "My App", "Hello", "Exit", "Settings", "Feature"</span><span id="ab3b" class="jo jp hs ko b fi lt kt l ku kv">                  Default config: <br/>string/myapp      0x00000001<br/>string/hello      0x00000002<br/>string/exit       0x00000003<br/>string/settings   0x00000004<br/>string/feature    0x00000005</span></pre><p id="9d25" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">现在想象一下，你正在给你的应用程序添加一个只能在API 21+上工作的新特性。该特性需要在使用时显示不同的消息，因此您决定覆盖<em class="kw"> values-v21/strings.xml </em>中的一个字符串，并重新编译您的应用程序。</p><p id="6265" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您可能会认为您只是向字符串池添加了一个新的字符串值，并为新创建的v21 config添加了一个字符串指针。不幸的是，<em class="kw"> resources.arsc </em>文件格式不是这样的。相反，您可能会看到:</p><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="1758" class="jo jp hs ko b fi ks kt l ku kv">String pool: "My App", "Hello", "Exit", "Settings", "Feature", "New feature"</span><span id="a224" class="jo jp hs ko b fi lt kt l ku kv">                  Default config:         -v21 config:<br/>string/myapp      0x00000001              NO_ENTRY<br/>string/hello      0x00000002              NO_ENTRY<br/>string/exit       0x00000003              NO_ENTRY<br/>string/settings   0x00000004              NO_ENTRY<br/>string/feature    0x00000005              0x00000006<br/>                  <br/>                  ==========              ==========<br/>Config size:      20 bytes                <strong class="ko ht">20 bytes</strong>!</span></pre><p id="bc07" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">事实证明，每个配置(<em class="kw"> -v21 </em>、<em class="kw"> -land </em>甚至<em class="kw"> -en-land-v21 </em>)都会在每个可能的资源位置上为指针预留空间。实际指针可以为空，这意味着在此配置中没有定义任何值。空指针仍然占用4个字节。</p><p id="9f4b" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">正如我在开始提到的，这里可能的节省主要取决于你的应用程序中有多少字符串(或其他类型的资源)。对于我们的例子来说，字符串的-v21配置的开销只有4 * 4字节，也就是说在空条目中浪费了16字节(加上我们真正关心的指针的4字节)。</p><p id="dcd9" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然而，在现实生活中，一个应用程序定义了3500个字符串，并有一个单独的横向配置，其中1个字符串被翻译成50种语言(因此它有一些文件夹，如<em class="kw"> values-en-land </em>、<em class="kw"> -pl-land </em>、<em class="kw"> -de-land </em>、<em class="kw">-fr-land……</em>)将会丢失:</p><p id="1735" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">4字节* 3500个空条目* 50种语言= <strong class="ir ht"> 700千字节</strong></p><p id="98b1" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">也就是说,<strong class="ir ht">删除一个字符串</strong>就可以节省700千字节，我见过一些应用程序通过移动3个资源来减少配置数量，节省了超过<strong class="ir ht"> 2.5MB的空间。</strong></p><p id="ff24" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">有一个问题——因为你首先将一个资源放在一个单独的配置中，这通常意味着你需要它，而这实际上是在Android中这样做的正确方式。但是如果你能找到一个或几个能为你节省大量空间的资源，你可能会考虑想办法把它们一起扔掉。</p><p id="8d25" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">另一种方式，尽管不太优雅，是在那种情况下在代码中不同版本的资源之间切换。例如，在您的<em class="kw"> values/strings.xml </em>中，您可以有两个字符串:<strong class="ir ht"> string/my_feature </strong>和<strong class="ir ht"><em class="kw">string/my _ feature _ land</em></strong>，然后在运行时根据当前屏幕方向选择正确的一个。</p><p id="4ebb" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们开源了一个工具，可以帮助您找到稀疏资源配置，并确定哪些资源导致了您的<em class="kw"> resources.arsc </em>膨胀。它叫做ArscBlamer，可以在这里找到:</p><div class="hg hh ez fb hi lu"><a href="https://github.com/google/android-arscblamer" rel="noopener  ugc nofollow" target="_blank"><div class="lv ab dw"><div class="lw ab lx cl cj ly"><h2 class="bd ht fi z dy lz ea eb ma ed ef hr bi translated">谷歌/安卓-arscblamer</h2><div class="mb l"><h3 class="bd b fi z dy lz ea eb ma ed ef dx translated">ArscBlamer是一个命令行工具，可以解析Android应用程序的resources.arsc文件，并提取有用的、可操作的…</h3></div><div class="mc l"><p class="bd b fp z dy lz ea eb ma ed ef dx translated">github.com</p></div></div><div class="md l"><div class="me l mf mg mh md mi ho lu"/></div></div></a></div><p id="3c46" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">你需要安装<a class="ae jn" href="http://bazel.io/" rel="noopener ugc nofollow" target="_blank"> Bazel </a>来编译ArscBlamer。您可以使用以下命令编译和运行(全部在一行中):</p><pre class="kj kk kl km fd kn ko kp kq aw kr bi"><span id="b3e5" class="jo jp hs ko b fi ks kt l ku kv">$ bazel run //java/com/google/devrel/gmscore/tools/apk/arsc:ArscDumper --apk=/FULL_PATH_TO_APK/bar.apk - keys &gt; output.csv</span></pre><figure class="kj kk kl km fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es mj"><img src="../Images/bb26e2bb8223e0f3e3645120a06dc243.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hXU9WJgejvby0CxFDaJj1A.png"/></div></div></figure><p id="9c56" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然后，在任何编辑器(如<a class="ae jn" href="https://docs.google.com/spreadsheets" rel="noopener ugc nofollow" target="_blank"> Google Sheets </a>)中打开生成的CSV文件，并按<em class="kw">空条目</em>列降序排序。</p><p id="29ba" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">具有最多<em class="kw">空条目</em>的配置可能会被删除，右边的资源名称(<em class="kw">键</em>)将是您可以删除的配置。</p><p id="33ff" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">让我知道这种技术是否适用于你的应用程序，以及你如何能够减少资源的大小。</p></div><div class="ab cl mk ml go mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ha hb hc hd he"><p id="a0ee" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><a class="ae jn" rel="noopener" href="/@wkalicinski/smallerapk-part-4-multi-apk-through-abi-and-density-splits-477083989006">第4部分:通过ABI的多APK和密度分割</a>只需点击一下鼠标。</p></div></div>    
</body>
</html>