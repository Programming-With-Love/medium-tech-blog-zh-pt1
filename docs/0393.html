<html>
<head>
<title>Android Emulator: Project Marble improvements</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android模拟器:项目大理石改进</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/android-emulator-project-marble-improvements-1175a934941e?source=collection_archive---------3-----------------------#2019-03-26">https://medium.com/androiddevelopers/android-emulator-project-marble-improvements-1175a934941e?source=collection_archive---------3-----------------------#2019-03-26</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="3047" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc">发帖人:安卓产品经理林子闳</em></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/37fbb58e05bde44113b33cf55f87d66e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YXbEJNUcY1n4S5N1"/></div></div></figure><p id="ecd1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是Android工作室团队深入探讨<a class="ae jp" href="https://android-developers.googleblog.com/2019/01/android-studio-33.html" rel="noopener ugc nofollow" target="_blank">项目大理石</a>的一些细节和幕后的一系列博客文章中的第三篇。以下帖子由仿真器团队的林子闳(产品经理)、杨凌峰(技术主管)和胡波(技术主管)撰写。</p><p id="70b5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">今天，我们很高兴地向您介绍我们在大理石项目期间在Android模拟器中取得的进展。我们的核心目标之一是让Android模拟器成为应用程序开发的首选设备。物理Android设备很棒，但我们的目标是增加功能和性能，使您在开发和测试Android应用程序时更加高效。</p><p id="eef3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们听说许多应用开发者喜欢我们最近对模拟器所做的改进，从2秒启动时间、GPU图形加速到<a class="ae jp" href="https://developer.android.com/studio/run/emulator#snapshots" rel="noopener ugc nofollow" target="_blank">快照</a>。但是，我们也听说Android模拟器消耗了您的开发计算机上太多的系统资源。为了解决这个问题，我们在Project Marble中努力优化Android模拟器的CPU使用。在不偏离最初设计原则的情况下，我们在过去几个月的Marble项目中对Android模拟器的能效和绘制速率进行了重大改进。在本帖中，我们将介绍我们在金丝雀频道<a class="ae jp" href="https://developer.android.com/studio/preview/install-preview#change_your_update_channel" rel="noopener ugc nofollow" target="_blank">上发布的Android Emulator 28.1的进展。</a></p><h1 id="7ed4" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">保留设计原则，同时减少开销</h1><p id="4b54" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">Android Emulator的主要好处是为开发人员提供了一种可扩展的方法，可以在各种设备配置和屏幕分辨率上测试最新的Android APIs，而无需为每种配置购买物理设备。因此，在Android Emulator上测试应用应该尽可能接近在物理设备上测试，同时保持虚拟设备的优势。</p><p id="3f5e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了支持最新的系统映像，我们有意将Android模拟器设计得尽可能接近物理设备，作为一个模拟器而不是仿真器。这种方法确保了API的正确性和Android系统行为和交互的高保真度。当一个新的Android版本出来时，我们只需要确保我们的硬件抽象层(HALs)和内核与仿真器和新的系统映像兼容，而不必自己从头开始重新实现新Android版本的Android API的所有更改。这种架构的最终结果是，它大大加快了模拟器采用新系统映像的速度。</p><p id="5caa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，这种全系统仿真方法会增加CPU周期和内存访问的开销。相比之下，基于模拟器的方法会以可能更少的开销在主机系统上包装类似的API。因此，我们面临的挑战是保持全系统仿真的准确性和维护优势，同时减少CPU和内存开销。</p><h1 id="af2e" class="jq jr hh bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">Android仿真器架构的研究</h1><p id="cca0" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">Android模拟器在称为Android虚拟设备(AVD)的虚拟机中运行Android操作系统。AVD包含完整的<a class="ae jp" href="https://source.android.com/devices/architecture" rel="noopener ugc nofollow" target="_blank"> Android软件栈</a>，它就像在物理设备上一样运行。高层架构图如下。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kt"><img src="../Images/bb52fcdb8a0fb8e38261ab0dd587164f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*H8Y7VKtH1vckbx5M"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx"><em class="ky">Android Emulator System Architecture</em></figcaption></figure><p id="6a07" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于整个Android操作系统独立于主机操作系统运行，即使没有任何用户输入，运行Android模拟器也会导致主机上的后台活动。在做了一些技术调查后，当AVD空闲时，以下任务是CPU周期的主要消耗者:</p><ul class=""><li id="19e1" class="kz la hh ig b ih ii il im ip lb it lc ix ld jb le lf lg lh bi translated">谷歌Play商店——当有新版本时，应用程序会自动更新。</li><li id="4844" class="kz la hh ig b ih li il lj ip lk it ll ix lm jb le lf lg lh bi translated">后台服务——一些按需服务在假设设备正在充电时保持高CPU使用率。</li><li id="be34" class="kz la hh ig b ih li il lj ip lk it ll ix lm jb le lf lg lh bi translated">动画——比如<a class="ae jp" href="https://android-developers.googleblog.com/2010/02/live-wallpapers.html" rel="noopener ugc nofollow" target="_blank">的动态壁纸</a>。</li></ul><p id="83a4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于这些领域，我们进行了一系列深入的技术调查，并选择了以下五大解决方案来优化Android模拟器。</p><ol class=""><li id="1fc5" class="kz la hh ig b ih ii il im ip lb it lc ix ld jb ln lf lg lh bi translated">默认电池模式</li><li id="42f9" class="kz la hh ig b ih li il lj ip lk it ll ix lm jb ln lf lg lh bi translated">仿真器暂停/恢复</li><li id="2853" class="kz la hh ig b ih li il lj ip lk it ll ix lm jb ln lf lg lh bi translated">减少呼叫开销</li><li id="65cb" class="kz la hh ig b ih li il lj ip lk it ll ix lm jb ln lf lg lh bi translated">macOS主循环IO开销减少</li><li id="3cf4" class="kz la hh ig b ih li il lj ip lk it ll ix lm jb ln lf lg lh bi translated">无头构建</li></ol><h2 id="a5a2" class="lo jr hh bd js lp lq lr jw ls lt lu ka ip lv lw ke it lx ly ki ix lz ma km mb bi translated"><strong class="ak">改进1 —默认电池模式</strong></h2><p id="e942" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">之前，Android模拟器将AVD的电池充电模式设置为使用<a class="ae jp" href="https://developer.android.com/reference/android/os/BatteryManager.html#BATTERY_STATUS_CHARGING" rel="noopener ugc nofollow" target="_blank">交流电源</a>。经过深思熟虑的讨论和数据分析，我们得出的结论是，最好在默认情况下将AVD设置为电池模式。这是因为大多数Android框架、服务和应用程序都经过了优化，以节省电池寿命，这些优化只有在设备(无论是物理设备还是虚拟设备)认为它正在使用电池而不是用交流电源充电时才会生效。</p><p id="4c5f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，仅仅默认AVD使用电池是不够的。这是因为处于电池模式也会导致屏幕在一段时间后自动关闭。这可能会让在笔记本电脑或台式机上使用模拟器的用户感到困惑，他们希望应用程序不会随机进入睡眠状态，需要被唤醒。为了避免这种情况，Android Emulator将在每次冷启动完成时使用<a class="ae jp" href="https://developer.android.com/reference/android/provider/Settings.System#SCREEN_OFF_TIMEOUT" rel="noopener ugc nofollow" target="_blank"> ADB shell命令</a>将屏幕关闭超时设置为最大值(~24天)。</p><p id="3693" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">随着这些变化，谷歌Play商店将不会在电池模式下自动更新应用程序，并避免系统过载。然而，<a class="ae jp" href="https://support.google.com/googleplay/answer/113412?hl=en" rel="noopener ugc nofollow" target="_blank">切换回交流充电模式仍然可以触发应用</a>的自动更新。这实际上让开发者可以控制何时自动更新应用。这可以防止关键用例中的干扰，例如当用户只想构建和测试单个应用程序时。下图比较了电池和交流电源的CPU使用情况:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mc"><img src="../Images/a402539c23568892b63d9aa4430a41c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gt4ov7MOkjcvhFYP"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx"><em class="ky">AVD CPU Usage: Auto-update app vs Idle</em></figcaption></figure><h2 id="dfdf" class="lo jr hh bd js lp lq lr jw ls lt lu ka ip lv lw ke it lx ly ki ix lz ma km mb bi translated"><strong class="ak">改进#2 —仿真器暂停/恢复</strong></h2><p id="b29f" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">在许多情况下，您可能希望立即保证模拟器在关键任务(如编辑/构建/部署循环的编辑和构建步骤)期间不会在后台消耗CPU周期。为了解决这个问题，我们正在开发一个控制台命令和界面来完全暂停模拟器的CPU使用。这可以通过遵循控制台命令显式暂停/恢复AVD来实现。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es md"><img src="../Images/a2174978ffd115cdc7268fb2ffc1f3eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q77jcfo5jiRqRwhW2l2NgA.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx"><em class="ky">Android Emulator: Pause command line options</em></figcaption></figure><p id="2703" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里的挑战是如何用Android Studio协调这个Android模拟器的状态变化。因此，当应用部署发生时，我们自动恢复模拟器。我们仍在研究这一机制，很高兴听到您的<a class="ae jp" href="https://source.android.com/setup/contribute/report-bugs#developer-tools" rel="noopener ugc nofollow" target="_blank">想法和反馈</a>。</p><h2 id="fc04" class="lo jr hh bd js lp lq lr jw ls lt lu ka ip lv lw ke it lx ly ki ix lz ma km mb bi translated">改进# 3——减少绘图调用开销</h2><p id="1200" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">我们还对Android模拟器引擎进行了更改，使其在绘图方面更高效，从而在测试屏幕上有许多对象的图形密集型应用程序时，带来更流畅的用户体验。例如，与v28.0.23相比，Emulator v28.1.10在<a class="ae jp" href="https://github.com/google/gpu-emulation-stress-test" rel="noopener ugc nofollow" target="_blank"> GPU emulation压力测试应用</a>上的绘图速度提高了8%。我们还在Android Q中进行进一步优化，并将在<a class="ae jp" href="https://developer.android.com/preview" rel="noopener ugc nofollow" target="_blank"> Android Q预览版</a>期间分享额外的更新。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/a7874fba7260c8464de709e70b917f3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9SgQAdVAIYAHR_eD"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx"><em class="ky">Emulator OpenGL ES FPS: 28.0.23 vs 28.1.10</em></figcaption></figure><h2 id="e466" class="lo jr hh bd js lp lq lr jw ls lt lu ka ip lv lw ke it lx ly ki ix lz ma km mb bi translated">改进4 — macOS主循环IO开销减少</h2><p id="3a81" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">一个完整的系统仿真器必须维护某种方法来通知虚拟OS磁盘和网络上的I/O操作已经完成。Android模拟器基于<a class="ae jp" href="https://www.qemu.org/" rel="noopener ugc nofollow" target="_blank"> QEMU </a>，使用一个主循环和iothreads来完成这个。它在Linux和Windows上的开销很低。然而，在macOS上，由于使用了select()系统调用，我们看到主循环的CPU使用率更高。这一点往往没有得到有效实施。macOS确实提供了一种低开销的方法来等待I/O: <a class="ae jp" href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/kqueue.2.html" rel="noopener ugc nofollow" target="_blank"> kqueue </a>。我们发现，当前基于select()的主I/O循环可以用基于<a class="ae jp" href="https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/kqueue.2.html" rel="noopener ugc nofollow" target="_blank"> kqueue </a>的主I/O循环替换。这大大降低了主循环的CPU使用率，从大约10%降低到大约3%。由于这并没有说明所有空闲CPU的使用情况，所以图表(如下)没有显示太多变化。尽管如此，差异仍然是明显的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mc"><img src="../Images/ff082db823e058177e3c7fc31a53c5a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*O_gCbgpsbOadRFV9"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx">AVD Idle CPU Usage — Emulator 28.0.23 vs 28.1.10</figcaption></figure><h2 id="ddf0" class="lo jr hh bd js lp lq lr jw ls lt lu ka ip lv lw ke it lx ly ki ix lz ma km mb bi translated">改进5——无头构建</h2><p id="ef57" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">对于那些使用持续集成系统来构建Android应用的人，我们也在这方面进行了性能改进。通过关闭Android模拟器中的用户界面，您可以使用access一种新的无模拟器模式。这种新模式在后台运行测试，使用更少的内存。这也减少了大约100MB，主要是因为我们用于用户界面的<a class="ae jp" href="https://www.qt.io/" rel="noopener ugc nofollow" target="_blank"> Qt </a>库没有被加载。当不需要UI和用户交互时，这也是运行自动化测试的好选择。增量可以通过启动2个仿真器AVD实例来测量，如下所示。请注意，命令行示例明确指定了主机GPU模式，以确保在相同的条件下进行比较。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es md"><img src="../Images/bdc1df50ca88d5e7262cf03b7e741b60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qhp25FXwP_K4gE8ggOQQbQ.png"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx"><em class="ky">Android Emulator: Headless emulator command line option</em></figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es me"><img src="../Images/981ce299fb6b66c501bd846a62bc8495.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DZ20pZNiqKnaydzW"/></div></div><figcaption class="ku kv et er es kw kx bd b be z dx"><em class="ky">AVD Idle Memory Usage — emulator vs emulator-headless</em></figcaption></figure><h2 id="4ad3" class="lo jr hh bd js lp lq lr jw ls lt lu ka ip lv lw ke it lx ly ki ix lz ma km mb bi translated">后续步骤</h2><p id="6cb0" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">要使用这篇博客中提到的性能和资源优化，请下载Android Emulator 28.1，今天可以在金丝雀频道下载。我们很高兴与你们分享这个早期的进展，但我们肯定还没有完成。我们邀请您今天尝试Android模拟器的最新更新，并将您的<a class="ae jp" href="https://developer.android.com/studio/report-bugs.html#emulator-bugs" rel="noopener ugc nofollow" target="_blank">反馈</a>发送给我们。</p></div></div>    
</body>
</html>