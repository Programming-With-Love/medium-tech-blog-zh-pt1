# 将洛蒂迅速带入未来

> 原文：<https://medium.com/airbnb-engineering/lottie-and-swift-at-airbnb-e0c85dc365e7?source=collection_archive---------0----------------------->

## 一个关于 Airbnb 如何用一种新语言重写流行的开源库 Lottie 的个人故事

![](img/14b9a95738cbdaa1ac1a1cf85b94469c.png)

Come and join us in working on Swift development in our gorgeous office!

[Lottie](https://airbnb.io/lottie/) 是一个适用于 Android、iOS、web 和 Windows 的库，它解析用 [Bodymovin](https://github.com/airbnb/lottie-web) 导出为 JSON 的 [Adobe After Effects](http://www.adobe.com/products/aftereffects.html) 动画，并在移动设备和 Web 上自然呈现它们。如果你还没有读过 Brandon 关于 Lottie 在 iOS 上被迅速改写的帖子，请查看一下！我们想提供更多一点的背景，为什么我们决定投资于这次重写。

Lottie 是两年前用 Objective-C 编写的，当时 Airbnb 还没有完全迁移到 Swift，大多数公司还没有采用 Swift。快进到 2019 年— [超过 50%的顶级非游戏应用程序正在使用 Swift](https://blog.andrewmadsen.com/post/182862756395/how-many-apps-use-swift-in-2019) 。Airbnb 应用程序 90%以上是 Swift 代码，我们已经多年没有编写 Objective-C 了。是时候通过在 Swift 中重写 Lottie 了，Lottie 是我们最受欢迎的开源回购之一。

## 为什么要重写？

如果你告诉很多开发人员你打算从头开始重写一个大型开源库，他们会犹豫不决。为什么不在它的基础上建造呢？Objective-C 版本运行良好；为什么不维持现状？我们意识到，考虑到 Objective-C 和 Swift 之间的差异，重写是合适的，原因如下:

*   **Objective-C 与 Swift 的互操作性仍然不够好**。这是可行的，但你只能说这么多了。如果我们只在 Swift 中编写 Lottie 的一些层，我们最终会得到一个混合代码库，迫使贡献者更长时间地处理这一挑战，而不会推动库向前发展。
*   **Swift 有许多精彩的语言改进**，如结构、模式匹配、更好的不变性、更严格的访问控制、强大的枚举类型、函数式编程范例等等。这些特性在 Objective-C 中都不可用，这意味着 Lottie 代码库也将错过所有这些特性以及将来引入的任何新特性。
*   **从 Objective-C 到 Swift 的上下文切换需要时间**，这使得同时在 Lottie 和现代代码库中工作更加困难和令人沮丧。
*   **越来越多的工程师在从未接触过 Objective-C 的情况下先学习 Swift】随着有这种背景的工程师数量的增加，用 Objective-C 编写的项目变得过时，这些较新的 iOS 工程师无法接触到。**

## 我自己的快速故事

当我刚开始在 Airbnb 工作时，我根本不了解 Swift。我真的很舒服，很高兴写 Objective-C；为什么要改变呢？2017 年，Swift 经历了许多变化，与 Objective-C 的互操作性是一个需要应对的重大挑战。错误消息通常很难理解，编译器也没有提供多少帮助。Objective-C 是一种更成熟的语言，并且工作得更好。由于这些原因，我非常不喜欢 Swift，尽可能避免使用它。

奇怪的是，我加入 Airbnb 的主要原因之一是因为我知道我需要学习 Swift 来推进我作为 iOS 工程师的职业生涯。Airbnb 是向 Swift 过渡的领导者，他们在 2016 年底将大部分应用程序改写为 Swift 2。当我加入时，该应用程序刚刚被[更新为支持 Swift 3](/airbnb-engineering/getting-to-swift-3-at-airbnb-79a257d2b656) ，我对强迫自己使用我多年来避免使用的语言持谨慎乐观态度。就像任何语言(编程与否)一样，如果你完全沉浸其中，你可以非常快地学会它。我了解了结构、强大的函数式编程范例以及编写面向协议的代码。我很兴奋地来工作，想更多地了解这门语言，每天都变得更容易了。是的，在这个过程中有一些障碍(主要是编译速度慢)，但是几个月后，我真的喜欢上了这门语言及其所有的复杂性。

我写 Objective-C 已经两年了，现在我在拥有和维护洛蒂库的团队中。作为其中的一部分，我不得不不时查看 Lottie 源代码，以解决其他工程师提出的错误或问题。这样做已经变成了一个回到目标 C 的大的环境切换，把我带出我通常的流程，并且变得越来越困难。

当我使用 Lottie 动画实现一个新的动画按钮时，我遇到了一个 bug，动画的某些层没有根据按钮状态正确隐藏。当我深入渲染源代码寻找罪魁祸首时，我很快发现自己迷失在像洋葱一样分层的 Objective-C 代码中。Lottie 有不同类型的图层、遮罩、形状、渐变、笔画和变换的类。许多其他以不同风格编写代码的工程师都对它做出了贡献。添加了一些方法，它们以稍微不同的方式做同样的事情。我越来越难以理解什么是重要的，什么只是需要过滤掉的噪音。

很明显，试图在没有帮助的情况下调试这个问题几乎是不可能的。为了让更多的人直接为图书馆做出贡献来解决这类问题，我们意识到我们的最佳选择是将 Lottie 转移到未来并用 Swift 重写。

在重写过程中，我可以和 Brandon 一起直接开发新的 Lottie 版本，并提出改进意见。当我们将新版本集成到 Airbnb 应用程序中时，我能够发现新的错误并报告它们，或者自己做出贡献并修复它们。我增加了对目标 C 兼容性的支持，并修正了一些关于 T2 新动画开关类的问题。能够在这个库上工作已经被授权了，我终于觉得我不仅可以调试新的问题，还可以通过为每个人改进它来回馈社区。

## Airbnb 对开源的承诺

Airbnb 喜欢与开源社区合作。如果没有过多的开源软件，我们将无法快速、轻松地构建我们的应用和服务，我们希望尽我们所能回馈社会。这是我们两年前开源 Lottie 的主要动机。当我们与 Brandon Withrow 合作在 Swift 中重写 Lottie 时，我们知道唯一的选择是公开进行，并尽早提供社区访问。自从 Lottie 的开源版本更新到 3.0 版本后，我们收到了大量来自社区的评论、问题和请求，这极大地改进了这个新版本。

我们希望你和你的团队喜欢这个更新，并且社区中的其他人将继续在这个新的现代化平台上与我们合作，使它变得更好。非常感谢您对 Lottie 和 Airbnb 开源项目的支持！

*如果你对 Swift 和 iOS 开发充满热情，我们鼓励你申请我们已经开放的* [*不同角色*](https://grnh.se/1cb1ce351) *！我们希望你能加入我们的团队！*

非常感谢 Maja Wichrowska 和 Stephanie Teng 的写作和编辑支持。