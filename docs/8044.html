<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/microservices-with-orchestration-and-choreography-d09941b1b4e6?source=collection_archive---------0-----------------------#2021-08-06">https://medium.com/walmartglobaltech/microservices-with-orchestration-and-choreography-d09941b1b4e6?source=collection_archive---------0-----------------------#2021-08-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><h2 id="8e66" class="hf hg hh bd hi hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id bi translated">具有编排和编排的微服务</h2><p id="cb6a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io hr ip iq ir hv is it iu hz iv iw ix iy ha bi translated"><strong class="ig iz">在沃尔玛建立无线订单处理的现代平台</strong></p><figure class="jb jc jd je fd jf er es paragraph-image"><div role="button" tabindex="0" class="jg jh di ji bf jj"><div class="er es ja"><img src="../Images/574bc0d38a2aa47429eec66735782e97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LG_qb_KPYAUgJzgCMeUsZA.jpeg"/></div></div><figcaption class="jm jn et er es jo jp bd b be z dx">Source: <a class="ae jq" href="https://pixabay.com/illustrations/personal-collective-group-knowledge-3286017/" rel="noopener ugc nofollow" target="_blank">https://pixabay.com/illustrations/personal-collective-group-knowledge-3286017/</a></figcaption></figure><p id="d3be" class="pw-post-body-paragraph ie if hh ig b ih jr ij ik il js in io hr jt iq ir hv ju it iu hz jv iw ix iy ha bi translated">我经常遇到这样的问题:编排是否应该用在现代服务架构中，或者是否所有的集成都需要通过编排的事件来完成。我甚至与认为编排在现代微服务架构中没有位置的架构师进行过对话。如果你阅读了一些技术文献，你自己可能会开始相信这一点。我可以自信地说这只是一个神话。现实情况是，一些业务问题最好通过混合方法来解决，在混合方法中，编排和编排都需要使用。诀窍在于知道何时使用哪种方法，以及如何处理它们带来的复杂性。<br/>像任何与架构设计相关的事情一样，在编排、编排或两者之间做出决定是一个<em class="jw">“看情况”</em>的答案。那你怎么选择呢？首先，你需要对正在解决的业务问题有非常深刻的理解，包括底层流程的复杂性，有可衡量的业务成果(换句话说，成功意味着什么——而不是肤浅的东西),并且知道如何/何时/何地允许设计复杂性。为了说明这一点，我将详细说明编排和编排是如何一起使用的。这不会是理论，我将使用我在沃尔玛实施的架构，该架构在最初推出时幸存下来，扩展时没有任何问题，并且正在通过下一波业务转型进行扩展。我们开始吧。</p><h1 id="a8dd" class="jx hg hh bd hi jy jz ka hm kb kc kd hq ke kf kg hu kh ki kj hy kk kl km ic kn bi translated"><strong class="ak">问题陈述</strong></h1><p id="a1c8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io hr ip iq ir hv is it iu hz iv iw ix iy ha bi translated">在我谈论为什么做出某些选择之前，我需要解释一下业务问题。需要解决的总体问题是改造遗留的无线订单处理系统，该系统随着时间的推移变得复杂而脆弱。它不再能够扩展到更高的容量，不能进行更改以满足新的业务需求，而且维护成本太高。让事情变得更加复杂的是，新系统必须支持电子商务和店内销售渠道，这意味着它直接面向消费者，将由零售店的员工使用。从架构的角度来看，遗留系统面临许多挑战。服务缺乏正确定义的边界，存在大量的数据孤岛，设计脆弱而复杂，并且构建于过时的技术堆栈之上。最后但同样重要的是，它部署在一个正在关闭的数据中心，需要转移到云中。这是一个系统的经典案例，在某一点上很好地服务于它的目的，但是新的业务需求超出了这个体系结构最初打算提供的，它需要被转换。多年的技术债务不断增加，合理的未来投资是对其进行重建和现代化。</p><p id="272b" class="pw-post-body-paragraph ie if hh ig b ih jr ij ik il js in io hr jt iq ir hv ju it iu hz jv iw ix iy ha bi translated">在我们进入解决方案细节之前，让我们先谈谈整体业务愿景。该企业需要一个平台来支持他们当前处理无线订单的需求，但也需要一个平台来支持不同产品的订单处理。为每个产品提供单点解决方案并不是一个可行的选择，而且会导致比预期更多的复杂性和成本。显然，我们不能为我们不知道的东西进行设计，但是，我们也知道理解业务目标对于创建正确的基础架构的重要性。在我们的领域中，无论产品类型如何，订单处理都共享一组通用的业务功能；核心架构的目标是构建一个可重用和可扩展的平台，该平台可以持续增长，以支持多产品订单管理。</p><h1 id="c7af" class="jx hg hh bd hi jy jz ka hm kb kc kd hq ke kf kg hu kh ki kj hy kk kl km ic kn bi translated"><strong class="ak">架构解决方案</strong></h1><p id="28e2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io hr ip iq ir hv is it iu hz iv iw ix iy ha bi translated">现在让我们把这个带到另一个层次。关于业务流程，有几个重要因素是解决方案设计的核心输入:</p><ul class=""><li id="dabd" class="ko kp hh ig b ih jr il js hr kq hv kr hz ks iy kt ku kv kw bi translated">订单流程跨越了几个业务领域，包含了所有正常路径的定义良好的流程流。一些异常路径是明确定义的，但是有许多用例没有遵循严格的路径，因此需要处理的灵活性，特别是在零售的情况下。</li><li id="ab0e" class="ko kp hh ig b ih kx il ky hr kz hv la hz lb iy kt ku kv kw bi translated">处理无线订单非常复杂，涉及许多步骤，并且需要与外部第三方系统进行大量交互。这些交互中的一些是高度响应的，而另一些需要更长的时间。更有趣的是，这些交互的延迟可能会有所不同，因此解决方案需要在逐个事务的基础上适应不同类型的特征。</li><li id="661f" class="ko kp hh ig b ih kx il ky hr kz hv la hz lb iy kt ku kv kw bi translated">该企业希望在交易(订单)发生时获得近乎实时的洞察。此外，还有明确的业务事件需要跟踪，并可用于运营洞察。这在销售、促销和节日活动期间尤为重要，因为在这些活动中，企业需要查看销售额并跟踪订单的处理状态。</li><li id="43e7" class="ko kp hh ig b ih kx il ky hr kz hv la hz lb iy kt ku kv kw bi translated">过程中的任何小故障，无论是业务还是技术异常，都意味着销售的损失。以简单的方式跟踪每个处理步骤和每个订单的状态至关重要。此外，对数据丢失的容忍度非常非常低。简单来说，当订单达到某个状态并被支付时，数据一定不能丢失。任何级别的异常(包括完全灾难恢复事件)都不会导致数据丢失。</li></ul><p id="138d" class="pw-post-body-paragraph ie if hh ig b ih jr ij ik il js in io hr jt iq ir hv ju it iu hz jv iw ix iy ha bi translated">这份清单上有很多需要解开的东西。在你进一步阅读之前，再看一眼上面的条目并研究它们。每一项都直接影响到架构的构建和权衡。我们比较和分析了管理订单的不同方法，进行了一些深入的讨论，最终确定了以下关键架构方面:</p><ul class=""><li id="e36a" class="ko kp hh ig b ih jr il js hr kq hv kr hz ks iy kt ku kv kw bi translated">端到端订单流程将由业务流程管理(BPM)引擎进行编排，该引擎将位于核心业务服务的有界上下文中。这个服务，即订单处理服务，将负责通过所需的步骤接收无线订单，并在此过程中发出业务事件，并且将是任何时间点订单状态的单一记录系统。换句话说，它的工作是编排业务流程并对编排好的事件做出响应。之所以决定使用BPM引擎，是因为需要通过一系列步骤来管理每个订单，提供一种快速更改工作流的方法，并在执行每个订单时提供近乎实时的操作视图。订单处理服务无疑是一项小型服务，在如何设计工作流和子流以实现所需的灵活性方面非常小心。</li><li id="b35c" class="ko kp hh ig b ih kx il ky hr kz hv la hz lb iy kt ku kv kw bi translated">事件分为两种类型；<em class="jw">宏事件</em>是管理订单状态和驱动BPM引擎处理工作流所需的事件，以及<em class="jw">微事件</em>是用于编排从属于核心流的域服务之间的更细粒度活动的事件。</li><li id="fbbf" class="ko kp hh ig b ih kx il ky hr kz hv la hz lb iy kt ku kv kw bi translated">域服务，即处理订单时需要的同一业务域中的所有服务，将主要作为微服务来解决。每个支持服务都有特定的职责，可以自由使用额外的技术来完成他们的订单处理部分(例如，规则引擎、子工作流)，不会维护订单状态，并且如果使用了异步处理，将负责在订单处理服务完成工作时使用事件或API回调通知订单处理服务，或者如果使用了同步处理，将在调用被阻塞时立即通知订单处理服务。在需要的地方，域服务将能够创建它们自己的微事件，并直接为微流相互通信，而不必通过订单处理服务。</li><li id="5a7b" class="ko kp hh ig b ih kx il ky hr kz hv la hz lb iy kt ku kv kw bi translated">企业集成都将通过同步API来编排，因为它们是核心BPM流程的一部分，直接连接到客户旅程，并附加到用户体验层。还有必须严格管理的关键服务级别协议(SLA)。</li><li id="8477" class="ko kp hh ig b ih kx il ky hr kz hv la hz lb iy kt ku kv kw bi translated">包括订单状态在内的业务数据将与工作流操作数据分开存储，两者都在订单处理服务的范围内。订单状态数据作为业务数据进行维护，并与其他工作流操作数据分开。</li><li id="9d47" class="ko kp hh ig b ih kx il ky hr kz hv la hz lb iy kt ku kv kw bi translated">数据将根据企业希望用于分析和监控事务的事件流向数据仓库。仓库中的其他交易数据将近乎实时地可用。要求是在几分钟之内让数据在仓库中可用(想想1-3分钟，而不是5-10分钟)。当决定何时何地使用编排、编排和确定事件粒度时，这个速度容差是一个重要因素。</li></ul><p id="1a9c" class="pw-post-body-paragraph ie if hh ig b ih jr ij ik il js in io hr jt iq ir hv ju it iu hz jv iw ix iy ha bi translated">下面是一个逻辑层次的架构，上面描述了所有组件的布局。</p><figure class="jb jc jd je fd jf er es paragraph-image"><div class="er es lc"><img src="../Images/d15c3113b71e354dd447267c74c736b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*BG43QD9aCKgQiGBJr0ty1A.png"/></div></figure><h1 id="17fc" class="jx hg hh bd hi jy jz ka hm kb kc kd hq ke kf kg hu kh ki kj hy kk kl km ic kn bi translated"><strong class="ak">一些挑战</strong></h1><p id="da6d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io hr ip iq ir hv is it iu hz iv iw ix iy ha bi translated">这种架构并非没有复杂性。以下是在实施过程中出现的一些我们必须解决的问题:</p><ul class=""><li id="e98a" class="ko kp hh ig b ih jr il js hr kq hv kr hz ks iy kt ku kv kw bi translated">使用编排的服务交互实现的处理步骤的语句管理。虽然对于什么是宏观事件，什么是微观事件，有了BPM，管理状态变得更加容易，因此可以在任何时间点轻松地确定它，但是微观事件也需要被跟踪，不能丢失。</li><li id="aff6" class="ko kp hh ig b ih kx il ky hr kz hv la hz lb iy kt ku kv kw bi translated">如何有效地在核心业务流和独立执行部分流程的子流和小流之间划清界限。虽然事情可能发生在核心业务流程之外，但我们需要准确地知道订单在生命周期中的任何一点。</li><li id="75df" class="ko kp hh ig b ih kx il ky hr kz hv la hz lb iy kt ku kv kw bi translated">与上述项目相关，决定事件的粒度很重要。我们从驱动编排所需的东西开始，慢慢地创建更细粒度的事件，以支持小流程的编排和执行。宏观事件和微观事件之间需要有关系。</li><li id="2d74" class="ko kp hh ig b ih kx il ky hr kz hv la hz lb iy kt ku kv kw bi translated">处理长时间运行的事务的重试逻辑、异常、超时和用户体验管理。简而言之，这些项目是复杂的非快乐路径场景，需要仔细考虑并建模。在这种架构中，几乎所有都由订单处理服务处理。然而，在某些情况下，尤其是在有长时间运行的事务和编排的情况下，某些逻辑将由域服务实现。决定哪里需要补偿事务，确保服务的幂等性，以及利用状态管理，这些都成为我们必须逐渐引入的技术。</li><li id="fade" class="ko kp hh ig b ih kx il ky hr kz hv la hz lb iy kt ku kv kw bi translated">用于分析的数据速度。一般来说，数据应该尽可能快地移动到报告和分析层，除非它是直接从事件流中使用的，并且有必要的细节。然而，当数据分散在多个微服务中时，将一个可使用的数据集拼接在一起可能会很复杂。</li></ul><h1 id="f5fa" class="jx hg hh bd hi jy jz ka hm kb kc kd hq ke kf kg hu kh ki kj hy kk kl km ic kn bi translated"><strong class="ak">总结一下</strong></h1><p id="f2fa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io hr ip iq ir hv is it iu hz iv iw ix iy ha bi translated">所以你有它。可能有人会说这不是一个“纯粹的”现代服务架构，应该在没有任何编排的情况下使用编排。恕我不敢苟同，我想给你上一课——从实际出发，打造你的业务所需的最简单的解决方案。不要承担你不需要的复杂性，也不要假设理论反映了现实。敏捷架构意味着从简单开始，不断发展，迭代地形成最佳解决方案。编排和编排绝对可以一起工作，如果它们是解决问题的正确工具，那就去做吧。</p></div></div>    
</body>
</html>