<html>
<head>
<title>Decrypting BazarLoader strings with a Unicorn</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用独角兽解密BazarLoader字符串</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/decrypting-bazarloader-strings-with-a-unicorn-15d2585272a9?source=collection_archive---------1-----------------------#2021-07-30">https://medium.com/walmartglobaltech/decrypting-bazarloader-strings-with-a-unicorn-15d2585272a9?source=collection_archive---------1-----------------------#2021-07-30</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/7ae2c1df0b0dc2795e5ffd1cbc2d3ae6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*94HcjHschG2t3QjIKigzSw.jpeg"/></div></div></figure><p id="b5ae" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">BazarLoader[1，2，6]在过去的一年中已经被许多团队使用，主要被TrickBot[3]相关的团队用于垃圾邮件活动。虽然最初的恶意软件改变了目标TTP(trick bot攻击团队行动手册)，但它们仍然与大多数感染非常相似，以高优先级服务器上的锚点和最终的勒索病毒感染结束[4，5，7]。</p><p id="1857" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最近我注意到在加载端，两个版本使用了不同的模糊处理，并出现在不同的活动中。参与Bazar的各种团队使用的混淆方法很少，但出于本报告的目的，我们将重点关注使用LLVM的样本[8]。我的目的是展示一种有趣的技术，我认为这种技术在恶意软件分析中没有得到充分利用，在恶意软件分析中，您可以利用CPU仿真器来解码各种类型的字符串编码，我多年来一直使用这种技术来解码H1N1[9]加载程序的各个部分，并且多年来还利用它来创建解密器，例如man 1的旧crypter[10]。</p><p id="fd53" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们将看到的一些未包装的样品自称为:</p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="5122" class="jw jx hh js b fi jy jz l ka kb">exeLoaderDll_LLVMO.dll</span></pre><p id="4a44" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这些样本以一种混淆的方式存储它们的大多数相关字符串，其中数据被手动加载，然后经过一个相当长的解码数据的过程。</p><figure class="jn jo jp jq fd ii er es paragraph-image"><div class="er es kc"><img src="../Images/0fed673c988905320ab0744fac9104e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*8twmjZHPzGr3PS8qUAVNBQ.png"/></div><figcaption class="kd ke et er es kf kg bd b be z dx">Loading data</figcaption></figure><figure class="jn jo jp jq fd ii er es paragraph-image"><div class="er es kh"><img src="../Images/5554d150f83c8acf5cb7f74ae96420fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/1*5DpUNznCiPre_unefpteqA.png"/></div><figcaption class="kd ke et er es kf kg bd b be z dx">Start of decode loop</figcaption></figure><p id="3190" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在同一个样本中调查这个过程的更多实例显示了变化，这意味着它是使用宏或较低级别的混淆器动态生成的，TrickBot组在历史上利用了ADVobfuscator[11]和LLVM[8]。</p><p id="8e97" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了用仿真器[12]解码字符串，我们需要捕获加载字节的数据块以及解码它的循环，幸运的是，对于这样的混淆器，我们通常可以为样本签名:</p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="3e6a" class="jw jx hh js b fi jy jz l ka kb">import sys<br/>import re<br/>import binascii<br/>import struct<br/>from unicorn import *<br/>from unicorn.x86_const import *</span><span id="7d7f" class="jw jx hh js b fi ki jz l ka kb">STACK=0x90000<br/>code_base = 0x10000000<br/>mu = Uc(UC_ARCH_X86,UC_MODE_64)</span><span id="f450" class="jw jx hh js b fi ki jz l ka kb">data = open(sys.argv[1], 'rb').read()<br/>test = re.findall(r'''488d.{3,20}c70.+0f......ffff''',binascii.hexlify(data))</span></pre><p id="8621" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在这个代码块中，我们正在为unicorn[12]做一些初始设置，然后找到我们的代码块，因为python regex在这里的使用方式，我们将从文件的第一个块一直到最后一个块。这意味着我们将需要分解和解析出单独的块，我更喜欢这种方法，因为它让我在一定程度上控制这个过程。</p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="7b92" class="jw jx hh js b fi jy jz l ka kb">temp = test[0]<br/>temp = ['488d'+x for x in temp.split('488d')]<br/>tempp = []<br/>for x in temp:<br/> xx = x.split('feffff')<br/> if 'fdffff' in xx[0]:<br/>  xx = x.split('fdffff')<br/>  tempp.append(xx[0]+'fdffff')<br/> else:<br/>  tempp.append(xx[0]+'feffff')<br/>temp = tempp</span></pre><p id="f0e3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因此，我们根据开始和结束来分解每个块，同时考虑到我在一些结束字节的示例中注意到的变化。接下来，我们将完成模拟器的设置，然后遍历并模拟每个代码块:</p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="7fb3" class="jw jx hh js b fi jy jz l ka kb">mu.mem_map(code_base, 0x100000)</span><span id="0332" class="jw jx hh js b fi ki jz l ka kb">mu.mem_map(STACK, 4096*10)<br/>for i in range(len(temp)):<br/> try:<br/>  blob = binascii.unhexlify(temp[i])<br/> except:<br/>  blob = binascii.unhexlify(temp[i][1:])<br/> mu.mem_write(code_base, '\x00'*0x100000)<br/> mu.mem_write(STACK, '\x00'*(4096*10))<br/> <br/> mu.mem_write(code_base,blob)<br/> mu.reg_write(UC_X86_REG_ESP,STACK+4096)<br/> try:<br/>  mu.emu_start(code_base, code_base+len(blob), timeout=10000)<br/> except:<br/>  pass</span></pre><p id="f0e6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在仿真之后，我们将读入为堆栈分配的整个内存，然后通过剥离所有空字节打印出找到的任何字符串:</p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="9b7c" class="jw jx hh js b fi jy jz l ka kb"> a = mu.mem_read(STACK,4096*10) <br/> a = a[len(blob):].split('\x00')<br/> a = filter(lambda x: x != '', a)<br/> a = map(str,a)<br/> print(str(''.join(a)))</span></pre><p id="5fd8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一个例子给了我们一个健康的数据块:</p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="76d2" class="jw jx hh js b fi jy jz l ka kb"># python str_decode.py 9d76e72fb45bb059b64c58d10da43cbac1487f8b396d705eae0a427974587171.bin  |strings<br/>Mozilla/5.0<br/>ABCDEFGHIJKLMNOPQRTSUVWXYZ0123456789<br/>%s.%d.%d.%d%s.%s.%d.%d.%d%s.%s<br/>%%s.%d.%d.%d%s.%s.%d.%d.%d%s.%s<br/> Avast.exe<br/>c34.212.193.150 35.166.147.40<br/>rareanimalsofcanada.bazar wildwinternature.bazar coldmountainsanimals.bazar<br/>Software\%s<br/>cmd /c ping 8.8.7.7 -n 2 &amp; <br/>8Y3y<br/>start %s %s<br/>GGNY<br/> yyyy-MM-dd<br/>SHA384<br/>HashDigestLength8<br/> ECDSA_P384<br/>kernel32.dll<br/><a class="ae kj" href="http://twitter.com/advapi32" rel="noopener ugc nofollow" target="_blank">@advapi32</a>.dll<br/>xuser32.dll<br/>ws2_g<br/>+ntdll.dll<br/>shell32.dll<br/>crypt32.dll<br/>shlwapi.dll<br/>owinhttp.dll<br/>netapi32.dll<br/>bcrypt.dll<br/>userenv.dll</span></pre><p id="9132" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">运行VirusTotal的一组文件，我们可以快速生成一些C2列表。</p><p id="ba82" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">样品:</p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="f039" class="jw jx hh js b fi jy jz l ka kb">0c2e254376127f76d44fc9276000697e45a2977fca4384705e84994ab63fdc37  90d0c4995ce53077cd2fbc00a248f02df108b42b4df1ba84b89ea014fae4ea01<br/>0d53ed1eca1a3d28e0227055f66f6d2de1b2606e30f10982967509df4e478ee1  9296e1fef0356eab2956aac2d010dac587d55ae2de7f520deb97d1dfcc4e4a9a<br/>1c27d4dc6fef72e096b06662908d7c5b225cecdbfc66c8f19db78b76008fac63  <br/>270890cfa6621fa3b5c6edcdd2bb15760b97abd43245d6673eee9dca23c77d40  <br/>2ea153ff7675c15adcda2bff88958be2004f9d32f6d67d9fabd3c872eeb07505<br/>2eec5366c21fc1bc9c11c2afbf66368fc704175231ab63659b3e8b839e5c9e71  <br/>37aae88b9a3f942952c258d611c2c629116fcc077079e3698590c3f8aab3e684  <br/>37e587e6b801e926dc31da093c55f1f834edcb8c1971c40869a8054580e39e42  9d76e72fb45bb059b64c58d10da43cbac1487f8b396d705eae0a427974587171<br/>447b4c867b7147afe178d73adf8113fc33f6399f03707e4308efa36e0859bf86  9f6ae735999f98738022b1784d1b46975ae16069c260656646fbcfeaeef35a06<br/>47eb57d467c4330269a5238a53dd399c5183b338a8bbead88bb8b88b4396a80c  ae6e6dd4f2aa22ccc395ade0ae713000af9d3dc189651e054b46540647ec891c<br/>5791ef7d6916f8c14d3261a9c3d9b68b30e208e2ddd74d0dae1ad0a476504e2a  c0a087a520fdfb5f1e235618b3a5101969c1de85b498bc4670372c02756efd55<br/>664e8512cd3ce3552f33878e26800184e0cff8ee54c75bfa93f19ad97615bb56  <br/>68b4f6fde1a2d1024f4028d22d12daeaf3f4ae4ffb46cc07cf11cf6a2cb35e90  d5df7e82b5ff898d49f3f779f2064491654ae3d50129aa0bd48a88cd43c42113<br/>69f897a4ccf41cdf3f0c7903fc740b6914707d3286a5b5c8ca1ff90487b1c4ef  e06473cad41789dddc88aa58b2f1433023637c468a88bbe364db50c1e4513744<br/>87ad0b1bd7a18ff2aa975991cd15725b4ddfa0d0ef972cbe2f57a789582aa675  f18c2a8922bbe7b8f12980a46cc3548e9a0903a7294206eeb2d01f7923cdb8eb<br/>8a0fbcde56a9a817c10b0fe5ae281f75385c2a28ca271d736484e689c104e96c  f29253139dab900b763ef436931213387dc92e860b9d3abb7dcd46040ac28a0e</span></pre><p id="4c80" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">IP、域名和URIs:</p><pre class="jn jo jp jq fd jr js jt ju aw jv bi"><span id="22ec" class="jw jx hh js b fi jy jz l ka kb">18.188.232.155<br/>18.191.220.165<br/>18.222.240.99<br/>194.5.249.30<br/>3.134.106.170<br/>34.209.40.84<br/>34.212.193.150<br/>35.166.147.40<br/>45.142.158.252<br/>54.184.178.68<br/>54.184.52.204<br/>54.190.171.88<br/>acghilbdihio.bazar<br/>achiikbdjiin.bazar<br/>adehjkbeghjn.bazar<br/>adfhikbehhin.bazar<br/>adggklbeigko.bazar<br/>afegkmbgggkp.bazar<br/>bceikkccgikn.bazar<br/>bchgjlcdjgjo.bazar<br/>begiklceiiko.bazar<br/>bffhklcghhko.bazar<br/>cegiikdeiiin.bazar<br/>coastalbrezecarwash.com<br/>coldmountainsanimals.bazar<br/>deehimeeghip.bazar<br/>rareanimalsofcanada.bazar<br/>wildwinternature.bazar<br/>/thirst/honor/commerce<br/>/no/link/1</span></pre><p id="4c74" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">参考文献</strong></p><p id="1deb" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">1:<a class="ae kj" href="https://www.bleepingcomputer.com/news/security/bazarbackdoor-trickbot-gang-s-new-stealthy-network-hacking-malware/" rel="noopener ugc nofollow" target="_blank">https://www . bleeping computer . com/news/security/bazarbackdoor-trick bot-gang-s-new-secretable-network-hacking-malware/</a></p><p id="6083" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">2:<a class="ae kj" href="https://blog.fox-it.com/2020/06/02/in-depth-analysis-of-the-new-team9-malware-family/" rel="noopener ugc nofollow" target="_blank">https://blog . fox-it . com/2020/06/02/depth-analysis-of-the-new-team 9-malware-family/</a></p><p id="690a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">3:<a class="ae kj" href="https://cybersecurity.att.com/blogs/labs-research/trickbot-bazarloader-in-depth" rel="noopener ugc nofollow" target="_blank">https://cyber security . att . com/blogs/labs-research/trick bot-bazar loader-in-depth</a></p><p id="0693" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">4:<a class="ae kj" href="https://thedfirreport.com/2021/03/08/bazar-drops-the-anchor/" rel="noopener ugc nofollow" target="_blank">https://thedfirreport . com/2021/03/08/bazar-drops-the-anchor/</a></p><p id="3ac2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">5:<a class="ae kj" href="https://thedfirreport.com/2020/10/18/ryuk-in-5-hours/" rel="noopener ugc nofollow" target="_blank">https://thedfirreport.com/2020/10/18/ryuk-in-5-hours/</a></p><p id="4ac9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">6:<a class="ae kj" href="https://malpedia.caad.fkie.fraunhofer.de/details/win.bazarbackdoor" rel="noopener ugc nofollow" target="_blank">https://mal pedia . caad . fkie . fraunhofer . de/details/win . bazarbackdoor</a></p><p id="243c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">7:<a class="ae kj" href="https://labs.sentinelone.com/inside-a-trickbot-cobaltstrike-attack-server/" rel="noopener ugc nofollow" target="_blank">https://labs . sentinel one . com/inside-a-trick bot-cobalt strike-attack-server/</a></p><p id="89ba" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">https://github.com/obfuscator-llvm/obfuscator</p><p id="0809" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">9:<a class="ae kj" href="https://malpedia.caad.fkie.fraunhofer.de/details/win.h1n1" rel="noopener ugc nofollow" target="_blank">https://malpedia.caad.fkie.fraunhofer.de/details/win.h1n1</a></p><p id="9899" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">10:<a class="ae kj" href="https://vixra.org/pdf/1902.0257v1.pdf" rel="noopener ugc nofollow" target="_blank">https://vixra.org/pdf/1902.0257v1.pdf</a></p><p id="7bf9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">11:<a class="ae kj" href="https://github.com/andrivet/ADVobfuscator" rel="noopener ugc nofollow" target="_blank">https://github.com/andrivet/ADVobfuscator</a></p><p id="c4e1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">12:<a class="ae kj" href="https://www.unicorn-engine.org/docs/" rel="noopener ugc nofollow" target="_blank">https://www.unicorn-engine.org/docs/</a></p></div></div>    
</body>
</html>