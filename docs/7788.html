<html>
<head>
<title>Pesky Old-Style Macro Popups — Advanced Maldoc Techniques</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">讨厌的旧式宏弹出窗口——高级Maldoc技术</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/pesky-old-style-macro-popups-advanced-maldoc-techniques-8868ed02d845?source=collection_archive---------2-----------------------#2019-06-04">https://medium.com/walmartglobaltech/pesky-old-style-macro-popups-advanced-maldoc-techniques-8868ed02d845?source=collection_archive---------2-----------------------#2019-06-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="53e2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作者:凯莉·罗伯茨(<a class="ae jc" href="https://twitter.com/OrOneEqualsOne" rel="noopener ugc nofollow" target="_blank"> @OrOneEqualsOne </a>)</p><p id="60cd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">还记得旧式的启用宏对话框吗？您可以将它重新投入使用，以提高网络钓鱼活动的点击率。旧式对话框如下所示。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/5c01efc4e6ea978bfd31f5035baa536b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*alkRRju572cUUdUWkCO4bQ.png"/></div></div></figure><p id="cd72" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这比我们已经习惯的黄色通知更“直接”地显示在你的面前，如下所示。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jp"><img src="../Images/7cf8b47d67e40c555f908f515e56d1c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S5Q9d59cYxyDg0fPSV_p3A.png"/></div></div></figure><p id="1130" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当Excel工作簿设置为隐藏时，将显示旧式对话框。以下步骤将为启用宏的xlsm文件完成此操作。</p><ol class=""><li id="af2e" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb jv jw jx jy bi translated">重命名。xlsm到。拉上拉链和拉开拉链</li><li id="2cce" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">将visibility="hidden "属性添加到xl/workbook.xml文件中的workbookView元素。</li><li id="1141" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">再次将所有文件压缩成一个xlsm文件</li></ol><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ke"><img src="../Images/5551fda87922a755125fdd8166e52a7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OYG6QE07ENUHwUxyCvJkeg.png"/></div></div></figure><p id="5358" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此，至少对于Excel来说，这是一个增加网络钓鱼活动趣味的好方法。我们能用PowerPoint或Word做同样的事情吗？不幸的是，这些格式没有隐藏的可见性属性。</p><p id="0b81" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，在查看来自VirusTotal的恶意软件样本时，我们在Word文档中遇到了一些讨厌的旧式宏弹出窗口。这些弹出窗口不会消失，除非你启用了宏，并且它们没有使用之前描述的visibility="hidden "参数。例如，哈希为FFA a6 e 86 c 13 b 9 bb 1952 b 42d 07d 9 c 94882 e 27 BC 3 b 0 cfe 51 e 81 b 310 a 7 FD 0 a 5 b 29 b的VirusTotal文件在放弃之前会弹出5个对话框。文档本身是一个Word文档，以RTF格式保存，并嵌入了启用宏的Excel电子表格。下面的动画图像显示了这款恶意软件的用户体验。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kf"><img src="../Images/96f183d0fb727b0db5cf73de69921f26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*fqECQaWHpxLoNyNfGE38nA.gif"/></div></div></figure><p id="7ce0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">可以通过以下步骤创建如上所示的恶意软件示例。</p><ol class=""><li id="2009" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb jv jw jx jy bi translated">创建启用宏的Excel文档，文档一打开，宏就运行。(例如使用Workbook_Open函数)。您可以将此文件保存为xls或xlsm文件。</li><li id="3f99" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">创建一个Word文档，并将启用宏的Excel文档嵌入其中。使用“插入”菜单，从功能区文本区域的下拉列表中选择“对象…”并选择“从文件创建”选项卡，然后浏览至Excel文档。不要点击“链接到文件”或“显示为图标”。选择“禁用宏”关闭出现的对话框。</li><li id="b50a" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">重复第二步任意次。嵌入项目的数量控制用户将收到的弹出窗口的数量。</li><li id="8c38" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">可以选择隐藏嵌入的对象，方法是选择它们并按“Ctrl+Shift+H ”,或者将它们移动到文档中后面的页面。</li><li id="c8ef" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">将Word文档保存为RTF文件，然后将。rtf扩展到。文件</li><li id="5f62" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">编辑。将“\objemb”替换为“\objupdate\objemb”</li></ol><p id="8ba5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这种恶意软件启发我们寻找其他方法，不使用RTF文件中的“objupdate”字符串就可以完成同样的事情。这导致了以下方法的发现。与第一种方法相比，第二种方法可能不太容易被检测为恶意软件。</p><ol class=""><li id="ffd5" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb jv jw jx jy bi translated">创建启用宏的Excel文档，文档一打开，宏就运行。(例如使用Workbook_Open函数)。您可以将此文件保存为xls或xlsm文件。</li><li id="3e6b" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">创建一个Word文档，并将启用宏的Excel文档嵌入其中。使用“插入”菜单，从功能区文本区域的下拉列表中选择“对象…”并选择“从文件创建”选项卡，然后浏览至Excel文档。不要点击“链接到文件”或“显示为图标”。选择“禁用宏”关闭出现的对话框。</li><li id="c9fb" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">重复第二步任意次。嵌入项目的数量控制用户将收到的弹出窗口的数量。</li><li id="5f69" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">可以选择隐藏嵌入的对象，方法是选择它们并按“Ctrl+Shift+H ”,或者将它们移动到文档中后面的页面。</li><li id="c5bb" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">将Word文档保存为. docx文件。关闭并重新打开. docx。</li><li id="53e9" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">现在保存。docx文件作为RTF文件。</li></ol><p id="49b5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">是的，你必须做第五步！当您按照概述的步骤操作时，在最终的RTF文件中会发生神奇的事情。为了理解这种魔力，我们将提取代表RTF文件中嵌入的Excel文档的二进制OLE对象。我们将使用来自<a class="ae jc" href="https://github.com/decalage2/oletools" rel="noopener ugc nofollow" target="_blank"> oletools </a>的rtfobj.py脚本进行提取。如果在此步骤中遇到错误，请使用标记为v0.53.1的oletools版本。</p><p id="756c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对RTF文件运行rtfobj.py:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kg"><img src="../Images/5c88934a1cac30bbf68af7bbd6ea7616.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kdJWbQ_qTmFMPzXPPU6d3A.png"/></div></div></figure><p id="82bf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">确定嵌入的Excel文档的流编号。在这种情况下，流编号为零。现在将它提取为一个OLE对象。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kh"><img src="../Images/2f83a6337c3402214fbcfb288b966c3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oPw5El1xXlKcdNieLJyalQ.png"/></div></div></figure><p id="40b2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的OLE文件已经输出到最后一行所示的目录中。现在，在理解OLE格式的十六进制编辑器中打开这个提取的文件，例如迈克菲实验室的<a class="ae jc" href="http://download.nai.com/products/mcafee-avert/fileinsight.zip" rel="noopener ugc nofollow" target="_blank"> FileInsight </a>。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ki"><img src="../Images/580110d587ef8853f68fe21a3a1a1ad3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mSHWAWU-E2_Tmq5NwHL0aw.png"/></div></div></figure><p id="3d28" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们正在寻找的“魔法”就在上图中突出显示的<strong class="ig hi"> Objinfo </strong>流中。对于<strong class="ig hi"> Objinfo </strong>流，我们需要看到的幻数是“000003000100”。如果您跳过文档创建过程中的第5步，您将在应该是“1”的地方以“D”结束，并且您将不会得到“启用宏”弹出窗口。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kg"><img src="../Images/02674aa6d4b74954876603492bfd8f56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EIyENHqMuf7Nl1BSfXWtoQ.png"/></div></div></figure><p id="b733" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">那么，这个神奇的十六进制数字到底是什么？我们可以在这里阅读更多关于<strong class="ig hi"> ObjInfo </strong> stream <a class="ae jc" href="https://docs.microsoft.com/en-us/openspecs/office_file_formats/ms-doc/13ba10a8-d8b2-433b-bf3b-ec238dc8f9ce" rel="noopener ugc nofollow" target="_blank">的内容。具体来说，该流包含用于<strong class="ig hi"> ODTPersist1 </strong>结构的2个字节、用于<strong class="ig hi"> cf </strong>结构的2个字节和用于<strong class="ig hi"> ODPerstist2 </strong>结构的2个字节。</a></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kj"><img src="../Images/a668d469c36ef68279ef4a2077f91c5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lbPrqhX9mnwANpvtHQjRQw.png"/></div></div></figure><p id="7bac" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请记住，在文档中，这些字节是从“最低有效位”(LSB)到“最高有效位”(MSB)排列的，也就是您可能提到的反向排列。所以<strong class="ig hi"> cf </strong>值为0x0003，表示嵌入文件的格式不是“元文件”就是“增强型元文件”。为了决定它是否是一个“增强元文件”，我们需要查看<strong class="ig hi"> ODTPersist2 </strong>结构，最后两个字节。当<strong class="ig hi"> ODTPersist2 </strong>为0x000D时，左3个字节为1011。下面的图表表明这意味着该文件是一个增强型图元文件，并且OLE对象支持这种格式。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kk"><img src="../Images/bbcc5dac2c8f578685e19abaad64a513.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nnovalyAXeSN1id6HbGuRA.png"/></div></div></figure><p id="3fa7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们的例子中，我们希望打开RTF文档，让它自动启动Excel并提示用户启用宏。当<strong class="ig hi"> ODTPersist2 </strong>结构中的<strong class="ig hi"> fStoredAsEMF (D) </strong>位被置位时，这种情况不会发生。实际上，我们只需要一个值来设置<strong class="ig hi"> fEMF (A) </strong>位，而<em class="kl">不会</em>设置<strong class="ig hi">fstoredasmf(D)</strong>位。或者换句话说，我们指定OLE对象是不支持这种文件格式的增强型图元文件。因此，我们可以将<strong class="ig hi"> ODTPersist2 </strong>的值设置为0x0001来完成我们的设计。</p><p id="e104" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">哇，我们刚刚向您展示了如何以编程方式强制在打开文档时显示旧式的启用宏弹出窗口的痛苦细节。如果您执行第5步(将文档保存为docx文件，关闭文件，重新打开并另存为RTF ),这将自动发生。为什么？我不知道，但这总比做这些逆向二进制的东西强。</p><p id="41f9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有趣的是，你可以结合这篇文章中的文档创建方法1和2，从一个嵌入的OLE对象中得到两个启用宏弹出窗口。</p><p id="bc7c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">关于检测:您对检测带有嵌入宏的文档的RTF文件感兴趣吗？哈罗德·奥格登(<a class="ae jc" href="http://twitter.com/HaroldOgden" rel="noopener ugc nofollow" target="_blank">@哈罗德·奥格登</a>)提供了这两条亚拉法则。第一个规则检测具有多个嵌入的启用宏的文档的RTF文件，而第二个规则范围较广，更容易出现误报，但有利于搜索。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="km kn l"/></div></figure><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="km kn l"/></div></figure></div></div>    
</body>
</html>