<html>
<head>
<title>Using Cypress to test Azure Active Directory protected Single-Page Applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Cypress测试Azure Active Directory保护的单页应用程序</h1>
<blockquote>原文：<a href="https://medium.com/version-1/using-cypress-to-test-azure-active-directory-protected-spas-47d04f5add9?source=collection_archive---------0-----------------------#2022-08-17">https://medium.com/version-1/using-cypress-to-test-azure-active-directory-protected-spas-47d04f5add9?source=collection_archive---------0-----------------------#2022-08-17</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="er es ie"><img src="../Images/742f9a756c4216518e7e4d513b6c7a49.png" data-original-src="https://miro.medium.com/v2/resize:fit:886/format:webp/1*zD2pOejxiQYdVyMHZBxCdg.png"/></div></figure><p id="0c54" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">测试使用OAuth2授权代码流的单页应用程序可能很困难，因为用户会从应用程序的主页被重定向到授权服务器。在本文中，我们将讨论如何在使用Cypress测试Azure Active Directory保护的单页应用程序时克服这一挑战。</p><p id="5185" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">这些是测试场景的组件:</strong></p><p id="878b" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><a class="ae jj" href="https://www.cypress.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="in hi">赛普拉斯</strong> </a>是一个一体化的、端到端的测试框架和断言库，允许您对web应用程序的用户界面进行自动化测试。</p><p id="e89f" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><a class="ae jj" href="https://azure.microsoft.com/en-gb/services/active-directory/" rel="noopener ugc nofollow" target="_blank"> <strong class="in hi"> Azure AD </strong> </a>是一项基于云的身份和访问管理服务，实现了OAuth2规范。</p><p id="f96e" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><a class="ae jj" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-js-initializing-client-applications" rel="noopener ugc nofollow" target="_blank"> <strong class="in hi"> MSAL.js </strong> </a>是一个由微软编写并维护的javascript库，允许SPAs使用Azure AD对用户进行身份验证。</p><p id="45f7" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">OAuth2为spa推荐的授权流程是授权代码流程，总结如下:</p><figure class="jl jm jn jo fd ii er es paragraph-image"><div class="er es jk"><img src="../Images/defc7feda48fdaa7861ac074fdb19f5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*bGTIvzTvrSDDFn_soIfj9g.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx">MSAL.js acquires tokens using Authorisation Code with PKCE flow.</figcaption></figure><ol class=""><li id="4bfb" class="jt ju hh in b io ip is it iw jv ja jw je jx ji jy jz ka kb bi translated">用户导航到单页应用程序。</li><li id="2ad3" class="jt ju hh in b io kc is kd iw ke ja kf je kg ji jy jz ka kb bi translated">如果用户未通过身份验证，则将他们重定向到Azure AD进行身份验证。</li><li id="8b16" class="jt ju hh in b io kc is kd iw ke ja kf je kg ji jy jz ka kb bi translated">身份验证成功后，Azure AD会向SPA返回一个授权码。</li><li id="299b" class="jt ju hh in b io kc is kd iw ke ja kf je kg ji jy jz ka kb bi translated">SPA交换id令牌、访问令牌和刷新令牌的授权码。</li><li id="a6e7" class="jt ju hh in b io kc is kd iw ke ja kf je kg ji jy jz ka kb bi translated">SPA会将令牌安全地存储在本地存储中。</li><li id="671f" class="jt ju hh in b io kc is kd iw ke ja kf je kg ji jy jz ka kb bi translated">SPA根据请求将访问令牌传递给后端API，后端API也受Azure AD保护。</li></ol><p id="27e3" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">当我们试图为Azure AD保护的单页应用程序(SPA)编写Cypress自动化测试时，我们需要在没有用户在场的情况下复制获取令牌的过程。然而，这提出了一个挑战……</p><blockquote class="kh ki kj"><p id="5f24" class="il im kk in b io ip iq ir is it iu iv kl ix iy iz km jb jc jd kn jf jg jh ji ha bi translated"><strong class="in hi"> <em class="hh">相关说明:</em> </strong> <a class="ae jj" href="https://www.version1.com/about-us/our-technology-partnerships/microsoft/" rel="noopener ugc nofollow" target="_blank">为什么选择版本1作为您的微软合作伙伴？</a></p></blockquote><p id="3400" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">我们最初考虑为登录页面编写测试，但是<a class="ae jj" href="https://docs.cypress.io/guides/references/best-practices#Visiting-external-sites" rel="noopener ugc nofollow" target="_blank"> Cypress不鼓励测试第三方外部网站</a> (Azure AD登录页面)，原因有几个，比如:</p><ol class=""><li id="7ead" class="jt ju hh in b io ip is it iw jv ja jw je jx ji jy jz ka kb bi translated">我们无法控制所述页面的设计，如果第三方改变页面的布局/元素，我们的测试可能会中断。</li><li id="2757" class="jt ju hh in b io kc is kd iw ke ja kf je kg ji jy jz ka kb bi translated">第三方网站可能有我们无法控制的问题。</li></ol><p id="9c28" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">其次，我们考虑尝试用我们的代码替换重定向，在运行测试之前登录并获取访问令牌；有几篇关于如何实现这一目标的文章。尽管如此，这些文章描述了使用OAuth隐式或OAuth客户端凭证流；两者都不适合我们的场景，原因如下:</p><ul class=""><li id="966f" class="jt ju hh in b io ip is it iw jv ja jw je jx ji ko jz ka kb bi translated">OAuth隐式流存在安全问题，不再推荐使用<a class="ae jj" href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics-09#section-2.1.2" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="91bd" class="jt ju hh in b io kc is kd iw ke ja kf je kg ji ko jz ka kb bi translated">OAuth客户端凭证流没有给我们API后端需要的必要声明，特别是范围声明。</li></ul><p id="6969" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">最后，我们决定使用资源所有者密码凭证(ROPC)流。这种流程并非没有缺点，<a class="ae jj" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth-ropc" rel="noopener ugc nofollow" target="_blank">微软不推荐使用</a>，除非对应用程序有高度的信任。然而，我们认为自动Cypress测试是安全的，因为没有用户在场。</p><p id="3cbb" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">我们采用的方法是用我们的代码替换MSAL.js来获取令牌，并以MSAL.js期望的形状/格式将令牌保存到本地存储中，从而欺骗MSAL.js库认为用户已经通过了身份验证，而不是将用户重定向到Microsoft登录页面。</p><p id="ce38" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">资源所有者口令身份证明流程的步骤总结如下:</p><figure class="jl jm jn jo fd ii er es paragraph-image"><div class="er es kp"><img src="../Images/7c6a4f91b4118479897a30614af038ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*OR1EPvlR-puzf3ZVcFCaxA.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx">Cypress acquiries tokens using ROPC Flow</figcaption></figure><ol class=""><li id="2db8" class="jt ju hh in b io ip is it iw jv ja jw je jx ji jy jz ka kb bi translated">Cypress脚本使用ROPC流向Azure AD的令牌端点发送身份验证详细信息。</li><li id="5260" class="jt ju hh in b io kc is kd iw ke ja kf je kg ji jy jz ka kb bi translated">Azure AD返回一个id令牌、一个访问令牌和一个刷新令牌。</li><li id="c5d0" class="jt ju hh in b io kc is kd iw ke ja kf je kg ji jy jz ka kb bi translated">Cypress脚本以MSAL.js库期望的格式将令牌存储在本地存储中。</li><li id="2c53" class="jt ju hh in b io kc is kd iw ke ja kf je kg ji jy jz ka kb bi translated">Cypress在UI上运行自动化测试脚本。</li><li id="4ee5" class="jt ju hh in b io kc is kd iw ke ja kf je kg ji jy jz ka kb bi translated">UI使用MSAL.js从本地存储中收集令牌。</li><li id="1f0d" class="jt ju hh in b io kc is kd iw ke ja kf je kg ji jy jz ka kb bi translated">UI在发送到后端API的请求上传递访问令牌。</li></ol><h2 id="0e39" class="kq kr hh bd ks kt ku kv kw kx ky kz la iw lb lc ld ja le lf lg je lh li lj lk bi translated"><strong class="ak">按照这种方法，你需要以下信息:</strong></h2><ul class=""><li id="df97" class="jt ju hh in b io ll is lm iw ln ja lo je lp ji ko jz ka kb bi translated">禁用了MFA的Azure AD帐户，此帐户应该只具有测试应用程序所需的最低访问权限。</li><li id="697d" class="jt ju hh in b io kc is kd iw ke ja kf je kg ji ko jz ka kb bi translated">您的UI的Azure AD应用程序详细信息:目录Id/租户Id、应用程序Id/客户端Id、客户端机密。</li><li id="35a4" class="jt ju hh in b io kc is kd iw ke ja kf je kg ji ko jz ka kb bi translated">您的API的Azure AD应用程序详细信息:目录Id/租户Id、应用程序Id/客户端Id、应用程序ID URI和范围Id。</li></ul><p id="ae31" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">在您的Cypress项目中添加json配置文件来保存身份验证设置:</p><figure class="jl jm jn jo fd ii"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="9ea0" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">接下来，创建一个授权支持模块，该模块将处理身份验证，并将授权详细信息保存到本地存储中:</p><figure class="jl jm jn jo fd ii"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="ed40" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">添加到本地存储的键值对的格式如下:</p><pre class="jl jm jn jo fd ls lt lu lv aw lw bi"><span id="b7c3" class="kq kr hh lt b fi lx ly l lz ma"><strong class="lt hi">Id Token key:</strong><br/>[homeAccountId]-[environment]-idtoken-[clientId]-[tenantId]-</span><span id="aa25" class="kq kr hh lt b fi mb ly l lz ma"><strong class="lt hi">Id Token value:</strong><br/>clientId: [your app id]<br/>credentialType: "IdToken"<br/>environment: "login.windows.net"<br/>homeAccountId: [oid or sid].[tid] //these values come from the id-token<br/>realm: [tid]</span><span id="3afc" class="kq kr hh lt b fi mb ly l lz ma">--------------------------------------------------------------------</span><span id="f1a8" class="kq kr hh lt b fi mb ly l lz ma"><strong class="lt hi">Access Token key:</strong><br/>[homeAccountId]-[environment]-accesstoken-[clientId]-[tenantId]-[api-scope (lowercase)]</span><span id="2539" class="kq kr hh lt b fi mb ly l lz ma"><strong class="lt hi">Access Token value:</strong><br/>cachedAt: [timestamp]<br/>clientId: [your app id]<br/>credentialType: "AccessToken"<br/>environment: "login.windows.net"<br/>expiresOn: [timestamp + expiresIn] //expiresIn is the expire_in from the token response<br/>extendedExpiresOn: [timestamp + extendedExpiresIn] //ext_expires_in from the token response<br/>homeAccountId: [oid or sid].[tid], //these values come from the access_token<br/>realm: [tid]<br/>secret: [access_token] //from token response<br/>target: [api_scope]<br/>tokenType: "Bearer"</span><span id="0ae3" class="kq kr hh lt b fi mb ly l lz ma">--------------------------------------------------------------------</span><span id="2f04" class="kq kr hh lt b fi mb ly l lz ma"><strong class="lt hi">Refresh Token key:<br/></strong>[homeAccountId]-[environment]-refreshtoken-[clientId]--</span><span id="8877" class="kq kr hh lt b fi mb ly l lz ma"><strong class="lt hi">Refresh Token value:<br/></strong>clientId: [your app id]<br/>credentialType: "RefreshToken"<br/>environment: "login.windows.net"<br/>homeAccountId: [oid or sid].[tid], //these values come from the access token or id token<br/>secret: [refresh_token] //from token response</span><span id="3a4a" class="kq kr hh lt b fi mb ly l lz ma">--------------------------------------------------------------------</span><span id="1c47" class="kq kr hh lt b fi mb ly l lz ma"><strong class="lt hi">Account key:</strong><br/>[homeAccountId]-[environment]-[tenantId]</span><span id="fc0d" class="kq kr hh lt b fi mb ly l lz ma"><strong class="lt hi">Account value:<br/>authorityType:</strong> "MSSTS"<br/><strong class="lt hi">clientInfo:</strong> ""<br/><strong class="lt hi">environment:</strong> "login.windows.net"<br/><strong class="lt hi">homeAccountId:</strong> [oid or sid].[tid], //these values come from the access token or id token<br/><strong class="lt hi">idTokenClaims:</strong> map of id_token claims (aud, exp, iat, iss, name, nbf, nonce, oir, preferred_username, rh, sub, tid, uti, ver)<br/><strong class="lt hi">localAccountId:</strong> [oid or sid]<br/><strong class="lt hi">name:</strong> name claim from id_token<br/><strong class="lt hi">realm:</strong> [tid]<br/><strong class="lt hi">username:</strong> preferred_name claim from id_token</span></pre><p id="b038" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">从身份验证过程返回的id_token和access_token中可以找到派生这些值的信息:</p><figure class="jl jm jn jo fd ii er es paragraph-image"><div class="er es mc"><img src="../Images/b224967869dd51f9b14622cdea55dca8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1072/format:webp/1*3ELLlqbiMypybbNo5ebhJw.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx">id_token</figcaption></figure><figure class="jl jm jn jo fd ii er es paragraph-image"><div class="er es md"><img src="../Images/1a3d1c02effef3a258be758fd2e03425.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*LVgsiliyejUJ_S8Hry6B8w.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx">access_token</figcaption></figure><p id="aec3" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">接下来，我们可以创建一个cypress命令来从cypress测试中调用我们的登录功能:</p><figure class="jl jm jn jo fd ii"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="0bc2" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">最后，编写调用登录命令的测试:</p><figure class="jl jm jn jo fd ii"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="c08b" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">这篇文章的主要灵感来自Joonas Westlin的精彩演讲。</p><p id="3e56" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">全部完成！</p><p id="3a40" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">参考文献</strong></p><ul class=""><li id="5d1b" class="jt ju hh in b io ip is it iw jv ja jw je jx ji ko jz ka kb bi translated"><a class="ae jj" href="https://www.youtube.com/watch?v=OZh5RmCztrU" rel="noopener ugc nofollow" target="_blank">用Cypress测试Azure广告保护的单页面应用</a></li></ul><figure class="jl jm jn jo fd ii er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es me"><img src="../Images/736187f701c46038a7946f7f639dcc5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Saz8YlWzGPLBPNOSMUlbHg.jpeg"/></div></div></figure><p id="89a2" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">关于作者:<br/> </strong> Frank Lores-Penalver是版本1的解决方案架构师。</p></div></div>    
</body>
</html>