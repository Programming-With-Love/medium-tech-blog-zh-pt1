<html>
<head>
<title>Pinterest’s Analytics as a Platform on Druid (Part 1 of 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">作为德鲁伊平台的Pinterest分析(第1部分，共3部分)</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/pinterests-analytics-as-a-platform-on-druid-part-1-of-3-9043776b7b76?source=collection_archive---------2-----------------------#2021-08-19">https://medium.com/pinterest-engineering/pinterests-analytics-as-a-platform-on-druid-part-1-of-3-9043776b7b76?source=collection_archive---------2-----------------------#2021-08-19</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="f82c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">、齐家·古、、伊莎贝尔·塔拉姆、拉克什米·纳拉亚纳·纳马拉、卡比尔·巴贾杰|实时分析团队</p><p id="a9b3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是一个由三部分组成的博客系列。要阅读第2部分，请点击此处的。第三部分点击<a class="ae jc" rel="noopener" href="/pinterest-engineering/pinterests-analytics-as-a-platform-on-druid-part-3-of-3-579406ffa374">这里</a>。</p><p id="7942" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这个博客系列中，我们将讨论作为德鲁伊平台的Pinterest分析，并分享一些使用德鲁伊的心得。这是博客系列的第一篇，简要介绍了切换到Druid的历史、Druid的系统架构以及优化Mmap主机类型的经验。</p><h1 id="1c1c" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">切换到德鲁伊的简短历史</h1><p id="e102" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">从历史上看，Pinterest中的大多数分析用例都是由Hbase支持的，h base当时是该公司中一个受到良好支持的关键价值商店。所有报告指标都在每小时或每天的批处理作业中预先计算，转换为关键值数据模型，并存储在Hbase中。这种方法在一段时间内运行良好，但最终基于Hbase的预计算键值查找系统的缺点变得越来越明显:</p><ul class=""><li id="2797" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">关键值数据模型自然不适合分析查询模式，在应用程序端需要做更多的工作来进行聚合</li><li id="56f6" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">每当添加新列时，基数就会爆炸</li><li id="e44f" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">预计算所有过滤器组合的成本太高，导致UI中的过滤器选择有限</li><li id="7237" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">随着数据集变得越来越大，Hbase集群稳定性和运营成本变得越来越难以管理</li></ul><p id="543d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">出于所有这些原因，我们评估并决定采用Druid作为Pinterest的下一代分析数据存储。从那时起，我们已经开始使用许多关键用例，包括报告合作伙伴和广告商业务指标、有机pin统计、实验指标、垃圾邮件指标分析等。该基础架构由多集群设置中的2，000多个节点组成(最大的离线用例覆盖超过1 PB的数据)，最大的在线用例服务1000多个QPS(P99延迟低于250毫秒)。</p><h1 id="2418" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">体系结构</h1><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/26fc8fe8f7c93ef8362194ec2794342b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c8spC_vIQiQ8VB52"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx">Figure 1: Overall System Architecture</figcaption></figure><p id="6de0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">摄取是一种lambda架构，其中:</p><ul class=""><li id="0964" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">每天/每小时的批处理管道将S3上的输入数据转换成Druid格式的索引文件，并将相应的元数据记录插入MySQL写回S3</li><li id="39e4" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">流式管道使用Kafka的主题，上游客户端服务实时将事件放入其中</li></ul><p id="f987" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">查询通过一个名为大法师的代理服务进行。公司中的大多数微服务都通过Thrift RPC调用相互通信，而Druid只接受HTTP，所以我们在Druid上添加了一个thrift server大法师来处理这种差异。同时，代理还简化了服务度量、查询重写、暗读、速率限制等。</p><h1 id="3e5f" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">关于优化Mmap主机类型的学习</h1><p id="58dc" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们知道，当一个查询进来时，历史进程通过Mmap从要查询的数据段中检索部分数据。通过提供一些偏移量和长度，这在由段文件备份的字节数组的理想化抽象上操作。操作系统负责确保字节数组中引用的偏移量在RAM中。如果不是，它将触发一个主要页面错误，将包含数据的一个或一系列页面加载到RAM中，这是一个开销很大的磁盘操作。另一方面，如果字节数组中引用的偏移量之前已经被访问过并且没有被逐出，那么它驻留在RAM的磁盘缓存(也称为页面缓存)部分。然后，触发一个小的页面错误，将页面缓存中的页面链接到Druid进程的虚拟内存中的页面，这是一个轻量级得多的操作，不涉及磁盘读取。在引入不同使用案例的过程中，我们评估了不同工作负载的不同主机类型，并根据所需的磁盘访问量，决定使用内存优化或IO优化的主机类型。</p><h1 id="867b" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">内存优化的主机类型</h1><p id="8c24" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">对于Pinterest中的低延迟用例，我们试图通过为主机提供足够大的内存来将所有频繁访问的段放入页面缓存中，从而最大限度地减少磁盘读取。如果使用AWS，我们选择内存优化的主机，例如R系列。经验法则是，磁盘上段的大小和页面缓存的可用RAM之间至少要有1:1的映射。每个历史节点的可用页面缓存大小的计算方法是，主机中的总RAM减去Druid进程的最大堆和直接分配内存，再减去主机中其他侧柜使用的RAM。随着时间的推移，随着查询的到来，由主要页面错误导致的初始磁盘读取会消失，因为所有数据段都会逐渐缓存到页面缓存中。</p><p id="d812" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当每小时或每天下载新的数据段时，这个过程将再次开始，我们将看到性能下降，直到这些数据段被完全缓存。为了提高性能的可预测性，我们采用了预缓存方法。由于操作系统管理页面缓存的方式，如果磁盘上的段文件被任何进程(甚至来自非Druid进程)的读取系统调用遍历，操作系统将在还有空间的情况下将其加载到RAM的页面缓存部分，以便以后对段文件的任何读取系统调用都可以触发较小的页面错误，从而避免磁盘读取。我们利用这种机制，让历史进程中的线程池在历史进程第一次将一个线程下载到本地磁盘时遍历整个段文件。</p><h1 id="8193" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">IO优化的主机类型</h1><p id="3e31" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">在以下情况下，内存优化的主机类型并不适合:</p><ul class=""><li id="b804" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">数据量太大，我们无法提供足够的RAM来缓存每个数据段</li><li id="31ea" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">用例本身是离线的，不需要亚秒级的延迟</li></ul><p id="57d9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当我们对包含大约1PB数据的实验度量进行离线用例时，我们得到了具有上述特征的用例的最佳实践。</p><p id="3fea" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最初，我们尝试了具有大EBS卷的内存优化主机类型。我们认为使用更大的RAM，我们至少可以从缓存比主机类型更多的段中受益；更小的内存和性能结果并不令人满意。深入研究后，我们发现对于每个查询，都有许多段需要扫描，远远超过页面缓存所能容纳的数量，而且几乎每次都不一样。因此，之前在页面缓存中的任何内容都将被逐出，性能主要由磁盘读取性能决定。Druid将段抽象成一个字节数组，并依靠mmap从磁盘中只获取(按需)字节数组的特定部分，而不是所有的段数据(例如，给定过滤器的某个维度的位图索引的某个部分)。这相当于为一个段加载一个或一系列页面，然后移动到另一个段，直到处理完查询所需的所有段。对于大多数公司的架构，4KB是最小的页面大小。</p><p id="b104" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">总之，经验法则是，如果预期有磁盘访问，则使用具有高4KB页面大小随机读取IOPS的主机类型。对于AWS，具有实例上SSD的主机类型工作得最好:i3比i3en好，并且都比连接EBS磁盘的任何其他实例类型好得多。我们最终选择了i3en，它在价格和性能之间取得了平衡，是该公司最具成本效益的用例之一。</p><h1 id="811a" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">未来的工作</h1><p id="7ff6" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们将不断改进架构，以满足新的用例需求:</p><ul class=""><li id="1195" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">向数据节点添加AZ感知段分配以提高可用性</li><li id="049d" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">评估基于ZK的细分市场发现的替代方案，以便更好地适应大型使用情形</li><li id="60f5" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">评估替代摄取解决方案，以提高效率或降低维护成本</li></ul><p id="4623" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们还计划探索更多的主机类型，以提高不同场景的成本效益。我们将探索具有增强EBS吞吐量的主机类型、具有AWS Graviton处理器的主机类型等。</p><h1 id="fbbf" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">承认</h1><p id="b258" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">当我们开始反馈我们的工作时，我们从德鲁伊公会与Ads数据团队的讨论以及来自开源社区的反馈中学到了很多。我们还要感谢所有与我们合作将其使用案例纳入统一分析平台的团队:洞察团队、核心产品数据团队、测量团队、信任与安全团队、广告数据团队、信号平台团队、广告服务团队等。每个用例都是不同的，该平台自诞生以来已经发展了很多。</p><p id="0c32" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lk">要在Pinterest了解更多工程知识，请查看我们的</em> <a class="ae jc" href="https://medium.com/pinterest-engineering" rel="noopener"> <em class="lk">工程博客</em> </a> <em class="lk">，并访问我们的</em><a class="ae jc" href="https://www.pinterestlabs.com/?utm_source=medium&amp;utm_medium=blog-article&amp;utm_campaign=wang-et-al-august-19-2021" rel="noopener ugc nofollow" target="_blank"><em class="lk">Pinterest Labs</em></a><em class="lk">网站。要查看和申请空缺职位，请访问我们的</em> <a class="ae jc" href="https://www.pinterestcareers.com/?utm_source=medium&amp;utm_medium=blog-article&amp;utm_campaign=wang-et-al-august-19-2021" rel="noopener ugc nofollow" target="_blank"> <em class="lk">职业</em> </a> <em class="lk">页面。</em></p></div></div>    
</body>
</html>