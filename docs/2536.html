<html>
<head>
<title>How I Seed My Database With Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何用Go播种我的数据库</h1>
<blockquote>原文：<a href="https://medium.easyread.co/how-i-seed-my-database-with-go-27488d2e6a75?source=collection_archive---------2-----------------------#2020-09-13">https://medium.easyread.co/how-i-seed-my-database-with-go-27488d2e6a75?source=collection_archive---------2-----------------------#2020-09-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3a774aa2ce0734383745ead14a9b386a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*heGuDOz1ZOea3MEm9yrQkg.png"/></div></div></figure><p id="43cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于Laravel或其他编程语言中的任何其他框架，我最怀念的是移植和播种数据库的便利性。</p><p id="5d7b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我试图在Go中找到一个数据库播种器的包，我确实找到了一个<a class="ae kw" href="https://github.com/romanyx/polluter" rel="noopener ugc nofollow" target="_blank">https://github.com/romanyx/polluter</a>，但是看起来这个包并不是我真正需要的，因为使用<code class="fe kx ky kz la b"><strong class="ka ir">polluter</strong></code>我将需要在。yaml文件。</p><p id="93b7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我需要一个更灵活的播种器，在那里我可以生成随机数据，执行SQL文件，或者也可以调用现有的用例/存储库。因此，在这篇文章中，我将尝试解释我是如何做到这一点的。</p><p id="a86d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我们需要在数据库中创建一个表，假设表名为<code class="fe kx ky kz la b"><strong class="ka ir">customers</strong></code>。以下是生成该表的SQL脚本:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="035a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后创建名为<code class="fe kx ky kz la b"><strong class="ka ir">seeds</strong></code>的目录和名为<code class="fe kx ky kz la b"><strong class="ka ir">seeder.go</strong></code>的新文件</p><pre class="lb lc ld le gt lh la li lj aw lk bi"><span id="7f43" class="ll lm iq la b gy ln lo l lp lq"><strong class="la ir">mkdir seeds &amp;&amp; cd seeds &amp;&amp; touch seeder.go</strong></span></pre><p id="e75e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并定义一个保存数据库的<code class="fe kx ky kz la b"><strong class="ka ir">Seed</strong></code>结构，我们稍后将使用该数据库进行播种。</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="f4d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我在这篇文章中使用标准的<code class="fe kx ky kz la b"><strong class="ka ir">database/sql</strong></code>包，你可以用你喜欢的包tho来改变它，比如<a class="ae kw" href="https://github.com/go-ozzo/ozzo-dbx" rel="noopener ugc nofollow" target="_blank"> ozzo-dbx </a>。</p><p id="5802" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后我们创建一个名为<code class="fe kx ky kz la b"><strong class="ka ir">customers.go</strong></code>的新文件，并在名为<code class="fe kx ky kz la b"><strong class="ka ir">CustomerSeed</strong></code>的<code class="fe kx ky kz la b"><strong class="ka ir">Seed</strong></code>结构上定义一个方法，这个方法就是我们实现数据库插入的地方，看看下面的代码:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="42e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe kx ky kz la b"><strong class="ka ir">CustomerSeed</strong></code>方法中，我用<a class="ae kw" href="http://github.com/bxcodec/faker/v3" rel="noopener ugc nofollow" target="_blank"> faker </a>包生成了100个客户数据，这个包用于生成<strong class="ka ir">假的</strong>数据，如姓名、地址和电话号码。</p><p id="6d66" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后返回到<code class="fe kx ky kz la b"><strong class="ka ir">seeder.go</strong></code>文件，用下面的代码添加一个函数<code class="fe kx ky kz la b"><strong class="ka ir">seed</strong></code>:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="d20d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个函数中，我们接收作为参数的<code class="fe kx ky kz la b"><strong class="ka ir">Seed</strong></code>结构和要执行的函数/方法的名称。您可以看到，我们正在利用<code class="fe kx ky kz la b"><strong class="ka ir">reflect</strong></code>包来执行基于方法名的特定方法(在本例中，我们希望执行我们的种子方法)。如果你还明白我的意思，<strong class="ka ir">我们希望在运行程序</strong>时能够将种子方法名作为参数传递。使用<code class="fe kx ky kz la b"><strong class="ka ir">reflect</strong></code>，我们可以反映方法变量，并使用<code class="fe kx ky kz la b">reflect.Call</code>来调用它。</p><p id="e173" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后仍然在<code class="fe kx ky kz la b"><strong class="ka ir">seeder.go</strong></code>文件中，我们将添加一个函数<code class="fe kx ky kz la b"><strong class="ka ir">Execute</strong></code>，它接受两个参数，数据库和播种方法的名称(可选)。</p><p id="6b24" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果没有传递函数/方法名，我们也在这里使用<code class="fe kx ky kz la b"><strong class="ka ir">reflect</strong></code>来迭代<code class="fe kx ky kz la b"><strong class="ka ir">Seed</strong></code> struct上的所有方法，这样它将执行我们所有的seeder方法。</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="f5d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们的<code class="fe kx ky kz la b"><strong class="ka ir">seeder.go</strong></code>文件应该是这样的:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="8818" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在用下面的代码创建一个<code class="fe kx ky kz la b"><strong class="ka ir">main.go</strong></code>文件:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="a7a4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在主文件中，我们收到一个参数<code class="fe kx ky kz la b"><strong class="ka ir">seed</strong></code>,后面是我们要执行的播种方法的名称，如果没有给出播种方法名称，所有的播种器都将被执行。</p><p id="0f76" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们可以使用以下命令运行我们的播种机:</p><pre class="lb lc ld le gt lh la li lj aw lk bi"><span id="fb53" class="ll lm iq la b gy ln lo l lp lq"><strong class="la ir">go run main.go seed</strong></span></pre><p id="73fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者仅执行特定的播种方法</p><pre class="lb lc ld le gt lh la li lj aw lk bi"><span id="6574" class="ll lm iq la b gy ln lo l lp lq"><strong class="la ir">go run main.go seed CustomerSeed</strong></span></pre><p id="0c86" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者如果您喜欢先构建它</p><pre class="lb lc ld le gt lh la li lj aw lk bi"><span id="5edd" class="ll lm iq la b gy ln lo l lp lq"><strong class="la ir">go build -o app main.go &amp;&amp;<br/>./app seed CustomerSeed</strong></span></pre><p id="0e1b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你想添加新的种子，你只需要在<code class="fe kx ky kz la b"><strong class="ka ir">Seed</strong></code>结构上添加另一个方法，比如说<code class="fe kx ky kz la b"><strong class="ka ir">ProductSeed</strong></code></p><pre class="lb lc ld le gt lh la li lj aw lk bi"><span id="42df" class="ll lm iq la b gy ln lo l lp lq"><strong class="la ir">func(s Seed) ProductSeed() {</strong></span><span id="7247" class="ll lm iq la b gy lr lo l lp lq"><strong class="la ir">   // insert product here<br/>}</strong></span></pre><p id="bf11" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您还可以使用多个参数运行种子程序:</p><pre class="lb lc ld le gt lh la li lj aw lk bi"><span id="2bc4" class="ll lm iq la b gy ln lo l lp lq"><strong class="la ir">go run main.go seed CustomerSeed ProductSeed</strong></span></pre><p id="64fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">seeder方法的实现更加灵活，您可以调用现有的存储库，甚至执行SQL文件，因为它只是常规的Go方法/函数。</p><p id="fe33" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我将演示如何在seeder方法中执行SQL文件。首先，使用以下脚本创建一个新的<code class="fe kx ky kz la b"><strong class="ka ir">products</strong></code>表:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="ce30" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并在<code class="fe kx ky kz la b"><strong class="ka ir">seeds</strong></code>目录下创建另一个目录和SQL文件</p><pre class="lb lc ld le gt lh la li lj aw lk bi"><span id="9d22" class="ll lm iq la b gy ln lo l lp lq"><strong class="la ir">cd seeds &amp;&amp; <br/>mkdir scripts &amp;&amp; <br/>cd scripts &amp;&amp; <br/>touch products.sql</strong></span></pre><p id="7042" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用以下脚本:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="009b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在在<code class="fe kx ky kz la b"><strong class="ka ir">products.go</strong></code>中创建一个新的播种方法</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lf lg l"/></div></figure><p id="9cbb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行<code class="fe kx ky kz la b"><strong class="ka ir">go run main.go seed ProductSeed</strong></code>，它将从SQL文件中获取产品数据。</p><p id="821c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在我的<a class="ae kw" href="https://github.com/redhajuanda/goseeder" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到所有的代码。</p><p id="1417" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">希望这有所帮助！😉<br/>另外，如果你有更好的想法，欢迎发表评论。</p></div></div>    
</body>
</html>