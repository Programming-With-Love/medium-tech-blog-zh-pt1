<html>
<head>
<title>Managing Oracle Cloud Infrastructure iSCSI Block Volume attachments with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform管理Oracle云基础架构iSCSI数据块卷附件</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/managing-oracle-cloud-infrastructure-iscsi-block-volume-attachments-with-terraform-97726691b842?source=collection_archive---------0-----------------------#2018-11-08">https://medium.com/oracledevs/managing-oracle-cloud-infrastructure-iscsi-block-volume-attachments-with-terraform-97726691b842?source=collection_archive---------0-----------------------#2018-11-08</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="01f9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将额外的块存储数据卷附加到实例是许多<a class="ae jc" href="https://www.oracle.com/cloud/what-is-iaas/" rel="noopener ugc nofollow" target="_blank"> IaaS </a>云部署的常见用例。本文概述了一种使用<strong class="ig hi"> Terraform </strong>在<strong class="ig hi"> Oracle云基础架构</strong> (OCI)计算实例上管理<strong class="ig hi"> iSCSI数据块卷</strong>的附件和连接详细信息的方法。</p><p id="8128" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">| <code class="du jd je jf jg b"><em class="jh">Terraform 0.11.10</em></code> <em class="jh">，</em>，<code class="du jd je jf jg b"><em class="jh">provider.oci 3.5.0</em></code>，<em class="jh">，</em>，<code class="du jd je jf jg b"><em class="jh">Oracle Linux 7.4</em></code></p><p id="f88c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将附加块存储数据卷连接到实例时，需要考虑4个关键步骤:</p><ol class=""><li id="da1c" class="ji jj hh ig b ih ii il im ip jk it jl ix jm jb jn jo jp jq bi translated"><strong class="ig hi">创建</strong> —创建块存储卷资源。这是使用<code class="du jd je jf jg b"><a class="ae jc" href="https://www.terraform.io/docs/providers/oci/r/core_volume.html" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">oci_core_volume</strong></a></code> <strong class="ig hi">资源</strong>在Terraform中创建的。如果您正在使用现有的存储卷，您可以使用<code class="du jd je jf jg b"><a class="ae jc" href="https://www.terraform.io/docs/providers/oci/d/core_volume.html" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">oci_core_volume</strong></a></code> <strong class="ig hi">数据源。</strong></li><li id="53a2" class="ji jj hh ig b ih jr il js ip jt it ju ix jv jb jn jo jp jq bi translated"><strong class="ig hi">附加</strong> —将卷与特定实例相关联。这在Terraform中管理，创建一个<code class="du jd je jf jg b"><a class="ae jc" href="https://www.terraform.io/docs/providers/oci/r/core_volume_attachment.html" rel="noopener ugc nofollow" target="_blank"><strong class="ig hi">oci_core_volume_attachment</strong></a></code>资源。</li><li id="eff5" class="ji jj hh ig b ih jr il js ip jt it ju ix jv jb jn jo jp jq bi translated"><strong class="ig hi">连接</strong> —使客户操作系统能够访问存储设备。</li><li id="58a4" class="ji jj hh ig b ih jr il js ip jt it ju ix jv jb jn jo jp jq bi translated"><strong class="ig hi">挂载</strong> —将存储设备挂载为可用的文件系统。对于新的存储卷，这可能还包括创建分区表和初始化文件系统。</li></ol><p id="55b0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">步骤<strong class="ig hi"> 1 </strong>和<strong class="ig hi"> 2 </strong>直接使用<code class="du jd je jf jg b">oci_core_volume</code>和<code class="du jd je jf jg b">oci_core_volume_attachment</code>地形资源处理。对于本文，我们将特别关注将步骤<strong class="ig hi"> 3 </strong>和<strong class="ig hi"> 4 </strong>合并到我们的地形配置中。</p><h2 id="c690" class="jw jx hh bd jy jz ka kb kc kd ke kf kg ip kh ki kj it kk kl km ix kn ko kp kq bi translated">iSCSI音量连接</h2><p id="3cb5" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated"><a class="ae jc" href="https://docs.cloud.oracle.com/iaas/Content/Block/Concepts/overview.htm#iSCSI" rel="noopener ugc nofollow" target="_blank"> iSCSI </a>是一种基于IP的标准，用于连接的存储和裸机或虚拟机实例之间的通信，可以提供比<a class="ae jc" href="https://docs.cloud.oracle.com/iaas/Content/Block/Concepts/overview.htm#Paravirtualized" rel="noopener ugc nofollow" target="_blank">半虚拟化</a>卷附件更好、更一致的IOPS(参见<a class="ae jc" href="https://docs.cloud.oracle.com/iaas/Content/Block/Concepts/blockvolumeperformance.htm" rel="noopener ugc nofollow" target="_blank">块卷性能</a>)</p><p id="f605" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用半虚拟化卷附件时，连接步骤是自动的，但是对于iSCSI卷附件，您需要在设备可用之前在来宾操作系统中执行一些附加命令</p><ul class=""><li id="923f" class="ji jj hh ig b ih ii il im ip jk it jl ix jm jb kw jo jp jq bi translated">用<code class="du jd je jf jg b">iscsiadm</code>工具注册卷</li><li id="0a19" class="ji jj hh ig b ih jr il js ip jt it ju ix jv jb kw jo jp jq bi translated">将iSCSI配置为在重新启动后自动连接到数据块存储卷</li><li id="c9d9" class="ji jj hh ig b ih jr il js ip jt it ju ix jv jb kw jo jp jq bi translated">(可选)配置CHAP身份验证</li><li id="85ad" class="ji jj hh ig b ih jr il js ip jt it ju ix jv jb kw jo jp jq bi translated">登录iSCSI</li></ul><p id="1a23" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Oracle云基础设施控制台在<strong class="ig hi">块卷</strong>详细信息页面中提供了需要执行的确切<code class="du jd je jf jg b">iscsiadm</code>命令的详细信息。</p><figure class="ky kz la lb fd lc er es paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="er es kx"><img src="../Images/68a8b352edd1d6a3ea39a9afd4829501.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FycDw4qo7VPY3Wqfo9duqA.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx">Oracle Cloud Infrastructure Block Volume iSCSI Commands and Information</figcaption></figure><h2 id="53ea" class="jw jx hh bd jy jz ka kb kc kd ke kf kg ip kh ki kj it kk kl km ix kn ko kp kq bi translated">体积附件和与地形的连接</h2><p id="bc35" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">上面显示的所需iSCSI连接命令可以作为使用<code class="du jd je jf jg b">remote-exec</code>供应器创建<code class="du jd je jf jg b">oci_core_volume_attachment</code>资源的一部分来执行。每个附件的<strong class="ig hi"> IQN </strong>、iSCSI <strong class="ig hi"> IP地址</strong>和<strong class="ig hi">端口</strong>的必需值都可以作为附件资源的属性。</p><pre class="ky kz la lb fd ln jg lo lp aw lq bi"><span id="2ca2" class="jw jx hh jg b fi lr ls l lt lu">resource "oci_core_volume_attachment" "attachment1" {<br/><strong class="jg hi">  attachment_type = "iscsi"<br/></strong>  instance_id     = "${oci_core_instance.instance1.id}"<br/>  volume_id       = "${oci_core_volume.volume1.id}"</span><span id="d407" class="jw jx hh jg b fi lv ls l lt lu">  connection {<br/>    type        = "ssh"<br/>    host        = "${oci_core_instance.instance1.public_ip}"<br/>    user        = "opc"<br/>    private_key = "${file("~/.ssh/id_rsa")}"<br/>  }</span><span id="7f89" class="jw jx hh jg b fi lv ls l lt lu">  provisioner "remote-exec" {<br/>    inline = [<br/>      "sudo iscsiadm -m node -o new -T <strong class="jg hi">${self.iqn}</strong> -p <strong class="jg hi">${self.ipv4}</strong>:<strong class="jg hi">${self.port}</strong>",<br/>      "sudo iscsiadm -m node -o update -T <strong class="jg hi">${self.iqn}</strong> -n node.startup -v automatic",<br/>      "sudo iscsiadm -m node -T <strong class="jg hi">${self.iqn}</strong> -p <strong class="jg hi">${self.ipv4}</strong>:<strong class="jg hi">${self.port}</strong> -l",<br/>    ]<br/>  }<br/>}</span></pre><p id="6631" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了防止潜在的数据丢失，我们还希望在销毁附件之前完全断开数据块存储，方法是添加一个销毁时间资源调配器，并提供所需的断开连接命令。</p><pre class="ky kz la lb fd ln jg lo lp aw lq bi"><span id="8860" class="jw jx hh jg b fi lr ls l lt lu">  provisioner "remote-exec" {<br/><strong class="jg hi">    when       = "destroy"<br/>    </strong>on_failure <strong class="jg hi">=</strong> "continue"</span><span id="8b05" class="jw jx hh jg b fi lv ls l lt lu">    inline = [<br/>      "sudo iscsiadm -m node -T <strong class="jg hi">${self.iqn}</strong> -p <strong class="jg hi">${self.ipv4}</strong>:<strong class="jg hi">${self.port}</strong> -u",<br/>      "sudo iscsiadm -m node -o delete -T <strong class="jg hi">${self.iqn}</strong> -p <strong class="jg hi">${self.ipv4}</strong>:<strong class="jg hi">${self.port}</strong>",<br/>    ]<br/>  }</span></pre><p id="eefe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意:使用销毁时间置备程序有一些注意事项。更多详情参见<a class="ae jc" href="https://www.terraform.io/docs/provisioners/index.html#destroy-time-provisioners" rel="noopener ugc nofollow" target="_blank">地形文件</a></p><blockquote class="lw lx ly"><p id="dfae" class="ie if jh ig b ih ii ij ik il im in io lz iq ir is ma iu iv iw mb iy iz ja jb ha bi translated">销毁时置备程序只有在销毁资源时仍在配置中才能运行。如果从配置中完全删除带有销毁时置备程序的资源块，其置备程序配置也会随之删除，因此销毁置备程序将不会运行</p></blockquote><h2 id="7b67" class="jw jx hh bd jy jz ka kb kc kd ke kf kg ip kh ki kj it kk kl km ix kn ko kp kq bi translated">使用CHAP身份验证阻止卷附件</h2><p id="f4fe" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">使用CHAP身份验证时，需要包括三个额外的<code class="du jd je jf jg b">iscsiadm</code>命令，如下所示。</p><pre class="ky kz la lb fd ln jg lo lp aw lq bi"><span id="130f" class="jw jx hh jg b fi lr ls l lt lu">resource "oci_core_volume_attachment" "attachment2" {<br/><strong class="jg hi">  attachment_type = "iscsi"<br/></strong>  <strong class="jg hi">use_chap        = true<br/></strong>  instance_id     = "${oci_core_instance.instance1.id}"<br/>  volume_id       = "${oci_core_volume.volume2.id}"</span><span id="2f30" class="jw jx hh jg b fi lv ls l lt lu">  connection {<br/>    type        = "ssh"<br/>    host        = "${oci_core_instance.instance1.public_ip}"<br/>    user        = "opc"<br/>    private_key = "${file("~/.ssh/id_rsa")}"<br/>  }</span><span id="3081" class="jw jx hh jg b fi lv ls l lt lu">  provisioner "remote-exec" {<br/>    inline = [<br/>      "sudo iscsiadm -m node -o new -T ${self.iqn} -p ${self.ipv4}:${self.port}",<br/>      "sudo iscsiadm -m node -o update -T ${self.iqn} -n node.startup -v automatic",<br/><strong class="jg hi">      "sudo iscsiadm -m node -T ${self.iqn} -p ${self.ipv4}:${self.port} -o update -n node.session.auth.authmethod -v CHAP"<br/>      "sudo iscsiadm -m node -T ${self.iqn} -p ${self.ipv4}:${self.port} -o update -n node.session.auth.username -v ${self.chap_username}"<br/>      "sudo iscsiadm -m node -T ${self.iqn} -p ${self.ipv4}:${self.port} -o update -n node.session.auth.password -v ${self.chap_secret}"<br/></strong>      "sudo iscsiadm -m node -T ${self.iqn} -p ${self.ipv4}:${self.port} -l",<strong class="jg hi"><br/></strong>    ]<br/>  }<br/>}</span></pre><h1 id="79b7" class="mc jx hh bd jy md me mf kc mg mh mi kg mj mk ml kj mm mn mo km mp mq mr kp ms bi translated"><strong class="ak">安装块卷</strong></h1><p id="6f8c" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">成功将iSCSI数据块卷与实例连接后，通常需要装载设备以供文件系统使用。</p><p id="00c6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注意:如果您的部署脚本采用设备名称，如</strong> <code class="du jd je jf jg b"><strong class="ig hi">/dev/sdb</strong></code> <strong class="ig hi">或</strong> <code class="du jd je jf jg b"><strong class="ig hi">/dev/sdc</strong></code> <strong class="ig hi">，请注意，不能保证设备将被一致地分配预期的通用设备id，或者多个附件将总是以相同的顺序创建。</strong>以下介绍如何使用唯一的设备特定id安装存储设备。</p><p id="4301" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当您挂载一个新创建的卷时，您还需要初始化文件系统。在下面的示例中，我们将了解以下步骤:</p><ul class=""><li id="9245" class="ji jj hh ig b ih ii il im ip jk it jl ix jm jb kw jo jp jq bi translated">用GPT分区表初始化新卷</li><li id="f743" class="ji jj hh ig b ih jr il js ip jt it ju ix jv jb kw jo jp jq bi translated">用一个<code class="du jd je jf jg b">xfs</code>文件系统创建一个新分区</li><li id="fdbe" class="ji jj hh ig b ih jr il js ip jt it ju ix jv jb kw jo jp jq bi translated">更新<code class="du jd je jf jg b">/etc/fstab</code>以自动挂载分区</li></ul><p id="e3bd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注意:分区和文件系统步骤将破坏块卷上的任何现有数据。</strong></p><h2 id="7ccf" class="jw jx hh bd jy jz ka kb kc kd ke kf kg ip kh ki kj it kk kl km ix kn ko kp kq bi translated">1.通过路径找到iSCSI设备</h2><p id="00f7" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">连接的iSCSI设备映射到<code class="du jd je jf jg b">/dev/disk/by-path</code>下的唯一设备名称。设备名称基于<strong class="ig hi"> IQN </strong>、<strong class="ig hi"> IP地址</strong>和<strong class="ig hi">端口</strong>，格式如下:</p><pre class="ky kz la lb fd ln jg lo lp aw lq bi"><span id="26e8" class="jw jx hh jg b fi lr ls l lt lu">/dev/disk/by-path/ip-<strong class="jg hi"><em class="jh">IPADDRESS</em></strong>:<strong class="jg hi"><em class="jh">PORT</em></strong>-iscsi-<strong class="jg hi"><em class="jh">IQN</em></strong>-lun-1</span></pre><h2 id="545b" class="jw jx hh bd jy jz ka kb kc kd ke kf kg ip kh ki kj it kk kl km ix kn ko kp kq bi translated">2.初始化分区</h2><p id="2526" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">使用<code class="du jd je jf jg b">fdisk</code>我们初始化分区表，并为设备上的可用存储创建一个分区。</p><pre class="ky kz la lb fd ln jg lo lp aw lq bi"><span id="ffa4" class="jw jx hh jg b fi lr ls l lt lu">$ fdisk /dev/disk/by-path/ip-<strong class="jg hi"><em class="jh">IPADDRESS</em></strong>:<strong class="jg hi"><em class="jh">PORT</em></strong>-iscsi-<strong class="jg hi"><em class="jh">IQN</em></strong>-lun-1</span></pre><ul class=""><li id="c625" class="ji jj hh ig b ih ii il im ip jk it jl ix jm jb kw jo jp jq bi translated"><code class="du jd je jf jg b">g</code>创建一个新的空GPT分区表</li><li id="fb22" class="ji jj hh ig b ih jr il js ip jt it ju ix jv jb kw jo jp jq bi translated"><code class="du jd je jf jg b">n</code>添加新分区(默认分区号、默认第一个扇区和默认最后一个扇区)</li><li id="6e05" class="ji jj hh ig b ih jr il js ip jt it ju ix jv jb kw jo jp jq bi translated"><code class="du jd je jf jg b">w</code>将表格写入磁盘并退出</li></ul><p id="b436" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">新分区由附加了<code class="du jd je jf jg b">-part1</code>的设备路径标识。</p><pre class="ky kz la lb fd ln jg lo lp aw lq bi"><span id="30cd" class="jw jx hh jg b fi lr ls l lt lu">/dev/disk/by-path/ip-<strong class="jg hi"><em class="jh">IPADDRESS</em></strong>:<strong class="jg hi"><em class="jh">PORT</em></strong>-iscsi-<strong class="jg hi"><em class="jh">IQN</em></strong>-lun-1-part1</span></pre><p id="262a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们可以初始化分区上的文件系统。对于这个例子，我们使用<code class="du jd je jf jg b"><strong class="ig hi">xfs</strong></code>。</p><pre class="ky kz la lb fd ln jg lo lp aw lq bi"><span id="6b2f" class="jw jx hh jg b fi lr ls l lt lu">$ sudo mkfs.xfs \<br/>  /dev/disk/by-path/ip-<strong class="jg hi"><em class="jh">IPADDRESS</em></strong>:<strong class="jg hi"><em class="jh">PORT</em></strong>-iscsi-<strong class="jg hi"><em class="jh">IQN</em></strong>-lun-1-part1</span></pre><h2 id="6dcc" class="jw jx hh bd jy jz ka kb kc kd ke kf kg ip kh ki kj it kk kl km ix kn ko kp kq bi translated">3.自动挂载分区</h2><p id="1387" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">首先创建一个合适的挂载点，例如<code class="du jd je jf jg b">/mnt/vol1</code></p><pre class="ky kz la lb fd ln jg lo lp aw lq bi"><span id="df2c" class="jw jx hh jg b fi lr ls l lt lu">$ sudo mkdir -p /mnt/vol1</span></pre><p id="a4a3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">分区的UUID用于唯一标识挂载。使用<code class="du jd je jf jg b">blkid</code>找到UUID</p><pre class="ky kz la lb fd ln jg lo lp aw lq bi"><span id="56d0" class="jw jx hh jg b fi lr ls l lt lu">$ blkid -s UUID -o value \<br/>  /dev/disk/by-path/ip-<strong class="jg hi"><em class="jh">IPADDRESS</em></strong>:<strong class="jg hi"><em class="jh">PORT</em></strong>-iscsi-<strong class="jg hi"><em class="jh">IQN</em></strong>-lun-1-part1</span><span id="5b9a" class="jw jx hh jg b fi lv ls l lt lu">9ff8c2eb-4b54–4a81-bf4c-9b040663e172</span></pre><p id="eb32" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将下面一行添加到<code class="du jd je jf jg b">/etc/fstab</code>中，使用UUID在重启时自动挂载卷。如果与<code class="du jd je jf jg b"><strong class="ig hi">/mnt/vol1</strong></code>不同，请设置适当的挂载点位置，如果您使用的是与<code class="du jd je jf jg b"><strong class="ig hi">xfs</strong></code>不同的文件系统，请更改文件系统类型。iSCSI设备需要<code class="du jd je jf jg b">_netdev</code>选项。</p><pre class="ky kz la lb fd ln jg lo lp aw lq bi"><span id="3ef7" class="jw jx hh jg b fi lr ls l lt lu">UUID=9ff8c2eb-4b54–4a81-bf4c-9b040663e172 /mnt/vol1 xfs defaults,_netdev,nofail 0 2</span></pre><p id="0550" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，挂载文件系统:</p><pre class="ky kz la lb fd ln jg lo lp aw lq bi"><span id="783e" class="jw jx hh jg b fi lr ls l lt lu">$ sudo mount -a</span></pre><h1 id="1cca" class="mc jx hh bd jy md me mf kc mg mh mi kg mj mk ml kj mm mn mo km mp mq mr kp ms bi translated">最终配置</h1><p id="d782" class="pw-post-body-paragraph ie if hh ig b ih kr ij ik il ks in io ip kt ir is it ku iv iw ix kv iz ja jb ha bi translated">以上步骤可以添加到<code class="du jd je jf jg b">oci_core_volume_attachment</code>资源<code class="du jd je jf jg b">remote-exec</code>置备程序中。通过一些额外的保护措施来防止初始化已经存在的分区，并在断开连接之前卸载卷，我们完成的自连接iSCSI块卷附件资源现在看起来像这样:</p><pre class="ky kz la lb fd ln jg lo lp aw lq bi"><span id="f511" class="jw jx hh jg b fi lr ls l lt lu">resource "oci_core_volume_attachment" "attachment1" {</span><span id="4442" class="jw jx hh jg b fi lv ls l lt lu">  attachment_type = "iscsi"<br/>  instance_id     = "${oci_core_instance.instance1.id}"<br/>  volume_id       = "${oci_core_volume.volume1.id}"</span><span id="e778" class="jw jx hh jg b fi lv ls l lt lu">  connection {<br/>    type        = "ssh"<br/>    host        = "${oci_core_instance.instance1.public_ip}"<br/>    user        = "opc"<br/>    private_key = "${file("~/.ssh/id_rsa")}"<br/>  }</span><span id="f5dc" class="jw jx hh jg b fi lv ls l lt lu"><strong class="jg hi"><em class="jh">  # register and connect the iSCSI block volume<br/></em></strong>  provisioner "remote-exec" {<br/>    inline = [<br/>      "sudo iscsiadm -m node -o new -T ${self.iqn} -p ${self.ipv4}:${self.port}",<br/>      "sudo iscsiadm -m node -o update -T ${self.iqn} -n node.startup -v automatic",<br/>      "sudo iscsiadm -m node -T ${self.iqn} -p ${self.ipv4}:${self.port} -l",<br/>    ]<br/>  }</span><span id="2a7b" class="jw jx hh jg b fi lv ls l lt lu"><strong class="jg hi"><em class="jh">  # initialize partition and file system<br/></em></strong>  provisioner "remote-exec" {<br/>    inline = [<br/>      "set -x",<br/>      "export DEVICE_ID=ip-${self.ipv4}:${self.port}-iscsi-${self.iqn}-lun-1",<br/>      "export HAS_PARTITION=$(sudo partprobe -d -s /dev/disk/by-path/$${DEVICE_ID} | wc -l)",<br/>      "if [ $HAS_PARTITION -eq 0 ] ; then",<br/>      "  (echo g; echo n; echo ''; echo ''; echo ''; echo w) | sudo fdisk /dev/disk/by-path/$${DEVICE_ID}",<br/>      "  while [[ ! -e /dev/disk/by-path/$${DEVICE_ID}-part1 ]] ; do sleep 1; done",<br/>      "  sudo mkfs.xfs /dev/disk/by-path/$${DEVICE_ID}-part1",<br/>      "fi",<br/>    ]<br/>  }</span><span id="b5bd" class="jw jx hh jg b fi lv ls l lt lu"><strong class="jg hi"><em class="jh">  # mount the partition<br/></em></strong>  provisioner "remote-exec" {<br/>    inline = [<br/>      "set -x",<br/>      "export DEVICE_ID=ip-${self.ipv4}:${self.port}-iscsi-${self.iqn}-lun-1",<br/>      "sudo mkdir -p /mnt/vol1",<br/>      "export UUID=$(sudo /usr/sbin/blkid -s UUID -o value /dev/disk/by-path/$${DEVICE_ID}-part1)",<br/>      "echo 'UUID='$${UUID}' /mnt/vol1 xfs defaults,_netdev,nofail 0 2' | sudo tee -a /etc/fstab",<br/>      "sudo mount -a",<br/>    ]<br/>  }</span><span id="eb3d" class="jw jx hh jg b fi lv ls l lt lu"><strong class="jg hi"><em class="jh">  # unmount and disconnect on destroy<br/></em></strong>  provisioner "remote-exec" {<br/>    when       = "destroy"<br/>    on_failure = "continue"</span><span id="5091" class="jw jx hh jg b fi lv ls l lt lu">    inline = [<br/>      "set -x",<br/>      "export DEVICE_ID=ip-${self.ipv4}:${self.port}-iscsi-${self.iqn}-lun-1",<br/>      "export UUID=$(sudo /usr/sbin/blkid -s UUID -o value /dev/disk/by-path/$${DEVICE_ID}-part1)",<br/>      "sudo umount /mnt/vol1",<br/>      "if [[ $UUID ]] ; then",<br/>      "  sudo sed -i.bak '\\@^UUID='$${UUID}'<a class="ae jc" href="http://twitter.com/d" rel="noopener ugc nofollow" target="_blank">@d</a>' /etc/fstab",<br/>      "fi",<br/>      "sudo iscsiadm -m node -T ${self.iqn} -p ${self.ipv4}:${self.port} -u",<br/>      "sudo iscsiadm -m node -o delete -T ${self.iqn} -p ${self.ipv4}:${self.port}",<br/>    ]<br/>  }<br/>}</span></pre><h1 id="fca6" class="mc jx hh bd jy md me mf kc mg mh mi kg mj mk ml kj mm mn mo km mp mq mr kp ms bi translated">进一步阅读</h1><ul class=""><li id="27ad" class="ji jj hh ig b ih kr il ks ip mt it mu ix mv jb kw jo jp jq bi translated"><a class="ae jc" href="https://docs.cloud.oracle.com/iaas/Content/Block/Concepts/overview.htm" rel="noopener ugc nofollow" target="_blank">块体积概述</a></li><li id="4af6" class="ji jj hh ig b ih jr il js ip jt it ju ix jv jb kw jo jp jq bi translated">Oracle云基础架构<a class="ae jc" href="https://docs.cloud.oracle.com/iaas/Content/Block/Tasks/connectingtoavolume.htm" rel="noopener ugc nofollow" target="_blank">连接到卷</a></li><li id="72d6" class="ji jj hh ig b ih jr il js ip jt it ju ix jv jb kw jo jp jq bi translated">Oracle云基础设施<a class="ae jc" href="https://docs.cloud.oracle.com/iaas/Content/Block/References/fstaboptions.htm" rel="noopener ugc nofollow" target="_blank"> /etc/fstab选项</a></li></ul></div></div>    
</body>
</html>