<html>
<head>
<title>Presto On Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure上的Presto</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/presto-on-azure-c9bb8357a50a?source=collection_archive---------1-----------------------#2020-06-08">https://medium.com/walmartglobaltech/presto-on-azure-c9bb8357a50a?source=collection_archive---------1-----------------------#2020-06-08</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/6475d8a021552cf0c5a70f526ad2bedc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U0KtloOftUoSycwtWAgW4g.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Source: <a class="ae it" href="https://github.com/prestosql/presto/blob/master/presto-docs/src/main/resources/logo/web/main/blue/Presto_Logo_DarkBlueBG.svg" rel="noopener ugc nofollow" target="_blank">Presto</a>, <a class="ae it" href="https://commons.wikimedia.org/wiki/File:Microsoft_Azure_Logo.svg" rel="noopener ugc nofollow" target="_blank">Azure</a></figcaption></figure><p id="2dd0" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi js translated">resto是一个分布式SQL查询引擎，旨在通过使用分布式执行来高效地查询大量数据。由于它的分布式内存处理架构，它已经成为发展最快的SQL查询引擎。</p><p id="8163" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">像其他数据处理引擎一样，Presto可以部署在多个平台上。当谈到解耦计算和数据的系统时，Presto非常适合，这也是Presto非常适合云的主要原因。</p><p id="2359" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在本文中，我们将计划做三件事，</p><p id="a0c8" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="kb">我们将在Azure上建立3个节点的自动扩展的Presto集群。</em></p><p id="8a37" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="kb">配置配置单元目录以访问多种类型的Azure存储。</em></p><p id="570b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在Azure上创建Presto集群的其他可用选项。</p><h1 id="2b1e" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">在Azure虚拟机上运行Presto</h1><p id="a047" class="pw-post-body-paragraph iu iv hh iw b ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn le jp jq jr ha bi translated"><strong class="iw hi">我们要做的是建立一个集群—</strong></p><p id="7b31" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">1.启动2个虚拟机，设置Presto协调器和Presto worker。</p><p id="118c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">2.从我们在上一步中设置的Presto worker VM创建一个映像。</p><p id="df49" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">3.使用Presto worker虚拟机映像为Presto worker创建一个比例集。</p><p id="21ea" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">4.配置自动缩放策略。</p><p id="dc47" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">5.验证设置。</p><h1 id="ebbb" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">让我们为Presto设置创建2个虚拟机</h1><p id="4b4e" class="pw-post-body-paragraph iu iv hh iw b ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn le jp jq jr ha bi translated">我们首先需要2个Azure虚拟机，在虚拟机上安装java，然后我们将分别设置Presto协调器和工作器。</p><p id="3a66" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">你可以在这里找到设置azure-cli的步骤。</p><p id="280b" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您可以使用以下命令来启动Azure VM，</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="68be" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Presto coordinator和worker至少需要在其coordinator和worker上安装Java8。我推荐使用Java11来获得更好的GC。</p><h1 id="07d5" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">快速协调器和工人设置</h1><p id="b5c9" class="pw-post-body-paragraph iu iv hh iw b ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn le jp jq jr ha bi translated">按照以下步骤在虚拟机上设置Presto协调器，</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="2083" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">按照以下步骤在虚拟机上设置Presto Worker，</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="1f07" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">以防万一，如果您在启动Presto协调器或工作器时遇到任何问题，那么您可以在各个虚拟机上的'<strong class="iw hi">/var/Presto/data/var/log/server . log</strong>'位置找到日志。</p><p id="6572" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在这一点上，我们已经设置好用1个worker count来检查我们的Presto UI。您可以在<em class="kb">http:://{ Presto-coordinator-IP }:8080</em>启动Presto UI</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ll"><img src="../Images/2dbd1b0a8f7f496e3fbca603415802ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3UDOW4oJIYoBvJMlysN6wQ.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Figure 1: Presto Coordinator UI</figcaption></figure><h1 id="b4e3" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">让我们准备一个快速的工人图像</h1><p id="1341" class="pw-post-body-paragraph iu iv hh iw b ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn le jp jq jr ha bi translated">我们已经设置了Presto worker虚拟机，我们将使用它来创建一个Presto worker映像，我们将使用它进行自动扩展部署。</p><p id="db00" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">首先，我们必须登录到上一步中设置的Presto worker VM，然后运行下面的脚本，</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="12ed" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">一旦我们运行了上面的脚本，我们就为定制映像虚拟机的创建做好了云初始化安装的准备。输入exit关闭SSH客户机，并按照下面脚本中的步骤创建Presto worker映像，</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><h1 id="a239" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">我们现在准备使用Presto worker映像为集群创建我们的规模集</h1><p id="da28" class="pw-post-body-paragraph iu iv hh iw b ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn le jp jq jr ha bi translated">在此步骤中，我们将为我们的群集创建一个扩展集，开始时最少包含2个节点，并将为其设置自动扩展规则。</p><p id="13e6" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">作为此设置的一部分，当5分钟内实例间的CPU百分比平均值大于75%时，autoscaler将向上扩展2个实例，当5分钟内实例间的CPU百分比平均值小于30%时，autoscaler将向下扩展1个实例。</p><p id="d048" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这取决于你想如何为你的设置配置自动缩放规则。</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="8d1a" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们有3个节点(1个协调器和2个工作器),可以根据CPU使用情况进行自动扩展。</p><h1 id="1311" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">确认</h1><p id="a199" class="pw-post-body-paragraph iu iv hh iw b ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn le jp jq jr ha bi translated">让我们在<em class="kb">http:://{ Presto-coordinator-IP }:8080</em>打开Presto UI进行验证</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lm"><img src="../Images/cc7737522235a32d89e0f94d7eac5947.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BYPUHADVqV9H-It7.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Figure 2:Presto coordinator UI</figcaption></figure><h1 id="6214" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">快速为配置单元目录准备配置</h1><p id="6a17" class="pw-post-body-paragraph iu iv hh iw b ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn le jp jq jr ha bi translated">假设你已经有一个Azure存储帐户，并且Azure注册应用程序被授予访问权限。</p><p id="76fc" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果您需要对存储的<strong class="iw hi">只读访问权限</strong>，向Azure注册的应用程序提供IAM访问权限<strong class="iw hi">存储Blob数据读取器</strong>角色。</p><p id="896f" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果您需要对存储的读写访问权限，请向Azure注册的应用程序提供IAM访问权限。</p><p id="94d1" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">接下来的步骤是为Presto集群配置配置单元目录。让我们把下面的配置放在Azure注册应用程序的手边，</p><p id="df09" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">应用程序(客户端)ID</p><p id="345d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">可在应用内生成的客户端密码</p><p id="47b4" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Oauth 2.0令牌端点(v1)</p><p id="1af6" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">占位符{Oauth2.0-endpoint}、{client-id}和{client-secret}在使用前必须替换为azure-site.xml中的应用信息。</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="9774" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">将您配置的azure-site.xml放在所有主机(Presto coordinator和workers)上的Presto安装目录中(默认位置是/usr/lib/presto/etc/)。</p><h2 id="8c8a" class="ln kd hh bd ke lo lp lq ki lr ls lt km jf lu lv kq jj lw lx ku jn ly lz ky ma bi translated">正在配置配置单元目录</h2><p id="8d63" class="pw-post-body-paragraph iu iv hh iw b ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn le jp jq jr ha bi translated">是时候让您的配置单元目录配置为通过Presto访问在Azure存储上创建的表了。这将需要重新启动集群。</p><p id="d5ec" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">不要忘记用您的配置替换占位符。</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><h1 id="2de9" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">最后，是时候通过Presto进行查询了</h1><p id="23c2" class="pw-post-body-paragraph iu iv hh iw b ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn le jp jq jr ha bi translated">Presto与Presto-CLI捆绑在一起，它提供了一个基于终端的交互式shell来运行查询。您可以登录到协调器并安装Presto-CLI来运行您的查询。</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="ed60" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Presto与Presto-CLI捆绑在一起，它提供了一个基于终端的交互式shell来运行查询。您可以通过运行命令“presto”来启动CLI。</p><p id="1eaa" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您可以登录到协调器并登录到Presto-Cli，然后您就可以通过Presto进行查询了。</p><figure class="lf lg lh li fd ii"><div class="bz dy l di"><div class="lj lk l"/></div></figure><p id="771d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">访问Presto不仅限于Presto-cli。它可以通过你选择的任何BI工具访问，可以是Superset、DBeaver、Looker、Tableau、Power BI等等。</p><h1 id="0990" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">Azure上Presto设置的其他可用选项</h1><p id="df89" class="pw-post-body-paragraph iu iv hh iw b ix la iz ja jb lb jd je jf lc jh ji jj ld jl jm jn le jp jq jr ha bi translated">使用Azure HDInsight可以运行Presto，您可以使用bash脚本URI在现有或新的HDInsight <em class="kb"> Hadoop </em>集群(版本3.5或更高)上运行自定义<a class="ae it" href="https://docs.microsoft.com/en-us/azure/hdinsight/hdinsight-hadoop-customize-cluster-linux" rel="noopener ugc nofollow" target="_blank">脚本操作</a>。</p><p id="f17c" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">使用Azure HDInsight运行Presto会很好，但Presto已经是一个资源密集型进程，与HDInsight进程共享Presto资源不会有效。如果你想为Presto有效地管理你的资源，我强烈建议在Azure vanilla虚拟机上设置Presto。</p></div></div>    
</body>
</html>