<html>
<head>
<title>Implementing Square’s Payment Form in Reaction Commerce</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在互动商务中实现广场支付形式</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/implementing-sqpaymentform-in-reaction-commerce-31cfdb737ee2?source=collection_archive---------1-----------------------#2018-01-12">https://medium.com/square-corner-blog/implementing-sqpaymentform-in-reaction-commerce-31cfdb737ee2?source=collection_archive---------1-----------------------#2018-01-12</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><blockquote class="ie"><p id="f74e" class="if ig hh bd ih ii ij ik il im in io dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们在https://developer.squareup.com/blog<a class="ae ip" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">的新家</a></p></blockquote><p id="9877" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm io ha bi translated">根据支付卡行业数据安全标准(<a class="ae ip" href="https://squareup.com/guides/pci-compliance" rel="noopener ugc nofollow" target="_blank"> PCI-DSS </a>)，为了安全地处理支付，您必须最大限度地减少您处理的敏感持卡人数据量。如果您不这样做，您可能会受到攻击，失去处理支付的能力，或者招致处理者的罚款。</p><blockquote class="jn jo jp"><p id="4cdc" class="iq ir jq is b it jr iv iw ix js iz ja jt ju jd je jv jw jh ji jx jy jl jm io ha bi translated"><strong class="is hi"> <em class="hh">不付款=没钱&amp;没钱=没生意</em> </strong>。</p></blockquote><p id="7cb6" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">一旦您接受、处理、存储或传输敏感的持卡人数据，您就有责任保护这些数据。那么，您如何确保客户的数据是安全的呢？<a class="ae ip" href="https://hackernoon.com/im-harvesting-credit-card-numbers-and-passwords-from-your-site-here-s-how-9a8cb347c5b5" rel="noopener ugc nofollow" target="_blank">我们知道</a>黑客在不断创新窃取敏感信息的新方法。在Square，我们提供符合PCI的产品和服务，因此您不需要单独验证您的合规状态。</p><p id="af50" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">Square通过提供<a class="ae ip" href="https://docs.connect.squareup.com/payments/sqpaymentform/sqpaymentform-overview" rel="noopener ugc nofollow" target="_blank">SqPaymentForm</a>JavaScript库来安全处理客户支付信息，从而帮助您完全避免处理敏感的支付信息。<code class="du jz ka kb kc b">SqPaymentForm</code>是一个托管的JavaScript库，您可以加载到您的页面上，它有助于生成一个iframe表单，该表单可以安全地捕获客户的支付信息。处理表单时，它将生成一个nonce，用一个替代令牌替换持卡人的敏感信息。您可以引用这个令牌来处理客户的付款，并使用Square的API执行其他操作。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es kd"><img src="../Images/1599c0c359b2e69658dbf16d6ee310f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*3YfMc7lmguosz2Z3kciA3Q.png"/></div></figure><p id="75a1" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">为了演示如何实现一个安全的支付表单，我使用<a class="ae ip" href="https://reactioncommerce.com/" rel="noopener ugc nofollow" target="_blank"> Reaction Commerce </a>实现了一个。对于那些不熟悉的人来说，<a class="ae ip" href="https://reactioncommerce.com/" rel="noopener ugc nofollow" target="_blank"> Reaction Commerce </a>是一个使用Meteor构建的开源电子商务平台。这让我们展示了在更复杂的环境中加载支付表单的方法，这迫使我们使用不太简单的实现。</p><p id="82df" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">因此，在所有这些描述结束后，让我们实际上深入研究一些示例，并通过一种方法在Reaction Commerce内部实现<code class="du jz ka kb kc b">SqPaymentForm</code>。</p><p id="a3c4" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">通常，您需要在想要使用脚本标签处理客户付款的页面上包含<code class="du jz ka kb kc b">SqPaymentForm</code>(通常这是在结帐页面上)。</p><figure class="ke kf kg kh fd ki"><div class="bz dy l di"><div class="kl km l"/></div><figcaption class="kn ko et er es kp kq bd b be z dx">You need to include the hosted version, otherwise your attempts to process the form will fail.</figcaption></figure><p id="7644" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">只要您可以简单地使用HTML标签来包含您的脚本，上述方法就会非常有效。不幸的是，我们不能使用这种方法来实现，因为Meteor有一个独特的模板系统(<a class="ae ip" href="http://blazejs.org/" rel="noopener ugc nofollow" target="_blank"> Blaze </a>)，这使得包含外部脚本很困难。为了保证在结帐时可以访问<code class="du jz ka kb kc b">SqPaymentForm</code>对象，我们可以将script标签添加到主HTML模板的标题中。这样做的问题是，在主HTML模板中包含这个脚本，并在应用程序的每个页面上加载它，而实际上我们只是在结账时才需要它，这看起来很笨拙。</p><p id="0dd1" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">试图将脚本包含在结帐模板中的主要问题是，我们不能保证在我们试图实例化<code class="du jz ka kb kc b">SqPaymentForm</code>对象时，Square的支付表单脚本已经被加载。我们可以使用jQuery的<code class="du jz ka kb kc b">getScript()</code>方法来规避这个问题，因为Reaction Commerce为我们提供了这个方法，并且当我们试图在客户端脚本中使用<code class="du jz ka kb kc b">SqPaymentForm</code>对象时，我们可以保证我们已经加载了脚本。</p><figure class="ke kf kg kh fd ki"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="9c6a" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">您可以看到我们现在正在访问<code class="du jz ka kb kc b">getScript()</code>方法的承诺链中的<code class="du jz ka kb kc b">SqPaymentForm</code>对象。在我的fork of Reaction Commerce中，我实际上已经将这一切打包在一个函数中，以便在我们需要销毁支付表单并重新创建它的情况下可以再次调用它(在我们的教程<a class="ae ip" href="https://docs.connect.squareup.com/payments/sqpaymentform/sqpaymentform-setup#troubleshooting" rel="noopener ugc nofollow" target="_blank">的故障排除部分中可以看到更多这方面的内容</a>)。</p><p id="1147" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">这应该足够让我们加载支付表单，并拥有我们想要的样式，但是我们仍然缺少生成用于处理支付的<code class="du jz ka kb kc b">nonce</code>的功能。第一步是触发<code class="du jz ka kb kc b">paymentForm</code>为我们请求一张卡<code class="du jz ka kb kc b">nonce</code>。</p><figure class="ke kf kg kh fd ki"><div class="bz dy l di"><div class="kl km l"/></div><figcaption class="kn ko et er es kp kq bd b be z dx">createPaymentForm() is just a function wrapping our .getScript() method from earlier.</figcaption></figure><p id="24e7" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">所以我们在submit按钮上添加了一个监听器来拦截提交，这样我们就可以先触发<code class="du jz ka kb kc b">requestCardNonce()</code>方法。一旦我们有了<code class="du jz ka kb kc b">nonce</code>，我们就可以触发表单实际提交，返回的<code class="du jz ka kb kc b">nonce</code>放在一个隐藏的输入字段中。<code class="du jz ka kb kc b">SqPaymentForm</code>为我们提供了一个回调函数，用于知道我们何时收到了卡<code class="du jz ka kb kc b">nonce</code>的响应，称为<code class="du jz ka kb kc b">cardNonceResponseReceived()</code>。</p><figure class="ke kf kg kh fd ki"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="1c08" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">我们在这里有非常基本的错误日志，以防生成或接收<code class="du jz ka kb kc b">nonce</code>时出现问题，但是在将<code class="du jz ka kb kc b">nonce</code>注入到我们隐藏的nonce输入字段后，我们继续通常的表单提交过程。</p><figure class="ke kf kg kh fd ki"><div class="bz dy l di"><div class="kl km l"/></div><figcaption class="kn ko et er es kp kq bd b be z dx">Lines 7, 15, and 37 are the places to make note of changes on the form’s lifecycle</figcaption></figure><p id="f6dd" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">由于Reaction Commerce使用<code class="du jz ka kb kc b">AutoForm</code>来处理所有的表单处理，我认为最好尝试利用它来更加符合平台的配置方式。<code class="du jz ka kb kc b">AutoForm</code>有一些处理表单提交的生命周期方法，我们将在这里处理我们的<code class="du jz ka kb kc b">nonce</code>,并将其传递回服务器进行处理。在<code class="du jz ka kb kc b">AutoForm</code>中，有一个<code class="du jz ka kb kc b">onSubmit</code>钩子，我们可以用它来处理任何事情。</p><p id="ed0b" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">表单值通过doc变量传递给<code class="du jz ka kb kc b">onSubmit</code>函数，我们可以用它来取出我们的<code class="du jz ka kb kc b">nonce</code>发送给服务器。我们还在成功处理后添加了<code class="du jz ka kb kc b">paymentForm.destroy()</code>,这样，如果他们在下订单后决定继续购物，就不会有任何问题。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es kr"><img src="../Images/0bad21b8cb8a7689875361214440f6db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/1*T5fU3fwcd2OEk_OEjJo-vw.png"/></div><figcaption class="kn ko et er es kp kq bd b be z dx">Here is our final form loaded on the checkout page.</figcaption></figure><p id="ac8c" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">现在我们已经使用<code class="du jz ka kb kc b">SqPaymentForm</code>成功地生成并处理了付款表单！剩下要做的就是实现处理支付的后端流程。这只是在非正常环境中实现支付处理前端的快速演练，以便您可以生成卡<code class="du jz ka kb kc b">nonce</code>并将其发送到您的后端服务器。</p><p id="4fcc" class="pw-post-body-paragraph iq ir hh is b it jr iv iw ix js iz ja jb ju jd je jf jw jh ji jj jy jl jm io ha bi translated">你可以在<a class="ae ip" href="https://github.com/mootrichard/reaction" rel="noopener ugc nofollow" target="_blank">https://github.com/mootrichard/reaction</a>查看我的fork来了解全部内容(它仍然只有前端表单设置在工作，仍然有一些不必要的日志记录)。请自己尝试一下，给我留下评论，让我知道你对它的看法。您可以在https://connect.squareup.com/apps<a class="ae ip" href="https://connect.squareup.com/apps" rel="noopener ugc nofollow" target="_blank">的</a>注册自己的Square开发者账户，如果您有兴趣了解更多关于Square开发者平台的信息，请注册订阅我们的时事通讯。</p></div></div>    
</body>
</html>