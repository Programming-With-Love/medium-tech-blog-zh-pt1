<html>
<head>
<title>Managing Oracle Cloud Infrastructure iSCSI Block Volume attachments with Terraform. Part 2: Windows Instances</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform管理Oracle云基础架构iSCSI数据块卷附件。第2部分:Windows实例</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/managing-oracle-cloud-infrastructure-iscsi-block-volume-attachments-with-terraform-16ae46fdf3b4?source=collection_archive---------0-----------------------#2019-01-20">https://medium.com/oracledevs/managing-oracle-cloud-infrastructure-iscsi-block-volume-attachments-with-terraform-16ae46fdf3b4?source=collection_archive---------0-----------------------#2019-01-20</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="2131" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我的第一篇关于使用Terraform  管理Oracle云基础设施iSCSI块卷附件的帖子只涵盖了Oracle Linux实例的步骤。在本文中，我们将了解如何使用相同的方法将iSCSI数据块卷连接到Windows实例。</p><h1 id="3da5" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">使用WinRM启用远程执行资源调配</h1><p id="5acc" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">首先，我们需要在创建时为远程资源调配启用实例。Oracle云基础架构Windows映像支持<code class="du kg kh ki kj b">cloudbase-init</code>和WinRM(参见<a class="ae jc" href="https://docs.cloud.oracle.com/iaas/Content/Compute/References/images.htm?Highlight=cloudbase-init#winDetails" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi"> Oracle提供的映像</strong> </a> <strong class="ig hi">)，</strong>但是在能够将Terraform remote-exec provisioner用于WinRM之前，必须满足一些网络和实例配置先决条件。</p><h2 id="5a6b" class="kk je hh bd jf kl km kn jj ko kp kq jn ip kr ks jr it kt ku jv ix kv kw jz kx bi translated">启用入站WinRM流量</h2><p id="088e" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">配置您的子网安全规则以允许WinRM流量进入端口<strong class="ig hi"> 5986 </strong>。例如，可以将下面的规则添加到将在其中创建实例的子网的<code class="du kg kh ki kj b">oci_core_security_list</code>中。</p><pre class="ky kz la lb fd lc kj ld le aw lf bi"><span id="6af5" class="kk je hh kj b fi lg lh l li lj">  # allow inbound winrm traffic<br/>  ingress_security_rules {<br/>    protocol  = "6"<br/>    source    = "0.0.0.0/0"<br/>    stateless = false<br/>    tcp_options { <br/>      "min" = <strong class="kj hi">5986</strong><br/>      "max" = <strong class="kj hi">5986</strong><br/>    }<br/>  }</span></pre><h2 id="ba77" class="kk je hh bd jf kl km kn jj ko kp kq jn ip kr ks jr it kt ku jv ix kv kw jz kx bi translated">启用远程访问管理员帐户</h2><p id="0efb" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们需要启用合适的远程管理帐户。<strong class="ig hi">在创建和管理远程访问帐户时，您应该遵循自己公司的安全指导方针和政策</strong>。</p><p id="b161" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为Oracle提供的Windows服务器映像创建的默认<code class="du kg kh ki kj b">opc</code>管理员帐户启用了密码过期，这要求用户在首次登录时更改帐户密码，这将阻止任何远程执行，直到手动更改密码。要在配置期间使用<code class="du kg kh ki kj b">opc</code>帐户启用远程访问，我们需要在<code class="du kg kh ki kj b">cloudbase-init</code>启动脚本中禁用密码过期。</p><pre class="ky kz la lb fd lc kj ld le aw lf bi"><span id="6a33" class="kk je hh kj b fi lg lh l li lj">#ps1_sysnative<br/>cmd /C 'wmic UserAccount where Name="opc" set PasswordExpires=False'</span></pre><p id="a438" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有关如何在实例配置中包含云初始化脚本的详细信息，请参见<a class="ae jc" rel="noopener" href="/oracledevs/automating-instance-initialization-with-terraform-on-oracle-cloud-infrastructure-part-2-e1aa1a8710d"> <strong class="ig hi">在Oracle云基础设施上使用Terraform自动化实例初始化:第2部分</strong> </a></p><h2 id="1d6a" class="kk je hh bd jf kl km kn jj ko kp kq jn ip kr ks jr it kt ku jv ix kv kw jz kx bi translated">terra form remote-exec provisioner WinRM连接设置</h2><p id="1fa3" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">使用以下设置为远程执行置备程序配置资源<code class="du kg kh ki kj b">connection</code>块</p><pre class="ky kz la lb fd lc kj ld le aw lf bi"><span id="4b5b" class="kk je hh kj b fi lg lh l li lj">  connection {<br/>    type     = <strong class="kj hi">"winrm"</strong><br/>    insecure = <strong class="kj hi">true</strong><br/>    https    = <strong class="kj hi">true</strong><br/>    port     = <strong class="kj hi">5986</strong><br/>    host     = "${oci_core_instance.instance1.public_ip}"<br/>    user     = "${data.oci_core_instance_credentials.instance1.username}"<br/>    password = "${data.oci_core_instance_credentials.instance1.password}"<br/>  }</span></pre><p id="2583" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因为我们使用的是<code class="du kg kh ki kj b">opc</code>帐户，所以我们可以从<code class="du kg kh ki kj b">oci_core_instance_credentials</code>数据源获取初始密码。</p><pre class="ky kz la lb fd lc kj ld le aw lf bi"><span id="d3ef" class="kk je hh kj b fi lg lh l li lj">data "oci_core_instance_credentials" "instance1" {<br/>  instance_id = "${oci_core_instance.instance1.id}"<br/>}</span></pre><h1 id="5f82" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">iSCSI块卷附件</h1><p id="9523" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">正如我在<a class="ae jc" rel="noopener" href="/oracledevs/managing-oracle-cloud-infrastructure-iscsi-block-volume-attachments-with-terraform-97726691b842"> <strong class="ig hi">使用Terraform</strong></a><strong class="ig hi"/>管理Oracle云基础设施iSCSI块卷附件中所介绍的，将块卷附加到实例的过程涉及多个步骤，包括<strong class="ig hi">附加</strong>块卷资源、<strong class="ig hi">连接</strong>操作系统中的iSCSI设备，以及最后<strong class="ig hi">挂载</strong>卷。</p><p id="7396" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Oracle云基础架构控制台提供了在<strong class="ig hi">块卷</strong>详细信息页面中附加卷后需要执行的iSCSI PowerShell命令的详细信息。</p><figure class="ky kz la lb fd ll er es paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="er es lk"><img src="../Images/160471cbaf3102a315cfac40706a357e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7009SW97O1kBkC2G1KsgJw.png"/></div></div><figcaption class="ls lt et er es lu lv bd b be z dx">Oracle Cloud Infrastructure Block Volume iSCSI Commands and Information</figcaption></figure><p id="a4e6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">前两个命令只需要执行一次就可以启用iSCSI服务，这些命令可以添加到实例<code class="du kg kh ki kj b">cloudbase-init</code>脚本中，以便在启动时初始化。</p><pre class="ky kz la lb fd lc kj ld le aw lf bi"><span id="5ef1" class="kk je hh kj b fi lg lh l li lj">#ps1_sysnative<br/>Set-Service -Name msiscsi -StartupType Automatic<br/>Start-Service msiscsi</span></pre><p id="708d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">设备特定的命令包含在用于<code class="du kg kh ki kj b">oci_core_volume_attachment</code>资源的远程执行供应器中，因此它们只在实例启动后在附件上运行。为了在分离数据块卷时完全断开连接，我们还提供了销毁时间资源调配器。对于Windows Server 2008和Windows Server 2012/2016，iSCSI命令有所不同</p><p id="6826" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> Windows Server 2012/2016 </strong></p><pre class="ky kz la lb fd lc kj ld le aw lf bi"><span id="b8a9" class="kk je hh kj b fi lg lh l li lj">  # register and connect the iSCSI block volume<br/>  provisioner "remote-exec" {<br/>    inline = [<br/>      "  Powershell New-IscsiTargetPortal –TargetPortalAddress <strong class="kj hi">${self.ipv4}</strong>",<br/>      "  Powershell Connect-IscsiTarget -NodeAddress <strong class="kj hi">${self.iqn}</strong> -TargetPortalAddress <strong class="kj hi">${self.ipv4}</strong> -IsPersistent $True",<br/>    ]<br/>  }</span><span id="5b66" class="kk je hh kj b fi lw lh l li lj">  # disconnect and unregister on destroy<br/>  provisioner "remote-exec" {<br/>    when       = "destroy"<br/>    on_failure = "continue"</span><span id="83b7" class="kk je hh kj b fi lw lh l li lj">  inline = [<br/>      "  Powershell Disconnect-IscsiTarget -NodeAddress <strong class="kj hi">${self.iqn}</strong> -Confirm:$false",<br/>      "  Powershell Remove-IscsiTargetPortal -TargetPortalAddress <strong class="kj hi">${self.ipv4}</strong> -Confirm:$false",<br/>    ]<br/>  }</span></pre><p id="390e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lx">注意:</em> <code class="du kg kh ki kj b">Powershell</code> <em class="lx">命令前的空格看似随意，但实际上很重要。不知道为什么，但是很管用:-) </em></p><p id="07f3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> Windows Server 2008 </strong></p><p id="0303" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Windows 2008上，我们需要使用<code class="du kg kh ki kj b">iscsicli.exe</code>命令</p><pre class="ky kz la lb fd lc kj ld le aw lf bi"><span id="e5e0" class="kk je hh kj b fi lg lh l li lj">  # register and connect the iSCSI block volume<br/>  provisioner "remote-exec" {<br/>    inline = [<br/>      "iscsicli.exe QAddTargetPortal <strong class="kj hi">${self.ipv4}</strong>",<br/>      "iscsicli.exe QLoginTarget <strong class="kj hi">${self.iqn}</strong>",<br/>      "iscsicli.exe PersistentLoginTarget <strong class="kj hi">${self.iqn}</strong> * <strong class="kj hi">${self.ipv4}</strong> <strong class="kj hi">${self.port}</strong> * * * * * * * * * * * * * *"<br/>    ]<br/>  }</span><span id="51ce" class="kk je hh kj b fi lw lh l li lj">  # unregister on destroy<br/>  provisioner "remote-exec" {<br/>    when       = "destroy"<br/>    on_failure = "continue"</span><span id="7419" class="kk je hh kj b fi lw lh l li lj">inline = [<br/>      "iscsicli.exe RemovePersistentTarget <strong class="kj hi">Root\iScsiPrt\0000_0</strong> <strong class="kj hi">${self.iqn}</strong> * <strong class="kj hi">${self.ipv4}</strong> <strong class="kj hi">${self.port}</strong>"<br/>      "iscsicli.exe RemoveTarget <strong class="kj hi">${self.iqn}</strong>",<br/>      "iscsicli.exe RemoveTargetPortal <strong class="kj hi">${self.ipv4}</strong> <strong class="kj hi">${self.port}</strong>",<br/>    ]<br/>  }</span></pre><h1 id="a0d0" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">装载块卷</h1><p id="2dee" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">在我关于块卷附件的原始文章中，我介绍了如何使用唯一的iSCSI设备id确定性地挂载卷，以确保每次挂载都被一致地分配到相同的挂载点/驱动器。老实说，我的Powershell技能充其量只能算是最低限度的，我只是不知道如何在Windows上做到这一点，所以这一部分主要是留给读者作为练习。</p><blockquote class="ly lz ma"><p id="9699" class="ie if lx ig b ih ii ij ik il im in io mb iq ir is mc iu iv iw md iy iz ja jb ha bi translated">与其提供坏建议，不如什么建议都不提供。</p></blockquote><p id="22d2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是，对于一个非常基本的用例，如果您只需要初始化和格式化一个新的附加卷，您可以使用以下Powershell命令。<strong class="ig hi">不要将这些命令添加到没有附加脚本的</strong> <code class="du kg kh ki kj b">oci_core_volume_attachment</code> <strong class="ig hi">资源供应器，以防止破坏已经初始化的卷上的数据。</strong></p><pre class="ky kz la lb fd lc kj ld le aw lf bi"><span id="3033" class="kk je hh kj b fi lg lh l li lj">Initialize-Disk <strong class="kj hi">-Number 1</strong><br/>New-Partition <strong class="kj hi">-DiskNumber 1</strong> -UseMaximumSize -AssignDriveLetter<br/>Powershell Format-Volume <strong class="kj hi">-DriveLetter D</strong> -Confirm:$false"</span></pre><h1 id="2462" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">最终配置</h1><p id="b4a2" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">这是一个完整的示例，用于启动带有连接的iSCSI数据块卷的Windows Server 2016 Standard Edition实例</p><figure class="ky kz la lb fd ll"><div class="bz dy l di"><div class="me mf l"/></div></figure><h1 id="0e59" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">相关文章</h1><div class="mg mh ez fb mi mj"><a href="https://blogs.oracle.com/cloud-infrastructure/windows-custom-startup-scripts-and-cloud-init-on-oracle-cloud-infrastructure" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hi fi z dy mo ea eb mp ed ef hg bi translated">Oracle云基础架构上的Windows自定义启动脚本和云初始化</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">我们很高兴宣布推出一种在Oracle上配置和定制Microsoft Windows Server计算实例的简单方法…</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">blogs.oracle.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx lq mj"/></div></div></a></div><div class="mg mh ez fb mi mj"><a rel="noopener follow" target="_blank" href="/oracledevs/managing-oracle-cloud-infrastructure-iscsi-block-volume-attachments-with-terraform-97726691b842"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hi fi z dy mo ea eb mp ed ef hg bi translated">使用Terraform管理Oracle云基础架构iSCSI数据块卷附件</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">将额外的块存储数据卷附加到实例是许多云部署的常见用例。这个…</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">medium.com</p></div></div><div class="ms l"><div class="my l mu mv mw ms mx lq mj"/></div></div></a></div><div class="mg mh ez fb mi mj"><a rel="noopener follow" target="_blank" href="/oracledevs/automating-instance-initialization-with-terraform-on-oracle-cloud-infrastructure-part-2-e1aa1a8710d"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hi fi z dy mo ea eb mp ed ef hg bi translated">在Oracle云基础设施上使用Terraform自动化实例初始化:第2部分</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">作为上一篇关于在Oracle计算云上使用Terraform自动化实例初始化的文章的后续…</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">medium.com</p></div></div></div></a></div></div></div>    
</body>
</html>