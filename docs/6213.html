<html>
<head>
<title>Open sourcing Singer, Pinterest’s performant and reliable logging agent</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开源歌手，Pinterest的高性能和可靠的日志代理</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/open-sourcing-singer-pinterests-performant-and-reliable-logging-agent-610fecf35566?source=collection_archive---------3-----------------------#2019-06-20">https://medium.com/pinterest-engineering/open-sourcing-singer-pinterests-performant-and-reliable-logging-agent-610fecf35566?source=collection_archive---------3-----------------------#2019-06-20</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="46a6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">杨宇|软件工程师，数据工程</p><p id="b2c3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Pinterest，我们使用数据来指导产品决策，并最终改善Pinner体验。在之前的一篇文章中，我们分享了Pinterest数据摄取框架的设计。数据接收和数据驱动的决策制定的第一步是数据收集。</p><p id="51a8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">乍一看，数据收集似乎很简单:只是将数据从主机上传到中央存储库。然而，为了从成千上万的主机上收集各种格式的数据，以低延迟的方式可靠、高效地大规模上传数据成为一个具有挑战性的问题。2014年，我们评估了可用的开源日志代理，没有找到符合我们需求的代理。作为一个解决方案，我们构建了一个名为“<em class="jd">歌手</em>的日志代理，它已经在Pinterest上生产了多年。Singer是我们数据基础设施的重要组成部分，现在每天传输超过1万亿条消息。今天，我们与开源社区分享Singer。你可以在<a class="ae jc" href="http://github.com/pinterest/singer" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到它的源代码和设计文档。</p><p id="8a6c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Singer支持以下功能:</p><ul class=""><li id="8789" class="je jf hh ig b ih ii il im ip jg it jh ix ji jb jj jk jl jm bi translated"><em class="jd">文本日志格式和节约日志格式现成的</em> : <a class="ae jc" href="https://github.com/pinterest/singer/blob/master/thrift-logger/src/main/thrift/singer_if.thrift#L9" rel="noopener ugc nofollow" target="_blank">节约</a>日志格式提供了更好的吞吐量和效率。我们在<a class="ae jc" href="https://github.com/pinterest/singer/tree/master/thrift-logger-python" rel="noopener ugc nofollow" target="_blank"> Python </a>和<a class="ae jc" href="https://github.com/pinterest/singer/tree/master/thrift-logger" rel="noopener ugc nofollow" target="_blank">Java</a>Singer repository中包含了thrift log客户端库。</li><li id="d823" class="je jf hh ig b ih jn il jo ip jp it jq ix jr jb jj jk jl jm bi translated"><em class="jd">至少一次消息传递</em> : Singer上传一批消息失败后会重试。对于每个日志流，Singer使用一个水印文件来跟踪其进度。当Singer重新启动时，它从水印位置开始处理消息。</li><li id="747e" class="je jf hh ig b ih jn il jo ip jp it jq ix jr jb jj jk jl jm bi translated"><em class="jd">支持在Kubernetes中作为边车服务登录:</em>在Kubernetes中作为daemonset登录，Singer可以从多个Kubernetes pods的日志目录中监视和上传负载。</li><li id="3fad" class="je jf hh ig b ih jn il jo ip jp it jq ix jr jb jj jk jl jm bi translated"><em class="jd">高吞吐量写入</em> : Singer使用分阶段事件驱动架构，能够以高吞吐量传输数千个日志流(节约日志为&gt; 100MB/s，文本日志为&gt; 40MB/s)</li><li id="8e5b" class="je jf hh ig b ih jn il jo ip jp it jq ix jr jb jj jk jl jm bi translated"><em class="jd">低延迟日志</em> : Singer支持可配置的处理延迟和批量大小，可以实现&lt; 5ms的日志上传延迟。</li><li id="febc" class="je jf hh ig b ih jn il jo ip jp it jq ix jr jb jj jk jl jm bi translated"><em class="jd">灵活的消息划分</em> : Singer提供多个划分器，支持可插拔划分器。我们还支持位置感知分区器，这可以避免跨可用性区域的生产者流量，并<a class="ae jc" rel="noopener" href="/@Pinterest_Engineering/optimizing-kafka-for-the-cloud-4e936643fde0">降低数据传输成本</a>。</li><li id="d844" class="je jf hh ig b ih jn il jo ip jp it jq ix jr jb jj jk jl jm bi translated"><em class="jd">监控</em> : Singer可以根据配置发送心跳消息到一个集中的消息队列。这允许用户大规模设置Singer实例的集中监控。</li><li id="43cf" class="je jf hh ig b ih jn il jo ip jp it jq ix jr jb jj jk jl jm bi translated"><em class="jd">可扩展设计</em> : Singer可以轻松扩展，支持数据上传到自定义目的地。</li></ul><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/1ee652523cfb07f9d05fe8b8373f1eba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Lr8BL_IbXwVRhu-k"/></div></div></figure><p id="b0f4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jd">图一。歌手内幕</em></p><p id="a5c6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">具体来说，服务将日志写入仅附加日志流。Singer根据配置监听文件系统事件。一旦检测到日志文件更改，Singer会处理日志流，并将数据发送到写入线程池进行上传。成功上传一批记录后，它会将logstream水印文件存储在磁盘上。当重新启动时，它还将处理来自水印位置的日志流。</p><p id="d2bc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Singer可以自动检测新添加的配置并处理相关的日志流。在Kubernetes环境中作为daemonset运行，Singer可以查询kubelet API来检测每个节点上的活动pod，并根据配置处理每个pod上的日志流。关于如何运行Singer，请看<a class="ae jc" href="https://github.com/pinterest/singer/tree/master/tutorial" rel="noopener ugc nofollow" target="_blank">教程</a>。</p><p id="fd3f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">开源不仅对Pinterest的工程师很重要，对YouTube、Google、Tinder、Snap等公司也很重要，这些公司使用我们的开源技术来支持应用持久化、图像下载等。参见<a class="ae jc" href="https://opensource.pinterest.com/" rel="noopener ugc nofollow" target="_blank">opensource.pinterest.com</a>和<a class="ae jc" href="https://github.com/pinterest" rel="noopener ugc nofollow" target="_blank"> GitHub </a>了解我们的开源项目。Pinterest engineering有许多有趣的问题需要解决，查看<a class="ae jc" href="https://careers.pinterest.com/careers" rel="noopener ugc nofollow" target="_blank">我们开放的工程角色并加入我们</a>！</p><p id="3705" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"/></p></div></div>    
</body>
</html>