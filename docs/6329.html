<html>
<head>
<title>Cost Reduction in Goku</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">降低悟空的成本</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/cost-reduction-in-goku-9bf09696e99e?source=collection_archive---------3-----------------------#2021-12-17">https://medium.com/pinterest-engineering/cost-reduction-in-goku-9bf09696e99e?source=collection_archive---------3-----------------------#2021-12-17</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="db94" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Monil Mukesh Sanghavi |实时分析团队软件工程师；</p><p id="0c7c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">张睿|实时分析团队软件工程师；</p><p id="5219" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">姜灏|实时分析团队软件工程师；</p><p id="fea8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">王淼|实时分析团队软件工程师；</p><p id="fed9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2018年，我们推出了<a class="ae jc" rel="noopener" href="/pinterest-engineering/goku-building-a-scalable-and-high-performant-time-series-database-system-a8ff5758a181"> Goku </a>，这是一个可扩展的高性能时间序列数据库系统，用作短期指标(不到一天)的存储和查询服务引擎。2020年初，我们推出了<a class="ae jc" rel="noopener" href="/pinterest-engineering/gokul-extending-time-series-data-storage-to-serve-beyond-one-day-52264307364d"> GokuL </a> (Goku long term)，通过支持长期指标数据(即超过一天且长达一年的数据)扩展了Goku的功能。这两个都完全取代了OpenTSDB。对于GokuL，我们使用了3个i3 . 4x大ssd支持的ec2实例集群，随着时间的推移，我们意识到这非常昂贵。降低这一成本是我们进入2021年的主要目标之一。这篇博文将讲述我们实现抱负的方法。</p><h1 id="1811" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">背景</h1><p id="ac00" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们使用分层方法来隔离长期数据，并将其以存储桶的形式存储。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kg"><img src="../Images/da7be82abf668d8679a990a5a52c45db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1TGaNhjSs_obsZ8sITXUiQ.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">Table 1: table of tiered approach</figcaption></figure><p id="ce20" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第1层到第5层包含存储在GokuL(长期)集群上的数据。GokuL使用RocksDB来存储其长期数据，数据以sst文件的形式接收。</p><h1 id="e9b6" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">查询分析</h1><p id="19f4" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们分析了发往长期集群的查询，并观察到以下情况:</p><ol class=""><li id="5747" class="kw kx hh ig b ih ii il im ip ky it kz ix la jb lb lc ld le bi translated">在总共10B个指标中，从GokuL查询的数据点时间超过三个月的指标非常少(大约6K)。</li><li id="4722" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb lb lc ld le bi translated">一半以上的GokuL查询指定了一天或一天以上的汇总间隔。</li></ol><h1 id="17be" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">第5层数据分析</h1><p id="48a0" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们在GokuL随机选择了一些碎片，并分析了数据。我们观察到第5层数据的内存消耗比所有其他层(1-4)的总和还要多。尽管第5层仅包含一小时的汇总数据，而其他层包含原始数据和15分钟的汇总数据。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es lk"><img src="../Images/3dda49e200586e577537e1602a531fd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AAEPKAJsv975kOgHSmfueA.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">Table 2: SST File size for each bucket in MiB</figcaption></figure><h1 id="619e" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">解决方法</h1><p id="c377" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">从查询和第5层分析中可以推断，第5层数据(包含六个存储桶，每个存储桶包含64天的数据)是查询最少的，也是消耗磁盘最多的。我们计划将我们的解决方案瞄准这一层，因为它将给我们带来最大的好处。下面是讨论过的一些解决方案。</p><h2 id="e891" class="ll je hh bd jf lm ln lo jj lp lq lr jn ip ls lt jr it lu lv jv ix lw lx jz ly bi translated">命名空间</h2><p id="1394" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">名为namespace的功能的实现将存储ttl、rollup interval之类的配置，以及该namespace之后的一组指标的层配置。<a class="ae jc" href="https://eng.uber.com/m3/" rel="noopener ugc nofollow" target="_blank">优步的M3 </a>也有类似的解决方案。这将有助于我们为选择集设置适当的配置(例如，为不需要更长保留时间的指标设置较低的ttl等)。这个项目的生产时间更长，因此我们决定将来把它作为一个单独的项目。这是一个正在积极进行的项目。</p><h2 id="9ddb" class="ll je hh bd jf lm ln lo jj lp lq lr jn ip ls lt jr it lu lv jv ix lw lx jz ly bi translated">第5层数据的累计间隔调整</h2><p id="08ac" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们尝试将第5层数据的累计间隔从一小时更改为一天，并观察了第5层存储桶的最终sst文件大小的变化。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es lz"><img src="../Images/69ec9139146d8780f04454dfe692ca42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KMJCMGS4jjqBrHOyc9C6mw.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">Table 3</figcaption></figure><p id="1326" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该解决方案带来的节约不足以支持将其投入生产。</p><h2 id="5203" class="ll je hh bd jf lm ln lo jj lp lq lr jn ip ls lt jr it lu lv jv ix lw lx jz ly bi translated">按需加载第5层数据</h2><p id="5c76" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">GokuL集群在启动时只存储第1层到第4层的数据，并在必要时加载第5层存储桶(基于查询)。这种解决方案的缺点是:</p><ul class=""><li id="7d45" class="kw kx hh ig b ih ii il im ip ky it kz ix la jb ma lc ld le bi translated">一旦GokuL主机接收到s3中相应的第5层存储桶，用户就必须等待并重试查询。</li><li id="c05d" class="kw kx hh ig b ih lf il lg ip lh it li ix lj jb ma lc ld le bi translated">一旦被接收，这个桶将一直留在GokuL中，除非被驱逐算法丢弃。</li></ul><p id="7f30" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们决定不采用这个解决方案，因为它对用户不友好。</p><h2 id="f2d5" class="ll je hh bd jf lm ln lo jj lp lq lr jn ip ls lt jr it lu lv jv ix lw lx jz ly bi translated">分层存储</h2><p id="55a9" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">我们决定将第5层数据移动到一个独立的基于硬盘的集群中。虽然在查询延迟方面观察到了一些显著的差异，但是可以忽略，因为命中该层的查询数量要少得多。我们计算出，GokuL集群中的650台主机中，第5层每台大约消耗1 TB。我们决定使用d2.2xlarge实例来存储和服务GokuL中的第5层数据。</p><figure class="kh ki kj kk fd kl er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es mb"><img src="../Images/9a6639606f102a857ad52dea12609a13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BweGpMdrA3sbM5KFHK_mUA.png"/></div></div><figcaption class="ks kt et er es ku kv bd b be z dx">Table 4</figcaption></figure><p id="6dde" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该解决方案带来的成本节约是巨大的。我们用111个d 2.2x大型实例替换了大约325个I 3.4x大型实例，成本大幅降低。通过这一改变，我们降低了近30–35%的成本。</p><p id="84e6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了支持这一点，我们必须在goku根集群中设计和实现基于层的路由，将查询路由到短期和长期叶集群。这是为我们节省大量成本的解决方案之一。</p><p id="a2dd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将来，我们可以评估是否可以减少副本的数量，并针对低数量的查询牺牲可用性。</p><h2 id="aeb8" class="ll je hh bd jf lm ln lo jj lp lq lr jn ip ls lt jr it lu lv jv ix lw lx jz ly bi translated">RocksDB调整</h2><p id="33f9" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">如上所述，GokuL使用RocksDB来存储长期数据。我们发现我们使用的RocksDB选项对于具有高容量和低QPS的悟空数据来说并不是最佳的。</p><p id="d070" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们尝试使用更强的压缩算法(ZSTD，级别5)，这将磁盘使用量减少了40%。除此之外，我们启用了分区索引过滤器，其中只有顶级索引被加载到内存中。除此之外，我们为过滤器和索引块启用了更高优先级的缓存，以便它们使用与数据块相同的缓存，同时最大限度地降低性能影响。</p><p id="4750" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过上述两项更改，我们注意到延迟差异并不大，数据空间使用量减少了大约50%。我们立即将其投入生产，并将GokuL集群的规模和成本缩减了一半。</p><h1 id="8101" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">下一步是什么</h1><h2 id="5261" class="ll je hh bd jf lm ln lo jj lp lq lr jn ip ls lt jr it lu lv jv ix lw lx jz ly bi translated">命名空间</h2><p id="9192" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">如前所述，我们正在积极实施命名空间功能，这将有助于我们进一步降低长期集群成本，方法是降低大多数不需要高保留率的当前指标的ttl。</p><h1 id="2818" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">承认</h1><p id="07b0" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">非常感谢布莱恩·奥弗斯特里特、朱未和观察小组提供并支持桌面上的解决方案。</p><p id="52ba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="mc">要在Pinterest了解更多工程知识，请查看我们的</em> <a class="ae jc" href="https://medium.com/pinterest-engineering" rel="noopener"> <em class="mc">工程博客</em> </a> <em class="mc">，并访问我们的</em><a class="ae jc" href="https://www.pinterestlabs.com/?utm_source=medium&amp;utm_medium=blog-article-post&amp;utm_campaign=samghavi-et-al-december-17-2021" rel="noopener ugc nofollow" target="_blank"><em class="mc">Pinterest Labs</em></a><em class="mc">网站。要查看和申请空缺职位，请访问我们的</em> <a class="ae jc" href="https://www.pinterestcareers.com/?utm_source=medium&amp;utm_medium=blog-article-post&amp;utm_campaign=samghavi-et-al-december-17-2021" rel="noopener ugc nofollow" target="_blank"> <em class="mc">职业</em> </a> <em class="mc">页面。</em></p></div></div>    
</body>
</html>