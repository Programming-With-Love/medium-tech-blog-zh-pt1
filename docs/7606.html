<html>
<head>
<title>Secure sensitive data in .NET 6.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">保护中的敏感数据。NET 6。</h1>
<blockquote>原文：<a href="https://medium.com/version-1/secure-sensitive-data-in-net-6-79c141d69015?source=collection_archive---------2-----------------------#2022-10-13">https://medium.com/version-1/secure-sensitive-data-in-net-6-79c141d69015?source=collection_archive---------2-----------------------#2022-10-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="6022" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作为开发人员，我们总是面临处理代码中敏感配置数据的挑战，比如连接字符串、应用程序机密、证书等。最佳实践建议不要在我们的源代码中存储这样的数据，我们必须找到一种方法来保护这些秘密，并在需要时使用它们。Azure提供密钥库服务，以高度安全的方式存储这些秘密。Key Vault为我们的秘密提供了一个保险库存储，因此敏感数据不需要硬编码在我们的代码库中。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/933afc677bbb64ea2cc6e65db72a1d62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SLEOx4wIOhDLMBbJ"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Photo by <a class="ae js" href="https://unsplash.com/@tjevans?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Tim Evans</a> on <a class="ae js" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="dffb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本文中，我们将演示如何在Web API在开发和生产环境中使用的密钥库的帮助下保护和检索连接字符串。可以使用类似的步骤来保护其他敏感数据。<br/>在本文中我们将使用以下:<br/> Visual Studio 2022 <br/>。NET Core Web API<br/>Azure Key Vault<br/>用户机密<br/> Azure Windows Web App <br/>如果你想跟进，你需要访问有效的Azure订阅。</p><p id="bb2b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第一步:在Azure上创建Azure密钥库</strong></p><p id="a16e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如何创建Azure Key Vault超出了本文的范围。我们假设，您已经有一个有效的Azure订阅和密钥库。</p><p id="9c19" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您需要创建密钥库的步骤，请遵循链接— <a class="ae js" href="https://learn.microsoft.com/en-us/azure/key-vault/general/quick-create-portal" rel="noopener ugc nofollow" target="_blank">创建密钥库</a>。</p><p id="f8bb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">步骤2:为Azure Web App启用托管身份</strong></p><p id="ef4d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们假设你有一个现有的Azure Web应用程序。如下图所示启用身份，以便web应用程序可以访问Azure Key Vault。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jt"><img src="../Images/ccf1bcdaea165ce310ff441caf60b5b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tsf-Fvzi0lCgrYZiCDztEw.png"/></div></div></figure><p id="5020" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请记下Azure Web应用的对象ID，稍后将使用它来分配对Azure key vault的权限。</p><p id="c30c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第三步:授予Azure密钥库权限</strong></p><p id="b5bd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下一步是为Azure Key Vault中的托管身份配置访问策略。这可以通过转到Azure Key Vault资源并在访问策略选项卡下，单击选项<strong class="ig hi">添加访问策略来实现。</strong></p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ju"><img src="../Images/d4b175578200bba9c0fee5bf6f7ae62f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J5EFlsgAbKkjVhifUxIgvg.png"/></div></div></figure><p id="9ff8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第四步:在Azure Key Vault中创建一个秘密</strong></p><p id="f88e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">点击设置下的秘密。在下图中，我们创建了一个名为“<strong class="ig hi">amoa-d b-connectionstring</strong>的秘密，并用实际的连接字符串设置了值。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ju"><img src="../Images/3fbbef62f7e62628c25cd411fb5deb40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VGvii6qHuojKw4Sjv2jEOA.png"/></div></div></figure><p id="31aa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，我们准备从我们的应用程序中访问秘密。</p><p id="22cc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第五步:</strong> <strong class="ig hi">获取套餐</strong></p><p id="a998" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">创建一个标准的Asp。Net核心web API定位。NET 6，你需要安装以下软件包来使用Azure Key Vault: <br/> Azure。身份<br/>蔚蓝。微软。扩展. Configuration.AzureKeyVault</p><p id="e49b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第六步:保护不同环境中的数据</strong></p><p id="8abf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在让我们看看，如何在不同的环境中获取秘密。</p><p id="41df" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">开发:</strong></p><p id="f8ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从开发环境访问azure上的密钥库需要应用程序注册</p><p id="d179" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">按照<a class="ae js" href="https://learn.microsoft.com/en-us/power-apps/developer/data-platform/walkthrough-register-app-azure-active-directory" rel="noopener ugc nofollow" target="_blank">链接</a>中的步骤完成应用注册，并记下客户端Id和客户端密码值。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ju"><img src="../Images/4ac2a28c287c2280305cf5a5f376cf2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S8rfLg3-MLZ2Vpo6kLAYwQ.png"/></div></div></figure><p id="fed7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为API / Web app项目创建secret.json文件，如下所示，</p><p id="1032" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">右键单击项目并选择管理用户机密选项，如下所示:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jv"><img src="../Images/f64e4bb65cf3509c79d025df83c7334f.png" data-original-src="https://miro.medium.com/v2/resize:fit:812/format:webp/1*1NLXiNenjbL0Yr8d8uA_bA.png"/></div></figure><p id="c053" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在下面添加与secret.json中的密钥库相对应的密钥值，这是从密钥库中检索值所必需的。</p><p id="4dd0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">kvUrl:密钥库Url</p><p id="ec8e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">tenantId:订阅租户Id</p><p id="8654" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">clientId:在您的应用程序注册完成后收到的Id。</p><p id="9c07" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">ClientSecret:使用在应用程序注册中创建的秘密。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jw"><img src="../Images/ae6e46b8ebba59f2aa4f66fe63089a20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*85vaM0w-16C3OeMHUC2h0A.png"/></div></div></figure><p id="f2f8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">利用<strong class="ig hi"> SecretClient </strong>从密钥库中读取秘密值。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ju"><img src="../Images/6018752239d293fdc5987ae4a4ff31d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tvxtx9kQXMCrQYZ48IhcJA.png"/></div></div></figure><p id="0f58" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">密钥库中存在的连接字符串"<strong class="ig hi"> amoa-db-connectionstring </strong>"将被添加到配置中。</p><p id="c153" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过以上更改，无需在appSettings中存储连接字符串。Json文件。</p><p id="a69a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">制作:</strong></p><p id="3ba8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于生产环境，使用密钥库引用实用程序从密钥库读取值。</p><p id="aa64" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在app service的配置中创建一个Key，如下所示:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ju"><img src="../Images/33be5ef582d3d76bbd3e06ec77b147c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mh_C0A6aoxkrmLT6l73C5g.png"/></div></div></figure><p id="57f9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">参考如下所示的密钥库:</p><p id="1bd6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">@微软。KeyVault(SecretUri= &lt;秘密标识符&gt; ) </strong></p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ju"><img src="../Images/d0abda757eb1523c6bfaf7a70ec90c24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ai6phQezrMa_yGsxRTOTNA.png"/></div></div></figure><p id="a555" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">配置中的密钥如下所示:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ju"><img src="../Images/34bb4a9cadaf86f2cd6dc41cbe1d5dba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KPsIkXuYhtQs07fAj1SgEw.png"/></div></div></figure><p id="490d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过遵守上述存储敏感数据的方法，我们可以保护数据不被暴露和滥用。希望这篇文章的内容对你有所帮助。</p><p id="0dc2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">关于作者:</strong> <br/> Praveen Desai是这里1版的. Net开发者。</p></div></div>    
</body>
</html>