<html>
<head>
<title>Setup Prometheus and Grafana monitoring on Kubernetes cluster using Helm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Helm在Kubernetes集群上设置Prometheus和Grafana监控</h1>
<blockquote>原文：<a href="https://medium.com/globant/setup-prometheus-and-grafana-monitoring-on-kubernetes-cluster-using-helm-3484efd85891?source=collection_archive---------0-----------------------#2022-09-07">https://medium.com/globant/setup-prometheus-and-grafana-monitoring-on-kubernetes-cluster-using-helm-3484efd85891?source=collection_archive---------0-----------------------#2022-09-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="er es ie"><img src="../Images/26bbebe171152f0862b867b136791169.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*p3YcEQ3bMezMe956"/></div></figure><p id="2003" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">在本文中，我们将讨论Prometheus和Grafana，以及如何使用Helm charts为任何Kubernetes集群设置监控。我们还将学习如何将Prometheus和Grafana连接在一起，并在Grafana上设置一个基本的仪表板来监控Kubernetes集群上的资源。</p><p id="4540" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">该文章包含以下部分:</p><ul class=""><li id="31d1" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">介绍</li><li id="4460" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">先决条件</li><li id="5c56" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">普罗米修斯建筑</li><li id="7337" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">舵部署优于手动部署的优势</li><li id="2512" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">安装舵</li><li id="cc12" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">安装普罗米修斯和格拉夫纳</li><li id="0bfc" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">将prometheus数据源添加到Grafana仪表板中</li><li id="b46b" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">结论</li><li id="6396" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">参考</li></ul><p id="ecde" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">简介</strong></p><p id="797d" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">普罗米修斯和格拉夫纳一起工作，以提供监测。Prometheus将数据获取作为数据源，并将该数据输入Grafana，Grafana可用于可视化具有吸引力的仪表板的数据。</p><p id="c40e" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">关于普罗米修斯</p><ul class=""><li id="5cd3" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">Prometheus是一个开源系统监控和警报工具包。</li><li id="b66c" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">Prometheus收集并存储作为时间序列数据的指标。</li><li id="752c" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">它为Kubernetes等容器编排平台提供了开箱即用的监控功能。</li></ul><p id="835f" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">关于格拉夫纳</p><ul class=""><li id="8c3a" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">Grafana是一个多平台开源分析和交互式可视化web应用程序。</li><li id="7a3e" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">当连接到支持的数据服务时，它为web提供图表、图形和警报。</li><li id="cf52" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">Grafana允许我们查询、可视化、提醒和理解我们的指标，无论它们存储在哪里。除了Prometheus之外，一些受支持的数据源还有AWS CloudWatch、AzureMonitor、PostgreSQL、Elasticsearch等等。</li><li id="4ccc" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">我们可以创建自己的仪表板或使用Grafana提供的现有仪表板。我们可以根据自己的需求个性化仪表盘。</li></ul><p id="dc6d" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">关于头盔</p><ul class=""><li id="3274" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">Helm是Kubernetes的包装经理。</li><li id="5e98" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">它允许我们简化Kubernetes应用程序的安装和管理。</li><li id="93af" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">Helms使用一种叫做Charts的打包格式，它基本上是yaml清单文件的集合。</li></ul><p id="d64e" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">先决条件</strong></p><ul class=""><li id="6138" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">用户必须具备Kubernetes的基本知识。</li><li id="555b" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">在我们可以设置的地方应该有一个Kubernetes集群。普罗米修斯和格拉夫纳。在本文中，我们使用minikube创建了一个新的Kubernetes集群。Minikube可用于在Windows、macOS或Linux上建立本地Kubernetes集群。</li></ul><p id="027b" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">普罗米修斯建筑</strong></p><p id="77fa" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">此图展示了普罗米修斯的架构及其生态系统组件:</p><figure class="jy jz ka kb fd ii er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es jx"><img src="../Images/a541fcd8525a6695f7c31e77a4cbd0ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KksRZeEmoxs2tmAl"/></div></div></figure><p id="08e7" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">普罗米修斯服务器:</strong>存储和抓取时间序列数据的主服务器。</p><p id="9a32" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi"> TSDB(时间序列数据库):</strong>指标是任何系统了解其健康和运行状态的关键方面。任何系统的设计都需要收集、存储和报告指标，以提供系统的脉动。数据存储在一系列时间间隔内，需要一个高效的数据库来存储和检索这些数据。<a class="ae kg" href="http://opentsdb.net/overview.html" rel="noopener ugc nofollow" target="_blank"> OpenTSDB时间序列数据库</a>就是这样一个可以满足这种需求的时间序列数据库。</p><p id="1dac" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi"> PromQL: </strong> Prometheus以PromQL的形式定义了一种丰富的查询语言，从时间序列数据库中查询数据。</p><p id="f2cc" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi"> Pushgateway: </strong>可用于支持短期作业。</p><p id="bfb6" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">导出器:</strong>它们用于将指标数据提升到prometheus服务器。</p><p id="a371" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi"> Alertmanager: </strong>用于向slack、email等各种通信渠道发送通知，通知用户。</p><p id="bfad" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">Helm图表相对于手动Kubernetes部署的优势</strong></p><ul class=""><li id="bf6e" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">没有Helm for Kubernetes，我们依靠Kubernetes YAML文件来配置Kubernetes工作负载。这些YAML文件指定了部署容器所需的一切。从每个Pod需要配置的方式到Kubernetes集群如何实现负载平衡，一切都必须在这些YAML文件中提及。因此，要设置一个新的Kubernetes工作负载，我们需要为该工作负载创建一个YAML文件。手动执行意味着编写多个YAML文件——为我们创建的每个工作负载编写一个。工作负载可以是部署、服务、配置图、机密和配置文件。</li><li id="0348" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">使用Helm for Kubernetes，我们可以下载现有的Helm图表，这些图表已经提供了清单文件，而不必手动为每个应用程序编写单独的YAML文件。以下几点强调了Helm相对于手动部署的优势。</li><li id="1241" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">Helm charts包含各种Kubernetes资源的模板，这些资源组合在一起形成一个应用程序。</li><li id="1922" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">在不同的Kubernetes集群上部署Helm图表时，可以对其进行模板化。舵图的创建方式是将特定于环境或部署的配置提取到单独的文件中，以便在部署舵图时指定这些值。例如，在开发、试运行和生产环境中部署应用程序时，我们不需要单独的图表。</li><li id="e6ef" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">除此之外，Helm还提供了存储库支持，其中图表可用于Prometheus和Grafana等流行工具，这些工具可直接用于设置pod。</li></ul><p id="ce29" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">安装舵</strong></p><p id="ec87" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Helm项目提供二进制文件和脚本来获取和安装Helm。这些是官方释放头盔的方法。除此之外，Helm社区还提供了通过不同的包管理器安装Helm的方法。通过这些方法的安装可以在helm的官方网站(<a class="ae kg" href="https://helm.sh/docs/intro/install/" rel="noopener ugc nofollow" target="_blank">https://helm.sh/docs/intro/install/</a>)找到。我们已经在下面提到的步骤中介绍了二进制安装。</p><ul class=""><li id="01af" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">基于操作系统从Helm的GitHub库下载所需版本。在本例中，我们使用了Windows操作系统。</li><li id="1231" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">解压缩下载的文件(helm-v 3 . 9 . 0-RC . 1-windows-amd64 . zip)并将helm二进制文件复制到任何文件夹中，然后在环境path变量中添加文件夹路径。一旦完成，我们就可以使用头盔了。</li></ul><p id="04ff" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">安装普罗米修斯和格拉夫纳</strong></p><ul class=""><li id="ddf1" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">去下面回购，【https://artifacthub.io/】。</li><li id="e22b" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">使用以下命令在helm repo中查找Prometheus和Grafana的官方图表以及存储库:</li></ul><p id="4ffa" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><em class="kh">掌舵回购添加普罗米修斯社区</em><a class="ae kg" href="https://prometheus-community.github.io/helm-charts" rel="noopener ugc nofollow" target="_blank"><em class="kh">https://prometheus-community.github.io/helm-charts</em></a></p><p id="421d" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><em class="kh">赫尔姆回购加格拉夫纳</em><a class="ae kg" href="https://grafana.github.io/helm-charts" rel="noopener ugc nofollow" target="_blank"><em class="kh">https://grafana.github.io/helm-charts</em></a></p><p id="5a2f" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><em class="kh">掌舵回购更新</em></p><ul class=""><li id="6df6" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">接下来，我们需要使用以下命令安装Prometheus:</li></ul><p id="2aa8" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><em class="kh">掌舵安装普罗米修斯-社区普罗米修斯/普罗米修斯</em></p><ul class=""><li id="2b78" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">它将通过一个简单的命令安装普罗米修斯系统所有需要的组件。如果没有舵图，我们将不得不自己编写清单文件。</li></ul><figure class="jy jz ka kb fd ii er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es ki"><img src="../Images/05fd027d39fe4a135495a480e8ed0496.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nmXM7s_Ck49uupRW"/></div></div></figure><ul class=""><li id="2769" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">我们可以使用nodeport将prometheus-server服务公开给internet，但是prometheus提供的GUI不如Grafana提供的好。同样，我们可以使用以下命令:</li></ul><p id="9bad" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><em class="kh"> kubectl公开服务Prometheus-server—type = node port—target-port = 9090—name = Prometheus-server-ext</em></p><p id="6b8d" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><em class="kh">minikube service Prometheus-server-ext</em></p><ul class=""><li id="51a2" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">我们可以使用以下命令安装Grafana:</li></ul><p id="5562" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><em class="kh">舵安装grafana grafana/grafana </em></p><ul class=""><li id="826a" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">它将在Grafana的集群上创建以下组件:</li></ul><figure class="jy jz ka kb fd ii er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kj"><img src="../Images/89154fee379a7e8f421681b307825100.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2FFxFH86p4deiiG8"/></div></div></figure><ul class=""><li id="e5a1" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">我们可以使用以下命令向外界公开Grafana服务:</li></ul><p id="3d16" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><em class="kh"> kubectl公开服务grafana—type = node port—target-port = 3000—name = grafana-ext</em></p><p id="98cb" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><em class="kh">minikube service graf ana-ext</em></p><ul class=""><li id="2919" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">我们可以使用以下命令找到登录Grafana所需的用户名和密码。它将以加密格式显示值，我们可以使用OpenSSL和base 64格式对其进行解码。</li></ul><p id="e5ec" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><em class="kh"> kubectl get secret —名称空间默认grafana -o yaml </em></p><p id="623b" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><em class="kh">echo " password _ value " | OpenSSL base64-d；回声</em></p><p id="7555" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><em class="kh"> echo“用户名_值”| OpenSSL base64-d；回声</em></p><p id="c353" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">将prometheus数据源添加到Grafana仪表板中</strong></p><ul class=""><li id="6b48" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">使用上一步生成的管理员用户和密码登录Grafana仪表板。</li><li id="bb0a" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated">在add data source部分，提供安装后为prometheus-server-ext生成的服务URL，并保存它。</li></ul><figure class="jy jz ka kb fd ii er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kk"><img src="../Images/c6739c579da94a62c65c9f9c06cfc606.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UCddOL2d2ZJ8mNkc"/></div></div></figure><ul class=""><li id="9d4c" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">接下来，我们需要创建一个新的仪表板。我们既可以从头开始创建仪表板，也可以导入grafana.com Prometheus上可用的仪表板。为了简化本文，我们使用grafana.com上编号为“3662”的仪表板。添加仪表板编号并点击加载。</li></ul><figure class="jy jz ka kb fd ii er es paragraph-image"><div class="er es kl"><img src="../Images/10dba1de3329e0995de5ada258b3ab5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/0*Li8Uy11MzM2M-ElL"/></div></figure><ul class=""><li id="b2a7" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">在下一个屏幕上，为这个仪表板添加数据源，在我们的例子中是Prometheus，然后点击import。</li></ul><figure class="jy jz ka kb fd ii er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es km"><img src="../Images/bc2033f2220fcc1e36db300b115d3849.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UfQkrp7UWQ2MkfYv"/></div></div></figure><ul class=""><li id="c6cc" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated">我们将有一个漂亮的仪表板为我们准备，我们可以根据我们的要求修改。</li></ul><figure class="jy jz ka kb fd ii er es paragraph-image"><div role="button" tabindex="0" class="kc kd di ke bf kf"><div class="er es kn"><img src="../Images/cf0adf5d610d20073c74d0d538e30b96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5prXyDHjwVF_6MUJ"/></div></div></figure><p id="f587" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">结论</strong></p><p id="8a04" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">我们可以看到，与通过Kubernetes yaml文件进行的手动部署相比，通过使用helm charts，可以毫不费力地在Kubernetes集群上设置Prometheus和Grafana监控。</p><p id="2fe0" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><strong class="in hi">参考文献</strong>:</p><ul class=""><li id="96ac" class="jj jk hh in b io ip is it iw jl ja jm je jn ji jo jp jq jr bi translated"><a class="ae kg" href="https://www.thetips4you.com/" rel="noopener ugc nofollow" target="_blank">https://www.thetips4you.com/</a></li><li id="2dd6" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated"><a class="ae kg" href="https://phoenixnap.com/kb/prometheus-grafana" rel="noopener ugc nofollow" target="_blank">https://phoenixnap.com/kb/prometheus-grafana</a></li><li id="5399" class="jj jk hh in b io js is jt iw ju ja jv je jw ji jo jp jq jr bi translated"><a class="ae kg" href="https://github.com/helm/helm/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/helm/helm/releases</a></li></ul></div></div>    
</body>
</html>