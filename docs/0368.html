<html>
<head>
<title>Using multiple camera streams simultaneously</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">同时使用多个摄像机流</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/using-multiple-camera-streams-simultaneously-bf9488a29482?source=collection_archive---------1-----------------------#2018-10-11">https://medium.com/androiddevelopers/using-multiple-camera-streams-simultaneously-bf9488a29482?source=collection_archive---------1-----------------------#2018-10-11</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="cc77" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这篇博文是当前关于安卓相机系列的最新一篇；我们之前已经介绍过<a class="ae jc" rel="noopener" href="/androiddevelopers/camera-enumeration-on-android-9a053b910cb5">摄像机枚举</a>和<a class="ae jc" rel="noopener" href="/androiddevelopers/understanding-android-camera-capture-sessions-and-requests-4e54d9150295">摄像机捕获会话和请求</a>。</p><h1 id="cb82" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">多个摄像机流的用例</h1><p id="44c0" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">一个相机应用程序可能希望同时使用多个帧流，在某些情况下，不同的帧流甚至需要不同的帧分辨率或像素格式；一些典型的使用案例包括:</p><ul class=""><li id="2438" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb kl km kn ko bi translated">视频录制:一个流用于预览，另一个流被编码并保存到文件中</li><li id="0a60" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">条形码扫描:一个用于预览，另一个用于条形码检测</li><li id="dc4a" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb kl km kn ko bi translated">计算摄影:一个流用于预览，另一个流用于人脸/场景检测</li></ul><p id="237a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正如我们在<a class="ae jc" rel="noopener" href="/androiddevelopers/understanding-android-camera-capture-sessions-and-requests-4e54d9150295">之前的博客文章</a>中所讨论的，当我们处理帧时，有一个不小的性能成本，当进行并行流/管道处理时，这个成本会成倍增加。</p><p id="80cc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">像CPU、GPU和DSP这样的资源也许能够利用框架的<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/CameraDevice#createReprocessCaptureRequest(android.hardware.camera2.TotalCaptureResult)" rel="noopener ugc nofollow" target="_blank">再处理</a>能力，但是像内存这样的资源将会线性增长。</p><h1 id="4d0b" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">每个请求多个目标</h1><p id="a20f" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">通过执行某种官僚程序，多个摄像机流可以合并成一个<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/CaptureRequest" rel="noopener ugc nofollow" target="_blank"> CameraCaptureRequest </a>。此代码片段说明了如何设置相机会话，其中一个流用于相机预览，另一个流用于图像处理:</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="d599" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您正确地配置了目标表面，该代码将只产生满足由<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/params/StreamConfigurationMap#getOutputMinFrameDuration(int,%20android.util.Size)" rel="noopener ugc nofollow" target="_blank"> StreamComfigurationMap确定的最小FPS的流。GetOutputMinFrameDuration(int，Size) </a>和<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/params/StreamConfigurationMap.html#getOutputStallDuration(int,%20android.util.Size)" rel="noopener ugc nofollow" target="_blank"> StreamComfigurationMap。GetOutputStallDuration(int，Size) </a>。实际性能会因设备而异，尽管Android为我们提供了一些支持特定组合的保证，这取决于三个变量:<strong class="ig hi">输出类型</strong>、<strong class="ig hi">输出大小</strong>和<strong class="ig hi">硬件级别</strong>。使用不支持的参数组合可能会在低帧速率下工作；或者它可能根本不工作，触发一个失败回调。<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/CameraDevice#createCaptureSession(java.util.List%3Candroid.view.Surface%3E,%20android.hardware.camera2.CameraCaptureSession.StateCallback,%20android.os.Handler)" rel="noopener ugc nofollow" target="_blank">文档</a>非常详细地描述了保证工作的内容，强烈建议完整阅读，但我们将在此介绍基本内容。</p><h1 id="cdd4" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">输出类型</h1><p id="8bfd" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated"><strong class="ig hi">输出类型</strong>指帧编码的格式。文档中描述的可能值有PRIV、YUV、JPEG和RAW。文档最好地解释了它们:</p><blockquote class="lb lc ld"><p id="026b" class="ie if le ig b ih ii ij ik il im in io lf iq ir is lg iu iv iw lh iy iz ja jb ha bi translated">PRIV是指使用<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/params/StreamConfigurationMap#getOutputSizes(java.lang.Class%3CT%3E)" rel="noopener ugc nofollow" target="_blank">streamconfigurationmap . get output size(Class)</a>找到其可用大小的任何目标，没有直接的应用程序可见格式</p><p id="e17f" class="ie if le ig b ih ii ij ik il im in io lf iq ir is lg iu iv iw lh iy iz ja jb ha bi translated">YUV是指使用<a class="ae jc" href="https://developer.android.com/reference/android/graphics/ImageFormat#YUV_420_888" rel="noopener ugc nofollow" target="_blank">图像格式的目标表面。YUV_420_888 </a>格式</p><p id="5e8a" class="ie if le ig b ih ii ij ik il im in io lf iq ir is lg iu iv iw lh iy iz ja jb ha bi translated">JPEG是指<a class="ae jc" href="https://developer.android.com/reference/android/graphics/ImageFormat#JPEG" rel="noopener ugc nofollow" target="_blank">ImageFormat.JPEG</a>格式</p><p id="1da0" class="ie if le ig b ih ii ij ik il im in io lf iq ir is lg iu iv iw lh iy iz ja jb ha bi translated">RAW是指<a class="ae jc" href="https://developer.android.com/reference/android/graphics/ImageFormat#RAW_SENSOR" rel="noopener ugc nofollow" target="_blank"> ImageFormat。RAW_SENSOR </a>格式。</p></blockquote><p id="d402" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当选择应用程序的输出类型时，如果目标是最大化兼容性，那么推荐使用<a class="ae jc" href="https://developer.android.com/reference/android/graphics/ImageFormat#YUV_420_888" rel="noopener ugc nofollow" target="_blank"> ImageFormat。YUV_420_888 </a>用于帧分析，而<a class="ae jc" href="https://developer.android.com/reference/android/graphics/ImageFormat#JPEG" rel="noopener ugc nofollow" target="_blank">ImageFormat.JPEG</a>用于静止图像。对于预览和录制场景，您可能会使用<code class="du li lj lk ll b">SurfaceView</code>、<code class="du li lj lk ll b">TextureView</code>、<code class="du li lj lk ll b">MediaRecorder</code>、<code class="du li lj lk ll b">MediaCodec</code>或<code class="du li lj lk ll b">RenderScript.Allocation</code>。在这些情况下，不要指定图像格式，出于兼容性目的，它将被计为<a class="ae jc" href="https://developer.android.com/reference/android/graphics/ImageFormat#PRIVATE" rel="noopener ugc nofollow" target="_blank"> ImageFormat。私有</a>(不考虑引擎盖下实际使用的格式)。给定设备的<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/CameraCharacteristics" rel="noopener ugc nofollow" target="_blank"> CameraCharacteristics </a>，使用以下代码查询设备支持的格式:</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="kz la l"/></div></figure><h1 id="ceb3" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">输出大小</h1><p id="942a" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">当我们调用<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/params/StreamConfigurationMap.html#getOutputSizes(int)" rel="noopener ugc nofollow" target="_blank">streamconfigurationmap . getoutputsizes()</a>时，所有可用的<strong class="ig hi">输出大小</strong>都被列出，但是就兼容性而言，我们只需要担心其中的两个:预览和最大值。我们可以把这些尺寸看作上限。如果文档中说预览大小可以工作，那么任何小于预览大小的都可以工作。同样适用于最大值。以下是来自<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/CameraDevice" rel="noopener ugc nofollow" target="_blank">文档</a>的相关摘录:</p><blockquote class="lb lc ld"><p id="0922" class="ie if le ig b ih ii ij ik il im in io lf iq ir is lg iu iv iw lh iy iz ja jb ha bi translated">对于最大尺寸栏，预览是指与设备屏幕分辨率或1080p (1920x1080)最匹配的尺寸，以较小者为准。录制是指摄像设备支持的最大录制分辨率，由<a class="ae jc" href="https://developer.android.com/reference/android/media/CamcorderProfile.html" rel="noopener ugc nofollow" target="_blank">摄像机配置文件</a>决定。最大值是指来自<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/params/StreamConfigurationMap.html#getOutputSizes(int)" rel="noopener ugc nofollow" target="_blank">streamconfigurationmap . getoutputsizes(int)</a>的该格式或目标的摄像设备的最大输出分辨率。</p></blockquote><p id="f094" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，可用的输出大小取决于格式的选择。给定<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/CameraCharacteristics" rel="noopener ugc nofollow" target="_blank"> CameraCharacteristics </a>和一种格式，我们可以像这样查询可用的输出大小:</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="84ce" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在相机预览和录制用例中，我们应该使用目标类来确定支持的大小，因为格式将由相机框架本身来处理:</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="cc29" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">获取最大尺寸很容易，只需按区域对输出尺寸进行排序并返回最大的尺寸:</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="008f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">获取预览大小需要更多的思考。回想一下，预览指的是与设备屏幕分辨率或1080p (1920x1080)匹配的最佳尺寸，以较小者为准。请记住，长宽比可能不完全匹配屏幕的长宽比，所以如果我们计划以全屏模式显示它，我们可能需要对流应用字母框或裁剪。为了获得正确的预览尺寸，我们需要将可用的输出尺寸与显示器尺寸进行比较，同时考虑到显示器可能会旋转。在这段代码中，我们还定义了一个助手类<code class="du li lj lk ll b">SmartSize</code>,它将使大小比较变得稍微容易一些:</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="kz la l"/></div></figure><h1 id="8ff4" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">硬件级别</h1><p id="9278" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">为了确定运行时的可用能力，相机应用程序需要的最重要的信息是支持的<strong class="ig hi">硬件级别</strong>。再一次，我们可以依靠文档向我们解释这一点:</p><blockquote class="lb lc ld"><p id="78f5" class="ie if le ig b ih ii ij ik il im in io lf iq ir is lg iu iv iw lh iy iz ja jb ha bi translated">支持的硬件级别是对相机设备功能的高级描述，将多种功能总结到一个字段中。每个级别都在前一个级别的基础上增加了额外的功能，并且总是前一个级别的严格超集。排序是传统的&lt; LIMITED &lt; FULL &lt; LEVEL_3.</p></blockquote><p id="32c0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">With a <a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/CameraCharacteristics" rel="noopener ugc nofollow" target="_blank"> CameraCharacteristics </a>对象，我们可以用一条语句检索硬件级别:</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="kz la l"/></div></figure><h1 id="b21a" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">把所有的碎片放在一起</h1><p id="75d6" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">一旦我们了解了输出类型、输出大小和硬件级别，我们就可以确定哪些流组合是有效的。例如，这里有一个由具有<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/CameraMetadata#INFO_SUPPORTED_HARDWARE_LEVEL_LEGACY" rel="noopener ugc nofollow" target="_blank">传统</a>硬件级别的<code class="du li lj lk ll b">CameraDevice</code>支持的配置的快照。快照取自<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/CameraDevice.html#createCaptureSession(android.hardware.camera2.params.SessionConfiguration)" rel="noopener ugc nofollow" target="_blank"> createCaptureSession </a>方法的文档:</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lm"><img src="../Images/3b8c5d7e1cba6e92d4baa3398c0fe5b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GsDVSq0sGzP-p1ou"/></div></div></figure><p id="7a3a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于LEGACY是可能的最低硬件级别，我们可以从上表中推断出，使用正确的配置，每个支持Camera2(即API级别21及以上)的设备都可以同时输出多达三个流，这非常酷！然而，在许多设备上可能无法实现最大的可用吞吐量，因为您自己的代码可能会产生开销，从而引发其他限制性能的约束，如内存、CPU甚至散热。</p><p id="8846" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在我们已经了解了在框架的支持下设置两个同步流的必要知识，我们可以更深入地研究目标输出缓冲区的配置。例如，如果我们的目标是一个具有<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/CameraMetadata#INFO_SUPPORTED_HARDWARE_LEVEL_LEGACY" rel="noopener ugc nofollow" target="_blank">传统</a>硬件级别的设备，我们可以设置两个目标输出表面:一个使用<a class="ae jc" href="https://developer.android.com/reference/android/graphics/ImageFormat#PRIVATE" rel="noopener ugc nofollow" target="_blank"> ImageFormat。私有</a>和另一个使用<a class="ae jc" href="https://developer.android.com/reference/android/graphics/ImageFormat#YUV_420_888" rel="noopener ugc nofollow" target="_blank">图像格式。YUV_420_888 </a>。根据上表，只要我们使用预览大小，这应该是一个受支持的组合。使用上面定义的函数，获得相机ID所需的预览大小现在非常简单:</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="5a8f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们必须等到<code class="du li lj lk ll b">SurfaceView</code>准备好使用提供的回调，就像这样:</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="eca2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们甚至可以通过调用<a class="ae jc" href="https://developer.android.com/reference/android/view/SurfaceHolder#setFixedSize(int,%20int)" rel="noopener ugc nofollow" target="_blank">surface holder . setfixedsize()</a>来强制<code class="du li lj lk ll b">SurfaceView</code>匹配相机输出大小，但就UI而言，采用类似于GitHub 上的<a class="ae jc" href="https://github.com/googlesamples/android-HdrViewfinder" rel="noopener ugc nofollow" target="_blank"> HDR取景器示例中的</a><a class="ae jc" href="https://github.com/googlesamples/android-HdrViewfinder/blob/9cd7531ea34b4515b3f300a354149dded9d99332/Application/src/main/java/com/example/android/hdrviewfinder/FixedAspectSurfaceView.java" rel="noopener ugc nofollow" target="_blank"> FixedAspectSurfaceView </a>的方法可能会更好，它会考虑纵横比和可用空间来设置绝对大小，同时在触发活动变化时自动调整。</p><p id="1766" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">用期望的格式设置来自<code class="du li lj lk ll b">ImageReader</code>的另一个表面甚至更容易，因为不需要等待回调:</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="400c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当使用像<code class="du li lj lk ll b">ImageReader</code>这样的阻塞目标缓冲器时，我们需要在使用完帧后将其丢弃:</p><figure class="ku kv kw kx fd ky"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="07ef" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们应该记住，我们的目标是最小公分母——具有传统硬件水平的设备。我们可以添加条件分支，并在具有有限硬件级别的设备中为输出目标表面之一使用记录大小，或者甚至为具有完整硬件级别的设备将其提升到最大大小。</p><h1 id="5365" class="jd je hh bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">摘要</h1><p id="bbf6" class="pw-post-body-paragraph ie if hh ig b ih kb ij ik il kc in io ip kd ir is it ke iv iw ix kf iz ja jb ha bi translated">在本文中，我们介绍了:</p><ol class=""><li id="ef67" class="kg kh hh ig b ih ii il im ip ki it kj ix kk jb lt km kn ko bi translated">使用单个相机设备同时输出多个流</li><li id="2e30" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb lt km kn ko bi translated">在单个捕获请求中组合不同目标的规则</li><li id="6b4e" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb lt km kn ko bi translated">查询和选择适当的输出类型、输出大小和硬件级别</li><li id="cbea" class="kg kh hh ig b ih kp il kq ip kr it ks ix kt jb lt km kn ko bi translated">设置和使用由<code class="du li lj lk ll b">SurfaceView</code>和<code class="du li lj lk ll b">ImageReader</code>提供的<code class="du li lj lk ll b">Surface</code></li></ol><p id="80c2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有了这些知识，现在我们可以创建一个相机应用程序，它能够显示预览流，同时对单独的流中的传入帧进行异步分析。</p></div></div>    
</body>
</html>