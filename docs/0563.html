<html>
<head>
<title>Android Emulator in a CI environment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CI环境中的Android模拟器</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/android-emulator-in-a-ci-environment-dd65f63cdcd?source=collection_archive---------0-----------------------#2020-10-01">https://medium.com/androiddevelopers/android-emulator-in-a-ci-environment-dd65f63cdcd?source=collection_archive---------0-----------------------#2020-10-01</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/ec7e6210812f01b617e8ef69db39a9f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yAWafZw5htC_WLI0hskj-g.png"/></div></div></figure><div class=""/><div class=""><h2 id="53fd" class="pw-subtitle-paragraph ip hr hs bd b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg dx translated">了解如何创建Docker映像并远程访问调试信息</h2></div><p id="8e4e" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">能够在一个持续集成的环境中对你的Android应用程序进行测试，在确保你的产品质量方面向前迈进了一大步。然而，创建一个映像来为您的持续集成机器重新创建一个一致的环境可能是一个挑战。作为应对这一挑战的第一步，您可以使用预构建的容器或脚本来构建Linux的Docker映像。在这篇文章中，我将解释如何使用预构建的容器和脚本做什么。</p><h1 id="32de" class="kd ke hs bd kf kg kh ki kj kk kl km kn iy ko iz kp jb kq jc kr je ks jf kt ku bi translated">Android模拟器Docker预构建</h1><p id="84e4" class="pw-post-body-paragraph jh ji hs jj b jk kv it jm jn kw iw jp jq kx js jt ju ky jw jx jy kz ka kb kc ha bi translated">借助我们预先构建的Android模拟器容器，在持续集成(CI)或持续部署(CD)环境中设置和运行Android模拟器变得前所未有的简单。这些容器使您能够找到并运行模拟器的正确版本，而没有令人头痛的依赖管理。这些容器还使得将自动化测试作为CI或CD系统的一部分进行扩展变得容易，而没有物理设备场的成本。</p><p id="3809" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">之前，我们发布了<a class="ae la" href="https://android-developers.googleblog.com/2019/10/continuous-testing-with-new-android.html" rel="noopener ugc nofollow" target="_blank"> Android模拟器下载和Docker图像生成器脚本</a>来帮助开发人员简化部署和调试远程模拟器。这些脚本使得找到正确的系统映像、管理系统依赖性和运行Android模拟器变得更加容易。</p><p id="9109" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">我们现在更进一步，为每个主要的仿真器版本提供预构建的Android仿真器容器。这些容器消除了运行生成器脚本的需要，节省了时间和复杂性。预构建的容器支持那些用Docker脚本构建的容器所提供的所有特性，例如<a class="ae la" href="https://github.com/google/android-emulator-container-scripts#communicating-with-the-emulator-in-the-container" rel="noopener ugc nofollow" target="_blank"> adb </a>和<a class="ae la" href="https://github.com/google/android-emulator-container-scripts#make-the-emulator-accessible-on-the-web" rel="noopener ugc nofollow" target="_blank"> web </a>访问。</p><p id="5daf" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">运行这些容器需要Linux KVM，可以通过在裸机或具有嵌套虚拟化的虚拟机上运行来实现。正确的选择取决于您的云提供商，请参见<a class="ae la" href="https://github.com/google/android-emulator-container-scripts/blob/master/REGISTRY.MD#requirements-and-recommendations" rel="noopener ugc nofollow" target="_blank">文档</a>获取建议。</p><p id="cdf8" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">以下脚本展示了如何将Android模拟器容器集成到您的系统中，并使用它来运行测试。</p><figure class="lb lc ld le fd hj"><div class="bz dy l di"><div class="lf lg l"/></div></figure><p id="9ef6" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">查看<a class="ae la" href="https://github.com/google/android-emulator-container-scripts" rel="noopener ugc nofollow" target="_blank">自述文件</a>了解更多关于开始使用和利用Android模拟器容器的信息。这是我们首次提供预构建的仿真器容器，因此请在<a class="ae la" href="https://github.com/google/android-emulator-container-scripts/issues" rel="noopener ugc nofollow" target="_blank">问题跟踪器</a>上报告任何问题或功能请求。</p><h1 id="30b0" class="kd ke hs bd kf kg kh ki kj kk kl km kn iy ko iz kp jb kq jc kr je ks jf kt ku bi translated">详细的容器脚本</h1><p id="1929" class="pw-post-body-paragraph jh ji hs jj b jk kv it jm jn kw iw jp jq kx js jt ju ky jw jx jy kz ka kb kc ha bi translated">Github repo<a class="ae la" href="https://github.com/google" rel="noopener ugc nofollow" target="_blank">Google</a>/<a class="ae la" href="https://github.com/google/android-emulator-container-scripts" rel="noopener ugc nofollow" target="_blank">android-emulator-container-scripts</a>包含了我们针对Docker上的Android模拟器的解决方案背后的内部工作原理。这些脚本目前只适用于Linux，并且需要访问KVM管理程序。这是一组使用emu-docker命令的最小脚本，包括以下功能:</p><ul class=""><li id="9fe9" class="lh li hs jj b jk jl jn jo jq lj ju lk jy ll kc lm ln lo lp bi translated"><code class="du lq lr ls lt b"><a class="ae la" rel="noopener" href="/androiddevelopers/android-emulator-in-a-ci-environment-dd65f63cdcd">emu-docker list</a></code>:查询已发布的Docker兼容系统镜像和仿真器引擎二进制文件，显示其下载URL。这在stable和Canary通道中提供了所有已发布系统映像和模拟器的动态生成列表。该列表使用描述SDK管理器中仿真器和系统映像版本的相同数据，因此它总是最新的。</li><li id="bb1a" class="lh li hs jj b jk lu jn lv jq lw ju lx jy ly kc lm ln lo lp bi translated"><code class="du lq lr ls lt b"><a class="ae la" rel="noopener" href="/androiddevelopers/android-emulator-in-a-ci-environment-dd65f63cdcd">emu-docker create &lt;emulator-zip&gt; &lt;systemimage-zip&gt; [ — dest docker-src-dir(getcwd()/src by default)</a></code>:为指定的系统映像和仿真器创建一个自定义的本地Docker映像。</li><li id="2227" class="lh li hs jj b jk lu jn lv jq lw ju lx jy ly kc lm ln lo lp bi translated"><code class="du lq lr ls lt b"><a class="ae la" rel="noopener" href="/androiddevelopers/android-emulator-in-a-ci-environment-dd65f63cdcd">docker run -e ADBKEY=”$(cat ~/.android/adbkey)” — device /dev/kvm — publish 8554:8554/tcp — publish 5555:5555/tcp &lt;docker-image-id&gt;</a></code>:使用端口8554进行gRPC通信，使用端口5555进行ADB通信(<code class="du lq lr ls lt b"><a class="ae la" rel="noopener" href="/androiddevelopers/android-emulator-in-a-ci-environment-dd65f63cdcd">adb connect localhost:5555</a></code>将启用ADB访问)，启动与<code class="du lq lr ls lt b"><a class="ae la" rel="noopener" href="/androiddevelopers/android-emulator-in-a-ci-environment-dd65f63cdcd">&lt;docker-image-id&gt;</a></code>相关的仿真器和系统映像。</li><li id="989b" class="lh li hs jj b jk lu jn lv jq lw ju lx jy ly kc lm ln lo lp bi translated"><code class="du lq lr ls lt b"><a class="ae la" rel="noopener" href="/androiddevelopers/android-emulator-in-a-ci-environment-dd65f63cdcd">emu-docker interactive — start</a></code>:一个交互式提示，逐步完成Docker图像的列表、下载、创建和启动步骤。</li></ul><h1 id="4635" class="kd ke hs bd kf kg kh ki kj kk kl km kn iy ko iz kp jb kq jc kr je ks jf kt ku bi translated">与Docker实例交互</h1><p id="482f" class="pw-post-body-paragraph jh ji hs jj b jk kv it jm jn kw iw jp jq kx js jt ju ky jw jx jy kz ka kb kc ha bi translated">创建并启动Docker实例后，有两种方式与它交互:使用ADB或通过WebRTC进行远程流传输。这些方法描述如下</p><h1 id="dc4e" class="kd ke hs bd kf kg kh ki kj kk kl km kn iy ko iz kp jb kq jc kr je ks jf kt ku bi translated">亚洲开发银行(Asian Development Bank)</h1><p id="ec01" class="pw-post-body-paragraph jh ji hs jj b jk kv it jm jn kw iw jp jq kx js jt ju ky jw jx jy kz ka kb kc ha bi translated">使用<a class="ae la" href="https://developer.android.com/studio/command-line/adb" rel="noopener ugc nofollow" target="_blank"> ADB </a>提供了logcat和shell访问以及全部ADB命令，只需要adb connect <code class="du lq lr ls lt b"><a class="ae la" rel="noopener" href="/androiddevelopers/android-emulator-in-a-ci-environment-dd65f63cdcd">localhost:5555</a></code>(如果不同，用所需的ADB端口替换5555)。</p><h1 id="965e" class="kd ke hs bd kf kg kh ki kj kk kl km kn iy ko iz kp jb kq jc kr je ks jf kt ku bi translated">通过WebRTC进行远程流传输</h1><p id="b173" class="pw-post-body-paragraph jh ji hs jj b jk kv it jm jn kw iw jp jq kx js jt ju ky jw jx jy kz ka kb kc ha bi translated">我们提供了一个设置，其中<a class="ae la" href="https://www.envoyproxy.io/" rel="noopener ugc nofollow" target="_blank"> Envoy </a>、<a class="ae la" href="https://www.nginx.com/" rel="noopener ugc nofollow" target="_blank"> Nginx </a>、<a class="ae la" href="https://github.com/google/android-emulator-container-scripts/blob/master/js/jwt-provider/README.md" rel="noopener ugc nofollow" target="_blank">令牌服务</a>，以及仿真器容器与docker-compose一起工作，以公开一个WebRTC/gRPC端点来与仿真器交互。在使用前面的步骤创建了一个模拟器容器之后，脚本包含了<code class="du lq lr ls lt b"><a class="ae la" rel="noopener" href="/androiddevelopers/android-emulator-in-a-ci-environment-dd65f63cdcd">create_web_container.sh</a></code>，在本地情况下，它捕获了创建容器和生成用于发送加密流量的密钥的过程。创建web容器后，<code class="du lq lr ls lt b"><a class="ae la" rel="noopener" href="/androiddevelopers/android-emulator-in-a-ci-environment-dd65f63cdcd">docker-compose -f js/docker/docker-compose.yaml</a></code> up或<code class="du lq lr ls lt b"><a class="ae la" rel="noopener" href="/androiddevelopers/android-emulator-in-a-ci-environment-dd65f63cdcd">docker-compose -f js/docker/docker-compose.yaml -f js/docker/development.yaml </a></code> up(用于亚行同时访问)可用于启动和协调一切。默认情况下，它们在本地机器的端口80上公开交互式仿真器，因此将浏览器指向localhost应该能够与仿真器交互:</p><figure class="lb lc ld le fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es lz"><img src="../Images/f369f4599c4f4a6b97c5dc69f8f8971b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rudKEGEmQwl-vxBA"/></div></div></figure><p id="05a7" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">这些脚本仍在开发中，我们希望使用<a class="ae la" href="https://github.com/google/android-emulator-container-scripts/issues" rel="noopener ugc nofollow" target="_blank"> Github问题跟踪器</a>得到反馈。你也可能对用新的Android模拟器工具进行的<a class="ae la" href="https://android-developers.googleblog.com/2019/10/continuous-testing-with-new-android.html" rel="noopener ugc nofollow" target="_blank">持续测试感兴趣，它提供了更多的背景知识。</a></p></div></div>    
</body>
</html>