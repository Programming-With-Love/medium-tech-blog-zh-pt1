# 5 分钟开发运维:有效测试

> 原文：<https://medium.com/walmartglobaltech/5-minute-devops-effective-testing-bd38fab50564?source=collection_archive---------1----------------------->

![](img/2668a4262c576a972655938c911f9064.png)

[https://pixabay.com/en/developer-programmer-technology-3461405/](https://pixabay.com/en/developer-programmer-technology-3461405/)

# 保护企业

开发人员驱动的软件测试并不新鲜。[研究表明](https://cloudplatformonline.com/rs/248-TPC-286/images/DORA-State%20of%20DevOps.pdf)高绩效的组织依赖于开发人员编写的测试，而不是将它们交给外部的“测试自动化”团队。许多供应商出售*一个测试工具来统治他们所有人*，并承诺将想法从测试中剔除。我已经看到了反复演示的工具，它们光滑的用户界面让那些预算控制的人眼花缭乱，承诺使测试变得如此简单，甚至没有上下文的外部承包商也能做到。有人告诉我，只有单元测试是开发团队的责任。我甚至听说，为了提高开发人员的生产力，测试应该交给测试团队，因为“开发人员有更好的事情要做，反正他们没有资格进行测试”。哇！

这些被误导的信念使企业处于危险之中。客户只关心结果，数据显示，DevOps 原则和 CD 实践带来了更好的结果。工具不能解决这个问题。熟练、专业的开发人员使用有效的工具。

# CD ==测试

对于任何希望掌握 CD 的人来说，很少有研究领域比度量和测试的有效使用更重要。

CD 管道的整个要点是安全地持续向我们的最终用户交付价值。代码必须**向管道证明**它是值得交付的，而管道的工作就是阻止交付，除非价值被尽快证明。要做到这一点，一个[产品团队](/@bdfinst/5-minute-devops-designing-product-teams-33b82e6c1c5c)应该有以下优先权:

1.  构建并强化 CD 管道。
2.  保持管道绿色。如果有一个坏的构建，放弃一切并修复它。如果你不能出货，你正在做的任何事情都无关紧要。确保可以按需交付变更，以保护不逞英雄地修复生产的能力。
3.  **当**(非如果)缺陷穿透时，通过为该缺陷设计额外的有效测试来进一步强化管道。
4.  编写特性并每天发布，以不断地**测试我们以最小的 MTTR 修正生产**的能力。
5.  尽快获得关于变更状态的反馈。

持续交付不是工具。这是我们使用工具的方式。如果您声称执行 CD 流程，则以下情况属实。

*   在版本控制中提交代码之前，对任何代码更改的所有测试都要被实现和验证。测试驱动开发是一个好主意。开发期间的测试是不可协商的。
*   任何代码变更都只有一条通向生产的路径，不管它有多重要。我们总是使用我们的应急流程，我们总是以同样的方式进行测试。
*   用代码测试版本。
*   紧急情况下不得取消测试。
*   虽然可能有一个按钮来交付到产品，但是一旦代码通过了代码审查，就没有其他手动阶段门、人工干预或移交给外部团队。

如果上面所说的都不是真的，那么你写 Jenkins 的脚本有多好或者你付给测试团队多少钱都没有关系。您将永远无法获得可持续的质量，并且您将在每一次变更中冒业务风险，尤其是在紧急情况下。

CD 的秘诀是正确的心态:**永远是紧急事件**。我们设计管道是为了标准化工作并消除人工接触点，因为在凌晨 3 点，当生产中的垃圾箱着火，副总裁们紧紧盯着我们，我们在咖啡和恐怖中操作时，我们不想忘记我们“修补程序”中的步骤。我们只用我们的标准流程。这已经是一场噩梦了，所以我们不要让牛仔变得更糟，好吗？

以上所有的都暗示了我们如何构建我们的测试计划。

# 构建弹性测试计划

您的测试套件需要针对混乱世界的现实进行强化。在一个虚幻的测试世界中，网络从来没有延迟，外部依赖关系总是存在并且总是稳定的，拥有这些依赖关系的团队从来不会在没有版本控制的情况下部署突破性的 API 变更。假设一切都将完美运行是很好的，直到出现紧急情况，而你的假设是可悲的错误。你必须相信你的测试。你不能接受测试中的随机失败。即使你周围的一切都崩溃了，你的关键路径管道测试也必须工作。

## 表格赌注:可靠的单元测试

单元测试绝对是基础。它们也是大多数开发者止步的地方。虽然单元测试至关重要，但它们需要用于正确的目的；复杂、孤立的代码单元的黑盒测试。通常，我们在这个层次上讨论类、方法或函数。为了构建一个连续交付测试套件，我们希望它是快速和高效的。我们希望针对危险行为进行测试。100%的代码覆盖率既不合理也没有效率。测试像 getter 和 setter 方法这样的东西是没有意义的，除非它们在做一些有趣的事情。除非我们正在开发 JVM，否则测试 Java 将数据赋给变量的能力是没有用的。有很多关于单元测试模式和反模式的有用信息。最喜欢的是 [xUnit 测试模式](http://xunitpatterns.com)。这是一本关于正确测试和常见反模式的大部头书，我强烈推荐。

## 满足业务目标:功能测试

单元测试将很好地展示单个单元将如何执行，但是大多数应用程序都在实现一些业务流程。测试核心业务领域逻辑是至关重要的，而单元测试在这方面是无效的。许多团队会立即跳到端到端测试来解决这个问题，但是这些测试是不稳定的(flakey test anti-pattern ),并且不能有效地测试所有的逻辑分支。

更好的方法是使用独立测试每个业务特性的功能测试。

***“假设我在银行
有 20 英镑，当我向提款机要 20 英镑
时，它应该会给我 20 英镑
，并记入我账户的借方。”***

***摘自:*** [***莉丝·基奥。“行为驱动的发展。”***](https://leanpub.com/bdd)

这里我们有一个可以通过帐户服务实现的单一业务特性。这不需要特殊的工具来实现，只需要“我需要测试这个流”的思想过程。就像一个好的单元测试一样，每个功能测试都应该是有重点的，能够并行运行，不应该在测试范围之外直接集成。

## 成为一个好的 API 公民:API 契约测试

通信接口是大多数缺陷发生的地方。很明显，我们应该优先测试这些接口，甚至在实现它们背后的行为之前。这就是[契约测试](https://martinfowler.com/bliki/ContractTest.html)和[接触驱动开发](/@carlescliment/an-experience-with-contract-driven-development-480a700b277)变得重要的地方。

有许多记录 API 契约的糟糕方法，但是只有一种正确的方法:由提供者记录和测试的契约测试和契约模拟。合同测试的基本形式是对合同形式的简单单元测试。

这里有一个简单的例子:

## 与他人合作愉快:集成测试

契约测试在 CI 构建期间为您提供了一定程度的信心，即您没有破坏契约或破坏您消费契约的方式，但是因为它们被模仿，所以它们需要另一层测试来验证模仿。

许多人会用“集成测试”来指代通过几个组件测试业务流程的活动，以及端到端的测试。其他人用它来指我上面提到的功能测试。我下面提到的参考文献将集成测试称为验证组件间通信路径的行为；一个浅显的测试，消费者问，“我能理解我的依赖者的反应吗？”测试不应该试图测试依赖项的行为，只应该测试响应是否可以理解。

集成测试有一个弱点，CD 管道的架构师需要了解:它们是古怪的。您不能保证依赖关系在 CD 流执行时可用。如果这种依赖性不存在，交付仍然是你的团队的责任。记住上面 CD 的规则。你不允许绕过测试去交货。所以，我们有冲突。我们如何设计解决方案？

**第一步:**服务虚拟化。使用 [Wiremock](http://wiremock.org/) 、[江湖骗子](http://www.mbtest.org/)或其他相关工具，我们可以进行虚拟集成。这些工具可以作为实际依赖关系的代理，更好的工具可以复制延迟，并且不仅仅处理 HTTP。此外，除了最简单的集成测试之外，它们还减少了对测试数据管理的需求。数据是测试中最难处理的东西，所以要避免。

**步骤 2:** 预定的集成测试。当需要直接集成测试时，在标准流程之外的时间表上运行它。建立警报，告诉你什么时候中断，并触发中断的原因。如果依赖是不稳定的，那么记录下是如何不稳定的，这样你就可以快速的发现是他们的不稳定还是他们所做的突破性的改变，或者是你的虚拟集成测试需要解决的问题。

使用这种方法，您可以减少许多典型集成测试的缺陷，并且可以重复快速地测试复杂的场景，这些场景不能用不太精炼的方法有效地测试。

## 验证用户旅程:端到端测试

端到端测试测试跨多个组件的信息流和行为。当心出售记录和重放测试工具的供应商，他们声称通过简单地用这种方式测试整个系统来减轻开发人员的负担。然而…

记录测试的主要问题是他们记录的粒度级别。大多数商业工具在用户界面(UI)元素级别记录动作，这导致脆弱的测试"

***摘自:杰拉德·梅萨罗什。《xUnit 测试模式:重构测试代码***

端到端测试不能替代[适当分层的测试](http://xunitpatterns.com/Layer%20Test.html)。他们缺乏有效测试所需的粒度和数据控制。一个适当的 E2E 测试将集中在几个愉快的路径流上，以验证用户通过应用程序的旅程。将 E2E 的范围扩展到被其他测试层更好地覆盖的领域会导致测试缓慢和不可靠。如果将责任交给外部测试团队，情况会变得更糟。

## 我们没有测试什么？

探索性测试是为了发现我们没有想到要测试的东西。我们永远不会想到所有的事情，所以团队中有擅长破坏事物的人并不断尝试破坏事物是很重要的，这样就可以增加对这些破坏的测试。是的，这是手工探索，但不是验收测试。如果你使用清单，你就做错了。

## 真的会操作吗？

负载测试和性能测试不应该留到最后。你应该坚持不懈地执行它们。没有什么比相信一切都很好，然后当有人试图使用它时却失败了更糟糕的了。运营稳定性是您的首要功能，而不是事后的想法。

## 熵发生了

*   如果关键的依赖关系不可用怎么办？
*   如果它给你发垃圾会怎么样？
*   云提供商因升级而重启或停机？
*   延时过长？
*   日冕物质抛射？

这个世界是一个混乱的地方。弹性测试验证你能以最好的方式处理混乱。为服务的适度降级进行设计，然后进行测试。

# 测试并不容易！

正确的测试需要正确的思维方式和至少与生产代码一样多的设计。这需要一颗好奇的，有时是邪恶的心，以及思考“如果”的能力合适的测试工程师不会替你测试代码；他们帮助**你**考得更好。测试应该是快速、有效的，并且完整地记录你的应用程序的行为，因为测试是**唯一**可靠的文档。如果你对自己测试每一层的能力没有信心，那就研究一下。并不是额外增加的额外费用耽误了交货。这是工作。

如果你是一个专业的开发者和你的手艺的学生，这里有更多更深入学习的参考:

*   [Accelerate:精益软件和 DevOps 的科学:构建和扩展高性能技术组织](https://itrevolution.com/book/accelerate/)
*   [连续交货](https://continuousdelivery.com/)
*   [实战测试金字塔](https://martinfowler.com/articles/practical-test-pyramid.html)
*   [xUnit 测试模式](https://www.oreilly.com/library/view/xunit-test-patterns/9780131495050/)
*   [绘制软件弹性之路](/walmartlabs/charting-a-path-to-software-resiliency-38148d956f4a)

**如果你觉得这很有帮助，这是一个更大的** [**5 分钟 DevOps 系列**](/search?q=%225%20minute%20devops%22) **的一部分，我一直在努力，欢迎反馈。**