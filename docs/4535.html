<html>
<head>
<title>Debugging a Python Workload Gone Silent inside Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">调试在Kubernetes中静默的Python工作负载</h1>
<blockquote>原文：<a href="https://medium.com/compendium/debug-a-python-workload-that-has-gone-silent-hung-inside-kubernetes-9a597e163a86?source=collection_archive---------0-----------------------#2019-12-09">https://medium.com/compendium/debug-a-python-workload-that-has-gone-silent-hung-inside-kubernetes-9a597e163a86?source=collection_archive---------0-----------------------#2019-12-09</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="0e02" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">今天，我在帮助一位客户优化他们的<a class="ae jc" href="https://cloud.google.com/composer/" rel="noopener ugc nofollow" target="_blank"> Cloud Composer </a>设置。Cloud Composer是一个托管气流安装，一个运行在Kubernetes上的作业编排工具，由Airbnb制作。我之前建议客户使用Cloud Composer只运行Docker containers(<a class="ae jc" href="https://airflow.apache.org/docs/stable/_api/airflow/contrib/operators/kubernetes_pod_operator/index.html#airflow.contrib.operators.kubernetes_pod_operator.KubernetesPodOperator" rel="noopener ugc nofollow" target="_blank">KubernetesPodOperator</a>)，因为这确实简化了Cloud Composer/Airflow的测试和部署过程。使用<a class="ae jc" href="https://airflow.apache.org/docs/stable/howto/operator/python.html" rel="noopener ugc nofollow" target="_blank"> PythonOperator </a>来运行复杂的Python程序是你将来一定会后悔的事情(无论是测试还是包管理)。</p><p id="a96b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该客户开始出现的情况是，Kubernetes的工作负载开始停滞在运行状态。永远。</p><p id="6c46" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要弄清楚为什么Cloud Composer将工作负载留在集群中，只需阅读文档即可。我们没有设置<strong class="ig hi"><em class="jd">is _ delete _ operator _ pod</em></strong><em class="jd"/>参数，这意味着composer将在超时后保持工作负载运行。这不是我们真正想要的，所以一个简单的修复方法是应用参数更改，删除已经卡住的作业，问题会在某种程度上消失。至少它会被隐藏起来。</p><p id="9354" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，一个简单的读/写作业会像这样被卡住，这确实让我很困扰。程序中没有什么业务逻辑可言，基本上只是从一个源读取数据，然后将数据转储到另一个目标。我该如何调试它？</p></div><div class="ab cl je jf go jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="ha hb hc hd he"><h1 id="d531" class="jl jm hh bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">步骤1:连接到运行中的容器</h1><p id="25df" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">SSH进入正在运行的容器是可能的，在<a class="ae jc" href="https://cloud.google.com/kubernetes-engine/" rel="noopener ugc nofollow" target="_blank"> GKE </a>中最简单的方法是使用云Shell。只需在workloads菜单中找到要调试的正在运行的作业，然后单击它。然后，您将进入“Pod详细信息”页面。单击kubectl下拉菜单(右上角)→ exec →然后选择您的容器(通常只有一个)。在云壳中运行。</p><figure class="kp kq kr ks fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es ko"><img src="../Images/2e93a88600d40d9cdd6e612e6d8e6557.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pd3_IPgLPpc70HVlSKiWTQ.png"/></div></div></figure><p id="2bc8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您将得到一个生成的命令，以类似这样的内容结束。</p><pre class="kp kq kr ks fd la lb lc ld aw le bi"><span id="ca73" class="lf jm hh lb b fi lg lh l li lj">&amp;&amp; kubectl exec&lt;pod_name&gt; — namespace &lt;YOUR_NAMESPACE&gt; -c base — ls</span></pre><p id="d786" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">添加<strong class="ig hi"> <em class="jd"> -it </em> </strong>参数，启动<strong class="ig hi"> <em class="jd"> /bin/bash </em> </strong>(或类似shell)。在这种情况下，Docker图像基于python:3，python:3基于Ubuntu。</p><pre class="kp kq kr ks fd la lb lc ld aw le bi"><span id="8086" class="lf jm hh lb b fi lg lh l li lj">&amp;&amp; kubectl <strong class="lb hi">-it</strong> exec&lt;pod_name&gt; — namespace &lt;YOUR_NAMESPACE&gt; -c base — <strong class="lb hi">/bin/bash</strong></span></pre><p id="8e19" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦你按下回车键，你就有了一个问题容器的外壳。</p><h1 id="68f2" class="jl jm hh bd jn jo lk jq jr js ll ju jv jw lm jy jz ka ln kc kd ke lo kg kh ki bi translated">步骤2:在运行容器中安装调试工具</h1><p id="7776" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">容器很可能不包含您需要调试的工具。</p><p id="f3a2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Gdb是一个C调试器，通常用于调试C/C++程序。你会需要这个，因为Python是基于c的。我们还需要一个Python包装器，将gdb渲染成有意义的东西。<a class="ae jc" href="http://pyrasite.com/" rel="noopener ugc nofollow" target="_blank"> Pyrasite </a>就是这样一个库，应该在每个Python开发者的工具箱里！</p><p id="0360" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这些命令是在我们刚刚开始的SSH会话中的pod内部运行的。</p><pre class="kp kq kr ks fd la lb lc ld aw le bi"><span id="3f73" class="lf jm hh lb b fi lg lh l li lj">apt-get update<br/>apt-get install gdb<br/>pip install pyrasite</span></pre><h1 id="bfe2" class="jl jm hh bd jn jo lk jq jr js ll ju jv jw lm jy jz ka ln kc kd ke lo kg kh ki bi translated">第3步:让调试器工作！</h1><p id="36f1" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">安装之后，如果调试器在Kubernetes内部运行，它还不能施展魔法。调试器需要一些权限来进行跟踪，Kubernetes在默认情况下不会授予这些权限。通过运行以下命令进行演示(在pod内):</p><pre class="kp kq kr ks fd la lb lc ld aw le bi"><span id="81ac" class="lf jm hh lb b fi lg lh l li lj">$ps x<br/>PID TTY      STAT   TIME COMMAND<br/>1 ?        Ssl    0:12 python3 main.py --path=/foo/bar</span><span id="eb65" class="lf jm hh lb b fi lp lh l li lj">$pyrasite<br/>WARNING: ptrace is disabled. Injection will not work.<br/>You can enable it by running the following:<br/>echo 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope</span><span id="8e63" class="lf jm hh lb b fi lp lh l li lj">$echo 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope<br/>tee: /proc/sys/kernel/yama/ptrace_scope: Read-only file system<br/>0</span></pre><p id="de44" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">好吧，那现在该怎么办？我不允许更改我需要更改的文件。一个解决方案可以是在特权模式下运行容器，但是这样我们就会失去用例。现在可以做些什么来得到我需要的调试信息吗？</p><p id="986f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">其实是的！Kubernetes和Docker运行在虚拟机上(在我们的例子中是容器优化的操作系统)，所以我找到了运行作业的实际虚拟机，并在虚拟机上运行ssh(菜单→计算→计算引擎→实例→实例上的SSH)。一旦进入我运行的虚拟机</p><pre class="kp kq kr ks fd la lb lc ld aw le bi"><span id="8719" class="lf jm hh lb b fi lg lh l li lj">ps aux | grep python</span></pre><p id="5baf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Docker实例中运行的同一个Python程序出现了(除了气流包装器之外)。我简单地研究了一下在这台机器上安装相同的工具，但是操作系统需要一些定制的安装和编译来获得我想要的东西，从经验来看，这可能是痛苦的。</p><p id="ed40" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">可以用另一种方法解决吗？由于Python在主机上运行，如果我在主机上启用ptrace会发生什么？那会有好处吗？所以我跑了…</p><pre class="kp kq kr ks fd la lb lc ld aw le bi"><span id="223b" class="lf jm hh lb b fi lg lh l li lj">echo 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope</span></pre><p id="78ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在主机上。我做的时候没有得到错误信息。</p><p id="001d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后，回到挂着pod的SSH会话，我发现了这个:</p><pre class="kp kq kr ks fd la lb lc ld aw le bi"><span id="192a" class="lf jm hh lb b fi lg lh l li lj">pyrasite-shell 1<br/>Pyrasite Shell 2.0<br/>Connected to ‘python3 main.py — path=/foo/bar — workers=4’<br/>Python 3.8.0 (default, Nov 23 2019, 05:36:56)<br/>[GCC 8.3.0] on linux<br/>Type “help”, “copyright”, “credits” or “license” for more information.<br/>(DistantInteractiveConsole)<br/>&gt;&gt;&gt;</span></pre><p id="2f39" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">是啊！Pyrasite现在起作用了！</p><p id="b46d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">粘贴这个小代码片段会将线程调用堆栈打印到stdout中。</p><pre class="kp kq kr ks fd la lb lc ld aw le bi"><span id="13e2" class="lf jm hh lb b fi lg lh l li lj">import sys, traceback<br/>for thread_id, frame in sys._current_frames().items():<br/>    print('Stack for thread {}'.format(thread_id))<br/>    traceback.print_stack(frame)<br/>    print('')</span></pre><p id="0110" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">调用堆栈的一部分是(我故意混淆了调用堆栈，因为实际Python程序的函数名和文件名可以识别客户):</p><pre class="kp kq kr ks fd la lb lc ld aw le bi"><span id="11b4" class="lf jm hh lb b fi lg lh l li lj">File “/foo/bar/baz.py”, line xxx, in problem_function</span><span id="eafe" class="lf jm hh lb b fi lp lh l li lj">data = requests.Session().get(url, cookies=info[“login_token”], headers=headers, params=querystring).json()</span></pre><p id="55b5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我的例子中，很容易看出request.get缺少超时参数。这造成了。如果服务器没有响应，将永远等待。这导致了所有的麻烦！</p></div><div class="ab cl je jf go jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="ha hb hc hd he"><p id="d7ee" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有一个卡住的程序是一座金矿，简单地杀死它只会使问题在以后的时间里再次出现。您应该总是试图找到根本原因，获得调用堆栈通常是一个很大的帮助，而且通常情况下，说明确切的原因是什么。</p><p id="4985" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这种获取调用堆栈的方法也可以应用于裸机或普通虚拟机，您可以跳过Kubernetes/Docker层和命令的所有复杂性。</p><p id="cb9e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果你觉得这篇文章有用，我总是感谢掌声:)</p></div><div class="ab cl je jf go jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="ha hb hc hd he"><h1 id="d95b" class="jl jm hh bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">资源</h1><p id="aef6" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">Pyrasite打印调用堆栈</p><p id="aa0e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae jc" href="https://gist.github.com/reywood/e221c4061bbf2eccea885c9b2e4ef496" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/Rey wood/e 221 c 4061 bbf 2 ecce a85c 9 B2 E4 ef 496</a></p><p id="f8f4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如何安装广发银行</p><p id="1e56" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">http://www.gdbtutorial.com/tutorial/how-install-gdb<a class="ae jc" href="http://www.gdbtutorial.com/tutorial/how-install-gdb" rel="noopener ugc nofollow" target="_blank"/></p><p id="979a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Stackoverflow线索让我找到了pyrasite</p><p id="fee5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">【https://stackoverflow.com/a/29881630/8579931 T4】</p></div></div>    
</body>
</html>