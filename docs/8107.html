<html>
<head>
<title>CobaltStrike UUID stager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">钴罢工UUID舞台</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/cobaltstrike-uuid-stager-ca7e82f7bb64?source=collection_archive---------7-----------------------#2022-03-28">https://medium.com/walmartglobaltech/cobaltstrike-uuid-stager-ca7e82f7bb64?source=collection_archive---------7-----------------------#2022-03-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="5597" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作者:杰森·里维斯</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/ff1e8bb74f7e69fe728833b3ae8ebec9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zf9dIuyRSq2o7hpd6pOYgQ.jpeg"/></div></div></figure><p id="326a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">CobaltStrike有很多有趣的stagerss和loaders，我们已经讨论了一些用不同语言编写的stager和loaders，2，3]。我们已经跟踪了一年多，现在它已经验证了船上的stager代码，最近我们看到了一个我们用来跟踪此stager的YARA规则的匹配项:</p><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="5ede" class="jt ju hh jp b fi jv jw l jx jy">rule cs_hexlified_stager_sc<br/>{<br/>strings:<br/>$a1 = "d2648b52308b" nocase<br/>condition:<br/>all of them<br/>}</span></pre><p id="ec4b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">样本:</p><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="e52b" class="jt ju hh jp b fi jv jw l jx jy">488d4cbe017c493c66a769ccb203b40cbca3396c654bfff72c1aebeb41f23297</span></pre><p id="6b1a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，我们解码外壳代码的系统失败了，所以我们仔细看了一下，注意到一些有趣的事情，一个是hexlified外壳代码被存储为uuid[4]，另一个是最近由LAPSUS$[5]泄露的NVIDIAs cert签名的样本。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jz"><img src="../Images/ccc95c61898b6a0da54f8891a4bf91b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:812/format:webp/1*iVkDEa1vhqqufvVEk54pOg.png"/></div><figcaption class="ka kb et er es kc kd bd b be z dx">Ref: virustotal.com</figcaption></figure><p id="1a30" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通常情况下，要解码外壳代码，我们的解码器会简单地取出已加密的数据并重建它:</p><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="8bc0" class="jt ju hh jp b fi jv jw l jx jy">def decoder(data):<br/>    ret = []<br/>    c2s = []<br/>    blob = re.findall(b'''fce8[0-9a-f]+''', data)<br/>    for val in blob:<br/>        if len(val)%2 &gt;0:<br/>            val = val[:-1]<br/>        temp = binascii.unhexlify(val)<br/>        s = re.findall(b'[ -~]{4,}', temp)<br/>        t = [x.decode('cp1250') for x in s]<br/>        c2s.append(t[-1])<br/>        ret += t</span><span id="03e0" class="jt ju hh jp b fi ke jw l jx jy">    return((ret,c2s))</span></pre><p id="fcd1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因为它是UUIDs，所以过程仍然很简单，但是我们只需要考虑空白，然后滥用try/catch来结束收集:</p><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="c158" class="jt ju hh jp b fi jv jw l jx jy">idx = data.find(b'0089e8fc')<br/>t = data[idx:].split(b'\x00')<br/>tt = [x for x in t if x != b'']<br/>sc = b''<br/>c2s = []<br/>ret = []<br/>for val in tt:<br/>    try:<br/>        u = uuid.UUID(val.decode('cp1250'))<br/>        sc += u.bytes_le<br/>    except:<br/>        break<br/>if sc != '':<br/>    s = re.findall(b'[ -~]{4,}', sc)<br/>    t = [x.decode('cp1250') for x in s]<br/>    c2s.append(t[-1])<br/>    ret += t</span></pre><p id="8461" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">示例中的调试工件将自己称为“shellcode_uuids ”,这也可用于在VirusTotal中查找另一个示例:</p><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="1c02" class="jt ju hh jp b fi jv jw l jx jy">a59ab6c4e69fafc927f666cf1afb31a2851a392cc74336d8a31e15daf1f343ff</span></pre><p id="a49c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，stagers看起来是相同的，所以我们可以搜索不同的东西作为支点:</p><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="c78c" class="jt ju hh jp b fi jv jw l jx jy">content:"0089e8fc-"</span></pre><p id="52d6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这导致更多的样本，因为我们已经有了一个解码器，我们可以很容易地为我们已经考虑的样本枚举IOC，但还有一些其他的混合。例如，与其他样本相比，具有无序UUIDs的GoLang样本:</p><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="65a2" class="jt ju hh jp b fi jv jw l jx jy">07122c83922c50b386a060d4fbf21433042118fccf5bc678f78acd377d5dccfe</span></pre><p id="f801" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要解码，我们只需找到代码中第一个UUID的偏移引用，然后遍历表进行重建:</p><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="54a9" class="jt ju hh jp b fi jv jw l jx jy">if b'Go build ID' not in data:<br/>    t = data[idx:].split(b'\x00')<br/>    tt = [x for x in t if x != b'']<br/>else:<br/>    pe = pefile.PE(data=data)<br/>    memdata = pe.get_memory_mapped_image()<br/>    idx = memdata.find(b'0089e8fc')<br/>    imgbase = pe.OPTIONAL_HEADER.ImageBase<br/>    val_to_find = struct.pack('&lt;I', imgbase + idx)<br/>    offset = data.find(val_to_find)<br/>    blob = data[offset:]<br/>    tt = []<br/>    done = False<br/>    while not done:<br/>        temp = struct.unpack_from('&lt;I', blob)[0]<br/>        if temp == 0:<br/>            break<br/>        temp -= imgbase<br/>        val = memdata[temp:temp+36]<br/>        tt.append(val)<br/>        blob = blob[16:]</span></pre><p id="5905" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">解码数据:</p><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="40f9" class="jt ju hh jp b fi jv jw l jx jy">['49.234.114.124'] [';}$u', 'D$$[[aYZQ', ']hnet', 'hwiniThLw&amp;', 'WWWWWh:Vy', 'QQhP', 'SPhW', 'RRRSRPh', 'SVh-', 'hE!^1', 'QVPh', '/XjDV', 'ebW*', 'User-Agent: Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Win64; x64; Trident/6.0; Touch)', 'Lio[', '[E$Y', 'Wetb', '49.234.114.124']</span></pre><p id="e73d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">还有一些UUIDs结构颠倒的其他示例:</p><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="2035" class="jt ju hh jp b fi jv jw l jx jy">9bfd19e3e459118981bf8ca009acca84f5f079ad3a7baa5eb6a1b20f97d3e922</span></pre><p id="5476" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们只需要考虑解码后的外壳代码是16，这意味着我们在最后，我们可能需要颠倒顺序:</p><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="974f" class="jt ju hh jp b fi jv jw l jx jy">if len(sc) == 16:<br/>    #reversed<br/>    tt = re.findall(b'''[a-f0-9]{8}\-[a-f0-9]{4}\-[a-f0-9]{4}\-[a-f0-9]{4}\-[a-f0-9]{12}''', data)<br/>    sc = b''<br/>    for val in tt[::-1]:<br/>        try:<br/>            u = uuid.UUID(val.decode('cp1250'))<br/>            sc += u.bytes_le<br/>        except:<br/>            break</span></pre><p id="a6f2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">解码数据:</p><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="fa53" class="jt ju hh jp b fi jv jw l jx jy">['47.116.23.73'] [';}$u', 'D$$[[aYZQ', ']hnet', 'hwiniThLw&amp;', 'WWWWWh:Vy', 'SPhW', 'RRRSRPh', 'VhuF', 'SVh-', 'hE!^1', 'QVPh', '/jquery-3.3.1.slim.min.js', '5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-T', 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8', 'Accept-Language: en-US,en;q=0.5', 'Referer: <a class="ae kf" href="http://code.jquery.com/'" rel="noopener ugc nofollow" target="_blank">http://code.jquery.com/'</a>, 'Accept-Encoding: gzip, deflate', 'User-Agent: Mozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko', '5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TES', '47.116.23.73']</span></pre><h2 id="bf0e" class="jt ju hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">IOCs:</h2><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="cf51" class="jt ju hh jp b fi jv jw l jx jy">144.168.57.182<br/>49.234.114.124<br/>img.googlesoftup.com<br/>7355-120-239-40-185.ngrok.io<br/>132.232.40.201<br/>159.75.127.118<br/>81.68.200.63<br/>150.158.166.73<br/>47.116.23.73<br/>8.142.131.209<br/>172.29.25.27<br/>169.254.41.35</span></pre><h2 id="ca78" class="jt ju hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">用户代理:</h2><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="1d89" class="jt ju hh jp b fi jv jw l jx jy">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36 QIHU 360EE<br/>User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0; Avant Browser)<br/>User-Agent: Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; WOW64; Trident/6.0; ASU2JS)<br/>User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0; BOIE9;ENIN)<br/>User-Agent: Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; WOW64; Trident/6.0; MAARJS)<br/>User-Agent: Microsoft Internet Explorer<br/>User-Agent: Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; WOW64; Trident/6.0; MATBJS)<br/>User-Agent: Mozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko<br/>User-Agent: Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)<br/>User-Agent: Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Win64; x64; Trident/6.0; Touch)<br/>User-Agent: Mozilla/4.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)<br/>User-Agent: Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; WOW64; Trident/6.0; Touch; MASPJS)</span></pre><h2 id="b77c" class="jt ju hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">哈希:</h2><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="47e4" class="jt ju hh jp b fi jv jw l jx jy">fc16b66c98a897df46a91a4ac913993ef4ebf440250051fef1d3151d5c9faeab<br/>f175df01577971262f662f15e36c633e0dedd6c0fff9c22bcf5f702ddecc05b7<br/>dd4d27b29f656b5ad1f5cd177b138fe011cc98f5383a102c9a363de0a0021226<br/>dd3416fa926a9801928d8dafd595ce6c3f41ad909ef4c25deb1b9b6a928e3749<br/>ca9fcd4be0990d19aff9244f47ad05cb033abe4307c51b7b46b635ecca71c3f5<br/>c916d2ee316491ec643b2b029e4e3acced82eeeb6896d42c9e9693e8d0e495ad<br/>c5c586c5c0ad28761dfaef0d049ed4b862be1398ac2fd75cd04e359170777bd8<br/>bc1936c3a33d4e75603341786227bbe8887a19d7b61926ddbe8875fabd1471fe<br/>a59ab6c4e69fafc927f666cf1afb31a2851a392cc74336d8a31e15daf1f343ff<br/>a3b268e6ecc6d2594d2dfdaeb86c25e9baf337f83659d6a718206474b8c416a1<br/>9bfd19e3e459118981bf8ca009acca84f5f079ad3a7baa5eb6a1b20f97d3e922<br/>8cd86fa95c702dca17ea75893f27ac414e1947fc90ca86bcd38d209ede2ee19b<br/>8c80fa876b01544e85b8588209cefc99827f1a882580778b87274d157b88eda6<br/>8869be33e23370d19c17f33cb5b2e1501b95eafcfd9b71b34bc338f477bc5a3e<br/>80907d4e3519cf212e755b4cc175ce807cf2313ad16d85020f985670be87a4c9<br/>804c3e3709e35949311bae50a1d98d8233c26cf193ff27d439d9da025ab6f94f<br/>6cbe5b78e2c82b3e98fdff531aaf49dd8a7191015af8eb63366eb468693a0532<br/>6237bbef07de46d11d45b4997fc661114f092abcbbe1108b0f6d7508e55e4398<br/>61f47f9b7f68ac996bc3a56c16f7dd4aedbeba6a5d7b46e8406505fc6903524c<br/>588454f02cba40703ed7f6dfe256ecaba3c41bbd80ed1cc0e34ba8d2214c05d0<br/>57c1c1e2f214f4a933fa356219acaec3bb338e6fb15dd6349e6cf04a5289a2e4<br/>53c337b5f52ac1d21ba226e4d027f01a80cc6176cb1d3f1ad1148cf37c8c75eb<br/>488d4cbe017c493c66a769ccb203b40cbca3396c654bfff72c1aebeb41f23297<br/>47df2d7eb512a533511104c939bfa89e6266d3ce9f0ffdced681768e183244a6<br/>44d6dd82e5b7ca8976c50c9165ce822fbef86075a7bde43cfd364e28f30e400c<br/>42d9638489f248f1177b86739d1d9ce2a9f4aa591523cd7655b324853895e857<br/>3ba3aaecbc834da3dba0ec5d20d5c9cb119f27bc660f720f6cc3da929da0e529<br/>398b4205fe8f4d1bf005782bd05730c45c39224c14b2878865dd3d7a255cd20b<br/>38f4167638607dd6a299d3c02ceb984fc4f9d7491d4c25a609186e582e705505<br/>317dc94e847fec42f101709043eff4d705b531b1e1d433f7af1f4ef62185e194<br/>2cfdacdc363ddf146d59add3bf49b49a29df951ff3be4bf35e70c2125b2751d1<br/>2c3db921dd86b801b9e856c28830990311db52b18f3a1f4a100eb84d3aaf55a7<br/>24d66bc81ac389c5580a7de37f531cd89e5dbf97f3048e5164a1cb829d16c51b<br/>24b60dfda87cebafec57f827b0fc534bc3fe3afa178b5f15683fe30bcf4041fe<br/>23084aa205a2a09623752e0fa807c722a9a23c169eb5f7a04fb50a8c4f7a6924<br/>1322219fff925f6081bb38c09d8215b796fbc910003a2df2ad627558479f2cf8<br/>07122c83922c50b386a060d4fbf21433042118fccf5bc678f78acd377d5dccfe<br/>033b1cad6953ad623cbc565fa7afb4751cac1b25f5050dab08646faafff29619</span></pre><h2 id="51d9" class="jt ju hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">YARA:</h2><pre class="jd je jf jg fd jo jp jq jr aw js bi"><span id="d2fc" class="jt ju hh jp b fi jv jw l jx jy">rule cs_hexlified_stager_sc<br/>{<br/>strings:<br/>$a1 = "d2648b52308b" nocase<br/>condition:<br/>all of them<br/>}</span></pre><h1 id="3f1e" class="kz ju hh bd kg la lb lc kk ld le lf ko lg lh li kr lj lk ll ku lm ln lo kx lp bi translated">参考</h1><p id="706e" class="pw-post-body-paragraph ie if hh ig b ih lq ij ik il lr in io ip ls ir is it lt iv iw ix lu iz ja jb ha bi translated">1:<a class="ae kf" rel="noopener" href="/walmartglobaltech/investigation-into-the-state-of-nim-malware-14cc543af811">https://medium . com/walmartglobaltech/investigation-into-the-state-of-nim-malware-14c c543 af 811</a></p><p id="7816" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2:<a class="ae kf" rel="noopener" href="/walmartglobaltech/trickbot-crews-new-cobaltstrike-loader-32c72b78e81c">https://medium . com/Walmart global tech/trick bot-crews-new-cobalt strike-loader-32 c 72 b 78 e 81 c</a></p><p id="4075" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">3:<a class="ae kf" rel="noopener" href="/walmartglobaltech/investigation-into-the-state-of-nim-malware-part-2-a28bffffa671">https://medium . com/walmartglobaltech/investigation-into-the-state-of-nim-malware-part-2-a 28 bffffa 671</a></p><p id="e260" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">4:<a class="ae kf" href="https://en.wikipedia.org/wiki/Universally_unique_identifier" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Universally_unique_identifier</a></p><p id="adaa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">5:<a class="ae kf" href="https://threatpost.com/nvidias-stolen-code-signing-certs-sign-malware/178784/" rel="noopener ugc nofollow" target="_blank">https://threat post . com/nvidias-stopped-code-signing-certs-sign-malware/178784/</a></p></div></div>    
</body>
</html>