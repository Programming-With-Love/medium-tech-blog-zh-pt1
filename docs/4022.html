<html>
<head>
<title>Load balance microservices using Kubernetes' Minikube</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kubernetes Minikube的负载平衡微服务</h1>
<blockquote>原文：<a href="https://medium.com/globant/load-balance-microservices-using-kubernetes-minikube-88b78dae4796?source=collection_archive---------0-----------------------#2022-11-07">https://medium.com/globant/load-balance-microservices-using-kubernetes-minikube-88b78dae4796?source=collection_archive---------0-----------------------#2022-11-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="adb2" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">了解如何使用Minikube部署和平衡应用程序</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/0c96a46f1b435d8bd302b01264b1cb6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*12WNLAycHovc_3aF"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Photo by <a class="ae jm" href="https://unsplash.com/@soochunkit?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Chun Kit Soo</a> on <a class="ae jm" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="0c20" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">在本文中，我将带您了解如何使用Minikube(本地Kubernetes环境)部署和负载平衡Spring Boot应用程序。</p><p id="0e65" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">对于这项工作，您需要以下内容:</p><ul class=""><li id="7f98" class="kj kk hh jp b jq jr jt ju jw kl ka km ke kn ki ko kp kq kr bi translated">Spring Boot版本:2.7.3</li><li id="e899" class="kj kk hh jp b jq ks jt kt jw ku ka kv ke kw ki ko kp kq kr bi translated">Minikube版本:v1.25.1</li><li id="b21b" class="kj kk hh jp b jq ks jt kt jw ku ka kv ke kw ki ko kp kq kr bi translated">Kubectl: v1.22.5</li><li id="aaf3" class="kj kk hh jp b jq ks jt kt jw ku ka kv ke kw ki ko kp kq kr bi translated">斯卡福德:1.39.1版</li></ul><h1 id="243f" class="kx ky hh bd kz la lb lc ld le lf lg lh in li io lj iq lk ir ll it lm iu ln lo bi translated">让我们开始吧…</h1><p id="bcb8" class="pw-post-body-paragraph jn jo hh jp b jq lp ii js jt lq il jv jw lr jy jz ka ls kc kd ke lt kg kh ki ha bi translated">我们将使用Spring Boot创建一个示例微服务，并将其部署在本地Kubernetes集群上。要启动本地Kubernetes集群，首先使用以下命令启动Minikube。</p><pre class="ix iy iz ja fd lu lv lw lx aw ly bi"><span id="e216" class="lz ky hh lv b fi ma mb l mc md">minikube start</span></pre><p id="544b" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">现在让我们创建一个简单的Spring Boot应用程序，它有一个REST GET端点，将返回“Hello + Pod Name”。pod名称将在这里指示哪个实例正在为请求提供服务。</p><p id="08f1" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">使用Spring start.io，创建一个项目，并将其命名为“order-service”。</p><p id="c6b5" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">将以下端点代码添加到订单服务项目中。</p><pre class="ix iy iz ja fd lu lv lw lx aw ly bi"><span id="85af" class="lz ky hh lv b fi ma mb l mc md">@SpringBootApplication<br/>@RestController<br/>public class OrderServiceApplication {<br/>  @Autowired<br/>  Environment env;</span><span id="ec77" class="lz ky hh lv b fi me mb l mc md">  @GetMapping(<strong class="lv hi">"/</strong>status<strong class="lv hi">"</strong>)<br/>  public String status() {</span><span id="417c" class="lz ky hh lv b fi me mb l mc md"><strong class="lv hi"> </strong> return "Status - returned by Pod - "<strong class="lv hi"> </strong>+ env.getProperty(<strong class="lv hi">"</strong>HOSTNAME<strong class="lv hi">"</strong>)  ; <br/>  //HOSTNAME =&gt; POD name serving request<br/> }<br/>}</span></pre><p id="2de2" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">现在让我们创建一个名为“docker file”的docker文件来创建容器。</p><pre class="ix iy iz ja fd lu lv lw lx aw ly bi"><span id="1aa5" class="lz ky hh lv b fi ma mb l mc md"><strong class="lv hi">FROM</strong> openjdk:11.0.7-jre-slim<br/><strong class="lv hi">VOLUME</strong> /tmp<br/><strong class="lv hi">ADD</strong> target/order-*.jar app.jar<br/><strong class="lv hi">ENV</strong> JAVA_OPTS=<strong class="lv hi">""<br/>ENTRYPOINT </strong>[ "sh", "-c", "java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -jar /app.jar" ]</span></pre><p id="8dd1" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">接下来，创建包含服务负载平衡器服务定义的部署文件“order-service.yaml ”,如下所示:</p><pre class="ix iy iz ja fd lu lv lw lx aw ly bi"><span id="d720" class="lz ky hh lv b fi ma mb l mc md"><strong class="lv hi">apiVersion</strong>: "v1"<strong class="lv hi"><br/>kind</strong>: "List"<strong class="lv hi"><br/>items</strong>:<br/>  - <strong class="lv hi">apiVersion</strong>: "v1"<strong class="lv hi"><br/>    kind</strong>: "Service"<strong class="lv hi"><br/>    metadata</strong>:<br/>      <strong class="lv hi">annotations</strong>: {}<br/>      <strong class="lv hi">labels</strong>: {}<br/>      <strong class="lv hi">name</strong>: "order-service"<strong class="lv hi"><br/>    spec</strong>:<br/>      <strong class="lv hi">selector</strong>:<br/>        <strong class="lv hi">app</strong>: "order-service<strong class="lv hi">"<br/>      type</strong>: LoadBalancer<em class="mf"><br/>      </em><strong class="lv hi">ports</strong>:<br/>        - <strong class="lv hi">name</strong>: http<br/>          <strong class="lv hi">port</strong>: 8080<br/>          <strong class="lv hi">targetPort</strong>: 8080<br/>          <strong class="lv hi">nodePort</strong>: 32000<br/>          <strong class="lv hi">protocol</strong>: TCP<br/>  - <strong class="lv hi">apiVersion</strong>: "apps/v1"<strong class="lv hi"><br/>    kind</strong>: "Deployment"<strong class="lv hi"><br/>    metadata</strong>:<br/>      <strong class="lv hi">labels</strong>:<br/>        <strong class="lv hi">app</strong>: "order-service"<strong class="lv hi"><br/>        version</strong>: "1.0.0"<strong class="lv hi"><br/>      name</strong>: "order-service"<strong class="lv hi"><br/>    spec</strong>:<br/>      <strong class="lv hi">replicas</strong>: 3<br/>      <strong class="lv hi">selector</strong>:<br/>        <strong class="lv hi">matchLabels</strong>:<br/>          <strong class="lv hi">app</strong>: "order-service"<strong class="lv hi"><br/>          version</strong>: "1.0.0"<strong class="lv hi"><br/>      template</strong>:<br/>        <strong class="lv hi">metadata</strong>:<br/>          <strong class="lv hi">labels</strong>:<br/>            <strong class="lv hi">app</strong>: "order-service"<strong class="lv hi"><br/>            version</strong>: "1.0.0"<strong class="lv hi"><br/>        spec</strong>:<br/>          <strong class="lv hi">containers</strong>:<br/>            - <strong class="lv hi">image</strong>: "order-service:1.0.0"<strong class="lv hi"><br/>              imagePullPolicy</strong>: "Never"<strong class="lv hi"><br/>              name</strong>: "order-service"<strong class="lv hi"><br/>              resources</strong>:<br/>                <strong class="lv hi">limits</strong>:<br/>                  <strong class="lv hi">cpu</strong>: 500m<br/>                <strong class="lv hi">requests</strong>:<br/>                  <strong class="lv hi">cpu</strong>: 200m<br/>              <strong class="lv hi">ports</strong>:<br/>                - <strong class="lv hi">protocol</strong>: TCP<br/>                  <strong class="lv hi">containerPort</strong>: 8080</span></pre><p id="16e7" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">您可以使用<code class="du mg mh mi lv b">kubectl apply -f order-service.yaml</code>命令直接部署，或者创建一个Skaffold文件“skaffold.yaml ”,如下所示:</p><pre class="ix iy iz ja fd lu lv lw lx aw ly bi"><span id="ce91" class="lz ky hh lv b fi ma mb l mc md"><strong class="lv hi">apiVersion</strong>: skaffold/v2beta11<br/><strong class="lv hi">kind</strong>: Config<br/><strong class="lv hi">metadata</strong>:<br/>  <strong class="lv hi">name</strong>: order-service<br/><strong class="lv hi">build</strong>:<br/>  <strong class="lv hi">artifacts</strong>:<br/>  - <strong class="lv hi">image</strong>: order-service<br/><strong class="lv hi">deploy</strong>:<br/>  <strong class="lv hi">kubectl</strong>:<br/>    <strong class="lv hi">manifests</strong>:<br/>    - k8s/order-service.yaml<br/><strong class="lv hi">portForward</strong>:<br/>- <strong class="lv hi">resourceType</strong>: deployment<br/>  <strong class="lv hi">resourceName</strong>: order-service<br/>  <strong class="lv hi">port</strong>: 8080<br/>  <strong class="lv hi">localPort</strong>: 8080</span><span id="26da" class="lz ky hh lv b fi me mb l mc md">    <strong class="lv hi">manifests</strong>:<br/>    - k8s/order-service.yaml<br/><strong class="lv hi">portForward</strong>:<br/>- <strong class="lv hi">resourceType</strong>: deployment<br/>  <strong class="lv hi">resourceName</strong>: order-service<br/>  <strong class="lv hi">port</strong>: 8080<br/>  <strong class="lv hi">localPort</strong>: 8080</span></pre><p id="d6e3" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">打开命令提示符，导航到项目目录，然后运行以下命令。</p><pre class="ix iy iz ja fd lu lv lw lx aw ly bi"><span id="783c" class="lz ky hh lv b fi ma mb l mc md">skaffold run</span></pre><p id="5eab" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">在成功运行时，验证三个<code class="du mg mh mi lv b">order-service</code>实例正在运行。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mj"><img src="../Images/4edd5387e3788f67a63e7bfba9279d19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5lr3m0G4vxAhzWf1"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">POD status</figcaption></figure><p id="7ca6" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">检查新创建的服务的状态:</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mk"><img src="../Images/79cc12ac6bfbf16db16c19ced3dfa2c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*C_Invq5Suy5fllFu"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">service status</figcaption></figure><p id="d148" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">正如我们所看到的，服务“order-service”属于负载平衡器类型，它的外部IP分配正在进行中。要访问和分配外部IP，我们需要使用隧道命令在Minikube和我们的机器之间创建一个桥。</p><p id="b454" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">打开一个新的命令提示符，运行<code class="du mg mh mi lv b">minikube tunnel</code>命令。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es ml"><img src="../Images/8b21e787781a896f05ff0fa3cbb97e83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cgCeHwxbfDrsGH5Y"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Tunnel command to bridge local and Minikube network</figcaption></figure><p id="12f8" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">注意:为了保持桥梁畅通，不要关闭隧道窗口。</p><p id="09e7" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">现在，重新运行get services命令(<code class="du mg mh mi lv b">kubectl get svc</code>)并验证是否分配了IP:</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mm"><img src="../Images/bde9d5464b0311002076f72d151dc8b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qrAbJ_wkL5SFnQte"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Load Balancer Service IP Assignment</figcaption></figure><p id="ef0f" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">现在打开Postman，创建一个GET端点并更改keep-alive配置，如下所示。</p><p id="6fe3" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">点击标题→隐藏:</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mn"><img src="../Images/b83b9d29790d5449978b1ade569a9878.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*N3ShvHMi-9JXHBgN"/></div></div><figcaption class="ji jj et er es jk jl bd b be z dx">Toggle hidden headers</figcaption></figure><p id="2957" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">取消选中连接字段，如下图所示。这将确保每次建立新连接时，我们都会看到负载平衡的效果。(K8s负载均衡器采用随机分配算法；因此，有时您可能会看到同一个pod正在为请求提供服务。)</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es mo"><img src="../Images/59e918b9f216bcb3d476e198b8406339.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/0*CHaWUXCGLOogGyPq"/></div><figcaption class="ji jj et er es jk jl bd b be z dx">Change Keep-alive</figcaption></figure><p id="7947" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated"><strong class="jp hi">重要</strong>:对于浏览器来说，默认的保活是60秒(使用浏览器的网络选项卡，可以验证报头)；因此，如果您使用浏览器进行测试，那么在这段时间之后点击结束点以查看负载平衡的效果。</p><p id="be1e" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">现在，让我们到达如下所示的终点，验证负载平衡是否正常工作:</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div class="er es mp"><img src="../Images/3d1354e854845e7f3d33500de69fee51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*pplQOoJIaMpDp0fGd49yMw.gif"/></div></figure><p id="54ac" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated">观察响应(最后一个字)部分。正如我们所看到的，不同的实例发送响应，负载平衡正在工作！</p><h2 id="7d49" class="lz ky hh bd kz mq mr ms ld mt mu mv lh jw mw mx lj ka my mz ll ke na nb ln nc bi translated">结论</h2><p id="c783" class="pw-post-body-paragraph jn jo hh jp b jq lp ii js jt lq il jv jw lr jy jz ka ls kc kd ke lt kg kh ki ha bi translated">我们已经成功地在Minikube上部署了一个微服务，并可以使用负载平衡器服务从不同的实例中获得响应。</p><p id="d7cd" class="pw-post-body-paragraph jn jo hh jp b jq jr ii js jt ju il jv jw jx jy jz ka kb kc kd ke kf kg kh ki ha bi translated"># Minikube # Springboot #负载平衡器</p></div></div>    
</body>
</html>