<html>
<head>
<title>A walkthrough to Lambda layers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Lambda层的演练</h1>
<blockquote>原文：<a href="https://medium.com/globant/a-walkthrough-to-lambda-layers-69c0f0c2392a?source=collection_archive---------0-----------------------#2021-09-27">https://medium.com/globant/a-walkthrough-to-lambda-layers-69c0f0c2392a?source=collection_archive---------0-----------------------#2021-09-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="6a78" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">介绍</h1><p id="745d" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">自从我了解了AWS Lambda函数，我就尽可能地实现它们。在AWS服务中，AWS Lambda函数因其适应性和易用性而脱颖而出。然而，我最近不得不实现一个Lambda函数来更新一个Confluence wiki并使用Atlassian-python-API库。你猜怎么着？AWS Lambda没有包含该库；因此密码被破解了。</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es ka"><img src="../Images/ed82f71e03d307671ed10a8c55245e8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*34ePXGPaohah5sw0"/></div></div></figure><p id="c2ab" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">我之前已经遇到过同样的问题，但是因为我们可以使用其他方法，所以我们只是修改了代码。这一次是不同的，因为解决方法很容易出错，所以我们要解决这个问题。我们是这样解决的。</p><h1 id="5b0b" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">问题是</h1><p id="8cd5" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">需要运行用python写的AWS Lambda函数，该函数使用了AWS Lambda上默认不可用的python库。该功能使用Terraform进行部署。</p><h1 id="551c" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">解决方案</h1><p id="c8cd" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在做了一些研究后，AWS Lambda层似乎是我们担忧的解决方案。根据AWS文档，层“<em class="kr">是一个. zip文件档案，可以包含附加代码或数据”。</em>换句话说，你可以事先压缩你的函数正确运行所需要的任何东西，否则其他函数会用到它。然后，通过压缩它并将其保存为一个层，您可以重用您压缩的任何内容，而不必重新创建它。</p><h1 id="e4fc" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">实施</h1><ol class=""><li id="edce" class="ks kt hh je b jf jg jj jk jn ku jr kv jv kw jz kx ky kz la bi translated"><em class="kr">创建zip文件</em></li></ol><p id="a717" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">要创建zip文件，您必须知道文件夹必须具有以下结构:python/your library。例如，我们想安装atlassian-python-api和requests的库，安装后，文件夹看起来像这样:</p><figure class="kb kc kd ke fd kf"><div class="bz dy l di"><div class="lb lc l"/></div></figure><p id="dd1f" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">记住这一点；否则，你的Lambda函数将无法识别已安装的库，它将不断抛出错误。</p><p id="862e" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">生成了包含所有所需库的名为python的文件夹后，您可以对其进行压缩</p><pre class="kb kc kd ke fd ld le lf lg aw lh bi"><span id="bc7d" class="li if hh le b fi lj lk l ll lm">zip -r9 ../lambda_layer.zip .</span></pre><p id="3d90" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">重要注意事项:</p><p id="24ef" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">a)r标记递归地压缩到目录中的所有文件夹，9标记表示最高的压缩。</p><p id="bab2" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">b)在python文件夹所在的目录中执行该命令。如果您的python文件夹在$HOME/python_layer中，那么您可以在该目录中进行操作。为避免出现故障，建议您检查该文件夹，其中只有python文件夹，其中包含您要添加到图层的库。为了以防万一，您可以使用ls命令检查这一点:</p><pre class="kb kc kd ke fd ld le lf lg aw lh bi"><span id="c981" class="li if hh le b fi lj lk l ll lm">$HOME/python_layer ls<br/>python</span></pre><p id="48bc" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">您的函数代码不需要在这个目录中。</p><p id="9d00" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated"><em class="kr"> 2。创建你的图层并把它附加到一个函数上</em></p><p id="22f2" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">无论您是将基础设施作为代码管理，还是以传统方式管理，两种方式都是可行的。请记住，每个lambda函数最多可以附加5个不同的层。</p><ul class=""><li id="5959" class="ks kt hh je b jf km jj kn jn ln jr lo jv lp jz lq ky kz la bi translated">带地形的IaC</li></ul><p id="e6c9" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">幸运的是，Terraform确实有lambda层的资源，所以我们只是将其配置如下:</p><figure class="kb kc kd ke fd kf"><div class="bz dy l di"><div class="lb lc l"/></div></figure><p id="3169" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">如您所见，第一个资源是我们需要附加层的lambda函数。如果您想要创建层而不将其附加到任何函数，则可以忽略此步骤。当用层配置lambda时，主要的区别是在资源中添加了属性“layers”。</p><p id="1ea4" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">第二个资源是创建层的资源，称为“lambda_utils_layer”需要注意的两个关键方面:</p><p id="c173" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">a)确保您在文件名上使用的路径正是您的压缩文件夹所在的位置。</p><p id="f4da" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">b)仔细检查lambda函数运行时是否在为您的层列出的兼容运行时之中。</p><p id="aac9" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">执行terraform apply时，如果lambda函数已经存在，它将被就地更新，如下所示:</p><figure class="kb kc kd ke fd kf"><div class="bz dy l di"><div class="lb lc l"/></div></figure><p id="ed22" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">相反，如果lambda函数不存在，那么两个资源都会被创建。您可以在AWS控制台上检查一切正常，方法是转到您的Lambda函数并查看它是否附加了一个层。</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lr"><img src="../Images/472e9032e29f9a3a86eb9ba6a5810954.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*V69BCY-8Z2fz_udC"/></div></div></figure><ul class=""><li id="ada9" class="ks kt hh je b jf km jj kn jn ln jr lo jv lp jz lq ky kz la bi translated">从AWS管理控制台:</li></ul><p id="3cc8" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">从管理控制台向Lambda添加层非常简单:</p><p id="8cb8" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">在左侧菜单中，选择层选项，</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div class="er es ls"><img src="../Images/c79a53f027487f03f8ed64cea4081898.png" data-original-src="https://miro.medium.com/v2/resize:fit:968/0*zTe9W1yWi2GEB-C7"/></div></figure><p id="0c33" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">选择右边的创建层，</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lt"><img src="../Images/329d3d86f1a53a29c0706cc1a796fa9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pOjxExeUM2SVkOe5"/></div></div></figure><p id="f1d9" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">并上传您在前面步骤中创建的zip文件。</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lu"><img src="../Images/4e7586c9530261d420050a5886634f82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gQ7aDsVP7NTQUkTg"/></div></div></figure><p id="6e7a" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">然后去你的功能，点击层</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lv"><img src="../Images/1a6ee6e4e21ddeab0a55170d78060465.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3M6j6WjLjj5hTrH6"/></div></div></figure><p id="a6f2" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">并选择添加层</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lt"><img src="../Images/5dacfce694596faa4289ecc8f087d07e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WlBJEnphxAG-RWAq"/></div></div></figure><p id="b427" class="pw-post-body-paragraph jc jd hh je b jf km jh ji jj kn jl jm jn ko jp jq jr kp jt ju jv kq jx jy jz ha bi translated">请注意，如果您的函数运行时不在您的层的兼容运行时中，您创建的层就不会出现。</p><h1 id="4f01" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">总结</h1><p id="9330" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">AWS Lambda函数是一个强大的工具，当向它们添加层时，它们的使用可能性得到了扩展。添加层简化了自定义函数的过程，并确保函数能够访问正确运行所需的库。因此，学习如何使用它们绝对是提升Lambda函数的必备技能。</p><h1 id="126d" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">附赠曲目</h1><p id="f689" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">为了创建zip文件，我的同事<a class="ae lw" href="https://co.linkedin.com/in/felipe-mej%C3%ADa-alvarez-54754899" rel="noopener ugc nofollow" target="_blank">费利佩·梅希亚</a>与我分享了他在bash中编写的脚本，以创建zip文件并将层发布到AWS。他无疑拯救了我的一周，在他的认可下，我们与你分享它，希望它也能拯救你的一周:</p><figure class="kb kc kd ke fd kf"><div class="bz dy l di"><div class="lb lc l"/></div></figure><h1 id="8ccd" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">参考</h1><ul class=""><li id="47bf" class="ks kt hh je b jf jg jj jk jn ku jr kv jv kw jz lq ky kz la bi translated"><a class="ae lw" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/lambda/latest/DG/configuration-layers . html</a></li><li id="10c5" class="ks kt hh je b jf lx jj ly jn lz jr ma jv mb jz lq ky kz la bi translated"><a class="ae lw" rel="noopener" href="/globant/connecting-to-sql-server-from-aws-lambda-docker-container-b474727522eb">https://medium . com/globant/connecting-to-SQL-server-from-AWS-lambda-docker-container-b 474727522 EB</a></li><li id="6700" class="ks kt hh je b jf lx jj ly jn lz jr ma jv mb jz lq ky kz la bi translated"><a class="ae lw" href="https://towardsdatascience.com/introduction-to-amazon-lambda-layers-and-boto3-using-python3-39bd390add17" rel="noopener" target="_blank">https://towards data science . com/introduction-to-Amazon-lambda-layers-and-boto 3-using-python 3-39bd 390 add 17</a></li><li id="ccb2" class="ks kt hh je b jf lx jj ly jn lz jr ma jv mb jz lq ky kz la bi translated"><a class="ae lw" href="https://www.globant.com/stay-relevant/partnerships/aws" rel="noopener ugc nofollow" target="_blank">AWS Globant (T1)</a></li></ul></div></div>    
</body>
</html>