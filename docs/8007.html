<html>
<head>
<title>Circuit Breakers in Solr and Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Solr和弹性研究中的断路器</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/circuit-breakers-in-solr-and-elastic-e568cd7b08fe?source=collection_archive---------5-----------------------#2021-05-12">https://medium.com/walmartglobaltech/circuit-breakers-in-solr-and-elastic-e568cd7b08fe?source=collection_archive---------5-----------------------#2021-05-12</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="5897" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">什么是断路器？</strong></h1><p id="53ae" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">Solr和Elasticsearch等搜索产品中添加了断路器，以防止可能导致内存不足错误或节点关闭的操作。断路器的前提是确保更高的服务质量，并且只接受在当前资源配置中可服务的请求负载。</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es ka"><img src="../Images/10e78afe89c22bd483de26e3a833cb75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r-pBY58a0nrmUZMYpqd_ew.png"/></div></div></figure><h1 id="a7e9" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">断路器在</strong>弹性搜索</h1><p id="60fb" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">弹性研究中的断路器由来已久，但它是基于建议的<strong class="je hi"> </strong>问题和改进而发展起来的。目前，在7.x版本的Elasticsearch中，我们有6个断路器:</p><ol class=""><li id="73c8" class="km kn hh je b jf ko jj kp jn kq jr kr jv ks jz kt ku kv kw bi translated">父断路器:父断路器异常是由跨不同类型断路器使用的所有内存的总和引起的。<strong class="je hi">indexes . breaker . total . use _ real _ memory default = true indexes . breaker . total . limit default = 95% JVM堆</strong></li><li id="e848" class="km kn hh je b jf kx jj ky jn kz jr la jv lb jz kt ku kv kw bi translated">字段数据断路器:当索引中的字段数据使用的内存总量超过阈值时，会导致字段数据断路器异常。默认情况下，文本字段上的字段数据设置为false，但如果在映射中定义了它，则可以使用它:" fielddata": <strong class="je hi"> true。indexes . breaker . field data . limit(默认值=40% JVM堆)</strong></li><li id="ba1e" class="km kn hh je b jf kx jj ky jn kz jr la jv lb jz kt ku kv kw bi translated">请求断路器:当对elasticsearch的一个请求试图使用超过指定阈值的内存时，会导致请求断路器异常。<strong class="je hi">indexes . breaker . request . limit(默认为JVM堆的60%)</strong></li><li id="436e" class="km kn hh je b jf kx jj ky jn kz jr la jv lb jz kt ku kv kw bi translated">传输中请求断路器:当传输或HTTP级别上所有当前活动的传入请求的内存使用量超过某个节点上的特定内存量时，会导致传输中断路器异常。<strong class="je hi">network . breaker . inflight _ requests . limit(默认为100%的JVM堆)</strong></li><li id="bd5b" class="km kn hh je b jf kx jj ky jn kz jr la jv lb jz kt ku kv kw bi translated">账户请求断路器:账户请求断路器异常是由于当请求完成时，内存中保存的东西没有被释放而导致的。<strong class="je hi">indexes . breaker . accounting . limit(默认为100%的JVM堆)</strong></li><li id="6723" class="km kn hh je b jf kx jj ky jn kz jr la jv lb jz kt ku kv kw bi translated">脚本编译断路器:当一段时间内的内联脚本编译数量超过阈值时，将触发脚本编译断路器异常。<strong class="je hi">(默认为75/5m，即每5分钟75次)</strong></li></ol><h1 id="c6fc" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">弹性搜索<strong class="ak">断路器状态</strong></h1><p id="0a29" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">命令检查:</p><p id="c416" class="pw-post-body-paragraph jc jd hh je b jf ko jh ji jj kp jl jm jn lc jp jq jr ld jt ju jv le jx jy jz ha bi translated"><strong class="je hi"> <em class="lf">获取_节点/统计/断路器</em> </strong></p><p id="b86a" class="pw-post-body-paragraph jc jd hh je b jf ko jh ji jj kp jl jm jn lc jp jq jr ld jt ju jv le jx jy jz ha bi translated">回应:</p><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es lg"><img src="../Images/1cc80d997ada90611a393af30a190f72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5FFDeMJiCfWx6i4r4AFFzQ.png"/></div></div></figure><h1 id="b76b" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated"><strong class="ak">弹性搜索中的断路器异常示例</strong></h1><pre class="kb kc kd ke fd lh li lj lk aw ll bi"><span id="7406" class="lm if hh li b fi ln lo l lp lq">[2020-11-02T07:11:45,611][WARN ][o.e.a.b.TransportShardBulkAction] [es-data-1-123456] [[tracking-2020.11][8]] failed to perform indices:data/write/bulk[s] on replica [tracking-2020.11][8], node[c3aC_s52RMe0xv0uzp02nQabc], [R], s[STARTED], a[id=Tgwiiu_GREOAnbKl7BI6Mgcv]<br/>org.elasticsearch.transport.RemoteTransportException: [es-data-3-123456][99.123.11.111:9300][indices:data/write/bulk[s][r]]<br/>Caused by: org.elasticsearch.common.breaker.CircuitBreakingException: <strong class="li hi">[parent]</strong> Data too large, data for [&lt;transport_request&gt;] would be [20293537836/18.8gb], which is larger than the limit of <strong class="li hi">[20293386240/18.8gb]</strong>, real usage: <strong class="li hi">[20293530192/18.8gb],</strong> new bytes reserved: [7644/7.4kb], usages [request=49320/48.1kb, fielddata=2665302366/2.4gb, in_flight_requests=2491948/2.3mb, accounting=162036398/154.5mb]</span></pre><p id="53ec" class="pw-post-body-paragraph jc jd hh je b jf ko jh ji jj kp jl jm jn lc jp jq jr ld jt ju jv le jx jy jz ha bi translated">关于诊断常见断路器错误<a class="ae lr" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/fix-common-cluster-issues.html#diagnose-circuit-breaker-errors" rel="noopener ugc nofollow" target="_blank">，请参考</a>。此外，还可以查看以下内容:</p><ol class=""><li id="8c91" class="km kn hh je b jf ko jj kp jn kq jr kr jv ks jz kt ku kv kw bi translated">启用慢速搜索和索引日志。</li><li id="de5f" class="km kn hh je b jf kx jj ky jn kz jr la jv lb jz kt ku kv kw bi translated">将Kibana默认索引从*(所有索引)更改为最相关的索引。这有助于避免对所有索引运行即席查询。</li><li id="b156" class="km kn hh je b jf kx jj ky jn kz jr la jv lb jz kt ku kv kw bi translated">根据使用情况适当设置每个数据节点的内存设置。建议将虚拟机总内存的50–70%分配给弹性搜索。</li><li id="ecdf" class="km kn hh je b jf kx jj ky jn kz jr la jv lb jz kt ku kv kw bi translated">检查并验证我们没有在大量存储桶上聚合的聚合查询。</li></ol><h1 id="3da6" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">Solr中的断路器</h1><p id="d921" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">Solr中的断路器是在Solr 8.7版本中引入的。与弹性搜索相比，Solr中的断路器是相当新的。当集群的稳定性比请求吞吐量更重要时，我们使用断路器。如果启用了断路器，在节点压力高的情况下，请求可能会被拒绝，并显示相应的HTTP错误代码(503)。</p><p id="86cf" class="pw-post-body-paragraph jc jd hh je b jf ko jh ji jj kp jl jm jn lc jp jq jr ld jt ju jv le jx jy jz ha bi translated">由客户机来处理这个错误，并可能建立一个重试逻辑。</p><p id="a856" class="pw-post-body-paragraph jc jd hh je b jf ko jh ji jj kp jl jm jn lc jp jq jr ld jt ju jv le jx jy jz ha bi translated">在Solr中，我们有两种断路器:</p><ol class=""><li id="cc72" class="km kn hh je b jf ko jj kp jn kq jr kr jv ks jz kt ku kv kw bi translated"><strong class="je hi">基于JVM堆使用的断路器</strong>:该断路器跟踪JVM堆内存使用，如果堆使用超过分配给JVM的最大堆的配置百分比(-Xmx)，则拒绝传入的搜索请求，并返回503错误代码。</li><li id="fa25" class="km kn hh je b jf kx jj ky jn kz jr la jv lb jz kt ku kv kw bi translated"><strong class="je hi">基于CPU利用率的断路器</strong>:该断路器跟踪CPU利用率，如果过去一分钟的平均CPU利用率超过可配置的阈值，则触发该断路器。</li></ol><h1 id="015f" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">Solr中的电路异常示例</h1><figure class="kb kc kd ke fd kf er es paragraph-image"><div role="button" tabindex="0" class="kg kh di ki bf kj"><div class="er es ls"><img src="../Images/0a10b71346d99c5ec2af6aaa4394c1b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IxJvDVVoiFd09y9D_EKryg.png"/></div></div></figure><h1 id="c2b7" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">摘要</h1><p id="5f0e" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">目前，与Solr中的断路器相比，Elasticsearch拥有更多数量的断路器和更多动态选项来控制断路器，从而实现更稳定、更有弹性的搜索服务。</p><h1 id="1891" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">参考</h1><ol class=""><li id="f573" class="km kn hh je b jf jg jj jk jn lt jr lu jv lv jz kt ku kv kw bi translated"><a class="ae lr" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/circuit-breaker.html" rel="noopener ugc nofollow" target="_blank">https://www . elastic . co/guide/en/elastic search/reference/7 . x/circuit-breaker . html</a></li><li id="ec5c" class="km kn hh je b jf kx jj ky jn kz jr la jv lb jz kt ku kv kw bi translated"><a class="ae lr" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/fix-common-cluster-issues.html#diagnose-circuit-breaker-errors" rel="noopener ugc nofollow" target="_blank">https://www . elastic . co/guide/en/elastic search/reference/7 . x/fix-common-cluster-issues . html # diagnose-circuit-breaker-errors</a></li><li id="161e" class="km kn hh je b jf kx jj ky jn kz jr la jv lb jz kt ku kv kw bi translated"><a class="ae lr" href="https://solr.apache.org/guide/8_7/circuit-breakers.html" rel="noopener ugc nofollow" target="_blank">https://solr.apache.org/guide/8_7/circuit-breakers.html</a></li></ol></div></div>    
</body>
</html>