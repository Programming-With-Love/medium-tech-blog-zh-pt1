<html>
<head>
<title>File processing with Apache Camel &amp; AWS services</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Apache Camel &amp; AWS服务进行文件处理</h1>
<blockquote>原文：<a href="https://medium.com/globant/file-processing-with-apache-camel-aws-services-6c18ee6c49f?source=collection_archive---------0-----------------------#2020-12-23">https://medium.com/globant/file-processing-with-apache-camel-aws-services-6c18ee6c49f?source=collection_archive---------0-----------------------#2020-12-23</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/7e77dcf155b60042803ace001cb2fcf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y0OnuFf23x8qcZPdv8Wk7w.png"/></div></div></figure><p id="31be" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这是我们的常规冲刺，直到我们得到一些文件处理即将到来的工作。我们认为这可能是我们过去工作的一些csv或xl文件处理工作，并开始检查初始jiras。</p><p id="2fb9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">所以我们有:-</p><ol class=""><li id="e0b6" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated">多个源系统每天生成一次不同的输入文件。</li><li id="7690" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">每个文件具有不同的结构，包含固定宽度的字符数据，页眉，页脚和行数不超过30k。</li><li id="ada7" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">要在某个位置上传的源文件和生成的输出文件。</li><li id="8add" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">能够针对失败的记录向运营团队发送电子邮件和/或任何其他通知。</li></ol><p id="0bc3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最初，我们认为解决方案应该如下所示，我们将代码捆绑成一个jar，在服务器上运行，可能带有cron作业或独立的应用程序。也许我们可以添加一些消息队列。</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div class="er es kb"><img src="../Images/ddc6f3c8d39012dca1c44cbab83160c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/0*Kz6SH1kJvETvxIsY"/></div></figure><p id="9b24" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">但我们应该在现有的AWS客户端基础设施上构建云原生应用。这不是解决安全(目录许可、SMTP、数据库访问)成本和存储的完美解决方案，也没有使用任何现有的AWS服务。</p><p id="537c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">此外，由于文件具有固定宽度的字符，没有任何分隔符，即使是POI或Spring批处理也无法适应。</p><p id="5bc3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">那么这个怎么解决呢？在这里我们开始学习关于<a class="ae kg" href="https://camel.apache.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="ir hi">阿帕奇骆驼</strong> </a>和<a class="ae kg" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ir hi"> AWS </strong> </a>服务的新概念。</p></div><div class="ab cl kh ki go kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="ha hb hc hd he"><p id="3669" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">首先，这是EIP<strong class="ir hi">和骆驼</strong> ( <a class="ae kg" href="https://www.enterpriseintegrationpatterns.com/patterns/messaging/" rel="noopener ugc nofollow" target="_blank"> <strong class="ir hi">企业整合模式</strong> </a>)的完美案例，为什么？</p><ul class=""><li id="2695" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm ko jt ju jv bi translated">Camel提供了精通的API来支持不同的源/目的地端点，因此您可以轻松地集成和更改。端点可以是任何ftp位置、jms端点，甚至是AWS S3存储桶。</li><li id="8572" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm ko jt ju jv bi translated">它有<a class="ae kg" href="https://camel.apache.org/components/latest/aws-s3-component.html" rel="noopener ugc nofollow" target="_blank"> AWS S3组件</a>，该组件为从读取和写入AWS S3处理文件提供了出色的支持。</li><li id="0a65" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm ko jt ju jv bi translated"><a class="ae kg" href="https://camel.apache.org/components/latest/dataformats/bindy-dataformat.html" rel="noopener ugc nofollow" target="_blank"> Camel Bindy </a>支持不同的文件格式，包括固定宽度(这是我们的用例)，这有助于避免任何样板代码来解析分隔文件、页眉、页脚等。</li><li id="12f1" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm ko jt ju jv bi translated">使用Camel，您可以轻松地编写Junits来测试文件处理代码。</li><li id="0a7b" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm ko jt ju jv bi translated">我们还观察到Camel有很好的社区支持，我们的一个文件编码问题得到了及时的回应。<a class="ae kg" href="http://camel.465427.n5.nabble.com/Character-encoding-lost-when-using-Camel-AWS2S3Endpoint-td5890047.html" rel="noopener ugc nofollow" target="_blank">链接</a></li></ul><p id="91f4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">到目前为止还不错，但是接下来我们必须决定如何调用文件处理代码或者在AWS上部署。为了部署应用程序，我们有两个选择，使用<strong class="ir hi"> AWS ECS(弹性容器服务)</strong> : <strong class="ir hi"> EC2 </strong>(弹性计算云)或<strong class="ir hi"> Fargate </strong>。</p></div><div class="ab cl kh ki go kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="ha hb hc hd he"><p id="3039" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一般来说，ECS是制作容器化应用程序并在EC2集群上运行它的好选择，你可以参考AWS文档<a class="ae kg" href="https://aws.amazon.com/ecs/?whats-new-cards.sort-by=item.additionalFields.postDateTime&amp;whats-new-cards.sort-order=desc&amp;ecs-blogs.sort-by=item.additionalFields.createdDate&amp;ecs-blogs.sort-order=desc" rel="noopener ugc nofollow" target="_blank">链接</a>。ECS在您自己的亚马逊VPC中启动您的容器，允许您使用您的VPC安全组和网络ACL。没有与其他客户共享计算资源。您还可以使用IAM为每个容器分配粒度访问权限，以限制对每个服务的访问以及容器可以访问的资源。</p><p id="ad42" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">Amazon EC2提供了最广泛、最深入的计算平台，可选择处理器、存储、网络、操作系统和购买模式。</p><p id="9b0e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">决定采用EC2方法，因为出于安全原因，客户团队更喜欢控制EC2的配置，并且EC2定价模式更具成本效益。这篇文章完美地描述了它们之间的区别<a class="ae kg" href="https://containersonaws.com/introduction/ec2-or-aws-fargate/" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><p id="fd86" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">但下一个问题是，我们如何运行这些ECS任务？接下来是AWS Lambda和S3通知事件。</p><p id="0779" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><a class="ae kg" href="https://www.amazonaws.cn/en/lambda/" rel="noopener ugc nofollow" target="_blank"> <strong class="ir hi"> AWS Lambda </strong> </a>是一个事件驱动的无服务器计算平台，由亚马逊提供，作为亚马逊网络服务的一部分。它是一种计算服务，运行代码以响应事件，并自动管理该代码所需的计算资源。Lambda的最大执行时间跨度为15分钟，因为它是无服务器的，所以我们只为执行时间付费，并根据请求的数量，为lambda函数分配内存。</p><p id="4646" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">对于存储文件，显而易见的选择是亚马逊简单存储服务——S3。它是一种对象存储服务，可提供行业领先的可扩展性、数据可用性、安全性和性能。它还支持版本控制，并根据业务需求提供各种存储类别。查看详情<a class="ae kg" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank">此处</a></p><p id="7ed8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">亚马逊S3通知功能使您能够在您的存储桶中发生特定事件时接收通知。要启用通知，您必须首先添加通知配置，以确定您希望亚马逊S3发布的事件以及您希望亚马逊S3发送通知的目的地。</p><p id="a5b8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这正是我们所需要的，因此我们没有使用池化并等待文件到达，而是使用了“新对象创建的S3事件”,因此一旦文件到达S3存储桶，它就会触发lambda函数(我们使用Java代码，但它可以用python或AWS支持的其他语言编写),进而异步运行ECS任务。</p><p id="6f47" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">希望下图能清楚地解释最终的端到端流程。</p><figure class="kc kd ke kf fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kp"><img src="../Images/2816ae1664493aba48d2d99cdd3ff433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2NOplN6_nOfGlQ0r"/></div></div></figure><p id="48ee" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">对于电子邮件通知，我们计划使用AWS简单电子邮件服务，这是一种经济高效、灵活且可扩展的电子邮件服务，使开发人员能够从任何应用程序中发送邮件。</p></div><div class="ab cl kh ki go kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="ha hb hc hd he"><p id="76ab" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">我们面临的挑战:- </strong></p><ol class=""><li id="622b" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated">如果你是第一次使用，Apache Camel有一个学习曲线，并且有不同的方法来达到相同的结果(XML与注释，不同的bindy格式，异常处理)，所以调试和提出一个运行模型有点乏味。</li><li id="5210" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">在AWS开发环境中测试整个流程非常耗时，但幸运的是，我们使用了<a class="ae kg" href="https://github.com/localstack/localstack" rel="noopener ugc nofollow" target="_blank"> <strong class="ir hi"> Localstack </strong> </a>来模拟我们本地机器上的AWS设置，这大大加快了我们的测试速度。同样，如果你必须在Windows机器上运行localstack会有一些问题，但是我们可以用docker桌面来管理它。</li><li id="6559" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">我们在保留文件中的重音字符时遇到了一个问题，Camel APIs中的一个错误在3.6.0版本中得到修复，但在AWS上仍然不能正常运行。经过进一步的测试，我们可以通过将AWS平台的默认lang改为LANG=en_US来解决这个问题。UTF-8。</li><li id="acd3" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">之前，我们没有为camel代码设置任何超时，以便在文件处理完成后立即结束，这会导致多个ECS任务在后台运行。但是在我们指定camel配置的最大空闲时间后，我们可以解决这个问题。</li><li id="b71f" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">对于一些复杂的文件，我们最近观察到串行文件处理有点慢，所以现在我们增加了Camel提供的并行处理支持，在这里阅读更多关于线程模型<a class="ae kg" href="https://camel.apache.org/manual/latest/threading-model.html" rel="noopener ugc nofollow" target="_blank"/>。</li><li id="7c3f" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">最近，我们必须读取并生成一个大文件(&gt; 1.5 Gb)，为此我们必须使用getByteRange/multipart upload S3 API。你可以在我的同事<a class="ae kg" rel="noopener" href="/globant/large-file-processing-using-apache-camel-with-aws-s3-37c6633082cd">写的这篇文章</a>中读到更多的细节</li></ol><p id="7f4e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这就是我们最终如何用Camel和AWS服务简化文件处理的，希望你喜欢这篇文章。</p><p id="c7ae" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你有任何问题/意见，请给我留言！</p></div></div>    
</body>
</html>