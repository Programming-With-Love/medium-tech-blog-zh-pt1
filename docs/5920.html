<html>
<head>
<title>Using the External Secrets Operator with OCI Kubernetes and OCI Vault</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">对OCI·库伯内特和OCI·库使用外部机密操作符</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/using-the-external-secrets-operator-with-oci-kubernetes-and-oci-vault-6865f2e1fe35?source=collection_archive---------0-----------------------#2022-06-01">https://medium.com/oracledevs/using-the-external-secrets-operator-with-oci-kubernetes-and-oci-vault-6865f2e1fe35?source=collection_archive---------0-----------------------#2022-06-01</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="15e4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一位客户最近向我推荐了<a class="ae jc" href="https://external-secrets.io/v0.5.3/" rel="noopener ugc nofollow" target="_blank">外部秘密运营商(ESO)项目</a>，我很高兴地看到它已经将<a class="ae jc" href="https://external-secrets.io/v0.5.3/provider-oracle-vault/" rel="noopener ugc nofollow" target="_blank">与</a><a class="ae jc" href="https://docs.oracle.com/en-us/iaas/Content/KeyManagement/home.htm#top" rel="noopener ugc nofollow" target="_blank"> OCI金库</a>集成在一起。在本文中，我们将尝试一下ESO，看看如何将它与OKE结合使用。</p><h2 id="3874" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">在OKE上安装外部机密操作符</h2><p id="af14" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">首先，使用OCI控制台中的快速创建或使用<a class="ae jc" href="https://github.com/oracle-terraform-modules/terraform-oci-oke" rel="noopener ugc nofollow" target="_blank">https://github . com/Oracle-terra form-modules/terra form-OCI-OKE</a>创建一个OKE集群。现在，您可以使用Cloud Shell或terraform-oci-oke模块中的操作员主机来运行kubectl或helm命令。</p><p id="6aaa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们使用舵图来安装ESO:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="6cf1" class="jd je hh ki b fi km kn l ko kp">helm repo add external-secrets <a class="ae jc" href="https://charts.external-secrets.io" rel="noopener ugc nofollow" target="_blank">https://charts.external-secrets.io</a></span><span id="4325" class="jd je hh ki b fi kq kn l ko kp">helm install external-secrets \<br/>  external-secrets/external-secrets \<br/>  -n external-secrets \<br/>  --create-namespace</span></pre><h2 id="bb3b" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">配置ESO以用于OCI保险库</h2><p id="af19" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">如果您是使用<a class="ae jc" href="https://docs.oracle.com/en-us/iaas/Content/Identity/Tasks/callingservicesfrominstances.htm" rel="noopener ugc nofollow" target="_blank"> instance_principal </a>的<strong class="ig hi">而不是</strong>，请在yaml文件中创建一个Kubernetes秘密来保存私钥和指纹:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="1231" class="jd je hh ki b fi km kn l ko kp">apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: pk-fp<br/>  labels:<br/>    type: oracle<br/>type: Opaque<br/>stringData:<br/>  privateKey: |<br/>    -----BEGIN RSA PRIVATE KEY-----<br/>    abcdefg1234567890/+-<br/>    -----END RSA PRIVATE KEY-----<br/>  fingerprint: ab:cd:ef:gh:12:34</span></pre><p id="9a6b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">创造秘密:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="e32f" class="jd je hh ki b fi km kn l ko kp">kubectl create -f pk-fp.yaml</span></pre><p id="49fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您现在可以创建秘密商店:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="4b07" class="jd je hh ki b fi km kn l ko kp">apiVersion: external-secrets.io/v1beta1<br/>kind: SecretStore<br/>metadata:<br/>  name: alivault<br/>spec:<br/>  provider:<br/>    oracle:<br/>      vault: # The vault OCID<br/>      region: # The vault region<br/>      auth:<br/>        user: # A user OCID<br/>        tenancy: # A user's tenancy<br/>        secretRef:<br/>          privatekey:<br/>            name: pk-fp<br/>            key: privateKey<br/>          fingerprint:<br/>            name: pk-fp<br/>            key: fingerprint</span></pre><p id="c3d6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意:如果您使用instance_principals，请删除从<em class="kr"> auth </em>到结尾的部分。您还需要创建一个动态组，并向其中添加工作节点。最后，您还需要创建一个策略，允许动态组使用您将在OCI保险库中创建的密钥。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="1cbb" class="jd je hh ki b fi km kn l ko kp">kubectl create -f oci-secret-store.yaml</span></pre><h2 id="b2e3" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">创建外部Secret</h2><p id="e5bf" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">现在让我们使用ESO创建一个ExternalSecret:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="f812" class="jd je hh ki b fi km kn l ko kp">apiVersion: external-secrets.io/v1beta1<br/>kind: ExternalSecret<br/>metadata:<br/>  name: oci-secret<br/>spec:<br/>  refreshInterval: 0.03m<br/>  secretStoreRef:<br/>    kind: SecretStore<br/>    name: alivault # Must match SecretStore on the cluster<br/>  target:<br/>    name: my-oke-secret # Name for the secret on the cluster<br/>    creationPolicy: Owner<br/>  data:<br/>  - secretKey: key<br/>    remoteRef:<br/>      key: my-eso-secret</span></pre><p id="1428" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我的-eso-secret是金库中OCI秘密的名字:</p><figure class="kd ke kf kg fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es ks"><img src="../Images/3463472b7640be6a901664c096f3ace6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5HnTJEdEVh4U3NDO6Y4KSg.png"/></div></div></figure><p id="4838" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这种情况下，它只有一个普通的内容(“aSecretInSiV”)，所以我们使用上面的数据，我们可以创建ExternalSecret:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="e831" class="jd je hh ki b fi km kn l ko kp">kubectl create -f ext-secret.yaml</span></pre><p id="d8e2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">获取外部秘密:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="2956" class="jd je hh ki b fi km kn l ko kp">kubectl get es<br/>NAME         STORE      REFRESH INTERVAL   STATUS<br/>oci-secret   alivault   0.03m              SecretSynced</span></pre><p id="2597" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们可以看到秘密已经被同步了。让我们列出这个名称空间中的秘密:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="a391" class="jd je hh ki b fi km kn l ko kp">kubectl get secrets<br/>NAME                  TYPE                                DATA   AGE<br/>default-token-mnpsm   kubernetes.io/service-account-token   3    41m<br/>my-oke-secret         Opaque                                1   108s<br/>pk-fp                 Opaque                                2    10m</span></pre><p id="1774" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们可以看到<em class="kr"> my-oke-secret </em>已经创建。让我们来一窥其中的秘密:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="1c68" class="jd je hh ki b fi km kn l ko kp">kubectl get secret my-oke-secret -o yaml<br/>apiVersion: v1<br/>data:<br/>  key: YVNlY3JldEluU2lW<br/>immutable: false<br/>kind: Secret<br/>metadata:<br/>  annotations:<br/>    reconcile.external-secrets.io/data-hash: cff53a4bddfc2d04ea50e6d0da2c2868<br/>  creationTimestamp: "2022-06-01T02:11:43Z"<br/>  name: my-oke-secret<br/>  namespace: default<br/>  ownerReferences:<br/>  - apiVersion: external-secrets.io/v1beta1<br/>    blockOwnerDeletion: true<br/>    controller: true<br/>    kind: ExternalSecret<br/>    name: oci-secret<br/>    uid: 0039c7ab-91c2-4e15-acc7-f8de87ba1254<br/>  resourceVersion: "9117"<br/>  uid: 3074d172-078f-4214-9f21-a6bc69aae182<br/>type: Opaque</span></pre><p id="2501" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们可以看到密钥已经创建。让我们提取它，看看它是否与我们在《OCI的秘密》中创造的相匹配:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="0af2" class="jd je hh ki b fi km kn l ko kp">kubectl get secret my-oke-secret -o json | jq -r ."data.key" | base64 -d<br/>aSecretInSiV</span></pre><p id="edbe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">非常好。这个吻合！</p><h2 id="b27c" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">更新秘密</h2><p id="f791" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">现在让我们看看它是否能处理更新。在OCI的秘密中，让我们创造一个新的版本:</p><figure class="kd ke kf kg fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es la"><img src="../Images/9e7c7201567d418858446175c0102b54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HiyPWqhnPnJp3Eqj7oZZ3Q.png"/></div></div></figure><p id="5193" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">等待版本2处于活动状态，然后再次运行上面的命令来提取密码:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="0047" class="jd je hh ki b fi km kn l ko kp">kubectl get secret my-oke-secret -o json | jq -r ."data.key" | base64 -d<br/>SecretVersion2</span></pre><p id="92a9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Kubernetes秘密中的值已更新。</p><h2 id="6fd1" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">将ESO与群集中的另一个应用程序一起使用</h2><p id="21e5" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">让我们看看如何使用ESO将秘密注入集群中运行的其他应用程序。在这种情况下，我们将尝试向Grafana中注入一个密码。</p><p id="6f5b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">添加Grafana helm repo:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="80e7" class="jd je hh ki b fi km kn l ko kp">helm repo add grafana https://grafana.github.io/helm-charts</span><span id="c92d" class="jd je hh ki b fi kq kn l ko kp">helm show values <!-- -->grafana/grafana<!-- --> &gt; grafana.yaml</span></pre><p id="c9d7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">编辑grafana.yaml并找到管理员凭据部分:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="c964" class="jd je hh ki b fi km kn l ko kp">admin:<br/>  ## Name of the secret. Can be templated.<br/>  existingSecret: "grafana-in-eso"<br/>  userKey: admin-user<br/>  passwordKey: admin-password</span></pre><p id="71cf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将existingSecret更改为如上(或您选择的值)。</p><p id="c85e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，在OCI保险库中创建一个秘密，如下所示:</p><figure class="kd ke kf kg fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es lb"><img src="../Images/4d241aeb0e5506231e8fd59d72371be7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*afV0_FyhW8iYqBIpa4nYbA.png"/></div></div></figure><p id="8404" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们现在可以使用上面的代码创建一个ExternalSecret:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="f13b" class="jd je hh ki b fi km kn l ko kp">apiVersion: external-secrets.io/v1beta1<br/>kind: ExternalSecret<br/>metadata:<br/>  name: oci-secret<br/>spec:<br/>  refreshInterval: 0.03m<br/>  secretStoreRef:<br/>    kind: SecretStore<br/>    name: alivault<br/>  target:<br/>    name: grafana-in-eso<br/>    creationPolicy: Owner<br/>  dataFrom:<br/>  - extract:<br/>      key: grafana</span></pre><p id="0f8e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在让我们部署Grafana:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="a8db" class="jd je hh ki b fi km kn l ko kp">helm install grafana grafana/grafana -f grafana.yaml</span></pre><p id="7f03" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">转到Grafana吊舱的左舷:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="16ce" class="jd je hh ki b fi km kn l ko kp">export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=grafana,app.kubernetes.io/instance=grafana" -o jsonpath="{.items[0].metadata.name}")</span><span id="5926" class="jd je hh ki b fi kq kn l ko kp">kubectl --namespace default port-forward $POD_NAME 3000</span></pre><figure class="kd ke kf kg fd kt er es paragraph-image"><div class="er es lc"><img src="../Images/f2810c0ebbf5b6651cb7c148f8eccb14.png" data-original-src="https://miro.medium.com/v2/resize:fit:972/format:webp/1*liHhCWZXLl7wQZXzb0R5SA.png"/></div></figure><p id="848b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，我们现在使用的是在OCI保险库中创建的值。我们能够登录。</p><p id="159f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">假设我们现在想要更改管理员用户名和密码。在OCI秘密中创建新版本:</p><figure class="kd ke kf kg fd kt er es paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="er es ld"><img src="../Images/756d1cf3f8591e0f29106a94f3a56588.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Gv4J9aiZmLpGfAwujTpSQ.png"/></div></div></figure><p id="8c6a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">激活后，再次登录:</p><figure class="kd ke kf kg fd kt er es paragraph-image"><div class="er es le"><img src="../Images/7bdc27d832c5484901857d3e4eaa506b.png" data-original-src="https://miro.medium.com/v2/resize:fit:952/format:webp/1*1T40wwxf9CIqjhIfFijXLQ.png"/></div></figure><p id="6348" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这将失败。原因是当Grafana pod被创建时，它读取密码并使用密码中的admin-username和admin-password值，并将其存储在配置文件中。所以现在，即使OCI秘密和库伯内特秘密的价值观已经改变，格拉法纳还没有意识到这一点。</p><p id="b441" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了使用新的值，我们必须更新这个文件。我们可以使用Grafana的REST API，但我不知道Grafana是否有监听机制来监视秘密变化(这是将来要调查的事情)。目前，强制重新加载用户名和密码的最简单方法是删除Grafana pod，以强制Kubernetes重新创建它:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="4bbd" class="jd je hh ki b fi km kn l ko kp">kubectl delete pod $POD_NAME</span></pre><p id="02b6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您会注意到创建了一个新的pod:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="fac7" class="jd je hh ki b fi km kn l ko kp">kubectl get pods<br/>NAME                       READY   STATUS              RESTARTS  AGE<br/>grafana-788976bc4c-q2swm   0/1     ContainerCreating   0         8s</span></pre><p id="32cb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">等待它准备好，并使用您在secret版本2中使用的值将它转发到端口。这一次，您将能够登录到Grafana。</p><p id="ef7f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注意</strong>:这不是更新Grafana用户名和密码的推荐方式。这个例子的目的是展示在一个应用程序中通过ESO从OCI保险库重新装载秘密。</p><h2 id="d909" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">摘要</h2><p id="7dcd" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">外部秘密运营商是一个很好的方式来整合和使用OCI奥凯与OCI保险库。OKE和在OKE中运行的应用程序都可以使用ESO从OCI保险库中检索敏感数据。</p><p id="1220" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我希望这篇文章对你有用。</p><p id="1cc7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">想讨论一下吗？加入我们的<a class="ae jc" href="https://bit.ly/devrel_slack" rel="noopener ugc nofollow" target="_blank">公共休闲频道</a>！</p></div></div>    
</body>
</html>