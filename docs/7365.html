<html>
<head>
<title>Making the Invisible Visible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让不可见的变得可见</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/making-the-invisible-visible-a-look-at-building-tools-for-square-developers-bae30a212950?source=collection_archive---------3-----------------------#2019-01-09">https://medium.com/square-corner-blog/making-the-invisible-visible-a-look-at-building-tools-for-square-developers-bae30a212950?source=collection_archive---------3-----------------------#2019-01-09</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="6c34" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">Square开发人员的构建工具</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/187249eeb9bf2111ed5349d825cf1bcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*v_kkQ3GaJJrtzeJm"/></div></div></figure><blockquote class="ji jj jk"><p id="0dad" class="jl jm jn jo b jp jq ii jr js jt il ju jv jw jx jy jz ka kb kc kd ke kf kg kh ha bi translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae ki" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><p id="37b5" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">在Square，开发人员团队公开了允许第三方开发人员构建定制业务处理解决方案的API。10月18日，我们向使用我们API的开发者宣布，webhooks现在将支持重试。如果一个webhook无法交付，我们的系统现在将能够重试多次，直到成功交付。</p><p id="64e8" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">Square的webhook交付系统是一项我称之为Webhooks的服务。提高Webhooks的可靠性是我作为一名大学毕业生在Square开始工作的第一周有机会深入研究的一个项目。从一开始，我们就希望我们的Webhooks升级不需要我们的外部开发人员做任何改变，这与项目中的大量研究、规划和工作形成了鲜明的对比。事实上，我们发出的公告向开发者保证，他们<em class="jn">“不需要做任何改变来支持重试webhooks。</em>“我的经理说这是“有史以来最看不见的变化”——本来就应该如此。我们团队的重点是让开发人员能够轻松地与Square的API集成，并为他们提供可靠且易于使用的体验。也许是我的经理对我们的“无形”项目的评论启发了我，让我不仅分享了我们的webhooks可靠性项目，还分享了我们在Square的一些“可见性”实践。</p><h2 id="a4af" class="km kn hh bd ko kp kq kr ks kt ku kv kw kj kx ky kz kk la lb lc kl ld le lf lg bi translated">Webhooks</h2><p id="05b7" class="pw-post-body-paragraph jl jm hh jo b jp lh ii jr js li il ju kj lj jx jy kk lk kb kc kl ll kf kg kh ha bi translated">在web开发中，webhooks被定义为由特定事件触发的代码片段(HTTP回调)。一旦事件发生，开发人员就会收到通知，并可以实时处理它。使用传统的API，开发人员可能必须不断轮询端点以检测事件。我想介绍我们在Square是如何设计Webhooks的，以及我们为提高可靠性所做的改变。如果你想在Square上了解更多关于Webhooks的技术细节，请查看我们的<a class="ae ki" rel="noopener" href="/square-corner-blog/reliable-webhooks-using-serverless-architecture-e009a2096732">早期博客文章</a>。解释webhooks最吸引人的方式是通过Square的基础设施跟踪单个webhook通知的生命周期。</p><p id="a3c4" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">假设我拥有一家名为“呼唤的笑骆驼”的在线商店，它使用Square的API。运行我的在线商店的应用程序接收来自Square的webhook通知。当一位喜爱美洲驼的顾客从呼唤的笑驼那里购买了一只美洲驼时，我会收到一个webhook通知，告诉我有人刚刚付款了。从购买到收到通知，发生了很多事情，将这个支付“事件”转换成我收到的webhook通知。客户购买骆驼后，支付事件被发布到一个feed，Square的许多内部服务都会读取这个feed。我们团队拥有的Webhooks服务从提要中读取这个支付事件，将这个事件转换成webhook通知，并将这个通知传递给呼唤的Laughing Llamas应用程序指定的端点。但是，在高流量期间，事件可能会堆积在提要中，后续通知可能会延迟。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/ad7585010ed842bb347a6051c0e6cc63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZFL6zIjDXdAgFqzF"/></div></div></figure><p id="4146" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">直觉上，我们需要一种方法来将事件的读取和通知的发送分开。虽然有许多方法可以解决这个问题，但是最简单的方法是创建单独的线程池，用于从提要中读取事件和发送通知。我们的解决方案是使用<a class="ae ki" href="https://aws.amazon.com" rel="noopener ugc nofollow" target="_blank">亚马逊网络服务(AWS) </a>将我们的Webhooks交付机制转移到云中。我们将Webhooks迁移到云的主要动机是降低Square的系统复杂性和成本(而不是在我们自己的数据中心维护Webhooks)。我们可以通过使用记录良好且常用的云基础设施来提高Webhooks的可靠性。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/524c0fcee28e9c62d0c4e57b7716645f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ATj88vvFmJxVubqL"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx"><em class="lq">Using AWS allows Webhooks to decouple event reading and notification delivery.</em></figcaption></figure><p id="b70b" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">在我们新的webhooks系统中，呼唤的笑羊驼支付事件变成webhooks通知的生命周期略有变化。在客户购买了一只美洲驼之后，支付事件被发布到一个提要上，我们的Webhooks服务会像以前一样读取它。一旦事件被转换成webhook通知，我们的服务就会将通知作为消息发送给AWS。我们在AWS中的工具包含将消息传递到呼唤笑羊驼的应用服务器的逻辑。如果呼唤的笑羊驼花了太长时间来响应信息，或者无法在递送时记录信息，AWS将重试。在每一次后续传递尝试中，AWS都会增加重试间隔时间；这种回退策略确保消息会不断重试，而不会使服务器不堪重负。此外，AWS会将所有交付尝试的指标发送回Square。</p><p id="9807" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">最终结果？呼唤的Laughing Llamas应用程序的开发者可以停止轮询Square的API，因为webhook通知会及时到达。如果应用服务器很忙，开发人员不必担心错过通知，因为会重试通知。从开发人员的角度来看，获得新的及时通知和重试是不必要的。</p><h2 id="ba29" class="km kn hh bd ko kp kq kr ks kt ku kv kw kj kx ky kz kk la lb lc kl ld le lf lg bi translated">能见度和影响</h2><p id="876f" class="pw-post-body-paragraph jl jm hh jo b jp lh ii jr js li il ju kj lj jx jy kk lk kb kc kl ll kf kg kh ha bi translated">这个项目结束时让我惊讶的是它在Square以及其他项目中的可见性。在发布的前一天，我们向全公司发送了产品更新电子邮件。我的团队仔细地梳理了旧的电子邮件、工作项目和文档注释，给我留下了深刻的印象。从代码审查到设计建议，这些人的贡献没有被遗忘。几分钟后，邮件收到了“回复所有人”，表达了祝贺，并提供了更好的webhooks对Square开发者平台的影响的背景。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lr"><img src="../Images/6631ac94833859ce1d8f369559bb2084.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7NKgdUtHisWz8Nm5"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx"><em class="lq">A “Product Updates” email sent to everyone at Square.</em></figcaption></figure><p id="8c16" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">我的团队也有机会分享我们的学习经验。开发人员团队每两周召开一次“午餐和学习”会议，我们在会上介绍新技术、框架以及我们正在开发的各种服务和项目。这些午餐和学习会议突出了Square对组织内部知识共享的重视。通过建立对Webhooks和我们团队采用的技术的认识，我们最密切合作的团队可以利用我们的学习经验来开发他们自己的项目。</p><p id="067e" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">哦，Webhooks不仅仅是可见的，它也是可闻的。发布后，敲响锣是Square的传统，我们让办公室响亮而清晰地知道我们发布了新的产品。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es ls"><img src="../Images/920ff9caa6c8799e2484040ce6b016b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EcG08hnsyQjGKaq2"/></div></div><figcaption class="lm ln et er es lo lp bd b be z dx"><em class="lq">Ringing the gong after launching a better Webhooks.</em></figcaption></figure><p id="cb1a" class="pw-post-body-paragraph jl jm hh jo b jp jq ii jr js jt il ju kj jw jx jy kk ka kb kc kl ke kf kg kh ha bi translated">能够在Square内外分享我们的知识和学习经验是很有意义的，但是听到来自我们开发人员的反馈也同样重要。一位开发人员赞赏我们的后退重试策略，因为它避免了“在服务器遇到困难时敲打它”在我们推出改进的Webhooks后的一周内，我们成功地发送了超过31，000个第一次发送失败的通知。能够迅速对Webhooks产生影响——作为一名仍在学习诀窍的新员工——激励我继续改进Webhooks，并开始其他项目，这些项目不仅帮助我们虚构的呼唤的笑骆马，还帮助希望使用Square无缝处理在线和面对面支付的现实世界开发者。</p></div></div>    
</body>
</html>