# ä½¿ç”¨ Datreeã€AWS CodeBuild å’Œ Terraform è‡ªåŠ¨æ‰§è¡Œ K8s ç­–ç•¥æ£€æŸ¥

> åŸæ–‡ï¼š<https://medium.com/globant/automate-k8s-policy-checks-using-datree-aws-codebuild-and-terraform-ea3ae76b7277?source=collection_archive---------0----------------------->

# **ç®€ä»‹**

G itops æ˜¯ä¼˜åŒ– Kubernetes é›†ç¾¤ä¸­åº”ç”¨ç”Ÿå‘½å‘¨æœŸçš„æœ€ä½³ç­–ç•¥ä¹‹ä¸€ã€‚å®ƒçš„åŸºç¡€åœ¨äºä»¥å£°æ˜çš„æ–¹å¼å®šä¹‰ Git å­˜å‚¨åº“ä¸­åº”ç”¨ç¨‹åºå’Œé›†ç¾¤é…ç½®çš„æœŸæœ›çŠ¶æ€ã€‚é‡‡ç”¨åŸºäº [GitOps practices](https://www.weave.works/technologies/gitops/) çš„éƒ¨ç½²å·¥ä½œæµå°†ä½¿æˆ‘ä»¬å—ç›Šï¼ŒåŒ…æ‹¬ç‰ˆæœ¬æ§åˆ¶ã€æ›´ç®€å•çš„å®‰å…¨æ€§ã€å®¡è®¡å’Œåˆè§„æ€§æ§åˆ¶è‡ªåŠ¨åŒ–ã€æ›´å¼ºçš„ç¨³å®šæ€§å’Œä¸€è‡´æ€§ã€æ›´å¿«çš„éƒ¨ç½²ä»¥åŠä¿ƒè¿›åä½œè´¡çŒ®ï¼Œç­‰ç­‰ã€‚

> "æ‰‹åŠ¨é…ç½®ä¸­å‘ç”Ÿçš„äº‹æƒ…ï¼Œå°†ä¿ç•™åœ¨æ‰‹åŠ¨é…ç½®ä¸­."â€œä¸€åˆ‡å¦‚ä»£ç æ˜¯å…³é”®ï¼ŒGitOps å®è·µè§£å†³æ–¹æ¡ˆã€‚â€

æ ¹æ®å…·ä½“æƒ…å†µï¼Œå­˜å‚¨åº“ä¸­çš„ç‰ˆæœ¬åŒ–ä»£ç å¯ä»¥æ˜¯ Kubernetes åœ¨ Kustomizeã€Helm Charts ä¸­å®šä¹‰çš„åº”ç”¨ç¨‹åºï¼Œæˆ–è€…ä»…ä»…æ˜¯ YAML æ–‡ä»¶ä¸­çš„æ¸…å•ï¼Œè¿™äº›æ–‡ä»¶å°†æ˜¯ GitOps è¿ç»­äº¤ä»˜å·¥å…·çš„ç†æƒ³æ¥æºï¼Œè¿™äº›å·¥å…·ä¸“æ³¨äºè‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œä»¥ç¡®ä¿æ‰€éœ€çš„å£°æ˜çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œ [ArgoCD](https://argo-cd.readthedocs.io/en/stable/) å’Œ [FluxCD](https://fluxcd.io/) æ”¯æŒå„ç§æœ‰è¶£çš„åŸºäºåˆ†æ”¯ã€æ ‡ç­¾ã€æ–‡ä»¶å¤¹ç­‰çš„å¤šé›†ç¾¤å’Œå¤šç¯å¢ƒéƒ¨ç½²ç­–ç•¥ã€‚

åœ¨å°†å˜æ›´é›†æˆåˆ°ä¸»åˆ†æ”¯ä¹‹å‰ï¼Œå¦‚ä½•ä¿è¯é«˜ä»£ç è´¨é‡ï¼Ÿé«˜ä»£ç è´¨é‡åŒ…æ‹¬éµå®ˆå®‰å…¨ç­–ç•¥ä»¥åŠè¯­æ³•å’Œè¯­ä¹‰éªŒè¯ã€‚

å—¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¿¡ä»»â€¦æˆ–è€…æ›´å¥½ï¼Œæˆ‘ä»¬å¯ä»¥**ä¿¡ä»»ï¼Œä½†ä»¥è‡ªåŠ¨æ–¹å¼éªŒè¯**ã€‚ğŸš€

è®©æˆ‘ä»¬é€šè¿‡ GitOps å®è·µå’Œä½¿ç”¨ä¸€äº› GitOps å·¥å…·æ¥æ¢ç´¢ä¸€ç§æ— é™çš„æ–¹æ³•æ¥è‡ªåŠ¨åŒ–è¿™äº›éªŒè¯ã€‚

æœ¬æ–‡å°†å›é¡¾ä»¥ä¸‹éƒ¨åˆ†:

*   æ¶æ„æ¦‚è¿°
*   å…ˆå†³æ¡ä»¶
*   å±¥è¡Œ
*   è€ƒè™‘
*   ç»“è®º

# æ¦‚è§‚

é­”æœ¯æ›¿ä»£å“æ»¡è¶³ä»¥ä¸‹è¦æ±‚:

*   ä¸»åˆ†æ”¯ä¸­åŒ…å«ç‰ˆæœ¬åŒ– K8s æ¸…å•çš„ Git å­˜å‚¨åº“ã€‚
*   åœ¨å°†æ–°çš„å˜æ›´é›†æˆåˆ°ä¸»åˆ†æ”¯ä¹‹å‰ï¼Œè‡ªåŠ¨éªŒè¯å®ƒä»¬çš„æ–¹æ³•ã€‚
*   å¦‚æœè‡ªåŠ¨éªŒè¯å¤±è´¥ï¼Œæ–°çš„å˜æ›´å°±ä¸èƒ½é›†æˆåˆ°ä¸»åˆ†æ”¯ä¸­ã€‚
*   å¦å¤–:ä¸€ç§è·¨å¤šä¸ª K8s å­˜å‚¨åº“è½»æ¾å¤åˆ¶è‡ªåŠ¨åŒ–èµ„æºçš„æ–¹æ³•

![](img/35e6b81a74fe789084804217befe9eb2.png)

Diagram of the magic solution

å¦‚å›¾æ‰€ç¤ºï¼Œè¯¥æµç¨‹åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤:

1.  å¼€å‘äººå‘˜æˆ–æ“ä½œäººå‘˜å›¢é˜ŸåŸºäºä¸»åˆ†æ”¯åœ¨ Git å­˜å‚¨åº“ä¸­åˆ›å»ºç‰¹æ€§åˆ†æ”¯ï¼Œå¹¶å¯¹ K8s æ¸…å•åšå‡ºå¿…è¦çš„è´¡çŒ®ã€‚ä¸»åˆ†æ”¯æ˜¯ä¸€ä¸ªå—ä¿æŠ¤çš„åˆ†æ”¯ï¼Œæ‰€ä»¥ä»–ä»¬å¿…é¡»åˆ›å»ºä¸€ä¸ªä»ç‰¹æ€§åˆ°ä¸»åˆ†æ”¯çš„æ‹‰è¯·æ±‚ã€‚
2.  å½“ PR è¢«åˆ›å»ºåˆ°ä¸»åˆ†æ”¯æ—¶ï¼Œä¸€ä¸ª **AWS CodeBuild** é¡¹ç›®è¢«è§¦å‘ï¼Œå®ƒä½¿ç”¨ **Datree CLI** åˆ†ææ¥è‡ªç‰¹æ€§åˆ†æ”¯çš„ä»£ç ã€‚
3.  åˆ†æç»“æœçš„è¯¦ç»†ä¿¡æ¯è¢«å‘é€åˆ° **Datree** äº‘åç«¯ï¼Œå¹¶æ˜¾ç¤ºåœ¨ç­–ç•¥æ£€æŸ¥ä»ªè¡¨æ¿ä¸­ã€‚æˆ–è€…æ‚¨å¯ä»¥ç®€å•åœ°åœ¨ CodeBuild é¡¹ç›®æ—¥å¿—ä¸­æŸ¥çœ‹å®ƒä»¬ã€‚
4.  å¦‚æœ **Datree** ç­–ç•¥æ£€æŸ¥é€šè¿‡ï¼Œé‚£ä¹ˆ **AWS CodeBuild** å°†è¿”å›å¯¹ PR çš„æˆåŠŸæ£€æŸ¥ï¼Œå¦åˆ™ï¼Œå°†è¿”å›å¤±è´¥çš„æ£€æŸ¥ï¼Œå¹¶ä¸” PR ä¸èƒ½è¢«åˆå¹¶ã€‚
5.  åœ¨ **AWS** ä¸­ä½œä¸º **CodeBuild** é¡¹ç›®æä¾›çš„æ‰€æœ‰è‡ªåŠ¨åŒ–èµ„æºå·²ç»è¢«æŠ½è±¡åˆ° **Terraform æ¨¡å—**ä¸­ï¼Œè¿™å°†å…è®¸æˆ‘ä»¬ä¸ºä»»ä½• K8s å­˜å‚¨åº“é‡ç”¨å’Œå¤åˆ¶è¿™äº›é…ç½®ã€‚

è®°ä½è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬æ¾„æ¸…ä¸€ä¸‹ï¼Œä¸€äº› GitOps ä½¿ç”¨çš„å·¥å…·å’ŒæœåŠ¡ã€‚

## æ›¼é™€ç½—

[Datree](https://www.datree.io/) æ˜¯ä¸€æ¬¾ä¸“æ³¨äºéªŒè¯ K8s æ¸…å•çš„å·¥å…·ï¼Œç»“åˆå…¶ CLIï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ K8s ç®¡é“ä¸­è‡ªåŠ¨æ‰§è¡Œç­–ç•¥æ£€æŸ¥ã€‚[éªŒè¯è¿‡ç¨‹](https://hub.datree.io/welcome/how-datree-works)ç”±ä¸‰ä¸ªé˜¶æ®µç»„æˆ:YAML éªŒè¯ã€æ¨¡å¼éªŒè¯å’Œç­–ç•¥æ£€æŸ¥ã€‚æ­¤å¤–ï¼Œ[é›†ä¸­å¼ç­–ç•¥](https://hub.datree.io/setup/centralized-policy)çš„ Datree æ¦‚å¿µæ”¯æŒä½¿ç”¨å†…ç½®è§„åˆ™ç”šè‡³æˆ‘ä»¬è‡ªå·±çš„è‡ªå®šä¹‰è§„åˆ™æ¥éªŒè¯ç­–ç•¥ã€‚

ä¸€äº›ç±»ä¼¼çš„å¤‡é€‰æ–¹æ¡ˆæœ‰ [Kube-score](https://github.com/zegl/kube-score) ã€ [Kubeval](https://kubeval.instrumenta.dev/) ã€ [Conftest](https://www.conftest.dev/) å’Œ [Trivy](https://github.com/aquasecurity/trivy) ã€‚

## AWS ä»£ç æ„å»º

[AWS CodeBuild](https://aws.amazon.com/codebuild/) æ˜¯ AWS DevOps æœåŠ¡ï¼Œç”¨äºåœ¨é€šè¿‡ CodeBuild é¡¹ç›®å’Œ git å­˜å‚¨åº“ä¹‹é—´çš„ webhook å‘ä¸»å—ä¿æŠ¤åˆ†æ”¯åˆ›å»º Pull è¯·æ±‚æ—¶æ‰§è¡Œ Datree éªŒè¯ã€‚

æ ¹æ®æ„å»ºçš„ç»“æœæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼ŒCodeBuild æœ¬èº«æ”¯æŒå°†æ£€æŸ¥è¿”å›åˆ° GitHub ä¸­çš„ Pull è¯·æ±‚ã€‚

## å°†ï¼ˆè¡Œæ˜Ÿï¼‰åœ°çƒåŒ–ï¼ˆä»¥é€‚åˆäººç±»å±…ä½ï¼‰

ä½œä¸ºâ€œ*ä¸€åˆ‡å¦‚ä»£ç *â€æ¦‚å¿µçš„ä¸€éƒ¨åˆ†ï¼Œä¸ºäº†æ”¯æŒè‘—åçš„ [DRY](https://en.wikipedia.org/wiki/Don%27t_repeat_yourself) åŸåˆ™ï¼ŒAWS ä¸Šæä¾›çš„æ‰€æœ‰èµ„æºéƒ½è¢«æŠ½è±¡æˆäº†ä¸€ä¸ª [Terraform](https://www.terraform.io/) æ¨¡å—ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæˆ‘ä»¬æ‰€æœ‰çš„ K8s ä»“åº“å¤åˆ¶ä»£ç æ„å»ºé¡¹ç›®ã€‚ä½œä¸ºä¸€ä¸ª IaC å·¥å…·ï¼Œæ‚¨ç°åœ¨å°†è·å¾—ç®¡é“ä»£ç ã€‚ğŸš€

## Git å‚¨å­˜åº“

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåªæåˆ°äº† K8s æ¸…å•å­˜å‚¨åº“ã€‚è¿™æ˜¯ä¸€ä¸ª GitHub åº“ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ AWS CodeBuild æ”¯æŒçš„ä»»ä½•æºä»£ç [(æ¯”å¦‚ GitHubã€GitHub Enterpriseã€AWS CodeCommit æˆ– BitBucket)](https://aws.amazon.com/codebuild/faqs/?nc1=h_ls#:~:text=Q%3A%20Which%20source%20repositories%20does%20CodeBuild%20support%3F%20%3E%3E)

åŒæ ·é‡è¦çš„æ˜¯ï¼Œç”¨äºæä¾› AWS èµ„æºçš„ Terraform æ¨¡å—(ä¸»è¦æ˜¯æ‰§è¡Œ Datree ç­–ç•¥æ£€æŸ¥çš„ CodeBuild é¡¹ç›®)æœ‰è‡ªå·±çš„ GitHub å­˜å‚¨åº“ã€‚å› æ­¤ï¼Œæœ‰ä¸¤ä¸ª GitHub åº“:

*   [K8s æ¸…å•åº“](https://github.com/Kirmito/k8s-apps)
*   [AWS code build&Datree terra form æ¨¡å—åº“](https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild)

# å…ˆå†³æ¡ä»¶

*   Terraform v1.0 ç‰ˆæˆ–æ›´æ—©ç‰ˆæœ¬
*   AWS äº‘å¸æˆ·
*   å¸¦æœ‰ K8S æ¸…å•çš„ Git å­˜å‚¨åº“ã€‚æœ¬æ¡ˆä¸­çš„ GitHub å›è´­åè®®ã€‚
*   [ä¸º AWS ä»£ç ç‰ˆæœ¬é…ç½® GitHub è®¤è¯](https://docs.aws.amazon.com/codebuild/latest/userguide/access-tokens.html)
*   Datree è´¦æˆ·ã€‚çœ‹çœ‹[å®˜æ–¹æ•°æ®å…¥é—¨](https://hub.datree.io/)æˆ–è€…ç›´æ¥åˆ›å»º[è´¦å·](https://app.datree.io/login)ã€‚

# å¼€å§‹å§ï¼

æ›¿ä»£è§£å†³æ–¹æ¡ˆå°†åŒ…å«åœ¨ä»¥ä¸‹ 5 ä¸ªæ­¥éª¤ä¸­:

1.  åˆ›å»º K8s æ¸…å•åº“ã€‚
2.  Datree é¢„é…ç½®ã€‚
3.  Terraform æ¨¡å—ç»“æ„å’Œä¾›åº”ã€‚
4.  æœ€ç»ˆçš„ GitHub é…ç½®ã€‚
5.  ä¸€ã€äºŒã€ä¸‰â€¦å¼€æ‹ï¼ğŸ¬ç­–ç•¥æ£€æŸ¥çš„ç»“æœã€‚

## æ­¥éª¤ 1:åˆ›å»º K8s æ¸…å•å­˜å‚¨åº“

æ­£å¦‚æ‚¨åœ¨[K8s æ¸…å•å­˜å‚¨åº“ç»“æ„](https://github.com/Kirmito/k8s-apps/tree/main/apps)ä¸­çœ‹åˆ°çš„ï¼Œæœ‰ä¸¤ä¸ª Kubernetes åº”ç”¨ç¨‹åºï¼Œå®ƒä»¬çš„æ¸…å•è¢«å£°æ˜ä¸º YAML æ–‡ä»¶ã€‚

```
apps
â”œâ”€â”€ demo-app
â”‚   â”œâ”€â”€ base
â”‚   â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”‚   â”œâ”€â”€ ingress.yaml
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â”œâ”€â”€ namespace.yaml
â”‚   â”‚   â””â”€â”€ service.yaml
â”‚   â””â”€â”€ overlays
â”‚       â””â”€â”€ develop
â”‚           â”œâ”€â”€ config.json
â”‚           â””â”€â”€ kustomization.yaml
â””â”€â”€ lab-app
    â”œâ”€â”€ base
    â”‚   â”œâ”€â”€ deployment.yaml
    â”‚   â”œâ”€â”€ ingress.yaml
    â”‚   â”œâ”€â”€ kustomization.yaml
    â”‚   â”œâ”€â”€ namespace.yaml
    â”‚   â””â”€â”€ service.yaml
    â””â”€â”€ overlays
        â””â”€â”€ develop
            â”œâ”€â”€ config.json
            â””â”€â”€ kustomization.yaml
```

å› æ­¤ï¼Œå½“ä»»ä½•å¼€å‘è€…æˆ–æ“ä½œè€…æƒ³è¦é€šè¿‡æ‹‰è¯·æ±‚åšå‡ºè´¡çŒ®æ—¶ï¼Œå…¶æƒ³æ³•æ˜¯åˆ†æè¿™äº›ç°æœ‰çš„å’Œæœªæ¥çš„æ¸…å•ã€‚

## æ­¥éª¤ 2: Datree é¢„é…ç½®

ä¸€æ—¦æ‚¨åˆ›å»ºäº† Datree å¸æˆ·å¹¶å®Œæˆäº†[å…ˆå†³æ¡ä»¶éƒ¨åˆ†ä¸­è¯¦è¿°çš„æ­£å¼ Datree å…¥é—¨](https://hub.datree.io/)ï¼Œä¸€ä¸ªè‰¯å¥½çš„å®‰å…¨å®è·µæ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„ **read** ä»¤ç‰Œï¼ŒCodeBuild é¡¹ç›®ç¨åå°†ä½¿ç”¨å®ƒæ¥è®¿é—® Datree åç«¯ã€‚

è½¬åˆ°`the Datree Web Console > Settings > Token Management`ï¼Œç„¶åç‚¹å‡»`Create Token`ã€‚ç¡®ä¿ä»¤ç‰Œç±»å‹ä¸º **Readã€‚**

![](img/7e7a5bca80481e8f9606071c1d03db2a.png)

Create a Read Datree Token

è‹¥è¦å®‰å…¨åœ°å­˜å‚¨æ­¤æ ‡è®°å¹¶ç¡®ä¿ CodeBuild é¡¹ç›®å¯ä»¥æ¥å—å®ƒï¼Œè¯·å°†è¯¥å€¼ä½œä¸º SecureString åŠ è½½åˆ° SSM å‚æ•°å­˜å‚¨åŒºä¸­ã€‚

```
/k8s-apps-example/datree/APP_TOKEN 
```

![](img/184f2e99a6ae5050528316bca9981351.png)

ä¸ºäº†ä¸ Datree çš„é›†ä¸­å¼ç­–ç•¥æ§åˆ¶å°è¿›è¡Œäº¤äº’ï¼Œè®©æˆ‘ä»¬ä¸ºæ­¤ç¤ºä¾‹åˆ›å»ºä¸€ä¸ªæ–°ç­–ç•¥ã€‚è½¬åˆ°ç­–ç•¥é€‰é¡¹å¡ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåä¸º`k8s_apps_example`çš„æ–°ç­–ç•¥ã€‚è¯·æ³¨æ„è¿™ä¸ªåç§°ï¼Œå› ä¸ºå®ƒç¨åå°†ç”¨äº CodeBuild é¡¹ç›®ã€‚

![](img/a2518b1ca37431e9e4e02e1d7399e2e0.png)

Datreeâ€™s Centralized policy console

ç°åœ¨æ˜¯æ—¶å€™æ¿€æ´»è§„åˆ™äº†ï¼Œè¿™äº›è§„åˆ™å°†åœ¨ CodeBuild é¡¹ç›®ä¸­ç”±ç­–ç•¥æ£€æŸ¥è‡ªåŠ¨éªŒè¯ã€‚å¦‚ä¸Šæ‰€ç¤ºï¼Œ53 ä¸ªè§„åˆ™ä¸­çš„ 22 ä¸ªå·²ç»è¢«æ¿€æ´»ï¼Œå…¶ä¸­ä¸€äº›å±äºå®‰å…¨ã€Argo å’Œå®¹å™¨ç±»åˆ«ã€‚

## æ­¥éª¤ 3: Terraform æ¨¡å—ç»“æ„å’Œä¾›åº”

é¦–å…ˆï¼Œå…‹éš†[terra form æ¨¡å—åº“](https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild)å¹¶æŸ¥çœ‹å°†è¦æä¾›çš„èµ„æºã€‚

*   [ä»£ç æ„å»ºé¡¹ç›®](https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/codebuild_pr.tf#L1-L59)
*   [CodeBuild Webhook](https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/codebuild_pr.tf#L61-L76)
*   [Webhook SSM å‚æ•°](https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/ssm.tf)(æœ‰æ•ˆè½½è· URL å’Œç§˜å¯†)
*   [ä»£å·é€šçŸ¥](https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/codestar_notifications.tf)

é™¤äº†æ¨¡å—åˆ›å»ºçš„èµ„æºä¹‹å¤–ï¼Œè¿˜éœ€è¦ä»¥ä¸‹èµ„æºä½œä¸ºæ¨¡å—è°ƒç”¨çš„è¾“å…¥ã€‚

*   [KMS å¯†é’¥åŠ å¯† SSM å‚æ•°](https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/examples/complete/main.tf#L21-L28)
*   [ä»£ç æ„å»ºé¡¹ç›®å°†æ‰¿æ‹…çš„ IAM è§’è‰²å’Œ IAM ç­–ç•¥](https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/examples/complete/main.tf#L81-L91)

åœ¨[å®Œæ•´çš„](https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/tree/main/examples/complete)ç¤ºä¾‹çš„ [main.tf](https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/examples/complete/main.tf) æ–‡ä»¶ä¸­ï¼Œå£°æ˜äº†æ‰€éœ€çš„èµ„æºå’Œ Terraform æ¨¡å—çš„è°ƒç”¨ã€‚

è¯¥æ¨¡å—æ”¯æŒè®¸å¤š[è¾“å…¥å˜é‡](https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/variables.tf)ï¼›ä½†æ˜¯ï¼Œæœ€ç›¸å…³çš„å˜é‡æ˜¯èµ„æºåç§°çš„å‰ç¼€ã€è¦åˆ†æçš„å­˜å‚¨åº“å’Œåˆ†æ”¯ã€Datree ç­–ç•¥åç§°ä»¥åŠå…ˆå‰åˆ›å»º Datree ä»¤ç‰Œçš„å‚æ•°å­˜å‚¨è·¯å¾„ã€‚

å…‹éš†äº† repo ä¹‹åï¼Œè®¾ç½® AWS å‡­è¯ï¼Œè®©æˆ‘ä»¬ç»§ç»­åˆ°ç»ˆç«¯ï¼Œçœ‹çœ‹ Terraform çš„ç¥å¥‡ä¹‹å¤„ã€‚

```
cd examples/complete
terraform init
terraform apply 
```

åœ¨**åœ°å½¢åº”ç”¨**ä¸­è¾“å…¥**æ˜¯**åçš„é¢„æœŸè¾“å‡º:

![](img/ad63c1c275436c479181e90598b5bfe6.png)

æœ€åï¼Œå·²ç»æä¾›äº† AWS CodeBuild é¡¹ç›®ã€‚ğŸ‰

![](img/5303b23ea472dc15516baea16142a9f9.png)

CodeBuild project

ä»[åœ°å½¢æ¨¡æ¿](https://www.terraform.io/language/functions/templatefile?_ga=2.106572672.2087542934.1652304655-572813180.1649204332)æ„å»º`buildspec.yml`æ–‡ä»¶ï¼Œæœ€ç»ˆç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚å¦‚æ‚¨æ‰€è§ï¼Œé¦–å…ˆæ‰€æœ‰ YAML æ–‡ä»¶è¢«é€’å½’åˆ—å‡ºï¼Œç„¶åæ‰§è¡ŒåŒ…å«`--only-k8s-files`æ ‡å¿—çš„`datree test`å‘½ä»¤ï¼Œä»å­˜å‚¨åº“æ ¹é€’å½’éªŒè¯æ‰€æœ‰ä¸ K8s æ¸…å•ç›¸å…³çš„ YAML æ–‡ä»¶ã€‚

ç±»ä¼¼åœ°ï¼ŒCodeBuild webhook ä¹Ÿè¢«æ·»åŠ åˆ°äº† K8s æ¸…å•å­˜å‚¨åº“ä¸­ã€‚

![](img/083aade45200d6f30b8817e348463120.png)

CodeBuild Webhook created in Github repository

## æ­¥éª¤ 4:æœ€ç»ˆçš„ GitHub é…ç½®

ä¸ºäº†ç¡®ä¿å¼€å‘äººå‘˜æˆ–è¿è¥å›¢é˜Ÿåªèƒ½é€šè¿‡æ‹‰è¯·æ±‚å¯¹ä¸»åˆ†æ”¯åšå‡ºè´¡çŒ®ï¼Œå¿…é¡»åœ¨åŠŸèƒ½åˆ†æ”¯åˆå¹¶åˆ°ä¸»åˆ†æ”¯ä¹‹å‰é€šè¿‡ä»£ç æ„å»ºæ£€æŸ¥ã€‚åœ¨ K8s æ¸…å•æŠ¥å‘Šä¸­ï¼Œåˆ›å»ºä¸€ä¸ªä¸ä¸»åˆ†æ”¯ç›¸å…³è”çš„å—ä¿æŠ¤åˆ†æ”¯è§„åˆ™ï¼Œå¹¶åœ¨çŠ¶æ€æ¸…å•ä¸­é€‰æ‹© CodeBuild æ£€æŸ¥ã€‚

![](img/5abe9e9d188325cc8693e39a7f6910f6.png)

## ç¬¬äº”æ­¥:1ï¼Œ2ï¼Œ3â€¦å¼€å§‹ï¼ğŸ¬ç­–ç•¥æ£€æŸ¥çš„ç»“æœ

æœ€åï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªä»ç‰¹æ€§åˆ†æ”¯åˆ°ä¸»åˆ†æ”¯çš„æ‹‰è¯·æ±‚ï¼Œå¹¶åšäº†ä¸€äº›ä¿®æ”¹ï¼Œé‚£ä¹ˆå°±ä¼šè‡ªåŠ¨è§¦å‘ä¸€ä¸ªä»£ç æ„å»ºæ¥åˆ†æç‰¹æ€§åˆ†æ”¯çš„ä»£ç ã€‚

![](img/9360abe58cb1fdbb2f643396062b7e70.png)

æ ¹æ® CodeBuild æ‰§è¡Œçš„çŠ¶æ€ï¼ŒAWS å°†å‘ PR è¿”å›å¤±è´¥æˆ–æˆåŠŸæ£€æŸ¥çš„çŠ¶æ€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºæ£€æŸ¥å¤±è´¥ï¼Œå› æ­¤ä¸å…è®¸åˆå¹¶ã€‚

![](img/dbe580b88ae3cfba50856e16b3be4d94.png)

è¦è¯¦ç»†è¯´æ˜æ„å»ºçŠ¶æ€ï¼Œåªéœ€å•å‡» **Details** æ ‡ç­¾ï¼Œå®ƒä¼šå°†æ‚¨é‡å®šå‘åˆ° AWS ä¸Šçš„ CodeBuild æ—¥å¿—æˆ–ç›´æ¥è®¿é—® CodeBuild é¡¹ç›®çš„è¿è¡Œå†å²ã€‚

![](img/d6f9c9d01fc6dda50a2327e73a4cafbb.png)

CodeBuild logs

åœ¨ä»£ç æ„å»ºæ—¥å¿—ä¸­ï¼Œæ‚¨å¯ä»¥è¯¦ç»†æè¿°ä»¥ä¸‹å†…å®¹:

*   åŸºäºå…ˆå‰åˆ›å»ºçš„ Datree ç­–ç•¥ä¸­å¯ç”¨çš„è§„åˆ™å°šæœªé€šè¿‡çš„è§„åˆ™ã€‚
*   ä¸‰ä¸ªè¿ç»­é˜¶æ®µ(YAML éªŒè¯ã€æ¨¡å¼éªŒè¯å’Œç­–ç•¥æ£€æŸ¥)çš„æ‘˜è¦ã€‚
*   åœ¨ç­–ç•¥æ£€æŸ¥é˜¶æ®µè¯„ä¼°ã€è·³è¿‡ã€å¤±è´¥å’Œé€šè¿‡çš„è§„åˆ™çš„æ€»ç»“æœã€‚

åŒæ ·ï¼Œå¦‚æœæ‚¨è®¿é—® Datree ä¸­çš„â€œå†å²è®°å½•â€é€‰é¡¹å¡ï¼Œæ‚¨å¯ä»¥è½»æ¾è·Ÿè¸ªæ‰€æœ‰ä¸åŒçš„ç­–ç•¥æ£€æŸ¥æ‰§è¡Œæƒ…å†µã€‚

![](img/02cc45427c85302789ecd7ef1ede2d7a.png)

Datree policy check history

# è®°ä½

*   è¿è¡Œ Datree CLI ä¸éœ€è¦åˆ›å»º Datree å¸æˆ·ï¼Œä½†æ˜¯ï¼Œè¦è®¿é—®é›†ä¸­ç­–ç•¥åŠŸèƒ½ï¼ŒDatree å¸æˆ·æ˜¯å¿…éœ€çš„ã€‚
*   Datree çš„å…è´¹æ¨¡å¼ä»…æ”¯æŒ GitHub å’Œ Google SSO ç”¨æˆ·ï¼Œå› æ­¤æœ€å¥½åˆ›å»ºä¸€ä¸ªæ–°çš„è‡ªåŠ¨åŒ–ç”¨æˆ·æˆ–è€ƒè™‘ä¼ä¸šæ¨¡å¼ã€‚
*   å¦‚å‰æ‰€è¿°ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå­˜å‚¨åº“ä¸­çš„æ‰€æœ‰ k8s æ¸…å•éƒ½è¢«éªŒè¯ã€‚ä½†æ˜¯ï¼ŒDatree æ”¯æŒåœ¨[èˆµå›¾](https://github.com/datreeio/helm-datree)å’Œ [Kustomize](https://hub.datree.io/integrations/kustomize-support) ä¸­éªŒè¯åº”ç”¨ã€‚
*   terraform æ¨¡å—æ”¯æŒåˆ›å»º CodeStar é€šçŸ¥ï¼Œä»¥å‘æ¾å¼›é€šé“å‘é€çŠ¶æ€ã€‚è¿™éœ€è¦åˆ›å»ºä¸€ä¸ªèŠå¤©æœºå™¨äººé€šçŸ¥ï¼Œå¹¶å°†å…¶æ·»åŠ ä¸ºä¸€ä¸ª[è¾“å…¥å˜é‡](https://github.com/Kirmito/terraform-aws-k8s-datree-codebuild/blob/main/variables.tf#L91-L101)ã€‚
*   å½“å®ƒæ˜¯ Github.com å­˜å‚¨åº“æ—¶ï¼Œwebhook æ˜¯ç”± Codebuild é€šè¿‡ä¸ªäººè®¿é—®ä»¤ç‰Œè‡ªåŠ¨åˆ›å»ºçš„ã€‚ä½†æ˜¯ï¼Œå½“å®ƒæ˜¯ GitHub ä¼ä¸šå­˜å‚¨åº“æ—¶ï¼Œå¿…é¡»å•ç‹¬åˆ›å»ºã€‚å› æ­¤ï¼Œwebhook çš„æœ‰æ•ˆè´Ÿè½½ URL å’Œç§˜å¯†å­˜å‚¨åœ¨ SSM å‚æ•°å­˜å‚¨ä¸­ã€‚

# ç»“è®º

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ¢ç´¢äº†ä¸€ç§åŸºäº GitOps å®è·µçš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨éƒ¨ç½²ä¹‹å‰ï¼Œè‡ªåŠ¨åˆ†æåœ¨ git å­˜å‚¨åº“ä¸­å£°æ˜çš„ K8s åº”ç”¨ç¨‹åºæ¸…å•ã€‚è¯¥å®æ–½ä¾èµ–äºä¸€äº› GitOps å·¥å…·ï¼Œå¦‚ Datreeï¼Œä»¥é€šè¿‡ç­–ç•¥æ£€æŸ¥æ¥éªŒè¯ K8s çš„é”™è¯¯é…ç½®ï¼ŒAWS Codebuild ä»¥è‡ªåŠ¨è§¦å‘æ£€æŸ¥ï¼ŒTerraform æ¨¡å—ç”¨äºæŠ½è±¡å’Œæä¾›ä¸è¯¥è§£å†³æ–¹æ¡ˆç›¸å…³çš„åŸºç¡€è®¾æ–½ï¼Œæœ€åï¼ŒGitHub ä¸­çš„ä¸€äº›é…ç½®ä»¥ç¡®ä¿åŸºäºæ‹‰è¯·æ±‚çš„æµç¨‹ã€‚

æœ€åï¼Œæˆ‘æƒ³å¯¹çº¦å°”æ›¼å’Œå”Â·å¥¥æ–¯å¡æ—çš„å®è´µæ”¯æŒè¡¨ç¤ºæœ€æ·±åˆ‡çš„æ„Ÿè°¢ã€‚

# å‚è€ƒ

*   [GitOps å®è·µ](https://www.weave.works/technologies/gitops/)
*   [Datree å…¥é—¨](https://hub.datree.io/)
*   [Datree CLI è¾“å‡º](https://hub.datree.io/setup/cli-output)
*   [AWS â€”é…ç½® GitHub ä¸ªäººè®¿é—®ä»¤ç‰Œ](https://docs.aws.amazon.com/codebuild/latest/userguide/access-tokens.html)
*   [AWS â€”ä¸º GitHub æ‹‰è¯·æ±‚é…ç½®ä»£ç æ„å»º](https://docs.aws.amazon.com/codebuild/latest/userguide/sample-github-pull-request.html)
*   [åœ°å½¢æ¨¡å—](https://www.terraform.io/language/modules/syntax)