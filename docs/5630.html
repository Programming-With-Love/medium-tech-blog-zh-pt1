<html>
<head>
<title>Experimenting with Ingress Controllers on Oracle Container Engine (OKE) — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Oracle容器引擎(OKE)上试验入口控制器—第2部分</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/experimenting-with-ingress-controllers-on-oracle-container-engine-oke-part-2-96063927d2e6?source=collection_archive---------2-----------------------#2019-07-12">https://medium.com/oracledevs/experimenting-with-ingress-controllers-on-oracle-container-engine-oke-part-2-96063927d2e6?source=collection_archive---------2-----------------------#2019-07-12</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="4ca5" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">通过OKE使用多个控制器和负载平衡器</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/f4a4e070f89b46d404a84659ee5238df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3RDqucebZRVLZx_4rJwDLA.png"/></div></div></figure><p id="e717" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在<a class="ae ke" rel="noopener" href="/@lmukadam/experimenting-with-ingress-controllers-on-oracle-container-engine-oke-part-1-5af51e6cdb85?source=friends_link&amp;sk=ec2339dfb787af382b38d7edd12877f5">第一部分</a>中，我简单描述了什么是<a class="ae ke" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank">入口</a>和<a class="ae ke" href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" rel="noopener ugc nofollow" target="_blank">入口控制器</a>。我们还对Kubernetes的一些最受欢迎的入口控制器进行了分析，即:</p><ul class=""><li id="1730" class="kf kg hh jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated"><a class="ae ke" href="https://kubernetes.github.io/ingress-nginx/" rel="noopener ugc nofollow" target="_blank"> nginx-ingress </a></li><li id="5905" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated"><a class="ae ke" href="https://github.com/jcmoraisjr/haproxy-ingress" rel="noopener ugc nofollow" target="_blank"> haproxy-ingress </a></li><li id="b168" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated"><a class="ae ke" href="https://traefik.io/" rel="noopener ugc nofollow" target="_blank"> Traefik </a></li><li id="7865" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated"><a class="ae ke" href="https://projectcontour.io/" rel="noopener ugc nofollow" target="_blank">轮廓</a></li></ul><p id="d8c7" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在本帖中，我们将看看Ingress类，以及如何使用它们来同时部署多个Ingress控制器实例。我们还将简要介绍一种不同类型的Kubernetes服务(<a class="ae ke" href="https://kubernetes.io/docs/concepts/services-networking/service/#externalname" rel="noopener ugc nofollow" target="_blank"> ExternalName </a>)以及使用它的一种方式。最后，我们看看它们如何与公共和内部负载平衡器一起使用。</p><p id="248d" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">下面练习中的所有yamls都可以在<a class="ae ke" href="https://github.com/hyder/okesamples/tree/master/ingresscontrollers" rel="noopener ugc nofollow" target="_blank"> github </a>上找到。</p><h2 id="6f5a" class="kt ku hh bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">使用多个入口控制器</h2><p id="89af" class="pw-post-body-paragraph ji jj hh jk b jl lo ii jn jo lp il jq jr lq jt ju jv lr jx jy jz ls kb kc kd ha bi translated">使用哪个入口控制器是一个很难回答的问题。通常，这取决于您的需求、您的团队技能组合(例如，您的团队可能比Traefik或Contour更熟悉NGINX或HAProxy)、您正在部署的应用程序类型、您需要的技术和操作功能、支持的协议、控制器或helm包的成熟度(如果您正在部署的话)、您对试验和风险的偏好、内部批准等等。这本优秀的Kubedex指南及其功能概述可以帮助你缩小评估范围。</p><p id="8600" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">无论如何，在一个Kubernetes集群中部署多个控制器是可能的。也可以通过指定不同的入口类，在同一个集群中部署同一个控制器的多个实例<em class="lt">。那么，我们来看看Ingress类是如何工作的。</em></p><p id="a0c8" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">回想一下，入口控制器监听变化并更新其路由规则。然而，当您部署多个入口控制器和入口时，必须有一种方法来确保特定的入口被正确的控制器拾取。这就是Ingress类的目的。将入口类视为所有已部署入口控制器的指令:</p><ul class=""><li id="f47b" class="kf kg hh jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated">你负责执行我的路由规则</li><li id="c906" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">你不负责执行我的路由规则</li></ul><p id="3649" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">下图说明了这一点。当入口类值与<em class="lt">控制器实例</em>的值匹配时，该控制器实例将为您的入口处理路由规则。如果您有其他控制器实例，无论是相同还是不同类型的<em class="lt">，但与您的入口具有不同的入口类值</em>，它们将忽略该入口。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es lu"><img src="../Images/f879350e472c59a37273740e7aad64ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5IUhlZHLjK9zy7i0yS6bJA.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx">Ingress classes and Ingress mapping</figcaption></figure><h2 id="f1e2" class="kt ku hh bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">通过注释指定入口类</h2><p id="fa43" class="pw-post-body-paragraph ji jj hh jk b jl lo ii jn jo lp il jq jr lq jt ju jv lr jx jy jz ls kb kc kd ha bi translated">入口API有一个注释，允许您指定这个入口类:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="304d" class="kt ku hh ma b fi me mf l mg mh">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: acme-blog-ingress<br/>  annotations:<br/>    <strong class="ma hi">kubernetes.io/ingress.class</strong>: "ingressclass"</span></pre><p id="bc9a" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">除了traefik(见下文)，每个控制器都有一个默认的入口类值，但也允许您指定自己的自定义类。这很有用，尤其是当您必须在单个集群中部署它们的多个实例时。当你使用各自的舵表时，下面是每个的默认进入等级值:</p><ul class=""><li id="b85a" class="kf kg hh jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated">nginx: nginx</li><li id="319f" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">哈普洛克西:哈普洛克西</li><li id="dc3b" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">traefik:</li><li id="be58" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">轮廓:轮廓</li></ul><p id="6bf6" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">如果按照<a class="ae ke" rel="noopener" href="/oracledevs/experimenting-with-ingress-controllers-on-oracle-container-engine-oke-part-1-5af51e6cdb85">第1部分</a>、<strong class="jk hi">、<em class="lt">中所述使用traefik的舵图，则默认设置没有</em>、</strong>入口类别。您需要在部署期间明确指定它，如下所示:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="4ae5" class="kt ku hh ma b fi me mf l mg mh">helm install stable/traefik --name traefikcontroller <strong class="ma hi">--set kubernertes.ingressClass=traefik</strong></span></pre><p id="c66b" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">最后，注意如果你使用轮廓，你需要<strong class="jk hi">而不是</strong>在<a class="ae ke" href="https://github.com/heptio/contour/blob/master/docs/ingressroute.md" rel="noopener ugc nofollow" target="_blank">进刀路线</a>上设置注释kubernetes.io/ingress.class。稍后将详细介绍Contour及其入口类。</p><h2 id="f112" class="kt ku hh bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">在Ingress中使用默认的Ingress类注释</h2><p id="41de" class="pw-post-body-paragraph ji jj hh jk b jl lo ii jn jo lp il jq jr lq jt ju jv lr jx jy jz ls kb kc kd ha bi translated">以下示例显示了您需要为四个控制器中的每一个提供的默认注释。</p><p id="6d06" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">NGINX入口控制器:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="13ed" class="kt ku hh ma b fi me mf l mg mh">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: acme-website<br/>  annotations:<br/>    <strong class="ma hi">kubernetes.io/ingress.class: "nginx"</strong><br/>...</span></pre><p id="ac47" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">HAProxy:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="bccf" class="kt ku hh ma b fi me mf l mg mh">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: acme-website<br/>  annotations:<br/>    <strong class="ma hi">kubernetes.io/ingress.class: "haproxy"</strong><br/>...</span></pre><p id="e7ab" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">Traefik:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="9d8b" class="kt ku hh ma b fi me mf l mg mh">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: acme-website<br/>  annotations:<br/>    <strong class="ma hi">kubernetes.io/ingress.class: "traefik"</strong><br/>...</span></pre><p id="9558" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">轮廓:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="a96b" class="kt ku hh ma b fi me mf l mg mh">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: acme-website<br/>  annotations:<br/>    <strong class="ma hi">kubernetes.io/ingress.class: "contour"</strong><br/>...</span></pre><h2 id="2d64" class="kt ku hh bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">自定义入口类</h2><p id="d3c0" class="pw-post-body-paragraph ji jj hh jk b jl lo ii jn jo lp il jq jr lq jt ju jv lr jx jy jz ls kb kc kd ha bi translated">现在，让我们看看如何在安装过程中使用舵图为每个控制器定制入口类。</p><p id="478b" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="lt"> NGINX </em>:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="4cd6" class="kt ku hh ma b fi me mf l mg mh">helm install --name acmecontroller stable/nginx-ingress <strong class="ma hi">--set controller.ingressClass=mycustomnginx</strong></span></pre><p id="857c" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">您可以为NGINX入口类设置任何值。</p><p id="610e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">HAProxy :</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="c6ff" class="kt ku hh ma b fi me mf l mg mh">helm install --name acmecontroller incubator/haproxy-ingress <strong class="ma hi">--set controller.ingressClass=mycustomhaproxy</strong></span></pre><p id="94a2" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">同样，您可以为HAProxy的Ingress类设置任何值。</p><p id="6a96" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">Traefik:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="5e5d" class="kt ku hh ma b fi me mf l mg mh">helm install stable/traefik --name traefikcontroller <strong class="ma hi">--set kubernertes.ingressClass=traefikcustom</strong></span></pre><p id="0b4a" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">对于Traefik，入口类值<strong class="jk hi">必须以‘trae fik’开始</strong>。我不确定是头盔包的问题还是Traefik本身的问题。这是基于Traefik的舵图文档。</p><p id="20ae" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="lt">轮廓</em>:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="d730" class="kt ku hh ma b fi me mf l mg mh">kubectl apply -f examples/deployment-grpc-v2/ <strong class="ma hi">--ingress-class-name=newcontour</strong></span></pre><p id="8667" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">与NGINX和HAProxy类似，可以为Contour的Ingress类设置任何值。但是，请注意，根据Contour的文件，以下内容适用:</p><blockquote class="mi mj mk"><p id="fac2" class="ji jj lt jk b jl jm ii jn jo jp il jq ml js jt ju mm jw jx jy mn ka kb kc kd ha bi translated"><code class="du mo mp mq ma b"><em class="hh">contour.heptio.com/ingress.class</em></code>:应该解释和服务IngressRoute的入口类。如果未设置，则所有轮廓实例都服务于IngressRoute。如果指定为<code class="du mo mp mq ma b"><em class="hh">contour.heptio.com/ingress.class: contour</em></code>，则等高线服务于进入路线。如果为任何其他值，Contour将忽略IngressRoute定义。您可以在运行时用<code class="du mo mp mq ma b"><em class="hh">--ingress-class-name</em></code>标志覆盖默认的类<code class="du mo mp mq ma b"><em class="hh">contour</em></code></p></blockquote><p id="80fb" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">因此，如果你打算使用Contour的IngressRoute API，你必须<em class="lt">将这个值</em>设置为‘Contour ’,或者<em class="lt">根本不要</em>设置它。</p><h2 id="bec7" class="kt ku hh bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">使用多个控制器</h2><p id="2848" class="pw-post-body-paragraph ji jj hh jk b jl lo ii jn jo lp il jq jr lq jt ju jv lr jx jy jz ls kb kc kd ha bi translated">我说过可以在一个集群上同时部署多个入口控制器。让我们看看如何同时使用它们。</p><p id="199f" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">挑选2个你喜欢的控制器并部署它们。在本例中，我们将使用NGINX和Traefik进行说明，但是您可以使用任何组合，只要您指定正确的入口类，例如，如果您愿意，您也可以有2个NGINX控制器，只要您为第二个控制器设置不同的类名。</p><p id="79a8" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这就是我们想要如何部署我们的工件:</p><ul class=""><li id="730c" class="kf kg hh jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated">acme名称空间中的acme服务(网站、博客)</li><li id="4ead" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">web命名空间中的nginx控制器和网站入口</li><li id="1441" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">博客命名空间中的traefik控制器和博客入口</li></ul><p id="6cd9" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">下图说明了我们的部署。</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mr"><img src="../Images/d5557073d4bc6fcda59b573e26f0016f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y-tS9VXrauQ8cm0jTscUqA.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx">Using multiple controllers and public load balancers</figcaption></figure><p id="85ac" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">让我们首先创建名称空间:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="1701" class="kt ku hh ma b fi me mf l mg mh">kubectl create ns acme<br/>kubectl create ns web<br/>kubectl create ns blog</span></pre><p id="1fae" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们现在可以部署网站和博客。</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="323f" class="kt ku hh ma b fi me mf l mg mh">kubectl create -f ingresscontrollers/multiplecontrollers/acme-website.yaml<br/>kubectl create -f ingresscontrollers/multiplecontrollers/acme-blog.yaml</span></pre><p id="c1e3" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">现在让我们部署我们的2个入口控制器(NGINX和Traefik)。</p><p id="403a" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">NGINX:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="18d2" class="kt ku hh ma b fi me mf l mg mh">helm install --name webcontroller stable/nginx-ingress \<br/>--namespace web \<br/>--set defaultBackend.enabled=true \<br/>--set defaultBackend.name=acmedefaultbackend \<br/>--set rbac.create=true</span></pre><p id="aa45" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">验证NGINX控制器已正确部署:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="48b7" class="kt ku hh ma b fi me mf l mg mh">kubectl -n web get pods                                                                                                                                    <br/>NAME                                                              READY   STATUS    RESTARTS   AGE<br/>webcontroller-nginx-ingress-acmedefaultbackend-86689bd54b-dzpcg   1/1     Running   0          5m45s                                                                                          <br/>webcontroller-nginx-ingress-controller-8bdc8c665-f6xqm            1/1     Running   0          5m45s</span></pre><p id="d62f" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">并检索负载平衡器的公共IP地址:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="a172" class="kt ku hh ma b fi me mf l mg mh">kubectl -n web get svc -o wide</span><span id="a201" class="kt ku hh ma b fi ms mf l mg mh">NAME                                             TYPE           CLUSTER-IP      EXTERNAL-IP       PORT(S)                      AGE   SELECTOR                                                 <br/>webcontroller-nginx-ingress-acmedefaultbackend   ClusterIP      10.96.122.109               80/TCP                       46s   app=nginx-ingress,component=acmedefaultbackend,release=we<br/>bcontroller                                                                                                                                                                                   <br/>webcontroller-nginx-ingress-controller           LoadBalancer   10.96.45.231    <strong class="ma hi">129.146.208.247</strong>   80:30698/TCP,443:32651/TCP   46s   app=nginx-ingress,component=controller,release=webcontrol<br/>ler</span></pre><p id="8e26" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">Traefik:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="3bd5" class="kt ku hh ma b fi me mf l mg mh">helm install --name blogcontroller stable/traefik \<br/>--namespace blog \<br/>--set rbac.enabled=true \<br/>--set kubernetes.ingressClass=traefik</span></pre><p id="6d53" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">验证Traefik控制器已正确部署:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="4f59" class="kt ku hh ma b fi me mf l mg mh">kubectl -n blog get pods                                                                                                                                   <br/>NAME                                      READY   STATUS    RESTARTS   AGE                                                                                                                    <br/>blogcontroller-traefik-65579ddcb4-7hqdz   1/1     Running   0          6m30s</span></pre><p id="d305" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">并检索负载平衡器的公共IP地址:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="5055" class="kt ku hh ma b fi me mf l mg mh">kubectl -n blog get svc -o wide                                                                                                                            <br/>NAME                     TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)                      AGE   SELECTOR                                                                          <br/>blogcontroller-traefik   LoadBalancer   10.96.127.166   <strong class="ma hi">129.146.89.209</strong>   80:30293/TCP,443:30455/TCP   69s   app=traefik,release=blogcontroller</span></pre><p id="d5f1" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">更新您的DNS“A”记录，使它们与以下内容匹配:</p><ul class=""><li id="3526" class="kf kg hh jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated">129.146.208.247(由NGINX入口控制器创建的负载平衡器使用)映射到www.acme.com</li><li id="f0da" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">129.146.89.209(由Traefik的入口控制器创建的负载平衡器使用)映射到blog.acme.com</li></ul><p id="6c67" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">注意:</p><ul class=""><li id="c4c2" class="kf kg hh jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated">您的负载平衡器公共IP地址会有所不同，请记住使用您自己的地址</li><li id="b2ba" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">用你的域名替换acme.com</li></ul><p id="e540" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">现在让我们创建入口，从网站入口开始，使用与第1部分中的示例相同的入口代码。</p><p id="0b00" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">打开一个新的终端来查看NGINX控制器日志(替换为您的控制器盒的名称):</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="3491" class="kt ku hh ma b fi me mf l mg mh">kubectl -n web log webcontroller-nginx-ingress-controller-8bdc8c665-f6xqm -f</span><span id="afa2" class="kt ku hh ma b fi ms mf l mg mh">...</span><span id="0789" class="kt ku hh ma b fi ms mf l mg mh">I0712 00:36:36.398883       8 status.go:86] new leader elected: webcontroller-nginx-ingress-controller-8bdc8c665-f6xqm</span></pre><p id="14dc" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们现在将创建以下入口(用您的域的入口替换<a class="ae ke" href="http://www.acme.com" rel="noopener ugc nofollow" target="_blank">acme.com</a>):</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="239d" class="kt ku hh ma b fi me mf l mg mh">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: acme-website<br/>  <strong class="ma hi">namespace: web</strong><br/>  annotations:<br/>    kubernetes.io/ingress.class: "nginx"<br/>spec:<br/>  rules:<br/>  - host: www.acme.com<br/>    http:<br/>      paths:<br/>      - path: /<br/>      backend:<br/>        serviceName: acme-website<br/>        servicePort: 80</span></pre><p id="b808" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在您的第一个终端上，创建入口:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="72e9" class="kt ku hh ma b fi me mf l mg mh">kubectl create -f multiplecontrollers/acme-website-ingress.yaml</span></pre><p id="937c" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在手表终端中，您会注意到以下内容:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="09e6" class="kt ku hh ma b fi me mf l mg mh">I0712 00:50:13.540522       8 controller.go:133] Configuration changes detected, backend reload required.                                                                                     <br/>I0712 00:50:13.540695       8 event.go:258] Event(v1.ObjectReference{Kind:"Ingress", Namespace:"acme", Name:"acme-website", UID:"02051a8b-a43f-11e9-a88d-0a580aed1b23", APIVersion:"extensions<br/>/v1beta1", ResourceVersion:"192541", FieldPath:""}): type: 'Normal' reason: <strong class="ma hi">'CREATE' Ingress acme/acme-website </strong>                                                                               <br/>I0712 00:50:13.624379       8 controller.go:149] Backend successfully reloaded.                                                                                                               <br/>[12/Jul/2019:00:50:13 +0000]TCP200000.000                                                                                                                                                     <br/>I0712 00:50:36.427547       8 status.go:309] updating Ingress acme/acme-website status from [] to [{ }]                                                                                       <br/>I0712 00:50:36.434886       8 event.go:258] Event(v1.ObjectReference{Kind:"Ingress", Namespace:"acme", Name:"acme-website", UID:"02051a8b-a43f-11e9-a88d-0a580aed1b23", APIVersion:"extensions<br/>/v1beta1", ResourceVersion:"192593", FieldPath:""}): type: 'Normal' <strong class="ma hi">reason: 'UPDATE' Ingress acme/acme-website</strong></span></pre><p id="0dc4" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">现在，如果您访问网站的URL，您将能够访问网站页面。如果您仍在查看控制器盒日志，您还会注意到传入的流量:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="4722" class="kt ku hh ma b fi me mf l mg mh">10.244.0.0 - [10.244.0.0] - - [12/Jul/2019:00:51:26 +0000] "GET / HTTP/1.1" 200 1855 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:68.0) Gecko/20100101 Firefox/68.0" 388 0.002 [acme-acme<br/>-website-80] [] 10.244.2.13:80 4446 0.002 200 0bed30fdf9d16bde887ed8e488b80735                                                                                                                <br/>10.244.0.0 - [10.244.0.0] - - [12/Jul/2019:00:51:27 +0000] "GET /favicon.ico HTTP/1.1" 404 178 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:68.0) Gecko/20100101 Firefox/68.0" 320 0.001 <br/>[acme-acme-website-80] [] 10.244.2.13:80 178 0.001 404 d91af2a400fd4230ec3dec8b0eaf713f</span></pre><p id="d9e1" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这里需要注意的一件重要事情是，<em class="lt">入口是在与服务</em>相同的名称空间中定义的。如果您在不同于目标服务的名称空间中创建入口，入口控制器仍将能够检测到入口更改。但是，它将无法获得端点，因此无法更新其配置。</p><p id="bc87" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">为了说明这一点，我们将特意在博客名称空间(即traefik的名称空间)中创建博客入口。</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="3ea2" class="kt ku hh ma b fi me mf l mg mh">apiVersion: extensions/v1beta1                                                                                                                                                                <br/>kind: Ingress                                                                                                                                                                                 <br/>metadata:                                                                                                                                                                                     <br/>  name: acme-blog-ingress                                                                                                                                                                     <br/>  <strong class="ma hi">namespace: blog </strong>                                                                                                                                                                            <br/>  annotations:                                                                                                                                                                                <br/>    kubernetes.io/ingress.class: "traefik"                                                                                                                                                    <br/>spec:                                                                                                                                                                                         <br/>  rules:                                                                                                                                                                                      <br/>  - host: blog.acme.com                                                                                                                                                                 <br/>    http:                                                                                                                                                                                     <br/>      paths:                                                                                                                                                                                  <br/>      - path: /                                                                                                                                                                               <br/>        backend:                                                                                                                                                                              <br/>          serviceName: acme-blog                                                                                                                                                              <br/>          servicePort: 80</span></pre><p id="91f9" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在您的第二个终端上，停止观察NGINX控制器，开始观察traefik控制器(替换为您的控制器盒的名称):</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="5143" class="kt ku hh ma b fi me mf l mg mh">kubectl -n blog log blogcontroller-traefik-65579ddcb4-7hqdz -f</span></pre><p id="d08e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">现在让我们创建博客入口(记得在入口规则中更改主机名):</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="9145" class="kt ku hh ma b fi me mf l mg mh">kubectl create -f acme-blog-ingress.yaml</span></pre><p id="3e19" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">您将在traefikcontroller日志中看到以下内容:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="364c" class="kt ku hh ma b fi me mf l mg mh">{"level":"error","msg":"Service not found for blog/acme-blog","time":"2019-07-12T01:02:20Z"}</span></pre><p id="c097" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">删除博客入口:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="d7d3" class="kt ku hh ma b fi me mf l mg mh">kubectl delete -f acme-blog-ingress.yaml</span></pre><p id="c54f" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">将其名称空间编辑为acme:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="643c" class="kt ku hh ma b fi me mf l mg mh">apiVersion: extensions/v1beta1                                                                                                                                                                <br/>kind: Ingress                                                                                                                                                                                 <br/>metadata:                                                                                                                                                                                     <br/>  name: acme-blog-ingress                                                                                                                                                                     <br/>  <strong class="ma hi">namespace: acme </strong>                                                                                                                                                                            <br/>  annotations:                                                                                                                                                                                <br/>    kubernetes.io/ingress.class: "traefik"                                                                                                                                                    <br/>spec:                                                                                                                                                                                         <br/>  rules:                                                                                                                                                                                      <br/>  - host: blog.acme.com                                                                                                                                                                 <br/>    http:                                                                                                                                                                                     <br/>      paths:                                                                                                                                                                                  <br/>      - path: /                                                                                                                                                                               <br/>        backend:                                                                                                                                                                              <br/>          serviceName: acme-blog                                                                                                                                                              <br/>          servicePort: 80</span></pre><p id="bb68" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">重建入口:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="2f44" class="kt ku hh ma b fi me mf l mg mh">kubectl create -f acme-blog-ingress.yaml</span></pre><p id="a171" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">再次检查控制器日志:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="f843" class="kt ku hh ma b fi me mf l mg mh">kubectl -n blog log blogcontroller-traefik-65579ddcb4-7hqdz -f</span><span id="e3a0" class="kt ku hh ma b fi ms mf l mg mh">{"level":"info","msg":"Server configuration reloaded on :8880","time":"2019-07-12T02:01:36Z"}</span></pre><p id="0eb6" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">现在，如果我们访问博客网址，我们也可以访问博客。</p><p id="d727" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">让我们在最后的实验前清理一下:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="13c3" class="kt ku hh ma b fi me mf l mg mh">kubectl delete -f acme-blog-ingress.yaml<br/>kubectl delete -f acme-website-ingress.yaml<br/>helm delete --purge blogcontroller<br/>helm delete --purge webcontroller</span></pre><h2 id="63ad" class="kt ku hh bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">使用单个公共负载平衡器、带有多个控制器的私有负载平衡器</h2><p id="898f" class="pw-post-body-paragraph ji jj hh jk b jl lo ii jn jo lp il jq jr lq jt ju jv lr jx jy jz ls kb kc kd ha bi translated">正如您在前面的实验中可能已经注意到的，无论何时部署入口控制器，默认情况下都会创建一个公共负载平衡器<em class="lt"/>。部署多个控制器意味着您将拥有多个公共负载平衡器。这可能会对成本产生明显的影响，尽管OCI在数据收费方面非常慷慨，但作为超级管理员，您应该密切关注这一点。</p><p id="4f09" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">现在，假设你有两个团队(团队网络和团队博客)，每个团队都有他们最喜欢的入口控制器(分别是NGINX和Traefik ),不管出于什么技术原因，他们都坚持使用他们最喜欢的。不管辣妹唱什么，2不可能变成1。</p><p id="bc01" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">事实证明，你可以通过设置正确的<a class="ae ke" href="https://github.com/oracle/oci-cloud-controller-manager/blob/master/docs/load-balancer-annotations.md" rel="noopener ugc nofollow" target="_blank">注释</a>来使用内部负载平衡器。我们在之前的<a class="ae ke" rel="noopener" href="/oracledevs/changing-load-balancer-shape-in-oracle-container-engine-oke-and-updating-dns-with-external-dns-7064f15cf600">中使用了负载平衡器注释，但是是为了改变负载平衡器的形状。但是如何用入口控制器做到这一点，然后公开应用程序呢？</a></p><p id="46c0" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">下面是对以前的部署架构的一点修改:</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mt"><img src="../Images/0a254eb05a7043d978b2a1dea0942534.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vn0bXe7mBMYS7gYygd5gAQ.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx">Using a public load balancer and multiple private load balancers</figcaption></figure><p id="1645" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在上图中，当用户访问网站或博客URL时，他们将使用公共负载平衡器。我们还希望网络和博客流量通过内部负载平衡器。</p><p id="2850" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这次我们将使用以下3个控制器:</p><ul class=""><li id="cb91" class="kf kg hh jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated">nginx-ingress:私有，网站</li><li id="bffc" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">traefik:私人，博客</li><li id="5161" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">haproxy:前端负载平衡器</li></ul><p id="b303" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">让我们首先在内部模式下部署nginx-ingress和traefik:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="0b44" class="kt ku hh ma b fi me mf l mg mh">helm install --name webcontroller stable/nginx-ingress \<br/>--namespace web \<br/>--set controller.name=web \<br/>--set rbac.create=true \<br/>--set controller.ingressClass=nginx \<br/><strong class="ma hi">--set controller.service.annotations."service\.beta\.kubernetes\.io/oci-load-balancer-internal"=true</strong></span></pre><p id="fe44" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">通过添加上面的注释，NGINX入口控制器创建的负载平衡器将只使用私有IP地址进行部署。只有来自VCN内部的请求才能到达它。</p><p id="0013" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">让我们为Traefik做同样的事情:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="5ac9" class="kt ku hh ma b fi me mf l mg mh">helm install --name blogcontroller stable/traefik \<br/>--namespace blog \<br/>--set rbac.enabled=true \<br/>--set kubernetes.ingressClass=traefik \<br/>--set service.annotations."service\.beta\.kubernetes\.io/oci-load-balancer-internal=true"</span></pre><p id="1e1e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">最后，让我们创建一个前端名称空间并部署HAProxy:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="684e" class="kt ku hh ma b fi me mf l mg mh">kubectl create ns frontend</span><span id="ab2f" class="kt ku hh ma b fi ms mf l mg mh">helm install --name frontendcontroller incubator/haproxy-ingress \<br/>--namespace frontend \<br/>--set defaultBackend.enabled=true \<br/>--set defaultBackend.name=defaultbackend \<br/>--set rbac.create=true \<br/>--set controller.ingressClass=haproxy</span></pre><p id="cc09" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">对于HAProxy，我们没有设置<em class="lt">OCI-load-balancer-internal = true</em>注释，因为我们希望它可以公开访问。当您登录到OCI控制台时，您可以验证这一点:</p><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es mu"><img src="../Images/6b01feeba5f0c28e73a70e6ba946623f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Xdvvm1s-e6CuDyfZ1SRJw.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx">Public and Private Load Balancers</figcaption></figure><p id="2699" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">现在，我们需要部署服务和入口。回想一下，我们希望流量通过专用负载平衡器进行路由。我之前也提到过，您的入口应该与您的服务在同一个名称空间中。由于我们希望强制流量通过特定路径，即内部负载平衡器，我们将使用上述方法的替代方法。在这种情况下，我们将使用<a class="ae ke" href="https://kubernetes.io/docs/concepts/services-networking/service/#externalname" rel="noopener ugc nofollow" target="_blank">外部名称</a>。正如文档所解释的，ExternalName类型的服务将服务映射到DNS名称。</p><p id="08bd" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">以下是文档中的解释:</p><blockquote class="mi mj mk"><p id="13af" class="ji jj lt jk b jl jm ii jn jo jp il jq ml js jt ju mm jw jx jy mn ka kb kc kd ha bi translated">当查找主机<code class="du mo mp mq ma b"><strong class="jk hi"><em class="hh">my-service.prod.svc.cluster.local</em></strong></code>时，集群DNS服务返回一个值为<code class="du mo mp mq ma b"><strong class="jk hi"><em class="hh">my.database.example.com</em></strong></code>的<code class="du mo mp mq ma b"><strong class="jk hi"><em class="hh">CNAME</em></strong></code>记录。访问<code class="du mo mp mq ma b"><strong class="jk hi"><em class="hh">my-service</em></strong></code>的工作方式与其他服务相同，但关键区别在于重定向发生在DNS级别，而不是通过代理或转发。</p></blockquote><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="d807" class="kt ku hh ma b fi me mf l mg mh"><strong class="ma hi">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: my-service<br/>  namespace: prod<br/>spec:<br/>  type: ExternalName<br/>  externalName: my.database.example.com</strong></span></pre><p id="ff59" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">然而，在Kubernetes文档<a class="ae ke" href="https://kubernetes.io/docs/concepts/services-networking/service/#externalname" rel="noopener ugc nofollow" target="_blank">中还有一个小注释</a>:</p><blockquote class="mi mj mk"><p id="51fd" class="ji jj lt jk b jl jm ii jn jo jp il jq ml js jt ju mm jw jx jy mn ka kb kc kd ha bi translated">ExternalName接受IPv4地址字符串，但作为由数字组成的DNS名称，而不是作为IP地址。CoreDNS或ingress-nginx不会解析类似IPv4地址的ExternalName，因为external name旨在指定规范的DNS名称。</p></blockquote><p id="c3ac" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">由于类似IPv4地址的外部名称<em class="lt">不会</em>解析，我们可以使用IPv4地址来强制流量通过内部负载平衡器。</p><p id="3ae7" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">acme名称空间中的网站和博客服务仍然存在，因此我们只需要创建以下内容:</p><ol class=""><li id="0a80" class="kf kg hh jk b jl jm jo jp jr kh jv ki jz kj kd mv kl km kn bi translated">类别为“nginx”的网站入口。这将允许内部nginx控制器对网站服务进行必要的路由。</li><li id="a65c" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd mv kl km kn bi translated">类别为“traefik”的博客入口。这将允许内部traefik控制器对博客服务进行必要的路由。</li></ol><p id="a225" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">当使用2个公共负载平衡器时，上述2个入口与上一个练习中的入口相同。我们可以让2个入口保持原样，在清理过程中不删除它们，但我想在这里更清楚地说明当前场景中发生了什么。</p><p id="b2e4" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们还将创建:</p><ol class=""><li id="310a" class="kf kg hh jk b jl jm jo jp jr kh jv ki jz kj kd mv kl km kn bi translated">ExternalName类型的acme网站服务，其externalName值是由NGINX控制器创建的内部负载平衡器的专用IP地址</li><li id="c3dd" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd mv kl km kn bi translated">ExternalName类型的acme-blog服务，其externalName值是由Traefik控制器创建的内部负载平衡器的专用IP地址。</li><li id="abed" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd mv kl km kn bi translated">最后是类“haproxy”的2个入口，其目标服务是网站和博客的2个外部名称服务。</li></ol><p id="9b1a" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">所有的yaml文件都可以在Ingres controllers/private目录下找到。</p><p id="91d5" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">首先，编辑<strong class="jk hi">所有</strong>入口，并像以前一样将“acme.com”更改为您的域。</p><p id="41c2" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">接下来获取负载平衡器的私有IP地址:</p><p id="6323" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">一旦nginx-ingress和traefik控制器部署完毕，获取它们的私有IP地址。</p><p id="927e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">Nginx:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="d684" class="kt ku hh ma b fi me mf l mg mh">kubectl -n web get svc -o wide                                                                                                                                               <br/>NAME                                          TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE   SELECTOR                                                         <br/>webcontroller-nginx-ingress-default-backend   ClusterIP      10.96.44.162           80/TCP                       29s   app=nginx-ingress,component=default-backend,release=webcontroller<br/>webcontroller-nginx-ingress-web               LoadBalancer   10.96.54.89    <strong class="ma hi">10.0.12.23</strong>    80:30626/TCP,443:30352/TCP   29s   app=nginx-ingress,component=web,release=webcontroller</span></pre><p id="d8f8" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">Traefik:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="3a28" class="kt ku hh ma b fi me mf l mg mh">kubectl -n blog get svc -o wide                                                                                                                                              <br/>NAME                     TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE   SELECTOR                                                                              <br/>blogcontroller-traefik   LoadBalancer   10.96.236.78   <strong class="ma hi">10.0.12.26</strong>    80:30668/TCP,443:32269/TCP   86s   app=traefik,release=blogcontroller</span></pre><p id="ec7b" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">编辑frontend-website-ingress.yaml并更改externalName值:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="df1e" class="kt ku hh ma b fi me mf l mg mh">kind: Service                       <br/>apiVersion: v1<br/>metadata:<br/>  name: acme-website<br/>  namespace: frontend<br/>spec:<br/>  type: ExternalName<br/>  externalName: <strong class="ma hi">10.0.12.23</strong><br/>  ports:<br/>  - port: 80<br/>---<br/>apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: acme-website<br/>  namespace: frontend<br/>  annotations:                        <br/>    kubernetes.io/ingress.class: "haproxy"                       <br/>spec:<br/>  rules:<br/>  - host: www.acme.com<br/>    http:<br/>      paths:<br/>      - path: /<br/>        backend:<br/>          serviceName: acme-website                                  <br/>          servicePort: 80</span></pre><p id="8d1e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">对frontend-website-ingress.yaml重复上述操作，并更改externalName值。</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="a51c" class="kt ku hh ma b fi me mf l mg mh">kind: Service                       <br/>apiVersion: v1<br/>metadata:<br/>  name: acme-blog<br/>  namespace: public<br/>spec:<br/>  type: ExternalName<br/>  externalName: <strong class="ma hi">10.0.12.26</strong><br/>  ports:<br/>  - port: 80<br/>---<br/>apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: acme-blog<br/>  namespace: public<br/>  annotations:                        <br/>    kubernetes.io/ingress.class: "haproxy"                       <br/>spec:<br/>  rules:<br/>  - host: blog.acme.com<br/>    http:<br/>      paths:<br/>      - path: /<br/>        backend:<br/>          serviceName: acme-website                                  <br/>          servicePort: 80</span></pre><p id="7453" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">应用清单:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="f1e6" class="kt ku hh ma b fi me mf l mg mh">kubectl create -f ingresscontrollers/private/</span><span id="9411" class="kt ku hh ma b fi ms mf l mg mh">ingress.extensions/acme-blog-ingress created                                                                                                                                                  <br/>deployment.apps/acme-blog created                                                                                                                                                             <br/>service/acme-blog created                                                                                                                                                                     <br/>ingress.extensions/acme-website created                                                                                                                                                       <br/>deployment.apps/acme-website created                                                                                                                                                          <br/>service/acme-website created                                                                                                                                                                  <br/>service/acme-blog created                                                                                                                                                                     <br/>ingress.extensions/acme-blog created                                                                                                                                                          <br/>service/acme-website created                                                                                                                                                                  <br/>ingress.extensions/acme-website created</span></pre><p id="2a64" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">最后，从OCI控制台或使用kubectl获取负载平衡器的公共IP地址:</p><pre class="ix iy iz ja fd lz ma mb mc aw md bi"><span id="0be0" class="kt ku hh ma b fi me mf l mg mh">kubectl -n frontend get svc -o wide                                                                                                                                        <br/>NAME                                                TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)                      AGE   SELECTOR                                                <br/>frontendcontroller-haproxy-ingress-controller       LoadBalancer   10.96.41.118   <strong class="ma hi">129.146.95.188</strong>   80:30746/TCP,443:30777/TCP   83s   app=haproxy-ingress,component=controller,release=fronten<br/>dcontroller                                                                                                                                                                                   <br/>frontendcontroller-haproxy-ingress-defaultbackend   ClusterIP      10.96.158.93              8080/TCP                     83s   app=haproxy-ingress,component=defaultbackend,release=fro<br/>ntendcontroller</span></pre><p id="8b7e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">更新OCI DNS中网站和博客的2个条目(用您的域替换“acme.com ”),并将IP地址设置为公共负载平衡器的IP地址:</p><ul class=""><li id="55ca" class="kf kg hh jk b jl jm jo jp jr kh jv ki jz kj kd kk kl km kn bi translated">www.acme.com</li><li id="30a5" class="kf kg hh jk b jl ko jo kp jr kq jv kr jz ks kd kk kl km kn bi translated">blog.acme.com</li></ul><p id="4a4d" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">请记住点击“发布更改”以使其生效，并测试对您的网站和博客的访问。</p><h2 id="962b" class="kt ku hh bd kv kw kx ky kz la lb lc ld jr le lf lg jv lh li lj jz lk ll lm ln bi translated">摘要</h2><p id="62f8" class="pw-post-body-paragraph ji jj hh jk b jl lo ii jn jo lp il jq jr lq jt ju jv lr jx jy jz ls kb kc kd ha bi translated">我们在OKE上用4种不同的入口控制器对<a class="ae ke" rel="noopener" href="/@lmukadam/experimenting-with-ingress-controllers-on-oracle-container-engine-oke-part-1-5af51e6cdb85?source=friends_link&amp;sk=ec2339dfb787af382b38d7edd12877f5">进行了实验。然后，我们查看了入口类及其用途，并在一个集群上同时部署了多个控制器，使用入口类来确保相应地路由请求。最后，我们看了私有负载平衡器如何也可以与多个入口控制器一起使用，然后公开地公开服务。</a></p><p id="bf9e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们使用的例子和理由相当琐碎和做作，但我希望它们能够说明当您在Kubernetes和Oracle云基础设施上部署应用程序时所具有的灵活性。</p><p id="97ff" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">其他参考资料:</p><p id="dcc0" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><a class="ae ke" href="https://kubernetes.github.io/ingress-nginx/user-guide/multiple-ingress/" rel="noopener ugc nofollow" target="_blank"> NGINX和多个入口控制器</a> <br/> <a class="ae ke" href="https://github.com/helm/charts/issues/10275" rel="noopener ugc nofollow" target="_blank">使用带有服务注释的helm部署Traefik</a><br/><a class="ae ke" href="https://docs.cloud.oracle.com/iaas/Content/ContEng/Tasks/contengcreatingloadbalancer.htm#CreatingInternalLoadBalancersinPublicandPrivateSubnets" rel="noopener ugc nofollow" target="_blank">OCI文档:创建内部负载平衡器</a> <br/> <a class="ae ke" href="https://kubedex.com/ingress/" rel="noopener ugc nofollow" target="_blank">入口控制器比较</a> <br/> <a class="ae ke" href="https://stackoverflow.com/questions/51878195/kubernetes-cross-namespace-ingress-network" rel="noopener ugc nofollow" target="_blank"> Kubernetes跨名称空间入口</a></p></div></div>    
</body>
</html>