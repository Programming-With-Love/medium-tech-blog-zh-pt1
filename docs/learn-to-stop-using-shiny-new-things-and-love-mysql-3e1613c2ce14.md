# 学会停止使用闪亮的新事物，热爱 MySQL

> 原文：<https://medium.com/pinterest-engineering/learn-to-stop-using-shiny-new-things-and-love-mysql-3e1613c2ce14?source=collection_archive---------0----------------------->

Marty Weiner | Pinterest 工程师，BlackOps

我遇到的很多初创公司都想用最新、最热门的技术来做一些很酷但不具有技术突破性的东西。我还没有见过一家初创公司建造时间机器、传送机或量子社交网络，这实际上需要一些令人惊叹的新技术。他们有令人敬畏的新想法和脚踏实地的技术要求，所以我一直在想，当他们需要的只是一个好的、值得信赖的数据库时，他们为什么要选择这个闪亮的(而且有风险的)新东西。我认为这是因为许多人认为，建设最新和最大的需要最新和最大的！

事实证明，这只是人们追求闪亮和新奇的三个糟糕原因(陷阱)之一。原因二是人们错误地认为旧的东西速度慢，功能不丰富或者不能扩展。“MySQL 是缓慢的，”他们说。“Java 很慢，”我听说过。“Python 不会扩展，”他们声称。这些都不是真的。

人们追求闪亮的第三个原因是，旧技术没有新技术那样被大肆宣传。年轻的公司需要与老派不同，更大胆、更有激情，并承诺实现你最大胆的梦想。但是大多数新技术的推销通常并不坦率地谈到它们的许多失败模式。

在我们早期，我们陷入了第三个陷阱。我们在扩展架构的过程中经历了很多成长的烦恼。呼声最高、最激动的数据库公司不断来找我们，说他们会解决我们所有的可伸缩性问题。但是没有人告诉我们 MySQL 的优点，可能是因为 MySQL 只是工作，人们知道它。

![](img/5cdce8d9e9968a1eb97935c8e80caee5.png)

通过这次挑战，我从创建 Pinterest 中学到了两个最重要的经验:

*   不要做最大的。如果你是一项技术的最大用户，你的挑战将会被大大放大。
*   保持简单。不管你用什么技术，都会失败。

在 Pinterest 经历了一年的快速扩张后，我们有了 MySQL、Memcache、MongoDB、Redis、Cassandra、Membase 和 Elastic Search。所有的东西都着火了，并以它们自己特殊的方式破裂。我们希望简化并摆脱所有花哨的东西，但我们也希望有一些东西可以与我们一起扩展到月球。是时候开始我们伟大的重建了。为了帮助指导我们和我们的选择，我们构建了一组适用于每种不同技术的问题:

*   *技术满足你的需求吗？*
    固化你的要求。您需要简单查找、有序查找和/或按地理位置查找吗？图走？一种技术可能无法支持您的所有需求，但当它支持您的所有需求时，这是一件好事。
*   *它的伸缩性如何？*
    有些技术是为大规模设计的，有些不是。你可能需要在上面放一点魔法。随着规模的扩大，复杂性增加，灵活性降低。请记住这一点，避免过早扩展。
*   成本合理吗？
    考虑支持合同或许可，看看没有支持合同你是否还能活下去。如果你是一家天使投资的初创公司，理想情况下，你会把钱花在灯光和拉面上，而不是大型主机上。
*   *技术有多成熟？*
    产品的成熟度是除了基本需求之外你可以问的最重要的问题。这是我将花大部分时间写这篇文章的地方。

## 成熟是自然的

人们越努力、越热情地推动一项技术，他们就会越快地遇到错误或性能问题，修复它们，并有希望将修复结果反馈给整个社区使用。

如果技术简单，成熟会快得多。让一个五行 Python 程序打印“Hello，World”以避免错误需要 30 个人秒，而一个处理全球分布式银行交易的程序将需要许多个人年才能成熟，这是由于必须解决的复杂性。

所以，让我们把这个方程化。成熟随着血汗而增长，但随着复杂性的增加而变慢。

成熟度=(血+汗)/复杂度

(我真的很想在等式中加入一些 e，I 和π，但就是无法证明这一点。然而……)

随着技术的发展，合作发生了，理解加深了，丰富的知识积累了。随着技术本身变得越来越稳定和美观，文档化和简化也在发生，边界和界限也在被测试和拓宽。

你不想在成熟度等式的另一端。那里有龙:

*   招聘将更加困难试试在谷歌上搜索 MySQL admin 和 Cassandra admin。试着走到旧金山繁忙的人行道上，大喊你需要一个 MySQL 管理员。你会找到的。Hbase，不太可能。
*   *你会发现最小社区*
    现在是凌晨 2 点，你会收到一条奇怪的错误消息“48fe1a 是不透明的”(这是我从 Membase 得到的一条真实的错误消息)。搞什么鬼。*k 这是什么意思？糟糕，谷歌上没有任何答案。相反，我不记得上一次我的 MySQL 问题没有得到回答，有人称提问者为 nOObXor 是什么时候了。
*   *你更有可能失败，可能是灾难性的*
    除了 MySQL 之外，我们曾经使用过的几乎所有技术都出现过意外的数据丢失。即使在最糟糕的日子里，当硬盘崩溃时，我们仍然设法找到了某人编写的一个脚本来进行魔法巫术，以再次获得我们的 MySQL 数据并过上新的一天。其他技术让我们原地踏步，因为没有人遇到过同样的问题，或者他们没有努力深入恢复他们的数据，或者他们没有将修复贡献给社区。顺便说一句，我非常感谢在早期，除了 MySQL 之外，我们从来没有把我们数据的黄金拷贝托付给任何其他系统。

有时候你不得不在这个成熟度比率的坏的一端。例如，如果你必须为你的时间机器安装一个通量电容器，要意识到你不可能轻易的租到它。将会有一个最小的在线社区来帮助你调试为什么你只能回到 100 年前而不是 1000 年前。支持可能无法帮助你理解为什么马蒂·小飞侠现在被困在超新星中。

如果你在前沿，你会遇到世界其他地方从未见过的新问题。它们的调试难度会增加 10 倍，并且可能需要超出当前工程师舒适范围的知识深度。你必须埋头苦干，努力学习，快速进步。我给你虚拟的拥抱和赞美。我去过那里。这将是艰难的。记录你的发现，合作和交流。

如果你正在创建或发展一家公司，并且你的规模还不算大，除了基本要求之外，考虑成熟度是你最重要的因素。问问你自己 MySQL 足以满足我的需求吗？如果有，那就用吧。如果你想知道 MySQL 是否足够快，答案是*是的*。甚至比 fast 还要好，MySQL 的性能会比较一致。

## 最后的话

所以我已经为一堆技术哭泣，但我似乎对 MySQL 有一种近乎浪漫的东西。我想花点时间提一下，MySQL 虽然成熟，但并不能解决你所有的问题。有时候，你不得不冒险远离成熟带来的温暖。

*   *笛卡尔距离*
    如果你需要在二维空间中搜索附近的点，在 MySQL 中以 [Geohashes](http://en.wikipedia.org/wiki/Geohash) 的形式存储坐标会很好([这里有一个 XKCD 漫画](http://xkcd.com/426/)可以帮忙)。三维可能也能很好地工作。但是如果你需要大的 N 维搜索空间，我不知道在 MySQL 中有效地存储和检索它们的好方法。例如，如果您已经创建了一个为某些输入生成特征向量的模型，并且您想要查看两个输入是否相似，您可能会发现自己需要存储 N 维点。经典的例子包括确定两个图像是否相似但不完全相同。对于这种情况，考虑构建一个分布式 RP/KD 树(很乐意合作！给我发邮件！).
*   *写入速度*
    MySQL 提供完全写入一致性。如果你愿意用“完整”来换取“最终”的一致性，你的写作会快得多。HBase、Cassandra 和其他类似的技术写入更新日志的速度非常快，代价是读取速度变慢(读取现在必须读取存储的信息并遍历更新日志)。这是一个很好的反转，因为更容易缓存读取并使它们更快。
*   我对 MySQL 最大的抱怨是它仍然生活在 1994 年(宽松的裤子和..英皇家空军阶级最低的兵..[玛卡丽娜](https://www.youtube.com/watch?v=XiBYM6g8Tck)。那时数据库的许多用途都需要关系查询。没有社交网络。MySpace 再过九年都不会出现了！所以 MySQL 是由树构建的，没有队列的概念。插入到 B 树中是 O(lg(N))运算(假设快乐平衡)。但今天，社交网络是互联网上的主要力量，它们严重依赖于队列。我们要超级快的 O(1)入队！我的建议是不要用 MySQL 做提要。开销太大了。相反，考虑一下 [Redis](http://redis.io/) ，尤其是如果你还是一个小团队的话。Redis 速度非常快，拥有可以快速插入和检索的列表。如果你是一家较大的公司，并且可以雇佣人员来维护它，那么考虑 HBase。它对我们的反馈很有效。
*   *日志*
    看在万物神圣的份上，*不要在 MySQL* 存储日志。如前一段所述，MySQL 将事物存储在树中。原木不应该生活在树上(这么说就怪了……)。将您的日志发送到 [Kafka](http://kafka.apache.org/) ，然后使用 [Secor](https://github.com/pinterest/secor) 从 Kafka 读取并运送到 S3。然后疯狂使用 [EMR](http://aws.amazon.com/elasticmapreduce/) 、 [Qubole](http://qubole.com) 或你的地图缩小平台。
*   *超越一个框框*
    如果你在这个位置，你已经优化了所有的查询(无连接、外键、distinct 等。)，并且您现在正在考虑使用 read slaves，那么您需要扩展到一个以上的 MySQL 服务器。MySQL 不会开箱为你做这些，但这并不难。我们有一个解决方案，一旦我写完博文，你就可以阅读并了解我们是如何做到这一点的。同时，在 marty@pinterest.com 给我打电话，我会让你现在就开始工作。

Marty Weiner 是 Pinterest 的工程经理。跟随他在 [*推特*](https://twitter.com/MartyWeiner) *和*[*Pinterest*](https://pinterest.com/martaaay)*上冒险。有兴趣加入他的团队吗？查看我们的* [*招聘网站*](https://about.pinterest.com/en/careers/engineering-product) *。*

*获取 Pinterest 工程新闻及更新，关注我们的工程*[*Pinterest*](https://www.pinterest.com/malorie/pinterest-engineering-news/)*[*脸书*](https://www.facebook.com/pinterestengineering)*[*推特*](https://twitter.com/PinterestEng) *。有兴趣加入团队吗？查看我们的* [*招聘网站*](https://about.pinterest.com/en/careers/engineering-product) *。***