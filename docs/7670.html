<html>
<head>
<title>Rest easy with Json and Binary</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Json和二进制代码让您高枕无忧</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/rest-easy-with-json-and-binary-f218f7e141be?source=collection_archive---------0-----------------------#2017-03-03">https://medium.com/walmartglobaltech/rest-easy-with-json-and-binary-f218f7e141be?source=collection_archive---------0-----------------------#2017-03-03</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/4a5811761a3c490088fc6c2e9fb3d792.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*90DD64NiK-SER9IV0eZspw.jpeg"/></div></div><figcaption class="hq hr et er es hs ht bd b be z dx">Photo credit: <a class="ae hu" href="https://pixabay.com/en/tiger-lazy-sleeping-white-animal-1285229/" rel="noopener ugc nofollow" target="_blank">Pexels</a></figcaption></figure><div class=""/><p id="88c1" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在基于SOA的微服务模型中，大多数POST &amp; PUT服务契约通过HTTP(S)使用JSON或Xml有效负载。但是，如果您处理图像或PII或HIPAA数据，可能需要将二进制数据与JSON一起发送。</p><p id="2e27" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这篇博客解释了实现这一目标所需的方法和设置。我们假设您熟悉Java-JAX-RS RESTful服务设置。</p><p id="907a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">有两个选项可以实现这一点:</p><ol class=""><li id="a3a1" class="js jt hx iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated"><strong class="iw hy">对二进制数据使用Base64编码</strong>,以便将其转换为文本——然后可以与<em class="kb">应用程序/json </em>内容类型一起发送，作为json有效负载的另一个属性。这是一个可以接受的解决方案，但另一方面是它的<em class="kb">一点也不高效，尤其是当你处理低带宽和间歇性网络的时候。这是因为编码的图像数据将比原始数据增加大约30%的有效载荷大小。</em></li><li id="85d2" class="js jt hx iw b ix kc jb kd jf ke jj kf jn kg jr jx jy jz ka bi translated">使用<a class="ae hu" href="https://www.ietf.org/rfc/rfc1867.txt" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hy">多部分表单数据</strong> </a>作为请求的内容类型，其中各个部分在<em class="kb">多部分</em>中，内容类型为<em class="kb">应用程序/json </em>和<em class="kb">应用程序/八位字节流。</em>根据<a class="ae hu" href="https://www.ietf.org/rfc/rfc2388.txt" rel="noopener ugc nofollow" target="_blank"> RFC </a>，一个应用多部分可以定义自己的内容类型。多部分表单数据本质上是一个由<strong class="iw hy">附件</strong>组成的列表，其中每个附件通常是一个文本或文件。</li></ol><p id="6b2a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">对于我们的用例，我们使用<strong class="iw hy">选项2 </strong>来优化我们正在发送的图像尺寸的性能。我们概述了编写和测试这样一个RESTful服务的几个重要步骤。(这个解决方案是基于Spring，JAX-RS开发框架和cURL来测试的)。</p><p id="4126" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">JAX-RS支持开箱即用的多部分表单数据提供者。<em class="kb">提供者</em> 是序列化&amp;反序列化输入/输出流的实体，以便您的Java服务接口可以直接与POJOS一起工作。Jax-Rs拥有几乎所有标准内容类型的提供者——JSON、文本、二进制等。提供者根据各种内容类型进行注册，以便在读取<em class="kb">内容类型</em>时，选择合适的提供者。为了处理多部分表单数据，您需要在附件的每个部分指定<strong class="iw hy">内容类型</strong>。</p><p id="2c0a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hy">为您的Java服务编写REST接口</strong></p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="bf53" class="kq kr hx km b fi ks kt l ku kv">@Path("/employees/{id}/employeeDetails")<br/>@POST<br/>Response submitEmployeeDetails(<br/>@PathParam(value="id") UUID empId,<br/>@Multipart(value="depId", type="application/json"; required=false) UUID deptId,<br/>@Multipart(value="details", type="application/json") EmployeeDetails employeeDetails,<br/>@Multipart(value="photoId",type="application/octet-stream", required=false) InputStream imageInputStream) throws ServiceException;</span></pre><p id="05e0" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">MultipartProvider必须在CXF总线中注册为提供者</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="12b0" class="kq kr hx km b fi ks kt l ku kv">&lt;bean id="multiPart" class="<strong class="km hy">org.apache.cxf.jaxrs.provider.MultipartProvider</strong>"/&gt;</span><span id="4269" class="kq kr hx km b fi kw kt l ku kv">&lt;jaxrs:providers&gt;<br/> <strong class="km hy">&lt;ref bean="multipartProvider"/&gt;</strong><br/>&lt;/jaxrs:providers&gt;</span></pre><blockquote class="kx ky kz"><p id="23e6" class="iu iv kb iw b ix iy iz ja jb jc jd je la jg jh ji lb jk jl jm lc jo jp jq jr ha bi translated">这是相当不明显但重要的一步。即使在运行时调用服务时选择了提供者，上下文初始化也不会发生，并且各个附件的反序列化会导致异常。您可能最终要调试几个小时来找出问题所在。</p></blockquote><p id="a7bd" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hy">测试服务</strong></p><p id="0a43" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果您使用PostMan或Advanced REST客户端，测试这一点可能是一个挑战，因为这些客户端只允许“文本”或“文件”作为附件。<strong class="iw hy"> cURL </strong>解决了这个问题，它允许我们使用“<strong class="iw hy"> type </strong>属性在表单数据的每个部分显式设置内容类型。</p><pre class="kh ki kj kk fd kl km kn ko aw kp bi"><span id="1b75" class="kq kr hx km b fi ks kt l ku kv">curl -X POST -H "Accept: application/json" -F "depId=<strong class="km hy">\"596ac151-53ea-460c-bd5f-2e5665307971\"</strong>;<strong class="km hy">type=application/json</strong>" -F "details=<strong class="km hy">{\"firstName\":\"John\",\"lastName\":\"Doe\"};type=application/json</strong>" -F "photoId=<strong class="km hy">@/testdir/john_doe.png;type=image</strong>" "http://yourhost.domain.com:8080/app/employees/ddbe8f98-75d4-4764-8f48-39e4a68ca187/employeeDetails"</span></pre><p id="c035" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hy">就是这样，伙计们！</strong></p><p id="4372" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">您已经准备好使用一个在单个有效负载中同时接受JSON和Binary的服务了。</p></div></div>    
</body>
</html>