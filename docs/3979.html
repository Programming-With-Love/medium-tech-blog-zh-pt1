<html>
<head>
<title>Active-active API Gateway: a step-by-step guide with terraform code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">主动-主动API网关:带terraform代码的分步指南</h1>
<blockquote>原文：<a href="https://medium.com/globant/active-active-api-gateway-a-step-by-step-guide-with-terraform-code-9882d6c2609a?source=collection_archive---------0-----------------------#2022-09-15">https://medium.com/globant/active-active-api-gateway-a-step-by-step-guide-with-terraform-code-9882d6c2609a?source=collection_archive---------0-----------------------#2022-09-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/b96b5f81a1170734dd8db071e0145dcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*d2VZFb-qLkQ-gjPb"/></div></div></figure><p id="ba23" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">应用程序基础架构和灾难恢复策略各不相同，这取决于每个公司的需求。如果没有坚固的基础设施，那么拥有坚固的代码又有什么意义呢？采用主动-主动策略，尽管比其他策略(如指示灯或温暖袖手旁观)更昂贵；确保我们的客户不会受到主站点故障的影响，并且他们始终由延迟最小的区域提供服务。这里我们将解释部署主动-主动API网关的一步一步，并分享一些有用的代码。</p><p id="4101" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">本文将回顾以下部分:</p><ul class=""><li id="4db9" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated">体系结构</li><li id="7bc6" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">所需资源的部署</li><li id="d3c4" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">结论</li></ul><h1 id="217d" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">体系结构</h1><p id="5eaf" class="pw-post-body-paragraph ip iq hh ir b is kz iu iv iw la iy iz ja lb jc jd je lc jg jh ji ld jk jl jm ha bi translated">我们将部署的基础架构:</p><figure class="le lf lg lh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/de1518e187837d438b86bac6280c4f82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cFsWS7FI8m2SWb6d"/></div></div></figure><p id="fa8f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">流程如下所示:</p><ul class=""><li id="06a8" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated">用户去我们的网站</li><li id="8a1f" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">Route53重定向到延迟最小的区域，或者如果其中一个区域出现故障，则重定向到工作正常的区域</li><li id="004d" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">HTTP API根据第三方OAuth对用户进行身份验证</li><li id="9934" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">如果用户通过了正确的身份验证，它将重定向到负载平衡器</li><li id="d906" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">负载平衡器将根据WAF规则检查是否允许继续</li><li id="4333" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">如果允许继续，用户将被定向到相应的应用程序</li></ul><p id="6e82" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因为Amazon Cognito不支持主动-主动API网关配置，所以我们使用一个定制的解决方案来提供JSON Web令牌(JWT)进行身份验证。这个定制的解决方案促使我们决定实现HTTP API，而不是Rest Api。我们可以使用带有Lambda的JWT授权器，但是我们更喜欢这种更简单的方法。此外，HTTP apis比它们的Rest对等物更便宜(关于API之间的AWS比较，你可以参考官方文档<a class="ae li" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-vs-rest.html" rel="noopener ugc nofollow" target="_blank">这里</a>)。</p><h1 id="2cbb" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">部署资源</h1><ol class=""><li id="7e97" class="jn jo hh ir b is kz iw la ja lj je lk ji ll jm lm jt ju jv bi translated">创建托管区域</li></ol><p id="4cf5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">除非您已经有了要在其中创建记录的托管区域，否则您应该创建一个。为此，请转到AWS控制台Route53，然后单击创建托管区域:</p><figure class="le lf lg lh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ln"><img src="../Images/33fde553137b14d647bd9215b40c8574.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Q3kAhOmHS2SsiiyU"/></div></div></figure><p id="c808" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在您的域名中，您需要指明您的托管区域的域名。域名是所有子域名的后缀。例如，如果你的域名是my-domain.com，那么你将能够创建子域名，如cool.my-domain.com和supercool.my-domain.com。此外，您需要将您的托管区域标记为Public，因为我们希望该区域可以公开访问。</p><figure class="le lf lg lh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ln"><img src="../Images/2b1fe8250c4c407d7b59958520cfd745.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RHgh_xZ2pgQMlgSh"/></div></div></figure><p id="7e0b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">创建托管区域时，AWS会自动创建两条记录:一条是NS类型的，另一条是SOA类型的。NS代表名称服务器，指的是包含您的DNS的服务器。SOA代表授权开始(Start of Authority)，拥有与域名相关的所有管理信息，比如你的姓名和联系方式(这与RFC 1035规则有关，你可以在这里阅读更多<a class="ae li" href="https://www.rfc-editor.org/rfc/rfc1035" rel="noopener ugc nofollow" target="_blank"/>)。</p><p id="d364" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">2.创建API和API记录</p><p id="9346" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一旦你创建了你的托管区域，首先你需要创建你的自定义域名和你想要公开的API。因此，您应该转到API网关控制台。</p><p id="4263" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">3.创建一个与您的托管区域的后缀相匹配的域名</p><p id="a3f6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当创建您的域名时，您必须指明:它的名称、最低TLS版本、端点配置，如果它有ACM证书，您必须选择它。</p><figure class="le lf lg lh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ln"><img src="../Images/c8b86512ac2de251fa95326c978fd8b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WDAfKyPbr6-keIww"/></div></div></figure><p id="13d2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">4.创建HTTP API</p><p id="9511" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">创建HTTP API时，您需要:</p><ul class=""><li id="50d6" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated">添加集成</li><li id="3d6c" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">指明HTTP API名称</li><li id="a1aa" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">配置路线</li><li id="a3fb" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">添加VPC链接</li></ul><p id="efcc" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">简而言之，这是如何工作的？用户将向您的{yourcustomdomainname}/{api}发出请求。在这个例子中，它可能是:devops.cool.my-domain.com/learn-api。请注意，您的自定义域名以我们在第一个实例中创建的托管区域的域名结尾。</p><p id="63f5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当您创建集成时，您正在指示api应该将请求重定向到哪里。在我们的例子中，我们将流量重定向到一个已经存在的应用负载平衡器。如果使用ACM证书，在集成中确保HTTPS主机名和映射主机名的参数与证书的主机名相匹配是很重要的。否则，它将抛出一个未经授权的错误。</p><p id="be3a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">api的路由指定路径。按照我们的例子，也许我希望我的api公开不同的路径，比如“aws-courses”和“gcp-courses”，在这种情况下，我的api将有两条路径，每条路径一条；可从以下网址获得:</p><ul class=""><li id="8f2b" class="jn jo hh ir b is it iw ix ja jp je jq ji jr jm js jt ju jv bi translated">devops.cool.my-domain.com/learn-api/aws-courses</li><li id="3dcf" class="jn jo hh ir b is jw iw jx ja jy je jz ji ka jm js jt ju jv bi translated">devops.cool.my-domain.com/learn-api/gcp-courses</li></ul><p id="711d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">每条路线也有方法。可能的方法有POST、PUT、PATCH、GET、DELETE。如果您希望用户能够使用这些方法中的任何一种，您可以指定any作为该特定路线的方法。</p><p id="a11b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">VPC链接至关重要，因为没有它，api将无法访问它应该重定向到的资源。</p><p id="386f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果你想知道更多关于api是如何工作的，你可以在<a class="ae li" href="https://www.alexdebrie.com/posts/api-gateway-elements/" rel="noopener ugc nofollow" target="_blank">这篇文章</a>上找到更多信息。</p><p id="a339" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">重要提示:由于我们正在部署主动-主动配置，请确保自定义域名和您的路由部署在不同的区域，但命名相同。在我们的示例中，两个自定义域名都应该是“devops.cool.my-domain.com ”,并且两个api路由应该是相同的。</p><p id="bcfd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在我们的例子中，我们需要实现一个定制的授权器。可以从AWS api网关控制台向Api添加授权者，如下所示:</p><figure class="le lf lg lh fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lo"><img src="../Images/d2f498a213a81b55e0c636d0ba285ad6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*s9xfyoFQQ_MiQX5l"/></div></div></figure><p id="e98a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在写着姓名的地方，你应该写上你想要的授权人的姓名。如果您留下$request.header.Authorization，这意味着授权令牌应该包含在请求中。发布者URL是授权服务器端点，受众是注册的客户端id。如果在使用令牌执行请求时，令牌与列出的任何受众都不匹配，api将返回一个授权错误。</p><p id="d9b4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">5.创造53项CNAME纪录</p><p id="fa2b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一旦设置了api网关，就为api网关设置DNS记录。这是令人困惑的部分。</p><p id="a7fe" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">第一步:为你的自定义域名创建一个延迟记录</p><p id="3229" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">第二步:为您的应用程序负载平衡器创建一个CNAME记录。</p><p id="b9d3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">让我们深入了解其中的每一个步骤。</p><p id="89e3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">第一步是设置延迟记录，每个区域一个。每个延迟记录应该具有完全相同的名称；然而，它们将指向它们相应的api网关。因此，当用户向您的自定义域名发出请求时，route53会将用户重定向到延迟最小的区域。</p><p id="064a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一旦做到这一点，你需要进入第二步。对于应用程序负载平衡器背后的每个服务，确保您有一个CNAME类型的DNS记录。通过这种方式，应用程序负载平衡器将能够将流量重定向到它。</p><h1 id="6783" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">可选:配置晶片</h1><p id="4a1c" class="pw-post-body-paragraph ip iq hh ir b is kz iu iv iw la iy iz ja lb jc jd je lc jg jh ji ld jk jl jm ha bi translated">配置WAF ALC是可选的，但总是建议这样做。对此进行配置有两个重要方面。首先是设置规则，这些规则可以根据IP、位置等进行匹配。第二个是将WAF ACL与资源相关联，它应该应用它的规则。如果你想将WAF日志保存到Kinesis Data Firehose中，请记住它的名称应该以aws-waf-logs开头(见官方文档<a class="ae li" href="https://docs.aws.amazon.com/waf/latest/developerguide/logging-kinesis.html" rel="noopener ugc nofollow" target="_blank">此处</a>)。</p><h1 id="e085" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">结论</h1><p id="9cfb" class="pw-post-body-paragraph ip iq hh ir b is kz iu iv iw la iy iz ja lb jc jd je lc jg jh ji ld jk jl jm ha bi translated">配置主动-主动api可能既有助于灾难恢复策略，也有助于确保用户重定向到延迟最小的区域。这种api的配置需要在两个不同的区域设置相同的api配置，然后创建route53资源以将流量重定向到它们。将授权者添加到api，将WAF ACL添加到应用程序负载平衡器，这并不是强制性的，但是这样做绝对是一个好的实践。</p><h1 id="61e1" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">奖金</h1><p id="8993" class="pw-post-body-paragraph ip iq hh ir b is kz iu iv iw la iy iz ja lb jc jd je lc jg jh ji ld jk jl jm ha bi translated">您也可以使用Terraform，而不是从控制台执行此操作。我们已经在<a class="ae li" href="https://registry.terraform.io/modules/rgg1993/api-gateway/aws/1.0.0" rel="noopener ugc nofollow" target="_blank">这个地形库</a>上传了我们用来创建所有这些资源的模块(除了从控制台手动创建的托管区域)。</p><h1 id="953b" class="kb kc hh bd kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky bi translated">承认</h1><p id="36f8" class="pw-post-body-paragraph ip iq hh ir b is kz iu iv iw la iy iz ja lb jc jd je lc jg jh ji ld jk jl jm ha bi translated">这个解决方案是由<a class="ae li" href="https://www.linkedin.com/in/ivanferb?miniProfileUrn=urn%3Ali%3Afs_miniProfile%3AACoAAA9buSIBllgcvnAXktSbJJ96--ECOmykhd8&amp;lipi=urn%3Ali%3Apage%3Ad_flagship3_search_srp_all%3BzrVmI26AT0mqMrcC0CYwVw%3D%3D" rel="noopener ugc nofollow" target="_blank">伊万·费尔南德斯</a>设计的，所以所有的功劳都应该归他。我只是在他的指导下编写了实现解决方案的模块，并决定写这篇文章来确保我理解这个过程。</p></div></div>    
</body>
</html>