<html>
<head>
<title>Deploying with Confidence — Minimize Risk, Maximize Resiliency With Canary Deployments on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">信心十足地部署—借助AWS上的Canary部署，最大限度地降低风险、提高弹性</h1>
<blockquote>原文：<a href="https://medium.com/capital-one-tech/deploying-with-confidence-strategies-for-canary-deployments-on-aws-7cab3798823e?source=collection_archive---------0-----------------------#2018-10-31">https://medium.com/capital-one-tech/deploying-with-confidence-strategies-for-canary-deployments-on-aws-7cab3798823e?source=collection_archive---------0-----------------------#2018-10-31</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/2245409db48c71e12c74c7796ae99009.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*8gilqgP1-mZ48rD7AqluSg.gif"/></div></div></figure><p id="d0ca" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">今天的客户对在线网站和网络应用有很高的期望。他们希望网站和应用程序总是可用的，当它们不可用时，这就成了大新闻。想象一个社交媒体应用程序宕机一个小时左右。公司会尽快安排最优秀的人员来解决这个问题。他们还会向用户发送信息，解释发生了什么，以及他们将来如何避免这种情况。在内部，他们将经历许多回顾和反思，以加强他们的系统和基础设施，并履行他们对用户的承诺。</p><p id="148a" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">而且这只是针对社交媒体应用。金融网站和应用程序与客户的个人生活非常接近，影响了他们访问和使用财务的能力。客户越来越多地在网上进行金融交易，包括付款、交易股票、转账等。因此，客户越来越希望财务应用程序始终可用。这些应用程序可用性的任何中断不仅会影响客户满意度，还会影响金融机构的信任度、声誉和可信度。</p><p id="7445" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">我们如何确保金融应用程序始终可供客户使用？</p><h1 id="7863" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">变化是活系统不可避免的</h1><p id="29b9" class="pw-post-body-paragraph iq ir hh is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn ha bi translated">金融界及其他领域的企业越来越多地构建“永不停机”系统，以便为客户提供全天候可用性。这些系统需要不断更新以添加新功能、更新技术堆栈等。改变一个活跃的系统总是伴随着出错的风险。这些故障可能源于系统错误和/或应用程序/功能缺陷。对于“永不停机”的系统，有不同的策略来降低不同故障的风险。</p><h1 id="2f02" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">蓝绿色部署</h1><p id="99f8" class="pw-post-body-paragraph iq ir hh is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn ha bi translated"><a class="ae kr" href="https://martinfowler.com/bliki/BlueGreenDeployment.html" rel="noopener ugc nofollow" target="_blank">蓝绿色部署</a>是一种在不影响当前实时流量的情况下部署新版本软件的流行技术。在这种方法中，创建了两个基础设施栈；一个叫做<em class="ks">蓝</em>，另一个叫做<em class="ks">绿</em>。在任何给定的时间，其中一个栈正在服务实时流量，而另一个栈是空闲的。闲置的堆栈基础架构可以在不用于部署时关闭，以避免资源浪费。在更新期间，新版本被部署在空闲堆栈上。一旦所有验证完成，流量就向空闲堆栈开放，空闲堆栈变为活动，活动堆栈变为空闲。</p><p id="1453" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">请参见下图:</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kt"><img src="../Images/fcc96b8c60d230d8b0280751144628ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ygDl99S5O_8a7YSO"/></div></div></figure><h1 id="1813" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">金丝雀部署</h1><p id="13c5" class="pw-post-body-paragraph iq ir hh is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn ha bi translated">金丝雀部署(Canary Deployment)是一种将流量缓慢调节到新版本软件的技术。这种方法的好处是，与向新版本开放全部流量相比，任何问题的影响都较低。一旦新版本通过验证，并且没有发现任何问题，那么新版本将被滚动部署到剩余的服务器上。</p><p id="de3f" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">请参见下图:</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ky"><img src="../Images/c5eacc2150be608f7a7819ecb48557be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fmsb27q9f1PN5T0D"/></div></div></figure><p id="73fb" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">Canary部署是升级“永不停机”系统的最佳方法之一，在这种系统中，新旧两个版本可以并行运行，不会产生任何副作用。这需要端到端的验证，以确保新版本没有任何问题。它还允许流量在缓慢增加之前向一小部分用户开放。如果出现任何问题，这允许快速回滚到以前的版本。</p><h1 id="b76e" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">AWS服务</h1><p id="3616" class="pw-post-body-paragraph iq ir hh is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn ha bi translated">AWS提供了一组丰富的服务，可用于实现蓝绿色和淡黄色部署。</p><ul class=""><li id="f2f1" class="kz la hh is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh bi translated"><a class="ae kr" href="https://aws.amazon.com/route53/" rel="noopener ugc nofollow" target="_blank"> <strong class="is hi">路由53 </strong> </a> <strong class="is hi"> : </strong>提供路由和健康检查功能的托管DNS服务。路由策略决定了Route 53将如何响应查询。</li><li id="3bff" class="kz la hh is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated"><a class="ae kr" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html" rel="noopener ugc nofollow" target="_blank"> <strong class="is hi"> ALB </strong> </a> <strong class="is hi"> : </strong>应用负载平衡器在多个可用性区域中的多个目标(如EC2实例)之间分配传入流量。</li><li id="0b91" class="kz la hh is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated"><a class="ae kr" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank"><strong class="is hi">ECS</strong></a><strong class="is hi">:</strong>弹性容器服务(Elastic Container Service)是一种容器编排服务，可以在Docker中轻松运行和扩展容器化的应用。</li><li id="fc9d" class="kz la hh is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated"><a class="ae kr" href="https://aws.amazon.com/ec2/" rel="noopener ugc nofollow" target="_blank"><strong class="is hi">EC2</strong></a><strong class="is hi">:</strong>弹性计算云在AWS中提供可扩展的计算能力。</li><li id="4a06" class="kz la hh is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated"><a class="ae kr" href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/AutoScalingGroup.html" rel="noopener ugc nofollow" target="_blank"><strong class="is hi">ASG</strong></a><strong class="is hi">:</strong>自动缩放组包含一组具有相似特征的EC2实例，并被视为一个逻辑分组，用于实例缩放和管理。</li></ul><h1 id="dbff" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">使用AWS实现Canary部署</h1><p id="e49e" class="pw-post-body-paragraph iq ir hh is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn ha bi translated">使用AWS服务实现Canary部署有许多方法。这些技术可用于ALB/ECS堆栈或ALB/ASG堆栈。Canary部署也可以通过创建一个堆栈或两个堆栈来实现。</p><h2 id="a834" class="ln jp hh bd jq lo lp lq ju lr ls lt jy jb lu lv kc jf lw lx kg jj ly lz kk ma bi translated">1堆栈方法:使用AWS服务实现Canary部署</h2><p id="06e4" class="pw-post-body-paragraph iq ir hh is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn ha bi translated">在这种方法中，有一个ALB/ECS堆栈为实时流量提供服务。通过增加ASG的大小或附加另一个ASG来部署软件的新版本。一旦新版本通过验证并且没有发现任何问题，那么新版本将在剩余实例上滚动部署。</p><p id="ccb3" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">请参见下图:</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div class="er es mb"><img src="../Images/510068e24ba0c492bef510d76bc67988.png" data-original-src="https://miro.medium.com/v2/resize:fit:1050/0*I_VlTAYq9pJQTuAl"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div class="er es mc"><img src="../Images/709b503d4afc9b060e8a07647c6c9deb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/0*fjERT9Ri0fv-qxGy"/></div></figure><p id="2311" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">考虑这种方法，其中堆栈大小较小，回滚的SLA较大。注意，这种方法不能控制新版本的流量百分比。ALB路由到所有EC2实例。在上面的例子中，一旦创建了一个新的实例，由于有4个实例，25%的流量将流向新版本。</p><p id="8fda" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">此外，完全释放后的回滚可能需要比预期更长的时间。要回滚，请对软件的先前版本重复上述过程。回滚所需的时间取决于实例的数量和每个实例的启动时间。</p><p id="9819" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">这种方法的另一个变体是使用两个ASG，并向第二个ASG添加新的实例。请参见下图:</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div class="er es md"><img src="../Images/8679452e2599658f2bdf64e111840a22.png" data-original-src="https://miro.medium.com/v2/resize:fit:954/0*oEQwm0624ZeKQQIx"/></div></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div class="er es me"><img src="../Images/63c62027dd3aec287fbe6175568de05f.png" data-original-src="https://miro.medium.com/v2/resize:fit:966/0*8hSdh5jwOSj8wTGv"/></div></figure><p id="f047" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">考虑这种方法，其中堆栈大小较大，回滚的SLA也较大。这种方法不能控制新版本的流量百分比。ALB路由到所有EC2实例。</p><p id="613b" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">当两个ASG都在服务流量时，回滚比收缩旧版本后更容易。只要把V2的ASG缩小到0。这将终止所有具有V2的实例。但是，完全释放后，回滚将需要更长时间。要回滚，请对以前版本的软件重复上述过程。回滚所需的时间取决于实例的数量和每个实例的启动时间。</p><h2 id="25a8" class="ln jp hh bd jq lo lp lq ju lr ls lt jy jb lu lv kc jf lw lx kg jj ly lz kk ma bi translated">2堆栈方法:使用AWS服务实现Canary部署</h2><p id="b89c" class="pw-post-body-paragraph iq ir hh is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn ha bi translated">在这种方法中，竖立两个平行的ALB/ECS堆叠。使用Route53加权策略向一个或两个堆栈发送流量。默认情况下，100%的流量由一个堆栈提供服务(比如蓝色)。新版本部署在非活动堆栈上(在本例中为绿色)。在路由任何流量之前，所有验证和健康检查都在绿色堆栈上运行。一旦一切正常，通过改变Route53记录的权重，一小部分流量(比如10%)被开放给绿色堆栈。</p><p id="9a8c" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">请参见下图:</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mf"><img src="../Images/09520859a89c11855d7a4237ef0142c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kWXJ398Wkymoo1kz"/></div></div></figure><p id="5138" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">当两个堆栈都在服务流量时，可以自动比较每个堆栈的健康状况、响应时间和错误率，并决定增加或减少新堆栈的流量。如果一切顺利，则慢慢增加新堆栈的流量，直到流量达到100%。</p><p id="464f" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">请参见下图:</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mf"><img src="../Images/56fa8caa194a57e876955a328ae50d47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kLuaeIo98qKCGQj9"/></div></div></figure><p id="fd1e" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">这种方法的好处如下:</p><ul class=""><li id="5dda" class="kz la hh is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh bi translated">完全控制百分比。</li><li id="e730" class="kz la hh is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">不应影响现有堆栈的运行状况。</li><li id="5a4b" class="kz la hh is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">回滚更容易、更快；切换流量所需的时间取决于为Route 53记录集配置的TTL值。</li></ul><p id="0563" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated">考虑将这种方法用于业务关键型低风险系统，因为这种方法提供了最快的回滚选项。</p><h1 id="c7f1" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">摘要</h1><p id="aea0" class="pw-post-body-paragraph iq ir hh is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn ha bi translated">总之，在决定部署策略之前，评估您的系统的风险承受能力，识别您的实际系统的风险，并选择最适合您的系统的方法。这里有一些通用的指导方针，可能有助于使系统更有弹性。</p><ul class=""><li id="202e" class="kz la hh is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh bi translated">拥有健全的健康检查机制。</li><li id="d26c" class="kz la hh is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">添加智能显示器和警报。</li><li id="bd2e" class="kz la hh is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">评估每个版本的风险承受能力，并准备好后备选项。</li><li id="2642" class="kz la hh is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">决定最适合您系统的部署策略。</li><li id="d2eb" class="kz la hh is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">使用自动化测试、自动化验证和自动化管道。</li><li id="e316" class="kz la hh is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">为自动回滚添加智能。</li><li id="bfe1" class="kz la hh is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">将基础设施版本(JDK升级、框架升级)与功能版本(新功能、增强、逻辑变化)分开。</li><li id="58ce" class="kz la hh is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">有一个全面的发布沟通计划。</li></ul></div><div class="ab cl mg mh go mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ha hb hc hd he"><p id="a258" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn ha bi translated"><em class="ks">披露声明:这些观点是作者的观点。除非本帖中另有说明，否则Capital One不属于所提及的任何公司，也不被其认可。使用或展示的所有商标和其他知识产权都是其各自所有者的所有权。本文为Capital One 2018。</em></p></div></div>    
</body>
</html>