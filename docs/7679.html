<html>
<head>
<title>Optimizing HapiJS for Benchmarks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为基准优化HapiJS</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/optimizing-hapijs-for-benchmarks-737f371265e9?source=collection_archive---------0-----------------------#2017-06-27">https://medium.com/walmartglobaltech/optimizing-hapijs-for-benchmarks-737f371265e9?source=collection_archive---------0-----------------------#2017-06-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/c6c2c39a130c93bc12b5726be2d33a88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yP5RsLzewlpSgEm2TjwZnA.jpeg"/></div></div></figure><div class=""/><p id="8a28" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi jn translated"><span class="l jo jp jq bm jr js jt ju jv di">在</span>过去一年多的时间里，我们的团队在<a class="jx jy ge" href="https://medium.com/u/c884135151a4?source=post_page-----737f371265e9--------------------------------" rel="noopener" target="_blank"> @WalmartLabs </a>成功开发并标准化了一个使用NodeJS开发和部署企业应用的平台<a class="ae jw" href="http://www.electrode.io/" rel="noopener ugc nofollow" target="_blank">电极</a>。</p><p id="7b31" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在做出的许多架构决策中，其中之一是使用哈比神作为框架来支持我们的web服务器。因此，我们不断收到有关性能的问题，许多基准测试表明express的性能是哈比神的X倍。</p><p id="d93e" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">就像任何其他架构决策一样，性能只是拼图的一部分。哈比神的创造者<a class="jx jy ge" href="https://medium.com/u/b4e3921706ee?source=post_page-----737f371265e9--------------------------------" rel="noopener" target="_blank"> Eran Hammer </a>为此写了一篇非常好的博客<a class="ae jw" href="https://hueniverse.com/performance-at-rest-75bb8fff143" rel="noopener ugc nofollow" target="_blank">。尽管如此，除了性能之外，我没有解释哈比神带来的其他重要特性，如安全检查和验证，而是决定深入研究细节，看看哈比神到底做了什么来牺牲性能，看看是否有任何优化的机会。</a></p></div><div class="ab cl jz ka go kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="ha hb hc hd he"><p id="7117" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们选择哈比神的一些原因是:</p><ul class=""><li id="f44a" class="kg kh hs ir b is it iw ix ja ki je kj ji kk jm kl km kn ko bi translated">定义明确的约定和已建立的应用程序结构，并进行验证</li><li id="3f75" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">它有一个独立于请求生命周期的插件系统</li><li id="76a9" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">它有安全检查和配置验证</li><li id="7a4c" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">它带有请求生命周期中的默认特性，如缓存和授权</li><li id="36cf" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">它有一个内置的事件记录系统</li><li id="d9d9" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">鉴于它已经在这里开发了一段时间，哈比神在<a class="jx jy ge" href="https://medium.com/u/c884135151a4?source=post_page-----737f371265e9--------------------------------" rel="noopener" target="_blank"> @WalmartLabs </a>有一些普遍的曝光</li></ul></div><div class="ab cl jz ka go kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="ha hb hc hd he"><p id="f12d" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">基准性能并不是哈比神的优先考虑事项之一，正如其创建者所解释的那样，各种基准表明:</p><ul class=""><li id="db44" class="kg kh hs ir b is it iw ix ja ki je kj ji kk jm kl km kn ko bi translated"><a class="ae jw" href="https://www.techempower.com/benchmarks/" rel="noopener ugc nofollow" target="_blank"><em class="ku">techempower.com</em></a></li><li id="613a" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated"><a class="ae jw" href="https://raygun.com/blog/node-js-performance-comparison/?utm_source=RG_BLOG&amp;utm_medium=article_link&amp;utm_content=node_performance_2016" rel="noopener ugc nofollow" target="_blank">raygun.com</a></li></ul><p id="21a1" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">显然，任何框架和节点的原始样本之间的区别在于接收请求和发回响应之间插入了多少代码。例如，至少，对于任何有用的框架，首先需要的是通过URL匹配进行路由。</p><p id="ad98" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我将跟踪哈比神的请求生命周期代码路径，看看它在响应发送之前做了什么，然后对它运行V8概要分析，看看热点在哪里。</p></div><div class="ab cl jz ka go kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="ha hb hc hd he"><p id="23f0" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">首先，在我们运行CentOS 7和Node 6.10.0的商用服务器上运行express和哈比神的简单基准测试时的一些快速基数:</p><ul class=""><li id="c750" class="kg kh hs ir b is it iw ix ja ki je kj ji kk jm kl km kn ko bi translated">运行示例的单个实例</li><li id="7e37" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">使用<code class="du kv kw kx ky b">ab -c 64 -n 10000 <a class="ae jw" href="http://localhost:8000`" rel="noopener ugc nofollow" target="_blank">http://localhost:8000</a></code>进行查询</li></ul><p id="9e98" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我得到的大概数字是快车<em class="ku"> 1550请求/秒</em>和哈比神<em class="ku"> 550请求/秒</em>。哈比神的这种开销是不变的。它显示了3倍的差异，因为完全没有业务逻辑。如果您的逻辑占用了很大一部分响应时间，那么哈比神的开销只是很小的一部分，而express在整体响应时间上只占很小的一部分。</p></div><div class="ab cl jz ka go kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="ha hb hc hd he"><p id="f5d9" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">接下来，当收到请求时，我通过哈比神的代码进行跟踪。以下是哈比神在请求生命周期中经历的有趣点的概述:</p><ul class=""><li id="fa7d" class="kg kh hs ir b is it iw ix ja ki je kj ji kk jm kl km kn ko bi translated">第一个节点的<code class="du kv kw kx ky b">http</code>服务器发出<code class="du kv kw kx ky b">request</code>事件，该事件由<code class="du kv kw kx ky b"><em class="ku">_dispatch</em></code> <em class="ku">中的<code class="du kv kw kx ky b">Connection</code>处理。</em></li><li id="0941" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">哈比神创建了自己的<code class="du kv kw kx ky b">Request</code>对象，包装了<code class="du kv kw kx ky b">http</code>请求。</li><li id="56a6" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">哈比神有过载保护功能，所以它会进行负载检查。</li><li id="4b73" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">哈比神执行请求生命周期，用节点的域保护它。</li><li id="88d3" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">请求中的第一件事是检查URL路由。</li><li id="24de" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">设置响应超时。</li><li id="bea3" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">执行生命周期步骤。</li></ul><p id="e856" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">生命周期的步骤相当简单:</p><ul class=""><li id="8df9" class="kg kh hs ir b is it iw ix ja ki je kj ji kk jm kl km kn ko bi translated">首先检查<code class="du kv kw kx ky b"><em class="ku">hapi/lib/route.js</em></code>中的cookies</li><li id="1d66" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">在<code class="du kv kw kx ky b"><em class="ku">hapi/lib/auth.js</em></code>中检查授权</li><li id="c21c" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">最后调用路由处理器</li><li id="c2a2" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">路由处理器进行一些初始化以测量定时基准</li></ul><p id="3930" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因为示例非常简单，所以没有cookies或auth，所以跳过了它们。</p><p id="bb17" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我注意到两件事:</p><ul class=""><li id="d8bb" class="kg kh hs ir b is it iw ix ja ki je kj ji kk jm kl km kn ko bi translated">哈比神默认使用节点的域来保护请求生命周期的执行</li><li id="f2f9" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">默认情况下，哈比神有一个调试设置，因此它订阅服务器日志事件</li></ul><p id="6918" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在创建服务器时，可以使用选项关闭这两个选项，但是，这样做不会对性能产生任何有意义的改变。</p></div><div class="ab cl jz ka go kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="ha hb hc hd he"><p id="340b" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在请求生命周期代码路径中没有其他突出的东西，所以我求助于V8的分析器。</p><ul class=""><li id="527b" class="kg kh hs ir b is it iw ix ja ki je kj ji kk jm kl km kn ko bi translated">使用<code class="du kv kw kx ky b"><em class="ku">NODE_ENV=production node --prof</em></code>运行样本</li><li id="16d3" class="kg kh hs ir b is kp iw kq ja kr je ks ji kt jm kl km kn ko bi translated">用<code class="du kv kw kx ky b">ab</code>查询服务器</li></ul><p id="e16f" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">来自分析器的结果显示，最成功的是大量的<code class="du kv kw kx ky b">Joi</code>验证和<code class="du kv kw kx ky b">Podium</code>事件处理。</p><figure class="kz la lb lc fd hj"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="3a3c" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在<code class="du kv kw kx ky b"><em class="ku">joi/lib/any.js:442</em></code>设置断点我追踪到这些调用源自<code class="du kv kw kx ky b">Podium</code>，并且指向<code class="du kv kw kx ky b"><em class="ku">podium/lib/index.js</em></code>中的两行代码，这些代码调用<code class="du kv kw kx ky b"><em class="ku">Joi.attempt</em></code>来验证事件对象。</p><p id="684f" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了验证这一发现，我注释掉了这两行，并再次运行计时检查。结果是哈比神现在可以每秒处理超过1000个请求。基准性能提高了一倍，现在只比express低一点点。</p><p id="e0fb" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">再次运行分析器，现在只有<code class="du kv kw kx ky b">Podium</code>事件处理显示为最热门。鉴于哈比神的内部系统严重依赖它，这并不奇怪。</p></div><div class="ab cl jz ka go kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="ha hb hc hd he"><p id="fa8a" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我决定停在这里，因为<code class="du kv kw kx ky b">Podium</code>显然是一个特性丰富的事件发射器，不受性能要求的限制，与express相比，它很可能是剩余额外开销的主要原因。进一步挖掘，看看开销分解成什么，肯定会很有趣。</p><p id="32b2" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">优化的机会可能是避免重新验证<code class="du kv kw kx ky b">Podium</code>中的所有事件。例如，在<code class="du kv kw kx ky b"><em class="ku">hapi/lib/request.js</em></code>中，当一个请求被创建时，它立即用一个包含三个静态事件的数组调用<code class="du kv kw kx ky b">Podium</code>，对于每个传入的请求，这些静态事件不需要用<code class="du kv kw kx ky b">Joi</code>进行验证。</p><figure class="kz la lb lc fd hj"><div class="bz dy l di"><div class="ld le l"/></div></figure></div><div class="ab cl jz ka go kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="ha hb hc hd he"><p id="6ad5" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir ht">结论</strong>:哈比神是一个专注于为开发可靠的业务应用程序提供基础设施的框架。它在诸如严格检查和验证等功能的“基准性能”上进行权衡，这些功能在数百名开发人员开发应用程序时非常有用。虽然大多数都是应用启动期间的配置验证，不会对热代码路径产生影响，但哈比神的<code class="du kv kw kx ky b">Podium</code>自定义事件发射器在运行时对事件的验证增加了许多冗余开销，甚至对静态事件对象也是如此。在某种程度上，这几乎就像V8引擎每次执行时都重新验证相同的JS代码。即使在“基准性能”方面做得很好没有太大的意义，但是如果有一种方法可以重用这些验证或者在生产中直接关闭它们，这将有助于从哈比神的请求生命周期中减少一些ms。</p><p id="3e48" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">感谢<a class="jx jy ge" href="https://medium.com/u/9f42c93e61de?source=post_page-----737f371265e9--------------------------------" rel="noopener" target="_blank">戴夫·史蒂文斯</a>审阅这篇文章。</p></div></div>    
</body>
</html>