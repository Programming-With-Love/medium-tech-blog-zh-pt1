<html>
<head>
<title>A Developer Walks into Amazon SageMaker…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一名开发人员走进亚马逊SageMaker…</h1>
<blockquote>原文：<a href="https://medium.com/capital-one-tech/using-k-means-algorithm-and-amazon-sagemaker-ddf736d93867?source=collection_archive---------3-----------------------#2019-06-20">https://medium.com/capital-one-tech/using-k-means-algorithm-and-amazon-sagemaker-ddf736d93867?source=collection_archive---------3-----------------------#2019-06-20</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="36ae" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">使用K-Means算法和Amazon SageMaker构建机器学习模型</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/48ace6f169d5f99fd826f1ca7b7f8dfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tf_QWQc3ZeSrwtOCOixqGQ.jpeg"/></div></div></figure><p id="a07d" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">除非你生活在众所周知的技术岩石下，否则你可能在某个时候听说过“机器学习”这个词。近年来，机器学习已经从学术界和数据科学扩展到通用软件工程领域。这导致工程团队试图理解这个新领域，以及如何将其集成到传统编程模型中。对于许多用例来说，机器学习可能是不必要的，但是在某些场景中，机器学习可以比传统的编程模型提供更好的价值。</p><p id="7ca1" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">有大量的博客讨论什么是机器学习以及与之配合使用的各种工具。我为对机器学习感兴趣的受过传统训练的软件工程师写了这篇文章，并希望专注于一个他们可能感兴趣的工具——<a class="ae ke" href="https://aws.amazon.com/sagemaker/" rel="noopener ugc nofollow" target="_blank">Amazon sage maker</a>——以及一个使用它的用例。</p><h1 id="6ff6" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">亚马逊SageMaker是什么？</h1><p id="7ae7" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">Amazon SageMaker是由AWS提供的完全托管的机器学习服务，它为开发人员和数据科学家提供了构建、训练和部署他们的机器学习模型的工具。它于2017年11月在AWS re:Invent期间推出。虽然它为机器学习模型提供了端到端的工作流，但它的任何模块都可以独立运行。这使得团队可以灵活地只使用他们需要的部分。它还为包括Java、C#和Python在内的各种语言的开发者提供了一个健壮的<a class="ae ke" href="https://docs.aws.amazon.com/cli/latest/reference/sagemaker/index.html" rel="noopener ugc nofollow" target="_blank"> CLI </a>和一套<a class="ae ke" href="https://aws.amazon.com/sagemaker/developer-resources/" rel="noopener ugc nofollow" target="_blank">丰富的SDK</a>。</p><h1 id="b852" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">一个简单的用例</h1><p id="f13a" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">如果你愿意，可以想象一个拥有数百万条业务领域记录的数据库。您拥有最高效的SQL查询来返回您想要的任何数据。在这个场景中，业务部门请求根据数据库中的数百万条记录来预测趋势或检测模式。用不了多久，您就会意识到，仅仅使用高效的SQL查询很难完成这项任务。这就是引导我去亚马逊SageMaker的用例类型。</p><p id="f847" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我目前在Capital One的角色是一个六人团队，致力于为企业设计中间件系统。我们使用Java和NodeJs构建API和微服务，所有这些都在AWS生态系统内。我们的部分职责是研究新的工具、供应商和策略，这些工具、供应商和策略有可能为我们的项目服务。</p><p id="068d" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">大约一年半前，我的团队被分配到设计新的微服务的任务，这些微服务将取代为各种业务线处理事务的遗留系统。新系统需要的一个特征是能够检测某些类型的交易。当时，我们决定使用规则引擎，因为它更容易实现，周转时间更快。六个月前，在我们发布微服务并成功替换传统系统后，我们开始与业务团队一起审查一些功能增强。我们发现规则引擎很难检测到某些交易模式，因为可观察到的模式不遵循简单的算术或逻辑。</p><p id="c6af" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我的团队开始研究加强规则引擎的方法，不久我们就同意加入机器学习是一条可行的途径。然而，我们是一个软件工程团队，而不是数据科学家，所以我们真的不知道如何开始。我们希望研究并理想地找到一种新工具，它既可以被数据科学家和软件工程师使用，又符合MRO提供的严格准则。我们并没有寻找一个终极的解决方案，而是寻找一个新的工具，用于我们管理良好的建模系统生态系统中。那时我们走进了亚马逊sage maker……</p><p id="0529" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们喜欢SageMaker，因为它让用户可以通过完成大部分基础设施的繁重工作来轻松构建机器学习模型。尽管SageMaker加速了您的构建，但是您仍然需要对您的数据和建模框架有一个基本的了解，尤其是在数据准备方面。而且，如果您在像我们这样的大型企业中工作，您仍然必须确保您的模型符合您的法律和治理要求。但是SageMaker可以为各种用例工作，这些用例涉及大量需要模式检测、预测或标记的数据。面部识别和消费者购买行为甚至可以通过亚马逊SageMaker来完成。</p><h2 id="1b54" class="ld kg hh bd kh le lf lg kl lh li lj kp jr lk ll kr jv lm ln kt jz lo lp kv lq bi translated">基本规则</h2><p id="d0b2" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">为了构建这一概念证明，我们制定了一些基本规则，以在此过程中保护和指导我们:</p><ul class=""><li id="054f" class="lr ls hh jk b jl jm jo jp jr lt jv lu jz lv kd lw lx ly lz bi translated">将基础设施作为代码(IaC)用于我们所做的一切，以保持事情符合良好架构框架的<a class="ae ke" href="https://aws.amazon.com/blogs/apn/the-5-pillars-of-the-aws-well-architected-framework/" rel="noopener ugc nofollow" target="_blank">原则。</a>这可能是<a class="ae ke" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank">云形成</a>、<a class="ae ke" href="https://aws.amazon.com/sagemaker/developer-resources/" rel="noopener ugc nofollow" target="_blank"> SageMaker SDK </a>或<a class="ae ke" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> Lambdas。</a></li><li id="60d5" class="lr ls hh jk b jl ma jo mb jr mc jv md jz me kd lw lx ly lz bi translated">加密！加密！！加密！！！我们需要通过在每个SageMaker SDK中使用适当的KMS密钥来确保静态数据保持加密。</li><li id="28cc" class="lr ls hh jk b jl ma jo mb jr mc jv md jz me kd lw lx ly lz bi translated">标记任何创建的资源，以确保易于管理。</li><li id="9d31" class="lr ls hh jk b jl ma jo mb jr mc jv md jz me kd lw lx ly lz bi translated">确保该工具符合我们的企业需求。</li></ul><p id="2c70" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">尽管与直接在AWS控制台中执行任务相比，使用IaC看起来开销很大，但考虑到我们必须创建和运行模型的次数，这种方法很快就有了回报。</p><h2 id="2811" class="ld kg hh bd kh le lf lg kl lh li lj kp jr lk ll kr jv lm ln kt jz lo lp kv lq bi translated">数据准备</h2><p id="e6d4" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">这是数据转换(规范化、标准化等)的地方。)发生，包括异常值和偏差的去除。数据科学家中用于这些任务的流行工具是Jupyter笔记本。AWS提供了一个<a class="ae ke" href="https://docs.aws.amazon.com/dlami/latest/devguide/setup-jupyter.html" rel="noopener ugc nofollow" target="_blank">管理版本的Jupyter笔记本</a>，它与SageMaker集成得非常好。不过需要注意的是，在亚马逊SageMaker中构建数据模型并不一定要使用Jupyter笔记本。任何支持数据操作语言的集成开发环境(IDE)都应该足够了。Julia，Python和R (Jupyter懂了吗？)是为数据操作和数值分析而构建的流行语言。我选择Python是因为它对<a class="ae ke" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker.html" rel="noopener ugc nofollow" target="_blank"> AWS SDK </a>的广泛支持(AWS SDK目前不提供对Julia和R的支持)。</p><p id="988c" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">以下是用于训练和测试的分割数据的Python代码片段:</p><pre class="ix iy iz ja fd mf mg mh mi aw mj bi"><span id="e3c2" class="ld kg hh mg b fi mk ml l mm mn">from sklearn.model_selection import train_test_split<br/># get Training and testing Data<br/>df = pd.read_csv("TrainTest_RawData.csv", sep=",")</span><span id="23f4" class="ld kg hh mg b fi mo ml l mm mn"># randomly select 20% of the data for testing and the other 80% for training<br/>x_train, x_test, y_train, y_test = train_test_split(df.Amount, df.tranCode,test_size=0.2</span></pre><h2 id="0a7e" class="ld kg hh bd kh le lf lg kl lh li lj kp jr lk ll kr jv lm ln kt jz lo lp kv lq bi translated">模特培训</h2><p id="c8de" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">数据验证和理解是任何建模工作流中最耗时的部分，但是模型训练的配置需要对模型类型本身的理解，并且具有如下所示的多个方面。</p><p id="9b65" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi"> IAM角色</strong> <br/>将用于构建这些模型的IAM角色必须满足以下标准:</p><ul class=""><li id="45f4" class="lr ls hh jk b jl jm jo jp jr lt jv lu jz lv kd lw lx ly lz bi translated">你必须能够承担这个角色。</li><li id="1168" class="lr ls hh jk b jl ma jo mb jr mc jv md jz me kd lw lx ly lz bi translated">该角色必须附加有SageMaker信任关系。</li></ul><pre class="ix iy iz ja fd mf mg mh mi aw mj bi"><span id="7a2e" class="ld kg hh mg b fi mk ml l mm mn">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>      {<br/>        "Effect": "Allow",<br/>        "Principal": {<br/>          "Service": [<br/>            "sagemaker.amazonaws.com"<br/>          ]<br/>        },<br/>        "Action": "sts:AssumeRole"<br/>      }<br/>    ]<br/>}</span></pre><ul class=""><li id="a43b" class="lr ls hh jk b jl jm jo jp jr lt jv lu jz lv kd lw lx ly lz bi translated">该角色必须附有SageMaker/KMS策略。</li></ul><pre class="ix iy iz ja fd mf mg mh mi aw mj bi"><span id="6a5a" class="ld kg hh mg b fi mk ml l mm mn">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>      {<br/>        "Action": "iam:PassRole",<br/>        "Resource": "*",<br/>        "Effect": "Allow",<br/>        "Condition": {<br/>          "StringEquals": {<br/>            "iam:PassedToService": "sagemaker.amazonaws.com"<br/>          }<br/>        },<br/>        "Sid": "GrantsIamPassRole"<br/>      },<br/>      {<br/>        "Action": [<br/>          "kms:DescribeKey",<br/>          "kms:ListAliases"<br/>        ],<br/>        "Resource": "*",<br/>        "Effect": "Allow",<br/>        "Sid": "KmsKeysForCreateForms"<br/>      },<br/>      {<br/>        "Action": [<br/>          "iam:ListRoles"<br/>        ],<br/>        "Resource": "*",<br/>        "Effect": "Allow",<br/>        "Sid": "ListAndCreateExecutionRoles"<br/>      },<br/>      {<br/>        "Action": [<br/>          "kms:Encrypt",<br/>          "kms:Decrypt",<br/>          "kms:ReEncrypt*",<br/>          "kms:GenerateDataKey*",<br/>          "kms:DescribeKey",<br/>          "kms:GetKeyPolicy",<br/>          "kms:CreateGrant",<br/>          "kms:ListGrants",<br/>          "kms:RevokeGrant"<br/>      ],<br/>      "Resource": "KMS_KEY_ARN",<br/>      "Effect": "Allow",<br/>      "Sid": "GrantKMSAccess"<br/>    },<br/>    {<br/>      "Action": [<br/>        "sagemaker:CreateEndPoint",<br/>        "sagemaker:DescribeEndpoint"<br/>      ],<br/>      "Resource": "*",<br/>      "Effect": "Allow",<br/>      "Sid": "GrantSageMakerCreate"<br/>    }<br/>  ]<br/>}</span></pre><p id="3def" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi"> KMS密钥</strong> <br/>将用于加密的KMS密钥必须附带一个策略，该策略将授予对将使用SageMaker的IAM角色的访问权限。</p><pre class="ix iy iz ja fd mf mg mh mi aw mj bi"><span id="5f83" class="ld kg hh mg b fi mk ml l mm mn">{<br/>    "Version": "2012-10-17",<br/>    "Id": "key-consolepolicy-3",<br/>    "Statement": [<br/>        {<br/>            "Sid": "Enable IAM User Permissions",<br/>            "Effect": "Allow",<br/>            "Principal": {<br/>                "AWS": "ARN_OF_ROOT"<br/>            },<br/>            "Action": "kms:*",<br/>            "Resource": "*"<br/>        },<br/>        {<br/>            "Sid": "Allow access for Key Administrators",<br/>            "Effect": "Allow",<br/>            "Principal": {<br/>                "AWS": "ARN_OF_KEY_ADMINISTRATORS_ROLE"<br/>            },<br/>            "Action": [<br/>                "kms:Create*",<br/>                "kms:Describe*",<br/>                "kms:Enable*",<br/>                "kms:List*",<br/>                "kms:Put*",<br/>                "kms:Update*",<br/>                "kms:Revoke*",<br/>                "kms:Disable*",<br/>                "kms:Get*",<br/>                "kms:Delete*",<br/>                "kms:TagResource",<br/>                "kms:UntagResource",<br/>                "kms:ScheduleKeyDeletion",<br/>                "kms:CancelKeyDeletion"<br/>            ],<br/>            "Resource": "*"<br/>        },<br/>        {<br/>            "Sid": "Allow use of the key",<br/>            "Effect": "Allow",<br/>            "Principal": {<br/>                "AWS": [<br/>                    "ARN_OF_SAGEMAKER_ROLE"<br/>                ]<br/>            },<br/>            "Action": [<br/>                "kms:Encrypt",<br/>                "kms:Decrypt",<br/>                "kms:ReEncrypt*",<br/>                "kms:GenerateDataKey*",<br/>                "kms:DescribeKey",<br/>                "kms:GetKeyPolicy"<br/>            ],<br/>            "Resource": "*"<br/>        },<br/>        {<br/>            "Sid": "Allow attachment of persistent resources",<br/>            "Effect": "Allow",<br/>            "Principal": {<br/>                "AWS": [<br/>                    "ARN_OF_SAGEMAKER_ROLE"<br/>                ]<br/>            },<br/>            "Action": [<br/>                "kms:CreateGrant",<br/>                "kms:ListGrants",<br/>                "kms:RevokeGrant"<br/>            ],<br/>            "Resource": "*",<br/>            "Condition": {<br/>                "Bool": {<br/>                    "kms:GrantIsForAWSResource": "true"<br/>                }<br/>            }<br/>        }<br/>    ]<br/>}</span></pre><p id="9874" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi">培训工作</strong> <br/>此时，您已准备好将数据导入SageMaker进行培训。我们的用例非常适合集群。Amazon SageMaker支持超过15 ML的算法，可以满足庞大的场景库。<em class="lc"> K-Means </em>就是解决聚类问题的算法之一。</p><p id="1d60" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="lc">我在首都的一个同事Madison Schott写了一篇关于K-Means算法的</em> <a class="ae ke" rel="noopener" href="/capital-one-tech/k-means-clustering-algorithm-for-machine-learning-d1d7dc5de882"> <em class="lc">博客</em> </a> <em class="lc">如果你想更深入的了解。</em></p><p id="0d2a" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">有两种方法可以在Amazon SageMaker中为K-Means算法(以及它支持的大多数算法)构建训练作业:</p><ul class=""><li id="487e" class="lr ls hh jk b jl jm jo jp jr lt jv lu jz lv kd lw lx ly lz bi translated"><strong class="jk hi">创建培训作业API: </strong>当您非常清楚培训作业构建最佳模型所需的超参数(参数)时，可以使用该API。它可以加快模型的构建速度，但是需要您具备数据的领域知识，以提供精确的超参数值来构建最佳模型。它在流程结束时产生一个培训工作。</li><li id="4175" class="lr ls hh jk b jl ma jo mb jr mc jv md jz me kd lw lx ly lz bi translated"><strong class="jk hi">创建超参数调整作业API: </strong>当您不知道产生最佳模型的准确超参数值时，使用该工具。您向它提供一系列超参数值以供使用，SageMaker将为您构建一系列训练工作，并根据提供的范围标记最佳工作。对于<em class="lc"> K-Means </em>算法，SageMaker提供了一个推荐使用的超参数值范围。</li></ul><p id="3676" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">对于我们的POC，我们使用了超参数调整作业API，这使我们能够灵活地尝试不同的培训作业场景，而不是一次构建一个。</p><p id="4c18" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">以下Python代码可用于创建超参数优化作业:</p><pre class="ix iy iz ja fd mf mg mh mi aw mj bi"><span id="14c6" class="ld kg hh mg b fi mk ml l mm mn">import boto3<br/>import os</span><span id="fbf5" class="ld kg hh mg b fi mo ml l mm mn">from sagemaker.amazon.amazon_estimator import get_image_uri</span><span id="b696" class="ld kg hh mg b fi mo ml l mm mn">os.environ['AWS_PROFILE'] = 'YOUR_AWS_STS_PROFILE'</span><span id="795e" class="ld kg hh mg b fi mo ml l mm mn"># gets the K-Means docker image from AWS<br/>image = get_image_uri(boto3.Session().region_name, 'kmeans')</span><span id="3b23" class="ld kg hh mg b fi mo ml l mm mn">role = 'ARN_OF_ROLE'<br/>bucket = 'S3_BUCKET'</span><span id="c2d7" class="ld kg hh mg b fi mo ml l mm mn">data_key = 'S3_TRAINING_DATA_LOCATION'<br/>test_key = 'S3_TESTING_DATA_LOCATION'<br/>output_key = 'S3_MODEL_OUTPUT_LOCATION'</span><span id="1ffa" class="ld kg hh mg b fi mo ml l mm mn">data_location = 's3://{}/{}'.format(bucket, data_key)<br/>output_location = 's3://{}/{}'.format(bucket,output_key)<br/>test_location = 's3://{}/{}'.format(bucket, test_key)</span><span id="7043" class="ld kg hh mg b fi mo ml l mm mn">sagemaker = boto3.client('sagemaker')</span><span id="6d33" class="ld kg hh mg b fi mo ml l mm mn">response = sagemaker.create_hyper_parameter_tuning_job(<br/>    HyperParameterTuningJobName='TRAINING_JOB_NAME',<br/>    HyperParameterTuningJobConfig={<br/>        'Strategy': 'Bayesian',<br/>        'HyperParameterTuningJobObjective': {<br/>            'Type': 'Minimize',<br/>            'MetricName': 'test:msd'<br/>        },<br/>        'ResourceLimits': {<br/>            'MaxNumberOfTrainingJobs': 50,<br/>            'MaxParallelTrainingJobs': 2<br/>        },<br/>        'ParameterRanges': {<br/>            'IntegerParameterRanges': [<br/>                {<br/>                    'Name': 'extra_center_factor',<br/>                    'MinValue': '4',<br/>                    'MaxValue': '10'<br/>                },<br/>                {<br/>                    'Name': 'mini_batch_size',<br/>                    'MinValue': '3000',<br/>                    'MaxValue': '15000'<br/>                },<br/>            ],<br/>            'CategoricalParameterRanges': [<br/>                {<br/>                    'Name': 'init_method',<br/>                    'Values': [<br/>                        'kmeans++', 'random'<br/>                    ]<br/>                },<br/>            ]<br/>        },<br/>        'TrainingJobEarlyStoppingType' : 'Auto'<br/>    },<br/>    TrainingJobDefinition={<br/>        'StaticHyperParameters': {<br/>            'k': '10',<br/>            'feature_dim': '2',<br/>        },<br/>        'AlgorithmSpecification': {<br/>            'TrainingImage': image,<br/>            'TrainingInputMode': 'File'<br/>        },<br/>        'RoleArn': role,<br/>        'InputDataConfig': [<br/>            {<br/>                'ChannelName': 'train',<br/>                'DataSource': {<br/>                    'S3DataSource': {<br/>                        'S3DataType': 'S3Prefix',<br/>                        'S3Uri': data_location,<br/>                        'S3DataDistributionType': 'FullyReplicated'<br/>                    }<br/>                },<br/>                'ContentType': 'text/csv;label_size=0'<br/>            },<br/>            <br/>            {<br/>                'ChannelName': 'test',<br/>                'DataSource': {<br/>                    'S3DataSource': {<br/>                        'S3DataType': 'S3Prefix',<br/>                        'S3Uri': test_location,<br/>                        'S3DataDistributionType': 'FullyReplicated'<br/>                    }<br/>                },<br/>                'ContentType': 'text/csv;label_size=0'<br/>            },<br/>        ],<br/>        'OutputDataConfig': {<br/>            'KmsKeyId': 'KMS_KEY_ID',<br/>            'S3OutputPath': output_location<br/>        },<br/>        'ResourceConfig': {<br/>            'InstanceType': 'ml.m4.16xlarge',<br/>            'InstanceCount': 1,<br/>            'VolumeSizeInGB': 50,<br/>            'VolumeKmsKeyId': 'KMS_KEY_ID'<br/>        },<br/>        'StoppingCondition': {<br/>            'MaxRuntimeInSeconds': 60 * 60<br/>        }<br/>    }<br/>)</span><span id="d9b4" class="ld kg hh mg b fi mo ml l mm mn">print(response)</span></pre><p id="6417" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi">模型</strong> <br/>在创建了符合您的标准的培训工作后，您现在可以创建模型了。该模型接受训练作业和算法，并创建Docker配置，SageMaker(或任何平台)可以为您托管该配置。这是一个基本的概念证明，展示了如何构建模型，并掩盖了将模型投入生产的治理流程和合作关系。</p><p id="d55a" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">以下Python代码示例可用于创建模型:</p><pre class="ix iy iz ja fd mf mg mh mi aw mj bi"><span id="598e" class="ld kg hh mg b fi mk ml l mm mn">import boto3<br/>import os</span><span id="89d8" class="ld kg hh mg b fi mo ml l mm mn">from sagemaker.amazon.amazon_estimator import get_image_uri</span><span id="cf05" class="ld kg hh mg b fi mo ml l mm mn">os.environ['AWS_PROFILE'] = 'AWS_STS_PROFILE'</span><span id="6f65" class="ld kg hh mg b fi mo ml l mm mn">sagemaker = boto3.client('sagemaker')</span><span id="5b1c" class="ld kg hh mg b fi mo ml l mm mn">role = 'ARN_IAM_ROLE'</span><span id="a315" class="ld kg hh mg b fi mo ml l mm mn"># gets the K-Means docker image from AWS<br/>image = get_image_uri(boto3.Session().region_name, 'kmeans')</span><span id="690e" class="ld kg hh mg b fi mo ml l mm mn">job_name = 'TRAINING_JOB_NAME'<br/>model_name = 'MODEL_NAME'</span><span id="47da" class="ld kg hh mg b fi mo ml l mm mn">info = sagemaker.describe_training_job(TrainingJobName=job_name)<br/>print(info)<br/>model_data = info['ModelArtifacts']['S3ModelArtifacts']</span><span id="6d42" class="ld kg hh mg b fi mo ml l mm mn">primary_container = {<br/>    'Image': image,<br/>    'ModelDataUrl': model_data<br/>}</span><span id="bb5b" class="ld kg hh mg b fi mo ml l mm mn">tags = [<br/>        {'Key' : 'ResourceName', 'Value': 'KMeans_Model'}<br/>    ]</span><span id="7cc7" class="ld kg hh mg b fi mo ml l mm mn">create_model_response = sagemaker.create_model(<br/>    ModelName = model_name,<br/>    ExecutionRoleArn = role,<br/>    PrimaryContainer = primary_container,<br/>    Tags = tags)</span><span id="6282" class="ld kg hh mg b fi mo ml l mm mn">print(create_model_response['ModelArn'])</span></pre><p id="7756" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi">端点配置</strong> <br/>创建模型后的下一步是创建端点配置。这将创建用于构建API端点的配置，API端点将最终托管模型。</p><p id="343a" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">以下<a class="ae ke" href="https://github.kdc.capitalone.com/gist/yrw063/29bfecf8f4a28866c8bd7d689e793414" rel="noopener ugc nofollow" target="_blank"> </a>代码示例可用于创建端点配置:</p><pre class="ix iy iz ja fd mf mg mh mi aw mj bi"><span id="2522" class="ld kg hh mg b fi mk ml l mm mn">import boto3<br/>import os</span><span id="cbc5" class="ld kg hh mg b fi mo ml l mm mn">os.environ['AWS_PROFILE'] = 'AWS_STS_PROFILE'</span><span id="5edd" class="ld kg hh mg b fi mo ml l mm mn">sagemaker = boto3.client('sagemaker')<br/>model_name = 'MODEL_NAME'</span><span id="7200" class="ld kg hh mg b fi mo ml l mm mn">endpoint_config_name = 'ENDPOINT_CONFIG_NAME'<br/>print(endpoint_config_name)</span><span id="ba91" class="ld kg hh mg b fi mo ml l mm mn">tags = [<br/>        {'Key' : 'ResourceName', 'Value': 'KMeans_EndPointConfig'}<br/>    ]</span><span id="7250" class="ld kg hh mg b fi mo ml l mm mn">create_endpoint_config_response = sagemaker.create_endpoint_config(<br/>    EndpointConfigName = endpoint_config_name,<br/>    ProductionVariants=[{<br/>        'InstanceType':'ml.m4.xlarge',<br/>        'InitialInstanceCount':1,<br/>        'ModelName':model_name,<br/>        'VariantName':'AllTraffic'}],<br/>    Tags= tags,<br/>    KmsKeyId='KMS_KEY_ID')</span><span id="c63b" class="ld kg hh mg b fi mo ml l mm mn">print("Endpoint Config Arn: " + create_endpoint_config_response['EndpointConfigArn'])</span></pre><p id="cd8d" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi">端点</strong>在用于创建端点的SDK中，没有用于分配将执行SDK的角色的参数。因此，您不能在本地执行<em class="lc">sage maker . create _ endpoint</em>。</p><p id="50bc" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我使用的解决方法包括创建一个Lambda函数，并将执行角色分配给在创建前面的资源时使用的IAM角色。</p><p id="214b" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这是Lambda函数的示例代码:</p><pre class="ix iy iz ja fd mf mg mh mi aw mj bi"><span id="e0d7" class="ld kg hh mg b fi mk ml l mm mn">import json<br/>import boto3<br/>import os<br/></span><span id="4dd5" class="ld kg hh mg b fi mo ml l mm mn">def lambda_handler(event, context):<br/>    sagemaker = boto3.client('sagemaker')<br/>    <br/>    endpoint_name = event['EndPointName']<br/>    endpoint_config_name = event['EndPointConfigName'] <br/>    <br/>    tags = [<br/>            {'Key' : 'ResourceName', 'Value': 'Kmeans_Lambda'}<br/>        ]<br/>    <br/>    print(endpoint_name)<br/>    <br/>    create_endpoint_response = sagemaker.create_endpoint(<br/>        EndpointName=endpoint_name,<br/>        EndpointConfigName=endpoint_config_name,<br/>        Tags = tags)<br/>    <br/>    print(create_endpoint_response['EndpointArn'])<br/>    <br/>    resp = sagemaker.describe_endpoint(EndpointName=endpoint_name)<br/>    status = resp['EndpointStatus']<br/>    print("Status: " + status)<br/>    <br/>    try:<br/>  sagemaker.get_waiter('endpoint_in_service').wait(EndpointName=endpoint_name)<br/>    finally:<br/>        resp = sagemaker.describe_endpoint(EndpointName=endpoint_name)<br/>        status = resp['EndpointStatus']<br/>        print("Arn: " + resp['EndpointArn'])<br/>        print("Create endpoint ended with status: " + status)<br/>    <br/>        if status != 'InService':<br/>            message = sagemaker.describe_endpoint(EndpointName=endpoint_name)['FailureReason']<br/>            print('Create endpoint failed with the following error: {}'.format(message))<br/>            raise Exception('Endpoint creation did not succeed')</span></pre><h2 id="0c8a" class="ld kg hh bd kh le lf lg kl lh li lj kp jr lk ll kr jv lm ln kt jz lo lp kv lq bi translated">确认</h2><p id="36f3" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">创建完端点之后，您就可以开始向端点发送测试数据并获取结果了。获取训练/测试数据段的最简单方法是在数据准备阶段统一绘制80/20。这个方法的验证是一个严格的过程，为了简洁起见，我们跳过了这个过程。要调用您的端点，您可以使用您选择的语言的SageMaker-runtime SDK。</p><p id="d5e6" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">这是我在POC中使用的Python片段。</p><pre class="ix iy iz ja fd mf mg mh mi aw mj bi"><span id="7258" class="ld kg hh mg b fi mk ml l mm mn">import boto3<br/>import os<br/>import json</span><span id="1a46" class="ld kg hh mg b fi mo ml l mm mn">os.environ['AWS_PROFILE'] = 'AWS_STS_PROFILE'</span><span id="883a" class="ld kg hh mg b fi mo ml l mm mn">runtime = boto3.Session().client('sagemaker-runtime',use_ssl=True)<br/>endpoint_name = 'ENDPOINT'<br/>payload = 'DATA_TO_SEND'</span><span id="6d64" class="ld kg hh mg b fi mo ml l mm mn">response = runtime.invoke_endpoint(EndpointName=endpoint_name, <br/>                                   ContentType='text/csv', <br/>                                   Body=payload)</span><span id="8afe" class="ld kg hh mg b fi mo ml l mm mn">result = json.loads(response['Body'].read())<br/>print(result)</span></pre><p id="0478" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">结果以JSON格式返回:</p><pre class="ix iy iz ja fd mf mg mh mi aw mj bi"><span id="495a" class="ld kg hh mg b fi mk ml l mm mn">{"closest_cluster": 1.0, "distance_to_cluster": 7.6}<br/>{"closest_cluster": 2.0, "distance_to_cluster": 3.2}</span></pre><p id="c690" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">聚类id和到聚类的距离的含义与K-Means算法的数学解释有关。该模型不会直接告诉你一个点是否属于一个聚类，你必须提供逻辑来根据到聚类的距离进行推断。在我们的概念验证中，我们发现我们的数据点紧密地聚集在一起(非常短的距离),因为这些点真正属于同一个组。然而，对于不在业务线标准范围内的点，我们注意到聚类的距离比平均距离大得多。基于这一发现，我们开始构建我们的推理逻辑。</p><h2 id="acef" class="ld kg hh bd kh le lf lg kl lh li lj kp jr lk ll kr jv lm ln kt jz lo lp kv lq bi translated">履行</h2><p id="abd3" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">一旦您对您的验证结果感到满意，那么这就意味着您已经有了一个可以接受管理机构验证的模型。当您的模型获得批准并准备投入生产时，AWS SageMaker可以轻松地在AWS中托管和扩展您的模型。鉴于其模块的灵活性，您可以从AWS导出您的模型，并将其托管在prem或任何您想要的平台上。</p><h1 id="dc53" class="kf kg hh bd kh ki kj kk kl km kn ko kp in kq io kr iq ks ir kt it ku iu kv kw bi translated">结论</h1><p id="05e5" class="pw-post-body-paragraph ji jj hh jk b jl kx ii jn jo ky il jq jr kz jt ju jv la jx jy jz lb kb kc kd ha bi translated">作为一名几乎没有数据科学背景的软件工程师，亚马逊SageMaker很容易就开始构建机器学习模型。我们仍在与我们的模型风险办公室合作，评估该模型并微调其结果的准确性。建立一个准确的模型需要时间、协作和整个工具生态系统，但一旦你有了一个可以检测复杂模式的模型，它就有回报了。</p><p id="6e11" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">市场上有各种各样的工具来帮助工程师开始构建机器学习模型。我鼓励您做自己的研究，找出哪一个最适合您的用例及治理过程！</p></div><div class="ab cl mp mq go mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ha hb hc hd he"><p id="6a21" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="lc">披露声明:2020资本一。观点是作者个人的观点。除非本帖中另有说明，否则Capital One不隶属于所提及的任何公司，也不被这些公司认可。使用或展示的所有商标和其他知识产权是其各自所有者的财产。</em></p></div></div>    
</body>
</html>