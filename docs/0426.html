<html>
<head>
<title>Unit-testing LiveData and other common observability problems</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">单元测试LiveData和其他常见的可观察性问题</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/unit-testing-livedata-and-other-common-observability-problems-bb477262eb04?source=collection_archive---------0-----------------------#2019-09-02">https://medium.com/androiddevelopers/unit-testing-livedata-and-other-common-observability-problems-bb477262eb04?source=collection_archive---------0-----------------------#2019-09-02</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="7cc6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下一次当你挠头想知道为什么一个看起来无辜的用LiveDatas进行的单元测试失败了，或者盯着一个应该显示… <em class="jd">一些东西的空屏幕时，你应该记住<strong class="ig hi">一个没有被观察到的live data不会发出更新</strong>。在这篇文章中，你会学到一些避免这个问题的好方法。</em></p><p id="b079" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这在处理<strong class="ig hi">转换</strong>时尤其重要。如果LiveData被转换，<strong class="ig hi">必须观察转换的结果</strong>。否则转换将永远不会被评估。</p><p id="84c9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jd">如果一个LiveData在森林里倒下了，没有人注意到它…它曾经被更新过吗？</em></p><p id="ec62" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本例中，每当初始值改变时，初始<code class="du je jf jg jh b">_liveData1</code>的值就被转换(映射)为大写:</p><figure class="ji jj jk jl fd jm"><div class="bz dy l di"><div class="jn jo l"/></div></figure><p id="04ed" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们为它编写一个简单的测试:</p><figure class="ji jj jk jl fd jm"><div class="bz dy l di"><div class="jn jo l"/></div></figure><p id="035f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个测试失败是因为LiveData没有做多余的工作。<strong class="ig hi">阅读</strong> <code class="du je jf jg jh b"><strong class="ig hi">liveData2.value</strong></code> <strong class="ig hi">不会引发依赖转化链，因为它没有被观察到。只有通过<code class="du je jf jg jh b">observe()</code>订阅才能做到这一点。</strong></p><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jp"><img src="../Images/b130e07944767e75e94ed2a579d36fd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TTfA6ep9do2kjo9Ef2r_YA.png"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx">The result of a Transformation is not computed if it’s not observed</figcaption></figure><p id="2e7f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请注意，<code class="du je jf jg jh b">liveData1</code>的值是可以读取的，因为它是一个<code class="du je jf jg jh b">MutableLiveData</code>，不需要评估任何转换。</p><p id="3aef" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">解决这个问题的一个简单(但不太好)的方法是在我们需要读取的LiveDatas上调用<code class="du je jf jg jh b">observeForever()</code>:</p><figure class="ji jj jk jl fd jm"><div class="bz dy l di"><div class="jn jo l"/></div></figure><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ka"><img src="../Images/99b2b6b0088236d86ea13c52f45771f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*566oksxDrIwQD8aLVWBtVg.png"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx">The result of a Transformation is not computed if it’s not observed</figcaption></figure><p id="28db" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，如果我们需要观察多个LiveDatas <strong class="ig hi">,这可能会用不重要的语句快速填充我们的测试。</strong></p><p id="2748" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了解决这个问题，Jetpack还没有提供测试助手<a class="ae jc" href="https://issuetracker.google.com/130709056" rel="noopener ugc nofollow" target="_blank"><em class="jd"/></a>，但是我们可以自己制作:</p><figure class="ji jj jk jl fd jm"><div class="bz dy l di"><div class="jn jo l"/></div></figure><p id="735f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Java 中也有<a class="ae jc" href="https://gist.github.com/JoseAlcerreca/1e9ee05dcdd6a6a6fa1cbfc125559bba" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="91ae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">该函数观察一个LiveData，直到它接收到一个新值(通过<code class="du je jf jg jh b">onChanged</code>)，然后它移除观察者。如果LiveData已经有一个值，它会立即返回。此外，如果从未设置该值，它将在2秒钟后(或您设置的任何时间)抛出异常。这可以防止出现问题时测试无法完成。</p><blockquote class="kb kc kd"><p id="a6aa" class="ie if jd ig b ih ii ij ik il im in io ke iq ir is kf iu iv iw kg iy iz ja jb ha bi translated">或者，如果您需要在整个测试过程中一直观察LiveData，因为它可能会接收到您想要检查的多个值，那么请看一下LiveData示例中的<code class="du je jf jg jh b"><a class="ae jc" href="https://github.com/googlesamples/android-architecture-components/blob/master/LiveDataSample/app/src/test/java/com/android/example/livedatabuilder/util/LiveDataTestUtil.kt#L61" rel="noopener ugc nofollow" target="_blank">observeForTesting</a> </code>。</p></blockquote><p id="47bb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在测试可读性更强了:</p><figure class="ji jj jk jl fd jm"><div class="bz dy l di"><div class="jn jo l"/></div></figure><p id="7279" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意:虽然您不需要<em class="jd">使用</em>来处理可变LiveData，但是在读取<em class="jd">任何</em> LiveData值时，最好使用<code class="du je jf jg jh b">getOrAwaitValue</code>，以防将来实现细节发生变化:</p><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ka"><img src="../Images/9ea587704ca935ab5724e9bd12723f40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qSoDZTxIFcslhKkzEp7CXA.png"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx">You don’t need to observe MutableLiveDatas to get their value, but it’s a good practice.</figcaption></figure><h1 id="40d5" class="kh ki hh bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">InstantTaskExecutorRule</h1><p id="5a26" class="pw-post-body-paragraph ie if hh ig b ih lf ij ik il lg in io ip lh ir is it li iv iw ix lj iz ja jb ha bi translated">需要注意的是，这种技术可能存在线程问题。大多数问题都可以通过在单元测试中添加<a class="ae jc" href="https://developer.android.com/reference/android/arch/core/executor/testing/InstantTaskExecutorRule" rel="noopener ugc nofollow" target="_blank"> InstantTaskExecutorRule </a>来解决。然而，如果你从主线程调用<code class="du je jf jg jh b">LiveData.postValue()</code>，那么<a class="ae jc" href="https://developer.android.com/reference/android/arch/lifecycle/LiveData#postvalue" rel="noopener ugc nofollow" target="_blank">记录的优先级</a>可能不会被保留。这种情况并不常见，但值得一提，因为它会产生不可避免的错误。</p><p id="4583" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在LiveData示例的<a class="ae jc" href="https://github.com/googlesamples/android-architecture-components/blob/master/LiveDataSample/app/src/test/java/com/android/example/livedatabuilder/LiveDataViewModelTest.kt" rel="noopener ugc nofollow" target="_blank">测试中查看它的运行情况。</a></p><h1 id="d158" class="kh ki hh bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">其他场景</h1><h2 id="b7ce" class="lk ki hh bd kj ll lm ln kn lo lp lq kr ip lr ls kv it lt lu kz ix lv lw ld lx bi translated">错误的视图模型</h2><p id="af95" class="pw-post-body-paragraph ie if hh ig b ih lf ij ik il lg in io ip lh ir is it li iv iw ix lj iz ja jb ha bi translated">如果你在多个片段之间使用一个共享的视图模型，确保你在所有的屏幕中使用相同的实例。当将片段而不是活动作为生命周期所有者传递给ViewModelProviders，或者在片段中使用<code class="du je jf jg jh b">by ViewModels</code>而不是<code class="du je jf jg jh b">by activityViewModels()</code>时，会发生这种情况。</p><h2 id="8f48" class="lk ki hh bd kj ll lm ln kn lo lp lq kr ip lr ls kv it lt lu kz ix lv lw ld lx bi translated">错误的房间数据库实例</h2><p id="9c5c" class="pw-post-body-paragraph ie if hh ig b ih lf ij ik il lg in io ip lh ir is it li iv iw ix lj iz ja jb ha bi translated">为什么返回LiveData的查询不发出任何更新？</p><p id="bdc9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您确定正在观察LiveData，那么您可能正在使用数据库的不同实例。检查你的创作模式或你的DI图。如果你知道你在做什么，你也可以在数据库构建器中启用<a class="ae jc" href="https://developer.android.com/reference/androidx/room/RoomDatabase.Builder.html#enableMultiInstanceInvalidation()" rel="noopener ugc nofollow" target="_blank">多实例失效</a>，但是它有一些限制。</p></div><div class="ab cl ly lz go ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ha hb hc hd he"><p id="b0fe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您可以在<a class="ae jc" href="https://github.com/googlesamples/android-architecture-components/blob/master/LiveDataSample" rel="noopener ugc nofollow" target="_blank"> LiveDataSample </a>中看到<a class="ae jc" href="https://github.com/googlesamples/android-architecture-components/blob/master/LiveDataSample/app/src/test/java/com/android/example/livedatabuilder/util/LiveDataTestUtil.kt" rel="noopener ugc nofollow" target="_blank"> LiveDataTestUtil </a>的运行。</p></div><div class="ab cl ly lz go ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ha hb hc hd he"><p id="d2fa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你还发现了哪些场景？请在评论中告诉我们！</p></div></div>    
</body>
</html>