<html>
<head>
<title>An efficient way to use Uniflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用单向流的有效方法</h1>
<blockquote>原文：<a href="https://blog.kotlin-academy.com/an-efficient-way-to-use-uniflow-2b41a9785a05?source=collection_archive---------0-----------------------#2020-02-18">https://blog.kotlin-academy.com/an-efficient-way-to-use-uniflow-2b41a9785a05?source=collection_archive---------0-----------------------#2020-02-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/b76b91d7c8615fb61718849990210033.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gux2zqutfB3Y0HPup28ctw.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo from <a class="ae jz" href="https://unsplash.com/photos/8FdEwlxP3oU/download?force=true" rel="noopener ugc nofollow" target="_blank">Max Bender</a></figcaption></figure><h1 id="e731" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="80b9" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">这篇文章是关于我们如何使用uniflow，使用这个库的好处是什么，以及使用它有多简单。别担心，我们会支付测试费用。我们将看到测试我们的视图模型是多么容易</p><h1 id="c2a2" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">单向流动的</h1><p id="e09d" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated"><a class="ae jz" href="https://github.com/uniflow-kt/uniflow-kt" rel="noopener ugc nofollow" target="_blank"> Uniflow </a>帮助您使用简单的单向数据流方法编写应用程序，确保始终保持一致性，这与Kotlin协程是一致的。</p><h1 id="c236" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">让我们使用Uniflow创建一个示例应用程序</h1><p id="6662" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">大多数应用程序都有一个配置文件屏幕，让我们来关注一下这个用例。在我们的使用案例中，uniflow将给我们带来哪些好处？好处很多，我来指出来:</p><ul class=""><li id="de12" class="lw lx in la b lb ly lf lz lj ma ln mb lr mc lv md me mf mg bi translated">简单的测试方法</li><li id="aa1e" class="lw lx in la b lb mh lf mi lj mj ln mk lr ml lv md me mf mg bi translated">我们只需要写状态和事件</li><li id="9585" class="lw lx in la b lb mh lf mi lj mj ln mk lr ml lv md me mf mg bi translated">真理的单一来源</li><li id="2c12" class="lw lx in la b lb mh lf mi lj mj ln mk lr ml lv md me mf mg bi translated">我们可以使用协程</li><li id="6e1d" class="lw lx in la b lb mh lf mi lj mj ln mk lr ml lv md me mf mg bi translated">用纯Kotlin编写数据流的聪明方法</li></ul><figure class="mn mo mp mq gt jo gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/0a801c321b4cfa296c10cea3d07b82ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:650/format:webp/1*4OxtmxBftHV6lmBsWuAyrg.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk"><a class="ae jz" href="https://github.com/MarcinChrapowicz/Uniflow-User-Profile" rel="noopener ugc nofollow" target="_blank">Click Me</a></figcaption></figure><h1 id="9a32" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">状态</h1><p id="3399" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">让我们编写一个类，在应用程序中用来表示一个状态。我们称之为<code class="fe mr ms mt mu b">UserProfileState</code>。我们只需要一个数据类。我们只需要定义这个数据类，因为我们将使用通用的加载/重试状态</p><p id="7656" class="pw-post-body-paragraph ky kz in la b lb ly ld le lf lz lh li lj mv ll lm ln mw lp lq lr mx lt lu lv ig bi translated">什么是状态:状态是我们需要保持的UI逻辑数据。这就是为什么我们的州只有一个名字，一个电子邮件和一个手机，来支持我们的用户界面。</p><figure class="mn mo mp mq gt jo"><div class="bz fp l di"><div class="my mz l"/></div></figure><h1 id="5bc9" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">事件</h1><p id="3ddd" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">什么是事件:事件是“一次性的”动作，我们不需要保留它。</p><p id="7f1b" class="pw-post-body-paragraph ky kz in la b lb ly ld le lf lz lh li lj mv ll lm ln mw lp lq lr mx lt lu lv ig bi translated">我们将有几个活动:</p><ul class=""><li id="09af" class="lw lx in la b lb ly lf lz lj ma ln mb lr mc lv md me mf mg bi translated"><code class="fe mr ms mt mu b">RetryView</code>当我们没有数据时，它会出现在用户面前——在本例中，当我们没有任何东西可显示时</li><li id="4679" class="lw lx in la b lb mh lf mi lj mj ln mk lr ml lv md me mf mg bi translated"><code class="fe mr ms mt mu b">Loading</code>它会在我们等待结果的时候出现在用户面前</li><li id="8547" class="lw lx in la b lb mh lf mi lj mj ln mk lr ml lv md me mf mg bi translated"><code class="fe mr ms mt mu b">OpenEmail</code>它将打开另一个带有电子邮件活动的活动</li><li id="c3fb" class="lw lx in la b lb mh lf mi lj mj ln mk lr ml lv md me mf mg bi translated"><code class="fe mr ms mt mu b">OpenMobileNumber</code>它会用is MobileNumberActivity打开另一个活动</li></ul><figure class="mn mo mp mq gt jo"><div class="bz fp l di"><div class="my mz l"/></div></figure><h1 id="87e8" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">视图模型</h1><p id="d998" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">现在让我们创建扩展<code class="fe mr ms mt mu b">AndroidDataFlow</code>的ViewModel类</p><figure class="mn mo mp mq gt jo"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="f088" class="pw-post-body-paragraph ky kz in la b lb ly ld le lf lz lh li lj mv ll lm ln mw lp lq lr mx lt lu lv ig bi translated">当我们创建<code class="fe mr ms mt mu b">UserProfileViewModel</code>时，我们想要设置初始状态，因为当我们打开屏幕时，我们还没有数据要设置。这就是我们发送事件来设置加载状态的原因。</p><p id="2822" class="pw-post-body-paragraph ky kz in la b lb ly ld le lf lz lh li lj mv ll lm ln mw lp lq lr mx lt lu lv ig bi translated">让我们关注下一个方法，因为它很重要。如果没有这种状态，我们可能没有可能做出另一个动作。</p><figure class="mn mo mp mq gt jo"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="c1ae" class="pw-post-body-paragraph ky kz in la b lb ly ld le lf lz lh li lj mv ll lm ln mw lp lq lr mx lt lu lv ig bi translated">嗯，这很重要，因为我们正在设置我们的状态，主要是因为它允许用户采取行动。没有这种状态，我们无法采取类似<code class="fe mr ms mt mu b">OpenEmail</code>或<code class="fe mr ms mt mu b">OpenMobileNumber</code> <strong class="la io">，</strong>的行动，让我们来看看那些方法</p><figure class="mn mo mp mq gt jo"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="2693" class="pw-post-body-paragraph ky kz in la b lb ly ld le lf lz lh li lj mv ll lm ln mw lp lq lr mx lt lu lv ig bi translated">可能现在你在想<code class="fe mr ms mt mu b">actionOn</code>。如果状态与<code class="fe mr ms mt mu b">UserProfileState</code>不同，这种方法将阻止您运行块内的逻辑。这样做会给我们一个简单的方法来控制国家。保证我们在开始下一个之前总是处于期望的状态</p><p id="b249" class="pw-post-body-paragraph ky kz in la b lb ly ld le lf lz lh li lj mv ll lm ln mw lp lq lr mx lt lu lv ig bi translated">不过不用担心在<code class="fe mr ms mt mu b">actionOn</code> <strong class="la io">中也很容易抓错。</strong>Uniflow提供的一种方法是通过提供一个回退lambda函数为您创建这个“try/catch”块，让您在出错时处理您的操作</p><figure class="mn mo mp mq gt jo"><div class="bz fp l di"><div class="my mz l"/></div></figure><h1 id="00b4" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">活动</h1><p id="a158" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">到目前为止，我们几乎完成了所有的逻辑，所以让我们看看如何实现我们的UI。活动中的函数<code class="fe mr ms mt mu b">onStates</code>允许我们使用传入状态。</p><figure class="mn mo mp mq gt jo"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="eb98" class="pw-post-body-paragraph ky kz in la b lb ly ld le lf lz lh li lj mv ll lm ln mw lp lq lr mx lt lu lv ig bi translated">如您所见，该事件将触发一个名为<code class="fe mr ms mt mu b">openFragment</code>的方法。该方法将检查当前显示给用户的片段是否与我们想要设置的片段不同。如果为真，我们要为<code class="fe mr ms mt mu b">UserProfileFragment</code>替换当前片段。我们为什么要这样做，让我们看看下面的例子</p><h1 id="8828" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">碎片</h1><figure class="mn mo mp mq gt jo"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="295b" class="pw-post-body-paragraph ky kz in la b lb ly ld le lf lz lh li lj mv ll lm ln mw lp lq lr mx lt lu lv ig bi translated">片段允许我们有一个更灵活的用户界面，并清晰地封装逻辑。如你所见，这与我们的Activity plus中的逻辑非常相似。我们不需要担心获取这个片段的最后状态和更新UI，因为Uniflow会处理剩下的事情。</p><h1 id="b0c9" class="ka kb in bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">测试</h1><p id="3875" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">不要忘记测试这一重要部分，让我们专注于此。</p><p id="0e2c" class="pw-post-body-paragraph ky kz in la b lb ly ld le lf lz lh li lj mv ll lm ln mw lp lq lr mx lt lu lv ig bi translated">在运行测试之前，我们需要设置:</p><ul class=""><li id="6d6c" class="lw lx in la b lb ly lf lz lj ma ln mb lr mc lv md me mf mg bi translated"><code class="fe mr ms mt mu b"><a class="ae jz" href="https://mockk.io/" rel="noopener ugc nofollow" target="_blank">Mockk</a></code></li><li id="47bd" class="lw lx in la b lb mh lf mi lj mj ln mk lr ml lv md me mf mg bi translated"><code class="fe mr ms mt mu b">MockedViewObserver</code></li><li id="fa64" class="lw lx in la b lb mh lf mi lj mj ln mk lr ml lv md me mf mg bi translated"><code class="fe mr ms mt mu b">TestDispatchersRule</code></li><li id="1950" class="lw lx in la b lb mh lf mi lj mj ln mk lr ml lv md me mf mg bi translated"><code class="fe mr ms mt mu b"><a class="ae jz" href="https://developer.android.com/reference/android/arch/core/executor/testing/InstantTaskExecutorRule" rel="noopener ugc nofollow" target="_blank">InstantTaskExecutorRule</a></code></li><li id="ec3b" class="lw lx in la b lb mh lf mi lj mj ln mk lr ml lv md me mf mg bi translated"><code class="fe mr ms mt mu b">UniFlowLogger.init(DebugMessageLogger())</code></li></ul><figure class="mn mo mp mq gt jo"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="6553" class="pw-post-body-paragraph ky kz in la b lb ly ld le lf lz lh li lj mv ll lm ln mw lp lq lr mx lt lu lv ig bi translated">当一切都准备好了，我们就可以开始写测试了</p><figure class="mn mo mp mq gt jo"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="572b" class="pw-post-body-paragraph ky kz in la b lb ly ld le lf lz lh li lj mv ll lm ln mw lp lq lr mx lt lu lv ig bi translated">用Uniflow测试就是这么简单。您的视图模型一次只有一个状态。测试将侧重于检查状态/事件序列，你可以重放任何状态和模拟任何场景！</p><figure class="mn mo mp mq gt jo"><div class="bz fp l di"><div class="my mz l"/></div></figure></div><div class="ab cl na nb hr nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ig ih ii ij ik"><h1 id="63ac" class="ka kb in bd kc kd nh kf kg kh ni kj kk kl nj kn ko kp nk kr ks kt nl kv kw kx bi translated">感谢阅读和快乐编码！🙏</h1><p id="44ed" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">如果您对实现感兴趣，可以看看这个示例</p><div class="nm nn gp gr no np"><a href="https://github.com/MarcinChrapowicz/Uniflow-User-Profile" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd io gy z fp nu fr fs nv fu fw im bi translated">MarcinChrapowicz/Uniflow-用户配置文件</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">在GitHub上创建一个帐户，为MarcinChrapowicz/Uniflow用户配置文件的开发做出贡献。</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">github.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od jt np"/></div></div></a></div></div><div class="ab cl na nb hr nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ig ih ii ij ik"><h1 id="2f89" class="ka kb in bd kc kd nh kf kg kh ni kj kk kl nj kn ko kp nk kr ks kt nl kv kw kx bi translated">单击👏说“谢谢！”并帮助他人找到这篇文章。</h1><p id="42e4" class="pw-post-body-paragraph ky kz in la b lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv ig bi translated">了解卡帕头最新的重大新闻。学院，<a class="ae jz" href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a" rel="noopener ugc nofollow" target="_blank">订阅时事通讯</a>，<a class="ae jz" href="https://twitter.com/ktdotacademy" rel="noopener ugc nofollow" target="_blank">观察推特</a>并在媒体上关注我们。</p><p id="bdbd" class="pw-post-body-paragraph ky kz in la b lb ly ld le lf lz lh li lj mv ll lm ln mw lp lq lr mx lt lu lv ig bi translated">如果你需要一个科特林工作室，看看我们如何能帮助你:<a class="ae jz" href="https://kt.academy/" rel="noopener ugc nofollow" target="_blank"> kt.academy </a>。</p><figure class="mn mo mp mq gt jo gh gi paragraph-image"><a href="https://kotlin-academy.us17.list-manage.com/subscribe?u=5d3a48e1893758cb5be5c2919&amp;id=d2ba84960a"><div class="gh gi oe"><img src="../Images/3146970f03e44cb07afe660b0d43e045.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*54OqlYA4etu7wfpmMP5TKQ.png"/></div></a></figure></div></div>    
</body>
</html>