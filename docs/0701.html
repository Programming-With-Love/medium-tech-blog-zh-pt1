<html>
<head>
<title>DataStore and data migration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据存储和数据迁移</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/datastore-and-data-migration-fdca806eb1aa?source=collection_archive---------6-----------------------#2022-02-15">https://medium.com/androiddevelopers/datastore-and-data-migration-fdca806eb1aa?source=collection_archive---------6-----------------------#2022-02-15</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/1fea125b5da043ce725eedc85b702dab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5_yt1M6_QEMN0OgGU8VaZw.png"/></div></div></figure><div class=""/><p id="69aa" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在我们的<a class="ae jn" rel="noopener" href="/androiddevelopers/introduction-to-jetpack-datastore-3dc8d74139e7"> <strong class="ir ht"> Jetpack数据存储系列</strong> </a>的这篇文章中，我们将介绍如何进行<strong class="ir ht">数据存储到数据存储的迁移</strong>。希望这将为您提供将数据存储成功添加到应用程序所需的所有信息。我们将参考<strong class="ir ht"> </strong> <a class="ae jn" href="https://developer.android.com/codelabs/android-preferences-datastore#0" rel="noopener ugc nofollow" target="_blank"> <strong class="ir ht">偏好</strong> <strong class="ir ht"> codelab </strong> </a>贯穿本文，获取代码示例。</p><h1 id="79f7" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">数据迁移</h1><p id="eb94" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">我们之前讨论过使用<code class="du kr ks kt ku b"><a class="ae jn" href="https://developer.android.com/reference/kotlin/androidx/datastore/migrations/SharedPreferencesMigration" rel="noopener ugc nofollow" target="_blank">SharedPreferencesMigration</a></code>从<code class="du kr ks kt ku b">SharedPreferences</code>迁移到数据存储。然而，在某些时候，您可能还需要进行<strong class="ir ht">数据存储到数据存储的迁移</strong>，例如，当您对数据集进行一些<strong class="ir ht">重大更改时(比如重命名您的数据模型值或更改它们的类型)。</strong></p><p id="d728" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这个过程和<code class="du kr ks kt ku b">SharedPreferences</code>的移民非常相似。事实上，<code class="du kr ks kt ku b">SharedPreferencesMigration</code>只是 <code class="du kr ks kt ku b"><a class="ae jn" href="https://cs.android.com/androidx/platform/frameworks/support/+/androidx-main:datastore/datastore-core/src/main/java/androidx/datastore/core/DataMigration.kt?q=DataMigration" rel="noopener ugc nofollow" target="_blank"><strong class="ir ht">DataMigration</strong></a></code> <strong class="ir ht">接口</strong>的一个<strong class="ir ht">实现:</strong></p><figure class="kv kw kx ky fd hj"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="e348" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了理解如何使用<code class="du kr ks kt ku b">DataMigration</code>，我们来分解一下:</p><ul class=""><li id="9850" class="lb lc hs ir b is it iw ix ja ld je le ji lf jm lg lh li lj bi translated"><code class="du kr ks kt ku b">DataMigration&lt;T&gt; </code> —我们的数据存储迁移界面。如果数据存储在将新迁移的数据写入磁盘时遇到问题，或者如果任何迁移抛出<code class="du kr ks kt ku b">Exception</code>，则可能会多次调用此迁移的方法(<code class="du kr ks kt ku b">shouldMigrate</code>、<code class="du kr ks kt ku b">migrate</code>和<code class="du kr ks kt ku b">cleanUp</code> ) <strong class="ir ht">。</strong></li><li id="4c8b" class="lb lc hs ir b is lk iw ll ja lm je ln ji lo jm lg lh li lj bi translated"><code class="du kr ks kt ku b">shouldMigrate()</code> —指定是否需要执行此迁移。如果返回false，则不会进行迁移或清理。这将在每次数据存储初始化时调用<strong class="ir ht">。</strong></li><li id="5b0b" class="lb lc hs ir b is lk iw ll ja lm je ln ji lo jm lg lh li lj bi translated"><code class="du kr ks kt ku b">migrate()</code> —执行迁移。如果失败，数据存储将不会向磁盘提交任何数据，<code class="du kr ks kt ku b">cleanUp()</code>将不会被调用，并且<strong class="ir ht">异常将被传播回</strong>触发迁移的数据存储调用。未来对数据存储的调用将导致再次尝试迁移。注意，这将总是在调用<code class="du kr ks kt ku b">cleanUp()</code>之前被调用。</li><li id="0a3d" class="lb lc hs ir b is lk iw ll ja lm je ln ji lo jm lg lh li lj bi translated"><code class="du kr ks kt ku b">cleanUp()</code>—您可以在这里添加您的实现，用于<strong class="ir ht">从先前的存储</strong>中清除任何迁移到新数据存储中的旧数据。如果迁移失败，将不会调用此函数。如果<code class="du kr ks kt ku b">cleanUp()</code>抛出异常，该异常将被传播回触发迁移的数据存储调用，未来对数据存储的调用将导致再次尝试迁移。</li></ul><h1 id="b3cf" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">首选项数据存储迁移</h1><p id="a081" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">为了创建一个满足我们迁移需求的实现，让我们想象一个场景，我们想要从 <code class="du kr ks kt ku b"><strong class="ir ht">oldPreferencesDataStore</strong></code> <strong class="ir ht">迁移到</strong> <code class="du kr ks kt ku b"><strong class="ir ht">newPreferencesDataStore</strong></code>。我们希望:</p><ol class=""><li id="d2f1" class="lb lc hs ir b is it iw ix ja ld je le ji lf jm lp lh li lj bi translated">将一个特定的旧<code class="du kr ks kt ku b">Float</code>键值对重新映射并重命名为一个新的<code class="du kr ks kt ku b">Int</code>键值对</li><li id="cbe9" class="lb lc hs ir b is lk iw ll ja lm je ln ji lo jm lp lh li lj bi translated">照原样将所有其他键-值对从旧的迁移到新的</li><li id="eba8" class="lb lc hs ir b is lk iw ll ja lm je ln ji lo jm lp lh li lj bi translated">清理旧仓库</li></ol><p id="6464" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了简单起见，我们将在我们的<a class="ae jn" href="https://developer.android.com/codelabs/android-preferences-datastore#0" rel="noopener ugc nofollow" target="_blank">首选项</a>代码实验室的<code class="du kr ks kt ku b">TasksActivity</code>中使用首选项数据存储委托来完成所有这些，但是您可以按照关于句柄注入  <strong class="ir ht"> </strong>的<a class="ae jn" rel="noopener" href="/androiddevelopers/datastore-and-dependency-injection-ea32b95704e3"> <strong class="ir ht">指令来将它移动到一个注入模块中。</strong></a></p><p id="d845" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们实现了<code class="du kr ks kt ku b">DataMigration</code>,并以如下方式覆盖了它的函数:</p><figure class="kv kw kx ky fd hj"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="b31f" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du kr ks kt ku b">produceMigrations</code>将确保<code class="du kr ks kt ku b">migrate()</code>在对新数据存储的任何潜在数据访问之前<strong class="ir ht">运行。这意味着您的<strong class="ir ht">迁移必须在数据存储发出任何进一步的值之前和开始对数据进行任何新的更改之前已经成功</strong>。</strong></p><p id="e890" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当<code class="du kr ks kt ku b">produceMigrations</code>参数接受一个<code class="du kr ks kt ku b">DataMigration</code>列表时，你可以从<strong class="ir ht">转移你想要的</strong>的旧存储器。这就是安全迁移您的数据所需的一切！您可以很容易地按照相同的模式将<strong class="ir ht"> Proto迁移到Proto DataStore</strong>——唯一的区别是如何转换数据。</p><h1 id="e066" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">待续</h1><p id="2a6a" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">我们已经介绍了从不同的数据存储库执行数据迁移——<code class="du kr ks kt ku b">DataMigration</code>接口如何工作，如何覆盖其功能以将旧数据转换为新数据，迁移数据，然后进行相应的清理。</p><p id="61b6" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">加入我们系列的下一篇也是最后一篇文章，我们将探讨如何测试数据存储库。</p><p id="7dce" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您可以在这里找到我们的Jetpack DataStore系列的所有帖子:<br/><a class="ae jn" rel="noopener" href="/androiddevelopers/introduction-to-jetpack-datastore-3dc8d74139e7">Jetpack DataStore简介</a> <br/> <a class="ae jn" rel="noopener" href="/androiddevelopers/all-about-preferences-datastore-cc7995679334">所有关于首选项DataStore </a> <br/> <a class="ae jn" rel="noopener" href="/androiddevelopers/all-about-proto-datastore-1b1af6cd2879">所有关于Proto DataStore</a><br/><a class="ae jn" rel="noopener" href="/androiddevelopers/datastore-and-dependency-injection-ea32b95704e3">DataStore和依赖注入</a> <br/> <a class="ae jn" rel="noopener" href="/androiddevelopers/datastore-and-kotlin-serialization-8b25bf0be66c"> DataStore和Kotlin序列化</a> <br/> <a class="ae jn" rel="noopener" href="/androiddevelopers/datastore-and-synchronous-work-576f3869ec4c"> DataStore和同步工作</a> <br/> <a class="ae jn" rel="noopener" href="/androiddevelopers/datastore-and-data-migration-fdca806eb1aa"> DataStore和数据迁移</a> <br/> <a class="ae jn" rel="noopener" href="/androiddevelopers/datastore-and-testing-edf7ae8df3d8"> DataStore和测试</a></p></div></div>    
</body>
</html>