<html>
<head>
<title>Building a new experiment pipeline with Spark</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Spark构建新的实验管道</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/building-a-new-experiment-pipeline-with-spark-b04e1a7d639a?source=collection_archive---------2-----------------------#2017-04-25">https://medium.com/pinterest-engineering/building-a-new-experiment-pipeline-with-spark-b04e1a7d639a?source=collection_archive---------2-----------------------#2017-04-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="1a96" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Tien Nguyen | Pinterest工程师，数据</p><p id="c1b5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Pinterest，我们非常依赖A/B实验来决定产品和功能。我们每天的目标是在上午10点之前准备好实验结果，这样我们就可以做出快速而有根据的决定。每天运行1，000多个实验，处理超过1.75亿个Pinners的数十亿条记录，我们需要一个可靠的管道来支持我们的增长并实现我们的服务级别协议。在本帖中，我们将讨论如何改进我们的遗留实验管道，以加快计算过程，使其更具可扩展性和性能。</p><h2 id="a488" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated"><strong class="ak">遗留管道</strong></h2><p id="16f3" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">Pinterest一直是一家数据驱动的公司。为了支持我们的决策过程，我们花费了巨大的努力来巩固、建立和维护一个专门的、可靠的<a class="ae kc" rel="noopener" href="/@Pinterest_Engineering/scalable-a-b-experiments-at-pinterest-1e28ddb7d22">实验管道</a>。随着这些年来我们的快速发展，Hive中的旧管道达到了其设计预期寿命。为此，管道有几个缺点:</p><ul class=""><li id="82c4" class="kd ke hh ig b ih ii il im ip kf it kg ix kh jb ki kj kk kl bi translated"><em class="km">较长的计算时间。</em>月活跃用户数从2015年的1亿跃升至2016年的1.5亿，再到今天的1.75亿。此外，活跃实验的数量在同一时期翻了一番，有更多的指标需要处理。这些增加导致了许多瓶颈，导致计算时间更长。</li><li id="1ff8" class="kd ke hh ig b ih kn il ko ip kp it kq ix kr jb ki kj kk kl bi translated">工作冗余。由于我们的数据量很大，我们需要通过将一个任务分成更小的任务来实现并行化。划分工作导致我们的管道中不可避免的重复代码，使得调试和维护更加困难。工作越多，依赖就越多，因此潜在的延迟就越多。</li></ul><p id="9505" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了支持我们的长期增长，我们必须解决这些缺点，建立新的渠道。</p><h2 id="b048" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated"><strong class="ak">新管道</strong></h2><p id="79be" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">在我们设计新管道时，我们不仅希望解决前面提到的挑战，还希望支持Pinterest在未来几年的发展。具体来说，我们希望简化逻辑、减少存储空间并轻松支持用户的请求。</p><p id="8891" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为此，我们采用Spark作为我们的解决方案。(查看<a class="ae kc" href="https://engineering.pinterest.com/blog/scalable-ab-experiments-pinterest" rel="noopener ugc nofollow" target="_blank">这篇文章</a>，它描述了我们实验框架的组件。)Spark工作流非常适合我们的框架。下图显示了:</p><ul class=""><li id="4131" class="kd ke hh ig b ih ii il im ip kf it kg ix kh jb ki kj kk kl bi translated">日志传输层的Kafka</li><li id="2af8" class="kd ke hh ig b ih kn il ko ip kp it kq ix kr jb ki kj kk kl bi translated">用于编排我们的Spark工作流程的弹球</li><li id="2316" class="kd ke hh ig b ih kn il ko ip kp it kq ix kr jb ki kj kk kl bi translated">用于实时实验组验证的火花流</li><li id="ae06" class="kd ke hh ig b ih kn il ko ip kp it kq ix kr jb ki kj kk kl bi translated">HBase和MemSQL为仪表板后端提供动力</li><li id="0709" class="kd ke hh ig b ih kn il ko ip kp it kq ix kr jb ki kj kk kl bi translated">快速进行交互式分析</li></ul><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es ks"><img src="../Images/7a7f65b8210d1726ef8b282377a67cb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D5bGNHENQ5itcQj_WhlrXA.png"/></div></div></figure><p id="7ba3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">借助Spark，我们还获得了以下优势:</p><ul class=""><li id="53d9" class="kd ke hh ig b ih ii il im ip kf it kg ix kh jb ki kj kk kl bi translated"><em class="km">更快的执行时间</em>。对于我们的特殊需求，我们发现在给定相同输入数据的情况下，我们在Spark中的实现通常比我们以前在遗留管道中的实现更快。下图显示，一项新作业的平均执行时间远低于两个小时，而在此之前，该作业需要四个多小时。我们通过简化管道来利用Spark的内存执行，从而获得更好的运行时间。此外，使用Spark，我们可以根据作业本身所需的资源来调整作业参数(比如执行器数量、Java内存开销)。</li></ul><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es le"><img src="../Images/edcd3ace354087fa61404c96722a8cb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1286/0*rCIUtmFbBDXmfUlj."/></div></figure><ul class=""><li id="06c9" class="kd ke hh ig b ih ii il im ip kf it kg ix kh jb ki kj kk kl bi translated"><a class="ae kc" href="https://engineering.pinterest.com/blog/scalable-ab-experiments-pinterest" rel="noopener ugc nofollow" target="_blank"> <em class="km">工作抽象</em> </a> <em class="km">。使用Spark，我们可以构建一个可以在未来扩展的实验分析框架，因此我们可以抽象作业，并在需要时传递适当的参数。作业抽象有助于避免重复代码，并将管道中的作业数量减少到很少。我们在设计和实施我们的渠道时抱着这样一种心态，即我们的工作需要:</em></li></ul><ol class=""><li id="6bd9" class="kd ke hh ig b ih ii il im ip kf it kg ix kh jb lf kj kk kl bi translated">具有足够的可扩展性和通用性，因此Pinterest的其他团队可以扩展和添加新的指标到实验仪表板。</li><li id="4962" class="kd ke hh ig b ih kn il ko ip kp it kq ix kr jb lf kj kk kl bi translated">可扩展以处理、存储和跟踪由不断增加的实验、用户和指标数量生成的大量数据。</li><li id="e2e3" class="kd ke hh ig b ih kn il ko ip kp it kq ix kr jb lf kj kk kl bi translated">能够通过仪表盘批量/实时地提供高质量的指标，提供最佳的统计测试模块。</li></ol><ul class=""><li id="4860" class="kd ke hh ig b ih ii il im ip kf it kg ix kh jb ki kj kk kl bi translated"><em class="km">减少存储空间。</em>随着数据的增加，我们希望减少存储空间。我们使用parquet格式(Spark自带的)来节省成本和空间。</li></ul><h2 id="464c" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated"><strong class="ak">结果</strong></h2><p id="b0ff" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">借助我们的新管道，我们现在可以在工作执行方面节省大量时间。平均而言，我们至少增加了三个小时(如下图所示)，因此，在我们的同事开始工作之前，我们就可以获得实验结果。</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lg"><img src="../Images/e9bc07ce1bd43001205491e1099276ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nyoW4L6QfSRh2NxY."/></div></div></figure><p id="299b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">上图显示了两条管道的交货时间。黑色是遗留管道，蓝线是用Spark写的。y轴是太平洋时间的交付时间(例如，15表示管道在下午3点结束)。新管道几乎总是在上午8点前完工，尽管仍有一些由上游作业延迟引起的高峰。</p><p id="0b10" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们很高兴看到新的Spark管道带来的巨大好处。如果你有兴趣建立一个影响整个Pinterest的伟大服务，<a class="ae kc" href="https://careers.pinterest.com/" rel="noopener ugc nofollow" target="_blank">加入我们</a>！</p><p id="bdd4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="km">鸣谢</em> </strong> <em class="km">:本项目由数据分析团队的Tien Nguyen、Shuo Xiang、Jooseong Kim和Bryant Xiao合作完成。全公司的人通过他们的见解和反馈帮助推出了这一功能。</em></p></div></div>    
</body>
</html>