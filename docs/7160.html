<html>
<head>
<title>Introducing Cleanse: A Lightweight Dependency Injection Framework For Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">引入cleane:Swift的轻量级依赖注入框架</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/introducing-cleanse-a-lightweight-dependency-injection-framework-for-swift-c1b0ddefd9c9?source=collection_archive---------0-----------------------#2016-06-14">https://medium.com/square-corner-blog/introducing-cleanse-a-lightweight-dependency-injection-framework-for-swift-c1b0ddefd9c9?source=collection_archive---------0-----------------------#2016-06-14</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="b60f" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">Cleanse是一个纯粹的Swift依赖注入库。</h2></div><p id="c64e" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="js">作者写的</em><a class="ae jt" href="http://twitter.com/@mikelewis" rel="noopener ugc nofollow" target="_blank"><em class="js"/></a><em class="js">。</em></p><blockquote class="ju"><p id="8f23" class="jv jw hh bd jx jy jz ka kb kc kd jr dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae jt" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><figure class="kf kg kh ki kj kk er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es ke"><img src="../Images/12d6719dfb57c00f6386d1158baa9dfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*121y-g03_twwV3f6wd8Ubg.png"/></div></div></figure><h1 id="fc7d" class="kr ks hh bd kt ku kv kw kx ky kz la lb in lc io ld iq le ir lf it lg iu lh li bi translated">面向所有人的依赖注入(移动设备)</h1><p id="4804" class="pw-post-body-paragraph iw ix hh iy b iz lj ii jb jc lk il je jf ll jh ji jj lm jl jm jn ln jp jq jr ha bi translated">几年前，我被介绍到这里从事Java服务的<a class="ae jt" href="https://en.wikipedia.org/wiki/Dependency_injection" rel="noopener ugc nofollow" target="_blank">依赖注入</a> (DI)。我们的Java“服务容器”构建在<a class="ae jt" href="https://github.com/google/guice" rel="noopener ugc nofollow" target="_blank"> Guice </a>之上。在经历了一个小小的学习过程后，它显然成了我离不开的技术之一。DI使软件能够<a class="ae jt" href="https://en.wikipedia.org/wiki/Loose_coupling" rel="noopener ugc nofollow" target="_blank">松散耦合</a>，<a class="ae jt" href="https://www.youtube.com/watch?v=hBVJbzAagfs" rel="noopener ugc nofollow" target="_blank">更易测试</a>，同时需要更少<a class="ae jt" href="https://corner.squareup.com/2013/05/dagger-1.0.html" rel="noopener ugc nofollow" target="_blank">烦人的样板代码</a>。</p><p id="c690" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在开发了几个Java服务之后，是时候回到iOS，在Objective-C中构建我们可爱的<a class="ae jt" href="https://squareup.com/appointments/app" rel="noopener ugc nofollow" target="_blank"> Square约会应用</a>了。转移到Objective-C意味着放弃强大的DI框架，如<a class="ae jt" href="https://github.com/google/guice" rel="noopener ugc nofollow" target="_blank"> Guice </a>和<a class="ae jt" href="https://github.com/square/dagger" rel="noopener ugc nofollow" target="_blank"> Dagger </a>。是的，过去和现在都有几个Objective-C的DI实现，但是我们觉得它们缺乏安全性，过度使用Objective-C运行时，或者配置起来过于冗长。这并没有阻止我们。我们提出了一个弗兰肯斯坦式的解决方案，使用<a class="ae jt" href="http://clang.llvm.org/docs/Tooling.html#libclang" rel="noopener ugc nofollow" target="_blank"> LibClang </a>并基于“注释”生成代码。它模仿了Dagger 1，并提供了编译时检查和其他一些好处。</p><p id="1e08" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">大约一年前，我们开始采用Swift。基于Objective-C的阿迪库开始显示出它的弱点，甚至在我们添加了对使用swift创建模块的支持之后。我们不能注入那些没有连接到Objective-C的东西，比如结构或者<a class="ae jt" href="https://github.com/ReactiveX/RxSwift/blob/master/Documentation/GettingStarted.md#observables-aka-sequences" rel="noopener ugc nofollow" target="_blank"> Observables </a>。代码生成解决方案需要一点Xcode技巧，比如维护<a class="ae jt" href="https://developer.apple.com/library/ios/recipes/xcode_help-project_editor/Articles/Adding%20a%20Build%20Rule.html#//apple_ref/doc/uid/TP40010155-CH5-SW1" rel="noopener ugc nofollow" target="_blank">定制构建规则</a>，并且必须手动接触文件来触发重新编译。尽管我们不想放弃DI，因为我们<a class="ae jt" href="https://corner.squareup.com/2013/05/dagger-1.0.html" rel="noopener ugc nofollow" target="_blank">也讨厌写样板代码</a>！</p><h1 id="f4ab" class="kr ks hh bd kt ku kv kw kx ky kz la lb in lc io ld iq le ir lf it lg iu lh li bi translated">输入清洗</h1><p id="be98" class="pw-post-body-paragraph iw ix hh iy b iz lj ii jb jc lk il je jf ll jh ji jj lm jl jm jn ln jp jq jr ha bi translated">在理想的情况下，我们应该为Swift实现类似于<a class="ae jt" href="http://google.github.io/dagger/" rel="noopener ugc nofollow" target="_blank"> Dagger 2 </a>的东西。不幸的是，Swift缺乏工具，如注释处理器、注释、类似Java的反射库等。然而，Swift确实有一个非常强大的类型系统。</p><p id="87aa" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们利用这种类型系统为您带来了<a class="ae jt" href="https://github.com/square/Cleanse" rel="noopener ugc nofollow" target="_blank">净化</a>，这是我们针对Swift的依赖注入框架。配置清理模块可能看起来与配置<a class="ae jt" href="https://google.github.io/guice/api-docs/latest/javadoc/com/google/inject/AbstractModule.html" rel="noopener ugc nofollow" target="_blank"> Guice模块</a>非常相似。然而，许多灵感也来自于<a class="ae jt" href="http://google.github.io/dagger/" rel="noopener ugc nofollow" target="_blank">匕首2 </a>，例如<a class="ae jt" href="http://google.github.io/dagger/users-guide.html#building-the-graph" rel="noopener ugc nofollow" target="_blank">组件</a>和<a class="ae jt" href="http://google.github.io/dagger/dagger-1-migration.html#declaring-the-component" rel="noopener ugc nofollow" target="_blank">缺少ObjectGraph </a> / <a class="ae jt" href="https://google.github.io/guice/api-docs/latest/javadoc/index.html?com/google/inject/Injector.html" rel="noopener ugc nofollow" target="_blank">注射器</a>类型，这允许不安全的操作。这让我们有了一个现代的DI框架，一个我们今天可以使用的健壮的<a class="ae jt" href="https://github.com/square/Cleanse#features" rel="noopener ugc nofollow" target="_blank">特性集</a>！</p><h1 id="2aba" class="kr ks hh bd kt ku kv kw kx ky kz la lb in lc io ld iq le ir lf it lg iu lh li bi translated">快速游览</h1><p id="907c" class="pw-post-body-paragraph iw ix hh iy b iz lj ii jb jc lk il je jf ll jh ji jj lm jl jm jn ln jp jq jr ha bi translated">我们制作了一个<a class="ae jt" href="https://github.com/square/Cleanse/blob/master/CleansePlayground.playground/Pages/GithubClientExample.xcplaygroundpage/Contents.swift" rel="noopener ugc nofollow" target="_blank">小示例playground </a>,演示了如何连接HTTP客户端向GitHub的API发出请求。</p><p id="0bbf" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">与支持<a class="ae jt" href="https://github.com/google/guice/wiki/ProvidesMethods" rel="noopener ugc nofollow" target="_blank">绑定</a>和<a class="ae jt" href="https://github.com/google/guice/wiki/Injections" rel="noopener ugc nofollow" target="_blank">注入</a>的<a class="ae jt" href="https://github.com/google/guice/wiki/LinkedBindings" rel="noopener ugc nofollow" target="_blank">几种</a> <a class="ae jt" href="https://github.com/google/guice/wiki/InstanceBindings" rel="noopener ugc nofollow" target="_blank">类型</a>的两个事实上的Java DI框架Dagger和Guice不同，Cleanse主要在<em class="js">工厂</em>注入上操作。在这个上下文中，factory只是一个取<em class="js"> 0的<a class="ae jt" href="https://developer.apple.com/library/ios/documentation/Swift/Conceptual/Swift_Programming_Language/Types.html#//apple_ref/doc/uid/TP40014097-CH31-ID449" rel="noopener ugc nofollow" target="_blank">函数类型</a>..参数并返回一个新的实例。方便的是，如果有一个<em class="js">GithubListMembersServiceImpl</em>类型，<em class="js">GithubListMembersServiceImpl . init</em>是<em class="js">GithubListMembersServiceImpl</em>的工厂，这使得它几乎等同于<a class="ae jt" href="https://github.com/google/guice/wiki/Injections#constructor-injection" rel="noopener ugc nofollow" target="_blank">构造函数注入</a>。</em></p><p id="9ed5" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">假设我们定义了一个协议，它应该列出GitHub组织的成员。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="a70b" class="lx ks hh lt b fi ly lz l ma mb"><strong class="lt hi">protocol</strong> GithubListMembersService {<br/>    <strong class="lt hi">func</strong> listMembers(organizationName: String, handler: [String] <strong class="lt hi">-&gt;</strong> ())<br/>}</span></pre><p id="1d48" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们将该协议实现为<em class="js">GithubListMembersServiceImpl</em></p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="45fb" class="lx ks hh lt b fi ly lz l ma mb"><strong class="lt hi">struct</strong> GithubListMembersServiceImpl : GithubListMembersService {<br/>  <em class="js">// We require a github base URL and an NSURLSession to perform our task</em></span><span id="e210" class="lx ks hh lt b fi mc lz l ma mb">  <strong class="lt hi">let</strong> githubURL: TaggedProvider<strong class="lt hi">&lt;</strong>GithubBaseURL<strong class="lt hi">&gt;</strong><br/>  <strong class="lt hi">let</strong> urlSession: NSURLSession</span><span id="8e2f" class="lx ks hh lt b fi mc lz l ma mb">  <em class="js">/// Lists members of an organization (ignores errors for sake of example)</em><br/>  <strong class="lt hi">func</strong> listMembers(organizationName: String, handler: [String] <strong class="lt hi">-&gt;</strong> ()) {<br/>    <strong class="lt hi">let</strong> url <strong class="lt hi">=</strong> githubURL.<strong class="lt hi">get</strong>().URLByAppendingPathComponent("orgs/\(organizationName)/public_members")</span><span id="2fbd" class="lx ks hh lt b fi mc lz l ma mb">    <strong class="lt hi">let</strong> dataTask <strong class="lt hi">=</strong> urlSession.dataTaskWithURL(url) { data, response, error <strong class="lt hi">in</strong><br/>      guard <strong class="lt hi">let</strong> data <strong class="lt hi">=</strong> data, result <strong class="lt hi">=</strong> (try<strong class="lt hi">?</strong> NSJSONSerialization.JSONObjectWithData(data, options: [])) <strong class="lt hi">as?</strong> [[String: AnyObject]] <strong class="lt hi">else</strong> {<br/>        handler([])<br/>        <strong class="lt hi">return</strong><br/>      }</span><span id="f9b1" class="lx ks hh lt b fi mc lz l ma mb">      handler(result.flatMap { $0["login"] <strong class="lt hi">as?</strong> String })<br/>    }</span><span id="c2a3" class="lx ks hh lt b fi mc lz l ma mb">    dataTask.resume()<br/>  }<br/>}</span></pre><p id="a9f2" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们希望每当请求一个<em class="js">githublistmemberservice</em>时就提供这个实现。为此，我们将其配置在一个<em class="js">模块</em>中。<em class="js">模块</em>是配置Cleanse的构建模块。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="e93f" class="lx ks hh lt b fi ly lz l ma mb"><strong class="lt hi">struct</strong> GithubAPIModule : Module {<br/>    <strong class="lt hi">func</strong> configure<strong class="lt hi">&lt;</strong>B : Binder<strong class="lt hi">&gt;</strong>(binder binder: B) {<br/>        <em class="js">// Configure GithubMembersServiceImpl to be the implementation of GithubMembersService</em><br/>        binder<br/>            .bind(GithubListMembersService.self)<br/>            .asSingleton()<br/>            .to(factory: GithubListMembersServiceImpl.<strong class="lt hi">init</strong>)</span><span id="a3d1" class="lx ks hh lt b fi mc lz l ma mb">        <em class="js">// While we're at it, configure the github Base URL to be "https://api.github.com"</em><br/>        binder<br/>            .bind()<br/>            .tagged(with: GithubBaseURL.self)<br/>            .to(value: NSURL(string: "https://api.github.com")<strong class="lt hi">!</strong>)</span><span id="5d54" class="lx ks hh lt b fi mc lz l ma mb">    }<br/>}</span></pre><p id="98a0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">你可能已经注意到<em class="js">githublistmemberserviceimpl</em>需要一个<em class="js"> NSURLSession </em>。为了满足这一要求，我们也需要对其进行配置。让我们制作另一个模块:</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="887d" class="lx ks hh lt b fi ly lz l ma mb"><strong class="lt hi">struct</strong> NetworkModule : Module {<br/>  <strong class="lt hi">func</strong> configure<strong class="lt hi">&lt;</strong>B : Binder<strong class="lt hi">&gt;</strong>(binder binder: B) {<br/>    <em class="js">// Make `NSURLSessionConfiguration.ephemeralSessionConfiguration` be provided</em><br/>    <em class="js">// when one requests a `NSURLSessionConfiguration`</em><br/>    binder<br/>        .bind()<br/>        .asSingleton()<br/>        .to(factory: NSURLSessionConfiguration.ephemeralSessionConfiguration)</span><span id="9db3" class="lx ks hh lt b fi mc lz l ma mb">    <em class="js">// Make `NSURLSession` available.</em><br/>    <em class="js">// It depends on `NSURLSessionConfiguration` configured above (`$0`)</em><br/>    binder<br/>        .bind()<br/>        .asSingleton()<br/>        .to {<br/>            NSURLSession(<br/>                configuration: $0,<br/>                delegate: nil,<br/>                delegateQueue: NSOperationQueue.mainQueue()<br/>            )<br/>        }<br/>  }<br/>}</span></pre><p id="5d38" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们可以将这两个模块组装在一个<em class="js">组件</em>中。一个<em class="js">组件</em>本质上是一个<em class="js">模块</em>，它也为一个对象图声明了一个<em class="js">根</em>类型。在这种情况下，我们希望我们的根是<em class="js">GithubListMembersService</em>。</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="a1d3" class="lx ks hh lt b fi ly lz l ma mb"><strong class="lt hi">struct</strong> GithubListMembersComponent : Component {<br/>  <em class="js">// When we build this component we want `GithubListMembersService` returned</em><br/>  <strong class="lt hi">typealias</strong> Root <strong class="lt hi">=</strong> GithubListMembersService</span><span id="1f7d" class="lx ks hh lt b fi mc lz l ma mb">  <strong class="lt hi">func</strong> configure<strong class="lt hi">&lt;</strong>B : Binder<strong class="lt hi">&gt;</strong>(binder binder: B) {<br/>    <em class="js">// Install both the modules we have made</em><br/>    binder.install(module: NetworkModule())<br/>    binder.install(module: GithubAPIModule())<br/>  }<br/>}</span></pre><p id="d177" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在是时候构建组件并获得我们的<em class="js">GithubListMembersService</em>！我们在组件的实例上调用<em class="js"> build() </em>。这将返回<em class="js">根</em>类型，<em class="js"> GithubListMembersService。</em></p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="dc6c" class="lx ks hh lt b fi ly lz l ma mb"><strong class="lt hi">let</strong> membersService <strong class="lt hi">=</strong> try<strong class="lt hi">!</strong> GithubListMembersComponent().build()</span></pre><p id="17b3" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">如果在构建我们的对象图时出现验证错误，它们将会从<em class="js"> build() </em>方法中抛出。</p><p id="5e82" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">现在，让我们看看<a class="ae jt" href="https://github.com/square" rel="noopener ugc nofollow" target="_blank"> Square的GitHub org </a>的成员是谁:</p><pre class="lo lp lq lr fd ls lt lu lv aw lw bi"><span id="2258" class="lx ks hh lt b fi ly lz l ma mb">membersService.listMembers("square") { members <strong class="lt hi">in</strong><br/>  print("Fetched \(members.count) members:")</span><span id="a36d" class="lx ks hh lt b fi mc lz l ma mb">  <strong class="lt hi">for</strong> (i, login) <strong class="lt hi">in</strong> members.enumerate() {<br/>    print("\(i+1).\t\(login)")<br/>  }<br/>}</span></pre><p id="2647" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">更详细的入门指南可以在自述文件中的<a class="ae jt" href="https://github.com/square/Cleanse#using-cleanse" rel="noopener ugc nofollow" target="_blank">中找到，或者看看我们的</a><a class="ae jt" href="https://github.com/square/Cleanse/tree/master/Examples/CleanseGithubBrowser" rel="noopener ugc nofollow" target="_blank">示例应用</a>。</p><h1 id="496e" class="kr ks hh bd kt ku kv kw kx ky kz la lb in lc io ld iq le ir lf it lg iu lh li bi translated">代码</h1><p id="dcd2" class="pw-post-body-paragraph iw ix hh iy b iz lj ii jb jc lk il je jf ll jh ji jj lm jl jm jn ln jp jq jr ha bi translated">人们可以在GitHub 上查看<a class="ae jt" href="https://github.com/square/Cleanse" rel="noopener ugc nofollow" target="_blank">clean。</a></p><p id="1dca" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">Cleanse是一项正在进行中的工作，但是我们认为它已经为一个非常强大和开发人员友好的DI框架提供了构建模块。我们鼓励社区参与开发更高级的功能(例如匕首2 中的<a class="ae jt" href="http://google.github.io/dagger/subcomponents.html" rel="noopener ugc nofollow" target="_blank">子组件)。其目前的实施支持Swift 2.2和Swift 3的开源版本。</a></p><p id="4f05" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们正在完全迁移<a class="ae jt" href="https://squareup.com/appointments/app" rel="noopener ugc nofollow" target="_blank"> Square Appointments应用</a>，以便在不久的将来满足我们所有的DI需求。期待在接下来的几周和几个月里看到令人兴奋的新特性、改进、更多的文档、示例，甚至更多的文章。</p></div><div class="ab cl md me go mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ha hb hc hd he"><div class="lo lp lq lr fd mk"><a href="http://twitter.com/@mikelewis" rel="noopener  ugc nofollow" target="_blank"><div class="ml ab dw"><div class="mm ab mn cl cj mo"><h2 class="bd hi fi z dy mp ea eb mq ed ef hg bi translated">迈克·刘易斯(@MikeLewis) |推特</h2><div class="mr l"><h3 class="bd b fi z dy mp ea eb mq ed ef dx translated">来自迈克·刘易斯的最新推文(@MikeLewis)。东西的制造者。小猫爱好者。@square的iOS黑客/麻烦制造者…</h3></div><div class="ms l"><p class="bd b fp z dy mp ea eb mq ed ef dx translated">twitter.com</p></div></div><div class="mt l"><div class="mu l mv mw mx mt my kp mk"/></div></div></a></div></div></div>    
</body>
</html>