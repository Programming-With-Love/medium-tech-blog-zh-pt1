<html>
<head>
<title>Super Simple Serverless eCommerce</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">超级简单的无服务器电子商务</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/super-simple-serverless-ecommerce-68d2792e8285?source=collection_archive---------2-----------------------#2018-04-19">https://medium.com/square-corner-blog/super-simple-serverless-ecommerce-68d2792e8285?source=collection_archive---------2-----------------------#2018-04-19</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><blockquote class="ie"><p id="df72" class="if ig hh bd ih ii ij ik il im in io dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae ip" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><p id="b4e1" class="pw-post-body-paragraph iq ir hh is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm io ha bi translated">许多公司已经投入使用<a class="ae ip" href="https://en.wikipedia.org/wiki/Serverless_computing" rel="noopener ugc nofollow" target="_blank">无服务器</a>来增强他们的技术堆栈(例如<a class="ae ip" href="https://read.acloud.guru/serverless-event-sourcing-at-nordstrom-ea69bd8fb7cc" rel="noopener ugc nofollow" target="_blank">诺德斯特龙</a>、<a class="ae ip" rel="noopener" href="/netflix-techblog/developer-experience-lessons-operating-a-serverless-like-platform-at-netflix-a8bbd5b899a0">网飞</a>和<a class="ae ip" href="https://aws.amazon.com/serverless/videos/video-lambda-coca-cola/" rel="noopener ugc nofollow" target="_blank">可口可乐</a>)。看起来无服务器只是一种日益增长的时尚，但这也是许多人对Node的想法，直到沃尔玛在黑色星期五之前推出了一个新网站。对于无服务器来说，我们可能正在接近一个类似的拐点，以快速提高Node已经能够实现的开发速度和规模。</p><p id="ef25" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">如果您还没有加入无服务器潮流，现在正是时候。我们将通过一个简单的方法来创建无服务器功能，以允许客户立即结帐并从Square商店购买商品。我们将在S3上创建一个静态站点，创建AWS Lambda函数，并创建AWS API网关端点，以允许客户使用Square Checkout API即时结账。</p><blockquote class="js jt ju"><p id="c9d9" class="iq ir jv is b it jn iv iw ix jo iz ja jw jp jd je jx jq jh ji jy jr jl jm io ha bi translated">有必要澄清一下<a class="ae ip" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>和<a class="ae ip" href="https://en.wikipedia.org/wiki/Serverless_computing" rel="noopener ugc nofollow" target="_blank">无服务器计算</a>之间的区别。无服务器框架只是一个工具，可用于帮助创建、部署和管理您与您想要的云提供商一起创建的无服务器功能。无服务器计算是指云提供商动态管理机器资源的分配。</p></blockquote><p id="a035" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">在这篇文章中，我们将使用无服务器框架来更容易地创建和部署我们的功能，但我们不希望它与无服务器计算相混淆。我们将在未来的帖子中探索不同的平台和不同的工具，因为我们将在这里讨论的概念上进行构建。</p></div><div class="ab cl jz ka go kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="ha hb hc hd he"><p id="4073" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">建造这个需要的东西:</p><ul class=""><li id="3edb" class="kg kh hh is b it jn ix jo jb ki jf kj jj kk io kl km kn ko bi translated"><a class="ae ip" href="https://squareup.com/developers" rel="noopener ugc nofollow" target="_blank"> Square开发者账号</a></li><li id="3c90" class="kg kh hh is b it kp ix kq jb kr jf ks jj kt io kl km kn ko bi translated"><a class="ae ip" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> AWS账户</a></li><li id="3837" class="kg kh hh is b it kp ix kq jb kr jf ks jj kt io kl km kn ko bi translated"><a class="ae ip" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器架构</a></li></ul><h2 id="4cd9" class="ku kv hh bd kw kx ky kz la lb lc ld le jb lf lg lh jf li lj lk jj ll lm ln lo bi translated">使用S3的静态站点</h2><p id="9a72" class="pw-post-body-paragraph iq ir hh is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm io ha bi translated">我们的小商店的基本结构将是一个静态的HTML页面，托管在S3上，用CSS和JavaScript装饰。然后，我们将通过Lambda函数处理我们的结账，该函数允许您只购买您点击的一件商品。这是为了说明如何在AWS上启动和运行的超级基础——我们可以在未来的帖子中探索更高级的方法。我们将从HTML开始，并把它引入S3来创建我们的静态网站。</p><figure class="lu lv lw lx fd ly"><div class="bz dy l di"><div class="lz ma l"/></div><figcaption class="mb mc et er es md me bd b be z dx">We’re just hard coding our item variant ID into a hidden input field to POST to our function.</figcaption></figure><p id="e8e9" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">通过查看产品div元素来了解我们的<code class="du mf mg mh mi b">index.html</code>的内容。我们将项目的<a class="ae ip" href="https://docs.connect.squareup.com/api/connect/v2#endpoint-retrievecatalogobject" rel="noopener ugc nofollow" target="_blank">变量id </a>硬编码到每个div中，并将其填充到一个隐藏的输入字段中。这将让我们很容易通过POST请求将它传递给我们的Lambda函数。我采用这种方法的主要原因完全在于它的简单性。我们不需要编写任何JavaScript来处理信息传递——我们可以使用表单元素的本机行为将我们的项目信息发送到我们的函数中。</p><p id="5625" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">如果我们放入12种产品，我们会得到类似于下面的结果:</p><figure class="lu lv lw lx fd ly"><div class="bz dy l di"><div class="lz ma l"/></div><figcaption class="mb mc et er es md me bd b be z dx">The inner product tags have been removed to make this easier to read.</figcaption></figure><p id="75d6" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">我们将跳过用于创建模态的样式和jQuery，因为这不是这里的重点。我们所要做的就是将我们所有的文件上传到S3，并启用属性中的“静态网站托管”来拥有一个可公开访问的网站。</p><p id="fb71" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">现在我们应该有一个漂亮的页面让每个人都能看到我们的产品，但我们需要有一种方法让每个人都能购买这些产品。现在我们终于开始深入创建我们的AWS Lambda函数(无服务器函数)。这就是我们将要创建的放在表单“action”属性中的内容，这样我们的表单就可以发送到我们的函数中。</p><figure class="lu lv lw lx fd ly er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es mj"><img src="../Images/f59556adf9b018f858d2f080a0bffa29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RiQhDFnejiTQYb3B1tNASg.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx">I should hope its clear you have your own bucket name for the URL.</figcaption></figure><p id="f7c2" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">通过访问AWS提供的URL，您应该能够访问您的静态网站，并且您可以看到所有展出的精彩项目。</p></div><div class="ab cl jz ka go kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="ha hb hc hd he"><h2 id="a107" class="ku kv hh bd kw kx ky kz la lb lc ld le jb lf lg lh jf li lj lk jj ll lm ln lo bi translated">使用AWS Lambda的无服务器功能</h2><p id="c928" class="pw-post-body-paragraph iq ir hh is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm io ha bi translated">对于我们的无服务器功能，我们将处理Square <a class="ae ip" href="https://docs.connect.squareup.com/api/connect/v2#endpoint-retrievecatalogobject" rel="noopener ugc nofollow" target="_blank"> catalog variant ID </a>，它是从我们静态站点中的表单发送的，然后创建一个checkout URL来重定向我们的用户。为此，我们将在函数中使用Square的<a class="ae ip" href="https://github.com/square/connect-javascript-sdk" rel="noopener ugc nofollow" target="_blank"> JavaScript SDK </a>来更容易地生成我们需要的URL。非常欢迎您尝试使用<em class="jv">和</em> AWS工具来创建和部署功能，但是我们将只使用<a class="ae ip" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器</a>来管理功能的部署并将其链接到AWS API网关。</p><p id="ecd9" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">如果你也想使用无服务器来创建你自己的功能，这里有很棒的教程。您需要在您的机器上安装Node并使用<code class="du mf mg mh mi b">npm install -g serverless</code>安装serverless(或者如果您不想全局安装它，就使用<code class="du mf mg mh mi b"><a class="ae ip" rel="noopener" href="/@maybekatz/introducing-npx-an-npm-package-runner-55f7d4bd282b">npx</a></code>)。</p><p id="789d" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">你可以运行<code class="du mf mg mh mi b">serverless create --template aws-nodejs</code>来得到一个模板，但是它创建了很多不需要的东西。你可以随意复制<code class="du mf mg mh mi b">handler.js</code>和<code class="du mf mg mh mi b">serverless.yml</code>来修改成你自己的模板。我们将从一个基本功能开始，测试我们的部署是否按预期工作，然后为我们的检查添加功能。</p><figure class="lu lv lw lx fd ly"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="4d9c" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">这只是我们要测试的例子。接下来，我们想要创建我们的<code class="du mf mg mh mi b">serverless.yml</code>文件，用于部署我们的功能和创建AWS API网关端点。</p><figure class="lu lv lw lx fd ly"><div class="bz dy l di"><div class="lz ma l"/></div><figcaption class="mb mc et er es md me bd b be z dx">There are probably more elegant ways of handling your credentials if you don’t want them in your file.</figcaption></figure><p id="dc86" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">现在，只需运行<code class="du mf mg mh mi b">serverless deploy</code>就可以将我们的功能发布到云中。部署时，您应该会看到类似下面的内容:</p><pre class="lu lv lw lx fd mq mi mr ms aw mt bi"><span id="2ff9" class="ku kv hh mi b fi mu mv l mw mx">Serverless: Packaging service...<br/>Serverless: Excluding development dependencies...<br/>Serverless: Uploading CloudFormation file to S3...<br/>Serverless: Uploading artifacts...<br/>Serverless: Uploading service .zip file to S3 (742.81 KB)...<br/>Serverless: Validating template...<br/>Serverless: Updating Stack...<br/>Serverless: Checking Stack update progress...<br/>..............<br/>Serverless: Stack update finished...<br/>Service Information<br/>service: serverless-checkout<br/>stage: prod<br/>region: us-east-1<br/>stack: serverless-checkout-prod<br/>api keys:<br/>  None<br/>endpoints:<br/>  ANY - https://UNIQUE_ID.execute-api.us-east-1.amazonaws.com/prod/checkout<br/>functions:<br/>  checkout: serverless-checkout-prod-checkout<br/>Serverless: Removing old service versions...</span></pre><p id="52ab" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">您应该能够在浏览器中访问无服务器退出控制台的URL，并在浏览器中找到我们的消息<code class="du mf mg mh mi b">“Success! Our function is running!”</code>。我们只需要重构Lambda函数来处理目录变量ID，以便请求我们的checkout URL并重定向用户。</p><figure class="lu lv lw lx fd ly"><div class="bz dy l di"><div class="lz ma l"/></div><figcaption class="mb mc et er es md me bd b be z dx">Note that our credentials are pulled in from “<code class="du mf mg mh mi b">process.env”</code>, which can be set in the AWS console as environment variables.</figcaption></figure><p id="7adc" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">在这里，我们有我们的全功能(双关语)Lambda函数，可以创建结帐URL，让用户购买我们的产品。</p><p id="484f" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">同样，值得提醒的是，这是故意最小化的实现，仅适用于像数字商品(不需要纳税)这样的东西，但演示了创建您的结账和重定向客户是多么容易，而无需启动我们自己的服务器。事实上，如果您要将目录变量ID作为查询字符串参数附加到函数URL中，您可以在函数中解析出这些内容，从而拥有自己的无服务器“立即购买”链接。此外，您可以添加一个运费项目，以轻松处理统一运费，甚至在收银台捕捉客户的运费细节(请参见<a class="ae ip" href="https://docs.connect.squareup.com/payments/checkout/overview#create-the-post-request" rel="noopener ugc nofollow" target="_blank">此处</a>了解更多详情)。</p><figure class="lu lv lw lx fd ly er es paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="er es my"><img src="../Images/fd78dfdd67cb48de860d4412917a11c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VC8FjM4vSbPwtsTdDDDKNw.png"/></div></div><figcaption class="mb mc et er es md me bd b be z dx">A preview of our eCommerce store. Those are our stickers we give away at developer conferences.</figcaption></figure><h2 id="cab2" class="ku kv hh bd kw kx ky kz la lb lc ld le jb lf lg lh jf li lj lk jj ll lm ln lo bi translated">无服务器误解</h2><p id="c7e1" class="pw-post-body-paragraph iq ir hh is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm io ha bi translated">关于无服务器计算及其组成，似乎存在广泛的误解。是按调用付费吗？按内存Mb/s付费？就像Node一样，serverless也有点渴望“做所有的事情”没错，这是一项需要探索的新技术，但是出现了许多奇怪的用法，它们被视为反模式(在我看来)。Node过去和现在都因其单线程特性而在处理CPU密集型任务方面表现不佳，对于使用无服务器进行面向用户的交互或API也是如此。用户期望事情有响应，冷启动扼杀了预期的响应。您当然可以尝试通过保持函数温暖来解决这个问题，但这听起来像是一种反模式。无服务器的全部好处是不必担心您的基础设施，然而人们正在编写更多的代码来修改他们实际上无法控制的基础设施的行为。</p><p id="b955" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">如果您计划将无服务器应用于面向用户的应用程序，请仔细查看您的终端用户流量模式，因为这将严重影响整体用户体验。恒定的流量相对来说没什么问题——功能会保持温暖，很少一部分用户会受到缓慢响应的影响——但如果你的流量特别大，用户体验就会受到影响，因为你的平台提供商<a class="ae ip" href="https://theburningmonk.com/2018/01/im-afraid-youre-thinking-about-aws-lambda-cold-starts-all-wrong/" rel="noopener ugc nofollow" target="_blank">正在增加你的功能的额外实例</a>来服务你的流量。</p></div><div class="ab cl jz ka go kb" role="separator"><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke kf"/><span class="kc bw bk kd ke"/></div><div class="ha hb hc hd he"><p id="4d8d" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">随着技术的不断成熟，使用无服务器计算有许多可能性可以探索，并且随着时间的推移，今天的问题将会减少。现在开始的真正原因是，你可以对未来所有新的无服务器采用者居高临下，告诉他们无服务器编程在你那个时代有多难。因此，现在就开始构建无服务器系统吧！</p><p id="c8df" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated">要跟进这篇文章，你需要<a class="ae ip" href="https://squareup.com/developers" rel="noopener ugc nofollow" target="_blank">注册一个Square开发者账户</a>。即使你不想跟进，也要注册，这是免费的！</p><p id="f0af" class="pw-post-body-paragraph iq ir hh is b it jn iv iw ix jo iz ja jb jp jd je jf jq jh ji jj jr jl jm io ha bi translated"><em class="jv">想要更多吗？</em> <a class="ae ip" href="https://www.workwithsquare.com/developer-newsletter.html?channel=Online%20Social&amp;sqmethod=Blog" rel="noopener ugc nofollow" target="_blank"> <em class="jv">注册</em> </a> <em class="jv">获取我们每月的开发者简讯。</em></p></div></div>    
</body>
</html>