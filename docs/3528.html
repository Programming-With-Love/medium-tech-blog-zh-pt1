<html>
<head>
<title>MONITORING AZURE VMs USING GRAFANA</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GRAFANA监控AZURE虚拟机</h1>
<blockquote>原文：<a href="https://medium.com/globant/monitoring-azure-vms-using-grafana-6b6636582bdd?source=collection_archive---------0-----------------------#2020-10-29">https://medium.com/globant/monitoring-azure-vms-using-grafana-6b6636582bdd?source=collection_archive---------0-----------------------#2020-10-29</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><h1 id="e199" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">介绍</h1><p id="e830" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">Grafana是一个可视化工具，使用Azure Monitor、Elasticsearch、CloudWatch等数据源。用于图形显示数据。本文将集中讨论使用Azure Monitor插件来监控Azure虚拟机，以及Grafana提供的各种功能来主动监控Azure虚拟机。</p><p id="b6d3" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">作为先决条件，虚拟机应该连接到Azure Log analytics工作区，其中所有指标数据都在Perf表下捕获</p><p id="1f61" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">本文的第一部分将描述一个典型的安装，使用基本配置和Azure Monitor作为数据源。</p><blockquote class="kf kg kh"><p id="2a9f" class="jc jd ki je b jf ka jh ji jj kb jl jm kj kc jp jq kk kd jt ju kl ke jx jy jz ha bi translated">1-安装<br/> 2-配置<br/> 3-数据源</p></blockquote><p id="a7d0" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">第二部分将包括关键仪表板以及如何共享它们。</p><blockquote class="kf kg kh"><p id="3f4d" class="jc jd ki je b jf ka jh ji jj kb jl jm kj kc jp jq kk kd jt ju kl ke jx jy jz ha bi translated">4-仪表板<br/> 5-仪表板共享</p></blockquote><p id="3f0b" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">最后但同样重要的是，我们将描述这个用例中这个工具的优点和局限性。</p><blockquote class="kf kg kh"><p id="3002" class="jc jd ki je b jf ka jh ji jj kb jl jm kj kc jp jq kk kd jt ju kl ke jx jy jz ha bi translated">Grafana的优点<br/> 7-局限性</p></blockquote><h1 id="e8d7" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">第一节</h1><h2 id="c2ff" class="km if hh bd ig kn ko kp ik kq kr ks io jn kt ku is jr kv kw iw jv kx ky ja kz bi translated">1.装置</h2><p id="9dbd" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">Grafana提供了两个版本的工具:</p><ol class=""><li id="3030" class="la lb hh je b jf ka jj kb jn lc jr ld jv le jz lf lg lh li bi translated">OSS(开源) :功能上与企业版相同，但是如果你想要企业版的特性，你需要下载企业版</li><li id="172e" class="la lb hh je b jf lj jj lk jn ll jr lm jv ln jz lf lg lh li bi translated">企业:推荐下载。功能上与开源版本相同，但是包括您可以选择使用许可证解锁的功能。</li></ol><p id="6652" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">本文展示了在Linux VM (Ubuntu 18.04)上安装最新的Grafana企业版。要在Windows、Mac和其他版本的Linux上安装，请参考Grafana的官方文档:</p><p id="80ce" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">【https://grafana.com/docs/grafana/latest/installation/ T4】</p><p id="05a4" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">步骤:</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="c47a" class="km if hh lu b fi ly lz l ma mb">1. sudo apt-get install -y apt-transport-https</span><span id="0b60" class="km if hh lu b fi mc lz l ma mb">2. sudo apt-get install -y software-properties-common wget</span><span id="f44b" class="km if hh lu b fi mc lz l ma mb">3. wget -q -O —  <a class="ae lo" href="https://packages.grafana.com/gpg.key" rel="noopener ugc nofollow" target="_blank">https://packages.grafana.com/gpg.key</a> | sudo apt-key add –</span><span id="17f3" class="km if hh lu b fi mc lz l ma mb">4. echo “deb <a class="ae lo" href="https://packages.grafana.com/enterprise/deb" rel="noopener ugc nofollow" target="_blank">https://packages.grafana.com/enterprise/deb</a> stable main” | sudo tee -a /etc/apt/sources.list.d/grafana.list</span><span id="c978" class="km if hh lu b fi mc lz l ma mb">5. sudo apt-get update</span><span id="8bdf" class="km if hh lu b fi mc lz l ma mb">6. sudo apt-get install grafana-enterprise</span><span id="dfa4" class="km if hh lu b fi mc lz l ma mb">7. sudo service grafana-server start</span><span id="047c" class="km if hh lu b fi mc lz l ma mb">8. sudo service grafana-server status</span><span id="1c1b" class="km if hh lu b fi mc lz l ma mb">9. sudo update-rc.d grafana-server defaults</span></pre><h2 id="e50b" class="km if hh bd ig kn ko kp ik kq kr ks io jn kt ku is jr kv kw iw jv kx ky ja kz bi translated">2.配置</h2><p id="5113" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">安装完成后，在默认端口3000上打开Grafana工具</p><p id="deb8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi"> http://YOUR-IP:3000 </strong></p><p id="2327" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">默认用户名和密码是admin，需要在首次登录时更改。</p><p id="8ecd" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">注意</strong>:用安装Grafana的虚拟机的公共IP地址替换YOUR-IP</p><figure class="lp lq lr ls fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es md"><img src="../Images/c20b830149e2855d4b34e7d82ffbbd0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2mmW9IYHK8NvZMwN"/></div></div></figure><p id="0f60" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">Grafana使用Azure Monitor作为数据源，从Azure Monitor、Azure log analytics、Application Insights等Azure服务中实时获取数据。为此，我们需要创建一个服务主体，并将以下权限分配给SPN:</p><p id="975f" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">1.订阅级别的读者权限(如果存在多个订阅，则需要多个订阅的读者权限)。这是通过Azure Monitor读取订阅中的所有资源所必需的。</p><p id="a544" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">2.订阅从Azure log analytics读取数据的日志分析读取器权限。</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/8ae9a16be53f1ffa1601518fcf07fc2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*FfX4NmYi-XItuiVB"/></div></figure><p id="d1bd" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">3.日志分析API权限。(活动目录-&gt; API权限-&gt;添加权限)</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/02b8924d2d5bd688c50678e7ff898028.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*Ngocy6baV5wrGSEq"/></div></figure><p id="7b44" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">创建了具有所需权限的SPN后，使用以下步骤配置Azure Monitor数据源:</p><h2 id="dc57" class="km if hh bd ig kn ko kp ik kq kr ks io jn kt ku is jr kv kw iw jv kx ky ja kz bi translated">3.数据源</h2><p id="f85a" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">1.在浏览器上打开Grafana实例，然后转到数据源</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/979c0defee3c65a33f60bc1ccd502e71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*cCJ4iYyXgDiudTDo"/></div></figure><p id="cbfe" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">2.点击添加数据源并搜索Azure Monitor</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/0bf1f3dfbd5aca51ea94e09e34930f67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*Xo-Mq45uE7uqvsHf"/></div></figure><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/79c2717762e9bd75f36c073d4effad64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*NbGWKN72TqANLWEJ"/></div></figure><p id="baeb" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">3.在数据源中填写SPN的详细信息。</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/a066584347aa74b8a711fbddbfe56c98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*2khm-UqTgtIf1mhq"/></div></figure><p id="7221" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">一旦数据源配置成功，我们就可以开始创建仪表板了。</p><h1 id="ac4c" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">第二节</h1><h2 id="b6fe" class="km if hh bd ig kn ko kp ik kq kr ks io jn kt ku is jr kv kw iw jv kx ky ja kz bi translated">4.仪表板</h2><p id="5c31" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">在本节中，我已经使用上一节中配置的数据源创建了一个仪表板。它使用log analytics查询从perf表中获取数据，并显示在Grafana中。为了列出资源组和这些资源组中的虚拟机，我们使用了一个称为<strong class="je hi">变量</strong>的特性，我们可以在日志分析查询中使用它。</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/0750bbfe5d3877fee9e4f3758017a254.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*CF1a5HT-QzEo1WSP"/></div></figure><p id="631d" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">变量:</strong>创建变量请使用以下截图:</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/68c85c1986a928eabfdee19a27c49403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*Bc-HkIt6nZLmH6rx"/></div></figure><p id="640c" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">1.创建一个变量<strong class="je hi"> ResourceGroup </strong>来列出订阅中的所有rg:</p><p id="b5f8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">查询:</strong>资源组()</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/c7ef6d5109e8f6da41608c7ef11d248e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*NUFtPh1ml9jUz819"/></div></figure><p id="6463" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">2.创建变量VM以列出RG中的VM:</p><p id="94fd" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">查询</strong>:ResourceNames($ resource group，Microsoft。计算/虚拟机器)</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/d3e4f23ed594ddec25888a2e5b958a9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*L2Od9zyIiruoOzkk"/></div></figure><p id="2670" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">注意:</strong>如果您有多个订阅，您也可以使用type作为<strong class="je hi"> Datasource </strong>为订阅创建一个变量，然后在ResourceGroup和VM变量中使用该变量。</p><p id="fb90" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">这里我只有一个数据源(GrafanaTest ),显示在下面的截图中，所以我没有创建订阅变量。</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/67b337858257d81b26f60b0abcc5cfaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*UQXLrlahLuabyBJt"/></div></figure><p id="131f" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">指标:</strong>现在，一旦变量准备就绪，我们就可以在日志分析查询中使用它们进行各种指标监控。</p><p id="982f" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">以下是我用来监控Azure虚拟机的一些指标:</p><ul class=""><li id="86ff" class="la lb hh je b jf ka jj kb jn lc jr ld jv le jz mm lg lh li bi translated"><strong class="je hi"> CPU百分比(平均值)</strong>:显示过去5分钟的平均CPU百分比。</li></ul><p id="bcb2" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">变量<strong class="je hi">虚拟机</strong>用于日志分析，以显示所选RG中所有虚拟机的数据。</p><p id="b69c" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">查询:</strong></p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="3ace" class="km if hh lu b fi ly lz l ma mb">Perf</span><span id="4fb7" class="km if hh lu b fi mc lz l ma mb">|where ObjectName ==”Processor” and CounterName ==”% Processor Time”</span><span id="4bc5" class="km if hh lu b fi mc lz l ma mb">|extend vm=iif(Computer has “.”,substring(Computer,0,indexof(Computer, ‘.’)),Computer)</span><span id="56b3" class="km if hh lu b fi mc lz l ma mb">|where (tolower(strcat(“””,$<strong class="lu hi">VM</strong>,”””)) has tolower(vm)) and (Computer has vm)</span><span id="d586" class="km if hh lu b fi mc lz l ma mb">|where $__timeFilter(TimeGenerated)</span><span id="af58" class="km if hh lu b fi mc lz l ma mb">|summarize avg(CounterValue) by vm,bin(TimeGenerated,5m)</span><span id="6586" class="km if hh lu b fi mc lz l ma mb">| sort by vm asc , TimeGenerated asc</span><span id="687a" class="km if hh lu b fi mc lz l ma mb">| order by TimeGenerated asc</span></pre><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/b3c5fd17bf5a4d5bdbbdb224b703802f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*395HlbqDK9MSgpJ8"/></div></figure><p id="c73e" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">X轴和Y轴的比例可以从轴面板更改，如下图所示:</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es mn"><img src="../Images/e967bd6788356dc2e8bd6bc7ebf65c36.png" data-original-src="https://miro.medium.com/v2/resize:fit:426/0*EINJUWf68u8jlcGo"/></div></figure><ul class=""><li id="62b0" class="la lb hh je b jf ka jj kb jn lc jr ld jv le jz mm lg lh li bi translated"><strong class="je hi">已用磁盘空间(%): </strong>显示虚拟机上过去5分钟的平均已用磁盘空间百分比</li></ul><p id="0a27" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">查询:</strong></p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="cb43" class="km if hh lu b fi ly lz l ma mb">Perf</span><span id="bba1" class="km if hh lu b fi mc lz l ma mb">| where ObjectName == “LogicalDisk” or ObjectName == “Logical Disk”</span><span id="2fd9" class="km if hh lu b fi mc lz l ma mb">| where CounterName == “% Used Space”</span><span id="2fba" class="km if hh lu b fi mc lz l ma mb">|where InstanceName != “_Total”</span><span id="65a3" class="km if hh lu b fi mc lz l ma mb">|extend vm=iif(Computer has “.”,substring(Computer,0,indexof(Computer, ‘.’)),Computer)</span><span id="1106" class="km if hh lu b fi mc lz l ma mb">|where (tolower(strcat(“””,$VM,”””)) has tolower(vm)) and (Computer has vm)</span><span id="d7a0" class="km if hh lu b fi mc lz l ma mb">| where $__timeFilter(TimeGenerated)</span><span id="e901" class="km if hh lu b fi mc lz l ma mb">| summarize avg(CounterValue) by vm,bin(TimeGenerated,5m)</span><span id="4656" class="km if hh lu b fi mc lz l ma mb">| sort by vm asc,TimeGenerated asc</span><span id="97e6" class="km if hh lu b fi mc lz l ma mb">| order by TimeGenerated asc</span></pre><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/5afdd83d7be4956b3d2a4000a4d25aeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*FxwxXArIB7_uEPtV"/></div></figure><ul class=""><li id="472f" class="la lb hh je b jf ka jj kb jn lc jr ld jv le jz mm lg lh li bi translated"><strong class="je hi">可用磁盘空间(%): </strong>显示虚拟机上最近15分钟的平均可用磁盘空间百分比</li></ul><p id="a397" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">查询:</strong></p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="8003" class="km if hh lu b fi ly lz l ma mb">Perf</span><span id="0433" class="km if hh lu b fi mc lz l ma mb">| where ObjectName == “LogicalDisk” or ObjectName == “Logical Disk”</span><span id="e6c8" class="km if hh lu b fi mc lz l ma mb">| where CounterName == “% Used Space”</span><span id="8f6e" class="km if hh lu b fi mc lz l ma mb">|where InstanceName != “_Total”</span><span id="1432" class="km if hh lu b fi mc lz l ma mb">|extend vm=iif(Computer has “.”,substring(Computer,0,indexof(Computer, ‘.’)),Computer)</span><span id="8548" class="km if hh lu b fi mc lz l ma mb">|where (tolower(strcat(“””,$VM,”””)) has tolower(vm)) and (Computer has vm)</span><span id="37c5" class="km if hh lu b fi mc lz l ma mb">| where $__timeFilter(TimeGenerated)</span><span id="2033" class="km if hh lu b fi mc lz l ma mb">| summarize avg(100-CounterValue) by vm,bin(TimeGenerated,15m)</span><span id="c51a" class="km if hh lu b fi mc lz l ma mb">| sort by vm asc,TimeGenerated asc</span><span id="b66a" class="km if hh lu b fi mc lz l ma mb">| order by TimeGenerated asc</span></pre><figure class="lp lq lr ls fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es ml"><img src="../Images/9bba2c0a610cc379ac18a9130d7949f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*XzNdEuamVJ_nqSkk"/></div></div></figure><ul class=""><li id="3baf" class="la lb hh je b jf ka jj kb jn lc jr ld jv le jz mm lg lh li bi translated"><strong class="je hi">可用内存(%): </strong>显示虚拟机上的可用内存(RAM)百分比，为过去15分钟的平均值。</li></ul><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/23b57a04948e87eb070c9e3770c3120a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*bCLh6sjY4fFuoA4y"/></div></figure><p id="0382" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">查询:</strong></p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="bc7c" class="km if hh lu b fi ly lz l ma mb">Perf</span><span id="9e95" class="km if hh lu b fi mc lz l ma mb">|where ObjectName ==”Memory”</span><span id="aafe" class="km if hh lu b fi mc lz l ma mb">|where CounterName ==”% Committed Bytes in Use” or CounterName == “% Used Memory”</span><span id="bca5" class="km if hh lu b fi mc lz l ma mb">|extend vm=iif(Computer has “.”,substring(Computer,0,indexof(Computer, ‘.’)),Computer)</span><span id="5e87" class="km if hh lu b fi mc lz l ma mb">|where (tolower(strcat(“””,$VM,”””)) has tolower(vm)) and (Computer has vm)</span><span id="6704" class="km if hh lu b fi mc lz l ma mb">| where $__timeFilter(TimeGenerated)</span><span id="1add" class="km if hh lu b fi mc lz l ma mb">|summarize avg(100-CounterValue) by vm,bin(TimeGenerated,15m)</span><span id="7089" class="km if hh lu b fi mc lz l ma mb">| sort by vm asc,TimeGenerated asc</span><span id="cc85" class="km if hh lu b fi mc lz l ma mb">| order by TimeGenerated asc</span></pre><ul class=""><li id="d2f1" class="la lb hh je b jf ka jj kb jn lc jr ld jv le jz mm lg lh li bi translated"><strong class="je hi">已用内存(%): </strong>显示过去15分钟虚拟机上已用内存(RAM)的百分比平均值。</li></ul><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es mo"><img src="../Images/c7a7efbf0fcab5aed399ee6fe5a4648e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/0*VBRivT9TUPUYeScK"/></div></figure><p id="305c" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">查询:</strong></p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="7e7c" class="km if hh lu b fi ly lz l ma mb">Perf</span><span id="3024" class="km if hh lu b fi mc lz l ma mb">|where ObjectName ==”Memory”</span><span id="3aad" class="km if hh lu b fi mc lz l ma mb">|where CounterName ==”% Committed Bytes in Use” or CounterName == “% Used Memory”</span><span id="ff83" class="km if hh lu b fi mc lz l ma mb">|extend vm=iif(Computer has “.”,substring(Computer,0,indexof(Computer, ‘.’)),Computer)</span><span id="4f1a" class="km if hh lu b fi mc lz l ma mb">|where (tolower(strcat(“””,$VM,”””)) has tolower(vm)) and (Computer has vm)</span><span id="87c7" class="km if hh lu b fi mc lz l ma mb">| where $__timeFilter(TimeGenerated)</span><span id="0ce8" class="km if hh lu b fi mc lz l ma mb">|summarize avg(CounterValue) by vm,bin(TimeGenerated,15m)</span><span id="f3ac" class="km if hh lu b fi mc lz l ma mb">| sort by vm asc,TimeGenerated asc</span><span id="0393" class="km if hh lu b fi mc lz l ma mb">| order by TimeGenerated asc</span></pre><ul class=""><li id="c11b" class="la lb hh je b jf ka jj kb jn lc jr ld jv le jz mm lg lh li bi translated"><strong class="je hi">每秒磁盘写入数:</strong>显示过去15分钟内每秒的平均磁盘写入操作数。</li></ul><p id="84c3" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">查询:</strong></p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="cfcb" class="km if hh lu b fi ly lz l ma mb">Perf</span><span id="4fa2" class="km if hh lu b fi mc lz l ma mb">| where ObjectName == “LogicalDisk” or ObjectName == “Logical Disk”</span><span id="6190" class="km if hh lu b fi mc lz l ma mb">|where CounterName == “Disk Writes/sec”</span><span id="955d" class="km if hh lu b fi mc lz l ma mb">|extend vm=iif(Computer has “.”,substring(Computer,0,indexof(Computer, ‘.’)),Computer)</span><span id="d099" class="km if hh lu b fi mc lz l ma mb">|where (tolower(strcat(“””,$VM,”””)) has tolower(vm)) and (Computer has vm)</span><span id="6960" class="km if hh lu b fi mc lz l ma mb">| where $__timeFilter(TimeGenerated)</span><span id="1e3f" class="km if hh lu b fi mc lz l ma mb">| summarize avg(CounterValue) by vm,bin(TimeGenerated,15m)</span><span id="ff2b" class="km if hh lu b fi mc lz l ma mb">| sort by vm asc,TimeGenerated asc</span><span id="00f9" class="km if hh lu b fi mc lz l ma mb">| order by TimeGenerated asc</span></pre><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es mp"><img src="../Images/93c0383662d14b6f8cfc330e660eb378.png" data-original-src="https://miro.medium.com/v2/resize:fit:1170/0*6eG1ZAeIifo52kBt"/></div></figure><ul class=""><li id="a9de" class="la lb hh je b jf ka jj kb jn lc jr ld jv le jz mm lg lh li bi translated"><strong class="je hi">每秒磁盘读取数:</strong>显示过去15分钟内每秒的平均磁盘读取操作数。</li></ul><p id="c9fb" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">查询:</strong></p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="ed8d" class="km if hh lu b fi ly lz l ma mb">Perf</span><span id="c9b5" class="km if hh lu b fi mc lz l ma mb">| where ObjectName == “LogicalDisk” or ObjectName == “Logical Disk”</span><span id="d03b" class="km if hh lu b fi mc lz l ma mb">|where CounterName == “Disk Reads/sec”</span><span id="f4d2" class="km if hh lu b fi mc lz l ma mb">|extend vm=iif(Computer has “.”,substring(Computer,0,indexof(Computer, ‘.’)),Computer)</span><span id="2854" class="km if hh lu b fi mc lz l ma mb">|where (tolower(strcat(“””,$VM,”””)) has tolower(vm)) and (Computer has vm)</span><span id="50b9" class="km if hh lu b fi mc lz l ma mb">| where $__timeFilter(TimeGenerated)</span><span id="5b67" class="km if hh lu b fi mc lz l ma mb">| summarize avg(CounterValue) by vm,bin(TimeGenerated,15m)</span><span id="1109" class="km if hh lu b fi mc lz l ma mb">| sort by vm asc,TimeGenerated asc</span><span id="baa1" class="km if hh lu b fi mc lz l ma mb">| order by TimeGenerated asc</span></pre><figure class="lp lq lr ls fd me er es paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="er es mq"><img src="../Images/5bd7dd44b5684009c58ae465b09bd732.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*72Kt3QusuxpEl0dg"/></div></div></figure><ul class=""><li id="1fda" class="la lb hh je b jf ka jj kb jn lc jr ld jv le jz mm lg lh li bi translated"><strong class="je hi">逻辑磁盘IOPS: </strong>显示过去15分钟内平均每秒执行的输入/输出磁盘操作的原始数量。</li></ul><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/1f9771d937b4069a4699c4882078560a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*JSQ5mqwZFB7El7q6"/></div></figure><p id="60fe" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">查询</strong>:</p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="cd67" class="km if hh lu b fi ly lz l ma mb">Perf</span><span id="11a0" class="km if hh lu b fi mc lz l ma mb">| where ObjectName == “LogicalDisk” or ObjectName == “Logical Disk”</span><span id="3f51" class="km if hh lu b fi mc lz l ma mb">|where CounterName == “Disk Transfers/sec”</span><span id="9811" class="km if hh lu b fi mc lz l ma mb">| where InstanceName != “_Total”</span><span id="0792" class="km if hh lu b fi mc lz l ma mb">|extend vm=iif(Computer has “.”,substring(Computer,0,indexof(Computer, ‘.’)),Computer)</span><span id="1725" class="km if hh lu b fi mc lz l ma mb">|where (tolower(strcat(“””,$VM,”””)) has tolower(vm)) and (Computer has vm)</span><span id="bfc6" class="km if hh lu b fi mc lz l ma mb">| where $__timeFilter(TimeGenerated)</span><span id="35bb" class="km if hh lu b fi mc lz l ma mb">| summarize avg(CounterValue) by vm,bin(TimeGenerated,15m)</span><span id="0ece" class="km if hh lu b fi mc lz l ma mb">| sort by vm asc,TimeGenerated asc</span><span id="5a80" class="km if hh lu b fi mc lz l ma mb">| order by TimeGenerated asc</span></pre><ul class=""><li id="645a" class="la lb hh je b jf ka jj kb jn lc jr ld jv le jz mm lg lh li bi translated"><strong class="je hi">网络输入:</strong>显示过去15分钟内虚拟机在所有网络接口上接收的平均字节数(传入流量)。</li></ul><p id="013f" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">查询:</strong></p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="865b" class="km if hh lu b fi ly lz l ma mb">Perf</span><span id="9303" class="km if hh lu b fi mc lz l ma mb">| where ObjectName == “Network Adapter”</span><span id="7267" class="km if hh lu b fi mc lz l ma mb">|where CounterName == “Bytes Received/sec”</span><span id="4c9a" class="km if hh lu b fi mc lz l ma mb">|extend vm=iif(Computer has “.”,substring(Computer,0,indexof(Computer, ‘.’)),Computer)</span><span id="0724" class="km if hh lu b fi mc lz l ma mb">|where (tolower(strcat(“””,$VM,”””)) has tolower(vm)) and (Computer has vm)</span><span id="2ee1" class="km if hh lu b fi mc lz l ma mb">| where $__timeFilter(TimeGenerated)</span><span id="7168" class="km if hh lu b fi mc lz l ma mb">|extend vm_new= strcat(vm, “.Bytes Received/sec”)</span><span id="e2db" class="km if hh lu b fi mc lz l ma mb">| summarize avg(CounterValue) by vm_new,bin(TimeGenerated,15m)</span><span id="ceb1" class="km if hh lu b fi mc lz l ma mb">| sort by vm_new asc,TimeGenerated asc</span><span id="068c" class="km if hh lu b fi mc lz l ma mb">| order by TimeGenerated asc</span></pre><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/ccc56742ed15029655186a3ac21d3c77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*3SQgD-NB52aQNc3f"/></div></figure><ul class=""><li id="1ba5" class="la lb hh je b jf ka jj kb jn lc jr ld jv le jz mm lg lh li bi translated"><strong class="je hi">网络输出:</strong>显示过去15分钟内虚拟机在所有网络接口上输出的平均字节数(传出流量)。</li></ul><p id="dcd9" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">查询:</strong></p><pre class="lp lq lr ls fd lt lu lv lw aw lx bi"><span id="b9a9" class="km if hh lu b fi ly lz l ma mb">Perf</span><span id="0bf4" class="km if hh lu b fi mc lz l ma mb">| where ObjectName == “Network Adapter”</span><span id="f31a" class="km if hh lu b fi mc lz l ma mb">|where CounterName == “Bytes Sent/sec”</span><span id="78d1" class="km if hh lu b fi mc lz l ma mb">|extend vm=iif(Computer has “.”,substring(Computer,0,indexof(Computer, ‘.’)),Computer)</span><span id="a4a9" class="km if hh lu b fi mc lz l ma mb">|where (tolower(strcat(“””,$VM,”””)) has tolower(vm)) and (Computer has vm)</span><span id="1f25" class="km if hh lu b fi mc lz l ma mb">| where $__timeFilter(TimeGenerated)</span><span id="6c57" class="km if hh lu b fi mc lz l ma mb">|extend vm_new= strcat(vm, “.Bytes Sent/sec”)</span><span id="3400" class="km if hh lu b fi mc lz l ma mb">| summarize avg(CounterValue) by vm_new,bin(TimeGenerated,15m)</span><span id="16eb" class="km if hh lu b fi mc lz l ma mb">| sort by vm_new asc,TimeGenerated asc</span><span id="045e" class="km if hh lu b fi mc lz l ma mb">| order by TimeGenerated asc</span></pre><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/838e7ba0c9abb9c1121c6864fd082b20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*q9a4QtH2kwzjCwD1"/></div></figure><h2 id="a074" class="km if hh bd ig kn ko kp ik kq kr ks io jn kt ku is jr kv kw iw jv kx ky ja kz bi translated">5.仪表板共享</h2><p id="f0d1" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">Grafana提供了三种共享仪表板的方式:</p><p id="21d3" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">链接:</strong>您可以为仪表板生成一个链接，并将其共享给有权访问Grafana的用户。</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/bbdaebb897d2f91a0c7f746450ed046d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*YXb6X9FLurHSqyul"/></div></figure><p id="1377" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">快照:</strong>您可以生成一个本地快照来生成一个不需要用户访问Grafana的链接。在此链接中，用户将无法更改变量值，但可以看到共享时的数据</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/e90cc9d38da160a2fb1d519c5dffe978.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*6De_Oa_Rx9HjSyvC"/></div></figure><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/e73ad02ed8021731bf5e6e2c616908a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*Bn7zjm3M-X8CgcSy"/></div></figure><p id="31ae" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">快照仪表板:</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/37e9024f53775dbc37d80d5768e6a079.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*drA2XUj7jP4G5fr7"/></div></figure><p id="49ae" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated"><strong class="je hi">导出:</strong>仪表板可以保存到json文件中并与其他人共享。Grafana提供了一个使用json文件导入dashboard的选项。这样，Grafana仪表板也可以作为json文件保存在源代码控制存储库中。</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/1657d5e4c46bfc914c1fe7cfe04417bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*8Mtt3cbdki2_q2N6"/></div></figure><p id="54f8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">然后，可以使用下面截图中显示的步骤将保存的json格式的仪表板导入grafana:</p><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/49a64bfc60ef678d22652e9c8cf1a758.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*P7R5kPhni8BRdeE7"/></div></figure><figure class="lp lq lr ls fd me er es paragraph-image"><div class="er es ml"><img src="../Images/1e0ad03f93232797be3cac0bad0460bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/0*8bXKreTXkSzR4pRa"/></div></figure><h1 id="d2ae" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">第三节</h1><h2 id="de9e" class="km if hh bd ig kn ko kp ik kq kr ks io jn kt ku is jr kv kw iw jv kx ky ja kz bi translated">6.Grafana的优势</h2><p id="e2b4" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">1.与Azure本机监控相比，Grafana提供了一个选项，可以借助变量在单个仪表板上绘制多个虚拟机指标。</p><p id="ee08" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">2.Grafana支持多种云，如AWS、Azure、GCP等。因此，可以在一个控制面板上监控来自不同云的资源。</p><p id="e2d8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">3.Grafana提供了更好的指标可视化。它有各种类型的面板，如图表、条形图、表格、文本等。</p><p id="e8b2" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">4.提供仪表板链接等功能，可用于链接各种仪表板，以实现更深入和增强的监控。</p><p id="a498" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">5.共享仪表板很容易。</p><p id="3ea8" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">6.Grafana支持报警。</p><p id="003c" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">7.Grafana不存储任何数据，它使用Rest API调用获取实时数据。</p><h2 id="40a8" class="km if hh bd ig kn ko kp ik kq kr ks io jn kt ku is jr kv kw iw jv kx ky ja kz bi translated">7.限制</h2><p id="f433" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">1.不支持时序存储。Grafana只是一个可视化解决方案。时间序列存储不是其核心功能的一部分，而Prometheus等工具通过沿时间序列使用键值标记来存储时间序列，以更好地组织数据并提供强大的查询功能。</p><p id="956b" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">2.不支持数据收集。时间序列存储和时间序列收集都不是其核心功能的一部分。</p><p id="0f17" class="pw-post-body-paragraph jc jd hh je b jf ka jh ji jj kb jl jm jn kc jp jq jr kd jt ju jv ke jx jy jz ha bi translated">3.警报管理不是很成熟，也不是其核心功能的一部分。</p><h1 id="ac85" class="ie if hh bd ig ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb bi translated">结论</h1><p id="d3ed" class="pw-post-body-paragraph jc jd hh je b jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ha bi translated">Grafana提供了大量插件，用于集成多个云提供商和其他工具，如Elasticsearch、Graphite、Prometheus等。Grafana也提供报告功能，但需要企业许可证。Grafana不存储任何数据，这是一个限制，但从安全角度来看也是好的，因为它使用REST API调用获取实时数据。因此，如果您正在寻找一个集中式工具来监控多云环境中的资源，或者与其他工具集成以提高可视化，Grafana是一个不错的选择。</p></div></div>    
</body>
</html>