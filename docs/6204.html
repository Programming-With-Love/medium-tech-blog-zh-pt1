<html>
<head>
<title>Optimizing Kafka for the cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为云优化Kafka</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/optimizing-kafka-for-the-cloud-4e936643fde0?source=collection_archive---------0-----------------------#2019-04-23">https://medium.com/pinterest-engineering/optimizing-kafka-for-the-cloud-4e936643fde0?source=collection_archive---------0-----------------------#2019-04-23</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="28f3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由Ambud Sharma |测井团队软件工程师</p><h1 id="6ae8" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated"><strong class="ak">外卖</strong></h1><ul class=""><li id="6a88" class="ka kb hh ig b ih kc il kd ip ke it kf ix kg jb kh ki kj kk bi translated">开发位置感知系统和平衡算法有助于大幅降低成本</li><li id="29bc" class="ka kb hh ig b ih kl il km ip kn it ko ix kp jb kh ki kj kk bi translated">使Kafka生产者和消费者机架感知有助于有效地路由流量</li><li id="7f92" class="ka kb hh ig b ih kl il km ip kn it ko ix kp jb kh ki kj kk bi translated">数据驱动的工程决策对于持续改进系统至关重要</li></ul><p id="007c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在云中运行时的一个基本原则是确保应用程序不会中断。实现这一点的常见方法是将应用程序的部署分布在多个故障域中。在公共云环境中，可用性区域(AZ)可以作为故障域。我们可以使用多个az为应用程序提供容错。</p><p id="bdc0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">像HDFS这样的分布式系统传统上是机架感知的，通过将副本分布在数据中心内的多个机架上来提高容错能力。然而，在云环境中运行时，使用AZs作为机架信息是一种常见的做法。这使得数据拷贝可以跨多个az分布，从而在一个az出现故障时提供容错能力。<strong class="ig hi">虽然跨AZs复制数据提供了容错能力，但这确实会增加AZ传输成本。</strong></p><p id="ebf5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Pinterest，我们广泛使用Kafka作为可扩展的容错分布式消息总线，为几项关键服务提供支持，如<a class="ae kq" rel="noopener" href="/@Pinterest_Engineering/building-a-real-time-user-action-counting-system-for-ads-88a60d9c9a">用户操作计数</a>和变更数据捕获(CDC)。<strong class="ig hi"> </strong>由于我们有<a class="ae kq" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank"> Kafka </a>以非常大的<a class="ae kq" rel="noopener" href="/pinterest-engineering/how-pinterest-runs-kafka-at-scale-ff9c6f735be">规模运行</a>，我们需要注意AZ传输成本并尽可能高效地运行，因此我们专注于减少跨AZ传输的数据量。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="er es kr"><img src="../Images/6623eea6fba8c26efccb897832ffc168.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9BmXWVw13HIHMMC1"/></div></div></figure><p id="6f59" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当Kafka集群具有分布在多个AZ上的代理时，会导致三种类型的跨AZ网络流量:</p><ol class=""><li id="eb39" class="ka kb hh ig b ih ii il im ip ld it le ix lf jb lg ki kj kk bi translated">代理间复制流量</li><li id="ea7a" class="ka kb hh ig b ih kl il km ip kn it ko ix kp jb lg ki kj kk bi translated">来自不同az的生产者的流量</li><li id="fa77" class="ka kb hh ig b ih kl il km ip kn it ko ix kp jb lg ki kj kk bi translated">来自不同az的消费者的流量</li></ol><p id="c09d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在上述流量类型中，我们需要1来实现容错。然而，2和3是引起额外成本的不希望的副作用，在理论上可以消除。</p><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es lh"><img src="../Images/94a2384418f19cae4e94d87a92490535.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/0*aAp_4NeSdp8hslsf"/></div></figure><h1 id="cceb" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated"><strong class="ak">设计</strong></h1><p id="1b61" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip li ir is it lj iv iw ix lk iz ja jb ha bi translated">有两种潜在的方法可以解决这个问题。</p><p id="af7d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ll">方法1 </em></p><p id="a0ee" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们可以让我们的生产者和消费者只为其领导者共享相同AZ的分区写/读数据，以使它们更具成本效益。</p><p id="228a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ll">方法2 </em></p><p id="8649" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">或者，我们可以部署AZ特定的Kafka集群，但为了实现这一点，任何其他实时消费者都需要让他们的业务逻辑AZ知道。</p><p id="7a2c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了简单起见，我们选择了方法1，因为它最大限度地减少了代码和堆栈的变化。生产者/消费者AZ感知可以通过查找我们试图读/写的分区的领导者代理的机架信息，并改变生产者的分区逻辑和消费者的分配来实现。</p><p id="180c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Kafka中，经纪人的<a class="ae kq" href="https://kafka.apache.org/11/javadoc/org/apache/kafka/common/Node.html#rack--" rel="noopener ugc nofollow" target="_blank">机架信息</a>是与Kafka客户端(消费者和生产者)共享的<a class="ae kq" href="https://kafka.apache.org/11/javadoc/org/apache/kafka/common/PartitionInfo.html" rel="noopener ugc nofollow" target="_blank">分区信息</a>元数据对象的一部分。因此，我们在Kafka集群中部署了机架感知，每个代理将它所在的AZ发布为节点机架信息。</p><p id="c2bd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们从Kafka、伐木代理和S3运输公司的最大生产商和消费者应用程序开始了这项计划。</p><h1 id="17a7" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated"><strong class="ak">制作人AZ知名度</strong></h1><p id="6b01" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip li ir is it lj iv iw ix lk iz ja jb ha bi translated">我们的日志代理负责从日志文件中读取数据，并用微型批处理将它们发送给Kafka。该代理还允许用户配置如何跨主题的分区对日志进行分区。</p><p id="ab50" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的日志代理的一个关键设计是能够在调用Kafka的<a class="ae kq" href="https://kafka.apache.org/10/javadoc/org/apache/kafka/clients/producer/KafkaProducer.html#send-org.apache.kafka.clients.producer.ProducerRecord-" rel="noopener ugc nofollow" target="_blank"> producer.send() </a>之前对数据进行预分区。这允许我们添加更高级的路由。为了让它能够感知AZ，我们为日志代理添加了使用EC2元数据API查找运行它的节点的AZ信息的能力。接下来，我们增强了我们的分区器，以利用Kafka的生产者元数据中的机架信息，从而将写入限制为仅写入领导者与日志记录代理在同一AZ的分区。(此更改仅适用于不使用基于键的分区的主题，因为在AZ感知更改后无法保证排序，因为分区会切换AZ。)</p><h1 id="107f" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated"><strong class="ak">消费者AZ认知度</strong></h1><p id="eddc" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip li ir is it lj iv iw ix lk iz ja jb ha bi translated">S3传输器负责从Kafka读取日志，并将其保存到S3进行进一步处理。我们尝试了类似于《S3运输者》的制作。</p><p id="5dc9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的S3传送器不使用卡夫卡消费者分配。相反，它使用自己的分区分配系统。这使我们能够在节点重启或临时网络隔离的情况下保持局部性，从而减少给定批处理需要重放的数据量。</p><p id="eefa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们让每个S3运输工人查找并向Zookeeper发布其AZ信息，这有助于S3运输工人根据他们的机架(AZ)将Kafka分区分配给工人。如果我们无法查找一个分区的(机架)AZ信息，我们会降级到在所有可用的工作者之间进行分配。</p><h1 id="9e04" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated"><strong class="ak">结果</strong></h1><figure class="ks kt ku kv fd kw er es paragraph-image"><div class="er es lh"><img src="../Images/50ee51a84c30e898d2bc92a62a575804.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/0*T73dplejkwwT8SX3"/></div></figure><p id="1112" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们将AZ aware S3运输机投入生产，为伐木节省了超过25%的AZ运输成本。我们目前正在慢慢推出AZ感知日志代理，以进一步降低我们的AZ转移成本。</p><p id="c86a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们还在努力将这种设计扩展到标准的Kafka生产商和消费者，以帮助我们将我们的节省扩展到其他应用，一旦实施，可能包括<a class="ae kq" href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-392%3A+Allow+consumers+to+fetch+from+closest+replica" rel="noopener ugc nofollow" target="_blank"> KIP-392 </a>。</p><p id="d7bd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi"> <em class="ll">鸣谢</em> </strong> <em class="ll">:非常感谢、蔡亨利、、平、、易茵、齐一年和帮助Pinterest改进日志记录。此外，感谢卡利姆·莫卧儿帮助我们完成这项工作。</em></p></div></div>    
</body>
</html>