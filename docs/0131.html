<html>
<head>
<title>Better Android Testing at Airbnb — Part 2: Screenshot Testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Airbnb更好的Android测试——第二部分:截图测试</h1>
<blockquote>原文：<a href="https://medium.com/airbnb-engineering/better-android-testing-at-airbnb-a77ac9531cab?source=collection_archive---------1-----------------------#2019-11-30">https://medium.com/airbnb-engineering/better-android-testing-at-airbnb-a77ac9531cab?source=collection_archive---------1-----------------------#2019-11-30</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="ccae" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们Airbnb Android测试系列的第二部分，我们来看看如何使用截图测试来自动测试我们的片段UI。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/ac4fc4ca18795462e96f8717c1f33976.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rFNXjTXgs4i3T9a0Ha7lGg.jpeg"/></div></div></figure><p id="6ac4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在<a class="ae jp" rel="noopener" href="/airbnb-engineering/better-android-testing-at-airbnb-3f5b90b9c40a">我们的第一篇文章</a>中，我们看了MvRx模拟系统，以及在应用程序中打开任何屏幕或模拟的启动器。虽然这对手工测试来说很棒，但是模拟的最大好处是它们在自动化测试中释放的能量。为了利用这一点，我们从自动化截图测试开始，该测试检测提交之间的视觉变化。</p><p id="e228" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这有助于发现一系列问题:</p><ul class=""><li id="3ae1" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb jv jw jx jy bi translated">填充、颜色和样式更改</li><li id="53e7" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">数据呈现方式的逻辑问题</li><li id="8918" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">如何显示边缘情况，如null或空数据</li><li id="4879" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">从右向左(RTL)布局回归</li><li id="56a8" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">由库版本更改引入的更改，如新的RecyclerView或ConstraintLayout版本</li></ul><p id="4eaa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">手动测试所有这些需要很长时间，我们发现问题经常在我们的开发人员测试和QA过程中出现。特别是在复杂的屏幕上，很容易错过这些类型的回归。屏幕截图测试捕捉到了这些问题，此外，还添加了基本的健全性检查，以确保片段可以在不崩溃的情况下运行。对我们来说，这是最容易实现的目标，一旦我们有了模拟基础设施，添加它就相当容易了。</p><p id="5954" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们通过几个步骤实现了这一点:</p><ol class=""><li id="923d" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb ke jw jx jy bi translated">构建了一个Android库来截图一个活动并将位图上传到云存储</li><li id="1832" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb ke jw jx jy bi translated">利用<a class="ae jp" href="https://happo.io/" rel="noopener ugc nofollow" target="_blank"> Happo </a>提供了一个网络用户界面来显示各个分支之间的位图差异</li><li id="641d" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb ke jw jx jy bi translated">设置我们的CI来截屏每个模拟，用Happo生成一个差异报告，并将结果发送回PR</li></ol><p id="1d7e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这些步骤中的每一步都提出了一系列独特的挑战。</p><h1 id="37f3" class="kf kg hh bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">截图库</h1><p id="bb51" class="pw-post-body-paragraph ie if hh ig b ih ld ij ik il le in io ip lf ir is it lg iv iw ix lh iz ja jb ha bi translated">捕捉一个截图是相当简单的，有很多库都是这样做的；然而，我们构建了自己的系统，因为我们有一些重要的需求。</p><p id="af18" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">首先，我们需要捕捉整个视图层次结构，而不仅仅是设备屏幕上可见的内容。我们广泛使用RecyclerViews，这些视图不会将内容显示在屏幕之外，因此内容不会在正常的屏幕截图中被捕获。为了解决这个问题，我们手动测量activity视图，并允许它获得想要的高度。然后，我们强行布局。为了模拟真实的布局过程，我们还调用注册的布局监听器和预绘制监听器——这些监听器可能会请求另一个布局过程，在这个过程中，我们进行case循环，直到所有视图都被布局好。最后，我们将整个视图层次结构绘制到画布上，并保存到位图中。</p><p id="8313" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">另一个需求是最小化测试迭代中的视觉差异(即片状剥落)。本库有几种方法可以最小化这些差异:</p><ul class=""><li id="b230" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb jv jw jx jy bi translated">禁用编辑文本光标，否则它会在计时器上闪烁</li><li id="0bde" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">每个视图的焦点清晰，但可能设置不一致</li><li id="6914" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">使每个视图无效并请求布局，这对于清除度量缓存、可绘制状态以及确保每个视图将完全重绘自己是必要的</li><li id="baa7" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">清除资源可绘制缓存，因为共享可绘制对象在以不同大小重绘时会导致不可预测的像素混淆。</li></ul><p id="5328" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们的库将每个位图上传到云存储，并将所有的截图URL编译成一个报告，上传到Happo。生成的Happo报告与git SHA相关联，Happo可以将其与任何其他SHA报告进行比较，以发现跨分支的变化。</p><p id="b233" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，因为我们必须处理成千上万的截图，所以我们的库必须尽可能的高性能。为了实现这一点，它使用协同程序同时处理和上传位图。</p><p id="2439" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因为我们使用的是位图，所以内存异常是一个威胁。我们布局整个RecyclerViews的方法加剧了这种情况，这种方法可能会无限长。为了防止出现问题，我们将模拟数据中的列表截断为三项，但是仍然必须支持固有的长屏幕。通过有效地重用位图，并启用大堆，我们能够截屏长达40，000像素的视图。</p><p id="6650" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们对AWS和Happo都有不稳定的网络请求问题，这可能会超时或遇到我们无法控制的其他问题。用指数补偿将所有这些请求包装在重试逻辑中极大地增加了测试的稳定性。</p><p id="de7f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">结果是，对于每个模拟，我们都有一个相应的图像url来直观地表示它。位图的md5 SHA用作文件名，并且允许我们容易地检查两个图像是否相同。</p><h1 id="7620" class="kf kg hh bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">哈波</h1><p id="2e7b" class="pw-post-body-paragraph ie if hh ig b ih ld ij ik il le in io ip lf ir is it lg iv iw ix lh iz ja jb ha bi translated">Happo是一个外部服务，我们利用它来运行位图比较。它提供了许多优秀的特性，例如</p><ul class=""><li id="f913" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb jv jw jx jy bi translated">查看屏幕的位图历史记录，了解它是如何随时间变化的</li><li id="1330" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">当您关注的屏幕发生变化时，发送电子邮件提醒通知</li><li id="138c" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">UI将差异标记为易变的，并存储起来以备将来比较</li><li id="170c" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">阻止Github PR，直到差异报告被批准</li><li id="d442" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">一个web用户界面，用于查看报告中的所有屏幕截图，并识别跨报告的可视更改</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es li"><img src="../Images/90128eaacf371353b8cdaf649355cb75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9zCtjl2_5CcrX-mznfOiLg.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx">A Happo screenshot diff showing a change in price per night styling</figcaption></figure><p id="3f7e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这里Happo显示了每晚价格显示方式的变化。diff允许工程师检查他们的PR是否有预期的变更，并且代码评审员对PR做了什么有了更好的理解。在合并之前，任何意外的更改都很容易被发现并修复。</p><p id="fa57" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这种方法称为认可测试，有许多好处:</p><ul class=""><li id="1a46" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb jv jw jx jy bi translated">更新测试需要最少的努力。工程师只需要查看差异，并接受预期的变化。新报告将作为标准自动更新。</li><li id="753f" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">完整覆盖了UI呈现流程。不需要编写UI的手动测试。</li><li id="e3be" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">UI边缘案例的简单测试。这个系统可以根据我们的需要扩展以支持尽可能多的模拟变体。</li></ul><h1 id="125e" class="kf kg hh bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">CI设置</h1><p id="5779" class="pw-post-body-paragraph ie if hh ig b ih ld ij ik il le in io ip lf ir is it lg iv iw ix lh iz ja jb ha bi translated">对于最终开发人员来说，将所有这些部分连接成一个内聚的测试体验需要做一些不平凡的工作。本系列文章的第5–7部分对此进行了详细描述。</p><p id="f2f8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">简而言之，我们构建的测试框架自动查找应用程序中的每个mock，将其加载到屏幕上，然后允许我们在其上运行我们的测试。这是以一种通用的方式完成的，它允许我们应用任何我们想要的测试验证——在这个例子中，是截图测试。</p><p id="304e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最终结果是每个PR运行一个阻塞作业来生成截图并进行比较。如果发现任何差异，将在PR上发布带有差异的评论和指向Happo报告的链接。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ln"><img src="../Images/ec3788199369c0221d4a14d27efbde26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*upSVvGndQ_qEFRBJbF1caA.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx">A Github PR comment indicating visual changed detected by Happo</figcaption></figure><p id="9f31" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这让作者和代码审查者都清楚PR导致了UI更改，并准确地显示了更改是什么。这对于捕捉回归和防止意外的代码变更有很大的帮助。</p><p id="9cb0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此外，开发人员不需要做任何额外的工作来为他们的片段设置截图测试。他们简单地将模拟定义添加到他们的片段类中(正如在<a class="ae jp" rel="noopener" href="/p/3f5b90b9c40a">第1部分</a>中所解释的)，测试框架自动地挑选它们并生成截图。</p><h1 id="1b5e" class="kf kg hh bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">附加测试</h1><p id="5da7" class="pw-post-body-paragraph ie if hh ig b ih ld ij ik il le in io ip lf ir is it lg iv iw ix lh iz ja jb ha bi translated">一旦我们建立了这个模拟测试系统，就很容易添加额外的检查:</p><ul class=""><li id="1aa3" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb jv jw jx jy bi translated">我们设置LeakCanary仪器测试在每个模拟截屏时运行。这使得在测试结束后，如果片段、视图或者活动被泄露，自动检测和失败测试变得容易。</li><li id="c1ca" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">一旦我们的Happo库展示了整个活动，我们就对其运行Espresso AccessibilityChecks断言，以捕捉屏幕上常见的可访问性违规。</li><li id="6447" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">片段参数和状态通过一个进程运行，该进程模拟具有状态保存和重建的进程重建。这将检查它们是否可以打包和恢复而不会崩溃。我们还截屏了重建的结果，这样我们可以看到片段如何处理恢复保存的状态。</li></ul><p id="3952" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">测试框架的奇妙之处在于，它为自动显示应用程序中的每个屏幕并在每个屏幕上运行动态生成的测试代码奠定了基础。这些额外的测试只需要几行代码就可以完成，并立即应用于应用程序的所有片段，不需要开发人员做额外的工作。随着我们纯粹从基础设施方面增加可测试性，产品工程师最初创建片段模拟的努力继续得到回报。</p><h1 id="1e65" class="kf kg hh bd kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc bi translated">下一步:测试事件处理</h1><p id="fcdf" class="pw-post-body-paragraph ie if hh ig b ih ld ij ik il le in io ip lf ir is it lg iv iw ix lh iz ja jb ha bi translated">在本文中，我们研究了如何测试屏幕的静态UI内容。然而，一个特性的大部分代码都是处理事件的，比如在屏幕间导航，更新状态，或者执行一个请求。</p><p id="b164" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae jp" rel="noopener" href="/airbnb-engineering/better-android-testing-at-airbnb-1d1e91e489b4">在第3部分</a>中，我们将采用UI截图比较的想法，看看我们如何将它应用到交互测试中，以自动测试事件处理代码。</p><h2 id="cfef" class="lo kg hh bd kh lp lq lr kl ls lt lu kp ip lv lw kt it lx ly kx ix lz ma lb mb bi translated">系列索引</h2><p id="18cd" class="pw-post-body-paragraph ie if hh ig b ih ld ij ik il le in io ip lf ir is it lg iv iw ix lh iz ja jb ha bi translated">这是关于Airbnb测试的七篇系列文章。</p><p id="c733" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第1部分— <a class="ae jp" rel="noopener" href="/airbnb-engineering/better-android-testing-at-airbnb-3f5b90b9c40a">测试原理和模拟系统</a></p><p id="221c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">第二部分(本文)</strong>——<a class="ae jp" rel="noopener" href="/airbnb-engineering/better-android-testing-at-airbnb-a77ac9531cab">用MvRx和Happo进行截图测试</a></p><p id="3c1e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第3部分— <a class="ae jp" rel="noopener" href="/airbnb-engineering/better-android-testing-at-airbnb-1d1e91e489b4">自动化交互测试</a></p><p id="992a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第4部分— <a class="ae jp" rel="noopener" href="/airbnb-engineering/better-android-testing-at-airbnb-part-4-testing-viewmodels-550d929126c8">单元测试框架视图模型</a></p><p id="6103" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第5部分— <a class="ae jp" rel="noopener" href="/airbnb-engineering/better-android-testing-at-airbnb-661a554a8c8b">我们的自动化测试框架的架构</a></p><p id="c39d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第6部分— <a class="ae jp" rel="noopener" href="/airbnb-engineering/better-android-testing-at-airbnb-a11f6832773f">持续嘲讽的障碍</a></p><p id="461f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">第7部分— <a class="ae jp" rel="noopener" href="/airbnb-engineering/better-android-testing-at-airbnb-eacec3a8a72f">测试生成和CI配置</a></p><h2 id="4dbd" class="lo kg hh bd kh lp lq lr kl ls lt lu kp ip lv lw kt it lx ly kx ix lz ma lb mb bi translated">我们在招人！</h2><p id="e896" class="pw-post-body-paragraph ie if hh ig b ih ld ij ik il le in io ip lf ir is it lg iv iw ix lh iz ja jb ha bi translated">想和我们一起在这些和其他大规模的Android项目上合作吗？Airbnb正在全公司招聘几个Android工程师职位！有关当前空缺，请参见<a class="ae jp" href="https://careers.airbnb.com/" rel="noopener ugc nofollow" target="_blank">https://careers.airbnb.com</a>。</p></div></div>    
</body>
</html>