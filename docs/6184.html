<html>
<head>
<title>Building a real-time user action counting system for ads</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为广告构建实时用户行为统计系统</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/building-a-real-time-user-action-counting-system-for-ads-88a60d9c9a?source=collection_archive---------1-----------------------#2018-07-13">https://medium.com/pinterest-engineering/building-a-real-time-user-action-counting-system-for-ads-88a60d9c9a?source=collection_archive---------1-----------------------#2018-07-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="2970" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Del Bao，软件工程师，Ads基础架构<br/>韩和，软件工程师，服务系统</p><p id="b7be" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest广告团队的使命是为Pinners和广告商提供最佳体验。我们的广告系统是一个实时竞价系统，根据各种属性提供有针对性的广告。一个主要的行为属性是用户行为计数，即Pinner过去的点击、印象和其他广告行为的计数。用户行为计数的一个重要部分是频率控制，它设置了广告向Pinner显示的最大次数(一段时间内的印象计数强制执行该限制)。</p><p id="8825" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因为我们的系统是实时的，我们必须根据请求立即提供用户动作计数。这就是我们建立Aperture的原因，Aperture是一种内部数据存储和在线事件跟踪服务，可以满足ads用户行为计数的要求。在本帖中，我们将解释Aperture和我们的中央服务的基本原理。</p><h1 id="b9b7" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">用户动作计数问题</h1><h2 id="bdba" class="ka jd hh bd je kb kc kd ji ke kf kg jm ip kh ki jq it kj kk ju ix kl km jy kn bi translated">用例</h2><p id="0a47" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated"><strong class="ig hi">频率控制<br/> </strong>频率控制管理广告向Pinners的投放。通过控制频率，广告商既可以防止相同广告的过度曝光，也可以提升品牌知名度(即品牌在客户或观众中的认知度的提高)。这个用例需要实时地在不同的时间范围内对促销广告进行多次用户印象计数。</p><p id="6593" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">广告的频率被定义为在给定的时间段内广告被浏览的次数。行动是印象，时间窗口可以是一天、七天、三十天。</p><p id="0f5a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">疲劳模型<br/> </strong>疲劳发生在一个人厌倦了看同一个广告的时候。这通常会对CTR(点击率)产生负面影响。我们的ads系统有一个pCTR(预测CTR)疲劳模型的培训管道。在请求时，为用户疲劳模型提取几个用户计数特征。一个品酒师的疲劳程度是在不同的活动水平上衡量的。我们的活动结构有四个层次:</p><ol class=""><li id="b819" class="kt ku hh ig b ih ii il im ip kv it kw ix kx jb ky kz la lb bi translated">广告商:账户</li><li id="32d5" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb ky kz la lb bi translated">活动:广告组的房子</li><li id="46ea" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb ky kz la lb bi translated">广告组:提升的pin的容器</li><li id="67e5" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb ky kz la lb bi translated">促销大头针:广告</li></ol><p id="a56b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所需的动作是展示和点击。首先，我们的广告服务系统获取一个Pinner在一个时间范围内的过去参与计数，用于四个活动级别的广告候选人列表。然后，计数特征被馈送到疲劳模型用于CTR预测。</p><h1 id="29b1" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">查询模式</h1><p id="06d8" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">我们将这些用例中的查询模式概括为在几个维度上查询计数。每个维度都有有限和离散的值。每个计数都基于维度值的每个可能组合。一个查询示例是:</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="5982" class="ka jd hh lm b fi lq lr l ls lt">What is the Pinner’s impression count of promoted Pins 1,2,3 for the last week?</span></pre><p id="2864" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本例中，活动(印象)、时间范围(过去七天)、促销商品(1，2，3)是查询中的维度。如果计数查询请求必须为维度提供一个或多个值，则维度是必需的。</p><p id="3866" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们当前跟踪用户操作计数的维度包括:</p><ul class=""><li id="e586" class="kt ku hh ig b ih ii il im ip kv it kw ix kx jb lu kz la lb bi translated"><strong class="ig hi">动作</strong>:点击和印象是使用最广泛的两种动作。该系统还可以扩展到任何动作，如保存一个Pin。</li><li id="35b1" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb lu kz la lb bi translated"><strong class="ig hi">视图类型</strong>:视图类型是Pinner登陆页面类型的术语。其中大部分是首页饲料，搜索和相关的引脚。当页面加载时，为Pinner发出一个ads请求。我们的大多数用例要么关注所请求的视图类型的动作计数，要么关注所有视图类型的动作计数。在后一种情况下，不指定视图类型。</li><li id="598a" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb lu kz la lb bi translated"><strong class="ig hi">时间范围</strong>:支持任意天数、小时数或分钟数。</li><li id="5815" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb lu kz la lb bi translated"><strong class="ig hi">实体维度</strong>:提升引脚上的用户动作事件发生在所有四个级别。例如，当Pinner点击广告时，促销Pin、其广告组、活动和广告商的计数都分别递增。每个实体级别都是一个单独的维度。</li></ul><h1 id="a909" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">用户操作计数请求流</h1><figure class="lh li lj lk fd lw er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es lv"><img src="../Images/504963a5023698780aab8302283e530d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8SqZ7P4Rb-3WjoJgqxJv3Q.png"/></div></div></figure><p id="64c4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当Pinner在Pinterest上加载视图类型的页面时，带有用户信息的广告请求从web服务器发送到广告系统，以便填充广告位(即显示广告的机会)。该系统将从我们的库存中检索候选广告，并随后确定将候选广告中的哪些放在指定位置。这种行为被称为广告插入。</p><p id="1429" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">当Pinner与提升的pin交互时，通过从前端调用跟踪端点来跟踪这些动作。然后，服务器将该事件记录到Kafka。Kafka消费者将消费消息并将动作事件写入数据存储(Aperture)。候选人检索后，Ads后端服务器从Aperture请求用户操作计数。</p><h1 id="2655" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">两种方法</h1><p id="837b" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">通过计算每个用户的事件数量来计算用户操作计数。我们考虑两种方法来弥补计数和原始事件之间的差距。</p><p id="a13d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">方法1 </strong>:客户端事件计数</p><ul class=""><li id="748f" class="kt ku hh ig b ih ii il im ip kv it kw ix kx jb lu kz la lb bi translated">Ads服务器访问数据存储以获取原始事件。</li><li id="03bf" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb lu kz la lb bi translated">业务组件运行特定的逻辑来计算计数。</li></ul><p id="0861" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">方法2 </strong>:独立计数服务</p><ul class=""><li id="8d02" class="kt ku hh ig b ih ii il im ip kv it kw ix kx jb lu kz la lb bi translated">事件数据存储有一个计数层来提供计数。</li><li id="24d4" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb lu kz la lb bi translated">该服务公开了一组通用计数API。</li></ul><p id="2926" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下表详细比较了两种方法的优缺点。</p><figure class="lh li lj lk fd lw er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es md"><img src="../Images/024d0dea3daf6e209f25543baa09fe4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Q7-b-unx0Itey3RIw-e_A.png"/></div></div></figure><p id="a500" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于计数服务解决方案在大多数标准上超越了客户端计数，我们采用了独立的计数服务方法。</p><h1 id="a67e" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">其他挑战</h1><p id="7f24" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">计数基于已消除重复的事件数据，原因有两个:</p><ul class=""><li id="83f7" class="kt ku hh ig b ih ii il im ip kv it kw ix kx jb lu kz la lb bi translated">ads日志记录系统不能保证事件消息只发送一次。</li><li id="dfb4" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb lu kz la lb bi translated">业务逻辑要求Pinner在一个时间范围内对提升的Pin的相同操作只计算一次。例如，对于相同的插入，Pinner的印象在一天内只计算一次。</li></ul><p id="0025" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这要求计数服务跟踪原始事件，以便对它们进行重复数据删除。这也要求计数计算发生在服务时间，而不是事件摄取时间。</p><p id="8f3d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">而且，对于不同的维度和时间范围，有各种各样的计数情况。对于所有情况，在摄取时预先计算计数是不可扩展的。该服务需要有一个灵活的查询接口，用于各种计数情况。</p><p id="7b5d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">计数服务的SLA应小于8ms的P99延迟，用于扫描和过滤高峰时间200k qps的用户原始事件。</p><h1 id="76b0" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">Aperture作为计数服务</h1><p id="deb4" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">我们利用Aperture，这是我们内部开发的一项服务。与其他数据存储服务相比，Aperture专为时序数据存储和在线事件跟踪和服务而设计。它支持低延迟事件追加、重复数据删除、过滤和聚合。在幕后，该服务使用RocksDB作为存储引擎，并由<a class="ae me" rel="noopener" href="/@Pinterest_Engineering/automated-cluster-management-and-recovery-for-rocksplicator-f1f8fd35c833"> Helix </a>启用的<a class="ae me" rel="noopener" href="/@Pinterest_Engineering/open-sourcing-rocksplicator-a-real-time-rocksdb-data-replicator-558cd3847a9d"> Rocksplicator </a>提供支持，用于集群管理、恢复和复制。我们的目标是在今年晚些时候开源Aperture，届时将会展示它与其他系统的比较(我们这篇文章的目标是解释它解决广告计数问题的技术)。</p><h2 id="26ad" class="ka jd hh bd je kb kc kd ji ke kf kg jm ip kh ki jq it kj kk ju ix kl km jy kn bi translated">存储模式</h2><p id="f324" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">Aperture在用户级别为时序事件数据实现数据存储模式和服务功能。它将单个事件抽象为具有预定义长度的字节数组。事件可以是ID或字段列表。从逻辑上讲，记录是用户和用户过去所有事件的键值对。由于RocksDB在记录级别进行检索和存储，将用户的所有事件存储为单个记录会导致时间范围查询的高成本。理想情况下，只有查询时间范围内的事件应该从磁盘中获取。</p><p id="afdd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了优化查询性能，Aperture将用户事件分成单独的记录。</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="9f63" class="ka jd hh lm b fi lq lr l ls lt">{</span><span id="4237" class="ka jd hh lm b fi mf lr l ls lt">      Key -&gt; [event_id, …, event_id],</span><span id="58ac" class="ka jd hh lm b fi mf lr l ls lt">      ...</span><span id="b4cb" class="ka jd hh lm b fi mf lr l ls lt">      Key -&gt; [event_id, …, event_id]</span><span id="27d7" class="ka jd hh lm b fi mf lr l ls lt">}</span><span id="59f9" class="ka jd hh lm b fi mf lr l ls lt">Key = [User Id] + [Time Bucket Type] + [Time Bucket Id]</span><span id="a0d6" class="ka jd hh lm b fi mf lr l ls lt">Time Bucket Types: D(Day), H(Hour), M(Minute)</span></pre><p id="346e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">具体来说，属于同一时间范围(由时段ID表示)的所有事件都将进入一个记录。因此，RocksDB键是<code class="du mg mh mi lm b">[User Id] + [Time Bucket Type] + [Time Bucket Id]</code>。当Aperture接收到事件时，它会计算所需类型(日、小时和/或分钟)下的时段id，然后写回这三个记录，并使用自定的RocksDB的合并运算符将其附加到DB。</p><h1 id="591d" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">查询语言</h1><p id="be1d" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">Aperture的聚合API具有类似SQL的语义。这里有一个比较表</p><figure class="lh li lj lk fd lw er es paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="er es mj"><img src="../Images/04d5b75596fcf5db2a84be4c282e0c89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KgHFHtJPp3T8jjGzmD_5Gw.png"/></div></div></figure><p id="2ed4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="mk">注意:由于时间范围不是事件中的维度，查询语言不支持多个时间范围。单个聚合请求只能支持一个时间范围。</em></p><h1 id="660d" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">事件模式</h1><p id="18c6" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">Aperture将事件表示为字节数组，不考虑事件的维度。定义事件模式是客户端的责任。对于ads用例，事件是一个接一个排列的维度列表。Aperture的聚合API允许查询中的位掩码将相应的字节表示为运算符应用的维度。</p><p id="d9d0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">每次将促销Pin插入插接板时，ads系统都会生成一个唯一的插入ID来识别它。因此，事件由插入ID、动作和视图类型来标识。插入ID是附加维度。Aperture根据完整的事件字节对事件进行重复数据删除。</p><h2 id="0719" class="ka jd hh bd je kb kc kd ji ke kf kg jm ip kh ki jq it kj kk ju ix kl km jy kn bi translated">客户请求</h2><p id="ec97" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">在客户端，我们确保所有用例的计数都在一个地方获取。这样，我们可以管理对Aperture的请求数量。</p><p id="9a40" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们在候选检索之后向Aperture发出请求，因为:</p><ul class=""><li id="5ac1" class="kt ku hh ig b ih ii il im ip kv it kw ix kx jb lu kz la lb bi translated">在候选检索阶段之后，对消费者进行计数。</li><li id="2b3a" class="kt ku hh ig b ih lc il ld ip le it lf ix lg jb lu kz la lb bi translated">检索之后，我们得到一个提升的Pin候选列表。我们只请求这些候选引脚的计数，而不是Pinner参与的所有引脚的计数。这减少了内存占用和下游服务器的带宽。</li></ul><p id="b036" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们为时间范围、实体类型、实体ID和计数填充一个嵌套映射，并将其传递给下游。</p><h1 id="6c77" class="jc jd hh bd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz bi translated">结论</h1><p id="2ff0" class="pw-post-body-paragraph ie if hh ig b ih ko ij ik il kp in io ip kq ir is it kr iv iw ix ks iz ja jb ha bi translated">为了投放符合Pinner兴趣的相关、有用的广告，准确统计用户在推广的pin上采取的行动非常重要。我们的ads系统利用Aperture的时序存储能力和聚合API进行用户动作计数。我们期待着加入更多的用例，并在未来与开源社区分享这项技术。</p><p id="2a44" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="mk">鸣谢:非常感谢裴礼泉、扎克·德拉克、、张、邹、、何金如、和为设计和实施提供建议。</em></p></div></div>    
</body>
</html>