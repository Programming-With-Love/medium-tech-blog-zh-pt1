<html>
<head>
<title>Watch your Manifest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">注意你的清单</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/watch-your-manifest-4be40f1dfc8e?source=collection_archive---------2-----------------------#2022-10-28">https://medium.com/pinterest-engineering/watch-your-manifest-4be40f1dfc8e?source=collection_archive---------2-----------------------#2022-10-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="bcb0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">王麟|安卓性能工程师</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/95c25a1df679bab7f1e44aa870b577e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Fz6ib34tFBYYqgA_TcPjQ.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx">Designed by AJ Oxendine | Software Engineer</figcaption></figure><p id="02d6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于Android开发人员来说，众所周知，一个应用程序的<a class="ae js" href="https://developer.android.com/guide/topics/manifest/manifest-intro" rel="noopener ugc nofollow" target="_blank">清单(AndroidManifest.xml) </a>包含了至关重要的应用程序声明。它在建立后很少被监控，因为我们认为它几乎不会改变。然而，在Pinterest，我们在意识到清单确实经常变化后，一直在积极监控清单。</p><p id="2f32" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在构建一个应用程序时，<a class="ae js" href="https://gradle.org/" rel="noopener ugc nofollow" target="_blank"> Gradle </a>下载所有的依赖库来编译并与应用程序链接。这些依赖库都有自己的迷你清单。在构建过程中，<a class="ae js" href="https://developer.android.com/studio/releases/gradle-plugin#updating-plugin" rel="noopener ugc nofollow" target="_blank"> Android Gradle插件</a> (AGP)将它们与应用程序的主清单合并，形成最终清单。由于这种合并过程，最终的清单通常看起来与原始清单非常不同，并且包含额外的声明。在大多数情况下，这些额外的声明对于依赖库的运行是必要的。然而，有时他们会有意想不到的行为。</p><p id="4705" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">它首次引起我们的注意是在一次冷启动回归调查中。我们发现一个第三方软件开发工具包(SDK)在其清单中声明了一个特殊的<a class="ae js" href="https://developer.android.com/reference/android/content/ContentProvider" rel="noopener ugc nofollow" target="_blank"> ContentProvider </a>来尽早预热自己。这是因为内容提供者在应用程序启动时很早就被初始化了，甚至在应用程序的onCreate()方法被调用之前。然而，我们希望控制每个第三方库的初始化，只在必要时才初始化它们。因此，我们添加了以下声明:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jt"><img src="../Images/9577a640d4d57f8b46e3b2e5043579bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H8CgL-w1R5ky63q5BtchuA.png"/></div></div></figure><p id="37ee" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将此声明添加到清单将导致SdkEarlyInitializer从最终合并的清单中移除。这一变化使冷启动时间缩短了130毫秒。</p><p id="c0c5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">从那时起，我们创建了以下流程，以便在提交之前定期监控合并清单的更改，首先是获取当前合并清单的快照，并将其保存在代码库中:</p><ol class=""><li id="e7c6" class="ju jv hh ig b ih ii il im ip jw it jx ix jy jb jz ka kb kc bi translated">作为PR构建的一部分，我们将合并的清单与快照进行比较。</li><li id="67aa" class="ju jv hh ig b ih kd il ke ip kf it kg ix kh jb jz ka kb kc bi translated">如果检测到差异，我们将使构建失败。</li><li id="7634" class="ju jv hh ig b ih kd il ke ip kf it kg ix kh jb jz ka kb kc bi translated">如果有必要进行更改，PR开发人员必须调整快照清单，或者添加适当的“remove”标记，以将新组件排除在最终清单之外。</li></ol><p id="300d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一小组审查人员将审查每一个明显的变化。</p><h1 id="c603" class="ki kj hh bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">有用的案例</h1><ul class=""><li id="ac0b" class="ju jv hh ig b ih lg il lh ip li it lj ix lk jb ll ka kb kc bi translated">发现了由工作管理器库添加的<a class="ae js" href="https://cs.android.com/androidx/platform/frameworks/support/+/androidx-main:work/work-runtime/src/main/java/androidx/work/WorkManagerInitializer.java?q=WorkManagerInitializer" rel="noopener ugc nofollow" target="_blank">workmanagerinializer</a>(content provider)。我们首先删除了它，并通知了Google，Google最终添加了对使用<a class="ae js" href="https://developer.android.com/topic/libraries/architecture/workmanager/advanced/custom-configuration" rel="noopener ugc nofollow" target="_blank">自定义配置</a>初始化工作管理器的支持。</li><li id="3a9e" class="ju jv hh ig b ih kd il ke ip kf it kg ix kh jb ll ka kb kc bi translated">发现一个新的意图是通过升级exoplayer库到2.15.0。然后，我们参与了与谷歌正在进行的<a class="ae js" href="https://android-review.googlesource.com/c/platform/frameworks/support/+/1411627" rel="noopener ugc nofollow" target="_blank">问题讨论</a>，最终删除了这个不必要的意图。</li><li id="9b42" class="ju jv hh ig b ih kd il ke ip kf it kg ix kh jb ll ka kb kc bi translated">检测到库添加了<a class="ae js" href="https://developers.google.com/android/reference/com/google/android/gms/ads/identifier/AdvertisingIdClient.Info" rel="noopener ugc nofollow" target="_blank"> AD_ID </a>权限。</li></ul><h1 id="3cf1" class="ki kj hh bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">经验教训</h1><ul class=""><li id="c150" class="ju jv hh ig b ih lg il lh ip li it lj ix lk jb ll ka kb kc bi translated">常规的cshell diff足以比较清单</li><li id="f410" class="ju jv hh ig b ih kd il ke ip kf it kg ix kh jb ll ka kb kc bi translated"><a class="ae js" href="https://developer.android.com/studio/releases/gradle-plugin#updating-plugin" rel="noopener ugc nofollow" target="_blank"> AGP </a>有时会在不改变内容的情况下对清单中的项目进行重新排序，在这种情况下，需要调整快照</li><li id="9d03" class="ju jv hh ig b ih kd il ke ip kf it kg ix kh jb ll ka kb kc bi translated">忽略空白和换行符是必要的</li><li id="3d07" class="ju jv hh ig b ih kd il ke ip kf it kg ix kh jb ll ka kb kc bi translated">需要显式忽略清单中频繁更改的项目(例如UUIDs、版本代码)</li></ul><h1 id="4929" class="ki kj hh bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">结论</h1><p id="cbfa" class="pw-post-body-paragraph ie if hh ig b ih lg ij ik il lh in io ip lm ir is it ln iv iw ix lo iz ja jb ha bi translated">通过这种方法，当任何新组件添加到我们的应用程序中时，我们都会收到警报，并且每当我们添加新的依赖项时，我们都会感到更加自信。</p><h1 id="2775" class="ki kj hh bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">承认</h1><p id="6acb" class="pw-post-body-paragraph ie if hh ig b ih lg ij ik il lh in io ip lm ir is it ln iv iw ix lo iz ja jb ha bi translated">安卓性能团队:阿伦K、埃内斯托杜哈特、王麟、刘胜、汤姆哈曼</p><p id="f23b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">特别感谢:沙沙初(She她)</p><p id="fe3f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lp">要在Pinterest了解更多工程知识，请查看我们的</em> <a class="ae js" href="https://medium.com/pinterest-engineering" rel="noopener"> <em class="lp">工程博客</em> </a> <em class="lp">，并访问我们的</em><a class="ae js" href="https://www.pinterestlabs.com?utm_source=medium&amp;utm_medium=blog-article-link&amp;utm_campaign=wang-oct-18-2022" rel="noopener ugc nofollow" target="_blank"><em class="lp">Pinterest Labs</em></a><em class="lp">网站。要探索Pinterest的生活，请访问我们的</em> <a class="ae js" href="https://www.pinterestcareers.com?utm_source=medium&amp;utm_medium=blog-article-link&amp;utm_campaign=wang-oct-18-2022" rel="noopener ugc nofollow" target="_blank"> <em class="lp">职业</em> </a> <em class="lp">页面。</em></p></div></div>    
</body>
</html>