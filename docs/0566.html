<html>
<head>
<title>Biometric Authentication on Android — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android上的生物认证—第2部分</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/biometric-authentication-on-android-part-2-bc4d0dae9863?source=collection_archive---------0-----------------------#2020-10-06">https://medium.com/androiddevelopers/biometric-authentication-on-android-part-2-bc4d0dae9863?source=collection_archive---------0-----------------------#2020-10-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/b911131c1d399d94515164dfbc9c1c57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e3jNfHQGTe7f7ptGpa74yA.png"/></div></div></figure><div class=""/><div class=""><h2 id="ac14" class="pw-subtitle-paragraph ip hr hs bd b iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg dx translated">关键用户旅程和用户界面</h2></div><p id="baaf" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">这是Android 系列上<em class="kd">生物认证的第2部分。更多信息，参见<a class="ae ke" rel="noopener" href="/androiddevelopers/biometric-authentication-on-android-part-1-264523bce85d">第1部分</a>。</em></p><p id="b5dd" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">要增强您的登录过程以包括生物识别身份验证，请在用户成功登录后立即提示他们启用生物识别身份验证。图1A显示了一个典型的登录流程，您可能已经很熟悉了。用户按下登录按钮后，服务器返回一个<code class="du kf kg kh ki b">userToken</code>，然后提示他们启用生物识别，如图1B所示。一旦用户启用了生物特征认证，从那时起，每次用户需要登录时，应用程序都会自动显示生物特征提示，如图2所示。</p><figure class="kk kl km kn fd hj er es paragraph-image"><div class="er es kj"><img src="../Images/4d265fc9da4e712f7bcb5b7a84e2dd28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/format:webp/1*9r7k3kmVkzbRPUo9J9KeBg.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx"><strong class="bd ks">Figure 1A: Typical sign-in UI</strong></figcaption></figure><figure class="kk kl km kn fd hj er es paragraph-image"><div class="er es kt"><img src="../Images/742f7f047c974705364f34cd24339cee.png" data-original-src="https://miro.medium.com/v2/resize:fit:914/format:webp/1*lmbX2q4Wy88mNQlMRx-w0Q.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx"><strong class="bd ks">Figure 1B: Enable biometric authentication</strong></figcaption></figure><figure class="kk kl km kn fd hj er es paragraph-image"><div class="er es ku"><img src="../Images/19a36f1165816d0e95af914e1333f67e.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*1TaMm9KQgxbEeA52B5NRCA.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx"><strong class="bd ks">Figure 2: Confirm biometric authentication</strong></figcaption></figure><p id="15bf" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated"><strong class="jj ht">图2:确认生物认证</strong></p><p id="4fa2" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">虽然图2显示了UI中的确认按钮，但该按钮实际上是可选的。例如，如果您正在构建一个餐馆应用程序，建议您显示这个确认按钮，因为生物认证允许顾客支付他们的餐费。对于敏感交易和支付，我们建议您要求确认。要在你的应用程序UI中包含一个确认按钮，在构建你的<code class="du kf kg kh ki b"><a class="ae ke" href="https://developer.android.com/reference/androidx/biometric/BiometricPrompt.PromptInfo" rel="noopener ugc nofollow" target="_blank">BiometricPrompt.PromptInfo</a></code>时调用<code class="du kf kg kh ki b"><a class="ae ke" href="https://developer.android.com/reference/androidx/biometric/BiometricPrompt.PromptInfo.Builder#setConfirmationRequired(boolean)" rel="noopener ugc nofollow" target="_blank">setConfirmationRequired(true)</a></code>。请注意，如果您不调用<code class="du kf kg kh ki b">setConfirmationRequired()</code>，系统将默认将其设置为true。</p><h1 id="98c1" class="kv kw hs bd ks kx ky kz la lb lc ld le iy lf iz lg jb lh jc li je lj jf lk ll bi translated">生物识别设计流程</h1><p id="af18" class="pw-post-body-paragraph jh ji hs jj b jk lm it jm jn ln iw jp jq lo js jt ju lp jw jx jy lq ka kb kc ha bi translated">举例来说，代码片段使用加密版本的<code class="du kf kg kh ki b">BiometricPrompt</code>，带有<code class="du kf kg kh ki b">CryptoObject</code>。</p><p id="964b" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">如果你的应用需要认证，你应该创建一个专用的<code class="du kf kg kh ki b">LoginActivity</code>组件作为你的应用的登陆页面。只要需要身份验证，无论您要求用户进行身份验证的频率有多高，这一点都很重要。如果用户已经被认证，那么<code class="du kf kg kh ki b">LoginActivity</code>将调用<code class="du kf kg kh ki b">finish()</code>，用户可以继续前进。如果用户尚未通过身份验证，那么您应该检查生物识别功能是否已启用。</p><p id="50f2" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">有几种方法可以检查生物识别功能是否已启用。然而，与其在各种备选方案中费力地寻找，不如让我们特别深入一个:对定制属性<code class="du kf kg kh ki b">ciphertextWrapper</code>的空检查。<code class="du kf kg kh ki b">CiphertextWrapper</code>是您创建的一个数据类，以便当用户成功地为您的应用启用生物认证时，您可以方便地将加密的<code class="du kf kg kh ki b">userToken</code>，也称为<code class="du kf kg kh ki b">ciphertext</code>，存储在永久存储中，如<code class="du kf kg kh ki b">SharedPreferences</code>或<code class="du kf kg kh ki b">Room</code>。因此，如果<code class="du kf kg kh ki b">ciphertextWrapper</code>不为空，那么就有了访问远程服务器所需的<code class="du kf kg kh ki b">userToken</code>的加密版本——也就是说启用了生物识别。</p><figure class="kk kl km kn fd hj"><div class="bz dy l di"><div class="lr ls l"/></div></figure><p id="b68d" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">如果没有启用生物识别，那么用户可以点击启用它(图1B)，这时您将向用户显示实际的生物识别提示，如图3所示。</p><p id="c168" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">在下面的代码片段中，<code class="du kf kg kh ki b">showBiometricPromptForEncryption()</code>展示了如何设置与生物识别提示相关联的密钥。本质上，您从一个<code class="du kf kg kh ki b">String</code>初始化一个<code class="du kf kg kh ki b">Cipher</code>，然后将<code class="du kf kg kh ki b">Cipher</code>传递给<code class="du kf kg kh ki b">CryptoObject</code>。最后你把<code class="du kf kg kh ki b">CryptoObject</code>传给<code class="du kf kg kh ki b">biometricPrompt.authenticate(promptInfo, cryptoObject)</code>。</p><figure class="kk kl km kn fd hj"><div class="bz dy l di"><div class="lr ls l"/></div></figure><figure class="kk kl km kn fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es lt"><img src="../Images/806c556e437e2560dce304a5e09e4db4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_y7f7msSDIhpOUAk-3dK0w.png"/></div></div><figcaption class="ko kp et er es kq kr bd b be z dx"><strong class="bd ks">Figure 3: Prompt to enable biometrics</strong></figcaption></figure><p id="198a" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">此时，即图2和图3，app只有<code class="du kf kg kh ki b">userToken</code>。但是，除非用户每次打开应用程序时都使用他们的密码，否则这个<code class="du kf kg kh ki b">userToken</code>需要存储在应用程序的文件系统中，以供以后的会话使用。然而，如果您存储<code class="du kf kg kh ki b">userToken</code>而没有首先对其进行加密，那么未经授权访问设备的攻击者可能会读取<code class="du kf kg kh ki b">userToken</code>，并使用它从远程服务器获取数据。因此，最好在本地保存之前加密<code class="du kf kg kh ki b">userToken</code>。这就是图3中的生物特征提示发挥作用的地方。当用户使用他们的生物特征进行身份验证时，你的目标是使用<code class="du kf kg kh ki b">BiometricPrompt</code>解锁一个密钥(或者是<em class="kd">每次使用授权</em>或者是<em class="kd">有时间限制</em>)，然后使用该密钥加密服务器生成的<code class="du kf kg kh ki b">userToken</code>，然后将其存储在本地。从现在开始，当用户需要登录时，可以使用自己的生物特征进行认证(即生物特征认证- &gt;解锁密钥- &gt;解密<code class="du kf kg kh ki b">userToken</code>进行服务器访问)。</p><p id="06e8" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">请注意用户第一次启用生物特征识别和用户随后使用生物特征识别登录之间的区别。为了启用生物认证，应用程序调用<code class="du kf kg kh ki b">showBiometricPromptForEncryption()</code>，它初始化一个用于加密<code class="du kf kg kh ki b">userToken</code>的<code class="du kf kg kh ki b">Cipher</code>。另一方面，为了使用生物特征进行实际登录，应用程序调用<code class="du kf kg kh ki b">showBiometricPromptForDecryption()</code>，它初始化一个<code class="du kf kg kh ki b">Cipher</code>进行解密，然后使用<code class="du kf kg kh ki b">Cipher</code>对<code class="du kf kg kh ki b">userToken</code>进行解密。</p><p id="4149" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">启用生物认证后，用户下次返回应用程序时应该会看到生物认证提示，如图4所示。请注意，因为图4用于登录应用程序，而图2用于交易确认，所以不需要确认，因为应用程序登录是一个被动的、容易撤销的操作。</p><figure class="kk kl km kn fd hj er es paragraph-image"><div class="er es lu"><img src="../Images/dd33acb07d05453ab24352dc33c8906b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1366/format:webp/1*MXl8HO0rvsbb2QA1FJQfYw.png"/></div><figcaption class="ko kp et er es kq kr bd b be z dx"><strong class="bd ks">Figure 4</strong></figcaption></figure><p id="cf8b" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">为了为您的用户实现这个流程，当您的<code class="du kf kg kh ki b">LoginActivity</code>验证用户已经通过身份验证时，您将使用通过成功的<code class="du kf kg kh ki b">BiometricPrompt</code>身份验证解锁的加密对象来解密<code class="du kf kg kh ki b">userToken</code>，然后在<code class="du kf kg kh ki b">LoginActivity</code>组件上调用<code class="du kf kg kh ki b">finish()</code>。</p><figure class="kk kl km kn fd hj"><div class="bz dy l di"><div class="lr ls l"/></div></figure><h1 id="506f" class="kv kw hs bd ks kx ky kz la lb lc ld le iy lf iz lg jb lh jc li je lj jf lk ll bi translated">完整的图片</h1><p id="e5de" class="pw-post-body-paragraph jh ji hs jj b jk lm it jm jn ln iw jp jq lo js jt ju lp jw jx jy lq ka kb kc ha bi translated">图5显示了推荐工程设计的完整流程图。我们充分意识到，您的代码在许多地方可能会偏离这一建议。例如，您自己的加密解决方案可能只要求为加密而不是为解密解锁密钥。我们仍然为那些可能需要的人提供完整的示例解决方案。</p><p id="0a29" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">图中提到<em class="kd">密钥</em>的地方，你可以自由使用<em class="kd">每次使用授权</em>密钥或<em class="kd">限时</em>密钥。此外，只要图中提到“应用程序的内存”，您就可以自由地使用您最喜欢的结构化数据存储解决方案:<code class="du kf kg kh ki b"><a class="ae ke" href="https://developer.android.com/reference/android/content/SharedPreferences" rel="noopener ugc nofollow" target="_blank">SharedPreferences</a></code>、<code class="du kf kg kh ki b"><a class="ae ke" href="https://developer.android.com/jetpack/androidx/releases/room" rel="noopener ugc nofollow" target="_blank">Room</a></code>或其他任何东西。最后，通常所说的<code class="du kf kg kh ki b">userToken</code>是任何类型的服务器负载，可以让用户访问受限数据或服务。服务器通常会检查这种有效载荷的存在，作为调用者被授权的证据。</p><p id="1eb3" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">在图中，从“<em class="kd"> encrypt userToken </em>”指向的箭头很可能指向“<em class="kd"> login completed </em>”而不是回到“<code class="du kf kg kh ki b">LoginActivity</code>”。尽管如此，我们还是选择了“<code class="du kf kg kh ki b">LoginActivity</code>”来提醒大家注意，在用户点击“启用生物识别”之后，可以使用额外的<code class="du kf kg kh ki b">Activity</code>，例如<code class="du kf kg kh ki b">EnableBiometricAuthActivity</code>。使用单独的活动可能会使您的代码更加模块化，因此可读性更好。或者，您可以创建一个带有两个<code class="du kf kg kh ki b">Fragment</code>的<code class="du kf kg kh ki b">LoginActivity</code>(由一个<a class="ae ke" href="https://developer.android.com/guide/navigation" rel="noopener ugc nofollow" target="_blank">导航组件</a>支持):一个<code class="du kf kg kh ki b">Fragment</code>用于实际的认证流程，另一个<code class="du kf kg kh ki b">Fragment</code>用于响应用户点击“启用生物识别”。</p><p id="4968" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">除了这个工程流程图，我们还发布了一个设计指南，您可以在实施您的应用时遵循。此外，我们在Github 上的<a class="ae ke" href="https://github.com/android/security-samples/tree/master/BiometricLoginKotlin" rel="noopener ugc nofollow" target="_blank">示例应该会为您提供进一步的见解。</a></p><figure class="kk kl km kn fd hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es lv"><img src="../Images/72cebfc57cb807c3f00d0a6a9b1fee87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yco2IB_h7rBc-yHJ"/></div></div><figcaption class="ko kp et er es kq kr bd b be z dx"><strong class="bd ks">Figure 5: Complete diagram of biometric login with remote server</strong></figcaption></figure><h1 id="00e9" class="kv kw hs bd ks kx ky kz la lb lc ld le iy lf iz lg jb lh jc li je lj jf lk ll bi translated">第二部分总结</h1><p id="6fb4" class="pw-post-body-paragraph jh ji hs jj b jk lm it jm jn ln iw jp jq lo js jt ju lp jw jx jy lq ka kb kc ha bi translated">在这篇文章中，你学到了以下内容:</p><ul class=""><li id="aad2" class="lw lx hs jj b jk jl jn jo jq ly ju lz jy ma kc mb mc md me bi translated">使用哪些UI资产来增强生物识别的登录过程。</li><li id="a142" class="lw lx hs jj b jk mf jn mg jq mh ju mi jy mj kc mb mc md me bi translated">你的应用应该为生物认证解决的关键用户旅程。</li><li id="278a" class="lw lx hs jj b jk mf jn mg jq mh ju mi jy mj kc mb mc md me bi translated">如何设计您的代码来处理生物认证的不同方面。</li><li id="25e6" class="lw lx hs jj b jk mf jn mg jq mh ju mi jy mj kc mb mc md me bi translated">您的登录系统应该如何流动的完整工程图。</li></ul><p id="da58" class="pw-post-body-paragraph jh ji hs jj b jk jl it jm jn jo iw jp jq jr js jt ju jv jw jx jy jz ka kb kc ha bi translated">编码快乐！</p></div></div>    
</body>
</html>