<html>
<head>
<title>Running fetch in a web worker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在web worker中运行fetch</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/running-fetch-in-a-web-worker-700dc33ac854?source=collection_archive---------0-----------------------#2018-02-27">https://medium.com/google-developer-experts/running-fetch-in-a-web-worker-700dc33ac854?source=collection_archive---------0-----------------------#2018-02-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/fb0b602dd23d2fa001b01304ff3cf526.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FvsTAUgvLadncEGum9ucKA.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">The greatest Web Worker of all time</figcaption></figure><p id="e11d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">性能是网络上最大的挑战之一&amp;尤其是在移动设备上。以60fps的速度运行web应用程序并不是一件容易的事情。</p><p id="9869" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">虽然有许多因素会影响你的web应用程序的性能，但在这篇文章中，我将介绍Web Worker，以及你如何在Web Worker中运行<a class="ae jr" href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch" rel="noopener ugc nofollow" target="_blank"> fetch </a>，以及你为什么要这样做。</p></div><div class="ab cl js jt go ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="ha hb hc hd he"><p id="788c" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">JavaScript代码阻塞了DOM，这会降低用户界面的速度。例如，您会惊讶于<a class="ae jr" href="https://codetogo.io/how-to-parse-JSON-string-in-javascript/" rel="noopener ugc nofollow" target="_blank"> JSON.parse </a>阻塞了DOM。</p><p id="9d7f" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">随着你的数据源越来越大，你的UI性能会越来越差。这是因为DOM操作与JavaScript代码一起在<strong class="iv hi">主线程</strong>上运行。</p><p id="8d7c" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">我们能把这些操作从主线程中移走吗？</p><h1 id="2a2c" class="jz ka hh bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">输入Web Workers</h1><p id="96b9" class="pw-post-body-paragraph it iu hh iv b iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm lb jo jp jq ha bi translated">有了web workers，我们可以将那些昂贵的操作转移到在不同线程上运行的后台进程中。</p><p id="4c22" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Web Worker 是Web内容在后台线程中运行脚本的简单方法。可以把它想象成一个<strong class="iv hi">后台</strong>进程，运行一些您编写的JavaScript代码。</p><p id="e2f2" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">尽管您很可能看不到在web worker中运行fetch的性能优势，但本文将作为Web worker和<a class="ae jr" href="https://github.com/GoogleChromeLabs/comlink" rel="noopener ugc nofollow" target="_blank"> Comlink </a>的介绍和解释。</p><h2 id="a862" class="lc ka hh bd kb ld le lf kf lg lh li kj je lj lk kn ji ll lm kr jm ln lo kv lp bi translated">我能从网络工作者那里访问DOM吗？</h2><p id="2e4f" class="pw-post-body-paragraph it iu hh iv b iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm lb jo jp jq ha bi translated">Web工作者不能访问DOM，因为DOM不是线程安全的。让web工作者可以访问DOM将会违背Web工作者的初衷，因为他们的实现将会慢得多。</p><h2 id="4301" class="lc ka hh bd kb ld le lf kf lg lh li kj je lj lk kn ji ll lm kr jm ln lo kv lp bi translated">我已经可以使用Web Workers了吗？</h2><figure class="lr ls lt lu fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lq"><img src="../Images/74e2836b29f193a609bb52d94083a247.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kq6dECLXQZ-al3YpGMor2w.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Browser support for Web Workers: a green paradise.</figcaption></figure><p id="4474" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">照片本身就说明了一切。😅</p><h1 id="652a" class="jz ka hh bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">Comlink</h1><p id="afee" class="pw-post-body-paragraph it iu hh iv b iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm lb jo jp jq ha bi translated"><a class="ae jr" href="https://github.com/GoogleChromeLabs/comlink" rel="noopener ugc nofollow" target="_blank">Google chrome labs/Comlink</a>让我们更容易在web worker中编写一个<strong class="iv hi"> ES2015类</strong>并将其公开给我们的主线程。</p><figure class="lr ls lt lu fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lv"><img src="../Images/3d6d0ea6bd2e3988bac2e5720dd07e6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*015kmnBJxJ7uEVOWvit9LQ.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Github repository for Comlink</figcaption></figure><p id="c95d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Web Worker和您的主线程之间唯一的通信方式是通过<a class="ae jr" href="https://developer.mozilla.org/en-US/docs/Web/API/Worker/postMessage" rel="noopener ugc nofollow" target="_blank"> postMessage </a>。虽然您不一定需要Comlink来使用web worker，但Comlink使在Web worker中编写一个类并公开它以便从主线程中使用变得容易得多。</p><figure class="lr ls lt lu fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lw"><img src="../Images/50bd0f8d246fd8e51bd9aecf6e48ce09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yeGu0HyWCu1lijWpdPvQPg.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Communication between Web Worker &amp; Your web page happens through postMessage</figcaption></figure><p id="ea56" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">Comlink使用postMessage在Web Worker和您的页面之间进行通信。</p><p id="551d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">我相信Comlink会促使开发者越来越依赖Web工作者。</p><h1 id="9369" class="jz ka hh bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">Fetch + Comlink</h1><p id="b1f4" class="pw-post-body-paragraph it iu hh iv b iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm lb jo jp jq ha bi translated">Comlink-fetch 允许您在通过Comlink公开的web worker中使用fetch。</p><p id="c070" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">我最近在<a class="ae jr" href="https://www.npmjs.com/package/comlink-fetch" rel="noopener ugc nofollow" target="_blank"> npm </a>上发布了版本<strong class="iv hi"> 0.1.2 </strong>。它是这样工作的:</p><p id="a719" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">首先从npm安装comlink-fetch:</p><pre class="lr ls lt lu fd lx ly lz ma aw mb bi"><span id="464e" class="lc ka hh ly b fi mc md l me mf">npm install comlink-fetch --save</span></pre><figure class="lr ls lt lu fd ii er es paragraph-image"><div class="er es mg"><img src="../Images/60b1e788e34c208395ef1c9666b8e28a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/1*2ThqarAvEjL2ZM_Jyg9ZHg.gif"/></div><figcaption class="ip iq et er es ir is bd b be z dx">install comlink-fetch</figcaption></figure><p id="c52a" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">然后创建一个加载<strong class="iv hi"> index.js </strong>的最小index.html文件:</p><figure class="lr ls lt lu fd ii"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="e01e" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">我使用JavaScript模块(<code class="du mj mk ml ly b">type="module"</code>)是因为我希望能够从那个<strong class="iv hi"> index.js </strong>中进行<code class="du mj mk ml ly b">import</code> Comlink</p><p id="494f" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">现在用下面的代码创建一个<strong class="iv hi"> index.js </strong>:</p><figure class="lr ls lt lu fd ii"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="b6df" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">下面是对这个<strong class="iv hi"> index.js </strong>中发生的事情的分析:</p><ul class=""><li id="0f0a" class="mm mn hh iv b iw ix ja jb je mo ji mp jm mq jq mr ms mt mu bi translated">你从<strong class="iv hi"> comlink.es6.js </strong>导入<strong class="iv hi"> Comlink </strong></li><li id="d17e" class="mm mn hh iv b iw mv ja mw je mx ji my jm mz jq mr ms mt mu bi translated">从comlink-fetch的<a class="ae jr" href="https://github.com/jadjoubran/comlink-fetch/blob/master/src/fetch.worker.js" rel="noopener ugc nofollow" target="_blank"> fetch.worker.js </a>创建一个新的Web Worker</li><li id="66a2" class="mm mn hh iv b iw mv ja mw je mx ji my jm mz jq mr ms mt mu bi translated">您使用<code class="du mj mk ml ly b">Comlink</code>为该工人创建一个代理</li></ul><p id="114e" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">然后你就可以使用它了！我展示的其余代码是一个用例，您希望在后台加载一些额外的信息，例如您稍后将使用的<strong class="iv hi">帖子</strong>。</p><p id="e353" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">将它们加载到web worker中可以确保它们不会阻塞主线程，也不会降低用户界面的速度。</p><figure class="lr ls lt lu fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es na"><img src="../Images/27f22f3ba60fc72f023b859685191c15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*9gx7DoJjZ2TsQYsoiVbwGQ.gif"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Network tab recording with Fast 3G network throttling</figcaption></figure><p id="575d" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">值得注意的是<code class="du mj mk ml ly b">GET /posts/1</code>和<code class="du mj mk ml ly b">GET /posts/2</code>是同时在后台执行的。</p><h1 id="5c07" class="jz ka hh bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">Comlink-fetch是如何构建的</h1><p id="5ce7" class="pw-post-body-paragraph it iu hh iv b iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm lb jo jp jq ha bi translated">一旦你看一看comlink-fetch的<a class="ae jr" href="https://github.com/jadjoubran/comlink-fetch/blob/master/src/fetch.worker.js" rel="noopener ugc nofollow" target="_blank"> fetch.worker.js </a>的源代码，你就明白comlink为什么牛逼了。</p><p id="d559" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">我简单地定义了一个类<code class="du mj mk ml ly b">Fetch</code>，它是在<a class="ae jr" href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API" rel="noopener ugc nofollow" target="_blank"> fetch </a>之上的一个包装器，使得它有可能具有一些好的特性，比如设置一个基本url、默认标题和默认主体。</p><p id="9e73" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">你只需要在开始的时候导入Comlink，然后公开你写的类，这样以后就可以从主线程代理它了。</p><p id="03e9" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">看看我定义的类<strong class="iv hi"> Fetch </strong>的签名:</p><figure class="lr ls lt lu fd ii"><div class="bz dy l di"><div class="mh mi l"/></div></figure><p id="efc1" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">如您所见，没有样板文件或不必要的代码。开头只是一个简单的<strong class="iv hi">导入</strong>，结尾是一个<strong class="iv hi"> Comlink.expose </strong>。</p><h1 id="c2aa" class="jz ka hh bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">性能优势</h1><p id="c685" class="pw-post-body-paragraph it iu hh iv b iw kx iy iz ja ky jc jd je kz jg jh ji la jk jl jm lb jo jp jq ha bi translated">如果您使用<strong class="iv hi"> comlink-fetch </strong>，是否会直接看到性能优势？很可能不会。正如由<a class="nb nc ge" href="https://medium.com/u/f93bf4868810?source=post_page-----700dc33ac854--------------------------------" rel="noopener" target="_blank">康拉德·德兹温内尔</a>撰写的这篇Stackoverflow <a class="ae jr" href="https://stackoverflow.com/a/26219348/1599122" rel="noopener ugc nofollow" target="_blank">线程</a>中所概述的，一个基于通用工人的获取不一定会提高你的性能。</p><p id="b06a" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">但是，如果您必须对获取的数据进行一些繁重的处理，那么当您解析结果并在主线程之外处理它们时，这是有意义的。</p></div><div class="ab cl js jt go ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="ha hb hc hd he"><p id="97c8" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">ComLink的其他替代品是由Preact和其他令人敬畏的软件包的作者<a class="nb nc ge" href="https://medium.com/u/30b8f5921914?source=post_page-----700dc33ac854--------------------------------" rel="noopener" target="_blank">杰森·米勒</a>开发的<a class="ae jr" href="https://github.com/developit/workerize" rel="noopener ugc nofollow" target="_blank"> workerize </a>和<a class="ae jr" href="https://github.com/developit/greenlet" rel="noopener ugc nofollow" target="_blank"> greenlet </a>。</p><p id="7b36" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">请继续关注关于如何在大型项目中使用Web Workers的更多技巧和诀窍，以及一些关于性能优势的数据。</p></div><div class="ab cl js jt go ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="ha hb hc hd he"><p id="78dc" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated">查看我的互动课程:</p><ul class=""><li id="22dd" class="mm mn hh iv b iw ix ja jb je mo ji mp jm mq jq mr ms mt mu bi translated"><a class="ae jr" href="https://learnprogramming.online" rel="noopener ugc nofollow" target="_blank"> <strong class="iv hi">学习编程</strong> </a></li><li id="a075" class="mm mn hh iv b iw mv ja mw je mx ji my jm mz jq mr ms mt mu bi translated"><a class="ae jr" href="http://learnjavascript.online" rel="noopener ugc nofollow" target="_blank"> <strong class="iv hi">学习JavaScript </strong> </a></li><li id="942f" class="mm mn hh iv b iw mv ja mw je mx ji my jm mz jq mr ms mt mu bi translated"><a class="ae jr" href="https://react-tutorial.app" rel="noopener ugc nofollow" target="_blank"> <strong class="iv hi">反应过来教程</strong> </a></li></ul><p id="72d2" class="pw-post-body-paragraph it iu hh iv b iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq ha bi translated"><em class="nd">感谢</em><a class="nb nc ge" href="https://medium.com/u/c21d4da150d1?source=post_page-----700dc33ac854--------------------------------" rel="noopener" target="_blank"><em class="nd">Ciro Nunes</em></a><em class="nd">&amp;</em><a class="nb nc ge" href="https://medium.com/u/2c972de40a20?source=post_page-----700dc33ac854--------------------------------" rel="noopener" target="_blank"><em class="nd">Nicole Saidy</em></a><em class="nd">对他们的反馈。</em></p></div></div>    
</body>
</html>