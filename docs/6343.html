<html>
<head>
<title>Addressing Python Dependency Confusion at Pinterest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Pinterest解决Python依赖困惑</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/addressing-python-dependency-confusion-at-pinterest-e0a0609c8e9?source=collection_archive---------3-----------------------#2022-03-10">https://medium.com/pinterest-engineering/addressing-python-dependency-confusion-at-pinterest-e0a0609c8e9?source=collection_archive---------3-----------------------#2022-03-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="e71d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Bill Prin |软件工程师，工程生产力，PythonDevin Lundberg |软件工程师，安全主管；和亚当·贝瑞|软件工程师，工程生产力</p><p id="04ad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在当今世界，软件供应链是一个非常重要的安全话题。2021年5月，美国<a class="ae jc" href="https://www.bloomberg.com/news/articles/2021-06-04/hackers-breached-colonial-pipeline-using-compromised-password" rel="noopener ugc nofollow" target="_blank">石油管道系统成为网络攻击</a>的受害者，在联邦调查局的协助下，向攻击者支付了超过440万美元的赎金，以恢复他们的系统。</p><p id="53d6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">结果，美国总统乔·拜登被迫宣布进入紧急状态，并于5月12日在<a class="ae jc" href="https://www.cnbc.com/2021/05/12/biden-signs-executive-order-to-strengthen-cybersecurity-after-colonial-pipeline-hack.html" rel="noopener ugc nofollow" target="_blank">发布了第14028 </a>号行政命令，提高软件供应链的软件安全标准。据VentureBeat报道，<a class="ae jc" href="https://venturebeat.com/2022/01/27/report-software-supply-chain-attacks-increased-300-in-2021/" rel="noopener ugc nofollow" target="_blank">软件供应链攻击在2021年增加了300%。</a></p><p id="6b0f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">那年早些时候，安全研究员Alex Birsan写了一篇病毒文章，描述了他如何<a class="ae jc" rel="noopener" href="/@alex.birsan/dependency-confusion-4a5d60fec610">利用一种叫做“依赖混淆”的软件供应链漏洞攻击苹果、微软和其他十几家公司</a>。</p><p id="6f4b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作为一名软件工程师，你会经常发现有用的软件在线免费发布在软件包仓库上，比如Python的PyPi或者NodeJS的NPM。这些开源软件包可以节省大量的时间，但是从互联网上下载代码会带来大量的安全隐患。</p><p id="09c3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有了依赖混淆，黑客可以给他们的恶意包起一个和正版包一样的名字，然后上传到一个公共库，希望它被意外下载。如果发生这种情况，攻击者将有权执行<a class="ae jc" href="https://en.wikipedia.org/wiki/Arbitrary_code_execution" rel="noopener ugc nofollow" target="_blank">任意代码</a>，可能允许他们完全访问敏感数据，或者使他们能够破坏为Pinterest等网站提供支持的生产服务。Pinterest非常重视安全性，减轻这些努力已经成为该公司的首要任务。Pinterest指派了内部安全专家和第三方安全研究人员来审计我们的依赖性混淆风险。</p><p id="7d31" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了防止依赖性混淆，我们采取的第一个行动是验证我们所有的依赖性都被“固定”到了一个特定的版本。例如，不接受任何版本的“requests”库，而是在“requirements.txt”文件中将需求指定为“requests==2.27.1”。这是非常重要的第一步，这样你就不会不小心下载了恶意版本的软件包。这是防止Python依赖混淆攻击的必要步骤，但仅仅这样还不够。</p><p id="93da" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Python编程语言特别容易受到供应链攻击，原因有几个。</p><ul class=""><li id="ad9a" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">Python中有一种代码重用的文化。<br/>正因为如此，人们经常想要添加新的库，这些库通常是由不知名的第三方开发者创建的。</li><li id="4a05" class="jd je hh ig b ih jm il jn ip jo it jp ix jq jb ji jj jk jl bi translated">最流行的软件包管理器pip很容易配置错误，从而使您的组织容易受到依赖性混淆的影响。<br/>这是一个由志愿者组成的团队运行的非常有价值的工具。总的来说，他们做得非常出色，这也是这个工具如此受欢迎的原因，但它确实有这个弱点。</li></ul><h1 id="a9d0" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">“pip–额外索引url”的危险</h1><p id="c7c0" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">让我们面临依赖性混乱风险的一个主要问题是，我们的Python“pip”配置使用了多个索引端点，使用了配置标志“extra-index-url”。Pinterest Python工件的一部分存储在我们自己的定制存储库中，<a class="ae jc" href="https://github.com/pinterest/pinrepo" rel="noopener ugc nofollow" target="_blank">开源为Pinrepo </a>，我们的一些Python包存储在JFrog的<a class="ae jc" href="https://jfrog.com/artifactory/" rel="noopener ugc nofollow" target="_blank"> Artifactory </a>中。</p><p id="d5c0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用“— extra-index-url”标志有一个很大的危险:它不支持任何优先级排序。这已经在<a class="ae jc" href="https://github.com/pypa/pip/issues/8606" rel="noopener ugc nofollow" target="_blank"> Github </a>和<a class="ae jc" href="https://stackoverflow.com/questions/67253141/python-pip-priority-order-with-index-url-and-extra-index-url" rel="noopener ugc nofollow" target="_blank">堆栈溢出</a>中进行了广泛的讨论。简短的总结是，管理pip开源项目的志愿者团队没有考虑pip工具范围内的存储库索引优先级。相反，他们建议使用一个单一的服务器端点来管理后端的优先级。</p><p id="78a9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下图显示了攻击的样子。</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/6ff01cfd9588fca70cd8990125eab31f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Im-ycDqonk8PmyXX"/></div></div></figure><p id="cb6a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请记住，<strong class="ig hi"> pip不允许您设置哪个后端索引优先。</strong>因此，尽管版本被锁定，pip仍有可能意外下载恶意软件包。一种补救方法是在PyPi上用一个空包“蹲”住每个内部包。然而，PyPi组织并不认可这种方法，并且已经移除了空的包。</p><p id="0330" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">幸运的是，Artifactory支持<a class="ae jc" href="https://www.jfrog.com/confluence/display/JFROG/Virtual+Repositories" rel="noopener ugc nofollow" target="_blank">虚拟存储库</a>的概念，允许您使用单个端点，然后“虚拟地”分派到适当的后端存储库，包括优先级等功能。这意味着你可以配置Artifactory来<em class="lg">总是</em>优先考虑内部存储库，从而降低意外下载外部包的风险。</p><p id="0643" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Pinterest，我们投资将所有包转移到与Artifactory虚拟端点兼容的存储库中。然后，我们设置虚拟端点，以正确的优先级顺序委托给后端包索引，总是优先考虑内部包。通过切换到Artifactory上的单个端点，我们可以优先考虑pip在哪里寻找包，并且总是优先选择内部版本。</p><h1 id="c59b" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">其他重要的补救措施</h1><p id="23c0" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">还有一些其他重要的补救步骤。其中最大的一个是将依赖项安装绑定到内容的一个<strong class="ig hi">散列</strong>，而不仅仅是包的名称和版本。这样，即使软件包的名称和版本完全相同，如果任何内容与预期不同，安装也会失败。这可以通过像<a class="ae jc" href="https://github.com/jazzband/pip-tools" rel="noopener ugc nofollow" target="_blank"> pip-tools </a>或<a class="ae jc" href="https://python-poetry.org/" rel="noopener ugc nofollow" target="_blank">poems</a>这样的工具来完成。</p><p id="e352" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">另一个我们正在实施的建议是用相同的前缀命名每个内部包，比如pinterest-*。通过这种方式，我们可以编写逻辑代码，永远不从外部资源下载带有那个前缀的包。</p><p id="076a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Pinterest，我们对安全基础设施进行了重大改进，这将有助于防止我们看到的供应链软件攻击类型。尽管如此，鉴于从互联网上频繁下载和运行的代码数量，这是一个巨大的安全领域，每个公司都应该投资加强。软件供应链攻击对政府和企业都是一个严重的威胁，这是Pinterest engineering将持续监控并投资防止的一个领域。</p><h1 id="3af7" class="jr js hh bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">致谢和参考</h1><p id="c370" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip kr ir is it ks iv iw ix kt iz ja jb ha bi translated">我们要感谢Josh Koza和产品安全团队、持续集成和测试团队的Jasmine Qin以及云架构团队的Kynan Lalone和Ruth王君馨所做的努力。我们也在寻找能帮助提高我们工程生产力的人:代码和语言运行时团队，他们专注于解决Java、Python、Node、C++和Go等语言的类似问题。</p><p id="bd0f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">其中一篇关于依赖性困惑的内容丰富的博文来自Twilio: <a class="ae jc" href="https://www.twilio.com/blog/avoiding-dependency-confusion-attacks" rel="noopener ugc nofollow" target="_blank">依赖性、困惑和解决方案:Twilio做了什么来解决依赖性困惑</a>。在Pinterest engineering，我们发现Twilio关于该主题的文章信息量很大，我们强烈建议任何致力于防止依赖性混淆的公司查看Twilio关于该主题的帖子。</p><p id="6371" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个领域的其他有用的参考资料是谷歌的SLSA框架，你可以在谷歌的博客文章<a class="ae jc" href="https://security.googleblog.com/2021/06/introducing-slsa-end-to-end-framework.html" rel="noopener ugc nofollow" target="_blank">上读到，介绍SLSA，一个端到端的供应链完整性框架</a>，以及<a class="ae jc" href="https://www.sigstore.dev/" rel="noopener ugc nofollow" target="_blank"> Sigstore </a>项目，旨在推动更好的软件签名和验证行业标准。</p><p id="6510" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lg">要在Pinterest上了解更多工程知识，请查看我们的</em> <a class="ae jc" href="https://medium.com/pinterest-engineering" rel="noopener"> <em class="lg">工程博客</em> </a> <em class="lg">，并访问我们的</em><a class="ae jc" href="https://www.pinterestlabs.com?utm_source=medium&amp;utm_medium=blog-article&amp;utm_campaign=prin-et-al-march-10-2022" rel="noopener ugc nofollow" target="_blank"><em class="lg">Pinterest Labs</em></a><em class="lg">网站。要查看和申请空缺职位，请访问我们的</em> <a class="ae jc" href="https://www.pinterestcareers.com?utm_source=medium&amp;utm_medium=blog-article&amp;utm_campaign=prin-et-al-march-10-2022" rel="noopener ugc nofollow" target="_blank"> <em class="lg">招聘</em> </a> <em class="lg">页面</em></p></div></div>    
</body>
</html>