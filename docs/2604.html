<html>
<head>
<title>Changes Storage Destination from Local Disk into Google Cloud Storage in Strapi v4</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Strapi v4中将存储目标从本地磁盘更改为Google云存储</h1>
<blockquote>原文：<a href="https://medium.easyread.co/changes-storage-destination-from-local-disk-into-google-cloud-storage-in-strapi-v4-bad6e41e14a0?source=collection_archive---------0-----------------------#2022-01-18">https://medium.easyread.co/changes-storage-destination-from-local-disk-into-google-cloud-storage-in-strapi-v4-bad6e41e14a0?source=collection_archive---------0-----------------------#2022-01-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="f6f0" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">在生产模式下，您还可以在Strapi v4中集成Google云存储</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/4d33407edf0c1d6baf8e1514891f1e87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wet30vzxWsLyYstx"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@markuswinkler?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Markus Winkler</a> on <a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="e554" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">大家好，我是潘杜，我是一名软件工程师。欢迎来到我的博客，快乐阅读！</p><p id="2dd5" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">今天我就和大家分享一下如何在Heroku中解决连接Google云存储时上传文件的问题。</p></div><div class="ab cl lp lq hr lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ig ih ii ij ik"><p id="b231" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当我第一次在Heroku上部署时(没有带文件上传功能——read:media on Google Cloud Storage ),当所有功能都运行良好时，这对我来说是个好结果。我可以在生产模式下做任何事情，直到我发现无法查看和上传媒体或查看图片的问题。</p><p id="8806" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">简而言之，我在社区中发现我可以在Heroku做到这一点，因为…</p><div class="lw lx gp gr ly lz"><a href="https://help.heroku.com/K1PPS2WM/why-are-my-file-uploads-missing-deleted" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd io gy z fp me fr fs mf fu fw im bi translated">为什么我上传的文件丢失/被删除了？</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">文件被上传到应用程序，但过一会儿就会消失或被删除。Heroku文件系统是短暂的…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">help.heroku.com</p></div></div></div></a></div><p id="1876" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当您部署它时，您的<code class="fe mi mj mk ml b">public/uploads</code>将被自动删除。您可以尝试部署，然后使用Heroku CLI <code class="fe mi mj mk ml b">heroku run bash</code>和<code class="fe mi mj mk ml b">ls public/uploads</code>。那边的图像会是空的。为此，你必须阅读我在上面提供的FAQ。</p><p id="f2d6" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这就是为什么你必须在项目中改变目标存储。以我为例，我把它修改成了谷歌云存储。</p><p id="5e8e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Strapi支持在Google云存储上进行集成。任何流行的包，包是<br/> Vanessa Lith的<code class="fe mi mj mk ml b">strapi-provider-upload-google-cloud-storage</code>(CMIIW关于名字)。</p><div class="lw lx gp gr ly lz"><a href="https://www.npmjs.com/package/strapi-provider-upload-google-cloud-storage" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd io gy z fp me fr fs mf fu fw im bi translated">strapi-提供商-上传-谷歌-云存储</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">非官方的谷歌云存储提供商从你的应用根目录安装软件包。</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">www.npmjs.com</p></div></div><div class="mm l"><div class="mn l mo mp mq mm mr km lz"/></div></div></a></div><p id="e305" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">该包支持Strapi v3和Strapi v4。文档也直截了当，非常清晰。请检查这个超酷的包装。</p><div class="lw lx gp gr ly lz"><a href="https://github.com/Lith/strapi-provider-upload-google-cloud-storage" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd io gy z fp me fr fs mf fu fw im bi translated">GitHub-Lith/strapi-Provider-Upload-Google-Cloud-Storage:Google Cloud Storage Upload Provider for…</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">非官方的谷歌云存储提供商从你的应用根目录安装软件包。</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">github.com</p></div></div><div class="mm l"><div class="ms l mo mp mq mm mr km lz"/></div></div></a></div><p id="e09f" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">好的，继续向下滚动每个人。</p><h1 id="9077" class="mt mu in bd mv mw mx my mz na nb nc nd jt ne ju nf jw ng jx nh jz ni ka nj nk bi translated">1.装置</h1><p id="822e" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">从您的应用程序根目录安装软件包。</p><p id="d235" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">与<code class="fe mi mj mk ml b">npm</code></p><pre class="kd ke kf kg gt nq ml nr ns aw nt bi"><span id="7916" class="nu mu in ml b gy nv nw l nx ny">npm install strapi-provider-upload-google-cloud-storage --save</span></pre><p id="2608" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">或者<code class="fe mi mj mk ml b">yarn</code></p><pre class="kd ke kf kg gt nq ml nr ns aw nt bi"><span id="cc07" class="nu mu in ml b gy nv nw l nx ny">yarn add strapi-provider-upload-google-cloud-storage</span></pre><h1 id="6ec8" class="mt mu in bd mv mw mx my mz na nb nc nd jt ne ju nf jw ng jx nh jz ni ka nj nk bi translated">2.在Google云存储上创建您的存储桶</h1><p id="659f" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">应该使用<strong class="kv io">细粒度的</strong>访问控制来创建bucket，因为插件将使用公共读取权限来配置上传的文件。</p><h2 id="515c" class="nu mu in bd mv nz oa dn mz ob oc dp nd lc od oe nf lg of og nh lk oh oi nj oj bi translated">如何创建一个桶？</h2><ul class=""><li id="1983" class="ok ol in kv b kw nl kz nm lc om lg on lk oo lo op oq or os bi translated"><a class="ae ks" href="https://cloud.google.com/storage/docs/creating-buckets" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/storage/docs/creating-buckets</a></li></ul><h2 id="7c32" class="nu mu in bd mv nz oa dn mz ob oc dp nd lc od oe nf lg of og nh lk oh oi nj oj bi translated">我的水桶在哪里？</h2><ul class=""><li id="fb88" class="ok ol in kv b kw nl kz nm lc om lg on lk oo lo op oq or os bi translated"><a class="ae ks" href="https://cloud.google.com/storage/docs/locations" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/storage/docs/locations</a></li></ul><h1 id="e154" class="mt mu in bd mv mw mx my mz na nb nc nd jt ne ju nf jw ng jx nh jz ni ka nj nk bi translated">3.设置Google身份验证</h1><p id="e53a" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">如果你部署到一个支持<a class="ae ks" href="https://cloud.google.com/docs/authentication/production#finding_credentials_automatically" rel="noopener ugc nofollow" target="_blank">应用默认凭证</a>的Google云平台产品(比如App Engine、Cloud Run、Cloud Functions等。)，那么可以跳过这一步。</p><p id="b479" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果您在GCP以外部署，请按照以下步骤设置身份验证:</p><ol class=""><li id="123e" class="ok ol in kv b kw kx kz la lc ot lg ou lk ov lo ow oq or os bi translated">在GCP控制台中，转至“创建服务帐户密钥”页面。<a class="ae ks" href="https://console.cloud.google.com/apis/credentials/serviceaccountkey" rel="noopener ugc nofollow" target="_blank">转到创建服务帐户密钥页面</a></li><li id="c6da" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo ow oq or os bi translated">从<strong class="kv io">服务帐户</strong>列表中，选择新服务帐户。</li><li id="803e" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo ow oq or os bi translated">在“服务帐户名称”字段中，输入一个名称。</li><li id="d36d" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo ow oq or os bi translated">从角色列表中，选择<strong class="kv io">云存储</strong> &gt; <strong class="kv io">存储管理员</strong>。</li><li id="8b87" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo ow oq or os bi translated">选择<code class="fe mi mj mk ml b">JSON</code>键类型</li><li id="2e7b" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo ow oq or os bi translated">单击创建。一个JSON文件，包含下载到您计算机的密钥。</li><li id="f730" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo ow oq or os bi translated">复制下载的JSON文件的全部内容</li><li id="be00" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo ow oq or os bi translated">打开Strapi配置文件</li><li id="bd6f" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo ow oq or os bi translated">将其粘贴到“服务帐户JSON”字段(如<code class="fe mi mj mk ml b">string</code>或<code class="fe mi mj mk ml b">JSON</code>，注意缩进)</li></ol><h1 id="13ab" class="mt mu in bd mv mw mx my mz na nb nc nd jt ne ju nf jw ng jx nh jz ni ka nj nk bi translated">4.在生产目录中创建plugins.js文件</h1><p id="a6cc" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">创建或编辑<code class="fe mi mj mk ml b">config/env/production/plugins.js</code></p><pre class="kd ke kf kg gt nq ml nr ns aw nt bi"><span id="0f44" class="nu mu in ml b gy nv nw l nx ny">const fs = require('fs');<br/>require('dotenv').config();<br/>module.exports = ({ env }) =&gt; ({<br/>    upload: {<br/>        config: {<br/>            provider: 'strapi-provider-upload-google-cloud-storage',<br/>            providerOptions: {<br/>                serviceAccount: JSON.parse(fs.readFileSync(process.env.GCS_SERVICE_ACCOUNT)),<br/>                bucketName: env('GCS_BUCKET_NAME'),<br/>                basePath: env('GCS_BASE_PATH'),<br/>                baseUrl: env('GCS_BASE_URL'),<br/>                publicFiles: true,<br/>                uniform: false,<br/>                gzip: true,<br/>            },<br/>        },<br/>    },<br/>});</span></pre><p id="0fb4" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">不要忘记为附加包安装<code class="fe mi mj mk ml b">dotenv</code>。</p><p id="80ca" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果您的环境有不同的上传提供者，您可以根据环境覆盖<code class="fe mi mj mk ml b">plugins.js</code>文件:</p><ul class=""><li id="c211" class="ok ol in kv b kw kx kz la lc ot lg ou lk ov lo op oq or os bi translated"><code class="fe mi mj mk ml b">config/env/development/plugins.js</code></li><li id="44b7" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo op oq or os bi translated"><code class="fe mi mj mk ml b">config/env/production/plugins.js</code></li></ul><p id="cf37" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在<code class="fe mi mj mk ml b">config/env/{env}/</code>下的这个文件将覆盖主文件夹<code class="fe mi mj mk ml b">config</code>中的默认配置。</p><p id="0058" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">环境变量可以按照你的方式改变。</p><h1 id="94e0" class="mt mu in bd mv mw mx my mz na nb nc nd jt ne ju nf jw ng jx nh jz ni ka nj nk bi translated">如何配置变量？</h1><h2 id="cb11" class="nu mu in bd mv nz oa dn mz ob oc dp nd lc od oe nf lg of og nh lk oh oi nj oj bi translated"><code class="fe mi mj mk ml b">serviceAccount</code>:</h2><p id="89fb" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">Google账号提供的JSON数据(之前解释过)。如果您要部署到支持应用程序默认凭据的GCP产品，则可以省略此步骤，身份验证将自动运行。</p><p id="c50e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">可以设置为字符串、JSON对象，也可以省略。</p><h2 id="2353" class="nu mu in bd mv nz oa dn mz ob oc dp nd lc od oe nf lg of og nh lk oh oi nj oj bi translated"><code class="fe mi mj mk ml b">bucketName</code>:</h2><p id="1c0f" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">Google云存储上的存储桶的名称。</p><ul class=""><li id="53f2" class="ok ol in kv b kw kx kz la lc ot lg ou lk ov lo op oq or os bi translated">需要</li></ul><p id="be9e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">您可以在Google Cloud文档中找到更多信息。</p><h2 id="bad0" class="nu mu in bd mv nz oa dn mz ob oc dp nd lc od oe nf lg of og nh lk oh oi nj oj bi translated"><code class="fe mi mj mk ml b">baseUrl</code>:</h2><p id="34ae" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">定义您的基本Url，首先是默认值:</p><ul class=""><li id="5ed4" class="ok ol in kv b kw kx kz la lc ot lg ou lk ov lo op oq or os bi translated"><a class="ae ks" href="https://storage.googleapis.com/%7Bbucket-name%7D" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/{bucket-name}</a></li><li id="6363" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo op oq or os bi translated"><a class="ae ks" rel="noopener ugc nofollow" target="_blank" href="/{bucket-name}"> https://{bucket-name} </a></li><li id="0a0c" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo op oq or os bi translated"><a class="ae ks" rel="noopener ugc nofollow" target="_blank" href="/{bucket-name}">http://{桶名} </a></li></ul><h2 id="e947" class="nu mu in bd mv nz oa dn mz ob oc dp nd lc od oe nf lg of og nh lk oh oi nj oj bi translated"><code class="fe mi mj mk ml b">basePath</code>:</h2><p id="7165" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">定义保存每个媒体文档的基本路径。</p><ul class=""><li id="62cf" class="ok ol in kv b kw kx kz la lc ot lg ou lk ov lo op oq or os bi translated">可选择的</li></ul><h2 id="cb3c" class="nu mu in bd mv nz oa dn mz ob oc dp nd lc od oe nf lg of og nh lk oh oi nj oj bi translated"><code class="fe mi mj mk ml b">publicFiles</code>:</h2><p id="f30a" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">布尔值，用于在文件上传到存储时为文件定义公共属性。</p><ul class=""><li id="cf07" class="ok ol in kv b kw kx kz la lc ot lg ou lk ov lo op oq or os bi translated">默认值:<code class="fe mi mj mk ml b">true</code></li><li id="f258" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo op oq or os bi translated">可选择的</li></ul><h2 id="f096" class="nu mu in bd mv nz oa dn mz ob oc dp nd lc od oe nf lg of og nh lk oh oi nj oj bi translated"><code class="fe mi mj mk ml b">uniform</code>:</h2><p id="d563" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">启用统一存储桶级别访问时，用于定义统一访问的布尔值。</p><ul class=""><li id="4bbd" class="ok ol in kv b kw kx kz la lc ot lg ou lk ov lo op oq or os bi translated">默认值:<code class="fe mi mj mk ml b">false</code></li><li id="3399" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo op oq or os bi translated">可选择的</li></ul><h2 id="b417" class="nu mu in bd mv nz oa dn mz ob oc dp nd lc od oe nf lg of og nh lk oh oi nj oj bi translated"><code class="fe mi mj mk ml b">cacheMaxAge</code>:</h2><p id="887b" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">为上传的文件设置缓存控制头的数字。</p><ul class=""><li id="f7ef" class="ok ol in kv b kw kx kz la lc ot lg ou lk ov lo op oq or os bi translated">默认值:<code class="fe mi mj mk ml b">3600</code></li><li id="93f0" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo op oq or os bi translated">可选择的</li></ul><h2 id="3d85" class="nu mu in bd mv nz oa dn mz ob oc dp nd lc od oe nf lg of og nh lk oh oi nj oj bi translated"><code class="fe mi mj mk ml b">gzip</code>:</h2><p id="28ad" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">用于定义文件是否使用gzip压缩上传和存储的值。</p><ul class=""><li id="1e6a" class="ok ol in kv b kw kx kz la lc ot lg ou lk ov lo op oq or os bi translated">可能的值:<code class="fe mi mj mk ml b">true</code>、<code class="fe mi mj mk ml b">false</code>、<code class="fe mi mj mk ml b">auto</code></li><li id="250a" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo op oq or os bi translated">默认值:<code class="fe mi mj mk ml b">auto</code></li><li id="3cab" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo op oq or os bi translated">可选择的</li></ul><h1 id="5646" class="mt mu in bd mv mw mx my mz na nb nc nd jt ne ju nf jw ng jx nh jz ni ka nj nk bi translated"><code class="fe mi mj mk ml b">metadata</code>:</h1><p id="4964" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">上传文件时执行的计算文件元数据的功能。</p><p id="ad1c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果没有提供函数，则使用以下元数据:</p><pre class="kd ke kf kg gt nq ml nr ns aw nt bi"><span id="6e37" class="nu mu in ml b gy nv nw l nx ny">{<br/>  contentDisposition: `inline; filename="${file.name}"`,<br/>  cacheControl: `public, max-age=${config.cacheMaxAge || 3600}`,<br/>}</span></pre><ul class=""><li id="cd5e" class="ok ol in kv b kw kx kz la lc ot lg ou lk ov lo op oq or os bi translated">默认值:<code class="fe mi mj mk ml b">undefined</code></li><li id="5b70" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo op oq or os bi translated">可选择的</li></ul><p id="fb32" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">示例:</p><pre class="kd ke kf kg gt nq ml nr ns aw nt bi"><span id="8fab" class="nu mu in ml b gy nv nw l nx ny">metadata: (file) =&gt; ({<br/>    cacheControl: `public, max-age=${60 * 60 * 24 * 7}`, // One week<br/>    contentLanguage: 'en-US',<br/>    contentDisposition: `attachment; filename="${file.name}"`,<br/>  }),</span></pre><p id="9fa1" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">可用的属性可以在<a class="ae ks" href="https://cloud.google.com/storage/docs/json_api/v1/objects/insert#request_properties_JSON" rel="noopener ugc nofollow" target="_blank">云存储JSON API文档</a>中找到。</p><h1 id="83a1" class="mt mu in bd mv mw mx my mz na nb nc nd jt ne ju nf jw ng jx nh jz ni ka nj nk bi translated"><code class="fe mi mj mk ml b">generateUploadFileName</code>:</h1><p id="de24" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">执行该函数以生成上传文件的名称。这种方法可以对文件名进行更多的控制，例如可以用于包含自定义散列函数或动态路径。</p><p id="3ab4" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">当没有提供功能时，使用默认算法。</p><ul class=""><li id="0e6c" class="ok ol in kv b kw kx kz la lc ot lg ou lk ov lo op oq or os bi translated">默认值:<code class="fe mi mj mk ml b">undefined</code></li><li id="f186" class="ok ol in kv b kw ox kz oy lc oz lg pa lk pb lo op oq or os bi translated">可选择的</li></ul><p id="0415" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">示例:</p><pre class="kd ke kf kg gt nq ml nr ns aw nt bi"><span id="d7b0" class="nu mu in ml b gy nv nw l nx ny">generateUploadFileName: (file) =&gt; {<br/>    const hash = ...; // Some hashing function, for example MD-5<br/>    const extension = file.ext.toLowerCase().substring(1);<br/>    return `${extension}/${slugify(path.parse(file.name).name)}-${hash}.${extension}`;<br/>  },</span></pre><h1 id="e021" class="mt mu in bd mv mw mx my mz na nb nc nd jt ne ju nf jw ng jx nh jz ni ka nj nk bi translated">5.设置<code class="fe mi mj mk ml b">strapi::security</code>中间件以避免CSP阻止URL</h1><p id="16ab" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">创建或编辑<code class="fe mi mj mk ml b">./config/env/production/middlewares.js</code></p><ul class=""><li id="a251" class="ok ol in kv b kw kx kz la lc ot lg ou lk ov lo op oq or os bi translated">在字段<code class="fe mi mj mk ml b">img-src</code>和<code class="fe mi mj mk ml b">media-src</code>中添加您自己的CDN URL，默认为<code class="fe mi mj mk ml b">storage.googleapis.com</code>，但您需要添加您自己的CDN URL</li></ul><pre class="kd ke kf kg gt nq ml nr ns aw nt bi"><span id="d846" class="nu mu in ml b gy nv nw l nx ny">module.exports = [<br/>  'strapi::errors',<br/>  {<br/>    name: 'strapi::security',<br/>    config: {<br/>      contentSecurityPolicy: {<br/>        useDefaults: true,<br/>        directives: {<br/>          'connect-src': ["'self'", 'https:'],<br/>          'img-src': ["'self'", 'data:', 'blob:', 'storage.googleapis.com'],<br/>          'media-src': ["'self'", 'data:', 'blob:', 'storage.googleapis.com'],<br/>          upgradeInsecureRequests: null,<br/>        },<br/>      },<br/>    },<br/>  },<br/>  'strapi::cors',<br/>  'strapi::poweredBy',<br/>  'strapi::logger',<br/>  'strapi::query',<br/>  'strapi::body',<br/>  'strapi::favicon',<br/>  'strapi::public',<br/>];</span></pre><h1 id="1234" class="mt mu in bd mv mw mx my mz na nb nc nd jt ne ju nf jw ng jx nh jz ni ka nj nk bi translated">6.部署到Heroku</h1><p id="b18b" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">最后，如果你已经遵循了所有的指令，请将你的代码放入Heroku。尝试上传或在媒体菜单中获取，如果你一直发现错误，请在评论区评论。</p><p id="dbda" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在我的例子中，<strong class="kv io">我曾经得到错误内部服务器错误和状态代码500 </strong>。</p><p id="8838" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">解决问题的方法可能是因为:</p><ul class=""><li id="6af7" class="ok ol in kv b kw kx kz la lc ot lg ou lk ov lo op oq or os bi translated">您还没有添加安全中间件</li></ul><pre class="kd ke kf kg gt nq ml nr ns aw nt bi"><span id="7474" class="nu mu in ml b gy nv nw l nx ny">...<br/>{<br/>    name: 'strapi::security',<br/>    config: {<br/>      contentSecurityPolicy: {<br/>        useDefaults: true,<br/>        directives: {<br/>          'connect-src': ["'self'", 'https:'],<br/>          'img-src': ["'self'", 'data:', 'blob:', 'storage.googleapis.com'],<br/>          'media-src': ["'self'", 'data:', 'blob:', 'storage.googleapis.com'],<br/>          upgradeInsecureRequests: null,<br/>        },<br/>      },<br/>    },<br/>  },<br/>...</span></pre><ul class=""><li id="3bc3" class="ok ol in kv b kw kx kz la lc ot lg ou lk ov lo op oq or os bi translated">或者你应该在<code class="fe mi mj mk ml b">extensions/upload/config/</code>中创建文件<code class="fe mi mj mk ml b">settings.json</code></li></ul><pre class="kd ke kf kg gt nq ml nr ns aw nt bi"><span id="ecc6" class="nu mu in ml b gy nv nw l nx ny">{<br/>    "provider": "strapi-provider-upload-google-cloud-storage",<br/>    "providerOptions": {<br/>        "serviceAccount": {<br/>            "type": "service_account",<br/>            "project_id": "xxx-xxx-xxxxxxxx",<br/>            "private_key_id": "xxxx2b00abxx243b17d8xxd7fe5bf5xx7970cxxx",<br/>            "private_key": "xxxxxxxxxxx and so on",<br/>            "client_email": "strapi-storage@xxx-xxx-xxxxxxxx.iam.gserviceaccount.com",<br/>            "client_id": "xxxxxxnumberxxxxxxxxxx",<br/>            "auth_uri": "https://accounts.google.com/o/oauth2/auth",<br/>            "token_uri": "https://oauth2.googleapis.com/token",<br/>            "auth_provider_x888_cert_url": "https://www.googleapis.com/oauth2/v1/certs",<br/>            "client_x888_cert_url": "https://www.googleapis.com/robot/v1/metadata/x888/strapi-storage%40xxx-xxx-xxxxxxxx.iam.gserviceaccount.com"<br/>        },<br/>        "bucketName": "cms-strapi-storage",<br/>        "basePath": "",<br/>        "baseUrl": "https://storage.googleapis.com/strapi-storage",<br/>        "publicFiles": true,<br/>        "uniform": false,<br/>        "gzip": true<br/>    }<br/>}</span></pre><p id="1243" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">有关详细信息，请访问</p><div class="lw lx gp gr ly lz"><a href="https://github.com/strapi/strapi/issues/9701" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd io gy z fp me fr fs mf fu fw im bi translated">无法从UI问题#9701 strapi/strapi将文件上传到媒体资产</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">错误报告描述无法从管理UI界面上传媒体的错误重现该问题的步骤请转到…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">github.com</p></div></div><div class="mm l"><div class="pc l mo mp mq mm mr km lz"/></div></div></a></div><p id="27ee" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">是的，这是一个将Strapi与Google云存储集成的小故事。</p><p id="c3ea" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">感谢Vanessa Lith和她的团队创建了一个很棒的项目，将Strapi连接到Google云存储。</p><p id="df83" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">结束了。希望我能帮你解决这个问题。快乐阅读&amp;快乐编码。谢谢你。</p><h1 id="12bf" class="mt mu in bd mv mw mx my mz na nb nc nd jt ne ju nf jw ng jx nh jz ni ka nj nk bi translated">警惕！</h1><p id="a492" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">如果你们来自<strong class="kv io">印尼</strong>，想要支持我写更多的东西，希望你们能从钱包里拿出一点来。你可以通过一些方式分享你的天赋，</p><h2 id="b9c6" class="nu mu in bd mv nz oa dn mz ob oc dp nd lc od oe nf lg of og nh lk oh oi nj oj bi translated">萨韦里亚</h2><p id="a572" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated">【https://saweria.co/pandhuwibowo T4】</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/0089e6c52b43886c90f7f853a7b8a73b.png" data-original-src="https://miro.medium.com/v2/resize:fit:580/format:webp/1*xFmG4J1rW-MHyEqO_mzIaw.png"/></div></figure><h2 id="b9fb" class="nu mu in bd mv nz oa dn mz ob oc dp nd lc od oe nf lg of og nh lk oh oi nj oj bi translated">特拉克特尔</h2><p id="c63d" class="pw-post-body-paragraph kt ku in kv b kw nl jo ky kz nm jr lb lc nn le lf lg no li lj lk np lm ln lo ig bi translated"><a class="ae ks" href="https://trakteer.id/goodpeopletogivemoney" rel="noopener ugc nofollow" target="_blank">https://trakteer.id/goodpeopletogivemoney</a></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/d26e4901a3c5106b7c99a3c8a99d74a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/format:webp/1*Q-ZYOzqJ6R3ijDlVlM5JMw.jpeg"/></div></figure><h1 id="159f" class="mt mu in bd mv mw mx my mz na nb nc nd jt ne ju nf jw ng jx nh jz ni ka nj nk bi translated">参考</h1><div class="lw lx gp gr ly lz"><a href="https://github.com/strapi/strapi/issues/8275" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd io gy z fp me fr fs mf fu fw im bi translated">无法上传到媒体库(500内部服务器错误)生产问题#8275 …</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">描述在生产环境中尝试向媒体库上传任何内容时出现的错误，我将获得一台500内部服务器…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">github.com</p></div></div><div class="mm l"><div class="pf l mo mp mq mm mr km lz"/></div></div></a></div><div class="lw lx gp gr ly lz"><a href="https://github.com/strapi/strapi/issues/9701" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd io gy z fp me fr fs mf fu fw im bi translated">无法从UI问题#9701 strapi/strapi将文件上传到媒体资产</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">错误报告描述无法从管理UI界面上传媒体的错误重现该问题的步骤请转到…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">github.com</p></div></div><div class="mm l"><div class="pc l mo mp mq mm mr km lz"/></div></div></a></div><div class="lw lx gp gr ly lz"><a href="https://github.com/Lith/strapi-provider-upload-google-cloud-storage" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd io gy z fp me fr fs mf fu fw im bi translated">GitHub-Lith/strapi-Provider-Upload-Google-Cloud-Storage:Google Cloud Storage Upload Provider for…</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">非官方的谷歌云存储提供商从你的应用根目录安装软件包。</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">github.com</p></div></div><div class="mm l"><div class="ms l mo mp mq mm mr km lz"/></div></div></a></div><div class="lw lx gp gr ly lz"><a href="https://www.npmjs.com/package/strapi-provider-upload-google-cloud-storage#setup-auth" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd io gy z fp me fr fs mf fu fw im bi translated">strapi-提供商-上传-谷歌-云存储</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">非官方的谷歌云存储提供商从你的应用根目录安装软件包。</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">www.npmjs.com</p></div></div><div class="mm l"><div class="pg l mo mp mq mm mr km lz"/></div></div></a></div><div class="lw lx gp gr ly lz"><a href="https://githubplus.com/Lith/strapi-provider-upload-google-cloud-storage/issues" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd io gy z fp me fr fs mf fu fw im bi translated">strapi-提供商-上传-谷歌-云存储- Github Plus</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">描述一下我在Cloud Run上部署了一个strapi应用程序，它使用Google云存储作为媒体存储…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">githubplus.com</p></div></div><div class="mm l"><div class="ph l mo mp mq mm mr km lz"/></div></div></a></div><div class="lw lx gp gr ly lz"><a href="https://help.heroku.com/K1PPS2WM/why-are-my-file-uploads-missing-deleted" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd io gy z fp me fr fs mf fu fw im bi translated">为什么我上传的文件丢失/被删除了？</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">文件被上传到应用程序，但过一会儿就会消失或被删除。Heroku文件系统是短暂的…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">help.heroku.com</p></div></div></div></a></div></div></div>    
</body>
</html>