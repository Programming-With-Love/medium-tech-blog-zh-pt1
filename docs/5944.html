<html>
<head>
<title>Kubernetes Networking with Cilium CNI and OKE on Oracle Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes在Oracle Cloud上与Cilium CNI和OKE联网</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/cni-adventures-with-kubernetes-on-oracle-cloud-cilium-5c6f011746d5?source=collection_archive---------0-----------------------#2022-07-21">https://medium.com/oracledevs/cni-adventures-with-kubernetes-on-oracle-cloud-cilium-5c6f011746d5?source=collection_archive---------0-----------------------#2022-07-21</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="1f24" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">直到最近，当你使用OKE处理你的Kubernetes工作负载时，你的pod网络的唯一网络选项是你尊敬和友好的邻居CNI，<a class="ae jc" href="https://github.com/flannel-io/flannel" rel="noopener ugc nofollow" target="_blank">法兰绒</a>。法兰绒比较简洁。它只处理你的pod网络，对做其他事情不感兴趣。</p><p id="08cf" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，Kubernetes用例在复杂性、多样性和其他*关系方面已经爆炸了。结果，我们见证了CNI寒武纪大爆发。现在至少有<a class="ae jc" href="https://kubernetes.io/docs/concepts/cluster-administration/networking/" rel="noopener ugc nofollow" target="_blank"> 25个</a>，最近我们通过<a class="ae jc" href="https://blogs.oracle.com/cloud-infrastructure/post/announcing-vcn-native-pod-networking-for-kubernetes-in-oci" rel="noopener ugc nofollow" target="_blank">发布我们的VCN本地pod网络</a>加入了这个派对。这个词很拗口，所以为了简洁起见，我称它为"<strong class="ig hi"> NPN。</strong>“NPN使Kubernetes pods能够拥有来自VCN子网的IP地址。想象一下，您的Kubernetes pods与您的虚拟机或裸机节点或其他工作负载位于同一网络中。那是NPN。</p><p id="d1a2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">NPN CNI提供的可能性是巨大的，我们已经在努力在terraform-oci-oke中增加对它的支持。由于我还没有完全掌握这一点的重要性，我将避免对此发表意见，以便您可以同时阅读我的同事Ajay和Greg的<a class="ae jc" href="https://blogs.oracle.com/cloud-infrastructure/post/announcing-vcn-native-pod-networking-for-kubernetes-in-oci" rel="noopener ugc nofollow" target="_blank">博客公告</a>或<a class="ae jc" href="https://docs.oracle.com/en-us/iaas/Content/ContEng/Concepts/contengpodnetworking_topic-OCI_CNI_plugin.htm" rel="noopener ugc nofollow" target="_blank">文档</a>以了解更多细节。</p><p id="166f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我前面提到过，法兰绒是精简和简单的，只关心豆荚的网络。嗯，大部分是。如果你在OCI管理你自己的Kubernetes集群，并且有额外的需求，例如网络策略，你可能会从<a class="ae jc" href="https://kubernetes.io/docs/concepts/cluster-administration/networking/" rel="noopener ugc nofollow" target="_blank">列表中选择另一个CNI</a>，例如<a class="ae jc" href="https://oracle.github.io/cluster-api-provider-oci/networking/infrastructure.html" rel="noopener ugc nofollow" target="_blank">OCI的ClusterAPI默认安装Calico</a>。由于OKE是一项托管服务，您不能随便选择一项服务来代替法兰绒。相反，您可以部署另一个CNI，它1)与法兰绒共存良好，2)提供网络策略功能。使用Calico进行网络策略是<a class="ae jc" href="https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengsettingupcalico.htm" rel="noopener ugc nofollow" target="_blank">与OKE </a>的良好记录。它已经使用<a class="ae jc" href="https://lmukadam.medium.com/installing-and-using-calico-on-oracle-container-engine-oke-c61c12608cb6" rel="noopener">有一段时间了</a>，它也是<a class="ae jc" href="https://github.com/oracle-terraform-modules/terraform-oci-oke/blob/main/docs/instructions.adoc#installing-calico" rel="noopener ugc nofollow" target="_blank">地形模块上的一个选项</a>。</p><p id="e176" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">但是今天我们将探索一种新的CNI:纤毛。你会问，为什么是纤毛？首先，我的队友舍伍德·泽恩已经谈论它很久了。事实上，他一直没有停止谈论这件事。另一方面，我想探索它的一些特点，特别是eBPF。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/5cdb9a135e9a398dc93c50b5cd0ab850.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iV29e8BAqAm-mSVc7qm9JA.png"/></div></div></figure><p id="47f9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在本文中，我们将了解以下内容:</p><ol class=""><li id="bb8d" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb jv jw jx jy bi translated">如何在OKE上部署纤毛作为CNI</li><li id="0e2d" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">如何使用Cilium实现Kubernetes网络策略</li><li id="9410" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb jv jw jx jy bi translated">利用哈勃、普罗米修斯和格拉夫纳的可观测性</li></ol><h2 id="4fca" class="ke kf hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">在OKE上安装纤毛作为CNI</h2><p id="81d0" class="pw-post-body-paragraph ie if hh ig b ih kz ij ik il la in io ip lb ir is it lc iv iw ix ld iz ja jb ha bi translated">使用您认为合适的任何方式来配置OKE集群:OCI控制台快速创建、<a class="ae jc" href="https://github.com/oracle-terraform-modules/terraform-oci-oke" rel="noopener ugc nofollow" target="_blank"> Terraform OKE模块</a>或命令行。如果您使用OCI控制台，请确保选择自定义创建&gt;法兰绒覆盖:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es le"><img src="../Images/186b0cacbdc7baa3829210428beaca3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uHxHClI_ZAROGvZKFMWeTQ.png"/></div></div></figure><p id="1bc9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这一点上，如果您只是好奇并想尝试一下，您可以为API端点分配一个公共IP地址。如果您仍然希望使用私有端点，那么您需要能够在某个时候访问您的API服务器(至少对于本文来说是这样)。如果是这种情况，<a class="ae jc" href="https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengdownloadkubeconfigfile.htm" rel="noopener ugc nofollow" target="_blank">检查您的集群访问选项</a>或者您可以使用<a class="ae jc" href="https://github.com/oracle-terraform-modules/terraform-oci-oke" rel="noopener ugc nofollow" target="_blank"> Terraform OKE模块</a>并使用instance_principal启用操作员主机。</p><p id="c7d5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">对于节点池，请确保至少有一个包含至少两个工作节点的节点池。这是因为默认情况下，纤毛部署2个副本。如果您使用的是<a class="ae jc" href="https://github.com/oracle-terraform-modules/terraform-oci-oke" rel="noopener ugc nofollow" target="_blank"> Terraform OKE模块</a>，您可以使用以下要点中的示例代码:</p><p id="e7cd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><a class="ae jc" href="https://gist.githubusercontent.com/hyder/030c2c66bd07b1cd65dd27e8009844b1/raw/4f0a38e61f91d95ac9ff1a89eead8478ad4815eb/cluster.tf" rel="noopener ugc nofollow" target="_blank">https://gist . githubusercontent . com/Hyder/030 C2 c 66 BD 07 B1 CD 65 DD 27 e 8009844 b 1/raw/4 f 0 a 38 e 61 f 91d 95 AC 9 ff 1 a 89 eead 8478 ad 4815 EB/cluster . TF</a></p><p id="1f0c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在terraform.tfvars中填入值，运行terraform init并应用，然后等待集群创建完成。从这里开始，我假设您正在使用<a class="ae jc" href="https://github.com/oracle-terraform-modules/terraform-oci-oke" rel="noopener ugc nofollow" target="_blank"> Terraform OKE模块</a>，并且您已经启用了操作员。ssh到操作员，并检查您是否能够到达API服务器。请注意操作主机上kubectl的方便的缩写别名(k，h ):</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="3fe8" class="lk kf hh lg b be ll lm l ln lo">[opc@dev-operator ~]$ k get nodes<br/>NAME          STATUS   ROLES   AGE   VERSION<br/>10.0.108.37   Ready    node    54m   v1.23.4<br/>10.0.93.111   Ready    node    54m   v1.23.4</span></pre><p id="8189" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">添加cilium helm repo并在本地生成清单以供编辑:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="497e" class="lk kf hh lg b be ll lm l ln lo">helm repo add cilium https://helm.cilium.io/<br/>helm show values cilium/cilium &gt; cilium.yaml</span></pre><p id="5952" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">修改cilium.yaml并将默认值更改为以下值:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="525e" class="lk kf hh lg b be ll lm l ln lo">containerRuntime:<br/>  integration: crio<br/>hubble:<br/>  tls:<br/>    enabled: false<br/>hubble:<br/>  relay:<br/>    enabled: true<br/>hubble:<br/>  ui:<br/>    enabled: true<br/>ipam:<br/>  mode: "kubernetes"<br/>clustermesh:<br/>  useAPIServer: true</span></pre><p id="db85" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">安装纤毛:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="ca11" class="lk kf hh lg b be ll lm l ln lo">helm install cilium cilium/cilium --namespace=kube-system -f cilium.yaml</span></pre><p id="56f3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下载cilium cli:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="3f6c" class="lk kf hh lg b be ll lm l ln lo">CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/master/stable.txt)<br/>CLI_ARCH=amd64<br/>if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi<br/>curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}<br/>sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum<br/>sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin<br/>rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}</span></pre><p id="682f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">并检查状态。此时，您会得到一些错误，因为有些pod尚未被cilium管理，可能是因为它们在Cilium本身运行之前就已启动:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="5f1f" class="lk kf hh lg b be ll lm l ln lo">[opc@dev-operator ~]$ cilium status<br/>    /¯¯\<br/> /¯¯\__/¯¯\    Cilium:         OK<br/> \__/¯¯\__/    Operator:       OK<br/> /¯¯\__/¯¯\    Hubble:         1 errors<br/> \__/¯¯\__/    ClusterMesh:    disabled<br/>    \__/<br/>DaemonSet         cilium             Desired: 2, Ready: 2/2, Available: 2/2<br/>Deployment        hubble-ui          Desired: 1, Ready: 1/1, Available: 1/1<br/>Deployment        hubble-relay       Desired: 1, Unavailable: 1/1<br/>Deployment        cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2<br/>Containers:       cilium             Running: 2<br/>                  hubble-ui          Running: 1<br/>                  hubble-relay       Running: 1<br/>                  cilium-operator    Running: 2<br/>Cluster Pods:     2/5 managed by Cilium<br/>Image versions    cilium             quay.io/cilium/cilium:v1.12.0@sha256:079baa4fa1b9fe638f96084f4e0297c84dd4fb215d29d2321dcbe54273f63ade: 2<br/>                  hubble-ui          quay.io/cilium/hubble-ui-backend:v0.9.0@sha256:000df6b76719f607a9edefb9af94dfd1811a6f1b6a8a9c537cba90bf12df474b: 1<br/>                  hubble-ui          quay.io/cilium/hubble-ui:v0.9.0@sha256:0ef04e9a29212925da6bdfd0ba5b581765e41a01f1cc30563cef9b30b457fea0: 1<br/>                  hubble-relay       quay.io/cilium/hubble-relay:v1.12.0@sha256:ca8033ea8a3112d838f958862fa76c8d895e3c8d0f5590de849b91745af5ac4d: 1<br/>                  cilium-operator    quay.io/cilium/operator-generic:v1.12.0@sha256:bb2a42eda766e5d4a87ee8a5433f089db81b72dd04acf6b59fcbb445a95f9410: 2<br/>Errors:           hubble-relay       hubble-relay    1 pods of Deployment hubble-relay are not ready</span></pre><p id="7fbb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意只有2/5的荚果是由纤毛控制的。我们需要确保它们都由纤毛控制。让我们去猎杀那些没有的。Cilium非常有用地提供了一个脚本来帮助您识别它们:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="25de" class="lk kf hh lg b be ll lm l ln lo">curl -sLO https://raw.githubusercontent.com/cilium/cilium/master/contrib/k8s/k8s-unmanaged.sh<br/>chmod +x k8s-unmanaged.sh</span></pre><p id="9b9f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您将得到类似下面的输出:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="ed01" class="lk kf hh lg b be ll lm l ln lo">[opc@dev-operator ~]$ ./k8s-unmanaged.sh<br/>Skipping pods with host networking enabled...<br/>error: the server doesn't have a resource type "cep"<br/>kube-system/coredns-5695dcc5cf-44rm6<br/>kube-system/coredns-5695dcc5cf-pwj9g<br/>kube-system/hubble-relay-859488fdc9-h6d75<br/>kube-system/hubble-ui-5cbf89dcff-7nqvj<br/>kube-system/kube-dns-autoscaler-6d89b5d4c-x92wz</span></pre><p id="200e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">删除上面的窗格并重新创建它们:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="b9f7" class="lk kf hh lg b be ll lm l ln lo">kubectl -n kube-system delete pod &lt;pod-name-1&gt; &lt;pod-name-2&gt;</span></pre><p id="9554" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">再次检查状态，所有指示灯都应该为绿色，并且所有pod现在都应该由纤毛管理:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="1173" class="lk kf hh lg b be ll lm l ln lo">cilium status</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lp"><img src="../Images/8f9cdcd0c94d5a9f460def77ab2585bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p06k22gGYxNYk5TIkK_aMA.png"/></div></div></figure><p id="a7fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">此时，我们可以将法兰绒daemonset移除，因为我们不需要它:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="d188" class="lk kf hh lg b be ll lm l ln lo">kubectl delete -n kube-system daemonset kube-flannel-ds</span></pre><p id="9e21" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们横向扩展节点池，使其规模翻倍至4。我们的纤毛状态应该还是全绿。是的，它是:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lq"><img src="../Images/abbfc5ea022fb6876543892678c5c93c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iw46xvsObmfF0Fp5tie6cg.png"/></div></div></figure><p id="6d3e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们现在可以运行连通性测试:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="0b92" class="lk kf hh lg b be ll lm l ln lo">cilium connectivity test</span></pre><p id="46e3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们所有的测试都应该通过:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lr"><img src="../Images/02262730ddbfd4c71b0057e6a52c7557.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TrI8796A3-Ks6EHKMxdvHg.png"/></div></div></figure><p id="88e1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在让我们测试一下Hubble UI。如果您创建了一个公共集群，并且所有的kubectl/helm都是在本地完成的，那么您只需运行hubble UI，如下所示:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="dfff" class="lk kf hh lg b be ll lm l ln lo">cilium hubble ui</span></pre><p id="cf8f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">cilium cli将自动设置必要的端口转发，并在本地打开浏览器。如果您通过operator进行所有的交互，请打开一个新的终端并对其进行ssh，如下所示，以创建一个隧道:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="e201" class="lk kf hh lg b be ll lm l ln lo">ssh -i ~/.ssh/id_rsa -J opc@&lt;bastion-ip&gt; opc@&lt;operator-ip&gt; -L 8080:localhost:8080 -L 8081:localhost:8081 </span></pre><p id="9e25" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">登录后，获取Hubble UI pod的名称，并使用kubectl对其进行端口转发:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="492b" class="lk kf hh lg b be ll lm l ln lo">POD_NAME=$(kubectl -n kube-system get pod --selector=k8s-app=hubble-ui  -o jsonpath='{.items[*].metadata.name}')<br/>kubectl -n kube-system port-forward $POD_NAME 8081:8081</span></pre><p id="333e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在您的浏览器上，通过端口8081:<a class="ae jc" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank">http://localhost:808</a>1访问Hubble UI。在单独的终端上，再次运行连通性测试，并在Hubble UI中选择cilium-test名称空间:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ls"><img src="../Images/a50ad02f58588c298d4275f2b2ff5748.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-fR7Cc7VHO5zityPSTTzvA.png"/></div></div></figure><p id="b9dc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">纤毛现在在OKE完全可以使用。</p><h2 id="d327" class="ke kf hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">测试网络策略</h2><p id="2aff" class="pw-post-body-paragraph ie if hh ig b ih kz ij ik il la in io ip lb ir is it lc iv iw ix ld iz ja jb ha bi translated">现在让我们测试一个<a class="ae jc" href="https://github.com/ahmetb/kubernetes-network-policy-recipes/blob/master/01-deny-all-traffic-to-an-application.md" rel="noopener ugc nofollow" target="_blank">拒绝所有的简单网络策略</a>。运行一个带有标签<em class="jd"> app=web </em>的nginx Pod，并将其暴露在端口80:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="ebee" class="lk kf hh lg b be ll lm l ln lo">kubectl run web --image=nginx --labels="app=web" --expose --port=80</span></pre><p id="a7f0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">运行临时Pod并向"<em class="jd">web "</em>服务发出请求:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="454a" class="lk kf hh lg b be ll lm l ln lo">kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh<br/>If you don't see a command prompt, try pressing enter.<br/>/ # wget -qO- http://web<br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br/>&lt;style&gt;<br/>html { color-scheme: light dark; }<br/>body { width: 35em; margin: 0 auto;<br/>font-family: Tahoma, Verdana, Arial, sans-serif; }<br/>&lt;/style&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;<br/>&lt;p&gt;If you see this page, the nginx web server is successfully installed and<br/>working. Further configuration is required.&lt;/p&gt;<br/>&lt;p&gt;For online documentation and support please refer to<br/>&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;<br/>Commercial support is available at<br/>&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;<br/>&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="b990" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们得到回应。在Hubble UI中，我们还可以看到正在转发的流量:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lt"><img src="../Images/fa6a1219a9849fa39d85a05b9dc3cfd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GxdIjcgpw28SCMm8A1loCg.png"/></div></div></figure><p id="1d60" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，让我们创建一个拒绝所有流量的网络策略:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="f10a" class="lk kf hh lg b be ll lm l ln lo">kind: NetworkPolicy<br/>apiVersion: networking.k8s.io/v1<br/>metadata:<br/>  name: web-deny-all<br/>spec:<br/>  podSelector:<br/>    matchLabels:<br/>      app: web<br/>  ingress: []</span></pre><p id="9d88" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">将它保存到web-deny-all.yaml并应用它:</p><pre class="jf jg jh ji fd lf lg lu lv aw lw bi"><span id="4b3f" class="ke kf hh lg b fi lx ly l lz lo">kubectl apply -f web-deny-all.yaml</span><span id="5918" class="ke kf hh lg b fi ma ly l lz lo">networkpolicy.networking.k8s.io/web-deny-all created</span></pre><p id="24de" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在临时窗格中，再次运行命令来访问nginx，但设置2s超时:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="fe3c" class="lk kf hh lg b be ll lm l ln lo">wget -qO- --timeout=2 http://web</span></pre><p id="b307" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这一次，超时了。在Hubble UI流日志中，我们还看到流量被丢弃:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mb"><img src="../Images/95feac835172699d68c6988ad3777a8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KUNMvxu86T1WrcWQk38rVQ.png"/></div></div><figcaption class="mc md et er es me mf bd b be z dx">Traffic dropped</figcaption></figure><p id="3f27" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">您可以尝试使用<a class="ae jc" href="https://github.com/ahmetb/kubernetes-network-policy-recipes" rel="noopener ugc nofollow" target="_blank">其他网络策略</a>或Cilium自己的<a class="ae jc" href="https://docs.cilium.io/en/stable/gettingstarted/#network-policy-security-tutorials" rel="noopener ugc nofollow" target="_blank">网络策略教程</a>来了解使用Cilium进行网络策略的可能性。</p><p id="00cd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">删除您创建的网络策略，以便我们继续本练习的第3部分，例如</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="874a" class="lk kf hh lg b be ll lm l ln lo">kubectl delete -f web-deny-all.yaml</span></pre><h2 id="63e8" class="ke kf hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">捕获网络指标</h2><p id="e128" class="pw-post-body-paragraph ie if hh ig b ih kz ij ik il la in io ip lb ir is it lc iv iw ix ld iz ja jb ha bi translated">我们想做的最后一点是了解我们的网络是如何运作的。首先，我们需要安装普罗米修斯和格拉夫纳。我们将使用<a class="ae jc" href="https://artifacthub.io/packages/helm/prometheus-community/kube-prometheus-stack" rel="noopener ugc nofollow" target="_blank"> kube-prometheus-stack </a>。</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="1ef4" class="lk kf hh lg b be ll lm l ln lo">helm repo add prometheus-community https://prometheus-community.github.io/helm-charts<br/><br/>helm repo update<br/><br/>helm show values prometheus-community/kube-prometheus-stack &gt; kube-prometheus-stack.yaml</span></pre><p id="62bb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">编辑kube-prometheus-stack.yaml并更改以下内容:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="447a" class="lk kf hh lg b be ll lm l ln lo">prometheus:<br/>  prometheusSpec:<br/>    serviceMonitorSelectorNilUsesHelmValues: false</span></pre><p id="b335" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">并使用helm安装kube-prometheus-stack图表:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="9584" class="lk kf hh lg b be ll lm l ln lo">helm install kps --namespace monitoring prometheus-community/kube-prometheus-stack -f kube-prometheus-stack.yaml --create-namespace</span></pre><p id="ae8c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，编辑cilium.yaml并更改以下内容:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="48e3" class="lk kf hh lg b be ll lm l ln lo">prometheus:<br/>  enabled: true<br/>prometheus:<br/>  serviceMonitor:<br/>    enabled: true<br/>operator:<br/>  prometheus:<br/>    enabled: true<br/>operator:<br/>  prometheus:<br/>    serviceMonitor:<br/>      enabled: true<br/>hubble:<br/>  metrics:<br/>    enabled:<br/>    - dns<br/>    - drop<br/>    - tcp<br/>    - flow<br/>    - icmp<br/>    - http<br/>hubble:<br/>  metrics:<br/>    serviceMonitor:<br/>      enabled: true<br/>hubble:<br/>  relay:<br/>    prometheus:<br/>      enabled: true<br/>hubble:<br/>  relay:<br/>    prometheus:<br/>      serviceMonitor:<br/>        enabled: true</span></pre><p id="ce03" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">使用包含以下指标的新配置升级helm版本:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="0e64" class="lk kf hh lg b be ll lm l ln lo">helm upgrade cilium cilium/cilium --namespace=kube-system -f cilium.yaml</span></pre><p id="bcd5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">部署完成后，将端口转发到Prometheus服务:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="6e9b" class="lk kf hh lg b be ll lm l ln lo">kubectl -n monitoring port-forward svc/kps-kube-prometheus-stack-prometheus 8080:9090</span></pre><p id="6d0c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">并且在另一个终端上连接到grafana服务:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="3f47" class="lk kf hh lg b be ll lm l ln lo">kubectl -n monitoring port-forward svc/kps-grafana 8081:80</span></pre><p id="8e8e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要访问Prometheus UI以便试验Prometheus查询，请在<a class="ae jc" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080/ </a>上打开浏览器，要访问Grafana，请在<a class="ae jc" href="http://localhost:8081." rel="noopener ugc nofollow" target="_blank"> http://localhost:8081上打开浏览器。</a>使用默认的Grafana用户名&amp;密码登录:admin/prom-operator。然后导入具有以下id的仪表板:</p><ul class=""><li id="fdae" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb mg jw jx jy bi translated">15513:【https://grafana.com/grafana/dashboards/15513】T4</li><li id="73c0" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb mg jw jx jy bi translated">15514:<a class="ae jc" href="https://grafana.com/grafana/dashboards/15514" rel="noopener ugc nofollow" target="_blank">https://grafana.com/grafana/dashboards/15514</a></li><li id="cb40" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb mg jw jx jy bi translated">15515:<a class="ae jc" href="https://grafana.com/grafana/dashboards/15515" rel="noopener ugc nofollow" target="_blank">https://grafana.com/grafana/dashboards/15515</a></li></ul><p id="4532" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Prometheus上，您应该能够看到纤毛指标和目标:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mh"><img src="../Images/f5d90a24e6845c04633ec74cebc01ac5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*K1aWJR3kfA1cTwjpnrS9Yw.png"/></div></figure><p id="c9fd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">再次运行cilium连接测试以生成一些流量:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="3376" class="lk kf hh lg b be ll lm l ln lo">cilium connectivity test</span></pre><p id="3ec9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Prometheus的图形页面上，输入以下查询并点击执行:</p><pre class="jf jg jh ji fd lf lg lh bn li lj bi"><span id="6d35" class="lk kf hh lg b be ll lm l ln lo">sum(rate(cilium_k8s_client_api_calls_total{k8s_app=”cilium”}[1m])) by (pod, method, return_code)</span></pre><p id="fd52" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">你应该能看到这样的图表:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mi"><img src="../Images/54ea9c55a8b874137d83b56d38787246.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4T_lk0JpmK1AYntdRFbDUA.png"/></div></div></figure><p id="e1a5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Grafana仪表盘上，您可以找到更多有趣的信息。例如，下面的截图显示了哈勃度量仪表板的一部分</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mj"><img src="../Images/605944f961c453b9255818ddd854e07c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fenq0JoVYoW72YAoPAqhvg.png"/></div></div><figcaption class="mc md et er es me mf bd b be z dx">Hubble metrics in Grafana</figcaption></figure><p id="e393" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">而下面的示例显示了Cilium Agent metrics仪表板的一部分:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mk"><img src="../Images/769573f4a4e71952116885664afc28ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZWznkCC_-4D8VYh22dXI5g.png"/></div></div><figcaption class="mc md et er es me mf bd b be z dx">Cilium Agent metrics in Grafana</figcaption></figure><p id="f129" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">虽然我可以猜测或查看<a class="ae jc" href="https://docs.cilium.io/en/stable/operations/metrics/" rel="noopener ugc nofollow" target="_blank">纤毛监测文档</a>，但我实际上不知道这些指标中的大多数意味着什么<em class="jd">还是</em>，但我喜欢我的图表(大部分)是填充的和丰富多彩的。更重要的是，他们告诉我法兰绒和纤毛在OKE上共存是可能的，这为我们的用户提供了选择和机会。</p><h2 id="2ca2" class="ke kf hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">摘要</h2><p id="2f8c" class="pw-post-body-paragraph ie if hh ig b ih kz ij ik il la in io ip lb ir is it lc iv iw ix ld iz ja jb ha bi translated">CNI是集装箱技术领域最具竞争力的细分市场之一。不同的玩家有一种或多种渴望，他们创造了一套真正迷人的网络项目。更不寻常的是，它们都遵守CNI规范，在某些情况下，共存得相当好，Oracle现在是NPN的成员之一。</p><p id="f902" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在未来几周，我们将更详细地了解NPN，以帮助用户进行规划和采用，同时完成其在<a class="ae jc" href="https://github.com/oracle-terraform-modules/terraform-oci-oke" rel="noopener ugc nofollow" target="_blank"> Terraform OKE模块</a>中的包含。现在，我希望你喜欢这篇关于纤毛的文章。</p><h2 id="543e" class="ke kf hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">确认</h2><p id="9241" class="pw-post-body-paragraph ie if hh ig b ih kz ij ik il la in io ip lb ir is it lc iv iw ix ld iz ja jb ha bi translated">我要感谢以下人员对本文做出的重要贡献:</p><ul class=""><li id="afee" class="jq jr hh ig b ih ii il im ip js it jt ix ju jb mg jw jx jy bi translated">舍伍德·泽恩</li><li id="ccf4" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb mg jw jx jy bi translated">德文·克劳斯</li><li id="76e6" class="jq jr hh ig b ih jz il ka ip kb it kc ix kd jb mg jw jx jy bi translated">阿维·米勒</li></ul><h2 id="ae77" class="ke kf hh bd kg kh ki kj kk kl km kn ko ip kp kq kr it ks kt ku ix kv kw kx ky bi translated">参考</h2><p id="0fef" class="pw-post-body-paragraph ie if hh ig b ih kz ij ik il la in io ip lb ir is it lc iv iw ix ld iz ja jb ha bi translated">https://antrea.io/的安特里亚CNI</p><p id="4cd4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">https://oracle.github.io/cluster-api-provider-oci/ OCI<a class="ae jc" href="https://oracle.github.io/cluster-api-provider-oci/" rel="noopener ugc nofollow" target="_blank">集群API</a></p><p id="e260" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">纤毛文件:【https://docs.cilium.io/en/stable/ T4】</p><p id="3c0c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">纤毛舵图:<a class="ae jc" href="https://artifacthub.io/packages/helm/cilium/cilium" rel="noopener ugc nofollow" target="_blank">https://artifacthub.io/packages/helm/cilium/cilium</a></p><p id="a72a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">法兰绒的工作原理:<a class="ae jc" href="https://www.sobyte.net/post/2022-07/k8s-flannel/" rel="noopener ugc nofollow" target="_blank">https://www.sobyte.net/post/2022-07/k8s-flannel/</a></p><p id="ae8f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Kube Prometheus Stack Helm图表:<a class="ae jc" href="https://artifacthub.io/packages/helm/prometheus-community/kube-prometheus-stack" rel="noopener ugc nofollow" target="_blank">https://artifact hub . io/packages/Helm/Prometheus-community/kube-Prometheus-Stack</a></p><p id="883d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Kubernetes生态系统的状态:第一版、第二版:<a class="ae jc" href="https://thenewstack.io/ebooks/kubernetes/state-of-kubernetes-ecosystem-second-edition-2020" rel="noopener ugc nofollow" target="_blank">https://thenewstack . io/ebooks/Kubernetes/State-of-Kubernetes-Ecosystem-second-edition-2020</a></p><p id="725b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注册我们的<a class="ae jc" href="https://signup.cloud.oracle.com/?language=en&amp;sourceType=:ex:tb:::::&amp;SC=:ex:tb:::::&amp;pcode=" rel="noopener ugc nofollow" target="_blank">免费等级</a>来玩一把吧。</p><p id="5e2c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">有问题吗？让我们在<a class="ae jc" href="https://bit.ly/devrel_slack" rel="noopener ugc nofollow" target="_blank">公共开发者松弛通道</a>上讨论吧！</p></div></div>    
</body>
</html>