<html>
<head>
<title>GCP Workload Identity Federation on Gitlab Passing Authentication between Jobs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Gitlab上的GCP工作负载身份联合通过作业之间的身份验证</h1>
<blockquote>原文：<a href="https://medium.com/compendium/gcp-workload-identity-federation-on-gitlab-passing-authentication-between-jobs-ffaa2d51be2c?source=collection_archive---------2-----------------------#2022-11-30">https://medium.com/compendium/gcp-workload-identity-federation-on-gitlab-passing-authentication-between-jobs-ffaa2d51be2c?source=collection_archive---------2-----------------------#2022-11-30</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/d79f2b8b976f63e00c022918a789d910.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Gtp30FvRX5GF9_VJVfmSg.png"/></div></div></figure><p id="897d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">git lab(2022年末)对于工作负载身份联合来说是一个相对较新的东西，目前还没有太多好的模板或指南。官方指南解释了如何设置联合池并使用它进行认证，但没有真正解释如何在企业管道中使用它。一个经常出现的基本问题是如何将身份验证传递给管道中的其他作业。</p><p id="2519" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">例如，假设您正在将基础架构作为代码进行开发，并且有一个相对简单的工作流，如下所示:</p><p id="4f5e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">认证→验证→计划→应用</p><p id="52f0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><a class="ae jn" href="https://stackoverflow.com/questions/74505435/403-trying-to-run-terraform-from-gitlab-without-json-file" rel="noopener ugc nofollow" target="_blank">一种简单的方法</a>是验证并假设验证/计划/应用也知道上下文。它不…</p><p id="7360" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您将凭证作为一个秘密，那么它将对所有4个作业都可用，一个常见的做法是将GOOGLE_APPLICATION_CREDENTIALS设置为该JSON，然后默认情况下所有作业都将被认证。</p><p id="77fa" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">但是，当我们使用工作负载身份联合时，我们不再拥有那个秘密，事实上，我们在进行身份验证时创建了那个秘密！如果你已经习惯了Github的动作，这就是他们如何做的，在Gitlab上做应该很简单…对吗？</p><p id="98da" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">不完全是。</p><p id="b581" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在撰写本文时，还没有stackoverflows、博客帖子或指南来说明如何以一种好的方式做到这一点。<a class="ae jn" href="https://gitlab.com/guided-explorations/gcp/configure-openid-connect-in-gcp" rel="noopener ugc nofollow" target="_blank">官方的Gitlab例子非常简单，假设你应该在每一步进行认证</a>。</p><p id="76ec" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">那么我们如何解决这个问题呢？</p><p id="76ae" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">概念是这样的:当我们通过gcloud使用workload identity federation进行身份验证时，我们实际上获得了一个JSON(就像一个服务帐户)和一个令牌，我们可以在我们的管道下游使用它。我们需要做的是将JSON和令牌作为工件向下游传递。</p><ol class=""><li id="c6b0" class="jo jp hh ir b is it iw ix ja jq je jr ji js jm jt ju jv jw bi translated">鉴定—使用gcloud Docker映像，将文件写入共享文件夹</li><li id="52b2" class="jo jp hh ir b is jx iw jy ja jz je ka ji kb jm jt ju jv jw bi translated">验证—使用Terraform Docker映像，使用来自共享的凭据</li><li id="3ac5" class="jo jp hh ir b is jx iw jy ja jz je ka ji kb jm jt ju jv jw bi translated">计划—使用Terraform Docker映像，使用来自共享的凭据</li><li id="f583" class="jo jp hh ir b is jx iw jy ja jz je ka ji kb jm jt ju jv jw bi translated">应用—使用Terraform Docker图像。，使用共享中的凭据和计划</li></ol><p id="61c0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为此，我定义了一个_auth/ shared文件夹来在作业之间传递(Gitlab术语—工件)。</p><h1 id="e5cd" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">证明</h1><p id="90c0" class="pw-post-body-paragraph ip iq hh ir b is la iu iv iw lb iy iz ja lc jc jd je ld jg jh ji le jk jl jm ha bi translated">我创建了一个使用gcloud进行身份验证的身份验证作业。</p><p id="6965" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这项工作需要3个参数(环境变量)</p><p id="279e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">服务帐户电子邮件—是服务帐户的电子邮件地址(如name@gcp-project.iam.gserviceaccount.com)</p><p id="04b6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">WORKLOAD_IDENTITY_PROVIDER —在此表单上:projects/PROJECT _ NUMBER/locations/global/workloadIdentityPools/POOL _ NAME/providers/PROVIDER _ ID</p><p id="b0f2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">GOOGLE _ CLOUD _ PROJECT要设置为默认值的GCP项目id。</p><pre class="lf lg lh li fd lj lk ll bn lm ln bi"><span id="648f" class="lo kd hh lk b be lp lq l lr ls">.gcp-auth:<br/>  image: "google/cloud-sdk:slim"<br/>  artifacts:<br/>    paths:<br/>      - _auth/<br/>  script:<br/>    - |<br/>      if [ -z "${SERVICE_ACCOUNT_EMAIL}" ]; then<br/>        echo "MISSING SERVICE_ACCOUNT_EMAIL variable. (expected: full email of service account)"<br/>        exit 1<br/>      fi      <br/>      if [ -z "${WORKLOAD_IDENTITY_PROVIDER}" ]; then<br/>        echo "MISSING WORKLOAD_IDENTITY_PROVIDER variable (expected: projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_NAME/providers/PROVIDER_ID)"<br/>        exit 1<br/>      fi      <br/>      if [ -z "${GOOGLE_CLOUD_PROJECT}" ]; then<br/>        echo "MISSING GOOGLE_CLOUD_PROJECT variable.  (expected: gcp project id)"<br/>        exit 1<br/>      fi      <br/>      mkdir -p _auth <br/>      echo "$CI_JOB_JWT_V2" &gt; $CI_PROJECT_DIR/_auth/.ci_job_jwt_file<br/>      echo "$GOOGLE_CLOUD_PROJECT" &gt; $CI_PROJECT_DIR/_auth/.GOOGLE_CLOUD_PROJECT<br/>      gcloud iam workload-identity-pools create-cred-config \<br/>      $WORKLOAD_IDENTITY_PROVIDER \<br/>      --service-account=$SERVICE_ACCOUNT_EMAIL \<br/>      --service-account-token-lifetime-seconds=600 \<br/>      --output-file=$CI_PROJECT_DIR/_auth/.gcp_temp_cred.json \<br/>      --credential-source-file=$CI_PROJECT_DIR/_auth/.ci_job_jwt_file<br/>      gcloud config set project $GOOGLE_CLOUD_PROJECT<br/>    - !reference [.gcp_ensure_auth_script, before]<br/>    - "gcloud auth login --cred-file=$GOOGLE_APPLICATION_CREDENTIALS"</span></pre><p id="0e4a" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如您所见，它将_auth/ folder设置为工件，在作业之间传递，并将项目id、令牌和JWT转储到这个文件夹中。</p><h1 id="9a03" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">将（行星）地球化（以适合人类居住）</h1><p id="0d54" class="pw-post-body-paragraph ip iq hh ir b is la iu iv iw lb iy iz ja lc jc jd je ld jg jh ji le jk jl jm ha bi translated">为了简化Terraform步骤，我为Terraform创建了一个基本作业，它知道gcp身份验证状态，我只需要在我的主管道中扩展它。这给了我在Terraform脚本中做任何事情的灵活性。例如，我可以创建一个一步到位的计划&amp;申请，而不是像我现在这样分成3个部分。</p><pre class="lf lg lh li fd lj lk ll bn lm ln bi"><span id="f832" class="lo kd hh lk b be lp lq l lr ls"><br/>.terraform:<br/>  extends: .gcp-auth<br/>  image:<br/>    name: hashicorp/terraform:1.3.5<br/>    entrypoint:<br/>      - '/usr/bin/env'<br/>      - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'<br/>  artifacts:<br/>    paths:<br/>      - planfile<br/>      - _auth/<br/>  before_script:<br/>    - !reference [.gcp_ensure_auth_script, before]<br/>    - *tf_before_script</span></pre><h1 id="6336" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">示例管道</h1><p id="04a3" class="pw-post-body-paragraph ip iq hh ir b is la iu iv iw lb iy iz ja lc jc jd je ld jg jh ji le jk jl jm ha bi translated">如果您已经设置了工作负载身份联邦，那么这个示例应该或多或少是现成的。用适合你的用例的东西替换变量！</p><pre class="lf lg lh li fd lj lk ll bn lm ln bi"><span id="93b6" class="lo kd hh lk b be lp lq l lr ls">include:<br/>  - local: '/.gitlab-gcp-auth.yml'<br/><br/>stages:<br/>  - auth<br/>  - validate<br/>  - plan<br/>  - apply<br/><br/>auth:<br/>  extends: .gcp-auth<br/>  stage: auth<br/>  variables:<br/>     SERVICE_ACCOUNT_EMAIL: "terraform@foo.iam.gserviceaccount.com"<br/>     WORKLOAD_IDENTITY_PROVIDER: "projects/123123/locations/global/workloadIdentityPools/gitlab-pool/providers/gitlab-provider"<br/>     GOOGLE_CLOUD_PROJECT: "example"<br/><br/>validate:<br/>  extends: .terraform<br/>  stage: validate<br/>  variables:<br/>     TF_BACKEND_CONFIG: "bucket=yoursecretstatebucket"<br/>  script:<br/>    - terraform validate<br/>  only:<br/>    refs:<br/>      - main<br/><br/>plan:<br/>  extends: .terraform<br/>  stage: plan<br/>  variables:<br/>     TF_BACKEND_CONFIG: "bucket=your-terraform-state"<br/>  script:<br/>    - terraform plan -out ../planfile -input=false -var-file=env/main.tfvars<br/>  dependencies:<br/>    - validate<br/>  only:<br/>    refs:<br/>      - main<br/><br/>apply:<br/>  extends: .terraform<br/>  stage: apply<br/>  variables:<br/>     TF_BACKEND_CONFIG: "bucket=your-terraform-state"<br/>  script:<br/>    - terraform apply -input=false ../planfile -var-file=env/main.tfvars<br/>  dependencies:<br/>    - plan<br/>    - auth<br/>  when: manual<br/>  only:<br/>    refs:<br/>      - main</span></pre><h1 id="b213" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">。gitlab-gcp-auth.yml</h1><p id="43d8" class="pw-post-body-paragraph ip iq hh ir b is la iu iv iw lb iy iz ja lc jc jd je ld jg jh ji le jk jl jm ha bi translated">为了方便起见，我在这里包含了完整的文件。随意剪切粘贴，随心所欲使用。</p><pre class="lf lg lh li fd lj lk ll bn lm ln bi"><span id="aff1" class="lo kd hh lk b be lp lq l lr ls">.gcp_ensure_auth_script:<br/>  before:<br/>    - |<br/>      if [ ! -d "$CI_PROJECT_DIR/_auth" ]; then<br/>         echo "Missing auth folder, please make sure your job defines _auth as an artifact!"<br/>         exit 1<br/>      fi<br/>    - export GOOGLE_APPLICATION_CREDENTIALS=$CI_PROJECT_DIR/_auth/.gcp_temp_cred.json<br/>    - export CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE=$CI_PROJECT_DIR/_auth/.gcp_temp_cred.json<br/>    - export GOOGLE_GHA_CREDS_PATH=$CI_PROJECT_DIR/_auth/.gcp_temp_cred.json<br/>    - export GOOGLE_CLOUD_PROJECT=$(cat $CI_PROJECT_DIR/_auth/.GOOGLE_CLOUD_PROJECT)<br/>    - export CLOUDSDK_PROJECT=$(cat $CI_PROJECT_DIR/_auth/.GOOGLE_CLOUD_PROJECT)<br/>    - export CLOUDSDK_CORE_PROJECT=$(cat $CI_PROJECT_DIR/_auth/.GOOGLE_CLOUD_PROJECT)<br/>    - export GCP_PROJECT=$(cat $CI_PROJECT_DIR/_auth/.GOOGLE_CLOUD_PROJECT)<br/>    - export GCLOUD_PROJECT=$(cat $CI_PROJECT_DIR/_auth/.GOOGLE_CLOUD_PROJECT)<br/><br/>.gcp-auth:<br/>  image: "google/cloud-sdk:slim"<br/>  artifacts:<br/>    paths:<br/>      - _auth/<br/>  script:<br/>    - |<br/>      if [ -z "${SERVICE_ACCOUNT_EMAIL}" ]; then<br/>        echo "MISSING SERVICE_ACCOUNT_EMAIL variable. (expected: full email of service account)"<br/>        exit 1<br/>      fi      <br/>      if [ -z "${WORKLOAD_IDENTITY_PROVIDER}" ]; then<br/>        echo "MISSING WORKLOAD_IDENTITY_PROVIDER variable (expected: projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_NAME/providers/PROVIDER_ID)"<br/>        exit 1<br/>      fi      <br/>      if [ -z "${GOOGLE_CLOUD_PROJECT}" ]; then<br/>        echo "MISSING GOOGLE_CLOUD_PROJECT variable.  (expected: gcp project id)"<br/>        exit 1<br/>      fi      <br/>      mkdir -p _auth <br/>      echo "$CI_JOB_JWT_V2" &gt; $CI_PROJECT_DIR/_auth/.ci_job_jwt_file<br/>      echo "$GOOGLE_CLOUD_PROJECT" &gt; $CI_PROJECT_DIR/_auth/.GOOGLE_CLOUD_PROJECT<br/>      gcloud iam workload-identity-pools create-cred-config \<br/>      $WORKLOAD_IDENTITY_PROVIDER \<br/>      --service-account=$SERVICE_ACCOUNT_EMAIL \<br/>      --service-account-token-lifetime-seconds=600 \<br/>      --output-file=$CI_PROJECT_DIR/_auth/.gcp_temp_cred.json \<br/>      --credential-source-file=$CI_PROJECT_DIR/_auth/.ci_job_jwt_file<br/>      gcloud config set project $GOOGLE_CLOUD_PROJECT<br/>    - !reference [.gcp_ensure_auth_script, before]<br/>    - "gcloud auth login --cred-file=$GOOGLE_APPLICATION_CREDENTIALS"<br/><br/><br/>.gcp-ensure-auth:<br/>  artifacts:<br/>    paths:<br/>      - _auth/<br/>  before_script:<br/>    - !reference [ .gcp_ensure_auth_script, before ]<br/><br/>.tf_before_script: &amp;tf_before_script<br/>  - |<br/>    if [ -z "${TF_BACKEND_CONFIG}" ]; then<br/>       echo "Missing TF_BACKEND_CONFIG, expected bucket=value"<br/>       exit 1<br/>    fi<br/>  - rm -rf .terraform<br/>  - terraform --version<br/>  - terraform init -backend-config="$TF_BACKEND_CONFIG"<br/><br/><br/>.terraform:<br/>  extends: .gcp-auth<br/>  image:<br/>    name: hashicorp/terraform:1.3.5<br/>    entrypoint:<br/>      - '/usr/bin/env'<br/>      - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'<br/>  artifacts:<br/>    paths:<br/>      - planfile<br/>      - _auth/<br/>  before_script:<br/>    - !reference [.gcp_ensure_auth_script, before]<br/>    - *tf_before_script</span></pre><p id="91f3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">注意，这个例子只知道一种环境，所以您必须针对真实的用例进行调整。您可能还想设置_auth工件的生命周期。</p><p id="0475" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果这对你有用，请鼓掌，或者如果有更好的方法，请给出评论！</p><h1 id="0c2a" class="kc kd hh bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">我检查的链接:</h1><p id="0e41" class="pw-post-body-paragraph ip iq hh ir b is la iu iv iw lb iy iz ja lc jc jd je ld jg jh ji le jk jl jm ha bi translated">在写我自己的文章之前，我做了很多谷歌搜索，所以所有这些链接都在某种程度上启发了我。</p><div class="lt lu ez fb lv lw"><a href="https://stackoverflow.com/questions/74505435/403-trying-to-run-terraform-from-gitlab-without-json-file" rel="noopener  ugc nofollow" target="_blank"><div class="lx ab dw"><div class="ly ab lz cl cj ma"><h2 class="bd hi fi z dy mb ea eb mc ed ef hg bi translated">403试图在没有json文件的情况下从Gitlab运行terraform</h2><div class="md l"><h3 class="bd b fi z dy mb ea eb mc ed ef dx translated">经过一堆故障排除，我设法让我的gitlab CICD管道连接到GCP，而不需要我的…</h3></div><div class="me l"><p class="bd b fp z dy mb ea eb mc ed ef dx translated">stackoverflow.com</p></div></div><div class="mf l"><div class="mg l mh mi mj mf mk in lw"/></div></div></a></div><div class="lt lu ez fb lv lw"><a href="https://docs.gitlab.com/ee/ci/cloud_services/google_cloud/" rel="noopener  ugc nofollow" target="_blank"><div class="lx ab dw"><div class="ly ab lz cl cj ma"><h2 class="bd hi fi z dy mb ea eb mc ed ef hg bi translated">使用GCP工作负载身份联盟| GitLab配置OpenID连接</h2><div class="md l"><h3 class="bd b fi z dy mb ea eb mc ed ef dx translated">GitLab社区版、GitLab企业版、Omnibus GitLab和GitLab Runner的文档。</h3></div><div class="me l"><p class="bd b fp z dy mb ea eb mc ed ef dx translated">docs.gitlab.com</p></div></div></div></a></div><div class="lt lu ez fb lv lw"><a href="https://cloud-architecture-design.medium.com/using-gitlab-ci-with-gcp-workload-identity-federation-8b80bec99c0b" rel="noopener follow" target="_blank"><div class="lx ab dw"><div class="ly ab lz cl cj ma"><h2 class="bd hi fi z dy mb ea eb mc ed ef hg bi translated">将GitLab CI用于GCP工作负载身份联盟。</h2><div class="md l"><h3 class="bd b fi z dy mb ea eb mc ed ef dx translated">工程师面临的挑战之一是服务帐户密钥的管理、保护、分发和更新。</h3></div><div class="me l"><p class="bd b fp z dy mb ea eb mc ed ef dx translated">cloud-architecture-design.medium.com</p></div></div><div class="mf l"><div class="ml l mh mi mj mf mk in lw"/></div></div></a></div><div class="lt lu ez fb lv lw"><a rel="noopener follow" target="_blank" href="/google-cloud/gitlab-and-workload-identity-federation-on-google-cloud-a0795091e404"><div class="lx ab dw"><div class="ly ab lz cl cj ma"><h2 class="bd hi fi z dy mb ea eb mc ed ef hg bi translated">Google Cloud上的Gitlab和工作负载身份联盟</h2><div class="md l"><h3 class="bd b fi z dy mb ea eb mc ed ef dx translated">您可以轻松使用Workload Identity Federation从Gitlab CI管道中安全地使用Google Cloud APIs，用于…</h3></div><div class="me l"><p class="bd b fp z dy mb ea eb mc ed ef dx translated">medium.com</p></div></div><div class="mf l"><div class="mm l mh mi mj mf mk in lw"/></div></div></a></div><div class="lt lu ez fb lv lw"><a href="https://dev.to/gbostoen/integrate-gitlab-with-google-cloud-workload-identity-federation-3041" rel="noopener  ugc nofollow" target="_blank"><div class="lx ab dw"><div class="ly ab lz cl cj ma"><h2 class="bd hi fi z dy mb ea eb mc ed ef hg bi translated">将Gitlab与Google云工作负载身份联盟集成</h2><div class="md l"><h3 class="bd b fi z dy mb ea eb mc ed ef dx translated">在Gitlab 14.7中，连接到AWS、GCP和vault以及其他云服务现在是可能的，通过引入…</h3></div><div class="me l"><p class="bd b fp z dy mb ea eb mc ed ef dx translated">开发到</p></div></div><div class="mf l"><div class="mn l mh mi mj mf mk in lw"/></div></div></a></div></div></div>    
</body>
</html>