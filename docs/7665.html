<html>
<head>
<title>Node for Holidays: 25 or 6 to 4</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">节假日节点:25号或6点到4点</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/node-for-holidays-25-or-6-to-4-d5bddcd15a63?source=collection_archive---------2-----------------------#2017-01-25">https://medium.com/walmartglobaltech/node-for-holidays-25-or-6-to-4-d5bddcd15a63?source=collection_archive---------2-----------------------#2017-01-25</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/d5cd532f4431a36843c966a066a3a69e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kGetBKUhB848s3UJoPtfKw.jpeg"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Photo Credit: <a class="ae it" href="https://pixabay.com/en/christmas-balls-deco-christmas-1831975/" rel="noopener ugc nofollow" target="_blank">liesel24</a></figcaption></figure><p id="3b7d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">你可能听说过沃尔玛一直在大量使用<a class="ae it" href="https://nodejs.org" rel="noopener ugc nofollow" target="_blank">节点</a>，尤其是UI层——服务器端渲染、<a class="ae it" href="https://facebook.github.io/react/" rel="noopener ugc nofollow" target="_blank">反应</a>、<a class="ae it" href="http://redux.js.org" rel="noopener ugc nofollow" target="_blank">还原</a>、<a class="ae it" href="http://www.electrode.io" rel="noopener ugc nofollow" target="_blank">电极</a>等。在这种背景下，你可能会继续听到更多关于Node和沃尔玛的消息，以及Node在假期取得的成功。然而，在这篇文章中，我将在一个不同的背景下写节点和我的个人旅程——我，一个前端工程师，作为上游Java服务和节点UI层之间的中间人(<a class="ae it" href="http://www.walmart.com" rel="noopener ugc nofollow" target="_blank">walmart.com</a>)跳入服务层和节点。</p><h1 id="af64" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">前后，左右，等等…</h1><p id="ce67" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">在过去10年左右的职业生涯中，我一直在前端工作。我没有计算机专业学位，HTTP规范我也不熟，你的实体关系图我也看不懂。所以服务团队的职位是完美的匹配，对吗？</p><p id="839d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">不管对错，我加入了服务团队，因为那里需要帮助。不用说，我很快意识到我对端到端软件工程的了解是多么的少。这是一次极其令人羞愧的经历。我最终设法把自我放在一边，开始敞开心扉去学习。我打算通过一系列博客文章来分享其中的一些经验，从我所学到的关于请求计时度量和节点的知识开始。</p><h1 id="6156" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">客厅墙后面</h1><p id="0330" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">在深入学习计时标准之前，我想先介绍一下我们为本次学习和其他学习建立的背景。对于假期，我们的任务是替换业务逻辑，该业务逻辑编排服务调用并将现有monolith Java应用程序中的数据转换为独立的服务，该服务可以由不同的垂直行业(页面)和本地移动应用程序调用。考虑到页面区域(槽、桶、出口等)中的模块调度，该服务需要返回要呈现的页面定义和模块。)和A/B测试。除了这些需求之外，该服务还需要扩充数据，如模块数据中包含的产品标识符，以及来自上游服务的形状产品数据。还有其他与上游服务的集成，如个性化。下面是更详细描述基于配置的解决方案的高级概述和序列图。我们已经开源了数据修补库<a class="ae it" href="https://www.npmjs.com/package/json-patchwork" rel="noopener ugc nofollow" target="_blank"> json-patchwork </a>，并将在未来开源编排层。</p><h2 id="e6a7" class="kv jt hh bd ju kw kx ky jy kz la lb kc jf lc ld kg jj le lf kk jn lg lh ko li bi translated">高级概述</h2><figure class="lk ll lm ln fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lj"><img src="../Images/6e0b2c736804d6fd05c1a4dee1e035e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TrkKYb5hbUnYjRiF5T9mXg.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">System Overview</figcaption></figure><h2 id="4bfc" class="kv jt hh bd ju kw kx ky jy kz la lb kc jf lc ld kg jj le lf kk jn lg lh ko li bi translated">数据丰富详细信息</h2><figure class="lk ll lm ln fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lo"><img src="../Images/d3864bc25564d6bcd08187424c280bd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zhgvUkg0n-vqmMubI5vGfQ.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Orchestrates the selection and execution of contracts that enrich service data with upstream service responses based upon contract declarations.</figcaption></figure><p id="78f6" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">所有这些都需要扩展到每秒处理48，000个请求，但那是另一回事了。剧透:我们放大了。</p><h1 id="875b" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">中年的一天</h1><p id="a88b" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">前端具有挑战性，但这些挑战中的大多数都被沙盒化到浏览器环境中，例如渲染性能。后端同样具有挑战性，但挑战分布在不同的层，如缓存、数据库、服务总线等。所有这些都通过一个网络连接在一起，而这个网络有其自身的挑战。在中间层，每个人的挑战(问题)都是你的。如果UI应用程序报告您的服务有高延迟，那么不管延迟是在您的服务中、上游还是网络中，它都会自动成为您的问题。这是因为你是他们的下一层。简而言之，排行中间的孩子确实过得不好。</p><h1 id="20c4" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">这完全是时间问题</h1><p id="9296" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">那么，当您的服务的消费者向您展示他们的日志或漂亮的图表，并说“您运行得比平时慢”，或者更糟糕的是“您没有满足SLA”时，您该怎么办呢？你的第一反应可能是内心恐慌，同时说，“谢谢你让我们知道；我们会调查的”。这件事在我身上发生过好几次。</p><h2 id="b66b" class="kv jt hh bd ju kw kx ky jy kz la lb kc jf lc ld kg jj le lf kk jn lg lh ko li bi translated">不要相信和验证</h2><p id="84a6" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">人们常说，“信任，但要核实”。我发现当设计软件时，这不是很有帮助的建议。这并不是说我认为人们不诚实，这只是因为系统是复杂的，如果你对出现的每个问题都做出反应，你可能会浪费大量时间试图解决一个无关紧要的问题。</p><p id="40a0" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在报告延迟的情况下，通常情况下，在我们的日志显示我们确实达到并超过了我们的SLA之后，我们的服务不应受到责备。</p><h2 id="35b8" class="kv jt hh bd ju kw kx ky jy kz la lb kc jf lc ld kg jj le lf kk jn lg lh ko li bi translated">沃尔多在哪？</h2><p id="58c7" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">然而，仅仅因为我们的日志表明我们没有错，并不意味着没有问题。这只是意味着UI应用程序和服务日志之间存在差异，我们需要确定为什么存在差异。我们做的第一件事是比较我们测量的是什么。</p><p id="347d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们的服务日志测量了我们的服务发送对请求的响应所花费的时间。UI应用程序日志测量从发出请求到UI应用程序收到响应的时间。这让我们找到了缺失的一环——网络(延迟)。找到了。—不完全是。试图解决一个联网问题是<strong class="iw hi"> <em class="lp">难</em> </strong>。条件从不相同，网络的行为也从不一致。就在你认为你已经发现问题的时候，事情发生了变化。我将直接切入正题，让你知道在这种情况下，网络不是问题所在。</p><h2 id="66db" class="kv jt hh bd ju kw kx ky jy kz la lb kc jf lc ld kg jj le lf kk jn lg lh ko li bi translated">测量两次，切割一次</h2><p id="a741" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">追着尾巴看完网络，我们又回到了起点。所以我们决定再次更仔细地检查我们测量的东西。首先，我们仔细检查了我们的服务遥测。一旦我们感到满意，我们就决定深入研究UI应用程序代码和遥测技术。一切看起来都很正常，除了应答计时测量发生在应答体被解析之后。这增加了一些时间，但不足以解释应用程序报告的延迟。然而，尽管无关紧要，这一发现却成了真正的发现时刻。</p><h2 id="8aad" class="kv jt hh bd ju kw kx ky jy kz la lb kc jf lc ld kg jj le lf kk jn lg lh ko li bi translated">知道是成功的一半</h2><p id="2110" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">有人说，作为一名工程师，你至少应该理解比你工作的层次低一个层次的东西。基本原理是，这有助于您在实现特性时做出更好的决策，因为您将知道您的指令在做什么，以及环境的优点和缺点。对我们来说，下面的层次是一些库，如<a class="ae it" href="https://www.npmjs.com/package/request" rel="noopener ugc nofollow" target="_blank">请求</a>、<a class="ae it" href="https://www.npmjs.com/package/async" rel="noopener ugc nofollow" target="_blank">异步</a>等。、节点和JavaScript运行时本身。</p><p id="98ae" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi"> <em class="lp">回到手头的讲座……</em></strong></p><p id="4011" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们之前在UI应用程序遥测中发现了一个小差异，在响应体解析之后测量请求响应时间，这让我们想到了回调和JavaScript并发模型，即事件循环。</p><p id="dd24" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">JavaScript本质上有一个队列，其中包含一个由初始函数调用创建的帧堆栈。当初始函数调用返回时，堆栈被清除。</p><figure class="lk ll lm ln fd ii er es paragraph-image"><div class="er es lq"><img src="../Images/9ade9c760c73860f911845f9edb34aea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*Kw5F86Bz0BCwnhEplQOwSQ.png"/></div><figcaption class="ip iq et er es ir is bd b be z dx">JavaScript Concurrency model and Event Loop — <a class="ae it" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop" rel="noopener ugc nofollow" target="_blank">MDN</a></figcaption></figure><p id="f4ba" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">因此，当队列很大时，这意味着任何被推送到队列中的请求-应答回调可能需要等待一段时间，等待队列中的其他消息运行完成，然后才能执行。</p><p id="8a7e" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这正是UI应用程序在高流量期间开始报告服务延迟时所发生的情况。所以我们不需要修复，但是我们通过识别延迟的根源，即UI应用程序中的事件循环延迟，间接地帮助提高了UI应用程序的性能。这反过来帮助UI应用程序团队识别和修复瓶颈。这些修复从渲染优化到添加更多的应用服务器。</p><h1 id="0dd9" class="js jt hh bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">外卖食品</h1><p id="bc31" class="pw-post-body-paragraph iu iv hh iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr ha bi translated">我曾经认为在前端工作是困难的，因为每个问题通常都是首先针对UI提出的，所以人们通常认为UI总是应该受到责备，不管实际问题发生在堆栈的哪个位置。我现在认为中间部分更具挑战性，因为它不仅是后端的前端(它受到UI的所有指责)，而且在调试时，你还必须从两个方向看，而不是一个方向。您必须了解调用您的前端和后端接口，以及网络。你还需要与双方和所有相关团队建立稳固的关系，以培养合作意识，而不是在出现问题时相互指责。</p><p id="c66d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">就技术要点而言，了解运行时环境，即具有事件循环并发模型的单线程，是调试问题的关键。此外，除了应用程序和服务遥测之外，还要确保您正在收集事件循环延迟等指标。最后，永远不要相信数据，永远要验证它。</p></div><div class="ab cl lr ls go lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ha hb hc hd he"><p id="b891" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">好了，现在就这样。希望你觉得这很有趣，也很有用。下一次，我将分享keep-alive是如何不止一次差点害死我们的。</p></div></div>    
</body>
</html>