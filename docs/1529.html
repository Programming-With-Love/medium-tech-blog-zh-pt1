<html>
<head>
<title>The Mon-ifesto Part 1: Metrics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Mon-ifesto第1部分:度量</h1>
<blockquote>原文：<a href="https://medium.com/capital-one-tech/the-mon-ifesto-part-1-metrics-808f6c944765?source=collection_archive---------0-----------------------#2018-03-13">https://medium.com/capital-one-tech/the-mon-ifesto-part-1-metrics-808f6c944765?source=collection_archive---------0-----------------------#2018-03-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="3841" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">更好地监控应用程序的三部分指南</h2></div><figure class="ix iy iz ja fd jb er es paragraph-image"><div role="button" tabindex="0" class="jc jd di je bf jf"><div class="er es iw"><img src="../Images/1585aaeb49d60d6997d76abd01c2d5e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tJOVu4HlxvbtmTc1mp7McQ.png"/></div></div></figure><p id="eedb" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">谈到技术，我们生活在一个有趣的时代。随着越来越多的应用程序变得以API为中心，变得不那么有状态，我们的心态也需要改变。现在，我们看到一场关于数据和指标的大战正在世界各地公司的大厅和会议室里展开。从招聘和保留，到业务收购，再到应用程序框架，一切都变得越来越受指标驱动。但是，如果一切都是以度量为中心的，我们如何确定关注哪些度量，忽略哪些度量呢？这个问题就是这场战争的前线在哪里。</p><h1 id="626e" class="ke kf hh bd kg kh ki kj kk kl km kn ko in kp io kq iq kr ir ks it kt iu ku kv bi translated">但是等等…</h1><p id="8474" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">首先，我们应该谈谈指标的来源。应用程序指标可以从应用程序性能监控(APM)代理和应用程序日志中生成。应用程序性能监控代理与您的应用程序内部集成，并跟踪诸如响应时间、系统资源使用、正常运行时间等指标。通常，APM代理只会跟踪一组预定义的指标，但是如果您想要自定义指标，那么应用程序日志是一个很好的起点。因为您控制记录什么以及如何聚集和解析日志，所以与设置第三种度量收集方法相比，使用日志作为跟踪定制度量的方法通常是微不足道的。</p><p id="3899" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">(关于应用程序日志的补充说明:从应用程序中进行日志记录是很重要的，但前提是您的日志记录是正确的。最起码，应用程序日志应该给工程师一个内部的视角，看看在日志被写的时候应用程序到底在做什么。如果您有适当的基础设施来处理该卷，那么您应该记录所有内容，并使用日志来关联事件和生成除应用程序性能指标之外的指标。)</p><p id="25da" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">其次，区分运营指标和业务指标很重要。一个应用程序将会产生这两者，而分离这两者是你实现度量zen的第一步。</p><ul class=""><li id="410c" class="lc ld hh jk b jl jm jo jp jr le jv lf jz lg kd lh li lj lk bi translated"><strong class="jk hi">业务指标</strong>是由应用程序中的业务逻辑生成的指标，如注册、购买流程点击量、内容页面点击量等。</li><li id="13ae" class="lc ld hh jk b jl ll jo lm jr ln jv lo jz lp kd lh li lj lk bi translated"><strong class="jk hi">运营指标</strong>是客户端连接、CPU负载、错误率等。这些度量标准本身并不告知应用程序的实际逻辑，但是它们确实说明了应用程序的持续功能。</li></ul><p id="82cf" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">其次，当提到一个应用程序时，我实际上是指一个<em class="lb">应用程序服务</em>。单实例应用程序为该应用程序的一个实例提供所有流量的时代已经一去不复返了。应用服务是一组应用实例，它们共同执行整个应用的功能。无论这是通过分布式微服务架构还是共享流量的单一应用程序的多个副本(或两者之间的某种混合)来实现，都与我们的上下文无关。</p><p id="fa21" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">记住这一点，让我们开始研究我们的第一个指标:每分钟通话次数。</p><h1 id="d5e4" class="ke kf hh bd kg kh ki kj kk kl km kn ko in kp io kq iq kr ir ks it kt iu ku kv bi translated">1.每分钟通话次数</h1><p id="db2c" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">当谈到应用程序的规模时，每分钟调用次数(CPM)是衡量所有应用程序的标准。为什么？因为像服务器计数或数据包I/O这样的事情可能会因应用程序而异，这取决于代码效率等因素。CPM准确显示了单个应用程序可以处理的流量，这是一个常用于容量规划的指标。</p><p id="4ff7" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">从运营的角度来看，监控CPM非常重要，这样我们就可以实时了解我们的应用程序正在发生什么，客户是否能够访问我们的应用程序，我们正在为多少客户提供服务，以及是否有任何问题需要我们关注。CPM中意想不到的大峰值会让工程师们夜不能寐，这些异常事件会导致服务和服务器灾难性的崩溃。但是我们需要担心的不仅仅是CPM的增加，API调用数量的突然减少也应该让我们担心。</p><p id="32ff" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><em class="lb">但是如何监控CPM这样没有静态成功/失败值的东西呢</em>？这里通常所做的是监控与给定基线的偏差，其中基线是在任意长度的时间内(例如14天)建立的。使用相对于基线的偏差将允许流量模式的有机变化，无论是消费者模式的变化还是应用程序架构的变化，同时仍然对峰值和丢失发出警报。请记住，当谈到多少偏差是可接受的时，没有神奇的数字，它应该并且确实因应用程序而异。虽然应用程序A可能具有非常稳定的CPM速率，并在偏离基线仅10%时开始发出警报，但应用程序B可能不会，低百分比会发出不必要的警报。探索这一点的最佳方式是通过测试和反复试验。调整你的偏差百分比，直到你找到一个适合你和你的应用。</p><h1 id="8a77" class="ke kf hh bd kg kh ki kj kk kl km kn ko in kp io kq iq kr ir ks it kt iu ku kv bi translated">2.错误率(EPM)</h1><p id="bc72" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">与CPM类似，每分钟错误数(EPM，或错误率)衡量应用程序在给定的一分钟内抛出的错误数。差错率与CPM有几个非常重要的区别。</p><ol class=""><li id="2437" class="lc ld hh jk b jl jm jo jp jr le jv lf jz lg kd lq li lj lk bi translated">当低于基线时，您永远不希望打开警报，而是希望关闭警报。错误率下降是一件好事。</li><li id="5d22" class="lc ld hh jk b jl ll jo lm jr ln jv lo jz lp kd lq li lj lk bi translated">报告EPM的绝对值几乎没有用。一个更有用的指标是错误的应用程序调用的百分比。</li></ol><p id="8b17" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">让我举一个例子。App A的错误率为每分钟50个错误。这个数字本身没有任何意义，因为它缺乏上下文。如果应用A的总CPM比率为25，000，那么50的EPM不是什么大问题，通常低于警报阈值。但是，即使将这些表示为绝对值也有点笨拙，特别是如果您处理的数字不像我们的例子那样漂亮和圆润的话。</p><p id="2929" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">百分比让我们更快地了解应用程序的整体性能。在我们的例子中，EPM为50只是0.2%的错误率。就像CPM一样，你的EPM阈值应该是多少并没有什么神奇的数字，但是一个好的起点通常是10%。</p><h1 id="56fb" class="ke kf hh bd kg kh ki kj kk kl km kn ko in kp io kq iq kr ir ks it kt iu ku kv bi translated">3.响应时间</h1><p id="1a02" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">可以说响应时间是您可以从应用程序中收集的最重要的指标。响应时间不仅给出了关于整体应用健康状况的指示，而且还提供了对客户体验的洞察，不仅会对您的应用产生影响，还会对您的业务或公司整体产生影响。对于严重依赖NPS分数的公司，如电信公司，缓慢的响应时间可能意味着一个好季度或一个坏季度的区别。</p><p id="011b" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">对于响应时间，为您的应用程序获取一个好的基线非常重要。与CPM一样，您需要监控与基线的偏差，而不仅仅是一个“哑”阈值。这是因为与CPM一样，响应时间的突然下降或峰值表明您的应用程序在其环境中存在内部或外部问题。但是，您可以将阈值监视器与基线偏差监视器结合起来(事实上，如果您的应用程序监视套件允许的话，我会推荐它)。现实世界的响应时间很少是个位数。如果您的应用程序开始抛出1到10毫秒范围内的时间，要么您的API实际上没有做任何工作(就像一个简单的“ping”检查，在这种情况下，您需要为该API创建特殊的规则),要么它们立即返回错误。</p><p id="12d7" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">响应时间可以指示应用程序问题的另一种方式是，如果您看到CPM和响应时间之间的相关性。对于大多数API来说，API调用会有一个自然的起伏，导致一个类似于正弦波的图形，波峰通常在白天，波谷在晚上。(当然，不是所有的应用都是一样的，对于一些公司来说，我敢肯定这不成立)你不希望你的响应时间图与你的CPM图跟踪；如果是这样，这通常是一个很好的迹象，表明你的应用程序要么写得很差，要么超载，这就把我们带到了最后的指标…</p><h1 id="500a" class="ke kf hh bd kg kh ki kj kk kl km kn ko in kp io kq iq kr ir ks it kt iu ku kv bi translated">4.带宽饱和(BS)</h1><p id="224e" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">在这种情况下,“带宽”指的是应用程序可以承受的最大负载，而不仅仅是网络带宽(尽管网络带宽在整个应用程序的容量中扮演着重要的角色)。带宽饱和度(或仅仅是饱和度)与前三个指标略有不同，因为它要求您对应用程序执行负载测试，以便建立一些“预先”数据。当对你的应用进行负载测试时，你需要做一些事情:</p><ul class=""><li id="e626" class="lc ld hh jk b jl jm jo jp jr le jv lf jz lg kd lh li lj lk bi translated">分别测试微服务或整体实例，以确定其最大单独负载(对于微服务，如果可能的话，您会希望对每个微服务进行单独测试)。</li><li id="9e4b" class="lc ld hh jk b jl ll jo lm jr ln jv lo jz lp kd lh li lj lk bi translated">在其环境中测试应用程序的最小单元。对于微服务应用程序，这意味着每个微服务的单个副本及其所有路由和发现以及负载平衡都已就绪；对于monolith来说，这是该应用程序的一个实例，具有负载平衡和其他一切功能。通过比较第一次测试和这次测试的性能数据，该测试将通知您在应用程序之外的环境中是否存在任何瓶颈。</li><li id="b7b0" class="lc ld hh jk b jl ll jo lm jr ln jv lo jz lp kd lh li lj lk bi translated">检查你的数据，找出你的实际最大CPM是多少，这将是你推断和测试你扩展能力的基线。</li></ul><p id="191b" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">一旦确定，如果您超过此基准扩展到多个实例或不同数量的微服务，并开始看到性能下降，那么一定是出了问题，您应该去解决它。在理想情况下，您的扩展是基于这个基线乘以实例或微服务的数量。假设一切正常，您可以使用您的新基线来计算您的最大期望应用程序带宽。让我们看看这是如何工作的。</p><p id="2aba" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">在我们的示例中，App A每个应用实例可以消耗10，000 CPM，但是在9，500时，它开始变得不稳定，因此为了安全起见，我们说9，000 CPM是我们的基线CPM。如果我们有5个应用程序A的副本在运行，那么我们的最大带宽是45，000 CPM，还有大约2，500 CPM的“净空”，以防我们遇到一些高峰，无法足够快地扩展。如果App A的真实CPM为30，000 CPM，那么我们可以说我们已经使用了总带宽的67%左右。</p><p id="779b" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">再说一次，没有神奇的数字说，“如果你达到X%的带宽，你必须扩展。”每个应用程序都是不同的，采用的流量模式也大相径庭，所以请尝试并找出您的神奇数字。一旦完成，您就可以将警报设置到该阈值，并简化您的扩展策略。</p><h1 id="0acd" class="ke kf hh bd kg kh ki kj kk kl km kn ko in kp io kq iq kr ir ks it kt iu ku kv bi translated">但是等等，还有更多</h1><p id="280a" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated"><em class="lb">“但是等等！”</em>我听到你说，<em class="lb">“我的所有系统指标，如CPU和磁盘I/O，怎么样？如果我们不打算使用它们，我为什么要浪费资源去收集它们呢？”</em></p><p id="e2bf" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">惊喜！你<em class="lb">将</em>使用它们，只是不是你习惯的方式。工程师半夜醒来响应Nagios对CPU或内存的警告的日子已经一去不复返了。因为基础硬件，甚至操作系统，已经从应用程序中抽象出来，我们必须开始以不同的方式思考我们的底层系统。我们将这样做:<strong class="jk hi">收集一切，警惕四件事，关联一切。</strong></p><h1 id="06eb" class="ke kf hh bd kg kh ki kj kk kl km kn ko in kp io kq iq kr ir ks it kt iu ku kv bi translated">收集一切，关联一切</h1><p id="3c68" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">没有任何度量是不重要的。甚至CPU。为什么？因为度量相关性。当出现警报时，我们希望了解环境的整个范围，而不仅仅是几个关键指标。我们想知道，精确到秒，每台机器、每个进程、每个容器在做什么，以及它在使用什么资源，这样我们就可以深入研究并找到根本原因。这是使用系统统计数据的地方。</p><p id="f16e" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">我们可以走这条“捷径”,因为如果我们的某个应用程序主机出现问题——一个真正的问题，症状会出现在我们的四个关键指标之一中。沉重的CPU负载将表现为较慢的响应时间，丢失的网络数据包将在我们的EPM中显示为错误，TCP连接未关闭将在几乎所有情况下显示。这并不意味着你不想关注他们；无论如何，创建CPU指标仪表板或磁盘I/O计数器等等。只是你不敢为他们制造警报。为什么？</p><h1 id="1000" class="ke kf hh bd kg kh ki kj kk kl km kn ko in kp io kq iq kr ir ks it kt iu ku kv bi translated">恼人的黑仔:寻呼机疲劳</h1><p id="f8bf" class="pw-post-body-paragraph ji jj hh jk b jl kw ii jn jo kx il jq jr ky jt ju jv kz jx jy jz la kb kc kd ha bi translated">因为警报会杀人。</p><p id="5fd9" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">想想像咖啡因这样的警示:这里一点点，那里一点点，会让你感到震惊，让你跑起来，太多了，它会真的杀了你。“寻呼机疲劳”是一个术语，用来描述这样一种现象:太多的紧急警报(或页面)不再是警报，而只是成为噪音、让你从收件箱中过滤掉的电子邮件或静音的空闲频道。有太多的工作和太多的警报需要回答，你还不如忽略一切——这对生产应用程序来说是一个真正的问题。我们将在本系列的后面部分更深入地讨论警报和响应，但是现在，只需知道过多的警报可能是一件<em class="lb">非常糟糕的事情</em>。</p><p id="dc18" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated">通过使用这四个简单的指标，您不仅可以减少警报的数量，还可以确保每个被触发的警报都是重要的。这样，您的工程师将会花更多的时间来解决实际问题，而不是幻影问题。</p></div><div class="ab cl lr ls go lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ha hb hc hd he"><h2 id="6b52" class="ly kf hh bd kg lz ma mb kk mc md me ko jr mf mg kq jv mh mi ks jz mj mk ku ml bi translated">*<a class="ae mm" rel="noopener" href="/capital-one-developers/the-mon-ifesto-part-2-alerting-and-graphing-bf51828a008f">Mon-ifesto第2部分:报警和绘图</a></h2><h2 id="7a14" class="ly kf hh bd kg lz ma mb kk mc md me ko jr mf mg kq jv mh mi ks jz mj mk ku ml bi translated">* <a class="ae mm" rel="noopener" href="/capital-one-developers/the-mon-ifesto-part-3-alert-response-and-post-mortem-cd227c684ac0">监控第3部分:警报响应和事后分析</a></h2></div><div class="ab cl lr ls go lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ha hb hc hd he"><p id="00c0" class="pw-post-body-paragraph ji jj hh jk b jl jm ii jn jo jp il jq jr js jt ju jv jw jx jy jz ka kb kc kd ha bi translated"><strong class="jk hi"> <em class="lb">披露声明:以上观点为作者个人观点。除非本帖中另有说明，否则Capital One不属于所提及的任何公司，也不被其认可。使用或展示的所有商标和其他知识产权都是其各自所有者的所有权。本文为2018首都一。</em>T3】</strong></p></div></div>    
</body>
</html>