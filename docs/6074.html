<html>
<head>
<title>Understanding Pinners through funnel analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过漏斗分析了解Pinners</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/understanding-pinners-through-funnel-analysis-f759f4a77e2c?source=collection_archive---------1-----------------------#2015-11-13">https://medium.com/pinterest-engineering/understanding-pinners-through-funnel-analysis-f759f4a77e2c?source=collection_archive---------1-----------------------#2015-11-13</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="da6f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">刘长书| Pinterest工程师，数据</p><p id="4e40" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作为一家公司，我们的首要价值观是将Pinners放在第一位，通过数据将这一点付诸实践需要我们深入了解Pinners如何导航和使用我们的产品。Pinner活动的一个常见分析模式是顺序分析它们从一个记录的事件到另一个记录的事件的移动，这一过程称为<a class="ae jc" href="https://en.wikipedia.org/wiki/Funnel_analysis" rel="noopener ugc nofollow" target="_blank">漏斗分析</a>。除了帮助我们更好地了解Pinners，我们还使用漏斗分析为工程资源提供信息。在这里，我们介绍Pinterest漏斗，一种能够对Pinner活动进行交互式可视化分析的工具。</p><h2 id="e6c0" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">我们的漏斗分析平台</h2><p id="bc05" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">我们将漏斗定义为Pinner活动会话中的一系列有序步骤。每一步都由Pinner采取的至少一个动作组成，比如查看一个Pin或发送一条消息。</p><p id="ae0f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">例如，可以定义如下漏斗(概念上)来理解邀请转换率:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="182c" class="jd je hh ki b fi km kn l ko kp">{<br/>    ‘name’: ‘invitation conversion’,<br/>    ‘creator’: ‘Changshu Liu’<br/>    ‘steps’: [<br/>        ‘click invitation’: [‘email_invite_click’, ‘fb_invite_click’, ‘twitter_invite_click’],<br/>        ‘visit landing page’: [‘langing_page_visit’],<br/>        ‘registration’ [‘email_reg’, ‘gplus_reg’]<br/>    ]<br/>    ‘experiments’: [‘exp_name1’, ‘exp_name2’]<br/>}</span></pre><p id="9acb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kq">漏斗定义示例</em></p><p id="0be0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了简化创建漏斗的任务，我们提供了一个基于web的漏斗编辑器，它具有预定义的动作名称自动完成功能。这使得非工程师能够容易地采用漏斗系统，也减少了行动名称的打字错误，从而提高了用户的生产力。</p><figure class="kd ke kf kg fd ks er es paragraph-image"><div class="er es kr"><img src="../Images/1722678849d7449ef0a3ede9737a6f8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/0*yAHWirBByrUJPnLt.png"/></div></figure><p id="9b38" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在定义了一个漏斗之后，我们使用两个漏斗分析器中的一个(将在本文后面详述)来生成在门户网站中可视化的结果，包括:</p><ul class=""><li id="269c" class="kv kw hh ig b ih ii il im ip kx it ky ix kz jb la lb lc ld bi translated">有多少pinner到达了漏斗中定义的步骤(对于步骤N的pinner，他们已经到达了步骤1、步骤2 …步骤N-1)。</li><li id="234e" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated">一种分段功能，允许我们将总计数分成不同的分段。(我们现在支持六个细分:性别、app、app版本、国家、浏览器、实验组。)</li><li id="8a23" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated">不同细分组合的结果。</li><li id="f6c0" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated">结果的历史记录。</li></ul><figure class="kd ke kf kg fd ks er es paragraph-image"><div class="er es lj"><img src="../Images/7bb4c08df622753623fb37a3b7d2234d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/0*04K8OcQ4JHjk8o4b.png"/></div></figure><figure class="kd ke kf kg fd ks er es paragraph-image"><div class="er es lk"><img src="../Images/419d2e20df6cd6f86b9ccafafa408b07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1256/format:webp/0*pVBTZGr7dNhrueo6.png"/></div></figure><figure class="kd ke kf kg fd ks er es paragraph-image"><div class="er es ll"><img src="../Images/6d363b0ad0b4bd992f3ef3faaa5bfcca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/format:webp/0*wg676SBqqu8u2XnI.png"/></div></figure><h2 id="8f82" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">在幕后</h2><p id="5707" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">漏斗分析平台有三个主要的子系统:</p><ul class=""><li id="767d" class="kv kw hh ig b ih ii il im ip kx it ky ix kz jb la lb lc ld bi translated"><strong class="ig hi">动作会话管道</strong>，它收集原始数据源，用适当的元信息对它们进行注释，并将它们分组到每个用户的会话中，然后由下面的两个分析器使用。</li><li id="2fa7" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated"><strong class="ig hi"> Hive漏斗分析器</strong>，使用Hive UDF消耗会话数据，为每个分段组合的每个漏斗步骤生成一个会话号，并将这些数据输入到我们的Pinalytics后端。</li><li id="445b" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated"><strong class="ig hi"> ElasticSearch漏斗分析器</strong>，它将漏斗定义转换为ElasticSearch查询操作符树和针对索引会话数据的查询，以验证漏斗定义的正确性。它还可以为交互式特别漏斗分析请求提供服务。</li></ul><h2 id="4e36" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">动作会话管道</h2><p id="7202" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">漏斗分析平台中使用的Pinner行动数据有三个来源。前两个来源是前端事件和后端事件，它们是具有预定义模式的日志。第三个来源是自由形式的日志，任何开发人员或团队都可以添加。每个日志条目可能包含许多字段，但这里我们主要关心谁(代表注册或未注册Pinner的unique_id)在什么时间(标准时间戳)做了什么(代表Pinner动作的字符串)。</p><p id="9e60" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了让Pinner动作数据更容易被漏斗平台使用，我们对原始动作名称做了一些特殊处理。</p><ul class=""><li id="6c9d" class="kv kw hh ig b ih ii il im ip kx it ky ix kz jb la lb lc ld bi translated">为避免任何冲突，每个动作都添加了一个短前缀，例如，我们可以用_f_表示前端事件，用_b_表示后端事件。</li><li id="c507" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated">我们还跟踪前端事件的动作发生在哪里(比如视图、组件和元素信息)。这种类型的最终动作看起来像是<a class="ae jc" href="mailto:_f_action@view" rel="noopener ugc nofollow" target="_blank">_ f _ action @ view</a>@<a class="ae jc" href="mailto:component@element" rel="noopener ugc nofollow" target="_blank">component @ element</a>。</li></ul><p id="f750" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然后将这三个来源联合在一起，过滤垃圾邮件，会话成一系列Pinner会话，并用实验/片段信息进行注释。有多种方法可以将操作分组到会话中。在我们的案例中，我们最关心Pinners在一天或一周内的行为。我们按照unique_id对每日动作和每周动作表进行分组。最终原始会话表中的典型行如下所示:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="a102" class="jd je hh ki b fi km kn l ko kp">(uuid_xyz, [‘action_1’, ‘action_2’, ‘action_3’ ...], [‘exp_1’,...], ‘Android’, ‘3.3’, ‘US’, ‘Chrome’, ‘Male’)</span></pre><figure class="kd ke kf kg fd ks er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lm"><img src="../Images/79a7e1bf3f442652b3de870e3296f871.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AxuJqIRkVgLlg3ry.png"/></div></div></figure><p id="971f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在生成原始会话表之后，将对其应用分析器逻辑。我们有两个针对不同场景的分析器，一个是基于Hive的离线分析器，另一个是基于ElasticSearch的在线分析器。</p><h2 id="af72" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">蜂巢漏斗分析仪</h2><figure class="kd ke kf kg fd ks er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lr"><img src="../Images/bde2a03dcf6e2ada48ebc0b7bdfd0c19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NOsumpX7KV36P5Le.png"/></div></div></figure><p id="97b6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Hive漏斗分析器中，我们构建了一个Hive UDF来处理会话表。对于每个Pinner会话(原始会话表中的一行)，UDF将其与我们的漏斗库中定义的所有漏斗进行匹配，并生成与每个漏斗中定义的步骤操作相匹配的会话总数。</p><p id="26fa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">例如，假设我们有一个如下所示的Pinner会话:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="4529" class="jd je hh ki b fi km kn l ko kp">(‘uuid_1234’, [‘fb_invite_click’, ‘action_1’, ‘langing_page_visit’, ‘action_2’], [‘exp_1’], ‘US’, ‘iPhone’, ‘5.0’, ‘Female’, ‘Safari’ )</span></pre><p id="f857" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在根据我们在开始时定义的漏斗处理该会话后，UDF将生成以下记录:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="9268" class="jd je hh ki b fi km kn l ko kp">(‘invitation_conversion.step_1’, ‘exp_1’, ‘US’, ‘iPhone’, ‘5.0’, ‘Female’, ‘Safari’, 1)<br/>(‘invitation_conversion.step_2’, ‘exp_1’, ‘US’, ‘iPhone’, ‘5.0’, ‘Female’, ‘Safari’, 1)</span></pre><p id="9d02" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如您所见，没有第三步的记录，因为给定的Pinner会话没有达到邀请转换漏斗的第三步中定义的任何操作。</p><p id="2b24" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">接下来，对这些会话计数求和，我们现在就有了每个阶段组合的每个漏斗中每个步骤的总会话计数。但是最有可能的是，用户只关心总和或者一些分割的总和。例如，用户可能想知道邀请转换漏斗中第一步和第二步的会话数，仅在美国。我们使用<a class="ae jc" href="https://engineering.pinterest.com/blog/building-pinalytics-pinterest%E2%80%99s-data-analytics-engine" rel="noopener ugc nofollow" target="_blank"> Pinalytics </a>通过HBase协处理器实时实施“汇总”功能。考虑到我们的段基数，这消除了预先计算汇总数字的需要，这将花费大量的空间，并使回填相对容易。</p><p id="463d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如前所述，我们在前端事件动作中包含了视图、组件和元素。有时，用户希望基于此类行为的模式构建一个漏斗。例如，用户可能想知道有多少Pinners在“invite_button”元素上执行了“click”操作，而不管视图或组件是什么。我们提供了一种特殊的“模式匹配”动作语法来表达这种语义:_ f _ click @ * @ * @ invite _ button。两个“*”字符表示视图和组件属性可以是任何值，而“@”字符用作字段分隔符。</p><h2 id="a1a6" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">弹性搜索漏斗分析仪</h2><figure class="kd ke kf kg fd ks er es paragraph-image"><div class="er es ls"><img src="../Images/1fc50bd309652808a51abeb9b7cb699a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/0*Zvpr-7F9tL0_bSI6.png"/></div></figure><p id="3fcc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您熟悉搜索引擎的工作方式，您可能会注意到会话/漏斗匹配逻辑与典型搜索引擎根据查询操作符树匹配文档的方式非常相似。如果我们将Pinner会话建模为搜索文档，将每个操作建模为定位术语，将段建模为ElasticSearch中的文档字段，那么漏斗的同一步骤中的操作之间的关系可以使用OR运算符来表示，而连续步骤之间的关系可以使用“出现在”(在<a class="ae jc" href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank"> ElasticSearch </a>中，一个in_order属性设置为true的NEAR运算符)运算符来表示。</p><p id="72c3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">例如，开始示例中的漏斗定义可以转换为以下三个查询操作符树:</p><figure class="kd ke kf kg fd ks er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lt"><img src="../Images/0a0320bd975ce7e16b752ec0165dc28b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*F_tNDiycWCLHkmW2.png"/></div></div></figure><p id="f8f4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这些查询返回的文档数将是漏斗定义中每个步骤的会话数。</p><p id="e22d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了支持“模式匹配”操作语法，如:ElasticSearch漏斗分析器中的_f_click@*@*@invite_button，我们使用了来自搜索社区的名为“<a class="ae jc" href="https://en.wikipedia.org/wiki/Query_expansion" rel="noopener ugc nofollow" target="_blank">查询扩展</a>的技术我们从具体的动作字典中预先构建一个trie，并使用它在查询时将“模式匹配”动作扩展为具体动作的列表。如果有太多扩展的具体动作，我们根据术语频率对它们进行加权，并选择前K个动作，其中K是可配置的参数。</p><p id="0841" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">例如，根据我们的动作字典，_f_click@*@*@invite_button可以扩展为以下四个具体动作:</p><figure class="kd ke kf kg fd ks er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lu"><img src="../Images/56aaf39cff141080d661fd2e019d9813.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*whP-x7c-Ga-jJm6f.png"/></div></div></figure><p id="e374" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正如您所看到的，这两个分析器具有不同的特性。</p><ul class=""><li id="e1ee" class="kv kw hh ig b ih ii il im ip kx it ky ix kz jb la lb lc ld bi translated">Hive Analyzer比ElasticSearch Analyzer慢。如果漏斗定义发生变化，我们需要重新运行Hive查询来更新结果。然而，它涵盖了更多的历史会话数据，因为不需要将它们加载到ElasticSearch集群中。结果更准确，因为没有近似逻辑。</li><li id="66d7" class="kv kw hh ig b ih le il lf ip lg it lh ix li jb la lb lc ld bi translated">ElasticSearch Analyzer速度超快(亚秒级)，但它覆盖的数据较少，因为我们需要将会话表索引到容量有限的ElasticSearch集群中。在某些情况下，它不太准确，因为如果有太多的候选动作，我们会忽略一些扩展动作。</li></ul><p id="388a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在实践中，我们使用ElasticSearch进行漏斗预览，这有助于在将定义具体化为漏斗repo之前验证漏斗定义是否是我们想要的。我们还使用它进行临时漏斗分析，这是一种对ElasticSearch中最近的会议进行的交互式按需漏斗分析。</p><h2 id="2397" class="jd je hh bd jf jg jh ji jj jk jl jm jn ip jo jp jq it jr js jt ix ju jv jw jx bi translated">后续步骤</h2><p id="a46f" class="pw-post-body-paragraph ie if hh ig b ih jy ij ik il jz in io ip ka ir is it kb iv iw ix kc iz ja jb ha bi translated">上述过程使我们的团队能够在预定义的路径上查看导航。我们目前正在考虑如何在多个渠道之间进行简单的比较。为了扩展上面的例子，我们可以比较通过不同类型的邀请电子邮件注册的Pinners之间的数据。其次，由于数据量的原因，我们不得不在弹性搜索指数中做出权衡。最理想的情况是，我们将为用户提供更大的灵活性来导航实时漏斗，而不是等待MapReduce漏斗分析器作业来填充他们的数据。</p><p id="51ea" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">鸣谢:漏斗分析项目是数据团队和增长团队之间的合作。感谢成长团队的Ludo Antonov和Dannie Chu提供的功能建议和实施讨论，以及漏斗分析的初步工作，并感谢数据团队的苏曼·詹迪亚拉、硕翔和杰夫·费里斯。</p></div></div>    
</body>
</html>