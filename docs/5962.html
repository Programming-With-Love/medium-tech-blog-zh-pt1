<html>
<head>
<title>Unlocking Oracle Analytics Cloud with OAuth 2.0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用OAuth 2.0开启Oracle分析云</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/unlocking-oracle-analytics-cloud-with-oauth-2-0-e62218efb277?source=collection_archive---------0-----------------------#2022-09-12">https://medium.com/oracledevs/unlocking-oracle-analytics-cloud-with-oauth-2-0-e62218efb277?source=collection_archive---------0-----------------------#2022-09-12</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/b474c3a72f05fa001bae2a86783a9ee0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5VPffrROH6fE71yZNIGgYA.png"/></div></div></figure><p id="52b6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在过去几年中，我们看到Oracle分析云(OAC)越来越多地使用<a class="ae jn" href="https://oauth.net/2/" rel="noopener ugc nofollow" target="_blank"> OAuth 2.0 </a>访问令牌。从我自己的经验来看，获得和使用访问令牌需要一个学习过程，我希望这篇博客对开始使用OAC这方面的人有用。这并不是OAuth 2.0的权威指南，而是OAC用户理解和使用访问令牌的一种方式。</p><p id="71ed" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">网上有很多介绍OAuth 2.0的资源。https://oauth.net/2/<a class="ae jn" href="https://oauth.net/2/" rel="noopener ugc nofollow" target="_blank">的站点</a>是一个很好的起点。您还可以在该网站上找到相关RFC参考资料的详细信息。这个<a class="ae jn" href="https://www.rfc-editor.org/rfc/rfc6749" rel="noopener ugc nofollow" target="_blank"> RFC </a>很好地介绍了OAuth 2.0授权框架以及它所要解决的问题。</p><h1 id="8223" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">术语</h1><p id="c565" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">让我们先来描述一下本博客中使用的一些术语:</p><p id="f474" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">访问令牌<br/></strong><a class="ae jn" href="https://www.oauth.com/oauth2-servers/access-tokens/" rel="noopener ugc nofollow" target="_blank">访问令牌</a>用于访问Oracle分析云。这可能是一个<a class="ae jn" href="https://insight2action.medium.com/oracle-analytics-cloud-oac-embedding-public-user-access-part-1-5fb0f513508a" rel="noopener">嵌入</a>用例，或者使用OAC <a class="ae jn" href="https://blogs.oracle.com/analytics/post/announcing-oracle-analytics-cloud-apis" rel="noopener ugc nofollow" target="_blank"> API </a> s，或者其他一些原因。OAuth 2.0 RFC将访问令牌描述为“表示特定范围、生存期和其他访问属性的字符串”访问令牌可以采用各种格式。我喜欢<a class="ae jn" href="https://developer.okta.com/blog/2019/06/05/seven-ways-an-oauth-access-token-is-like-a-hotel-key-card" rel="noopener ugc nofollow" target="_blank">这种</a>用酒店房间钥匙卡来类比访问令牌的描述。</p><p id="693b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">承载令牌</strong> <br/>承载令牌是一种接入令牌。Oracle分析云使用的令牌类型是不记名令牌。它被描述为一个不透明的字符串，对使用它的客户来说没有任何意义。Oracle Analytics使用的令牌是结构化令牌，采用JSON Web令牌或jwt的形式。</p><p id="7fad" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi"> JSON Web Token (JWT) <br/> </strong>引用<a class="ae jn" href="https://en.wikipedia.org/wiki/JSON_Web_Token" rel="noopener ugc nofollow" target="_blank">维基百科</a>，‘一个JWT(发音为‘jot’)是一个提议的互联网标准，用于创建带有可选签名和/或可选加密的数据，其有效负载包含断言一些声明的JSON。使用私有秘密或公共/私有密钥对令牌进行签名。当我们在本博客后面讨论JWT断言时，这将变得更加相关。我还在下面加入了一些参考资料，它们更详细地介绍了jwt。如果需要进行故障排除，这个<a class="ae jn" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank">站点</a>是“解码”jwt的有用资源。</p><p id="1602" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">刷新令牌<br/>刷新令牌可用于获得使用不同于用于获得原始访问令牌的API有效负载的访问令牌。如上所述，访问令牌具有与其相关联的特定(可配置的)寿命，并且刷新令牌提供了获得新的访问令牌的机制。刷新令牌通常比访问令牌具有更长的寿命。若要获取刷新令牌，请在调用IDCS/oauth 2/v1/令牌端点时将“offline_access”添加到scope参数中。</strong></p><p id="79c0" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">令牌到期<br/> </strong>当您获得一个访问令牌时，它将在一段可配置的时间后到期。对于Oracle Analytics，默认情况下为100秒。这可以通过编辑OAC实例的IDCS应用程序(不是本博客下一节创建的机密应用程序)来更改。注意，刷新令牌通常具有长得多的到期时间。如果您希望使用API更改令牌到期时间，此处的<a class="ae jn" href="https://insight2action.medium.com/oracle-analytics-cloud-embedding-changing-the-idcs-token-timeout-1da9323e1b94" rel="noopener">描述了该过程</a>。</p><p id="58cb" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">保密应用</strong> <br/>这个<a class="ae jn" href="https://www.rfc-editor.org/rfc/rfc6749#section-2.1" rel="noopener ugc nofollow" target="_blank">术语</a>指的是一个可以保证诸如“客户机密”等凭证安全的应用。对于Oracle分析云，在Oracle <a class="ae jn" href="https://docs.oracle.com/en/cloud/paas/identity-cloud/uaids/add-confidential-application.html" rel="noopener ugc nofollow" target="_blank">身份云服务</a>或Oracle <a class="ae jn" href="https://docs.oracle.com/en-us/iaas/Content/Identity/applications/overview.htm" rel="noopener ugc nofollow" target="_blank"> IAM </a>中创建机密应用。</p><p id="58d6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">客户端ID <br/> </strong>这是发给机密应用的标识符。</p><p id="03dd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">客户端秘密<br/> </strong>这是与机密应用程序相关联的相应“秘密”。如果需要，可以更新。</p><p id="91ee" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">作用域<br/> </strong>正如我们将在本博客后面看到的，当您调用一个API来获取用于Oracle Analytics Cloud的访问令牌时，您需要提供一个作用域作为有效负载的一部分。<a class="ae jn" href="https://docs.oracle.com/en/cloud/paas/identity-cloud/rest-api/Scopes.html" rel="noopener ugc nofollow" target="_blank">范围</a>提供了一种方法来定义访问令牌允许使用的资源。在我们的OAC用例中，这通常是IDCS机密应用程序中映射的OAC实例。</p><h1 id="939a" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">创建机密应用程序</strong></h1><p id="392b" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">您需要相关的权限才能在Oracle IDCS / IAM中创建应用产品。第一步是选择“添加”新的机密应用程序:</p><figure class="ks kt ku kv fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kr"><img src="../Images/a3b3ad47c4f3380a0484cb17284a640c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HdwVSTILxmC8q0pleHVgEA.png"/></div></div></figure><p id="5cd6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">提供机密应用程序的名称:</p><figure class="ks kt ku kv fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kw"><img src="../Images/70b03a731b9c87275c20a62ddbba270b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hs1TIgNnJcHChZf1zw3F0w.png"/></div></div></figure><p id="6976" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">单击“下一步”并选择“立即将此应用程序配置为客户端”:</p><figure class="ks kt ku kv fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kw"><img src="../Images/70b03a731b9c87275c20a62ddbba270b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hs1TIgNnJcHChZf1zw3F0w.png"/></div></div></figure><p id="401d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果使用JWT签名断言，除了上传公钥和定义别名之外，您还可以在这个屏幕上选择授权类型(稍后将详细介绍)。</p><figure class="ks kt ku kv fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kx"><img src="../Images/1a1ede3896d55e6c6d98e55f4ba9abbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PL_2dIE5O1Q8siJ-ByoARw.png"/></div></div></figure><p id="de08" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您向下滚动，您将在参考资料部分看到“添加范围”选项。这是您映射要为其生成访问令牌的Oracle Analytics云实例的位置。</p><figure class="ks kt ku kv fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es kx"><img src="../Images/3f33108fce564ed6bd474fa54102c50c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*coSbPBkrYOrfGPtaLqJYOQ.png"/></div></div></figure><p id="48c8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在剩余屏幕中单击“下一步”,直到您可以单击“完成”。此时，系统会提示您已经添加了应用程序，并提供了该应用程序的客户端ID和客户端密码。不要忘记“激活”应用程序。</p><h1 id="dc49" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">获取Oracle Analytics云访问令牌的最简单方法</h1><p id="9d01" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">在Oracle IDCS控制台中，如果导航到左侧的“Oracle云服务”选项，然后选择要获取令牌的OAC实例。您会注意到一个“生成访问令牌”按钮，选择该按钮后，您可以选择是否也包括刷新令牌，然后您可以下载访问令牌。</p><figure class="ks kt ku kv fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ky"><img src="../Images/e42859deb9dbb90bb5b2ff7350c6143d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RfPgpb4O8BNe-hDCLZ4cnQ.png"/></div></div></figure><p id="731c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这可能是你所需要的一切！如果您使用以这种方式获得的初始访问令牌“引导”一个进程，然后使用刷新令牌获得后续访问令牌。这是一个使用刷新令牌获取新访问令牌的curl命令示例:</p><pre class="ks kt ku kv fd kz la lb lc aw ld bi"><span id="93a3" class="le jp hh la b fi lf lg l lh li">curl --location --request POST 'https://&lt;IDCS INSTANCE&gt;.identity.oraclecloud.com/oauth2/v1/token' \<br/>--header 'Authorization: Basic &lt;base64 encoded clientID and clientSecret&gt;' \<br/>--header 'Content-Type: application/x-www-form-urlencoded' \<br/>--data-urlencode 'grant_type=refresh_token' \<br/>--data-urlencode 'refresh_token=&lt;REFRESH TOKEN OBTAINED FROM SECOND CURL COMMAND&gt;' \<br/>--data-urlencode 'scope=&lt;SCOPE FROM IDCS CONFIDENTIAL APP&gt;'</span></pre><p id="883b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您的用例需要以编程方式获取访问令牌，那么您将需要使用下面描述的方法之一，该方法允许您使用API获取访问令牌(以及刷新令牌)。</p><h1 id="cff9" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">授权类型</h1><p id="bd50" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">在本节中，我将描述授权类型的<a class="ae jn" href="https://docs.oracle.com/en/cloud/get-started/subscriptions-cloud/csimg/securing-authorizations-oracle-cloud.html" rel="noopener ugc nofollow" target="_blank">示例</a>，这些授权类型可用于获取与Oracle Analytics Cloud一起使用的访问令牌。</p><h2 id="def8" class="le jp hh bd jq lj lk ll ju lm ln lo jy ja lp lq kc je lr ls kg ji lt lu kk lv bi translated">资源所有者密码凭据</h2><p id="4398" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">这种<a class="ae jn" href="https://docs.oracle.com/en/cloud/paas/identity-cloud/rest-api/ROPCGT.html" rel="noopener ugc nofollow" target="_blank">授权类型</a>要求在API调用的有效负载中包含用户名和密码，因此它可能不适合所有用例。事实上，<a class="ae jn" href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics#page-9" rel="noopener ugc nofollow" target="_blank"> OAuth 2.0最佳实践</a>指南并不推荐使用这种授权类型。</p><p id="ab2b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">此外，<strong class="ir hi"> <em class="lw">如果您将联合用户</em> </strong>与Oracle分析云实例一起使用，则此授权类型不起作用。只有在Oracle IDCS本身定义了您的用户时，它才有效。</p><p id="5ba2" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这是一个使用这种授权类型获取访问令牌的curl命令示例。根据您自己的值需要替换的参数有<parameter>等。请注意，如果将“offline_access”添加到scope参数的末尾，则还会返回一个刷新令牌:</parameter></p><pre class="ks kt ku kv fd kz la lb lc aw ld bi"><span id="c1c9" class="le jp hh la b fi lf lg l lh li">curl --request POST '&lt;IDCS INSTANCE&gt;/oauth2/v1/token' \<br/>--header 'Authorization: Basic &lt;BASE64 ENCODED client ID:Client Secret&gt; ' \<br/>--header 'Content-Type: application/x-www-form-urlencoded' \<br/>--data-urlencode 'grant_type=password' \<br/>--data-urlencode 'username=&lt;USERNAME&gt;' \<br/>--data-urlencode 'password=&lt;PASSWORD&gt;' \<br/>--data-urlencode 'scope=&lt;SCOPE FROM IDCS CONFIDENTIAL APP&gt; offline_access'</span></pre><h2 id="1d98" class="le jp hh bd jq lj lk ll ju lm ln lo jy ja lp lq kc je lr ls kg ji lt lu kk lv bi translated">设备码</h2><p id="6ef8" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">正如我的<a class="ae jn" href="https://blogs.oracle.com/authors/amit-chakraborty" rel="noopener ugc nofollow" target="_blank">同事</a>在这篇<a class="ae jn" href="https://www.ateam-oracle.com/post/securing-oracle-analytics-cloud-rest-api-with-oci-iam-oauth-20-device-authorization-grant" rel="noopener ugc nofollow" target="_blank">博客</a>中所描述的那样，<a class="ae jn" href="https://docs.oracle.com/en/cloud/paas/identity-cloud/rest-api/DCGT.html" rel="noopener ugc nofollow" target="_blank">设备代码</a>授权是获得用于Oracle分析云的访问令牌的一个很好的选择。它与联合用户配合使用，并提供了一种机制，用户通过向Oracle IDCS进行身份验证来获取访问令牌，然后在现有令牌到期时使用刷新令牌来获取新的访问令牌。我将使用三个curl命令来说明这种授权类型的使用。</p><p id="c8f8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在第一个curl命令中，我们调用IDCS API来获取设备代码和用户代码，相应地替换参数<parameter>:</parameter></p><pre class="ks kt ku kv fd kz la lb lc aw ld bi"><span id="544c" class="le jp hh la b fi lf lg l lh li">curl --location --request POST 'https://&lt;IDCS INSTANCE&gt;.identity.oraclecloud.com/oauth2/v1/device' \<br/>--header 'Content-Type: application/x-www-form-urlencoded; charset=utf-8' \<br/>--data-urlencode 'response_type=device_code' \<br/>--data-urlencode 'scope=&lt;SCOPE FROM IDCS CONFIDENTIAL APP&gt; offline_access' \<br/>--data-urlencode 'client_id=&lt;CLIENT ID FROM IDCS CONFIDENTIAL APP&gt;'</span></pre><p id="58f6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这个curl命令的响应将与此类似。请注意验证URI，您必须以您的用户ID登录并传递user_code:</p><pre class="ks kt ku kv fd kz la lb lc aw ld bi"><span id="9893" class="le jp hh la b fi lf lg l lh li">{"device_code":"12a42e616264123ccb913a86df39c1397","user_code":"QYWNNPSS","verification_uri":"<a class="ae jn" href="https://idcs-d7b03c1eccf64cd5a0f0ea75f283dfed.identity.oraclecloud.com/ui/v1/device" rel="noopener ugc nofollow" target="_blank">https://&lt;IDCS INSTANCE .identity.oraclecloud.com/ui/v1/device</a>","expires_in":300}</span></pre><p id="5066" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">一旦您将user_code传递给登录到提供的IDCS URI时出现的UI，您将运行第二个curl命令，相应地替换<parameters>:</parameters></p><pre class="ks kt ku kv fd kz la lb lc aw ld bi"><span id="e12a" class="le jp hh la b fi lf lg l lh li">curl --location --request POST 'https://&lt;IDCS INSTANCE&gt;.identity.oraclecloud.com/oauth2/v1/token' \<br/>--header 'Content-Type: application/x-www-form-urlencoded' \<br/>--data-urlencode 'grant_type=urn:ietf:params:oauth:grant-type:device_code' \<br/>--data-urlencode 'client_id=&lt;CLIENT ID FROM IDCS CONFIDENTIAL APP&gt;' \<br/>--data-urlencode 'client_secret=&lt;CLIENT SECRET FROM IDCS CONFIDENTIAL APP&gt;' \<br/>--data-urlencode 'device_code=&lt;DEVICE CODE RETURNED FROM FIRST CURL COMMAND&gt;'</span></pre><p id="7a94" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">IDCS正在等待您执行第二个curl命令(注意到期时间)，并将返回一个访问令牌(如果在scope参数中使用了“offline_access ”,还可以返回一个刷新令牌)。</p><p id="7ad1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果您希望使用刷新令牌，在访问令牌到期时获取新的访问令牌，您可以使用以下curl命令:</p><pre class="ks kt ku kv fd kz la lb lc aw ld bi"><span id="b086" class="le jp hh la b fi lf lg l lh li">curl --location --request POST 'https://&lt;IDCS INSTANCE&gt;.identity.oraclecloud.com/oauth2/v1/token' \<br/>--header 'Authorization: Basic &lt;base64 encoded clientID and clientSecret&gt;' \<br/>--header 'Content-Type: application/x-www-form-urlencoded' \<br/>--data-urlencode 'grant_type=refresh_token' \<br/>--data-urlencode 'refresh_token=&lt;REFRESH TOKEN OBTAINED FROM SECOND CURL COMMAND&gt;' \<br/>--data-urlencode 'scope=&lt;SCOPE FROM IDCS CONFIDENTIAL APP&gt;'</span></pre><h2 id="91ff" class="le jp hh bd jq lj lk ll ju lm ln lo jy ja lp lq kc je lr ls kg ji lt lu kk lv bi translated">JWT断言</h2><p id="4abd" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">这个<a class="ae jn" href="https://docs.oracle.com/en/cloud/get-started/subscriptions-cloud/csimg/obtaining-access-token-using-self-signed-user-assertion-and-client-assertion.html" rel="noopener ugc nofollow" target="_blank">授权类型</a>也可以用于联合用户，并且需要一些额外的步骤来为客户端和用户创建签名的JWT断言。这个<a class="ae jn" href="https://redthunder.blog/2018/10/26/using-public-private-key-authentication-for-oracle-idcs/" rel="noopener ugc nofollow" target="_blank">博客</a>提供了整个过程的极好概述，我建议在使用下面的脚本之前先看一下这个博客。</p><p id="90b6" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当您创建IDCS机密应用程序时，请确保选择“客户证书”和“JWT声明”授权类型。此外，为“客户端类型”选项选择“可信”。</p><p id="4c30" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">以下Python脚本将为客户端和用户生成签名断言。然后，它将调用Oracle IDCS API来获取访问和刷新令牌。Python脚本依赖于可以使用pip安装的<a class="ae jn" href="https://pyjwt.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> PyJWT </a>和‘请求’包。</p><pre class="ks kt ku kv fd kz la lb lc aw ld bi"><span id="ff34" class="le jp hh la b fi lf lg l lh li">from datetime import datetime, timezone<br/>import jwt<br/>import requests</span><span id="649c" class="le jp hh la b fi lx lg l lh li">tokenIssued = int(datetime.now(tz=timezone.utc).timestamp())<br/>tokenExpiry = tokenIssued + 3600</span><span id="3af6" class="le jp hh la b fi lx lg l lh li"># These are the parameters you need to substitute for the values for <br/># your OAC instance and IDCS instance and confidential app<br/># The scope also includes 'offline_access' in order to also return a # refresh token</span><span id="9409" class="le jp hh la b fi lx lg l lh li">clientId = '&lt;CLIENT ID FROM IDCS CONFIDENTIAL APP&gt;'<br/>certAlias = '&lt;CERTIFICATE ALIAS FROM IDCS CONFIDENTIAL APP&gt;'<br/>userToAssert = '&lt;USER TO ASSERT&gt;'<br/>OACscope = '&lt;OAC SCOPE FROM IDCS CONFIDENTIAL APP&gt; offline_access'<br/>IDCS_url = 'https://&lt;IDCS INSTANCE&gt;.identity.oraclecloud.com/oauth2/v1/token'</span><span id="eb64" class="le jp hh la b fi lx lg l lh li">private_key = open('&lt;path to private RSA key&gt;', 'r').read()</span><span id="1c85" class="le jp hh la b fi lx lg l lh li"># The following details are used to create the JWT</span><span id="0a7d" class="le jp hh la b fi lx lg l lh li">header = {<br/>    "alg": "RS256",<br/>    "typ": "JWT",<br/>    "kid":certAlias<br/>}</span><span id="9aa3" class="le jp hh la b fi lx lg l lh li">client_payload = {<br/>    "sub":clientId,<br/>    "iss":clientId,<br/>    "aud": ["<a class="ae jn" href="https://identity.oraclecloud.com/" rel="noopener ugc nofollow" target="_blank">https://identity.oraclecloud.com/</a>"],<br/>    "iat":tokenIssued,<br/>    "exp":tokenExpiry<br/>}</span><span id="c3b1" class="le jp hh la b fi lx lg l lh li">user_payload = {<br/>    "sub":userToAssert,<br/>    "iss":clientId,<br/>    "aud": ["<a class="ae jn" href="https://identity.oraclecloud.com/" rel="noopener ugc nofollow" target="_blank">https://identity.oraclecloud.com/</a>"],<br/>    "iat":tokenIssued,<br/>    "exp":tokenExpiry<br/>}</span><span id="b525" class="le jp hh la b fi lx lg l lh li"># Create the signed assertions</span><span id="e476" class="le jp hh la b fi lx lg l lh li">encoded_user_assertion = jwt.encode(<br/>    payload = user_payload,<br/>    headers=header,<br/>    key=private_key,<br/>    algorithm="RS256")</span><span id="3ca8" class="le jp hh la b fi lx lg l lh li">encoded_client_assertion = jwt.encode(<br/>    payload = client_payload,<br/>    headers=header,<br/>    key=private_key,<br/>    algorithm="RS256")</span><span id="308d" class="le jp hh la b fi lx lg l lh li"># Create the payload and headers for the call to the IDCS API to <br/># obtain the access token</span><span id="718a" class="le jp hh la b fi lx lg l lh li">payload = {<br/>'grant_type' : 'urn:ietf:params:oauth:grant-type:jwt-bearer',<br/>'scope' : OACscope,<br/>'client_id' : clientId,<br/>'client_assertion_type' : 'urn:ietf:params:oauth:client-assertion-type:jwt-bearer',<br/>'assertion' : encoded_user_assertion,<br/>'client_assertion' : encoded_client_assertion<br/>}</span><span id="4780" class="le jp hh la b fi lx lg l lh li">headers = {<br/>  'content-type': 'application/x-www-form-urlencoded'<br/>}</span><span id="dd81" class="le jp hh la b fi lx lg l lh li"># Call the IDCS API and output the access token</span><span id="1fdd" class="le jp hh la b fi lx lg l lh li">response = requests.request("POST", IDCS_url, headers=headers, data=payload)</span><span id="acd5" class="le jp hh la b fi lx lg l lh li">print(response.text)</span></pre><h1 id="f365" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">参考</h1><p id="ebd8" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">以下参考资料在本博客的创建过程中非常有用:<br/> <a class="ae jn" href="https://oauth.net/2/" rel="noopener ugc nofollow" target="_blank"> OAuth 2.0 </a> <br/> <a class="ae jn" href="https://auth0.com/blog/how-to-handle-jwt-in-python/" rel="noopener ugc nofollow" target="_blank">如何在Python中处理jwt</a>。<br/>红雷<a class="ae jn" href="https://redthunder.blog/2017/06/08/jwts-jwks-kids-x5ts-oh-my/" rel="noopener ugc nofollow" target="_blank">博客</a>描述jwt及相关物品。<br/> Red Thunder <a class="ae jn" href="https://redthunder.blog/2018/10/26/using-public-private-key-authentication-for-oracle-idcs/" rel="noopener ugc nofollow" target="_blank">博客</a>关于Oracle IDCS使用公钥/私钥认证。<br/>来自<a class="ae jn" href="https://auth0.com/docs/get-started/applications/confidential-and-public-applications" rel="noopener ugc nofollow" target="_blank"> Auth0网站</a>的保密和公开申请说明。</p><h1 id="611e" class="jo jp hh bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">鸣谢</strong></h1><p id="bf6d" class="pw-post-body-paragraph ip iq hh ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated"><a class="ae jn" href="https://blogs.oracle.com/authors/amit-chakraborty" rel="noopener ugc nofollow" target="_blank"> Amit Chakraborty </a>对设备代码授予类型的指导。<br/> <a class="ae jn" href="https://blogs.oracle.com/analytics/authors/gabrielle-prichard" rel="noopener ugc nofollow" target="_blank"> Gabrielle Prichard </a>获得python脚本和审阅本博客草稿的指导。</p></div><div class="ab cl ly lz go ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ha hb hc hd he"><p id="e51d" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">想讨论这个或其他开发者话题吗？<a class="ae jn" href="https://bit.ly/odevrel_slack" rel="noopener ugc nofollow" target="_blank">加入我们的公共休闲频道</a>！</p></div></div>    
</body>
</html>