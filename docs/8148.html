<html>
<head>
<title>Diavol resurfaces</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Diavol重新露面</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/diavol-resurfaces-91dd93c7d922?source=collection_archive---------6-----------------------#2022-09-30">https://medium.com/walmartglobaltech/diavol-resurfaces-91dd93c7d922?source=collection_archive---------6-----------------------#2022-09-30</a></blockquote><div><div class="es gk gl gm gn go"/><div class="gp gq gr gs gt"><div class=""/><p id="880d" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">作者:杰森·里维斯和乔纳森·麦凯</p><figure class="is it iu iv ek iw dy dz paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="dy dz ir"><img src="../Images/b0d055070cbc3a9b3c04448e1cfd3a1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JhSR5kUA7fs-vBxG.png"/></div></div></figure><p id="ca4a" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">我们之前浏览了Diavol勒索软件变种文件加密[1]，它与TrickBot group[2]有关联。最近分手后，Diavol几乎消失了。奇怪的是，我们开始注意到提交给VirusTotal的样本数量有所上升。在调查最近的样本时，我们能够确定它对文件混合使用RSA加密和XOR编码。在某些情况下，文件恢复仍然是可能的。</p><p id="bb68" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">在VirusTotal上发现了以下样本:</p><pre class="is it iu iv ek jd je jf jg aw jh bi"><span id="6a14" class="ji jj gw je b ev jk jl l jm jn">SHA256: aac969e36686f8f8517c111d30f8fb3b527988ebd31b3b762aec8d46e860eb9d<br/>Creation Time 2022-09-05 20:01:56 UTC<br/>First Submission 2022-09-09 21:06:06 UTC <br/>Last Submission 2022-09-13 15:50:00 UTC <br/>Last Analysis 2022-09-13 15:50:00 UTC<br/><br/>SHA256: fb5ee29b98446d34520bf04a82996eefec3b5692710c5631458da63ef7e44fe4<br/>Creation Time 2022-09-05 20:04:30 UTC<br/>First Submission 2022-09-11 20:30:20 UTC <br/>Last Submission 2022-09-11 20:30:20 UTC <br/>Last Analysis 2022-09-11 20:30:20 UTC <br/><br/>SHA256: 708806f5e2e8bfa3d1e911e391ff2ccf1edcac05cc1df80439b8b867253423df<br/>Creation Time 2022-08-25 16:12:58 UTC<br/>First Submission 2022-08-29 19:49:08 UTC <br/>Last Submission 2022-09-03 15:40:44 UTC <br/>Last Analysis 2022-09-03 15:40:44 UTC</span></pre><p id="2b17" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">样本现在是64位，但功能相似。出于本报告的目的，我们将仔细检查上面的7088样本。出于本报告的目的，我们将仔细检查上面的7088样本。</p><pre class="is it iu iv ek jd je jf jg aw jh bi"><span id="1346" class="ji jj gw je b ev jk jl l jm jn">group=test<br/>file_ext=.bully<br/>note_filename=WARNING.txt</span></pre><p id="3836" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">文件加密仍然需要使用一个2048字节的XOR密钥，它是在主bot的GENBOTID片段中随机生成的。然后，密钥被存储在主bot中，并在文件加密代码中重用。那么除非要编码的数据量小于2048字节，否则循环将读取2048字节的块:</p><p id="4124" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">文件加密的第一部分是前面提到的2048字节XOR密钥的使用。对于大多数文件，将要进行XOR编码的字节数基于总文件大小除以10。那么除非要编码的数据量小于2048字节，否则循环将读取2048字节的块:</p><figure class="is it iu iv ek iw dy dz paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="dy dz jo"><img src="../Images/e2e05a37ad18487a055e0f78c9a75c24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rECwUc0gPafBGqFiBA2IGA.png"/></div></div></figure><p id="145e" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">已经实现了一个类似的XOR循环，这可以在Diavol[1]的以前版本中看到。该循环将对读取的数据块进行XOR编码，然后将其写回文件:</p><figure class="is it iu iv ek iw dy dz paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="dy dz jp"><img src="../Images/388d0b1c47d1decc071bd8b6c52e0076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xpdn22NzZxzDZHWC66n-9Q.png"/></div></div></figure><p id="3451" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">对文件进行XOR编码后，RSA加密的XOR密钥被写入文件末尾，后跟编码的字节数:</p><figure class="is it iu iv ek iw dy dz paragraph-image"><div class="dy dz jq"><img src="../Images/37852065ad54221d972867c52877a136.png" data-original-src="https://miro.medium.com/v2/resize:fit:816/format:webp/1*kKPzpZ3t1i5S9XeW5ph66w.png"/></div></figure><p id="06e5" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">接下来，bot single XOR对编码的字节数进行编码，并将其写入文件的末尾:</p><figure class="is it iu iv ek iw dy dz paragraph-image"><div role="button" tabindex="0" class="ix iy di iz bf ja"><div class="dy dz jr"><img src="../Images/9205ebc728389aa02630e1e069eb1426.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ln7WWEWed53eWMFle8ESjg.png"/></div></div></figure><p id="a001" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">在进行XOR编码并将适当的数据写入文件末尾后，bot返回到文件的开头，并开始读取0x75字节的数据块。它将对它们进行RSA加密，然后将加密的字节写回到文件中，但没有填充字节。这样，文件开头的0x75 * 10或1170字节将在进行XOR编码后进行RSA加密。</p><figure class="is it iu iv ek iw dy dz paragraph-image"><div class="dy dz js"><img src="../Images/43e362297f99bed6bae39db76b0b8936.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/1*wJwQhBBwCKPfgqIupOsSXQ.png"/></div></figure><p id="1a08" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">使用一个空文件和一个大的MSI文件，可以执行一个快速测试来验证我们的发现。首先，我们验证添加到文件中的最终数据，它应该是距离末尾110+0x900+16个字节:</p><pre class="is it iu iv ek jd je jf jg aw jh bi"><span id="2ee7" class="ji jj gw je b ev jk jl l jm jn">&gt;&gt;&gt; data = open('test_data.txt.bully', 'rb').read()<br/>&gt;&gt;&gt; 110+0x900+16 <br/>2430<br/>&gt;&gt;&gt; end = data[-2430:]</span></pre><p id="5ca5" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">跳过RSA加密的XOR密钥应该显示两个8字节的值，第二个用0xFF进行XOR编码</p><pre class="is it iu iv ek jd je jf jg aw jh bi"><span id="c3b5" class="ji jj gw je b ev jk jl l jm jn">&gt;&gt;&gt; end[0x900:]<br/>'\x88\x13\x00\x00\x00\x00\x00\x00w\xec\xff\xff\xff\xff\xff\xffk\xa8\x0f/6o\x12\x08\xd6\xbe\xaaw\xf1\x1b0\x1f\x10\x12\x9b\x12\xcc?\xf4\xbd\x03\xf9H\x01\x99\xa6\xd7\x9ae\xee\xf3\xa7\xe9\xc6\xb1\xf8\x81\xe0\xb6\xc4\xbaD\xa2\xb9jM\xd0\x05zj\xb7s#\xe6q\xb3\xf3\x8d\xe7\x00\x05\xa6OT\xba\x7f\xdd))\xb4\xfbu\x9anK0J\xa9\x03\xbb\xd5\xcfZ=\xe2\x15\xba\xd6&gt;\x18V\x12\x0fP\xb8\x80O\xb4\xd4\xf6\xd2C\nHcT'<br/>&gt;&gt;&gt; 0x1388<br/>5000<br/>&gt;&gt;&gt; end[0x900+8:]<br/>'w\xec\xff\xff\xff\xff\xff\xffk\xa8\x0f/6o\x12\x08\xd6\xbe\xaaw\xf1\x1b0\x1f\x10\x12\x9b\x12\xcc?\xf4\xbd\x03\xf9H\x01\x99\xa6\xd7\x9ae\xee\xf3\xa7\xe9\xc6\xb1\xf8\x81\xe0\xb6\xc4\xbaD\xa2\xb9jM\xd0\x05zj\xb7s#\xe6q\xb3\xf3\x8d\xe7\x00\x05\xa6OT\xba\x7f\xdd))\xb4\xfbu\x9anK0J\xa9\x03\xbb\xd5\xcfZ=\xe2\x15\xba\xd6&gt;\x18V\x12\x0fP\xb8\x80O\xb4\xd4\xf6\xd2C\nHcT'<br/>&gt;&gt;&gt; l = bytearray('w\xec')<br/>&gt;&gt;&gt; l[0] ^= 0xff<br/>&gt;&gt;&gt; l[1] ^= 0xff<br/>&gt;&gt;&gt; l<br/>bytearray(b'\x88\x13')</span></pre><p id="7cda" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">由于文件为空，所以在我们跳过开头的1170个RSA加密字节后，明文XOR密钥应该是前2048个字节:</p><pre class="is it iu iv ek jd je jf jg aw jh bi"><span id="a07a" class="ji jj gw je b ev jk jl l jm jn">&gt;&gt;&gt; key = bytearray(data[1170:1170+2048])</span></pre><p id="114a" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">我们可以对另一个文件进行测试，在本例中是MSI:</p><pre class="is it iu iv ek jd je jf jg aw jh bi"><span id="37da" class="ji jj gw je b ev jk jl l jm jn">&gt;&gt;&gt; data2 = open('powerpointmui.msi.bully', 'rb').read()<br/>&gt;&gt;&gt; test_block = bytearray(data2[1170:])<br/>&gt;&gt;&gt; <br/>&gt;&gt;&gt; for i in range(len(test_block)):<br/>...   test_block[i] ^= key[i%2048]<br/>...<br/>&gt;&gt;&gt; test_block[:10000]<br/>bytearray(b'\xa4A(H\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x18\x00\x02\x01\x1c\x00\x00\x00#\x00\x00\x00\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00....<br/>snip<br/>....<br/>02\x00\x00\x12\x00\x00\x000\x02\x00\x00\x02\x00\x00\x00\xe4\x04\x00\x00\x1e\x00\x00\x00\x16\x00\x00\x00Installation Database\x00\x00\x00\x1e\x00\x00\x00;\x00\x00\x00Microsoft Office PowerPoint MUI (Portuguese (Brazil)) 2007\x00\x00\x1e\x00\x00\x00\x16\x00\x00\x00Microsoft Corporation\x00\x00\x00\x1e\x00\x00\x00"\x00\x00\x00Installer, MSI, Database, Release\x00\x00\x00\x1e\x00\x00\x00\x84\x00\x00\x00This Installer database contains the logic and data required to install Microsoft Office PowerPoint MUI (Portuguese (Brazil)) 2007.<br/>...snip...</span></pre><p id="07c0" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">因此，在您恢复XOR密钥后，可以轻松地恢复每个文件的大部分内容。下一步只是重建前1170个字节。</p><h1 id="5344" class="jt jj gw bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">IOCs</h1><p id="7d1d" class="pw-post-body-paragraph ht hu gw hv b hw kq hy hz ia kr ic id ie ks ig ih ii kt ik il im ku io ip iq gp bi translated">端点:</p><pre class="is it iu iv ek jd je jf jg aw jh bi"><span id="f18e" class="ji jj gw je b ev jk jl l jm jn">WARNING.txt<br/>warning.txt<br/>.bully</span><span id="d93c" class="ji jj gw je b ev kv jl l jm jn">4eb5bea255c0308b296f5aa259f68626<br/>88b41ba2d6b7cca40118de9007cf64a0e5cc9710<br/>aac969e36686f8f8517c111d30f8fb3b527988ebd31b3b762aec8d46e860eb9d</span><span id="0b21" class="ji jj gw je b ev kv jl l jm jn">cba851aab28c4b52fb9f0c655d2c0c0e<br/>9697acfa83a31c2925b72f627c9be51346cf5dd0<br/>fb5ee29b98446d34520bf04a82996eefec3b5692710c5631458da63ef7e44fe4</span><span id="c61b" class="ji jj gw je b ev kv jl l jm jn">332c1a9146276bc9abc1161e13efabde<br/>6c366cd3b4a54f8e9f7ed6016aac9e7509b06102<br/>708806f5e2e8bfa3d1e911e391ff2ccf1edcac05cc1df80439b8b867253423df</span></pre><p id="6ad0" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">勒索信:</p><pre class="is it iu iv ek jd je jf jg aw jh bi"><span id="6912" class="ji jj gw je b ev jk jl l jm jn">You've been hacked. All your corporate network servers and workstations are encrypted.Your company is a victim of double extortion ransomware attack.\rhat is it? Basically it means that not only your data is encrypted, but it's also have been exfiltrated from your network.Double Extortion attack explained in details :https://www.zscaler.com/resources/security-terms-glossary/what-is-double-extortion-ransomware\r==== What now? =====If you want your network to be fully operational again and if you want us not to publish all files we've taken :1. Download Tor Browser from original site : https://torproject.org\r. Open this url in Tor Browser and visit this website : https://7ypnbv3snejqmgce4kbewwvym4cm5j6lkzf2hra2hyhtsvwjaxwipkyd.onion/\r. Enter this key : 57C0E-4C543-DCABB-EBF0C-2EDCA-A9FC4If you've done everything correctly - now you are able to contact us and take a chance to leave this all behind for a reasonable fee.\rOTE : If TOR network is unavailable by any reason - you can use any VPN service to solve it.</span></pre><p id="9283" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">网络:</p><pre class="is it iu iv ek jd je jf jg aw jh bi"><span id="e9de" class="ji jj gw je b ev jk jl l jm jn">hxxps://7ypnbv3snejqmgce4kbewwvym4cm5j6lkzf2hra2hyhtsvwjaxwipkyd[.]onion<br/>173.232[.]146[.]118</span></pre><h1 id="023d" class="jt jj gw bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">参考</h1><p id="20e2" class="pw-post-body-paragraph ht hu gw hv b hw kq hy hz ia kr ic id ie ks ig ih ii kt ik il im ku io ip iq gp bi translated">1:<a class="ae kw" rel="noopener" href="/walmartglobaltech/diavol-the-enigma-of-ransomware-1fd78ffda648">https://medium . com/walmartglobaltech/diavol-the-enigma-of-ransomware-1fd 78 ffda 648</a></p><p id="6c81" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">2:<a class="ae kw" href="https://www.bleepingcomputer.com/news/security/fbi-links-diavol-ransomware-to-the-trickbot-cybercrime-group/" rel="noopener ugc nofollow" target="_blank">https://www . bleeping computer . com/news/security/FBI-links-diavol-ransomware-to-the-trick bot-cyber crime-group/</a></p><p id="0115" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">3:<a class="ae kw" href="https://www.advintel.io/post/the-trickbot-saga-s-finale-has-aired-but-a-spinoff-is-already-in-the-works" rel="noopener ugc nofollow" target="_blank">https://www . adv Intel . io/post/the-trick bot-saga-s-finale-has-air-but-a-spindle-is-always-in-work</a></p><p id="ab99" class="pw-post-body-paragraph ht hu gw hv b hw hx hy hz ia ib ic id ie if ig ih ii ij ik il im in io ip iq gp bi translated">4:<a class="ae kw" href="https://www.bleepingcomputer.com/news/security/conti-ransomware-shuts-down-operation-rebrands-into-smaller-units/" rel="noopener ugc nofollow" target="_blank">https://www . bleeping computer . com/news/security/conti-ransomware-shuts-down-operation-rebrands-into-small-units/</a></p></div></div>    
</body>
</html>