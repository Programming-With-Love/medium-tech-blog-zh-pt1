# 将大型企业迁移到 NodeJS

> 原文：<https://medium.com/walmartglobaltech/migrating-large-enterprise-to-nodejs-6c38523d2b33?source=collection_archive---------0----------------------->

![](img/fdb950570f9507f2f9bef783aa3eddc1.png)

odeJS 席卷了开源社区，并迅速成为最受欢迎的开发平台。随着在企业环境中的良好记录，越来越多的公司正在采用它。在 [@WalmartLabs](https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------) 时，我们是 NodeJS 的前沿用户，早期的采用工作如 [hapi](https://hapijs.com/) 的开发。这里总是有一个繁荣的 NodeJS 社区。有了[电极](http://www.electrode.io/)，它大大加快了 NodeJS 在 [@WalmartLabs](https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------) 中的使用，现在为我们 http://www.walmart.com 的大部分电子商务网站[供电。](http://www.walmart.com.)在这篇博客中，我将回顾一些推动电极被采用的关键因素。

在你进一步阅读之前，请注意有些观点是固执己见的。这是我们认为采用 NodeJS 的重要性的高层次概述，但是肯定有其他方法来实现这个目标。

## 获得管理层支持

要开发一个通用平台来改变公司开发社区的一大部分，高管们的支持是必不可少的。获得支持可能并不容易。你只能展示 NodeJS 的成功和优势来说服你的高管。他们必须首先被说服，并主动提供支持。幸运的是，我们的高管已经普遍对 NodeJS 持开放态度，部分原因是 NodeJS 在各个项目中的成功使用。

## 提供全面的解决方案

NodeJS 的一大优势是开发应用程序非常容易，尤其是有了所有可用的开源资源。一些 [@WalmartLabs](https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------) 团队使用 NodeJS 成功开发了他们的应用，但是他们必须以自己的方式处理一切，包括 CI/CD 设置、部署、监控以及与现有基础设施的集成。一个解决这些问题的平台将对任何希望在应用程序中使用 NodeJS 的团队有所帮助。

我在[@ walmartlab](https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------)的头几周，在我写一行 JavaScript 代码之前，我花了一些时间学习内部 [OneOps cloud infra](http://oneops.com/) 和 Jenkins build 系统。然后我设计了一个通用的可重用的方法,让构建和部署 NodeJS 应用变得简单无缝。我在我的另一篇博客中写了一些技术细节。

最终，我们确保任何使用电极平台的团队在其应用开发周期的每一步都有一个解决方案。其中包括:

1.  入门和培训支持
2.  持续开发和集成设置
3.  获取云实例并向其部署应用程序
4.  自动化功能端到端集成和回归测试
5.  生产稳定性和性能监控支持

![](img/6af95578278b0f8e7105f9b7ca9011ad.png)

Offering all the pieces is important.

## 提供可重复的部署

重要的是，团队可以构建他们的应用程序的不可变版本，以便他们可以在任何时间部署任何版本。在 [@WalmartLabs](https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------) 的一般标准实践是将应用程序及其`node_modules`发布到内部 npm 注册表。我们不得不开发一种新的方法，因为 npm 不适合这种用途。

将应用程序打包成二进制不可变工件，甚至锁定 NodeJS 运行时的版本，这一点极其重要。所以我们最终做的是用内置的设置清单创建应用程序的 zip 工件，并将其推送到我们的内部 Nexus 存储库。

## 提供入职支持

我们的开发人员对 JavaScript 和 NodeJS 有不同程度的经验。为了帮助所有团队参与进来，我们投入了大量资源来开发培训材料，并通过 slack 频道提供实时支持。

## 支持生产监控

每个团队都必须对生产环境中运行的应用程序的运行状况进行实时监控，以便对问题做出反应。他们还需要能够随着时间的推移收集指标，以了解趋势。[@ WalmartLabs](https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------)one ops cloud 已经为应用健康监控和修复提供了许多内置支持。为了增加额外的支持，我们花费了大量时间来实施与我们各种后端基础架构(如 Splunk 的内部 Kafka 实例和服务)集成的工具和 APM 库。

![](img/8d543fa24df0d4c3deab08f70a91c041.png)

Offer 24/7 realtime and comprehensive monitoring of app health and performance.

## 标准化集成

要运营一个像 http://www.walmart.com T2 这样的电子商务网站，幕后有许多非常复杂的系统。 [@WalmartLabs](https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------) 有内部 *uService* 架构。这些服务像 http 端点一样松散地实现为 REST。有了工具跟踪和服务到服务授权之类的支持，在调用这些服务时需要做一些设置工作。现有的节点代码每次都要重新发明轮子。

我们的决定是使用 Swagger 规范标准化所有服务客户端。由于我们的服务端点中的一些非标准的东西，我们实际上不得不稍微定制实现。结果是每个团队的共同努力，为我们使用的所有服务创建了共享客户端。

![](img/7fbf65d2e7b610a4cc32783dc1722169.png)

Standardizing allow all teams to come together to build and share modules.

## 制定发布模块的计划

对于 NodeJS 的任何大规模内部采用，能够发布您的私有模块是必不可少的。您可以运行自己的内部注册表或使用 npm 的私有模块服务。 [@WalmartLabs](https://medium.com/u/c884135151a4?source=post_page-----6c38523d2b33--------------------------------) 已经有了一个内部 npm 企业实例。然而，我们在数据库存储方面有问题，所以另一个团队进来，在现有的 Nexus 存储库的基础上构建了一个新的数据库。如果您想避免这种情况，那么 npm 的私有模块服务是一个不错的选择。

## 审核您使用的 npm 模块

NodeJS 的模块生态系统是惊人的。现在 npm 注册表中有将近 50 万个模块。你几乎可以找到任何你想做的事情的模块。然而，有些模块可能有严重的错误或恶意黑客的意图。所以使用众所周知和流行的模块通常是一个好主意。如果你想使用一个很少使用的模块，那么就要格外小心，仔细检查它的代码，确保它做你认为它做的事情。

## 锁定依赖关系

使用 npm 的 NodeJS 中的标准实践是使用 [semver](http://semver.org/) 来获取依赖关系的新的次要版本或补丁版本。然而，这也打开了你的应用程序，让你在下一次`npm install`中获得你可能没有预料到的变化。npm 有收缩包装功能。npm@5 和 yarn 具有锁定功能。利用这些来帮助为你的应用维护一个更加一致的模块安装，并保持对何时更新你的依赖关系的更好的控制。提交每个版本的锁文件。当你更新的时候，调试哪个依赖破坏了你的应用是很重要的。

## 支持灵活的动态配置

要在复杂的企业环境中支持数十种不同的应用，灵活的动态配置非常重要。NodeJS 应用程序开发周期通常会在进入生产环境之前首先经过本地、开发和试运行环境。其中每一种都有不同的支持，需要进行不同的配置。虽然 hapi 有[置信度](https://github.com/hapijs/confidence)模块，但我们选择了[节点配置](https://github.com/lorenwest/node-config)。

然而，仅基于`NODE_ENV`构建配置是不够的，因为当在我们的开发和登台云上运行时，它应该总是`production`。我们的应用程序必须能够选择基于云环境的配置，而不是`NODE_ENV`。此外，我们有需要与应用程序集成的内部动态中央配置管理。

为了满足这些需求，实现了一个新的 NodeJS 应用配置管理模块，类似于名为[电极配置](https://github.com/electrode-io/electrode-confippet)的 node-config。然后，confippet 的可扩展性支持被用来实现另一个模块，该模块构成了特定于我们的云设置的配置。

![](img/1bf63752323fd1b7081e1279ba84f692.png)

Give your user the flexibility to configure their app.

## 考虑哲学理想

NodeJS 生态系统的好处之一是所有的资源都是可用的。JavaScript 的本质为猴子补丁现象打开了大门。一般来说，猴子补丁是一个坏主意，但你愿意不惜任何代价避开它，包括完全阻止你的项目吗？

我遇到的一个问题是基于 Java 的用户服务平台代码坚持我们的内部 http 头都是大写的。NodeJS 自动将所有 http 头转换成小写。Java 团队正在开发一个新的版本，他们不想对此进行修改。为了推进项目，NodeJS 核心被打了猴子补丁，以保持我们的内部 http 头全部大写。我在[这个博客](/p/f2a10ea3028e)中写了这个。

猴子补丁是一个极端的例子，但每个人都有自己的看法和理想。有时，为了避开拦截器，您可能必须将某些拦截器放在一边。

## 使用承诺

自早期以来，承诺一直是一个有争议的话题。有一个阵营坚决反对，除了回调什么都不用。事实上，有人称之为 NodeJS 反模式。

不要释放萨尔戈怪物。你可以用承诺来避免。您可以通过一个简单的标准接口将任何异步操作附加到承诺链中。在一个拥有大量业务逻辑的大型应用程序中，Promise 使得控制流程和错误处理变得非常容易。在使用回调处理复杂的业务逻辑的无尽迷宫中，我有很多糟糕的经历。

随着 babel 等工具的出现和 Node 8 中 async/await 的引入，Promise 的吸引力越来越大，任何向 NodeJS 迁移的努力都应该尽可能地使用 Promise。能够用 async/await 编写线性的异步 JavaScript 代码是一种变革。

![](img/03f08342c93150debfb919ea7ce33168.png)

Like legos, Promise offers a simple way to connect all your async pieces.

## 找到一条渐进的入职路径

在我们说服任何团队致力于新平台之前，我们必须首先证明它的可行性。为了做到这一点，我们选择了一个低风险的商业应用程序，并召集了一个高级开发人员团队，开始开发新的应用程序。这个团队还帮助我们进行 beta 测试，并为我们解决问题提供有价值的反馈。这款应用的成功给了其他团队信心，让他们开始使用自己的应用。

## 遵循 NodeJS 最佳实践

NodeJS 提供了一种在生产环境中运行服务器的不同方法，其他人已经发现了一些帮助平稳运行它的实践。例如，在节点服务器前面运行 nginx 作为 http 代理是常见的做法。在代码和部署过程中拥有健壮的错误处理也很重要。一定要搜索`node js production best practices`并阅读它找到的一些文章。

## 采用标准，但拥抱所有者

作为结束语，请注意我们的很多努力都是让 NodeJS 与现有的专有技术一起工作。例如，当我们开始 OneOps 时，就有关于集装箱化方法的讨论。最后，我们选择了利用已经存在的东西。然而，当有意义时，采用已建立的标准也很重要。因此，当我们有机会使用 Swagger 来标准化 NodeJS 领域的服务消费时，我们选择了它。

## 结论

这是我们认为将企业迁移到 NodeJS 的重要技术项目的高度概述。在 2016 节点峰会上，[阿历克斯·格里戈良](https://medium.com/u/54a709eacdb7?source=post_page-----6c38523d2b33--------------------------------)的演讲中，一些物流项目涵盖得更好。还有很多其他的小事情，每一件都有很多细节。我计划在未来写更多关于他们的内容。