<html>
<head>
<title>Shrinking your app with R8</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用R8缩小你的应用</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/shrinking-your-app-with-r8-909efac25de4?source=collection_archive---------0-----------------------#2020-07-28">https://medium.com/androiddevelopers/shrinking-your-app-with-r8-909efac25de4?source=collection_archive---------0-----------------------#2020-07-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><figure class="hg hh ez fb hi hj er es paragraph-image"><div role="button" tabindex="0" class="hk hl di hm bf hn"><div class="er es hf"><img src="../Images/5b0a3e414f064e1fb026acc9edfbd0ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ltpwqDXPqmns7Zt2"/></div></div></figure><div class=""/><p id="19d1" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><em class="jn">由软件工程师索伦·杰希和软件工程师克里斯托夫·亚当森发布</em></p><p id="b867" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">下载量和安装占用空间较小的应用更有可能被安装并持续安装，尤其是在新兴市场。有了R8编译器，您现在可以通过收缩、混淆和优化获得更全面的支持。</p><p id="8b68" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在本帖中，我们提供了在R8可用的特性的概述，您可能期望的代码大小的减少，并展示了如何在R8启用这些特性。</p><h1 id="643d" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">R8缩小特征</h1><p id="2e3f" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">R8提供了四个旨在减少你的Android应用程序大小的功能:</p><ul class=""><li id="5f2c" class="kr ks hs ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated"><strong class="ir ht">摇树</strong>:使用静态代码分析发现并移除不可达代码和未实例化类型。</li><li id="862a" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated"><strong class="ir ht">优化</strong>:通过移除死代码、选择性内联、移除未使用的参数和类合并来优化代码大小。</li><li id="119a" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated"><strong class="ir ht">标识符重命名又称混淆</strong>:使用短名称和压缩包名称空间。</li><li id="de4b" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated"><strong class="ir ht">减少调试信息</strong>:规范化调试信息，压缩行号信息。</li></ul><h1 id="5bd4" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">为什么我们需要R8萎缩</h1><p id="7a36" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">当你编写一个应用程序时，所有的代码都应该服务于一个目的，并实现应用程序中的功能。但是大部分app都使用第三方库，比如<a class="ae lf" href="https://developer.android.com/jetpack" rel="noopener ugc nofollow" target="_blank"> Jetpack </a>、<a class="ae lf" href="https://square.github.io/okhttp/" rel="noopener ugc nofollow" target="_blank"> OkHttp </a>、<a class="ae lf" href="https://github.com/google/guava" rel="noopener ugc nofollow" target="_blank"> Guava </a>、<a class="ae lf" href="https://github.com/google/gson" rel="noopener ugc nofollow" target="_blank"> Gson </a>和<a class="ae lf" href="https://developers.google.com/android/guides/overview" rel="noopener ugc nofollow" target="_blank"> Google Play Services </a>，用Kotlin编写的app总是包含<a class="ae lf" href="https://kotlinlang.org/api/latest/jvm/stdlib/" rel="noopener ugc nofollow" target="_blank"> Kotlin标准库</a>。当您使用这些第三方库之一时，通常每个单独的库只有很小一部分在您的应用程序中使用。如果不收缩，所有库代码都会保留在您的应用程序中。</p><p id="6fad" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">您的代码也可能比实际需要的要大，因为冗长的代码有时会提高可读性和可维护性:例如，您可能会努力使用有意义的变量名和生成器模式，以便其他人更容易查看和理解您的代码。但是这些模式是以代码大小为代价的——通常，您自己编写的代码提供了大量缩减的机会。</p><h1 id="f4f4" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">启用应用程序的R8收缩</h1><p id="a1cd" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">要让R8为发布版本收缩你的应用，在你的应用主<code class="du lg lh li lj b">build.gradle</code>文件中设置<code class="du lg lh li lj b">minifyEnable</code>为真，如下所示:</p><figure class="lk ll lm ln fd hj"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="f319" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">不要让这个名字迷惑了你——它会让R8退缩。</p><h1 id="4e1e" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">R8会将你的应用程序缩小多少？</h1><p id="b4da" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">R8可以大大减少你的应用程序的大小。例如，去年的Google I/O应用程序在收缩前为18.55 MB，包含150，220个方法和3个dex文件。收缩后，该应用程序减少到6.45 MB，包含45，831个方法和1个dex文件。R8节省了65%的dex大小(用Android Studio 3.5.1和<a class="ae lf" href="https://github.com/google/iosched" rel="noopener ugc nofollow" target="_blank"> IOSched示例应用</a>在<a class="ae lf" href="https://github.com/google/iosched/commit/7b1e6c3f1efcca6bd25d2ca10a1b839eb51eb0b1" rel="noopener ugc nofollow" target="_blank"> this commit </a>测得)。</p><h1 id="a47a" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">基本收缩算法</h1><p id="3527" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">为简单起见，让我们以Java编程语言中的独立程序为例:</p><figure class="lk ll lm ln fd hj"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="ed2a" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">程序的入口点是静态void main方法，我们使用下面的<a class="ae lf" href="https://developer.android.com/studio/build/shrink-code#configuration-files" rel="noopener ugc nofollow" target="_blank"> keep规则</a>来指定它:</p><figure class="lk ll lm ln fd hj"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="0ede" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">R8收缩算法的工作原理如下:</p><ul class=""><li id="2061" class="kr ks hs ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">首先，它从程序众所周知的入口点跟踪所有可到达的代码——这些入口点是由R8 <a class="ae lf" href="https://developer.android.com/studio/build/shrink-code#configuration-files" rel="noopener ugc nofollow" target="_blank"> keep规则</a>定义的。例如，在这个Java代码示例中，R8将从main方法开始。</li><li id="8f58" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">在这个例子中，R8从主方法追溯到问候方法。greeting方法调用运行时，因此跟踪在那里停止。</li><li id="68c7" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">跟踪完成后，R8使用一种叫做树抖动的优化来删除未使用的代码。在本例中，树抖动删除了未使用的方法，因为R8的跟踪步骤检测到该方法无法从任何已知的入口点到达。</li><li id="1406" class="kr ks hs ir b is la iw lb ja lc je ld ji le jm kw kx ky kz bi translated">接下来，R8将标识符重命名为在DEX文件中占用较少空间的较短名称。在这个例子中，R8可能会将方法greeting重命名为更短的名称<code class="du lg lh li lj b">a</code>:</li></ul><figure class="lk ll lm ln fd hj"><div class="bz dy l di"><div class="lo lp l"/></div></figure><ul class=""><li id="f6ba" class="kr ks hs ir b is it iw ix ja kt je ku ji kv jm kw kx ky kz bi translated">最后，应用代码优化。其中之一是内联，这会导致代码更少。在这个例子中，将方法<code class="du lg lh li lj b">a</code>的主体直接移到main中会使代码变得更小:</li></ul><figure class="lk ll lm ln fd hj"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="1f26" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如您所见，结果代码比原始代码小得多。</p><h1 id="9584" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">为R8萎缩准备应用程序</h1><p id="b328" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">像一个独立的Java程序一样，Android应用程序有许多众所周知的入口点:活动、服务、内容提供者和广播接收者。aapt2工具通过基于Android清单文件生成keep规则来为您处理这些入口点。</p><p id="cbb4" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">除了这些众所周知的入口点，Android应用程序还需要其他标准的keep规则。这些规则由Android Gradle插件在默认配置文件中提供，您可以在配置您的版本时指定该文件:</p><figure class="lk ll lm ln fd hj"><div class="bz dy l di"><div class="lo lp l"/></div></figure><h1 id="1685" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">应用程序代码中的反射</h1><p id="d8da" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">反射会产生R8在跟踪代码时无法识别的代码入口点。请记住，反射也可能发生在第三方库中，因为第三方库实际上是应用程序的一部分，所以作为应用程序开发人员，您实际上要对这些库中以及您自己的代码中执行的反射负责。库可能会附带自己的规则，但请记住，许多库不是用Android编写的，也没有考虑到收缩，所以它们可能需要额外的配置。</p><p id="a57c" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">举一个Kotlin类的例子，它有一个名为<code class="du lg lh li lj b">name</code>的字段和一个<code class="du lg lh li lj b">main</code>方法，该方法创建一个实例并将该实例序列化为JSON:</p><figure class="lk ll lm ln fd hj"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="b6dc" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">收缩代码后，运行程序输出一个空的JSON对象<code class="du lg lh li lj b">{}</code>。这是因为R8只看到字段名是写的(这发生在Person构造函数中)而不是读的，所以R8删除了它。Person最终没有字段，导致JSON对象为空。然而，字段<em class="jn">被Gson串行器</em>读取，但是Gson使用反射技术来这样做，所以R8看不到这个字段被读取。</p><p id="b46c" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">为了保留<code class="du lg lh li lj b">name</code>字段，在您的<code class="du lg lh li lj b"><a class="ae lf" href="https://developer.android.com/studio/build/shrink-code#add-configuration" rel="noopener ugc nofollow" target="_blank">proguard-rules.pro</a></code>文件中添加一个保留规则:</p><figure class="lk ll lm ln fd hj"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="165f" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这条规则指示R8不要在班级里触摸名为“人”的字段。有了这些，运行代码就会得到预期的JSON对象<code class="du lg lh li lj b">{“name”:”Søren Gjesse”}</code>。</p><p id="f800" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">最后，在设置您的项目时，确保将<code class="du lg lh li lj b">proguard-rules.pro</code>文件添加到您的<code class="du lg lh li lj b">build.gradle</code>配置中:</p><figure class="lk ll lm ln fd hj"><div class="bz dy l di"><div class="lo lp l"/></div></figure><h1 id="bd77" class="jo jp hs bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">了解更多信息</h1><p id="cb53" class="pw-post-body-paragraph ip iq hs ir b is km iu iv iw kn iy iz ja ko jc jd je kp jg jh ji kq jk jl jm ha bi translated">有兴趣了解更多关于R8心理医生的工作原理吗？查看<a class="ae lf" href="https://developer.android.com/studio/build/shrink-code" rel="noopener ugc nofollow" target="_blank"> R8开发者文档</a>并观看2019年Android Dev Summit的演讲，了解R8的总体情况并深入了解R8更高级的优化之一——类内联:</p><figure class="lk ll lm ln fd hj"><div class="bz dy l di"><div class="lq lp l"/></div></figure><p id="9e9a" class="pw-post-body-paragraph ip iq hs ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">你可以点击<a class="ae lf" href="https://youtu.be/uQ_yK8kRCaA?t=565" rel="noopener ugc nofollow" target="_blank">这里</a>直接进入类内联部分。</p></div></div>    
</body>
</html>