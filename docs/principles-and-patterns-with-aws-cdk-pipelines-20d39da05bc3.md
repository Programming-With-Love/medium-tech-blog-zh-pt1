# AWS CDK 管道的原理和模式

> 原文：<https://medium.com/version-1/principles-and-patterns-with-aws-cdk-pipelines-20d39da05bc3?source=collection_archive---------2----------------------->

在论文*设计原则和设计模式*中，罗伯特·C·马丁讨论了“腐烂设计”的症状。他强调说，糟糕设计的一个主要症状是僵化；*‘软件趋向于***’*。*

*在这篇博客中，我们将探讨如何利用原则和编程模式来创建灵活且可维护的 AWS CDK 管道应用程序。*

# *紧密耦合的实现*

*让我们从下面的片段开始，它取自一个使用上下文参数 envType 的管道应用程序。*

*   *当使用值“dev”传递 envType 时，将创建一个管道模板，该模板将部署到单个 AWS 帐户和区域。*
*   *当 envType 的值为“release”时，将使用两个管道阶段来部署到多个 AWS 帐户和区域。*

*Dynamic pipelines for different environments*

*这可能看起来很简单，但是，请考虑进一步开发这些代码的含义。例如:*

*   *在开发和发布的同时增加更多的管道变化。*
*   *每个 CicdStage 发布不同版本的应用程序堆栈。*
*   *对每个管道使用不同的 synth 步骤*

*由于开发和发布阶段的实现与管道紧密耦合，应用程序已经是**刚性的；**进一步的开发变成了附加更多 if/else 逻辑的练习，以满足管道、阶段和应用程序堆栈的所有组合。*

*实现这些变化的结果是，代码逐渐变得混乱和脆弱，开发任务花费更长时间，变得不必要的复杂。*

> *“随着时间的推移，随着腐烂的继续，丑陋的溃烂疮和疖子积累起来，直到它们主宰了应用程序的设计。程序变成了一大堆代码，开发人员发现越来越难以维护*

# *依赖性倒置*

*依赖倒置原则( [SOLID](https://en.wikipedia.org/wiki/SOLID) )声明应用程序应该建立在抽象之上，这样实现就可以被交换，使得应用程序更加灵活**。***

***让我们重温一下示例管道应用程序代码，并从一个基类开始抽象我们的管道实现。***

***A base class to be extended by multiple pipeline types***

***接下来，为开发和发布管道类型创建基类的子类。例如:***

***Sample extension of MyPipelineBase***

***当我们扩展基类时，我们必须实现抽象方法`addStages()`***

# ***模板模式***

***当在 CDK 中创建代码管道时，基本上有两个关键步骤，synth 和添加阶段。***

***注意，在基类中，我们在`generatePipeline()`方法中声明了这些步骤，这被称为模板模式；指定子类要遵循的一组步骤，但允许通过重写方法来改变行为。***

***可以从基类的开发或测试实现中调用`generatePipeline()`，它们将共享相同的 synth 方法，但是执行它们各自被覆盖的`addStages`方法。***

# ***传递接口***

***接下来，我们来介绍一个界面。***

***并更改 PipelineDev 和 PipelineTest 以实现 PipelineInterface。***

***这种微妙的变化使我们能够引用接口而不是实现；因此，任何实现接口的东西都可以用在它的位置上。***

# ***工厂模式***

***工厂模式用于根据提供的值创建对象实例。我们可以通过引入工厂模式来获得管道类型，从而扩展上面的工作。***

# ***完成抽象***

***为了通过 PipelineFactory 创建 pipeline 实例，我们现在使用以下代码:***

*****任何对管道实现的引用都被抽象掉了**。我们可以使用**任何 PipelineInterface 实现**来换入和使用**，而无需更改任何底层管道代码**。***

# ***创建新的管道变化***

***既然我们所有的管道实现都是从管道本身抽象出来的，我们就能够交换管道实现了。让我们回顾一下这篇博客开始时要求的代码更改。***

*****我们如何在开发和发布的同时增加另一个管道变化？** 只需扩展 MyPipelineBase 类，根据需要实现 addStages()。根据需要修改 PipelineFactory 以创建实例。***

*****我们如何在每个 CicdStage 中实现不同版本的应用程序堆栈？将本博客中讨论的相同模式应用到您的管道阶段，使用工厂模式来确定使用哪个实现。*****

*****我们如何使用不同的 synth 实现？简单地用自己的方法覆盖 synth 的基类实现。*****

# ***结论***

***在这篇博客中，我们研究了如何应用原则和模式来使脆弱和僵化的 CDK 管道应用程序变得灵活和更易于维护。***

***无论项目有多简单，考虑应用程序架构和维护永远不会太早。腐烂的设计是一个渐进过程的结果，不处理的时间越长，就越难修复。***

***![](img/3201a2a89d9110e6df1f758293360182.png)***

*****关于作者:** Paul Harwood 是这里的高级 AWS DevOps 工程师。***