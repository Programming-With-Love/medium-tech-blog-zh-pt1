<html>
<head>
<title>Core principles behind CameraX Jetpack Library</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CameraX Jetpack库背后的核心原则</h1>
<blockquote>原文：<a href="https://medium.com/androiddevelopers/core-principles-behind-camerax-jetpack-library-8e8380f7604c?source=collection_archive---------0-----------------------#2019-08-29">https://medium.com/androiddevelopers/core-principles-behind-camerax-jetpack-library-8e8380f7604c?source=collection_archive---------0-----------------------#2019-08-29</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="7d30" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在这篇博文中，我们将介绍CameraX Jetpack库背后的基本原则，以及该库自<a class="ae jc" href="https://www.youtube.com/watch?v=kuv8uK-5CLY" rel="noopener ugc nofollow" target="_blank">在Google I/O 2019上发布</a>以来的一些变化。要获得最新资源，请查看<a class="ae jc" href="http://developer.android.com/camerax" rel="noopener ugc nofollow" target="_blank">文档</a>，查看<a class="ae jc" href="http://g.co/camerax/sample" rel="noopener ugc nofollow" target="_blank">官方样本</a>，并加入我们的<a class="ae jc" href="http://g.co/camerax/developers" rel="noopener ugc nofollow" target="_blank">在线开发者社区</a>。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/7fda3c3f31ea3ce165109c95f3cfa978.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/0*Fhl8EPXSbgA-vhIJ"/></div></figure><h1 id="3660" class="jl jm hh bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">生命周期意识</h1><p id="a922" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">与许多其他Jetpack库一样，CameraX的核心特性之一是生命周期感知。只要我们提供一个生命周期所有者，CameraX就可以代替我们管理相机设备和会话的打开和关闭。当生命周期开始时，相机也开始了；当生命周期因为我们的应用、活动或片段的消失而停止时，我们也不必担心关闭，因为CameraX为我们做了这些。不错！</p><h1 id="0ab5" class="jl jm hh bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">用例驱动的方法</h1><p id="ef90" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">CameraX Jetpack库的另一个核心原则是它的<strong class="ig hi">用例驱动方法</strong>。CameraX试图在非常低级的抽象(如Camera2的<a class="ae jc" href="https://developer.android.com/reference/android/hardware/camera2/CameraDevice#constants_2" rel="noopener ugc nofollow" target="_blank">捕获请求模板</a>)和过于简单的API(如已废弃的<a class="ae jc" href="https://developer.android.com/reference/android/hardware/Camera.html" rel="noopener ugc nofollow" target="_blank">相机API </a>)之间找到平衡点。</p><p id="c164" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">CameraX提供的主要用例有:</p><ul class=""><li id="8c2b" class="ko kp hh ig b ih ii il im ip kq it kr ix ks jb kt ku kv kw bi translated"><a class="ae jc" href="https://developer.android.com/training/camerax/preview" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi">预览</strong> </a>:用于显示相机正对的取景器。</li><li id="6442" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated"><a class="ae jc" href="https://developer.android.com/training/camerax/analyze" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi">图像分析</strong> </a>:用于解析来自摄像头的信息，例如检测画面中的人脸。</li><li id="0e65" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated"><a class="ae jc" href="https://developer.android.com/training/camerax/take-photo" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi"> ImageCapture </strong> </a>:用于拍摄高质量照片，可根据应用要求以高分辨率或低延迟完成。</li></ul><p id="c1f4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">用例是使用配置对象构建的。API在各种用例中都是一致的，开发人员可以通过一个简单的三步流程来实现这一点:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lc ld l"/></div></figure><p id="a144" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">注意，每个用例都是完全独立的。这意味着，理论上，如果我们愿意，可以为我们的每个活动案例设置不同的分辨率、纵横比，甚至生命周期所有者。在我们的<a class="ae jc" href="https://github.com/android/camera/tree/master/CameraXBasic" rel="noopener ugc nofollow" target="_blank">官方示例</a>中，我们保持简单，对所有用例使用相同的参数。</p><h1 id="d071" class="jl jm hh bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">优雅的退化</h1><p id="53b6" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">尽管从技术上来说，我们可以为不同的用例拥有不同的生命周期所有者，但是建议我们在一次调用中通过CameraX将我们的用例绑定到生命周期，并且使用相同的生命周期所有者:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lc ld l"/></div></figure><p id="86c9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">背后的原因是，如果我们要求的不可行，CameraX将尝试执行<strong class="ig hi">优雅降级</strong>并提供最接近的可能配置。通过一次提供所有的用例，我们给CameraX一个机会来找到一个折衷方案，这样所有的用例都可以运行。当摄像机会话已经处于活动状态时，提供用例会逐渐增加约束，可能需要重新启动会话，这可能会导致正在进行的摄像机流出现故障。</p><p id="27b6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">特定配置不可行的原因有很多，这取决于Camera2 API可以提供什么，而这在不同的设备之间是不同的。其中一个主要的制约因素与相机流的限制有关，我们<a class="ae jc" rel="noopener" href="/androiddevelopers/using-multiple-camera-streams-simultaneously-bf9488a29482">在之前的帖子</a>中解释过。不幸的是，在CameraX中，目前没有好的方法可以知道一个配置组合是否会成功，而不需要一定量的尝试和错误。</p><h1 id="bb29" class="jl jm hh bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">和睦相处</h1><p id="1987" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">谈论Android上的<strong class="ig hi">兼容性</strong>通常指的是API级别。幸运的是，CameraX所基于的Camera2 APIs自其在API级别21中引入以来一直相当稳定，CameraX支持21及以上版本的设备——这代表了大约90%的Android设备<a class="ae jc" href="https://developer.android.com/about/dashboards/index.html" rel="noopener ugc nofollow" target="_blank">(截至2019年8月)。</a></p><p id="15be" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，即使在同一个API级别中，不同设备之间也有很多不同之处；例如<a class="ae jc" href="https://source.android.com/devices/camera/camera3" rel="noopener ugc nofollow" target="_blank"> HAL级别</a>和对不同<a class="ae jc" href="https://developer.android.com/reference/android/graphics/ImageFormat" rel="noopener ugc nofollow" target="_blank">像素格式</a>的不同支持会对性能产生很大影响。</p><p id="69af" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了解决这个问题，CameraX团队在自动化测试方面投入了大量资金，包括建立一个拥有一系列设备的专用测试实验室。所有的目标是，当我们选择一个经过测试的用例配置组合时，它对我们所有的用户都有效。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es le"><img src="../Images/1b59cd409c9c95f00d834c1f27b3c2b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*AFJq-Hjj-qZknWvG"/></div><figcaption class="lf lg et er es lh li bd b be z dx">Automated CameraX test lab</figcaption></figure><h1 id="67ce" class="jl jm hh bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">扩展ˌ扩张</h1><p id="b978" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">让CameraX在许多不同的设备上工作不是一件容易的事情。为了帮助解决这个问题，Google与许多OEM合作伙伴合作开发上述核心用例的扩展。文档最好地描述了:</p><blockquote class="lj lk ll"><p id="875a" class="ie if lm ig b ih ii ij ik il im in io ln iq ir is lo iu iv iw lp iy iz ja jb ha bi translated">CameraX提供了一个API来访问特定于设备的供应商效果，如散景、HDR和附加功能。API使您能够查询特定的扩展在当前设备上是否可用，并优先启用该扩展。也就是说，如果扩展在该设备上可用，它将被启用，如果不可用，它将正常降级。</p></blockquote><p id="8803" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">启用一个用例的扩展，比如图像捕获，可能会修改所有其他活动的用例。换句话说，启用HDR扩展可能会修改预览和图像分析用例，而不仅仅是图像捕获用例。注意，目前(从扩展模块的alpha01版本开始)，这是通过确保所有活动用例都启用了扩展来实现的。我们可以使用一个<a class="ae jc" href="https://developer.android.com/reference/androidx/camera/extensions/ExtensionsErrorListener.html" rel="noopener ugc nofollow" target="_blank"> ExtensionsErrorListener </a>来设置一个错误监听器，尽管这个设计将来可能会改变。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es lq"><img src="../Images/e729c6c5bced11f04edc262f05cfa502.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RJnPE2Mx66wi-dDQ"/></div></div><figcaption class="lf lg et er es lh li bd b be z dx">Showcase of the different extensions currently available</figcaption></figure><h1 id="dea4" class="jl jm hh bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">最近的API变化</h1><p id="197b" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">自从Google I/O发布以来，已经发布了一些新的API，其他一些也有所改变:</p><ul class=""><li id="6193" class="ko kp hh ig b ih ii il im ip kq it kr ix ks jb kt ku kv kw bi translated"><a class="ae jc" href="https://developer.android.com/training/camerax/vendor-extensions" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi">厂商扩展</strong> </a>现已可用。为了在我们的应用程序中包含工件，我们将以下内容添加到我们的Gradle dependencies: <code class="du lv lw lx ly b">implementation "androidx.camera:camera-extensions:1.0.0-alpha01"</code>(或更高)</li><li id="c095" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated">用例现在接受<a class="ae jc" href="https://developer.android.com/reference/java/util/concurrent/Executor" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi">执行者</strong> </a>而不是处理者。简单地调用用例配置对象上的<code class="du lv lw lx ly b">setBackgroundExecutor</code>。</li><li id="8d1e" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated">图像分析现在允许<a class="ae jc" href="https://developer.android.com/reference/androidx/camera/core/ImageAnalysis.ImageReaderMode" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi">非阻塞</strong> </a>操作，无需在应用程序级别进行节流以避免资源匮乏。</li><li id="8d8c" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated"><strong class="ig hi">相机属性</strong>将通过一个新的CameraInfo对象可用。这特别有帮助，因为备选方案是退回到Camera2 APIs和<em class="lm">猜测</em>哪个相机设备对应于所选的镜头朝向属性。</li><li id="64f7" class="ko kp hh ig b ih kx il ky ip kz it la ix lb jb kt ku kv kw bi translated"><strong class="ig hi">相机控件</strong>，比如变焦和对焦，包括一些非常方便的点击对焦工具，都可以通过<a class="ae jc" href="https://developer.android.com/reference/androidx/camera/core/CameraControl.html" rel="noopener ugc nofollow" target="_blank"> <strong class="ig hi"> CameraControl </strong> </a>类获得。</li></ul><h1 id="c97f" class="jl jm hh bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">了解更多信息</h1><p id="a2d2" class="pw-post-body-paragraph ie if hh ig b ih kj ij ik il kk in io ip kl ir is it km iv iw ix kn iz ja jb ha bi translated">要了解更多关于CameraX的信息，请查看<a class="ae jc" href="http://developer.android.com/camerax" rel="noopener ugc nofollow" target="_blank">文档</a>和<a class="ae jc" href="http://g.co/camerax/sample" rel="noopener ugc nofollow" target="_blank">官方样本</a>，或者加入我们的<a class="ae jc" href="http://g.co/camerax/developers" rel="noopener ugc nofollow" target="_blank">在线开发者社区</a>。请继续关注未来的博客帖子和更新，因为CameraX正在从alpha走向生产就绪库。</p></div></div>    
</body>
</html>