<html>
<head>
<title>Soundwave: an open source configuration management database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">声波:一个开源的配置管理数据库</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/soundwave-an-open-source-configuration-management-database-df75b31b8f5a?source=collection_archive---------2-----------------------#2017-06-07">https://medium.com/pinterest-engineering/soundwave-an-open-source-configuration-management-database-df75b31b8f5a?source=collection_archive---------2-----------------------#2017-06-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="172f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Lida Li &amp; Saurabh Joshi | Pinterest工程师，云计算管理平台</p><p id="3ef6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest在AWS上运行其基础设施。每天，由于<a class="ae jc" rel="noopener" href="/@Pinterest_Engineering/auto-scaling-pinterest-df1d2beb4d64">自动伸缩</a>，以及新服务启动和集群轮换，数千个EC2实例被启动、停止和终止。为了作为主机级硬件和软件配置的单一事实来源，我们建立了声波，一个配置管理数据库(CMDB)。声波在支持资源管理、服务自动化、容量规划、安全、财务审计和即席查询方面发挥着关键作用。我们<a class="ae jc" href="https://github.com/pinterest/soundwave" rel="noopener ugc nofollow" target="_blank">开源了</a>名为声波的CMDB的核心组件，以帮助其他人自动跟踪当前和历史EC2实例及其元数据。在这里，我们将涵盖如何CMDB是有益的和声波的建筑。</p><p id="a9c0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">配置管理数据库</strong></p><p id="dfc9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">配置管理数据库通常被查询来回答诸如“在我们的基础设施中有多少特定类型的实例在运行？”，“给定实例的IAM角色是什么？”以及“给定实例上使用的OpenSSH版本是什么？”。</p><p id="8414" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们将声波构建为内部数据存储，与AWS控制台和EC2 API一起工作，并帮助:</p><p id="082a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">1.从自动化系统直接查询机器信息</p><p id="4ff6" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2.保存已终止实例的元数据和实例信息，以跟踪这些已终止实例的使用历史和诊断问题。</p><p id="6a1f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">3.将EC2模式和查询扩展到简单过滤之外。</p><p id="6e9d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">其他优势包括:</p><p id="1421" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">1.在我们的elasticsearch store中专门跟踪EC2实例有助于我们获得比EC2 API更好的查询性能。这意味着在声波获得所有正在运行的实例的信息大约需要5秒钟，但是在EC2 API中需要一分多钟。</p><p id="51b2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">2.它为配置管理创建了一个与云无关的抽象层，使得支持混合云场景变得更加容易。</p><p id="c14e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">声波:引擎盖下</p><p id="8e87" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">声波有三个主要组件，下图显示了其系统架构，包括:</p><ul class=""><li id="b7f2" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">一个基于Java的worker系统，它将实例数据与EC2同步，并将最新数据推送到Elasticsearch存储中。数据接收分两部分完成:</li></ul><ol class=""><li id="d227" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb jm jj jk jl bi translated">AWS lambda函数监听由实例状态变化触发的CloudWatch事件，并将通知推送到亚马逊SQS队列。订阅这个SQS队列的一队Java工作人员获取通知数据并写入Elasticsearch存储。</li><li id="54c4" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb jm jj jk jl bi translated">后台协调作业定期运行，以确保Elasticsearch存储中的数据与EC2数据同步。这有助于捕获不会触发云观察事件的实例更改。</li></ol><ul class=""><li id="87ef" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb ji jj jk jl bi translated">一个RESTful API层，通过搜索提供对实例数据的访问。</li><li id="6633" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb ji jj jk jl bi translated">最终用户使用Lucene语法执行特定搜索查询的UI仪表板。</li></ul><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/d1ec198ceb1af2cc19a5eac32a923666.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*flCL_1aFptAslujrbguaUQ.png"/></div></div></figure><p id="e72c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">EC2 API的最终一致性</strong></p><p id="a71d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">EC2 API有一个<a class="ae jc" href="http://docs.aws.amazon.com/AWSEC2/latest/APIReference/query-api-troubleshooting.html#eventual-consistency" rel="noopener ugc nofollow" target="_blank">最终一致性</a>模型。当一个新的实例启动时，JAVA工作者会收到一个关于这个实例的通知。该工作线程调用一个API——DescribeInstances——来获取关于新启动的实例的信息。很有可能许多实例属性目前还没有填充，但是几分钟后就可以使用了。如下所述，声波优雅地处理了这些问题:</p><ol class=""><li id="58cf" class="jd je hh ig b ih ii il im ip jf it jg ix jh jb jm jj jk jl bi translated">Java工作者检查期望从EC2返回的关键属性。如果此时属性不可用，它会将实例通知放回SQS队列，并使用由消息可见性控制的指数补偿时间。一旦从EC2 API获得了所需的属性，该消息将被完全处理。</li><li id="85b6" class="jd je hh ig b ih jn il jo ip jp it jq ix jr jb jm jj jk jl bi translated">对于其他非关键属性，工作线程会运行后台协调作业，以便在EC2中提供缺失的属性时填充这些属性。</li></ol><p id="3793" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">评价声波</strong></p><p id="6b0a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们开源了<a class="ae jc" href="https://github.com/pinterest/soundwave" rel="noopener ugc nofollow" target="_blank">声波</a>，因为我们相信它会对其他在AWS EC2中运行服务的人有用。我们提供了Terraform文件来配置AWS和Docker-Compose，以便在容器中快速运行整个声波堆栈。要开始使用，请查看<a class="ae jc" href="https://github.com/pinterest/soundwave" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>，了解设置和使用它的详细步骤。</p><p id="47c0" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果这些是让你兴奋的项目，<a class="ae jc" href="https://careers.pinterest.com/" rel="noopener ugc nofollow" target="_blank">加入我们</a>。</p><p id="e107" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="ke">鸣谢:浩铭、苏曼·卡鲁莫里和杰姆·考克斯，感谢他们的原创设计讨论和基础设施支持CMP和SRE团队，感谢他们的使用反馈和错误报告。</em></p></div></div>    
</body>
</html>