<html>
<head>
<title>How to a pull Docker Image from GCR in any non-GCP Kubernetes cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在任何非GCP Kubernetes集群中从GCR拉码头形象</h1>
<blockquote>原文：<a href="https://medium.easyread.co/today-i-learned-pull-docker-image-from-gcr-google-container-registry-in-any-non-gcp-kubernetes-5f8298f28969?source=collection_archive---------0-----------------------#2019-07-07">https://medium.easyread.co/today-i-learned-pull-docker-image-from-gcr-google-container-registry-in-any-non-gcp-kubernetes-5f8298f28969?source=collection_archive---------0-----------------------#2019-07-07</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="0f63" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">帮助您在任何非GCP Kubernetes集群中使用GCR作为您的容器注册中心的简单指南</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/93ff3d6a008a53c2ef358d4d4d981e9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7lfGxZFcTntykAf0"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@victoire_jonch?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Victoire Joncheray</a> on <a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="306c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我有许多副业项目，但我把它部署在我在GCP的Kubernetes集群(谷歌云平台)。但在DigitalOcean(DO)发布了他们的Kubernetes功能后，我想把我在GCP的所有辅助项目都转移到DO。进行这种迁移的原因是因为GCP太贵了，而且对于那些没有真正生产用户的简单副业项目来说是多余的。</p><p id="ce05" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">但是，我只是迁移了Kubernetes集群和数据库。我仍然使用GCP的一些服务，例如，像GCR(谷歌容器注册)这样的谷歌服务作为我的容器注册，因为GCR相对于DockerHub的私有注册要便宜一些。</p><p id="e852" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在迁移Kubernetes集群时，我发现了一个问题。该问题是关于在提取私人图像时对GCR的身份验证。这是我拿到豆荚时豆荚的状态。</p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="38e9" class="lu lv in lq b gy lw lx l ly lz">$ kubectl get pods<br/>NAME                    READY   STATUS         RESTARTS   AGE<br/>august-f7fc98c5-x4chl   0/1     ErrImagePull   0          88s</span></pre><p id="c3c4" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在查找日志之后，问题出现了，因为我需要在提取私有映像时定义一个访问令牌。所以在这里，我将解释我解决这个问题的所有步骤。</p><h2 id="518b" class="lu lv in bd ma mb mc dn md me mf dp mg lc mh mi mj lg mk ml mm lk mn mo mp mq bi translated">步骤1:为GCR创建凭据</h2><ul class=""><li id="4402" class="mr ms in kv b kw mt kz mu lc mv lg mw lk mx lo my mz na nb bi translated">转到GCP控制台。选择<strong class="kv io">“API&amp;服务”&gt;“凭证”</strong></li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/644a736b2656757e7bf4a5672e1c3903.png" data-original-src="https://miro.medium.com/v2/resize:fit:952/format:webp/1*_YTjL9QX4gj3mnk4gqu-Lw.png"/></div></figure><ul class=""><li id="de47" class="mr ms in kv b kw kx kz la lc nd lg ne lk nf lo my mz na nb bi translated">选择<strong class="kv io">“创建凭证”&gt;“服务帐户密钥”&gt;“创建新服务帐户”。</strong></li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/a7a4996a1b0111dadc0336f926739ceb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/1*6PXCV-ky-dYli-kqrgwp7A.png"/></div></figure><ul class=""><li id="f1ae" class="mr ms in kv b kw kx kz la lc nd lg ne lk nf lo my mz na nb bi translated">然后，填写服务帐户名称，对于角色，选择<strong class="kv io">查看器</strong></li></ul><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nh"><img src="../Images/f850528811178b6f298965d8d507d893.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q-i3p8o5KAoOcdbnwn6ftQ.png"/></div></div></figure><ul class=""><li id="bf3d" class="mr ms in kv b kw kx kz la lc nd lg ne lk nf lo my mz na nb bi translated">并点击<strong class="kv io">创建</strong>。创建后，凭证将自动下载到一个JSON文件中。它将会是这个样子。</li></ul><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="682f" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">所以现在，我们已经有资格从GCR获取私人图像。</p><h2 id="8faf" class="lu lv in bd ma mb mc dn md me mf dp mg lc mh mi mj lg mk ml mm lk mn mo mp mq bi translated">步骤2:在Kubernetes集群中添加一个Kubernetes秘密</h2><ul class=""><li id="0796" class="mr ms in kv b kw mt kz mu lc mv lg mw lk mx lo my mz na nb bi translated">下一步是，我们将在我们的Kubernetes群集中创建一个Kubernetes秘密。</li></ul><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="3fdd" class="lu lv in lq b gy lw lx l ly lz">$ kubectl create secret docker-registry gcr-json-key \<br/>  --docker-server=asia.gcr.io \<br/>  --docker-username=_json_key \<br/>  --docker-password="$(cat ~/json-key-file-from-gcp.json)" \<br/>  --docker-email=any@valid.email</span></pre><ul class=""><li id="4b09" class="mr ms in kv b kw kx kz la lc nd lg ne lk nf lo my mz na nb bi translated">运行上面的命令，并根据您的需要进行输入。比如:<code class="fe nk nl nm lq b">docker-server</code> : <code class="fe nk nl nm lq b">asia.gcr.io</code>(我用的是亚洲服务器)。并且用你在GCP注册的邮箱填邮箱等等。</li><li id="92d0" class="mr ms in kv b kw nn kz no lc np lg nq lk nr lo my mz na nb bi translated">如果你在下面看到这个错误，那是因为你已经有了一个名为<code class="fe nk nl nm lq b">gcr-json-key</code>的秘密。您可以删除密码并重新创建，或者在创建密码时输入另一个名称。</li></ul><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="0ee8" class="lu lv in lq b gy lw lx l ly lz">$ Error from server (AlreadyExists): secrets "gcr-json-key" already exists</span></pre><ul class=""><li id="ce6f" class="mr ms in kv b kw kx kz la lc nd lg ne lk nf lo my mz na nb bi translated">要确保秘密已经被创建，只需获取秘密；应该以<code class="fe nk nl nm lq b">gcr-json-key</code>这个名字存在。</li></ul><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="21d6" class="lu lv in lq b gy lw lx l ly lz">$ kubectl get secret<br/>NAME         TYPE                                  DATA   AGE<br/>gcr-json-key kubernetes.io/dockerconfigjson        1      6s</span></pre><h2 id="1dea" class="lu lv in bd ma mb mc dn md me mf dp mg lc mh mi mj lg mk ml mm lk mn mo mp mq bi translated">步骤3:使用秘密进行部署</h2><p id="4f42" class="pw-post-body-paragraph kt ku in kv b kw mt jo ky kz mu jr lb lc ns le lf lg nt li lj lk nu lm ln lo ig bi translated">我们有两种方法可以使用前面步骤中创建的秘密。他们是</p><ul class=""><li id="ffc7" class="mr ms in kv b kw kx kz la lc nd lg ne lk nf lo my mz na nb bi translated">将秘密添加到Kubernetes的名称空间中默认服务帐户的<strong class="kv io"> ImagePullSecrets </strong>中。通过这种方法，将被部署的每个pod将在提取图像时使用该秘密。</li><li id="c97d" class="mr ms in kv b kw nn kz no lc np lg nq lk nr lo my mz na nb bi translated">另一种方法是，将秘密直接添加到每个需要它的pod的部署配置中。</li></ul><p id="27af" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">步骤3.a:将秘密添加到默认服务帐户中的“ImagePullSecrets”中。</strong></p><p id="4334" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">第一种方法是在默认服务帐户中添加密码。为此，我们可以直接复制下面的这个命令。</p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="65df" class="lu lv in lq b gy lw lx l ly lz">$ kubectl patch serviceaccount default \<br/>-p '{"imagePullSecrets": [{"name": "gcr-json-key"}]}'</span></pre><p id="be41" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">使用该命令，我们的Kubernetes集群应该已经能够从GCR获取图像。</p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="55bd" class="lu lv in lq b gy lw lx l ly lz">$ kubectl describe pod pod_name<br/>....<br/>Normal  Pulling    16s   kubelet, default-staging-oro2  Pulling image "asia.gcr.io/personal-project/august:latest"</span><span id="d403" class="lu lv in lq b gy nv lx l ly lz">Normal  Pulled     12s   kubelet, default-staging-oro2  Successfully pulled image "asia.gcr.io/personal-project/august:latest"</span></pre><p id="104c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果仍然出现错误，请尝试删除该单元，并等待该单元再次重新部署。</p><p id="9eee" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">步骤3.b:将秘密添加到每个吊舱部署配置中</strong></p><p id="6755" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">对于这一步，我们需要更新我们的部署文件。我们需要将秘密直接添加到部署文件中。这种方法只对每个包含秘密的pod有效。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="b3f5" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">寻找属性:<code class="fe nk nl nm lq b">imagePullSecrets</code>。我们必须将秘密直接添加到部署文件中。</p><p id="f947" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">对于我的情况，我选择第一种方法，原因是因为我的默认容器注册中心是GCR。因此，如果将来我有一个不同的注册表，我只需将部署文件直接添加到每个需要它的pod中。</p></div><div class="ab cl nw nx hr ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="ig ih ii ij ik"><p id="f4b4" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这就是我今天学到的东西。也许这只适用于GCR，但我认为这一概念对其他集装箱注册也是一样的。</p><h2 id="f651" class="lu lv in bd ma mb mc dn md me mf dp mg lc mh mi mj lg mk ml mm lk mn mo mp mq bi translated">参考</h2><ul class=""><li id="a9c3" class="mr ms in kv b kw mt kz mu lc mv lg mw lk mx lo my mz na nb bi translated"><a class="ae ks" href="https://container-solutions.com/using-google-container-registry-with-kubernetes/" rel="noopener ugc nofollow" target="_blank">https://container-solutions . com/using-Google-container-registry-with-kubernetes/</a></li></ul></div></div>    
</body>
</html>