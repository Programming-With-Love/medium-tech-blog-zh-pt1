<html>
<head>
<title>Hvorfor og hvordan lage din egen terraform provider</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Hvorfor og hvordan lage din egen terraform provider</h1>
<blockquote>原文：<a href="https://medium.com/compendium/hvorfor-og-hvordan-lage-din-egen-terraform-provider-db54f88c7d68?source=collection_archive---------0-----------------------#2021-10-04">https://medium.com/compendium/hvorfor-og-hvordan-lage-din-egen-terraform-provider-db54f88c7d68?source=collection_archive---------0-----------------------#2021-10-04</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/></div><div class="ab cl ie if go ig" role="separator"><span class="ih bw bk ii ij ik"/><span class="ih bw bk ii ij ik"/><span class="ih bw bk ii ij"/></div><div class="ha hb hc hd he"><p id="b775" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Sammen med flere gode kollegaer hos Computas har jeg jobbet for Elvia de siste årene. Her har vi hatt stor suksess ved bruk av Terraform fra Hashicorp, og har også utviklet en egen Terraform provider for å styre våre tjenester.</p><p id="5628" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Terraform er et verktøy for å skrive Infrastructure as Code. Det skrives i HashiCorp configuration language (HCL). Vi styrer alt mulig fra Terraform, som opprettelse av databaser, ad-grupper, devops-prosjekter, kjøretidsmiljøet i kubernetes og alt annet av sky-tjenester. Vi klikker altså aldri i Azure-portalen for å opprette en ressurs, men skriver heller hvilken ressurs vi vil ha i Terraform kode, og ruller det så ut i våre dev, test og prod-miljøer med terraform apply.</p><p id="1b4e" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Ressurser som kan opprettes i Terraform er tilknyttet en provider. Feks benytter du Azure-provideren for å kunne opprette ressurser i Azure. Store skyleverandører og andre har laget providere slik at du allerede enkelt kan opprette ressurser for de store skyplattformene.</p><p id="eba2" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Men hva med de systemene du har laget selv? Hvis konfigurasjon av dem blir såpass omfattende at du gjerne skulle hatt “Infrastructure as Code” for dette kan det være en mulighet å lage din egen terraform provider. Sånn var det for oss med Elvias innloggingstjeneste som heter ElvID (Elvia ID).</p><h1 id="5288" class="jj jk hh bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">Vårt case</h1><p id="f939" class="pw-post-body-paragraph il im hh in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">ElvID er en tokenbasert tjeneste som bygger på rammeverket IdentityServer. Tjenesten brukes av interne og eksterne Elvia-brukere, samt til å sikre maskin-til-maskin kommunikasjon mellom våre tjenester.</p><p id="f24a" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Konfigurasjon for klientene må registreres i ElvID. For UserClients (Authorization code) må man registrere scopes, gyldige urler for redirects, CORS, innloggingsmetoder for sluttbrukere osv. For maskinclienter (client credentials) må det registres en client_id og client_secret, samt scopes.</p><p id="754a" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Vi benyttet først et simpelt GUI for å registrere klientene, men det viste seg at det ikke var en tilstrekkelig. Over tid ble det stadig behov for nye klienter. Samtidig var det få personer som hadde tilgang og kompetanse til å registrere disse. Utviklerne flest måtte da vente på at denne jobben ble gjort av andre. Sikkerhetsmessig var det ikke heldig at secrets måtte manuelt genereres og kopieres over til vår secret-manager (via terraform). Dette manuelle arbeidet tok jo også endel tid og måtte også gjøres for hvert av våre miljøer.</p><p id="b6ca" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Med nå rundt 100 slike klienter, som måtte registreres i 3 miljøer hadde det blitt veldig mye manuelt arbeid å gjøre det måten vi gjorde før. Løsningen for oss var å lage vår egen terraform provider.</p><h1 id="0460" class="jj jk hh bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">Hvordan lage en terraform provider</h1><p id="629a" class="pw-post-body-paragraph il im hh in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">Terraform kom etter hvert med muligheten for å lage egen provider. Providere skrives typisk i Go, og det finnes libraries og eksempler som støtter i utviklingen. Se installasjonsguider for <a class="ae km" href="https://golang.org/doc/install" rel="noopener ugc nofollow" target="_blank"> Golang </a> og <a class="ae km" href="https://learn.hashicorp.com/terraform/getting-started/install.html" rel="noopener ugc nofollow" target="_blank"> Terraform </a> .</p><p id="bf64" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Provideren vi har laget er opensourcet ( <a class="ae km" href="https://github.com/3lvia/terraform-provider-elvid" rel="noopener ugc nofollow" target="_blank"> her er github-repo </a> ). Både fordi vi synes det er fint å dele kode og at det gjør det lettere ved publisering i Terreaform Registry.</p><h2 id="07c2" class="kn jk hh bd jl ko kp kq jp kr ks kt jt iw ku kv jx ja kw kx kb je ky kz kf la bi translated">Schema for provideren</h2><p id="5041" class="pw-post-body-paragraph il im hh in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">Først må du beskrive schema for provider-en. Her bestemmer du hvilke variable som kan eller må settes ved oppsett av provideren i terraform-koden. Her kan du også sette opp validering og description. Du lager også en ResourcesMap hvor du definerer hvilke resources som skal kunne settes opp med provideren.</p><p id="3864" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Under ser du utdrag fra kildekoden for vår provider. Her defineres blant annet en tenant_id som required input. Fullstendig kode finner du <a class="ae km" href="https://github.com/3lvia/terraform-provider-elvid/blob/trunk/provider.go#L9" rel="noopener ugc nofollow" target="_blank"> her </a> .</p><figure class="lb lc ld le fd lf"><div class="bz dy l di"><div class="lg lh l"/></div><figcaption class="li lj et er es lk ll bd b be z dx">Go kode i terraform provider</figcaption></figure><p id="3a25" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><a class="ae km" href="https://learn.hashicorp.com/tutorials/terraform/provider-setup?in=terraform/providers#explore-provider-schema" rel="noopener ugc nofollow" target="_blank"> Les mer dokumentasjon om provider schema </a> .</p><h2 id="7c1c" class="kn jk hh bd jl ko kp kq jp kr ks kt jt iw ku kv jx ja kw kx kb je ky kz kf la bi translated">Resources</h2><p id="9771" class="pw-post-body-paragraph il im hh in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">Hver ressurs du skal lage trenger et resource-schema. Her defineres variable for ressursen, samt deres egenskaper. Her setter du opp CRUD-operasjoner for ressursen. CRUD-operasjonene kaller typisk et API du setter opp for å gjennomføre create, read, update, delete av ressursen i ditt system.</p><p id="7415" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Terraform holder selv styr på status på hver resource du har rullet ut, og kaller selv riktig CRUD-operasjon ved terraform apply.</p><p id="17ea" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Se feks vår resource for machineclient. Fullstendig kode for resourceMachineClient finner du <a class="ae km" href="https://github.com/3lvia/terraform-provider-elvid/blob/trunk/resource_machineclient.go#L11" rel="noopener ugc nofollow" target="_blank"> her </a> .</p><figure class="lb lc ld le fd lf"><div class="bz dy l di"><div class="lg lh l"/></div><figcaption class="li lj et er es lk ll bd b be z dx">Go kode i terraform provider</figcaption></figure><figure class="lb lc ld le fd lf"><div class="bz dy l di"><div class="lg lh l"/></div><figcaption class="li lj et er es lk ll bd b be z dx">HCL kode for bruk i terraform</figcaption></figure><p id="0aff" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Merk at denne machineclient-en er ubrukelig uten en client_secret. Client_secret er en annen resource i vår provider. Mer om dette i avsnittet om moduler.</p><p id="e16c" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated"><a class="ae km" href="https://learn.hashicorp.com/tutorials/terraform/provider-create?in=terraform/providers" rel="noopener ugc nofollow" target="_blank"> Se mer info om å lage resources på denne og påfølgende sider i terraforms guide </a> .</p><h2 id="6272" class="kn jk hh bd jl ko kp kq jp kr ks kt jt iw ku kv jx ja kw kx kb je ky kz kf la bi translated">Sikring av API</h2><p id="f78c" class="pw-post-body-paragraph il im hh in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">Sørg også for at du sikrer disse api-endepunktene så ikke uvedkommende kan gjøre disse api-kallene.</p><p id="87c0" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Vi brukte her tokens fra AzureAD, da vi allerede hadde det tilgjengelig i våre terraform workspaces.</p><h2 id="dc16" class="kn jk hh bd jl ko kp kq jp kr ks kt jt iw ku kv jx ja kw kx kb je ky kz kf la bi translated">Lokal bygging og debugging</h2><p id="39a0" class="pw-post-body-paragraph il im hh in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">Se informasjon om dette i <a class="ae km" href="https://learn.hashicorp.com/tutorials/terraform/provider-debug?in=terraform/providers" rel="noopener ugc nofollow" target="_blank"> terraforms guide </a> , vi har også skrevet litt i <a class="ae km" href="https://github.com/3lvia/terraform-provider-elvid#readme" rel="noopener ugc nofollow" target="_blank"> readme for terraform-provider-elvid </a> .</p><h1 id="832e" class="jj jk hh bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">Publisering av provideren til Terraform registry</h1><p id="84f4" class="pw-post-body-paragraph il im hh in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">Når du er klar for at provideren skal brukes så kan du feks publisere den i Terraform Registry. Da kan den brukes på samme måte som andre providere.</p><p id="a4d6" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Følg <a class="ae km" href="https://learn.hashicorp.com/tutorials/terraform/provider-release-publish?in=terraform/providers" rel="noopener ugc nofollow" target="_blank"> denne guiden </a> for publisering av provideren. Vi benytter github-actions for automatisk publisering av nye releases. Dette er også beskrevet i den nevnte guiden.</p><figure class="lb lc ld le fd lf er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lm"><img src="../Images/b1522e49dec3c70a0ddcc96ab96d226e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8deVzz0AvV2kcBkZ8cRb2g.png"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Skjermbilde fra Terraform Registry</figcaption></figure><p id="3514" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Denne provideren finner du <a class="ae km" href="https://registry.terraform.io/providers/3lvia/elvid/latest" rel="noopener ugc nofollow" target="_blank"> her i Terraform Registry </a></p><h1 id="5cf4" class="jj jk hh bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">Lag moduler for å forenkle bruk og innføre standarder</h1><p id="8f4a" class="pw-post-body-paragraph il im hh in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">I stedet for å bruke resources direkte i terraform så bruker vi som oftest terraform-moduler.</p><p id="6985" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Fordelen er at du kan innføre standarder på feks navn og alt mulig annet, og koble sammen flere resources for enkelt bruk, også på tvers av providere.</p><p id="bddd" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Feks har vi en modul for elvid-machineclients. Den benytter elvid-provideren til å lage en machineclient-resource og en client_secret-resource. Så benytter den Hashicorp Vault provider for å legge client_id og client_secret i vår secret-manager.</p><figure class="lb lc ld le fd lf"><div class="bz dy l di"><div class="lg lh l"/></div><figcaption class="li lj et er es lk ll bd b be z dx">HCL kode i modul</figcaption></figure><h1 id="dfa1" class="jj jk hh bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">Bruk av provider og modul</h1><p id="d30f" class="pw-post-body-paragraph il im hh in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">Med provideren registrert i Terraform Registry og modulen ovenfor registrert i vår Terraform Enterprise kan dette nå enkelt brukes.</p><figure class="lb lc ld le fd lf"><div class="bz dy l di"><div class="lg lh l"/></div><figcaption class="li lj et er es lk ll bd b be z dx">HCL kode for bruk i terraform</figcaption></figure><p id="a1d9" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Resultatet etter å kjøre terraform apply er at dette er klart til bruk med hemmeligheter lagt inn i Vault. Fra Vault kan vi programmatisk hente ut disse hemmelighetene under kjøring.</p><figure class="lb lc ld le fd lf er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lt"><img src="../Images/bf50db8a1dc771e60d626c10b54fed38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vaa0k7Fyi2dqa90L6HL_wA.png"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Skjermbilde fra Vault</figcaption></figure><p id="1acb" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Klienten kan også benyttes i Postman, her ved å få laget et access_token for denne machineclient-en basert på client_id og client_secret</p><figure class="lb lc ld le fd lf er es paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="er es lu"><img src="../Images/44bf1abf4b6be2200c4277bdcf7a9146.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WUeRjuB4wWiXw9cDQYo80A.png"/></div></div><figcaption class="li lj et er es lk ll bd b be z dx">Skjermbilde fra Postman</figcaption></figure><h1 id="0962" class="jj jk hh bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">Resultat</h1><p id="7995" class="pw-post-body-paragraph il im hh in b io kh iq ir is ki iu iv iw kj iy iz ja kk jc jd je kl jg jh ji ha bi translated">Med denne terraform provideren på plass har vedlikehold av elvid klienter blitt mye lettere for oss.</p><p id="0d7b" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Nå kan alle teamene vi har her sette opp det de trenger i terraform selv, med en gang de trenger det og uten å involvere admins. Også helt uten manuelt toil-arbeid, og ingen copy-paste av hemmeligheter. Dette kan så enkelt rulles ut til alle miljøer, og navnestandarder blir håndhevet av seg selv.</p><p id="ade2" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">Takk til Elvia for et godt samarbeid og at vi kunne dele koden og det vi har gjort rundt dette.</p></div></div>    
</body>
</html>