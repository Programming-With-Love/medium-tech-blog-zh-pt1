<html>
<head>
<title>Getting started with GKE Gateway controller</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GKE网关控制器入门</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/getting-started-with-gke-gateway-controller-ee45c3bc8996?source=collection_archive---------0-----------------------#2022-06-05">https://medium.com/google-developer-experts/getting-started-with-gke-gateway-controller-ee45c3bc8996?source=collection_archive---------0-----------------------#2022-06-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="117e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一年前，谷歌<a class="ae jc" href="https://cloud.google.com/blog/products/containers-kubernetes/new-gke-gateway-controller-implements-kubernetes-gateway-api" rel="noopener ugc nofollow" target="_blank">宣布</a>GKE<a class="ae jc" href="https://cloud.google.com/kubernetes-engine/docs/concepts/gateway-api" rel="noopener ugc nofollow" target="_blank">网关控制器</a>的预览版，虽然最初玩起来有点酷，但它并没有提供<a class="ae jc" href="https://gateway-api.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes网关API </a>当时应该带来的任何令人敬畏的、改变游戏规则的功能。然而，随着最近发布的网关API <em class="jd"> v0.4.3 </em>，GKE网关控制器也进入了<em class="jd"> v1alpha2 </em>阶段，并带来了它必须提供的一些令人兴奋的功能，所以我在这里解释一些使用案例以及如何开始使用GKE网关控制器。</p><h1 id="2b24" class="je jf hh bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">介绍</h1><p id="d9c5" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">Ingress是一个强大而有用的功能，通常用于许多Kubernetes部署和许多不同的实现，通过<a class="ae jc" href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" rel="noopener ugc nofollow" target="_blank">各种ingress控制器</a>实现不同的功能集。其实我之前也对比过<a class="ae jc" rel="noopener" href="/@glen.yu/nginx-ingress-or-gke-ingress-d87dd9db504c"> NGINX Ingress和GKE Ingress </a>！</p><p id="8482" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">传统入口的缺点在于入口资源和服务资源需要在同一个名称空间中。入口资源和它的控制器之间也有一对一的关系，这意味着所有的路由和规则都在一个大的YAML文件中定义。如果您是在您的集群上运行的应用程序的唯一所有者，并且您管理它的所有端点，这可能看起来没什么大不了的，但是如果您是共享租户或者不同的端点由不同的团队管理，那该怎么办呢？这里的一对一关系可能会带来一些管理上的挑战；一个团队可能会意外破坏另一个团队的路线。</p><p id="bd77" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Kubernetes网关API引入了一些特性，这些特性允许网关(实际上是您的负载平衡器或入口控制器)和路由之间的一对多关系。这允许不同的团队各自管理自己的端点和路由。通过<a class="ae jc" href="https://gateway-api.sigs.k8s.io/v1alpha2/guides/multiple-ns/" rel="noopener ugc nofollow" target="_blank">跨名称空间路由</a>，入口和服务资源不再需要在同一个名称空间中，这意味着网关本身可以是由平台团队管理的独立名称空间，而共享网关的应用团队也将拥有自己的名称空间。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/94290a187ec45ceb3a29da3436ab71e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*six7-WfY_SovdiSdy6h8Wg.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx">The possibilities the GKE Gateway controller can bring!</figcaption></figure><h2 id="6261" class="kx jf hh bd jg ky kz la jk lb lc ld jo ip le lf js it lg lh jw ix li lj ka lk bi translated">什么是GKE网关控制器？</h2><p id="5925" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">Kubernetes Gateway API已经被宣布为Kubernetes的下一代入口，并且已经有许多下游实现。GKE网关控制器是谷歌对Kubernetes网关API的实现——毕竟，它必须集成GCP的功能，如云负载平衡、<a class="ae jc" href="https://cloud.google.com/load-balancing/docs/negs" rel="noopener ugc nofollow" target="_blank">网络端点组(NEGs) </a>等。</p></div><div class="ab cl ll lm go ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ha hb hc hd he"><h1 id="b0db" class="je jf hh bd jg jh ls jj jk jl lt jn jo jp lu jr js jt lv jv jw jx lw jz ka kb bi translated">部署演示</h1><p id="5998" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">我们将部署一个非常简单的涉及跨名称空间路由的演示。</p><ul class=""><li id="2915" class="lx ly hh ig b ih ii il im ip lz it ma ix mb jb mc md me mf bi translated">安装Kubernetes网关API自定义资源定义(CRD): <code class="du mg mh mi mj b">kubectl kustomize "github.com/kubernetes-sigs/gateway-api/config/crd?ref=v0.4.3" | kubectl apply -f -</code> <br/> <strong class="ig hi"> <em class="jd">更新</em></strong><em class="jd">2022–12–26:</em>GKE网关控制器通过<br/> <code class="du mg mh mi mj b">gcloud container clusters update CLUSTER_NAME --gateway-api=standard --region=REGION</code>启用</li><li id="e3eb" class="lx ly hh ig b ih mk il ml ip mm it mn ix mo jb mc md me mf bi translated">创建名称空间，并且必须将<code class="du mg mh mi mj b">shared-gateway-access</code>标签设置为<code class="du mg mh mi mj b">true</code>。您可以申请以下清单:<code class="du mg mh mi mj b">kubectl apply -f namespaces.yaml</code></li></ul><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="mp mq l"/></div></figure><ul class=""><li id="5bc2" class="lx ly hh ig b ih ii il im ip lz it ma ix mb jb mc md me mf bi translated">在<code class="du mg mh mi mj b">infra-ns</code>名称空间:<code class="du mg mh mi mj b">kubectl apply -f gateway.yaml</code>中部署GKE第7层全局外部负载平衡器(<code class="du mg mh mi mj b">gke-l7-gxlb</code>)网关</li></ul><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="mp mq l"/></div></figure><ul class=""><li id="86bd" class="lx ly hh ig b ih ii il im ip lz it ma ix mb jb mc md me mf bi translated">在<code class="du mg mh mi mj b">store-ns</code>名称空间中部署<em class="jd"> store </em> pods和服务:<code class="du mg mh mi mj b">kubectl apply -f store.yaml</code> <br/> <strong class="ig hi">注意:</strong>我发现有必要在服务定义中显式指定使用NEGs的注释，尽管这应该是默认行为。</li></ul><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="mp mq l"/></div></figure><ul class=""><li id="802d" class="lx ly hh ig b ih ii il im ip lz it ma ix mb jb mc md me mf bi translated">展开<a class="ae jc" href="https://gateway-api.sigs.k8s.io/v1alpha2/api-types/httproute/" rel="noopener ugc nofollow" target="_blank"> HTTPRoute </a> : <code class="du mg mh mi mj b">kubectl apply -f store-route.yaml</code></li></ul><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="mp mq l"/></div></figure><p id="6ea4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注意:</strong>neg的创建和路线的同步可能需要几分钟的时间，所以请耐心等待。</p><h2 id="812a" class="kx jf hh bd jg ky kz la jk lb lc ld jo ip le lf js it lg lh jw ix li lj ka lk bi translated">测试</h2><p id="094c" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">您可以通过查看<code class="du mg mh mi mj b">kubectl describe gateway external-http -n infra-ns</code>的输出来获取网关的IP地址，也可以使用<code class="du mg mh mi mj b">kubectl get gateway external-http -n infra-ns -o=jsonpath="{.status.addresses[0].value}"</code>直接查询</p><p id="f5b3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">之后您可以<code class="du mg mh mi mj b">curl</code>端点，但是您必须提供正确的主机头(例如<code class="du mg mh mi mj b">curl -H "host: store.example.com" 123.45.67.89/de</code>来匹配到达<code class="du mg mh mi mj b">store-german</code>后端的路由)。</p><h2 id="3227" class="kx jf hh bd jg ky kz la jk lb lc ld jo ip le lf js it lg lh jw ix li lj ka lk bi translated">清理</h2><p id="e868" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">以相反的顺序在部署清单上运行<code class="du mg mh mi mj b">kubectl delete</code>。</p></div><div class="ab cl ll lm go ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ha hb hc hd he"><h1 id="5d89" class="je jf hh bd jg jh ls jj jk jl lt jn jo jp lu jr js jt lv jv jw jx lw jz ka kb bi translated">下一步是什么？</h1><p id="5a85" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">上面的演示对于这篇中型文章来说是简短的，但是如果你想看完整的演示(使用内部负载平衡器)，你可以在我的<a class="ae jc" href="https://devlibrary.withgoogle.com/products/cloud/repos/Neutrollized-free-tier-gke" rel="noopener ugc nofollow" target="_blank">自由层GKE回购</a>中找到它(以及其他示例)。</p><p id="54ea" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">阅读<a class="ae jc" href="https://gateway-api.sigs.k8s.io/v1alpha2/guides/getting-started/" rel="noopener ugc nofollow" target="_blank">Kubernetes API</a>入门指南，熟悉它的特性(例如<a class="ae jc" href="https://gateway-api.sigs.k8s.io/v1alpha2/guides/traffic-splitting/" rel="noopener ugc nofollow" target="_blank">流量分流</a>)，这样你就可以开始思考如何使用它来提高安全性、工作流、测试等。</p><p id="d71b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">请记住，GKE网关控制器仍处于预览模式，随着它向最终的<em class="jd"> v1beta1 </em>和更高版本发展，您可以期待更多的变化(可能是突破性的变化——甚至从<em class="jd"> v1alpha1 </em>到<em class="jd"> v1alpha2 </em>经历了相当多的突破性变化)。</p><h2 id="b657" class="kx jf hh bd jg ky kz la jk lb lc ld jo ip le lf js it lg lh jw ix li lj ka lk bi translated">PSA</h2><p id="3953" class="pw-post-body-paragraph ie if hh ig b ih kc ij ik il kd in io ip ke ir is it kf iv iw ix kg iz ja jb ha bi translated">如果你想了解更多关于Kubernetes、GKE或者只是谷歌云的知识，请查看<a class="ae jc" href="https://devlibrary.withgoogle.com/" rel="noopener ugc nofollow" target="_blank">谷歌开发库</a>，这是一个与GCP相关的博客文章、操作方法和代码示例的宝库。</p><p id="9e00" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jd">编辑2022–07–22:</em>网关API在<em class="jd"> v1beta1 </em>(从CRD v0.5.0开始)</p></div></div>    
</body>
</html>