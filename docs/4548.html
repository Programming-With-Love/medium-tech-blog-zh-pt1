<html>
<head>
<title>Automatic Validation of Kubernetes Config in Azure DevOps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure DevOps中Kubernetes配置的自动验证</h1>
<blockquote>原文：<a href="https://medium.com/compendium/automatic-validation-of-kubernetes-config-in-azure-devops-e9ae15d67d3e?source=collection_archive---------1-----------------------#2020-03-24">https://medium.com/compendium/automatic-validation-of-kubernetes-config-in-azure-devops-e9ae15d67d3e?source=collection_archive---------1-----------------------#2020-03-24</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="1a8b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">厌倦了因为YAML文件中的缩进错误而导致的发布失败吗？希望语法错误像其他代码一样被构建管道捕获吗？那么这可能是你的解决方案！</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/bfb6e7cedf186382f8b798b21270491f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iwTn0dafBEn8O2p9LIKTjA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Validation errors again!?</figcaption></figure><h1 id="28f9" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">TL；速度三角形定位法(dead reckoning)</h1><ul class=""><li id="504f" class="kr ks hh ig b ih kt il ku ip kv it kw ix kx jb ky kz la lb bi translated">您可以使用<a class="ae lc" href="https://kubeval.instrumenta.dev/" rel="noopener ugc nofollow" target="_blank"> Kubeval </a>来验证您的k8s配置，作为构建管道的一部分。</li><li id="41ec" class="kr ks hh ig b ih ld il le ip lf it lg ix lh jb ky kz la lb bi translated">将<a class="ae lc" href="https://gist.github.com/teodoran/afb3b6888a7c40a0a2dc2fb399d4dd57" rel="noopener ugc nofollow" target="_blank">这个</a>和<a class="ae lc" href="https://gist.github.com/teodoran/9205f1974ef3dc985e1b658bf0c61e50" rel="noopener ugc nofollow" target="_blank">这个</a>文件添加到repo中一个名为<em class="jc"> Kubeval </em>的文件夹中，将<a class="ae lc" href="https://gist.github.com/teodoran/b41b282c0f2705924903fe6bca8ffbde" rel="noopener ugc nofollow" target="_blank">这两个任务添加到管道定义</a>中，就大功告成了！*</li></ul><p id="f6fe" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc">*我假设你已经忽略了</em> <a class="ae lc" href="https://git-scm.com/docs/gitignore" rel="noopener ugc nofollow" target="_blank"> <em class="jc">中的所有bin文件夹。gitignore </em> </a> <em class="jc">，并在您的构建管道中使用基于Linux的代理。</em></p><h1 id="aef0" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">多给我讲讲！</h1><h2 id="ef00" class="li ju hh bd jv lj lk ll jz lm ln lo kd ip lp lq kh it lr ls kl ix lt lu kp lv bi translated">记得吗-预演？</h2><p id="710e" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated">Kubectl 可以通过使用- dry-run标志在本地验证k8s配置，而不需要实际部署任何东西。这很好，也是在您自己的机器上验证配置的一个很好的选择，但是让Kubectl作为构建管道的一部分工作可能会很棘手。因此，当您在提交之前忘记验证配置时，或者您只是懒得找到命令和参数的正确组合，而只是验证，而不是抱怨其他事情时，您就陷入了这样一种情况，在发布失败之前，一切看起来都很好💣</p><h2 id="5556" class="li ju hh bd jv lj lk ll jz lm ln lo kd ip lp lq kh it lr ls kl ix lt lu kp lv bi translated">输入Kubeval</h2><p id="85f1" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated"><a class="ae lc" href="https://kubeval.instrumenta.dev/" rel="noopener ugc nofollow" target="_blank"> Kubeval </a>是一个专门用于在本地或CI管道中验证Kubernetes配置的工具。它是<a class="ae lc" href="https://github.com/instrumenta/kubeval/" rel="noopener ugc nofollow" target="_blank">开源软件</a>，支持多个Kubernetes版本，并且很好地发现了我们在编辑部署、服务、入口等时都会犯的所有小错误。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lz"><img src="../Images/40107e2e1f0a995ef22a86a77fc07161.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MxT7vCUUBaiUmg_xctPbYg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx">Kubeval in action</figcaption></figure><h2 id="897e" class="li ju hh bd jv lj lk ll jz lm ln lo kd ip lp lq kh it lr ls kl ix lt lu kp lv bi translated">限制</h2><p id="513b" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated">即使Kubeval验证成功，发布仍然可能失败，因为只有在实际集群上执行配置时才能发现一些错误。例如，如果您引用集群上不存在的配置映射，Kubeval将无法捕捉错误。尽管如此，它还是很擅长处理所有“没有找到预期的键”、“错误的缩进”和“无效类型”的错误。</p><h1 id="304b" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">将Kubeval添加到您的构建管道中</h1><h2 id="8550" class="li ju hh bd jv lj lk ll jz lm ln lo kd ip lp lq kh it lr ls kl ix lt lu kp lv bi translated">找到库贝瓦尔</h2><p id="aa3f" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated">Kubeval <a class="ae lc" href="https://kubeval.instrumenta.dev/installation/" rel="noopener ugc nofollow" target="_blank">以压缩二进制</a>的形式发布，可用于不同的平台。假设我们使用基于Linux的管道代理，您可以使用脚本来下载、验证和解压缩<em class="jc"> kubeval </em>可执行文件。</p><p id="9056" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">新建一个名为<em class="jc"> Kubeval </em>的文件夹，添加一个名为<a class="ae lc" href="https://gist.github.com/teodoran/afb3b6888a7c40a0a2dc2fb399d4dd57" rel="noopener ugc nofollow" target="_blank"> use-kubeval.sh </a>的文件，内容如下所示。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="cf83" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于我们从互联网下载并运行可执行文件，我们应该验证我们实际上已经得到了我们想要的可执行文件，而不是来自黑客或中间人攻击者的奇怪东西。这可以用Linux实用程序<a class="ae lc" href="https://en.wikipedia.org/wiki/Sha1sum" rel="noopener ugc nofollow" target="_blank"> <em class="jc"> sha256sum </em> </a>和一个校验和文件来完成，所以除了使用-kubeval.sh，我们还需要向<em class="jc"> Kubeval </em>文件夹添加一个校验和文件，命名为<a class="ae lc" href="https://gist.github.com/teodoran/9205f1974ef3dc985e1b658bf0c61e50" rel="noopener ugc nofollow" target="_blank"> kubeval-checksum </a>，内容如下所示。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ma mb l"/></div></figure><blockquote class="mc md me"><p id="9e10" class="ie if jc ig b ih ii ij ik il im in io mf iq ir is mg iu iv iw mh iy iz ja jb ha bi translated">当用作use-kubeval.sh脚本的一部分时，“sha256sum -c kubeval-checksum”将为我们下载的文件生成阿沙-256哈希，并将其与存储在kubeval-checksum中的先前生成的哈希进行比较。您应该评估这个验证策略对于您的构建系统是否足够安全。可以用“sha 256 sum—tag bin/Kubeval-Linux-amd64 . tar . gz”为新版本的kube val生成新的校验和。如果要使用更长的校验和哈希，可以使用“sha512sum”。</p></blockquote><h1 id="21c5" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">向生成管道添加验证</h1><p id="1da2" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated">现在我们需要向<a class="ae lc" href="https://gist.github.com/teodoran/b41b282c0f2705924903fe6bca8ffbde" rel="noopener ugc nofollow" target="_blank"> azure-pipeline.yml </a>管道定义添加两个步骤。第一个执行<em class="jc"> Kubeval </em>文件夹中的use-kubeval.sh，第二个执行<em class="jc"> CI </em>文件夹中所有YAML文件的严格验证。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ma mb l"/></div></figure><p id="4cb3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因为我们使用Linux命令来下载、验证和解压缩kubeval可执行文件，所以您需要在构建管道中使用基于Linux的vmImage，比如“ubuntu-latest”。</p><p id="09eb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">根据您是否使用Docker以及您在管道中放置Kubeval-steps的位置，您可能希望将<em class="jc"> Kubeval </em>文件夹添加到您的<a class="ae lc" href="https://docs.docker.com/engine/reference/builder/#dockerignore-file" rel="noopener ugc nofollow" target="_blank">中。dockerignore </a>，避免将内容复制到您的Docker图像中。</p><h1 id="7cd3" class="jt ju hh bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">关于安全性和升级Kubeval的一些信息</h1><p id="75ed" class="pw-post-body-paragraph ie if hh ig b ih kt ij ik il ku in io ip lw ir is it lx iv iw ix ly iz ja jb ha bi translated">如use-kubeval.sh脚本中所述，您应该检查是否有新版本的kubeval可用，如果有，就升级。在所有可预见的未来使用v0.14.0版本可能是一个非常糟糕的想法😅</p><p id="c1bc" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="jc">记得为新版本的kubeval生成一个带有“sha 256 sum-tag bin/kube val-Linux-amd64 . tar . gz”的新校验和。</em></p></div></div>    
</body>
</html>