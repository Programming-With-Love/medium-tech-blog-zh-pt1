<html>
<head>
<title>Hidden pitfalls when using Elvis operator</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Elvis运算符时隐藏的陷阱</h1>
<blockquote>原文：<a href="https://medium.com/google-developer-experts/the-hidden-pitfalls-of-the-elvis-operator-da536ba68161?source=collection_archive---------1-----------------------#2020-07-28">https://medium.com/google-developer-experts/the-hidden-pitfalls-of-the-elvis-operator-da536ba68161?source=collection_archive---------1-----------------------#2020-07-28</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="baed" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我猜我们很多人都喜欢猫王，无论是科特林的艺术家还是经营者。但是如果你不知道它是如何工作的，它会导致一些隐藏的陷阱。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jc"><img src="../Images/838b5175eb35c99853b42a45cdb17729.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*82D3muiY4l_HWKKWMEG58g.jpeg"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx"><a class="ae js" href="https://unsplash.com/photos/1LCzr14Ah5U" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/photos/1LCzr14Ah5U</a></figcaption></figure><p id="bb89" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我最近才意识到，弗拉基米尔·兹德拉夫科维奇(Vladimir Zdravkovic)在twitter上发布了一些代码，让我们猜猜它在打印什么:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es jv"><img src="../Images/532a650ee7ebf14a4e7b3d2ed22d90dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8w3Ajym38XAxLGmyJ6mrAA.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx"><a class="ae js" href="https://twitter.com/vlazdra/status/1287366531987406848?s=20" rel="noopener ugc nofollow" target="_blank">https://twitter.com/vlazdra/status/1287366531987406848?s=20</a></figcaption></figure><p id="062a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我假设有一个隐藏的谜题，但我看不出问题所在。我看不出为什么它会打印任何东西，但它确实打印了！<br/>在思考了这个问题之后(Vladimir写了一篇关于这个问题的<a class="ae js" href="https://dev.to/vlazdra/a-decompiled-story-of-kotlin-let-and-run-4k83" rel="noopener ugc nofollow" target="_blank">文章</a>),我发现越来越多的案例可能会出错。但是让我给你看一些代码:</p><h1 id="6c93" class="jw jx hh bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">科特林的零安全</h1><p id="d0b5" class="pw-post-body-paragraph ie if hh ig b ih ku ij ik il kv in io ip kw ir is it kx iv iw ix ky iz ja jb ha bi translated">我想我们大多数人都喜欢用Kotlin轻松编写空安全代码的方式，就像这样:</p><pre class="jd je jf jg fd kz la lb lc aw ld bi"><span id="d1a9" class="le jx hh la b fi lf lg l lh li">presenter?.onDestroy()</span></pre><p id="e105" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">或者</p><pre class="jd je jf jg fd kz la lb lc aw ld bi"><span id="9a1d" class="le jx hh la b fi lf lg l lh li">data?.let{ updateData(data) }</span></pre><p id="19e3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">添加一个替代案例非常简单:</p><pre class="jd je jf jg fd kz la lb lc aw ld bi"><span id="c22c" class="le jx hh la b fi lf lg l lh li">data?.let{ updateData(data) } ?: run { showLoadingSpinner() }</span></pre><h1 id="f385" class="jw jx hh bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">让我问你一件事</h1><p id="8f72" class="pw-post-body-paragraph ie if hh ig b ih ku ij ik il kv in io ip kw ir is it kx iv iw ix ky iz ja jb ha bi translated">你觉得下面的代码和上面的基本一样吗？</p><pre class="jd je jf jg fd kz la lb lc aw ld bi"><span id="6684" class="le jx hh la b fi lf lg l lh li">if (data != null) { <br/>   updateData(data) <br/>} else { <br/>   showLoadingSpinner()<br/>}</span></pre><p id="1870" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我相信我们大多数人都认为它们是等价的。但如果我告诉你不是呢？<br/><code class="du lj lk ll la b">if/else</code>完全是二进制的，它是<strong class="ig hi">非此即彼。</strong>但是有了<strong class="ig hi">猫王</strong>操作员，就有可能<strong class="ig hi">两个</strong>！为了理解为什么我们必须更进一步了解它是如何工作的。</p><p id="dde9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">除了明确属于某个<code class="du lj lk ll la b">if</code>的<code class="du lj lk ll la b">else</code>之外，Elvis操作符并不局限于单个<code class="du lj lk ll la b">?</code>。请记住，我们可以用链条锁住它们:</p><pre class="jd je jf jg fd kz la lb lc aw ld bi"><span id="8c8a" class="le jx hh la b fi lf lg l lh li">someVariable<strong class="la hi">?</strong>.someField<strong class="la hi">?</strong>.doSomething()</span></pre><p id="6ae1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果我们现在在这里添加Elvis操作符，它将根据左边的表达式执行:</p><pre class="jd je jf jg fd kz la lb lc aw ld bi"><span id="9d87" class="le jx hh la b fi lf lg l lh li">someVariable<strong class="la hi">?</strong>.someField<strong class="la hi">?</strong>.doSomething() ?: run { doSomethingElse() }</span></pre><p id="2a37" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此，如果<strong class="ig hi">中有任何</strong>表达式是<code class="du lj lk ll la b">null</code>，Elvis块就会被调用。在检查是否需要操作员之前，它将完成对左边的所有内容的评估。这个<strong class="ig hi">包括</strong> <strong class="ig hi">最后一个</strong> <strong class="ig hi">表达式</strong>。</p><p id="a04e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">所以这取决于<code class="du lj lk ll la b">doSomething()</code>返回什么！如果是<code class="du lj lk ll la b">null</code>，那么会对右侧进行求值。</p><p id="d5d4" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">或者以我们的例子为例:</p><pre class="jd je jf jg fd kz la lb lc aw ld bi"><span id="55a4" class="le jx hh la b fi lf lg l lh li">data?<strong class="la hi">.</strong>updateData(data) ?: run { showLoadingSpinner<strong class="la hi">()</strong> }</span></pre><p id="8802" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果<code class="du lj lk ll la b">updateData</code>返回<code class="du lj lk ll la b">null</code>，则<strong class="ig hi">也将</strong>显示装载旋转器！这可能不是你想象中的<code class="du lj lk ll la b">if/else</code>。你可能会想，这个表达式是安全的，但是可能两个函数都被调用了。</p><p id="4ef2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这就是弗拉基米尔的例子:</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ji jj di jk bf jl"><div class="er es ln"><img src="../Images/2eeb065426382f9c1325778f78a7c0b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bxin_yyB_rJRTzmm3kBYmw.png"/></div></div><figcaption class="jo jp et er es jq jr bd b be z dx"><a class="ae js" href="https://dev.to/vlazdra/a-decompiled-story-of-kotlin-let-and-run-4k83" rel="noopener ugc nofollow" target="_blank">https://dev.to/vlazdra/a-decompiled-story-of-kotlin-let-and-run-4k83</a></figcaption></figure><p id="fef3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于第二个变量是<code class="du lj lk ll la b">null</code>，它的<code class="du lj lk ll la b">let</code>返回<code class="du lj lk ll la b">null</code>，这导致了外部Elvis块的调用。</p><p id="007f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">因此，如果您想要预期的行为，最好明确地做一些事情:</p><pre class="jd je jf jg fd kz la lb lc aw ld bi"><span id="0f7d" class="le jx hh la b fi lf lg l lh li">//<!-- --> Extension Function to handle else cases<br/>fun &lt;T&gt; T?.whenNull(block: () -&gt; Unit) = this ?: block()</span><span id="e405" class="le jx hh la b fi lo lg l lh li">data?.updateData(data).<strong class="la hi">whenNull </strong>{ handleNull() }</span></pre><p id="5a43" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">记住，Kotlin中的所有东西都被解析成某种类型，包括每个表达式。记住，<code class="du lj lk ll la b">let</code>正在从您的块返回结果(就像<code class="du lj lk ll la b">run</code>一样)。保持警惕！小心点！</p><p id="c7d8" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">PS:看看上面例子的反编译代码:<a class="ae js" href="https://dev.to/vlazdra/a-decompiled-story-of-kotlin-let-and-run-4k83" rel="noopener ugc nofollow" target="_blank">https://dev . to/vlazdra/a-decompiled-story-of-kotlin-let-and-run-4k 83</a></p><p id="e977" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">PPS:特别感谢<a class="jt ju ge" href="https://medium.com/u/d8e8e655f6e4?source=post_page-----da536ba68161--------------------------------" rel="noopener" target="_blank">卢卡斯·诺比尔</a>和<a class="jt ju ge" href="https://medium.com/u/9fbde7d7cabf?source=post_page-----da536ba68161--------------------------------" rel="noopener" target="_blank">阿图尔·拉托泽夫斯基</a>在此提供额外的投入，热爱群众的智慧🤗</p></div></div>    
</body>
</html>