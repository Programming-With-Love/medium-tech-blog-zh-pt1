<html>
<head>
<title>Differential Serving — Food for latest browsers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">差异化服务——最新浏览器的食物</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/differential-serving-food-for-latest-browsers-ba96192eb0ad?source=collection_archive---------8-----------------------#2020-06-22">https://medium.com/walmartglobaltech/differential-serving-food-for-latest-browsers-ba96192eb0ad?source=collection_archive---------8-----------------------#2020-06-22</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/1ca092c8e2ca9d64ac4d2b02e353b717.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MVsPmOSimcvU6qkz.png"/></div></div><figcaption class="ip iq et er es ir is bd b be z dx">Credit: <a class="ae it" href="https://pixabay.com/illustrations/browsers-internet-web-design-1273344/" rel="noopener ugc nofollow" target="_blank">pixabay</a>.com</figcaption></figure><p id="5d17" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">差异服务是一种为现代浏览器提供最新javascript包的现代技术。</p><p id="a3ff" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">有一段时间围绕这个话题有很多问题。在WalmartLabs，我们看到缩小的包大小减少了大约10%到25%,并使用这种技术来帮助我们的整体站点速度。</p><p id="9c23" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在这篇博客中，我将回答其中的一些问题。(什么、为什么和如何)</p><p id="b0cf" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">什么是差别服务？</p><p id="5a83" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们为什么需要它？</p><p id="d88d" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们如何实现它？</p><p id="0182" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">什么</strong>？</p><p id="92f6" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">差异化服务背后的想法是，应用程序生成两个包</p><ol class=""><li id="1916" class="js jt hh iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">默认捆绑包:在捆绑你的应用程序时，这个JS捆绑包必须已经生成了——受所有浏览器支持，因为它和一些polyfills一起被传输到ES5。</li><li id="ea99" class="js jt hh iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">ES6 bundle:作为differential serving的一部分，这个bundle具有完全相同的功能，但是没有附加polyfills，这使得它的大小要小得多，并且只能在受支持的现代浏览器中工作。</li></ol><p id="0491" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">为什么？</strong></p><p id="e05e" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这里的好处是，旧浏览器可以有一个单独的包，支持polyfills或transforms等功能，对于现代浏览器，它将有一个单独的包，支持es6-这是小尺寸，因此执行速度更快-这意味着更高的网站速度和更好的性能。</p><p id="45c4" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">此外，超过80%的沃尔玛用户使用现代JS支持的浏览器，这一功能有助于我们的大部分人获得更好的用户体验。</p><p id="ee8e" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">如何？</strong></p><p id="9f3e" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">实现它有两个主要步骤:</p><ol class=""><li id="4d00" class="js jt hh iw b ix iy jb jc jf ju jj jv jn jw jr jx jy jz ka bi translated">生成两个不同的捆绑包—默认捆绑包和es6捆绑包</li><li id="2dd6" class="js jt hh iw b ix kb jb kc jf kd jj ke jn kf jr jx jy jz ka bi translated">向浏览器提供正确的捆绑包。</li></ol><p id="9a59" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为了生成同一个应用程序的两个版本，需要为目标浏览器进行一些巴别塔配置。</p><p id="e2a7" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在WalmartLabs，所有应用都是基于<a class="ae it" href="https://github.com/electrode-io/electrode" rel="noopener ugc nofollow" target="_blank">电极</a>的。它的通天塔配置是从这里的<a class="ae it" href="https://github.com/electrode-io/electrode/blob/v6.x.x/packages/electrode-archetype-react-app-dev/config/babel/babelrc-client.js#L133" rel="noopener ugc nofollow" target="_blank">继承而来的</a>，在应用级配置必须设置目标和浏览器列表。为了简化配置层，webpack配置如下所示:</p><figure class="kg kh ki kj fd ii"><div class="bz dy l di"><div class="kk kl l"/></div></figure><p id="d278" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">上面的配置将生成es6包，其中一些重要的配置是:"<a class="ae it" href="https://babeljs.io/docs/en/babel-preset-env" rel="noopener ugc nofollow" target="_blank"> @babel/preset-env </a>"在" targets "中使用现代浏览器版本预设，以及"<a class="ae it" href="https://babeljs.io/docs/en/babel-preset-env#usebuiltins" rel="noopener ugc nofollow" target="_blank"> useBuiltIns </a>"值到" entry "。此外，基于生产版本，“<a class="ae it" href="https://babeljs.io/docs/en/babel-preset-env#modules" rel="noopener ugc nofollow" target="_blank">模块</a>”值为“auto”或“commonjs”。</p><p id="2097" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为了服务于es6捆绑包，第一个任务是检测浏览器类型和版本，以便有资格作为现代浏览器来理解es6捆绑包。一个好方法是使用用户代理来检查浏览器类型。使用名为<a class="ae it" href="https://www.npmjs.com/package/bowser" rel="noopener ugc nofollow" target="_blank">的库bowser </a></p><p id="40a0" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">一些开发者使用<a class="ae it" href="https://www.npmjs.com/package/browserslist-useragent" rel="noopener ugc nofollow" target="_blank"> Browserslist Useragent </a>库，但是我发现<a class="ae it" href="https://www.npmjs.com/package/bowser" rel="noopener ugc nofollow" target="_blank">布瑟</a>有更小的尺寸和优化的多平台支持。</p><figure class="kg kh ki kj fd ii"><div class="bz dy l di"><div class="kk kl l"/></div></figure><p id="9b96" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在电极专用应用程序中，要在这些最新浏览器中选择es6捆绑包，需要将此参数“<a class="ae it" href="https://github.com/electrode-io/electrode/blob/c15be2efcd137931abc5d6c856e827cb087bd6f6/packages/electrode-redux-router-engine/lib/util.js#L25" rel="noopener ugc nofollow" target="_blank"> request.query.__dist”值设置为es6 </a></p><figure class="kg kh ki kj fd ii"><div class="bz dy l di"><div class="kk kl l"/></div></figure><p id="debe" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在任何电极应用程序中使用这种配置，在构建babel transpiles时，整个应用程序不包括es6捆绑包的节点模块，但您可以添加逻辑来包括和排除babel transpiling中的某些节点模块，但我将保持这篇博客简单，以便清楚地理解主要步骤。</p><p id="9c8e" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">最后，当您运行应用程序时，您会看到这个es6.web.bundle.js捆绑包提供给现代浏览器，否则它会提供defaut.web.bundle.js</p><figure class="kg kh ki kj fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es km"><img src="../Images/9ec28b535c7a1a87d8dd316579baf874.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CTJcz5NNHBwoMhMFmQhuGg.png"/></div></div></figure><p id="9336" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">全新闪亮的es6捆绑包比默认捆绑包小10%到25%。我们期望性能和网站速度的提高是一致的，但实际上有点不同。</p><p id="cf8e" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">但事实并非如此。自从我们开始在生产中使用<a class="ae it" href="https://github.com/google/brotli" rel="noopener ugc nofollow" target="_blank"> Brotli压缩</a>以来，这种压缩机制在默认捆绑包上的效果比es6捆绑包好得多es6捆绑包将这些捆绑包之间的大小差异缩小到大约3–5%。这很好地解释了为什么性能增益低于预期。</p><p id="7d01" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><strong class="iw hi">总结</strong></p><p id="9c81" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们在2019年年初至年中开始实施差别服务，这在整个行业中处于相当早期的阶段。我们在实验中了解了它的性能增益和优缺点。</p><p id="e070" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">沃尔玛是一家大公司，尤其是购物车和收银台的表现对业务和收入至关重要。随着时间的推移，随着代码库随着新特性和功能的增加，差异服务在站点速度和性能方面提供了更好的收益。</p><p id="a7c3" class="pw-post-body-paragraph iu iv hh iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">此外，这建立了一个平台，使我们能够随着JS中新特性的发布，继续为受支持的浏览器提供现代JS。</p></div></div>    
</body>
</html>