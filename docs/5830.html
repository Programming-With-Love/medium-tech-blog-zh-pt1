<html>
<head>
<title>Travel light: K3S+MySQL on OCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">旅行灯:OCI K3S+MySQl</h1>
<blockquote>原文：<a href="https://medium.com/oracledevs/travel-light-k3s-mysql-on-oci-9b2befda989c?source=collection_archive---------0-----------------------#2021-10-27">https://medium.com/oracledevs/travel-light-k3s-mysql-on-oci-9b2befda989c?source=collection_archive---------0-----------------------#2021-10-27</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="er es ie"><img src="../Images/2344829396db90e44d970d0b8fbd748b.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*2Wdf0EfmJ0T5kiESb2_CVA.png"/></div></figure><p id="d035" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">在之前的一篇帖子中，我利用T2 K3S T3对OCI进行了一次旋转，我们创建了一个基本的单节点服务器/代理，它使用SQLite作为数据存储。K3S的好处之一是它为您提供了许多数据存储选项</p><ul class=""><li id="8a41" class="jk jl hh in b io ip is it iw jm ja jn je jo ji jp jq jr js bi translated"><a class="ae jj" href="https://www.mysql.com/" rel="noopener ugc nofollow" target="_blank"> MySQL </a></li><li id="68ae" class="jk jl hh in b io jt is ju iw jv ja jw je jx ji jp jq jr js bi translated">嵌入式或外部etcd</li><li id="bd69" class="jk jl hh in b io jt is ju iw jv ja jw je jx ji jp jq jr js bi translated">一种数据库系统</li></ul><p id="1a7e" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">在本文中，我们将尝试使用MySQL作为数据存储。由于<a class="ae jj" href="https://docs.oracle.com/en-us/iaas/mysql-database/index.html" rel="noopener ugc nofollow" target="_blank"> MySQL在OCI </a>上作为一项服务可用，我们也将使用它。我们还将添加代理节点。下面是K3S集群的基础设施，以及子网、堡垒和MySQL。我们还需要2个NSG(用于服务器和代理)以及一个安全列表(用于MDS子网)。您可以在<a class="ae jj" href="https://rancher.com/docs/k3s/latest/en/installation/installation-requirements/#networking" rel="noopener ugc nofollow" target="_blank"> K3S文档</a>中找到为安全规则打开的端口列表。</p><figure class="jz ka kb kc fd ii er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es jy"><img src="../Images/894bb997ba8709062ab1a6d134355393.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zjBpYaWw62vttp2CE5cqSQ.png"/></div></div></figure><h2 id="5dbe" class="kh ki hh bd kj kk kl km kn ko kp kq kr iw ks kt ku ja kv kw kx je ky kz la lb bi translated">设置服务器</h2><p id="da5b" class="pw-post-body-paragraph il im hh in b io lc iq ir is ld iu iv iw le iy iz ja lf jc jd je lg jg jh ji ha bi translated">我们现在将只创建1个。创建一个计算实例，将其添加到servre子网，并确保您也设置了服务器NSG。</p><p id="2130" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">设置完成后，登录服务器主机并安装MySQL Shell:</p><pre class="jz ka kb kc fd lh li lj lk aw ll bi"><span id="91b5" class="kh ki hh li b fi lm ln l lo lp">sudo dnf install -y mysql-shell</span></pre><p id="dc4e" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">从OCI控制台获取MDS端点，并使用MySQL Shell连接到它:</p><pre class="jz ka kb kc fd lh li lj lk aw ll bi"><span id="a932" class="kh ki hh li b fi lm ln l lo lp">mysqlsh &lt;admin_user&gt;@&lt;private_endpoint&gt;</span></pre><figure class="jz ka kb kc fd ii er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es lq"><img src="../Images/16e30f3100f59141c84a4b746a4fda9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*17xeuqGGh04_Qrn-jytnTQ.png"/></div></div></figure><p id="0f74" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">在上面的截图中，我的MDS端点位于10.0.0.40。设置K3S _ DATASTORE _ ENDPOINT变量:</p><pre class="jz ka kb kc fd lh li lj lk aw ll bi"><span id="864e" class="kh ki hh li b fi lm ln l lo lp">K3S_DATASTORE_ENDPOINT='mysql://admin:V3ry_Secure!@tcp(10.0.0.40:3306)/k3s'</span></pre><p id="a3c2" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">如果你能连接，你就可以走了；否则请检查您的安全列表和NSG。您也可以使用netcat来检查您的连接:</p><pre class="jz ka kb kc fd lh li lj lk aw ll bi"><span id="92a1" class="kh ki hh li b fi lm ln l lo lp">nc -v 10.0.0.40 3306</span></pre><p id="c72f" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">在服务器上安装mysql-shell是很有用的，尤其是当您面临权限问题时。</p><p id="f08d" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">您现在可以安装K3S了:</p><pre class="jz ka kb kc fd lh li lj lk aw ll bi"><span id="1922" class="kh ki hh li b fi lm ln l lo lp">curl -sfL <a class="ae jj" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | sh -s — server \<br/>  --datastore-endpoint=$K3S_DATASTORE_ENDPOINT</span></pre><p id="406f" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">设置K3S后，如前所述更改k3s.yaml文件的权限，并验证您是否可以看到一个节点:</p><pre class="jz ka kb kc fd lh li lj lk aw ll bi"><span id="5d36" class="kh ki hh li b fi lm ln l lo lp">$ sudo chmod go+r /etc/rancher/k3s/k3s.yaml</span><span id="d0ff" class="kh ki hh li b fi lr ln l lo lp">$ kubectl get nodes<br/>NAME     STATUS   ROLES                  AGE   VERSION</span><span id="4699" class="kh ki hh li b fi lr ln l lo lp">server   Ready    control-plane,master   34m   v1.21.5+k3s2</span></pre><p id="8d97" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">获取K3S令牌，您将需要该令牌向服务器注册代理:</p><pre class="jz ka kb kc fd lh li lj lk aw ll bi"><span id="5fce" class="kh ki hh li b fi lm ln l lo lp">$ sudo cat /var/lib/rancher/k3s/server/node-token<br/>K104214ab68054dadeb1616eda4c1b824de120a9f297dee24a08014cbcf89802220::server:38123df6165f4573e47def57e601aeea</span></pre><p id="85e0" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">最后，配置firewalld以允许端口6443上的流量:</p><pre class="jz ka kb kc fd lh li lj lk aw ll bi"><span id="c7cd" class="kh ki hh li b fi lm ln l lo lp">sudo firewall-cmd --permanent --add-port=6443/tcp<br/>sudo firewall-cmd --reload</span></pre><h2 id="fad4" class="kh ki hh bd kj kk kl km kn ko kp kq kr iw ks kt ku ja kv kw kx je ky kz la lb bi translated">设置代理</h2><figure class="jz ka kb kc fd ii er es paragraph-image"><div role="button" tabindex="0" class="kd ke di kf bf kg"><div class="er es ls"><img src="../Images/8b970ac0fb9ba9e5e8c056d3c0c19b0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JPl8LrncxVmd40TN"/></div></div></figure><p id="0320" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">接下来，我们将创建代理。我们现在只创建1个。创建一个计算实例，将其添加到代理子网，并确保您已经设置了代理NSG。</p><p id="7651" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">一旦提供了代理节点，就可以使用第二个终端对其进行ssh。验证您是否可以使用netcat连接到API服务器(我的分配为10.0.0.18):</p><pre class="jz ka kb kc fd lh li lj lk aw ll bi"><span id="1e7c" class="kh ki hh li b fi lm ln l lo lp">$ nc -v 10.0.0.18 6443<br/>Ncat: Version 7.70 ( <a class="ae jj" href="https://nmap.org/ncat" rel="noopener ugc nofollow" target="_blank">https://nmap.org/ncat</a> )<br/>Ncat: Connected to 10.0.0.18:6443.</span></pre><p id="60a0" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">您现在可以继续安装代理了。首先导出以下环境变量:</p><pre class="jz ka kb kc fd lh li lj lk aw ll bi"><span id="ae21" class="kh ki hh li b fi lm ln l lo lp">K3S_URL=https://10.0.0.18:6443<br/>K3S_TOKEN=K104214ab68054dadeb1616eda4c1b824de120a9f297dee24a08014cbcf89802220::server:38123df6165f4573e47def57e601aeea</span></pre><p id="0d77" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">请注意，因为我们正在安装代理，所以需要令牌。在安装过程中使用K3S_URL将会配置节点成为代理。太棒了。我们开始吧:</p><pre class="jz ka kb kc fd lh li lj lk aw ll bi"><span id="35dd" class="kh ki hh li b fi lm ln l lo lp">curl -sfL <a class="ae jj" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | K3S_URL=$K3S_URL K3S_TOKEN=$K3S_TOKEN sh -</span></pre><p id="9bbd" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">现在，当您检查服务器上的节点时，您可以看到工作节点:</p><pre class="jz ka kb kc fd lh li lj lk aw ll bi"><span id="f6c3" class="kh ki hh li b fi lm ln l lo lp">$ kubectl get nodes<br/>NAME     STATUS   ROLES                  AGE   VERSION<br/>server   Ready    control-plane,master   34m   v1.21.5+k3s2<br/>a1       Ready    &lt;none&gt;                 47s   v1.21.5+k3s2</span></pre><p id="5f58" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">这里，我们使用一个计算实例来创建代理节点，您可以重复这一步。但是也可以用实例池来创建代理。</p><p id="59c3" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">首先，创建一个实例配置。确保在云初始化中添加以下内容:</p><pre class="jz ka kb kc fd lh li lj lk aw ll bi"><span id="4060" class="kh ki hh li b fi lm ln l lo lp">#cloud-config<br/>runcmd:<br/> — curl -sfL https://get.k3s.io | K3S_URL=https://10.0.0.18:6443 K3S_TOKEN=K104214ab68054dadeb1616eda4c1b824de120a9f297dee24a08014cbcf89802220::server:38123df6165f4573e47def57e601aeea sh -</span></pre><p id="91bf" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">用您的值替换上面的令牌值和url。现在可以创建实例池了。</p><p id="cbab" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">实例池创建的代理准备就绪后，检查它们是否成功注册:</p><pre class="jz ka kb kc fd lh li lj lk aw ll bi"><span id="c071" class="kh ki hh li b fi lm ln l lo lp">kubectl get nodes</span></pre><h2 id="d6e2" class="kh ki hh bd kj kk kl km kn ko kp kq kr iw ks kt ku ja kv kw kx je ky kz la lb bi translated">结论</h2><p id="f885" class="pw-post-body-paragraph il im hh in b io lc iq ir is ld iu iv iw le iy iz ja lf jc jd je lg jg jh ji ha bi translated">这篇文章是为了探索OCI·MDS运行K3S的可行性。在未来的帖子中，我们将探索更多的K3S功能以及与OCI的集成。</p><p id="879c" class="pw-post-body-paragraph il im hh in b io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji ha bi translated">参考资料:</p><ul class=""><li id="8718" class="jk jl hh in b io ip is it iw jm ja jn je jo ji jp jq jr js bi translated"><a class="ae jj" href="https://rancher.com/docs/k3s/latest/en/installation/install-options/" rel="noopener ugc nofollow" target="_blank">https://rancher . com/docs/k3s/latest/en/installation/install-options/</a></li><li id="295d" class="jk jl hh in b io jt is ju iw jv ja jw je jx ji jp jq jr js bi translated">【https://rancher.com/docs/k3s/latest/en/quick-start/ T2】号</li><li id="ecb4" class="jk jl hh in b io jt is ju iw jv ja jw je jx ji jp jq jr js bi translated"><a class="ae jj" href="https://rancher.com/docs/k3s/latest/en/installation/datastore/" rel="noopener ugc nofollow" target="_blank">https://rancher . com/docs/k3s/latest/en/installation/datastore/</a></li></ul></div></div>    
</body>
</html>