<html>
<head>
<title>Improving GIF performance on Pinterest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">提高Pinterest上的GIF性能</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/improving-gif-performance-on-pinterest-8dad74bf92f1?source=collection_archive---------1-----------------------#2017-04-06">https://medium.com/pinterest-engineering/improving-gif-performance-on-pinterest-8dad74bf92f1?source=collection_archive---------1-----------------------#2017-04-06</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="6924" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Tianyu Lang和Nick DeChant| Pinterest工程师，视频和图像平台</p><p id="1577" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest是最注重图片的在线服务之一，因此我们不断努力提高这些图片的速度和质量至关重要，无论是静态图片、GIF图片还是视频。作为视频和图像平台团队工作的一部分，我们发现将gif转换为视频可以减少加载时间，提高播放流畅度并减少应用崩溃。</p><h2 id="d7c2" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated">确定gif的改进</h2><p id="d83b" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">2014年，一个小团队<a class="ae kc" rel="noopener" href="/@Pinterest_Engineering/building-support-for-gifs-over-night-8909df8ef4ca">在Makeathon经过一夜的黑客攻击后，建立了对gif的支持</a>。随着时间的推移，我们努力改善加载时间，使用更少的内存来避免崩溃，这损害了用户体验和参与。</p><p id="fa71" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">gif比图像和视频大得多，因此下载时间更长。此外，我们的iOS应用程序上的GIF库使用大量内存来解码和显示动画。因为gif很大，需要一个内存密集型的库来从压缩格式解码成原始像素，我们的iOS应用程序会耗尽内存并崩溃。</p><p id="22fd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">为了解决这个问题，在2016年<a class="ae kc" href="https://engineering.pinterest.com/blog/building-pinterest%E2%80%99s-video-platform" rel="noopener ugc nofollow" target="_blank">建立了我们的原生视频平台</a>后，我们开始将gif转换为视频。</p><h2 id="3944" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated">GIF与视频</h2><p id="19aa" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">GIF格式创建于1987年，是允许慢速调制解调器下载大图像的有效格式。1995年，Netscape Navigator 2.0首次支持动画循环gif。gif动画制作非常简单，只需快速翻转一系列单独的图像。你可以看看它的<a class="ae kc" href="https://en.wikipedia.org/wiki/GIF" rel="noopener ugc nofollow" target="_blank">维基百科</a>页面了解更多历史。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es kd"><img src="../Images/b0c0cdf170fee50cbb4d07850f0dc1b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/0*akL0KXb54mViVajR."/></div></figure><p id="1a03" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">比如上面的Mario GIF，播放下面3张图片，中间间隔0.54秒，达到动画的错觉。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kl"><img src="../Images/5e262f003ddd28a7d7f5c980b2fe6fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cB6aSOcibUkSrnJE."/></div></div></figure><p id="df72" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">然而，GIF的简单动画支持倾向于存储重复的信息并导致大文件。例如，下面的公共区域在任何帧中都没有改变，但仍然被存储。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es kq"><img src="../Images/ce1cf94c1a7fbc8cd6f0c2a44de3511c.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/0*a1WtPArcErtCGzsp."/></div></figure><p id="7d26" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这个缺点可以通过在创建图像时使用正确的“<a class="ae kc" href="http://www.webreference.com/content/studio/disposal.html" rel="noopener ugc nofollow" target="_blank">处理方法</a>来减少。正确的处理方法通过去除重复的信息来减小文件大小，因此只有第一帧需要存储“公共区域”,第二帧和第三帧只存储差异。然而，没有多少GIF创建软件利用这种优化。</p><p id="f7b1" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">H.264视频于2003年首次推出，然后在2014年之前的每个版本中不断改进。H.264视频不像gif那样存储单独的图像，而是存储完整的图像(关键帧)和增量(差分帧)。下面是H.264视频中帧存储方式的简化示意图。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kl"><img src="../Images/30f71dfe7b63d7d50362edb93aefb75a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bZLDW_-uBZrO6kY2."/></div></div></figure><p id="fb7b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">帧1是“完整”图像，而帧2和3是相对于完整图像的增量。如果第4帧有重大变化，那么第4帧将是一个新的“完整”图像。</p><p id="4bab" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">出于我们的目的，我们从影响加载速度和视频平滑度的三个特征(流、自适应比特率和大小)来比较gif和视频。</p><h2 id="122e" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated">流动</h2><p id="1e7d" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">流媒体会影响用户在播放开始前等待的时间。更好的流减少感知的加载时间。如果内容不是流式的，则需要完整下载。想想等待从网飞寄来的DVD和在你的笔记本电脑或手机上播放之间的区别。</p><p id="fc19" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">gif和H.264视频都可以流化，然而，H.264视频可以使用苹果最近开发的HLS (HTTP直播流)技术。HLS于2009年首次推出，现在在web、Android和iOS上得到原生支持。使用HLS，视频需要首先分成连续的块，然后才能下载并在播放设备上逐块播放。HLS <a class="ae kc" href="https://en.wikipedia.org/wiki/M3U" rel="noopener ugc nofollow" target="_blank">播放列表</a>在流媒体会话开始时获取。它们通过向播放设备提供每个视频片段的位置来引导播放设备。下图演示了使用HLS播放视频的过程。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kr"><img src="../Images/20149f6efde62d20d5950b2038f326d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MRyN1nYRcGcjLYnU."/></div></div></figure><p id="1795" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这些视频片段还允许视频更高效地缓存在我们的CDN中。如果只有视频的一部分被频繁访问，则只需要缓存相应的片段。然而，对于gif，必须缓存整个文件。</p><h2 id="d674" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated">自适应比特率流</h2><p id="2f3b" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">自适应比特率流是一种通过根据网络条件降低媒体质量来增强用户体验的技术。如果网络带宽突然下降，它会切换到较低质量的视频版本，从而提高视频播放的流畅性，反之亦然。</p><p id="4852" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">由于HLS视频已经成块，自适应比特率流几乎是免费的。我们只需要为同一视频生成不同比特率的变体，然后根据网络条件在它们之间切换。下图简要说明了HLS如何实现自适应比特率流。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es kr"><img src="../Images/6a79a995e11eebaf568fe311355edc97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*999MiKUvGO5WBhTI."/></div></div></figure><p id="69ad" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">gif可实现自适应比特率流。我们提取GIF中的图像，生成不同质量的备选方案，并创建一个GIF播放器，使用自适应技术来播放它。然而，这需要大量的工作，你需要建立自己的GIF播放器。相比之下，所有原生视频播放器都支持自适应比特率视频，并将自动切换质量/比特率以获得最佳体验。</p><h2 id="10cb" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated">大小</h2><p id="1767" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">文件大小以最直接的方式影响加载速度。文件越大，下载时间越长。</p><p id="d644" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">H.264视频比GIF视频小得多，我们通过实验证实了这一点。我们随机挑选了1万张3.1KB到78MB的动画gif，转换成H.264视频。我们使用FFmpeg 3.2和下面的命令进行转换。</p><pre class="ke kf kg kh fd ks kt ku kv aw kw bi"><span id="778c" class="jc jd hh kt b fi kx ky l kz la"><strong class="kt hi">ffmpeg -i $gifPath -movflags faststart -pix_fmt yuv420p -vf “scale=trunc(iw/2)*2:trunc(ih/2)*2” -c:v libx264 $videoPath</strong></span></pre><p id="5aee" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">下图展示了将这10，000张gif转换为视频后，大小缩减的分布情况。比率越大，结果越好。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="er es lb"><img src="../Images/9705c4e6a8926e3d4d85e204e3a1611e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/0*iG-JFK8EotwjbtL6."/></div></div></figure><p id="1fd7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">大约93%的gif图片比视频图片至少缩小了一半。将近50%的gif图片的视频副本只有原始图片的八分之一大。此外，过程中的质量损失可以忽略不计。下面是原始大小为4.1 MB的GIF与其1.4 MB的视频副本的并排比较。</p><figure class="ke kf kg kh fd ki"><div class="bz dy l di"><div class="lc ld l"/></div></figure><p id="e67c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">GIF:</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es le"><img src="../Images/bd082b9db1734ea4d9420c50ad28e148.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/0*Cy0_-5S3ta1t21kg."/></div></figure><h2 id="2210" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated">结果</h2><p id="e98d" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">在比较了gif和视频之后，我们对将gif转换成视频的决定充满了信心。让我们看看视频的威力。我们在相同的条件下，在同一台设备上播放了两次相同的三张gif，一次是gif，一次是视频。视频运行流畅，在26秒内完成，而gif滞后，在83秒内完成。以下是对比:</p><figure class="ke kf kg kh fd ki"><div class="bz dy l di"><div class="lc ld l"/></div></figure><h2 id="6e94" class="jc jd hh bd je jf jg jh ji jj jk jl jm ip jn jo jp it jq jr js ix jt ju jv jw bi translated">警告</h2><p id="adb8" class="pw-post-body-paragraph ie if hh ig b ih jx ij ik il jy in io ip jz ir is it ka iv iw ix kb iz ja jb ha bi translated">虽然结果很好，但有一个问题。gif并不总是比视频大。如果GIF在帧之间有巨大的延迟，转换后的视频将明显大于原始GIF。例如，下面的GIF只有162帧，6.6 MB，然而它的视频副本超过130 MB。在这张GIF的每一帧之间，有655.35秒的延迟。那可是10多分钟啊！默认情况下，FFmpeg每隔几秒钟创建一个“完整”图像(关键帧)。因此，这个GIF将导致比必要的多得多的关键帧。</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div class="er es lf"><img src="../Images/c937a111c6f50cc68de625d890f1feba.png" data-original-src="https://miro.medium.com/v2/resize:fit:650/0*Qq7sIYPdaGTQH3uV."/></div></figure><p id="5bee" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们目前正在研究构建一个解决方案来处理这些类型的图像。请关注未来的更新，并在Pinterest上享受改进的GIF体验！</p><p id="488e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="lg">鸣谢:GIF- &gt;视频转码项目的主要贡献者包括来自视频&amp;图像平台团队的天宇朗、尼克·德尚、张睿和诺贝特·波托基。</em></p></div></div>    
</body>
</html>