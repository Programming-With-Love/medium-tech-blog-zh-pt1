<html>
<head>
<title>Dynamic and reactive parameterization in Jenkins pipelines using HTML, Groovy, and Bash.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jenkins管道中使用HTML、Groovy和Bash的动态和反应式参数化。</h1>
<blockquote>原文：<a href="https://medium.com/globant/dynamic-and-reactive-parameterization-in-jenkins-pipelines-using-html-groovy-and-bash-27b031fcd69b?source=collection_archive---------0-----------------------#2021-05-12">https://medium.com/globant/dynamic-and-reactive-parameterization-in-jenkins-pipelines-using-html-groovy-and-bash-27b031fcd69b?source=collection_archive---------0-----------------------#2021-05-12</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="f5d7" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">几年前，DevOps文化蓬勃发展，并开始成为大多数微服务架构中的必备元素，这要归功于同时为数百个服务自动化应用生命周期的便利性。这种需求的增长也带来了新的挑战和开发CI/CD工作流和多种技术的可能方法。</p><p id="8c1e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在我们的具体案例中，我们将讨论Jenkins，以及如何使用一个名为“主动选择”的插件来扩展管道参数化的可能性</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es jc"><img src="../Images/57bf55341eab630e9f35f20ce7cb6174.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*dSSUhxBJYX6ci602KAsRhQ.png"/></div><figcaption class="jk jl et er es jm jn bd b be z dx"><strong class="bd jo">Source</strong>:<a class="ae jp" href="https://ichi.pro/es/canalizacion-de-jenkins-con-gitlab-para-proyectos-java-231864011383381" rel="noopener ugc nofollow" target="_blank"> Jenkins + Gitlab</a></figcaption></figure><h1 id="9027" class="jq jr hh bd jo js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak">内容:</strong></h1><ul class=""><li id="1b90" class="kn ko hh ig b ih kp il kq ip kr it ks ix kt jb ku kv kw kx bi translated">这个叫做“主动选择”的插件是什么？为什么它如此有用</li><li id="4d2a" class="kn ko hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">2-插件“主动选择”是如何工作的？</li><li id="1a22" class="kn ko hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">AWS中主动选择插件的一个实际例子:预览和上传一张图片到一个现有的S3桶。</li><li id="3829" class="kn ko hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">4-创建管线参数</li><li id="70ca" class="kn ko hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">5-结论</li></ul><h1 id="ae11" class="jq jr hh bd jo js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak"> 1-这个叫做“主动选择”的插件是什么，为什么它如此有用？</strong></h1><p id="1a9d" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">如其文档所述:“主动选择插件用于参数化自由式Jenkins作业，以创建脚本化、动态和交互式作业参数。主动选择参数可以动态更新，并可以呈现为组合框、复选框、单选按钮或丰富的HTML UI小部件。”</p><p id="1e7d" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通常，当有数百个服务要部署时，管道被参数化，以允许您仅从一个管道中选择多种部署，(即，应该部署哪个环境、使用什么名称、是否应该执行测试……)Jenkins当前允许您使用一些预定义的参数，如选择、复选框或字符串参数。当你不得不管理不同的管道时，你会发现在某些情况下Jenkins提供的参数由于其静态性质是不够的，在这些情况下，插件“Active Choices”来丰富你的参数化选项，允许你在参数之间传递反应引用，并在你的参数化选项中呈现自定义HTML。</p><h1 id="7f7c" class="jq jr hh bd jo js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak"> 2-插件“主动选择”是如何工作的？</strong></h1><p id="76a8" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">在配置管道时，它提供了3种新的参数:</p><ul class=""><li id="e4e3" class="kn ko hh ig b ih ii il im ip lg it lh ix li jb ku kv kw kx bi translated"><strong class="ig hi"> Active Choices参数</strong>:允许您使用Groovy或Scriplet脚本来确定您的输入是被计算还是被预定义，并根据计算结果返回结果。</li><li id="4270" class="kn ko hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated"><strong class="ig hi">主动选择反应参数</strong>:与主动选择相同，允许您使用Groovy或Scriplet脚本，此外，当引用的参数改变时，这些参数将被重新计算(即，当ENV是DEV时，ENV是被引用的参数，参数将反应并禁用“执行测试”选择参数)</li><li id="3408" class="kn ko hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated"><strong class="ig hi">主动选择反应参考参数</strong>:包含主动选择参数和主动选择反应参数选项，另外启用新的参数选项，如HTML小工具、项目符号或编号列表、输入框等。</li></ul><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es lj"><img src="../Images/28cc107cd1643b956ca565f2e8a2e5bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:866/1*BBW8sYEL2ydjTP8N8ZiNeA.gif"/></div><figcaption class="jk jl et er es jm jn bd b be z dx"><strong class="bd jo">Source:</strong> <a class="ae jp" href="https://github.com/jenkinsci/active-choices-plugin" rel="noopener ugc nofollow" target="_blank">Active Choices Plugin Github Repository</a></figcaption></figure><h1 id="3fb4" class="jq jr hh bd jo js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak">3-AWS中主动选择插件的一个实际例子:预览并上传一张图片到现有的S3桶中。</strong></h1><p id="d51a" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">假设您现在希望您的团队能够直接访问AWS管理控制台，将您的资产上传到S3，因为这将导致运营过热(用户创建、权限、策略……)，相反，您更希望将您资产的映像上传集中在Jenkins中，避免向用户提供具有S3特定权限的个人凭据。您还希望能够列出S3目录，并确定将资产上传到哪个目录。</p><p id="d360" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要做到这一点，你需要以下东西:</p><ul class=""><li id="9439" class="kn ko hh ig b ih ii il im ip lg it lh ix li jb ku kv kw kx bi translated">图像URL的输入字符串参数，带有用于预览图像的HTML反应引用参数。</li><li id="0f02" class="kn ko hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">用于输入图像名称的文本框。(用HTML调整)</li><li id="faed" class="kn ko hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">一个脚本化的活动选择参数，用于提取所有S3存储桶以选择将映像上传到何处。</li></ul><p id="9550" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">作为先决条件，你需要以下东西:</p><ul class=""><li id="1ce8" class="kn ko hh ig b ih ii il im ip lg it lh ix li jb ku kv kw kx bi translated">Jenkins插件:主动选择</li><li id="8609" class="kn ko hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">您的Jenkins代理中已经配置了AWS凭据。</li><li id="9b77" class="kn ko hh ig b ih ky il kz ip la it lb ix lc jb ku kv kw kx bi translated">AWS S3读取和上传权限。</li></ul><h1 id="1221" class="jq jr hh bd jo js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak"> 4-创建管道参数:</strong></h1><p id="0a56" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">要创建参数，我们将进入管道中的“配置”选项卡，单击“该项目已参数化”，启用后，单击“添加参数”并选择“字符串参数”以创建我们的图像输入框。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lk"><img src="../Images/bb7e6544853425ff00bb805f99891cce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AdUHput05lfYGaU1kvlibQ.png"/></div></div></figure><p id="8234" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦我们的常规字符串参数被创建，我们将为这个参数定义一个名称并选中“Trim”框，以修剪它的值并避免任何可能在我们的HTML中产生错误的空白。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lp"><img src="../Images/8ae18436980a3ca75e4cc6dd7a90ce44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AKJNz6IKrkkYNy1Ig7_3kw.png"/></div></div></figure><p id="227a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如果您想查看添加第一个参数后的效果，请单击“保存”，关闭配置窗口，然后单击“使用参数构建”</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lq"><img src="../Images/08812359b7a5de75a13731ca3a27183a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*huJu0tyEcSpkClWHFwJwdg.png"/></div></div></figure><p id="d853" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">如你所见，这非常简单，但一旦我们为图像预览添加新的反应参考参数，这将会改变。</p><p id="c48e" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">让我们回到“参数”设置并添加新参数，为此，我们将点击“添加参数”并选择“主动选择无功参考参数”。在配置脚本之前，导航到参数的底部，选择“选项类型”作为“格式化的HTML ”,以在我们的参数中启用HTML呈现，并添加之前创建的字符串参数作为“引用的参数”,在那里添加字符串参数，基本上启用了反应行为，并且当字符串参数中有更新时，这将被重新计算。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es lr"><img src="../Images/ee53d3361be42fc0a2bf7bc2c612a69d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5e8VQQ_rkvmR5glJcYOo4w.png"/></div></div></figure><p id="9083" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">要配置我们的脚本，首先，我们将选中参数顶部的“Groovy Script”框，我们将添加我们的Groovy文本框，返回我们想要呈现的HTML。</p><pre class="jd je jf jg fd ls lt lu lv aw lw bi"><span id="ae65" class="lx jr hh lt b fi ly lz l ma mb">return """&lt;img src=" """+ image + """ "alt="no-image"&gt;"""</span></pre><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mc"><img src="../Images/ae2bdd1339d3c4ead6136fe3b2f98d45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RceBiBeW16uTLayvQaXR-w.png"/></div></div></figure><p id="0500" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">这是一个非常简单的HTML标记，但它是我们预览图像所需的全部内容，正如您所看到的，该脚本基本上将“img”HTML标记与引用的参数“image”连接起来，将其设置为我们的参数的源图像。</p><p id="a5fb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">注意:</strong>回退脚本是一个备用脚本，如果主脚本返回异常，将执行该脚本。我们还使用三重引号来启用多行字符串插值，当您想要用另一个参数替换任何标签时，可以使用这种方法。(使用${parameter}语法)</p><p id="e1bb" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦完成，保存并测试它如何工作。为了测试它，我们需要做的就是在我们的“image”参数中复制一个图像URL，引用的参数将以普通的HTML呈现这个图像(或者如果失败，返回一个错误消息)</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es md"><img src="../Images/8d91828ee16cd3dab5bde98a10468187.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_daXrZLbMpCAncvFcd1ZLg.png"/></div></div></figure><p id="4cf5" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">尝试替换图像URL，并查看reactive参数如何重新呈现HTML图像。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es me"><img src="../Images/04fa9283908338b4f864e180978c0b22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4E_opIVJGEEJCiHoaeBq-g.png"/></div></div></figure><p id="225c" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">好了，现在我们已经有了图像，可以预览它了，现在我们要选择资产将被上传到哪个S3，为此，我们将再次进入设置并添加一个新参数，因为该参数不会对任何其他变量做出反应，我们将使用“活动选择参数”。因为我们要从列表1中选择，所以“选择类型”将是“单选”，我们还将启用复选框“启用过滤器”。这基本上将呈现一个输入框，我们可以在其中键入字符串进行搜索，并仅列出匹配项。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mf"><img src="../Images/3edf6c7ca1d2aea6cf06c3f9073c1eb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4QBu-suqCPym7O5OKRXhmw.png"/></div></div></figure><p id="2578" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，对于脚本，由于我们希望使用AWS CLI列出所有S3并对它们进行适当的格式化，因此我们将使用Groovy函数“execute”和管道操作符将std输出移动到下一个命令输入。指令“Execute”基本上将在我们的Groovy脚本中运行bash代码，一旦它完成，我们将标记输出(使用换行符作为拆分字符进行拆分)。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="mg mh l"/></div></figure><p id="982f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦您保存了新参数，现在您可以看到它将如何使用您键入的字符串呈现桶和过滤器</p><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es mi"><img src="../Images/fac19c31aff0a1fee1fbbf69fefd75f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:890/format:webp/1*aa1YOjj4gWJu7Yv8U-qAqQ.png"/></div></figure><p id="b85b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，我们只需要添加一个输入框来设置图像名称，并配置管道来使用我们的参数上传图像，我们就完成了，为此，要使用保存HTML的参数“preview ”,我们将使用它来附加一个输入标签，并在管道中稍后提取它的值。</p><pre class="jd je jf jg fd ls lt lu lv aw lw bi"><span id="8634" class="lx jr hh lt b fi ly lz l ma mb">return """&lt;h5&gt;Image name&lt;/h5&gt;&lt;input type="text" class="setting-input" style="width:auto" name="value" value="image.jpg" &gt;&lt;br&gt;&lt;img src=" """+ image + """ "alt="no-image" style="margin:5% 2% 5% 2%"&gt;"""</span></pre><p id="0fba" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，只需在前面的HTML中为参数“Preview”添加一个新的h5标签和一个input标签，并添加一个默认值(在我的例子中是image.jpg)，需要注意的重要一点是，要让Jenkins正确使用参数值，HTML中的类必须是“setting-input”。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mj"><img src="../Images/c8d9b4f9099ec33bfdfab028f4b8c03d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EQaAlu8JqkA2-BOU8_aO1w.png"/></div></div></figure><p id="cb30" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">最后，我们将配置管道以使用我们的参数，并使用以下代码将用户选择的图像上传到S3:</p><pre class="jd je jf jg fd ls lt lu lv aw lw bi"><span id="3247" class="lx jr hh lt b fi ly lz l ma mb">pipeline {<br/>    agent any</span><span id="b79f" class="lx jr hh lt b fi mk lz l ma mb">stages {<br/>        stage('Upload image to s3') {<br/>            environment{<br/>                name = sh(script:"echo ${params.preview} | cut -d',' -f1",  returnStdout: true).trim()<br/>            }<br/>            steps {<br/>               <br/>                sh """#!/usr/bin/env bash<br/>                curl ${params.image} &gt; ${name}<br/>                aws s3 cp ./${name} s3://${params.bucket}<br/>                rm ./${name}<br/>                """<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="171a" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">正如你所看到的，它非常简单，只使用之前创建的参数来下载和上传图像，你应该注意到的唯一一件事是，我们从环境“名称”中的“预览”参数中删除了一个逗号，这是因为当你使用格式化的HTML参数时，它会将它们导出为逗号分隔的列表(即1，2，3)。现在一切都准备好了，我们可以测试最终的管道。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es ml"><img src="../Images/147d4f39afe8a8527d38ea68381e3106.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IdSMeN-6L6s5W2HRQ_wXKQ.png"/></div></div></figure><p id="bd0b" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">一旦完成，我们将看到一个成功的执行，如果我们去我们的S3桶，图像文件被创建。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mm"><img src="../Images/60a593e300cf3e75143ac03c70d241ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7K3_iPV730nFmueYzt-FtQ.png"/></div></div></figure><p id="cf00" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">现在，为了验证一切是否正常，下载图像并打开它。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="er es mn"><img src="../Images/5fdb054744f5e272090c3c4cc4860ec6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zaC1g-oxI4k9BnpVXCY3kg.png"/></div></div></figure><p id="bf58" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">很好，现在您知道如何使用Groovy、bash和HTML动态参数化您的管道了。</p><h1 id="e347" class="jq jr hh bd jo js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak"> 5-结论</strong></h1><p id="a820" class="pw-post-body-paragraph ie if hh ig b ih kp ij ik il kq in io ip ld ir is it le iv iw ix lf iz ja jb ha bi translated">这个例子展示了使用反应式引用和HTML参数化管道的多种新方法，使Jenkins管道更加健壮和灵活，当然，您需要创建或修改管道来运行特定情况的情况会更少！</p><p id="e93f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">感谢您的宝贵时间！</p></div></div>    
</body>
</html>