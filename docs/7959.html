<html>
<head>
<title>Expanding Experimentation at Walmart using W3C Trace Context and Baggage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用W3C跟踪上下文和行李在沃尔玛扩展实验</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/expanding-experimentation-at-walmart-using-w3c-trace-context-and-baggage-9aecfb1b1f35?source=collection_archive---------0-----------------------#2020-12-22">https://medium.com/walmartglobaltech/expanding-experimentation-at-walmart-using-w3c-trace-context-and-baggage-9aecfb1b1f35?source=collection_archive---------0-----------------------#2020-12-22</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/0a2381f3eab212843ad9d2c32b65bf77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7t_9FAPQYC3rXwGDgkPPjw.png"/></div></div></figure><p id="9305" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在沃尔玛于2016年收购的Jet.com，我们有一个内部构建的A/B测试解决方案Phaser，它利用了所有服务都需要传播的遥测头。Phaser在头部注入了实验元数据，因此所有服务都可以免费进行开箱即用的实验。</p><p id="e199" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在沃尔玛，A/B测试系统Expo目前没有享受到这种奢侈，因此主要提供前端服务。为了将实验带给沃尔玛更广泛的服务受众，我们必须像Phaser一样将Expo集成到分布式跟踪系统中。</p><p id="0e09" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">我们没有集成到沃尔玛现有的跟踪实现中，而是与沃尔玛遥测团队合作，实现了一个基于W3C跟踪上下文和行李规格的跟踪实现；其解决了对传播跟踪和相关信息的标准化方法的需求。</p><p id="2d0e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在本帖中，你将了解到跟踪环境、包袱，以及我们如何利用它们来推动沃尔玛的实验。</p><h1 id="d4c4" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated"><strong class="ak">分布式追踪入门</strong></h1><p id="dcfd" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">在介绍规格之前，我想用一个类比来简要概述一下分布式跟踪——点对点，你可以在谷物盒背面或儿童活动手册中找到的编号黑点网络，你可以用铅笔进行跟踪。黑点是您的微服务架构中的服务，铅笔痕迹是自始至终唯一的请求。分布式跟踪让您清楚地了解请求流中涉及的所有服务，并有助于将识别故障和瓶颈所需的信息联系在一起。</p><figure class="kr ks kt ku fd ii er es paragraph-image"><div class="er es kq"><img src="../Images/43790877cff27b34426a2b09498e0038.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*co--J4fw7dKXIpqh8v5RcA.jpeg"/></div><figcaption class="kv kw et er es kx ky bd b be z dx">Dot-to-Dots worksheet of a Lion cub via <a class="ae kz" href="https://www.allkidsnetwork.com/" rel="noopener ugc nofollow" target="_blank">https://www.allkidsnetwork.com/</a></figcaption></figure><p id="c9a5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">跟踪是通过在跟踪头内部传递数据来实现的，这些数据后来被拼凑在一起，以帮助创建特定请求所采用的路径的可视化。传统上，这种头是由跟踪供应商设计的，导致部署多个跟踪供应商的系统缺乏互操作性。这是跟踪上下文和行李地址的问题之一。</p><h1 id="2487" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">简化的跟踪上下文</h1><p id="a2cb" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated"><strong class="ir hi">用途:</strong>跟踪上下文是两个头部的提议，当请求从一个服务传递到另一个服务时，这两个头部被更新和传播。报头用于分析请求通过系统的路径。</p><p id="6b82" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">它由什么组成:</strong> <code class="du la lb lc ld b">traceparent</code>和<code class="du la lb lc ld b">tracestate</code>:</p><ol class=""><li id="e1f0" class="le lf hh ir b is it iw ix ja lg je lh ji li jm lj lk ll lm bi translated"><code class="du la lb lc ld b">traceparent</code> ( <em class="ln">必选</em>)</li></ol><p id="36a1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">标题是跟踪的核心和灵魂。它包含四条信息:<em class="ln">版本</em>、<em class="ln">跟踪id </em>、<em class="ln">父跨度id </em>和<em class="ln">标志</em>。跟踪id和父span id对于帮助识别上述瓶颈和故障非常重要。下面是一个关于<code class="du la lb lc ld b">traceparent</code>的例子:</p><pre class="kr ks kt ku fd lo ld lp lq aw lr bi"><span id="31f9" class="ls jo hh ld b fi lt lu l lv lw">traceparent: 00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01</span><span id="30e5" class="ls jo hh ld b fi lx lu l lv lw"><strong class="ld hi">where</strong>:<br/>version = 00<br/>trace ID = 0af7651916cd43dd8448eb211c80319c<br/>parent span ID = b7ad6b7169203331<br/>flags = 01</span></pre><p id="9359" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">该示例显示了接收服务所看到的<code class="du la lb lc ld b">traceparent</code>头的一个实例。让我们称之为服务B。然后，服务B向服务C发出请求，通过使用自己的span id作为新的父span ID来更新跟踪上下文规范之后的<code class="du la lb lc ld b">traceparent</code>头，并保持trace-id不变。服务C接收的报头可以是:</p><pre class="kr ks kt ku fd lo ld lp lq aw lr bi"><span id="6ce3" class="ls jo hh ld b fi lt lu l lv lw">traceparent: 00-0af7651916cd43dd8448eb211c80319c-149ad35ecefe7f0c-01</span><span id="1179" class="ls jo hh ld b fi lx lu l lv lw"><strong class="ld hi">where:</strong><br/>version = 00<br/>trace ID = 0af7651916cd43dd8448eb211c80319c<br/>parent span ID = <strong class="ld hi">149ad35ecefe7f0c &lt;- only change</strong><br/>flags = 01</span></pre><p id="c3f5" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">请注意，跟踪ID保持不变，只有父span ID发生了变化。跟踪ID标识整个请求，父span ID标识服务B中发出请求的特定代码。</p><p id="4636" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">2.<strong class="ir hi"> </strong> <code class="du la lb lc ld b">tracestate</code> ( <em class="ln">可选</em>)</p><p id="1a74" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi"> </strong> <code class="du la lb lc ld b">tracestate</code> <strong class="ir hi"> </strong>表头<strong class="ir hi"> </strong>用于支持多个追踪系统的系统(即一个系统使用罗约，另一个系统使用刚果)。<code class="du la lb lc ld b">tracestate</code>是他们传递平台特定信息的地方，允许这些系统将<code class="du la lb lc ld b">traceparent</code>头与这些平台收集的数据相关联。下面是标题的一个示例:</p><pre class="kr ks kt ku fd lo ld lp lq aw lr bi"><span id="53bb" class="ls jo hh ld b fi lt lu l lv lw">tracestate: rojo=00f067aa0ba902b7,congo=t61rcWkgMzE</span></pre><p id="c892" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">罗约和刚果都指定了他们希望附加到追踪中的信息。这条信息在他们各自的系统中使用。</p><p id="d142" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">Trace Context如何帮助推进实验:</strong>这两个头文件本身并不支持实验——这就是行李规范的由来——但它们有助于推广标准的跟踪方法，从而更容易在整个技术组织中推广分布式跟踪。</p><p id="8426" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">采用跟踪上下文的另一个理由是OpenTelemetry社区推动了越来越多的跟踪上下文开源SDK实现。例子包括对流行语言的支持，如<a class="ae kz" href="https://github.com/open-telemetry/opentelemetry-java" rel="noopener ugc nofollow" target="_blank"> Java </a>、<a class="ae kz" href="https://github.com/open-telemetry/opentelemetry-js" rel="noopener ugc nofollow" target="_blank"> Javascript </a>、<a class="ae kz" href="https://github.com/open-telemetry/opentelemetry-python" rel="noopener ugc nofollow" target="_blank"> Python </a>和<a class="ae kz" href="https://github.com/open-telemetry/opentelemetry-go" rel="noopener ugc nofollow" target="_blank"> Go </a>。在沃尔玛，我们已经建立了自己的实现，将使W3C TraceContext兼容现有用户，但欢迎开发团队使用W3C TraceContext兼容的成熟社区构建库。</p><h1 id="50ea" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">行李简化</h1><p id="d064" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated"><strong class="ir hi">用途:</strong>行李是一个单一标题的建议——行李——可用于向请求添加用户定义的属性。以下是规范中的一些用例示例:</p><ol class=""><li id="5732" class="le lf hh ir b is it iw ix ja lg je lh ji li jm lj lk ll lm bi translated">如果您的所有数据都需要发送到单个节点，您可以传播一个属性来表明:<code class="du la lb lc ld b">baggage: serverNode=DF:28</code></li><li id="10fb" class="le lf hh ir b is ly iw lz ja ma je mb ji mc jm lj lk ll lm bi translated">如果在进行交易时需要记录原始用户ID，可以任意深入跟踪:<code class="du la lb lc ld b">baggage: userId=alice</code></li><li id="ee08" class="le lf hh ir b is ly iw lz ja ma je mb ji mc jm lj lk ll lm bi translated">如果您的非生产请求与生产请求流经相同的服务:<code class="du la lb lc ld b">baggage: isProduction=false</code></li></ol><p id="f47c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在沃尔玛，我们使用行李头来宣传实验单元。我们的标头可能会以下列方式使用:</p><p id="8136" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du la lb lc ld b">baggage: someID=someUUID</code></p><p id="0fef" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这将支持沃尔玛所有服务的实验。</p><p id="b7a8" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">它由什么组成:</strong> <code class="du la lb lc ld b">baggage</code></p><p id="6589" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du la lb lc ld b">baggage</code>头遵循与浏览器中的<a class="ae kz" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie" rel="noopener ugc nofollow" target="_blank"> Set-Cookie </a>相同的格式，一个逗号分隔的带有可选属性的键值对列表。</p><p id="cbfc" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><strong class="ir hi">行李如何帮助实验向前发展:</strong></p><p id="e1a3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在介绍中，我提到了如何在Jet使用Phaser进行实验。开箱即用的实验是成功的实验文化的关键，将我们的数据传播给所有服务是实现这一目标的良好开端。</p><p id="6d14" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">沃尔玛的跟踪上下文和行李标题将是利用Envoy的系统的一部分。考虑到这一点，Expo还将实现一个Envoy Web Assembly过滤器来解析<code class="du la lb lc ld b">baggage</code>头ID，然后将特定的请求分配给一组实验。这种方法将使我们不再在网络边缘分配用户，因此我们不再需要担心我们的头超过沃尔玛的指定阈值，因为分配将发生在服务级别。</p><h1 id="300d" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">实施行李限制</h1><p id="ddea" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">行李规范规定了以下限制:</p><ul class=""><li id="05d6" class="le lf hh ir b is it iw ix ja lg je lh ji li jm md lk ll lm bi translated">名称-值对的最大数量:<code class="du la lb lc ld b">180</code>。</li><li id="feaf" class="le lf hh ir b is ly iw lz ja ma je mb ji mc jm md lk ll lm bi translated">每个名称-值对的字节数:<code class="du la lb lc ld b">4096</code>。</li><li id="a544" class="le lf hh ir b is ly iw lz ja ma je mb ji mc jm md lk ll lm bi translated">所有名称-值对的最大总长度:<code class="du la lb lc ld b">8192</code>。</li></ul><p id="246b" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">然而，该规范并没有定义如何处理修改的策略，而是致力于定义非规范性的建议。这可能会导致应用程序开发人员在标题已满的情况下盲目丢弃密钥。给定我们的用例，一个随机化单元存在于传播这个头的所有服务中，重要的是我们预先定义那些指导方针。一些需要考虑的问题:</p><ul class=""><li id="acf5" class="le lf hh ir b is it iw ix ja lg je lh ji li jm md lk ll lm bi translated">键列表应该排序吗？</li><li id="122d" class="le lf hh ir b is ly iw lz ja ma je mb ji mc jm md lk ll lm bi translated">密钥应该是可修改的吗？</li><li id="c812" class="le lf hh ir b is ly iw lz ja ma je mb ji mc jm md lk ll lm bi translated">特定的键可以删除吗？</li><li id="f379" class="le lf hh ir b is ly iw lz ja ma je mb ji mc jm md lk ll lm bi translated">如果列表已满，是否应该删除旧的键(假设列表是有序的)？还是应该不能添加新的密钥？</li></ul><p id="fcf9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">因为规范把这个留给了它的用户，我们正致力于推广一套指南来限制对某些键的修改。</p><h1 id="3653" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><p id="7205" class="pw-post-body-paragraph ip iq hh ir b is kl iu iv iw km iy iz ja kn jc jd je ko jg jh ji kp jk jl jm ha bi translated">支持所有服务的实验是Expo团队的一个重要里程碑，随着沃尔玛采用Trace Context和行李，这一目标更近了一步。使跟踪上下文和包袱不同的是，由于它是W3C规范，并且有开源库支持，它变得更容易在整个组织中销售。这对于像沃尔玛这样的大公司来说很重要，在沃尔玛，向现代技术的转变可能比小公司需要更长的时间。实验在沃尔玛很重要，追踪背景和行李将在沃尔玛的持续发展中发挥至关重要的作用。</p></div></div>    
</body>
</html>