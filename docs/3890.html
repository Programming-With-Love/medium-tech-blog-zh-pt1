<html>
<head>
<title>Composing AWS Systems Manager configurations with Terraform — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform构建AWS系统管理器配置—第1部分</h1>
<blockquote>原文：<a href="https://medium.com/globant/composing-aws-systems-manager-configurations-with-terraform-part-1-939585ee9b7d?source=collection_archive---------0-----------------------#2022-06-10">https://medium.com/globant/composing-aws-systems-manager-configurations-with-terraform-part-1-939585ee9b7d?source=collection_archive---------0-----------------------#2022-06-10</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/55ea760315b401e4e328101a97aa15f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q1fxQo-pDSsYo5QUDj5ZdA.png"/></div></div></figure><p id="41ba" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">本文介绍了如何使用<a class="ae jn" href="https://registry.terraform.io/modules/areguera/ssm/aws/" rel="noopener ugc nofollow" target="_blank"> terraform-aws-ssm </a>模块设置<a class="ae jn" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/what-is-systems-manager.html" rel="noopener ugc nofollow" target="_blank"> AWS系统管理器(SSM) </a>配置。如果您对使用Terraform为您的AWS基础设施构建SSM配置感兴趣，那么这篇文章就是为您准备的。</p><p id="0bd1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当您完成本文后，您将能够使用<code class="du jo jp jq jr b"><a class="ae jn" href="https://registry.terraform.io/modules/areguera/ssm/aws/" rel="noopener ugc nofollow" target="_blank">terraform-aws-ssm</a></code>模块创建您自己的SSM配置。</p><p id="dd75" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">本文将回顾以下部分:</p><ul class=""><li id="bb9b" class="js jt hh ir b is it iw ix ja ju je jv ji jw jm jx jy jz ka bi translated">模块配置</li><li id="418a" class="js jt hh ir b is kb iw kc ja kd je ke ji kf jm jx jy jz ka bi translated">基础设施</li><li id="27af" class="js jt hh ir b is kb iw kc ja kd je ke ji kf jm jx jy jz ka bi translated">结论</li></ul></div><div class="ab cl kg kh go ki" role="separator"><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl"/></div><div class="ha hb hc hd he"><h1 id="6041" class="kn ko hh bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">模块配置</h1><p id="2201" class="pw-post-body-paragraph ip iq hh ir b is ll iu iv iw lm iy iz ja ln jc jd je lo jg jh ji lp jk jl jm ha bi translated"><code class="du jo jp jq jr b"><a class="ae jn" href="https://registry.terraform.io/modules/areguera/ssm/aws/" rel="noopener ugc nofollow" target="_blank">terraform-aws-ssm</a></code>模块需要如下所示的目录结构:</p><pre class="lq lr ls lt fd lu jr lv lw aw lx bi"><span id="71a6" class="ly ko hh jr b fi lz ma l mb mc">.<br/>├── ansible<br/>│   ├── 00-application-configuration.yml<br/>│   ├── 99-application-tests.yml<br/>│   └── roles<br/>│       ├── application-httpd<br/>│       │   ├── handlers<br/>│       │   │   └── main.yml<br/>│       │   ├── tasks<br/>│       │   │   └── main.yml<br/>│       │   └── templates<br/>│       │       ├── index.html.j2<br/>│       │       └── welcome.conf.j2<br/>│       └── application-httpd-tests<br/>│           └── tasks<br/>│               └── main.yml<br/>├── main.tf<br/>├── README.md<br/>└── variables.tf</span></pre><h2 id="080b" class="ly ko hh bd kp md me mf kt mg mh mi kx ja mj mk lb je ml mm lf ji mn mo lj mp bi translated">可翻译的目录</h2><p id="95dc" class="pw-post-body-paragraph ip iq hh ir b is ll iu iv iw lm iy iz ja ln jc jd je lo jg jh ji lp jk jl jm ha bi translated">该布局中的<code class="du jo jp jq jr b">ansible</code>目录用于组织可行的剧本和角色。使用此位置来声明SSM管理的EC2实例的所需状态。</p><p id="a101" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当应用ssm关联时，<a class="ae jn" href="https://github.com/areguera/terraform-aws-ssm" rel="noopener ugc nofollow" target="_blank"> terraform-aws-ssm </a>模块创建一个名为<code class="du jo jp jq jr b">${var.name}-ssm/</code>的私有S3存储桶，并将整个<code class="du jo jp jq jr b">ansible</code>目录上传到该存储桶以供进一步使用。当您引入对<code class="du jo jp jq jr b">ansible</code>目录的更改时，它们将在您下次运行<code class="du jo jp jq jr b">terraform apply</code>命令时反映在新的S3桶版本中，因此SSM服务将在关联中使用它们。</p><p id="2bcf" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当您在<code class="du jo jp jq jr b">ansible</code>目录中编写可翻译的剧本时，请记住它们将被下载到SSM托管实例并在那里应用。您不需要自己安装ansible command，因为<code class="du jo jp jq jr b">${var.name}-ApplyAnsiblePlaybooks</code> SSM文档已经处理好了，但是您必须编写您的剧本文件，以便仅使用<code class="du jo jp jq jr b">local</code>连接在<code class="du jo jp jq jr b">localhost</code>上运行。例如，考虑以下行动手册:</p><pre class="lq lr ls lt fd lu jr lv lw aw lx bi"><span id="caba" class="ly ko hh jr b fi lz ma l mb mc">---<br/> - name: Examples simple - Configure application<br/>  hosts: localhost<br/>  connection: local<br/><br/>  roles:<br/>     - application-httpd</span></pre><h2 id="c313" class="ly ko hh bd kp md me mf kt mg mh mi kx ja mj mk lb je ml mm lf ji mn mo lj mp bi translated">variables.tf文件</h2><p id="1d70" class="pw-post-body-paragraph ip iq hh ir b is ll iu iv iw lm iy iz ja ln jc jd je lo jg jh ji lp jk jl jm ha bi translated">默认情况下，<a class="ae jn" href="https://github.com/areguera/terraform-aws-ssm" rel="noopener ugc nofollow" target="_blank"> terraform-aws-ssm </a>模块需要两个变量作为输入。这些变量允许您自定义您创建的SSM配置。如果需要，还可以部署多个配置。</p><pre class="lq lr ls lt fd lu jr lv lw aw lx bi"><span id="1094" class="ly ko hh jr b fi lz ma l mb mc">variable "name" {<br/>  type        = string<br/>  description = "The project's name. This value is used to identify resources and tags."<br/>}<br/><br/>variable "region" {<br/>  type        = string<br/>  description = "The AWS region used by terraform provider."<br/>}</span></pre><h2 id="ff61" class="ly ko hh bd kp md me mf kt mg mh mi kx ja mj mk lb je ml mm lf ji mn mo lj mp bi translated"><code class="du jo jp jq jr b">main.tf</code>文件</h2><p id="1a9f" class="pw-post-body-paragraph ip iq hh ir b is ll iu iv iw lm iy iz ja ln jc jd je lo jg jh ji lp jk jl jm ha bi translated"><code class="du jo jp jq jr b">main.tf</code>文件有三个主要部分。第一个描述了terraform提供者和与之相关的限制。</p><pre class="lq lr ls lt fd lu jr lv lw aw lx bi"><span id="dfec" class="ly ko hh jr b fi lz ma l mb mc">terraform {<br/>  required_providers {<br/>    aws = {<br/>      source  = "hashicorp/aws"<br/>      version = "~&gt; 4.0"<br/>    }<br/>  }<br/>}<br/><br/>provider "aws" {<br/>  region = var.region<br/>}</span></pre><p id="79d4" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b">main.tf</code>文件中的第二部分调用<a class="ae jn" href="https://github.com/areguera/terraform-aws-ssm" rel="noopener ugc nofollow" target="_blank"> terraform-aws-ssm </a>模块，并提供模块设置补丁基线、维护窗口和ssm配置的关联资源所需的信息。</p><pre class="lq lr ls lt fd lu jr lv lw aw lx bi"><span id="5399" class="ly ko hh jr b fi lz ma l mb mc"># ------------------------------------------------------------------<br/># SSM Configuration<br/># ------------------------------------------------------------------<br/>module "ssm" {<br/>  source = "../../"<br/><br/>  name = var.name<br/><br/>  operating_system                     = "AMAZON_LINUX_2"<br/>  approved_patches_compliance_level    = "CRITICAL"<br/>  approved_patches_enable_non_security = false<br/><br/>  approval_rules = [{<br/>    approve_after_days  = 7<br/>    compliance_level    = "CRITICAL"<br/>    enable_non_security = false<br/>    patch_filters = [<br/>      { key = "PRODUCT", values = ["AmazonLinux2"] },<br/>      { key = "CLASSIFICATION", values = ["Security", "Bugfix"] },<br/>      { key = "SEVERITY", values = ["Critical", "Important"] }<br/>    ]<br/>  }]<br/><br/>  maintenance_window = {<br/>    enabled           = true<br/>    schedule          = "cron(0 9 */7 * ?)"<br/>    schedule_timezone = "UTC"<br/>    cutoff            = 0<br/>    duration          = 1<br/>  }<br/>}</span></pre><p id="5d2e" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">这就是使用<code class="du jo jp jq jr b"><a class="ae jn" href="https://registry.terraform.io/modules/areguera/ssm/aws/" rel="noopener ugc nofollow" target="_blank">terraform-aws-ssm</a></code>模块部署您的第一个SSM配置所需的全部内容。<code class="du jo jp jq jr b">main.tf</code>文件中剩余的配置部分专门用来说明SSM管理的EC2实例的部署。</p><pre class="lq lr ls lt fd lu jr lv lw aw lx bi"><span id="ea12" class="ly ko hh jr b fi lz ma l mb mc"># ------------------------------------------------------------------<br/># VPC<br/># ------------------------------------------------------------------<br/>module "vpc" {<br/>  source  = "terraform-aws-modules/vpc/aws"<br/>  version = "~&gt; 3.0"<br/><br/>  name = var.name<br/><br/>  cidr = "10.0.0.0/16"<br/><br/>  azs             = ["${var.region}a"]<br/>  public_subnets  = ["10.0.1.0/24"]<br/>  private_subnets = ["10.0.21.0/24"]<br/><br/>  enable_nat_gateway = true<br/>}<br/><br/># ------------------------------------------------------------------<br/># Security Groups<br/># ------------------------------------------------------------------<br/>module "security-group_http-80" {<br/>  source  = "terraform-aws-modules/security-group/aws//modules/http-80"<br/>  version = "~&gt; 4.0"<br/><br/>  name        = "${var.name}-sg-http-80"<br/>  description = "Allow http traffic from public subnets."<br/><br/>  vpc_id              = module.vpc.vpc_id<br/>  ingress_cidr_blocks = module.vpc.public_subnets_cidr_blocks<br/>}<br/><br/># ------------------------------------------------------------------<br/># Autoscaling<br/># ------------------------------------------------------------------<br/>module "asg" {<br/>  source  = "terraform-aws-modules/autoscaling/aws"<br/>  version = "~&gt; 6.0"<br/><br/>  name = var.name<br/><br/>  min_size         = 1<br/>  max_size         = 5<br/>  desired_capacity = 1<br/><br/>  iam_instance_profile_name = module.ssm.iam_instantace_profile_name<br/>  security_groups           = [module.security-group_http-80.security_group_id]<br/>  vpc_zone_identifier       = module.vpc.private_subnets<br/><br/>  launch_template_name        = var.name<br/>  launch_template_description = "Launch template for ${var.name} autoscaling group."<br/>  update_default_version      = true<br/><br/>  image_id          = "ami-0022f774911c1d690"<br/>  instance_type     = "t2.micro"<br/>  ebs_optimized     = false<br/>  enable_monitoring = true<br/><br/>  instance_market_options = {<br/>    market_type = "spot"<br/>    spot_options = {<br/>      max_price = "0.004"<br/>    }<br/>  }<br/><br/>  tags = {<br/>    "Name"        = "${var.name}"<br/>    "Patch Group" = "${var.name}"<br/>  }<br/>}</span></pre><p id="e17f" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">当部署新的EC2实例时，SSM代理和SSM服务器之间的通信开始，并且代理联系SSM服务器以通知它的存在。默认情况下，这种通信是被拒绝的，您需要通过创建一个具有必要权限的EC2实例概要文件来允许它，然后编写EC2实例部署代码来使用它。一旦EC2实例在SSM注册，它的代理就准备好执行SSM服务被配置为在本地操作系统中运行的所有操作。</p><p id="8098" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated"><code class="du jo jp jq jr b"><a class="ae jn" href="https://registry.terraform.io/modules/areguera/ssm/aws/" rel="noopener ugc nofollow" target="_blank">terraform-aws-ssm</a></code>模块创建了一个名为<code class="du jo jp jq jr b">${var.name}-ssm-managed-instance</code>的EC2实例概要文件，它拥有EC2实例与SSM服务交互所需的所有权限。但是，它不会在部署EC2实例的代码中配置EC2实例概要文件名称。当您编写自己的EC2实例部署代码时，您需要自己建立这样的关系。</p><p id="f929" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">例如，在<code class="du jo jp jq jr b">example/simple/main.tf</code>文件中，<code class="du jo jp jq jr b">iam_instance_profile_name</code>属性使用对<code class="du jo jp jq jr b">iam_instance_profile_name</code>资源的引用，在模块配置块中先前定义的<code class="du jo jp jq jr b">ssm</code>模块中，建立由<code class="du jo jp jq jr b"><a class="ae jn" href="https://registry.terraform.io/modules/areguera/ssm/aws/" rel="noopener ugc nofollow" target="_blank">terraform-aws-ssm</a></code>模块创建的EC2实例概要文件和为本文创建的EC2实例部署代码之间的关系。</p><pre class="lq lr ls lt fd lu jr lv lw aw lx bi"><span id="afc0" class="ly ko hh jr b fi lz ma l mb mc">module "asg" {<br/>  source  = "terraform-aws-modules/autoscaling/aws"<br/>  version = "~&gt; 6.0"</span><span id="1ad2" class="ly ko hh jr b fi mq ma l mb mc">  name = var.name</span><span id="2c2c" class="ly ko hh jr b fi mq ma l mb mc">  # ...</span><span id="76f7" class="ly ko hh jr b fi mq ma l mb mc">  iam_instance_profile_name = module.ssm.iam_instantace_profile_name</span><span id="17af" class="ly ko hh jr b fi mq ma l mb mc">  # ...</span><span id="8f67" class="ly ko hh jr b fi mq ma l mb mc">}</span></pre></div><div class="ab cl kg kh go ki" role="separator"><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl"/></div><div class="ha hb hc hd he"><h1 id="0231" class="kn ko hh bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">基础设施</h1><p id="364f" class="pw-post-body-paragraph ip iq hh ir b is ll iu iv iw lm iy iz ja ln jc jd je lo jg jh ji lp jk jl jm ha bi translated">本节描述基础结构的理想状态以及如何部署它。</p><h2 id="efc4" class="ly ko hh bd kp md me mf kt mg mh mi kx ja mj mk lb je ml mm lf ji mn mo lj mp bi translated">期望状态</h2><p id="589b" class="pw-post-body-paragraph ip iq hh ir b is ll iu iv iw lm iy iz ja ln jc jd je lo jg jh ji lp jk jl jm ha bi translated">基础设施期望状态是您希望满足的条件列表。例如，<code class="du jo jp jq jr b">example/simple/</code>基础设施的理想状态如下:</p><ul class=""><li id="9906" class="js jt hh ir b is it iw ix ja ju je jv ji jw jm jx jy jz ka bi translated">所有EC2实例必须使用Ansible playbooks进行安装和配置，以允许HTTP请求到达<code class="du jo jp jq jr b"><a class="ae jn" href="http://localhost/" rel="noopener ugc nofollow" target="_blank">http://localhost/</a></code>并接收<code class="du jo jp jq jr b">Hello, World!</code>响应。</li><li id="da69" class="js jt hh ir b is kb iw kc ja kd je ke ji kf jm jx jy jz ka bi translated">所有EC2实例必须批准分类为“安全”且严重性级别为“关键”或“重要”的所有操作系统补丁程序。补丁在发布后七天自动获得批准。还在发布后七天批准所有分类为“Bugfix”的修补程序。由补丁引起的系统重启也必须在没有人工干预的情况下以协调、渐进和可预测的方式发生。</li></ul><h2 id="c86b" class="ly ko hh bd kp md me mf kt mg mh mi kx ja mj mk lb je ml mm lf ji mn mo lj mp bi translated">部署</h2><ol class=""><li id="5361" class="js jt hh ir b is ll iw lm ja mr je ms ji mt jm mu jy jz ka bi translated">克隆存储库:<br/> <code class="du jo jp jq jr b">git clone <a class="ae jn" href="https://github.com/areguera/terraform-aws-ssm" rel="noopener ugc nofollow" target="_blank">https://github.com/areguera/terraform-aws-ssm</a></code></li><li id="09c2" class="js jt hh ir b is kb iw kc ja kd je ke ji kf jm mu jy jz ka bi translated">将工作目录更改为简单配置示例目录。<br/> <code class="du jo jp jq jr b">cd terraform-aws-ssm/examples/simple/</code></li><li id="dc8b" class="js jt hh ir b is kb iw kc ja kd je ke ji kf jm mu jy jz ka bi translated">初始化地形提供程序和模块:<br/> <code class="du jo jp jq jr b">terraform init</code></li><li id="a589" class="js jt hh ir b is kb iw kc ja kd je ke ji kf jm mu jy jz ka bi translated">自定义以设置您自己的SSM配置。您应该更改的主要位置是用于修改修补程序基准定义、维护窗口计划和自动扩展组容量的<code class="du jo jp jq jr b">examples/simple/main.tf</code>文件，以及用于修改基础架构所需状态的<code class="du jo jp jq jr b">examples/simple/ansible/</code>目录结构。</li><li id="0cff" class="js jt hh ir b is kb iw kc ja kd je ke ji kf jm mu jy jz ka bi translated">查看地形部署计划:<br/> <code class="du jo jp jq jr b">terraform plan -var name=MyProject -var region=us-east-1</code></li><li id="5af8" class="js jt hh ir b is kb iw kc ja kd je ke ji kf jm mu jy jz ka bi translated">应用地形部署计划:<br/> <code class="du jo jp jq jr b">terraform apply -var name=MyProject -var region=us-east-1</code></li></ol><p id="58ff" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">重复第4步和第6步。</p><h1 id="f6bf" class="kn ko hh bd kp kq mv ks kt ku mw kw kx ky mx la lb lc my le lf lg mz li lj lk bi translated">结论</h1><p id="3f7e" class="pw-post-body-paragraph ip iq hh ir b is ll iu iv iw lm iy iz ja ln jc jd je lo jg jh ji lp jk jl jm ha bi translated">这是由两部分组成的文章的第一部分。在第一部分中，您了解了<code class="du jo jp jq jr b">terraform-aws-ssm</code>模块以一致的方式供应SSM配置所需的非常基本的配置，考虑了IAM权限、修补程序基线、EC2实例的修补程序组分配、自动修补实例的关联以及使用ansible确保其所需状态等关键方面。</p><p id="07f3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">文章的第二部分“使用Terraform构建AWS系统管理器配置—第2部分”一步步地解释了<code class="du jo jp jq jr b">terraform-aws-ssm</code>模块的代码，并以分享关于使用基础设施作为代码构建SSM配置的最终想法这一主题结束。</p></div></div>    
</body>
</html>