<html>
<head>
<title>PinText: A Multitask Text Embedding System in Pinterest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PinText:Pinterest中的多任务文本嵌入系统</h1>
<blockquote>原文：<a href="https://medium.com/pinterest-engineering/pintext-a-multitask-text-embedding-system-in-pinterest-b80ece364555?source=collection_archive---------0-----------------------#2019-09-05">https://medium.com/pinterest-engineering/pintext-a-multitask-text-embedding-system-in-pinterest-b80ece364555?source=collection_archive---------0-----------------------#2019-09-05</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><p id="8a96" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><strong class="ig hi">庄金凤|软件工程师，内容知识</strong></p><p id="21dd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">自从神经网络语言模型被提出以来，机器学习社区中的研究人员和实践者已经积极地研究和开发了单词嵌入。研究人员不仅提出了原则性的算法和开源代码，而且他们还发布了预训练的嵌入模型，这些模型带有维基百科、推特或谷歌新闻等公共数据语料库。众所周知，高质量的单词表示通常对文本分类或其他一般任务贡献最大。</p><p id="b05f" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在Pinterest中，文本数据更多的是关于具体的注释术语和短语，而不是长句和段落，这使得word embedding成为比复杂的神经网络架构更基本的组件，用于特定的任务。虽然预先训练的单词嵌入提供了良好的基线，但我们确实观察到工业应用和学术研究之间存在明显的差距，包括存储成本、内存成本、监督信息的可用性、吞吐量和延迟。这些差距促使我们在实际系统层面上进行文本嵌入。我们的主要设计目标包括:</p><ul class=""><li id="305b" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">使用监督信息，而不是像word2vec那样的无监督共现风格的单词嵌入。</li><li id="804f" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">做单词级而不是字符级的嵌入，确保学习到的嵌入字典可以在需要的时候加载到内存中。</li><li id="def8" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">学习所有下游任务的共享单词嵌入，而不是与特定应用程序耦合的端到端嵌入。</li><li id="4a2f" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">最终替换所有开源嵌入，以节省维护成本。</li></ul><p id="a151" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们在Pinterest上有三个界面:主页、相关的大头针和搜索。使用多任务学习(MTL)将所有信息结合在一起，使学习到的模型更好地泛化，是一种直观的选择。用户参与每项任务自然会提供监督信息。在我们学习了这些信息的嵌入之后，我们使用Kubernetes+Docker解决方案或map-reduce系统进行大规模批量计算。我们还可以为在线搜索构建嵌入标记的倒排索引。图1展示了文本嵌入解决方案的高级架构。图2展示了三个表面、一个特定的用户配置文件和一个Pin。</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es jq"><img src="../Images/809029f2734fa24b27b516763a10dc28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RQVtMd4GfEaf4qR7"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx">Figure 1: A simplified representation of the PinText architecture consists of offline training, index building, and online serving. Left: We use Kafka to collect users’ engagement data to construct training data. Middle: We use locality-sensitive hashing (LSH) to compute embedding tokens and build an inverted index for each Pin. Embedding vectors and k-nearest neighbors (KNN) results can be cached. Right: Use LSH tokens of embedding vectors to retrieve Pins, and use embedding similarity in the ranking model.</figcaption></figure><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es jq"><img src="../Images/0e27ba52df76d3501a214bf9f8c7d386.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vjjgCZ9wl9483UG_"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx">Figure 2: Examples from the Pinterest iOS app of two core concepts: user (a) and Pin (b). Figures (c,d,e) presents examples of home feed, related Pin, and search for this particular user and the idea “Alaska train ride”. When users save and click content, we receive positive votes via the logging system. The learning task is to mine the semantic text embeddings behind such operations. Note we know voting results, but we don’t know who voted throughout this work.</figcaption></figure><p id="9b32" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">在下面的讨论中，让HF、RP和SR分别表示本地馈送、相关的Pin和搜索任务。每个训练实例是每个任务中的一对实体<q p="">。具体来说，</q></p><ul class=""><li id="713f" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">在SR中，q是搜索查询，p是Pin。我们提取Pin的标题和描述作为Pin的文本。参考图2(b)作为例子。</li><li id="64f9" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">在RP中，q是主题Pin，p是相关Pin。</li><li id="4802" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">在HF中，q是由我们的个性化团队导出的用户兴趣文本，p是Pin。</li></ul><p id="dfc2" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们使用实体的关联单词嵌入的平均值作为整体实体嵌入。然后，学习目标是使正实体对的嵌入的余弦相似性大于具有随机采样的背景实体的配对的余弦相似性。我们使用Pin保存和点击来定义正对。以SR任务为例，可以通过用户在搜索查询q的结果中保存或点击Pin p来定义肯定训练数据对<q p="">。</q></p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kg"><img src="../Images/33b34c575bfc3b310ef99fea6b8ab25a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*piLOufd56blf70xt"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx">Figure 3: Simplified architecture for the multitask word-embedding model</figcaption></figure><p id="9406" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">图3显示了学习架构的概况。现在我们来给出上述概念的数学表述。设<strong class="ig hi"> D </strong> ∈ Rⁿ×d表示学习过的字典，其中n为单词数，d为嵌入向量的维数。给定一个词wᵢ，我们通过恰好取<strong class="ig hi"> wᵢ </strong> ∈ Rᵈ为<strong class="ig hi"> D </strong>的第I行，推导出它的嵌入函数F(wᵢ) = <strong class="ig hi"> wᵢ </strong>。我们通过平均实体q的单词嵌入来计算实体q的嵌入。注意我们使用粗体小写字符来表示嵌入的行向量(例如，<strong class="ig hi"> q </strong> := F(q))。为了训练单任务嵌入模型，我们通过强制在涉及q的正对&lt; q，p⁺ &gt;上的相似性大于在几个随机采样的背景对&lt; q，p⁻ &gt;上的相似性来定义目标函数j(ɛ。以搜索任务为例(q为搜索查询):</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kh"><img src="../Images/6c933fad44a3cafcffc5ba2b2298580a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GekFakKREG1kDr2T"/></div></div></figure><p id="ac92" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">其中ρ负采样率、μ秩余量损失和嵌入向量的γ半径是通过实验调整的超参数。我们将L和S分别固定为铰链损失和余弦相似度。这样，我们实现了上面的目标函数设计目标。对于一个特定的实体q，我们强制它与一个肯定实体的相似性x比它与一个随机的否定实体的相似性y大一个差值μ。否则会引入损耗μ(x y)。这里的启发是，一个好的语义嵌入应该捕捉用户的参与度。</p><p id="1dbd" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">多任务学习目标函数是3个学习任务的简单集合，其中所有任务共享相同的单词嵌入查找表(如图3所示):</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es ki"><img src="../Images/0938f2d338ce85b251dff15100f9ce8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ioJyaFRBR_W3Rs5V"/></div></div></figure><p id="4558" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">利用这个MTL目标函数，我们可以对嵌入字典<strong class="ig hi"> D </strong>中的每个条目应用梯度下降，以直接学习单词嵌入。</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es kj"><img src="../Images/db665c5dce40852f87dcbd69d0863b0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4ocnWdrBUuMHlu45"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx">Figure 4: Breakdown of the contribution of each task.The Multitask training data is the distinct union of the three single tasks.</figcaption></figure><p id="d606" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们通过KNN查询2兴趣分类来评估这个PinText嵌入，其中我们为一个搜索查询预测一个感兴趣的术语列表。该任务的标签数据示例为:{查询:<em class="kk">木纹橱柜厨房</em>，标签:[ <em class="kk"> __label__home_decor，_ _ label _ _ DIY _ and _ crafts</em>}。我们基于各种文本嵌入模型计算查询和兴趣嵌入，然后使用最近的兴趣作为预测。事实证明，这种监督模型明显优于预先训练的非监督模型。它也明显优于单任务PinText学习。请注意，PinText-MTL仅比PinText-SR精确2%(表1 ),但在单词覆盖率方面的收益要大得多，这意味着它在其他场景中的表现甚至会更好。参考图4(b ),了解每个任务的令牌贡献。</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es jq"><img src="../Images/4332bfa68d1438ab5660748d5f2c4587.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KF0I8SSMEMPfYX06"/></div></div></figure><p id="60e9" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">通过学习单词嵌入字典，我们能够导出实体嵌入，并在上面使用KNN搜索进行检索。我们还使用文本术语作为索引标记。然而，有时复杂实体上的文本表示有一些限制:</p><ul class=""><li id="29c7" class="jc jd hh ig b ih ii il im ip je it jf ix jg jb jh ji jj jk bi translated">完整性:一些术语在语义上彼此接近，但拼写完全不同。对于长尾查询，往往很难在候选项中找到术语。</li><li id="62ed" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">紧凑性:一个用户或Pin可能有数百个注释术语。很难用具体的文本术语来概括这样一个复杂实体的主题。冗长的文本表示会导致歧义。</li><li id="89f5" class="jc jd hh ig b ih jl il jm ip jn it jo ix jp jb jh ji jj jk bi translated">连续性:当部分匹配发生时，我们需要一种定量的连续方式来定义我们是否应该为特定查询返回候选项。</li></ul><p id="49c3" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">Pinterest擅长视觉搜索，显示许多可能的灵感想法，而不是为事实问题提供具体答案。这种开放式查询的性质使得上述问题更加明显。使用文本嵌入模型，每个实体可以被压缩成固定长度的实向量，这在统一的宇宙中提供了紧凑的语义表示。因此，我们可以通过这个公共空间中的相似性度量将查询与候选项进行匹配，而不是依赖于精确的术语匹配，这在很大程度上解决了紧凑性和完整性问题。相似性得分可以用作以自然方式过滤候选对象的连续度量，或者用作监督模型中的区别特征。请参见下面图5中的广告检索示例。</p><figure class="jr js jt ju fd jv er es paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="er es jq"><img src="../Images/fd37e2a1b054ba633a1d32ff7f65bfce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YH6YDmScFTSmLSDn"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx">Figure 5: Examples of PinText-based retrieval and search keyword broad match in Pinterest. These top four queries exhibit the diversity advantage of embedding-based retrieval when the query is not specific or exact term match is not good. The cosine similarity between queries and Pins can also serve as a ranking feature.</figcaption></figure><p id="11aa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated">我们在这一领域持续投资。平均单词嵌入使得我们的系统简单而高效，但是我们也丢失了诸如单词顺序的信息。由于文本通常是具体的术语，而不是自然语言的句子，因此对其应用NLP模型并不简单。我们正在积极开发PinText的下一个版本。</p><p id="91aa" class="pw-post-body-paragraph ie if hh ig b ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb ha bi translated"><em class="kk">鸣谢:作者要感谢Pinterest Infra团队的队友——包括李丽达、刘军、徐素丽和刘——以及Ads Quality团队的无缝协作。我们感谢Stephanie deWet、Mukund Narasimhan、Ou和Nick Liu进行了许多富有成效的讨论。</em></p><blockquote class="kl"><p id="f2a0" class="km kn hh bd ko kp kq kr ks kt ku jb dx translated">我们正在建造世界上第一个视觉发现引擎。全世界有超过2.5亿人使用Pinterest来梦想、计划和准备他们在生活中想做的事情。<a class="ae kv" href="https://careers.pinterest.com/careers" rel="noopener ugc nofollow" target="_blank">来加入我们吧！</a></p></blockquote></div></div>    
</body>
</html>