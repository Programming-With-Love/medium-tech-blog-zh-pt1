<html>
<head>
<title>XCKnife: faster distributed tests for iOS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">XCKnife:更快的iOS分布式测试</h1>
<blockquote>原文：<a href="https://medium.com/square-corner-blog/xcknife-faster-distributed-tests-for-ios-e1eb6c23a6d5?source=collection_archive---------3-----------------------#2016-06-07">https://medium.com/square-corner-blog/xcknife-faster-distributed-tests-for-ios-e1eb6c23a6d5?source=collection_archive---------3-----------------------#2016-06-07</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><div class=""><h2 id="a3e1" class="pw-subtitle-paragraph ie hg hh bd b if ig ih ii ij ik il im in io ip iq ir is it iu iv dx translated">优化跨机器XCTest运行的简单工具</h2></div><p id="9bf5" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated"><em class="js">作者写的</em><a class="ae jt" href="https://twitter.com/metaphysicaldev" rel="noopener ugc nofollow" target="_blank"><em class="js"/></a><em class="js">。</em></p><blockquote class="ju"><p id="e462" class="jv jw hh bd jx jy jz ka kb kc kd jr dx translated">注意，我们已经行动了！如果您想继续了解Square的最新技术内容，请访问我们的新家<a class="ae jt" href="https://developer.squareup.com/blog" rel="noopener ugc nofollow" target="_blank">https://developer.squareup.com/blog</a></p></blockquote><p id="be85" class="pw-post-body-paragraph iw ix hh iy b iz ke ii jb jc kf il je jf kg jh ji jj kh jl jm jn ki jp jq jr ha bi translated">在Square，我们高度重视工程师的效率。随着我们的代码库的增长，我们的测试套件达到数万个测试，我们的工程师越来越长时间地等待他们的构建在我们的持续集成系统中是绿色的。</p><p id="a510" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">我们最近优化了我们的内部测试基础设施，使我们的iOS测试套件能够轻松高效地分布在数十台机器上。为了给我们的工程师提供最快的拉请求测试结果，我们还必须适当地平衡测试碎片，因为你的测试套件总是和它最慢的组件一样快。</p><figure class="kk kl km kn fd ko er es paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="er es kj"><img src="../Images/1d545e5b4d4566a858ee6b65c1dc140c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ByGOvpIortjIvNQi.png"/></div></div></figure><h1 id="072d" class="kv kw hh bd kx ky kz la lb lc ld le lf in lg io lh iq li ir lj it lk iu ll lm bi translated">平衡测试碎片</h1><p id="5ee2" class="pw-post-body-paragraph iw ix hh iy b iz ln ii jb jc lo il je jf lp jh ji jj lq jl jm jn lr jp jq jr ha bi translated">完美平衡的测试套件应该是这样的:</p><figure class="kk kl km kn fd ko er es paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="er es kj"><img src="../Images/18384e72d46df380f703e33c13a8d2a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Lw26cHuMWBbLho_e.png"/></div></div></figure><p id="fcf7" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">生成一个完美平衡的分片测试等价于一个已知的调度任务和机器的困难问题。对它进行近似<a class="ae jt" href="https://books.google.com/books?id=RxvrDwBUzcIC&amp;pg=PA544&amp;lpg=PA544&amp;dq=scheduling+graham%27s+algorithm+2+approximation&amp;source=bl&amp;ots=wUbmNtrmQ6&amp;sig=M_qz2mJ0RpzlaziOBKjsHXObyaw&amp;hl=en&amp;sa=X&amp;ved=0ahUKEwjuqdjj2IfNAhVW7mMKHT-yBOI4ChDoAQgiMAE#v=onepage&amp;q=scheduling%20graham%27s%20algorithm%202%20approximation&amp;f=false" rel="noopener ugc nofollow" target="_blank">足够快</a>，并且我们根据经验观察到它偏离最佳分区大约10%。</p><p id="73cb" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">为了计算近似的平衡碎片，我们创建了一个名为<a class="ae jt" href="https://github.com/square/xcknife" rel="noopener ugc nofollow" target="_blank"> XCKnife </a>的项目，目前我们正在开源这个项目。XCKnife以最小化总执行时间的方式划分<a class="ae jt" href="https://developer.apple.com/library/tvos/documentation/DeveloperTools/Conceptual/testing_with_xcode/chapters/04-writing_tests.html" rel="noopener ugc nofollow" target="_blank"> XCTestCase </a>测试(又名<a class="ae jt" href="https://en.wikipedia.org/wiki/Makespan" rel="noopener ugc nofollow" target="_blank"> <em class="js"> makespan </em> </a>)。在使用它之后，我们看到在我们最大的项目上CI测试构建速度提高了30%。</p><p id="66da" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">XCKnife通过利用Xctool的 <a class="ae jt" href="https://github.com/facebook/xctool#included-reporters" rel="noopener ugc nofollow" target="_blank"> json-stream </a> reporter输出来获得历史计时信息和当前测试套件定义。<a class="ae jt" href="https://github.com/facebook/xctool" rel="noopener ugc nofollow" target="_blank"> Xctool </a>是脸书创造的开源工具，作为苹果xcodebuild的替代品，让测试iOS和Mac产品变得更加容易。</p><p id="add8" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">XCKnife生成了一个只传递给Xctool的<a class="ae jt" href="https://github.com/facebook/xctool#testing" rel="noopener ugc nofollow" target="_blank"> -only测试参数</a>的参数列表，但是也可以使用适当的测试分区生成多个xcschemes。</p><p id="9834" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">XCKnife还自动处理删除的测试和测试目标，并推断新测试的预期时间。</p><h1 id="fd5d" class="kv kw hh bd kx ky kz la lb lc ld le lf in lg io lh iq li ir lj it lk iu ll lm bi translated">两级平衡</h1><p id="3803" class="pw-post-body-paragraph iw ix hh iy b iz ln ii jb jc lo il je jf lp jh ji jj lq jl jm jn lr jp jq jr ha bi translated">我们的测试套件通常包含多个<em class="js">分区集、</em>或者在不同配置下运行的多个测试目标列表。例如，给定下面的测试结构(来自<a class="ae jt" href="https://github.com/danielribeiro/xcknife-exemplar" rel="noopener ugc nofollow" target="_blank">这个样本项目</a>):</p><figure class="kk kl km kn fd ko er es paragraph-image"><div class="er es ls"><img src="../Images/48780c516d9dc1972d3fc3d4891edd2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:516/format:webp/0*W_jG-idh7DUYIrEq.png"/></div></figure><p id="f0d0" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">三个测试目标(_CommonTestTarget_、<em class="js"> iPadTestTarget </em>和<em class="js"> iPhoneTestTarget </em>)都有一个测试类列表，每个测试类都采用不同的计时数据。我们可以将这些测试目标分成三个分区集，例如:</p><figure class="kk kl km kn fd ko er es paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="er es kj"><img src="../Images/1ee886aedd052afa848dbe60a72b67cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6XnUJmgO9puTnGUo.png"/></div></div></figure><p id="b419" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">使用XCKnife在3台机器内分割<em class="js"> iPad </em>和<em class="js">基本</em>分区集，我们得到一个json表示如下分区:</p><figure class="kk kl km kn fd ko er es paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="er es kj"><img src="../Images/dc612629fa3dcd7901dbe02ca44d0a76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jKj12GTn59e-mK3a.png"/></div></div></figure><p id="08b7" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">XCKnife将对大多数类而不是方法进行分区，否则它将不止一次调用类的初始化，这并不总是安全的，例如，如果您使用改变状态的网络连接(像对外部有状态web服务进行Rest调用)。</p><h1 id="4989" class="kv kw hh bd kx ky kz la lb lc ld le lf in lg io lh iq li ir lj it lk iu ll lm bi translated">如何使用XCKnife</h1><p id="8044" class="pw-post-body-paragraph iw ix hh iy b iz ln ii jb jc lo il je jf lp jh ji jj lq jl jm jn lr jp jq jr ha bi translated">XCKnife 有可执行文件和Ruby gem两种版本。您可以通过以下方式安装它:</p><pre class="kk kl km kn fd lt lu lv lw aw lx bi"><span id="660a" class="ly kw hh lu b fi lz ma l mb mc">$ gem install xcknife</span></pre><p id="38b1" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">作为一种工具:</p><p id="4e30" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">$ xc knife-p common test target-p common test target，iPadTestTarget 6示例/xc knife-exemplar-historical-data . JSON-stream示例/xcknife-exemplar.json-stream</p><p id="85ea" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">这会产生json形式的分区信息:</p><figure class="kk kl km kn fd ko er es paragraph-image"><div class="er es md"><img src="../Images/4445537bdb9ec1291d2b89acb788a4f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1094/format:webp/0*IuN8IS3n7wJeW9ie.png"/></div></figure><p id="13a4" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">作为红宝石:</p><pre class="kk kl km kn fd lt lu lv lw aw lx bi"><span id="c3c7" class="ly kw hh lu b fi lz ma l mb mc">require 'xcknife'</span><span id="1807" class="ly kw hh lu b fi me ma l mb mc"><strong class="lu hi">def</strong> <strong class="lu hi">compute_shards</strong>(historical_file, current_file)<br/>  knife <strong class="lu hi">=</strong> XCKnife<strong class="lu hi">::</strong>StreamParser<strong class="lu hi">.</strong>new(6, <strong class="lu hi">[[</strong>"CommonTestTarget"<strong class="lu hi">]</strong>,<br/>    <strong class="lu hi">[</strong>"CommonTestTarget", "iPadTestTarget"<strong class="lu hi">]]</strong>)<br/>  knife<strong class="lu hi">.</strong>compute_shards_for_file(historical_file, current_file)<br/><strong class="lu hi">end</strong></span></pre><p id="b2cb" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">有关使用XCKnife的更多详细示例，请参考文档。</p><h1 id="43d8" class="kv kw hh bd kx ky kz la lb lc ld le lf in lg io lh iq li ir lj it lk iu ll lm bi translated">它是如何工作的</h1><p id="2980" class="pw-post-body-paragraph iw ix hh iy b iz ln ii jb jc lo il je jf lp jh ji jj lq jl jm jn lr jp jq jr ha bi translated">用于平衡单个分区集的<a class="ae jt" href="https://books.google.com/books?id=RxvrDwBUzcIC&amp;pg=PA544&amp;lpg=PA544&amp;dq=scheduling+graham%27s+algorithm+2+approximation&amp;source=bl&amp;ots=wUbmNtrmQ6&amp;sig=M_qz2mJ0RpzlaziOBKjsHXObyaw&amp;hl=en&amp;sa=X&amp;ved=0ahUKEwjuqdjj2IfNAhVW7mMKHT-yBOI4ChDoAQgiMAE#v=onepage&amp;q=scheduling%20graham%27s%20algorithm%202%20approximation&amp;f=false" rel="noopener ugc nofollow" target="_blank">2-近似法</a>是一种贪婪算法，在排序步骤O(N logN)之后为O(N ),其中所有测试类按照它们计算的时间排序，并放入一个队列中，时间最长的类在前面。每个迭代步骤从队列中取出一个测试类，并将其分配给最不忙的机器。</p><figure class="kk kl km kn fd ko er es paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="er es kj"><img src="../Images/4b6ebe0b1020105cd11fb673af7825e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TtxbkaEMcW427CxB.png"/></div></div></figure><p id="04d1" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">2-近似值意味着每个分区集的最终完成时间如下所示:</p><figure class="kk kl km kn fd ko er es paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="er es kj"><img src="../Images/45f3e489db80330d67120a86e343d4e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*j74ObGVk_s1D71In.png"/></div></div></figure><p id="bc92" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">当然，测试时间差异和推断在这里也起着关键作用。</p><h1 id="a916" class="kv kw hh bd kx ky kz la lb lc ld le lf in lg io lh iq li ir lj it lk iu ll lm bi translated">理解失衡</h1><p id="7834" class="pw-post-body-paragraph iw ix hh iy b iz ln ii jb jc lo il je jf lp jh ji jj lq jl jm jn lr jp jq jr ha bi translated">XCKnife将报告两个分区集之间及其内部分区的测试不平衡。这些都是根据理想情况(平均时间)报告的，不一定能够实现。例如，如果您有两个测试类的两个分区，每个分区有一个测试方法，预期时间为1秒和11秒，平均时间为6秒，但是因为我们不能将测试方法分成两部分，所以理想的场景是无法实现的。</p><p id="b5e2" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">下面的图表举例说明了一种情况，其中理想的时间是1秒，但是分区的总计算时间是0.5、1.1、0.8和1.3:</p><figure class="kk kl km kn fd ko er es paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="er es kj"><img src="../Images/4dfd07ad10204de30eb2963b922466a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_O5fcCjj5vj85L8e.png"/></div></div></figure><h1 id="d556" class="kv kw hh bd kx ky kz la lb lc ld le lf in lg io lh iq li ir lj it lk iu ll lm bi translated">承认</h1><p id="e0ae" class="pw-post-body-paragraph iw ix hh iy b iz ln ii jb jc lo il je jf lp jh ji jj lq jl jm jn lr jp jq jr ha bi translated">感谢<a class="ae jt" href="https://twitter.com/dnkoutso" rel="noopener ugc nofollow" target="_blank">迪米特里斯·库佐吉奥加斯</a>和<a class="ae jt" href="https://github.com/justinseanmartin" rel="noopener ugc nofollow" target="_blank">贾斯汀·马丁</a>在整个项目中对设计和代码进行审查。</p><h1 id="1b7e" class="kv kw hh bd kx ky kz la lb lc ld le lf in lg io lh iq li ir lj it lk iu ll lm bi translated">贡献</h1><p id="9302" class="pw-post-body-paragraph iw ix hh iy b iz ln ii jb jc lo il je jf lp jh ji jj lq jl jm jn lr jp jq jr ha bi translated">要发送投稿，请前往<a class="ae jt" href="https://github.com/square/xcknife#contributing" rel="noopener ugc nofollow" target="_blank"> XCKnife的GitHub页面</a>。</p></div><div class="ab cl mf mg go mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ha hb hc hd he"><p id="26d6" class="pw-post-body-paragraph iw ix hh iy b iz ja ii jb jc jd il je jf jg jh ji jj jk jl jm jn jo jp jq jr ha bi translated">在WWDC期间，Square的iOS工程团队邀请您加入我们的闪电对话之夜，并与您的iOS工程师同事一起享用美食和饮料。6月14日星期二，欢迎加入我们的SF包厢——下午5:30开门。RSVP  <a class="ae jt" href="https://squareioseng.splashthat.com/" rel="noopener ugc nofollow" target="_blank"> <em class="js">此处</em> </a> <em class="js">预留您的名额！</em></p></div><div class="ab cl mf mg go mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ha hb hc hd he"><div class="kk kl km kn fd mm"><a href="https://twitter.com/metaphysicaldev" rel="noopener  ugc nofollow" target="_blank"><div class="mn ab dw"><div class="mo ab mp cl cj mq"><h2 class="bd hi fi z dy mr ea eb ms ed ef hg bi translated">丹尼尔·里贝罗(@metaphysicaldev) |推特</h2><div class="mt l"><h3 class="bd b fi z dy mr ea eb ms ed ef dx translated">来自丹尼尔·里贝罗的最新推特(@metaphysicaldev)。工程师@广场。加州旧金山</h3></div><div class="mu l"><p class="bd b fp z dy mr ea eb ms ed ef dx translated">twitter.com</p></div></div><div class="mv l"><div class="mw l mx my mz mv na kt mm"/></div></div></a></div></div></div>    
</body>
</html>