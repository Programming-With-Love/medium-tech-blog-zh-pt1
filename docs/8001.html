<html>
<head>
<title>CobaltStrike Stager Utilizing Floating Point Math</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用浮点数学的钴击分级器</h1>
<blockquote>原文：<a href="https://medium.com/walmartglobaltech/cobaltstrike-stager-utilizing-floating-point-math-9bc13f9b9718?source=collection_archive---------0-----------------------#2021-04-20">https://medium.com/walmartglobaltech/cobaltstrike-stager-utilizing-floating-point-math-9bc13f9b9718?source=collection_archive---------0-----------------------#2021-04-20</a></blockquote><div><div class="ds gv gw gx gy gz"/><div class="ha hb hc hd he"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es ie"><img src="../Images/777b484d2534093d8df896da3e249876.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vcW8rzk2p6QYNExQajQnqg.jpeg"/></div></div></figure><p id="e27c" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">作者:杰森·里维斯和约书亚·普拉特</p><h1 id="2e60" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">行动纲要</h1><ol class=""><li id="0459" class="kl km hh ir b is kn iw ko ja kp je kq ji kr jm ks kt ku kv bi translated">新的CobaltStrike stagers利用浮点助记符[1]来解码stager外壳代码。</li><li id="f83b" class="kl km hh ir b is kw iw kx ja ky je kz ji la jm ks kt ku kv bi translated">使用原始套接字和谷歌头的日期值来检查被覆盖的睡眠值，如在一些沙盒爆炸。</li></ol><h1 id="4503" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">日期检查</h1><p id="98fd" class="pw-post-body-paragraph ip iq hh ir b is kn iu iv iw ko iy iz ja lb jc jd je lc jg jh ji ld jk jl jm ha bi translated">stager采用了一种有趣的技术来检查是否在受控环境(如沙箱)中被引爆，这可能会覆盖睡眠值，同时它还会检查网络连接。</p><p id="eade" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">stager利用原始套接字通过端口80连接到“google.com ”,并发送GET请求。</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es le"><img src="../Images/b957e0a8457f45aa586889b4a92a0ae8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gZi2apmv1DedVQWHHdPPuA.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx">Raw socket to google.com</figcaption></figure><p id="ca61" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在包括Wireshark[2]和Suricata[3]在内的大多数实用程序中，该请求不被解析为HTTP请求，因为它是不完整的，只有一个换行符，没有回车符。</p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es ln"><img src="../Images/b61eac90c23b6f61cd8a6c8c5d231cb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:746/format:webp/1*jCSAkpViAnfPkRniUSlYaA.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx">Incomplete request</figcaption></figure><p id="1663" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">该请求足以从web服务器检索404响应，然后恶意软件开始解析日期以外的值，特别是解析日、年和时间值。</p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es lo"><img src="../Images/8b02b36a62b84675eb7a45ccde755a41.png" data-original-src="https://miro.medium.com/v2/resize:fit:622/format:webp/1*92qIJV92lLkWhkJkaCG7Bw.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx">Parse values from response</figcaption></figure><p id="d5a3" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">解析出值后，它将其转换为秒，但不考虑月份。</p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es lp"><img src="../Images/81e6833d02f7fdf0c6948545ec29baea.png" data-original-src="https://miro.medium.com/v2/resize:fit:936/format:webp/1*mZK2HOSAn_u3HkxXTpfzkg.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx">Convert values to seconds</figcaption></figure><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lq"><img src="../Images/67c5d778736e6bd4d518bdb6250782cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RYopOr7Bq38ILHg5R2p6BQ.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx">Time Check</figcaption></figure><p id="8edd" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">上面你可以看到一个休眠调用被两个调用夹在中间，这两个调用是对负责从google请求中检索转换后的值的函数的调用，休眠是30秒，然后它检查这些值的差值是否小于28。它正在检查该过程是否花费了不到28秒的时间。</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="ij ik di il bf im"><div class="er es lr"><img src="../Images/cd67fe9afd1dd95102af4de463051eb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hrRmFgteIvcGaIvTq8KRWQ.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx">Error or decode logic</figcaption></figure><p id="f258" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">如果检查失败，则会显示一条假的DirectX错误消息，否则将开始对登台程序外壳代码进行解码。</p><h1 id="2a64" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">外壳代码解码</h1><p id="ed1a" class="pw-post-body-paragraph ip iq hh ir b is kn iu iv iw ko iy iz ja lb jc jd je lc jg jh ji ld jk jl jm ha bi translated">外壳代码是利用浮点助记符来解码的，从一些参与者的测试来看，这似乎很好地绕过了静态检测引擎。</p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es ls"><img src="../Images/8393cda6ea805b46c6b97da051db28ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:564/format:webp/1*ipmN5nsM4shfw9I8OMtH9w.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx">Decode loop</figcaption></figure><p id="efa7" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">所涉及的过程开始于使用硬编码的键值对数据表进行浮点模数运算。</p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es lt"><img src="../Images/f84a136386e3dd0885b57b0f43f192a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:798/format:webp/1*oOxRZOn-zE8tHXOtuckE0w.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx">fpmod</figcaption></figure><p id="cde9" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">在取模之后，该值被舍入为一个int值。用于解码数据的示例python代码如下所示:</p><pre class="lf lg lh li fd lu lv lw lx aw ly bi"><span id="1d8c" class="lz jo hh lv b fi ma mb l mc md">def fpmod_decode(key, data, l):<br/> out = ""<br/> for i in range(l):<br/>  temp = struct.unpack_from('&lt;d', data[i*8:])[0]<br/>  if temp &gt; int(temp%key):<br/>   out += chr((ord(struct.pack('&lt;Q', int(temp%key))[0])+1)&amp;0xff)<br/>  else:<br/>   out += chr((ord(struct.pack('&lt;Q', int(temp%key))[0]))&amp;0xff)<br/> return out</span></pre><p id="3bb1" class="pw-post-body-paragraph ip iq hh ir b is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm ha bi translated">使用我们的解码代码，我们可以快速枚举样本，以解码外壳代码并收集IOC。</p><h1 id="6390" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">妥协的标志</h1><pre class="lf lg lh li fd lu lv lw lx aw ly bi"><span id="8204" class="lz jo hh lv b fi ma mb l mc md">cda7edc9414814ef57c31e473ce87e489bcd6f1ed8d81a504e960e184fce1609<br/>abaf70728e6f940195e35e689cae40e0d598f2e85e2c881f8b558a45bb57cce5<br/>7793c2fd34248236e83206fdd01b547436e966bcb6cae21adcbf61550b62daea<br/>5d4fd3e3fef4e46cff33d0772f0c0c2c13ab7ba50cdd95f0761401652bb898de<br/>9ee75f2d28d93c90e2cf0da6d6d0d39fe9c12ce65c7ba6b880cf1c2c94add657<br/>7c047718e71e393bebd8147889087a4d207b125b98099b9effbf78f2291d2a68<br/>603e112de99388f8aea461a539ae57e38ca83faf2bd43984036eb3b7080c24be<br/>aca0a3e30d83e10197ebf1bf0fc2e7557e4e07f45066d6d1b3e997ca78d683f6<br/>6c6e49e0e822618c21d04ffd02ab26a0cb20b296d9d5a4e0cb27a5809a416089<br/>13177de544464a87be341fda62b7c62efd34adc858728893963d5169d2763b1f<br/>b4dceaded7b0184ebefbdac8b6d6af543b19b248a64754ffe8cee02473cefa83</span><span id="b4d4" class="lz jo hh lv b fi me mb l mc md">adsec[.]pro<br/>manageupdaternetwork[.]com<br/>192.99.250[.]7<br/>192.95.16[.]237<br/>195.123.234[.]60<br/>aloogi[.]com<br/>45.141.86[.]9<br/>185.4.65[.]139<br/>107.181.187[.]96<br/>5.34.179[.]35</span><span id="8d85" class="lz jo hh lv b fi me mb l mc md">alert tcp $HOME_NET any -&gt; $EXTERNAL_NET 80 (msg:"CS stager time check 1"; dsize:8; content:"GET drv|0a|"; offset:0; classtype:trojan-activity; sid:9000009; rev:1; metadata:author Jason Reaves;)</span><span id="e26e" class="lz jo hh lv b fi me mb l mc md">alert tcp $HOME_NET any -&gt; $EXTERNAL_NET 80 (msg:"CS stager time check 2"; dsize:11; content:"GET driver|0a|"; offset:0; classtype:trojan-activity; sid:9000010; rev:1; metadata:author Jason Reaves;)</span></pre><h1 id="9853" class="jn jo hh bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">参考</h1><ol class=""><li id="233b" class="kl km hh ir b is kn iw ko ja kp je kq ji kr jm ks kt ku kv bi translated"><a class="ae mf" href="https://www.felixcloutier.com/x86/index.html" rel="noopener ugc nofollow" target="_blank">https://www.felixcloutier.com/x86/index.html</a></li><li id="12be" class="kl km hh ir b is kw iw kx ja ky je kz ji la jm ks kt ku kv bi translated">https://www.wireshark.org/<a class="ae mf" href="https://www.wireshark.org/" rel="noopener ugc nofollow" target="_blank"/></li><li id="75b0" class="kl km hh ir b is kw iw kx ja ky je kz ji la jm ks kt ku kv bi translated">【https://suricata-ids.org/ T4】</li></ol></div></div>    
</body>
</html>